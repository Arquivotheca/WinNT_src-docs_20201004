<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmnotify.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmnotify.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d1/d1/cmnotify_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a0">CmpCheckPostBlock</a>(a)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a2">CmpReportNotifyHelper</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SearchHive, IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node, IN ULONG <a class="el" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a3">CmpCancelSlavePost</a> (<a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> PostBlock, PLIST_ENTRY DelayedDeref)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a4">CmpFreeSlavePost</a> (<a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> MasterPostBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a5">CmpAddToDelayedDeref</a> (<a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> PostBlock, PLIST_ENTRY DelayedDeref)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a6">CmpDelayedDerefKeys</a> (PLIST_ENTRY DelayedDeref)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a7">CmpNotifyTriggerCheck</a> (IN <a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a> NotifyBlock, IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a8">CmpDummyApc</a> (struct <a class="el" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *Apc, PVOID *SystemArgument1, PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a9">CmpReportNotify</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, ULONG <a class="el" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a10">CmpPostNotify</a> (<a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a> NotifyBlock, PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a> OPTIONAL, ULONG <a class="el" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>, NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>, PLIST_ENTRY ExternalKeyDeref OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a11">CmpPostApc</a> (struct <a class="el" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *Apc, <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, PVOID *NormalContext, PVOID *SystemArgument1, PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a12">CmpPostApcRunDown</a> (struct <a class="el" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *Apc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a13">CmNotifyRunDown</a> (<a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a14">CmpFlushNotify</a> (<a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a15">CmpNotifyChangeKey</a> (IN <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody, IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> PostBlock, IN ULONG CompletionFilter, IN BOOLEAN <a class="el" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>, IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> MasterPostBlock)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/cmnotify_8c.html#a1">CmpMasterHive</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="cmnotify.c::CmpCheckPostBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpCheckPostBlock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00085">85</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00804">CmpPostApc()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a13" doxytag="cmnotify.c::CmNotifyRunDown" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmNotifyRunDown           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Thread</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">1028</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00595">_CM_ASYNC_USER_POST_BLOCK::Apc</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00607">_CM_POST_BLOCK_UNION::AsyncUser</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00617">_CM_POST_BLOCK::CancelPostList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01738">CmpCancelSlavePost()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00054">CmpClearListEntry</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01634">CmpFreeSlavePost()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00048">CmpRemoveEntryList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l02019">CmpSetIoStatus</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00596">_CM_ASYNC_USER_POST_BLOCK::IoStatusBlock</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00632">IsMasterPostBlock</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00291">KeRemoveQueueApc()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00615">_CM_POST_BLOCK::NotifyList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00382">_ETHREAD::PostBlockList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00630">PostBlockType</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00616">_CM_POST_BLOCK::ThreadList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00620">_CM_POST_BLOCK::u</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00594">_CM_ASYNC_USER_POST_BLOCK::UserEvent</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.
<p>
<pre class="fragment"><div>01033                    :
01034 
01035     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called from <a class="code" href="../../d8/d0/psdelete_8c.html#a12">PspExitThread</a> to clean up any pending
01036     notify requests.
01037 
01038     It will traverse <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's PostBlockList, <span class="keywordflow">for</span> each PostBlock <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
01039     finds, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will:
01040 
01041         1.  Remove <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relevent NotifyBlock.  This requires
01042             that we hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Registry mutex.
01043 
01044         2.  Remove <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's PostBlockList.  This requires
01045             that we run at APC level.
01046 
01047         3.  By <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> runs, user apcs are not interesting
01048             and neither are SystemEvents, so <span class="keywordflow">do</span> not bother processing
01049             them.
01050 
01051             UserEvents and IoStatusBlocks could be refered to by other
01052             threads in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same process, or even a different process,
01053             so process them so those threads know what happened, use
01054             status code of STATUS_NOTIFY_CLEANUP.
01055 
01056             If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a master one, cancel all slave notifications.
01057             Else <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> remove <span class="keyword">this</span> notification from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master CancelPortList
01058 
01059         4.  Free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block.
01060 
01061 Arguments:
01062 
01063     Thread - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> executive thread object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread
01064              we wish to <span class="keywordflow">do</span> rundown on.
01065 
01066 Return Value:
01067 
01068     NONE.
01069 
01070 --*/
01071 {
01072     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>      PostBlock;
01073     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    NotifyBlock;
01074     KIRQL               OldIrql;
01075 
01076     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01077 
01078     <span class="keywordflow">if</span> ( IsListEmpty(&amp;(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o8">PostBlockList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) {
01079         <span class="keywordflow">return</span>;
01080     }
01081 
01082     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) {
01083         KdPrint((<span class="stringliteral">"CmNotifyRunDown: ethread:%08lx\n"</span>, Thread));
01084     }
01085 
01086     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01087 
01088         <span class="comment">//</span>
01089     <span class="comment">// Aquire exclusive access over the postlist(s)</span>
01090     <span class="comment">//</span>
01091     <span class="comment">// This is not needed (see the rule above)</span>
01092     <span class="comment">//LOCK_POST_LIST(); </span>
01093 
01094     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
01095     <span class="keywordflow">while</span> (IsListEmpty(&amp;(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o8">PostBlockList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01096 
01097         <span class="comment">//</span>
01098         <span class="comment">// remove from thread list</span>
01099         <span class="comment">//</span>
01100         PostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)RemoveHeadList(&amp;(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o8">PostBlockList</a>));
01101         PostBlock = CONTAINING_RECORD(
01102                         PostBlock,
01103                         <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
01104                         ThreadList
01105                         );
01106 
01107         <span class="comment">// Protect for multiple deletion of the same object</span>
01108         <a class="code" href="../../d1/d2/cmp_8h.html#a2">CmpClearListEntry</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01109 
01110         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) {
01111 <span class="preprocessor">#if DBG</span>
01112 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
01113                 KdPrint((<span class="stringliteral">"[CM]CmpNotifyRunDown: ethread:%08lx, PostBlock:%08lx\n"</span>, Thread,PostBlock));
01114             }
01115 <span class="preprocessor">#endif</span>
01116 <span class="preprocessor"></span>        }
01117 
01118         <span class="comment">//</span>
01119         <span class="comment">// Canceling a master notification implies canceling all the slave notifications</span>
01120         <span class="comment">// from the CancelPostList</span>
01121         <span class="comment">//</span>
01122         <span class="keywordflow">if</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock)) {
01123             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) {
01124 <span class="preprocessor">#if DBG</span>
01125 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
01126                         KdPrint((<span class="stringliteral">"[CM]\tCmpNotifyRunDown: PostBlock:%08lx is a master block\n"</span>, PostBlock));
01127                 }
01128 <span class="preprocessor">#endif</span>
01129 <span class="preprocessor"></span>            }
01130             <span class="comment">//</span>
01131             <span class="comment">// at this point, CmpReportNotify and friends will no longer</span>
01132             <span class="comment">// attempt to post this post block.</span>
01133             <span class="comment">//</span>
01134             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(PostBlock) == <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>) {
01135                 <span class="comment">//</span>
01136                 <span class="comment">// report status and wake up any threads that might otherwise</span>
01137                 <span class="comment">// be stuck.  also drop any event references we hold</span>
01138                 <span class="comment">//</span>
01139                 <span class="comment">//  Sundown only: Use a 32bit IO_STATUS_BLOCK if the caller is 32bit. </span>
01140 
01141                 <span class="keywordflow">try</span> {
01142                     <a class="code" href="../../d1/d2/cmp_8h.html#a151">CmpSetIoStatus</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o2">IoStatusBlock</a>, 
01143                                    STATUS_NOTIFY_CLEANUP, 
01144                                    0L, 
01145                                    <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process != NULL);
01146                 } except (EXCEPTION_EXECUTE_HANDLER) {
01147                     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
01148                         KdPrint((<span class="stringliteral">"!!CmNotifyRundown: code:%08lx\n"</span>, GetExceptionCode()));
01149                     }
01150                     NOTHING;
01151                 }
01152 
01153                 <span class="keywordflow">if</span> (PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01154                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(
01155                         PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>,
01156                         0,
01157                         FALSE
01158                         );
01159                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>);
01160                 }
01161 
01162                 <span class="comment">//</span>
01163                 <span class="comment">// Cancel the APC. Otherwise the rundown routine will also</span>
01164                 <span class="comment">// free the post block if the APC happens to be queued at</span>
01165                 <span class="comment">// this point. If the APC is queued, then the post block has</span>
01166                 <span class="comment">// already been removed from the notify list, so don't remove</span>
01167                 <span class="comment">// it again.</span>
01168                 <span class="comment">//</span>
01169                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d7/apcobj_8c.html#a4">KeRemoveQueueApc</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o1">Apc</a>)) {
01170 
01171                     <span class="comment">//</span>
01172                     <span class="comment">// remove from notify block's list</span>
01173                     <span class="comment">//</span>
01174                     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01175                     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01176                 }
01177             } <span class="keywordflow">else</span> {
01178                 <span class="comment">//</span>
01179                 <span class="comment">// remove from notify block's list</span>
01180                 <span class="comment">//</span>
01181                 <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01182                 <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01183             }
01184 
01185             <span class="comment">//</span>
01186             <span class="comment">// Cancel all slave Post requests that may be linked to self</span>
01187             <span class="comment">//</span>
01188             <a class="code" href="../../d0/d2/cmnotify_8c.html#a3">CmpCancelSlavePost</a>(PostBlock,NULL); <span class="comment">// we do not want delayed deref</span>
01189                         <span class="comment">//</span>
01190                         <span class="comment">// Free the slave Post blocks too</span>
01191                         <span class="comment">//</span>
01192                         <a class="code" href="../../d0/d2/cmnotify_8c.html#a4">CmpFreeSlavePost</a>(PostBlock);
01193         } <span class="keywordflow">else</span> {
01194 
01195             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) {
01196 <span class="preprocessor">#if DBG</span>
01197 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
01198                     KdPrint((<span class="stringliteral">"[CM]\tCmpNotifyRunDown: PostBlock:%08lx is a slave block\n"</span>, PostBlock));
01199                 }
01200 <span class="preprocessor">#endif</span>
01201 <span class="preprocessor"></span>            }
01202             <span class="comment">//</span>
01203             <span class="comment">// Is a slave PostBlock, just remove self from the Notify PostList</span>
01204             <span class="comment">//</span>
01205             <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01206             <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01207 
01208             <span class="comment">//</span>
01209             <span class="comment">// and unchain from the Master CancelPostList</span>
01210             <span class="comment">//</span>
01211             <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01212             <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>));
01213 
01214         }
01215 
01216         <span class="comment">//</span>
01217         <span class="comment">// Free the post block.  Use Ex call because PostBlocks are NOT</span>
01218         <span class="comment">// part of the global registry pool computation, but are instead</span>
01219         <span class="comment">// part of NonPagedPool with Quota.</span>
01220         <span class="comment">//</span>
01221         <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
01222     }
01223 
01224     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01225 
01226     <span class="comment">// This is not needed (see the rule above)</span>
01227     <span class="comment">//UNLOCK_POST_LIST();</span>
01228 
01229     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01230     <span class="keywordflow">return</span>;
01231 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="cmnotify.c::CmpAddToDelayedDeref" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpAddToDelayedDeref           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PostBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>DelayedDeref</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01845">1845</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00544">_CM_POST_KEY_BODY::KeyBody</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00543">_CM_POST_KEY_BODY::KeyBodyList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00618">_CM_POST_BLOCK::PostKeyBody</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01738">CmpCancelSlavePost()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>.
<p>
<pre class="fragment"><div>01851                    :
01852 
01853     Add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key body attached to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delayed deref list.
01854     Cleans <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block KeyBody member, so <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will not be dereferenced 
01855     when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
01856 
01857 Arguments:
01858 
01859     PostBlock - pointer to structure that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post requests.
01860 
01861     DelayedDeref - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delayed deref list
01862 
01863 Return Value:
01864 
01865     NONE.
01866 
01867 --*/
01868 
01869 {
01870     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01871 
01872     <span class="comment">// common sense</span>
01873     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostBlock != NULL );
01874 
01875     <span class="keywordflow">if</span>( PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o3">PostKeyBody</a> ) {
01876         <span class="comment">//</span>
01877         <span class="comment">// If the post block has a keybody attached, add it to delayed deref list and </span>
01878         <span class="comment">// clear the post block member. The key body will be deref'd prior after </span>
01879         <span class="comment">// postblock lock is released.</span>
01880         <span class="comment">//</span>
01881     
01882         <span class="comment">// extra validation</span>
01883         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o3">PostKeyBody</a>-&gt;<a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html#o1">KeyBody</a> != NULL);
01884         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DelayedDeref);
01885 
01886         <span class="comment">// add it to the end of the list</span>
01887         InsertTailList(
01888             DelayedDeref,
01889             &amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o3">PostKeyBody</a>-&gt;<a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html#o0">KeyBodyList</a>)
01890             );
01891     
01892         <span class="comment">// make sure we don't deref it in CmpFreePostBlock</span>
01893         PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o3">PostKeyBody</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01894     }
01895 
01896     <span class="keywordflow">return</span>;
01897 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="cmnotify.c::CmpCancelSlavePost" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpCancelSlavePost           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PostBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>DelayedDeref</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01738">1738</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00345">ASSERT_CM_LOCK_OWNED</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00617">_CM_POST_BLOCK::CancelPostList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01845">CmpAddToDelayedDeref()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00048">CmpRemoveEntryList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">CMS_NOTIFY</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00632">IsMasterPostBlock</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00615">_CM_POST_BLOCK::NotifyList</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>.
<p>
<pre class="fragment"><div>01744                    :
01745 
01746         Unlink <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> slave postblock from its notify list and dereferences (or adds to the delayed deref list)
01747         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> keybody related to <span class="keyword">this</span> thread. This should disable <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> slave post block. 
01748         It will be cleared later in <a class="code" href="../../d0/d2/cmnotify_8c.html#a11">CmpPostApc</a>.
01749 
01750 Arguments:
01751 
01752     MasterPostBlock - pointer to structure that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post requests.
01753                 It should be a master post!!
01754     DelayedDeref - pointer to list of delayed deref keybodies. If <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01755                 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> keybody <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> slave <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not cleared before calling <a class="code" href="../../d1/d2/cmp_8h.html#a286">CmpFreePostBlock</a>, 
01756                 and instead <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list
01757 
01758 
01759 Return Value:
01760 
01761     NONE.
01762 
01763 --*/
01764 {
01765     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  SlavePostBlock;
01766 
01767     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01768     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
01769         KdPrint((<span class="stringliteral">"CmpCancelSlavePost:\t"</span>));
01770         KdPrint((<span class="stringliteral">"MasterPostBlock:%08lx\n"</span>, MasterPostBlock));
01771     }
01772 
01773     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
01774 
01775     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(MasterPostBlock));
01776 
01777     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
01778 <span class="preprocessor">#if DBG</span>
01779 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(MasterPostBlock-&gt;TraceIntoDebugger) {
01780             KdPrint((<span class="stringliteral">"[CM]CmCancelSlavePost: MasterPostBlock:%08lx\n"</span>, MasterPostBlock));
01781         }
01782 <span class="preprocessor">#endif</span>
01783 <span class="preprocessor"></span>    }
01784 
01785     <span class="keywordflow">if</span> (IsListEmpty(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01786         <span class="comment">//</span>
01787         <span class="comment">// Nothing to cancel, just return</span>
01788         <span class="comment">//</span>
01789         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
01790 <span class="preprocessor">#if DBG</span>
01791 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(MasterPostBlock-&gt;TraceIntoDebugger) {
01792                 KdPrint((<span class="stringliteral">"[CM]CmCancelSlavePost: MasterPostBlock:%08lx has no slaves\n"</span>, MasterPostBlock));
01793             }
01794 <span class="preprocessor">#endif</span>
01795 <span class="preprocessor"></span>        }
01796 
01797         <span class="keywordflow">return</span>;
01798     }
01799 
01800 
01801     <span class="comment">//</span>
01802     <span class="comment">// Pull all the entries in the cancel post list and unlink them (when they are slave requests)</span>
01803     <span class="comment">// We base here on the assumption that there is only one slave.</span>
01804     <span class="comment">//</span>
01805     <span class="comment">//     NOTE!!!</span>
01806     <span class="comment">//       When more than slave allowed, here to modify</span>
01807     <span class="comment">//</span>
01808 
01809 
01810     SlavePostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>.Flink;
01811     SlavePostBlock = CONTAINING_RECORD(SlavePostBlock,
01812                                        <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
01813                                        CancelPostList);
01814 
01815     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
01816 <span class="preprocessor">#if DBG</span>
01817 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(MasterPostBlock-&gt;TraceIntoDebugger) {
01818             KdPrint((<span class="stringliteral">"[CM]CmCancelSlavePost: Cleaning SlavePostBlock:%08lx\n"</span>, SlavePostBlock));
01819         }
01820 <span class="preprocessor">#endif</span>
01821 <span class="preprocessor"></span>    }
01822 
01823     <span class="comment">//</span>
01824     <span class="comment">// This should be true !</span>
01825     <span class="comment">//</span>
01826     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(SlavePostBlock) );
01827 
01828     <span class="comment">//</span>
01829     <span class="comment">// Remove it from notify block's list</span>
01830     <span class="comment">//</span>
01831     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01832         <span class="comment">// This will disable the notifications that might come on the slave key</span>
01833         <span class="comment">//</span>
01834     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01835 
01836     <span class="keywordflow">if</span>( DelayedDeref ) {
01837         <span class="comment">// </span>
01838         <span class="comment">// the caller wants to handle key body dereferenciation by himself</span>
01839         <span class="comment">//</span>
01840         <a class="code" href="../../d0/d2/cmnotify_8c.html#a5">CmpAddToDelayedDeref</a>(SlavePostBlock,DelayedDeref);
01841     }
01842 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="cmnotify.c::CmpDelayedDerefKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpDelayedDerefKeys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PLIST_ENTRY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DelayedDeref</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01900">1900</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a162">CM_POST_KEY_BODY</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00486">KEY_BODY_TYPE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00544">_CM_POST_KEY_BODY::KeyBody</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a163">PCM_POST_KEY_BODY</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00491">_CM_KEY_BODY::Type</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00357">CmpReportNotifyHelper()</a>.
<p>
<pre class="fragment"><div>01905                    :
01906 
01907     Walk through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire list, dereference each keybody and free storage <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 
01908     <a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">CM_POST_KEY_BODY</a> allocated <span class="keywordflow">for</span> <span class="keyword">this</span> purpose.
01909 
01910 Arguments:
01911 
01912     DelayedDeref - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delayed deref list
01913 
01914 Return Value:
01915 
01916     NONE.
01917 
01918 --*/
01919 {
01920     <a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">PCM_POST_KEY_BODY</a>   PostKeyBody;
01921 
01922     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01923 
01924     <span class="comment">// common sense</span>
01925     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( DelayedDeref != NULL );
01926 
01927     <span class="keywordflow">while</span>(IsListEmpty(DelayedDeref) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01928         <span class="comment">//</span>
01929         <span class="comment">// Remove from the delayed deref list and deref the coresponding keybody</span>
01930         <span class="comment">// free the storage associated with CM_POST_KEY_BODY</span>
01931         <span class="comment">//</span>
01932         PostKeyBody = (<a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">PCM_POST_KEY_BODY</a>)RemoveHeadList(DelayedDeref);
01933         PostKeyBody = CONTAINING_RECORD(PostKeyBody,
01934                                       <a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">CM_POST_KEY_BODY</a>,
01935                                       KeyBodyList);
01936 
01937         <span class="comment">// extra validation</span>
01938         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PostKeyBody-&gt;<a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html#o1">KeyBody</a> != NULL);
01939         <span class="comment">// this should be a valid key body</span>
01940         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PostKeyBody-&gt;<a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html#o1">KeyBody</a>-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a> == KEY_BODY_TYPE);
01941         
01942         <span class="comment">// at last ..... dereference the key object</span>
01943         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostKeyBody-&gt;<a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html#o1">KeyBody</a>);
01944 
01945         <span class="comment">// Free the storage for the CM_POST_KEY_BODY object (allocated by CmpAllocatePostBlock)</span>
01946         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostKeyBody);
01947     }
01948 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="cmnotify.c::CmpDummyApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpDummyApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00159">159</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>.
<p>
<pre class="fragment"><div>00166                    :
00167 
00168     Dummy routine to prevent user-mode callers to set special kernel apcs
00169 
00170 Arguments:
00171 
00172     Apc - pointer to apc object
00173 
00174     SystemArgument1 -  IN: <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value <span class="keywordflow">for</span> IoStatusBlock
00175                       OUT: <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a> to IoStatusBlock (2nd arg to user apc routine)
00176 
00177     SystemArgument2 - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PostBlock
00178 
00179 Return Value:
00180 
00181     NONE.
00182 
00183 --*/
00184 {
00185     UNREFERENCED_PARAMETER(Apc);
00186     UNREFERENCED_PARAMETER(SystemArgument1);
00187     UNREFERENCED_PARAMETER(SystemArgument2);
00188 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="cmnotify.c::CmpFlushNotify" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpFlushNotify           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyBody</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">1235</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00345">ASSERT_CM_LOCK_OWNED</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00660">CmLockHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00054">CmpClearListEntry</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01515">CmpInitializeKeyNameString()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">CMS_NOTIFY</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00662">CmUnlockHive</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00272">_CM_KEY_CONTROL_BLOCK::Delete</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00559">_CM_NOTIFY_BLOCK::HiveList</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00033">HiveList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00279">_CM_KEY_CONTROL_BLOCK::KeyHive</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00295">_CM_KEY_CONTROL_BLOCK::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00034">MAX_KEY_NAME_LENGTH</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00493">_CM_KEY_BODY::NotifyBlock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00563">_CM_NOTIFY_BLOCK::PostList</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00564">_CM_NOTIFY_BLOCK::SubjectContext</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d2/d0/cmdelete_8c-source.html#l00031">CmpDeleteKeyObject()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00731">CmpRefreshHive()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.
<p>
<pre class="fragment"><div>01240                    :
01241 
01242     Clean up notifyblock when a handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> closed or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> refers
01243     to <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted.
01244 
01245 Arguments:
01246 
01247     KeyBody - supplies pointer to key object body <span class="keywordflow">for</span> handle we
01248                 are cleaning up.
01249 
01250 Return Value:
01251 
01252     NONE
01253 
01254 --*/
01255 {
01256     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    NotifyBlock;
01257     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01258 
01259     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01260     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
01261 
01262     <span class="keywordflow">if</span> (KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01263         <span class="keywordflow">return</span>;
01264     }
01265 
01266 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
01267 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a> == FALSE );
01268 <span class="preprocessor">#endif</span>
01269 <span class="preprocessor"></span>
01270     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
01271 <span class="preprocessor">#if DBG</span>
01272 <span class="preprocessor"></span>        WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01273         UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
01274 
01275         KdPrint((<span class="stringliteral">"[CM]CmpFlushNotify: NotifyBlock = %08lx\n"</span>,KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a>));
01276         NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, MAX_KEY_NAME_LENGTH);
01277         <span class="keywordflow">if</span>(NameBuffer &amp;&amp; KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>) {
01278            <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>,&amp;KeyName,NameBuffer);
01279            KdPrint((<span class="stringliteral">"\t[CM]CmpFlushNotify: Key = %.*S\n"</span>,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
01280            <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
01281         }
01282 <span class="preprocessor">#endif</span>
01283 <span class="preprocessor"></span>    }
01284 
01285     <span class="comment">//</span>
01286     <span class="comment">// Lock the hive exclusively to prevent multiple threads from whacking</span>
01287     <span class="comment">// on the list.</span>
01288     <span class="comment">//</span>
01289     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = CONTAINING_RECORD(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>,
01290                              <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>,
01291                              Hive);
01292     <a class="code" href="../../d1/d2/cmp_8h.html#a94">CmLockHive</a>(Hive);
01293     <span class="comment">//</span>
01294     <span class="comment">// Reread the notify block in case it has already been freed.</span>
01295     <span class="comment">//</span>
01296     NotifyBlock = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a>;
01297     <span class="keywordflow">if</span> (NotifyBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01298         <a class="code" href="../../d1/d2/cmp_8h.html#a95">CmUnlockHive</a>(Hive);
01299         <span class="keywordflow">return</span>;
01300     }
01301 
01302     <span class="comment">//</span>
01303     <span class="comment">// Clean up all PostBlocks waiting on the NotifyBlock</span>
01304     <span class="comment">//</span>
01305     <span class="keywordflow">if</span> (IsListEmpty(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01306         <a class="code" href="../../d1/d2/cmp_8h.html#a284">CmpPostNotify</a>(
01307             NotifyBlock,
01308             NULL,
01309             0,
01310             STATUS_NOTIFY_CLEANUP,
01311             NULL
01312             );
01313     }
01314 
01315     <span class="comment">//</span>
01316     <span class="comment">// Release the subject context</span>
01317     <span class="comment">//</span>
01318     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>(&amp;NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o5">SubjectContext</a>);
01319 
01320     <span class="comment">//</span>
01321     <span class="comment">// IMPLEMENTATION NOTE:</span>
01322     <span class="comment">//      If we ever do code to report names and types of events,</span>
01323     <span class="comment">//      this is the place to free the buffer.</span>
01324     <span class="comment">//</span>
01325 
01326     <span class="comment">//</span>
01327     <span class="comment">// Remove the NotifyBlock from the hive chain</span>
01328     <span class="comment">//</span>
01329     NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Blink-&gt;Flink = NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Flink;
01330     <span class="keywordflow">if</span> (NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01331         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Flink-&gt;Blink = NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Blink;
01332     }
01333 
01334     <span class="comment">// Protect for multiple deletion of the same object</span>
01335     <a class="code" href="../../d1/d2/cmp_8h.html#a2">CmpClearListEntry</a>(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>));
01336 
01337     KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01338 
01339 <span class="preprocessor">#ifdef _CM_ENTRYLIST_MANIPULATION</span>
01340 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (IsListEmpty(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01341         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFlushNotify: NotifyBlock %08lx\n"</span>,NotifyBlock);
01342         DbgBreakPoint();
01343     }
01344     <span class="comment">//check is the notify has been deleted from the hive notify list</span>
01345     {
01346         <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a> ValidNotifyBlock;
01347         PLIST_ENTRY NotifyPtr;
01348 
01349         NotifyPtr = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;NotifyList);
01350 
01351         <span class="keywordflow">while</span> (NotifyPtr-&gt;Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01352             NotifyPtr = NotifyPtr-&gt;Flink;
01353 
01354             ValidNotifyBlock = CONTAINING_RECORD(NotifyPtr, <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>, HiveList);
01355             <span class="keywordflow">if</span>( ValidNotifyBlock == NotifyBlock ) {
01356                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFlushNotify: NotifyBlock %08lx is about to be deleted but is still in the hive notify list\n"</span>,NotifyBlock);
01357                 DbgBreakPoint();
01358             }
01359         }
01360     }
01361     RtlZeroMemory((PVOID)NotifyBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>));
01362 <span class="preprocessor">#endif</span>
01363 <span class="preprocessor"></span>    
01364     <a class="code" href="../../d1/d2/cmp_8h.html#a95">CmUnlockHive</a>(Hive);
01365 
01366     <span class="comment">//</span>
01367     <span class="comment">// Free the block, clean up the KeyBody</span>
01368     <span class="comment">//</span>
01369     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NotifyBlock);
01370     <span class="keywordflow">return</span>;
01371 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="cmnotify.c::CmpFreeSlavePost" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpFreeSlavePost           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>MasterPostBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01634">1634</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00617">_CM_POST_BLOCK::CancelPostList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00048">CmpRemoveEntryList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">CMS_NOTIFY</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00632">IsMasterPostBlock</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00616">_CM_POST_BLOCK::ThreadList</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00804">CmpPostApc()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00922">CmpPostApcRunDown()</a>.
<p>
<pre class="fragment"><div>01639                    :
01640 
01641         Free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> slave post block related to <span class="keyword">this</span> master post block
01642 
01643 Arguments:
01644 
01645     MasterPostBlock - pointer to structure that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post requests.
01646                 It should be a master post!!
01647 Return Value:
01648 
01649     NONE.
01650 
01651 --*/
01652 {
01653     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  SlavePostBlock;
01654 
01655     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01656     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
01657         KdPrint((<span class="stringliteral">"CmpCancelSlavePost:\t"</span>));
01658         KdPrint((<span class="stringliteral">"MasterPostBlock:%08lx\n"</span>, MasterPostBlock));
01659     }
01660 
01661     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(MasterPostBlock));
01662 
01663     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
01664 <span class="preprocessor">#if DBG</span>
01665 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(MasterPostBlock-&gt;TraceIntoDebugger) {
01666             KdPrint((<span class="stringliteral">"[CM]CmCancelSlavePost: MasterPostBlock:%08lx\n"</span>, MasterPostBlock));
01667         }
01668 <span class="preprocessor">#endif</span>
01669 <span class="preprocessor"></span>    }
01670 
01671     <span class="keywordflow">if</span> (IsListEmpty(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01672         <span class="comment">//</span>
01673         <span class="comment">// Nothing to cancel, just return</span>
01674         <span class="comment">//</span>
01675         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
01676 <span class="preprocessor">#if DBG</span>
01677 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(MasterPostBlock-&gt;TraceIntoDebugger) {
01678                 KdPrint((<span class="stringliteral">"[CM]CmCancelSlavePost: MasterPostBlock:%08lx has no slaves\n"</span>, MasterPostBlock));
01679             }
01680 <span class="preprocessor">#endif</span>
01681 <span class="preprocessor"></span>        }
01682 
01683         <span class="keywordflow">return</span>;
01684     }
01685 
01686 
01687     <span class="comment">//</span>
01688     <span class="comment">// Pull all the entries in the cancel post list and unlink them (when they are slave requests)</span>
01689     <span class="comment">// We base here on the assumption that there is only one slave.</span>
01690     <span class="comment">//</span>
01691     <span class="comment">//     NOTE!!!</span>
01692     <span class="comment">//       When more than slave allowed, here to modify</span>
01693     <span class="comment">//</span>
01694 
01695 
01696     SlavePostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>.Flink;
01697     SlavePostBlock = CONTAINING_RECORD(SlavePostBlock,
01698                                        <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
01699                                        CancelPostList);
01700 
01701     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
01702 <span class="preprocessor">#if DBG</span>
01703 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(MasterPostBlock-&gt;TraceIntoDebugger) {
01704             KdPrint((<span class="stringliteral">"[CM]CmCancelSlavePost: Cleaning SlavePostBlock:%08lx\n"</span>, SlavePostBlock));
01705         }
01706 <span class="preprocessor">#endif</span>
01707 <span class="preprocessor"></span>    }
01708 
01709     <span class="comment">//</span>
01710     <span class="comment">// This should be true !</span>
01711     <span class="comment">//</span>
01712     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(SlavePostBlock) );
01713 
01714     <span class="comment">//</span>
01715     <span class="comment">// Unchain from the Master CancelPostList</span>
01716     <span class="comment">//</span>
01717     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01718     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>));
01719 
01720     <span class="comment">//</span>
01721     <span class="comment">// delist the post block from the thread postblocklist</span>
01722     <span class="comment">//</span>
01723     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01724     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01725 
01726     <span class="comment">//</span>
01727     <span class="comment">// Free the post block.</span>
01728     <span class="comment">//</span>
01729     <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(SlavePostBlock);
01730 
01731     <span class="comment">//</span>
01732     <span class="comment">// Result validation. was it the only slave?</span>
01733     <span class="comment">//</span>
01734     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>)));
01735 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="cmnotify.c::CmpNotifyChangeKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpNotifyChangeKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyBody</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PostBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionFilter</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WatchTree</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MasterPostBlock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">1378</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a164">CM_NOTIFY_BLOCK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01515">CmpInitializeKeyNameString()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">CMS_NOTIFY</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00264">CMS_POOL</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00265">ExAllocatePoolWithQuotaTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00562">_CM_NOTIFY_BLOCK::Filter</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00559">_CM_NOTIFY_BLOCK::HiveList</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00033">HiveList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00632">IsMasterPostBlock</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00561">_CM_NOTIFY_BLOCK::KeyBody</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00560">_CM_NOTIFY_BLOCK::KeyControlBlock</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00034">MAX_KEY_NAME_LENGTH</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00566">_CM_NOTIFY_BLOCK::NotifyPending</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00143">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00563">_CM_NOTIFY_BLOCK::PostList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00564">_CM_NOTIFY_BLOCK::SubjectContext</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00294">_CM_KEY_CONTROL_BLOCK::TotalLevels</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00070">WatchTree</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00565">_CM_NOTIFY_BLOCK::WatchTree</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>.
<p>
<pre class="fragment"><div>01389                    :
01390 
01391     This routine sets up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NotifyBlock, and attaches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PostBlock
01392     to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  When <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Notify <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> visible to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system,
01393     and will receive event reports.
01394 
01395     If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already an event report pending, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify
01396     call will be satisified at once.
01397 
01398 Arguments:
01399 
01400     KeyBody - pointer to key object that handle refers to, allows access
01401               to key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block, notify block, etc.
01402 
01403     PostBlock - pointer to structure that describes how/where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
01404                 <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be notified.
01405 
01406                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>:    PostBlock must come from Pool, THIS routine
01407                             will keep <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, back side will free <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  This
01408                             routine WILL free <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> in <span class="keywordflow">case</span> of error.
01409 
01410     CompletionFilter - what types of events <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller wants to see
01411 
01412     <a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a> - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to watch whole subtree, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to watch <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> immediate
01413                 key <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> applied to
01414 
01415     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - pointer to area to recieve notify data
01416 
01417     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - size of buffer, also size user would like to allocate
01418                  <span class="keywordflow">for</span> internal buffer
01419 
01420     MasterPostBlock - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master notification. Used to
01421                       insert <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PostBlock into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CancelPostList list.
01422 
01423 Return Value:
01424 
01425     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>.
01426 
01427 --*/
01428 {
01429     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    NotifyBlock;
01430     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    node;
01431     PLIST_ENTRY         ptr;
01432     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01433     KIRQL               OldIrql;
01434 
01435     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01436     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_NOTIFY) {
01437         KdPrint((<span class="stringliteral">"CmpNotifyChangeKey:\n"</span>));
01438         KdPrint((<span class="stringliteral">"\tKeyBody:%08lx PostBlock:%08lx "</span>, KeyBody, PostBlock));
01439         KdPrint((<span class="stringliteral">"Filter:%08lx WatchTree:%08lx\n"</span>, CompletionFilter, WatchTree));
01440 <span class="preprocessor">#if DBG</span>
01441 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
01442             WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01443             UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
01444 
01445             KdPrint((<span class="stringliteral">"[CM]CmpNotifyChangeKey: PostBlock:%08lx\tMasterBlock: %08lx\n"</span>, PostBlock,MasterPostBlock));
01446             NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, MAX_KEY_NAME_LENGTH);
01447             <span class="keywordflow">if</span>(NameBuffer&amp;&amp;KeyBody-&gt;KeyControlBlock-&gt;KeyNode) {
01448                <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(KeyBody-&gt;KeyControlBlock-&gt;KeyNode,&amp;KeyName,NameBuffer);
01449                KdPrint((<span class="stringliteral">"\t[CM]CmpNotifyChangeKey: Key = %.*S\n"</span>,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
01450                <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
01451             }
01452         }
01453 <span class="preprocessor">#endif</span>
01454 <span class="preprocessor"></span>    }
01455 
01456     <span class="comment">//</span>
01457     <span class="comment">// The registry lock should be aquired exclusively by the caller !!!</span>
01458     <span class="comment">//</span>
01459     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
01460 
01461     <span class="keywordflow">if</span> (KeyBody-&gt;KeyControlBlock-&gt;Delete) {
01462 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
01463 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeyBody-&gt;NotifyBlock == NULL );
01464 <span class="preprocessor">#endif</span>
01465 <span class="preprocessor"></span>        <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
01466         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
01467     }
01468 
01469     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = (<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)KeyBody-&gt;KeyControlBlock-&gt;KeyHive;
01470     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive);
01471     NotifyBlock = KeyBody-&gt;NotifyBlock;
01472 
01473     <span class="keywordflow">if</span> (NotifyBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01474         <span class="comment">//</span>
01475         <span class="comment">// Set up new notify session</span>
01476         <span class="comment">//</span>
01477         NotifyBlock = <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a>(PagedPool|POOL_QUOTA_FAIL_INSTEAD_OF_RAISE,<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>),CM_NOTIFYBLOCK_TAG);
01478         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_POOL) {
01479             KdPrint((<span class="stringliteral">"**CmpNotifyChangeKey: allocate:%08lx, "</span>, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>)));
01480             KdPrint((<span class="stringliteral">"type:%d, at:%08lx\n"</span>, PagedPool, NotifyBlock));
01481         }
01482 
01483         <span class="keywordflow">if</span> (NotifyBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01484             <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
01485             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01486         }
01487         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a> = KeyBody-&gt;KeyControlBlock;
01488         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o3">Filter</a> = CompletionFilter;
01489         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o6">WatchTree</a> = <a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>;
01490         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o7">NotifyPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01491         InitializeListHead(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>));
01492         KeyBody-&gt;NotifyBlock = NotifyBlock;
01493         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o2">KeyBody</a> = KeyBody;
01494         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeyBody-&gt;KeyControlBlock-&gt;Delete == FALSE );
01495 
01496         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_NOTIFY) {
01497 <span class="preprocessor">#if DBG</span>
01498 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
01499                 WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01500                 UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
01501 
01502                 NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, MAX_KEY_NAME_LENGTH);
01503                 <span class="keywordflow">if</span>(NameBuffer) {
01504                    <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(KeyBody-&gt;KeyControlBlock-&gt;KeyNode,&amp;KeyName,NameBuffer);
01505                    KdPrint((<span class="stringliteral">"[CM]\tCmpNotifyChangeKey: New NotifyBlock at:%08lx was allocated for Key = %.*S\n"</span>,NotifyBlock,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
01506                    <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
01507                 }
01508             }
01509 <span class="preprocessor">#endif</span>
01510 <span class="preprocessor"></span>        }
01511 
01512         <span class="comment">//</span>
01513         <span class="comment">// IMPLEMENTATION NOTE:</span>
01514         <span class="comment">//      If we ever want to actually return the buffers full of</span>
01515         <span class="comment">//      data, the buffer should be allocated and its address</span>
01516         <span class="comment">//      stored in the notify block here.</span>
01517         <span class="comment">//</span>
01518 
01519         <span class="comment">//</span>
01520         <span class="comment">// Capture the subject context so we can do checking once the</span>
01521         <span class="comment">// notify goes off.</span>
01522         <span class="comment">//</span>
01523         <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>(&amp;NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o5">SubjectContext</a>);
01524 
01525         <span class="comment">//</span>
01526         <span class="comment">// Attach notify block to hive in properly sorted order</span>
01527         <span class="comment">//</span>
01528         ptr = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;NotifyList);
01529         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01530             <span class="keywordflow">if</span> (ptr-&gt;Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01531                 <span class="comment">//</span>
01532                 <span class="comment">// End of list, add self after ptr.</span>
01533                 <span class="comment">//</span>
01534                 ptr-&gt;Flink = &amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>);
01535                 NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01536                 NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Blink = ptr;
01537                 <span class="keywordflow">break</span>;
01538             }
01539 
01540             ptr = ptr-&gt;Flink;
01541 
01542             node = CONTAINING_RECORD(ptr, <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>, HiveList);
01543 
01544             <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a> &gt;
01545                 KeyBody-&gt;KeyControlBlock-&gt;TotalLevels)
01546             {
01547                 <span class="comment">//</span>
01548                 <span class="comment">// ptr -&gt; notify with longer name than us, insert in FRONT</span>
01549                 <span class="comment">//</span>
01550                 NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Flink = ptr;
01551                 ptr-&gt;Blink-&gt;Flink = &amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>);
01552                 NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Blink = ptr-&gt;Blink;
01553                 ptr-&gt;Blink = &amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>);
01554                 <span class="keywordflow">break</span>;
01555             }
01556         }
01557     }
01558 
01559 
01560     <span class="comment">//</span>
01561     <span class="comment">// Add post block to front of notify block's list, and add it to thread list.</span>
01562     <span class="comment">//</span>
01563     InsertHeadList(
01564         &amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>),
01565         &amp;(PostBlock-&gt;NotifyList)
01566         );
01567 
01568 
01569 
01570     <span class="keywordflow">if</span>( <a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock) ) {
01571         <span class="comment">//</span>
01572         <span class="comment">// Protect against outrageous calls</span>
01573         <span class="comment">//</span>
01574         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PostBlock == MasterPostBlock);
01575 
01576         <span class="comment">//</span>
01577         <span class="comment">// When the notification is a master one, initialize the CancelPostList list</span>
01578         <span class="comment">//</span>
01579         InitializeListHead(&amp;(PostBlock-&gt;CancelPostList));
01580     } <span class="keywordflow">else</span> {
01581         <span class="comment">//</span>
01582         <span class="comment">// Add PostBlock at the end of the CancelPostList list from the master post</span>
01583         <span class="comment">//</span>
01584         InsertTailList(
01585             &amp;(MasterPostBlock-&gt;CancelPostList),
01586             &amp;(PostBlock-&gt;CancelPostList)
01587             );
01588     }
01589 
01590 
01591     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
01592     InsertHeadList(
01593         &amp;(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;PostBlockList),
01594         &amp;(PostBlock-&gt;ThreadList)
01595         );
01596 
01597     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_NOTIFY) {
01598 <span class="preprocessor">#if DBG</span>
01599 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
01600             KdPrint((<span class="stringliteral">"[CM]\tCmpNotifyChangeKey: Attaching the post:%08lx\t to thread:%08lx\n"</span>,PostBlock,<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()));
01601         }
01602 <span class="preprocessor">#endif</span>
01603 <span class="preprocessor"></span>    }
01604 
01605     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01606 
01607     <span class="comment">//</span>
01608     <span class="comment">// If there is a notify pending (will not be if we just created</span>
01609     <span class="comment">// the notify block) then post it at once.  Note that this call</span>
01610     <span class="comment">// ALWAYS returns STATUS_PENDING unless it fails.  Caller must</span>
01611     <span class="comment">// ALWAYS look in IoStatusBlock to see what happened.</span>
01612     <span class="comment">//</span>
01613     <span class="keywordflow">if</span> (NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o7">NotifyPending</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01614         <a class="code" href="../../d1/d2/cmp_8h.html#a284">CmpPostNotify</a>(
01615             NotifyBlock,
01616             NULL,
01617             0,
01618             STATUS_NOTIFY_ENUM_DIR,
01619             NULL
01620             );
01621         <span class="comment">//</span>
01622         <span class="comment">// return STATUS_SUCCESS to signal to the caller the the notify already been triggered</span>
01623         <span class="comment">//</span>
01624         <span class="keywordflow">return</span> STATUS_SUCCESS;
01625     }
01626 
01627     <span class="comment">//</span>
01628     <span class="comment">// return STATUS_PENDING to signal to the caller the the notify has not been triggered yet</span>
01629     <span class="comment">//</span>
01630     <span class="keywordflow">return</span> STATUS_PENDING;
01631 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="cmnotify.c::CmpNotifyTriggerCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpNotifyTriggerCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00281">281</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a175">CM_POST_BLOCK</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01032">CmpCheckNotifyAccess()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00615">_CM_POST_BLOCK::NotifyList</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a166">POST_BLOCK_TYPE</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00630">PostBlockType</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00357">CmpReportNotifyHelper()</a>.
<p>
<pre class="fragment"><div>00288                    :
00289 
00290     Checks <span class="keywordflow">if</span> a notify can be triggered
00291 
00292 Arguments:
00293 
00294     NotifyBlock - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify block
00295 
00296     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies hive containing node to match with.
00297 
00298     Node - pointer to key to match with (and check access to)
00299 
00300 
00301 Return Value:
00302 
00303     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - yes.
00304     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - no
00305 
00306 --*/
00307 {
00308     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> PostBlock;
00309     <a class="code" href="../../d1/d2/cmp_8h.html#a166">POST_BLOCK_TYPE</a> NotifyType;
00310 
00311     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00312 
00313     <span class="keywordflow">if</span>(IsListEmpty(&amp;(NotifyBlock-&gt;PostList)) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00314 
00315         <span class="comment">//</span>
00316         <span class="comment">// check if it is a kernel notify. Look at the first post block</span>
00317         <span class="comment">// to see that. If is a kernel post-block, then all posts in </span>
00318         <span class="comment">// the list should be kernel notifies</span>
00319         <span class="comment">//</span>
00320         PostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)NotifyBlock-&gt;PostList.Flink;
00321         PostBlock = CONTAINING_RECORD(PostBlock,
00322                                       <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
00323                                       NotifyList);
00324 
00325         NotifyType = <a class="code" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(PostBlock);
00326 
00327         <span class="keywordflow">if</span>( NotifyType == <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a> ) {
00328             <span class="comment">// this is a kernel notify; always trigger it</span>
00329 <span class="preprocessor">#if DBG</span>
00330 <span class="preprocessor"></span>            <span class="comment">//</span>
00331             <span class="comment">// DEBUG only code: All post blocks should be of the same type</span>
00332             <span class="comment">// (kernel/user)</span>
00333             <span class="comment">//</span>
00334             <span class="keywordflow">while</span>( PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>.Flink != &amp;(NotifyBlock-&gt;PostList) ) {
00335                 PostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>.Flink;
00336                 PostBlock = CONTAINING_RECORD(PostBlock,
00337                                             <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
00338                                             NotifyList);
00339                 
00340                 <span class="comment">//KdPrint(("CmpNotifyTriggerCheck : NotifyBlock = %lx\n",NotifyBlock));</span>
00341                 
00342                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(PostBlock) == NotifyType );
00343             }
00344 <span class="preprocessor">#endif</span>
00345 <span class="preprocessor"></span>        
00346             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00347         }
00348     }
00349 
00350     <span class="comment">//</span>
00351     <span class="comment">// else, check if the caller has the right access</span>
00352     <span class="comment">//</span>
00353     <span class="keywordflow">return</span> <a class="code" href="../../d7/d2/cmse_8c.html#a12">CmpCheckNotifyAccess</a>(NotifyBlock,Hive,Node);
00354 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="cmnotify.c::CmpPostApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpPostApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00804">804</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00607">_CM_POST_BLOCK_UNION::AsyncUser</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00085">CmpCheckPostBlock</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01634">CmpFreeSlavePost()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00048">CmpRemoveEntryList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l02019">CmpSetIoStatus</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">CMS_NOTIFY</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00596">_CM_ASYNC_USER_POST_BLOCK::IoStatusBlock</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00616">_CM_POST_BLOCK::ThreadList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00620">_CM_POST_BLOCK::u</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00594">_CM_ASYNC_USER_POST_BLOCK::UserEvent</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>.
<p>
<pre class="fragment"><div>00813                    :
00814 
00815     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel apc routine.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> all notifies,
00816     regardless of what form of notification <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller requested.
00817 
00818     We compute <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> postblock address from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> apc object address.
00819     IoStatus <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set.  SystemEvent and UserEvent will be signalled
00820     as appropriate.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user requested an APC, then NormalRoutine
00821     will be set at entry and executed when we <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>.  The PostBlock
00822     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed here.
00823 
00824 Arguments:
00825 
00826     Apc - pointer to apc object
00827 
00828     NormalRoutine - Will be called when we <span class="keywordflow">return</span>
00829 
00830     NormalContext - will be 1st argument to normal routine, ApcContext
00831                     passed in when <a class="code" href="../../d7/d7/ntapi_8c.html#a21">NtNotifyChangeKey</a> was called
00832 
00833     SystemArgument1 -  IN: <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value <span class="keywordflow">for</span> IoStatusBlock
00834                       OUT: <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a> to IoStatusBlock (2nd arg to user apc routine)
00835 
00836     SystemArgument2 - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PostBlock
00837 
00838 Return Value:
00839 
00840     NONE.
00841 
00842 --*/
00843 {
00844     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  PostBlock;
00845 
00846     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00847     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00848         KdPrint((<span class="stringliteral">"CmpPostApc:\n"</span>));
00849         KdPrint((<span class="stringliteral">"\tApc:%08lx "</span>, Apc));
00850         KdPrint((<span class="stringliteral">"NormalRoutine:%08lx\n"</span>, NormalRoutine));
00851         KdPrint((<span class="stringliteral">"\tNormalContext:%08lx"</span>, NormalContext));
00852         KdPrint((<span class="stringliteral">"\tSystemArgument1=IoStatusBlock:%08lx\n"</span>, SystemArgument1));
00853     }
00854 
00855 
00856     PostBlock = *(<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> *)SystemArgument2;
00857 
00858     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00859 <span class="preprocessor">#if DBG</span>
00860 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
00861             KdPrint((<span class="stringliteral">"[CM]CmpPostApc: PostBlock:%08lx\n"</span>, PostBlock));
00862         }
00863 <span class="preprocessor">#endif</span>
00864 <span class="preprocessor"></span>    }
00865     <span class="comment">//</span>
00866     <span class="comment">// Fill in IO Status Block</span>
00867     <span class="comment">//</span>
00868     <span class="comment">// IMPLEMENTATION NOTE:</span>
00869     <span class="comment">//      If we ever want to actually implement the code that returns</span>
00870     <span class="comment">//      names of things that changed, this is the place to copy the</span>
00871     <span class="comment">//      buffer into the caller's buffer.</span>
00872     <span class="comment">//</span>
00873     <span class="comment">//  Sundown only: Use a 32bit IO_STATUS_BLOCK if the caller is 32bit.</span>
00874 
00875     <span class="keywordflow">try</span> {
00876         <a class="code" href="../../d1/d2/cmp_8h.html#a151">CmpSetIoStatus</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o2">IoStatusBlock</a>, 
00877                        *((ULONG *)SystemArgument1), 
00878                        0L,
00879                        <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process != NULL);
00880     } except (EXCEPTION_EXECUTE_HANDLER) {
00881         NOTHING;
00882     }
00883     *SystemArgument1 = PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o2">IoStatusBlock</a>;
00884 
00885     <span class="comment">//</span>
00886     <span class="comment">// This is an Async notify, do all work here, including</span>
00887     <span class="comment">// cleaning up the post block</span>
00888     <span class="comment">//</span>
00889 
00890     <span class="comment">//</span>
00891     <span class="comment">// Signal UserEvent if present, and deref it.</span>
00892     <span class="comment">//</span>
00893     <span class="keywordflow">if</span> (PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00894         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>,
00895                    0,
00896                    FALSE);
00897         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>);
00898     }
00899 
00900     <span class="comment">//</span>
00901     <span class="comment">// remove the post block from the thread list, and free it</span>
00902     <span class="comment">//</span>
00903     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
00904     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
00905 
00906     <span class="comment">// debug only checks</span>
00907     <a class="code" href="../../d0/d2/cmnotify_8c.html#a0">CmpCheckPostBlock</a>(PostBlock);
00908     <span class="comment">//</span>
00909         <span class="comment">// Free the slave post block to avoid "dangling" postblocks</span>
00910         <span class="comment">//</span>
00911         <a class="code" href="../../d0/d2/cmnotify_8c.html#a4">CmpFreeSlavePost</a>(PostBlock);
00912     <span class="comment">//</span>
00913         <span class="comment">// free this post block</span>
00914         <span class="comment">// </span>
00915         <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
00916 
00917     <span class="keywordflow">return</span>;
00918 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="cmnotify.c::CmpPostApcRunDown" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpPostApcRunDown           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Apc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00922">922</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00607">_CM_POST_BLOCK_UNION::AsyncUser</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01634">CmpFreeSlavePost()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00048">CmpRemoveEntryList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l02019">CmpSetIoStatus</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">CMS_NOTIFY</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00596">_CM_ASYNC_USER_POST_BLOCK::IoStatusBlock</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00251">_KAPC::SystemArgument2</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00616">_CM_POST_BLOCK::ThreadList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00620">_CM_POST_BLOCK::u</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00594">_CM_ASYNC_USER_POST_BLOCK::UserEvent</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>.
<p>
<pre class="fragment"><div>00927                    :
00928 
00929     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to clear away apcs in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> apc queue
00930     of a thread that has been terminated.
00931 
00932     Since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> apc <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> apc queue, we know that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NOT in
00933     any NotifyBlock's post list.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>, however, in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> threads's
00934     PostBlockList.
00935 
00936     Therefore, poke any user events so that waiters are not stuck,
00937     drop <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> references so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event can be cleaned up, delist <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00938     PostBlock and free <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00939 
00940     Since we are cleaning up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread, SystemEvents are not interesting.
00941 
00942     Since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> apc <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> apc queue, we know that <span class="keywordflow">if</span> there were any other
00943     notifications related to <span class="keyword">this</span> one, they are cleaned up by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00944     CmPostNotify routine
00945 
00946 Arguments:
00947 
00948     Apc - pointer to apc object
00949 
00950 Return Value:
00951 
00952     NONE.
00953 
00954 --*/
00955 {
00956     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  PostBlock;
00957     KIRQL           OldIrql;
00958 
00959     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00960     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00961         KdPrint((<span class="stringliteral">"CmpApcRunDown:"</span>));
00962         KdPrint((<span class="stringliteral">"\tApc:%08lx \n"</span>, Apc));
00963     }
00964 
00965     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
00966 
00967     PostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a>;
00968 
00969     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00970 <span class="preprocessor">#if DBG</span>
00971 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
00972             KdPrint((<span class="stringliteral">"[CM]CmpPostApcRunDown: PostBlock:%08lx\n"</span>, PostBlock));
00973         }
00974 <span class="preprocessor">#endif</span>
00975 <span class="preprocessor"></span>    }
00976 
00977     <span class="comment">//</span>
00978     <span class="comment">// report status and wake up any threads that might otherwise</span>
00979     <span class="comment">// be stuck.  also drop any event references we hold</span>
00980     <span class="comment">//</span>
00981     <span class="comment">//  Sundown only: Use a 32bit IO_STATUS_BLOCK if the caller is 32bit. </span>
00982 
00983     <span class="keywordflow">try</span> {
00984         <a class="code" href="../../d1/d2/cmp_8h.html#a151">CmpSetIoStatus</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o2">IoStatusBlock</a>, 
00985                        STATUS_NOTIFY_CLEANUP, 
00986                        0L, 
00987                        <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process != NULL);
00988     } except (EXCEPTION_EXECUTE_HANDLER) {
00989         NOTHING;
00990     }
00991 
00992     <span class="keywordflow">if</span> (PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00993         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(
00994             PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>,
00995             0,
00996             FALSE
00997             );
00998         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>);
00999     }
01000 
01001     <span class="comment">//</span>
01002     <span class="comment">// delist the post block</span>
01003     <span class="comment">//</span>
01004     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01005     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01006 
01007         <span class="comment">//</span>
01008         <span class="comment">// Free the slave post block to avoid "dangling" postblocks</span>
01009         <span class="comment">//</span>
01010         <a class="code" href="../../d0/d2/cmnotify_8c.html#a4">CmpFreeSlavePost</a>(PostBlock);
01011     <span class="comment">//</span>
01012     <span class="comment">// Free the post block.  Use Ex call because PostBlocks are NOT</span>
01013     <span class="comment">// part of the global registry pool computation, but are instead</span>
01014     <span class="comment">// part of NonPagedPool with Quota.</span>
01015     <span class="comment">//</span>
01016     <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
01017 
01018     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01019 
01020     <span class="keywordflow">return</span>;
01021 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="cmnotify.c::CmpPostNotify" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpPostNotify           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Filter</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Status</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PLIST_ENTRY ExternalKeyDeref&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">487</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00595">_CM_ASYNC_USER_POST_BLOCK::Apc</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00345">ASSERT_CM_LOCK_OWNED</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00607">_CM_POST_BLOCK_UNION::AsyncUser</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00617">_CM_POST_BLOCK::CancelPostList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00634">ClearMasterPostBlockFlag</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01845">CmpAddToDelayedDeref()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01738">CmpCancelSlavePost()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00054">CmpClearListEntry</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01900">CmpDelayedDerefKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01515">CmpInitializeKeyNameString()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00048">CmpRemoveEntryList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">CMS_NOTIFY</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00075">Filter</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00632">IsMasterPostBlock</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00217">KeInsertQueueApc()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00560">_CM_NOTIFY_BLOCK::KeyControlBlock</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00295">_CM_KEY_CONTROL_BLOCK::KeyNode</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00643">LOCK_POST_LIST</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00034">MAX_KEY_NAME_LENGTH</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00615">_CM_POST_BLOCK::NotifyList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00566">_CM_NOTIFY_BLOCK::NotifyPending</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00619">_CM_POST_BLOCK::NotifyType</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00630">PostBlockType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00563">_CM_NOTIFY_BLOCK::PostList</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00633">SetMasterPostBlockFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00590">_CM_SYNC_POST_BLOCK::Status</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00606">_CM_POST_BLOCK_UNION::Sync</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00589">_CM_SYNC_POST_BLOCK::SystemEvent</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00616">_CM_POST_BLOCK::ThreadList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00620">_CM_POST_BLOCK::u</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00644">UNLOCK_POST_LIST</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/cmclose_8c-source.html#l00028">CmpCloseKeyObject()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">CmpFlushNotify()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">CmpNotifyChangeKey()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00357">CmpReportNotifyHelper()</a>.
<p>
<pre class="fragment"><div>00496                    :
00497 
00498     Actually report <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify event by signalling events, enqueing
00499     APCs, and so forth.
00500 
00501     When <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> STATUS_NOTIFY_CLEANUP:
00502 
00503       - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a slave one, just cancel <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00504       - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a master one, cancel all slave post blocks
00505         and trigger event on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master block.
00506 
00507 Comments:
00508     
00509     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">using</span> a <span class="stringliteral">"delayed dereferencing"</span> technique to prevent
00510     deadlocks that may appear when a keybody <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dereferenced <span class="keywordflow">while</span> holding
00511     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block lock. As <span class="keywordflow">for</span> <span class="keyword">this</span>, a list with keybodies that have to be 
00512     dereferenced <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> constructed <span class="keywordflow">while</span> walking <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of postblocks attached
00513     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current notify block and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> related (slave or master) post blocks.
00514     The list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> built by tricking postblocks. For all postblock about to be 
00515     freed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PostKeyBody member <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> local list and then set to <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00516     on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> postblock. This will avoid <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key body dereferencing in <a class="code" href="../../d1/d2/cmp_8h.html#a286">CmpFreePostBlock</a>.
00517     Instead, after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> postblock lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> released, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> local list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> iterated and 
00518     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> keybodies are dereferenced and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> storage <span class="keywordflow">for</span> associated <a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">CM_POST_KEY_BODY</a> 
00519     objects <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
00520 
00521   
00522 Arguments:
00523 
00524     NotifyBlock - pointer to structure that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify
00525                   operation.  (Where to post to)
00526 
00527     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - name of key at which event occurred.
00528 
00529     <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> - nature of event
00530 
00531     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - completion status to report
00532 
00533     ExternalKeyDeref - <span class="keyword">this</span> parameter (when not NULL) specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller doesn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> 
00534                     want any keybody to be dereferenced <span class="keywordflow">while</span> in <span class="keyword">this</span> routine
00535 
00536 Return Value:
00537 
00538     NONE.
00539 
00540 --*/
00541 {
00542     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>      PostBlock;
00543     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>      SlavePostBlock;
00544     LIST_ENTRY          LocalDelayedDeref;
00545     KIRQL               OldIrql;
00546     PLIST_ENTRY         DelayedDeref;
00547 
00548     <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>;
00549     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00550 
00551     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00552     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00553         KdPrint((<span class="stringliteral">"CmpPostNotify:\n"</span>));
00554         KdPrint((<span class="stringliteral">"\tNotifyBlock:%08lx  "</span>, NotifyBlock));
00555         KdPrint((<span class="stringliteral">"\tName = %wZ\n"</span>, Name));
00556         KdPrint((<span class="stringliteral">"\tFilter:%08lx  Status=%08lx\n"</span>, Filter, Status));
00557     }
00558     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
00559 
00560     <span class="keywordflow">if</span>( ARGUMENT_PRESENT(ExternalKeyDeref) ) {
00561         <span class="comment">//</span>
00562         <span class="comment">// The caller want to do all keybody dereferencing by himself</span>
00563         <span class="comment">//</span>
00564         DelayedDeref = ExternalKeyDeref;
00565     } <span class="keywordflow">else</span> {
00566         <span class="comment">// local delayed dereferencing (the caller doesn't care!)</span>
00567         DelayedDeref = &amp;LocalDelayedDeref;
00568         InitializeListHead(DelayedDeref);
00569     }
00570 
00571     <span class="comment">//</span>
00572     <span class="comment">// Aquire exclusive access over the postlist(s)</span>
00573     <span class="comment">//</span>
00574     <a class="code" href="../../d1/d2/cmp_8h.html#a92">LOCK_POST_LIST</a>();
00575 
00576     <span class="keywordflow">if</span> (IsListEmpty(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00577         <span class="comment">//</span>
00578         <span class="comment">// Nothing to post, set a mark and return</span>
00579         <span class="comment">//</span>
00580         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o7">NotifyPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00581         <a class="code" href="../../d1/d2/cmp_8h.html#a93">UNLOCK_POST_LIST</a>();
00582         <span class="keywordflow">return</span>;
00583     }
00584     NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o7">NotifyPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00585 
00586     <span class="comment">//</span>
00587     <span class="comment">// IMPLEMENTATION NOTE:</span>
00588     <span class="comment">//      If we ever want to actually implement the code that returns</span>
00589     <span class="comment">//      names of things that changed, this is the place to add the</span>
00590     <span class="comment">//      name and operation type to the buffer.</span>
00591     <span class="comment">//</span>
00592 
00593     <span class="comment">//</span>
00594     <span class="comment">// Pull and post all the entries in the post list</span>
00595     <span class="comment">//</span>
00596     <span class="keywordflow">while</span> (IsListEmpty(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00597 
00598         <span class="comment">//</span>
00599         <span class="comment">// Remove from the notify block list, and enqueue the apc.</span>
00600         <span class="comment">// The apc will remove itself from the thread list</span>
00601         <span class="comment">//</span>
00602         PostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)RemoveHeadList(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>));
00603         PostBlock = CONTAINING_RECORD(PostBlock,
00604                                       <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
00605                                       NotifyList);
00606 
00607         <span class="comment">// Protect for multiple deletion of the same object</span>
00608         <a class="code" href="../../d1/d2/cmp_8h.html#a2">CmpClearListEntry</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
00609         
00610         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00611 <span class="preprocessor">#if DBG</span>
00612 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
00613                 WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00614                 UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00615 
00616                 NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, MAX_KEY_NAME_LENGTH);
00617                 <span class="keywordflow">if</span>(NameBuffer) {
00618                    <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>,&amp;KeyName,NameBuffer);
00619                    KdPrint((<span class="stringliteral">"[CM]CmpPostNotify: NotifyBlock:%08lx\tKey = %.*S\n"</span>,NotifyBlock,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
00620                    <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
00621                 }
00622                 KdPrint((<span class="stringliteral">"[CM]\tCmpPostNotify: PostBlock:%08lx\n"</span>, PostBlock));
00623             }
00624 <span class="preprocessor">#endif</span>
00625 <span class="preprocessor"></span>        }
00626 
00627         <span class="keywordflow">if</span>( (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOTIFY_CLEANUP) &amp;&amp; !<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock) ) {
00628             <span class="comment">//</span>
00629             <span class="comment">// Cleanup notification (i.e. the key handle was closed or the key was deleted)</span>
00630             <span class="comment">// When the post is a slave one, just cancel it. Canceling means:</span>
00631             <span class="comment">//      1. Removing from the notify PostList (aldready done at this point - see above)</span>
00632             <span class="comment">//      2. Unchaining from the Master Block CancelPostList</span>
00633             <span class="comment">//      3. Delisting from the thread PostBlockList</span>
00634             <span class="comment">//      4. Actually freeing the memory</span>
00635             <span class="comment">//</span>
00636 
00637             <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
00638             <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>));
00639             <span class="comment">//</span>
00640             <span class="comment">// FIX 289351</span>
00641             <span class="comment">//</span>
00642             <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
00643             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
00644             <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
00645             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00646 
00647             <span class="keywordflow">if</span>( PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o4">NotifyType</a> != <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a> ) {
00648 
00649                 <span class="comment">// add to the deref list and clean the post block</span>
00650                 <a class="code" href="../../d0/d2/cmnotify_8c.html#a5">CmpAddToDelayedDeref</a>(PostBlock,DelayedDeref);
00651 
00652                 <span class="comment">//</span>
00653                 <span class="comment">// Front-end routine will do self cleanup for syncrounous notifications</span>
00654                 <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
00655             }
00656 
00657             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00658 <span class="preprocessor">#if DBG</span>
00659 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
00660                     KdPrint((<span class="stringliteral">"[CM]\tCmpPostNotify: PostBlock:%08lx is a slave block,and notify is CLEANUP==&gt; just cleanning\n"</span>, PostBlock));
00661                 }
00662 <span class="preprocessor">#endif</span>
00663 <span class="preprocessor"></span>            }
00664 
00665             <span class="keywordflow">continue</span>; <span class="comment">//try the next one</span>
00666         }
00667 
00668         <span class="comment">//</span>
00669         <span class="comment">// Simulate that this block is the master one, so we can free the others</span>
00670         <span class="comment">// Doing that will ensure the right memory dealocation when the master</span>
00671         <span class="comment">// (from now on this block) will be freed.</span>
00672         <span class="comment">//</span>
00673         <span class="keywordflow">if</span>(!<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock)) {
00674             <span class="comment">//</span>
00675             <span class="comment">// oops.,this is not the master block, we have some more work to do</span>
00676             <span class="comment">//</span>
00677             SlavePostBlock = PostBlock;
00678             <span class="keywordflow">do</span> {
00679                 SlavePostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>.Flink;
00680                 SlavePostBlock = CONTAINING_RECORD(SlavePostBlock,
00681                                                    <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
00682                                                    CancelPostList);
00683                 <span class="comment">//</span>
00684                 <span class="comment">// reset the "master flag" if set</span>
00685                 <span class="comment">//</span>
00686                 <a class="code" href="../../d1/d2/cmp_8h.html#a91">ClearMasterPostBlockFlag</a>(SlavePostBlock);
00687             } <span class="keywordflow">while</span> (SlavePostBlock != PostBlock);
00688 
00689             <span class="comment">//</span>
00690             <span class="comment">// Make this post block the master one</span>
00691             <span class="comment">//</span>
00692             <a class="code" href="../../d1/d2/cmp_8h.html#a90">SetMasterPostBlockFlag</a>(PostBlock);
00693         }
00694 
00695         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00696 <span class="preprocessor">#if DBG</span>
00697 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
00698                 KdPrint((<span class="stringliteral">"[CM]\tCmpPostNotify: Master block switched to :%08lx\n"</span>, PostBlock));
00699             }
00700 <span class="preprocessor">#endif</span>
00701 <span class="preprocessor"></span>        }
00702 
00703         <span class="comment">//</span>
00704         <span class="comment">// Cancel all slave Post requests that may be linked to self</span>
00705         <span class="comment">//</span>
00706 
00707         <span class="keywordflow">if</span>( <a class="code" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(PostBlock) != <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a> ) {
00708             <span class="comment">//</span>
00709             <span class="comment">// Front-end routine will do self cleanup for syncrounous notifications</span>
00710             <a class="code" href="../../d0/d2/cmnotify_8c.html#a3">CmpCancelSlavePost</a>(PostBlock,DelayedDeref);
00711             <span class="comment">//</span>
00712             <span class="comment">// Do the same for the master (in case master and slave got switched)</span>
00713             <span class="comment">// This will avoid dereferencing the keybody from CmpPostApc</span>
00714             <a class="code" href="../../d0/d2/cmnotify_8c.html#a5">CmpAddToDelayedDeref</a>(PostBlock,DelayedDeref);
00715         }
00716 
00717         <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(PostBlock)) {
00718             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>:
00719                 <span class="comment">//</span>
00720                 <span class="comment">// This is a SYNC notify call.  There will be no user event,</span>
00721                 <span class="comment">// and no user apc routine.  Quick exit here, just fill in</span>
00722                 <span class="comment">// the Status and poke the event.</span>
00723                 <span class="comment">//</span>
00724                 <span class="comment">// Holder of the systemevent will wake up and free the</span>
00725                 <span class="comment">// postblock.  If we free it here, we get a race &amp; bugcheck.</span>
00726                 <span class="comment">//</span>
00727                 <span class="comment">// Set the flink to NULL so that the front side can tell this</span>
00728                 <span class="comment">// has been removed if its wait aborts.</span>
00729                 <span class="comment">//</span>
00730                 PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00731                 PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o0">Sync</a>.<a class="code" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html#o1">Status</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00732                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o0">Sync</a>.<a class="code" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html#o0">SystemEvent</a>,
00733                            0,
00734                            FALSE);
00735                 <span class="keywordflow">break</span>;
00736 
00737             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>:
00738                 <span class="comment">//</span>
00739                 <span class="comment">// Insert the APC into the queue</span>
00740                 <span class="comment">//</span>
00741                 <a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o1">Apc</a>,
00742                                  (PVOID)ULongToPtr(Status),
00743                                  (PVOID)PostBlock,
00744                                  0);
00745                 <span class="keywordflow">break</span>;
00746 
00747             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>:
00748                 <span class="comment">//</span>
00749                 <span class="comment">// Queue the work item, then free the post block.</span>
00750                 <span class="comment">//</span>
00751                 <span class="keywordflow">if</span> (PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o1">WorkItem</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00752                     <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o1">WorkItem</a>,
00753                                     PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o2">QueueType</a>);
00754                 }
00755                 <span class="comment">//</span>
00756                 <span class="comment">// Signal Event if present, and deref it.</span>
00757                 <span class="comment">//</span>
00758                 <span class="keywordflow">if</span> (PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o0">Event</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00759                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o0">Event</a>,
00760                                0,
00761                                FALSE);
00762                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o0">Event</a>);
00763                 }
00764 
00765                                 <span class="comment">//</span>
00766                                 <span class="comment">// Multiple async kernel notification are not allowed</span>
00767                                 <span class="comment">//</span>
00768                                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>)) == TRUE);
00769                                 <span class="comment">//</span>
00770                 <span class="comment">// remove the post block from the thread list, and free it</span>
00771                 <span class="comment">//</span>
00772                 <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
00773                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
00774                 <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
00775                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00776                 
00777                 <span class="comment">// it was already added to delayed deref.</span>
00778                 <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
00779                 <span class="keywordflow">break</span>;
00780         }
00781     }
00782 
00783     <a class="code" href="../../d1/d2/cmp_8h.html#a93">UNLOCK_POST_LIST</a>();
00784 
00785     <span class="comment">//</span>
00786     <span class="comment">// At this point we have a list of keybody elements that have to be dereferenciated</span>
00787     <span class="comment">// and the associated storage for the covering objects freed. The keybodies in this </span>
00788     <span class="comment">// list have only one reference count on them (they were referenced only in </span>
00789     <span class="comment">// NtNotifyChangeMultipleKeys), dereferencing them here should free the object</span>
00790     <span class="comment">//</span>
00791 
00792     <span class="keywordflow">if</span>( ARGUMENT_PRESENT(ExternalKeyDeref) ) {
00793         <span class="comment">// do nothing; the caller wants to handle the dereferenciation by himself!</span>
00794     } <span class="keywordflow">else</span> {
00795         <span class="comment">// dereferenciate all keybodies in the delayed list</span>
00796         <a class="code" href="../../d0/d2/cmnotify_8c.html#a6">CmpDelayedDerefKeys</a>(DelayedDeref);
00797     }
00798    
00799     <span class="keywordflow">return</span>;
00800 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="cmnotify.c::CmpReportNotify" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpReportNotify           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Filter</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00191">191</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
<pre class="fragment"><div>00199                    :
00200 
00201     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a notifiable event occurs. It will
00202     apply <a class="code" href="../../d0/d2/cmnotify_8c.html#a2">CmpReportNotifyHelper</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event occured in,
00203     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master hive <span class="keywordflow">if</span> different.
00204 
00205 Arguments:
00206 
00207     KeyControlBlock - KCB of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key at which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event occured.
00208             For create or <span class="keyword">delete</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created or deleted key.
00209 
00210     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive containing cell of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> at which event occured.
00211 
00212     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - cell of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> at which event occured
00213 
00214             (hive and cell correspond with name.)
00215 
00216     <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> - event to be reported
00217 
00218 Return Value:
00219 
00220     NONE.
00221 
00222 --*/
00223 {
00224     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> pcell;
00225     ULONG       flags;
00226     ULONG       i;
00227 
00228     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00229     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_NOTIFY) {
00230         KdPrint((<span class="stringliteral">"CmpReportNotify:\n"</span>));
00231         KdPrint((<span class="stringliteral">"\tHive:%08lx Cell:%08lx Filter:%08lx\n"</span>, Hive, Cell, Filter));
00232     }
00233 
00234     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00235     <span class="comment">//</span>
00236     <span class="comment">// If the operation was create or delete, treat it as a change</span>
00237     <span class="comment">// to the parent.</span>
00238     <span class="comment">//</span>
00239     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> == REG_NOTIFY_CHANGE_NAME) {
00240         flags = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a>;
00241         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00242         <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
00243             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>);
00244             pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00245         }
00246 
00247 
00248         KeyControlBlock = KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
00249 
00250         <span class="comment">//</span>
00251         <span class="comment">// if we're at an exit/link node, back up the real node</span>
00252         <span class="comment">// that MUST be it's parent.</span>
00253         <span class="comment">//</span>
00254         <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a28">KEY_HIVE_EXIT</a>) {
00255             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00256         }
00257         pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00258     }
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// Report to notifies waiting on the event's hive</span>
00262     <span class="comment">//</span>
00263     <a class="code" href="../../d0/d2/cmnotify_8c.html#a2">CmpReportNotifyHelper</a>(KeyControlBlock, Hive, Hive, pcell, Filter);
00264 
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">// If containing hive is not the master hive, apply to master hive</span>
00268     <span class="comment">//</span>
00269     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> != &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>)) {
00270         <a class="code" href="../../d0/d2/cmnotify_8c.html#a2">CmpReportNotifyHelper</a>(KeyControlBlock,
00271                               &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
00272                               Hive,
00273                               pcell,
00274                               Filter);
00275     }
00276 
00277     <span class="keywordflow">return</span>;
00278 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="cmnotify.c::CmpReportNotifyHelper" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpReportNotifyHelper           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SearchHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Filter</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00357">357</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a164">CM_NOTIFY_BLOCK</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01900">CmpDelayedDerefKeys()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00281">CmpNotifyTriggerCheck()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00075">Filter</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00562">_CM_NOTIFY_BLOCK::Filter</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00033">HiveList</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00560">_CM_NOTIFY_BLOCK::KeyControlBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00295">_CM_KEY_CONTROL_BLOCK::KeyNode</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00651">_CMHIVE::NotifyList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00294">_CM_KEY_CONTROL_BLOCK::TotalLevels</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00565">_CM_NOTIFY_BLOCK::WatchTree</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00191">CmpReportNotify()</a>.
<p>
<pre class="fragment"><div>00366                    :
00367 
00368     Scan <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of active notifies <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified hive.  For
00369     any with scope including KeyControlBlock and filter <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a>
00370     <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>, and with proper security access, post <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify.
00371 
00372 Arguments:
00373 
00374     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - canonical <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> name (as in a key control block) of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key
00375             at which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event occured.  (This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name <span class="keywordflow">for</span>
00376             reporting purposes.)
00377 
00378     SearchHive - hive to search <span class="keywordflow">for</span> matches (which notify list to check)
00379 
00380     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies hive containing node to match with.
00381 
00382     Node - pointer to key to match with (and check access to)
00383 
00384     <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> - <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of event
00385 
00386 Return Value:
00387 
00388     NONE.
00389 
00390 --*/
00391 {
00392     PLIST_ENTRY         NotifyPtr;
00393     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    NotifyBlock;
00394     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>             CmSearchHive;
00395     PUNICODE_STRING     NotifyName;
00396     KIRQL               OldIrql;
00397     LIST_ENTRY          DelayedDeref;
00398 
00399     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00400 
00401     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
00402 
00403     CmSearchHive = CONTAINING_RECORD(SearchHive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive);
00404 
00405     NotifyPtr = &amp;(CmSearchHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o2">NotifyList</a>);
00406 
00407     InitializeListHead(&amp;(DelayedDeref));
00408 
00409     <span class="keywordflow">while</span> (NotifyPtr-&gt;Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00410 
00411         NotifyPtr = NotifyPtr-&gt;Flink;
00412 
00413         NotifyBlock = CONTAINING_RECORD(NotifyPtr, <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>, HiveList);
00414         <span class="keywordflow">if</span> (NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a> &gt; KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a>) {
00415             <span class="comment">//</span>
00416             <span class="comment">// list is level sorted, we're past all shorter entries</span>
00417             <span class="comment">//</span>
00418             <span class="keywordflow">break</span>;
00419         } <span class="keywordflow">else</span> {
00420             <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00421             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> LevelDiff, l;
00422 
00423             LevelDiff = KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a> - NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a>;
00424 
00425             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = KeyControlBlock;
00426             <span class="keywordflow">for</span> (l=0; l&lt;LevelDiff; l++) {
00427                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ParentKcb;
00428             }
00429 
00430             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> == NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a>) {
00431                 <span class="comment">//</span>
00432                 <span class="comment">// This Notify path is the prefix of this kcb.</span>
00433                 <span class="comment">//</span>
00434                 <span class="keywordflow">if</span> ((NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o3">Filter</a> &amp; <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>)
00435                             &amp;&amp;
00436                     ((NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o6">WatchTree</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ||
00437                      (Node == NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>))
00438                    )
00439                 {
00440                     <span class="comment">// Filter matches, this event is relevent to this notify</span>
00441                     <span class="comment">//                  AND</span>
00442                     <span class="comment">// Either the notify spans the whole subtree, or the cell</span>
00443                     <span class="comment">// (key) of interest is the one it applies to</span>
00444                     <span class="comment">//</span>
00445                     <span class="comment">// THEREFORE:   The notify is relevent.</span>
00446                     <span class="comment">//</span>
00447 
00448                     <span class="comment">//</span>
00449                     <span class="comment">// Correct scope, does caller have access?</span>
00450                     <span class="comment">//</span>
00451                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/cmnotify_8c.html#a7">CmpNotifyTriggerCheck</a>(NotifyBlock,Hive,Node)) {
00452                         <span class="comment">//</span>
00453                         <span class="comment">// Notify block has KEY_NOTIFY access to the node</span>
00454                         <span class="comment">// the event occured at.  It is relevent.  Therefore,</span>
00455                         <span class="comment">// it gets to see this event.  Post and be done.</span>
00456                         <span class="comment">//</span>
00457                         <span class="comment">// we specify that we want no key body dereferenciation </span>
00458                         <span class="comment">// during the CmpPostNotify call. This is to prevent the </span>
00459                         <span class="comment">// deletion of the current notify block</span>
00460                         <span class="comment">//</span>
00461                         <a class="code" href="../../d1/d2/cmp_8h.html#a284">CmpPostNotify</a>(
00462                             NotifyBlock,
00463                             NULL,
00464                             Filter,
00465                             STATUS_NOTIFY_ENUM_DIR,
00466                             &amp;DelayedDeref
00467                             );
00468 
00469                     }  <span class="comment">// else no KEY_NOTIFY access to node event occured at</span>
00470                 } <span class="comment">// else not relevent (wrong scope, filter, etc)</span>
00471             }
00472         }
00473     }
00474     
00475     <span class="comment">//</span>
00476     <span class="comment">// finish the job started in CmpPostNotify (i.e. dereference the keybodies</span>
00477     <span class="comment">// we prevented. this may cause some notifyblocks to be freed</span>
00478     <span class="comment">//</span>
00479     <a class="code" href="../../d0/d2/cmnotify_8c.html#a6">CmpDelayedDerefKeys</a>(&amp;DelayedDeref);
00480     
00481     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00482     <span class="keywordflow">return</span>;
00483 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="cmnotify.c::CmpMasterHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="el" href="../../d6/d3/cmwraper_8c.html#a7">CmpMasterHive</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00093">93</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:09 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
