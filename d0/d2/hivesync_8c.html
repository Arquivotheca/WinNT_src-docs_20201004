<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hivesync.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hivesync.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d1/d1/hivesync_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a0">DumpDirtyVector</a>(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a2">HvpWriteLog</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a3">HvpFindNextDirtyBlock</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, PRTL_BITMAP <a class="el" href="../../d2/d1/structBitMap.html">BitMap</a>, PULONG Current, PUCHAR *Address, PULONG Length, PULONG <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a4">HvpDiscardBins</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a5">HvpTruncateBins</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a6">HvRefreshHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a8">HvIsBinDirty</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>, ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a10">HvMarkClean</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>, ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a11">HvpGrowLog1</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG <a class="el" href="../../d6/d0/cmdat_8c.html#a5">Count</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a12">HvpGrowLog2</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a13">HvSyncHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a14">HvpDoWriteHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG FileType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a15">HvWriteHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a16">HvpDiscardBins</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a17">HvpTruncateBins</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/hivesync_8c.html#a1">HvShutdownComplete</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="hivesync.c::DumpDirtyVector" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DumpDirtyVector          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00052">52</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a8" doxytag="hivesync.c::HvIsBinDirty" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvIsBinDirty           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00200">200</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
<pre class="fragment"><div>00207                    :
00208 
00209     Given a hive and a cell, checks whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bin containing
00210     that cell has any dirty clusters or not.
00211 
00212 Arguments:
00213 
00214     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure
00215 
00216     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>.
00217 
00218 Return Value:
00219 
00220     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> contains dirty data.
00221 
00222     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> does not contain dirty data.
00223 
00224 --*/
00225 
00226 {
00227     ULONG       Type;
00228     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>      pcell;
00229     PRTL_BITMAP Bitmap;
00230     ULONG       First;
00231     ULONG       Last;
00232     ULONG       i;
00233     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Map;
00234     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00235 
00236     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_IO) {
00237         KdPrint((<span class="stringliteral">"HvIsBinDirty:\n\t"</span>));
00238         KdPrint((<span class="stringliteral">"Hive:%08lx Cell:%08lx\n"</span>, Hive, Cell));
00239     }
00240 
00241     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00242     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00243 
00244     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00245 
00246     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) ||
00247          (Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) )
00248     {
00249         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00250     }
00251 
00252     Bitmap = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00253 
00254     Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Cell);
00255     <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,Cell);
00256     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00257     First = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00258     Last = (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> - 1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00259 
00260     <span class="keywordflow">for</span> (i=First; i&lt;=Last; i++) {
00261         <span class="keywordflow">if</span> (RtlCheckBit(Bitmap, i)==1) {
00262             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00263         }
00264     }
00265     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00266 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="hivesync.c::HvMarkCellDirty" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvMarkCellDirty           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">117</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00187">HBIN_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">HvMarkDirty()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00292">HvpGetHCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00192">_HBIN::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00164">_HCELL::Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00161">USE_OLD_CELL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01087">CmpAddToLeaf()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00323">CmpCheckKey()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01704">CmpInsertSecurityCellList()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01608">CmpMarkIndexDirty()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00245">CmpMarkKeyDirty()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01870">CmpMarkKeyParentDirty()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01767">CmpMarkKeyValuesDirty()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01257">CmpSelectLeaf()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01472">CmpSplitLeaf()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01841">CmSetLastWriteTimeKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>.
<p>
<pre class="fragment"><div>00123                    :
00124 
00125     Marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified cell dirty.
00126 
00127 Arguments:
00128 
00129     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00130             hive of interest
00131 
00132     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - hcell_index of cell that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being edited
00133 
00134 Return Value:
00135 
00136     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00137 
00138     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - could not allocate log space, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>!
00139 
00140 --*/
00141 {
00142     ULONG       Type;
00143     ULONG       <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00144     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>      pCell;
00145     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Me;
00146     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Base;
00147     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00148 
00149     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_IO) {
00150         KdPrint((<span class="stringliteral">"HvMarkCellDirty:\n\t"</span>));
00151         KdPrint((<span class="stringliteral">"Hive:%08lx Cell:%08lx\n"</span>, Hive, Cell));
00152     }
00153 
00154     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00155     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00156     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00157 
00158     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00159 
00160     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) ||
00161          (Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) )
00162     {
00163         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00164     }
00165 
00166     pCell = <a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive,Cell);
00167 <span class="preprocessor">#if DBG</span>
00168 <span class="preprocessor"></span>    Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Cell);
00169     <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Cell);
00170     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00171     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> == HBIN_SIGNATURE);
00172 <span class="preprocessor">#endif</span>
00173 <span class="preprocessor"></span>    <span class="comment">//</span>
00174     <span class="comment">// If it's an old format hive, mark the entire</span>
00175     <span class="comment">// bin dirty, because the Last backpointers are</span>
00176     <span class="comment">// such a pain to deal with in the partial</span>
00177     <span class="comment">// alloc and free-coalescing cases.</span>
00178     <span class="comment">//</span>
00179 
00180     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00181         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Cell);
00182         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Cell);
00183         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00184         Base = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>;
00185         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00186         <span class="keywordflow">return</span> <a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(Hive, Base, Size);
00187     } <span class="keywordflow">else</span> {
00188         <span class="keywordflow">if</span> (pCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &lt; 0) {
00189             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = -pCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00190         } <span class="keywordflow">else</span> {
00191             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = pCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00192         }
00193         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Size &lt; Bin-&gt;Size);
00194         <span class="keywordflow">return</span> <a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(Hive, Cell-FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>,u.NewCell), Size);
00195     }
00196 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="hivesync.c::HvMarkClean" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvMarkClean           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Start</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00401">401</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d8/tbitmap_8c-source.html#l00028">BitMap</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>.
<p>
<pre class="fragment"><div>00408                    :
00409 
00410     Clears <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dirty bits <span class="keywordflow">for</span> a given portion of a hive.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00411     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inverse of <a class="code" href="../../d6/d0/hive_8h.html#a43">HvMarkDirty</a>, although <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not give up any
00412     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> space in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary or log that <a class="code" href="../../d6/d0/hive_8h.html#a43">HvMarkDirty</a> may have reserved.
00413 
00414     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a noop <span class="keywordflow">for</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a> address range.
00415 
00416 Arguments:
00417 
00418     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00419             hive of interest
00420 
00421     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - supplies a hive <span class="keyword">virtual</span> address (i.e., an HCELL_INDEX or
00422              like form address) of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> area to mark dirty.
00423 
00424     Length - inclusive length in bytes of area to mark dirty.
00425 
00426 Return Value:
00427 
00428     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00429 
00430 --*/
00431 {
00432     ULONG       Type;
00433     PRTL_BITMAP <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
00434     ULONG       First;
00435     ULONG       Last;
00436     ULONG       i;
00437     ULONG       Cluster;
00438 
00439     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_IO) {
00440         KdPrint((<span class="stringliteral">"HvMarkClean:\n\t"</span>));
00441         KdPrint((<span class="stringliteral">"Hive:%08lx Start:%08lx Length:%08lx\n"</span>, Hive, Start, Length));
00442     }
00443 
00444 
00445     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00446     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00447     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00448 
00449     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Start);
00450 
00451     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) ||
00452          (Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) )
00453     {
00454         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00455     }
00456 
00457     <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00458 
00459     First = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00460     Last = (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> + Length - 1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00461 
00462     Cluster = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00463     <span class="keywordflow">if</span> (Cluster &gt; 1) {
00464 
00465         <span class="comment">//</span>
00466         <span class="comment">// Force Start down to base of cluster</span>
00467         <span class="comment">// Force End up to top of cluster</span>
00468         <span class="comment">//</span>
00469         First = First &amp; ~(Cluster - 1);
00470         Last = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Last+1, Cluster) - 1;
00471     }
00472 
00473     <span class="keywordflow">if</span> (Last &gt;= <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>-&gt;SizeOfBitMap) {
00474         Last = <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>-&gt;SizeOfBitMap-1;
00475     }
00476 
00477     <span class="comment">//</span>
00478     <span class="comment">// Subtract out the dirty count and</span>
00479     <span class="comment">// and clear the dirty bits.</span>
00480     <span class="comment">//</span>
00481     <span class="keywordflow">for</span> (i=First; i&lt;=Last; i++) {
00482         <span class="keywordflow">if</span> (RtlCheckBit(BitMap,i)==1) {
00483             --<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a>;
00484             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a>(BitMap, i, 1);
00485         }
00486     }
00487     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00488 
00489     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00490 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="hivesync.c::HvMarkDirty" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvMarkDirty           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Start</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">270</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d8/tbitmap_8c-source.html#l00028">BitMap</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00097">CmpLazyFlush()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00204">HIVE_NOLAZYFLUSH</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00495">HvpGrowLog1()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00171">HvpMarkBinReadWrite</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01634">RtlSetBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>, and <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00847">HvpRecoverData()</a>.
<p>
<pre class="fragment"><div>00277                    :
00278 
00279     Marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relevent parts of a hive dirty, so that they will
00280     be flushed to backing store.
00281 
00282     If <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not 1, then adjacent all logical sectors
00283     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given cluster will be forced dirty (and log space
00284     allocated <span class="keywordflow">for</span> them.)  This must be done here rather than in
00285     HvSyncHive so that we can know how much to grow the log.
00286 
00287     This is a noop <span class="keywordflow">for</span> Volatile address range.
00288 
00289     NOTE:   Range will not be marked dirty <span class="keywordflow">if</span> operation fails.
00290 
00291 Arguments:
00292 
00293     Hive - supplies a pointer to the hive control structure <span class="keywordflow">for</span> the
00294             hive of interest
00295 
00296     Start - supplies a hive <span class="keyword">virtual</span> address (i.e., an HCELL_INDEX or
00297              like form address) of the start of the area to mark dirty.
00298 
00299     Length - inclusive length in bytes of area to mark dirty.
00300 
00301 Return Value:
00302 
00303     TRUE - it worked
00304 
00305     FALSE - could not allocate log space, failure!
00306 
00307 --*/
00308 {
00309     ULONG       Type;
00310     PRTL_BITMAP <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
00311     ULONG       First;
00312     ULONG       Last;
00313     ULONG       i;
00314     ULONG       Cluster;
00315     ULONG       OriginalDirtyCount;
00316     ULONG       DirtySectors;
00317     BOOLEAN     Result = TRUE;
00318 
00319     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_IO) {
00320         KdPrint((<span class="stringliteral">"HvMarkDirty:\n\t"</span>));
00321         KdPrint((<span class="stringliteral">"Hive:%08lx Start:%08lx Length:%08lx\n"</span>, Hive, Start, Length));
00322     }
00323 
00324 
00325     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00326     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00327     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00328 
00329     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Start);
00330 
00331     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; HIVE_VOLATILE) ||
00332          (Type == Volatile) )
00333     {
00334         <span class="keywordflow">return</span> TRUE;
00335     }
00336 
00337 
00338     <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00339     OriginalDirtyCount = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a>;
00340 
00341     First = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00342     Last = (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> + Length - 1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00343 
00344     Cluster = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00345     <span class="keywordflow">if</span> (Cluster &gt; 1) {
00346 
00347         <span class="comment">//</span>
00348         <span class="comment">// Force Start down to base of cluster</span>
00349         <span class="comment">// Force End up to top of cluster</span>
00350         <span class="comment">//</span>
00351         First = First &amp; ~(Cluster - 1);
00352         Last = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Last+1, Cluster) - 1;
00353     }
00354 
00355     <span class="keywordflow">if</span> (Last &gt;= <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>-&gt;SizeOfBitMap) {
00356         Last = <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>-&gt;SizeOfBitMap-1;
00357     }
00358 
00359     <span class="comment">//</span>
00360     <span class="comment">// Try and grow the log enough to accomodate all the dirty sectors.</span>
00361     <span class="comment">//</span>
00362     DirtySectors = 0;
00363     <span class="keywordflow">for</span> (i = First; i &lt;= Last; i++) {
00364         <span class="keywordflow">if</span> (RtlCheckBit(<a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>, i)==0) {
00365             ++DirtySectors;
00366         }
00367     }
00368     <span class="keywordflow">if</span> (DirtySectors != 0) {
00369         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a11">HvpGrowLog1</a>(Hive, DirtySectors) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00370             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00371         }
00372     
00373         <span class="keywordflow">if</span> ((OriginalDirtyCount == 0) &amp;&amp; (First != 0)) {
00374             Result = <a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(Hive, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));  <span class="comment">// force header of 1st bin dirty</span>
00375             <span class="keywordflow">if</span> (Result==<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00376                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00377             }
00378         }
00379     
00380         <span class="comment">//</span>
00381         <span class="comment">// Log has been successfully grown, go ahead</span>
00382         <span class="comment">// and set the dirty bits.</span>
00383         <span class="comment">//</span>
00384         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00385         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> += DirtySectors;
00386         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a>(<a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>, First, Last-First+1);
00387     }
00388 
00389     <span class="comment">// mark this bin as writable</span>
00390     <a class="code" href="../../d1/d2/cmp_8h.html#a12">HvpMarkBinReadWrite</a>(Hive,Start);
00391         
00392     <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>)) {
00393         <a class="code" href="../../d6/d3/cmwraper_8c.html#a11">CmpLazyFlush</a>();
00394     }
00395     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00396     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00397 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="hivesync.c::HvpDiscardBins" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpDiscardBins           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01885">1885</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00058">ASSERT_LISTENTRY</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00588">_FREE_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00589">_FREE_HBIN::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00583">FREE_HBIN_DISCARDABLE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00414">HMAP_DISCARDABLE</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>.
<p>
<pre class="fragment"><div>01891                    :
01892 
01893     Walks through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dirty bins in a hive to see <span class="keywordflow">if</span> any are marked
01894     discardable.  If so, they are discarded and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated to
01895     reflect <span class="keyword">this</span>.
01896 
01897 Arguments:
01898 
01899     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure.
01900 
01901 Return Value:
01902 
01903     None.
01904 
01905 --*/
01906 
01907 {
01908     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
01909     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Map;
01910     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> PreviousMap;
01911     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> NextMap;
01912     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a> FreeBin;
01913     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a> PreviousFreeBin;
01914     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a> NextFreeBin;
01915     PLIST_ENTRY <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
01916 
01917     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeBins.Flink;
01918 
01919     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> != &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeBins) {
01920         <a class="code" href="../../d6/d0/hive_8h.html#a3">ASSERT_LISTENTRY</a>(List);
01921         FreeBin = CONTAINING_RECORD(List, <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>, ListEntry);
01922 
01923         <span class="keywordflow">if</span> (FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>) {
01924             Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>);
01925             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>);
01926             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01927             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; HMAP_DISCARDABLE);
01928             <span class="comment">//</span>
01929             <span class="comment">// Note we use ExFreePool directly here to avoid</span>
01930             <span class="comment">// giving back the quota for this bin. By charging</span>
01931             <span class="comment">// registry quota for discarded bins, we prevent</span>
01932             <span class="comment">// sparse hives from requiring more quota after</span>
01933             <span class="comment">// a reboot than on a running system.</span>
01934             <span class="comment">//</span>
01935             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Bin);
01936             FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp;= ~<a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>;
01937         }
01938         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>=<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Flink;
01939     }
01940 
01941 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="hivesync.c::HvpDiscardBins" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpDiscardBins           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="hivesync.c::HvpDoWriteHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvpDoWriteHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">775</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d9/d8/tbitmap_8c-source.html#l00028">BitMap</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00348">_HBASE_BLOCK::CheckSum</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00345">_HBASE_BLOCK::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00227">CmpDoFileSetSize()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00480">CMP_OFFSET_ARRAY::DataBuffer</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00481">CMP_OFFSET_ARRAY::DataLength</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00603">_HHIVE::FileFlush</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00479">CMP_OFFSET_ARRAY::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00601">_HHIVE::FileWrite</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00342">_HBASE_BLOCK::Format</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00323">HBASE_BLOCK_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00329">HBASE_FORMAT_MEMORY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00058">HLOG_MINSIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00325">HSYS_MAJOR</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01233">HvpFindNextDirtyBlock()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d0/d1/hivesum_8c-source.html#l00031">HvpHeaderCheckSum()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00344">_HBASE_BLOCK::Length</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00619">_HHIVE::Log</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00624">_HHIVE::LogSize</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00339">_HBASE_BLOCK::Major</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00336">_HBASE_BLOCK::Sequence1</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00337">_HBASE_BLOCK::Sequence2</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00335">_HBASE_BLOCK::Signature</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00338">_HBASE_BLOCK::TimeStamp</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00196">_HBIN::TimeStamp</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00341">_HBASE_BLOCK::Type</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>.
<p>
<pre class="fragment"><div>00781                    :
00782 
00783     Write dirty parts of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> to either its primary or alternate
00784     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  Write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> header, flush, write all data, flush, update header,
00785     flush.  Assume either logging or primary/alternate pairs used.
00786 
00787     NOTE:   TimeStamp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not set, assumption <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that <a class="code" href="../../d0/d2/hivesync_8c.html#a2">HvpWriteLog</a> set
00788             that.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> used <span class="keywordflow">for</span> checking <span class="keywordflow">if</span> Logs correspond anyway.
00789 
00790 Arguments:
00791 
00792     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> <span class="keywordflow">for</span> which dirty data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be written.
00793 
00794     FileType - indicated whether primary or alternate <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> should be written.
00795 
00796 Return Value:
00797 
00798     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00799 
00800     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> failed
00801 
00802 --*/
00803 {
00804     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
00805     ULONG           <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00806     PUCHAR          Address;
00807     ULONG           Length;
00808     BOOLEAN         rc;
00809     ULONG           Current;
00810     PRTL_BITMAP     <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
00811     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00812     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00813     BOOLEAN         ShrinkHive;
00814     <a class="code" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a> offsetArray;
00815     <a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html">CMP_OFFSET_ARRAY</a> offsetElement;
00816     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00817     ULONG SetBitCount;
00818 
00819     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_IO) {
00820         KdPrint((<span class="stringliteral">"HvpDoWriteHive:\n\t"</span>));
00821         KdPrint((<span class="stringliteral">"Hive:%08lx FileType:%08lx\n"</span>, Hive, FileType));
00822     }
00823 
00824     <span class="comment">//</span>
00825     <span class="comment">// flush first, so that the filesystem structures get written to</span>
00826     <span class="comment">// disk if we have grown the file.</span>
00827     <span class="comment">//</span>
00828     <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileType)) {
00829         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00830     }
00831 
00832     BaseBlock = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>;
00833 
00834     <span class="keywordflow">if</span> (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> &gt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length) {
00835         ShrinkHive = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00836     } <span class="keywordflow">else</span> {
00837         ShrinkHive = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00838     }
00839 
00840     <span class="comment">//</span>
00841     <span class="comment">// --- Write out header first time, flush ---</span>
00842     <span class="comment">//</span>
00843     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> == HBASE_BLOCK_SIGNATURE);
00844     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> == HSYS_MAJOR);
00845     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a> == HBASE_FORMAT_MEMORY);
00846     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00847 
00848 
00849     <span class="keywordflow">if</span> (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a> != BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>) {
00850 
00851         <span class="comment">//</span>
00852         <span class="comment">// Some previous log attempt failed, or this hive needs to</span>
00853         <span class="comment">// be recovered, so punt.</span>
00854         <span class="comment">//</span>
00855         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00856     }
00857 
00858     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length;
00859 
00860     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a>++;
00861     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
00862     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o10">Cluster</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00863     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a> = <a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock);
00864 
00865     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
00866     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o0">FileOffset</a> = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00867     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o1">DataBuffer</a> = (PVOID) BaseBlock;
00868     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o2">DataLength</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00869     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
00870             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00871             FileType,
00872             &amp;offsetElement,
00873             1,
00874             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
00875             );
00876 
00877     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00878         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00879     }
00880     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileType)) {
00881         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00882     }
00883     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Offset, HBLOCK_SIZE);
00884 
00885     <span class="comment">//</span>
00886     <span class="comment">// --- Write out dirty data (only if there is any) ---</span>
00887     <span class="comment">//</span>
00888 
00889     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00890         <span class="comment">//</span>
00891         <span class="comment">// First sector of first bin will always be dirty, write it out</span>
00892         <span class="comment">// with the TimeStamp value overlaid on its Link field.</span>
00893         <span class="comment">//</span>
00894         <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00895 
00896         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RtlCheckBit(BitMap, 0) == 1);
00897         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RtlCheckBit(BitMap, (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> - 1)) == 1);
00898         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(LIST_ENTRY) &gt;= <span class="keyword">sizeof</span>(LARGE_INTEGER));
00899 
00900         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, 0);
00901         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,0);
00902         Address = (PUCHAR)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
00903         Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00904         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Address;
00905         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o4">TimeStamp</a> = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>;
00906 
00907         offsetElement.FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00908         offsetElement.DataBuffer = (PVOID) Address;
00909         offsetElement.DataLength = Length;
00910         rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
00911                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00912                 FileType,
00913                 &amp;offsetElement,
00914                 1,
00915                 &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
00916                 );
00917         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Offset % (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * HSECTOR_SIZE)) == 0);
00918         <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00919             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00920         }
00921 
00922 
00923         <span class="comment">//</span>
00924         <span class="comment">// Write out the rest of the dirty data</span>
00925         <span class="comment">//</span>
00926         Current = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;        <span class="comment">// don't rewrite 1st bin or header</span>
00927 
00928         SetBitCount = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(BitMap);
00929         offsetArray =
00930             (<a class="code" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a>)
00931             <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
00932                            <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html">CMP_OFFSET_ARRAY</a>) * SetBitCount);
00933         <span class="keywordflow">if</span> (offsetArray == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00934             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00935         }
00936         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00937 
00938         <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a3">HvpFindNextDirtyBlock</a>(
00939                     Hive,
00940                     BitMap,
00941                     &amp;Current,
00942                     &amp;Address,
00943                     &amp;Length,
00944                     &amp;Offset
00945                     ) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
00946         {
00947             <span class="comment">// Gather data into array.</span>
00948             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Count &lt; SetBitCount);
00949             offsetArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00950             offsetArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].DataBuffer = Address;
00951             offsetArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].DataLength = Length;
00952             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += Length;
00953             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++;
00954             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Offset % (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * HSECTOR_SIZE)) == 0);
00955         }
00956 
00957             rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
00958                     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00959                     FileType,
00960             offsetArray,
00961             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>,
00962             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>             <span class="comment">// Just an OUT parameter which returns the point</span>
00963                                 <span class="comment">// in the file after the last write.</span>
00964                     );
00965         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(offsetArray);
00966             <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00967                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00968         }
00969     }
00970 
00971     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileType)) {
00972         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00973     }
00974 
00975     <span class="comment">//</span>
00976     <span class="comment">// --- Write header again to report completion ---</span>
00977     <span class="comment">//</span>
00978     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>++;
00979     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a> = <a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock);
00980     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
00981 
00982     offsetElement.FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00983     offsetElement.DataBuffer = (PVOID) BaseBlock;
00984     offsetElement.DataLength = <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00985     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
00986             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00987             FileType,
00988             &amp;offsetElement,
00989             1,
00990             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
00991             );
00992     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00993         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00994     }
00995 
00996     <span class="keywordflow">if</span> (ShrinkHive) {
00997         <span class="comment">//</span>
00998         <span class="comment">// Hive has shrunk, give up the excess space.</span>
00999         <span class="comment">//</span>
01000         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a13">CmpDoFileSetSize</a>(Hive, FileType, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Stable].Length + HBLOCK_SIZE);
01001     }
01002 
01003     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileType)) {
01004         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01005     }
01006 
01007     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a>) &amp;&amp;
01008         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a4">HLOG_MINSIZE</a>(Hive))) {
01009         <span class="comment">//</span>
01010         <span class="comment">// Shrink log back down, reserve at least two clusters</span>
01011         <span class="comment">// worth of space so that if all the disk space is</span>
01012         <span class="comment">// consumed, there will still be enough space prereserved</span>
01013         <span class="comment">// to allow a minimum of registry operations so the user</span>
01014         <span class="comment">// can log on.</span>
01015         <span class="comment">//</span>
01016         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a13">CmpDoFileSetSize</a>(Hive, HFILE_TYPE_LOG, <a class="code" href="../../d0/d1/hivedata_8h.html#a4">HLOG_MINSIZE</a>(Hive));
01017         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a4">HLOG_MINSIZE</a>(Hive);
01018     }
01019 
01020     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01021 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="hivesync.c::HvpFindNextDirtyBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvpFindNextDirtyBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PRTL_BITMAP&nbsp;</td>
          <td class="mdname" nowrap> <em>BitMap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Current</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Offset</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01233">1233</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d9/d8/tbitmap_8c-source.html#l00028">BitMap</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00050">End</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00588">_FREE_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00187">HBIN_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00120">HCELL_OFFSET_MASK</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00414">HMAP_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00130">HSECTOR_COUNT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01025">HvpWriteLog()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01584">HvRefreshHive()</a>.
<p>
<pre class="fragment"><div>01243                    :
01244 
01245     This routine finds and reports <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> largest run of dirty logical
01246     sectors in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive, which are contiguous in memory and on disk.
01247 
01248 Arguments:
01249 
01250     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> of interest.
01251 
01252     <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> - supplies a pointer to a bitmap structure, which
01253                 describes what <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dirty.
01254 
01255     Current - supplies a pointer to a varible that tracks position
01256                 in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bitmap.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a bitnumber.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated by
01257                 <span class="keyword">this</span> call.
01258 
01259     Address - supplies a pointer to a variable to receive a pointer
01260                 to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> area in memory to be written <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.
01261 
01262     Length - supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length
01263                 of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region to read/write
01264 
01265     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> - supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset
01266                 in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> backing <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data should be written.
01267                 (not valid <span class="keywordflow">for</span> log files)
01268 
01269 Return Value:
01270 
01271     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - more to write, ret values good
01272 
01273     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - all data has been written
01274 
01275 --*/
01276 {
01277     ULONG       i;
01278     ULONG       EndOfBitMap;
01279     ULONG       <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
01280     ULONG       <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
01281     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> FileBaseAddress;
01282     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> FileEndAddress;
01283     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Me;
01284     PUCHAR      Block;
01285     PUCHAR      StartBlock;
01286     PUCHAR      NextBlock;
01287     ULONG       RunSpan;
01288     ULONG       RunLength;
01289     ULONG       FileLength;
01290     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>  FreeBin;
01291 
01292     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_IO) {
01293         KdPrint((<span class="stringliteral">"HvpFindNextDirtyBlock:\n\t"</span>));
01294         KdPrint((<span class="stringliteral">"Hive:%08lx Current:%08lx\n"</span>, Hive, *Current));
01295     }
01296 
01297 
01298     EndOfBitMap = <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>-&gt;SizeOfBitMap;
01299 
01300     <span class="keywordflow">if</span> (*Current &gt;= EndOfBitMap) {
01301         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01302     }
01303 
01304     <span class="comment">//</span>
01305     <span class="comment">// Find next run of set bits</span>
01306     <span class="comment">//</span>
01307     <span class="keywordflow">for</span> (i = *Current; i &lt; EndOfBitMap; i++) {
01308         <span class="keywordflow">if</span> (RtlCheckBit(BitMap, i) == 1) {
01309             <span class="keywordflow">break</span>;
01310         }
01311     }
01312     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = i;
01313 
01314     <span class="keywordflow">for</span> ( ; i &lt; EndOfBitMap; i++) {
01315         <span class="keywordflow">if</span> (RtlCheckBit(BitMap, i) == 0) {
01316             <span class="keywordflow">break</span>;
01317         }
01318     }
01319     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = i;
01320 
01321 
01322     <span class="comment">//</span>
01323     <span class="comment">// Compute hive virtual addresses, beginning file address, memory address</span>
01324     <span class="comment">//</span>
01325     FileBaseAddress = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01326     FileEndAddress = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01327     FileLength = FileEndAddress - FileBaseAddress;
01328     <span class="keywordflow">if</span> (FileLength == 0) {
01329         *Address = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01330         *Current = 0xffffffff;
01331         *Length = 0;
01332         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01333     }
01334     Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, FileBaseAddress);
01335     <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,FileBaseAddress);
01336 
01337     <span class="keywordflow">if</span> (Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) {
01338         FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
01339         StartBlock = (PUCHAR)((Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>) + FileBaseAddress - FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> );
01340     } <span class="keywordflow">else</span> {
01341         StartBlock = (PUCHAR)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
01342     }
01343 
01344     Block = StartBlock;
01345     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; HMAP_BASE))-&gt;Signature == HBIN_SIGNATURE);
01346     *Address = Block + (FileBaseAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a13">HCELL_OFFSET_MASK</a>);
01347 
01348     *<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = FileBaseAddress + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01349 
01350     <span class="comment">//</span>
01351     <span class="comment">// Build up length.  First, account for sectors in first block.</span>
01352     <span class="comment">//</span>
01353     RunSpan = <a class="code" href="../../d0/d1/hivedata_8h.html#a16">HSECTOR_COUNT</a> - (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> % <a class="code" href="../../d0/d1/hivedata_8h.html#a16">HSECTOR_COUNT</a>);
01354 
01355     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> - <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>) &lt;= RunSpan) {
01356 
01357         <span class="comment">//</span>
01358         <span class="comment">// Entire length is in first block, return it</span>
01359         <span class="comment">//</span>
01360         *Length = FileLength;
01361         *Current = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
01362         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01363 
01364     } <span class="keywordflow">else</span> {
01365 
01366         RunLength = RunSpan * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01367         FileBaseAddress = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(FileBaseAddress+1, HBLOCK_SIZE);
01368 
01369     }
01370 
01371     <span class="comment">//</span>
01372     <span class="comment">// Scan forward through blocks, filling up length as we go.</span>
01373     <span class="comment">//</span>
01374     <span class="comment">// NOTE:    This loop grows forward 1 block at time.  If we were</span>
01375     <span class="comment">//          really clever we'd fill forward a bin at time, since</span>
01376     <span class="comment">//          bins are always contiguous.  But most bins will be</span>
01377     <span class="comment">//          one block long anyway, so we won't bother for now.</span>
01378     <span class="comment">//</span>
01379     <span class="keywordflow">while</span> (RunLength &lt; FileLength) {
01380 
01381         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, FileBaseAddress);
01382         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,FileBaseAddress);
01383         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; HMAP_BASE))-&gt;Signature == HBIN_SIGNATURE);
01384 
01385         <span class="keywordflow">if</span> (Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) {
01386             FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
01387             NextBlock = (PUCHAR)((Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>) + FileBaseAddress - FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> );
01388         } <span class="keywordflow">else</span> {
01389             NextBlock = (PUCHAR)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
01390         }
01391 
01392         <span class="keywordflow">if</span> ( (NextBlock - Block) != <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
01393 
01394             <span class="comment">//</span>
01395             <span class="comment">// We've hit a discontinuity in memory.  RunLength is</span>
01396             <span class="comment">// as long as it's going to get.</span>
01397             <span class="comment">//</span>
01398             <span class="keywordflow">break</span>;
01399         }
01400 
01401 
01402         <span class="keywordflow">if</span> ((FileEndAddress - FileBaseAddress) &lt;= <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
01403 
01404             <span class="comment">//</span>
01405             <span class="comment">// We've reached the tail block, all is contiguous,</span>
01406             <span class="comment">// fill up to end and return.</span>
01407             <span class="comment">//</span>
01408             *Length = FileLength;
01409             *Current = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
01410             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01411         }
01412 
01413         <span class="comment">//</span>
01414         <span class="comment">// Just another contiguous block, fill forward</span>
01415         <span class="comment">//</span>
01416         RunLength += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01417         RunSpan += <a class="code" href="../../d0/d1/hivedata_8h.html#a16">HSECTOR_COUNT</a>;
01418         FileBaseAddress += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01419         Block = NextBlock;
01420     }
01421 
01422     <span class="comment">//</span>
01423     <span class="comment">// We either hit a discontinuity, OR, we're at the end of the range</span>
01424     <span class="comment">// we're trying to fill.  In either case, return.</span>
01425     <span class="comment">//</span>
01426     *Length = RunLength;
01427     *Current = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> + RunSpan;
01428     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01429 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="hivesync.c::HvpGrowLog1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvpGrowLog1           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Count</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00495">495</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00600">_HHIVE::FileSetSize</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00041">HLOG_GROW</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00619">_HHIVE::Log</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00624">_HHIVE::LogSize</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">HvMarkDirty()</a>.
<p>
<pre class="fragment"><div>00501                    :
00502 
00503     Adjust <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <span class="keywordflow">for</span> growth in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sectors of dirty
00504     data that are desired.
00505 
00506 Arguments:
00507 
00508     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00509             hive of interest
00510 
00511     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - number of additional logical sectors of log space needed
00512 
00513 Return Value:
00514 
00515     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00516 
00517     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - could not allocate log space, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>!
00518 
00519 --*/
00520 {
00521     ULONG   ClusterSize;
00522     ULONG   RequiredSize;
00523     ULONG   tmp;
00524 
00525     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_IO) {
00526         KdPrint((<span class="stringliteral">"HvpGrowLog1:\n\t"</span>));
00527         KdPrint((<span class="stringliteral">"Hive:%08lx Count:%08lx\n"</span>, Hive, Count));
00528     }
00529 
00530     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00531     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00532 
00533     <span class="comment">//</span>
00534     <span class="comment">// If logging is off, tell caller world is OK.</span>
00535     <span class="comment">//</span>
00536     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00537         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00538     }
00539 
00540     ClusterSize = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00541 
00542     tmp = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap / 8;   <span class="comment">// bytes</span>
00543     tmp += <span class="keyword">sizeof</span>(ULONG);                       <span class="comment">// signature</span>
00544 
00545     RequiredSize =
00546         ClusterSize  +                                  <span class="comment">// 1 cluster for header</span>
00547         <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(tmp, ClusterSize) +
00548         ((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> + <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>) * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>);
00549 
00550     RequiredSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(RequiredSize, HLOG_GROW);
00551 
00552     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00553 
00554     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>, RequiredSize)) {
00555         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00556     }
00557 
00558     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> = RequiredSize;
00559     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00560     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00561 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="hivesync.c::HvpGrowLog2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvpGrowLog2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00565">565</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00600">_HHIVE::FileSetSize</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00041">HLOG_GROW</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00619">_HHIVE::Log</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00624">_HHIVE::LogSize</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>.
<p>
<pre class="fragment"><div>00571                    :
00572 
00573     Adjust <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <span class="keywordflow">for</span> growth in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive, in particular,
00574     account <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> increased space needed <span class="keywordflow">for</span> a bigger dirty vector.
00575 
00576 Arguments:
00577 
00578     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00579             hive of interest
00580 
00581     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - proposed growth in size in bytes.
00582 
00583 Return Value:
00584 
00585     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00586 
00587     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - could not allocate log space, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>!
00588 
00589 --*/
00590 {
00591     ULONG   ClusterSize;
00592     ULONG   RequiredSize;
00593     ULONG   DirtyBytes;
00594 
00595     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_IO) {
00596         KdPrint((<span class="stringliteral">"HvpGrowLog2:\n\t"</span>));
00597         KdPrint((<span class="stringliteral">"Hive:%08lx Size:%08lx\n"</span>, Hive, Size));
00598     }
00599 
00600     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00601     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00602 
00603 
00604     <span class="comment">//</span>
00605     <span class="comment">// If logging is off, tell caller world is OK.</span>
00606     <span class="comment">//</span>
00607     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00608         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00609     }
00610 
00611     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (Size % HSECTOR_SIZE) == 0 );
00612 
00613     ClusterSize = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00614 
00615     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Stable].Length + Size) / HSECTOR_SIZE) % 8) == 0);
00616 
00617     DirtyBytes = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap / 8) +
00618                     ((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>) / 8) +
00619                     <span class="keyword">sizeof</span>(ULONG);                      <span class="comment">// signature</span>
00620     DirtyBytes = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(DirtyBytes, ClusterSize);
00621 
00622     RequiredSize =
00623         ClusterSize  +                                  <span class="comment">// 1 cluster for header</span>
00624         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>) +
00625         DirtyBytes;
00626 
00627     RequiredSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(RequiredSize, HLOG_GROW);
00628 
00629     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00630 
00631     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>, RequiredSize)) {
00632         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00633     }
00634 
00635     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> = RequiredSize;
00636     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00637     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00638 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="hivesync.c::HvpTruncateBins" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpTruncateBins           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01946">1946</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00588">_FREE_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00111">HCELL_TYPE_MASK</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00414">HMAP_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00071">HSTORAGE_TYPE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00076">HTYPE_COUNT</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00160">HvFreeHivePartial()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>.
<p>
<pre class="fragment"><div>01952                    :
01953 
01954     Attempts to shrink <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive by truncating any bins that are discardable at
01955     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.  Applies to both stable and <span class="keyword">volatile</span> storage.
01956 
01957 Arguments:
01958 
01959     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive to be truncated.
01960 
01961 Return Value:
01962 
01963     None.
01964 
01965 --*/
01966 
01967 {
01968     <a class="code" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> i;
01969     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Map;
01970     ULONG NewLength;
01971     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a> FreeBin;
01972 
01973     <span class="comment">//</span>
01974     <span class="comment">// stable and volatile</span>
01975     <span class="comment">//</span>
01976     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d0/d1/hivedata_8h.html#a5">HTYPE_COUNT</a>;i++) {
01977 
01978         <span class="comment">//</span>
01979         <span class="comment">// find the last in-use bin in the hive</span>
01980         <span class="comment">//</span>
01981         NewLength = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[i].Length;
01982 
01983         <span class="keywordflow">while</span> (NewLength &gt; 0) {
01984             Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, (NewLength - HBLOCK_SIZE) + (i*HCELL_TYPE_MASK));
01985             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,(NewLength - HBLOCK_SIZE) + (i*HCELL_TYPE_MASK));
01986             <span class="keywordflow">if</span> (Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) {
01987                 FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
01988                 NewLength = FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>;
01989             } <span class="keywordflow">else</span> {
01990                 <span class="keywordflow">break</span>;
01991             }
01992         }
01993 
01994         <span class="keywordflow">if</span> (NewLength &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[i].Length) {
01995             <span class="comment">//</span>
01996             <span class="comment">// There are some free bins to truncate.</span>
01997             <span class="comment">//</span>
01998             <a class="code" href="../../d2/d1/hivefree_8c.html#a1">HvFreeHivePartial</a>(Hive, NewLength, i);
01999         }
02000     }
02001 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="hivesync.c::HvpTruncateBins" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpTruncateBins           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="hivesync.c::HvpWriteLog" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvpWriteLog           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01025">1025</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d9/d8/tbitmap_8c-source.html#l00028">BitMap</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00348">_HBASE_BLOCK::CheckSum</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00345">_HBASE_BLOCK::Cluster</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00480">CMP_OFFSET_ARRAY::DataBuffer</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00481">CMP_OFFSET_ARRAY::DataLength</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00603">_HHIVE::FileFlush</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00479">CMP_OFFSET_ARRAY::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00601">_HHIVE::FileWrite</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00342">_HBASE_BLOCK::Format</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00323">HBASE_BLOCK_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00329">HBASE_FORMAT_MEMORY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00354">HLOG_DV_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00353">HLOG_HEADER_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00325">HSYS_MAJOR</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01233">HvpFindNextDirtyBlock()</a>, <a class="el" href="../../d0/d1/hivesum_8c-source.html#l00031">HvpHeaderCheckSum()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00339">_HBASE_BLOCK::Major</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00336">_HBASE_BLOCK::Sequence1</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00337">_HBASE_BLOCK::Sequence2</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00335">_HBASE_BLOCK::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00338">_HBASE_BLOCK::TimeStamp</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00341">_HBASE_BLOCK::Type</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>.
<p>
<pre class="fragment"><div>01030                    :
01031 
01032     Write a header, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DirtyVector, and all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dirty data into
01033     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  Do flushes at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> right places.  Update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> header.
01034 
01035 Arguments:
01036 
01037     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> <span class="keywordflow">for</span> which dirty data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be logged.
01038 
01039 Return Value:
01040 
01041     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
01042 
01043     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> failed
01044 
01045 --*/
01046 {
01047     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
01048     ULONG           <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01049     PUCHAR          Address;
01050     ULONG           Length;
01051     BOOLEAN         rc;
01052     ULONG           Current;
01053     ULONG           junk;
01054     ULONG           ClusterSize;
01055     ULONG           HeaderLength;
01056     PRTL_BITMAP     <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
01057     ULONG           DirtyVectorSignature = <a class="code" href="../../d0/d1/hivedata_8h.html#a32">HLOG_DV_SIGNATURE</a>;
01058     LARGE_INTEGER   systemtime;
01059     <a class="code" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a> offsetArray;
01060     <a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html">CMP_OFFSET_ARRAY</a> offsetElement;
01061     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
01062     ULONG SetBitCount;
01063 
01064     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_IO) {
01065         KdPrint((<span class="stringliteral">"HvpWriteLog:\n\t"</span>));
01066         KdPrint((<span class="stringliteral">"Hive:%08lx\n"</span>, Hive));
01067     }
01068 
01069     <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>;
01070     <span class="comment">//</span>
01071     <span class="comment">// --- Write out header first time, flush ---</span>
01072     <span class="comment">//</span>
01073     BaseBlock = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>;
01074     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> == HBASE_BLOCK_SIGNATURE);
01075     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> == HSYS_MAJOR);
01076     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a> == HBASE_FORMAT_MEMORY);
01077     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
01078 
01079 
01080     <span class="keywordflow">if</span> (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a> != BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>) {
01081 
01082         <span class="comment">//</span>
01083         <span class="comment">// Some previous log attempt failed, or this hive needs to</span>
01084         <span class="comment">// be recovered, so punt.</span>
01085         <span class="comment">//</span>
01086         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01087     }
01088 
01089     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a>++;
01090     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;systemtime);
01091     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a> = systemtime;
01092 
01093     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>;
01094 
01095     ClusterSize = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01096     HeaderLength = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(HLOG_HEADER_SIZE, ClusterSize);
01097     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o10">Cluster</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
01098 
01099     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a> = <a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock);
01100 
01101     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
01102     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o0">FileOffset</a> = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01103     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o1">DataBuffer</a> = (PVOID) BaseBlock;
01104     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o2">DataLength</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
01105     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
01106             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01107             <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
01108             &amp;offsetElement,
01109             1,
01110             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
01111             );
01112     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01113         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01114     }
01115     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Offset, HeaderLength);
01116     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>)) {
01117         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01118     }
01119 
01120     <span class="comment">//</span>
01121     <span class="comment">// --- Write out dirty vector ---</span>
01122     <span class="comment">//</span>
01123     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(ULONG) == <span class="keyword">sizeof</span>(DirtyVectorSignature));  <span class="comment">// See GrowLog1 above</span>
01124     offsetElement.FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01125     offsetElement.DataBuffer = (PVOID) &amp;DirtyVectorSignature;
01126     offsetElement.DataLength = <span class="keyword">sizeof</span>(DirtyVectorSignature);
01127     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
01128             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01129             <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
01130             &amp;offsetElement,
01131             1,
01132             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
01133             );
01134     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01135         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01136     }
01137 
01138     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap / 8;
01139     Address = (PUCHAR)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer);
01140     offsetElement.FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01141     offsetElement.DataBuffer = (PVOID) Address;
01142     offsetElement.DataLength = Length;
01143     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
01144             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01145             <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
01146             &amp;offsetElement,
01147             1,
01148             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
01149             );
01150     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01151         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01152     }
01153     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Offset, ClusterSize);
01154 
01155     <span class="comment">//</span>
01156     <span class="comment">// --- Write out body of log ---</span>
01157     <span class="comment">//</span>
01158     SetBitCount = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(BitMap);
01159     offsetArray =
01160         (<a class="code" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a>)
01161         <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
01162                        <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html">CMP_OFFSET_ARRAY</a>) * SetBitCount);
01163     <span class="keywordflow">if</span> (offsetArray == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01164         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01165     }
01166     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
01167 
01168     Current = 0;
01169     <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a3">HvpFindNextDirtyBlock</a>(
01170                 Hive,
01171                 BitMap,
01172                 &amp;Current,
01173                 &amp;Address,
01174                 &amp;Length,
01175                 &amp;junk
01176                 ) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
01177     {
01178         <span class="comment">// Gather data into array.</span>
01179         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Count &lt; SetBitCount);
01180         offsetArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01181         offsetArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].DataBuffer = Address;
01182         offsetArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].DataLength = Length;
01183         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += Length;
01184         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++;
01185         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Offset % ClusterSize) == 0);
01186     }
01187 
01188         rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
01189                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01190                 <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
01191         offsetArray,
01192         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>,
01193         &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>             <span class="comment">// Just an OUT parameter which returns the point</span>
01194                             <span class="comment">// in the file after the last write.</span>
01195                 );
01196     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(offsetArray);
01197         <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01198             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01199         }
01200 
01201     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>)) {
01202         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01203     }
01204 
01205     <span class="comment">//</span>
01206     <span class="comment">// --- Write header again to report completion ---</span>
01207     <span class="comment">//</span>
01208     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>++;
01209     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a> = <a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock);
01210     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
01211     offsetElement.FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01212     offsetElement.DataBuffer = (PVOID) BaseBlock;
01213     offsetElement.DataLength = <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
01214     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
01215             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01216             <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
01217             &amp;offsetElement,
01218             1,
01219             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
01220             );
01221     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01222         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01223     }
01224     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>)) {
01225         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01226     }
01227 
01228     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01229 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="hivesync.c::HvRefreshHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvRefreshHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="hivesync.c::HvSyncHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvSyncHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">647</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00620">_HHIVE::Alternate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00052">DumpDirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00569">HFILE_TYPE_ALTERNATE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01885">HvpDiscardBins()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01946">HvpTruncateBins()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01025">HvpWriteLog()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00076">HvShutdownComplete</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10281">IoSetThreadHardErrorMode()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00619">_HHIVE::Log</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00266">RtlClearAllBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02195">CmpDoFlushAll()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00124">EhCloseHive()</a>, and <a class="el" href="../../d0/d4/edithive_8c-source.html#l00156">EhOpenHive()</a>.
<p>
<pre class="fragment"><div>00652                    :
00653 
00654     Force backing store to match <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory image of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>
00655     part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive's space.
00656 
00657     Logs, primary, and alternate data can be written.  Primary <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00658     always written.  Normally either a log or an alternate, but
00659     not both, will also be written.
00660 
00661     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> possible to write <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary.
00662 
00663     All dirty bits will be set clear.
00664 
00665 Arguments:
00666 
00667     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00668             hive of interest
00669 
00670 Return Value:
00671 
00672     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00673 
00674     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - some <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00675 
00676 --*/
00677 {
00678     BOOLEAN oldFlag;
00679 
00680     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_IO) {
00681         KdPrint((<span class="stringliteral">"HvSyncHive:\n\t"</span>));
00682         KdPrint((<span class="stringliteral">"Hive:%08lx\n"</span>, Hive));
00683     }
00684 
00685     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00686     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00687 
00688     <span class="comment">//</span>
00689     <span class="comment">// Punt if post shutdown</span>
00690     <span class="comment">//</span>
00691     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a13">HvShutdownComplete</a>) {
00692         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_IO) {
00693             KdPrint((<span class="stringliteral">"HvSyncHive:  Attempt to sync AFTER SHUTDOWN\n"</span>));
00694         }
00695         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00696     }
00697 
00698     <span class="comment">//</span>
00699     <span class="comment">// If nothing dirty, do nothing</span>
00700     <span class="comment">//</span>
00701     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == 0) {
00702         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00703     }
00704 
00705     <a class="code" href="../../d0/d2/hivesync_8c.html#a17">HvpTruncateBins</a>(Hive);
00706 
00707     <span class="comment">//</span>
00708     <span class="comment">// If hive is volatile, do nothing</span>
00709     <span class="comment">//</span>
00710     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) {
00711         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00712     }
00713 
00714     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_IO) {
00715         KdPrint((<span class="stringliteral">"\tDirtyCount:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a>));
00716         KdPrint((<span class="stringliteral">"\tDirtyVector:"</span>));
00717         <a class="code" href="../../d0/d2/hivesync_8c.html#a0">DumpDirtyVector</a>(Hive);
00718     }
00719 
00720     <span class="comment">//</span>
00721     <span class="comment">// disable hard error popups, to avoid self deadlock on bogus devices</span>
00722     <span class="comment">//</span>
00723     oldFlag = <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(FALSE);
00724 
00725     <span class="comment">//</span>
00726     <span class="comment">// Write a log.</span>
00727     <span class="comment">//</span>
00728     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00729         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a2">HvpWriteLog</a>(Hive) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00730             <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(oldFlag);
00731             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00732         }
00733     }
00734 
00735     <span class="comment">//</span>
00736     <span class="comment">// Write the primary</span>
00737     <span class="comment">//</span>
00738     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a14">HvpDoWriteHive</a>(Hive, HFILE_TYPE_PRIMARY) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00739         <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(oldFlag);
00740         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00741     }
00742 
00743     <span class="comment">//</span>
00744     <span class="comment">// Write an alternate</span>
00745     <span class="comment">//</span>
00746     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o16">Alternate</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00747         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a14">HvpDoWriteHive</a>(Hive, HFILE_TYPE_ALTERNATE) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00748             <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(oldFlag);
00749             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00750         }
00751     }
00752 
00753     <span class="comment">//</span>
00754     <span class="comment">// restore hard error popups mode</span>
00755     <span class="comment">//</span>
00756     <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(oldFlag);
00757     
00758     <span class="comment">//</span>
00759     <span class="comment">// Hive was successfully written out, discard any bins marked as</span>
00760     <span class="comment">// discardable.</span>
00761     <span class="comment">//</span>
00762     <a class="code" href="../../d0/d2/hivesync_8c.html#a16">HvpDiscardBins</a>(Hive);
00763 
00764     <span class="comment">//</span>
00765     <span class="comment">// Clear the dirty map</span>
00766     <span class="comment">//</span>
00767     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00768     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = 0;
00769 
00770     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00771 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="hivesync.c::HvWriteHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvWriteHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">1433</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00227">CmpDoFileSetSize()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00265">CmpReleaseGlobalQuota()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00571">HFILE_TYPE_EXTERNAL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00076">HvShutdownComplete</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00305">RtlSetAllBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>.
<p>
<pre class="fragment"><div>01438                    :
01439 
01440     Write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.  Write <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Primary <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, neither
01441     logs nor alternates will be updated.  The hive will be written
01442     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a> handle.
01443 
01444     Intended <span class="keywordflow">for</span> use in applications like SaveKey.
01445 
01446     Only <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> storage will be written (as <span class="keywordflow">for</span> any hive.)
01447 
01448     Presumption is that layer above has set HFILE_TYPE_EXTERNAL
01449     handle to point to correct place.
01450 
01451     Applying <span class="keyword">this</span> call to an active hive will generally hose integrity
01452     measures.
01453 
01454     HOW IT WORKS:
01455 
01456         Make a <span class="keyword">new</span> DirtyVector.  Fill it with 1s (all dirty).
01457         Make hive point at <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  We now have what looks like
01458         a completely dirty hive.
01459 
01460         Call HvpWriteHive, which will write the whole thing to disk.
01461 
01462         Put back DirtyVector, and free the extra one we used.
01463 
01464         In failure <span class="keywordflow">case</span>, force Sequence numbers in Hive and BaseBlock
01465         to match.
01466 
01467 Arguments:
01468 
01469     Hive - supplies a pointer to the hive control structure <span class="keywordflow">for</span> the
01470             hive of interest.
01471 
01472 Return Value:
01473 
01474     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>.
01475 
01476 --*/
01477 {
01478     PULONG          SaveDirtyVector;
01479     ULONG           SaveDirtyVectorSize;
01480     PULONG          AltDirtyVector;
01481     ULONG           AltDirtyVectorSize;
01482     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    SaveBaseBlock;
01483     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    AltBaseBlock;
01484     ULONG           Alignment;
01485 
01486     NTSTATUS        status;
01487 
01488 
01489     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO) {
01490         KdPrint((<span class="stringliteral">"HvWriteHive: \n"</span>));
01491         KdPrint((<span class="stringliteral">"\tHive = %08lx\n"</span>));
01492     }
01493     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
01494     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
01495 
01496 
01497     <span class="comment">//</span>
01498     <span class="comment">// Punt if post shutdown</span>
01499     <span class="comment">//</span>
01500     if (HvShutdownComplete) {
01501         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_IO) {
01502             KdPrint((<span class="stringliteral">"HvWriteHive: Attempt to write hive AFTER SHUTDOWN\n"</span>));
01503         }
01504         <span class="keywordflow">return</span> STATUS_REGISTRY_IO_FAILED;
01505     }
01506 
01507     <span class="comment">//</span>
01508     <span class="comment">// Splice in a duplicate DirtyVector with all bits set.</span>
01509     <span class="comment">//</span>
01510     SaveDirtyVector = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer;
01511     SaveDirtyVectorSize = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap;
01512     SaveBaseBlock = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>;
01513 
01514     AltDirtyVectorSize = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Stable].Length / HSECTOR_SIZE) / 8;
01515     AltDirtyVector = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(AltDirtyVectorSize,<span class="keyword">sizeof</span>(ULONG)), FALSE);
01516     <span class="keywordflow">if</span> (AltDirtyVector == NULL) {
01517         status = STATUS_INSUFFICIENT_RESOURCES;
01518         <span class="keywordflow">goto</span> Exit1;
01519     }
01520     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer = AltDirtyVector;
01521     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap = AltDirtyVectorSize * 8;
01522     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a28">RtlSetAllBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
01523 
01524     <span class="comment">//</span>
01525     <span class="comment">// Splice in a duplicate BaseBlock</span>
01526     <span class="comment">//</span>
01527     AltBaseBlock = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>), TRUE);
01528     if (AltBaseBlock == NULL) {
01529         status = STATUS_INSUFFICIENT_RESOURCES;
01530         <span class="keywordflow">goto</span> Exit2;
01531     }
01532     <span class="comment">//</span>
01533     <span class="comment">// Make sure the buffer we got back is cluster-aligned. If not, try</span>
01534     <span class="comment">// harder to get an aligned buffer.</span>
01535     <span class="comment">//</span>
01536     Alignment = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * HSECTOR_SIZE - 1;
01537     if (((ULONG_PTR)AltBaseBlock &amp; Alignment) != 0) {
01538         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(AltBaseBlock, <span class="keyword">sizeof</span>(HBASE_BLOCK));
01539         AltBaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(PAGE_SIZE, TRUE));
01540         if (AltBaseBlock == NULL) {
01541             status = STATUS_INSUFFICIENT_RESOURCES;
01542             <span class="keywordflow">goto</span> Exit2;
01543         }
01544         <span class="comment">//</span>
01545         <span class="comment">// Return the quota for the extra allocation, as we are not really using</span>
01546         <span class="comment">// it and it will not be accounted for later when we free it.</span>
01547         <span class="comment">//</span>
01548         <a class="code" href="../../d1/d2/cmp_8h.html#a248">CmpReleaseGlobalQuota</a>(PAGE_SIZE - <span class="keyword">sizeof</span>(HBASE_BLOCK));
01549     }
01550 
01551     RtlMoveMemory(AltBaseBlock, SaveBaseBlock, HSECTOR_SIZE);
01552     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = AltBaseBlock;
01553 
01554     <span class="comment">//</span>
01555     <span class="comment">// Ensure the file can be made big enough, then do the deed</span>
01556     <span class="comment">//</span>
01557     status = <a class="code" href="../../d1/d2/cmp_8h.html#a219">CmpDoFileSetSize</a>(Hive,
01558                               HFILE_TYPE_EXTERNAL,
01559                               <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Stable].Length);
01560 
01561     if (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01562         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/hivesync_8c.html#a14">HvpDoWriteHive</a>(Hive, HFILE_TYPE_EXTERNAL)) {
01563             status = STATUS_REGISTRY_IO_FAILED;
01564         }
01565     }
01566 
01567     <span class="comment">//</span>
01568     <span class="comment">// Clean up, success or failure</span>
01569     <span class="comment">//</span>
01570     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(AltBaseBlock, <span class="keyword">sizeof</span>(HBASE_BLOCK));
01571 
01572 Exit2:
01573     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(AltDirtyVector, <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(AltDirtyVectorSize,<span class="keyword">sizeof</span>(ULONG)));
01574 
01575 Exit1:
01576     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer = SaveDirtyVector;
01577     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap = SaveDirtyVectorSize;
01578     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = SaveBaseBlock;
01579     <span class="keywordflow">return</span> status;
01580 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="hivesync.c::HvShutdownComplete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d0/d2/hivesync_8c.html#a1">HvShutdownComplete</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00027">27</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00461">CmpLazyFlushWorker()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03944">CmShutdownSystem()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:06 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
