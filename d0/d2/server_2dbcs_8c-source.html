<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dbcs.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dbcs.c</h1><a href="../../d9/d2/server_2dbcs_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    dbcs.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">Author:</span>
00012 <span class="comment"></span>
00013 <span class="comment">    KazuM Mar.05.1992</span>
00014 <span class="comment"></span>
00015 <span class="comment">Revision History:</span>
00016 <span class="comment"></span>
00017 <span class="comment">--*/</span>
00018 
00019 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00020 <span class="preprocessor">#pragma hdrstop</span>
00021 <span class="preprocessor"></span>
00022 <span class="preprocessor">#pragma alloc_text(FE_TEXT, CheckBisectStringA)</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, BisectWrite)</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, BisectClipbrd)</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, BisectWriteAttr)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, IsDBCSLeadByteConsole)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, TextOutEverything)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, TextOutCommonLVB)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#ifdef i386</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, RealUnicodeToNEC_OS2_Unicode)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, InitializeNEC_OS2_CP)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, ProcessCreateConsoleIME)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, InitConsoleIMEStuff)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, WaitConsoleIMEStuff)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, ConSrvRegisterConsoleIME)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, RemoveConsoleIME)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, ConsoleImeMessagePump)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, RegisterKeisenOfTTFont)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, ImmConversionToConsole)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, ImmConversionFromConsole)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, TranslateUnicodeToOem)</span>
00043 <span class="preprocessor"></span>
00044 
00045 <span class="preprocessor">#if defined(FE_SB)</span>
00046 <span class="preprocessor"></span>
00047 SINGLE_LIST_ENTRY gTTFontList;    <span class="comment">// This list contain TTFONTLIST data.</span>
00048 
00049 <span class="preprocessor">#if defined(i386)</span>
00050 <span class="preprocessor"></span>ULONG  gdwMachineId;
00051 <span class="preprocessor">#endif</span>
00052 <span class="preprocessor"></span>
00053 LPTHREAD_START_ROUTINE <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a11">ConsoleIMERoutine</a>;  <span class="comment">// client side console IME routine</span>
00054 CRITICAL_SECTION ConIMEInitWindowsLock;
00055 
00056 <span class="preprocessor">#if defined(i386)</span>
00057 <span class="preprocessor"></span><span class="comment">/*</span>
00058 <span class="comment"> * NEC PC-98 OS/2 OEM character set</span>
00059 <span class="comment"> * When FormatID is 0 or 80, Convert SBCS (00h-1Fh) font.</span>
00060 <span class="comment"> */</span>
00061 PCPTABLEINFO pGlyph_NEC_OS2_CP;
00062 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> pGlyph_NEC_OS2_Table;
00063 <span class="preprocessor">#endif // i386</span>
00064 <span class="preprocessor"></span>
00065 
00066 
00067 <span class="preprocessor">#if defined(FE_IME)</span>
00068 <span class="preprocessor"></span>
00069 
00070 <span class="preprocessor">#if defined(i386)</span>
00071 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00072 ImeWmFullScreen(
00073     IN BOOL Foreground,
00074     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00075     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
00076     )
00077 {
00078     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00079 
00080     <span class="keywordflow">if</span>(Foreground) {
00081         ULONG ModeIndex;
00082         PCONVERSIONAREA_INFORMATION ConvAreaInfo;
00083 
00084         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(Console,
00085                               CONIME_SETFOCUS,
00086                               (WPARAM)Console-&gt;ConsoleHandle,
00087                               (LPARAM)Console-&gt;hklActive
00088                              ))) {
00089             <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00090         }
00091 
00092         <span class="keywordflow">if</span> (ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaRoot) {
00093             <span class="keywordflow">if</span> (!(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>))
00094                 ModeIndex = ScreenInfo-&gt;BufferInfo.TextInfo.ModeIndex;
00095             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>))
00096                 ModeIndex = Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.ModeIndex;
00097             <span class="keywordflow">else</span>
00098                 ModeIndex = 0;
00099             <span class="keywordflow">do</span> {
00100 <span class="preprocessor">#ifdef FE_SB</span>
00101 <span class="preprocessor"></span>                <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
00102                 <span class="keywordflow">if</span> (! (ConvAreaInfo-&gt;ScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>))
00103                     ConvAreaInfo-&gt;ScreenBuffer-&gt;BufferInfo.TextInfo.ModeIndex = ModeIndex;
00104                 <span class="keywordflow">else</span>
00105                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00106 <span class="preprocessor">#else</span>
00107 <span class="preprocessor"></span>                ConvAreaInfo-&gt;ScreenBuffer-&gt;BufferInfo.TextInfo.ModeIndex = ModeIndex;
00108 <span class="preprocessor">#endif</span>
00109 <span class="preprocessor"></span>            } <span class="keywordflow">while</span> (ConvAreaInfo = ConvAreaInfo-&gt;ConvAreaNext);
00110         }
00111     }
00112     <span class="keywordflow">else</span>
00113     {
00114         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(Console,
00115                               CONIME_KILLFOCUS,
00116                               (WPARAM)Console-&gt;ConsoleHandle,
00117                               (LPARAM)Console-&gt;hklActive
00118                              ))) {
00119             <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00120         }
00121     }
00122 
00123     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00124 }
00125 <span class="preprocessor">#endif // i386</span>
00126 <span class="preprocessor"></span>
00127 
00128 
00129 
00130 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00131 GetImeKeyState(
00132     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00133     IN PDWORD pdwConversion
00134     )
00135 
00136 <span class="comment">/*++</span>
00137 <span class="comment"></span>
00138 <span class="comment">Routine Description:</span>
00139 <span class="comment"></span>
00140 <span class="comment">    This routine get IME mode for KEY_EVENT_RECORD.</span>
00141 <span class="comment"></span>
00142 <span class="comment">Arguments:</span>
00143 <span class="comment"></span>
00144 <span class="comment">    ConsoleInfo - Pointer to console information structure.</span>
00145 <span class="comment"></span>
00146 <span class="comment">Return Value:</span>
00147 <span class="comment"></span>
00148 <span class="comment">--*/</span>
00149 
00150 {
00151     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDummy;
00152 
00153     <span class="comment">/*</span>
00154 <span class="comment">     * If pdwConversion is NULL, the caller doensn't want</span>
00155 <span class="comment">     * the result --- but for code efficiency, let it</span>
00156 <span class="comment">     * point to the dummy dword variable, so that</span>
00157 <span class="comment">     * we don't have to care from here.</span>
00158 <span class="comment">     */</span>
00159     <span class="keywordflow">if</span> (pdwConversion == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00160         pdwConversion = &amp;dwDummy;
00161     }
00162 
00163     <span class="keywordflow">if</span> (Console-&gt;InputBuffer.ImeMode.Disable)
00164     {
00165         *pdwConversion = 0;
00166     }
00167     <span class="keywordflow">else</span>
00168     {
00169         <a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html">PINPUT_THREAD_INFO</a> InputThreadInfo;     <span class="comment">// console thread info</span>
00170 
00171         InputThreadInfo = TlsGetValue(InputThreadTlsIndex);
00172 
00173         <span class="keywordflow">if</span> (InputThreadInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00174         {
00175             LRESULT lResult;
00176 
00177             <span class="comment">/*</span>
00178 <span class="comment">             * This thread is in InputThread()</span>
00179 <span class="comment">             * We can try message pump.</span>
00180 <span class="comment">             */</span>
00181 
00182             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePumpWorker(Console,
00183                     CONIME_GET_NLSMODE,
00184                     (WPARAM)Console-&gt;ConsoleHandle,
00185                     (LPARAM)0,
00186                     &amp;lResult))) {
00187 
00188                 *pdwConversion = <a class="code" href="../../d3/d5/conime_8h.html#a30">IME_CMODE_DISABLE</a>;
00189                 <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00190             }
00191 
00192 
00193             *pdwConversion = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lResult;
00194 
00195             <span class="keywordflow">if</span> (Console-&gt;InputBuffer.ImeMode.ReadyConversion == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
00196                 Console-&gt;InputBuffer.ImeMode.ReadyConversion = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00197         }
00198         <span class="keywordflow">else</span>
00199         {
00200             <span class="comment">/*</span>
00201 <span class="comment">             * This thread is in CsrApiRequestThread()</span>
00202 <span class="comment">             * We can not try message pump.</span>
00203 <span class="comment">             */</span>
00204             <span class="keywordflow">if</span> (Console-&gt;InputBuffer.ImeMode.ReadyConversion == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00205                 *pdwConversion = 0;
00206                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00207             }
00208 
00209             *pdwConversion = Console-&gt;InputBuffer.ImeMode.Conversion;
00210         }
00211 
00212 
00213         <span class="keywordflow">if</span> (*pdwConversion &amp; <a class="code" href="../../d3/d5/conime_8h.html#a29">IME_CMODE_OPEN</a>)
00214             Console-&gt;InputBuffer.ImeMode.Open = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00215         <span class="keywordflow">else</span>
00216             Console-&gt;InputBuffer.ImeMode.Open = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00217         <span class="keywordflow">if</span> (*pdwConversion &amp; <a class="code" href="../../d3/d5/conime_8h.html#a30">IME_CMODE_DISABLE</a>)
00218             Console-&gt;InputBuffer.ImeMode.Disable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00219         <span class="keywordflow">else</span>
00220             Console-&gt;InputBuffer.ImeMode.Disable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00221 
00222         Console-&gt;InputBuffer.ImeMode.Conversion = *pdwConversion;
00223 
00224     }
00225 
00226     <span class="keywordflow">return</span> STATUS_SUCCESS;
00227 }
00228 
00229 
00230 
00231 
00232 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00233 SetImeKeyState(
00234     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00235     IN DWORD fdwConversion
00236     )
00237 
00238 <span class="comment">/*++</span>
00239 <span class="comment"></span>
00240 <span class="comment">Routine Description:</span>
00241 <span class="comment"></span>
00242 <span class="comment">    This routine get IME mode for KEY_EVENT_RECORD.</span>
00243 <span class="comment"></span>
00244 <span class="comment">Arguments:</span>
00245 <span class="comment"></span>
00246 <span class="comment">    Console - Pointer to console information structure.</span>
00247 <span class="comment"></span>
00248 <span class="comment">    fdwConversion - IME conversion status.</span>
00249 <span class="comment"></span>
00250 <span class="comment">Return Value:</span>
00251 <span class="comment"></span>
00252 <span class="comment">--*/</span>
00253 
00254 {
00255     PCONVERSIONAREA_INFORMATION ConvAreaInfo;
00256 
00257     <span class="keywordflow">if</span> ( (fdwConversion &amp; <a class="code" href="../../d3/d5/conime_8h.html#a30">IME_CMODE_DISABLE</a>) &amp;&amp; (! Console-&gt;InputBuffer.ImeMode.Disable) ) {
00258         Console-&gt;InputBuffer.ImeMode.Disable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00259         <span class="keywordflow">if</span> ( Console-&gt;InputBuffer.ImeMode.Open ) {
00260             ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaMode;
00261             <span class="keywordflow">if</span> (ConvAreaInfo)
00262                 ConvAreaInfo-&gt;ConversionAreaMode |= CA_HIDDEN;
00263             ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaSystem;
00264             <span class="keywordflow">if</span> (ConvAreaInfo)
00265                 ConvAreaInfo-&gt;ConversionAreaMode |= CA_HIDDEN;
00266             <span class="keywordflow">if</span> (Console-&gt;InputBuffer.ImeMode.Open &amp;&amp; CONSOLE_IS_DBCS_OUTPUTCP(Console))
00267                 ConsoleImePaint(Console, Console-&gt;ConsoleIme.ConvAreaRoot);
00268         }
00269     }
00270     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (! (fdwConversion &amp; <a class="code" href="../../d3/d5/conime_8h.html#a30">IME_CMODE_DISABLE</a>)) &amp;&amp; Console-&gt;InputBuffer.ImeMode.Disable) {
00271         Console-&gt;InputBuffer.ImeMode.Disable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00272         <span class="keywordflow">if</span> ( fdwConversion &amp; <a class="code" href="../../d3/d5/conime_8h.html#a29">IME_CMODE_OPEN</a> ) {
00273             ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaMode;
00274             <span class="keywordflow">if</span> (ConvAreaInfo)
00275                 ConvAreaInfo-&gt;ConversionAreaMode &amp;= ~CA_HIDDEN;
00276             ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaSystem;
00277             <span class="keywordflow">if</span> (ConvAreaInfo)
00278                 ConvAreaInfo-&gt;ConversionAreaMode &amp;= ~CA_HIDDEN;
00279             <span class="keywordflow">if</span> (Console-&gt;InputBuffer.ImeMode.Open &amp;&amp; CONSOLE_IS_DBCS_OUTPUTCP(Console))
00280                 ConsoleImePaint(Console, Console-&gt;ConsoleIme.ConvAreaRoot);
00281         }
00282     }
00283     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (fdwConversion &amp; <a class="code" href="../../d3/d5/conime_8h.html#a30">IME_CMODE_DISABLE</a>) &amp;&amp; (Console-&gt;InputBuffer.ImeMode.Disable) ) {
00284         <span class="keywordflow">return</span> STATUS_SUCCESS;
00285     }
00286 
00287     <span class="keywordflow">if</span> ( (fdwConversion &amp; <a class="code" href="../../d3/d5/conime_8h.html#a29">IME_CMODE_OPEN</a>) &amp;&amp; (! Console-&gt;InputBuffer.ImeMode.Open)) {
00288         Console-&gt;InputBuffer.ImeMode.Open = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00289     }
00290     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (! (fdwConversion &amp; <a class="code" href="../../d3/d5/conime_8h.html#a29">IME_CMODE_OPEN</a>)) &amp;&amp; Console-&gt;InputBuffer.ImeMode.Open) {
00291         Console-&gt;InputBuffer.ImeMode.Open = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00292     }
00293 
00294     Console-&gt;InputBuffer.ImeMode.Conversion = fdwConversion;
00295 
00296     <span class="keywordflow">if</span> (Console-&gt;InputBuffer.ImeMode.ReadyConversion == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
00297         Console-&gt;InputBuffer.ImeMode.ReadyConversion = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00298 
00299     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(Console,
00300                           CONIME_SET_NLSMODE,
00301                           (WPARAM)Console-&gt;ConsoleHandle,
00302                           (LPARAM)fdwConversion
00303                          ))) {
00304         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00305     }
00306 
00307     <span class="keywordflow">return</span> STATUS_SUCCESS;
00308 }
00309 
00310 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00311 SetImeCodePage(
00312     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00313     )
00314 {
00315     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CodePage = Console-&gt;OutputCP;
00316     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fdwConversion;
00317 
00318     <span class="keywordflow">if</span> (!CONSOLE_IS_DBCS_CP(Console))
00319     {
00320         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(GetImeKeyState(Console, &amp;fdwConversion))) {
00321             <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00322         }
00323 
00324         fdwConversion |= <a class="code" href="../../d3/d5/conime_8h.html#a30">IME_CMODE_DISABLE</a>;
00325 
00326     }
00327     <span class="keywordflow">else</span> {
00328         fdwConversion = Console-&gt;InputBuffer.ImeMode.Conversion &amp; ~<a class="code" href="../../d3/d5/conime_8h.html#a30">IME_CMODE_DISABLE</a>;
00329     }
00330 
00331     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(SetImeKeyState(Console, fdwConversion))) {
00332         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00333     }
00334 
00335     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>()) {
00336         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(Console,
00337                               CONIME_NOTIFY_CODEPAGE,
00338                               (WPARAM)Console-&gt;ConsoleHandle,
00339                               (LPARAM)MAKELPARAM(FALSE, CodePage)
00340                              ))) {
00341             <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00342         }
00343     }
00344 
00345     <span class="keywordflow">return</span> STATUS_SUCCESS;
00346 }
00347 
00348 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00349 SetImeOutputCodePage(
00350     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00351     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00352     IN DWORD PrevCodePage
00353     )
00354 {
00355     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CodePage = Console-&gt;OutputCP;
00356 
00357     <span class="comment">// Output code page</span>
00358     <span class="keywordflow">if</span> ((ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) &amp;&amp;
00359         (<a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>(CodePage) || <a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>(PrevCodePage)))
00360     {
00361         <a class="code" href="../../d0/d3/dbcs_8h.html#a39">ConvertToCodePage</a>(Console, PrevCodePage);
00362         <a class="code" href="../../d0/d3/dbcs_8h.html#a38">AdjustFont</a>(Console, CodePage);
00363     }
00364     <span class="comment">// load special ROM font, if necessary</span>
00365 <span class="preprocessor">#ifdef i386</span>
00366 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( (Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE) &amp;&amp;
00367          !(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>))
00368     {
00369         SetROMFontCodePage(CodePage,
00370                            ScreenInfo-&gt;BufferInfo.TextInfo.ModeIndex);
00371         SetCursorInformationHW(ScreenInfo,
00372                         ScreenInfo-&gt;BufferInfo.TextInfo.CursorSize,
00373                         ScreenInfo-&gt;BufferInfo.TextInfo.CursorVisible);
00374         WriteRegionToScreenHW(ScreenInfo,
00375                 &amp;ScreenInfo-&gt;Window);
00376     }
00377 <span class="preprocessor">#endif</span>
00378 <span class="preprocessor"></span>
00379     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>()) {
00380         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(Console,
00381                               CONIME_NOTIFY_CODEPAGE,
00382                               (WPARAM)Console-&gt;ConsoleHandle,
00383                               (LPARAM)MAKELPARAM(TRUE, CodePage)
00384                              ))) {
00385             <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00386         }
00387     }
00388 
00389     <span class="keywordflow">return</span> STATUS_SUCCESS;
00390 }
00391 <span class="preprocessor">#endif // FE_IME</span>
00392 <span class="preprocessor"></span>
00393 
00394 
00395 
00396 
00397 
00398 
00399 
00400 
00401 
00402 
00403 
00404 
00405 
00406 
00407 
00408 
00409 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00410 <a class="code" href="../../d0/d3/dbcs_8h.html#a29">SetLineChar</a>(
00411     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
00412     )
00413 
00414 <span class="comment">/*++</span>
00415 <span class="comment"></span>
00416 <span class="comment">Routine Description:</span>
00417 <span class="comment"></span>
00418 <span class="comment">    This routine setup of line character code.</span>
00419 <span class="comment"></span>
00420 <span class="comment">Arguments:</span>
00421 <span class="comment"></span>
00422 <span class="comment">    ScreenInfo - Pointer to screen information structure.</span>
00423 <span class="comment"></span>
00424 <span class="comment">Return Value:</span>
00425 <span class="comment"></span>
00426 <span class="comment">    none.</span>
00427 <span class="comment"></span>
00428 <span class="comment">--*/</span>
00429 
00430 {
00431     <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(ScreenInfo-&gt;Console))
00432     {
00433         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a> == <a class="code" href="../../d0/d3/dbcs_8h.html#a7">JAPAN_CP</a> || <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a> == <a class="code" href="../../d0/d3/dbcs_8h.html#a6">KOREAN_CP</a>)
00434         {
00435             <span class="comment">/*</span>
00436 <span class="comment">             * This is Japanese/Korean case,</span>
00437 <span class="comment">             * These characters maps grid of half width.</span>
00438 <span class="comment">             * so, same as U+2500.</span>
00439 <span class="comment">             */</span>
00440             ScreenInfo-&gt;LineChar[UPPER_LEFT_CORNER]   = 0x0001;
00441             ScreenInfo-&gt;LineChar[UPPER_RIGHT_CORNER]  = 0x0002;
00442             ScreenInfo-&gt;LineChar[HORIZONTAL_LINE]     = 0x0006;
00443             ScreenInfo-&gt;LineChar[VERTICAL_LINE]       = 0x0005;
00444             ScreenInfo-&gt;LineChar[BOTTOM_LEFT_CORNER]  = 0x0003;
00445             ScreenInfo-&gt;LineChar[BOTTOM_RIGHT_CORNER] = 0x0004;
00446         }
00447         <span class="keywordflow">else</span>
00448         {
00449             <span class="comment">/*</span>
00450 <span class="comment">             * This is FE case,</span>
00451 <span class="comment">             * FE don't uses U+2500 because these grid characters</span>
00452 <span class="comment">             * maps to full width.</span>
00453 <span class="comment">             */</span>
00454             ScreenInfo-&gt;LineChar[UPPER_LEFT_CORNER]   = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'+'</span>;
00455             ScreenInfo-&gt;LineChar[UPPER_RIGHT_CORNER]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'+'</span>;
00456             ScreenInfo-&gt;LineChar[HORIZONTAL_LINE]     = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'-'</span>;
00457             ScreenInfo-&gt;LineChar[VERTICAL_LINE]       = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'|'</span>;
00458             ScreenInfo-&gt;LineChar[BOTTOM_LEFT_CORNER]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'+'</span>;
00459             ScreenInfo-&gt;LineChar[BOTTOM_RIGHT_CORNER] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'+'</span>;
00460         }
00461     }
00462     <span class="keywordflow">else</span> {
00463         ScreenInfo-&gt;LineChar[UPPER_LEFT_CORNER]   = 0x250c;
00464         ScreenInfo-&gt;LineChar[UPPER_RIGHT_CORNER]  = 0x2510;
00465         ScreenInfo-&gt;LineChar[HORIZONTAL_LINE]     = 0x2500;
00466         ScreenInfo-&gt;LineChar[VERTICAL_LINE]       = 0x2502;
00467         ScreenInfo-&gt;LineChar[BOTTOM_LEFT_CORNER]  = 0x2514;
00468         ScreenInfo-&gt;LineChar[BOTTOM_RIGHT_CORNER] = 0x2518;
00469     }
00470 }
00471 
00472 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00473 <a class="code" href="../../d0/d3/dbcs_8h.html#a30">CheckBisectStringA</a>(
00474     IN DWORD CodePage,
00475     IN PCHAR Buffer,
00476     IN DWORD NumBytes,
00477     IN LPCPINFO lpCPInfo
00478     )
00479 
00480 <span class="comment">/*++</span>
00481 <span class="comment"></span>
00482 <span class="comment">Routine Description:</span>
00483 <span class="comment"></span>
00484 <span class="comment">    This routine check bisected on Ascii string end.</span>
00485 <span class="comment"></span>
00486 <span class="comment">Arguments:</span>
00487 <span class="comment"></span>
00488 <span class="comment">    CodePage - Value of code page.</span>
00489 <span class="comment"></span>
00490 <span class="comment">    Buffer - Pointer to Ascii string buffer.</span>
00491 <span class="comment"></span>
00492 <span class="comment">    NumBytes - Number of Ascii string.</span>
00493 <span class="comment"></span>
00494 <span class="comment">Return Value:</span>
00495 <span class="comment"></span>
00496 <span class="comment">    TRUE - Bisected character.</span>
00497 <span class="comment"></span>
00498 <span class="comment">    FALSE - Correctly.</span>
00499 <span class="comment"></span>
00500 <span class="comment">--*/</span>
00501 
00502 {
00503     UNREFERENCED_PARAMETER(CodePage);
00504 
00505     <span class="keywordflow">while</span>(NumBytes) {
00506         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a37">IsDBCSLeadByteConsole</a>(*Buffer,lpCPInfo)) {
00507             <span class="keywordflow">if</span> (NumBytes &lt;= 1)
00508                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00509             <span class="keywordflow">else</span> {
00510                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> += 2;
00511                 NumBytes -= 2;
00512             }
00513         }
00514         <span class="keywordflow">else</span> {
00515             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++;
00516             NumBytes--;
00517         }
00518     }
00519     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00520 }
00521 
00522 
00523 
00524 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00525 <a class="code" href="../../d0/d3/dbcs_8h.html#a31">BisectWrite</a>(
00526     IN SHORT StringLength,
00527     IN COORD TargetPoint,
00528     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
00529     )
00530 
00531 <span class="comment">/*++</span>
00532 <span class="comment"></span>
00533 <span class="comment">Routine Description:</span>
00534 <span class="comment"></span>
00535 <span class="comment">    This routine write buffer with bisect.</span>
00536 <span class="comment"></span>
00537 <span class="comment">Arguments:</span>
00538 <span class="comment"></span>
00539 <span class="comment">Return Value:</span>
00540 <span class="comment"></span>
00541 <span class="comment">--*/</span>
00542 
00543 {
00544     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
00545     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
00546     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> RowPrev;
00547     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> RowNext;
00548 
00549 <span class="preprocessor">#if defined(DBG) &amp;&amp; defined(DBG_KATTR)</span>
00550 <span class="preprocessor"></span>    BeginKAttrCheck(ScreenInfo);
00551 <span class="preprocessor">#endif</span>
00552 <span class="preprocessor"></span>
00553 <span class="preprocessor">#ifdef FE_SB</span>
00554 <span class="preprocessor"></span>    <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
00555     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(ScreenInfo-&gt;Flags &amp; CONSOLE_GRAPHICS_BUFFER));
00556 <span class="preprocessor">#endif</span>
00557 <span class="preprocessor"></span>
00558     RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+TargetPoint.Y) % ScreenInfo-&gt;ScreenBufferSize.Y;
00559     Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
00560 
00561     <span class="keywordflow">if</span> (RowIndex &gt; 0) {
00562         RowPrev = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex-1];
00563     } <span class="keywordflow">else</span> {
00564         RowPrev = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[ScreenInfo-&gt;ScreenBufferSize.Y-1];
00565     }
00566 
00567     <span class="keywordflow">if</span> (RowIndex+1 &lt; ScreenInfo-&gt;ScreenBufferSize.Y) {
00568         RowNext = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex+1];
00569     } <span class="keywordflow">else</span> {
00570         RowNext = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[0];
00571     }
00572 
00573     <span class="comment">//</span>
00574     <span class="comment">// Check start position of strings</span>
00575     <span class="comment">//</span>
00576     <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[TargetPoint.X] &amp; ATTR_TRAILING_BYTE)
00577     {
00578         <span class="keywordflow">if</span> (TargetPoint.X == 0) {
00579             RowPrev-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[ScreenInfo-&gt;ScreenBufferSize.X-1] = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00580             RowPrev-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[ScreenInfo-&gt;ScreenBufferSize.X-1] = 0;
00581             ScreenInfo-&gt;BisectFlag |= BISECT_TOP;
00582         }
00583         <span class="keywordflow">else</span> {
00584             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[TargetPoint.X-1] = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00585             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[TargetPoint.X-1] = 0;
00586             ScreenInfo-&gt;BisectFlag |= BISECT_LEFT;
00587         }
00588     }
00589 
00590     <span class="comment">//</span>
00591     <span class="comment">// Check end position of strings</span>
00592     <span class="comment">//</span>
00593     <span class="keywordflow">if</span> (TargetPoint.X+<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> &lt; ScreenInfo-&gt;ScreenBufferSize.X) {
00594         <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[TargetPoint.X+<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>] &amp; ATTR_TRAILING_BYTE)
00595           {
00596             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[TargetPoint.X+<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>] = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00597             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[TargetPoint.X+<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>] = 0;
00598             ScreenInfo-&gt;BisectFlag |= BISECT_RIGHT;
00599         }
00600     }
00601     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TargetPoint.Y+1 &lt; ScreenInfo-&gt;ScreenBufferSize.Y) {
00602         <span class="keywordflow">if</span> (RowNext-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[0] &amp; ATTR_TRAILING_BYTE)
00603         {
00604             RowNext-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[0] = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00605             RowNext-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[0] = 0;
00606             ScreenInfo-&gt;BisectFlag |= BISECT_BOTTOM;
00607         }
00608     }
00609 }
00610 
00611 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00612 <a class="code" href="../../d0/d3/dbcs_8h.html#a32">BisectClipbrd</a>(
00613     IN SHORT StringLength,
00614     IN COORD TargetPoint,
00615     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00616     OUT PSMALL_RECT SmallRect
00617     )
00618 
00619 <span class="comment">/*++</span>
00620 <span class="comment"></span>
00621 <span class="comment">Routine Description:</span>
00622 <span class="comment"></span>
00623 <span class="comment">    This routine check bisect for clipboard process.</span>
00624 <span class="comment"></span>
00625 <span class="comment">Arguments:</span>
00626 <span class="comment"></span>
00627 <span class="comment">Return Value:</span>
00628 <span class="comment"></span>
00629 <span class="comment">--*/</span>
00630 
00631 {
00632     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
00633     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
00634     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> RowNext;
00635 
00636 <span class="preprocessor">#if defined(DBG) &amp;&amp; defined(DBG_KATTR)</span>
00637 <span class="preprocessor"></span><span class="comment">//    BeginKAttrCheck(ScreenInfo);</span>
00638 <span class="preprocessor">#endif</span>
00639 <span class="preprocessor"></span>
00640 <span class="preprocessor">#ifdef FE_SB</span>
00641 <span class="preprocessor"></span>    <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
00642     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(ScreenInfo-&gt;Flags &amp; CONSOLE_GRAPHICS_BUFFER));
00643 <span class="preprocessor">#endif</span>
00644 <span class="preprocessor"></span>
00645     RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+TargetPoint.Y) % ScreenInfo-&gt;ScreenBufferSize.Y;
00646     Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
00647 
00648     <span class="keywordflow">if</span> (RowIndex+1 &lt; ScreenInfo-&gt;ScreenBufferSize.Y) {
00649         RowNext = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex+1];
00650     } <span class="keywordflow">else</span> {
00651         RowNext = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[0];
00652     }
00653 
00654     <span class="comment">//</span>
00655     <span class="comment">// Check start position of strings</span>
00656     <span class="comment">//</span>
00657     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CONSOLE_IS_DBCS_OUTPUTCP(ScreenInfo-&gt;Console));
00658     <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[TargetPoint.X] &amp; ATTR_TRAILING_BYTE)
00659     {
00660         <span class="keywordflow">if</span> (TargetPoint.X == 0) {
00661             SmallRect-&gt;Left++;
00662         }
00663         <span class="keywordflow">else</span> {
00664             SmallRect-&gt;Left--;
00665         }
00666     }
00667     <span class="comment">//</span>
00668     <span class="comment">// Check end position of strings</span>
00669     <span class="comment">//</span>
00670     <span class="keywordflow">if</span> (TargetPoint.X+<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> &lt; ScreenInfo-&gt;ScreenBufferSize.X) {
00671         <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[TargetPoint.X+<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>] &amp; ATTR_TRAILING_BYTE)
00672         {
00673             SmallRect-&gt;Right++;
00674         }
00675     }
00676     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TargetPoint.Y+1 &lt; ScreenInfo-&gt;ScreenBufferSize.Y) {
00677         <span class="keywordflow">if</span> (RowNext-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[0] &amp; ATTR_TRAILING_BYTE)
00678         {
00679             SmallRect-&gt;Right--;
00680         }
00681     }
00682 }
00683 
00684 
00685 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00686 <a class="code" href="../../d0/d3/dbcs_8h.html#a33">BisectWriteAttr</a>(
00687     IN SHORT StringLength,
00688     IN COORD TargetPoint,
00689     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
00690     )
00691 
00692 <span class="comment">/*++</span>
00693 <span class="comment"></span>
00694 <span class="comment">Routine Description:</span>
00695 <span class="comment"></span>
00696 <span class="comment">    This routine write buffer with bisect.</span>
00697 <span class="comment"></span>
00698 <span class="comment">Arguments:</span>
00699 <span class="comment"></span>
00700 <span class="comment">Return Value:</span>
00701 <span class="comment"></span>
00702 <span class="comment">--*/</span>
00703 
00704 {
00705     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
00706     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
00707     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> RowNext;
00708 
00709 <span class="preprocessor">#if defined(DBG) &amp;&amp; defined(DBG_KATTR)</span>
00710 <span class="preprocessor"></span>    BeginKAttrCheck(ScreenInfo);
00711 <span class="preprocessor">#endif</span>
00712 <span class="preprocessor"></span>
00713 <span class="preprocessor">#ifdef FE_SB</span>
00714 <span class="preprocessor"></span>    <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
00715     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(ScreenInfo-&gt;Flags &amp; CONSOLE_GRAPHICS_BUFFER));
00716 <span class="preprocessor">#endif</span>
00717 <span class="preprocessor"></span>
00718     RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+TargetPoint.Y) % ScreenInfo-&gt;ScreenBufferSize.Y;
00719     Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
00720 
00721     <span class="keywordflow">if</span> (RowIndex+1 &lt; ScreenInfo-&gt;ScreenBufferSize.Y) {
00722         RowNext = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex+1];
00723     } <span class="keywordflow">else</span> {
00724         RowNext = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[0];
00725     }
00726 
00727     <span class="comment">//</span>
00728     <span class="comment">// Check start position of strings</span>
00729     <span class="comment">//</span>
00730     <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[TargetPoint.X] &amp; ATTR_TRAILING_BYTE){
00731         <span class="keywordflow">if</span> (TargetPoint.X == 0) {
00732             ScreenInfo-&gt;BisectFlag |= BISECT_TOP;
00733         }
00734         <span class="keywordflow">else</span> {
00735             ScreenInfo-&gt;BisectFlag |= BISECT_LEFT;
00736         }
00737     }
00738 
00739     <span class="comment">//</span>
00740     <span class="comment">// Check end position of strings</span>
00741     <span class="comment">//</span>
00742     <span class="keywordflow">if</span> (TargetPoint.X+<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> &lt; ScreenInfo-&gt;ScreenBufferSize.X) {
00743         <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[TargetPoint.X+<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>] &amp; ATTR_TRAILING_BYTE){
00744             ScreenInfo-&gt;BisectFlag |= BISECT_RIGHT;
00745         }
00746     }
00747     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TargetPoint.Y+1 &lt; ScreenInfo-&gt;ScreenBufferSize.Y) {
00748         <span class="keywordflow">if</span> (RowNext-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[0] &amp; ATTR_TRAILING_BYTE){
00749             ScreenInfo-&gt;BisectFlag |= BISECT_BOTTOM;
00750         }
00751     }
00752 }
00753 
00754 
00755 
00756 <span class="comment">/***************************************************************************\</span>
00757 <span class="comment">* BOOL IsConsoleFullWidth(HDC hDC,DWORD CodePage,WCHAR wch)</span>
00758 <span class="comment">*</span>
00759 <span class="comment">* Determine if the given Unicode char is fullwidth or not.</span>
00760 <span class="comment">*</span>
00761 <span class="comment">* Return:</span>
00762 <span class="comment">*     FASLE : half width. Uses 1 column per one character</span>
00763 <span class="comment">*     TRUE  : full width. Uses 2 columns per one character</span>
00764 <span class="comment">*</span>
00765 <span class="comment">* History:</span>
00766 <span class="comment">* 04-08-92 ShunK       Created.</span>
00767 <span class="comment">* Jul-27-1992 KazuM    Added Screen Information and Code Page Information.</span>
00768 <span class="comment">* Jan-29-1992 V-Hirots Substruct Screen Information.</span>
00769 <span class="comment">* Oct-06-1996 KazuM    Not use RtlUnicodeToMultiByteSize and WideCharToMultiByte</span>
00770 <span class="comment">*                      Because 950 only defined 13500 chars,</span>
00771 <span class="comment">*                      and unicode defined almost 18000 chars.</span>
00772 <span class="comment">*                      So there are almost 4000 chars can not be mapped to big5 code.</span>
00773 <span class="comment">\***************************************************************************/</span>
00774 
00775 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> IsConsoleFullWidth(
00776     IN HDC hDC,
00777     IN DWORD CodePage,
00778     IN WCHAR wch
00779     )
00780 {
00781     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> Width;
00782     TEXTMETRIC tmi;
00783 
00784     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>(CodePage))
00785         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00786 
00787     <span class="keywordflow">if</span> (0x20 &lt;= wch &amp;&amp; wch &lt;= 0x7e)
00788         <span class="comment">/* ASCII */</span>
00789         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00790     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0x3041 &lt;= wch &amp;&amp; wch &lt;= 0x3094)
00791         <span class="comment">/* Hiragana */</span>
00792         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00793     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0x30a1 &lt;= wch &amp;&amp; wch &lt;= 0x30f6)
00794         <span class="comment">/* Katakana */</span>
00795         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00796     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0x3105 &lt;= wch &amp;&amp; wch &lt;= 0x312c)
00797         <span class="comment">/* Bopomofo */</span>
00798         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00799     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0x3131 &lt;= wch &amp;&amp; wch &lt;= 0x318e)
00800         <span class="comment">/* Hangul Elements */</span>
00801         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00802     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0xac00 &lt;= wch &amp;&amp; wch &lt;= 0xd7a3)
00803         <span class="comment">/* Korean Hangul Syllables */</span>
00804         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00805     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0xff01 &lt;= wch &amp;&amp; wch &lt;= 0xff5e)
00806         <span class="comment">/* Fullwidth ASCII variants */</span>
00807         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00808     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0xff61 &lt;= wch &amp;&amp; wch &lt;= 0xff9f)
00809         <span class="comment">/* Halfwidth Katakana variants */</span>
00810         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00811     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (0xffa0 &lt;= wch &amp;&amp; wch &lt;= 0xffbe) ||
00812               (0xffc2 &lt;= wch &amp;&amp; wch &lt;= 0xffc7) ||
00813               (0xffca &lt;= wch &amp;&amp; wch &lt;= 0xffcf) ||
00814               (0xffd2 &lt;= wch &amp;&amp; wch &lt;= 0xffd7) ||
00815               (0xffda &lt;= wch &amp;&amp; wch &lt;= 0xffdc)   )
00816         <span class="comment">/* Halfwidth Hangule variants */</span>
00817         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00818     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0xffe0 &lt;= wch &amp;&amp; wch &lt;= 0xffe6)
00819         <span class="comment">/* Fullwidth symbol variants */</span>
00820         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00821     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0x4e00 &lt;= wch &amp;&amp; wch &lt;= 0x9fa5)
00822         <span class="comment">/* Han Ideographic */</span>
00823         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00824     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0xf900 &lt;= wch &amp;&amp; wch &lt;= 0xfa2d)
00825         <span class="comment">/* Han Compatibility Ideographs */</span>
00826         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00827     <span class="keywordflow">else</span>
00828     {
00829         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> ret;
00830 
00831         <span class="comment">/* Unknown character */</span>
00832 
00833         ret = GetTextMetricsW(hDC, &amp;tmi);
00834         <span class="keywordflow">if</span> (! ret) {
00835             KdPrint((<span class="stringliteral">"CONSRV: IsConsoleFullWidth: GetTextMetricsW failed 0x%x\n"</span>,GetLastError()));
00836             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00837         }
00838         <span class="keywordflow">if</span> (IS_ANY_DBCS_CHARSET(tmi.tmCharSet))
00839             tmi.tmMaxCharWidth /= 2;
00840 
00841         ret = GetCharWidth32(hDC, wch, wch, &amp;Width);
00842         <span class="keywordflow">if</span> (! ret) {
00843             KdPrint((<span class="stringliteral">"CONSRV: IsConsoleFullWidth: GetCharWidth32 failed 0x%x\n"</span>,GetLastError()));
00844             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00845         }
00846         <span class="keywordflow">if</span> (Width == tmi.tmMaxCharWidth)
00847             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00848         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Width == tmi.tmMaxCharWidth*2)
00849             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00850     }
00851     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00852     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00853 }
00854 
00855 
00856 <span class="comment">/*++</span>
00857 <span class="comment"></span>
00858 <span class="comment">Routine Description:</span>
00859 <span class="comment"></span>
00860 <span class="comment">    This routine remove DBCS padding code.</span>
00861 <span class="comment"></span>
00862 <span class="comment">Arguments:</span>
00863 <span class="comment"></span>
00864 <span class="comment">    Dst - Pointer to destination.</span>
00865 <span class="comment"></span>
00866 <span class="comment">    Src - Pointer to source.</span>
00867 <span class="comment"></span>
00868 <span class="comment">    NumBytes - Number of string.</span>
00869 <span class="comment"></span>
00870 <span class="comment">    OS2OemFormat -</span>
00871 <span class="comment"></span>
00872 <span class="comment">Return Value:</span>
00873 <span class="comment"></span>
00874 <span class="comment">--*/</span>
00875 
00876 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
00877 <a class="code" href="../../d0/d3/dbcs_8h.html#a34">RemoveDbcsMark</a>(
00878     IN PWCHAR Dst,
00879     IN PWCHAR Src,
00880     IN DWORD NumBytes,
00881     IN PCHAR SrcA,
00882     IN BOOL OS2OemFormat
00883     )
00884 {
00885     PWCHAR Tmp = Dst;
00886 
00887     <span class="keywordflow">if</span> (NumBytes == 0 || NumBytes &gt;= 0xffffffff)
00888         <span class="keywordflow">return</span>( 0 );
00889 
00890 <span class="preprocessor">#if defined(i386)</span>
00891 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (OS2OemFormat) {
00892         RealUnicodeToNEC_OS2_Unicode(Src, NumBytes);
00893     }
00894 <span class="preprocessor">#endif</span>
00895 <span class="preprocessor"></span>
00896     <span class="keywordflow">if</span> (SrcA) {
00897         <span class="keywordflow">while</span> (NumBytes--)
00898         {
00899             <span class="keywordflow">if</span> (!(*SrcA++ &amp; ATTR_TRAILING_BYTE))
00900                 *Dst++ = *Src;
00901             Src++;
00902         }
00903         <span class="keywordflow">return</span> (ULONG)(Dst - Tmp);
00904     }
00905     <span class="keywordflow">else</span> {
00906         RtlCopyMemory(Dst,Src,NumBytes * <span class="keyword">sizeof</span>(WCHAR)) ;
00907         <span class="keywordflow">return</span>(NumBytes) ;
00908     }
00909 <span class="preprocessor">#if !defined(i386)</span>
00910 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(OS2OemFormat);
00911 <span class="preprocessor">#endif</span>
00912 <span class="preprocessor"></span>}
00913 
00914 <span class="comment">/*++</span>
00915 <span class="comment"></span>
00916 <span class="comment">Routine Description:</span>
00917 <span class="comment"></span>
00918 <span class="comment">    This routine remove DBCS padding code for cell format.</span>
00919 <span class="comment"></span>
00920 <span class="comment">Arguments:</span>
00921 <span class="comment"></span>
00922 <span class="comment">    Dst - Pointer to destination.</span>
00923 <span class="comment"></span>
00924 <span class="comment">    Src - Pointer to source.</span>
00925 <span class="comment"></span>
00926 <span class="comment">    NumBytes - Number of string.</span>
00927 <span class="comment"></span>
00928 <span class="comment">Return Value:</span>
00929 <span class="comment"></span>
00930 <span class="comment">--*/</span>
00931 
00932 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
00933 <a class="code" href="../../d0/d3/dbcs_8h.html#a35">RemoveDbcsMarkCell</a>(
00934     IN PCHAR_INFO Dst,
00935     IN PCHAR_INFO Src,
00936     IN DWORD NumBytes
00937     )
00938 {
00939     PCHAR_INFO Tmp = Dst;
00940     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> TmpByte;
00941 
00942     TmpByte = NumBytes;
00943     <span class="keywordflow">while</span> (NumBytes--) {
00944         <span class="keywordflow">if</span> (!(Src-&gt;Attributes &amp; COMMON_LVB_TRAILING_BYTE)){
00945             *Dst = *Src;
00946             Dst-&gt;Attributes &amp;= ~COMMON_LVB_SBCSDBCS;
00947             Dst++;
00948         }
00949         Src++;
00950     }
00951     NumBytes = (ULONG)(TmpByte - (Dst - Tmp));
00952     RtlZeroMemory(Dst, NumBytes * <span class="keyword">sizeof</span>(CHAR_INFO));
00953     Dst += NumBytes;
00954 
00955     <span class="keywordflow">return</span> (ULONG)(Dst - Tmp);
00956 }
00957 
00958 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
00959 <a class="code" href="../../d0/d3/dbcs_8h.html#a36">RemoveDbcsMarkAll</a>(
00960     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00961     IN <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row,
00962     IN PSHORT LeftChar,
00963     IN PRECT TextRect,
00964     IN <span class="keywordtype">int</span> *TextLeft,
00965     IN PWCHAR Buffer,
00966     IN SHORT NumberOfChars
00967     )
00968 {
00969     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> OS2OemFormat = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00970 
00971 <span class="preprocessor">#if defined(i386)</span>
00972 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((ScreenInfo-&gt;Console-&gt;Flags &amp; CONSOLE_OS2_REGISTERED) &amp;&amp;
00973         (ScreenInfo-&gt;Console-&gt;Flags &amp; CONSOLE_OS2_OEM_FORMAT) &amp;&amp;
00974         (ScreenInfo-&gt;Console-&gt;OutputCP == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>)) {
00975         OS2OemFormat = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00976     }
00977 <span class="preprocessor">#endif // i386</span>
00978 <span class="preprocessor"></span>
00979     <span class="keywordflow">if</span> (NumberOfChars &lt;= 0)
00980         <span class="keywordflow">return</span> NumberOfChars;
00981 
00982     <span class="keywordflow">if</span> ( !CONSOLE_IS_DBCS_OUTPUTCP(ScreenInfo-&gt;Console))
00983     {
00984         <span class="keywordflow">return</span> <a class="code" href="../../d0/d3/dbcs_8h.html#a34">RemoveDbcsMark</a>(Buffer,
00985                               &amp;Row-&gt;CharRow.Chars[*LeftChar],
00986                               NumberOfChars,
00987                               NULL,
00988                               OS2OemFormat
00989                              );
00990     }
00991     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( *LeftChar &gt; ScreenInfo-&gt;Window.Left &amp;&amp;  Row-&gt;CharRow.KAttrs[*LeftChar] &amp; ATTR_TRAILING_BYTE)
00992     {
00993         TextRect-&gt;left -= <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
00994         --*LeftChar;
00995         <span class="keywordflow">if</span> (TextLeft)
00996             *TextLeft = TextRect-&gt;left;
00997         <span class="keywordflow">return</span> <a class="code" href="../../d0/d3/dbcs_8h.html#a34">RemoveDbcsMark</a>(Buffer,
00998                               &amp;Row-&gt;CharRow.Chars[*LeftChar],
00999                               NumberOfChars+1,
01000                               &amp;Row-&gt;CharRow.KAttrs[*LeftChar],
01001                               OS2OemFormat
01002                              );
01003     }
01004     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*LeftChar == ScreenInfo-&gt;Window.Left &amp;&amp; Row-&gt;CharRow.KAttrs[*LeftChar] &amp; ATTR_TRAILING_BYTE)
01005     {
01006         *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01007         <span class="keywordflow">return</span> <a class="code" href="../../d0/d3/dbcs_8h.html#a34">RemoveDbcsMark</a>(Buffer+1,
01008                               &amp;Row-&gt;CharRow.Chars[*LeftChar+1],
01009                               NumberOfChars-1,
01010                               &amp;Row-&gt;CharRow.KAttrs[*LeftChar+1],
01011                               OS2OemFormat
01012                              ) + 1;
01013     }
01014     <span class="keywordflow">else</span>
01015     {
01016         <span class="keywordflow">return</span> <a class="code" href="../../d0/d3/dbcs_8h.html#a34">RemoveDbcsMark</a>(Buffer,
01017                               &amp;Row-&gt;CharRow.Chars[*LeftChar],
01018                               NumberOfChars,
01019                               &amp;Row-&gt;CharRow.KAttrs[*LeftChar],
01020                               OS2OemFormat
01021                              );
01022     }
01023 }
01024 
01025 
01026 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
01027 <a class="code" href="../../d0/d3/dbcs_8h.html#a37">IsDBCSLeadByteConsole</a>(
01028     IN BYTE AsciiChar,
01029     IN LPCPINFO lpCPInfo
01030     )
01031 {
01032     <span class="keywordtype">int</span> i;
01033 
01034     i = 0;
01035     <span class="keywordflow">while</span> (lpCPInfo-&gt;LeadByte[i]) {
01036         <span class="keywordflow">if</span> (lpCPInfo-&gt;LeadByte[i] &lt;= AsciiChar &amp;&amp; AsciiChar &lt;= lpCPInfo-&gt;LeadByte[i+1])
01037             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01038         i += 2;
01039     }
01040     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01041 }
01042 
01043 
01044 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01045 <a class="code" href="../../d0/d3/dbcs_8h.html#a38">AdjustFont</a>(
01046     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01047     IN UINT CodePage
01048     )
01049 {
01050     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo = Console-&gt;CurrentScreenBuffer;
01051     ULONG FontIndex;
01052     <span class="keyword">static</span> <span class="keyword">const</span> COORD NullCoord = {0, 0};
01053     <a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html">TEXT_BUFFER_FONT_INFO</a> TextFontInfo;
01054     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01055 
01056     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a26">FindTextBufferFontInfo</a>(ScreenInfo,
01057                                     CodePage,
01058                                     &amp;TextFontInfo);
01059     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01060         FontIndex = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a25">FindCreateFont</a>(TextFontInfo.<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o5">Family</a>,
01061                                    TextFontInfo.<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o3">FaceName</a>,
01062                                    TextFontInfo.<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o1">FontSize</a>,
01063                                    TextFontInfo.<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o4">Weight</a>,
01064                                    CodePage);
01065     }
01066     <span class="keywordflow">else</span> {
01067         FontIndex = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a25">FindCreateFont</a>(0,
01068                                    <a class="code" href="../../d8/d5/consrv_8h.html#a65">SCR_FACENAME</a>(ScreenInfo),
01069                                    NullCoord,                  <span class="comment">// sets new font by FontSize=0</span>
01070                                    0,
01071                                    CodePage);
01072     }
01073 <span class="preprocessor">#ifdef i386</span>
01074 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (! (Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
01075         <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a33">SetScreenBufferFont</a>(Console-&gt;CurrentScreenBuffer,FontIndex, CodePage);
01076     }
01077     <span class="keywordflow">else</span> {
01078         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fChange = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01079 
01080         <span class="keywordflow">if</span> ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE) &amp;&amp;
01081             (GetForegroundWindow() == Console-&gt;hWnd)                    )
01082         {
01083             <a class="code" href="../../d8/d5/consrv_8h.html#a293">ChangeDispSettings</a>(Console, Console-&gt;hWnd, 0);
01084             fChange = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01085         }
01086         <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a33">SetScreenBufferFont</a>(Console-&gt;CurrentScreenBuffer,FontIndex, CodePage);
01087         <a class="code" href="../../d7/d4/server_2private_8c.html#a48">ConvertToFullScreen</a>(Console);
01088         <span class="keywordflow">if</span> (fChange &amp;&amp;
01089             (GetForegroundWindow() == Console-&gt;hWnd))
01090             <a class="code" href="../../d8/d5/consrv_8h.html#a293">ChangeDispSettings</a>(Console, Console-&gt;hWnd, CDS_FULLSCREEN);
01091     }
01092 <span class="preprocessor">#else</span>
01093 <span class="preprocessor"></span>    <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a33">SetScreenBufferFont</a>(Console-&gt;CurrentScreenBuffer,FontIndex, CodePage);
01094 <span class="preprocessor">#endif</span>
01095 <span class="preprocessor"></span>    <span class="keywordflow">return</span> STATUS_SUCCESS;
01096 }
01097 
01098 
01099 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01100 <a class="code" href="../../d0/d3/dbcs_8h.html#a39">ConvertToCodePage</a>(
01101     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01102     IN UINT PrevCodePage
01103     )
01104 {
01105     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> Cur;
01106 
01107     <span class="keywordflow">if</span> (Console-&gt;OutputCP != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a> &amp;&amp; PrevCodePage == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>)
01108     {
01109 
01110         <span class="keywordflow">for</span> (Cur=Console-&gt;ScreenBuffers;Cur!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;Cur=Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o23">Next</a>) {
01111 
01112             <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>) {
01113                 <span class="keywordflow">continue</span>;
01114             }
01115 
01116             <a class="code" href="../../d0/d3/dbcs_8h.html#a40">ConvertOutputOemToNonOemUnicode</a>(
01117                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows,
01118                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.DbcsScreenBuffer.KAttrRows,
01119                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X * Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y,
01120                 Console-&gt;OutputCP);
01121 
01122             <span class="keywordflow">if</span> ((Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01123                 ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) == 0)) {
01124                 <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a42">RealUnicodeToFalseUnicode</a>(
01125                     Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows,
01126                     Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X * Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y,
01127                     Console-&gt;OutputCP);
01128             }
01129         }
01130 
01131         <span class="keywordflow">if</span> (Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
01132             PCONVERSIONAREA_INFORMATION ConvAreaInfo;
01133             ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaRoot;
01134             <span class="keywordflow">while</span> (ConvAreaInfo) {
01135                 Cur = ConvAreaInfo-&gt;ScreenBuffer;
01136 
01137                 <span class="keywordflow">if</span> (!(Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>)) {
01138 
01139                     <a class="code" href="../../d0/d3/dbcs_8h.html#a40">ConvertOutputOemToNonOemUnicode</a>(
01140                         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows,
01141                         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.DbcsScreenBuffer.KAttrRows,
01142                         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X * Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y,
01143                         Console-&gt;OutputCP);
01144 
01145                     <span class="keywordflow">if</span> ((Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01146                         ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) == 0)) {
01147                         <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a42">RealUnicodeToFalseUnicode</a>(
01148                             Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows,
01149                             Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X * Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y,
01150                             Console-&gt;OutputCP);
01151                     }
01152                 }
01153 
01154                 ConvAreaInfo = ConvAreaInfo-&gt;ConvAreaNext;
01155             }
01156 
01157             Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
01158         }
01159 
01160 <span class="preprocessor">#ifdef FE_SB</span>
01161 <span class="preprocessor"></span>        <span class="keywordflow">else</span>
01162         {
01163             <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
01164             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
01165         }
01166 <span class="preprocessor">#endif</span>
01167 <span class="preprocessor"></span>
01168         <a class="code" href="../../d6/d2/output_8c.html#a68">SetWindowSize</a>(Console-&gt;CurrentScreenBuffer);
01169         <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(Console-&gt;CurrentScreenBuffer,&amp;Console-&gt;CurrentScreenBuffer-&gt;Window);
01170     }
01171 
01172     <span class="keywordflow">return</span> STATUS_SUCCESS;
01173 }
01174 
01175 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01176 <a class="code" href="../../d0/d3/dbcs_8h.html#a40">ConvertOutputOemToNonOemUnicode</a>(
01177     IN OUT LPWSTR Source,
01178     IN OUT PBYTE KAttrRows,
01179     IN <span class="keywordtype">int</span> SourceLength, <span class="comment">// in chars</span>
01180     IN UINT Codepage
01181     )
01182 {
01183     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01184     LPSTR  pTemp;
01185     LPWSTR pwTemp;
01186     ULONG TempLength;
01187     ULONG Length;
01188     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> NormalChars;
01189     <span class="keywordtype">int</span> i;
01190 
01191     <span class="keywordflow">if</span> (SourceLength == 0 )
01192         <span class="keywordflow">return</span> STATUS_SUCCESS;
01193 
01194     NormalChars = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01195     <span class="keywordflow">for</span> (i=0;i&lt;SourceLength;i++) {
01196         <span class="keywordflow">if</span> (Source[i] &gt; 0x7f) {
01197             NormalChars = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01198             <span class="keywordflow">break</span>;
01199         }
01200     }
01201     <span class="keywordflow">if</span> (NormalChars) {
01202         <span class="keywordflow">return</span> STATUS_SUCCESS;
01203     }
01204 
01205     pTemp = (LPSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_TAG ),SourceLength);
01206     <span class="keywordflow">if</span> (pTemp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01207         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01208     }
01209 
01210     pwTemp = (LPWSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_TAG ),SourceLength * <span class="keyword">sizeof</span>(WCHAR));
01211     <span class="keywordflow">if</span> (pwTemp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01212         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pTemp);
01213         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01214     }
01215 
01216     TempLength = <a class="code" href="../../d0/d3/dbcs_8h.html#a34">RemoveDbcsMark</a>(pwTemp,
01217                                 Source,
01218                                 SourceLength,
01219                                 KAttrRows,
01220                                 FALSE);
01221 
01222     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a39">RtlUnicodeToOemN</a>(pTemp,
01223                               (ULONG)<a class="code" href="../../d8/d5/consrv_8h.html#a39">ConsoleHeapSize</a>(pTemp),
01224                               &amp;Length,
01225                               pwTemp,
01226                               TempLength * <span class="keyword">sizeof</span>(WCHAR)
01227                              );
01228     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01229         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pTemp);
01230         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pwTemp);
01231         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01232     }
01233 
01234     MultiByteToWideChar(Codepage,
01235                         0,
01236                         pTemp,
01237                         Length,
01238                         Source,
01239                         SourceLength
01240                        );
01241     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pTemp);
01242     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pwTemp);
01243 
01244     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01245         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01246     } <span class="keywordflow">else</span> {
01247         <span class="keywordflow">if</span> (KAttrRows) {
01248             RtlZeroMemory(KAttrRows, SourceLength);
01249         }
01250         <span class="keywordflow">return</span> STATUS_SUCCESS;
01251     }
01252 }
01253 
01254 
01255 
01256 
01257 
01258 
01259 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01260 <a class="code" href="../../d0/d3/dbcs_8h.html#a41">TextOutEverything</a>(
01261     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01262     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01263     IN SHORT LeftWindowPos,
01264     IN OUT PSHORT RightWindowPos,
01265     IN OUT PSHORT CountOfAttr,
01266     IN SHORT CountOfAttrOriginal,
01267     IN OUT PBOOL DoubleColorDBCS,
01268     IN BOOL LocalEUDCFlag,
01269     IN <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row,
01270     IN <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> Attr,
01271     IN SHORT LeftTextPos,
01272     IN SHORT RightTextPos,
01273     IN <span class="keywordtype">int</span> WindowRectLeft,
01274     IN RECT WindowRect,
01275     IN SHORT NumberOfChars
01276     )
01277 
01278 <span class="comment">/*++</span>
01279 <span class="comment"></span>
01280 <span class="comment">Routine Description:</span>
01281 <span class="comment"></span>
01282 <span class="comment">    This routine text out everything.</span>
01283 <span class="comment"></span>
01284 <span class="comment">Arguments:</span>
01285 <span class="comment"></span>
01286 <span class="comment">Return Value:</span>
01287 <span class="comment"></span>
01288 <span class="comment">--*/</span>
01289 
01290 {
01291     <span class="keywordtype">int</span>   j = LeftWindowPos;
01292     <span class="keywordtype">int</span>   TextLeft = WindowRectLeft;
01293     RECT TextRect = WindowRect;
01294     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> LeftChar = LeftTextPos;
01295     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RightChar = RightTextPos;
01296     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  DoubleColorDBCSBefore;
01297     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  LocalEUDCFlagBefore;
01298     <a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">PEUDC_INFORMATION</a> EudcInfo;
01299 
01300     <span class="keywordtype">int</span>   RightPos  = j + *CountOfAttr - 1;
01301     <span class="keywordtype">int</span>   RightText = LeftChar + *CountOfAttr - 1;
01302     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  OS2OemFormat = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01303 
01304 <span class="preprocessor">#ifdef FE_SB</span>
01305 <span class="preprocessor"></span>    <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
01306     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(ScreenInfo-&gt;Flags &amp; CONSOLE_GRAPHICS_BUFFER));
01307 <span class="preprocessor">#endif</span>
01308 <span class="preprocessor"></span>
01309 <span class="preprocessor">#if defined(i386)</span>
01310 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((ScreenInfo-&gt;Console-&gt;Flags &amp; CONSOLE_OS2_REGISTERED) &amp;&amp;
01311         (ScreenInfo-&gt;Console-&gt;Flags &amp; CONSOLE_OS2_OEM_FORMAT) &amp;&amp;
01312         (ScreenInfo-&gt;Console-&gt;OutputCP == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>)) {
01313         OS2OemFormat = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01314     }
01315 <span class="preprocessor">#endif // i386</span>
01316 <span class="preprocessor"></span>
01317 <span class="preprocessor">#if defined(DBG) &amp;&amp; defined(DBG_KATTR)</span>
01318 <span class="preprocessor"></span>    BeginKAttrCheck(ScreenInfo);
01319 <span class="preprocessor">#endif</span>
01320 <span class="preprocessor"></span>
01321     RightText = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(RightText,(ScreenInfo-&gt;ScreenBufferSize.X-1));
01322 
01323     LocalEUDCFlagBefore = LocalEUDCFlag ;
01324     EudcInfo = (<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">PEUDC_INFORMATION</a>)Console-&gt;EudcInformation;
01325 
01326     DoubleColorDBCSBefore = *DoubleColorDBCS ;
01327     <span class="keywordflow">if</span> (DoubleColorDBCSBefore){
01328         RECT TmpRect;
01329 
01330         <span class="keywordflow">if</span> (Console-&gt;FonthDC == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01331             Console-&gt;FonthDC = CreateCompatibleDC(Console-&gt;hDC);
01332             Console-&gt;hBitmap = CreateBitmap(DEFAULT_FONTSIZE, DEFAULT_FONTSIZE, BITMAP_PLANES, BITMAP_BITS_PIXEL, NULL);
01333             SelectObject(Console-&gt;FonthDC, Console-&gt;hBitmap);
01334         }
01335 
01336         <span class="keywordflow">if</span> (LocalEUDCFlagBefore){
01337             <span class="keywordflow">if</span> (EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o2">hDCLocalEudc</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01338                 EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o2">hDCLocalEudc</a> = CreateCompatibleDC(Console-&gt;hDC);
01339                 EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o3">hBmpLocalEudc</a> = CreateBitmap(EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o5">LocalEudcSize</a>.X,
01340                                                        EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o5">LocalEudcSize</a>.Y,
01341                                                        BITMAP_PLANES, BITMAP_BITS_PIXEL, NULL);
01342                 SelectObject(EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o2">hDCLocalEudc</a>, EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o3">hBmpLocalEudc</a>);
01343             }
01344             <a class="code" href="../../d9/d7/eudc_8h.html#a7">GetFitLocalEUDCFont</a>(Console,
01345                                 Row-&gt;CharRow.Chars[LeftChar-1]);
01346             BitBlt(Console-&gt;hDC,
01347                    TextRect.left,
01348                    TextRect.top,
01349                    <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X,
01350                    <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y,
01351                    EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o2">hDCLocalEudc</a>,
01352                    <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X,
01353                    0,
01354                    SRCCOPY
01355                   );
01356             TextRect.left += <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
01357             TextLeft +=  <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
01358             TextRect.right += <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
01359             (*CountOfAttr)++;
01360             NumberOfChars = 0;
01361         }
01362         <span class="keywordflow">else</span>{
01363             TmpRect.left = 0;
01364             TmpRect.top = 0;
01365             TmpRect.right = <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
01366             TmpRect.bottom = <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y;
01367 
01368             SelectObject(Console-&gt;FonthDC,
01369                          FontInfo[<a class="code" href="../../d8/d5/consrv_8h.html#a64">SCR_FONTNUMBER</a>(ScreenInfo)].hFont
01370                         );
01371 
01372             ExtTextOutW(Console-&gt;FonthDC,
01373                         0,
01374                         0,
01375                         ETO_OPAQUE,
01376                         &amp;TmpRect,
01377                         &amp;Row-&gt;CharRow.Chars[LeftChar-1],
01378                         1,
01379                         NULL
01380                        );
01381             BitBlt(Console-&gt;hDC,
01382                    TextRect.left,
01383                    TextRect.top,
01384                    <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X,
01385                    <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y,
01386                    Console-&gt;FonthDC,
01387                    <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X,
01388                    0,
01389                    SRCCOPY
01390                   );
01391             TextRect.left += <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
01392             TextLeft += <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
01393             NumberOfChars = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d0/d3/dbcs_8h.html#a34">RemoveDbcsMark</a>(ScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer.TransBufferCharacter,
01394                                                   &amp;Row-&gt;CharRow.Chars[LeftChar+1],
01395                                                   NumberOfChars-1,
01396                                                   &amp;Row-&gt;CharRow.KAttrs[LeftChar+1],
01397                                                   OS2OemFormat);
01398         }
01399 
01400     }
01401     <span class="keywordflow">else</span> {
01402         NumberOfChars = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d0/d3/dbcs_8h.html#a36">RemoveDbcsMarkAll</a>(ScreenInfo,
01403                                                  Row,
01404                                                  &amp;LeftChar,
01405                                                  &amp;TextRect,
01406                                                  &amp;TextLeft,
01407                                                  ScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer.TransBufferCharacter,
01408                                                  NumberOfChars);
01409     }
01410 
01411 
01412     *DoubleColorDBCS = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
01413     <span class="keywordflow">if</span> ((NumberOfChars != 0) &amp;&amp; (Row-&gt;CharRow.KAttrs[RightText] &amp; ATTR_LEADING_BYTE)){
01414         <span class="keywordflow">if</span> (RightPos &gt;= ScreenInfo-&gt;Window.Right)
01415             *(ScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer.TransBufferCharacter+NumberOfChars-1) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01416         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(TextRect.right &lt;= ScreenInfo-&gt;Window.Right * <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X) {
01417             *DoubleColorDBCS = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01418             TextRect.right += <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
01419             <span class="keywordflow">if</span>((j == *RightWindowPos)&amp;&amp;
01420                (*RightWindowPos &lt; ScreenInfo-&gt;Window.Right))
01421             *RightWindowPos++;
01422         }
01423     }
01424 
01425     <span class="keywordflow">if</span>( TextRect.left &lt; TextRect.right){
01426         ExtTextOutW(Console-&gt;hDC,
01427                     TextLeft,
01428                     TextRect.top,
01429                     ETO_OPAQUE,
01430                     &amp;TextRect,
01431                     ScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer.TransBufferCharacter,
01432                     NumberOfChars,
01433                     NULL
01434                    );
01435     }
01436     <span class="keywordflow">if</span> (LocalEUDCFlagBefore){
01437         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwFullWidth = (IsConsoleFullWidth(Console-&gt;hDC,
01438                                                 Console-&gt;OutputCP,
01439                                                 Row-&gt;CharRow.Chars[RightText+1]) ? 2 : 1);
01440 
01441         <span class="keywordflow">if</span> (EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o2">hDCLocalEudc</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01442             EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o2">hDCLocalEudc</a> = CreateCompatibleDC(Console-&gt;hDC);
01443             EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o3">hBmpLocalEudc</a> = CreateBitmap(EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o5">LocalEudcSize</a>.X,
01444                                                    EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o5">LocalEudcSize</a>.Y,
01445                                                    BITMAP_PLANES, BITMAP_BITS_PIXEL, NULL);
01446             SelectObject(EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o2">hDCLocalEudc</a>, EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o3">hBmpLocalEudc</a>);
01447         }
01448         <a class="code" href="../../d9/d7/eudc_8h.html#a7">GetFitLocalEUDCFont</a>(Console,
01449                             Row-&gt;CharRow.Chars[RightText+1]);
01450         BitBlt(Console-&gt;hDC,                      <span class="comment">// hdcDest</span>
01451                TextRect.right,                    <span class="comment">// nXDest</span>
01452                TextRect.top,                      <span class="comment">// nYDest</span>
01453                <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X * dwFullWidth, <span class="comment">// nWidth</span>
01454                <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y,    <span class="comment">// nHeight</span>
01455                EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o2">hDCLocalEudc</a>,            <span class="comment">// hdcSrc</span>
01456                0,                                 <span class="comment">// nXSrc</span>
01457                0,                                 <span class="comment">// nYSrc</span>
01458                SRCCOPY
01459               );
01460 
01461         TextRect.right += (<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X * dwFullWidth);
01462         (*CountOfAttr) += (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)dwFullWidth;
01463         <span class="keywordflow">if</span> (CountOfAttrOriginal &lt; *CountOfAttr ){
01464             *DoubleColorDBCS = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
01465             (*CountOfAttr)--;
01466             TextRect.right -= <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
01467         }
01468     }
01469     <span class="keywordflow">if</span> (DoubleColorDBCSBefore){
01470         TextRect.left -= <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
01471     }
01472 
01473     <a class="code" href="../../d0/d3/dbcs_8h.html#a42">TextOutCommonLVB</a>(Console, Attr-&gt;Attr, TextRect);
01474 
01475 }
01476 
01477 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01478 <a class="code" href="../../d0/d3/dbcs_8h.html#a42">TextOutCommonLVB</a>(
01479     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01480     IN WORD Attributes,
01481     IN RECT CommonLVBRect
01482     )
01483 {
01484     HBRUSH hbrSave;
01485     HGDIOBJ hbr;
01486     <span class="keywordtype">int</span> GridX;
01487 
01488     <span class="keywordflow">if</span> (Attributes &amp; (COMMON_LVB_GRID_HORIZONTAL |
01489                       COMMON_LVB_GRID_LVERTICAL  |
01490                       COMMON_LVB_GRID_RVERTICAL  |
01491                       COMMON_LVB_UNDERSCORE       )
01492        )
01493     {
01494         <span class="keywordflow">if</span>(Attributes &amp; COMMON_LVB_UNDERSCORE){
01495             <span class="keywordflow">if</span>(Attributes &amp; COMMON_LVB_REVERSE_VIDEO)
01496                 hbr = CreateSolidBrush(<a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attributes &gt;&gt; 4)));
01497             <span class="keywordflow">else</span>
01498                 hbr = CreateSolidBrush(<a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attributes)));
01499             hbrSave = SelectObject(Console-&gt;hDC, hbr);
01500             PatBlt(Console-&gt;hDC,
01501                    CommonLVBRect.left,
01502                    CommonLVBRect.bottom-1,
01503                    CommonLVBRect.right-CommonLVBRect.left,
01504                    1,
01505                    PATCOPY
01506                   );
01507             SelectObject(Console-&gt;hDC, hbrSave);
01508             DeleteObject(hbr);
01509         }
01510 
01511         <span class="keywordflow">if</span>(Attributes &amp; (COMMON_LVB_GRID_HORIZONTAL | COMMON_LVB_GRID_LVERTICAL | COMMON_LVB_GRID_RVERTICAL)){
01512             hbr = CreateSolidBrush(<a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, 0x0007));
01513             hbrSave = SelectObject(Console-&gt;hDC, hbr);
01514 
01515             <span class="keywordflow">if</span>(Attributes &amp; COMMON_LVB_GRID_HORIZONTAL){
01516                 PatBlt(Console-&gt;hDC,
01517                        CommonLVBRect.left,
01518                        CommonLVBRect.top,
01519                        CommonLVBRect.right-CommonLVBRect.left,
01520                        1,
01521                        PATCOPY
01522                       );
01523             }
01524             <span class="keywordflow">if</span>(Attributes &amp; COMMON_LVB_GRID_LVERTICAL){
01525                 <span class="keywordflow">for</span> ( GridX = CommonLVBRect.left ;
01526                       GridX &lt; CommonLVBRect.right ;
01527                       GridX += <a class="code" href="../../d8/d5/consrv_8h.html#a29">CON_FONTSIZE</a>(Console).X){
01528                     PatBlt(Console-&gt;hDC,
01529                            GridX,
01530                            CommonLVBRect.top,
01531                            1,
01532                            <a class="code" href="../../d8/d5/consrv_8h.html#a29">CON_FONTSIZE</a>(Console).Y,
01533                            PATCOPY
01534                           );
01535                 }
01536             }
01537             <span class="keywordflow">if</span>(Attributes &amp; COMMON_LVB_GRID_RVERTICAL){
01538                 <span class="keywordflow">for</span> ( GridX = CommonLVBRect.left + <a class="code" href="../../d8/d5/consrv_8h.html#a29">CON_FONTSIZE</a>(Console).X-1 ;
01539                       GridX &lt; CommonLVBRect.right ;
01540                       GridX += <a class="code" href="../../d8/d5/consrv_8h.html#a29">CON_FONTSIZE</a>(Console).X){
01541                     PatBlt(Console-&gt;hDC,
01542                            GridX,
01543                            CommonLVBRect.top,
01544                            1,
01545                            <a class="code" href="../../d8/d5/consrv_8h.html#a29">CON_FONTSIZE</a>(Console).Y,
01546                            PATCOPY
01547                           );
01548                 }
01549             }
01550             SelectObject(Console-&gt;hDC, hbrSave);
01551             DeleteObject(hbr);
01552         }
01553     }
01554 }
01555 
01556 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01557 <a class="code" href="../../d0/d3/dbcs_8h.html#a43">MakeAltRasterFont</a>(
01558     UINT CodePage,
01559     COORD DefaultFontSize,
01560     COORD *AltFontSize,
01561     BYTE  *AltFontFamily,
01562     ULONG *AltFontIndex,
01563     LPWSTR AltFaceName
01564     )
01565 {
01566     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
01567     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Find;
01568     ULONG FontIndex;
01569     COORD FontSize = <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>;
01570     COORD FontDelta;
01571     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fDbcsCharSet = <a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>(CodePage);
01572 
01573     FontIndex = 0;
01574     Find = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
01575     <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>; i++)
01576     {
01577         <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d6/font_8h.html#a2">TM_IS_TT_FONT</a>(FontInfo[i].Family) &amp;&amp;
01578             IS_ANY_DBCS_CHARSET(FontInfo[i].tmCharSet) == fDbcsCharSet
01579            )
01580         {
01581             FontDelta.X = <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(FontSize.X - FontInfo[i].Size.X);
01582             FontDelta.Y = <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(FontSize.Y - FontInfo[i].Size.Y);
01583             <span class="keywordflow">if</span> (Find &gt; (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(FontDelta.X + FontDelta.Y))
01584             {
01585                 Find = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(FontDelta.X + FontDelta.Y);
01586                 FontIndex = i;
01587             }
01588         }
01589     }
01590 
01591     *AltFontIndex = FontIndex;
01592     wcscpy(AltFaceName, FontInfo[*AltFontIndex].FaceName);
01593     *AltFontSize = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[*AltFontIndex].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>;
01594     *AltFontFamily = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[*AltFontIndex].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o5">Family</a>;
01595 
01596     <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"MakeAltRasterFont : AltFontIndex = %ld\n"</span>, *AltFontIndex));
01597 
01598     <span class="keywordflow">return</span> STATUS_SUCCESS;
01599 }
01600 
01601 
01602 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01603 <a class="code" href="../../d0/d3/dbcs_8h.html#a44">InitializeDbcsMisc</a>(
01604     VOID
01605     )
01606 {
01607     HANDLE hkRegistry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01608     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01609     WCHAR awchValue[ 512 ];
01610     WCHAR awchData[ 512 ];
01611     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[ 512 ];
01612     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Length;
01613     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwIndex;
01614     LPWSTR pwsz;
01615 
01616     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(gTTFontList.Next==NULL);
01617     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d0/d3/dbcs_8h.html#a25">gRegFullScreenCodePage</a>.Next==NULL);
01618 
01619     gTTFontList.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01620     <a class="code" href="../../d0/d3/dbcs_8h.html#a25">gRegFullScreenCodePage</a>.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01621 
01622     <span class="comment">/*</span>
01623 <span class="comment">     * Get TrueType Font Face name from registry.</span>
01624 <span class="comment">     */</span>
01625     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a44">MyRegOpenKey</a>(NULL,
01626                           MACHINE_REGISTRY_CONSOLE_TTFONT,
01627                           &amp;hkRegistry);
01628     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01629         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONSRV: NtOpenKey failed %ws\n"</span>, MACHINE_REGISTRY_CONSOLE_TTFONT));
01630     }
01631     <span class="keywordflow">else</span> {
01632         LPTTFONTLIST pTTFontList;
01633 
01634         <span class="keywordflow">for</span>( dwIndex = 0; ; dwIndex++) {
01635             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = MyRegEnumValue(hkRegistry,
01636                                     dwIndex,
01637                                     <span class="keyword">sizeof</span>(awchValue), (LPWSTR)&amp;awchValue,
01638                                     <span class="keyword">sizeof</span>(awchData),  (PBYTE)&amp;awchData);
01639             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01640                 <span class="keywordflow">break</span>;
01641             }
01642 
01643             pTTFontList = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
01644                                     <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SCREEN_DBCS_TAG ),
01645                                     <span class="keyword">sizeof</span>(TTFONTLIST));
01646             <span class="keywordflow">if</span> (pTTFontList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01647                 <span class="keywordflow">break</span>;
01648             }
01649 
01650             pTTFontList-&gt;List.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01651             pTTFontList-&gt;CodePage = <a class="code" href="../../d9/d7/eudc_8h.html#a12">ConvertStringToDec</a>(awchValue, NULL);
01652             pwsz = awchData;
01653             <span class="keywordflow">if</span> (*pwsz == BOLD_MARK) {
01654                 pTTFontList-&gt;fDisableBold = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01655                 pwsz++;
01656             }
01657             <span class="keywordflow">else</span>
01658                 pTTFontList-&gt;fDisableBold = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01659             wcscpy(pTTFontList-&gt;FaceName1, pwsz);
01660 
01661             pwsz += wcslen(pwsz) + 1;
01662             <span class="keywordflow">if</span> (*pwsz == BOLD_MARK) {
01663                 pTTFontList-&gt;fDisableBold = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01664                 pwsz++;
01665             }
01666             wcscpy(pTTFontList-&gt;FaceName2, pwsz);
01667 
01668             PushEntryList(&amp;gTTFontList, &amp;(pTTFontList-&gt;List));
01669         }
01670 
01671         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkRegistry);
01672     }
01673 
01674     <span class="comment">/*</span>
01675 <span class="comment">     * Get Full Screen from registry.</span>
01676 <span class="comment">     */</span>
01677     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a44">MyRegOpenKey</a>(NULL,
01678                           MACHINE_REGISTRY_CONSOLE_FULLSCREEN,
01679                           &amp;hkRegistry);
01680     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01681         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONSRV: NtOpenKey failed %ws\n"</span>, MACHINE_REGISTRY_CONSOLE_FULLSCREEN));
01682     }
01683     <span class="keywordflow">else</span> {
01684         <span class="comment">/*</span>
01685 <span class="comment">         * InitialPalette</span>
01686 <span class="comment">         */</span>
01687         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = MyRegQueryValueEx(hkRegistry,
01688                                    MACHINE_REGISTRY_INITIAL_PALETTE,
01689                                    <span class="keyword">sizeof</span>( Buffer ), Buffer, &amp;Length);
01690         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) &amp;&amp; Length &gt; <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) {
01691             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> PaletteLength = ((LPDWORD)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)[0];
01692             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> Palette;
01693 
01694             <span class="keywordflow">if</span> (PaletteLength * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) &gt;= (Length - <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)))
01695             {
01696                 Palette = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
01697                                     <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( BUFFER_TAG ),
01698                                     Length);
01699                 <span class="keywordflow">if</span> (Palette != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01700                 {
01701                     RtlCopyMemory(Palette, Buffer, Length);
01702                     <a class="code" href="../../d0/d3/dbcs_8h.html#a20">RegInitialPalette</a> = Palette;
01703                 }
01704             }
01705         }
01706 
01707         <span class="comment">/*</span>
01708 <span class="comment">         * ColorBuffer</span>
01709 <span class="comment">         */</span>
01710         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = MyRegQueryValueEx(hkRegistry,
01711                                    MACHINE_REGISTRY_COLOR_BUFFER,
01712                                    <span class="keyword">sizeof</span>( Buffer ), Buffer, &amp;Length);
01713         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) &amp;&amp; Length &gt; <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) {
01714             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ColorBufferLength = ((LPDWORD)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)[0];
01715             PUCHAR Color;
01716 
01717             <span class="keywordflow">if</span> (ColorBufferLength * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) &gt;= (Length - <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)))
01718             {
01719                 Color = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
01720                                   <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( BUFFER_TAG ),
01721                                   Length);
01722                 <span class="keywordflow">if</span> (Color != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01723                 {
01724                     RtlCopyMemory(Color, Buffer, Length);
01725                     <a class="code" href="../../d0/d3/dbcs_8h.html#a21">RegColorBuffer</a> = Color;
01726                 }
01727             }
01728         }
01729 
01730         <span class="comment">/*</span>
01731 <span class="comment">         * ColorBufferNoTranslate</span>
01732 <span class="comment">         */</span>
01733         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = MyRegQueryValueEx(hkRegistry,
01734                                    MACHINE_REGISTRY_COLOR_BUFFER_NO_TRANSLATE,
01735                                    <span class="keyword">sizeof</span>( Buffer ), Buffer, &amp;Length);
01736         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) &amp;&amp; Length &gt; <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) {
01737             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ColorBufferLength = ((LPDWORD)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)[0];
01738             PUCHAR Color;
01739 
01740             <span class="keywordflow">if</span> (ColorBufferLength * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) &gt;= (Length - <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)))
01741             {
01742                 Color = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
01743                                   <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( BUFFER_TAG ),
01744                                   Length);
01745                 <span class="keywordflow">if</span> (Color != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01746                 {
01747                     RtlCopyMemory(Color, Buffer, Length);
01748                     <a class="code" href="../../d0/d3/dbcs_8h.html#a22">RegColorBufferNoTranslate</a> = Color;
01749                 }
01750             }
01751         }
01752 
01753         <span class="comment">/*</span>
01754 <span class="comment">         * ModeFontPairs</span>
01755 <span class="comment">         */</span>
01756         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = MyRegQueryValueEx(hkRegistry,
01757                                    MACHINE_REGISTRY_MODE_FONT_PAIRS,
01758                                    <span class="keyword">sizeof</span>( Buffer ), Buffer, &amp;Length);
01759         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) &amp;&amp; Length &gt; <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) {
01760             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> NumOfEntries = ((LPDWORD)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)[0];
01761             <a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html">PMODE_FONT_PAIR</a> ModeFont;
01762 
01763             <span class="keywordflow">if</span> (NumOfEntries * <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html">MODE_FONT_PAIR</a>) &gt;= (Length - <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)))
01764             {
01765                 ModeFont = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
01766                                      <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( BUFFER_TAG ),
01767                                      Length);
01768                 <span class="keywordflow">if</span> (ModeFont != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01769                 {
01770                     Length -= <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
01771                     RtlCopyMemory(ModeFont, &amp;Buffer[<span class="keyword">sizeof</span>(DWORD)], Length);
01772                     <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a> = ModeFont;
01773                     <a class="code" href="../../d7/d4/server_2private_8c.html#a17">NUMBER_OF_MODE_FONT_PAIRS</a> = NumOfEntries;
01774                 }
01775             }
01776         }
01777 
01778         <span class="comment">/*</span>
01779 <span class="comment">         * FullScreen\CodePage</span>
01780 <span class="comment">         */</span>
01781         {
01782             HANDLE hkRegCP = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01783 
01784             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a44">MyRegOpenKey</a>(hkRegistry,
01785                                   MACHINE_REGISTRY_FS_CODEPAGE,
01786                                   &amp;hkRegCP);
01787             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01788                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONSRV: NtOpenKey failed %ws\n"</span>, MACHINE_REGISTRY_FS_CODEPAGE));
01789             }
01790             <span class="keywordflow">else</span> {
01791                 <a class="code" href="../../d8/d0/struct__FS__CODEPAGE.html">PFS_CODEPAGE</a> pFsCodePage;
01792 
01793                 <span class="keywordflow">for</span>( dwIndex = 0; ; dwIndex++) {
01794                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = MyRegEnumValue(hkRegCP,
01795                                             dwIndex,
01796                                             <span class="keyword">sizeof</span>(awchValue), (LPWSTR)&amp;awchValue,
01797                                             <span class="keyword">sizeof</span>(awchData),  (PBYTE)&amp;awchData);
01798                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01799                         <span class="keywordflow">break</span>;
01800                     }
01801 
01802                     pFsCodePage = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
01803                                             <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( BUFFER_TAG ),
01804                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d0/struct__FS__CODEPAGE.html">FS_CODEPAGE</a>));
01805                     <span class="keywordflow">if</span> (pFsCodePage == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01806                         <span class="keywordflow">break</span>;
01807                     }
01808 
01809                     pFsCodePage-&gt;<a class="code" href="../../d8/d0/struct__FS__CODEPAGE.html#o0">List</a>.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01810                     pFsCodePage-&gt;<a class="code" href="../../d8/d0/struct__FS__CODEPAGE.html#o1">CodePage</a> = <a class="code" href="../../d9/d7/eudc_8h.html#a12">ConvertStringToDec</a>(awchValue, NULL);
01811 
01812                     PushEntryList(&amp;gRegFullScreenCodePage, &amp;(pFsCodePage-&gt;<a class="code" href="../../d8/d0/struct__FS__CODEPAGE.html#o0">List</a>));
01813                 }
01814 
01815                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkRegCP);
01816             }
01817         }
01818 
01819 
01820         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkRegistry);
01821     }
01822 
01823 
01824 <span class="preprocessor">#if defined(i386)</span>
01825 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = NtGetMachineIdentifierValue(&amp;gdwMachineId);
01826     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01827         gdwMachineId = MACHINEID_MS_PCAT;
01828     }
01829 <span class="preprocessor">#endif</span>
01830 <span class="preprocessor"></span>
01831     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>(&amp;ConIMEInitWindowsLock,
01832                                                       0x80000000);
01833 
01834     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01835 }
01836 
01837 <span class="preprocessor">#if defined(i386)</span>
01838 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01839 RealUnicodeToNEC_OS2_Unicode(
01840     IN OUT LPWSTR Source,
01841     IN <span class="keywordtype">int</span> SourceLength      <span class="comment">// in chars</span>
01842     )
01843 
01844 <span class="comment">/*</span>
01845 <span class="comment"></span>
01846 <span class="comment">    this routine converts a unicode string from the real unicode characters</span>
01847 <span class="comment">    to the NEC OS/2 unicode characters.</span>
01848 <span class="comment"></span>
01849 <span class="comment">*/</span>
01850 
01851 {
01852     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01853     LPSTR Temp;
01854     ULONG TempLength;
01855     ULONG Length;
01856     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> StackBuffer[<a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>];
01857     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> NormalChars;
01858     <span class="keywordtype">int</span> i;
01859 
01860     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"RealUnicodeToNEC_OS2_Unicode U-&gt;ACP:???-&gt;U %.*ls\n"</span>,
01861             SourceLength &gt; 10 ? 10 : SourceLength, Source));
01862     NormalChars = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01863 
01864     <span class="keywordflow">if</span> (pGlyph_NEC_OS2_CP == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pGlyph_NEC_OS2_CP-&gt;MultiByteTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01865         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"RealUnicodeToNEC_OS2_Unicode  xfer buffer null\n"</span>));
01866         <span class="keywordflow">return</span> STATUS_SUCCESS;  <span class="comment">// there's nothing we can do</span>
01867     }
01868 
01869     <span class="comment">/*</span>
01870 <span class="comment">     * Test for characters &lt; 0x20.  If none are found, we don't have</span>
01871 <span class="comment">     * any conversion to do!</span>
01872 <span class="comment">     */</span>
01873     <span class="keywordflow">for</span> (i=0;i&lt;SourceLength;i++) {
01874         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Source[i]) &lt; 0x20) {
01875             NormalChars = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01876             <span class="keywordflow">break</span>;
01877         }
01878     }
01879     <span class="keywordflow">if</span> (NormalChars) {
01880         <span class="keywordflow">return</span> STATUS_SUCCESS;
01881     }
01882 
01883     TempLength = SourceLength;
01884     <span class="keywordflow">if</span> (TempLength &gt; <a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>) {
01885         Temp = (LPSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_TAG ),TempLength);
01886         <span class="keywordflow">if</span> (Temp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01887             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01888         }
01889     } <span class="keywordflow">else</span> {
01890         Temp = StackBuffer;
01891     }
01892     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a37">RtlUnicodeToMultiByteN</a>(Temp,
01893                                     TempLength,
01894                                     &amp;Length,
01895                                     Source,
01896                                     SourceLength * <span class="keyword">sizeof</span>(WCHAR)
01897                                    );
01898     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01899         <span class="keywordflow">if</span> (TempLength &gt; <a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>) {
01900             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Temp);
01901         }
01902         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01903     }
01904     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pGlyph_NEC_OS2_CP != NULL &amp;&amp; pGlyph_NEC_OS2_CP-&gt;MultiByteTable != NULL);
01905     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a42">RtlCustomCPToUnicodeN</a>(pGlyph_NEC_OS2_CP,
01906                                    Source,
01907                                    SourceLength * <span class="keyword">sizeof</span>(WCHAR),
01908                                    &amp;Length,
01909                                    Temp,
01910                                    TempLength
01911                                   );
01912     <span class="keywordflow">if</span> (TempLength &gt; <a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>) {
01913         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Temp);
01914     }
01915     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01916         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01917     } <span class="keywordflow">else</span> {
01918         <span class="keywordflow">return</span> STATUS_SUCCESS;
01919     }
01920 }
01921 
01922 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
01923 InitializeNEC_OS2_CP(
01924     VOID
01925     )
01926 {
01927     PPEB pPeb;
01928 
01929     pPeb = NtCurrentPeb();
01930     <span class="keywordflow">if</span> ((pPeb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pPeb-&gt;OemCodePageData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01931         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01932     }
01933 
01934     <span class="comment">/*</span>
01935 <span class="comment">     * Fill in the CPTABLEINFO struct</span>
01936 <span class="comment">     */</span>
01937     <span class="keywordflow">if</span> (pGlyph_NEC_OS2_CP == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01938         pGlyph_NEC_OS2_CP = (PCPTABLEINFO)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(SCREEN_DBCS_TAG), <span class="keyword">sizeof</span>(CPTABLEINFO));
01939         <span class="keywordflow">if</span> (pGlyph_NEC_OS2_CP == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01940             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01941         }
01942     }
01943     <a class="code" href="../../d9/d6/nlsxlat_8c.html#a45">RtlInitCodePageTable</a>(pPeb-&gt;OemCodePageData, pGlyph_NEC_OS2_CP);
01944 
01945     <span class="comment">/*</span>
01946 <span class="comment">     * Make a copy of the MultiByteToWideChar table</span>
01947 <span class="comment">     */</span>
01948     <span class="keywordflow">if</span> (pGlyph_NEC_OS2_Table == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01949         pGlyph_NEC_OS2_Table = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(SCREEN_DBCS_TAG), 256 * <span class="keyword">sizeof</span>(USHORT));
01950         <span class="keywordflow">if</span> (pGlyph_NEC_OS2_Table == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01951             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01952         }
01953     }
01954     RtlCopyMemory(pGlyph_NEC_OS2_Table, pGlyph_NEC_OS2_CP-&gt;MultiByteTable, 256 * <span class="keyword">sizeof</span>(USHORT));
01955 
01956     <span class="comment">/*</span>
01957 <span class="comment">     * Modify the first 0x20 bytes so that they are glyphs.</span>
01958 <span class="comment">     */</span>
01959     MultiByteToWideChar(CP_OEMCP, MB_USEGLYPHCHARS,
01960             <span class="stringliteral">"\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"</span>
01961             <span class="stringliteral">"\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x1E\x1F\x1C\x07"</span>,
01962             0x20, pGlyph_NEC_OS2_Table, 0x20);
01963 
01964 
01965     <span class="comment">/*</span>
01966 <span class="comment">     * Point the Custom CP at the glyph table</span>
01967 <span class="comment">     */</span>
01968     pGlyph_NEC_OS2_CP-&gt;MultiByteTable = pGlyph_NEC_OS2_Table;
01969 
01970     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01971 }
01972 <span class="preprocessor">#endif // i386</span>
01973 <span class="preprocessor"></span>
01974 <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>
01975 <a class="code" href="../../d0/d3/dbcs_8h.html#a45">CodePageToCharSet</a>(
01976     UINT CodePage
01977     )
01978 {
01979     CHARSETINFO csi;
01980 
01981     <span class="keywordflow">if</span> (!TranslateCharsetInfo((DWORD *)CodePage, &amp;csi, TCI_SRCCODEPAGE))
01982         csi.ciCharset = OEM_CHARSET;
01983 
01984     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)csi.ciCharset;
01985 }
01986 
01987 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
01988 <a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>(
01989     UINT CodePage
01990     )
01991 {
01992     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> CharSet = <a class="code" href="../../d0/d3/dbcs_8h.html#a45">CodePageToCharSet</a>(CodePage);
01993 
01994     <span class="keywordflow">return</span> IS_ANY_DBCS_CHARSET(CharSet);
01995 }
01996 
01997 LPTTFONTLIST
01998 <a class="code" href="../../d0/d3/dbcs_8h.html#a47">SearchTTFont</a>(
01999     LPWSTR pwszFace,
02000     BOOL   fCodePage,
02001     UINT   CodePage
02002     )
02003 {
02004     PSINGLE_LIST_ENTRY pTemp = gTTFontList.Next;
02005 
02006     <span class="keywordflow">if</span> (pwszFace) {
02007         <span class="keywordflow">while</span> (pTemp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02008             LPTTFONTLIST pTTFontList = (LPTTFONTLIST)pTemp;
02009 
02010             <span class="keywordflow">if</span> (wcscmp(pwszFace, pTTFontList-&gt;FaceName1) == 0 ||
02011                 wcscmp(pwszFace, pTTFontList-&gt;FaceName2) == 0    ) {
02012                 <span class="keywordflow">if</span> (fCodePage)
02013                     <span class="keywordflow">if</span> (pTTFontList-&gt;CodePage == CodePage )
02014                         <span class="keywordflow">return</span> pTTFontList;
02015                     <span class="keywordflow">else</span>
02016                         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02017                 <span class="keywordflow">else</span>
02018                     <span class="keywordflow">return</span> pTTFontList;
02019             }
02020 
02021             pTemp = pTemp-&gt;Next;
02022         }
02023     }
02024 
02025     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02026 }
02027 
02028 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
02029 <a class="code" href="../../d0/d3/dbcs_8h.html#a48">IsAvailableTTFont</a>(
02030     LPWSTR pwszFace
02031     )
02032 {
02033     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a47">SearchTTFont</a>(pwszFace, FALSE, 0))
02034         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02035     <span class="keywordflow">else</span>
02036         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02037 }
02038 
02039 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
02040 <a class="code" href="../../d0/d3/dbcs_8h.html#a49">IsAvailableTTFontCP</a>(
02041     LPWSTR pwszFace,
02042     UINT CodePage
02043     )
02044 {
02045     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a47">SearchTTFont</a>(pwszFace, TRUE, CodePage))
02046         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02047     <span class="keywordflow">else</span>
02048         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02049 }
02050 
02051 LPWSTR
02052 <a class="code" href="../../d0/d3/dbcs_8h.html#a50">GetAltFaceName</a>(
02053     LPWSTR pwszFace
02054     )
02055 {
02056     LPTTFONTLIST pTTFontList;
02057 
02058     pTTFontList = <a class="code" href="../../d0/d3/dbcs_8h.html#a47">SearchTTFont</a>(pwszFace, FALSE, 0);
02059     <span class="keywordflow">if</span> (pTTFontList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02060         <span class="keywordflow">if</span> (wcscmp(pwszFace, pTTFontList-&gt;FaceName1) == 0) {
02061             <span class="keywordflow">return</span> pTTFontList-&gt;FaceName2;
02062         }
02063         <span class="keywordflow">if</span> (wcscmp(pwszFace, pTTFontList-&gt;FaceName2) == 0) {
02064             <span class="keywordflow">return</span> pTTFontList-&gt;FaceName1;
02065         }
02066         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02067     }
02068     <span class="keywordflow">else</span>
02069         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02070 }
02071 
02072 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
02073 <a class="code" href="../../d0/d3/dbcs_8h.html#a51">IsAvailableFsCodePage</a>(
02074     UINT CodePage
02075     )
02076 {
02077     PSINGLE_LIST_ENTRY pTemp = <a class="code" href="../../d0/d3/dbcs_8h.html#a25">gRegFullScreenCodePage</a>.Next;
02078 
02079     <span class="keywordflow">while</span> (pTemp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02080         <a class="code" href="../../d8/d0/struct__FS__CODEPAGE.html">PFS_CODEPAGE</a> pFsCodePage = (<a class="code" href="../../d8/d0/struct__FS__CODEPAGE.html">PFS_CODEPAGE</a>)pTemp;
02081 
02082         <span class="keywordflow">if</span> (pFsCodePage-&gt;<a class="code" href="../../d8/d0/struct__FS__CODEPAGE.html#o1">CodePage</a> == CodePage) {
02083             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02084         }
02085 
02086         pTemp = pTemp-&gt;Next;
02087     }
02088 
02089     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02090 }
02091 
02092 
02093 <span class="preprocessor">#if defined(FE_IME)</span>
02094 <span class="preprocessor"></span><span class="comment">/*</span>
02095 <span class="comment"> * Console IME executing logic.</span>
02096 <span class="comment"> *</span>
02097 <span class="comment"> * KERNEL32:ConDllInitialize</span>
02098 <span class="comment"> *            If Reason is DLL_PROCESS_ATTACH</span>
02099 <span class="comment"> *            |</span>
02100 <span class="comment"> *            V</span>
02101 <span class="comment"> * WINSRV:ConsoleClientConnectRoutine</span>
02102 <span class="comment"> *          |</span>
02103 <span class="comment"> *          V</span>
02104 <span class="comment"> *          SetUpConsole</span>
02105 <span class="comment"> *            |</span>
02106 <span class="comment"> *            V</span>
02107 <span class="comment"> *            AllocateConsole</span>
02108 <span class="comment"> *              PostThreadMessage(CM_CREATE_CONSOLE_WINDOW)</span>
02109 <span class="comment"> *          |</span>
02110 <span class="comment"> *          V</span>
02111 <span class="comment"> *          UnlockConsoleHandleTable</span>
02112 <span class="comment"> *          InitConsoleIMEStuff</span>
02113 <span class="comment"> *            |</span>
02114 <span class="comment"> *            V</span>
02115 <span class="comment"> *            If never register console IME</span>
02116 <span class="comment"> *              hThread = InternalCreateCallbackThread(ConsoleIMERoutine)</span>
02117 <span class="comment"> *              QueueThreadMessage(CM_WAIT_CONIME_PROCESS)</span>
02118 <span class="comment"> *            |</span>
02119 <span class="comment"> *            V</span>
02120 <span class="comment"> *            QueueThreadMessage(CM_CONIME_CREATE)</span>
02121 <span class="comment"> *          |</span>
02122 <span class="comment"> *          V</span>
02123 <span class="comment"> * KERNEL32:NtWaitForMultipleObjects(InitEvents)</span>
02124 <span class="comment"> *</span>
02125 <span class="comment"> *</span>
02126 <span class="comment"> * WINSRV:InputThread</span>
02127 <span class="comment"> *          |</span>
02128 <span class="comment"> *          V</span>
02129 <span class="comment"> *          GetMessage</span>
02130 <span class="comment"> *            Receive CM_CREATE_CONSOLE_WINDOW</span>
02131 <span class="comment"> *              |</span>
02132 <span class="comment"> *              V</span>
02133 <span class="comment"> *              ProcessCreateConsoleWindow</span>
02134 <span class="comment"> *                |</span>
02135 <span class="comment"> *                V</span>
02136 <span class="comment"> *                CreateWindowsWindow</span>
02137 <span class="comment"> *                  |</span>
02138 <span class="comment"> *                  V</span>
02139 <span class="comment"> *                  CreateWindowEx</span>
02140 <span class="comment"> *                  NtSetEvent(InitEvents)</span>
02141 <span class="comment"> *          |</span>
02142 <span class="comment"> *          V</span>
02143 <span class="comment"> *          GetMessage</span>
02144 <span class="comment"> *            Receive CM_WAIT_CONIME_PROCESS (this case is never register console IME)</span>
02145 <span class="comment"> *              |</span>
02146 <span class="comment"> *              V</span>
02147 <span class="comment"> *              WaitConsoleIMEStuff</span>
02148 <span class="comment"> *                If never register console IME</span>
02149 <span class="comment"> *                  NtWaitForSingleObject(hThread, 20 sec)</span>
02150 <span class="comment"> *</span>
02151 <span class="comment"> *</span>
02152 <span class="comment"> * KERNEL32:ConsoleIMERoutine</span>
02153 <span class="comment"> *            |</span>
02154 <span class="comment"> *            V</span>
02155 <span class="comment"> *            hEvent = CreateEvent(CONSOLEIME_EVENT)</span>
02156 <span class="comment"> *            If not exist named event</span>
02157 <span class="comment"> *              CreateProcess(conime.exe)</span>
02158 <span class="comment"> *              WaitForSingleObject(hEvent, 10 sec)</span>
02159 <span class="comment"> *              If WAIT_TIMEOUT</span>
02160 <span class="comment"> *                TerminateProcess</span>
02161 <span class="comment"> *            |</span>
02162 <span class="comment"> *            V</span>
02163 <span class="comment"> *            TerminateThread(hThread)</span>
02164 <span class="comment"> *</span>
02165 <span class="comment"> *</span>
02166 <span class="comment"> * CONIME:WinMain</span>
02167 <span class="comment"> *          |</span>
02168 <span class="comment"> *          V</span>
02169 <span class="comment"> *          CreateWindow</span>
02170 <span class="comment"> *          RegisterConsoleIME</span>
02171 <span class="comment"> *            |</span>
02172 <span class="comment"> *            V</span>
02173 <span class="comment"> *            WINSRV:ConSrvRegisterConsoleIME</span>
02174 <span class="comment"> *                     |</span>
02175 <span class="comment"> *                     V</span>
02176 <span class="comment"> *                     QueueThreadMessage(CM_SET_CONSOLEIME_WINDOW)</span>
02177 <span class="comment"> *          |</span>
02178 <span class="comment"> *          V</span>
02179 <span class="comment"> *          AttachThreadInput</span>
02180 <span class="comment"> *          SetEvent(CONSOLEIME_EVENT)</span>
02181 <span class="comment"> *</span>
02182 <span class="comment"> *</span>
02183 <span class="comment"> * WINSRV:InputThread</span>
02184 <span class="comment"> *          |</span>
02185 <span class="comment"> *          V</span>
02186 <span class="comment"> *          GetMessage</span>
02187 <span class="comment"> *            Receive CM_CONIME_CREATE</span>
02188 <span class="comment"> *              |</span>
02189 <span class="comment"> *              V</span>
02190 <span class="comment"> *              ProcessCreateConsoleIME</span>
02191 <span class="comment"> *                If available hWndConsoleIME</span>
02192 <span class="comment"> *                  hIMC = SendMessage(console IME, CONIME_CREATE)</span>
02193 <span class="comment"> *                Else</span>
02194 <span class="comment"> *                  PostMessage(CM_CONIME_CREATE)</span>
02195 <span class="comment"> *          |</span>
02196 <span class="comment"> *          V</span>
02197 <span class="comment"> *          GetMessage</span>
02198 <span class="comment"> *            Receive CM_SET_CONSOLEIME_WINDOW</span>
02199 <span class="comment"> *              TlsGetValue()-&gt;hWndConsoleIME = wParam</span>
02200 <span class="comment"> *</span>
02201 <span class="comment"> *</span>
02202 <span class="comment"> * TerminateProcess of Console IME</span>
02203 <span class="comment"> *   WINSRV:ConsoleClientDisconnectRoutine</span>
02204 <span class="comment"> *            |</span>
02205 <span class="comment"> *            V</span>
02206 <span class="comment"> *            RemoveConsoleIME</span>
02207 <span class="comment"> */</span>
02208 
02209 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02210 ProcessCreateConsoleIME(
02211     IN LPMSG lpMsg,
02212     DWORD dwConsoleThreadId
02213     )
02214 {
02215     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02216     HANDLE ConsoleHandle = (HANDLE)lpMsg-&gt;wParam;
02217     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> pConsole;
02218     HWND hwndConIme;
02219 
02220     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(ConsoleHandle, &amp;pConsole);
02221     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02222         <span class="keywordflow">return</span>;  <span class="comment">// STATUS_PROCESS_IS_TERMINATING</span>
02223     }
02224 
02225     hwndConIme = pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o75">InputThreadInfo</a>-&gt;hWndConsoleIME;
02226 
02227     <span class="keywordflow">if</span> (pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o75">InputThreadInfo</a>-&gt;hWndConsoleIME != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02228         LRESULT lResult;
02229 
02230         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePumpWorker(pConsole,
02231                                   CONIME_CREATE,
02232                                   (WPARAM)pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a>,
02233                                   (LPARAM)pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>,
02234                                   &amp;lResult
02235                                  ))) {
02236             <span class="keywordflow">goto</span> TerminateConsoleIme;
02237         }
02238 
02239         <span class="keywordflow">if</span> (lResult)
02240         {
02241             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"ConsoleIME connected(Create)\n"</span>)) ;
02242 
02243             <span class="keywordflow">if</span> (!CONSOLE_IS_DBCS_CP(pConsole))
02244                 pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.ImeMode.Disable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02245 
02246             CreateConvAreaModeSystem(pConsole);
02247 
02248             <span class="keywordflow">if</span> ((pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) ||
02249                 (pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE))
02250             {
02251                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(pConsole,
02252                                       CONIME_SETFOCUS,
02253                                       (WPARAM)pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a>,
02254                                       (LPARAM)pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o9">hklActive</a>
02255                                      ))) {
02256                     <span class="keywordflow">goto</span> TerminateConsoleIme;
02257                 }
02258             }
02259 
02260             <span class="keywordflow">if</span> (pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>)
02261             {
02262                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(pConsole,
02263                                       CONIME_NOTIFY_SCREENBUFFERSIZE,
02264                                       (WPARAM)pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a>,
02265                                       (LPARAM)MAKELPARAM(pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X,
02266                                                          pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y)
02267                                      ))) {
02268                     <span class="keywordflow">goto</span> TerminateConsoleIme;
02269                 }
02270             }
02271             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(pConsole,
02272                                   CONIME_NOTIFY_CODEPAGE,
02273                                   (WPARAM)pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a>,
02274                                   (LPARAM)MAKELPARAM(FALSE, pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>)
02275                                  ))) {
02276                 <span class="keywordflow">goto</span> TerminateConsoleIme;
02277             }
02278             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(pConsole,
02279                                   CONIME_NOTIFY_CODEPAGE,
02280                                   (WPARAM)pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a>,
02281                                   (LPARAM)MAKELPARAM(TRUE, pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o62">OutputCP</a>)
02282                                  ))) {
02283                 <span class="keywordflow">goto</span> TerminateConsoleIme;
02284             }
02285 
02286             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(GetImeKeyState(pConsole, NULL))) {
02287                 <span class="keywordflow">goto</span> TerminateConsoleIme;
02288             }
02289         }
02290     }
02291     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lpMsg-&gt;lParam) {
02292         <span class="comment">/*</span>
02293 <span class="comment">         * This case, First = TRUE</span>
02294 <span class="comment">         * Again post message of CM_CONIME_CREATE.</span>
02295 <span class="comment">         * Becase hWndConsoleIME available when CM_SET_CONSOLEIME_WINDOW message</span>
02296 <span class="comment">         * and it message will be run after this.</span>
02297 <span class="comment">         */</span>
02298         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a39">QueueThreadMessage</a>(dwConsoleThreadId,
02299                                     CM_CONIME_CREATE,
02300                                     (WPARAM)ConsoleHandle,
02301                                     (LPARAM)FALSE
02302                                     );
02303 
02304         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02305                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"QueueThreadMessage(CM_CONIME_CREATE) failed (%08x)\n"</span>, Status);
02306         }
02307     }
02308     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(pConsole);
02309 
02310     <span class="keywordflow">return</span>;
02311 
02312 TerminateConsoleIme:
02313     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwndConIme)) {
02314         <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(hwndConIme, CONIME_DESTROY, (WPARAM)ConsoleHandle, (LPARAM)NULL);
02315     }
02316 }
02317 
02318 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02319 InitConsoleIMEStuff(
02320     HDESK hDesktop,
02321     DWORD dwConsoleThreadId,
02322     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
02323     )
02324 {
02325     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02326     CONSOLE_REGISTER_CONSOLEIME RegConIMEInfo;
02327     HANDLE hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02328     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> First = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02329 
02330     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a26">gfLoadConIme</a>) {
02331         KdPrint((<span class="stringliteral">"CONSRV: InitConsoleIMEStuff is skipping conime loading\n"</span>));
02332         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL; <span class="comment">// the return value does not really matter...</span>
02333     }
02334 
02335     RtlEnterCriticalSection(&amp;ConIMEInitWindowsLock);
02336 
02337     RegConIMEInfo.hdesk      = hDesktop;
02338     RegConIMEInfo.dwThreadId = 0;
02339     RegConIMEInfo.dwAction   = REGCONIME_QUERY;
02340     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleRegisterConsoleIME, &amp;RegConIMEInfo, <span class="keyword">sizeof</span>(RegConIMEInfo));
02341     <span class="keywordflow">if</span> (RegConIMEInfo.dwThreadId == 0)
02342     {
02343         <span class="comment">/*</span>
02344 <span class="comment">         * Create a Remote Thread on client side.</span>
02345 <span class="comment">         * This remote thread do create a console IME process.</span>
02346 <span class="comment">         */</span>
02347         hThread = <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a19">InternalCreateCallbackThread</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
02348                                                (ULONG_PTR)ConsoleIMERoutine,
02349                                                (ULONG_PTR)0);
02350         <span class="keywordflow">if</span> (hThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02351             KdPrint((<span class="stringliteral">"CONSRV: CreateRemoteThread failed %x\n"</span>,GetLastError()));
02352         }
02353         <span class="keywordflow">else</span>
02354         {
02355             <span class="comment">/*</span>
02356 <span class="comment">             * CM_WAIT_CONIME_PROCESS</span>
02357 <span class="comment">             * This message wait for ready to go console IME process.</span>
02358 <span class="comment">             */</span>
02359             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a39">QueueThreadMessage</a>(dwConsoleThreadId,
02360                                         CM_WAIT_CONIME_PROCESS,
02361                                         (WPARAM)hDesktop,
02362                                         (LPARAM)hThread
02363                                         );
02364             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02365                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"QueueThreadMessage(CM_WAIT_CONIME_PROCESS) failed (%08x)\n"</span>, Status);
02366             } <span class="keywordflow">else</span> {
02367                 First = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02368             }
02369         }
02370     }
02371 
02372     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a39">QueueThreadMessage</a>(dwConsoleThreadId,
02373                                 CM_CONIME_CREATE,
02374                                 (WPARAM)Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a>,
02375                                 (LPARAM)First
02376                                 );
02377     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02378         RIPMSG1(RIP_WARNING, <span class="stringliteral">"InitConsoleIMEStuff: QueueThreadMessage(CM_CONIME_CREATE) failed (%08x)\n"</span>, Status);
02379     }
02380 
02381     RtlLeaveCriticalSection(&amp;ConIMEInitWindowsLock);
02382 
02383     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02384 }
02385 
02386 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02387 WaitConsoleIMEStuff(
02388     HDESK hDesktop,
02389     HANDLE hThread
02390     )
02391 {
02392     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02393     CONSOLE_REGISTER_CONSOLEIME RegConIMEInfo;
02394 
02395     RtlEnterCriticalSection(&amp;ConIMEInitWindowsLock);
02396 
02397     RegConIMEInfo.hdesk      = hDesktop;
02398     RegConIMEInfo.dwThreadId = 0;
02399     RegConIMEInfo.dwAction   = REGCONIME_QUERY;
02400     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleRegisterConsoleIME, &amp;RegConIMEInfo, <span class="keyword">sizeof</span>(RegConIMEInfo));
02401 
02402     RtlLeaveCriticalSection(&amp;ConIMEInitWindowsLock);
02403 
02404     <span class="keywordflow">if</span> (RegConIMEInfo.dwThreadId == 0)
02405     {
02406         <span class="keywordtype">int</span> cLoops;
02407         LARGE_INTEGER li;
02408 
02409         <span class="comment">/*</span>
02410 <span class="comment">         * Do wait for ready to go console IME process.</span>
02411 <span class="comment">         *</span>
02412 <span class="comment">         * This wait code should after the CreateWindowsWindow</span>
02413 <span class="comment">         * because doesn't finish DLL attach on client side</span>
02414 <span class="comment">         * for wait a Console-&gt;InitEvents.</span>
02415 <span class="comment">         */</span>
02416         cLoops = 80;
02417         li.QuadPart = (LONGLONG)-10000 * 250;
02418         <span class="keywordflow">while</span> (cLoops--)
02419         {
02420             <span class="comment">/*</span>
02421 <span class="comment">             * Sleep for a second.</span>
02422 <span class="comment">             */</span>
02423             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(hThread, FALSE, &amp;li);
02424             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_TIMEOUT) {
02425                 <span class="keywordflow">break</span>;
02426             }
02427 
02428             RtlEnterCriticalSection(&amp;ConIMEInitWindowsLock);
02429             RegConIMEInfo.hdesk      = hDesktop;
02430             RegConIMEInfo.dwThreadId = 0;
02431             RegConIMEInfo.dwAction   = REGCONIME_QUERY;
02432             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleRegisterConsoleIME, &amp;RegConIMEInfo, <span class="keyword">sizeof</span>(RegConIMEInfo));
02433             RtlLeaveCriticalSection(&amp;ConIMEInitWindowsLock);
02434             <span class="keywordflow">if</span> (RegConIMEInfo.dwThreadId != 0) {
02435                 <span class="keywordflow">break</span>;
02436             }
02437         }
02438     }
02439 
02440     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hThread);
02441 
02442     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02443 }
02444 
02445 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02446 ConSrvRegisterConsoleIME(
02447     PCSR_PROCESS Process,
02448     HDESK hDesktop,
02449     HWINSTA hWinSta,
02450     HWND  hWndConsoleIME,
02451     DWORD dwConsoleIMEThreadId,
02452     DWORD dwAction,
02453     DWORD *dwConsoleThreadId
02454     )
02455 {
02456     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02457     CONSOLE_REGISTER_CONSOLEIME RegConIMEInfo;
02458     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
02459 
02460     RtlEnterCriticalSection(&amp;ConIMEInitWindowsLock);
02461 
02462     ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a82">CONSOLE_FROMPROCESSPERPROCESSDATA</a>(Process);
02463 
02464     RegConIMEInfo.hdesk      = hDesktop;
02465     RegConIMEInfo.dwThreadId = 0;
02466     RegConIMEInfo.dwAction   = REGCONIME_QUERY;
02467     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleRegisterConsoleIME, &amp;RegConIMEInfo, <span class="keyword">sizeof</span>(RegConIMEInfo));
02468     <span class="keywordflow">if</span> (RegConIMEInfo.dwConsoleInputThreadId == 0)
02469     {
02470         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
02471         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
02472     }
02473 
02474     <span class="keywordflow">if</span> (RegConIMEInfo.dwThreadId == 0)
02475     {
02476         <span class="comment">/*</span>
02477 <span class="comment">         * never registered console ime thread.</span>
02478 <span class="comment">         */</span>
02479         <span class="keywordflow">if</span> (dwAction == REGCONIME_REGISTER)
02480         {
02481             <span class="comment">/*</span>
02482 <span class="comment">             * register</span>
02483 <span class="comment">             */</span>
02484             RegConIMEInfo.hdesk      = hDesktop;
02485             RegConIMEInfo.dwThreadId = dwConsoleIMEThreadId;
02486             RegConIMEInfo.dwAction   = dwAction;
02487             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleRegisterConsoleIME, &amp;RegConIMEInfo, <span class="keyword">sizeof</span>(RegConIMEInfo));
02488             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02489                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a39">QueueThreadMessage</a>(RegConIMEInfo.dwConsoleInputThreadId,
02490                                             CM_SET_CONSOLEIME_WINDOW,
02491                                             (WPARAM)hWndConsoleIME,
02492                                             0
02493                                             );
02494                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02495                     RIPMSG1(RIP_WARNING, <span class="stringliteral">"ConSrvRegisterConsoleIME: QueueThreadMessage failed (%08x)\n"</span>, Status);
02496                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
02497                     <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
02498                 }
02499 
02500                 ProcessData-&gt;hDesk = hDesktop;
02501                 ProcessData-&gt;hWinSta = hWinSta;
02502 
02503                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a>)
02504                     *<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a> = RegConIMEInfo.dwConsoleInputThreadId;
02505             }
02506         }
02507         <span class="keywordflow">else</span>
02508         {
02509             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
02510             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
02511         }
02512     }
02513     <span class="keywordflow">else</span>
02514     {
02515         <span class="comment">/*</span>
02516 <span class="comment">         * do registered console ime thread.</span>
02517 <span class="comment">         */</span>
02518         <span class="keywordflow">if</span> ( (dwAction == REGCONIME_UNREGISTER) ||
02519              (dwAction == REGCONIME_TERMINATE)     )
02520         {
02521             <span class="comment">/*</span>
02522 <span class="comment">             * unregister</span>
02523 <span class="comment">             */</span>
02524             RegConIMEInfo.hdesk      = hDesktop;
02525             RegConIMEInfo.dwThreadId = dwConsoleIMEThreadId;
02526             RegConIMEInfo.dwAction   = dwAction;
02527             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleRegisterConsoleIME, &amp;RegConIMEInfo, <span class="keyword">sizeof</span>(RegConIMEInfo));
02528             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02529                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a39">QueueThreadMessage</a>(RegConIMEInfo.dwConsoleInputThreadId,
02530                                             CM_SET_CONSOLEIME_WINDOW,
02531                                             (WPARAM)NULL,
02532                                             0
02533                                             );
02534                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02535                     RIPMSG1(RIP_WARNING, <span class="stringliteral">"ConSrvRegisterConsoleIME: QueueThreadMessage failed (%08x)\n"</span>, Status);
02536                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
02537                     <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
02538                 }
02539 
02540                 CloseDesktop(ProcessData-&gt;hDesk);
02541                 <a class="code" href="../../d3/d0/user32_8def.html#a72">CloseWindowStation</a>(ProcessData-&gt;hWinSta);
02542 
02543                 ProcessData-&gt;hDesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02544                 ProcessData-&gt;hWinSta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02545 
02546                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a>)
02547                     *<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a> = RegConIMEInfo.dwConsoleInputThreadId;
02548             }
02549         }
02550         <span class="keywordflow">else</span>
02551         {
02552             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
02553             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
02554         }
02555     }
02556 
02557 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
02558     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
02559     {
02560         CloseDesktop(hDesktop);
02561         <a class="code" href="../../d3/d0/user32_8def.html#a72">CloseWindowStation</a>(hWinSta);
02562     }
02563 
02564     RtlLeaveCriticalSection(&amp;ConIMEInitWindowsLock);
02565 
02566     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02567 }
02568 
02569 
02570 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02571 RemoveConsoleIME(
02572     PCSR_PROCESS Process,
02573     DWORD dwConsoleIMEThreadId
02574     )
02575 {
02576     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02577     CONSOLE_REGISTER_CONSOLEIME RegConIMEInfo;
02578     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
02579 
02580     ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a82">CONSOLE_FROMPROCESSPERPROCESSDATA</a>(Process);
02581 
02582     <span class="comment">//</span>
02583     <span class="comment">// This is console IME process</span>
02584     <span class="comment">//</span>
02585     RtlEnterCriticalSection(&amp;ConIMEInitWindowsLock);
02586 
02587     RegConIMEInfo.hdesk      = ProcessData-&gt;hDesk;
02588     RegConIMEInfo.dwThreadId = 0;
02589     RegConIMEInfo.dwAction   = REGCONIME_QUERY;
02590     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleRegisterConsoleIME, &amp;RegConIMEInfo, <span class="keyword">sizeof</span>(RegConIMEInfo));
02591     <span class="keywordflow">if</span> (RegConIMEInfo.dwConsoleInputThreadId == 0)
02592     {
02593         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
02594     }
02595     <span class="keywordflow">else</span>
02596     <span class="keywordflow">if</span> (dwConsoleIMEThreadId == RegConIMEInfo.dwThreadId)
02597     {
02598         <span class="comment">/*</span>
02599 <span class="comment">         * Unregister console IME</span>
02600 <span class="comment">         */</span>
02601         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ConSrvRegisterConsoleIME(Process,
02602                                           ProcessData-&gt;hDesk,
02603                                           ProcessData-&gt;hWinSta,
02604                                           NULL,
02605                                           dwConsoleIMEThreadId,
02606                                           REGCONIME_TERMINATE,
02607                                           NULL
02608                                          );
02609     }
02610     RtlLeaveCriticalSection(&amp;ConIMEInitWindowsLock);
02611 
02612     <span class="keywordflow">return</span>;
02613 }
02614 
02615 
02616 <span class="comment">/*</span>
02617 <span class="comment"> * Console IME message pump.</span>
02618 <span class="comment"> *</span>
02619 <span class="comment"> * Note for NT5 --- this function is build on bogus assumptions</span>
02620 <span class="comment"> * (also has some nasty workaround for sloppy conime).</span>
02621 <span class="comment"> * There's a chance that pConsole goes away while sendmessage</span>
02622 <span class="comment"> * is processed by conime.</span>
02623 <span class="comment"> * Keep in mind, anybody who calls this function should validate</span>
02624 <span class="comment"> * the return status as appropriate.</span>
02625 <span class="comment"> */</span>
02626 
02627 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02628 ConsoleImeMessagePumpWorker(
02629     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
02630     UINT    Message,
02631     WPARAM  wParam,
02632     LPARAM  lParam,
02633     LRESULT* lplResult)
02634 {
02635     HWND    hWndConsoleIME = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o75">InputThreadInfo</a>-&gt;hWndConsoleIME;
02636     LRESULT fNoTimeout;
02637     <a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html">PINPUT_THREAD_INFO</a> InputThreadInfo;     <span class="comment">// console thread info</span>
02638 
02639     *lplResult = 0;
02640 
02641     <span class="keywordflow">if</span> (hWndConsoleIME == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02642     {
02643         <span class="keywordflow">return</span> STATUS_SUCCESS;
02644     }
02645 
02646     InputThreadInfo = TlsGetValue(InputThreadTlsIndex);
02647 
02648     <span class="keywordflow">if</span> (InputThreadInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02649     {
02650         HWND <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>;
02651 
02652         <span class="comment">/*</span>
02653 <span class="comment">         * This thread is in InputThread()</span>
02654 <span class="comment">         * We can try message pump.</span>
02655 <span class="comment">         */</span>
02656 
02657         fNoTimeout = <a class="code" href="../../d5/d9/cltxt_8h.html#a17">SendMessageTimeout</a>(hWndConsoleIME,
02658                                         Message,
02659                                         wParam,
02660                                         lParam,
02661                                         SMTO_ABORTIFHUNG | SMTO_NORMAL,
02662                                         CONIME_SENDMSG_TIMEOUT,
02663                                         lplResult);
02664         <span class="keywordflow">if</span> (fNoTimeout)
02665         {
02666             <span class="keywordflow">return</span> STATUS_SUCCESS;
02667         }
02668 
02669         <span class="keywordflow">if</span> ((Console = <a class="code" href="../../d8/d5/consrv_8h.html#a21">GetWindowConsole</a>(hWnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
02670                 (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a12">CONSOLE_TERMINATING</a>)) {
02671 
02672             <span class="comment">// This console is terminated.</span>
02673             <span class="comment">// ConsoleImeMessagePump gives up SendMessage to conime.</span>
02674 
02675             <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
02676         }
02677 
02678         <span class="comment">/*</span>
02679 <span class="comment">         * Timeout return from SendMessageTimeout</span>
02680 <span class="comment">         * Or, Hung hWndConsoleIME.</span>
02681 <span class="comment">         */</span>
02682     }
02683 
02684     <span class="comment">/*</span>
02685 <span class="comment">     * This thread is in CsrApiRequestThread()</span>
02686 <span class="comment">     * We can not try message pump.</span>
02687 <span class="comment">     */</span>
02688 
02689     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"ConsoleImeMessagePumpWorker::PostMessage(0x%x)\n"</span>,Message));
02690     <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(hWndConsoleIME,
02691                 Message,
02692                 wParam,
02693                 lParam);
02694 
02695     <span class="keywordflow">return</span> STATUS_SUCCESS;
02696 }
02697 
02698 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02699 ConsoleImeMessagePump(
02700     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
02701     UINT   Message,
02702     WPARAM wParam,
02703     LPARAM lParam
02704     )
02705 {
02706     LRESULT lResultDummy;
02707 
02708     <span class="keywordflow">return</span> ConsoleImeMessagePumpWorker(Console, Message, wParam, lParam, &amp;lResultDummy);
02709 }
02710 
02711 <span class="preprocessor">#endif // FE_IME</span>
02712 <span class="preprocessor"></span>
02713 
02714 
02715 
02716 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
02717 <a class="code" href="../../d0/d3/dbcs_8h.html#a52">RegisterKeisenOfTTFont</a>(
02718     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
02719     )
02720 {
02721     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02722     COORD FontSize;
02723     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> BuffSize;
02724     <a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html">LPSTRINGBITMAP</a> StringBitmap;
02725     WCHAR wChar;
02726     WCHAR wCharBuf[2];
02727     ULONG ulNumFonts;
02728     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwFonts;
02729     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console = ScreenInfo-&gt;Console;
02730 
02731     <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a29">GetNumFonts</a>(&amp;ulNumFonts);
02732     <span class="keywordflow">for</span> (dwFonts=0; dwFonts &lt; ulNumFonts; dwFonts++) {
02733         <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d6/font_8h.html#a2">TM_IS_TT_FONT</a>(FontInfo[dwFonts].Family) &amp;&amp;
02734             IS_ANY_DBCS_CHARSET(FontInfo[dwFonts].tmCharSet)
02735            ) {
02736             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a31">GetFontSize</a>(dwFonts, &amp;FontSize);
02737             BuffSize = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FontSize,BYTE_ALIGN);
02738             StringBitmap = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ), <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html">STRINGBITMAP</a>) + BuffSize);
02739             <span class="keywordflow">if</span> (StringBitmap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02740                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"RegisterKeisenOfTTFont: cannot allocate memory (%d bytes)"</span>,
02741                           <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html">STRINGBITMAP</a>) + BuffSize);
02742                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02743             }
02744 
02745             <span class="keywordflow">if</span> (SelectObject(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,FontInfo[dwFonts].hFont)==0) {
02746                 <span class="keywordflow">goto</span> error_return;
02747             }
02748 
02749             <span class="keywordflow">for</span> (wChar=0; wChar &lt; <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>; wChar++) {
02750                 wCharBuf[0] = wChar;
02751                 wCharBuf[1] = TEXT(<span class="charliteral">'\0'</span>);;
02752                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a28">GetStringBitmapW</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
02753                                      wCharBuf,
02754                                      1,
02755                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html">STRINGBITMAP</a>) + BuffSize,
02756                                      (BYTE*)StringBitmap
02757                                     ) == 0) {
02758                     <span class="keywordflow">goto</span> error_return;
02759                 }
02760                 FontSize.X = (WORD)StringBitmap-&gt;<a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html#o0">uiWidth</a>;
02761                 FontSize.Y = (WORD)StringBitmap-&gt;<a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html#o1">uiHeight</a>;
02762                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d7/eudc_8h.html#a5">RegisterLocalEUDC</a>(Console,wChar,FontSize,StringBitmap-&gt;<a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html#o2">ajBits</a>);
02763                 <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02764 error_return:
02765                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(StringBitmap);
02766                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02767                 }
02768             }
02769 
02770             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(StringBitmap);
02771         }
02772         ((<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">PEUDC_INFORMATION</a>)(Console-&gt;EudcInformation))-&gt;LocalKeisenEudcMode = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02773     }
02774     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02775 }
02776 
02777 ULONG
02778 <a class="code" href="../../d0/d3/dbcs_8h.html#a53">TranslateUnicodeToOem</a>(
02779     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
02780     IN PWCHAR UnicodeBuffer,
02781     IN ULONG UnicodeCharCount,
02782     OUT PCHAR AnsiBuffer,
02783     IN ULONG AnsiByteCount,
02784     OUT PINPUT_RECORD DbcsLeadInpRec
02785     )
02786 {
02787     ULONG i,j;
02788     PWCHAR TmpUni;
02789     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> AsciiDbcs[2];
02790     ULONG NumBytes;
02791 
02792     TmpUni = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),UnicodeCharCount*<span class="keyword">sizeof</span>(WCHAR));
02793     <span class="keywordflow">if</span> (TmpUni == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02794         <span class="keywordflow">return</span> 0;
02795 
02796     memcpy(TmpUni,UnicodeBuffer,UnicodeCharCount*<span class="keyword">sizeof</span>(WCHAR));
02797     AsciiDbcs[1] = 0;
02798     <span class="keywordflow">for</span> (i=0,j=0; i&lt;UnicodeCharCount; i++,j++) {
02799         <span class="keywordflow">if</span> (IsConsoleFullWidth(Console-&gt;hDC,Console-&gt;CP,TmpUni[i])) {
02800             NumBytes = <span class="keyword">sizeof</span>(AsciiDbcs);
02801             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(Console-&gt;CP,
02802                    &amp;TmpUni[i],
02803                    1,
02804                    &amp;AsciiDbcs[0],
02805                    NumBytes
02806                    );
02807             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a37">IsDBCSLeadByteConsole</a>(AsciiDbcs[0],&amp;Console-&gt;CPInfo)) {
02808                 <span class="keywordflow">if</span> (j &lt; AnsiByteCount-1) {  <span class="comment">// -1 is safe DBCS in buffer</span>
02809                     AnsiBuffer[j] = AsciiDbcs[0];
02810                     j++;
02811                     AnsiBuffer[j] = AsciiDbcs[1];
02812                     AsciiDbcs[1] = 0;
02813                 }
02814                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j == AnsiByteCount-1) {
02815                     AnsiBuffer[j] = AsciiDbcs[0];
02816                     j++;
02817                     <span class="keywordflow">break</span>;
02818                 }
02819                 <span class="keywordflow">else</span> {
02820                     AsciiDbcs[1] = 0;
02821                     <span class="keywordflow">break</span>;
02822                 }
02823             }
02824             <span class="keywordflow">else</span> {
02825                 AnsiBuffer[j] = AsciiDbcs[0];
02826                 AsciiDbcs[1] = 0;
02827             }
02828         }
02829         <span class="keywordflow">else</span> {
02830             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(Console-&gt;CP,
02831                    &amp;TmpUni[i],
02832                    1,
02833                    &amp;AnsiBuffer[j],
02834                    1
02835                    );
02836         }
02837     }
02838     <span class="keywordflow">if</span> (DbcsLeadInpRec) {
02839         <span class="keywordflow">if</span> (AsciiDbcs[1]) {
02840             DbcsLeadInpRec-&gt;EventType = KEY_EVENT;
02841             DbcsLeadInpRec-&gt;Event.KeyEvent.uChar.AsciiChar = AsciiDbcs[1];
02842         }
02843         <span class="keywordflow">else</span> {
02844             RtlZeroMemory(DbcsLeadInpRec,<span class="keyword">sizeof</span>(INPUT_RECORD));
02845         }
02846     }
02847     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TmpUni);
02848     <span class="keywordflow">return</span> j;
02849 }
02850 
02851 
02852 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
02853 <a class="code" href="../../d0/d3/dbcs_8h.html#a54">ImmConversionToConsole</a>(
02854     DWORD fdwConversion
02855     )
02856 {
02857     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwNlsMode;
02858 
02859     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_KANA) &amp; <a class="code" href="../../d4/d5/conimep_8h.html#a37">KEY_TOGGLED</a>) {
02860         fdwConversion = (fdwConversion &amp; ~IME_CMODE_LANGUAGE) | (IME_CMODE_NATIVE | IME_CMODE_KATAKANA);
02861     }
02862 
02863     dwNlsMode = 0;
02864     <span class="keywordflow">if</span> (fdwConversion &amp; IME_CMODE_NATIVE) {
02865         <span class="keywordflow">if</span> (fdwConversion &amp; IME_CMODE_KATAKANA)
02866             dwNlsMode |= NLS_KATAKANA;
02867         <span class="keywordflow">else</span>
02868             dwNlsMode |= NLS_HIRAGANA;
02869     }
02870     <span class="keywordflow">else</span> {
02871         dwNlsMode |= NLS_ALPHANUMERIC;
02872     }
02873 
02874     <span class="keywordflow">if</span> (fdwConversion &amp; IME_CMODE_FULLSHAPE)
02875         dwNlsMode |= NLS_DBCSCHAR;
02876 
02877     <span class="keywordflow">if</span> (fdwConversion &amp; IME_CMODE_ROMAN)
02878         dwNlsMode |= NLS_ROMAN;
02879 
02880     <span class="keywordflow">if</span> (fdwConversion &amp; <a class="code" href="../../d3/d5/conime_8h.html#a29">IME_CMODE_OPEN</a>)
02881         dwNlsMode |= NLS_IME_CONVERSION;
02882 
02883     <span class="keywordflow">if</span> (fdwConversion &amp; <a class="code" href="../../d3/d5/conime_8h.html#a30">IME_CMODE_DISABLE</a>)
02884         dwNlsMode |= NLS_IME_DISABLE;
02885 
02886     <span class="keywordflow">return</span> dwNlsMode;
02887 }
02888 
02889 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
02890 <a class="code" href="../../d0/d3/dbcs_8h.html#a55">ImmConversionFromConsole</a>(
02891     DWORD dwNlsMode
02892     )
02893 {
02894     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fdwConversion;
02895 
02896     fdwConversion = 0;
02897     <span class="keywordflow">if</span> (dwNlsMode &amp; (NLS_KATAKANA | NLS_HIRAGANA)) {
02898         fdwConversion |= IME_CMODE_NATIVE;
02899         <span class="keywordflow">if</span> (dwNlsMode &amp; NLS_KATAKANA)
02900             fdwConversion |= IME_CMODE_KATAKANA;
02901     }
02902 
02903     <span class="keywordflow">if</span> (dwNlsMode &amp; NLS_DBCSCHAR)
02904         fdwConversion |= IME_CMODE_FULLSHAPE;
02905 
02906     <span class="keywordflow">if</span> (dwNlsMode &amp; NLS_ROMAN)
02907         fdwConversion |= IME_CMODE_ROMAN;
02908 
02909     <span class="keywordflow">if</span> (dwNlsMode &amp; NLS_IME_CONVERSION)
02910         fdwConversion |= <a class="code" href="../../d3/d5/conime_8h.html#a29">IME_CMODE_OPEN</a>;
02911 
02912     <span class="keywordflow">if</span> (dwNlsMode &amp; NLS_IME_DISABLE)
02913         fdwConversion |= <a class="code" href="../../d3/d5/conime_8h.html#a30">IME_CMODE_DISABLE</a>;
02914 
02915     <span class="keywordflow">return</span> fdwConversion;
02916 }
02917 
02918 
02919 
02920 
02921 
02922 
02923 
02924 
02925 
02926 
02927 
02928 
02929 <span class="preprocessor">#if defined(DBG) &amp;&amp; defined(DBG_KATTR)</span>
02930 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02931 BeginKAttrCheck(
02932     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
02933     )
02934 {
02935     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
02936     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
02937     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
02938 
02939     RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow) % ScreenInfo-&gt;ScreenBufferSize.Y;
02940     Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
02941 
02942     <span class="keywordflow">for</span> (i=0;i&lt;ScreenInfo-&gt;ScreenBufferSize.Y;i++) {
02943         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs);
02944         <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;ScreenBufferSize.Y) {
02945             RowIndex = 0;
02946         }
02947     }
02948 }
02949 <span class="preprocessor">#endif // DBG &amp;&amp; DBG_KATTR</span>
02950 <span class="preprocessor"></span>
02951 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
