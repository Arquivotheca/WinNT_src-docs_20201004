<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pri_bld/pnpsubs.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpsubs.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>

<p>
<a href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a1">IopCreateMadeupNode</a> (IN PUNICODE_STRING ServiceKeyName, OUT PHANDLE <a class="el" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>, OUT PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, OUT PULONG InstanceNumber, IN BOOLEAN ResourceOwned)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a2">IopRemoveStringFromValueKey</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN PWSTR <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, IN PUNICODE_STRING <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a3">IopAppendStringToValueKey</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN PWSTR <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, IN PUNICODE_STRING <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>, IN BOOLEAN Create)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a> (OUT PUNICODE_STRING Destination, IN PUNICODE_STRING <a class="el" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>, IN PUNICODE_STRING <a class="el" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a5">IopPrepareDriverLoading</a> (IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN HANDLE KeyHandle, IN PIMAGE_NT_HEADERS <a class="el" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a> (IN HANDLE ServiceKeyHandle OPTIONAL, IN PUNICODE_STRING ServiceKeyName OPTIONAL, IN ULONG ServiceInstanceOrdinal, OUT PUNICODE_STRING DeviceInstanceRegistryPath OPTIONAL, OUT PHANDLE DeviceInstanceHandle OPTIONAL, IN ACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a7">IopOpenRegistryKeyPersist</a> (OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN HANDLE BaseHandle OPTIONAL, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN ACCESS_MASK DesiredAccess, IN BOOLEAN Create, OUT PULONG Disposition OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a> (IN PUNICODE_STRING ServiceKeyName, IN ACCESS_MASK DesiredAccess, OUT PHANDLE ServiceHandle OPTIONAL, OUT PHANDLE ServiceEnumHandle OPTIONAL, IN BOOLEAN CreateEnum)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a9">IopGetDeviceInstanceCsConfigFlags</a> (IN PUNICODE_STRING ServiceKeyName, IN ULONG Instance, OUT PULONG CsConfigFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a10">IopSetDeviceInstanceCsConfigFlags</a> (IN PUNICODE_STRING ServiceKeyName, IN ULONG Instance, IN ULONG CsConfigFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a11">IopOpenCurrentHwProfileDeviceInstanceKey</a> (OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN PUNICODE_STRING ServiceKeyName, IN ULONG Instance, IN ACCESS_MASK DesiredAccess, IN BOOLEAN Create)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a12">IopApplyFunctionToSubKeys</a> (IN HANDLE BaseHandle OPTIONAL, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a> OPTIONAL, IN ACCESS_MASK DesiredAccess, IN BOOLEAN IgnoreNonCriticalErrors, IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a121">PIOP_SUBKEY_CALLBACK_ROUTINE</a> SubKeyCallbackRoutine, IN OUT PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a13">IopRegMultiSzToUnicodeStrings</a> (IN PKEY_VALUE_FULL_INFORMATION KeyValueInformation, OUT PUNICODE_STRING *UnicodeStringList, OUT PULONG UnicodeStringCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a14">IopApplyFunctionToServiceInstances</a> (IN HANDLE ServiceKeyHandle OPTIONAL, IN PUNICODE_STRING ServiceKeyName OPTIONAL, IN ACCESS_MASK DesiredAccess, IN BOOLEAN IgnoreNonCriticalErrors, IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a121">PIOP_SUBKEY_CALLBACK_ROUTINE</a> DevInstCallbackRoutine, IN OUT PVOID Context, OUT PULONG ServiceInstanceOrdinal OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a15">IopMarkDuplicateDevice</a> (IN PUNICODE_STRING TargetKeyName, IN ULONG TargetInstance, IN PUNICODE_STRING SourceKeyName, IN ULONG SourceInstance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a16">IopIsDuplicatedDevices</a> (IN PCM_RESOURCE_LIST Configuration1, IN PCM_RESOURCE_LIST Configuration2, IN <a class="el" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo1 OPTIONAL, IN <a class="el" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo2 OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a> (IN PUNICODE_STRING UnicodeStringList, IN ULONG StringCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a18">IopDriverLoadingFailed</a> (IN HANDLE ServiceHandle OPTIONAL, IN PUNICODE_STRING ServiceName OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a19">IopIsAnyDeviceInstanceEnabled</a> (IN PUNICODE_STRING ServiceKeyName, IN HANDLE ServiceHandle OPTIONAL, IN BOOLEAN LegacyIncluded)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a20">IopIsDeviceInstanceEnabled</a> (IN HANDLE DeviceInstanceHandle, IN PUNICODE_STRING DeviceInstance, IN BOOLEAN DisableIfEnabled)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a> (IN PCM_RESOURCE_LIST ResourceList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a22">IopReferenceDriverObjectByName</a> (IN PUNICODE_STRING DriverName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a> (IN HANDLE DeviceInstanceHandle OPTIONAL, IN PUNICODE_STRING DeviceInstance OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PHANDLE DeviceInstanceHandle, IN ACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a25">IopCleanupDeviceRegistryValues</a> (IN PUNICODE_STRING InstancePath, IN BOOLEAN KeepReference)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN ULONG ResourceType, IN ULONG Preference, OUT PVOID *<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, OUT PULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN ULONG Flags, OUT PCM_RESOURCE_LIST *CmResource, OUT PULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (IN ULONG SlotNumber, IN PCM_RESOURCE_LIST CmResourceList, IN ULONG Priority)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a29">IopFilterResourceRequirementsList</a> (IN PIO_RESOURCE_REQUIREMENTS_LIST IoList, IN PCM_RESOURCE_LIST CmList, IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *FilteredList, OUT PBOOLEAN ExactMatch)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a30">IopMergeFilteredResourceRequirementsList</a> (IN PIO_RESOURCE_REQUIREMENTS_LIST IoList1, IN PIO_RESOURCE_REQUIREMENTS_LIST IoList2, IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *MergedList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a31">IopMergeCmResourceLists</a> (IN PCM_RESOURCE_LIST List1, IN PCM_RESOURCE_LIST List2, IN OUT PCM_RESOURCE_LIST *MergedList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a32">IopIsLegacyDriver</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a33">IopGetGroupOrderIndex</a> (IN HANDLE ServiceHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a34">IopDeleteLegacyKey</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a35">IopDeviceCapabilitiesToRegistry</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a36">IopRestartDeviceNode</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="pri_bld/pnpsubs.c::IopAppendStringToValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAppendStringToValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>String</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Create</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00546">546</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d5/consubs_8c-source.html#l00023">Create()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
<pre class="fragment"><div>00555                    :
00556 
00557     This routine appends a string to a value entry specified by <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>
00558     under an already opened registry handle.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not present
00559     and <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, a <span class="keyword">new</span> value entry will be created <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name
00560     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>.
00561 
00562 Parameters:
00563 
00564     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to a registry key whose value entry will
00565         be modified.
00566 
00567     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> - Supplies a pointer to a string to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.
00568 
00569     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> - Supplies a unicode string to append to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.
00570 
00571     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> - Supplies a BOOLEAN variable to indicate <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>
00572         value entry should be created <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not present.
00573 
00574 Return Value:
00575 
00576     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
00577 
00578 --*/
00579 
00580 {
00581     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00582     PWSTR destinationString, p;
00583     UNICODE_STRING unicodeValueName;
00584     ULONG size;
00585     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00586 
00587     <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> || (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length &lt; <span class="keyword">sizeof</span>(WCHAR)) ) {
00588         <span class="keywordflow">return</span> STATUS_SUCCESS;
00589     }
00590 
00591     <span class="comment">//</span>
00592     <span class="comment">// Read registry value entry data</span>
00593     <span class="comment">//</span>
00594 
00595     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(Handle, ValueName, &amp;keyValueInformation);
00596 
00597     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00598         <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND &amp;&amp; <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
00599 
00600             <span class="comment">//</span>
00601             <span class="comment">// if no valid entry exists and user said ok to create one</span>
00602             <span class="comment">//</span>
00603 
00604             keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00605         } <span class="keywordflow">else</span> {
00606             <span class="keywordflow">return</span> status;
00607         }
00608     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(keyValueInformation-&gt;Type != REG_MULTI_SZ) {
00609 
00610         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00611 
00612         <span class="keywordflow">if</span>(<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
00613             keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00614         } <span class="keywordflow">else</span> {
00615             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
00616         }
00617 
00618     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(keyValueInformation-&gt;DataLength &lt; <span class="keyword">sizeof</span>(WCHAR) ||
00619               *(PWCHAR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation) == UNICODE_NULL) {  <span class="comment">// empty or one NULL WCHAR</span>
00620 
00621         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00622         keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00623     }
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">// Allocate a buffer to hold new data for the specified key value entry</span>
00627     <span class="comment">// Make sure the buffer is at least an empty MULTI_SZ big.</span>
00628     <span class="comment">//</span>
00629 
00630     <span class="keywordflow">if</span> (keyValueInformation) {
00631         size = keyValueInformation-&gt;DataLength + <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length + <span class="keyword">sizeof</span> (UNICODE_NULL);
00632     } <span class="keywordflow">else</span> {
00633         size =  <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length + 2 * <span class="keyword">sizeof</span>(UNICODE_NULL);
00634     }
00635 
00636     destinationString = p = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, size);
00637     <span class="keywordflow">if</span> (destinationString == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00638         <span class="keywordflow">if</span> (keyValueInformation) {
00639             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00640         }
00641         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00642     }
00643 
00644     <span class="comment">//</span>
00645     <span class="comment">// Copy the existing data to our newly allocated buffer, if any</span>
00646     <span class="comment">//</span>
00647 
00648     <span class="keywordflow">if</span> (keyValueInformation) {
00649 
00650         <span class="comment">//</span>
00651         <span class="comment">// Note we  need to remove a UNICODE_NULL because the</span>
00652         <span class="comment">// MULTI_SZ has two terminating UNICODE_NULL.</span>
00653         <span class="comment">//</span>
00654 
00655         RtlMoveMemory(p,
00656                       <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00657                       keyValueInformation-&gt;DataLength - <span class="keyword">sizeof</span>(WCHAR)
00658                       );
00659         p += keyValueInformation-&gt;DataLength / <span class="keyword">sizeof</span>(WCHAR) - 1;
00660 
00661         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00662     }
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">// Append the user specified unicode string to our buffer</span>
00666     <span class="comment">//</span>
00667     RtlMoveMemory(p,
00668                   <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer,
00669                   <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length
00670                   );
00671     p += <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
00672     *p = UNICODE_NULL;
00673     p++;
00674     *p = UNICODE_NULL;
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">// Finally write the data to the specified registy value entry</span>
00678     <span class="comment">//</span>
00679 
00680     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeValueName, ValueName);
00681     status = ZwSetValueKey(
00682                 Handle,
00683                 &amp;unicodeValueName,
00684                 TITLE_INDEX_VALUE,
00685                 REG_MULTI_SZ,
00686                 destinationString,
00687                 size
00688                 );
00689 
00690     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(destinationString);
00691     <span class="keywordflow">return</span> status;
00692 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="pri_bld/pnpsubs.c::IopApplyFunctionToServiceInstances" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopApplyFunctionToServiceInstances           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE ServiceKeyHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING ServiceKeyName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreNonCriticalErrors</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a121">PIOP_SUBKEY_CALLBACK_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DevInstCallbackRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ServiceInstanceOrdinal&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02036">2036</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00899">PNP_SCRATCH_BUFFER_SIZE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00117">IopAddDevicesToBootDriver()</a>, and <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01411">IopGetDriverDeviceList()</a>.
<p>
<pre class="fragment"><div>02048                    :
02049 
02050     This routine enumerates all device instances referenced by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance
02051     ordinal entries under a service's <span class="keyword">volatile</span> Enum key, and calls
02052     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified callback routine <span class="keywordflow">for</span> each instance's corresponding subkey
02053     under HKLM\System\Enum.
02054 
02055 Arguments:
02056 
02057     ServiceKeyHandle - Optional handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service entry. If <span class="keyword">this</span> parameter
02058         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service key name must be given in
02059         ServiceKeyName (<span class="keywordflow">if</span> both parameters are specified, then ServiceKeyHandle
02060         is used, and ServiceKeyName is ignored).
02061 
02062     ServiceKeyName - Optional name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service entry key (under
02063         HKLM\CurrentControlSet\Services). If <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified,
02064         then ServiceKeyHandle must contain a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired service key.
02065 
02066     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine
02067         needs to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumerated device instance keys.  If no desired access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02068         specified (i.e., DesiredAccess is zero), then no handle will be opened
02069         <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance keys, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback will be passed a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">for</span>
02070         its DeviceInstanceHandle parameter.
02071 
02072     IgnoreNonCriticalErrors - Specifies whether <span class="keyword">this</span> function should
02073         immediately terminate on all errors, or <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> on critical ones.
02074         An example of a non-critical error <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> when an enumerated device instance
02075         key cannot be opened <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access.
02076 
02077     DevInstCallbackRoutine - Supplies a pointer to a function that will
02078         be called <span class="keywordflow">for</span> each device instance key referenced by a service instance
02079         entry under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service's <span class="keyword">volatile</span> Enum subkey. The prototype of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02080         function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> as follows:
02081 
02082             <span class="keyword">typedef</span> BOOLEAN (*PIOP_SUBKEY_CALLBACK_ROUTINE) (
02083                 IN     HANDLE DeviceInstanceHandle,
02084                 IN     PUNICODE_STRING DeviceInstancePath,
02085                 IN OUT PVOID Context
02086                 );
02087 
02088         where DeviceInstanceHandle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to an enumerated device instance
02089         key, DeviceInstancePath <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> (relative to
02090         HKLM\System\Enum) to <span class="keyword">this</span> device instance, and Context <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to
02091         user-defined data.
02092 
02093         This function should <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to <span class="keywordflow">continue</span> enumeration, or
02094         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to terminate <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
02095 
02096     Context - Supplies a pointer to user-defined data that will be passed
02097         in to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine at each device instance key invocation.
02098 
02099     ServiceInstanceOrdinal - Optionally, receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service instance ordinal (1 based)
02100         that terminated the enumeration, or the total number of instances enumerated
02101         if the enumeration completed without being aborted.
02102 
02103 Return Value:
02104 
02105     NT status code indicating whether the device instance keys were successfully
02106     enumerated.  Note that this does not provide information on the success or
02107     failure of the callback routine--if desired, this information should be
02108     stored in the Context structure.
02109 
02110 --*/
02111 
02112 {
02113     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02114     HANDLE ServiceEnumHandle, SystemEnumHandle, DeviceInstanceHandle;
02115     UNICODE_STRING TempUnicodeString;
02116     ULONG ServiceInstanceCount, i, junk;
02117     PKEY_VALUE_FULL_INFORMATION KeyValueInformation;
02118     WCHAR ValueNameString[20];
02119     BOOLEAN ContinueEnumeration;
02120 
02121     <span class="comment">//</span>
02122     <span class="comment">// First, open up the volatile Enum subkey under the specified service entry.</span>
02123     <span class="comment">//</span>
02124 
02125     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ServiceKeyHandle)) {
02126         PiWstrToUnicodeString(&amp;TempUnicodeString, REGSTR_KEY_ENUM);
02127         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;ServiceEnumHandle,
02128                                     ServiceKeyHandle,
02129                                     &amp;TempUnicodeString,
02130                                     KEY_READ,
02131                                     FALSE
02132                                    );
02133     } <span class="keywordflow">else</span> {
02134         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
02135                                         KEY_READ,
02136                                         NULL,
02137                                         &amp;ServiceEnumHandle,
02138                                         FALSE
02139                                        );
02140     }
02141     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02142         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02143     }
02144 
02145     <span class="comment">//</span>
02146     <span class="comment">// Find out how many instances are referenced in the service's Enum key.</span>
02147     <span class="comment">//</span>
02148 
02149     ServiceInstanceCount = 0;   <span class="comment">// assume none.</span>
02150 
02151     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(ServiceEnumHandle,
02152                                  REGSTR_VALUE_COUNT,
02153                                  &amp;KeyValueInformation
02154                                 );
02155     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02156 
02157         <span class="keywordflow">if</span>((KeyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
02158            (KeyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
02159 
02160             ServiceInstanceCount = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation);
02161 
02162         }
02163         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueInformation);
02164 
02165     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_OBJECT_NAME_NOT_FOUND) {
02166         <span class="keywordflow">goto</span> PrepareForReturn;
02167     } <span class="keywordflow">else</span> {
02168         <span class="comment">//</span>
02169         <span class="comment">// If 'Count' value entry not found, consider this to mean there are simply</span>
02170         <span class="comment">// no device instance controlled by this service.</span>
02171         <span class="comment">//</span>
02172         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02173     }
02174 
02175     <span class="comment">//</span>
02176     <span class="comment">// Now, enumerate each service instance, and call the specified callback function</span>
02177     <span class="comment">// for the corresponding device instance.</span>
02178     <span class="comment">//</span>
02179 
02180     <span class="keywordflow">if</span> (ServiceInstanceCount) {
02181 
02182         <span class="keywordflow">if</span> (DesiredAccess) {
02183             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;SystemEnumHandle,
02184                                         NULL,
02185                                         &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
02186                                         KEY_READ,
02187                                         FALSE
02188                                        );
02189             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02190                 <span class="keywordflow">goto</span> PrepareForReturn;
02191             }
02192         } <span class="keywordflow">else</span> {
02193             <span class="comment">//</span>
02194             <span class="comment">// Set DeviceInstanceHandle to NULL, since we won't be opening up the</span>
02195             <span class="comment">// device instance keys.</span>
02196             <span class="comment">//</span>
02197             DeviceInstanceHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02198         }
02199         KeyValueInformation = (PKEY_VALUE_FULL_INFORMATION)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
02200                                                               PagedPool,
02201                                                               PNP_SCRATCH_BUFFER_SIZE);
02202         <span class="keywordflow">if</span> (!KeyValueInformation) {
02203             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
02204             <span class="keywordflow">goto</span> PrepareForReturn;
02205         }
02206         i = 0;
02207         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02208             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateValueKey (           <span class="comment">// i was initialized to zero above.</span>
02209                             ServiceEnumHandle,
02210                             i++,
02211                             KeyValueFullInformation,
02212                             KeyValueInformation,
02213                             PNP_SCRATCH_BUFFER_SIZE,
02214                             &amp;junk
02215                             );
02216 
02217             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
02218                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
02219                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02220                     <span class="keywordflow">break</span>;
02221                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(IgnoreNonCriticalErrors) {
02222                     <span class="keywordflow">continue</span>;
02223                 } <span class="keywordflow">else</span> {
02224                     <span class="keywordflow">break</span>;
02225                 }
02226             }
02227 
02228             <span class="keywordflow">if</span> (KeyValueInformation-&gt;Type != REG_SZ) {
02229                 <span class="keywordflow">continue</span>;
02230             }
02231 
02232             ContinueEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02233             TempUnicodeString.Length = 0;
02234             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;TempUnicodeString,
02235                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation),
02236                                            KeyValueInformation-&gt;DataLength
02237                                            );
02238             <span class="keywordflow">if</span> (TempUnicodeString.Length) {
02239 
02240                 <span class="comment">//</span>
02241                 <span class="comment">// We have retrieved a (non-empty) string for this service instance.</span>
02242                 <span class="comment">// If the user specified a non-zero value for the DesiredAccess</span>
02243                 <span class="comment">// parameter, we will attempt to open up the corresponding device</span>
02244                 <span class="comment">// instance key under HKLM\System\Enum.</span>
02245                 <span class="comment">//</span>
02246                 <span class="keywordflow">if</span> (DesiredAccess) {
02247                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;DeviceInstanceHandle,
02248                                                 SystemEnumHandle,
02249                                                 &amp;TempUnicodeString,
02250                                                 DesiredAccess,
02251                                                 FALSE
02252                                                 );
02253                 }
02254 
02255                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02256                     <span class="comment">//</span>
02257                     <span class="comment">// Invoke the specified callback routine for this device instance.</span>
02258                     <span class="comment">//</span>
02259                     ContinueEnumeration = DevInstCallbackRoutine(DeviceInstanceHandle,
02260                                                                  &amp;TempUnicodeString,
02261                                                                  Context
02262                                                                 );
02263                     <span class="keywordflow">if</span> (DesiredAccess) {
02264                         ZwClose(DeviceInstanceHandle);
02265                     }
02266                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IgnoreNonCriticalErrors) {
02267                     <span class="keywordflow">continue</span>;
02268                 } <span class="keywordflow">else</span> {
02269                     <span class="keywordflow">break</span>;
02270                 }
02271             } <span class="keywordflow">else</span> {
02272                 <span class="keywordflow">continue</span>;
02273             }
02274             <span class="keywordflow">if</span> (!ContinueEnumeration) {
02275                 <span class="keywordflow">break</span>;
02276             }
02277         }
02278 
02279         <span class="keywordflow">if</span>(DesiredAccess) {
02280             ZwClose(SystemEnumHandle);
02281         }
02282         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueInformation);
02283     }
02284 
02285     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ServiceInstanceOrdinal)) {
02286         *ServiceInstanceOrdinal = i;
02287     }
02288 
02289 PrepareForReturn:
02290 
02291     ZwClose(ServiceEnumHandle);
02292 
02293     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02294 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="pri_bld/pnpsubs.c::IopApplyFunctionToSubKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopApplyFunctionToSubKeys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE BaseHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreNonCriticalErrors</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a121">PIOP_SUBKEY_CALLBACK_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SubKeyCallbackRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01690">1690</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05846">IopDeleteKeyRecursiveCallback()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00680">IopGetRootDevices()</a>, and <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00819">IopInitializeDeviceKey()</a>.
<p>
<pre class="fragment"><div>01701                    :
01702 
01703     This routine enumerates all subkeys under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified key, and calls
01704     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified callback routine <span class="keywordflow">for</span> each subkey.
01705 
01706 Arguments:
01707 
01708     BaseHandle - Optional handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>. If <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> also
01709         specified, then <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> represents a subkey under <span class="keyword">this</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.  If <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>
01710         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkeys are enumerated under <span class="keyword">this</span> handle.  If <span class="keyword">this</span>
01711         parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base key must be
01712         given in <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.
01713 
01714     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - Optional name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key whose subkeys are to be enumerated.
01715 
01716     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine
01717         needs to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkeys.  If no desired access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified (i.e.,
01718         DesiredAccess is zero), then no handle will be opened <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01719         subkeys, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback will be passed a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">for</span> its SubKeyHandle
01720         parameter.
01721 
01722     IgnoreNonCriticalErrors - Specifies whether <span class="keyword">this</span> function should
01723         immediately terminate on all errors, or <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> on critical ones.
01724         An example of a non-critical error <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> when an enumerated subkey
01725         cannot be opened <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access.
01726 
01727     SubKeyCallbackRoutine - Supplies a pointer to a function that will
01728         be called <span class="keywordflow">for</span> each subkey found under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01729         specified key.  The prototype of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function
01730         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> as follows:
01731 
01732             <span class="keyword">typedef</span> BOOLEAN (*PIOP_SUBKEY_CALLBACK_ROUTINE) (
01733                 IN     HANDLE SubKeyHandle,
01734                 IN     PUNICODE_STRING SubKeyName,
01735                 IN OUT PVOID Context
01736                 );
01737 
01738         where SubKeyHandle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to an enumerated subkey under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01739         specified key, SubKeyName <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> its name, and Context <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to
01740         user-defined data.
01741 
01742         This function should <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to <span class="keywordflow">continue</span> enumeration, or
01743         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to terminate <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01744 
01745     Context - Supplies a pointer to user-defined data that will be passed
01746         in to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine at each subkey invocation.
01747 
01748 Return Value:
01749 
01750     NT status code indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkeys were successfully
01751     enumerated.  Note that <span class="keyword">this</span> does not provide information on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01752     success or <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine--<span class="keywordflow">if</span> desired, <span class="keyword">this</span>
01753     information should be stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Context structure.
01754 
01755 --*/
01756 
01757 {
01758     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01759     BOOLEAN CloseHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, ContinueEnumeration;
01760     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, SubKeyHandle;
01761     ULONG i, RequiredBufferLength;
01762     PKEY_BASIC_INFORMATION KeyInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01763     <span class="comment">// Use an initial key name buffer size large enough for a 20-character key</span>
01764     <span class="comment">// (+ terminating NULL)</span>
01765     ULONG KeyInformationLength = <span class="keyword">sizeof</span>(KEY_BASIC_INFORMATION) + (20 * <span class="keyword">sizeof</span>(WCHAR));
01766     UNICODE_STRING SubKeyName;
01767 
01768     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(KeyName)) {
01769 
01770         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;Handle,
01771                                     BaseHandle,
01772                                     KeyName,
01773                                     KEY_READ,
01774                                     FALSE
01775                                    );
01776         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01777             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01778         } <span class="keywordflow">else</span> {
01779             CloseHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01780         }
01781 
01782     } <span class="keywordflow">else</span> {
01783 
01784         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = BaseHandle;
01785     }
01786 
01787     <span class="comment">//</span>
01788     <span class="comment">// Enumerate the subkeys until we run out of them.</span>
01789     <span class="comment">//</span>
01790     i = 0;
01791     SubKeyHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01792 
01793     <span class="keywordflow">while</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01794 
01795         <span class="keywordflow">if</span>(!KeyInformation) {
01796 
01797             KeyInformation = (PKEY_BASIC_INFORMATION)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
01798                                                                     KeyInformationLength
01799                                                                    );
01800             <span class="keywordflow">if</span>(!KeyInformation) {
01801                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01802                 <span class="keywordflow">break</span>;
01803             }
01804         }
01805 
01806         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateKey(Handle,
01807                                 i,
01808                                 KeyBasicInformation,
01809                                 KeyInformation,
01810                                 KeyInformationLength,
01811                                 &amp;RequiredBufferLength
01812                                );
01813 
01814         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01815             <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) {
01816                 <span class="comment">//</span>
01817                 <span class="comment">// Try again with larger buffer.</span>
01818                 <span class="comment">//</span>
01819                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyInformation);
01820                 KeyInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01821                 KeyInformationLength = RequiredBufferLength;
01822                 <span class="keywordflow">continue</span>;
01823 
01824             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
01825                 <span class="comment">//</span>
01826                 <span class="comment">// break out of loop</span>
01827                 <span class="comment">//</span>
01828                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01829                 <span class="keywordflow">break</span>;
01830 
01831             } <span class="keywordflow">else</span> {
01832                 <span class="comment">//</span>
01833                 <span class="comment">// This is a non-critical error.</span>
01834                 <span class="comment">//</span>
01835                 <span class="keywordflow">if</span>(IgnoreNonCriticalErrors) {
01836                     <span class="keywordflow">goto</span> ContinueWithNextSubKey;
01837                 } <span class="keywordflow">else</span> {
01838                     <span class="keywordflow">break</span>;
01839                 }
01840             }
01841         }
01842 
01843         <span class="comment">//</span>
01844         <span class="comment">// Initialize a unicode string with this key name.  Note that this string</span>
01845         <span class="comment">// WILL NOT be NULL-terminated.</span>
01846         <span class="comment">//</span>
01847         SubKeyName.Length = SubKeyName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)KeyInformation-&gt;NameLength;
01848         SubKeyName.Buffer = KeyInformation-&gt;Name;
01849 
01850         <span class="comment">//</span>
01851         <span class="comment">// If DesiredAccess is non-zero, open a handle to this subkey.</span>
01852         <span class="comment">//</span>
01853         <span class="keywordflow">if</span>(DesiredAccess) {
01854             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;SubKeyHandle,
01855                                         Handle,
01856                                         &amp;SubKeyName,
01857                                         DesiredAccess,
01858                                         FALSE
01859                                        );
01860             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01861                 <span class="comment">//</span>
01862                 <span class="comment">// This is a non-critical error.</span>
01863                 <span class="comment">//</span>
01864                 <span class="keywordflow">if</span>(IgnoreNonCriticalErrors) {
01865                     <span class="keywordflow">goto</span> ContinueWithNextSubKey;
01866                 } <span class="keywordflow">else</span> {
01867                     <span class="keywordflow">break</span>;
01868                 }
01869             }
01870         }
01871 
01872         <span class="comment">//</span>
01873         <span class="comment">// Invoke the supplied callback function for this subkey.</span>
01874         <span class="comment">//</span>
01875         ContinueEnumeration = SubKeyCallbackRoutine(SubKeyHandle, &amp;SubKeyName, Context);
01876 
01877         <span class="keywordflow">if</span>(DesiredAccess) {
01878             ZwClose(SubKeyHandle);
01879         }
01880 
01881         <span class="keywordflow">if</span>(!ContinueEnumeration) {
01882             <span class="comment">//</span>
01883             <span class="comment">// Enumeration has been aborted.</span>
01884             <span class="comment">//</span>
01885             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01886             <span class="keywordflow">break</span>;
01887 
01888         }
01889 
01890 ContinueWithNextSubKey:
01891 
01892         i++;
01893     }
01894 
01895     <span class="keywordflow">if</span>(KeyInformation) {
01896         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyInformation);
01897     }
01898 
01899     <span class="keywordflow">if</span>(CloseHandle) {
01900         ZwClose(Handle);
01901     }
01902 
01903     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01904 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="pri_bld/pnpsubs.c::IopCleanupDeviceRegistryValues" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCleanupDeviceRegistryValues           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>InstancePath</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>KeepReference</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03841">3841</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">IopDeleteLegacyKey()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01572">IopUnlockDeviceRemovalRelations()</a>.
<p>
<pre class="fragment"><div>03848                    :
03849 
03850     This routine cleans up a device instance key when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no
03851     longer present/enumerated.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> registered to a Service
03852     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Service's <span class="keyword">enum</span> key will also been cleaned up.
03853 
03854     Note <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller must lock <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RegistryDeciceResource
03855 
03856 Arguments:
03857 
03858     InstancePath - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance key.
03859 
03860     KeepReference - supplies a <span class="keywordtype">boolean</span> value to indicate <span class="keywordflow">if</span> we should remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03861         device instance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to device object mapping.
03862 
03863 Return Value:
03864 
03865     status
03866 
03867 --*/
03868 
03869 {
03870     HANDLE handle, instanceHandle;
03871     UNICODE_STRING unicodeValueName;
03872     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03873     ULONG count = 0;
03874     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03875 
03876     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03877 
03878     <span class="comment">//</span>
03879     <span class="comment">// Open System\CurrentControlSet\Enum</span>
03880     <span class="comment">//</span>
03881 
03882     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03883                                 NULL,
03884                                 &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
03885                                 KEY_ALL_ACCESS,
03886                                 FALSE
03887                                 );
03888 
03889     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03890         <span class="keywordflow">return</span> status;
03891     }
03892 
03893     <span class="comment">//</span>
03894     <span class="comment">// Open the device instance key</span>
03895     <span class="comment">//</span>
03896 
03897     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;instanceHandle,
03898                                 handle,
03899                                 InstancePath,
03900                                 KEY_ALL_ACCESS,
03901                                 FALSE
03902                                 );
03903 
03904     ZwClose(handle);
03905     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03906 
03907         <span class="comment">//</span>
03908         <span class="comment">// There is no registry key for the ServiceKeyName information.</span>
03909         <span class="comment">//</span>
03910 
03911         <span class="keywordflow">return</span> status;
03912     }
03913 
03914     <span class="comment">//</span>
03915     <span class="comment">// Delete the DeviceReference value name under Control key</span>
03916     <span class="comment">//</span>
03917 
03918     <span class="keywordflow">if</span> (!KeepReference) {
03919 
03920         <span class="comment">//</span>
03921         <span class="comment">// BUGBUG (lonnym)--verify that removal of the following code fragment is valid.</span>
03922         <span class="comment">//</span>
03923 <span class="preprocessor">#if 0</span>
03924 <span class="preprocessor"></span>        <span class="comment">//</span>
03925         <span class="comment">// Set the 'FoundAtEnum' value to false.</span>
03926         <span class="comment">//</span>
03927 
03928         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_FOUNDATENUM);
03929         tmpValue = 0;
03930         ZwSetValueKey(instanceHandle,
03931                       &amp;unicodeValueName,
03932                       TITLE_INDEX_VALUE,
03933                       REG_DWORD,
03934                       &amp;tmpValue,
03935                       <span class="keyword">sizeof</span>(tmpValue)
03936                       );
03937 <span class="preprocessor">#endif // (lonnym, verify removal to here)</span>
03938 <span class="preprocessor"></span>
03939         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
03940         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03941                                     instanceHandle,
03942                                     &amp;unicodeValueName,
03943                                     KEY_ALL_ACCESS,
03944                                     FALSE
03945                                     );
03946         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03947             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_DEVICE_REFERENCE);
03948             ZwDeleteValueKey(handle, &amp;unicodeValueName);
03949             ZwClose(handle);
03950         }
03951 
03952         <span class="comment">//</span>
03953         <span class="comment">// Deregister the device from its controlling service's service enum key</span>
03954         <span class="comment">//</span>
03955 
03956         status = PiDeviceRegistration(InstancePath,
03957                                       FALSE,
03958                                       NULL
03959                                       );
03960     }
03961     ZwClose(instanceHandle);
03962 
03963     <span class="keywordflow">return</span> status;
03964 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="pri_bld/pnpsubs.c::IopCmResourcesToIoResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PIO_RESOURCE_REQUIREMENTS_LIST IopCmResourcesToIoResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SlotNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>CmResourceList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Priority</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04279">4279</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00803">CmResourceTypeReserved</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04592">IopFilterResourceRequirementsList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00469">IoReportResourceUsageInternal()</a>, and <a class="el" href="../../d3/d4/mapper_8c-source.html#l01091">MapperMarkKey()</a>.
<p>
<pre class="fragment"><div>04287                    :
04288 
04289     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> converts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input CmResourceList to IO_RESOURCE_REQUIREMENTS_LIST.
04290 
04291 Arguments:
04292 
04293     SlotNumber - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SlotNumber <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources refer to.
04294 
04295     CmResourceList - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cm resource list to convert.
04296 
04297     Priority - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logconfig
04298 
04299 Return Value:
04300 
04301     returns a IO_RESOURCE_REQUIREMENTS_LISTST <span class="keywordflow">if</span> succeeds.  Otherwise a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04302     returned.
04303 
04304 --*/
04305 {
04306     PIO_RESOURCE_REQUIREMENTS_LIST ioResReqList;
04307     ULONG count = 0, size, i, j;
04308     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
04309     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmPartDesc;
04310     PIO_RESOURCE_DESCRIPTOR ioDesc;
04311 
04312     <span class="comment">//</span>
04313     <span class="comment">// First determine number of descriptors required.</span>
04314     <span class="comment">//</span>
04315 
04316     cmFullDesc = &amp;CmResourceList-&gt;List[0];
04317     <span class="keywordflow">for</span> (i = 0; i &lt; CmResourceList-&gt;Count; i++) {
04318         count += cmFullDesc-&gt;PartialResourceList.Count;
04319         cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04320         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04321             size = 0;
04322             <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
04323             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04324                  size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
04325                  count--;
04326                  <span class="keywordflow">break</span>;
04327             }
04328             cmPartDesc++;
04329             cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
04330         }
04331         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
04332     }
04333 
04334     <span class="keywordflow">if</span> (count == 0) {
04335         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04336     }
04337 
04338     <span class="comment">//</span>
04339     <span class="comment">// Count the extra descriptors for InterfaceType and BusNumber information.</span>
04340     <span class="comment">//</span>
04341 
04342     count += CmResourceList-&gt;Count - 1;
04343 
04344     <span class="comment">//</span>
04345     <span class="comment">// Allocate heap space for IO RESOURCE REQUIREMENTS LIST</span>
04346     <span class="comment">//</span>
04347 
04348     count++;           <span class="comment">// add one for CmResourceTypeConfigData</span>
04349     ioResReqList = (PIO_RESOURCE_REQUIREMENTS_LIST)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
04350                        PagedPool,
04351                        <span class="keyword">sizeof</span>(IO_RESOURCE_REQUIREMENTS_LIST) +
04352                            count * <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR)
04353                        );
04354     <span class="keywordflow">if</span> (!ioResReqList) {
04355         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04356     }
04357 
04358     <span class="comment">//</span>
04359     <span class="comment">// Parse the cm resource descriptor and build its corresponding IO resource descriptor</span>
04360     <span class="comment">//</span>
04361 
04362     ioResReqList-&gt;InterfaceType = CmResourceList-&gt;List[0].InterfaceType;
04363     ioResReqList-&gt;BusNumber = CmResourceList-&gt;List[0].BusNumber;
04364     ioResReqList-&gt;SlotNumber = SlotNumber;
04365     ioResReqList-&gt;Reserved[0] = 0;
04366     ioResReqList-&gt;Reserved[1] = 0;
04367     ioResReqList-&gt;Reserved[2] = 0;
04368     ioResReqList-&gt;AlternativeLists = 1;
04369     ioResReqList-&gt;List[0].Version = 1;
04370     ioResReqList-&gt;List[0].Revision = 1;
04371     ioResReqList-&gt;List[0].Count = count;
04372 
04373     <span class="comment">//</span>
04374     <span class="comment">// Generate a CmResourceTypeConfigData descriptor</span>
04375     <span class="comment">//</span>
04376 
04377     ioDesc = &amp;ioResReqList-&gt;List[0].Descriptors[0];
04378     ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
04379     ioDesc-&gt;Type = CmResourceTypeConfigData;
04380     ioDesc-&gt;ShareDisposition = CmResourceShareShared;
04381     ioDesc-&gt;Flags = 0;
04382     ioDesc-&gt;Spare1 = 0;
04383     ioDesc-&gt;Spare2 = 0;
04384     ioDesc-&gt;u.ConfigData.Priority = Priority;
04385     ioDesc++;
04386 
04387     cmFullDesc = &amp;CmResourceList-&gt;List[0];
04388     <span class="keywordflow">for</span> (i = 0; i &lt; CmResourceList-&gt;Count; i++) {
04389         <span class="keywordflow">if</span> (i != 0) {
04390 
04391             <span class="comment">//</span>
04392             <span class="comment">// Set up descriptor to remember the InterfaceType and BusNumber.</span>
04393             <span class="comment">//</span>
04394 
04395             ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
04396             ioDesc-&gt;Type = <a class="code" href="../../d9/d0/pnpiop_8h.html#a74">CmResourceTypeReserved</a>;
04397             ioDesc-&gt;ShareDisposition = CmResourceShareUndetermined;
04398             ioDesc-&gt;Flags = 0;
04399             ioDesc-&gt;Spare1 = 0;
04400             ioDesc-&gt;Spare2 = 0;
04401             <span class="keywordflow">if</span> (cmFullDesc-&gt;InterfaceType == InterfaceTypeUndefined) {
04402                 ioDesc-&gt;u.DevicePrivate.Data[0] = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
04403             } <span class="keywordflow">else</span> {
04404                 ioDesc-&gt;u.DevicePrivate.Data[0] = cmFullDesc-&gt;InterfaceType;
04405             }
04406             ioDesc-&gt;u.DevicePrivate.Data[1] = cmFullDesc-&gt;BusNumber;
04407             ioDesc-&gt;u.DevicePrivate.Data[2] = 0;
04408             ioDesc++;
04409         }
04410         cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04411         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04412             ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
04413             ioDesc-&gt;Type = cmPartDesc-&gt;Type;
04414             ioDesc-&gt;ShareDisposition = cmPartDesc-&gt;ShareDisposition;
04415             ioDesc-&gt;Flags = cmPartDesc-&gt;Flags;
04416             ioDesc-&gt;Spare1 = 0;
04417             ioDesc-&gt;Spare2 = 0;
04418 
04419             size = 0;
04420             <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
04421             <span class="keywordflow">case</span> CmResourceTypePort:
04422                  ioDesc-&gt;u.Port.MinimumAddress = cmPartDesc-&gt;u.Port.Start;
04423                  ioDesc-&gt;u.Port.MaximumAddress.QuadPart = cmPartDesc-&gt;u.Port.Start.QuadPart +
04424                                                              cmPartDesc-&gt;u.Port.Length - 1;
04425                  ioDesc-&gt;u.Port.Alignment = 1;
04426                  ioDesc-&gt;u.Port.Length = cmPartDesc-&gt;u.Port.Length;
04427                  ioDesc++;
04428                  <span class="keywordflow">break</span>;
04429             <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04430 <span class="preprocessor">#if defined(_X86_)</span>
04431 <span class="preprocessor"></span>                ioDesc-&gt;u.Interrupt.MinimumVector = ioDesc-&gt;u.Interrupt.MaximumVector =
04432                    cmPartDesc-&gt;u.Interrupt.Level;
04433 <span class="preprocessor">#else</span>
04434 <span class="preprocessor"></span>                 ioDesc-&gt;u.Interrupt.MinimumVector = ioDesc-&gt;u.Interrupt.MaximumVector =
04435                     cmPartDesc-&gt;u.Interrupt.Vector;
04436 <span class="preprocessor">#endif</span>
04437 <span class="preprocessor"></span>                 ioDesc++;
04438                  <span class="keywordflow">break</span>;
04439             <span class="keywordflow">case</span> CmResourceTypeMemory:
04440                  ioDesc-&gt;u.Memory.MinimumAddress = cmPartDesc-&gt;u.Memory.Start;
04441                  ioDesc-&gt;u.Memory.MaximumAddress.QuadPart = cmPartDesc-&gt;u.Memory.Start.QuadPart +
04442                                                                cmPartDesc-&gt;u.Memory.Length - 1;
04443                  ioDesc-&gt;u.Memory.Alignment = 1;
04444                  ioDesc-&gt;u.Memory.Length = cmPartDesc-&gt;u.Memory.Length;
04445                  ioDesc++;
04446                  <span class="keywordflow">break</span>;
04447             <span class="keywordflow">case</span> CmResourceTypeDma:
04448                  ioDesc-&gt;u.Dma.MinimumChannel = cmPartDesc-&gt;u.Dma.Channel;
04449                  ioDesc-&gt;u.Dma.MaximumChannel = cmPartDesc-&gt;u.Dma.Channel;
04450                  ioDesc++;
04451                  <span class="keywordflow">break</span>;
04452             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04453                  size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
04454                  <span class="keywordflow">break</span>;
04455             <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04456                  ioDesc-&gt;u.BusNumber.MinBusNumber = cmPartDesc-&gt;u.BusNumber.Start;
04457                  ioDesc-&gt;u.BusNumber.MaxBusNumber = cmPartDesc-&gt;u.BusNumber.Start +
04458                                                     cmPartDesc-&gt;u.BusNumber.Length - 1;
04459                  ioDesc-&gt;u.BusNumber.Length = cmPartDesc-&gt;u.BusNumber.Length;
04460                  ioDesc++;
04461                  <span class="keywordflow">break</span>;
04462             <span class="keywordflow">default</span>:
04463                  ioDesc-&gt;u.DevicePrivate.Data[0] = cmPartDesc-&gt;u.DevicePrivate.Data[0];
04464                  ioDesc-&gt;u.DevicePrivate.Data[1] = cmPartDesc-&gt;u.DevicePrivate.Data[1];
04465                  ioDesc-&gt;u.DevicePrivate.Data[2] = cmPartDesc-&gt;u.DevicePrivate.Data[2];
04466                  ioDesc++;
04467                  <span class="keywordflow">break</span>;
04468             }
04469             cmPartDesc++;
04470             cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
04471         }
04472         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
04473     }
04474     ioResReqList-&gt;ListSize = (ULONG)((ULONG_PTR)ioDesc - (ULONG_PTR)ioResReqList);
04475     <span class="keywordflow">return</span> ioResReqList;
04476 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="pri_bld/pnpsubs.c::IopConcatenateUnicodeStrings" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopConcatenateUnicodeStrings           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Destination</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>String1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING <a class="el" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00695">695</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d9/tcmpmem_8c-source.html#l00037">String1</a>, <a class="el" href="../../d0/d9/tcmpmem_8c-source.html#l00038">String2</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">IopCreateMadeupNode()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00931">IopServiceInstanceToDeviceInstance()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>00703                    :
00704 
00705     This routine returns a buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> concatenation of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00706     two specified strings.  Since <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> optional, <span class="keyword">this</span> function may
00707     also be used to make a copy of a unicode string.  Paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> space
00708     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination string.  Caller must release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00709     space once done with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00710 
00711 Parameters:
00712 
00713     Destination - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00714         newly created key.
00715 
00716     <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> frist UNICODE_STRING.
00717 
00718     <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a> - Supplies an optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second UNICODE_STRING.
00719 
00720 Return Value:
00721 
00722     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
00723 
00724 --*/
00725 
00726 {
00727     ULONG length;
00728     PWSTR buffer;
00729 
00730     length = <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00731     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(String2)) {
00732         length += <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Length;
00733     }
00734     buffer = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, length);
00735     <span class="keywordflow">if</span> (!buffer) {
00736         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00737     }
00738     Destination-&gt;Buffer = buffer;
00739     Destination-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length - <span class="keyword">sizeof</span>(UNICODE_NULL);
00740     Destination-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
00741     RtlMoveMemory (Destination-&gt;Buffer, <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Buffer, <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length);
00742     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(String2)) {
00743         RtlMoveMemory((PUCHAR)Destination-&gt;Buffer + <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length,
00744                       <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Buffer,
00745                       <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Length
00746                      );
00747     }
00748     buffer[length / <span class="keyword">sizeof</span>(WCHAR) - 1] = UNICODE_NULL;
00749     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00750 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="pri_bld/pnpsubs.c::IopCreateMadeupNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCreateMadeupNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>InstanceNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceOwned</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00087">87</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00177">CmRegistryMachineSystemCurrentControlSetEnumRootName</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00695">IopConcatenateUnicodeStrings()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01140">IopOpenRegistryKeyPersist()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration()</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00086">ReturnedHandle</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01038">RtlUpcaseUnicodeString()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00753">IopPrepareDriverLoading()</a>.
<p>
<pre class="fragment"><div>00097                    :
00098 
00099     This routine creates a <span class="keyword">new</span> instance node under System\Enum\Root\*Madeup&lt;Name&gt;
00100     key and all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> required <span class="keywordflow">default</span> value entries.  Also a value entry under
00101     Service\ServiceKeyName\Enum <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created madeup
00102     entry.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> keyname of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> key are returned to caller.
00103     Caller must free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unicode string when he <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00104 
00105 Parameters:
00106 
00107     ServiceKeyName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00108         system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)
00109         that caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RegistryPath parameter
00110         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> routine.
00111 
00112     <a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a> - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00113         newly created key.
00114 
00115     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created
00116         key.
00117 
00118     InstanceNumber - supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> InstanceNumber value
00119         entry created under service\name\<span class="keyword">enum</span> subkey.
00120 
00121     ResourceOwned - supplies a BOOLEAN variable to indicate <span class="keywordflow">if</span> caller owns
00122         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry resource exclusively.
00123 
00124 Return Value:
00125 
00126     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
00127 
00128 --*/
00129 
00130 {
00131     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00132     UNICODE_STRING tmpKeyName, unicodeInstanceName, unicodeString;
00133     UNICODE_STRING rootKeyName, unicodeValueName, unicodeKeyName;
00134     HANDLE handle, enumRootHandle, hTreeHandle;
00135     ULONG instance;
00136     UCHAR unicodeBuffer[20];
00137     ULONG tmpValue, disposition = 0;
00138     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00139     PWSTR p;
00140     BOOLEAN releaseResource = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00141 
00142     <span class="keywordflow">if</span> (!ResourceOwned) {
00143         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00144         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
00145         releaseResource = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00146     }
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">// Open LocalMachine\System\CurrentControlSet\Enum\Root</span>
00150     <span class="comment">//</span>
00151 
00152     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;enumRootHandle,
00153                                 NULL,
00154                                 &amp;CmRegistryMachineSystemCurrentControlSetEnumRootName,
00155                                 KEY_ALL_ACCESS,
00156                                 FALSE
00157                                 );
00158     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00159         <span class="keywordflow">goto</span> local_exit0;
00160     }
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">// Open, and create if not already exist, System\Enum\Root\LEGACY_&lt;ServiceName&gt;</span>
00164     <span class="comment">// First, try to find the ServiceName by extracting it from user supplied</span>
00165     <span class="comment">// ServiceKeyName.</span>
00166     <span class="comment">//</span>
00167 
00168     PiWstrToUnicodeString(&amp;tmpKeyName, REGSTR_KEY_MADEUP);
00169     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(&amp;unicodeKeyName, &amp;tmpKeyName, ServiceKeyName);
00170     <a class="code" href="../../d6/d6/nls_8c.html#a31">RtlUpcaseUnicodeString</a>(&amp;unicodeKeyName, &amp;unicodeKeyName, FALSE);
00171     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a7">IopOpenRegistryKeyPersist</a>(&amp;handle,
00172                                        enumRootHandle,
00173                                        &amp;unicodeKeyName,
00174                                        KEY_ALL_ACCESS,
00175                                        TRUE,
00176                                        NULL
00177                                        );
00178     ZwClose(enumRootHandle);
00179     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00180         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00181         <span class="keywordflow">goto</span> local_exit0;
00182     }
00183 
00184     instance = 1;
00185 
00186     PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_NEXT_INSTANCE);
00187     status = ZwSetValueKey(
00188                 handle,
00189                 &amp;unicodeValueName,
00190                 TITLE_INDEX_VALUE,
00191                 REG_DWORD,
00192                 &amp;instance,
00193                 <span class="keyword">sizeof</span>(instance)
00194                 );
00195 
00196     instance--;
00197     *InstanceNumber = instance;
00198     PiUlongToInstanceKeyUnicodeString(&amp;unicodeInstanceName,
00199                                       unicodeBuffer + <span class="keyword">sizeof</span>(WCHAR), <span class="comment">// reserve first WCHAR space</span>
00200                                       20 - <span class="keyword">sizeof</span>(WCHAR),
00201                                       instance
00202                                       );
00203     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a7">IopOpenRegistryKeyPersist</a>(ReturnedHandle,
00204                                        handle,
00205                                        &amp;unicodeInstanceName,
00206                                        KEY_ALL_ACCESS,
00207                                        TRUE,
00208                                        &amp;disposition
00209                                        );
00210     ZwClose(handle);
00211     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00212         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00213         <span class="keywordflow">goto</span> local_exit0;
00214     }
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">// Prepare newly created registry key name for returning to caller</span>
00218     <span class="comment">//</span>
00219 
00220     *(PWSTR)unicodeBuffer = OBJ_NAME_PATH_SEPARATOR;
00221     unicodeInstanceName.Buffer = (PWSTR)unicodeBuffer;
00222     unicodeInstanceName.Length += <span class="keyword">sizeof</span>(WCHAR);
00223     unicodeInstanceName.MaximumLength += <span class="keyword">sizeof</span>(WCHAR);
00224     PiWstrToUnicodeString(&amp;rootKeyName, REGSTR_KEY_ROOTENUM);
00225     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;tmpKeyName, L<span class="stringliteral">"\\"</span>);
00226     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(&amp;unicodeString, &amp;tmpKeyName, &amp;unicodeKeyName);
00227     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00228     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(&amp;tmpKeyName, &amp;rootKeyName, &amp;unicodeString);
00229     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeString);
00230     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(KeyName, &amp;tmpKeyName, &amp;unicodeInstanceName);
00231 
00232     <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {
00233 
00234         <span class="comment">//</span>
00235         <span class="comment">// Create all the default value entry for the newly created key.</span>
00236         <span class="comment">// Service = ServiceKeyName</span>
00237         <span class="comment">// FoundAtEnum = 1</span>
00238         <span class="comment">// Class = "LegacyDriver"</span>
00239         <span class="comment">// ClassGUID = GUID for legacy driver class</span>
00240         <span class="comment">// ConfigFlags = 0</span>
00241         <span class="comment">//</span>
00242         <span class="comment">// Create "Control" subkey with "NewlyCreated" value key</span>
00243         <span class="comment">//</span>
00244 
00245         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
00246         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
00247                                     *ReturnedHandle,
00248                                     &amp;unicodeValueName,
00249                                     KEY_ALL_ACCESS,
00250                                     TRUE
00251                                     );
00252         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00253             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_NEWLY_CREATED);
00254             tmpValue = 0;
00255             ZwSetValueKey(handle,
00256                           &amp;unicodeValueName,
00257                           TITLE_INDEX_VALUE,
00258                           REG_DWORD,
00259                           &amp;tmpValue,
00260                           <span class="keyword">sizeof</span>(tmpValue)
00261                           );
00262             ZwClose(handle);
00263         }
00264 
00265         handle = *<a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>;
00266 
00267         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_SERVICE);
00268         p = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
00269                                   ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
00270         <span class="keywordflow">if</span>(p) {
00271             RtlMoveMemory(p, ServiceKeyName-&gt;Buffer, ServiceKeyName-&gt;Length);
00272             p[ServiceKeyName-&gt;Length / <span class="keyword">sizeof</span> (WCHAR)] = UNICODE_NULL;
00273             ZwSetValueKey(
00274                         handle,
00275                         &amp;unicodeValueName,
00276                         TITLE_INDEX_VALUE,
00277                         REG_SZ,
00278                         p,
00279                         ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
00280                         );
00281             <span class="comment">//</span>
00282             <span class="comment">// We'll keep the null-terminated service name buffer around for a while,</span>
00283             <span class="comment">// because we may need it later on for the DeviceDesc in case the service</span>
00284             <span class="comment">// has no DisplayName.</span>
00285             <span class="comment">//</span>
00286             <span class="comment">// ExFreePool(p);</span>
00287         }
00288 
00289         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_LEGACY);
00290         tmpValue = 1;
00291         ZwSetValueKey(
00292                     handle,
00293                     &amp;unicodeValueName,
00294                     TITLE_INDEX_VALUE,
00295                     REG_DWORD,
00296                     &amp;tmpValue,
00297                     <span class="keyword">sizeof</span>(tmpValue)
00298                     );
00299 
00300         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_CONFIG_FLAGS);
00301         tmpValue = 0;
00302         ZwSetValueKey(
00303                     handle,
00304                     &amp;unicodeValueName,
00305                     TITLE_INDEX_VALUE,
00306                     REG_DWORD,
00307                     &amp;tmpValue,
00308                     <span class="keyword">sizeof</span>(tmpValue)
00309                     );
00310 
00311         <span class="comment">//</span>
00312         <span class="comment">// BUGBUG (lonnym)--verify that removal of the following code fragment is OK.</span>
00313         <span class="comment">//</span>
00314 <span class="preprocessor">#if 0</span>
00315 <span class="preprocessor"></span>        PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_FOUNDATENUM);
00316         tmpValue = 1;
00317         ZwSetValueKey(
00318                     handle,
00319                     &amp;unicodeValueName,
00320                     TITLE_INDEX_VALUE,
00321                     REG_DWORD,
00322                     &amp;tmpValue,
00323                     <span class="keyword">sizeof</span>(tmpValue)
00324                     );
00325 <span class="preprocessor">#endif // (lonnym, verify removal to here)</span>
00326 <span class="preprocessor"></span>
00327         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_CLASS);
00328         ZwSetValueKey(
00329                     handle,
00330                     &amp;unicodeValueName,
00331                     TITLE_INDEX_VALUE,
00332                     REG_SZ,
00333                     REGSTR_VALUE_LEGACY_DRIVER,
00334                     <span class="keyword">sizeof</span>(REGSTR_VALUE_LEGACY_DRIVER)
00335                     );
00336 
00337         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_CLASSGUID);
00338         ZwSetValueKey(
00339                     handle,
00340                     &amp;unicodeValueName,
00341                     TITLE_INDEX_VALUE,
00342                     REG_SZ,
00343                     REGSTR_VALUE_LEGACY_DRIVER_CLASS_GUID,
00344                     <span class="keyword">sizeof</span>(REGSTR_VALUE_LEGACY_DRIVER_CLASS_GUID)
00345                     );
00346 
00347 
00348         <span class="comment">//</span>
00349         <span class="comment">// Initialize DeviceDesc= value entry.  If the service key has a "DisplayName"</span>
00350         <span class="comment">// value entry, it is used as the DeviceDesc value.  Otherwise, the service key</span>
00351         <span class="comment">// name is used.</span>
00352         <span class="comment">//</span>
00353 
00354         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
00355                                         KEY_READ,
00356                                         &amp;handle,
00357                                         NULL,
00358                                         FALSE
00359                                         );
00360         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00361 
00362             keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00363             unicodeString.Length = 0;
00364             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
00365                                          REGSTR_VALUE_DISPLAY_NAME,
00366                                          &amp;keyValueInformation
00367                                         );
00368             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00369                 <span class="keywordflow">if</span> (keyValueInformation-&gt;Type == REG_SZ) {
00370                     <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength &gt; <span class="keyword">sizeof</span>(UNICODE_NULL)) {
00371                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;unicodeString,
00372                                                        (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00373                                                        keyValueInformation-&gt;DataLength
00374                                                        );
00375                     }
00376                 }
00377             }
00378             <span class="keywordflow">if</span> ((unicodeString.Length == 0) &amp;&amp; p) {
00379 
00380                 <span class="comment">//</span>
00381                 <span class="comment">// No DisplayName--use the service key name.</span>
00382                 <span class="comment">//</span>
00383 
00384                 unicodeString.Length = ServiceKeyName-&gt;Length;
00385                 unicodeString.MaximumLength = ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00386                 unicodeString.Buffer = p;
00387             }
00388 
00389             <span class="keywordflow">if</span>(unicodeString.Length) {
00390                 PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_DEVICE_DESC);
00391                 ZwSetValueKey(*ReturnedHandle,
00392                               &amp;unicodeValueName,
00393                               TITLE_INDEX_VALUE,
00394                               REG_SZ,
00395                               unicodeString.Buffer,
00396                               unicodeString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
00397                               );
00398             }
00399             <span class="keywordflow">if</span> (keyValueInformation) {
00400                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00401             }
00402             ZwClose(handle);
00403         }
00404 
00405         <span class="keywordflow">if</span>(p) {
00406             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(p);
00407         }
00408     }
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">// Create new value entry under ServiceKeyName\Enum to reflect the newly</span>
00412     <span class="comment">// added made-up device instance node.</span>
00413     <span class="comment">//</span>
00414 
00415     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
00416     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00417     releaseResource = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00418 
00419     status = <a class="code" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration</a>(
00420                  KeyName,
00421                  TRUE,
00422                  NULL,
00423                  NULL
00424                  );
00425 
00426     <span class="keywordflow">if</span> (ResourceOwned) {
00427         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00428         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
00429     }
00430     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;tmpKeyName);
00431     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00432 
00433         <span class="comment">//</span>
00434         <span class="comment">// There is no registry key for the ServiceKeyName information.</span>
00435         <span class="comment">//</span>
00436 
00437         ZwClose(*ReturnedHandle);
00438         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(KeyName);
00439     }
00440 local_exit0:
00441     <span class="keywordflow">if</span> (releaseResource) {
00442         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
00443         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00444     }
00445     <span class="keywordflow">return</span> status;
00446 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="pri_bld/pnpsubs.c::IopDeleteLegacyKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDeleteLegacyKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05338">5338</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05951">IoDeleteDevice()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03841">IopCleanupDeviceRegistryValues()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o32">_DEVICE_NODE::OverUsed1</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o34">_DEVICE_NODE::OverUsed2</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>05344                    :
05345 
05346     This routine checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Legacy= value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's legacy_xxx key
05347     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one.  If yes, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> deletes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Legacy key.
05348 
05349 Parameters:
05350 
05351     DriverObject - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object.
05352 
05353 Return Value:
05354 
05355     None.  If anything fails in <span class="keyword">this</span> routine, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> legacy key stays.
05356 
05357 --*/
05358 
05359 {
05360     WCHAR buffer[100];
05361     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05362     UNICODE_STRING deviceName, instanceName, unicodeName, *serviceName;
05363     ULONG length;
05364     HANDLE handle, handle1, handlex, enumHandle;
05365     ULONG legacy;
05366     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
05367     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
05368     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
05369 
05370     serviceName = &amp;DriverObject-&gt;DriverExtension-&gt;ServiceKeyName;
05371 
05372     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
05373     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
05374 
05375     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;enumHandle,
05376                                 NULL,
05377                                 &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
05378                                 KEY_ALL_ACCESS,
05379                                 FALSE
05380                                 );
05381 
05382     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05383         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
05384     }
05385 
05386     length = _snwprintf(buffer, <span class="keyword">sizeof</span>(buffer) / <span class="keyword">sizeof</span>(WCHAR), L<span class="stringliteral">"ROOT\\LEGACY_%s"</span>, serviceName-&gt;Buffer);
05387     deviceName.MaximumLength = <span class="keyword">sizeof</span>(buffer);
05388     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(length &lt;= <span class="keyword">sizeof</span>(buffer) - 10);
05389     deviceName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(length * <span class="keyword">sizeof</span>(WCHAR));
05390     deviceName.Buffer = buffer;
05391 
05392     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle1,
05393                                 enumHandle,
05394                                 &amp;deviceName,
05395                                 KEY_ALL_ACCESS,
05396                                 FALSE
05397                                 );
05398 
05399     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05400 
05401         deviceName.Buffer[deviceName.Length / <span class="keyword">sizeof</span>(WCHAR)] =
05402                    OBJ_NAME_PATH_SEPARATOR;
05403         deviceName.Length += <span class="keyword">sizeof</span>(WCHAR);
05404         PiUlongToInstanceKeyUnicodeString(
05405                                 &amp;instanceName,
05406                                 buffer + deviceName.Length / <span class="keyword">sizeof</span>(WCHAR),
05407                                 <span class="keyword">sizeof</span>(buffer) - deviceName.Length,
05408                                 0
05409                                 );
05410         deviceName.Length += instanceName.Length;
05411 
05412 
05413         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(
05414                                 &amp;handle,
05415                                 handle1,
05416                                 &amp;instanceName,
05417                                 KEY_ALL_ACCESS,
05418                                 FALSE
05419                                 );
05420         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05421             legacy = 1;
05422             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
05423                                           REGSTR_VALUE_LEGACY,
05424                                           &amp;keyValueInformation);
05425             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05426                 <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
05427                     (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
05428                     legacy = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
05429                 }
05430                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05431             }
05432             <span class="keywordflow">if</span> (legacy != 0) {
05433 
05434                 <span class="comment">//</span>
05435                 <span class="comment">// We also want to delete the madeup device node</span>
05436                 <span class="comment">//</span>
05437 
05438                 deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(handle, NULL);
05439                 <span class="keywordflow">if</span> (deviceObject) {
05440 
05441                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devNodex, devNodey;
05442 
05443                     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
05444                     <span class="keywordflow">if</span> (deviceNode) {
05445                         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) {
05446 
05447                             <span class="comment">//</span>
05448                             <span class="comment">// Now mark this one deleted.</span>
05449                             <span class="comment">//</span>
05450                             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>;
05451                             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_DEVICE_NOT_THERE);
05452 
05453                             <span class="comment">//</span>
05454                             <span class="comment">// This is actually doing nothing because DeviceNode-&gt;ResourceList is NULL.</span>
05455                             <span class="comment">//</span>
05456 
05457                             <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(deviceNode);
05458                             devNodex = deviceNode;
05459                             <span class="keywordflow">while</span> (devNodex) {
05460                                 devNodey = devNodex;
05461                                 devNodex = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)devNodey-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode;
05462                                 devNodey-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05463                                 devNodey-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.LegacyDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05464                             }
05465 
05466                             deviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>;  <span class="comment">// remove its boot config if any</span>
05467                             <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(deviceObject);
05468                         }
05469                     }
05470                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);  <span class="comment">// added via IopDeviceObjectFromDeviceInstance</span>
05471                 }
05472 
05473                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
05474                 status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handlex,
05475                                             handle,
05476                                             &amp;unicodeName,
05477                                             KEY_ALL_ACCESS,
05478                                             FALSE
05479                                             );
05480                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05481                     ZwDeleteKey(handlex);
05482                 }
05483                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
05484                 status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handlex,
05485                                             handle,
05486                                             &amp;unicodeName,
05487                                             KEY_ALL_ACCESS,
05488                                             FALSE
05489                                             );
05490                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05491                     ZwDeleteKey(handlex);
05492                 }
05493 
05494                 ZwClose(enumHandle);
05495 
05496                 <span class="comment">//</span>
05497                 <span class="comment">// We need to call IopCleanupDeviceRegistryValue even we are going to</span>
05498                 <span class="comment">// delete it.  Because, it also cleans up related value names in other</span>
05499                 <span class="comment">// keys.</span>
05500                 <span class="comment">//</span>
05501 
05502                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a25">IopCleanupDeviceRegistryValues</a>(&amp;deviceName, FALSE);
05503                 ZwDeleteKey(handle);
05504                 ZwDeleteKey(handle1);
05505             } <span class="keywordflow">else</span> {
05506                 ZwClose(handle);
05507                 ZwClose(handle1);
05508                 ZwClose(enumHandle);
05509             }
05510         } <span class="keywordflow">else</span> {
05511             ZwClose(handle1);
05512             ZwClose(enumHandle);
05513         }
05514     } <span class="keywordflow">else</span> {
05515         ZwClose(enumHandle);
05516     }
05517 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
05518     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
05519     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
05520     <span class="keywordflow">return</span>;
05521 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="pri_bld/pnpsubs.c::IopDetermineResourceListSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG IopDetermineResourceListSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ResourceList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03523">3523</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00629">IopChangeInterfaceType()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06955">IopCombineCmResourceList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06726">IopCombineLegacyResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05198">IopMergeCmResourceLists()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07291">IopReserveBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>03529                    :
03530 
03531     This routine determines size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed in ResourceList
03532     structure.
03533 
03534 Arguments:
03535 
03536     Configuration1 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource list.
03537 
03538 Return Value:
03539 
03540     size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource list structure.
03541 
03542 --*/
03543 
03544 {
03545     ULONG totalSize, listSize, descriptorSize, i, j;
03546     PCM_FULL_RESOURCE_DESCRIPTOR fullResourceDesc;
03547     PCM_PARTIAL_RESOURCE_DESCRIPTOR partialDescriptor;
03548 
03549     <span class="keywordflow">if</span> (!ResourceList) {
03550         totalSize = 0;
03551     } <span class="keywordflow">else</span> {
03552         totalSize = FIELD_OFFSET(CM_RESOURCE_LIST, List);
03553         fullResourceDesc = &amp;ResourceList-&gt;List[0];
03554         <span class="keywordflow">for</span> (i = 0; i &lt; ResourceList-&gt;Count; i++) {
03555             listSize = FIELD_OFFSET(CM_FULL_RESOURCE_DESCRIPTOR,
03556                                     PartialResourceList) +
03557                        FIELD_OFFSET(CM_PARTIAL_RESOURCE_LIST,
03558                                     PartialDescriptors);
03559             partialDescriptor = &amp;fullResourceDesc-&gt;PartialResourceList.PartialDescriptors[0];
03560             <span class="keywordflow">for</span> (j = 0; j &lt; fullResourceDesc-&gt;PartialResourceList.Count; j++) {
03561                 descriptorSize = <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR);
03562                 <span class="keywordflow">if</span> (partialDescriptor-&gt;Type == CmResourceTypeDeviceSpecific) {
03563                     descriptorSize += partialDescriptor-&gt;u.DeviceSpecificData.DataSize;
03564                 }
03565                 listSize += descriptorSize;
03566                 partialDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR)
03567                                         ((PUCHAR)partialDescriptor + descriptorSize);
03568             }
03569             totalSize += listSize;
03570             fullResourceDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)
03571                                       ((PUCHAR)fullResourceDesc + listSize);
03572         }
03573     }
03574     <span class="keywordflow">return</span> totalSize;
03575 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="pri_bld/pnpsubs.c::IopDeviceCapabilitiesToRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDeviceCapabilitiesToRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05524">5524</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">DNF_HAS_BOOT_CONFIG</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01959">_DEVICE_CAPABILITIES::DockDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01957">_DEVICE_CAPABILITIES::EjectSupported</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03776">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03694">IopQueryDeviceCapabilities()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01956">_DEVICE_CAPABILITIES::LockSupported</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01962">_DEVICE_CAPABILITIES::RawDeviceOK</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01958">_DEVICE_CAPABILITIES::Removable</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01961">_DEVICE_CAPABILITIES::SilentInstall</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01963">_DEVICE_CAPABILITIES::SurpriseRemovalOK</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01960">_DEVICE_CAPABILITIES::UniqueID</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05633">IopDeviceNodeCapabilitiesToRegistry()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>05530                    :
05531 
05532     This routine queries and updates device capabilities after device received a start irp.
05533 
05534 Arguments:
05535 
05536     DeviceObject - supplies a pointer to a device object whose registry
05537         values are to be updated.
05538 
05539 Return Value:
05540 
05541     status
05542 
05543 --*/
05544 
05545 {
05546     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
05547     HANDLE handle;
05548     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05549     UNICODE_STRING unicodeName;
05550     ULONG tmpValue;
05551     <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a> capabilities;
05552 
05553     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05554 
05555     <span class="comment">//</span>
05556     <span class="comment">// Open the device instance key</span>
05557     <span class="comment">//</span>
05558 
05559     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(DeviceObject, &amp;handle, KEY_ALL_ACCESS);
05560     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05561         <span class="keywordflow">return</span> status;
05562     }
05563 
05564     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a330">IopQueryDeviceCapabilities</a>(deviceNode, &amp;capabilities);
05565     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05566         <span class="keywordflow">return</span> status;
05567     }
05568 
05569     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>) {
05570         capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o11">SurpriseRemovalOK</a> = 0;
05571     }
05572 
05573     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_CAPABILITIES);
05574     tmpValue = (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o4">LockSupported</a>)          |
05575                (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o5">EjectSupported</a>    &lt;&lt; 1) |
05576                (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o6">Removable</a>         &lt;&lt; 2) |
05577                (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o7">DockDevice</a>        &lt;&lt; 3) |
05578                (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o8">UniqueID</a>          &lt;&lt; 4) |
05579                (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o9">SilentInstall</a>     &lt;&lt; 5) |
05580                (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o10">RawDeviceOK</a>       &lt;&lt; 6) |
05581                (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o11">SurpriseRemovalOK</a> &lt;&lt; 7);
05582 
05583     status = ZwSetValueKey(
05584                   handle,
05585                   &amp;unicodeName,
05586                   TITLE_INDEX_VALUE,
05587                   REG_DWORD,
05588                   &amp;tmpValue,
05589                   <span class="keyword">sizeof</span>(tmpValue)
05590                   );
05591 
05592     ZwClose(handle);
05593     <span class="keywordflow">return</span> status;
05594 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="pri_bld/pnpsubs.c::IopDeviceObjectFromDeviceInstance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> IopDeviceObjectFromDeviceInstance           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE DeviceInstanceHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING DeviceInstance&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">3651</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00037">IO_TYPE_DEVICE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01176">_DEVICE_OBJECT::Type</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00166">IopAddDevicesToBootDriverWorker()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">IopDeleteLegacyKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">IopDriverLoadingFailed()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01516">IopGetDriverDeviceListWorker()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03443">IopIsDeviceInstanceEnabled()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09922">IopProcessSetInterfaceState()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06660">IopSetLegacyDeviceInstance()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>03658                    :
03659 
03660     This routine receives a DeviceInstance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> (or DeviceInstance handle) and
03661     returns a reference to a bus device object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceInstance.
03662 
03663 Arguments:
03664 
03665     DeviceInstanceHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry Device Instance key.
03666         If <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DeviceInstance must specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
03667 
03668     DeviceInstance - supplies a UNICODE_STRING to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
03669         <span class="keywordflow">if</span> <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DeviceInstanceHandle must specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle
03670         to its registry key.
03671 
03672 Returns:
03673 
03674     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> reference to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired bus device object.
03675 
03676 --*/
03677 
03678 {
03679     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03680     HANDLE handle, deviceHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03681     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03682     UNICODE_STRING unicodeName;
03683     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03684     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03685 
03686     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03687 
03688     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(DeviceInstanceHandle)) {
03689 
03690         <span class="comment">//</span>
03691         <span class="comment">// first open System\CCS\Enum key and then the device instance key.</span>
03692         <span class="comment">//</span>
03693 
03694         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03695                                     NULL,
03696                                     &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
03697                                     KEY_READ,
03698                                     FALSE
03699                                     );
03700 
03701         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03702             <span class="keywordflow">return</span> deviceReference;
03703         }
03704 
03705         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceInstance);
03706         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a> (&amp;deviceHandle,
03707                                      handle,
03708                                      DeviceInstance,
03709                                      KEY_READ,
03710                                      FALSE
03711                                      );
03712         ZwClose(handle);
03713         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03714             <span class="keywordflow">return</span> deviceReference;
03715         }
03716         DeviceInstanceHandle = deviceHandle;
03717     }
03718 
03719     <span class="comment">//</span>
03720     <span class="comment">// Read the address of device object</span>
03721     <span class="comment">//</span>
03722 
03723     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
03724     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03725                                 DeviceInstanceHandle,
03726                                 &amp;unicodeName,
03727                                 KEY_READ,
03728                                 FALSE
03729                                 );
03730     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03731         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03732     }
03733 
03734     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
03735                                   REGSTR_VALUE_DEVICE_REFERENCE,
03736                                   &amp;keyValueInformation);
03737     ZwClose(handle);
03738     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03739         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03740             (keyValueInformation-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG_PTR))) {
03741 
03742             deviceReference = *(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03743         }
03744         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03745     }
03746     <span class="keywordflow">if</span> (!deviceReference) {
03747         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03748     }
03749 
03750     <span class="comment">//</span>
03751     <span class="comment">// Make sure the address of the device object is not clobbered,</span>
03752     <span class="comment">// unfortunately if the address is truly bogus we will bugcheck since</span>
03753     <span class="comment">// try/except doesn't work for kernel addresses.</span>
03754     <span class="comment">//</span>
03755 
03756     <span class="keywordflow">if</span> (deviceReference-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o0">Type</a> != <a class="code" href="../../d0/d5/io_8h.html#a2">IO_TYPE_DEVICE</a>) {
03757         deviceReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03758     } <span class="keywordflow">else</span> {
03759         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceReference-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03760         <span class="keywordflow">if</span> (deviceNode &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a> == deviceReference)) {
03761             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(deviceReference);
03762         } <span class="keywordflow">else</span> {
03763             deviceReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03764         }
03765     }
03766 
03767 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
03768     <span class="keywordflow">if</span> (deviceHandle) {
03769         ZwClose(deviceHandle);
03770     }
03771     <span class="keywordflow">return</span> deviceReference;
03772 
03773 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="pri_bld/pnpsubs.c::IopDeviceObjectToDeviceInstance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDeviceObjectToDeviceInstance           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceInstanceHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03776">3776</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00373">IoGetDeviceProperty()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00810">IoOpenDeviceRegistryKey()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01824">IopAssignResourcesToDevices()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05675">IopDeviceCapabilitiesToRegistry()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l02009">IopIsFirmwareDisabled()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08162">IopNotifySetupDeviceArrival()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04318">IopNotifySetupDevices()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01931">IopWriteAllocatedResourcesToRegistry()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>03784                    :
03785 
03786     This routine receives a DeviceObject pointer and returns a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
03787     instance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> under registry System\ENUM key.
03788 
03789     Note, caller must owner <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a> before calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function,
03790 
03791 Arguments:
03792 
03793     DeviceObject - supplies a pointer to a physical device object.
03794 
03795     DeviceInstanceHandle - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry
03796              device instance key.
03797 
03798     DesiredAccess - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to <span class="keyword">this</span> key.
03799 
03800 Returns:
03801 
03802     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code to indicate success or <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
03803 
03804 --*/
03805 
03806 {
03807     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03808     HANDLE handle;
03809     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03810 
03811     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03812 
03813     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03814                                 NULL,
03815                                 &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
03816                                 KEY_READ,
03817                                 FALSE
03818                                 );
03819 
03820     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03821         <span class="keywordflow">return</span> status;
03822     }
03823 
03824     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
03825     <span class="keywordflow">if</span> (deviceNode &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Length != 0)) {
03826         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a> (DeviceInstanceHandle,
03827                                      handle,
03828                                      &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>,
03829                                      DesiredAccess,
03830                                      FALSE
03831                                      );
03832     } <span class="keywordflow">else</span> {
03833         status = STATUS_INVALID_DEVICE_REQUEST;
03834     }
03835     ZwClose(handle);
03836 
03837     <span class="keywordflow">return</span> status;
03838 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="pri_bld/pnpsubs.c::IopDisableDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDisableDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03443">IopIsDeviceInstanceEnabled()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="pri_bld/pnpsubs.c::IopDriverLoadingFailed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDriverLoadingFailed           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE ServiceHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING ServiceName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02609">2609</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05951">IoDeleteDevice()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00964">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.
<p>
<pre class="fragment"><div>02616                    :
02617 
02618     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when driver failed to start.  All <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
02619     instances controlled by <span class="keyword">this</span> driver/service are marked as failing to
02620     start.
02621 
02622 Arguments:
02623 
02624     ServiceKeyHandle - Optionally, supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver service node in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02625         registry that controls <span class="keyword">this</span> device instance.  If <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified,
02626         then ServiceKeyName <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service entry.
02627 
02628     ServiceKeyName - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service entry that controls
02629         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance. This must be specified <span class="keywordflow">if</span> ServiceKeyHandle isn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> given.
02630 
02631 Returns:
02632 
02633     None.
02634 
02635 --*/
02636 
02637 {
02638     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02639     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
02640     BOOLEAN closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, deletePdo;
02641     HANDLE handle, serviceEnumHandle, controlHandle;
02642     HANDLE sysEnumHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02643     ULONG deviceFlags, count, newCount, i, j;
02644     UNICODE_STRING unicodeValueName, deviceInstanceName;
02645     WCHAR unicodeBuffer[20];
02646 
02647     <span class="comment">//</span>
02648     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
02649     <span class="comment">//</span>
02650 
02651     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(ServiceHandle)) {
02652         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceName,
02653                                         KEY_READ,
02654                                         &amp;ServiceHandle,
02655                                         &amp;serviceEnumHandle,
02656                                         FALSE
02657                                         );
02658         closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02659     } <span class="keywordflow">else</span> {
02660         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_ENUM);
02661         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;serviceEnumHandle,
02662                                     ServiceHandle,
02663                                     &amp;unicodeValueName,
02664                                     KEY_READ,
02665                                     FALSE
02666                                     );
02667     }
02668     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02669 
02670         <span class="comment">//</span>
02671         <span class="comment">// No Service Enum key? no device instance.  Return FALSE.</span>
02672         <span class="comment">//</span>
02673 
02674         <span class="keywordflow">return</span> status;
02675     }
02676 
02677     <span class="comment">//</span>
02678     <span class="comment">// Set "STARTFAILED" flags.  So, we won't load it again.</span>
02679     <span class="comment">//</span>
02680 
02681     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeValueName, L<span class="stringliteral">"INITSTARTFAILED"</span>);
02682     deviceFlags = 1;
02683     ZwSetValueKey(
02684                 serviceEnumHandle,
02685                 &amp;unicodeValueName,
02686                 TITLE_INDEX_VALUE,
02687                 REG_DWORD,
02688                 &amp;deviceFlags,
02689                 <span class="keyword">sizeof</span>(deviceFlags)
02690                 );
02691 
02692     <span class="comment">//</span>
02693     <span class="comment">// Find out how many device instances listed in the ServiceName's</span>
02694     <span class="comment">// Enum key.</span>
02695     <span class="comment">//</span>
02696 
02697     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( serviceEnumHandle,
02698                                    REGSTR_VALUE_COUNT,
02699                                    &amp;keyValueInformation
02700                                    );
02701     count = 0;
02702     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02703         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
02704             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
02705 
02706             count = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
02707         }
02708         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
02709     }
02710     <span class="keywordflow">if</span> (count == 0) {
02711         ZwClose(serviceEnumHandle);
02712         <span class="keywordflow">if</span> (closeHandle) {
02713             ZwClose(ServiceHandle);
02714         }
02715         <span class="keywordflow">return</span> status;
02716     }
02717 
02718     <span class="comment">//</span>
02719     <span class="comment">// Open HTREE\ROOT\0 key so later we can remove device instance key</span>
02720     <span class="comment">// from its AttachedComponents value name.</span>
02721     <span class="comment">//</span>
02722 
02723     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;sysEnumHandle,
02724                                 NULL,
02725                                 &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
02726                                 KEY_ALL_ACCESS,
02727                                 FALSE
02728                                 );
02729 
02730     <span class="comment">//</span>
02731     <span class="comment">// Walk through each registered device instance to mark its Problem and</span>
02732     <span class="comment">// StatusFlags as fail to start and reset its ActiveService</span>
02733     <span class="comment">//</span>
02734 
02735     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02736     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
02737 
02738     newCount = count;
02739     <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
02740         deletePdo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02741         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a> (
02742                      ServiceHandle,
02743                      ServiceName,
02744                      i,
02745                      &amp;deviceInstanceName,
02746                      &amp;handle,
02747                      KEY_ALL_ACCESS
02748                      );
02749 
02750         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02751 
02752             <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
02753             <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
02754 
02755             <span class="comment">//</span>
02756             <span class="comment">// If the device instance is a detected device reported during driver's</span>
02757             <span class="comment">// DriverEntry we need to clean it up.</span>
02758             <span class="comment">//</span>
02759 
02760             deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(handle, NULL);
02761             <span class="keywordflow">if</span> (deviceObject) {
02762                 deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
02763                 <span class="keywordflow">if</span> (deviceNode) {
02764 
02765                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(deviceNode);
02766 
02767                     <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>)) {
02768 
02769                         <span class="comment">//</span>
02770                         <span class="comment">// Now mark this one deleted.</span>
02771                         <span class="comment">//</span>
02772                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>;
02773 
02774                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_DEVICE_NOT_THERE);
02775                         deletePdo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02776                     }
02777                 }
02778                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);  <span class="comment">// added via IopDeviceObjectFromDeviceInstance</span>
02779             }
02780 
02781             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
02782             controlHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02783             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;controlHandle,
02784                                         handle,
02785                                         &amp;unicodeValueName,
02786                                         KEY_ALL_ACCESS,
02787                                         FALSE
02788                                         );
02789             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02790 
02791                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(controlHandle,
02792                                              REGSTR_VALUE_NEWLY_CREATED,
02793                                              &amp;keyValueInformation);
02794                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02795                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
02796                 }
02797                 <span class="keywordflow">if</span> ((status != STATUS_OBJECT_NAME_NOT_FOUND) &amp;&amp;
02798                     (status != STATUS_OBJECT_PATH_NOT_FOUND)) {
02799 
02800                     <span class="comment">//</span>
02801                     <span class="comment">// Remove the instance value name from service enum key</span>
02802                     <span class="comment">//</span>
02803 
02804                     PiUlongToUnicodeString(&amp;unicodeValueName, unicodeBuffer, 20, i);
02805                     status = ZwDeleteValueKey (serviceEnumHandle, &amp;unicodeValueName);
02806                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02807 
02808                         <span class="comment">//</span>
02809                         <span class="comment">// If we can successfaully remove the instance value entry</span>
02810                         <span class="comment">// from service enum key, we then remove the device instance key</span>
02811                         <span class="comment">// Otherwise, we go thru normal path to mark driver loading failed</span>
02812                         <span class="comment">// in the device instance key.</span>
02813                         <span class="comment">//</span>
02814 
02815                         newCount--;
02816 
02817                         ZwDeleteKey(controlHandle);
02818                         ZwDeleteKey(handle);
02819 
02820 
02821                         <span class="comment">//</span>
02822                         <span class="comment">// We also want to delete the ROOT\LEGACY_&lt;driver&gt; key</span>
02823                         <span class="comment">//</span>
02824 
02825                         <span class="keywordflow">if</span> (sysEnumHandle) {
02826                             deviceInstanceName.Length -= 5 * <span class="keyword">sizeof</span>(WCHAR);
02827                             deviceInstanceName.Buffer[deviceInstanceName.Length / <span class="keyword">sizeof</span>(WCHAR)] =
02828                                                  UNICODE_NULL;
02829                             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
02830                                                         sysEnumHandle,
02831                                                         &amp;deviceInstanceName,
02832                                                         KEY_ALL_ACCESS,
02833                                                         FALSE
02834                                                         );
02835                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02836                                 ZwDeleteKey(handle);
02837                             }
02838                         }
02839 
02840                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceInstanceName.Buffer);
02841 
02842                         <span class="comment">//</span>
02843                         <span class="comment">// If there is a PDO for this device, remove it</span>
02844                         <span class="comment">//</span>
02845 
02846                         <span class="keywordflow">if</span> (deletePdo) {
02847                             <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(deviceObject);
02848                         }
02849 
02850                         <span class="keywordflow">continue</span>;
02851                     }
02852                 }
02853             }
02854 
02855             <span class="comment">//</span>
02856             <span class="comment">// Reset Control\ActiveService value name.</span>
02857             <span class="comment">//</span>
02858 
02859             <span class="keywordflow">if</span> (controlHandle) {
02860                 PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VAL_ACTIVESERVICE);
02861                 ZwDeleteValueKey(controlHandle, &amp;unicodeValueName);
02862                 ZwClose(controlHandle);
02863             }
02864 
02865             ZwClose(handle);
02866             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceInstanceName.Buffer);
02867         }
02868     }
02869 
02870     <span class="comment">//</span>
02871     <span class="comment">// If some instance value entry is deleted, we need to update the count of instance</span>
02872     <span class="comment">// value entries and rearrange the instance value entries under service enum key.</span>
02873     <span class="comment">//</span>
02874 
02875     <span class="keywordflow">if</span> (newCount != count) {
02876         <span class="keywordflow">if</span> (newCount != 0) {
02877             j = 0;
02878             i = 0;
02879             <span class="keywordflow">while</span> (i &lt; count) {
02880                 PiUlongToUnicodeString(&amp;unicodeValueName, unicodeBuffer, 20, i);
02881                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(serviceEnumHandle,
02882                                              unicodeValueName.Buffer,
02883                                              &amp;keyValueInformation
02884                                              );
02885                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02886                     <span class="keywordflow">if</span> (i != j) {
02887 
02888                         <span class="comment">//</span>
02889                         <span class="comment">// Need to change the instance i to instance j</span>
02890                         <span class="comment">//</span>
02891 
02892                         ZwDeleteValueKey(serviceEnumHandle, &amp;unicodeValueName);
02893 
02894                         PiUlongToUnicodeString(&amp;unicodeValueName, unicodeBuffer, 20, j);
02895                         ZwSetValueKey (serviceEnumHandle,
02896                                        &amp;unicodeValueName,
02897                                        TITLE_INDEX_VALUE,
02898                                        REG_SZ,
02899                                        (PVOID)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
02900                                        keyValueInformation-&gt;DataLength
02901                                        );
02902                     }
02903                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
02904                     j++;
02905                 }
02906                 i++;
02907             }
02908         }
02909 
02910         <span class="comment">//</span>
02911         <span class="comment">// Don't forget to update the "Count=" and "NextInstance=" value entries</span>
02912         <span class="comment">//</span>
02913 
02914         PiWstrToUnicodeString( &amp;unicodeValueName, REGSTR_VALUE_COUNT);
02915 
02916         ZwSetValueKey(serviceEnumHandle,
02917                       &amp;unicodeValueName,
02918                       TITLE_INDEX_VALUE,
02919                       REG_DWORD,
02920                       &amp;newCount,
02921                       <span class="keyword">sizeof</span> (newCount)
02922                       );
02923         PiWstrToUnicodeString( &amp;unicodeValueName, REGSTR_VALUE_NEXT_INSTANCE);
02924 
02925         ZwSetValueKey(serviceEnumHandle,
02926                       &amp;unicodeValueName,
02927                       TITLE_INDEX_VALUE,
02928                       REG_DWORD,
02929                       &amp;newCount,
02930                       <span class="keyword">sizeof</span> (newCount)
02931                       );
02932     }
02933     ZwClose(serviceEnumHandle);
02934     <span class="keywordflow">if</span> (closeHandle) {
02935         ZwClose(ServiceHandle);
02936     }
02937     <span class="keywordflow">if</span> (sysEnumHandle) {
02938         ZwClose(sysEnumHandle);
02939     }
02940 
02941     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
02942     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02943 
02944     <span class="keywordflow">return</span> STATUS_SUCCESS;
02945 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="pri_bld/pnpsubs.c::IopFilterResourceRequirementsList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopFilterResourceRequirementsList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>IoList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>CmList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *&nbsp;</td>
          <td class="mdname" nowrap> <em>FilteredList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ExactMatch</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04479">4479</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04279">IopCmResourcesToIoResources()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>.
<p>
<pre class="fragment"><div>04488                    :
04489 
04490     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> adjusts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input IoList based on input BootConfig.
04491 
04492 
04493 Arguments:
04494 
04495     IoList - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to an IoResourceRequirementsList
04496 
04497     CmList - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to a BootConfig.
04498 
04499     FilteredList - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filtered resource
04500              requirements list.
04501 
04502 Return Value:
04503 
04504     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code to indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function.
04505 
04506 --*/
04507 {
04508     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04509     PIO_RESOURCE_REQUIREMENTS_LIST ioList, newList;
04510     PIO_RESOURCE_LIST ioResourceList, newIoResourceList, selectedResourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04511     PIO_RESOURCE_DESCRIPTOR ioResourceDescriptor, ioResourceDescriptorEnd;
04512     PIO_RESOURCE_DESCRIPTOR newIoResourceDescriptor, configDataDescriptor;
04513     LONG ioResourceDescriptorCount = 0;
04514     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> version;
04515     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
04516     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDescriptor;
04517     ULONG cmDescriptorCount = 0;
04518     ULONG size, i, j, oldCount, phase;
04519     LONG k, alternativeLists;
04520     BOOLEAN exactMatch;
04521 
04522     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04523 
04524     *FilteredList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04525     *ExactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04526 
04527     <span class="comment">//</span>
04528     <span class="comment">// Make sure there is some resource requirements to be filtered.</span>
04529     <span class="comment">// If no, we will convert CmList/BootConfig to an IoResourceRequirementsList</span>
04530     <span class="comment">//</span>
04531 
04532     <span class="keywordflow">if</span> (IoList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList-&gt;AlternativeLists == 0) {
04533         <span class="keywordflow">if</span> (CmList &amp;&amp; CmList-&gt;Count != 0) {
04534             *FilteredList = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, CmList, LCPRI_BOOTCONFIG);
04535         }
04536         <span class="keywordflow">return</span> STATUS_SUCCESS;
04537     }
04538 
04539     <span class="comment">//</span>
04540     <span class="comment">// Make a copy of the Io Resource Requirements List</span>
04541     <span class="comment">//</span>
04542 
04543     ioList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, IoList-&gt;ListSize);
04544     <span class="keywordflow">if</span> (ioList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04545         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04546     }
04547 
04548     RtlMoveMemory(ioList, IoList, IoList-&gt;ListSize);
04549 
04550     <span class="comment">//</span>
04551     <span class="comment">// If there is no BootConfig, simply return the copy of the input Io list.</span>
04552     <span class="comment">//</span>
04553 
04554     <span class="keywordflow">if</span> (CmList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || CmList-&gt;Count == 0) {
04555         *FilteredList = ioList;
04556         <span class="keywordflow">return</span> STATUS_SUCCESS;
04557     }
04558 
04559     <span class="comment">//</span>
04560     <span class="comment">// First determine minimum number of descriptors required.</span>
04561     <span class="comment">//</span>
04562 
04563     cmFullDesc = &amp;CmList-&gt;List[0];
04564     <span class="keywordflow">for</span> (i = 0; i &lt; CmList-&gt;Count; i++) {
04565         cmDescriptorCount += cmFullDesc-&gt;PartialResourceList.Count;
04566         cmDescriptor = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04567         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04568             size = 0;
04569             <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04570             <span class="keywordflow">case</span> CmResourceTypeConfigData:
04571             <span class="keywordflow">case</span> CmResourceTypeDevicePrivate:
04572                  cmDescriptorCount--;
04573                  <span class="keywordflow">break</span>;
04574             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04575                  size = cmDescriptor-&gt;u.DeviceSpecificData.DataSize;
04576                  cmDescriptorCount--;
04577                  <span class="keywordflow">break</span>;
04578             <span class="keywordflow">default</span>:
04579 
04580                  <span class="comment">//</span>
04581                  <span class="comment">// Invalid cmresource list.  Ignore it and use io resources</span>
04582                  <span class="comment">//</span>
04583 
04584                  <span class="keywordflow">if</span> (cmDescriptor-&gt;Type == CmResourceTypeNull ||
04585                      cmDescriptor-&gt;Type &gt;= CmResourceTypeMaximum) {
04586                      cmDescriptorCount--;
04587                  }
04588             }
04589             cmDescriptor++;
04590             cmDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmDescriptor + size);
04591         }
04592         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmDescriptor;
04593     }
04594 
04595     <span class="keywordflow">if</span> (cmDescriptorCount == 0) {
04596         *FilteredList = ioList;
04597         <span class="keywordflow">return</span> STATUS_SUCCESS;
04598     }
04599 
04600     <span class="comment">//</span>
04601     <span class="comment">// cmDescriptorCount is the number of BootConfig Descriptors needs.</span>
04602     <span class="comment">//</span>
04603     <span class="comment">// For each IO list Alternative ...</span>
04604     <span class="comment">//</span>
04605 
04606     ioResourceList = ioList-&gt;List;
04607     k = ioList-&gt;AlternativeLists;
04608     <span class="keywordflow">while</span> (--k &gt;= 0) {
04609         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04610         ioResourceDescriptorEnd = ioResourceDescriptor + ioResourceList-&gt;Count;
04611         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04612             ioResourceDescriptor-&gt;Spare1 = 0;
04613             ioResourceDescriptor++;
04614         }
04615         ioResourceList = (PIO_RESOURCE_LIST) ioResourceDescriptorEnd;
04616     }
04617 
04618     ioResourceList = ioList-&gt;List;
04619     k = alternativeLists = ioList-&gt;AlternativeLists;
04620     <span class="keywordflow">while</span> (--k &gt;= 0) {
04621         version = ioResourceList-&gt;Version;
04622         <span class="keywordflow">if</span> (version == 0xffff) {  <span class="comment">// Convert bogus version to valid number</span>
04623             version = 1;
04624         }
04625 
04626         <span class="comment">//</span>
04627         <span class="comment">// We use Version field to store number of BootConfig found.</span>
04628         <span class="comment">// Count field to store new number of descriptor in the alternative list.</span>
04629         <span class="comment">//</span>
04630 
04631         ioResourceList-&gt;Version = 0;
04632         oldCount = ioResourceList-&gt;Count;
04633 
04634         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04635         ioResourceDescriptorEnd = ioResourceDescriptor + ioResourceList-&gt;Count;
04636 
04637         <span class="keywordflow">if</span> (ioResourceDescriptor == ioResourceDescriptorEnd) {
04638 
04639             <span class="comment">//</span>
04640             <span class="comment">// An alternative list with zero descriptor count</span>
04641             <span class="comment">//</span>
04642 
04643             ioResourceList-&gt;Version = 0xffff;  <span class="comment">// Mark it as invalid</span>
04644             ioList-&gt;AlternativeLists--;
04645             <span class="keywordflow">continue</span>;
04646         }
04647 
04648         exactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04649 
04650         <span class="comment">//</span>
04651         <span class="comment">// For each Cm Resource descriptor ... except DevicePrivate and</span>
04652         <span class="comment">// DeviceSpecific...</span>
04653         <span class="comment">//</span>
04654 
04655         cmFullDesc = &amp;CmList-&gt;List[0];
04656         <span class="keywordflow">for</span> (i = 0; i &lt; CmList-&gt;Count; i++) {
04657             cmDescriptor = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04658             <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04659                 size = 0;
04660                 <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04661                 <span class="keywordflow">case</span> CmResourceTypeDevicePrivate:
04662                      <span class="keywordflow">break</span>;
04663                 <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04664                      size = cmDescriptor-&gt;u.DeviceSpecificData.DataSize;
04665                      <span class="keywordflow">break</span>;
04666                 <span class="keywordflow">default</span>:
04667                     <span class="keywordflow">if</span> (cmDescriptor-&gt;Type == CmResourceTypeNull ||
04668                         cmDescriptor-&gt;Type &gt;= CmResourceTypeMaximum) {
04669                         <span class="keywordflow">break</span>;
04670                     }
04671 
04672                     <span class="comment">//</span>
04673                     <span class="comment">// Check CmDescriptor against current Io Alternative list</span>
04674                     <span class="comment">//</span>
04675 
04676                     <span class="keywordflow">for</span> (phase = 0; phase &lt; 2; phase++) {
04677                         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04678                         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04679                             <span class="keywordflow">if</span> ((ioResourceDescriptor-&gt;Type == cmDescriptor-&gt;Type) &amp;&amp;
04680                                 (ioResourceDescriptor-&gt;Spare1 == 0)) {
04681                                 ULONGLONG min1, max1, min2, max2;
04682                                 ULONG len1 = 1, len2 = 1, align1, align2;
04683                                 UCHAR share1, share2;
04684 
04685                                 share2 = ioResourceDescriptor-&gt;ShareDisposition;
04686                                 share1 = cmDescriptor-&gt;ShareDisposition;
04687                                 <span class="keywordflow">if</span> ((share1 == CmResourceShareUndetermined) ||
04688                                     (share1 &gt; CmResourceShareShared)) {
04689                                     share1 = share2;
04690                                 }
04691                                 <span class="keywordflow">if</span> ((share2 == CmResourceShareUndetermined) ||
04692                                     (share2 &gt; CmResourceShareShared)) {
04693                                     share2 = share1;
04694                                 }
04695                                 align1 = align2 = 1;
04696 
04697                                 <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04698                                 <span class="keywordflow">case</span> CmResourceTypePort:
04699                                 <span class="keywordflow">case</span> CmResourceTypeMemory:
04700                                     min1 = cmDescriptor-&gt;u.Port.Start.QuadPart;
04701                                     max1 = cmDescriptor-&gt;u.Port.Start.QuadPart + cmDescriptor-&gt;u.Port.Length - 1;
04702                                     len1 = cmDescriptor-&gt;u.Port.Length;
04703                                     min2 = ioResourceDescriptor-&gt;u.Port.MinimumAddress.QuadPart;
04704                                     max2 = ioResourceDescriptor-&gt;u.Port.MaximumAddress.QuadPart;
04705                                     len2 = ioResourceDescriptor-&gt;u.Port.Length;
04706                                     align2 = ioResourceDescriptor-&gt;u.Port.Alignment;
04707                                     <span class="keywordflow">break</span>;
04708                                 <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04709                                     max1 = min1 = cmDescriptor-&gt;u.Interrupt.Vector;
04710                                     min2 = ioResourceDescriptor-&gt;u.Interrupt.MinimumVector;
04711                                     max2 = ioResourceDescriptor-&gt;u.Interrupt.MaximumVector;
04712                                     <span class="keywordflow">break</span>;
04713                                 <span class="keywordflow">case</span> CmResourceTypeDma:
04714                                     min1 = max1 =cmDescriptor-&gt;u.Dma.Channel;
04715                                     min2 = ioResourceDescriptor-&gt;u.Dma.MinimumChannel;
04716                                     max2 = ioResourceDescriptor-&gt;u.Dma.MaximumChannel;
04717                                     <span class="keywordflow">break</span>;
04718                                 <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04719                                     min1 = cmDescriptor-&gt;u.BusNumber.Start;
04720                                     max1 = cmDescriptor-&gt;u.BusNumber.Start + cmDescriptor-&gt;u.BusNumber.Length - 1;
04721                                     len1 = cmDescriptor-&gt;u.BusNumber.Length;
04722                                     min2 = ioResourceDescriptor-&gt;u.BusNumber.MinBusNumber;
04723                                     max2 = ioResourceDescriptor-&gt;u.BusNumber.MaxBusNumber;
04724                                     len2 = ioResourceDescriptor-&gt;u.BusNumber.Length;
04725                                     <span class="keywordflow">break</span>;
04726                                 <span class="keywordflow">default</span>:
04727                                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
04728                                     <span class="keywordflow">break</span>;
04729                                 }
04730                                 <span class="keywordflow">if</span> (phase == 0) {
04731                                     <span class="keywordflow">if</span> (share1 == share2 &amp;&amp; min2 == min1 &amp;&amp; max2 &gt;= max1 &amp;&amp; len2 &gt;= len1) {
04732 
04733                                         <span class="comment">//</span>
04734                                         <span class="comment">// For phase 0 match, we want near exact match...</span>
04735                                         <span class="comment">//</span>
04736 
04737                                         <span class="keywordflow">if</span> (max2 != max1) {
04738                                             exactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04739                                         }
04740                                         ioResourceList-&gt;Version++;
04741                                         ioResourceDescriptor-&gt;Spare1 = 0x80;
04742                                         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04743                                             PIO_RESOURCE_DESCRIPTOR ioDesc;
04744 
04745                                             ioDesc = ioResourceDescriptor;
04746                                             ioDesc--;
04747                                             <span class="keywordflow">while</span> (ioDesc &gt;= ioResourceList-&gt;Descriptors) {
04748                                                 ioDesc-&gt;Type = CmResourceTypeNull;
04749                                                 ioResourceList-&gt;Count--;
04750                                                 <span class="keywordflow">if</span> (ioDesc-&gt;Option == IO_RESOURCE_ALTERNATIVE) {
04751                                                     ioDesc--;
04752                                                 } <span class="keywordflow">else</span> {
04753                                                     <span class="keywordflow">break</span>;
04754                                                 }
04755                                             }
04756                                         }
04757                                         ioResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
04758                                         ioResourceDescriptor-&gt;Flags = cmDescriptor-&gt;Flags;
04759                                         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type == CmResourceTypePort ||
04760                                             ioResourceDescriptor-&gt;Type == CmResourceTypeMemory) {
04761                                             ioResourceDescriptor-&gt;u.Port.MinimumAddress.QuadPart = min1;
04762                                             ioResourceDescriptor-&gt;u.Port.MaximumAddress.QuadPart = min1 + len2 - 1;
04763                                             ioResourceDescriptor-&gt;u.Port.Alignment = 1;
04764                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type == CmResourceTypeBusNumber) {
04765                                             ioResourceDescriptor-&gt;u.BusNumber.MinBusNumber = (ULONG)min1;
04766                                             ioResourceDescriptor-&gt;u.BusNumber.MaxBusNumber = (ULONG)(min1 + len2 - 1);
04767                                         }
04768                                         ioResourceDescriptor++;
04769                                         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04770                                             <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04771                                                 ioResourceDescriptor-&gt;Type = CmResourceTypeNull;
04772                                                 ioResourceDescriptor++;
04773                                                 ioResourceList-&gt;Count--;
04774                                             } <span class="keywordflow">else</span> {
04775                                                 <span class="keywordflow">break</span>;
04776                                             }
04777                                         }
04778                                         phase = 1;   <span class="comment">// skip phase 1</span>
04779                                         <span class="keywordflow">break</span>;
04780                                     } <span class="keywordflow">else</span> {
04781                                         ioResourceDescriptor++;
04782                                     }
04783                                 } <span class="keywordflow">else</span> {
04784                                     exactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04785                                     <span class="keywordflow">if</span> (share1 == share2 &amp;&amp; min2 &lt;= min1 &amp;&amp; max2 &gt;= max1 &amp;&amp; len2 &gt;= len1 &amp;&amp;
04786                                         (min1 &amp; (align2 - 1)) == 0) {
04787 
04788                                         <span class="comment">//</span>
04789                                         <span class="comment">// Io range covers Cm range ... Change the Io range to what is specified</span>
04790                                         <span class="comment">// in BootConfig.</span>
04791                                         <span class="comment">//</span>
04792                                         <span class="comment">//</span>
04793 
04794                                         <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04795                                         <span class="keywordflow">case</span> CmResourceTypePort:
04796                                         <span class="keywordflow">case</span> CmResourceTypeMemory:
04797                                             ioResourceDescriptor-&gt;u.Port.MinimumAddress.QuadPart = min1;
04798                                             ioResourceDescriptor-&gt;u.Port.MaximumAddress.QuadPart = min1 + len2 - 1;
04799                                             <span class="keywordflow">break</span>;
04800                                         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04801                                         <span class="keywordflow">case</span> CmResourceTypeDma:
04802                                             ioResourceDescriptor-&gt;u.Interrupt.MinimumVector = (ULONG)min1;
04803                                             ioResourceDescriptor-&gt;u.Interrupt.MaximumVector = (ULONG)max1;
04804                                             <span class="keywordflow">break</span>;
04805                                         <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04806                                             ioResourceDescriptor-&gt;u.BusNumber.MinBusNumber = (ULONG)min1;
04807                                             ioResourceDescriptor-&gt;u.BusNumber.MaxBusNumber = (ULONG)(min1 + len2 - 1);
04808                                             <span class="keywordflow">break</span>;
04809                                         }
04810                                         ioResourceList-&gt;Version++;
04811                                         ioResourceDescriptor-&gt;Spare1 = 0x80;
04812                                         ioResourceDescriptor-&gt;Flags = cmDescriptor-&gt;Flags;
04813                                         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04814                                             PIO_RESOURCE_DESCRIPTOR ioDesc;
04815 
04816                                             ioDesc = ioResourceDescriptor;
04817                                             ioDesc--;
04818                                             <span class="keywordflow">while</span> (ioDesc &gt;= ioResourceList-&gt;Descriptors) {
04819                                                 ioDesc-&gt;Type = CmResourceTypeNull;
04820                                                 ioResourceList-&gt;Count--;
04821                                                 <span class="keywordflow">if</span> (ioDesc-&gt;Option == IO_RESOURCE_ALTERNATIVE) {
04822                                                     ioDesc--;
04823                                                 } <span class="keywordflow">else</span> {
04824                                                     <span class="keywordflow">break</span>;
04825                                                 }
04826                                             }
04827                                         }
04828                                         ioResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
04829                                         ioResourceDescriptor++;
04830                                         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04831                                             <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04832                                                 ioResourceDescriptor-&gt;Type = CmResourceTypeNull;
04833                                                 ioResourceList-&gt;Count--;
04834                                                 ioResourceDescriptor++;
04835                                             } <span class="keywordflow">else</span> {
04836                                                 <span class="keywordflow">break</span>;
04837                                             }
04838                                         }
04839                                         <span class="keywordflow">break</span>;
04840                                     } <span class="keywordflow">else</span> {
04841                                         ioResourceDescriptor++;
04842                                     }
04843                                 }
04844                             } <span class="keywordflow">else</span> {
04845                                 ioResourceDescriptor++;
04846                             }
04847                         } <span class="comment">// Don't add any instruction after this ...</span>
04848                     } <span class="comment">// phase</span>
04849                 } <span class="comment">// switch</span>
04850 
04851                 <span class="comment">//</span>
04852                 <span class="comment">// Move to next Cm Descriptor</span>
04853                 <span class="comment">//</span>
04854 
04855                 cmDescriptor++;
04856                 cmDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmDescriptor + size);
04857             }
04858 
04859             <span class="comment">//</span>
04860             <span class="comment">// Move to next Cm List</span>
04861             <span class="comment">//</span>
04862 
04863             cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmDescriptor;
04864         }
04865 
04866         <span class="keywordflow">if</span> (ioResourceList-&gt;Version != (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)cmDescriptorCount) {
04867 
04868             <span class="comment">//</span>
04869             <span class="comment">// If the current alternative list does not cover all the boot config</span>
04870             <span class="comment">// descriptors, make it as invalid.</span>
04871             <span class="comment">//</span>
04872 
04873             ioResourceList-&gt;Version = 0xffff;
04874             ioList-&gt;AlternativeLists--;
04875         } <span class="keywordflow">else</span> {
04876             <span class="keywordflow">if</span> ((ioResourceList-&gt;Count == cmDescriptorCount) ||
04877                 (ioResourceList-&gt;Count == (cmDescriptorCount + 1) &amp;&amp;
04878                  ioResourceList-&gt;Descriptors[0].Type == CmResourceTypeConfigData)) {
04879                 <span class="keywordflow">if</span> (selectedResourceList) {
04880                     ioResourceList-&gt;Version = 0xffff;
04881                     ioList-&gt;AlternativeLists--;
04882                 } <span class="keywordflow">else</span> {
04883                     selectedResourceList = ioResourceList;
04884                     ioResourceDescriptorCount += ioResourceList-&gt;Count;
04885                     ioResourceList-&gt;Version = version;
04886                     <span class="keywordflow">if</span> (exactMatch) {
04887                         *ExactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04888                     }
04889                 }
04890             } <span class="keywordflow">else</span> {
04891                 ioResourceDescriptorCount += ioResourceList-&gt;Count;
04892                 ioResourceList-&gt;Version = version;
04893             }
04894         }
04895         ioResourceList-&gt;Count = oldCount;
04896 
04897         <span class="comment">//</span>
04898         <span class="comment">// Move to next Io alternative list.</span>
04899         <span class="comment">//</span>
04900 
04901         ioResourceList = (PIO_RESOURCE_LIST) ioResourceDescriptorEnd;
04902     }
04903 
04904     <span class="comment">//</span>
04905     <span class="comment">// If there is not any valid alternative, convert CmList to Io list.</span>
04906     <span class="comment">//</span>
04907 
04908     <span class="keywordflow">if</span> (ioList-&gt;AlternativeLists == 0) {
04909          *FilteredList = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, CmList, LCPRI_BOOTCONFIG);
04910         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioList);
04911         <span class="keywordflow">return</span> STATUS_SUCCESS;
04912     }
04913 
04914     <span class="comment">//</span>
04915     <span class="comment">// we have finished filtering the resource requirements list.  Now allocate memory</span>
04916     <span class="comment">// and rebuild a new list.</span>
04917     <span class="comment">//</span>
04918 
04919     size = <span class="keyword">sizeof</span>(IO_RESOURCE_REQUIREMENTS_LIST) +
04920                <span class="keyword">sizeof</span>(IO_RESOURCE_LIST) * (ioList-&gt;AlternativeLists - 1) +
04921                <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR) * (ioResourceDescriptorCount);
04922     newList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, size);
04923     <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04924         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioList);
04925         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04926     }
04927 
04928     <span class="comment">//</span>
04929     <span class="comment">// Walk through the io resource requirements list and pick up any valid descriptor.</span>
04930     <span class="comment">//</span>
04931 
04932     newList-&gt;ListSize = size;
04933     newList-&gt;InterfaceType = CmList-&gt;List-&gt;InterfaceType;
04934     newList-&gt;BusNumber = CmList-&gt;List-&gt;BusNumber;
04935     newList-&gt;SlotNumber = ioList-&gt;SlotNumber;
04936     <span class="keywordflow">if</span> (ioList-&gt;AlternativeLists &gt; 1) {
04937         *ExactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04938     }
04939     newList-&gt;AlternativeLists = ioList-&gt;AlternativeLists;
04940     ioResourceList = ioList-&gt;List;
04941     newIoResourceList = newList-&gt;List;
04942     <span class="keywordflow">while</span> (--alternativeLists &gt;= 0) {
04943         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04944         ioResourceDescriptorEnd = ioResourceDescriptor + ioResourceList-&gt;Count;
04945         <span class="keywordflow">if</span> (ioResourceList-&gt;Version == 0xffff) {
04946             ioResourceList = (PIO_RESOURCE_LIST)ioResourceDescriptorEnd;
04947             <span class="keywordflow">continue</span>;
04948         }
04949         newIoResourceList-&gt;Version = ioResourceList-&gt;Version;
04950         newIoResourceList-&gt;Revision = ioResourceList-&gt;Revision;
04951 
04952         newIoResourceDescriptor = newIoResourceList-&gt;Descriptors;
04953         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type != CmResourceTypeConfigData) {
04954             newIoResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
04955             newIoResourceDescriptor-&gt;Type = CmResourceTypeConfigData;
04956             newIoResourceDescriptor-&gt;ShareDisposition = CmResourceShareShared;
04957             newIoResourceDescriptor-&gt;Flags = 0;
04958             newIoResourceDescriptor-&gt;Spare1 = 0;
04959             newIoResourceDescriptor-&gt;Spare2 = 0;
04960             newIoResourceDescriptor-&gt;u.ConfigData.Priority = LCPRI_BOOTCONFIG;
04961             configDataDescriptor = newIoResourceDescriptor;
04962             newIoResourceDescriptor++;
04963         } <span class="keywordflow">else</span> {
04964             newList-&gt;ListSize -= <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR);
04965             configDataDescriptor = newIoResourceDescriptor;
04966         }
04967 
04968         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04969             <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type != CmResourceTypeNull) {
04970                 *newIoResourceDescriptor = *ioResourceDescriptor;
04971                 newIoResourceDescriptor++;
04972             }
04973             ioResourceDescriptor++;
04974         }
04975         newIoResourceList-&gt;Count = (ULONG)(newIoResourceDescriptor - newIoResourceList-&gt;Descriptors);
04976 
04977         <span class="comment">//if (newIoResourceList-&gt;Count == (cmDescriptorCount + 1)) {</span>
04978         configDataDescriptor-&gt;u.ConfigData.Priority =  LCPRI_BOOTCONFIG;
04979         <span class="comment">//}</span>
04980 
04981         <span class="comment">//</span>
04982         <span class="comment">// Move to next Io alternative list.</span>
04983         <span class="comment">//</span>
04984 
04985         newIoResourceList = (PIO_RESOURCE_LIST) newIoResourceDescriptor;
04986         ioResourceList = (PIO_RESOURCE_LIST) ioResourceDescriptorEnd;
04987     }
04988     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((PUCHAR)newIoResourceList == ((PUCHAR)newList + newList-&gt;ListSize));
04989 
04990     *FilteredList = newList;
04991     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioList);
04992     <span class="keywordflow">return</span> STATUS_SUCCESS;
04993 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="pri_bld/pnpsubs.c::IopFreeUnicodeStringList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopFreeUnicodeStringList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeStringList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StringCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02570">2570</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, and <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05334">IopGetGroupOrderIndex()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02080">IopRegMultiSzToUnicodeStrings()</a>.
<p>
<pre class="fragment"><div>02577                    :
02578 
02579     This routine frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer <span class="keywordflow">for</span> each UNICODE_STRING in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified list
02580     (there are StringCount of them), and then frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory used <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02581     string list itself.
02582 
02583 Arguments:
02584 
02585     UnicodeStringList - Supplies a pointer to an array of UNICODE_STRINGs.
02586 
02587     StringCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of strings in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UnicodeStringList array.
02588 
02589 Returns:
02590 
02591     None.
02592 
02593 --*/
02594 
02595 {
02596     ULONG i;
02597 
02598     <span class="keywordflow">if</span>(UnicodeStringList) {
02599         <span class="keywordflow">for</span>(i = 0; i &lt; StringCount; i++) {
02600             <span class="keywordflow">if</span>(UnicodeStringList[i].Buffer) {
02601                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(UnicodeStringList[i].Buffer);
02602             }
02603         }
02604         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(UnicodeStringList);
02605     }
02606 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="pri_bld/pnpsubs.c::IopGetDeviceInstanceCsConfigFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetDeviceInstanceCsConfigFlags           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Instance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CsConfigFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01471">1471</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01588">IopOpenCurrentHwProfileDeviceInstanceKey()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, and <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, and <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03071">IopIsAnyDeviceInstanceEnabled()</a>.
<p>
<pre class="fragment"><div>01479                    :
01480 
01481     This routine retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> csconfig flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device
01482     which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance number under ServiceKeyName\Enum.
01483 
01484 Arguments:
01485 
01486     ServiceKeyName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01487         system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)
01488         that caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load.
01489 
01490     Instance - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance value under ServiceKeyName\Enum key
01491 
01492     CsConfigFlags - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's CsConfigFlags
01493 
01494 Return Value:
01495 
01496     status
01497 
01498 --*/
01499 
01500 {
01501     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01502     HANDLE handle;
01503     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01504 
01505     *CsConfigFlags = 0;
01506 
01507     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a11">IopOpenCurrentHwProfileDeviceInstanceKey</a>(&amp;handle,
01508                                                       ServiceKeyName,
01509                                                       Instance,
01510                                                       KEY_READ,
01511                                                       FALSE
01512                                                      );
01513     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01514         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
01515                                      REGSTR_VALUE_CSCONFIG_FLAGS,
01516                                      &amp;keyValueInformation
01517                                     );
01518         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01519             <span class="keywordflow">if</span>((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
01520                (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
01521                 *CsConfigFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01522             }
01523             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01524         }
01525         ZwClose(handle);
01526     }
01527     <span class="keywordflow">return</span> status;
01528 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="pri_bld/pnpsubs.c::IopGetDeviceResourcesFromRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetDeviceResourcesFromRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Preference</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03967">3967</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03776">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04170">IopReadDeviceConfiguration()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00740">QUERY_RESOURCE_LIST</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00743">REGISTRY_ALLOC_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00747">REGISTRY_BASIC_CONFIGVECTOR</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00745">REGISTRY_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00744">REGISTRY_FORCED_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00746">REGISTRY_OVERRIDE_CONFIGVECTOR</a>, and <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>.
<p>
<pre class="fragment"><div>03977                    :
03978 
03979     This routine determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources decoded by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device specified.
03980     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a madeup device, we will <span class="keywordflow">try</span> to read <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources
03981     from registry.  Otherwise, we need to traverse <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> internal assigned resource
03982     list to compose <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource list.
03983 
03984 Arguments:
03985 
03986     DeviceObject - supplies a pointer to a device object whose registry
03987         values are to be cleaned up.
03988 
03989     ResourceType - 0 <span class="keywordflow">for</span> CM_RESOURCE_LIST and 1 <span class="keywordflow">for</span> IO_RESOURCE_REQUIREMENTS_LIS
03990 
03991     Flags - specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> preference.
03992 
03993     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Specified a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> required resources.
03994 
03995     Length - Specified a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource structure.
03996 
03997 Return Value:
03998 
03999     status
04000 
04001 --*/
04002 
04003 {
04004     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
04005     HANDLE handle, handlex;
04006     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04007     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04008     PCM_RESOURCE_LIST cmResource;
04009     PIO_RESOURCE_REQUIREMENTS_LIST ioResource;
04010     ULONG length;
04011     UNICODE_STRING unicodeName;
04012     PWCHAR valueName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04013 
04014     *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04015     *Length = 0;
04016 
04017     <span class="comment">//</span>
04018     <span class="comment">// Open the LogConfig key of the device instance.</span>
04019     <span class="comment">//</span>
04020 
04021     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(DeviceObject, &amp;handlex, KEY_READ);
04022     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04023         <span class="keywordflow">return</span> status;
04024     }
04025 
04026     <span class="keywordflow">if</span> (ResourceType == <a class="code" href="../../d9/d0/pnpiop_8h.html#a60">QUERY_RESOURCE_LIST</a>) {
04027 
04028         <span class="comment">//</span>
04029         <span class="comment">// Caller is asking for CM_RESOURCE_LIST</span>
04030         <span class="comment">//</span>
04031 
04032         <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a62">REGISTRY_ALLOC_CONFIG</a>) {
04033 
04034             <span class="comment">//</span>
04035             <span class="comment">// Try alloc config first</span>
04036             <span class="comment">//</span>
04037 
04038             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
04039             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
04040                                         handlex,
04041                                         &amp;unicodeName,
04042                                         KEY_READ,
04043                                         FALSE
04044                                         );
04045             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04046                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a> (handle, REGISTRY_ALLOC_CONFIG, (PCM_RESOURCE_LIST *)Resource, Length);
04047                 ZwClose(handle);
04048                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04049                     ZwClose(handlex);
04050                     <span class="keywordflow">return</span> status;
04051                 }
04052             }
04053         }
04054 
04055         handle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04056         <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a63">REGISTRY_FORCED_CONFIG</a>) {
04057 
04058             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
04059             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
04060                                         handlex,
04061                                         &amp;unicodeName,
04062                                         KEY_READ,
04063                                         FALSE
04064                                         );
04065             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04066                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a> (handle, REGISTRY_FORCED_CONFIG, (PCM_RESOURCE_LIST *)Resource, Length);
04067                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04068                     ZwClose(handle);
04069                     ZwClose(handlex);
04070                     <span class="keywordflow">return</span> status;
04071                 }
04072             } <span class="keywordflow">else</span> {
04073                 ZwClose(handlex);
04074                 <span class="keywordflow">return</span> status;
04075             }
04076         }
04077         <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a64">REGISTRY_BOOT_CONFIG</a>) {
04078 
04079             <span class="comment">//</span>
04080             <span class="comment">// Try alloc config first</span>
04081             <span class="comment">//</span>
04082 
04083             <span class="keywordflow">if</span> (handle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04084                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
04085                 status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
04086                                             handlex,
04087                                             &amp;unicodeName,
04088                                             KEY_READ,
04089                                             FALSE
04090                                             );
04091                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04092                     ZwClose(handlex);
04093                     <span class="keywordflow">return</span> status;
04094                 }
04095             }
04096             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a> (handle, REGISTRY_BOOT_CONFIG, (PCM_RESOURCE_LIST *)Resource, Length);
04097         }
04098         <span class="keywordflow">if</span> (handle) {
04099             ZwClose(handle);
04100         }
04101     } <span class="keywordflow">else</span> {
04102 
04103         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
04104         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
04105                                     handlex,
04106                                     &amp;unicodeName,
04107                                     KEY_READ,
04108                                     FALSE
04109                                     );
04110         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04111 
04112             <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a65">REGISTRY_OVERRIDE_CONFIGVECTOR</a>) {
04113                 valueName = REGSTR_VALUE_OVERRIDE_CONFIG_VECTOR;
04114             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a66">REGISTRY_BASIC_CONFIGVECTOR</a>) {
04115                 valueName = REGSTR_VALUE_BASIC_CONFIG_VECTOR;
04116             }
04117             <span class="keywordflow">if</span> (valueName) {
04118 
04119                 <span class="comment">//</span>
04120                 <span class="comment">// Try to read device's configuration vector</span>
04121                 <span class="comment">//</span>
04122 
04123                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
04124                                               valueName,
04125                                               &amp;keyValueInformation);
04126                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04127 
04128                     <span class="comment">//</span>
04129                     <span class="comment">// Try to read what caller wants.</span>
04130                     <span class="comment">//</span>
04131 
04132                     <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_RESOURCE_REQUIREMENTS_LIST) &amp;&amp;
04133                         (keyValueInformation-&gt;DataLength != 0)) {
04134 
04135                         *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
04136                                                    keyValueInformation-&gt;DataLength);
04137                         <span class="keywordflow">if</span> (*Resource) {
04138                             PIO_RESOURCE_REQUIREMENTS_LIST ioResource;
04139 
04140                             *Length = keyValueInformation-&gt;DataLength;
04141                             RtlMoveMemory(*Resource,
04142                                           <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
04143                                           keyValueInformation-&gt;DataLength);
04144 
04145                             <span class="comment">//</span>
04146                             <span class="comment">// Process the io resource requirements list to change undefined</span>
04147                             <span class="comment">// interface type to our default type.</span>
04148                             <span class="comment">//</span>
04149 
04150                             ioResource = *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
04151                             <span class="keywordflow">if</span> (ioResource-&gt;InterfaceType == InterfaceTypeUndefined) {
04152                                 ioResource-&gt;BusNumber = 0;
04153                                 ioResource-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
04154                             }
04155                         } <span class="keywordflow">else</span> {
04156                             status = STATUS_INVALID_PARAMETER_2;
04157                         }
04158                     }
04159                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04160                 }
04161             }
04162             ZwClose(handle);
04163         }
04164     }
04165     ZwClose(handlex);
04166     <span class="keywordflow">return</span> status;
04167 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="pri_bld/pnpsubs.c::IopGetGroupOrderIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> IopGetGroupOrderIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ServiceHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05221">5221</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02570">IopFreeUnicodeStringList()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01907">IopRegMultiSzToUnicodeStrings()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00671">NO_MORE_GROUP</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>05227                    :
05228 
05229     This routine reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service key, finds its position in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05230     ServiceOrderList.  If ServiceHandle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> or unrecognized group value, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns
05231     a value with <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> group order + 1.
05232     <span class="keywordflow">if</span> any.
05233 
05234 Parameters:
05235 
05236     ServiceHandle - supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service key.
05237 
05238 Return Value:
05239 
05240     group order index.
05241 
05242 --*/
05243 
05244 {
05245     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05246     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
05247     UNICODE_STRING *groupTable, group;
05248     HANDLE handle;
05249     ULONG count, index;
05250 
05251     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05252 
05253     <span class="comment">//</span>
05254     <span class="comment">// Open System\CurrentControlSet\Control\ServiceOrderList</span>
05255     <span class="comment">//</span>
05256 
05257     PiWstrToUnicodeString(&amp;group, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\ServiceGroupOrder"</span>);
05258     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
05259                                 NULL,
05260                                 &amp;group,
05261                                 KEY_READ,
05262                                 FALSE
05263                                 );
05264 
05265     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
05266         <span class="keywordflow">return</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
05267     }
05268 
05269     <span class="comment">//</span>
05270     <span class="comment">// Read and build a unicode string array containing all the group names.</span>
05271     <span class="comment">//</span>
05272 
05273     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
05274                                   L<span class="stringliteral">"List"</span>,
05275                                   &amp;keyValueInformation);
05276     ZwClose(handle);
05277     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05278 
05279         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_MULTI_SZ) &amp;&amp;
05280             (keyValueInformation-&gt;DataLength != 0)) {
05281              status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a13">IopRegMultiSzToUnicodeStrings</a>(keyValueInformation, &amp;groupTable, &amp;count);
05282              <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05283                  <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05284                  <span class="keywordflow">return</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
05285              }
05286         }
05287         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05288     }
05289 
05290     <span class="keywordflow">if</span> (ServiceHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05291         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(groupTable, count);
05292         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(count + 1);
05293     }
05294 
05295 
05296     <span class="comment">//</span>
05297     <span class="comment">// Read service key's Group value</span>
05298     <span class="comment">//</span>
05299 
05300     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (ServiceHandle,
05301                                   L<span class="stringliteral">"Group"</span>,
05302                                   &amp;keyValueInformation);
05303     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05304 
05305         <span class="comment">//</span>
05306         <span class="comment">// Try to read what caller wants.</span>
05307         <span class="comment">//</span>
05308 
05309         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_SZ) &amp;&amp;
05310             (keyValueInformation-&gt;DataLength != 0)) {
05311             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;group,
05312                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
05313                                            keyValueInformation-&gt;DataLength
05314                                            );
05315         }
05316     } <span class="keywordflow">else</span> {
05317 
05318         <span class="comment">//</span>
05319         <span class="comment">// If we failed to read the Group value, or no Group value...</span>
05320         <span class="comment">//</span>
05321 
05322         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(groupTable, count);
05323         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)count;
05324     }
05325 
05326     index = 0;
05327     <span class="keywordflow">for</span> (index = 0; index &lt; count; index++) {
05328         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;group, &amp;groupTable[index], TRUE)) {
05329             <span class="keywordflow">break</span>;
05330         }
05331     }
05332     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05333     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(groupTable, count);
05334     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)index;
05335 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="pri_bld/pnpsubs.c::IopIsAnyDeviceInstanceEnabled" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsAnyDeviceInstanceEnabled           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE ServiceHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LegacyIncluded</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03071">3071</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01471">IopGetDeviceInstanceCsConfigFlags()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00828">IopIsDevNodeProblem</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00964">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00753">IopPrepareDriverLoading()</a>.
<p>
<pre class="fragment"><div>03079                    :
03080 
03081     This routine checks <span class="keywordflow">if</span> any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devices instances <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> turned on <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
03082     service. This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> Pnp Driver <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> temporary function to support
03083     SUR.
03084 
03085 Arguments:
03086 
03087     ServiceKeyName - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service key unicode name
03088 
03089     ServiceHandle - Optionally supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service key to be checked.
03090 
03091     LegacyIncluded - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, a legacy device instance key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> counted as a device instance.
03092                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, a legacy device instance key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not counted.
03093 
03094 Returns:
03095 
03096     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> BOOLEAN value.
03097 
03098 --*/
03099 
03100 {
03101     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03102     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03103     HANDLE serviceEnumHandle, handle, controlHandle;
03104     ULONG i, count, deviceFlags;
03105     UNICODE_STRING unicodeName;
03106     BOOLEAN enabled, setProblem, closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03107     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> physicalDeviceObject;
03108     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03109 
03110     <span class="comment">//</span>
03111     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
03112     <span class="comment">//</span>
03113 
03114     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(ServiceHandle)) {
03115         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
03116                                         KEY_READ,
03117                                         &amp;ServiceHandle,
03118                                         &amp;serviceEnumHandle,
03119                                         FALSE
03120                                         );
03121         closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03122     } <span class="keywordflow">else</span> {
03123         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_ENUM);
03124         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;serviceEnumHandle,
03125                                     ServiceHandle,
03126                                     &amp;unicodeName,
03127                                     KEY_READ,
03128                                     FALSE
03129                                     );
03130     }
03131     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03132 
03133         <span class="comment">//</span>
03134         <span class="comment">// No Service Enum key? no device instance.  Return FALSE.</span>
03135         <span class="comment">//</span>
03136 
03137         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03138     }
03139 
03140     <span class="comment">//</span>
03141     <span class="comment">// Find out how many device instances listed in the ServiceName's</span>
03142     <span class="comment">// Enum key.</span>
03143     <span class="comment">//</span>
03144 
03145     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( serviceEnumHandle,
03146                                    REGSTR_VALUE_COUNT,
03147                                    &amp;keyValueInformation
03148                                    );
03149     ZwClose(serviceEnumHandle);
03150     count = 0;
03151     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03152         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03153             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03154 
03155             count = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03156         }
03157         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03158     }
03159     <span class="keywordflow">if</span> (count == 0) {
03160         <span class="keywordflow">if</span> (closeHandle) {
03161             ZwClose(ServiceHandle);
03162         }
03163         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03164     }
03165 
03166     <span class="comment">//</span>
03167     <span class="comment">// Walk through each registered device instance to check it is enabled.</span>
03168     <span class="comment">//</span>
03169 
03170     enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03171     <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
03172 
03173         <span class="comment">//</span>
03174         <span class="comment">// Get device instance handle.  If it fails, we will skip this device</span>
03175         <span class="comment">// instance.</span>
03176         <span class="comment">//</span>
03177 
03178         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a> (
03179                      ServiceHandle,
03180                      NULL,
03181                      i,
03182                      NULL,
03183                      &amp;handle,
03184                      KEY_ALL_ACCESS
03185                      );
03186         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03187             <span class="keywordflow">continue</span>;
03188         }
03189 
03190         physicalDeviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(handle, NULL);
03191         <span class="keywordflow">if</span> (physicalDeviceObject) {
03192             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)physicalDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03193             <span class="keywordflow">if</span> (deviceNode &amp;&amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_DISABLED)) {
03194                 ZwClose(handle);
03195                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
03196                 <span class="keywordflow">continue</span>;
03197             }
03198         }
03199 
03200         <span class="comment">//</span>
03201         <span class="comment">// Check if the device instance has been disabled.</span>
03202         <span class="comment">// First check global flag: CONFIGFLAG and then CSCONFIGFLAG.</span>
03203         <span class="comment">//</span>
03204 
03205         deviceFlags = 0;
03206         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
03207                                      REGSTR_VALUE_CONFIG_FLAGS,
03208                                      &amp;keyValueInformation);
03209         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03210             <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03211                 (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03212 
03213                 deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03214             }
03215             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03216         }
03217 
03218         <span class="keywordflow">if</span> (deviceFlags &amp; CONFIGFLAG_DISABLED) {
03219 
03220             <span class="comment">//</span>
03221             <span class="comment">// Convert this flag into the hardware profile-specific version, so it'll</span>
03222             <span class="comment">// look the same as the CsConfigFlags we retrieve below.</span>
03223             <span class="comment">//</span>
03224 
03225             deviceFlags = CSCONFIGFLAG_DISABLED;
03226 
03227         } <span class="keywordflow">else</span> {
03228 
03229             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a9">IopGetDeviceInstanceCsConfigFlags</a>(
03230                          ServiceKeyName,
03231                          i,
03232                          &amp;deviceFlags
03233                          );
03234 
03235             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03236                 deviceFlags = 0;
03237             }
03238         }
03239 
03240         <span class="comment">//</span>
03241         <span class="comment">// If the device is disabled (either globally, or specifically for this</span>
03242         <span class="comment">// hardware profile), then mark the devnode as DNF_DISABLED.</span>
03243         <span class="comment">//</span>
03244 
03245         <span class="keywordflow">if</span> ((deviceFlags &amp; CSCONFIGFLAG_DISABLED) || (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_START)) {
03246 
03247             <span class="keywordflow">if</span> (deviceNode) {
03248                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice</a>(deviceNode, handle);
03249             }
03250         }
03251 
03252         <span class="keywordflow">if</span> (physicalDeviceObject) {
03253             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
03254         }
03255 
03256         <span class="comment">//</span>
03257         <span class="comment">// Finally, we need to set the STATUSFLAGS of the device instance to</span>
03258         <span class="comment">// indicate if the driver is successfully started.</span>
03259         <span class="comment">//</span>
03260 
03261         <span class="keywordflow">if</span> (!(deviceFlags &amp; (CSCONFIGFLAG_DISABLED | CSCONFIGFLAG_DO_NOT_CREATE | CSCONFIGFLAG_DO_NOT_START))) {
03262 
03263             ULONG legacy;
03264 
03265             <span class="comment">//</span>
03266             <span class="comment">// Check should legacy instance key be counted as an enabled device</span>
03267             <span class="comment">//</span>
03268 
03269             <span class="keywordflow">if</span> (LegacyIncluded == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03270 
03271                 <span class="comment">//</span>
03272                 <span class="comment">// The legacy variable must be initialized to zero.  Because the device</span>
03273                 <span class="comment">// instance key may be an enumerated device.  In this case, there is no</span>
03274                 <span class="comment">// legacy value name.</span>
03275                 <span class="comment">//</span>
03276 
03277                 legacy = 0;
03278                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
03279                                              REGSTR_VALUE_LEGACY,
03280                                              &amp;keyValueInformation
03281                                              );
03282                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03283                     <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03284                         (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03285                         legacy = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03286                     }
03287                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03288                 }
03289             } <span class="keywordflow">else</span> {
03290                 legacy = 0;
03291             }
03292 
03293             <span class="keywordflow">if</span> (legacy == 0) {
03294 
03295                 <span class="comment">//</span>
03296                 <span class="comment">// Mark that the driver has at least a device instance to work with.</span>
03297                 <span class="comment">//</span>
03298 
03299                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
03300                 status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;controlHandle,
03301                                             handle,
03302                                             &amp;unicodeName,
03303                                             KEY_ALL_ACCESS,
03304                                             TRUE
03305                                             );
03306                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03307                     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_ACTIVESERVICE);
03308                     ZwSetValueKey(
03309                                 controlHandle,
03310                                 &amp;unicodeName,
03311                                 TITLE_INDEX_VALUE,
03312                                 REG_SZ,
03313                                 ServiceKeyName-&gt;Buffer,
03314                                 ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
03315                                 );
03316 
03317                     ZwClose(controlHandle);
03318                 }
03319                 enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03320             }
03321         }
03322         ZwClose(handle);
03323     }
03324 
03325     <span class="keywordflow">if</span> (closeHandle) {
03326         ZwClose(ServiceHandle);
03327     }
03328     <span class="keywordflow">return</span> enabled;
03329 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="pri_bld/pnpsubs.c::IopIsDeviceInstanceEnabled" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsDeviceInstanceEnabled           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceInstanceHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceInstance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DisableIfEnabled</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03332">3332</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00179">CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00828">IopIsDevNodeProblem</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01516">IopGetDriverDeviceListWorker()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05138">IopProcessNewProfileStateCallback()</a>.
<p>
<pre class="fragment"><div>03340                    :
03341 
03342     This routine checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified devices instances <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> enabled.
03343 
03344 Arguments:
03345 
03346     DeviceInstanceHandle - Optionally supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance
03347         key to be checked.
03348 
03349     DeviceInstance - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance key unicode name.  Caller
03350         must at least specified DeviceInstanceHandle or DeviceInstance.
03351 
03352 Returns:
03353 
03354     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> BOOLEAN value.
03355 
03356 --*/
03357 
03358 {
03359     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03360     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03361     HANDLE handle, handle1;
03362     ULONG deviceFlags;
03363     BOOLEAN enabled, closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03364     UNICODE_STRING unicodeString;
03365     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03366     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;;
03367 
03368     <span class="comment">//</span>
03369     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
03370     <span class="comment">//</span>
03371 
03372     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(DeviceInstanceHandle)) {
03373         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03374                                     NULL,
03375                                     &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
03376                                     KEY_READ,
03377                                     FALSE
03378                                     );
03379 
03380         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03381 
03382             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a> (
03383                                     DeviceInstanceHandle,
03384                                     handle,
03385                                     DeviceInstance,
03386                                     KEY_READ,
03387                                     FALSE
03388                                     );
03389             ZwClose(handle);
03390         }
03391 
03392         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03393             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03394         }
03395         closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03396     }
03397 
03398     enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03399 
03400     <span class="comment">//</span>
03401     <span class="comment">// First check the device node</span>
03402     <span class="comment">//</span>
03403 
03404     deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(DeviceInstanceHandle, NULL);
03405     <span class="keywordflow">if</span> (deviceObject) {
03406         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03407         <span class="keywordflow">if</span> (deviceNode &amp;&amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_DISABLED)) {
03408             enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03409             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03410         }
03411     }
03412 
03413     <span class="comment">//</span>
03414     <span class="comment">// Check if the device instance has been disabled.</span>
03415     <span class="comment">// First check global flag: CONFIGFLAG and then CSCONFIGFLAG.</span>
03416     <span class="comment">//</span>
03417 
03418     deviceFlags = 0;
03419     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(DeviceInstanceHandle,
03420                                  REGSTR_VALUE_CONFIG_FLAGS,
03421                                  &amp;keyValueInformation);
03422     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03423         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03424             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03425             deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03426         }
03427         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03428     }
03429     <span class="keywordflow">if</span> (!(deviceFlags &amp; CONFIGFLAG_DISABLED)) {
03430         enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03431 
03432         <span class="comment">//</span>
03433         <span class="comment">// See if we can open current hardware profile</span>
03434         <span class="comment">//</span>
03435         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle1,
03436                                     NULL,
03437                                     &amp;CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent,
03438                                     KEY_READ,
03439                                     FALSE
03440                                     );
03441         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; DeviceInstance != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03442 
03443             <span class="comment">//</span>
03444             <span class="comment">// Now, we must open the System\CCS\Enum key under this.</span>
03445             <span class="comment">//</span>
03446             <span class="comment">//</span>
03447             <span class="comment">// Open system\CurrentControlSet under current hardware profile key</span>
03448             <span class="comment">//</span>
03449 
03450             PiWstrToUnicodeString(&amp;unicodeString, REGSTR_PATH_CURRENTCONTROLSET);
03451             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03452                                         handle1,
03453                                         &amp;unicodeString,
03454                                         KEY_READ,
03455                                         FALSE
03456                                         );
03457             ZwClose(handle1);
03458             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03459                 PiWstrToUnicodeString(&amp;unicodeString, REGSTR_KEY_ENUM);
03460                 status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle1,
03461                                             handle,
03462                                             &amp;unicodeString,
03463                                             KEY_READ,
03464                                             FALSE
03465                                             );
03466                 ZwClose(handle);
03467                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03468                     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03469                                                 handle1,
03470                                                 DeviceInstance,
03471                                                 KEY_READ,
03472                                                 FALSE
03473                                                 );
03474                     ZwClose(handle1);
03475                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03476                         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(
03477                                         handle,
03478                                         REGSTR_VALUE_CSCONFIG_FLAGS,
03479                                         &amp;keyValueInformation
03480                                         );
03481                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03482                             <span class="keywordflow">if</span>((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03483                                (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03484                                deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03485                             }
03486                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03487                         }
03488                         ZwClose(handle);
03489                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03490                             <span class="keywordflow">if</span> ((deviceFlags &amp; CSCONFIGFLAG_DISABLED) ||
03491                                 (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_CREATE) ||
03492                                 (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_START)) {
03493                                 enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03494                             }
03495                         }
03496                     }
03497                 }
03498             }
03499         }
03500     } <span class="keywordflow">else</span> {
03501         enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03502     }
03503 
03504     <span class="comment">//</span>
03505     <span class="comment">// If the device is disabled and has device node associated with it.</span>
03506     <span class="comment">// disable the device.</span>
03507     <span class="comment">//</span>
03508 
03509     <span class="keywordflow">if</span> (enabled == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; deviceNode &amp;&amp; DisableIfEnabled) {
03510         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice</a>(deviceNode, DeviceInstanceHandle);
03511     }
03512 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
03513     <span class="keywordflow">if</span> (deviceObject) {
03514         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);
03515     }
03516     <span class="keywordflow">if</span> (closeHandle) {
03517         ZwClose(DeviceInstanceHandle);
03518     }
03519     <span class="keywordflow">return</span> enabled;
03520 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="pri_bld/pnpsubs.c::IopIsDuplicatedDevices" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsDuplicatedDevices           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>Configuration1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>Configuration2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo1&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo2&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02384">2384</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02286">IopIsReportedAlready()</a>.
<p>
<pre class="fragment"><div>02393                    :
02394 
02395     This routine compares two set of configurations and bus information to
02396     determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same device.  If BusInfo1 and
02397     BusInfo2 both are absent, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> means caller wants to compare <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> raw
02398     resources.
02399 
02400 Arguments:
02401 
02402     Configuration1 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first set of resource.
02403 
02404     Configuration2 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second set of resource.
02405 
02406     BusInfo1 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first set of bus information.
02407 
02408     BusInfo2 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second set of bus information.
02409 
02410 Return Value:
02411 
02412     returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two set of resources indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same device;
02413     otherwise a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02414 
02415 --*/
02416 
02417 {
02418     PCM_PARTIAL_RESOURCE_LIST list1, list2;
02419     PCM_PARTIAL_RESOURCE_DESCRIPTOR descriptor1, descriptor2;
02420 
02421     ULONG i, j;
02422     ULONG pass = 0;
02423 
02424     <span class="comment">//</span>
02425     <span class="comment">// The BusInfo for both resources must be both present or not present.</span>
02426     <span class="comment">//</span>
02427 
02428     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT(BusInfo1) &amp;&amp; !ARGUMENT_PRESENT(BusInfo2)) ||
02429         (!ARGUMENT_PRESENT(BusInfo1) &amp;&amp; ARGUMENT_PRESENT(BusInfo2))) {
02430 
02431         <span class="comment">//</span>
02432         <span class="comment">// Unable to determine.</span>
02433         <span class="comment">//</span>
02434 
02435         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02436     }
02437 
02438     <span class="comment">//</span>
02439     <span class="comment">// Next check resources used by the two devices.</span>
02440     <span class="comment">// Currently, we *only* check the Io ports.</span>
02441     <span class="comment">//</span>
02442 
02443     <span class="keywordflow">if</span> (Configuration1-&gt;Count == 0 || Configuration2-&gt;Count == 0) {
02444 
02445         <span class="comment">//</span>
02446         <span class="comment">// If any one of the configuration data is empty, we assume</span>
02447         <span class="comment">// the devices are not duplicates.</span>
02448         <span class="comment">//</span>
02449 
02450         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02451     }
02452 
02453 RedoScan:
02454 
02455     list1 = &amp;(Configuration1-&gt;List[0].PartialResourceList);
02456     list2 = &amp;(Configuration2-&gt;List[0].PartialResourceList);
02457 
02458     <span class="keywordflow">for</span>(i = 0, descriptor1 = list1-&gt;PartialDescriptors;
02459         i &lt; list1-&gt;Count;
02460         i++, descriptor1++) {
02461 
02462         <span class="comment">//</span>
02463         <span class="comment">// If this is an i/o port or a memory range then look for a match</span>
02464         <span class="comment">// in the other list.</span>
02465         <span class="comment">//</span>
02466 
02467         <span class="keywordflow">if</span>((descriptor1-&gt;Type == CmResourceTypePort) ||
02468            (descriptor1-&gt;Type == CmResourceTypeMemory)) {
02469 
02470             <span class="keywordflow">for</span>(j = 0, descriptor2 = list2-&gt;PartialDescriptors;
02471                 j &lt; list2-&gt;Count;
02472                 j++, descriptor2++) {
02473 
02474                 <span class="comment">//</span>
02475                 <span class="comment">// If the types match then check to see if both addresses</span>
02476                 <span class="comment">// match as well.  If bus info was provided then go ahead</span>
02477                 <span class="comment">// and translate the ranges first.</span>
02478                 <span class="comment">//</span>
02479 
02480                 <span class="keywordflow">if</span>(descriptor1-&gt;Type == descriptor2-&gt;Type) {
02481 
02482                     PHYSICAL_ADDRESS range1, range1Translated;
02483                     PHYSICAL_ADDRESS range2, range2Translated;
02484                     ULONG range1IoSpace, range2IoSpace;
02485 
02486                     range1 = descriptor1-&gt;u.Generic.Start;
02487                     range2 = descriptor2-&gt;u.Generic.Start;
02488 
02489                     <span class="keywordflow">if</span>((range1.QuadPart == 0) ||
02490                        (BusInfo1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02491                        (<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>(
02492                             BusInfo1-&gt;BusType,
02493                             BusInfo1-&gt;BusNumber,
02494                             range1,
02495                             &amp;range1IoSpace,
02496                             &amp;range1Translated) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02497 
02498                         range1Translated = range1;
02499                         range1IoSpace =
02500                             (descriptor1-&gt;Type == CmResourceTypePort) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> :
02501                                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02502                     }
02503 
02504                     <span class="keywordflow">if</span>((range2.QuadPart == 0) ||
02505                        (BusInfo2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02506                        (<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>(
02507                             BusInfo2-&gt;BusType,
02508                             BusInfo2-&gt;BusNumber,
02509                             range2,
02510                             &amp;range2IoSpace,
02511                             &amp;range2Translated) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02512 
02513                         range2Translated = range2;
02514                         range2IoSpace =
02515                             (descriptor2-&gt;Type == CmResourceTypePort) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> :
02516                                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02517                     }
02518 
02519                     <span class="comment">//</span>
02520                     <span class="comment">// If the ranges are in the same space and start at the</span>
02521                     <span class="comment">// same location then break out and go on to the next</span>
02522                     <span class="comment">// range</span>
02523                     <span class="comment">//</span>
02524 
02525                     <span class="keywordflow">if</span>((range1Translated.QuadPart == range2Translated.QuadPart) &amp;&amp;
02526                        (range1IoSpace == range2IoSpace)) {
02527 
02528                         <span class="keywordflow">break</span>;
02529                     }
02530                 }
02531             }
02532 
02533             <span class="comment">//</span>
02534             <span class="comment">// If we made it all the way through the resource list without</span>
02535             <span class="comment">// finding a match then these are not duplicates.</span>
02536             <span class="comment">//</span>
02537 
02538             <span class="keywordflow">if</span>(j == list2-&gt;Count) {
02539                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02540             }
02541         }
02542     }
02543 
02544     <span class="comment">//</span>
02545     <span class="comment">// If every resource in list 1 exists in list 2 then we also need to make</span>
02546     <span class="comment">// sure that every resource in list 2 exists in list 1.</span>
02547     <span class="comment">//</span>
02548 
02549     <span class="keywordflow">if</span>(pass == 0) {
02550 
02551         PVOID tmp ;
02552 
02553         tmp = Configuration2;
02554         Configuration2 = Configuration1;
02555         Configuration1 = tmp;
02556 
02557         tmp = BusInfo2;
02558         BusInfo2 = BusInfo1;
02559         BusInfo1 = tmp;
02560 
02561         pass = 1;
02562 
02563         <span class="keywordflow">goto</span> RedoScan;
02564     }
02565 
02566     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02567 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="pri_bld/pnpsubs.c::IopIsLegacyDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsLegacyDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05177">5177</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01300">DRVO_LEGACY_DRIVER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.
<p>
<pre class="fragment"><div>05183                    :
05184 
05185     This routine checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object specifies a legacy driver.
05186 
05187 Arguments:
05188 
05189     DriverObject - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object to be checked.
05190 
05191 Return Value:
05192 
05193     BOOLEAN
05194 
05195 --*/
05196 
05197 {
05198 
05199     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05200 
05201     <span class="comment">//</span>
05202     <span class="comment">// If AddDevice entry is not empty it is a wdm driver</span>
05203     <span class="comment">//</span>
05204 
05205     <span class="keywordflow">if</span> (DriverObject-&gt;DriverExtension-&gt;AddDevice) {
05206         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05207     }
05208 
05209     <span class="comment">//</span>
05210     <span class="comment">// Else if LEGACY flag is set in the driver object, it's a legacy driver.</span>
05211     <span class="comment">//</span>
05212 
05213     <span class="keywordflow">if</span> (DriverObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a144">DRVO_LEGACY_DRIVER</a>) {
05214         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05215     } <span class="keywordflow">else</span> {
05216         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05217     }
05218 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="pri_bld/pnpsubs.c::IopMarkDuplicateDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopMarkDuplicateDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetInstance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceInstance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02297">2297</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00964">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>.
<p>
<pre class="fragment"><div>02306                    :
02307 
02308     This routine marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance specified by TargetKeyName and TargetInstance
02309     as DuplicateOf <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device specified by SourceKeyName and SourceInstance.
02310 
02311 Arguments:
02312 
02313     TargetKeyName - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of service key which will be marked
02314         as duplicate.
02315 
02316     TargetInstance - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target device.
02317 
02318     SourceKeyName - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of service key.
02319 
02320     SourceInstance - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source device.
02321 
02322 
02323 Returns:
02324 
02325     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
02326 
02327 --*/
02328 
02329 {
02330     HANDLE handle;
02331     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02332     UNICODE_STRING sourceDeviceString, unicodeValueName;
02333 
02334     <span class="comment">//</span>
02335     <span class="comment">// Open the handle of the target device instance.</span>
02336     <span class="comment">//</span>
02337 
02338     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a>(
02339                        NULL,
02340                        TargetKeyName,
02341                        TargetInstance,
02342                        NULL,
02343                        &amp;handle,
02344                        0
02345                        );
02346     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02347         <span class="keywordflow">return</span> status;
02348     }
02349 
02350     <span class="comment">//</span>
02351     <span class="comment">// Get the name of the source device instance</span>
02352     <span class="comment">//</span>
02353 
02354     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a>(
02355                        NULL,
02356                        SourceKeyName,
02357                        SourceInstance,
02358                        &amp;sourceDeviceString,
02359                        NULL,
02360                        0
02361                        );
02362     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02363         <span class="keywordflow">return</span> status;
02364     }
02365 
02366     <span class="comment">//</span>
02367     <span class="comment">// Write the name of the source device to the DuplicateOf value entry of</span>
02368     <span class="comment">// target device key.</span>
02369     <span class="comment">//</span>
02370 
02371     PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_DUPLICATEOF);
02372     status = ZwSetValueKey(
02373                 handle,
02374                 &amp;unicodeValueName,
02375                 TITLE_INDEX_VALUE,
02376                 REG_SZ,
02377                 &amp;sourceDeviceString,
02378                 sourceDeviceString.Length + <span class="keyword">sizeof</span>(WCHAR)
02379                 );
02380     <span class="keywordflow">return</span> status;
02381 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="pri_bld/pnpsubs.c::IopMergeCmResourceLists" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopMergeCmResourceLists           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>List1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>List2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCM_RESOURCE_LIST *&nbsp;</td>
          <td class="mdname" nowrap> <em>MergedList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05085">5085</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03523">IopDetermineResourceListSize()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
<pre class="fragment"><div>05093                    :
05094 
05095     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> merges two IoLists into one.
05096 
05097 
05098 Arguments:
05099 
05100     IoList1 - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first CmResourceList
05101 
05102     IoList2 - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second CmResourceList
05103 
05104     MergedList - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> merged resource
05105              list.
05106 
05107 Return Value:
05108 
05109     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code to indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function.
05110 
05111 --*/
05112 {
05113     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
05114     PCM_RESOURCE_LIST cmList, newList;
05115     ULONG size, size1, size2;
05116     PUCHAR p;
05117 
05118     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05119 
05120     *MergedList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05121 
05122     <span class="comment">//</span>
05123     <span class="comment">// First handle the easy cases that both IO Lists are empty or any one of</span>
05124     <span class="comment">// them is empty.</span>
05125     <span class="comment">//</span>
05126 
05127     <span class="keywordflow">if</span> ((List1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List1-&gt;Count == 0) &amp;&amp;
05128         (List2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List2-&gt;Count == 0)) {
05129         <span class="keywordflow">return</span> status;
05130     }
05131 
05132     cmList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05133     <span class="keywordflow">if</span> (List1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List1-&gt;Count == 0) {
05134         cmList = List2;
05135     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (List2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List2-&gt;Count == 0) {
05136         cmList = List1;
05137     }
05138     <span class="keywordflow">if</span> (cmList) {
05139         size =  <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(cmList);
05140         newList = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, size);
05141         <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05142             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05143         }
05144         RtlMoveMemory(newList, cmList, size);
05145         *MergedList = newList;
05146         <span class="keywordflow">return</span> status;
05147     }
05148 
05149     <span class="comment">//</span>
05150     <span class="comment">// Do real work...</span>
05151     <span class="comment">//</span>
05152 
05153     size1 =  <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(List1);
05154     size2 =  <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(List2);
05155     size = size1 + size2;
05156     newList = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
05157                           PagedPool,
05158                           size
05159                           );
05160     <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05161         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05162     }
05163     p = (PUCHAR)newList;
05164     RtlMoveMemory(p, List1, size1);
05165     p += size1;
05166     RtlMoveMemory(p,
05167                   &amp;List2-&gt;List[0],
05168                   size2 - FIELD_OFFSET(CM_RESOURCE_LIST, List)
05169                   );
05170     newList-&gt;Count = List1-&gt;Count + List2-&gt;Count;
05171     *MergedList = newList;
05172     <span class="keywordflow">return</span> status;
05173 
05174 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="pri_bld/pnpsubs.c::IopMergeFilteredResourceRequirementsList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopMergeFilteredResourceRequirementsList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>IoList1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>IoList2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *&nbsp;</td>
          <td class="mdname" nowrap> <em>MergedList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04996">4996</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>.
<p>
<pre class="fragment"><div>05004                    :
05005 
05006     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> merges two IoLists into one.
05007 
05008 
05009 Arguments:
05010 
05011     IoList1 - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first IoResourceRequirementsList
05012 
05013     IoList2 - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second IoResourceRequirementsList
05014 
05015     MergedList - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> merged resource
05016              requirements list.
05017 
05018 Return Value:
05019 
05020     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code to indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function.
05021 
05022 --*/
05023 {
05024     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
05025     PIO_RESOURCE_REQUIREMENTS_LIST ioList, newList;
05026     ULONG size;
05027     PUCHAR p;
05028 
05029     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05030 
05031     *MergedList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05032 
05033     <span class="comment">//</span>
05034     <span class="comment">// First handle the easy cases that both IO Lists are empty or any one of</span>
05035     <span class="comment">// them is empty.</span>
05036     <span class="comment">//</span>
05037 
05038     <span class="keywordflow">if</span> ((IoList1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList1-&gt;AlternativeLists == 0) &amp;&amp;
05039         (IoList2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList2-&gt;AlternativeLists == 0)) {
05040         <span class="keywordflow">return</span> status;
05041     }
05042     ioList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05043     <span class="keywordflow">if</span> (IoList1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList1-&gt;AlternativeLists == 0) {
05044         ioList = IoList2;
05045     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IoList2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList2-&gt;AlternativeLists == 0) {
05046         ioList = IoList1;
05047     }
05048     <span class="keywordflow">if</span> (ioList) {
05049         newList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, ioList-&gt;ListSize);
05050         <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05051             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05052         }
05053         RtlMoveMemory(newList, ioList, ioList-&gt;ListSize);
05054         *MergedList = newList;
05055         <span class="keywordflow">return</span> status;
05056     }
05057 
05058     <span class="comment">//</span>
05059     <span class="comment">// Do real work...</span>
05060     <span class="comment">//</span>
05061 
05062     size = IoList1-&gt;ListSize + IoList2-&gt;ListSize - FIELD_OFFSET(IO_RESOURCE_REQUIREMENTS_LIST, List);
05063     newList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
05064                           PagedPool,
05065                           size
05066                           );
05067     <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05068         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05069     }
05070     p = (PUCHAR)newList;
05071     RtlMoveMemory(p, IoList1, IoList1-&gt;ListSize);
05072     p += IoList1-&gt;ListSize;
05073     RtlMoveMemory(p,
05074                   &amp;IoList2-&gt;List[0],
05075                   size - IoList1-&gt;ListSize
05076                   );
05077     newList-&gt;ListSize = size;
05078     newList-&gt;AlternativeLists += IoList2-&gt;AlternativeLists;
05079     *MergedList = newList;
05080     <span class="keywordflow">return</span> status;
05081 
05082 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="pri_bld/pnpsubs.c::IopOpenCurrentHwProfileDeviceInstanceKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopOpenCurrentHwProfileDeviceInstanceKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Instance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Create</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01588">1588</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00179">CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent</a>, <a class="el" href="../../d1/d5/consubs_8c-source.html#l00023">Create()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00964">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01471">IopGetDeviceInstanceCsConfigFlags()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01591">IopGetServiceInstanceCsConfigFlags()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01531">IopSetDeviceInstanceCsConfigFlags()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01653">IopSetServiceInstanceCsConfigFlags()</a>.
<p>
<pre class="fragment"><div>01598                    :
01599 
01600     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> csconfig flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device
01601     which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance number under ServiceKeyName\Enum.
01602 
01603 Arguments:
01604 
01605     ServiceKeyName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01606         system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)
01607         that caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RegistryPath parameter
01608         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> routine.
01609 
01610     Instance - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance value under ServiceKeyName\Enum key
01611 
01612     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller needs to
01613         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key.
01614 
01615     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> - Determines <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be created <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not exist.
01616 
01617 Return Value:
01618 
01619     status
01620 
01621 --*/
01622 
01623 {
01624     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01625     UNICODE_STRING tempUnicodeString;
01626     HANDLE profileHandle, profileEnumHandle, tmpHandle;
01627 
01628     <span class="comment">//</span>
01629     <span class="comment">// See if we can open current hardware profile</span>
01630     <span class="comment">//</span>
01631     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;profileHandle,
01632                                 NULL,
01633                                 &amp;CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent,
01634                                 KEY_READ,
01635                                 Create
01636                                 );
01637     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01638         <span class="comment">//</span>
01639         <span class="comment">// Now, we must open the System\CCS\Enum key under this.</span>
01640         <span class="comment">//</span>
01641         <span class="comment">//</span>
01642         <span class="comment">// Open system\CurrentControlSet under current hardware profile key</span>
01643         <span class="comment">//</span>
01644 
01645         PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_PATH_CURRENTCONTROLSET);
01646         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;tmpHandle,
01647                                     profileHandle,
01648                                     &amp;tempUnicodeString,
01649                                     DesiredAccess,
01650                                     FALSE
01651                                     );
01652         ZwClose(profileHandle);
01653         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01654             <span class="keywordflow">return</span> status;
01655         }
01656 
01657         PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_KEY_ENUM);
01658         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;profileEnumHandle,
01659                                     tmpHandle,
01660                                     &amp;tempUnicodeString,
01661                                     KEY_READ,
01662                                     Create
01663                                     );
01664         ZwClose(tmpHandle);
01665         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01666 
01667             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a>(NULL,
01668                                                         ServiceKeyName,
01669                                                         Instance,
01670                                                         &amp;tempUnicodeString,
01671                                                         NULL,
01672                                                         0
01673                                                        );
01674             <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01675                 status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(Handle,
01676                                             profileEnumHandle,
01677                                             &amp;tempUnicodeString,
01678                                             DesiredAccess,
01679                                             Create
01680                                             );
01681                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;tempUnicodeString);
01682             }
01683             ZwClose(profileEnumHandle);
01684         }
01685     }
01686     <span class="keywordflow">return</span> status;
01687 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="pri_bld/pnpsubs.c::IopOpenRegistryKeyPersist" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopOpenRegistryKeyPersist           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE BaseHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Create</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG Disposition&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01140">1140</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d5/consubs_8c-source.html#l00023">Create()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00087">IopCreateMadeupNode()</a>.
<p>
<pre class="fragment"><div>01151                    :
01152 
01153     Opens or creates a PERSIST (non-<span class="keyword">volatile</span>) registry key <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name
01154     passed in based at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BaseHandle node. This name may specify a key
01155     that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> actually a registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>, in which <span class="keywordflow">case</span> each intermediate subkey
01156     will be created (<span class="keywordflow">if</span> Create is TRUE).
01157 
01158     NOTE: Creating a registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> (i.e., more than one of the keys in the path
01159     <span class="keywordflow">do</span> not presently exist) requires that a BaseHandle be specified.
01160 
01161 Arguments:
01162 
01163     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle which will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry key that
01164         was opened.
01165 
01166     BaseHandle - Optional handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> from which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key must be opened.
01167         If <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> specifies a registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> that must be created, then <span class="keyword">this</span> parameter
01168         must be specified, and <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> must be a relative <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
01169 
01170     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> that must be opened/created (possibly a registry path)
01171 
01172     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller needs to
01173         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key.
01174 
01175     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> - Determines <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be created <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not exist.
01176 
01177     Disposition - If <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <span class="keyword">this</span> optional pointer receives a ULONG indicating
01178         whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key was newly created:
01179 
01180             REG_CREATED_NEW_KEY - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keyword">new</span> Registry <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> was created
01181             REG_OPENED_EXISTING_KEY - An existing Registry <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> was opened
01182 
01183 Return Value:
01184 
01185    The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
01186 
01187 --*/
01188 
01189 {
01190     OBJECT_ATTRIBUTES objectAttributes;
01191     ULONG disposition, baseHandleIndex = 0, keyHandleIndex = 1, closeBaseHandle;
01192     HANDLE handles[2];
01193     BOOLEAN continueParsing;
01194     PWCHAR pathEndPtr, pathCurPtr, pathBeginPtr;
01195     ULONG pathComponentLength;
01196     UNICODE_STRING unicodeString;
01197     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01198 
01199     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01200 
01201     InitializeObjectAttributes(&amp;objectAttributes,
01202                                KeyName,
01203                                OBJ_CASE_INSENSITIVE,
01204                                BaseHandle,
01205                                (PSECURITY_DESCRIPTOR) NULL
01206                               );
01207     <span class="keywordflow">if</span>(<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
01208         <span class="comment">//</span>
01209         <span class="comment">// Attempt to create the path as specified. We have to try it this</span>
01210         <span class="comment">// way first, because it allows us to create a key without a BaseHandle</span>
01211         <span class="comment">// (if only the last component of the registry path is not present).</span>
01212         <span class="comment">//</span>
01213         status = ZwCreateKey(&amp;(handles[keyHandleIndex]),
01214                              DesiredAccess,
01215                              &amp;objectAttributes,
01216                              0,
01217                              (PUNICODE_STRING) NULL,
01218                              REG_OPTION_NON_VOLATILE,
01219                              &amp;disposition
01220                             );
01221 
01222         <span class="keywordflow">if</span>(!((status == STATUS_OBJECT_NAME_NOT_FOUND) &amp;&amp; ARGUMENT_PRESENT(BaseHandle))) {
01223             <span class="comment">//</span>
01224             <span class="comment">// Then either we succeeded, or failed, but there's nothing we can do</span>
01225             <span class="comment">// about it. In either case, prepare to return.</span>
01226             <span class="comment">//</span>
01227             <span class="keywordflow">goto</span> PrepareForReturn;
01228         }
01229 
01230     } <span class="keywordflow">else</span> {
01231         <span class="comment">//</span>
01232         <span class="comment">// Simply attempt to open the path, as specified.</span>
01233         <span class="comment">//</span>
01234         <span class="keywordflow">return</span> ZwOpenKey(Handle,
01235                          DesiredAccess,
01236                          &amp;objectAttributes
01237                         );
01238     }
01239 
01240     <span class="comment">//</span>
01241     <span class="comment">// If we get to here, then there must be more than one element of the</span>
01242     <span class="comment">// registry path that does not currently exist.  We will now parse the</span>
01243     <span class="comment">// specified path, extracting each component and doing a ZwCreateKey on it.</span>
01244     <span class="comment">//</span>
01245     handles[baseHandleIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01246     handles[keyHandleIndex] = BaseHandle;
01247     closeBaseHandle = 0;
01248     continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01249     pathBeginPtr = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Buffer;
01250     pathEndPtr = (PWCHAR)((PCHAR)pathBeginPtr + <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Length);
01251     status = STATUS_SUCCESS;
01252 
01253     <span class="keywordflow">while</span>(continueParsing) {
01254         <span class="comment">//</span>
01255         <span class="comment">// There's more to do, so close the previous base handle (if necessary),</span>
01256         <span class="comment">// and replace it with the current key handle.</span>
01257         <span class="comment">//</span>
01258         <span class="keywordflow">if</span>(closeBaseHandle &gt; 1) {
01259             ZwClose(handles[baseHandleIndex]);
01260         }
01261         baseHandleIndex = keyHandleIndex;
01262         keyHandleIndex = (keyHandleIndex + 1) &amp; 1;  <span class="comment">// toggle between 0 and 1.</span>
01263         handles[keyHandleIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01264 
01265         <span class="comment">//</span>
01266         <span class="comment">// Extract next component out of the specified registry path.</span>
01267         <span class="comment">//</span>
01268         <span class="keywordflow">for</span>(pathCurPtr = pathBeginPtr;
01269             ((pathCurPtr &lt; pathEndPtr) &amp;&amp; (*pathCurPtr != OBJ_NAME_PATH_SEPARATOR));
01270             pathCurPtr++);
01271 
01272         <span class="keywordflow">if</span>((pathComponentLength = (ULONG)((PCHAR)pathCurPtr - (PCHAR)pathBeginPtr))) {
01273             <span class="comment">//</span>
01274             <span class="comment">// Then we have a non-empty path component (key name).  Attempt</span>
01275             <span class="comment">// to create this key.</span>
01276             <span class="comment">//</span>
01277             unicodeString.Buffer = pathBeginPtr;
01278             unicodeString.Length = unicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)pathComponentLength;
01279 
01280             InitializeObjectAttributes(&amp;objectAttributes,
01281                                        &amp;unicodeString,
01282                                        OBJ_CASE_INSENSITIVE,
01283                                        handles[baseHandleIndex],
01284                                        (PSECURITY_DESCRIPTOR) NULL
01285                                       );
01286             status = ZwCreateKey(&amp;(handles[keyHandleIndex]),
01287                                  DesiredAccess,
01288                                  &amp;objectAttributes,
01289                                  0,
01290                                  (PUNICODE_STRING) NULL,
01291                                  REG_OPTION_NON_VOLATILE,
01292                                  &amp;disposition
01293                                 );
01294             <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01295                 <span class="comment">//</span>
01296                 <span class="comment">// Increment the closeBaseHandle value, which basically tells us whether</span>
01297                 <span class="comment">// the BaseHandle passed in has been 'shifted out' of our way, so that</span>
01298                 <span class="comment">// we should start closing our base handles when we're finished with them.</span>
01299                 <span class="comment">//</span>
01300                 closeBaseHandle++;
01301             } <span class="keywordflow">else</span> {
01302                 continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01303                 <span class="keywordflow">continue</span>;
01304             }
01305         } <span class="keywordflow">else</span> {
01306             <span class="comment">//</span>
01307             <span class="comment">// Either a path separator ('\') was included at the beginning of</span>
01308             <span class="comment">// the path, or we hit 2 consecutive separators.</span>
01309             <span class="comment">//</span>
01310             status = STATUS_INVALID_PARAMETER;
01311             continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01312             <span class="keywordflow">continue</span>;
01313         }
01314 
01315         <span class="keywordflow">if</span>((pathCurPtr == pathEndPtr) ||
01316            ((pathBeginPtr = pathCurPtr + 1) == pathEndPtr)) {
01317             <span class="comment">//</span>
01318             <span class="comment">// Then we've reached the end of the path</span>
01319             <span class="comment">//</span>
01320             continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01321         }
01322     }
01323 
01324     <span class="keywordflow">if</span>(closeBaseHandle &gt; 1) {
01325         ZwClose(handles[baseHandleIndex]);
01326     }
01327 
01328 PrepareForReturn:
01329 
01330     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01331         *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = handles[keyHandleIndex];
01332 
01333         <span class="keywordflow">if</span>(ARGUMENT_PRESENT(Disposition)) {
01334             *Disposition = disposition;
01335         }
01336     }
01337 
01338     <span class="keywordflow">return</span> status;
01339 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="pri_bld/pnpsubs.c::IopOpenServiceEnumKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopOpenServiceEnumKeys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE ServiceHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE ServiceEnumHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateEnum</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">1342</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00178">CmRegistryMachineSystemCurrentControlSetServices</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02209">IopApplyFunctionToServiceInstances()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">IopCreateMadeupNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">IopDriverLoadingFailed()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01411">IopGetDriverDeviceList()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01454">IopGetServiceType()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00931">IopServiceInstanceToDeviceInstance()</a>.
<p>
<pre class="fragment"><div>01352                    :
01353 
01354     This routine opens <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> HKEY_LOCAL_MACHINE\CurrentControlSet\Services\
01355     ServiceKeyName and its Enum subkey and returns handles <span class="keywordflow">for</span> both key.
01356     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> caller's responsibility to close <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned handles.
01357 
01358 Arguments:
01359 
01360     ServiceKeyName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01361         system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)
01362         that caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RegistryPath parameter
01363         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> routine.
01364 
01365     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> keys.
01366 
01367     ServiceHandle - Supplies a variable to receive a handle to ServiceKeyName.
01368         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ServiceHandle indicates caller does not want need <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to
01369         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ServiceKeyName.
01370 
01371     ServiceEnumHandle - Supplies a variable to receive a handle to ServiceKeyName\Enum.
01372         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ServiceEnumHandle indicates caller does not need <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to
01373         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ServiceKeyName\Enum.
01374 
01375     CreateEnum - Supplies a BOOLEAN variable to indicate should <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Enum subkey be
01376         created <span class="keywordflow">if</span> not present.
01377 
01378 Return Value:
01379 
01380     status
01381 
01382 --*/
01383 
01384 {
01385     HANDLE handle, serviceHandle, enumHandle;
01386     UNICODE_STRING enumName;
01387     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01388 
01389     <span class="comment">//</span>
01390     <span class="comment">// Open System\CurrentControlSet\Services</span>
01391     <span class="comment">//</span>
01392 
01393     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
01394                                 NULL,
01395                                 &amp;CmRegistryMachineSystemCurrentControlSetServices,
01396                                 DesiredAccess,
01397                                 FALSE
01398                                 );
01399 
01400     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01401         <span class="keywordflow">return</span> status;
01402     }
01403 
01404     <span class="comment">//</span>
01405     <span class="comment">// Open the registry ServiceKeyName key.</span>
01406     <span class="comment">//</span>
01407 
01408     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;serviceHandle,
01409                                 handle,
01410                                 ServiceKeyName,
01411                                 DesiredAccess,
01412                                 FALSE
01413                                 );
01414 
01415     ZwClose(handle);
01416     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01417 
01418         <span class="comment">//</span>
01419         <span class="comment">// There is no registry key for the ServiceKeyName information.</span>
01420         <span class="comment">//</span>
01421 
01422         <span class="keywordflow">return</span> status;
01423     }
01424 
01425     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ServiceEnumHandle) || CreateEnum) {
01426 
01427         <span class="comment">//</span>
01428         <span class="comment">// Open registry ServiceKeyName\Enum branch if caller wants</span>
01429         <span class="comment">// the handle or wants to create it.</span>
01430         <span class="comment">//</span>
01431 
01432         PiWstrToUnicodeString(&amp;enumName, REGSTR_KEY_ENUM);
01433         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;enumHandle,
01434                                     serviceHandle,
01435                                     &amp;enumName,
01436                                     DesiredAccess,
01437                                     CreateEnum
01438                                     );
01439 
01440         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01441 
01442             <span class="comment">//</span>
01443             <span class="comment">// There is no registry key for the ServiceKeyName\Enum information.</span>
01444             <span class="comment">//</span>
01445 
01446             ZwClose(serviceHandle);
01447             <span class="keywordflow">return</span> status;
01448         }
01449         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ServiceEnumHandle)) {
01450             *ServiceEnumHandle = enumHandle;
01451         } <span class="keywordflow">else</span> {
01452             ZwClose(enumHandle);
01453         }
01454     }
01455 
01456     <span class="comment">//</span>
01457     <span class="comment">// if caller wants to have the ServiceKey handle, we return it.  Otherwise</span>
01458     <span class="comment">// we close it.</span>
01459     <span class="comment">//</span>
01460 
01461     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ServiceHandle)) {
01462         *ServiceHandle = serviceHandle;
01463     } <span class="keywordflow">else</span> {
01464         ZwClose(serviceHandle);
01465     }
01466 
01467     <span class="keywordflow">return</span> STATUS_SUCCESS;
01468 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="pri_bld/pnpsubs.c::IopPrepareDriverLoading" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopPrepareDriverLoading           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIMAGE_NT_HEADERS&nbsp;</td>
          <td class="mdname" nowrap> <em>Header</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00753">753</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00087">IopCreateMadeupNode()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03071">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00116">PnPDetectionEnabled</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.
<p>
<pre class="fragment"><div>00761                    :
00762 
00763     This routine first checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> loadable.  If its a
00764     PnP driver, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will always be loaded (we trust it to <span class="keywordflow">do</span> the right
00765     things.)  If it is a legacy driver, we need to check <span class="keywordflow">if</span> its device
00766     has been disabled.  Once we decide to load the driver, the Enum
00767     subkey of the service node will be checked <span class="keywordflow">for</span> duplicates, <span class="keywordflow">if</span> any.
00768 
00769 Parameters:
00770 
00771     KeyName - Supplies a pointer to the driver's service key unicode string
00772 
00773     KeyHandle - Supplies a handle to the driver service node in the registry
00774         that describes the driver to be loaded.
00775 
00776 Return Value:
00777 
00778     The function value is the <span class="keyword">final</span> status of the load operation.
00779 
00780 --*/
00781 
00782 {
00783     NTSTATUS status;
00784     PKEY_VALUE_FULL_INFORMATION keyValueInformation = NULL;
00785     ULONG tmp, count = 0;
00786     HANDLE serviceEnumHandle = NULL, sysEnumXxxHandle, controlHandle;
00787     UNICODE_STRING unicodeKeyName, unicodeValueName;
00788     BOOLEAN IsPlugPlayDriver = FALSE;
00789 
00790     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00791     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
00792 
00793     <span class="comment">//</span>
00794     <span class="comment">// Check should this driver be loaded.  If it is a PnP driver and has at least</span>
00795     <span class="comment">// one device instance enabled, it will be loaded. If it is a legacy driver,</span>
00796     <span class="comment">// we need to check if its device has been disabled.</span>
00797     <span class="comment">//</span>
00798 
00799     <span class="keywordflow">if</span> ((Header) &amp;&amp;
00800         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;OptionalHeader.DllCharacteristics &amp; IMAGE_DLLCHARACTERISTICS_WDM_DRIVER)) {
00801         IsPlugPlayDriver = TRUE;
00802     }
00803     <span class="keywordflow">if</span> (IsPlugPlayDriver) {
00804 
00805         <span class="comment">//</span>
00806         <span class="comment">// BUGBUG - For SUR, we load the driver only if device instance list is not</span>
00807         <span class="comment">// empty and at least one device instance is enabled.</span>
00808         <span class="comment">//</span>
00809 
00810         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a19">IopIsAnyDeviceInstanceEnabled</a>(KeyName, KeyHandle, FALSE)) {
00811             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a15">PnPDetectionEnabled</a>) {
00812 
00813                 <span class="comment">//</span>
00814                 <span class="comment">// We need to load WDM driver on TextMode Setup phase.</span>
00815                 <span class="comment">//</span>
00816 
00817                 status = STATUS_SUCCESS;
00818             } <span class="keywordflow">else</span> {
00819                 status = STATUS_PLUGPLAY_NO_DEVICE;
00820            }
00821            <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00822 
00823         }
00824     } <span class="keywordflow">else</span> {
00825 
00826         <span class="comment">//</span>
00827         <span class="comment">// If this is a legacy driver, then we need to check if its</span>
00828         <span class="comment">// device has been disabled. (There should be NO more than one device</span>
00829         <span class="comment">// instance for legacy driver.)</span>
00830         <span class="comment">//</span>
00831 
00832         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a19">IopIsAnyDeviceInstanceEnabled</a>(KeyName, KeyHandle, TRUE)) {
00833 
00834             <span class="comment">//</span>
00835             <span class="comment">// If the device is not enabled, it may be because there is no device</span>
00836             <span class="comment">// instance.  If this is the case, we need to create a madeup key as</span>
00837             <span class="comment">// the device instance for the legacy driver.</span>
00838             <span class="comment">//</span>
00839 
00840             <span class="comment">//</span>
00841             <span class="comment">// First open registry ServiceKeyName\Enum branch</span>
00842             <span class="comment">//</span>
00843 
00844             PiWstrToUnicodeString(&amp;unicodeKeyName, REGSTR_KEY_ENUM);
00845             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;serviceEnumHandle,
00846                                         KeyHandle,
00847                                         &amp;unicodeKeyName,
00848                                         KEY_ALL_ACCESS,
00849                                         TRUE
00850                                         );
00851 
00852             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00853                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00854             }
00855 
00856             <span class="comment">//</span>
00857             <span class="comment">// Find out how many device instances listed in the ServiceName's</span>
00858             <span class="comment">// Enum key.</span>
00859             <span class="comment">//</span>
00860 
00861             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( serviceEnumHandle,
00862                                            REGSTR_VALUE_COUNT,
00863                                            &amp;keyValueInformation
00864                                            );
00865             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00866                 <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
00867                     (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
00868 
00869                     count = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
00870                 }
00871                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00872             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status != STATUS_OBJECT_PATH_NOT_FOUND &amp;&amp;
00873                        status != STATUS_OBJECT_NAME_NOT_FOUND) {
00874 
00875                 ZwClose(serviceEnumHandle);
00876                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00877             }
00878 
00879             <span class="keywordflow">if</span> (count == 0) {
00880 
00881                 <span class="comment">//</span>
00882                 <span class="comment">// If there is no Enum key or instance under Enum for the</span>
00883                 <span class="comment">// legacy driver we will create a madeup node for it.</span>
00884                 <span class="comment">//</span>
00885 
00886                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a1">IopCreateMadeupNode</a>(KeyName,
00887                                              &amp;sysEnumXxxHandle,
00888                                              &amp;unicodeKeyName,
00889                                              &amp;tmp,
00890                                              TRUE);
00891 
00892                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00893                     ZwClose(serviceEnumHandle);
00894                     <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00895                 }
00896                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00897 
00898                 <span class="comment">//</span>
00899                 <span class="comment">// Create and set Control\ActiveService value</span>
00900                 <span class="comment">//</span>
00901 
00902                 PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
00903                 status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;controlHandle,
00904                                             sysEnumXxxHandle,
00905                                             &amp;unicodeValueName,
00906                                             KEY_ALL_ACCESS,
00907                                             TRUE
00908                                             );
00909                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00910                     PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VAL_ACTIVESERVICE);
00911                     ZwSetValueKey(
00912                                 controlHandle,
00913                                 &amp;unicodeValueName,
00914                                 TITLE_INDEX_VALUE,
00915                                 REG_SZ,
00916                                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Buffer,
00917                                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
00918                                 );
00919 
00920                     ZwClose(controlHandle);
00921                 }
00922                 count++;
00923 
00924                 <span class="comment">//</span>
00925                 <span class="comment">// Don't forget to update the "Count=" and "NextInstance=" value entries</span>
00926                 <span class="comment">//</span>
00927 
00928                 PiWstrToUnicodeString( &amp;unicodeValueName, REGSTR_VALUE_COUNT);
00929 
00930                 ZwSetValueKey(serviceEnumHandle,
00931                               &amp;unicodeValueName,
00932                               TITLE_INDEX_VALUE,
00933                               REG_DWORD,
00934                               &amp;count,
00935                               <span class="keyword">sizeof</span> (count)
00936                               );
00937                 PiWstrToUnicodeString( &amp;unicodeValueName, REGSTR_VALUE_NEXT_INSTANCE);
00938 
00939                 ZwSetValueKey(serviceEnumHandle,
00940                               &amp;unicodeValueName,
00941                               TITLE_INDEX_VALUE,
00942                               REG_DWORD,
00943                               &amp;count,
00944                               <span class="keyword">sizeof</span> (count)
00945                               );
00946                 ZwClose(sysEnumXxxHandle);
00947                 ZwClose(serviceEnumHandle);
00948             } <span class="keywordflow">else</span> {
00949                 ZwClose(serviceEnumHandle);
00950                 status = STATUS_PLUGPLAY_NO_DEVICE;
00951                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00952             }
00953         }
00954     }
00955 
00956     status = STATUS_SUCCESS;
00957 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
00958     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
00959     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00960     <span class="keywordflow">return</span> status;
00961 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="pri_bld/pnpsubs.c::IopReadDeviceConfiguration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopReadDeviceConfiguration           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCM_RESOURCE_LIST *&nbsp;</td>
          <td class="mdname" nowrap> <em>CmResource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04170">4170</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00743">REGISTRY_ALLOC_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00745">REGISTRY_BOOT_CONFIG</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00744">REGISTRY_FORCED_CONFIG</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>.
<p>
<pre class="fragment"><div>04179                    :
04180 
04181     This routine read <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d3/d5/perfutil_8h.html#a9">ALLOC</a> config or ForcedConfig or Boot config.
04182 
04183 Arguments:
04184 
04185     Hanle - supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry key to read resources.
04186 
04187 Return Value:
04188 
04189     status
04190 
04191 --*/
04192 
04193 {
04194     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04195     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04196     PWCHAR valueName;
04197 
04198     *CmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04199     *Length = 0;
04200 
04201     <span class="keywordflow">if</span> (Flags == <a class="code" href="../../d9/d0/pnpiop_8h.html#a62">REGISTRY_ALLOC_CONFIG</a>) {
04202         valueName = REGSTR_VALUE_ALLOC_CONFIG;
04203     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Flags == <a class="code" href="../../d9/d0/pnpiop_8h.html#a63">REGISTRY_FORCED_CONFIG</a>) {
04204         valueName = REGSTR_VALUE_FORCED_CONFIG;
04205     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Flags == <a class="code" href="../../d9/d0/pnpiop_8h.html#a64">REGISTRY_BOOT_CONFIG</a>) {
04206         valueName = REGSTR_VALUE_BOOT_CONFIG;
04207     } <span class="keywordflow">else</span> {
04208         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
04209     }
04210 
04211     <span class="comment">//</span>
04212     <span class="comment">// Read the registry value of the desired value name</span>
04213     <span class="comment">//</span>
04214 
04215     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (Handle,
04216                                   valueName,
04217                                   &amp;keyValueInformation);
04218     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04219 
04220         <span class="comment">//</span>
04221         <span class="comment">// Try to read what caller wants.</span>
04222         <span class="comment">//</span>
04223 
04224         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_RESOURCE_LIST) &amp;&amp;
04225             (keyValueInformation-&gt;DataLength != 0)) {
04226             *CmResource = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
04227                                          keyValueInformation-&gt;DataLength);
04228             <span class="keywordflow">if</span> (*CmResource) {
04229                 <span class="keywordflow">if</span> (*CmResource) {
04230                     *Length = keyValueInformation-&gt;DataLength;
04231                     RtlMoveMemory(*CmResource,
04232                                   <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
04233                                   keyValueInformation-&gt;DataLength);
04234                 } <span class="keywordflow">else</span> {
04235                     status = STATUS_INSUFFICIENT_RESOURCES;
04236                 }
04237             }
04238             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04239             <span class="keywordflow">if</span> (*CmResource) {
04240                 PCM_RESOURCE_LIST resourceList;
04241                 PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
04242                 PCM_PARTIAL_RESOURCE_DESCRIPTOR cmPartDesc;
04243                 ULONG j, k, size, count;
04244 
04245                 <span class="comment">//</span>
04246                 <span class="comment">// Process the resource list read from Registry to change undefined</span>
04247                 <span class="comment">// interface type to our default interface type.</span>
04248                 <span class="comment">//</span>
04249 
04250                 resourceList = *CmResource;
04251                 cmFullDesc = &amp;resourceList-&gt;List[0];
04252                 <span class="keywordflow">for</span> (j = 0; j &lt; resourceList-&gt;Count; j++) {
04253                     <span class="keywordflow">if</span> (cmFullDesc-&gt;InterfaceType == InterfaceTypeUndefined) {
04254                         cmFullDesc-&gt;BusNumber = 0;
04255                         cmFullDesc-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
04256                     }
04257                     cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04258                     <span class="keywordflow">for</span> (k = 0; k &lt; cmFullDesc-&gt;PartialResourceList.Count; k++) {
04259                         size = 0;
04260                         <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
04261                         <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04262                              size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
04263                              <span class="keywordflow">break</span>;
04264                         }
04265                         cmPartDesc++;
04266                         cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
04267                     }
04268                     cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
04269                 }
04270             }
04271         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (keyValueInformation-&gt;Type != REG_RESOURCE_LIST) {
04272             status = STATUS_UNSUCCESSFUL;
04273         }
04274     }
04275     <span class="keywordflow">return</span> status;
04276 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="pri_bld/pnpsubs.c::IopReferenceDriverObjectByName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> IopReferenceDriverObjectByName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03578">3578</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d4/d4/iodata_8c-source.html#l00236">IoDriverObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>.
<p>
<pre class="fragment"><div>03584                    :
03585 
03586     This routine references a driver object by a given driver name.
03587 
03588 Arguments:
03589 
03590     DriverName - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver whose driver object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
03591         to be referenced.
03592 
03593 Returns:
03594 
03595     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a> <span class="keywordflow">if</span> succeeds.  Otherwise, a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> value.
03596 
03597 --*/
03598 
03599 {
03600     OBJECT_ATTRIBUTES objectAttributes;
03601     HANDLE driverHandle;
03602     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03603     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
03604 
03605     <span class="comment">//</span>
03606     <span class="comment">// Make sure the driver name is valid.</span>
03607     <span class="comment">//</span>
03608 
03609     <span class="keywordflow">if</span> (DriverName-&gt;Length == 0) {
03610         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03611     }
03612 
03613     InitializeObjectAttributes(&amp;objectAttributes,
03614                                DriverName,
03615                                OBJ_CASE_INSENSITIVE,
03616                                NULL,
03617                                NULL
03618                                );
03619     status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(&amp;objectAttributes,
03620                                 IoDriverObjectType,
03621                                 KernelMode,
03622                                 NULL,
03623                                 FILE_READ_ATTRIBUTES,
03624                                 NULL,
03625                                 &amp;driverHandle
03626                                 );
03627     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03628 
03629         <span class="comment">//</span>
03630         <span class="comment">// Now reference the driver object.</span>
03631         <span class="comment">//</span>
03632 
03633         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(driverHandle,
03634                                            0,
03635                                            IoDriverObjectType,
03636                                            KernelMode,
03637                                            &amp;driverObject,
03638                                            NULL
03639                                            );
03640         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(driverHandle);
03641     }
03642 
03643     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03644         <span class="keywordflow">return</span> driverObject;
03645     } <span class="keywordflow">else</span> {
03646         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03647     }
03648 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="pri_bld/pnpsubs.c::IopRegMultiSzToUnicodeStrings" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRegMultiSzToUnicodeStrings           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKEY_VALUE_FULL_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING *&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeStringList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeStringCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01907">1907</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02570">IopFreeUnicodeStringList()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00449">StringLength()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05334">IopGetGroupOrderIndex()</a>.
<p>
<pre class="fragment"><div>01915                    :
01916 
01917     This routine takes a KEY_VALUE_FULL_INFORMATION structure containing
01918     a REG_MULTI_SZ value, and allocates an array of UNICODE_STRINGs,
01919     initializing each one to a copy of one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> strings in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.
01920     All <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resulting UNICODE_STRINGs will be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> terminated
01921     (MaximumLength = Length + <span class="keyword">sizeof</span>(UNICODE_NULL)).
01922 
01923     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> responsibility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffers <span class="keywordflow">for</span> each
01924     unicode string, as well as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UNICODE_STRING
01925     array. This may be done by calling <a class="code" href="../../d9/d0/pnpiop_8h.html#a246">IopFreeUnicodeStringList</a>.
01926 
01927 Arguments:
01928 
01929     KeyValueInformation - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> REG_MULTI_SZ
01930         value entry data.
01931 
01932     UnicodeStringList - Receives a pointer to an array of UNICODE_STRINGs, each
01933         initialized with a copy of one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> strings in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> REG_MULTI_SZ.
01934 
01935     UnicodeStringCount - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of strings in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01936         UnicodeStringList.
01937 
01938 Returns:
01939 
01940     NT status code indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
01941 
01942 --*/
01943 
01944 {
01945     PWCHAR p, BufferEnd, StringStart;
01946     ULONG StringCount, i, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>;
01947 
01948     <span class="comment">//</span>
01949     <span class="comment">// First, make sure this is really a REG_MULTI_SZ value.</span>
01950     <span class="comment">//</span>
01951     <span class="keywordflow">if</span>(KeyValueInformation-&gt;Type != REG_MULTI_SZ) {
01952         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01953     }
01954 
01955     <span class="comment">//</span>
01956     <span class="comment">// Make a preliminary pass through the buffer to count the number of strings</span>
01957     <span class="comment">// There will always be at least one string returned (possibly empty).</span>
01958     <span class="comment">//</span>
01959     StringCount = 0;
01960     p = (PWCHAR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation);
01961     BufferEnd = (PWCHAR)((PUCHAR)p + KeyValueInformation-&gt;DataLength);
01962     <span class="keywordflow">while</span>(p != BufferEnd) {
01963         <span class="keywordflow">if</span>(!*p) {
01964             StringCount++;
01965             <span class="keywordflow">if</span>(((p + 1) == BufferEnd) || !*(p + 1)) {
01966                 <span class="keywordflow">break</span>;
01967             }
01968         }
01969         p++;
01970     }
01971     <span class="keywordflow">if</span>(p == BufferEnd) {
01972         StringCount++;
01973     }
01974 
01975     *UnicodeStringList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <span class="keyword">sizeof</span>(UNICODE_STRING) * StringCount);
01976     <span class="keywordflow">if</span>(!(*UnicodeStringList)) {
01977         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01978     }
01979 
01980     <span class="comment">//</span>
01981     <span class="comment">// Now, make a second pass through the buffer making copies of each string.</span>
01982     <span class="comment">//</span>
01983     i = 0;
01984     StringStart = p = (PWCHAR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation);
01985     <span class="keywordflow">while</span>(p != BufferEnd) {
01986         <span class="keywordflow">if</span>(!*p) {
01987             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> = (ULONG)((PUCHAR)p - (PUCHAR)StringStart) + <span class="keyword">sizeof</span>(UNICODE_NULL);
01988             (*UnicodeStringList)[i].Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, StringLength);
01989 
01990             <span class="keywordflow">if</span>(!((*UnicodeStringList)[i].Buffer)) {
01991                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(*UnicodeStringList, i);
01992                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01993             }
01994 
01995             RtlMoveMemory((*UnicodeStringList)[i].Buffer, StringStart, StringLength);
01996 
01997             (*UnicodeStringList)[i].Length =
01998                 ((*UnicodeStringList)[i].MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>)
01999                 - <span class="keyword">sizeof</span>(UNICODE_NULL);
02000 
02001             i++;
02002 
02003             <span class="keywordflow">if</span>(((p + 1) == BufferEnd) || !*(p + 1)) {
02004                 <span class="keywordflow">break</span>;
02005             } <span class="keywordflow">else</span> {
02006                 StringStart = p + 1;
02007             }
02008         }
02009         p++;
02010     }
02011     <span class="keywordflow">if</span>(p == BufferEnd) {
02012         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> = (ULONG)((PUCHAR)p - (PUCHAR)StringStart);
02013         (*UnicodeStringList)[i].Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
02014                                                         StringLength + <span class="keyword">sizeof</span>(UNICODE_NULL)
02015                                                        );
02016         <span class="keywordflow">if</span>(!((*UnicodeStringList)[i].Buffer)) {
02017             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(*UnicodeStringList, i);
02018             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02019         }
02020         <span class="keywordflow">if</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>) {
02021             RtlMoveMemory((*UnicodeStringList)[i].Buffer, StringStart, StringLength);
02022         }
02023         (*UnicodeStringList)[i].Buffer[CB_TO_CWC(StringLength)] = UNICODE_NULL;
02024 
02025         (*UnicodeStringList)[i].MaximumLength =
02026                 ((*UnicodeStringList)[i].Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>)
02027                 + <span class="keyword">sizeof</span>(UNICODE_NULL);
02028     }
02029 
02030     *UnicodeStringCount = StringCount;
02031 
02032     <span class="keywordflow">return</span> STATUS_SUCCESS;
02033 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="pri_bld/pnpsubs.c::IopRemoveStringFromValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRemoveStringFromValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>String</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00449">449</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
<pre class="fragment"><div>00457                    :
00458 
00459     This routine remove a string from a value entry specified by <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>
00460     under an already opened registry handle.  Note, <span class="keyword">this</span> routine will not
00461     <span class="keyword">delete</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> entry even <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> becomes empty after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> removal.
00462 
00463 Parameters:
00464 
00465     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to a registry key whose value entry will
00466         be modified.
00467 
00468     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> - Supplies a unicode string to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.
00469 
00470     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> - Supplies a unicode string to remove from value entry.
00471 
00472 Return Value:
00473 
00474     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
00475 
00476 --*/
00477 
00478 {
00479     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00480     UNICODE_STRING unicodeString;
00481     PWSTR nextString, currentString;
00482     ULONG length, leftLength;
00483     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00484     BOOLEAN found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00485 
00486     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR) == 0) {
00487         <span class="keywordflow">return</span> STATUS_SUCCESS;
00488     }
00489 
00490     <span class="comment">//</span>
00491     <span class="comment">// Read registry value entry data</span>
00492     <span class="comment">//</span>
00493 
00494     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(Handle, ValueName, &amp;keyValueInformation);
00495 
00496     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00497         <span class="keywordflow">return</span> status;
00498     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type != REG_MULTI_SZ) ||
00499                (keyValueInformation-&gt;DataLength == 0)) {
00500 
00501         status = (keyValueInformation-&gt;Type == REG_MULTI_SZ) ? STATUS_SUCCESS
00502                                                              : STATUS_INVALID_PARAMETER;
00503         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00504         <span class="keywordflow">return</span> status;
00505     }
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// Scan through the multi_sz string to find the matching string</span>
00509     <span class="comment">// and remove it.</span>
00510     <span class="comment">//</span>
00511 
00512     status = STATUS_SUCCESS;
00513     currentString = (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
00514     leftLength = keyValueInformation-&gt;DataLength;
00515     <span class="keywordflow">while</span> (!found &amp;&amp; leftLength &gt;= <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length + <span class="keyword">sizeof</span>(WCHAR)) {
00516         unicodeString.Buffer = currentString;
00517         length = wcslen( currentString ) * <span class="keyword">sizeof</span>( WCHAR );
00518         unicodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
00519         length += <span class="keyword">sizeof</span>(UNICODE_NULL);
00520         unicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
00521         nextString = currentString + length / <span class="keyword">sizeof</span>(WCHAR);
00522         leftLength -= length;
00523 
00524         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;unicodeString, String, TRUE)) {
00525             found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00526             RtlMoveMemory(currentString, nextString, leftLength);
00527             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeString, ValueName);
00528             status = ZwSetValueKey(
00529                         Handle,
00530                         &amp;unicodeString,
00531                         TITLE_INDEX_VALUE,
00532                         REG_MULTI_SZ,
00533                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00534                         keyValueInformation-&gt;DataLength - length
00535                         );
00536             <span class="keywordflow">break</span>;
00537         } <span class="keywordflow">else</span> {
00538             currentString = nextString;
00539         }
00540     }
00541     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00542     <span class="keywordflow">return</span> status;
00543 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="pri_bld/pnpsubs.c::IopRestartDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRestartDeviceNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05597">5597</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00421">DNF_BOOT_CONFIG_RESERVED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00396">DNF_ENUMERATED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00522">DNF_ENUMERATION_REQUEST_QUEUED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">DNF_HAS_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00433">DNF_NO_RESOURCE_REQUIRED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00390">DNF_PROCESSED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00453">DNF_RESOURCE_ASSIGNED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00459">DNF_RESOURCE_REPORTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00466">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00440">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00602">DNUF_NEED_RESTART</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00589">DNUF_WILL_BE_REMOVED</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01250">IopInvalidateRelationsInList()</a>.
<p>
<pre class="fragment"><div>05600 {
05601     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05602 
05603     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode) ||
05604             (DeviceNode-&gt;Flags &amp; (DNF_STARTED |
05605                                  DNF_ADDED |
05606                                  DNF_RESOURCE_ASSIGNED |
05607                                  DNF_RESOURCE_REPORTED)) ||
05608             (DeviceNode-&gt;UserFlags &amp; DNUF_WILL_BE_REMOVED)));
05609 
05610     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;Flags &amp; DNF_ENUMERATED);
05611 
05612     <span class="keywordflow">if</span> (!(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>)) {
05613         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
05614     }
05615 
05616     DeviceNode-&gt;UserFlags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a39">DNUF_NEED_RESTART</a>;
05617 
05618 <span class="preprocessor">#if DBG_SCOPE</span>
05619 <span class="preprocessor"></span>    DeviceNode-&gt;FailureStatus = 0;
05620     <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceList) {
05621         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceList);
05622         DeviceNode-&gt;PreviousResourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05623     }
05624     <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceRequirements) {
05625         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceRequirements);
05626         DeviceNode-&gt;PreviousResourceRequirements = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05627     }
05628 <span class="preprocessor">#endif</span>
05629 <span class="preprocessor"></span>
05630     <span class="comment">//</span>
05631     <span class="comment">// Free any existing devnode strings so we can recreate them</span>
05632     <span class="comment">// during enumeration.</span>
05633     <span class="comment">//</span>
05634 
05635     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a>) {
05636 
05637         DeviceNode-&gt;Flags &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a28">DNF_ENUMERATION_REQUEST_QUEUED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>);
05638 
05639         <span class="keywordflow">if</span> (DeviceNode-&gt;ServiceName.Length != 0) {
05640             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ServiceName.Buffer);
05641             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;DeviceNode-&gt;ServiceName, NULL);
05642         }
05643 
05644         <span class="keywordflow">if</span> (DeviceNode-&gt;InstanceOrdinal.Length != 0) {
05645             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;InstanceOrdinal.Buffer);
05646             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;DeviceNode-&gt;InstanceOrdinal, NULL);
05647         }
05648 
05649         <span class="keywordflow">if</span> (DeviceNode-&gt;ResourceRequirements != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05650             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ResourceRequirements);
05651             DeviceNode-&gt;ResourceRequirements = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05652             DeviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a16">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>;
05653         }
05654     }
05655 
05656     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;ServiceName.Length == 0 &amp;&amp;
05657            DeviceNode-&gt;ServiceName.MaximumLength == 0 &amp;&amp;
05658            DeviceNode-&gt;ServiceName.Buffer == NULL);
05659 
05660     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;InstanceOrdinal.Length == 0 &amp;&amp;
05661            DeviceNode-&gt;InstanceOrdinal.MaximumLength == 0 &amp;&amp;
05662            DeviceNode-&gt;InstanceOrdinal.Buffer == NULL);
05663 
05664     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(DeviceNode-&gt;Flags &amp;
05665            ~(DNF_MADEUP | DNF_ENUMERATED | DNF_HAS_BOOT_CONFIG |
05666              DNF_BOOT_CONFIG_RESERVED | DNF_NO_RESOURCE_REQUIRED)));
05667 
05668     <span class="keywordflow">return</span> STATUS_SUCCESS;
05669 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="pri_bld/pnpsubs.c::IopServiceInstanceToDeviceInstance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopServiceInstanceToDeviceInstance           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE ServiceKeyHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING ServiceKeyName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceInstanceOrdinal</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING DeviceInstanceRegistryPath&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE DeviceInstanceHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00964">964</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00695">IopConcatenateUnicodeStrings()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">IopDriverLoadingFailed()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02467">IopMarkDuplicateDevice()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01712">IopOpenCurrentHwProfileDeviceInstanceKey()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06660">IopSetLegacyDeviceInstance()</a>.
<p>
<pre class="fragment"><div>00975                    :
00976 
00977     This routine reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service node <span class="keyword">enum</span> entry to find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired device instance
00978     under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> System\Enum tree.  It then optionally returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00979     specified device instance (relative to HKLM\System\Enum) and an open handle
00980     to that registry key.
00981 
00982     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's responsibility to close <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle returned <span class="keywordflow">if</span>
00983     DeviceInstanceHandle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied, and also to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> (PagedPool) memory
00984     allocated for the unicode string buffer of DeviceInstanceRegistryPath, if
00985     supplied.
00986 
00987 Parameters:
00988 
00989     ServiceKeyHandle - Optionally, supplies a handle to the driver service node in the
00990         registry that controls this device instance.  If this argument is not specified,
00991         then ServiceKeyName is used to specify the service entry.
00992 
00993     ServiceKeyName - Optionally supplies the name of the service entry that controls
00994         the device instance. This must be specified if ServiceKeyHandle isn't given.
00995 
00996     ServiceInstanceOrdinal - Supplies the instance value under the service entry's
00997         volatile Enum subkey that references the desired device instance.
00998 
00999     DeviceInstanceRegistryPath - Optionally, supplies a pointer to a unicode string
01000         that will be initialized with the registry path (relative to HKLM\System\Enum)
01001         to the device instance key.
01002 
01003     DeviceInstanceHandle - Optionally, supplies a pointer to a variable that will
01004         receive a handle to the opened device instance registry key.
01005 
01006     DesiredAccess - If DeviceInstanceHandle is specified (i.e., the device instance
01007         key is to be opened), then this variable specifies the access that is needed
01008         to this key.
01009 
01010 Return Value:
01011 
01012     NT status code indicating whether the function was successful.
01013 
01014 --*/
01015 
01016 {
01017     WCHAR unicodeBuffer[20];
01018     UNICODE_STRING unicodeKeyName;
01019     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01020     HANDLE handle;
01021     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01022 
01023     <span class="comment">//</span>
01024     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
01025     <span class="comment">//</span>
01026     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ServiceKeyHandle)) {
01027 
01028         PiWstrToUnicodeString(&amp;unicodeKeyName, REGSTR_KEY_ENUM);
01029         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
01030                                     ServiceKeyHandle,
01031                                     &amp;unicodeKeyName,
01032                                     KEY_READ,
01033                                     FALSE
01034                                     );
01035     } <span class="keywordflow">else</span> {
01036 
01037         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
01038                                         KEY_READ,
01039                                         NULL,
01040                                         &amp;handle,
01041                                         FALSE
01042                                        );
01043     }
01044 
01045     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01046 
01047         <span class="comment">//</span>
01048         <span class="comment">// There is no registry key for the ServiceKeyName\Enum information.</span>
01049         <span class="comment">//</span>
01050 
01051         <span class="keywordflow">return</span> status;
01052     }
01053 
01054     <span class="comment">//</span>
01055     <span class="comment">// Read a path to System\Enum hardware tree branch specified by the service</span>
01056     <span class="comment">// instance ordinal</span>
01057     <span class="comment">//</span>
01058 
01059     swprintf(unicodeBuffer, REGSTR_VALUE_STANDARD_ULONG_FORMAT, ServiceInstanceOrdinal);
01060     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( handle,
01061                                    unicodeBuffer,
01062                                    &amp;keyValueInformation
01063                                    );
01064 
01065     ZwClose(handle);
01066     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01067         <span class="keywordflow">return</span> status;
01068     } <span class="keywordflow">else</span> {
01069         <span class="keywordflow">if</span>(keyValueInformation-&gt;Type == REG_SZ) {
01070             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;unicodeKeyName,
01071                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
01072                                            keyValueInformation-&gt;DataLength
01073                                           );
01074             <span class="keywordflow">if</span>(!unicodeKeyName.Length) {
01075                 status = STATUS_OBJECT_PATH_NOT_FOUND;
01076             }
01077         } <span class="keywordflow">else</span> {
01078             status = STATUS_INVALID_PLUGPLAY_DEVICE_PATH;
01079         }
01080 
01081         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01082             <span class="keywordflow">goto</span> PrepareForReturn;
01083         }
01084     }
01085 
01086     <span class="comment">//</span>
01087     <span class="comment">// If the DeviceInstanceHandle argument was specified, open the device instance</span>
01088     <span class="comment">// key under HKLM\System\CurrentControlSet\Enum</span>
01089     <span class="comment">//</span>
01090 
01091     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DeviceInstanceHandle)) {
01092 
01093         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
01094                                     NULL,
01095                                     &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
01096                                     KEY_READ,
01097                                     FALSE
01098                                     );
01099 
01100         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01101 
01102             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a> (DeviceInstanceHandle,
01103                                          handle,
01104                                          &amp;unicodeKeyName,
01105                                          DesiredAccess,
01106                                          FALSE
01107                                          );
01108             ZwClose(handle);
01109         }
01110 
01111         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01112             <span class="keywordflow">goto</span> PrepareForReturn;
01113         }
01114     }
01115 
01116     <span class="comment">//</span>
01117     <span class="comment">// If the DeviceInstanceRegistryPath argument was specified, then store a</span>
01118     <span class="comment">// copy of the device instance path in the supplied unicode string variable.</span>
01119     <span class="comment">//</span>
01120     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DeviceInstanceRegistryPath)) {
01121 
01122         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(DeviceInstanceRegistryPath,
01123                                           &amp;unicodeKeyName,
01124                                           NULL)) {
01125 
01126             <span class="keywordflow">if</span>(ARGUMENT_PRESENT(DeviceInstanceHandle)) {
01127                 ZwClose(*DeviceInstanceHandle);
01128             }
01129             status = STATUS_INSUFFICIENT_RESOURCES;
01130         }
01131     }
01132 
01133 PrepareForReturn:
01134 
01135     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01136     <span class="keywordflow">return</span> status;
01137 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="pri_bld/pnpsubs.c::IopSetDeviceInstanceCsConfigFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSetDeviceInstanceCsConfigFlags           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Instance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CsConfigFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01531">1531</a> of file <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html">pri_bld/pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01588">IopOpenCurrentHwProfileDeviceInstanceKey()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01539                    :
01540 
01541     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> csconfig flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device
01542     which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance number under ServiceKeyName\Enum.
01543 
01544 Arguments:
01545 
01546     ServiceKeyName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01547         system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)
01548         that caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RegistryPath parameter
01549         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> routine.
01550 
01551     Instance - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance value under ServiceKeyName\Enum key
01552 
01553     CsConfigFlags - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance's <span class="keyword">new</span> CsConfigFlags
01554 
01555 Return Value:
01556 
01557     status
01558 
01559 --*/
01560 
01561 {
01562     HANDLE handle;
01563     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01564     UNICODE_STRING tempUnicodeString;
01565 
01566     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a11">IopOpenCurrentHwProfileDeviceInstanceKey</a>(&amp;handle,
01567                                                       ServiceKeyName,
01568                                                       Instance,
01569                                                       KEY_READ | KEY_WRITE,
01570                                                       TRUE
01571                                                      );
01572     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01573 
01574         PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_VALUE_CSCONFIG_FLAGS);
01575         status = ZwSetValueKey(handle,
01576                                &amp;tempUnicodeString,
01577                                TITLE_INDEX_VALUE,
01578                                REG_DWORD,
01579                                &amp;CsConfigFlags,
01580                                <span class="keyword">sizeof</span>(CsConfigFlags)
01581                               );
01582         ZwClose(handle);
01583     }
01584     <span class="keywordflow">return</span> status;
01585 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:16 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
