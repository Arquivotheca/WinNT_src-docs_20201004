<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rtlexec.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rtlexec.c File Reference</h1><code>#include "<a class="el" href="../../d6/d8/ntrtlp_8h-source.html">ntrtlp.h</a>"</code><br>
<code>#include &lt;nturtl.h&gt;</code><br>
<code>#include &lt;string.h&gt;</code><br>
<code>#include "<a class="el" href="../../d9/d0/init_8h-source.html">init.h</a>"</code><br>
<code>#include "<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>"</code><br>

<p>
<a href="../../d1/d1/rtlexec_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/rtlexec_8c.html#a0">ROUND_UP</a>(x, y)&nbsp;&nbsp;&nbsp;((ULONG)(x) + ((y)-1) &amp; ~((y)-1))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/rtlexec_8c.html#a1">ISTERMINALSERVER</a>()&nbsp;&nbsp;&nbsp;(USER_SHARED_DATA-&gt;SuiteMask &amp; (1 &lt;&lt; TerminalServer))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>(Base, p)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>(Base, p)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a> (IN OUT PWSTR *pDst, OUT PUNICODE_STRING <a class="el" href="../../d0/d2/usrbench_8h.html#a35">DestString</a>, IN PUNICODE_STRING <a class="el" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>, IN ULONG DstAlloc OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/rtlexec_8c.html#a5">RtlpOpenImageFile</a> (IN PUNICODE_STRING ImagePathName, IN ULONG Attributes, OUT PHANDLE FileHandle, IN BOOLEAN ReportErrors)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/rtlexec_8c.html#a6">RtlpFreeStack</a> (IN HANDLE Process, IN PINITIAL_TEB <a class="el" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/rtlexec_8c.html#a7">RtlpCreateStack</a> (IN HANDLE Process, IN SIZE_T MaximumStackSize OPTIONAL, IN SIZE_T CommittedStackSize OPTIONAL, IN ULONG ZeroBits OPTIONAL, OUT PINITIAL_TEB <a class="el" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/rtlexec_8c.html#a8">RtlCreateProcessParameters</a> (OUT PRTL_USER_PROCESS_PARAMETERS *ProcessParameters, IN PUNICODE_STRING ImagePathName, IN PUNICODE_STRING DllPath OPTIONAL, IN PUNICODE_STRING <a class="el" href="../../d2/d5/editreg_8c.html#a47">CurrentDirectory</a> OPTIONAL, IN PUNICODE_STRING <a class="el" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a> OPTIONAL, IN PVOID Environment OPTIONAL, IN PUNICODE_STRING WindowTitle OPTIONAL, IN PUNICODE_STRING DesktopInfo OPTIONAL, IN PUNICODE_STRING ShellInfo OPTIONAL, IN PUNICODE_STRING RuntimeData OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/rtlexec_8c.html#a9">RtlDestroyProcessParameters</a> (IN PRTL_USER_PROCESS_PARAMETERS ProcessParameters)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PRTL_USER_PROCESS_PARAMETERS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/rtlexec_8c.html#a10">RtlNormalizeProcessParams</a> (IN OUT PRTL_USER_PROCESS_PARAMETERS ProcessParameters)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PRTL_USER_PROCESS_PARAMETERS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/rtlexec_8c.html#a11">RtlDeNormalizeProcessParams</a> (IN OUT PRTL_USER_PROCESS_PARAMETERS ProcessParameters)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/rtlexec_8c.html#a12">RtlCreateUserProcess</a> (IN PUNICODE_STRING NtImagePathName, IN ULONG Attributes, IN PRTL_USER_PROCESS_PARAMETERS ProcessParameters, IN PSECURITY_DESCRIPTOR ProcessSecurityDescriptor OPTIONAL, IN PSECURITY_DESCRIPTOR ThreadSecurityDescriptor OPTIONAL, IN HANDLE ParentProcess OPTIONAL, IN BOOLEAN InheritHandles, IN HANDLE <a class="el" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a> OPTIONAL, IN HANDLE ExceptionPort OPTIONAL, OUT PRTL_USER_PROCESS_INFORMATION ProcessInformation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a> (IN HANDLE Process, IN PSECURITY_DESCRIPTOR ThreadSecurityDescriptor OPTIONAL, IN BOOLEAN CreateSuspended, IN ULONG ZeroBits OPTIONAL, IN SIZE_T MaximumStackSize OPTIONAL, IN SIZE_T CommittedStackSize OPTIONAL, IN PUSER_THREAD_START_ROUTINE StartAddress, IN PVOID Parameter OPTIONAL, OUT PHANDLE Thread OPTIONAL, OUT PCLIENT_ID ClientId OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/rtlexec_8c.html#a14">RtlFreeUserThreadStack</a> (HANDLE hProcess, HANDLE hThread)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="rtlexec.c::ISTERMINALSERVER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ISTERMINALSERVER          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(USER_SHARED_DATA-&gt;SuiteMask &amp; (1 &lt;&lt; TerminalServer))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00034">34</a> of file <a class="el" href="../../d1/d1/rtlexec_8c-source.html">rtlexec.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00813">RtlCreateUserProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="rtlexec.c::ROUND_UP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ROUND_UP          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">x,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>y&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((ULONG)(x) + ((y)-1) &amp; ~((y)-1))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00030">30</a> of file <a class="el" href="../../d1/d1/rtlexec_8c-source.html">rtlexec.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="rtlexec.c::RtlpDeNormalizeProcessParam" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RtlpDeNormalizeProcessParam          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Base,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>p&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> ((p) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {                              \
        (p) = (PWSTR)((PCHAR)(p) - (ULONG_PTR)(Base));  \
        }                                           \
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00388">388</a> of file <a class="el" href="../../d1/d1/rtlexec_8c-source.html">rtlexec.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00444">RtlDeNormalizeProcessParams()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="rtlexec.c::RtlpNormalizeProcessParam" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RtlpNormalizeProcessParam          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Base,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>p&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> ((p) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {                              \
        (p) = (PWSTR)((PCHAR)(p) + (ULONG_PTR)(Base));  \
        }                                           \
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00383">383</a> of file <a class="el" href="../../d1/d1/rtlexec_8c-source.html">rtlexec.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00395">RtlNormalizeProcessParams()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a8" doxytag="rtlexec.c::RtlCreateProcessParameters" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlCreateProcessParameters           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PRTL_USER_PROCESS_PARAMETERS *&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessParameters</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ImagePathName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING DllPath&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING <a class="el" href="../../d2/d5/editreg_8c.html#a47">CurrentDirectory</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING <a class="el" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Environment&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING WindowTitle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING DesktopInfo&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING ShellInfo&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING RuntimeData&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00110">110</a> of file <a class="el" href="../../d1/d1/rtlexec_8c-source.html">rtlexec.c</a>.
<p>
References <a class="el" href="../../d3/d4/editreg_8c-source.html#l00314">CommandLine</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00308">CurrentDirectory</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d3/d3/eballoc_8c-source.html#l00032">RtlAcquirePebLock()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00444">RtlDeNormalizeProcessParams()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00365">RtlDestroyProcessParameters()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00083">RtlpCopyProcString()</a>, <a class="el" href="../../d3/d3/eballoc_8c-source.html#l00047">RtlReleasePebLock()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01093">SepServerSpawnClientProcess()</a>.
<p>
<pre class="fragment"><div>00125                    :
00126 
00127     This function formats NT style RTL_USER_PROCESS_PARAMETERS
00128     record.  The record <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">self</span>-contained in a single block of memory
00129     allocated by <span class="keyword">this</span> function.  The allocation method <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> opaque and
00130     thus <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> record must be freed by calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00131     <a class="code" href="../../d0/d2/rtlexec_8c.html#a9">RtlDestroyProcessParameters</a> function.
00132 
00133     The process parameters record <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created in a de-normalized form,
00134     thus making <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> suitable <span class="keywordflow">for</span> passing to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/rtlexec_8c.html#a12">RtlCreateUserProcess</a>
00135     function.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller will fill in additional
00136     fields in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process parameters record after <span class="keyword">this</span> function returns,
00137     but prior to calling <a class="code" href="../../d0/d2/rtlexec_8c.html#a12">RtlCreateUserProcess</a>.
00138 
00139 Arguments:
00140 
00141     ProcessParameters - Pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address
00142         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process parameter structure created by <span class="keyword">this</span> routinue.  The
00143         memory <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated in an opaque manner and must
00144         be freed by calling <a class="code" href="../../d0/d2/rtlexec_8c.html#a9">RtlDestroyProcessParameters</a>.
00145 
00146     ImagePathName - Required parameter that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fully qualified NT
00147         <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> that will be used to create <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process
00148         that will received these parameters.
00149 
00150     DllPath - An optional parameter that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an NT <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> variable pointing
00151         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> search <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT Loader <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process
00152         when searching <span class="keywordflow">for</span> Dll modules.  If not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Dll
00153         search <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> filled in from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process's Dll search
00154         <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
00155 
00156     <a class="code" href="../../d2/d5/editreg_8c.html#a47">CurrentDirectory</a> - An optional parameter that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an NT <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> variable
00157         pointing to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> directory string <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process.
00158         If not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current directory string <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> filled in
00159         from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process's current directory string.
00160 
00161     <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a> - An optional parameter that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an NT <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> variable that
00162         will be passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process as its command line.  If not
00163         specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> command line passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process will
00164         be a null string.
00165 
00166     Environment - An optional parameter that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an opaque pointer to an
00167         environment variable block of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> created by
00168         <a class="code" href="../../d5/d7/environ_8c.html#a3">RtlCreateEnvironment</a> routine.  If not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target
00169         process will receive a copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling process's environment
00170         variable block.
00171 
00172     WindowTitle - An optional parameter that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an NT <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> variable that
00173         points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> title string <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to use <span class="keywordflow">for</span> its
00174         <a class="code" href="../../d3/d9/arcinst_8c.html#a19">main</a> window.  If not specified, then a null string will be passed
00175         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process as its <span class="keywordflow">default</span> window title.
00176 
00177     DesktopInfo - An optional parameter that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an NT <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> variable that
00178         contains uninterpreted data that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed as <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target
00179         process.  If not specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process will receive a
00180         pointer to an empty string.
00181 
00182     ShellInfo - An optional parameter that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an NT <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> variable that
00183         contains uninterpreted data that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed as <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target
00184         process.  If not specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process will receive a
00185         pointer to an empty string.
00186 
00187     RuntimeData - An optional parameter that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an NT <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> variable that
00188         contains uninterpreted data that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed as <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target
00189         process.  If not specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process will receive a
00190         pointer to an empty string.
00191 
00192 Return Value:
00193 
00194     STATUS_SUCCESS - The process parameters <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> De-Normalized and
00195         contains entries <span class="keywordflow">for</span> each of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified argument and variable
00196         strings.
00197 
00198     STATUS_BUFFER_TOO_SMALL - The specified process parameters buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00199         too small to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> argument and environment strings. The value
00200         of ProcessParameters-&gt;Length <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> modified to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer
00201         size needed to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> argument and variable strings.
00202 
00203 --*/
00204 
00205 {
00206     PRTL_USER_PROCESS_PARAMETERS p;
00207     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00208     UNICODE_STRING NullString = {0, 1, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>};
00209     ULONG ByteCount;
00210     SIZE_T MaxByteCount;
00211     PWSTR pDst;
00212     PPEB Peb = NtCurrentPeb();
00213     HANDLE CurDirHandle;
00214 
00215     <span class="comment">//</span>
00216     <span class="comment">// Acquire the Peb Lock for the duration while we copy information out</span>
00217     <span class="comment">// of it.</span>
00218     <span class="comment">//</span>
00219 
00220     <a class="code" href="../../d2/d4/eballoc_8c.html#a1">RtlAcquirePebLock</a>();
00221     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00222     p = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00223     CurDirHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00224     <span class="keywordflow">try</span> {
00225         <span class="comment">//</span>
00226         <span class="comment">// For optional pointer parameters, default them to point to their</span>
00227         <span class="comment">// corresponding field in the current process's process parameter</span>
00228         <span class="comment">// structure or to a null string.</span>
00229         <span class="comment">//</span>
00230 
00231         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( DllPath )) {
00232             DllPath = &amp;Peb-&gt;ProcessParameters-&gt;DllPath;
00233             }
00234 
00235         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( CurrentDirectory )) {
00236 
00237             <span class="keywordflow">if</span> ( Peb-&gt;ProcessParameters-&gt;CurrentDirectory.Handle ) {
00238                 CurDirHandle = (HANDLE)((ULONG_PTR)Peb-&gt;ProcessParameters-&gt;CurrentDirectory.Handle &amp; ~OBJ_HANDLE_TAGBITS);
00239                 CurDirHandle = (HANDLE)((ULONG_PTR)CurDirHandle | RTL_USER_PROC_CURDIR_INHERIT);
00240                 }
00241             <a class="code" href="../../d2/d5/editreg_8c.html#a47">CurrentDirectory</a> = &amp;Peb-&gt;ProcessParameters-&gt;CurrentDirectory.DosPath;
00242             }
00243         <span class="keywordflow">else</span> {
00244             <span class="keywordflow">if</span> ( Peb-&gt;ProcessParameters-&gt;CurrentDirectory.Handle ) {
00245                 CurDirHandle = (HANDLE)((ULONG_PTR)Peb-&gt;ProcessParameters-&gt;CurrentDirectory.Handle &amp; ~OBJ_HANDLE_TAGBITS);
00246                 CurDirHandle = (HANDLE)((ULONG_PTR)CurDirHandle | RTL_USER_PROC_CURDIR_CLOSE);
00247                 }
00248             }
00249 
00250         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( CommandLine )) {
00251             <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a> = ImagePathName;
00252             }
00253 
00254         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( Environment )) {
00255             Environment = Peb-&gt;ProcessParameters-&gt;Environment;
00256             }
00257 
00258         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( WindowTitle )) {
00259             WindowTitle = &amp;NullString;
00260             }
00261 
00262         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( DesktopInfo )) {
00263             DesktopInfo = &amp;NullString;
00264             }
00265 
00266         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( ShellInfo )) {
00267             ShellInfo = &amp;NullString;
00268             }
00269 
00270         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( RuntimeData )) {
00271             RuntimeData = &amp;NullString;
00272             }
00273 
00274         <span class="comment">//</span>
00275         <span class="comment">// Determine size need to contain the process parameter record</span>
00276         <span class="comment">// structure and all of the strings it will point to.  Each string</span>
00277         <span class="comment">// will be aligned on a ULONG byte boundary.</span>
00278         <span class="comment">//</span>
00279 
00280         ByteCount = <span class="keyword">sizeof</span>( **ProcessParameters );
00281         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( ImagePathName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL),    <span class="keyword">sizeof</span>( ULONG ) );
00282         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( DllPath-&gt;MaximumLength,       <span class="keyword">sizeof</span>( ULONG ) );
00283         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( DOS_MAX_PATH_LENGTH*2,        <span class="keyword">sizeof</span>( ULONG ) );
00284         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL),      <span class="keyword">sizeof</span>( ULONG ) );
00285         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( WindowTitle-&gt;MaximumLength,   <span class="keyword">sizeof</span>( ULONG ) );
00286         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( DesktopInfo-&gt;MaximumLength,   <span class="keyword">sizeof</span>( ULONG ) );
00287         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( ShellInfo-&gt;MaximumLength,     <span class="keyword">sizeof</span>( ULONG ) );
00288         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( RuntimeData-&gt;MaximumLength,   <span class="keyword">sizeof</span>( ULONG ) );
00289 
00290         <span class="comment">//</span>
00291         <span class="comment">// Allocate memory for the process parameter record.</span>
00292         <span class="comment">//</span>
00293 
00294         MaxByteCount = ByteCount;
00295         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( NtCurrentProcess(),
00296                                           (PVOID *)&amp;p,
00297                                           0,
00298                                           &amp;MaxByteCount,
00299                                           MEM_COMMIT,
00300                                           PAGE_READWRITE
00301                                         );
00302         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00303             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00304             }
00305 
00306         p-&gt;MaximumLength = (ULONG) MaxByteCount;
00307         p-&gt;Length = ByteCount;
00308         p-&gt;Flags = RTL_USER_PROC_PARAMS_NORMALIZED;
00309         p-&gt;Environment = Environment;
00310         p-&gt;CurrentDirectory.Handle = CurDirHandle;
00311 
00312         <span class="comment">//</span>
00313         <span class="comment">// Inherits ^C inhibit information</span>
00314         <span class="comment">//</span>
00315 
00316         p-&gt;ConsoleFlags = Peb-&gt;ProcessParameters-&gt;ConsoleFlags;
00317 
00318         pDst = (PWSTR)(p + 1);
00319         <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst,
00320                             &amp;p-&gt;CurrentDirectory.DosPath,
00321                             CurrentDirectory,
00322                             DOS_MAX_PATH_LENGTH*2
00323                           );
00324 
00325         <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;DllPath, DllPath, 0 );
00326         <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;ImagePathName, ImagePathName, ImagePathName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL) );
00327         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>-&gt;Length == <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>-&gt;MaximumLength) {
00328             <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;CommandLine, CommandLine, 0 );
00329             }
00330         <span class="keywordflow">else</span> {
00331             <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;CommandLine, CommandLine, <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL) );
00332             }
00333         <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;WindowTitle, WindowTitle, 0 );
00334         <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;DesktopInfo, DesktopInfo, 0 );
00335         <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;ShellInfo,   ShellInfo, 0 );
00336         <span class="keywordflow">if</span> (RuntimeData-&gt;Length != 0) {
00337             <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;RuntimeData, RuntimeData, 0 );
00338             }
00339         <span class="keywordflow">else</span> {
00340             p-&gt;RuntimeData.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00341             p-&gt;RuntimeData.Length = 0;
00342             p-&gt;RuntimeData.MaximumLength = 0;
00343             }
00344         *ProcessParameters = <a class="code" href="../../d0/d2/rtlexec_8c.html#a11">RtlDeNormalizeProcessParams</a>( p );
00345         p = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00346         }
00347     finally {
00348         <span class="keywordflow">if</span> (AbnormalTermination()) {
00349             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_VIOLATION;
00350             }
00351 
00352         <span class="keywordflow">if</span> (p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00353             <a class="code" href="../../d0/d2/rtlexec_8c.html#a9">RtlDestroyProcessParameters</a>( p );
00354             }
00355 
00356         <a class="code" href="../../d2/d4/eballoc_8c.html#a2">RtlReleasePebLock</a>();
00357         }
00358 
00359     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00360 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="rtlexec.c::RtlCreateUserProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlCreateUserProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>NtImagePathName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PRTL_USER_PROCESS_PARAMETERS&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessParameters</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR ProcessSecurityDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR ThreadSecurityDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE ParentProcess&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritHandles</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE <a class="el" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE ExceptionPort&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PRTL_USER_PROCESS_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00813">813</a> of file <a class="el" href="../../d1/d1/rtlexec_8c-source.html">rtlexec.c</a>.
<p>
References <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00026">DebugPort</a>, <a class="el" href="../../d2/d8/icmui_8def-source.html#l00004">File</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00034">ISTERMINALSERVER</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l01241">RtlCreateUserThread()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01432">RtlGetNtGlobalFlags()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00493">RtlpOpenImageFile()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00844">Unicode</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/uexec_8c-source.html#l00030">main()</a>, and <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01093">SepServerSpawnClientProcess()</a>.
<p>
<pre class="fragment"><div>00828                    :
00829 
00830     This function creates a user mode process with a single thread with
00831     a suspend count of one.  The address space of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00832     initialized with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of specified image <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  The caller
00833     can specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Access Control <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process and thread.
00834     The caller can also specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent process to inherit process
00835     priority and processor affinity from.  The <span class="keywordflow">default</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to inherit
00836     these from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.  Finally <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller can specify
00837     whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to inherit any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object handles
00838     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified parent process or not.
00839 
00840     Information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process and thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned via
00841     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ProcessInformation parameter.
00842 
00843 Arguments:
00844 
00845     NtImagePathName - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> required pointer that points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT Path string
00846         that identifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be loaded into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00847         child process.
00848 
00849     ProcessParameters - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> required pointer that points to parameters that
00850         are to passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child process.
00851 
00852     ProcessSecurityDescriptor - An optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Security Descriptor
00853         give to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process.
00854 
00855     ThreadSecurityDescriptor - An optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Security Descriptor
00856         give to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> thread.
00857 
00858     ParentProcess - An optional process handle that will used to inherit
00859         certain properties from.
00860 
00861     InheritHandles - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> value.  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> specifies that object handles
00862         associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified parent process are to be inherited
00863         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process, provided they have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OBJ_INHERIT attribute.
00864         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to inherit no handles.
00865 
00866     <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a> - An optional handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debug port associated with <span class="keyword">this</span>
00867         process.
00868 
00869     ExceptionPort - An optional handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception port associated with <span class="keyword">this</span>
00870         process.
00871 
00872     ProcessInformation - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a variable that receives information
00873         about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process and thread.
00874 
00875 Return Value:
00876 
00877     TBS.
00878 
00879 --*/
00880 
00881 {
00882     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00883     HANDLE Section, <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
00884     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00885     PRTL_USER_PROCESS_PARAMETERS Parameters;
00886     SIZE_T ParameterLength;
00887     PVOID Environment;
00888     PWCHAR s;
00889     ULONG EnvironmentLength;
00890     SIZE_T RegionSize;
00891     PROCESS_BASIC_INFORMATION ProcessInfo;
00892     PPEB Peb;
00893     UNICODE_STRING <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>;
00894 
00895     <span class="comment">//</span>
00896     <span class="comment">// Zero output parameter and probe the addresses at the same time</span>
00897     <span class="comment">//</span>
00898 
00899     RtlZeroMemory( ProcessInformation, <span class="keyword">sizeof</span>( *ProcessInformation ) );
00900     ProcessInformation-&gt;Length = <span class="keyword">sizeof</span>( *ProcessInformation );
00901 
00902     <span class="comment">//</span>
00903     <span class="comment">// Open the specified image file.</span>
00904     <span class="comment">//</span>
00905 
00906     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a5">RtlpOpenImageFile</a>( NtImagePathName,
00907                                 Attributes &amp; (OBJ_INHERIT | OBJ_CASE_INSENSITIVE),
00908                                 &amp;File,
00909                                 TRUE
00910                               );
00911     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00912         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00913         }
00914 
00915 
00916     <span class="comment">//</span>
00917     <span class="comment">// Create a memory section backed by the opened image file</span>
00918     <span class="comment">//</span>
00919 
00920     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateSection( &amp;Section,
00921                               SECTION_ALL_ACCESS,
00922                               NULL,
00923                               NULL,
00924                               PAGE_EXECUTE,
00925                               SEC_IMAGE,
00926                               File
00927                             );
00928     ZwClose( File );
00929     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
00930         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00931         }
00932 
00933 
00934     <span class="comment">//</span>
00935     <span class="comment">// Create the user mode process, defaulting the parent process to the</span>
00936     <span class="comment">// current process if one is not specified.  The new process will not</span>
00937     <span class="comment">// have a name nor will the handle be inherited by other processes.</span>
00938     <span class="comment">//</span>
00939 
00940     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( ParentProcess )) {
00941         ParentProcess = NtCurrentProcess();
00942         }
00943 
00944     InitializeObjectAttributes( &amp;ObjectAttributes, NULL, 0, NULL,
00945                                 ProcessSecurityDescriptor );
00946     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a25">RtlGetNtGlobalFlags</a>() &amp; FLG_ENABLE_CSRDEBUG ) {
00947         <span class="keywordflow">if</span> ( wcsstr(NtImagePathName-&gt;Buffer,L<span class="stringliteral">"csrss"</span>) ||
00948              wcsstr(NtImagePathName-&gt;Buffer,L<span class="stringliteral">"CSRSS"</span>)
00949            ) {
00950 
00951             <span class="comment">//</span>
00952             <span class="comment">// For Hydra we don't name the CSRSS process to avoid name</span>
00953             <span class="comment">// collissions when multiple CSRSS's are started</span>
00954             <span class="comment">//</span>
00955             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/rtlexec_8c.html#a1">ISTERMINALSERVER</a>()) {
00956 
00957                 InitializeObjectAttributes( &amp;ObjectAttributes, NULL, 0, NULL,
00958                                             ProcessSecurityDescriptor );
00959             } <span class="keywordflow">else</span> {
00960 
00961                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Unicode,L<span class="stringliteral">"\\WindowsSS"</span>);
00962                 InitializeObjectAttributes( &amp;ObjectAttributes, &amp;Unicode, 0, NULL,
00963                                             ProcessSecurityDescriptor );
00964             }
00965 
00966             }
00967         }
00968 
00969     <span class="keywordflow">if</span> ( !InheritHandles ) {
00970         ProcessParameters-&gt;CurrentDirectory.Handle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00971         }
00972     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateProcess( &amp;ProcessInformation-&gt;Process,
00973                               PROCESS_ALL_ACCESS,
00974                               &amp;ObjectAttributes,
00975                               ParentProcess,
00976                               InheritHandles,
00977                               Section,
00978                               DebugPort,
00979                               ExceptionPort
00980                             );
00981     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
00982         ZwClose( Section );
00983         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00984         }
00985 
00986 
00987     <span class="comment">//</span>
00988     <span class="comment">// Retreive the interesting information from the image header</span>
00989     <span class="comment">//</span>
00990 
00991     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQuerySection( Section,
00992                              SectionImageInformation,
00993                              &amp;ProcessInformation-&gt;ImageInformation,
00994                              <span class="keyword">sizeof</span>( ProcessInformation-&gt;ImageInformation ),
00995                              NULL
00996                            );
00997     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
00998         ZwClose( ProcessInformation-&gt;Process );
00999         ZwClose( Section );
01000         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01001         }
01002 
01003     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryInformationProcess( ProcessInformation-&gt;Process,
01004                                         ProcessBasicInformation,
01005                                         &amp;ProcessInfo,
01006                                         <span class="keyword">sizeof</span>( ProcessInfo ),
01007                                         NULL
01008                                       );
01009     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
01010         ZwClose( ProcessInformation-&gt;Process );
01011         ZwClose( Section );
01012         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01013         }
01014 
01015     Peb = ProcessInfo.PebBaseAddress;
01016 
01017     <span class="comment">//</span>
01018     <span class="comment">// Duplicate Native handles into new process if any specified.</span>
01019     <span class="comment">// Note that the duplicated handles will overlay the input values.</span>
01020     <span class="comment">//</span>
01021 
01022     <span class="keywordflow">try</span> {
01023         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01024 
01025         <span class="keywordflow">if</span> ( ProcessParameters-&gt;StandardInput ) {
01026 
01027             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDuplicateObject(
01028                         ParentProcess,
01029                         ProcessParameters-&gt;StandardInput,
01030                         ProcessInformation-&gt;Process,
01031                         &amp;ProcessParameters-&gt;StandardInput,
01032                         0L,
01033                         0L,
01034                         DUPLICATE_SAME_ACCESS | DUPLICATE_SAME_ATTRIBUTES
01035                         );
01036             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01037                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01038             }
01039         }
01040 
01041         <span class="keywordflow">if</span> ( ProcessParameters-&gt;StandardOutput ) {
01042 
01043             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDuplicateObject(
01044                         ParentProcess,
01045                         ProcessParameters-&gt;StandardOutput,
01046                         ProcessInformation-&gt;Process,
01047                         &amp;ProcessParameters-&gt;StandardOutput,
01048                         0L,
01049                         0L,
01050                         DUPLICATE_SAME_ACCESS | DUPLICATE_SAME_ATTRIBUTES
01051                         );
01052             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01053                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01054             }
01055         }
01056 
01057         <span class="keywordflow">if</span> ( ProcessParameters-&gt;StandardError ) {
01058 
01059             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDuplicateObject(
01060                         ParentProcess,
01061                         ProcessParameters-&gt;StandardError,
01062                         ProcessInformation-&gt;Process,
01063                         &amp;ProcessParameters-&gt;StandardError,
01064                         0L,
01065                         0L,
01066                         DUPLICATE_SAME_ACCESS | DUPLICATE_SAME_ATTRIBUTES
01067                         );
01068             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01069                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01070             }
01071         }
01072 
01073     } finally {
01074         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01075             ZwClose( ProcessInformation-&gt;Process );
01076             ZwClose( Section );
01077             }
01078         }
01079 
01080     <span class="comment">//</span>
01081     <span class="comment">// Possibly reserve some address space in the new process</span>
01082     <span class="comment">//</span>
01083 
01084     <span class="keywordflow">if</span> (ProcessInformation-&gt;ImageInformation.SubSystemType == IMAGE_SUBSYSTEM_NATIVE ) {
01085         <span class="keywordflow">if</span> ( ProcessParameters-&gt;Flags &amp; RTL_USER_PROC_RESERVE_1MB ) {
01086 
01087 <span class="preprocessor">#if defined(_IA64_)</span>
01088 <span class="preprocessor"></span>            Environment = (PVOID)(UADDRESS_BASE+4);
01089 <span class="preprocessor">#else</span>
01090 <span class="preprocessor"></span>            Environment = (PVOID)(4);
01091 <span class="preprocessor">#endif</span>
01092 <span class="preprocessor"></span>            RegionSize = (1024*1024)-(256);
01093 
01094             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( ProcessInformation-&gt;Process,
01095                                               (PVOID *)&amp;Environment,
01096                                               0,
01097                                               &amp;RegionSize,
01098                                               MEM_RESERVE,
01099                                               PAGE_READWRITE
01100                                             );
01101             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
01102                 ZwClose( ProcessInformation-&gt;Process );
01103                 ZwClose( Section );
01104                 <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01105                 }
01106             }
01107         }
01108 
01109     <span class="comment">//</span>
01110     <span class="comment">// Allocate virtual memory in the new process and use NtWriteVirtualMemory</span>
01111     <span class="comment">// to write a copy of the process environment block into the address</span>
01112     <span class="comment">// space of the new process.  Save the address of the allocated block in</span>
01113     <span class="comment">// the process parameter block so the new process can access it.</span>
01114     <span class="comment">//</span>
01115 
01116     <span class="keywordflow">if</span> (s = (PWCHAR)ProcessParameters-&gt;Environment) {
01117         <span class="keywordflow">while</span> (*s++) {
01118             <span class="keywordflow">while</span> (*s++) {
01119                 }
01120             }
01121         EnvironmentLength = (ULONG)(s - (PWCHAR)ProcessParameters-&gt;Environment) * <span class="keyword">sizeof</span>(WCHAR);
01122 
01123         Environment = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01124         RegionSize = EnvironmentLength;
01125         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( ProcessInformation-&gt;Process,
01126                                           (PVOID *)&amp;Environment,
01127                                           0,
01128                                           &amp;RegionSize,
01129                                           MEM_COMMIT,
01130                                           PAGE_READWRITE
01131                                         );
01132         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
01133             ZwClose( ProcessInformation-&gt;Process );
01134             ZwClose( Section );
01135             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01136             }
01137 
01138         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwWriteVirtualMemory( ProcessInformation-&gt;Process,
01139                                        Environment,
01140                                        ProcessParameters-&gt;Environment,
01141                                        EnvironmentLength,
01142                                        NULL
01143                                      );
01144         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
01145             ZwClose( ProcessInformation-&gt;Process );
01146             ZwClose( Section );
01147             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01148             }
01149 
01150         ProcessParameters-&gt;Environment = Environment;
01151         }
01152 
01153     <span class="comment">//</span>
01154     <span class="comment">// Allocate virtual memory in the new process and use NtWriteVirtualMemory</span>
01155     <span class="comment">// to write a copy of the process parameters block into the address</span>
01156     <span class="comment">// space of the new process.  Set the initial parameter to the new thread</span>
01157     <span class="comment">// to be the address of the block in the new process's address space.</span>
01158     <span class="comment">//</span>
01159 
01160     Parameters = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01161     ParameterLength = ProcessParameters-&gt;MaximumLength;
01162     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( ProcessInformation-&gt;Process,
01163                                       (PVOID *)&amp;Parameters,
01164                                       0,
01165                                       &amp;ParameterLength,
01166                                       MEM_COMMIT,
01167                                       PAGE_READWRITE
01168                                     );
01169     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
01170         ZwClose( ProcessInformation-&gt;Process );
01171         ZwClose( Section );
01172         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01173         }
01174 
01175     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwWriteVirtualMemory( ProcessInformation-&gt;Process,
01176                                    Parameters,
01177                                    ProcessParameters,
01178                                    ProcessParameters-&gt;Length,
01179                                    NULL
01180                                  );
01181     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
01182             ZwClose( ProcessInformation-&gt;Process );
01183             ZwClose( Section );
01184             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01185             }
01186 
01187     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwWriteVirtualMemory( ProcessInformation-&gt;Process,
01188                                    &amp;Peb-&gt;ProcessParameters,
01189                                    &amp;Parameters,
01190                                    <span class="keyword">sizeof</span>( Parameters ),
01191                                    NULL
01192                                  );
01193     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
01194         ZwClose( ProcessInformation-&gt;Process );
01195         ZwClose( Section );
01196         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01197         }
01198 
01199     <span class="comment">//</span>
01200     <span class="comment">// Create a suspended thread in the new process.  Specify the size and</span>
01201     <span class="comment">// position of the stack, along with the start address, initial parameter</span>
01202     <span class="comment">// and an SECURITY_DESCRIPTOR.  The new thread will not have a name and its handle will</span>
01203     <span class="comment">// not be inherited by other processes.</span>
01204     <span class="comment">//</span>
01205 
01206     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>(
01207                  ProcessInformation-&gt;Process,
01208                  ThreadSecurityDescriptor,
01209                  TRUE,
01210                  ProcessInformation-&gt;ImageInformation.ZeroBits,
01211                  ProcessInformation-&gt;ImageInformation.MaximumStackSize,
01212                  ProcessInformation-&gt;ImageInformation.CommittedStackSize,
01213                  (PUSER_THREAD_START_ROUTINE)
01214                      ProcessInformation-&gt;ImageInformation.TransferAddress,
01215                  (PVOID)Peb,
01216                  &amp;ProcessInformation-&gt;Thread,
01217                  &amp;ProcessInformation-&gt;ClientId
01218                  );
01219     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
01220         ZwClose( ProcessInformation-&gt;Process );
01221         ZwClose( Section );
01222         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01223         }
01224 
01225     <span class="comment">//</span>
01226     <span class="comment">// Now close the section and file handles.  The objects they represent</span>
01227     <span class="comment">// will not actually go away until the process is destroyed.</span>
01228     <span class="comment">//</span>
01229 
01230     ZwClose( Section );
01231 
01232     <span class="comment">//</span>
01233     <span class="comment">// Return success status</span>
01234     <span class="comment">//</span>
01235 
01236     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01237 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="rtlexec.c::RtlCreateUserThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlCreateUserThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR ThreadSecurityDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateSuspended</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG ZeroBits&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T MaximumStackSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T CommittedStackSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUSER_THREAD_START_ROUTINE&nbsp;</td>
          <td class="mdname" nowrap> <em>StartAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Parameter&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE Thread&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCLIENT_ID ClientId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l01241">1241</a> of file <a class="el" href="../../d1/d1/rtlexec_8c-source.html">rtlexec.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00134">InitialTeb</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d7/d5/rtl_2ppc_2context_8c-source.html#l00031">RtlInitializeContext()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00539">RtlpCreateStack()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00783">RtlpFreeStack()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00136">ThreadClientId</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00137">ThreadContext</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00429">DbgSsInitialize()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00626">InitWindowsStuff()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01599">ProcessHardErrorRequest()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00813">RtlCreateUserProcess()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02677">RtlpStartThread()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00469">RtlQueryProcessDebugInformation()</a>, <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00069">UdbgTest1()</a>, <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00280">UdbgTest2()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00192">UserServerDllInitialization()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l00504">W32WinStationDoConnect()</a>, and <a class="el" href="../../d3/d7/api_8c-source.html#l00212">WinStationAPIInit()</a>.
<p>
<pre class="fragment"><div>01256                    :
01257 
01258     This function creates a user mode thread in a user process.  The caller
01259     specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> thread.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread, along
01260     with its Client Id are returned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
01261 
01262 Arguments:
01263 
01264     Process - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process in which to create <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> thread.
01265 
01266     ThreadSecurityDescriptor - An optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Security Descriptor
01267         give to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> thread.
01268 
01269     CreateSuspended - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> parameter that specifies whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
01270         thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be created suspended or not.  If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> thread
01271         will be created with an initial suspend count of 1.  If <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> then
01272         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> thread will be ready to run when <span class="keyword">this</span> call returns.
01273 
01274     ZeroBits - This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> memory manager
01275         when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated.  Stacks are always allocated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01276         MEM_TOP_DOWN allocation attribute.
01277 
01278     MaximumStackSize - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack.  This size
01279         will be rounded up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next highest page boundary.  If zero <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01280         specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> size will be 64K bytes.
01281 
01282     CommittedStackSize - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial committed size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack.  This
01283         size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next highest page boundary and then an
01284         additional page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> added <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> guard page.  The resulting size
01285         will then be commited and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> guard page protection initialized
01286         <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last committed page in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack.
01287 
01288     StartAddress - The initial starting address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
01289 
01290     Parameter - An optional pointer to a 32-bit pointer parameter that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01291         passed as a single argument to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start address
01292         location.
01293 
01294     Thread - An optional pointer that, <span class="keywordflow">if</span> specified, points to a variable that
01295         will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> thread.
01296 
01297     ClientId - An optional pointer that, <span class="keywordflow">if</span> specified, points to a variable
01298         that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Client Id of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> thread.
01299 
01300 Return Value:
01301 
01302     TBS
01303 
01304 --*/
01305 
01306 {
01307     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01308     CONTEXT <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>;
01309     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01310     INITIAL_TEB <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>;
01311     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
01312     CLIENT_ID <a class="code" href="../../d2/d1/cttoken_8c.html#a61">ThreadClientId</a>;
01313 
01314     <span class="comment">//</span>
01315     <span class="comment">// Allocate a stack for this thread in the address space of the target</span>
01316     <span class="comment">// process.</span>
01317     <span class="comment">//</span>
01318 
01319     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a7">RtlpCreateStack</a>( Process,
01320                               MaximumStackSize,
01321                               CommittedStackSize,
01322                               ZeroBits,
01323                               &amp;InitialTeb
01324                             );
01325     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
01326         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01327         }
01328 
01329     <span class="comment">//</span>
01330     <span class="comment">// Create an initial context for the new thread.</span>
01331     <span class="comment">//</span>
01332 
01333 
01334     <a class="code" href="../../d6/d6/rtl_2ppc_2context_8c.html#a1">RtlInitializeContext</a>( Process,
01335                           &amp;ThreadContext,
01336                           Parameter,
01337                           (PVOID)StartAddress,
01338                           <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>.StackBase
01339                         );
01340 
01341     <span class="comment">//</span>
01342     <span class="comment">// Now create a thread in the target process.  The new thread will</span>
01343     <span class="comment">// not have a name and its handle will not be inherited by other</span>
01344     <span class="comment">// processes.</span>
01345     <span class="comment">//</span>
01346 
01347     InitializeObjectAttributes( &amp;ObjectAttributes, NULL, 0, NULL,
01348                                 ThreadSecurityDescriptor );
01349     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateThread( &amp;ThreadHandle,
01350                              THREAD_ALL_ACCESS,
01351                              &amp;ObjectAttributes,
01352                              Process,
01353                              &amp;ThreadClientId,
01354                              &amp;ThreadContext,
01355                              &amp;InitialTeb,
01356                              CreateSuspended
01357                            );
01358     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01359 <span class="preprocessor">#if DBG</span>
01360 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTRTL: RtlCreateUserThread Failed. NtCreateThread Status == %X\n"</span>,
01361                   Status );
01362 <span class="preprocessor">#endif // DBG</span>
01363 <span class="preprocessor"></span>        <a class="code" href="../../d0/d2/rtlexec_8c.html#a6">RtlpFreeStack</a>( Process, &amp;InitialTeb );
01364         }
01365     <span class="keywordflow">else</span> {
01366         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Thread )) {
01367             *Thread = <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
01368             }
01369 
01370         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientId )) {
01371             *ClientId = <a class="code" href="../../d2/d1/cttoken_8c.html#a61">ThreadClientId</a>;
01372             }
01373 
01374         }
01375 
01376     <span class="comment">//</span>
01377     <span class="comment">// Return status</span>
01378     <span class="comment">//</span>
01379 
01380     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01381 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="rtlexec.c::RtlDeNormalizeProcessParams" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PRTL_USER_PROCESS_PARAMETERS RtlDeNormalizeProcessParams           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PRTL_USER_PROCESS_PARAMETERS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ProcessParameters</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00444">444</a> of file <a class="el" href="../../d1/d1/rtlexec_8c-source.html">rtlexec.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00388">RtlpDeNormalizeProcessParam</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00110">RtlCreateProcessParameters()</a>.
<p>
<pre class="fragment"><div>00447 {
00448     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( ProcessParameters )) {
00449         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00450         }
00451 
00452     <span class="keywordflow">if</span> (!(ProcessParameters-&gt;Flags &amp; RTL_USER_PROC_PARAMS_NORMALIZED)) {
00453         <span class="keywordflow">return</span>( ProcessParameters );
00454         }
00455 
00456     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00457                                  ProcessParameters-&gt;CurrentDirectory.DosPath.Buffer
00458                                );
00459 
00460     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00461                                  ProcessParameters-&gt;DllPath.Buffer
00462                                );
00463 
00464     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00465                                  ProcessParameters-&gt;ImagePathName.Buffer
00466                                );
00467 
00468     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00469                                  ProcessParameters-&gt;CommandLine.Buffer
00470                                );
00471 
00472     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00473                                  ProcessParameters-&gt;WindowTitle.Buffer
00474                                );
00475 
00476     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00477                                  ProcessParameters-&gt;DesktopInfo.Buffer
00478                                );
00479 
00480     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00481                                  ProcessParameters-&gt;ShellInfo.Buffer
00482                                );
00483 
00484     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00485                                  ProcessParameters-&gt;RuntimeData.Buffer
00486                                );
00487 
00488     ProcessParameters-&gt;Flags &amp;= ~RTL_USER_PROC_PARAMS_NORMALIZED;
00489     <span class="keywordflow">return</span>( ProcessParameters );
00490 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="rtlexec.c::RtlDestroyProcessParameters" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlDestroyProcessParameters           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_USER_PROCESS_PARAMETERS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ProcessParameters</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00365">365</a> of file <a class="el" href="../../d1/d1/rtlexec_8c-source.html">rtlexec.c</a>.
<p>
References <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00110">RtlCreateProcessParameters()</a>, and <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01093">SepServerSpawnClientProcess()</a>.
<p>
<pre class="fragment"><div>00368 {
00369     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00370     SIZE_T RegionSize;
00371 
00372     RegionSize = 0;
00373     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwFreeVirtualMemory( NtCurrentProcess(),
00374                                   (PVOID *)&amp;ProcessParameters,
00375                                   &amp;RegionSize,
00376                                   MEM_RELEASE
00377                                 );
00378 
00379     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00380 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="rtlexec.c::RtlFreeUserThreadStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlFreeUserThreadStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>hProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>hThread</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l01385">1385</a> of file <a class="el" href="../../d1/d1/rtlexec_8c-source.html">rtlexec.c</a>.
<p>
References <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l02706">NtQueryInformationThread()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00102">NtReadVirtualMemory()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>01389 {
01390     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01391     PTEB Teb;
01392     THREAD_BASIC_INFORMATION ThreadInfo;
01393     PVOID StackDeallocationBase;
01394     ULONG Length;
01395     SIZE_T <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01396 
01397     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a20">NtQueryInformationThread</a>( hThread,
01398                                        ThreadBasicInformation,
01399                                        &amp;ThreadInfo,
01400                                        <span class="keyword">sizeof</span>( ThreadInfo ),
01401                                        NULL
01402                                      );
01403     Teb = ThreadInfo.TebBaseAddress;
01404     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) || !Teb) {
01405         <span class="keywordflow">return</span>;
01406         }
01407 
01408     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>( hProcess,
01409                                   &amp;Teb-&gt;DeallocationStack,
01410                                   &amp;StackDeallocationBase,
01411                                   <span class="keyword">sizeof</span>( StackDeallocationBase ),
01412                                   &amp;Length
01413                                 );
01414     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) || !StackDeallocationBase) {
01415         <span class="keywordflow">return</span>;
01416         }
01417 
01418     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
01419     <a class="code" href="../../d3/d7/freevm_8c.html#a6">NtFreeVirtualMemory</a>( hProcess, &amp;StackDeallocationBase, &amp;Size, MEM_RELEASE );
01420     <span class="keywordflow">return</span>;
01421 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="rtlexec.c::RtlNormalizeProcessParams" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PRTL_USER_PROCESS_PARAMETERS RtlNormalizeProcessParams           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PRTL_USER_PROCESS_PARAMETERS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ProcessParameters</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00395">395</a> of file <a class="el" href="../../d1/d1/rtlexec_8c-source.html">rtlexec.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00383">RtlpNormalizeProcessParam</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.
<p>
<pre class="fragment"><div>00398 {
00399     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( ProcessParameters )) {
00400         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00401         }
00402 
00403     <span class="keywordflow">if</span> (ProcessParameters-&gt;Flags &amp; RTL_USER_PROC_PARAMS_NORMALIZED) {
00404         <span class="keywordflow">return</span>( ProcessParameters );
00405         }
00406 
00407     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00408                                ProcessParameters-&gt;CurrentDirectory.DosPath.Buffer
00409                              );
00410 
00411     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00412                                ProcessParameters-&gt;DllPath.Buffer
00413                              );
00414 
00415     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00416                                ProcessParameters-&gt;ImagePathName.Buffer
00417                              );
00418 
00419     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00420                                ProcessParameters-&gt;CommandLine.Buffer
00421                              );
00422 
00423     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00424                                ProcessParameters-&gt;WindowTitle.Buffer
00425                              );
00426 
00427     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00428                                ProcessParameters-&gt;DesktopInfo.Buffer
00429                              );
00430 
00431     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00432                                ProcessParameters-&gt;ShellInfo.Buffer
00433                              );
00434 
00435     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00436                                ProcessParameters-&gt;RuntimeData.Buffer
00437                              );
00438     ProcessParameters-&gt;Flags |= RTL_USER_PROC_PARAMS_NORMALIZED;
00439 
00440     <span class="keywordflow">return</span>( ProcessParameters );
00441 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="rtlexec.c::RtlpCopyProcString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpCopyProcString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PWSTR *&nbsp;</td>
          <td class="mdname" nowrap> <em>pDst</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DestString</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceString</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG DstAlloc&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00083">83</a> of file <a class="el" href="../../d1/d1/rtlexec_8c-source.html">rtlexec.c</a>.
<p>
References <a class="el" href="../../d1/d1/usrbench_8h-source.html#l00232">DestString</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d1/d1/usrbench_8h-source.html#l00230">SourceString</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00110">RtlCreateProcessParameters()</a>.
<p>
<pre class="fragment"><div>00089 {
00090     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( (ULONG_PTR)DstAlloc )) {
00091         DstAlloc = <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;MaximumLength;
00092         }
00093 
00094     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Length != 0) {
00095         RtlMoveMemory( *pDst,
00096                        <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Buffer,
00097                        <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Length
00098                      );
00099         }
00100 
00101     <a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a>-&gt;Buffer = *pDst;
00102     <a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a>-&gt;Length = <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Length;
00103     <a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a>-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)DstAlloc;
00104 
00105     *pDst = (PWSTR)((PCHAR)(*pDst) + <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( DstAlloc, <span class="keyword">sizeof</span>( ULONG ) ) );
00106     <span class="keywordflow">return</span>;
00107 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="rtlexec.c::RtlpCreateStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpCreateStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T MaximumStackSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T CommittedStackSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG ZeroBits&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PINITIAL_TEB&nbsp;</td>
          <td class="mdname" nowrap> <em>InitialTeb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00539">539</a> of file <a class="el" href="../../d1/d1/rtlexec_8c-source.html">rtlexec.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00134">InitialTeb</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l01241">RtlCreateUserThread()</a>.
<p>
<pre class="fragment"><div>00546 {
00547     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00548     PCH Stack;
00549     SYSTEM_BASIC_INFORMATION SysInfo;
00550     BOOLEAN GuardPage;
00551     SIZE_T RegionSize;
00552     ULONG OldProtect;
00553 <span class="preprocessor">#if defined(_IA64_)</span>
00554 <span class="preprocessor"></span>    PCH Bstore;
00555     SIZE_T CommittedBstoreSize;
00556     SIZE_T MaximumBstoreSize;
00557     SIZE_T MstackPlusBstoreSize;
00558 <span class="preprocessor">#endif</span>
00559 <span class="preprocessor"></span>
00560     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQuerySystemInformation( SystemBasicInformation,
00561                                        (PVOID)&amp;SysInfo,
00562                                        <span class="keyword">sizeof</span>( SysInfo ),
00563                                        NULL
00564                                      );
00565     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
00566         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00567         }
00568 
00569     <span class="comment">//</span>
00570     <span class="comment">// if stack is in the current process, then default to</span>
00571     <span class="comment">// the parameters from the image</span>
00572     <span class="comment">//</span>
00573 
00574     <span class="keywordflow">if</span> ( Process == NtCurrentProcess() ) {
00575         PPEB Peb;
00576         PIMAGE_NT_HEADERS NtHeaders;
00577 
00578 
00579         Peb = NtCurrentPeb();
00580         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Peb-&gt;ImageBaseAddress);
00581 
00582 
00583         <span class="keywordflow">if</span> (!MaximumStackSize) {
00584             MaximumStackSize = NtHeaders-&gt;OptionalHeader.SizeOfStackReserve;
00585             }
00586 
00587         <span class="keywordflow">if</span> (!CommittedStackSize) {
00588             CommittedStackSize = NtHeaders-&gt;OptionalHeader.SizeOfStackCommit;
00589             }
00590 
00591         }
00592     <span class="keywordflow">else</span> {
00593 
00594         <span class="keywordflow">if</span> (!CommittedStackSize) {
00595             CommittedStackSize = SysInfo.PageSize;
00596             }
00597 
00598         <span class="keywordflow">if</span> (!MaximumStackSize) {
00599             MaximumStackSize = SysInfo.AllocationGranularity;
00600             }
00601 
00602         }
00603 
00604 
00605     <span class="keywordflow">if</span> ( CommittedStackSize &gt;= MaximumStackSize ) {
00606         MaximumStackSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(CommittedStackSize, (1024*1024));
00607         }
00608 
00609 
00610     CommittedStackSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( CommittedStackSize, SysInfo.PageSize );
00611     MaximumStackSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( MaximumStackSize,
00612                                  SysInfo.AllocationGranularity
00613                                );
00614 
00615     Stack = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00616 
00617 <span class="preprocessor">#if defined(_IA64_)</span>
00618 <span class="preprocessor"></span>
00619     <span class="comment">//</span>
00620     <span class="comment">// Piggyback the backing store with the memory stack</span>
00621     <span class="comment">//</span>
00622 
00623     CommittedBstoreSize = CommittedStackSize;
00624     MaximumBstoreSize = MaximumStackSize;
00625     MstackPlusBstoreSize = MaximumBstoreSize + MaximumStackSize;
00626 
00627     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( Process,
00628                                       (PVOID *)&amp;Stack,
00629                                       ZeroBits,
00630                                       &amp;MstackPlusBstoreSize,
00631                                       MEM_RESERVE,
00632                                       PAGE_READWRITE
00633                                     );
00634 <span class="preprocessor">#else</span>
00635 <span class="preprocessor"></span>
00636     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( Process,
00637                                       (PVOID *)&amp;Stack,
00638                                       ZeroBits,
00639                                       &amp;MaximumStackSize,
00640                                       MEM_RESERVE,
00641                                       PAGE_READWRITE
00642                                     );
00643 <span class="preprocessor">#endif // defined(_IA64_)</span>
00644 <span class="preprocessor"></span>
00645     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
00646 <span class="preprocessor">#if DBG</span>
00647 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTRTL: RtlpCreateStack( %lx ) failed.  Stack Reservation Status == %X\n"</span>,
00648                   Process,
00649                   Status
00650                 );
00651 <span class="preprocessor">#endif // DBG</span>
00652 <span class="preprocessor"></span>        <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00653         }
00654 
00655 <span class="preprocessor">#if defined(_IA64_)</span>
00656 <span class="preprocessor"></span>    <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldBStoreLimit = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00657 <span class="preprocessor">#endif // defined(_IA64_)</span>
00658 <span class="preprocessor"></span>
00659     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldStackBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00660     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldStackLimit = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00661     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackAllocationBase = Stack;
00662     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackBase = Stack + MaximumStackSize;
00663 
00664     Stack += MaximumStackSize - CommittedStackSize;
00665     <span class="keywordflow">if</span> (MaximumStackSize &gt; CommittedStackSize) {
00666         Stack -= SysInfo.PageSize;
00667         CommittedStackSize += SysInfo.PageSize;
00668         GuardPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00669         }
00670     <span class="keywordflow">else</span> {
00671         GuardPage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00672         }
00673     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( Process,
00674                                       (PVOID *)&amp;Stack,
00675                                       0,
00676                                       &amp;CommittedStackSize,
00677                                       MEM_COMMIT,
00678                                       PAGE_READWRITE
00679                                     );
00680     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackLimit = Stack;
00681 
00682     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
00683 <span class="preprocessor">#if DBG</span>
00684 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTRTL: RtlpCreateStack( %lx ) failed.  Stack Commit Status == %X\n"</span>,
00685                   Process,
00686                   Status
00687                 );
00688 <span class="preprocessor">#endif // DBG</span>
00689 <span class="preprocessor"></span>        <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00690         }
00691 
00692     <span class="comment">//</span>
00693     <span class="comment">// if we have space, create a guard page.</span>
00694     <span class="comment">//</span>
00695 
00696     <span class="keywordflow">if</span> (GuardPage) {
00697         RegionSize =  SysInfo.PageSize;
00698         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwProtectVirtualMemory( Process,
00699                                          (PVOID *)&amp;Stack,
00700                                          &amp;RegionSize,
00701                                          PAGE_GUARD | PAGE_READWRITE,
00702                                          &amp;OldProtect);
00703 
00704 
00705         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
00706 <span class="preprocessor">#if DBG</span>
00707 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTRTL: RtlpCreateStack( %lx ) failed.  Guard Page Creation Status == %X\n"</span>,
00708                       Process,
00709                       Status
00710                     );
00711 <span class="preprocessor">#endif // DBG</span>
00712 <span class="preprocessor"></span>            <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00713             }
00714 <span class="preprocessor">#if defined(_IA64_)</span>
00715 <span class="preprocessor"></span>        <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackLimit = (PVOID)((PUCHAR)<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackLimit + RegionSize);
00716 <span class="preprocessor">#else</span>
00717 <span class="preprocessor"></span>        <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackLimit = (PVOID)((PUCHAR)<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackLimit - RegionSize);
00718 <span class="preprocessor">#endif // defined(_IA64_)</span>
00719 <span class="preprocessor"></span>        }
00720 
00721 <span class="preprocessor">#if defined(_IA64_)</span>
00722 <span class="preprocessor"></span>
00723     <span class="comment">//</span>
00724     <span class="comment">// Commit backing store pages and create guard pages if there is space</span>
00725     <span class="comment">//</span>
00726 
00727     Bstore = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackBase;
00728     <span class="keywordflow">if</span> (MaximumBstoreSize &gt; CommittedBstoreSize) {
00729         CommittedBstoreSize += SysInfo.PageSize;
00730         GuardPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00731     } <span class="keywordflow">else</span> {
00732         GuardPage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00733     }
00734 
00735     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( Process,
00736                                       (PVOID *)&amp;Bstore,
00737                                       0,
00738                                       &amp;CommittedBstoreSize,
00739                                       MEM_COMMIT,
00740                                       PAGE_READWRITE
00741                                     );
00742 
00743     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;BStoreLimit = Bstore + CommittedBstoreSize;
00744 
00745     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00746 <span class="preprocessor">#if DBG</span>
00747 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NTRTL: RtlpCreateStack( %lx ) failed. Backing Store Commit Status == %X\n"</span>,
00748                  Process,
00749                  Status
00750                 );
00751 <span class="preprocessor">#endif // DBG</span>
00752 <span class="preprocessor"></span>        <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00753     }
00754 
00755     <span class="keywordflow">if</span> (GuardPage) {
00756         Bstore = (PCH)<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;BStoreLimit - SysInfo.PageSize;
00757         RegionSize = SysInfo.PageSize;
00758         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwProtectVirtualMemory(Process,
00759                                         (PVOID *)&amp;Bstore,
00760                                         &amp;RegionSize,
00761                                         PAGE_GUARD | PAGE_READWRITE,
00762                                         &amp;OldProtect
00763                                        );
00764         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00765 <span class="preprocessor">#if DBG</span>
00766 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NTRTL: RtlpCreateStack( %lx ) failed.  Backing Store Guard Page Creation Status == %X\n"</span>,
00767                      Process,
00768                      Status
00769                     );
00770 <span class="preprocessor">#endif // DBG</span>
00771 <span class="preprocessor"></span>            <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00772         }
00773         <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;BStoreLimit = (PVOID)((PUCHAR)<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;BStoreLimit - RegionSize);
00774     }
00775 
00776 <span class="preprocessor">#endif // defined(_IA64_)</span>
00777 <span class="preprocessor"></span>
00778     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00779 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="rtlexec.c::RtlpFreeStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpFreeStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PINITIAL_TEB&nbsp;</td>
          <td class="mdname" nowrap> <em>InitialTeb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00783">783</a> of file <a class="el" href="../../d1/d1/rtlexec_8c-source.html">rtlexec.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00134">InitialTeb</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d5/ttime_8c-source.html#l00031">Zero</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l01241">RtlCreateUserThread()</a>.
<p>
<pre class="fragment"><div>00787 {
00788     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00789     SIZE_T <a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a>;
00790 
00791     <a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a> = 0;
00792     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwFreeVirtualMemory( Process,
00793                                   &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackAllocationBase,
00794                                   &amp;Zero,
00795                                   MEM_RELEASE
00796                                 );
00797     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
00798 <span class="preprocessor">#if DBG</span>
00799 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTRTL: RtlpFreeStack( %lx ) failed.  Stack DeCommit Status == %X\n"</span>,
00800                   Process,
00801                   Status
00802                 );
00803 <span class="preprocessor">#endif // DBG</span>
00804 <span class="preprocessor"></span>        <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00805         }
00806 
00807     RtlZeroMemory( InitialTeb, <span class="keyword">sizeof</span>( *InitialTeb ) );
00808     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00809 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="rtlexec.c::RtlpOpenImageFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpOpenImageFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ImagePathName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReportErrors</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00493">493</a> of file <a class="el" href="../../d1/d1/rtlexec_8c-source.html">rtlexec.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d2/d8/icmui_8def-source.html#l00004">File</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00582">ZwOpenFile()</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00813">RtlCreateUserProcess()</a>.
<p>
<pre class="fragment"><div>00499 {
00500     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00501     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00502     HANDLE <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
00503     IO_STATUS_BLOCK IoStatus;
00504 
00505     *FileHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00506 
00507     InitializeObjectAttributes( &amp;ObjectAttributes,
00508                                 ImagePathName,
00509                                 Attributes,
00510                                 NULL,
00511                                 NULL
00512                               );
00513     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>( &amp;File,
00514                          SYNCHRONIZE | FILE_EXECUTE,
00515                          &amp;ObjectAttributes,
00516                          &amp;IoStatus,
00517                          FILE_SHARE_READ | FILE_SHARE_DELETE,
00518                          FILE_NON_DIRECTORY_FILE
00519                          );
00520 
00521     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00522 <span class="preprocessor">#if DBG</span>
00523 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ReportErrors) {
00524             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTRTL: RtlpOpenImageFile - NtCreateFile( %wZ ) failed.  Status == %X\n"</span>,
00525                       ImagePathName,
00526                       Status
00527                     );
00528             }
00529 <span class="preprocessor">#endif // DBG</span>
00530 <span class="preprocessor"></span>        <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00531         }
00532 
00533     *FileHandle = <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
00534     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00535 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:30 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
