<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mmsup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mmsup.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d1/d1/mmsup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a3">MiIsPteDecommittedPage</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a4">MiIsProtectionCompatible</a> (IN ULONG OldProtect, IN ULONG NewProtect)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (IN ULONG Protect)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess, IN ULONG PfnMutexHeld, OUT PULONG Waited)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess, IN ULONG PfnMutexHeld)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a8">MiMakeSystemAddressValid</a> (IN PVOID VirtualAddress, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (IN PVOID VirtualAddress, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a10">MiMakeSystemAddressValidPfnSystemWs</a> (IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a12">MiLockPagedAddress</a> (IN PVOID VirtualAddress, IN ULONG PfnLockHeld)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a13">MiUnlockPagedAddress</a> (IN PVOID VirtualAddress, IN ULONG PfnLockHeld)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (IN PFN_NUMBER PageFrameIndex, IN ULONG PageColor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a15">MiRestoreTransitionPte</a> (IN PFN_NUMBER PageFrameIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a16">MiGetSubsectionAndProtoFromPte</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, OUT <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> *ProtoPte, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a17">MmIsNonPagedSystemAddressValid</a> (IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a18">MmHibernateInformation</a> (IN PVOID MemoryMap, OUT PULONG_PTR HiberVa, OUT PPHYSICAL_ADDRESS HiberPte)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a0">MmCompatibleProtectionMask</a> [8]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a1">MmUserProtectionToMask1</a> [16]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/mmsup_8c.html#a2">MmUserProtectionToMask2</a> [16]</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a6" doxytag="mmsup.c::MiDoesPdeExistAndMakeValid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiDoesPdeExistAndMakeValid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPde</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PfnMutexHeld</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Waited</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00437">437</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00764">MiMakeSystemAddressValid()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00519">MiCalculatePageCommitment()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00026">MiDeleteVirtualAddresses()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02281">MiFlushDirtyBitsToPfn()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00937">MiIsEntireRangeCommitted()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00673">MiQueryAddressState()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l01953">MiResetVirtualMemory()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l04177">MmSecureVirtualMemory()</a>, and <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00033">NtLockVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00446                    :
00447 
00448     This routine examines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified Page <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> Entry to determine
00449     <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page table page mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDE exists.
00450 
00451     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page table page exists and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not currently in memory, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00452     working set mutex and, <span class="keywordflow">if</span> held, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN mutex are released and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00453     page table page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> faulted into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set.  The mutexes are
00454     reacquired.
00455 
00456     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDE exists, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function returns <span class="keyword">true</span>.
00457 
00458 Arguments:
00459 
00460     PointerPde - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDE to examine and potentially
00461                  bring into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set.
00462 
00463     TargetProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
00464 
00465     PfnMutexHeld - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00466                    otherwise.
00467 
00468     Waited - Supplies a pointer to a ULONG to increment <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> released
00469              and reacquired.  Note <span class="keyword">this</span> value may be incremented more than once.
00470 
00471 Return Value:
00472 
00473     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDE exists, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero.
00474 
00475 Environment:
00476 
00477     Kernel mode, APCs disabled, WorkingSetLock held.
00478 
00479 --*/
00480 
00481 {
00482     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00483     KIRQL OldIrql;
00484 
00485     OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00486 
00487     <span class="keywordflow">if</span> (PointerPde-&gt;u.Long == 0) {
00488 
00489         <span class="comment">//</span>
00490         <span class="comment">// This page directory entry doesn't exist, return FALSE.</span>
00491         <span class="comment">//</span>
00492 
00493         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00494     }
00495 
00496     <span class="keywordflow">if</span> (PointerPde-&gt;u.Hard.Valid == 1) {
00497 
00498         <span class="comment">//</span>
00499         <span class="comment">// Already valid.</span>
00500         <span class="comment">//</span>
00501 
00502         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00503     }
00504 
00505     <span class="comment">//</span>
00506     <span class="comment">// Page directory entry exists, it is either valid, in transition</span>
00507     <span class="comment">// or in the paging file.  Fault it in.</span>
00508     <span class="comment">//</span>
00509 
00510     <span class="keywordflow">if</span> (PfnMutexHeld) {
00511         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00512         *Waited += 1;
00513     }
00514 
00515     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00516 
00517     *Waited += <a class="code" href="../../d0/d2/mmsup_8c.html#a8">MiMakeSystemAddressValid</a> (PointerPte, TargetProcess);
00518 
00519     <span class="keywordflow">if</span> (PfnMutexHeld) {
00520         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00521     }
00522     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00523 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="mmsup.c::MiGetSubsectionAndProtoFromPte" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> MiGetSubsectionAndProtoFromPte           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ProtoPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01385">1385</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01559">MiGetSubsectionAddress</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00837">MiMakeSystemAddressValidPfnWs()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01466">MiPteToProto</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02402">MiGetSystemCacheSubsection()</a>.
<p>
<pre class="fragment"><div>01393                    :
01394 
01395     This routine examines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied PTE (which must
01396     map a page within a section) and determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01397     subsection in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> contained.
01398 
01399 Arguments:
01400 
01401     PointerPte - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE.
01402 
01403     ProtoPte - Supplies a pointer to a <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> which receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01404                address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prototype PTE which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied
01405                PointerPte.
01406 
01407     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
01408 
01409 Return Value:
01410 
01411     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subsection <span class="keywordflow">for</span> <span class="keyword">this</span> PTE.
01412 
01413 Environment:
01414 
01415     Kernel mode - Must be holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database lock and
01416                   working set mutex (acquired safely) with APCs disabled.
01417 
01418 --*/
01419 
01420 {
01421     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProto;
01422     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01423 
01424     <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 1) {
01425         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;u.Hard.PageFrameNumber);
01426         *ProtoPte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
01427         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01428     }
01429 
01430     PointerProto = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (PointerPte);
01431     *ProtoPte = PointerProto;
01432 
01433     <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (PointerProto, Process);
01434 
01435     <span class="keywordflow">if</span> (PointerProto-&gt;u.Hard.Valid == 1) {
01436         <span class="comment">//</span>
01437         <span class="comment">// Prototype Pte is valid.</span>
01438         <span class="comment">//</span>
01439 
01440         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerProto-&gt;u.Hard.PageFrameNumber);
01441         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01442     }
01443 
01444     <span class="keywordflow">if</span> ((PointerProto-&gt;u.Soft.Transition == 1) &amp;&amp;
01445          (PointerProto-&gt;u.Soft.Prototype == 0)) {
01446 
01447         <span class="comment">//</span>
01448         <span class="comment">// Prototype Pte is in transition.</span>
01449         <span class="comment">//</span>
01450 
01451         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerProto-&gt;u.Trans.PageFrameNumber);
01452         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01453     }
01454 
01455     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerProto-&gt;u.Soft.Prototype == 1);
01456     <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (PointerProto);
01457 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="mmsup.c::MiIsProtectionCompatible" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG FASTCALL MiIsProtectionCompatible           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OldProtect</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProtect</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00139">139</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00243">MiMakeProtectionMask()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00120">MmCompatibleProtectionMask</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>.
<p>
<pre class="fragment"><div>00146                    :
00147 
00148     This function takes two user supplied page protections and checks
00149     to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> protection <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> compatible with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old protection.
00150 
00151    protection        compatible protections
00152     NoAccess          NoAccess
00153     ReadOnly          NoAccess, ReadOnly, ReadWriteCopy
00154     ReadWriteCopy     NoAccess, ReadOnly, ReadWriteCopy
00155     ReadWrite         NoAccess, ReadOnly, ReadWriteCopy, ReadWrite
00156     Execute           NoAccess, Execute
00157     ExecuteRead       NoAccess, ReadOnly, ReadWriteCopy, Execute, ExecuteRead,
00158                         ExecuteWriteCopy
00159     ExecuteWrite      NoAccess, ReadOnly, ReadWriteCopy, Execute, ExecuteRead,
00160                         ExecuteWriteCopy, ReadWrite, ExecuteWrite
00161     ExecuteWriteCopy  NoAccess, ReadOnly, ReadWriteCopy, Execute, ExecuteRead,
00162                         ExecuteWriteCopy
00163 
00164 Arguments:
00165 
00166     OldProtect - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection to be compatible with.
00167 
00168     NewProtect - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection to check <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.
00169 
00170 
00171 Return Value:
00172 
00173     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> compatible, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
00174 
00175 Environment:
00176 
00177     Kernel Mode.
00178 
00179 --*/
00180 
00181 {
00182     ULONG Mask;
00183     ULONG ProtectMask;
00184 
00185     <span class="keywordflow">try</span> {
00186         Mask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (OldProtect) &amp; 0x7;
00187     } except (EXCEPTION_EXECUTE_HANDLER) {
00188         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00189     }
00190 
00191     ProtectMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a0">MmCompatibleProtectionMask</a>[Mask] | PAGE_GUARD | PAGE_NOCACHE;
00192 
00193     <span class="keywordflow">if</span> ((ProtectMask | NewProtect) != ProtectMask) {
00194         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00195     }
00196     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00197 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="mmsup.c::MiIsPteDecommittedPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG FASTCALL MiIsPteDecommittedPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PointerPte</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00042">42</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02336">MI_PTE_LOOKUP_NEEDED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00144">MM_DECOMMIT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00519">MiCalculatePageCommitment()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00937">MiIsEntireRangeCommitted()</a>, and <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00673">MiQueryAddressState()</a>.
<p>
<pre class="fragment"><div>00048                    :
00049 
00050     This function checks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of a PTE to determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00051     PTE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> explicitly decommitted.
00052 
00053     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a prototype PTE and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00054     prototype PTE, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00055 
00056 Arguments:
00057 
00058     PointerPte - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE to examine.
00059 
00060 Return Value:
00061 
00062     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">explicit</span> decommitted state.
00063     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">explicit</span> decommitted state.
00064 
00065 Environment:
00066 
00067     Kernel mode, APCs disabled, WorkingSetLock held.
00068 
00069 --*/
00070 
00071 {
00072     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00073 
00074     PteContents = *PointerPte;
00075 
00076     <span class="comment">//</span>
00077     <span class="comment">// If the protection in the PTE is not decommitted, return false.</span>
00078     <span class="comment">//</span>
00079 
00080     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection != <a class="code" href="../../d4/d8/mi_8h.html#a45">MM_DECOMMIT</a>) {
00081         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00082     }
00083 
00084     <span class="comment">//</span>
00085     <span class="comment">// Check to make sure the protection field is really being interpreted</span>
00086     <span class="comment">// correctly.</span>
00087     <span class="comment">//</span>
00088 
00089     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00090 
00091         <span class="comment">//</span>
00092         <span class="comment">// The PTE is valid and therefore cannot be decommitted.</span>
00093         <span class="comment">//</span>
00094 
00095         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00096     }
00097 
00098     <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) &amp;&amp;
00099          (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>)) {
00100 
00101         <span class="comment">//</span>
00102         <span class="comment">// The PTE's protection is not known as it is in</span>
00103         <span class="comment">// prototype PTE format.  Return FALSE.</span>
00104         <span class="comment">//</span>
00105 
00106         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00107     }
00108 
00109     <span class="comment">//</span>
00110     <span class="comment">// It is a decommitted PTE.</span>
00111     <span class="comment">//</span>
00112 
00113     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00114 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="mmsup.c::MiLockPagedAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG FASTCALL MiLockPagedAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PfnLockHeld</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01058">1058</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01417">MI_ADD_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00996">MiMakeSystemAddressValidPfn()</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>.
<p>
<pre class="fragment"><div>01065                    :
01066 
01067     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid, and <span class="keywordflow">if</span>
01068     not makes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> valid.
01069 
01070 Arguments:
01071 
01072     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to make valid.
01073 
01074     CurrentProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
01075 
01076 Return Value:
01077 
01078     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> lock released and wait performed, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01079 
01080 Environment:
01081 
01082     Kernel mode.
01083 
01084 --*/
01085 
01086 {
01087 
01088     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01089     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01090     KIRQL OldIrql;
01091     ULONG Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01092 
01093     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(VirtualAddress);
01094 
01095     <span class="comment">//</span>
01096     <span class="comment">// The address must be within paged pool.</span>
01097     <span class="comment">//</span>
01098 
01099     <span class="keywordflow">if</span> (PfnLockHeld == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01100         <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
01101     }
01102 
01103     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01104 
01105         Waited = <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (
01106                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte));
01107 
01108     }
01109 
01110     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01111     <a class="code" href="../../d4/d8/mi_8h.html#a186">MI_ADD_LOCKED_PAGE_CHARGE</a>(Pfn1, 6);
01112     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
01113 
01114     <span class="keywordflow">if</span> (PfnLockHeld == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01115         <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
01116     }
01117     <span class="keywordflow">return</span> Waited;
01118 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="mmsup.c::MiMakePdeExistAndMakeValid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiMakePdeExistAndMakeValid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPde</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PfnMutexHeld</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00624">624</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00764">MiMakeSystemAddressValid()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/allocvm_8c-source.html#l02188">MiCreatePageTablesForPhysicalRange()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l01161">MiDecommitPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02785">MiMapLockedPagesInUserSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l01028">MiMapViewOfPhysicalSection()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>, and <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00632                    :
00633 
00634     This routine examines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified Page <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> Parent Entry to
00635     determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page directory page mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PPE exists.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does,
00636     then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> examines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified Page <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> Entry to determine <span class="keywordflow">if</span>
00637     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page table page mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDE exists.
00638 
00639     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page table page exists and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not currently in memory, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00640     working set mutex and, <span class="keywordflow">if</span> held, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN mutex are released and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00641     page table page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> faulted into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set.  The mutexes are
00642     reacquired.
00643 
00644     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDE exists, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function returns <span class="keyword">true</span>.
00645 
00646     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDE does not exist, a zero filled PTE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00647     too <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> brought into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set.  In <span class="keyword">this</span> <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span>
00648     value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00649 
00650 Arguments:
00651 
00652     PointerPde - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDE to examine and bring
00653                  into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set.
00654 
00655     TargetProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
00656 
00657     PfnMutexHeld - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00658                    otherwise.
00659 
00660 Return Value:
00661 
00662     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDE exists, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDE was created.
00663 
00664 Environment:
00665 
00666     Kernel mode, APCs disabled, WorkingSetLock held.
00667 
00668 --*/
00669 
00670 {
00671     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00672     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00673     KIRQL OldIrql;
00674     ULONG ReturnValue;
00675 
00676     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00677 
00678     <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1 &amp;&amp; PointerPde-&gt;u.Hard.Valid == 1) {
00679 
00680         <span class="comment">//</span>
00681         <span class="comment">// Already valid.</span>
00682         <span class="comment">//</span>
00683 
00684         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00685     }
00686 
00687     <span class="comment">//</span>
00688     <span class="comment">// Deal with the page directory page first.</span>
00689     <span class="comment">//</span>
00690 
00691     <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00692         ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00693     } <span class="keywordflow">else</span> {
00694         ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00695     }
00696 
00697     <span class="comment">//</span>
00698     <span class="comment">// Page directory parent entry not valid, make it valid.</span>
00699     <span class="comment">//</span>
00700 
00701     OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00702 
00703     <span class="keywordflow">do</span> {
00704 
00705         <span class="keywordflow">if</span> (PfnMutexHeld) {
00706             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00707         }
00708     
00709         <span class="comment">//</span>
00710         <span class="comment">// Fault it in.</span>
00711         <span class="comment">//</span>
00712     
00713         <a class="code" href="../../d0/d2/mmsup_8c.html#a8">MiMakeSystemAddressValid</a> (PointerPde, TargetProcess);
00714     
00715         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
00716     
00717         <span class="keywordflow">if</span> (PfnMutexHeld) {
00718             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00719         }
00720     
00721         <span class="comment">//</span>
00722         <span class="comment">// Now deal with the page table page.</span>
00723         <span class="comment">//</span>
00724     
00725         <span class="keywordflow">if</span> (ReturnValue == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00726             <span class="keywordflow">if</span> (PointerPde-&gt;u.Long == 0) {
00727                 ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00728             } <span class="keywordflow">else</span> {
00729                 ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00730             }
00731         }
00732         
00733         <span class="comment">//</span>
00734         <span class="comment">// Page directory entry not valid, make it valid.</span>
00735         <span class="comment">//</span>
00736     
00737         OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00738     
00739         <span class="keywordflow">if</span> (PfnMutexHeld) {
00740             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00741         }
00742     
00743         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00744     
00745         <span class="comment">//</span>
00746         <span class="comment">// Fault it in.</span>
00747         <span class="comment">//</span>
00748     
00749         <a class="code" href="../../d0/d2/mmsup_8c.html#a8">MiMakeSystemAddressValid</a> (PointerPte, TargetProcess);
00750     
00751         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;u.Hard.Valid == 1);
00752     
00753         <span class="keywordflow">if</span> (PfnMutexHeld) {
00754             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00755         }
00756 
00757     } <span class="keywordflow">while</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0 || PointerPde-&gt;u.Hard.Valid == 0);
00758 
00759     <span class="keywordflow">return</span> ReturnValue;
00760 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="mmsup.c::MiMakeProtectionMask" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG FASTCALL MiMakeProtectionMask           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Protect</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00243">243</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00143">MM_GUARD_PAGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00145">MM_NOACCESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00142">MM_NOCACHE</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00204">MmUserProtectionToMask1</a>, and <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00222">MmUserProtectionToMask2</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00139">MiIsProtectionCompatible()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l05278">MiProtectSpecialPool()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00390">MmCreateSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04027">MmSetPageProtection()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>, and <a class="el" href="../../d1/d8/protect_8c-source.html#l00069">NtProtectVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00249                    :
00250 
00251     This function takes a user supplied protection and converts <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00252     into a 5-bit protection code <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE.
00253 
00254 Arguments:
00255 
00256     Protect - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection.
00257 
00258 
00259 Return Value:
00260 
00261     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection code <span class="keywordflow">for</span> use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE.
00262     An exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user supplied protection <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invalid.
00263 
00264 Environment:
00265 
00266     Kernel Mode.
00267 
00268 --*/
00269 
00270 {
00271     ULONG Field1;
00272     ULONG Field2;
00273     ULONG ProtectCode;
00274 
00275     <span class="keywordflow">if</span> (Protect &gt;= (PAGE_NOCACHE * 2)) {
00276         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_PAGE_PROTECTION);
00277     }
00278 
00279     Field1 = Protect &amp; 0xF;
00280     Field2 = (Protect &gt;&gt; 4) &amp; 0xF;
00281 
00282     <span class="comment">//</span>
00283     <span class="comment">// Make sure at least one field is set.</span>
00284     <span class="comment">//</span>
00285 
00286     <span class="keywordflow">if</span> (Field1 == 0) {
00287         <span class="keywordflow">if</span> (Field2 == 0) {
00288 
00289             <span class="comment">//</span>
00290             <span class="comment">// Both fields are zero, raise exception.</span>
00291             <span class="comment">//</span>
00292 
00293             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_PAGE_PROTECTION);
00294             <span class="keywordflow">return</span> 0;
00295         }
00296         ProtectCode = <a class="code" href="../../d0/d2/mmsup_8c.html#a2">MmUserProtectionToMask2</a>[Field2];
00297     } <span class="keywordflow">else</span> {
00298         <span class="keywordflow">if</span> (Field2 != 0) {
00299             <span class="comment">//</span>
00300             <span class="comment">//  Both fields are non-zero, raise exception.</span>
00301             <span class="comment">//</span>
00302 
00303             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_PAGE_PROTECTION);
00304             <span class="keywordflow">return</span> 0;
00305         }
00306         ProtectCode = <a class="code" href="../../d0/d2/mmsup_8c.html#a1">MmUserProtectionToMask1</a>[Field1];
00307     }
00308 
00309     <span class="keywordflow">if</span> (ProtectCode == -1) {
00310         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_PAGE_PROTECTION);
00311     }
00312 
00313     <span class="keywordflow">if</span> (Protect &amp; PAGE_GUARD) {
00314         <span class="keywordflow">if</span> (ProtectCode == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
00315 
00316             <span class="comment">//</span>
00317             <span class="comment">// Invalid protection, no access and no_cache.</span>
00318             <span class="comment">//</span>
00319 
00320             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_PAGE_PROTECTION);
00321         }
00322 
00323         ProtectCode |= <a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>;
00324     }
00325 
00326     <span class="keywordflow">if</span> (Protect &amp; PAGE_NOCACHE) {
00327 
00328         <span class="keywordflow">if</span> (ProtectCode == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
00329 
00330             <span class="comment">//</span>
00331             <span class="comment">// Invalid protection, no access and no cache.</span>
00332             <span class="comment">//</span>
00333 
00334             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_PAGE_PROTECTION);
00335         }
00336 
00337         ProtectCode |= <a class="code" href="../../d4/d8/mi_8h.html#a43">MM_NOCACHE</a>;
00338     }
00339 
00340     <span class="keywordflow">return</span> ProtectCode;
00341 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="mmsup.c::MiMakeSystemAddressValid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG FASTCALL MiMakeSystemAddressValid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentProcess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00764">764</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01120">LOCK_WS_REGARDLESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00160">MM_PAGED_POOL_START</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00068">MmPagedPoolEnd</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01109">UNLOCK_WS_REGARDLESS</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00437">MiDoesPdeExistAndMakeValid()</a>, and <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00624">MiMakePdeExistAndMakeValid()</a>.
<p>
<pre class="fragment"><div>00771                    :
00772 
00773     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid, and <span class="keywordflow">if</span>
00774     not makes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> valid.
00775 
00776 Arguments:
00777 
00778     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to make valid.
00779 
00780     CurrentProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
00781 
00782 Return Value:
00783 
00784     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> lock released and wait performed, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00785 
00786 Environment:
00787 
00788     Kernel mode, APCs disabled, WorkingSetLock held.
00789 
00790 --*/
00791 
00792 {
00793     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00794     LOGICAL WsHeldSafe;
00795     ULONG Waited;
00796 
00797     Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00798 
00799     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VirtualAddress &gt; MM_HIGHEST_USER_ADDRESS);
00800 
00801     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((VirtualAddress &lt; MM_PAGED_POOL_START) ||
00802         (VirtualAddress &gt; MmPagedPoolEnd));
00803 
00804     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(VirtualAddress)) {
00805 
00806         <span class="comment">//</span>
00807         <span class="comment">// The virtual address is not present.  Release</span>
00808         <span class="comment">// the working set mutex and fault it in.</span>
00809         <span class="comment">//</span>
00810         <span class="comment">// The working set lock may have been acquired safely or unsafely</span>
00811         <span class="comment">// by our caller.  Handle both cases here and below.</span>
00812         <span class="comment">//</span>
00813 
00814         <a class="code" href="../../d4/d8/mi_8h.html#a164">UNLOCK_WS_REGARDLESS</a>(CurrentProcess, WsHeldSafe);
00815 
00816         status = <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a> (FALSE, VirtualAddress, KernelMode, (PVOID)0);
00817         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00818             KdPrint ((<span class="stringliteral">"MM:page fault status %lx\n"</span>,status));
00819             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (KERNEL_DATA_INPAGE_ERROR,
00820                           1,
00821                           (ULONG)status,
00822                           (ULONG_PTR)CurrentProcess,
00823                           (ULONG_PTR)VirtualAddress);
00824         }
00825 
00826         <a class="code" href="../../d4/d8/mi_8h.html#a165">LOCK_WS_REGARDLESS</a>(CurrentProcess, WsHeldSafe);
00827 
00828         Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00829     }
00830 
00831     <span class="keywordflow">return</span> Waited;
00832 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="mmsup.c::MiMakeSystemAddressValidPfn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG FASTCALL MiMakeSystemAddressValidPfn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00996">996</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02427">MiCheckProtoPtePageState()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">MiFlushSectionInternal()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01058">MiLockPagedAddress()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00191">MiSegmentDelete()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l05448">MiSetSystemCodeProtection()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04450">MiUpdateImageHeaderPage()</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01016">MmCheckCachedPageState()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01274">MmCopyToCachedPage()</a>, and <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01548">MmPurgeSection()</a>.
<p>
<pre class="fragment"><div>01002                    :
01003 
01004     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid, and <span class="keywordflow">if</span>
01005     not makes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> valid.
01006 
01007 Arguments:
01008 
01009     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to make valid.
01010 
01011 Return Value:
01012 
01013     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> lock released and wait performed, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01014 
01015 Environment:
01016 
01017     Kernel mode, APCs disabled, <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> held.
01018 
01019 --*/
01020 
01021 {
01022     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01023     KIRQL OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
01024 
01025     ULONG Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01026 
01027     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VirtualAddress &gt; MM_HIGHEST_USER_ADDRESS);
01028 
01029     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(VirtualAddress)) {
01030 
01031         <span class="comment">//</span>
01032         <span class="comment">// The virtual address is not present.  Release</span>
01033         <span class="comment">// the working set mutex and fault it in.</span>
01034         <span class="comment">//</span>
01035 
01036         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01037 
01038         status = <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a> (FALSE, VirtualAddress, KernelMode, (PVOID)0);
01039         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01040             KdPrint ((<span class="stringliteral">"MM:page fault status %lx\n"</span>,status));
01041             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (KERNEL_DATA_INPAGE_ERROR,
01042                           3,
01043                           (ULONG)status,
01044                           (ULONG_PTR)VirtualAddress,
01045                           0);
01046         }
01047 
01048         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01049 
01050         Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01051     }
01052 
01053     <span class="keywordflow">return</span> Waited;
01054 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="mmsup.c::MiMakeSystemAddressValidPfnSystemWs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG FASTCALL MiMakeSystemAddressValidPfnSystemWs           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00916">916</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05287">MI_IS_SESSION_IMAGE_ADDRESS</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>.
<p>
<pre class="fragment"><div>00922                    :
00923 
00924     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid, and <span class="keywordflow">if</span>
00925     not makes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> valid.
00926 
00927 Arguments:
00928 
00929     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to make valid.
00930 
00931 Return Value:
00932 
00933     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> lock released and wait performed, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00934 
00935 Environment:
00936 
00937     Kernel mode, APCs disabled, PFN lock held, system working set lock held.
00938 
00939 --*/
00940 
00941 {
00942     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00943     ULONG Waited;
00944     KIRQL OldIrql;
00945     KIRQL OldIrqlWs;
00946     LOGICAL SessionSpace;
00947 
00948     Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00949     OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00950     OldIrqlWs = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00951 
00952     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VirtualAddress &gt; MM_HIGHEST_USER_ADDRESS);
00953 
00954     SessionSpace = <a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (VirtualAddress);
00955 
00956     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(VirtualAddress)) {
00957 
00958         <span class="comment">//</span>
00959         <span class="comment">// The virtual address is not present.  Release</span>
00960         <span class="comment">// the working set mutex and fault it in.</span>
00961         <span class="comment">//</span>
00962 
00963         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00964 
00965         <span class="keywordflow">if</span> (SessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00966             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrqlWs);
00967         }
00968         <span class="keywordflow">else</span> {
00969             <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrqlWs);
00970         }
00971 
00972         status = <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a> (FALSE, VirtualAddress, KernelMode, (PVOID)0);
00973         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00974             KdPrint ((<span class="stringliteral">"MM:page fault status %lx\n"</span>,status));
00975             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (KERNEL_DATA_INPAGE_ERROR,
00976                           2,
00977                           (ULONG)status,
00978                           (ULONG_PTR)0,
00979                           (ULONG_PTR)VirtualAddress);
00980         }
00981         <span class="keywordflow">if</span> (SessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00982             <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrqlWs);
00983         }
00984         <span class="keywordflow">else</span> {
00985             <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrqlWs);
00986         }
00987         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00988 
00989         Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00990     }
00991     <span class="keywordflow">return</span> Waited;
00992 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="mmsup.c::MiMakeSystemAddressValidPfnWs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG FASTCALL MiMakeSystemAddressValidPfnWs           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00837">837</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01120">LOCK_WS_REGARDLESS</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01109">UNLOCK_WS_REGARDLESS</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/protect_8c-source.html#l02204">MiCaptureSystemPte()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l01745">MiDecrementCloneBlockReference()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01385">MiGetSubsectionAndProtoFromPte()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00541">MiPurgeImageSection()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l01953">MiResetVirtualMemory()</a>, and <a class="el" href="../../d9/d5/forksup_8c-source.html#l02184">MiUpCloneProtoRefCount()</a>.
<p>
<pre class="fragment"><div>00844                    :
00845 
00846     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid, and <span class="keywordflow">if</span>
00847     not makes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> valid.
00848 
00849 Arguments:
00850 
00851     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to make valid.
00852 
00853     CurrentProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00854                      working set lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not held, <span class="keyword">this</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
00855 
00856 Return Value:
00857 
00858     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> lock released and wait performed, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00859 
00860 Environment:
00861 
00862     Kernel mode, APCs disabled, PFN lock held, working set lock held
00863        <span class="keywordflow">if</span> CurrentProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
00864 
00865 --*/
00866 
00867 {
00868     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00869     ULONG Waited;
00870     KIRQL OldIrql;
00871     LOGICAL WsHeldSafe;
00872 
00873     Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00874     OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00875 
00876     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VirtualAddress &gt; MM_HIGHEST_USER_ADDRESS);
00877 
00878     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(VirtualAddress)) {
00879 
00880         <span class="comment">//</span>
00881         <span class="comment">// The virtual address is not present.  Release</span>
00882         <span class="comment">// the working set mutex and fault it in.</span>
00883         <span class="comment">//</span>
00884 
00885         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00886         <span class="keywordflow">if</span> (CurrentProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00887 
00888             <span class="comment">//</span>
00889             <span class="comment">// The working set lock may have been acquired safely or unsafely</span>
00890             <span class="comment">// by our caller.  Handle both cases here and below.</span>
00891             <span class="comment">//</span>
00892 
00893             <a class="code" href="../../d4/d8/mi_8h.html#a164">UNLOCK_WS_REGARDLESS</a>(CurrentProcess, WsHeldSafe);
00894         }
00895         status = <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a> (FALSE, VirtualAddress, KernelMode, (PVOID)0);
00896         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00897             KdPrint ((<span class="stringliteral">"MM:page fault status %lx\n"</span>,status));
00898             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (KERNEL_DATA_INPAGE_ERROR,
00899                           2,
00900                           (ULONG)status,
00901                           (ULONG_PTR)CurrentProcess,
00902                           (ULONG_PTR)VirtualAddress);
00903         }
00904         <span class="keywordflow">if</span> (CurrentProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00905             <a class="code" href="../../d4/d8/mi_8h.html#a165">LOCK_WS_REGARDLESS</a>(CurrentProcess, WsHeldSafe);
00906         }
00907         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00908 
00909         Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00910     }
00911     <span class="keywordflow">return</span> Waited;
00912 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="mmsup.c::MiRestoreTransitionPte" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL MiRestoreTransitionPte           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFN_NUMBER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PageFrameIndex</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01245">1245</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02114">_SUBSECTION::ControlArea</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01348">MI_CAPTURE_USED_PAGETABLE_ENTRIES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05296">MI_IS_SESSION_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02059">MiCheckForControlAreaDeletion()</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00767">MiGetByteOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01559">MiGetSubsectionAddress</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00135">MM_SYSTEM_SPACE_START</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02061">_CONTROL_AREA::NumberOfPfnReferences</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00068">MiDispatchFault()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00521">MiRemovePageFromList()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l01109">MiRemovePhysicalPages()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00868">MiResolveTransitionFault()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>.
<p>
<pre class="fragment"><div>01251                    :
01252 
01253     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> restores <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original contents into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE (which could
01254     be a prototype PTE) referred to by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
01255     physical page.  It also updates all necessary data structures to
01256     reflect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fact that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> referenced PTE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no longer in transition.
01257 
01258     The physical address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> referenced PTE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mapped into hyper space
01259     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> then updated.
01260 
01261 Arguments:
01262 
01263     PageFrameIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical page number which refers to a
01264                     transition PTE.
01265 
01266 Return Value:
01267 
01268     none.
01269 
01270 Environment:
01271 
01272     Must be holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database mutex with APCs disabled.
01273 
01274 --*/
01275 
01276 {
01277     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01278     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01279     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
01280     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
01281     KIRQL OldIrql = 99;
01282 
01283     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01284 
01285     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == StandbyPageList);
01286 
01287     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte) {
01288 
01289         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>)) {
01290             PointerPte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
01291         } <span class="keywordflow">else</span> {
01292 
01293             <span class="comment">//</span>
01294             <span class="comment">// The page containing the prototype PTE is not valid,</span>
01295             <span class="comment">// map the page into hyperspace and reference it that way.</span>
01296             <span class="comment">//</span>
01297 
01298             PointerPte = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>, &amp;OldIrql);
01299             PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)PointerPte +
01300                                     <a class="code" href="../../d4/d8/mi_8h.html#a110">MiGetByteOffset</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>));
01301         }
01302 
01303         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE (PointerPte) == PageFrameIndex) &amp;&amp;
01304                  (PointerPte-&gt;u.Hard.Valid == 0));
01305 
01306         <span class="comment">//</span>
01307         <span class="comment">// This page is referenced by a prototype PTE.  The</span>
01308         <span class="comment">// segment structures need to be updated when the page</span>
01309         <span class="comment">// is removed from the transition state.</span>
01310         <span class="comment">//</span>
01311 
01312         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype) {
01313 
01314             <span class="comment">//</span>
01315             <span class="comment">// The prototype PTE is in subsection format, calculate the</span>
01316             <span class="comment">// address of the control area for the subsection and decrement</span>
01317             <span class="comment">// the number of PFN references to the control area.</span>
01318             <span class="comment">//</span>
01319             <span class="comment">// Calculate address of subsection for this prototype PTE.</span>
01320             <span class="comment">//</span>
01321 
01322             Subsection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01323             ControlArea = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>;
01324             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> -= 1;
01325             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> &gt;= 0);
01326 
01327             <a class="code" href="../../d5/d5/sectsup_8c.html#a25">MiCheckForControlAreaDeletion</a> (ControlArea);
01328         }
01329 
01330     } <span class="keywordflow">else</span> {
01331 
01332         <span class="comment">//</span>
01333         <span class="comment">// The page points to a page or page table page which may not be</span>
01334         <span class="comment">// for the current process.  Map the page into hyperspace and</span>
01335         <span class="comment">// reference it through hyperspace.  If the page resides in</span>
01336         <span class="comment">// system space (but not session space), it does not need to be</span>
01337         <span class="comment">// mapped as all PTEs for system space must be resident.  Session</span>
01338         <span class="comment">// space PTEs are only mapped per session so access to them must</span>
01339         <span class="comment">// also go through hyperspace.</span>
01340         <span class="comment">//</span>
01341 
01342         PointerPte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
01343 
01344         <span class="keywordflow">if</span> (PointerPte &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MM_SYSTEM_SPACE_START) ||
01345                <a class="code" href="../../d4/d8/mi_8h.html#a355">MI_IS_SESSION_PTE</a> (PointerPte)) {
01346 
01347             PointerPte = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>, &amp;OldIrql);
01348             PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)PointerPte +
01349                                        <a class="code" href="../../d4/d8/mi_8h.html#a110">MiGetByteOffset</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>));
01350         }
01351         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE (PointerPte) == PageFrameIndex) &amp;&amp;
01352                  (PointerPte-&gt;u.Hard.Valid == 0));
01353 
01354         <a class="code" href="../../d4/d8/mi_8h.html#a175">MI_CAPTURE_USED_PAGETABLE_ENTRIES</a> (Pfn1);
01355 
01356 <span class="preprocessor">#if _WIN64</span>
01357 <span class="preprocessor"></span><span class="preprocessor">#if DBGXX</span>
01358 <span class="preprocessor"></span>        MiCheckPageTableTrim(PointerPte);
01359 <span class="preprocessor">#endif</span>
01360 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01361 <span class="preprocessor"></span>    }
01362 
01363     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
01364     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
01365              (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)));
01366 
01367     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01368 
01369     <span class="keywordflow">if</span> (OldIrql != 99) {
01370         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
01371     }
01372 
01373     <span class="comment">//</span>
01374     <span class="comment">// The PTE has been restored to its original contents and is</span>
01375     <span class="comment">// no longer in transition.  Decrement the share count on</span>
01376     <span class="comment">// the page table page which contains the PTE.</span>
01377     <span class="comment">//</span>
01378 
01379     <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01380 
01381     <span class="keywordflow">return</span>;
01382 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="mmsup.c::MiUnlockPagedAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL MiUnlockPagedAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PfnLockHeld</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01123">1123</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01470">MI_REMOVE_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>.
<p>
<pre class="fragment"><div>01130                    :
01131 
01132     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid, and <span class="keywordflow">if</span>
01133     not makes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> valid.
01134 
01135 Arguments:
01136 
01137     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to make valid.
01138 
01139 
01140 Return Value:
01141 
01142     None.
01143 
01144 Environment:
01145 
01146     Kernel mode.  PFN <a class="code" href="../../d4/d2/struct__LOCK.html">LOCK</a> MUST NOT BE HELD.
01147 
01148 --*/
01149 
01150 {
01151     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01152     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01153     KIRQL OldIrql;
01154     PFN_NUMBER PageFrameIndex;
01155 
01156     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(VirtualAddress);
01157 
01158     <span class="comment">//</span>
01159     <span class="comment">// Address must be within paged pool.</span>
01160     <span class="comment">//</span>
01161 
01162     <span class="keywordflow">if</span> (PfnLockHeld == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01163         <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
01164     }
01165 
01166     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
01167     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01168     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01169 
01170     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
01171 
01172     <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a>(Pfn1, 7);
01173 
01174     <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
01175 
01176     <span class="keywordflow">if</span> (PfnLockHeld == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01177         <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
01178     }
01179     <span class="keywordflow">return</span>;
01180 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="mmsup.c::MiZeroPhysicalPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL MiZeroPhysicalPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>PageFrameIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PageColor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01184">1184</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00228">KeZeroPage</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00315">MM_COLOR_MASK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/iniaxp64_8c-source.html#l00111">MiInitMachineDependent()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01177">MiRemoveZeroPage()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00674">MiResolveDemandZeroFault()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02144">MiSessionCommitImagePages()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02318">MiSessionCommitPageTables()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01881">MiSessionInitializeWorkingSetList()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l02335">MiWaitForInPageComplete()</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l00190">MmCreateProcessAddressSpace()</a>.
<p>
<pre class="fragment"><div>01191                    :
01192 
01193     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical page into hyper space
01194     and fills <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page with zeros.
01195 
01196 Arguments:
01197 
01198     PageFrameIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical page number to fill with
01199                     zeroes.
01200 
01201 Return Value:
01202 
01203     none.
01204 
01205 Environment:
01206 
01207     Kernel mode.
01208 
01209 --*/
01210 
01211 {
01212     PULONG va;
01213     KIRQL OldIrql;
01214 
01215 <span class="preprocessor">#if defined(_ALPHA_)</span>
01216 <span class="preprocessor"></span>
01217     HalZeroPage((PVOID)ULongToPtr((PageColor &amp; MM_COLOR_MASK) &lt;&lt; PAGE_SHIFT),
01218                 (PVOID)ULongToPtr((PageColor &amp; MM_COLOR_MASK) &lt;&lt; PAGE_SHIFT),
01219                 PageFrameIndex);
01220 <span class="preprocessor">#else</span>
01221 <span class="preprocessor"></span>
01222     UNREFERENCED_PARAMETER (PageColor);
01223 
01224     va = (PULONG)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageFrameIndex, &amp;OldIrql);
01225 
01226 <span class="preprocessor">#if defined(_X86_)</span>
01227 <span class="preprocessor"></span>
01228     <a class="code" href="../../d6/d9/kernlini_8c.html#a24">KeZeroPage</a>(va);
01229 
01230 <span class="preprocessor">#else</span>
01231 <span class="preprocessor"></span>
01232     RtlZeroMemory (va, PAGE_SIZE);
01233 
01234 <span class="preprocessor">#endif // X86</span>
01235 <span class="preprocessor"></span>
01236     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
01237 
01238 <span class="preprocessor">#endif // ALPHA</span>
01239 <span class="preprocessor"></span>
01240     <span class="keywordflow">return</span>;
01241 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="mmsup.c::MmHibernateInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmHibernateInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryMap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>HiberVa</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>HiberPte</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01503">1503</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00105">MmCrashDumpPte</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05490">MmGetPhysicalAddress()</a>, <a class="el" href="../../d2/d1/po_8h-source.html#l00141">PO_MEM_CLONE</a>, and <a class="el" href="../../d1/d2/po_8h.html#a67">PoSetHiberRange()</a>.
<p>
<pre class="fragment"><div>01508 {
01509     <span class="comment">//</span>
01510     <span class="comment">// Mark PTE page where the 16 dump PTEs reside as needing cloned</span>
01511     <span class="comment">//</span>
01512 
01513     <a class="code" href="../../d1/d2/po_8h.html#a67">PoSetHiberRange</a> (
01514         MemoryMap,
01515         PO_MEM_CLONE,
01516         MmCrashDumpPte,
01517         1,
01518         ' etP'
01519         );
01520 
01521     <span class="comment">//</span>
01522     <span class="comment">// Return the dump PTEs to the loader (as it needs to use them</span>
01523     <span class="comment">// to map it's relocation code into the kernel space on the</span>
01524     <span class="comment">// final bit of restoring memory)</span>
01525     <span class="comment">//</span>
01526 
01527     *HiberVa = (ULONG_PTR) <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(MmCrashDumpPte);
01528     *HiberPte = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a>(MmCrashDumpPte);
01529 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="mmsup.c::MmIsNonPagedSystemAddressValid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmIsNonPagedSystemAddressValid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01460">1460</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00068">MmPagedPoolEnd</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00067">MmPagedPoolStart</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l01500">MmBuildMdlForNonPagedPool()</a>.
<p>
<pre class="fragment"><div>01466                    :
01467 
01468     For a given <span class="keyword">virtual</span> address <span class="keyword">this</span> function returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address
01469     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> nonpagable portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system's address space,
01470     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01471 
01472 Arguments:
01473 
01474     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to check.
01475 
01476 Return Value:
01477 
01478     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> nonpagable portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system
01479     address space, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01480 
01481 Environment:
01482 
01483     Kernel mode.
01484 
01485 --*/
01486 
01487 {
01488     <span class="comment">//</span>
01489     <span class="comment">// Return TRUE if address is within the nonpagable portion</span>
01490     <span class="comment">// of the system.  Check limits for paged pool and if not within</span>
01491     <span class="comment">// those limits, return TRUE.</span>
01492     <span class="comment">//</span>
01493 
01494     <span class="keywordflow">if</span> ((VirtualAddress &gt;= <a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>) &amp;&amp;
01495         (VirtualAddress &lt;= <a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a>)) {
01496         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01497     }
01498 
01499     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01500 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="mmsup.c::MmCompatibleProtectionMask" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d2/mmsup_8c.html#a0">MmCompatibleProtectionMask</a>[8]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
            PAGE_NOACCESS,
            PAGE_NOACCESS | PAGE_READONLY | PAGE_WRITECOPY,
            PAGE_NOACCESS | PAGE_EXECUTE,
            PAGE_NOACCESS | PAGE_READONLY | PAGE_WRITECOPY | PAGE_EXECUTE |
                PAGE_EXECUTE_READ,
            PAGE_NOACCESS | PAGE_READONLY | PAGE_WRITECOPY | PAGE_READWRITE,
            PAGE_NOACCESS | PAGE_READONLY | PAGE_WRITECOPY,
            PAGE_NOACCESS | PAGE_READONLY | PAGE_WRITECOPY | PAGE_READWRITE |
                PAGE_EXECUTE | PAGE_EXECUTE_READ | PAGE_EXECUTE_READWRITE |
                PAGE_EXECUTE_WRITECOPY,
            PAGE_NOACCESS | PAGE_READONLY | PAGE_WRITECOPY | PAGE_EXECUTE |
                PAGE_EXECUTE_READ | PAGE_EXECUTE_WRITECOPY
            }
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00120">120</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00139">MiIsProtectionCompatible()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="mmsup.c::MmUserProtectionToMask1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CCHAR <a class="el" href="../../d0/d2/mmsup_8c.html#a1">MmUserProtectionToMask1</a>[16]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
                                 0,
                                 <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>,
                                 <a class="code" href="../../d4/d8/mi_8h.html#a36">MM_READONLY</a>,
                                 -1,
                                 <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>,
                                 -1,
                                 -1,
                                 -1,
                                 <a class="code" href="../../d4/d8/mi_8h.html#a40">MM_WRITECOPY</a>,
                                 -1,
                                 -1,
                                 -1,
                                 -1,
                                 -1,
                                 -1,
                                 -1 }
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00204">204</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00243">MiMakeProtectionMask()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="mmsup.c::MmUserProtectionToMask2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CCHAR <a class="el" href="../../d0/d2/mmsup_8c.html#a2">MmUserProtectionToMask2</a>[16]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
                                 0,
                                 <a class="code" href="../../d4/d8/mi_8h.html#a37">MM_EXECUTE</a>,
                                 <a class="code" href="../../d4/d8/mi_8h.html#a38">MM_EXECUTE_READ</a>,
                                 -1,
                                 <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>,
                                 -1,
                                 -1,
                                 -1,
                                 <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>,
                                 -1,
                                 -1,
                                 -1,
                                 -1,
                                 -1,
                                 -1,
                                 -1 }
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00222">222</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00243">MiMakeProtectionMask()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:47 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
