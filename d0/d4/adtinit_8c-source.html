<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: adtinit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>adtinit.c</h1><a href="../../d9/d4/adtinit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    adtinit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Auditing - Initialization Routines</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Scott Birrell       (ScottBi)       November 12, 1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel Mode only</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 
00026 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00027 <span class="preprocessor">#include "<a class="code" href="../../d6/d6/sep_8h.html">sep.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="../../d7/d4/adt_8h.html">adt.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="../../d1/d5/adtp_8h.html">adtp.h</a>"</span>
00030 
00031 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAdtInitializePhase1)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAdtInitializeBounds)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAdtValidateAuditBounds)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00036 <span class="preprocessor"></span>
00037 
00038 BOOLEAN
<a name="l00039"></a><a class="code" href="../../d6/d6/sep_8h.html#a70">00039</a> <a class="code" href="../../d6/d6/sep_8h.html#a70">SepAdtValidateAuditBounds</a>(
00040     ULONG Upper,
00041     ULONG Lower
00042     )
00043 
00044 <span class="comment">/*++</span>
00045 <span class="comment"></span>
00046 <span class="comment">Routine Description:</span>
00047 <span class="comment"></span>
00048 <span class="comment">    Examines the audit queue high and low water mark values and performs</span>
00049 <span class="comment">    a general sanity check on them.</span>
00050 <span class="comment"></span>
00051 <span class="comment">Arguments:</span>
00052 <span class="comment"></span>
00053 <span class="comment">    Upper - High water mark.</span>
00054 <span class="comment"></span>
00055 <span class="comment">    Lower - Low water mark.</span>
00056 <span class="comment"></span>
00057 <span class="comment">Return Value:</span>
00058 <span class="comment"></span>
00059 <span class="comment">    TRUE - values are acceptable.</span>
00060 <span class="comment"></span>
00061 <span class="comment">    FALSE - values are unacceptable.</span>
00062 <span class="comment"></span>
00063 <span class="comment"></span>
00064 <span class="comment">--*/</span>
00065 
00066 {
00067     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00068 
00069     <span class="keywordflow">if</span> ( Lower &gt;= Upper ) {
00070         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00071     }
00072 
00073     <span class="keywordflow">if</span> ( Lower &lt; 16 ) {
00074         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00075     }
00076 
00077     <span class="keywordflow">if</span> ( (Upper - Lower) &lt; 16 ) {
00078         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00079     }
00080 
00081     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00082 }
00083 
00084 BOOLEAN
<a name="l00085"></a><a class="code" href="../../d9/d4/adtinit_8c.html#a1">00085</a> <a class="code" href="../../d7/d4/adt_8h.html#a7">SepAdtInitializePhase1</a>()
00086 
00087 <span class="comment">/*++</span>
00088 <span class="comment"></span>
00089 <span class="comment">Routine Description:</span>
00090 <span class="comment"></span>
00091 <span class="comment">    This function performs Phase 1 Initialization for the Auditing subcomponent</span>
00092 <span class="comment">    of Security.  Global variables are initialized within the Nt Executive</span>
00093 <span class="comment">    and Auditing is turned off.</span>
00094 <span class="comment"></span>
00095 <span class="comment">Arguments:</span>
00096 <span class="comment"></span>
00097 <span class="comment">    None</span>
00098 <span class="comment"></span>
00099 <span class="comment">Return Value:</span>
00100 <span class="comment"></span>
00101 <span class="comment">    BOOLEAN - TRUE if Auditing has been initialized correctly, else FALSE.</span>
00102 <span class="comment"></span>
00103 <span class="comment">--*/</span>
00104 
00105 {
00106     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00107 
00108     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Security"</span> );
00109 
00110     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00111 }
00112 
00113 
00114 
00115 
00116 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00117"></a><a class="code" href="../../d1/d5/adtp_8h.html#a30">00117</a> <a class="code" href="../../d1/d5/adtp_8h.html#a30">SepAdtInitializeBounds</a>(
00118     VOID
00119     )
00120 
00121 <span class="comment">/*++</span>
00122 <span class="comment"></span>
00123 <span class="comment">Routine Description:</span>
00124 <span class="comment"></span>
00125 <span class="comment">    Queries the registry for the high and low water mark values for the</span>
00126 <span class="comment">    audit log.  If they are not found or are unacceptable, returns without</span>
00127 <span class="comment">    modifying the current values, which are statically initialized.</span>
00128 <span class="comment"></span>
00129 <span class="comment">Arguments:</span>
00130 <span class="comment"></span>
00131 <span class="comment">    None.</span>
00132 <span class="comment"></span>
00133 <span class="comment">Return Value:</span>
00134 <span class="comment"></span>
00135 <span class="comment">    None.</span>
00136 <span class="comment"></span>
00137 <span class="comment">--*/</span>
00138 
00139 {
00140 
00141     HANDLE KeyHandle;
00142     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00143     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00144     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00145     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00146     <a class="code" href="../../d3/d1/struct__SEP__AUDIT__BOUNDS.html">PSEP_AUDIT_BOUNDS</a> AuditBounds;
00147     PKEY_VALUE_PARTIAL_INFORMATION KeyValueInformation;
00148     ULONG Length;
00149 
00150     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00151 
00152     <span class="comment">//</span>
00153     <span class="comment">// Get the high and low water marks out of the registry.</span>
00154     <span class="comment">//</span>
00155 
00156     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Lsa"</span>);
00157 
00158     InitializeObjectAttributes(
00159         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00160         &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00161         OBJ_CASE_INSENSITIVE,
00162         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00163         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00164         );
00165 
00166     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
00167                  &amp;KeyHandle,
00168                  KEY_QUERY_VALUE,
00169                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00170                  );
00171 
00172     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00173 
00174         <span class="comment">//</span>
00175         <span class="comment">// Didn't work, take the defaults</span>
00176         <span class="comment">//</span>
00177 
00178         <span class="keywordflow">return</span>;
00179     }
00180 
00181     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Bounds"</span>);
00182 
00183     Length = <span class="keyword">sizeof</span>( KEY_VALUE_PARTIAL_INFORMATION ) - <span class="keyword">sizeof</span>( UCHAR ) + <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d1/struct__SEP__AUDIT__BOUNDS.html">SEP_AUDIT_BOUNDS</a> );
00184 
00185     KeyValueInformation = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, Length );
00186 
00187     <span class="keywordflow">if</span> ( KeyValueInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00188 
00189         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( KeyHandle );
00190         <span class="keywordflow">return</span>;
00191     }
00192 
00193     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00194                  KeyHandle,
00195                  &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00196                  KeyValuePartialInformation,
00197                  (PVOID)KeyValueInformation,
00198                  Length,
00199                  &amp;Length
00200                  );
00201 
00202     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( KeyHandle );
00203 
00204     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00205 
00206         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( KeyValueInformation );
00207         <span class="keywordflow">return</span>;
00208     }
00209 
00210 
00211     AuditBounds = (<a class="code" href="../../d3/d1/struct__SEP__AUDIT__BOUNDS.html">PSEP_AUDIT_BOUNDS</a>) &amp;KeyValueInformation-&gt;Data;
00212 
00213     <span class="comment">//</span>
00214     <span class="comment">// Sanity check what we got back</span>
00215     <span class="comment">//</span>
00216 
00217     <span class="keywordflow">if</span>(!<a class="code" href="../../d6/d6/sep_8h.html#a70">SepAdtValidateAuditBounds</a>( AuditBounds-&gt;<a class="code" href="../../d3/d1/struct__SEP__AUDIT__BOUNDS.html#o0">UpperBound</a>, AuditBounds-&gt;<a class="code" href="../../d3/d1/struct__SEP__AUDIT__BOUNDS.html#o1">LowerBound</a> )) {
00218 
00219         <span class="comment">//</span>
00220         <span class="comment">// The values we got back are not to our liking.  Use the defaults.</span>
00221         <span class="comment">//</span>
00222 
00223         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( KeyValueInformation );
00224         <span class="keywordflow">return</span>;
00225     }
00226 
00227     <span class="comment">//</span>
00228     <span class="comment">// Take what we got from the registry.</span>
00229     <span class="comment">//</span>
00230 
00231     <a class="code" href="../../d1/d5/adtp_8h.html#a5">SepAdtMaxListLength</a> = AuditBounds-&gt;<a class="code" href="../../d3/d1/struct__SEP__AUDIT__BOUNDS.html#o0">UpperBound</a>;
00232     <a class="code" href="../../d1/d5/adtp_8h.html#a6">SepAdtMinListLength</a> = AuditBounds-&gt;<a class="code" href="../../d3/d1/struct__SEP__AUDIT__BOUNDS.html#o1">LowerBound</a>;
00233 
00234     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( KeyValueInformation );
00235 
00236     <span class="keywordflow">return</span>;
00237 }
00238 
00239 
00240 
00241 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00242"></a><a class="code" href="../../d6/d6/sep_8h.html#a71">00242</a> <a class="code" href="../../d6/d6/sep_8h.html#a71">SepAdtInitializeCrashOnFail</a>(
00243     VOID
00244     )
00245 
00246 <span class="comment">/*++</span>
00247 <span class="comment"></span>
00248 <span class="comment">Routine Description:</span>
00249 <span class="comment"></span>
00250 <span class="comment">    Reads the registry to see if the user has told us to crash if an audit fails.</span>
00251 <span class="comment"></span>
00252 <span class="comment">Arguments:</span>
00253 <span class="comment"></span>
00254 <span class="comment">    None.</span>
00255 <span class="comment"></span>
00256 <span class="comment">Return Value:</span>
00257 <span class="comment"></span>
00258 <span class="comment">    STATUS_SUCCESS</span>
00259 <span class="comment"></span>
00260 <span class="comment">--*/</span>
00261 
00262 {
00263     HANDLE KeyHandle;
00264     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00265     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> TmpStatus;
00266     OBJECT_ATTRIBUTES Obja;
00267     ULONG ResultLength;
00268     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00269     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00270     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> KeyInfo[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <span class="keyword">sizeof</span>(BOOLEAN)];
00271     PKEY_VALUE_PARTIAL_INFORMATION pKeyInfo;
00272 
00273     <a class="code" href="../../d1/d5/adtp_8h.html#a12">SepCrashOnAuditFail</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00274 
00275     <span class="comment">//</span>
00276     <span class="comment">// Check the value of the CrashOnAudit flag in the registry.</span>
00277     <span class="comment">//</span>
00278 
00279     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Lsa"</span>);
00280 
00281     InitializeObjectAttributes( &amp;Obja,
00282                                 &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00283                                 OBJ_CASE_INSENSITIVE,
00284                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00285                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00286                                 );
00287 
00288     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
00289                  &amp;KeyHandle,
00290                  KEY_QUERY_VALUE | KEY_SET_VALUE,
00291                  &amp;Obja
00292                  );
00293 
00294     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_NAME_NOT_FOUND) {
00295         <span class="keywordflow">return</span>( STATUS_SUCCESS );
00296     }
00297 
00298     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, CRASH_ON_AUDIT_FAIL_VALUE );
00299 
00300     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00301                  KeyHandle,
00302                  &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00303                  KeyValuePartialInformation,
00304                  KeyInfo,
00305                  <span class="keyword">sizeof</span>(KeyInfo),
00306                  &amp;ResultLength
00307                  );
00308 
00309     TmpStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(KeyHandle);
00310     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus));
00311 
00312     <span class="comment">//</span>
00313     <span class="comment">// If the key isn't there, don't turn on CrashOnFail.</span>
00314     <span class="comment">//</span>
00315 
00316     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00317 
00318         pKeyInfo = (PKEY_VALUE_PARTIAL_INFORMATION)KeyInfo;
00319         <span class="keywordflow">if</span> ((UCHAR) *(pKeyInfo-&gt;Data) == LSAP_CRASH_ON_AUDIT_FAIL) {
00320             <a class="code" href="../../d1/d5/adtp_8h.html#a12">SepCrashOnAuditFail</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00321         }
00322     }
00323 
00324     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00325 }
00326 
00327 
00328 BOOLEAN
<a name="l00329"></a><a class="code" href="../../d6/d6/sep_8h.html#a72">00329</a> <a class="code" href="../../d6/d6/sep_8h.html#a72">SepAdtInitializePrivilegeAuditing</a>(
00330     VOID
00331     )
00332 
00333 <span class="comment">/*++</span>
00334 <span class="comment"></span>
00335 <span class="comment">Routine Description:</span>
00336 <span class="comment"></span>
00337 <span class="comment">    Checks to see if there is an entry in the registry telling us to do full privilege auditing</span>
00338 <span class="comment">    (which currently means audit everything we normall audit, plus backup and restore privileges).</span>
00339 <span class="comment"></span>
00340 <span class="comment">Arguments:</span>
00341 <span class="comment"></span>
00342 <span class="comment">    None</span>
00343 <span class="comment"></span>
00344 <span class="comment">Return Value:</span>
00345 <span class="comment"></span>
00346 <span class="comment">    BOOLEAN - TRUE if Auditing has been initialized correctly, else FALSE.</span>
00347 <span class="comment"></span>
00348 <span class="comment">--*/</span>
00349 
00350 {
00351     HANDLE KeyHandle;
00352     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00353     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> TmpStatus;
00354     OBJECT_ATTRIBUTES Obja;
00355     ULONG ResultLength;
00356     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00357     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00358     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> KeyInfo[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <span class="keyword">sizeof</span>(BOOLEAN)];
00359     PKEY_VALUE_PARTIAL_INFORMATION pKeyInfo;
00360     BOOLEAN Verbose;
00361 
00362     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00363 
00364     <span class="comment">//</span>
00365     <span class="comment">// Query the registry to set up the privilege auditing filter.</span>
00366     <span class="comment">//</span>
00367 
00368     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Lsa"</span>);
00369 
00370     InitializeObjectAttributes( &amp;Obja,
00371                                 &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00372                                 OBJ_CASE_INSENSITIVE,
00373                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00374                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00375                                 );
00376 
00377     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
00378                  &amp;KeyHandle,
00379                  KEY_QUERY_VALUE | KEY_SET_VALUE,
00380                  &amp;Obja
00381                  );
00382 
00383 
00384     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00385 
00386         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_NAME_NOT_FOUND) {
00387 
00388             <span class="keywordflow">return</span> ( <a class="code" href="../../d3/d5/seaudit_8c.html#a33">SepInitializePrivilegeFilter</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ));
00389 
00390         } <span class="keywordflow">else</span> {
00391 
00392             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00393         }
00394     }
00395 
00396     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, <a class="code" href="../../d1/d5/adtp_8h.html#a0">FULL_PRIVILEGE_AUDITING</a> );
00397 
00398     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00399                  KeyHandle,
00400                  &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00401                  KeyValuePartialInformation,
00402                  KeyInfo,
00403                  <span class="keyword">sizeof</span>(KeyInfo),
00404                  &amp;ResultLength
00405                  );
00406 
00407     TmpStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(KeyHandle);
00408     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus));
00409 
00410     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00411 
00412         Verbose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00413 
00414     } <span class="keywordflow">else</span> {
00415 
00416         pKeyInfo = (PKEY_VALUE_PARTIAL_INFORMATION)KeyInfo;
00417         Verbose = (BOOLEAN) *(pKeyInfo-&gt;Data);
00418     }
00419 
00420     <span class="keywordflow">return</span> ( <a class="code" href="../../d3/d5/seaudit_8c.html#a33">SepInitializePrivilegeFilter</a>( Verbose ));
00421 }
00422 
00423 
00424 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00425"></a><a class="code" href="../../d1/d5/adtp_8h.html#a35">00425</a> <a class="code" href="../../d1/d5/adtp_8h.html#a35">SepAdtInitializeAuditingOptions</a>(
00426     VOID
00427     )
00428 
00429 <span class="comment">/*++</span>
00430 <span class="comment"></span>
00431 <span class="comment">Routine Description:</span>
00432 <span class="comment"></span>
00433 <span class="comment">    Initialize options that control auditing.</span>
00434 <span class="comment">    (please refer to note in adtp.h near the def. of SEP_AUDIT_OPTIONS)</span>
00435 <span class="comment"></span>
00436 <span class="comment">Arguments:</span>
00437 <span class="comment"></span>
00438 <span class="comment">    None</span>
00439 <span class="comment"></span>
00440 <span class="comment">Return Value:</span>
00441 <span class="comment"></span>
00442 <span class="comment">    None</span>
00443 <span class="comment"></span>
00444 <span class="comment">--*/</span>
00445 
00446 {
00447     HANDLE KeyHandle;
00448     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00449     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> TmpStatus;
00450     OBJECT_ATTRIBUTES Obja;
00451     ULONG ResultLength;
00452     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00453     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00454     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> KeyInfo[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <span class="keyword">sizeof</span>(BOOLEAN)];
00455 
00456     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00457 
00458     <span class="comment">//</span>
00459     <span class="comment">// Query the registry </span>
00460     <span class="comment">//</span>
00461     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Lsa\\AuditingOptions"</span>);
00462 
00463     InitializeObjectAttributes( &amp;Obja,
00464                                 &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00465                                 OBJ_CASE_INSENSITIVE,
00466                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00467                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00468                                 );
00469 
00470     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
00471                  &amp;KeyHandle,
00472                  KEY_QUERY_VALUE,
00473                  &amp;Obja
00474                  );
00475 
00476 
00477     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00478 
00479         <span class="keywordflow">goto</span> Cleanup;
00480     }
00481 
00482     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DoNotAuditCloseObjectEvents"</span> );
00483 
00484     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00485                  KeyHandle,
00486                  &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00487                  KeyValuePartialInformation,
00488                  KeyInfo,
00489                  <span class="keyword">sizeof</span>(KeyInfo),
00490                  &amp;ResultLength
00491                  );
00492 
00493     TmpStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(KeyHandle);
00494     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus));
00495 
00496     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00497         <span class="comment">//</span>
00498         <span class="comment">// we check for the presence of this value, its value does not matter</span>
00499         <span class="comment">//</span>
00500         <a class="code" href="../../d1/d5/adtp_8h.html#a14">SepAuditOptions</a>.<a class="code" href="../../d4/d1/struct__SEP__AUDIT__OPTIONS.html#o0">DoNotAuditCloseObjectEvents</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00501     }
00502 
00503 Cleanup:
00504 
00505     <span class="keywordflow">return</span>;
00506 }
00507 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:13 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
