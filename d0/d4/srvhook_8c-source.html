<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: srvhook.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>srvhook.c</h1><a href="../../d9/d4/srvhook_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: srvhook.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Server side of hook calls and callbacks.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* 05-09-91 ScottLu      Created.</span>
00009 <span class="comment">\***************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00012 <span class="preprocessor">#pragma hdrstop</span>
00013 <span class="preprocessor"></span>
00014 LRESULT <a class="code" href="../../d9/d4/srvhook_8c.html#a0">fnHkINLPCBTCREATESTRUCT</a>(UINT msg, WPARAM wParam, LPCBT_CREATEWND pcbt,
00015     PROC xpfnProc, BOOL bAnsi);
00016 
00017 <span class="comment">/***************************************************************************\</span>
00018 <span class="comment">* xxxHkCallHook</span>
00019 <span class="comment">*</span>
00020 <span class="comment">* This is the server-side stub that calls to the client to call the actual</span>
00021 <span class="comment">* hook function.</span>
00022 <span class="comment">*</span>
00023 <span class="comment">* History:</span>
00024 <span class="comment">* 05-09-91 ScottLu      Rewrote to make all hooks work client/server!</span>
00025 <span class="comment">* 01-28-91 DavidPe      Created.</span>
00026 <span class="comment">\***************************************************************************/</span>
00027 
<a name="l00028"></a><a class="code" href="../../d4/d1/userk_8h.html#a1905">00028</a> LRESULT <a class="code" href="../../d4/d1/userk_8h.html#a1905">xxxHkCallHook</a>(
00029     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk,
00030     <span class="keywordtype">int</span> nCode,
00031     WPARAM wParam,
00032     LPARAM lParam)
00033 {
00034     LRESULT nRet;
00035     PROC pfnHk, pfnHookProc;
00036     <a class="code" href="../../d0/d5/struct__PFNCLIENT.html">PPFNCLIENT</a> ppfnClient;
00037     <a class="code" href="../../d0/d0/struct__CWPSTRUCTEX.html">PCWPSTRUCTEX</a> pcwp;
00038     <a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html">PCWPRETSTRUCTEX</a> pcwpret;
00039     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
00040     ULONG_PTR dwHookData;
00041     ULONG_PTR <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00042     <span class="keyword">struct </span><a class="code" href="../../d7/d6/structtagSMS.html">tagSMS</a> *psms;
00043     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlSFWLock;
00044     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fLockForeground;
00045 
00046     <a class="code" href="../../d4/d1/userk_8h.html#a601">DbgValidateHooks</a>(phk, phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>);
00047     <span class="comment">/*</span>
00048 <span class="comment">     * Only low level hooks are allowed in the RIT context.</span>
00049 <span class="comment">     * Also asssert that the hook is not destroyed</span>
00050 <span class="comment">     */</span>
00051 <span class="preprocessor">#ifdef REDIRECTION</span>
00052 <span class="preprocessor"></span>    UserAssert((<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>)
00053                || (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> == WH_MOUSE_LL)
00054                || (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> == WH_KEYBOARD_LL)
00055                || (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> == WH_HITTEST));
00056 <span class="preprocessor">#else</span>
00057 <span class="preprocessor"></span>    UserAssert((<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>)
00058                || (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> == WH_MOUSE_LL)
00059                || (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> == WH_KEYBOARD_LL));
00060 <span class="preprocessor">#endif // REDIRECTION</span>
00061 <span class="preprocessor"></span>
00062     <span class="comment">/*</span>
00063 <span class="comment">     * While we're still inside the critical section make sure the</span>
00064 <span class="comment">     * hook hasn't been 'freed'.  If so just return 0.</span>
00065 <span class="comment">     */</span>
00066     <span class="keywordflow">if</span> (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o3">offPfn</a> != 0) {
00067         pfnHookProc = <a class="code" href="../../d4/d1/userk_8h.html#a423">PFNHOOK</a>(phk);
00068     } <span class="keywordflow">else</span> {
00069         <span class="keywordflow">return</span> 0;
00070     }
00071 
00072 <span class="preprocessor">#ifdef WX86</span>
00073 <span class="preprocessor"></span>
00074 
00075     <span class="comment">/*</span>
00076 <span class="comment">     *  If the HookProc is x86 image, signal the client</span>
00077 <span class="comment">     *  dispatch code to use a risc thunk.</span>
00078 <span class="comment">     */</span>
00079 
00080     <span class="keywordflow">if</span> (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a508">HF_WX86KNOWNDLL</a>) {
00081         (ULONG_PTR)pfnHookProc |= 0x80000000;
00082         }
00083 
00084 
00085 <span class="preprocessor">#endif</span>
00086 <span class="preprocessor"></span>
00087     ppfnClient = (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a503">HF_ANSI</a>) ? &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o8">apfnClientA</a> :
00088             &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>;
00089 
00090     <span class="comment">/*</span>
00091 <span class="comment">     * LATER5.0 GerardoB. This might generate some hate reactions but I'm</span>
00092 <span class="comment">     *  not sure we want people hooking just to steal the foreground.</span>
00093 <span class="comment">     * Prevent hookprocs from other processes from switching the foreground</span>
00094 <span class="comment">     */</span>
00095     fLockForeground = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phk)-&gt;ppi != <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>());
00096     <span class="keywordflow">if</span> (fLockForeground) {
00097         <a class="code" href="../../d4/d1/userk_8h.html#a145">ThreadLockSFWLockCount</a>(&amp;tlSFWLock);
00098     }
00099 
00100 
00101     <span class="keywordflow">switch</span>(phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>) {
00102     <span class="keywordflow">case</span> WH_CALLWNDPROC:
00103     <span class="keywordflow">case</span> WH_CALLWNDPROCRET:
00104        <span class="keywordflow">if</span> (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> == WH_CALLWNDPROC) {
00105           pcwp = (<a class="code" href="../../d0/d0/struct__CWPSTRUCTEX.html">PCWPSTRUCTEX</a>)lParam;
00106           psms = pcwp-&gt;<a class="code" href="../../d0/d0/struct__CWPSTRUCTEX.html#o0">psmsSender</a>;
00107        } <span class="keywordflow">else</span> {
00108           pcwpret = (<a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html">PCWPRETSTRUCTEX</a>)lParam;
00109           psms = pcwpret-&gt;<a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html#o1">psmsSender</a>;
00110        }
00111 
00112         <span class="comment">/*</span>
00113 <span class="comment">         * If the sender has died or timed out, don't call the</span>
00114 <span class="comment">         * hook because any memory the message points to may be invalid.</span>
00115 <span class="comment">         */</span>
00116         <span class="keywordflow">if</span> (psms != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (psms-&gt;flags &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a426">SMF_SENDERDIED</a> | <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>))) {
00117             nRet = 0;
00118             <span class="keywordflow">break</span>;
00119         }
00120 
00121         <span class="comment">/*</span>
00122 <span class="comment">         * This is the hardest of the hooks because we need to thunk through</span>
00123 <span class="comment">         * the message hooks in order to deal with synchronously sent messages</span>
00124 <span class="comment">         * that point to structures - to get the structures passed across</span>
00125 <span class="comment">         * alright, etc.</span>
00126 <span class="comment">         *</span>
00127 <span class="comment">         * This will call a special client-side routine that'll rebundle the</span>
00128 <span class="comment">         * arguments and call the hook in the right format.</span>
00129 <span class="comment">         *</span>
00130 <span class="comment">         * Currently, the message thunk callbacks to the client-side don't take</span>
00131 <span class="comment">         * enough parameters to pass wParam (which == fInterThread send msg).</span>
00132 <span class="comment">         * To do this, call one of two functions.</span>
00133 <span class="comment">         */</span>
00134         pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
00135         <span class="keywordflow">if</span> (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> == WH_CALLWNDPROC) {
00136             pfnHk = ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o14">pfnHkINLPCWPSTRUCT</a>;
00137         } <span class="keywordflow">else</span> {
00138             pfnHk = ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o15">pfnHkINLPCWPRETSTRUCT</a>;
00139             pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o14">dwHookData</a> = pcwpret-&gt;<a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html#o0">lResult</a>;
00140         }
00141 
00142         <span class="comment">/*</span>
00143 <span class="comment">         * Save current hook state.</span>
00144 <span class="comment">         */</span>
00145         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a116">CI_INTERTHREAD_HOOK</a>;
00146         dwHookData = pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o14">dwHookData</a>;
00147 
00148         <span class="keywordflow">if</span> (wParam) {
00149             pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a116">CI_INTERTHREAD_HOOK</a>;
00150         } <span class="keywordflow">else</span> {
00151             pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a116">CI_INTERTHREAD_HOOK</a>;
00152         }
00153 
00154         <span class="keywordflow">if</span> (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> == WH_CALLWNDPROC) {
00155            nRet = <a class="code" href="../../d4/d1/userk_8h.html#a245">ScSendMessageSMS</a>(
00156                <a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(pcwp-&gt;hwnd),
00157                pcwp-&gt;message,
00158                pcwp-&gt;wParam,
00159                pcwp-&gt;lParam,
00160                (ULONG_PTR)pfnHookProc, pfnHk,
00161                (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a503">HF_ANSI</a>) ?
00162                        (<a class="code" href="../../d4/d1/userk_8h.html#a240">SCMS_FLAGS_ANSI</a>|<a class="code" href="../../d4/d1/userk_8h.html#a241">SCMS_FLAGS_INONLY</a>) :
00163                        <a class="code" href="../../d4/d1/userk_8h.html#a241">SCMS_FLAGS_INONLY</a>,
00164                psms);
00165         } <span class="keywordflow">else</span> {
00166             nRet = <a class="code" href="../../d4/d1/userk_8h.html#a245">ScSendMessageSMS</a>(
00167                 <a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(pcwpret-&gt;hwnd),
00168                 pcwpret-&gt;message,
00169                 pcwpret-&gt;wParam,
00170                 pcwpret-&gt;lParam,
00171                 (ULONG_PTR)pfnHookProc, pfnHk,
00172                 (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a503">HF_ANSI</a>) ?
00173                         (<a class="code" href="../../d4/d1/userk_8h.html#a240">SCMS_FLAGS_ANSI</a>|<a class="code" href="../../d4/d1/userk_8h.html#a241">SCMS_FLAGS_INONLY</a>) :
00174                         <a class="code" href="../../d4/d1/userk_8h.html#a241">SCMS_FLAGS_INONLY</a>,
00175                 psms);
00176         }
00177         <span class="comment">/*</span>
00178 <span class="comment">         * Restore previous hook state.</span>
00179 <span class="comment">         */</span>
00180         pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> ^= ((pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> ^ <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>) &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a116">CI_INTERTHREAD_HOOK</a>);
00181         pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o14">dwHookData</a> = dwHookData;
00182         <span class="keywordflow">break</span>;
00183     <span class="keywordflow">case</span> WH_CBT:
00184         <span class="comment">/*</span>
00185 <span class="comment">         * There are many different types of CBT hooks!</span>
00186 <span class="comment">         */</span>
00187         <span class="keywordflow">switch</span>(nCode) {
00188         <span class="keywordflow">case</span> HCBT_CLICKSKIPPED:
00189             <span class="keywordflow">goto</span> MouseHook;
00190             <span class="keywordflow">break</span>;
00191 
00192         <span class="keywordflow">case</span> HCBT_CREATEWND:
00193             <span class="comment">/*</span>
00194 <span class="comment">             * This hook type points to a CREATESTRUCT, so we need to</span>
00195 <span class="comment">             * be fancy with it's thunking, because a CREATESTRUCT contains</span>
00196 <span class="comment">             * a pointer to CREATEPARAMS which can be anything...  so</span>
00197 <span class="comment">             * funnel this through our message thunks.</span>
00198 <span class="comment">             */</span>
00199             nRet = <a class="code" href="../../d9/d4/srvhook_8c.html#a0">fnHkINLPCBTCREATESTRUCT</a>(
00200                     MAKELONG((WORD)nCode, (WORD)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>),
00201                     wParam,
00202                     (LPCBT_CREATEWND)lParam,
00203                     pfnHookProc,
00204                     (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a503">HF_ANSI</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00205             <span class="keywordflow">break</span>;
00206 
00207 <span class="preprocessor">#ifdef REDIRECTION</span>
00208 <span class="preprocessor"></span>        <span class="keywordflow">case</span> HCBT_GETCURSORPOS:
00209             
00210             <span class="comment">/*</span>
00211 <span class="comment">             * This hook type points to a POINT structure, so it's pretty</span>
00212 <span class="comment">             * simple.</span>
00213 <span class="comment">             */</span>
00214             nRet = fnHkINLPPOINT(MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nCode, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>),
00215                     wParam, (LPPOINT)lParam, (ULONG_PTR)pfnHookProc,
00216                     ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>);
00217             <span class="keywordflow">break</span>;
00218 <span class="preprocessor">#endif // REDIRECTION</span>
00219 <span class="preprocessor"></span>
00220         <span class="keywordflow">case</span> HCBT_MOVESIZE:
00221 
00222             <span class="comment">/*</span>
00223 <span class="comment">             * This hook type points to a RECT structure, so it's pretty</span>
00224 <span class="comment">             * simple.</span>
00225 <span class="comment">             */</span>
00226             nRet = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1160">fnHkINLPRECT</a>(MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nCode, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>),
00227                     wParam, (LPRECT)lParam, (ULONG_PTR)pfnHookProc,
00228                     ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>);
00229             <span class="keywordflow">break</span>;
00230 
00231         <span class="keywordflow">case</span> HCBT_ACTIVATE:
00232             <span class="comment">/*</span>
00233 <span class="comment">             * This hook type points to a CBTACTIVATESTRUCT</span>
00234 <span class="comment">             */</span>
00235             nRet = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1168">fnHkINLPCBTACTIVATESTRUCT</a>(MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nCode,
00236                     (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>), wParam, (LPCBTACTIVATESTRUCT)lParam,
00237                     (ULONG_PTR)pfnHookProc, ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>);
00238             <span class="keywordflow">break</span>;
00239 
00240         <span class="keywordflow">default</span>:
00241 
00242             <span class="comment">/*</span>
00243 <span class="comment">             * The rest of the cbt hooks are all dword parameters.</span>
00244 <span class="comment">             */</span>
00245             nRet = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1161">fnHkINDWORD</a>(MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nCode, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>),
00246                     wParam, lParam, (ULONG_PTR)pfnHookProc,
00247                     ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>, &amp;phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a>);
00248             <span class="keywordflow">break</span>;
00249         }
00250         <span class="keywordflow">break</span>;
00251 
00252     <span class="keywordflow">case</span> WH_FOREGROUNDIDLE:
00253         <span class="comment">/*</span>
00254 <span class="comment">         * These are dword parameters and are therefore real easy.</span>
00255 <span class="comment">         *</span>
00256 <span class="comment">         */</span>
00257         nRet = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1161">fnHkINDWORD</a>(MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nCode, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>),
00258                 wParam, lParam, (ULONG_PTR)pfnHookProc,
00259                 ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>, &amp;phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a>);
00260         <span class="keywordflow">break</span>;
00261 
00262     <span class="keywordflow">case</span> WH_SHELL:
00263 
00264         <span class="keywordflow">if</span> (nCode == HSHELL_GETMINRECT) {
00265             <span class="comment">/*</span>
00266 <span class="comment">             * This hook type points to a RECT structure, so it's pretty</span>
00267 <span class="comment">             * simple.</span>
00268 <span class="comment">             */</span>
00269             nRet = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1160">fnHkINLPRECT</a>(MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nCode, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>),
00270                     wParam, (LPRECT)lParam, (ULONG_PTR)pfnHookProc,
00271                     ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>);
00272             <span class="keywordflow">break</span>;
00273         }
00274 
00275         <span class="comment">/*</span>
00276 <span class="comment">         * Otherwise fall through to the simple case of DWORD below</span>
00277 <span class="comment">         */</span>
00278 
00279     <span class="keywordflow">case</span> WH_KEYBOARD:
00280         <span class="comment">/*</span>
00281 <span class="comment">         * These are dword parameters and are therefore real easy.</span>
00282 <span class="comment">         */</span>
00283         nRet = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1161">fnHkINDWORD</a>(MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nCode, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>),
00284                 wParam, lParam, (ULONG_PTR)pfnHookProc,
00285                 ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>, &amp;phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a>);
00286         <span class="keywordflow">break</span>;
00287 
00288     <span class="keywordflow">case</span> WH_MSGFILTER:
00289     <span class="keywordflow">case</span> WH_SYSMSGFILTER:
00290     <span class="keywordflow">case</span> WH_GETMESSAGE:
00291         <span class="comment">/*</span>
00292 <span class="comment">         * These take an lpMsg as their last parameter.  Since these are</span>
00293 <span class="comment">         * exclusively posted parameters, and since nowhere on the server</span>
00294 <span class="comment">         * do we post a message with a pointer to some other structure in</span>
00295 <span class="comment">         * it, the lpMsg structure contents can all be treated verbatim.</span>
00296 <span class="comment">         */</span>
00297         nRet = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1162">fnHkINLPMSG</a>(MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nCode, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>),
00298                 wParam, (LPMSG)lParam, (ULONG_PTR)pfnHookProc,
00299                 ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>,
00300                 (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a503">HF_ANSI</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a>);
00301         <span class="keywordflow">break</span>;
00302 
00303     <span class="keywordflow">case</span> WH_JOURNALPLAYBACK:
00304 
00305 <span class="preprocessor">#ifdef HOOKBATCH</span>
00306 <span class="preprocessor"></span>        <span class="comment">/*</span>
00307 <span class="comment">         * If this hook has cached playback info then we need to grab</span>
00308 <span class="comment">         * the info out of the cache.</span>
00309 <span class="comment">         */</span>
00310 
00311         <span class="keywordflow">if</span> (phk-&gt;cEventMessages) {
00312             <span class="keywordflow">if</span> (nCode == HC_GETNEXT) {
00313                 LPEVENTMSG pEventMsg;
00314                 pEventMsg = (LPEVENTMSG)lParam;
00315 
00316                 <span class="keywordflow">if</span> (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a504">HF_NEEDHC_SKIP</a>)
00317                     phk-&gt;iCurrentEvent++;
00318 
00319                 <span class="keywordflow">if</span> (phk-&gt;iCurrentEvent &lt; phk-&gt;cEventMessages) {
00320                     *pEventMsg = phk-&gt;aEventCache[phk-&gt;iCurrentEvent];
00321                 } <span class="keywordflow">else</span> {
00322 
00323                     <span class="comment">/*</span>
00324 <span class="comment">                     * Free the cache set if it is still around</span>
00325 <span class="comment">                     */</span>
00326                     <span class="keywordflow">if</span> (phk-&gt;aEventCache) {
00327                         UserFreePool(phk-&gt;aEventCache);
00328                         phk-&gt;aEventCache = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00329                     }
00330                     phk-&gt;cEventMessages = 0;
00331                     phk-&gt;iCurrentEvent = 0;
00332 
00333                     <span class="keywordflow">goto</span> MakeClientJournalPlaybackCall;
00334                 }
00335 
00336                 <span class="comment">/*</span>
00337 <span class="comment">                 * Return the time and zero the batched time so if we sleep</span>
00338 <span class="comment">                 * this time we won't sleep again next time</span>
00339 <span class="comment">                 */</span>
00340                 nRet = pEventMsg-&gt;time;
00341                 <span class="keywordflow">if</span> (nRet)
00342                     phk-&gt;aEventCache[phk-&gt;iCurrentEvent].time = 0;
00343             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nCode == HC_SKIP) {
00344                 phk-&gt;iCurrentEvent++;
00345                 nRet = 0;
00346             }
00347 
00348         } <span class="keywordflow">else</span> {
00349 <span class="preprocessor">#endif // HOOKBATCH</span>
00350 <span class="preprocessor"></span>            <span class="comment">/*</span>
00351 <span class="comment">             * In order to avoid a client/server transition for HC_SKIP we</span>
00352 <span class="comment">             * piggy-back it on top of the next journal playback event and</span>
00353 <span class="comment">             * send it from there.</span>
00354 <span class="comment">             */</span>
00355 <span class="comment">// MakeClientJournalPlaybackCall:</span>
00356             nRet = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1163">fnHkOPTINLPEVENTMSG</a>(MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nCode, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>),
00357                     (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(phk), (LPEVENTMSG)lParam, (ULONG_PTR)pfnHookProc,
00358                     ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>);
00359 <span class="preprocessor">#ifdef HOOKBATCH</span>
00360 <span class="preprocessor"></span>        }
00361 
00362         <span class="comment">/*</span>
00363 <span class="comment">         * Determine if we received a cached set of events if so then store</span>
00364 <span class="comment">         * them away off of the hook.</span>
00365 <span class="comment">         * paramL will be the number of events.</span>
00366 <span class="comment">         * paramH will be the array of events.</span>
00367 <span class="comment">         */</span>
00368         <span class="keywordflow">if</span> ((nCode == HC_GETNEXT) &amp;&amp; (((LPEVENTMSG)lParam)-&gt;message == 0x12341234)) {
00369             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00370             LPEVENTMSG pEventMsg = (LPEVENTMSG)lParam;
00371 
00372             <span class="comment">/*</span>
00373 <span class="comment">             * We should not be getting another cached set if we aren't</span>
00374 <span class="comment">             * done with the first set</span>
00375 <span class="comment">             */</span>
00376             UserAssert((phk-&gt;cEventMessages == 0) ||
00377                     (phk-&gt;cEventMessages &gt;= phk-&gt;iCurrentEvent));
00378             UserAssert((pEventMsg-&gt;paramL &lt; 500) &amp;&amp; (pEventMsg-&gt;paramL &gt; 1));
00379 
00380             <span class="comment">/*</span>
00381 <span class="comment">             * Free the last cache set if it is still around</span>
00382 <span class="comment">             */</span>
00383             <span class="keywordflow">if</span> (phk-&gt;aEventCache) {
00384                 UserFreePool(phk-&gt;aEventCache);
00385                 phk-&gt;aEventCache = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00386             }
00387 
00388             <span class="keywordflow">if</span> (phk-&gt;aEventCache = LocalAlloc(LPTR,
00389                     pEventMsg-&gt;paramL*<span class="keyword">sizeof</span>(EVENTMSG))) {
00390                 <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00391 
00392                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwReadVirtualMemory(Thread-&gt;Process-&gt;ProcessHandle,
00393                         (PVOID)pEventMsg-&gt;paramH, phk-&gt;aEventCache,
00394                         pEventMsg-&gt;paramL*<span class="keyword">sizeof</span>(EVENTMSG), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00395 
00396                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00397                     phk-&gt;cEventMessages = pEventMsg-&gt;paramL;
00398                     phk-&gt;iCurrentEvent = 0;
00399 
00400                     <span class="comment">/*</span>
00401 <span class="comment">                     * Fill in the real EventMsg for this message</span>
00402 <span class="comment">                     */</span>
00403                     *pEventMsg = phk-&gt;aEventCache[0];
00404                     phk-&gt;aEventCache[0].time = 0;
00405                 }
00406 
00407             } <span class="keywordflow">else</span> {
00408                 phk-&gt;cEventMessages = 0;
00409                 phk-&gt;iCurrentEvent = 0;
00410             }
00411         }
00412 <span class="preprocessor">#endif // HOOKBATCH</span>
00413 <span class="preprocessor"></span>
00414         phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a504">HF_NEEDHC_SKIP</a>;
00415         <span class="keywordflow">break</span>;
00416 
00417     <span class="keywordflow">case</span> WH_JOURNALRECORD:
00418 
00419         nRet = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1163">fnHkOPTINLPEVENTMSG</a>(MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nCode, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>),
00420                 wParam, (LPEVENTMSG)lParam, (ULONG_PTR)pfnHookProc,
00421                 ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>);
00422         <span class="keywordflow">break</span>;
00423 
00424     <span class="keywordflow">case</span> WH_DEBUG:
00425         <span class="comment">/*</span>
00426 <span class="comment">         * This takes an lpDebugHookStruct.</span>
00427 <span class="comment">         */</span>
00428         nRet = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1164">fnHkINLPDEBUGHOOKSTRUCT</a>(MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nCode, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>),
00429                 wParam, (LPDEBUGHOOKINFO)lParam, (ULONG_PTR)pfnHookProc,
00430                 ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>);
00431         <span class="keywordflow">break</span>;
00432 
00433     <span class="keywordflow">case</span> WH_KEYBOARD_LL:
00434         <span class="comment">/*</span>
00435 <span class="comment">         * This takes an lpKbdHookStruct.</span>
00436 <span class="comment">         */</span>
00437         nRet = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1166">fnHkINLPKBDLLHOOKSTRUCT</a>(MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nCode, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>),
00438                 wParam, (LPKBDLLHOOKSTRUCT)lParam,
00439                 (ULONG_PTR)pfnHookProc, ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>);
00440         <span class="keywordflow">break</span>;
00441 
00442     <span class="keywordflow">case</span> WH_MOUSE_LL:
00443         <span class="comment">/*</span>
00444 <span class="comment">         * This takes an lpMsllHookStruct.</span>
00445 <span class="comment">         */</span>
00446         nRet = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1167">fnHkINLPMSLLHOOKSTRUCT</a>(MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nCode, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>),
00447                 wParam, (LPMSLLHOOKSTRUCT)lParam,
00448                 (ULONG_PTR)pfnHookProc, ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>);
00449         <span class="keywordflow">break</span>;
00450 
00451     <span class="keywordflow">case</span> WH_MOUSE:
00452         <span class="comment">/*</span>
00453 <span class="comment">         * This takes an lpMouseHookStructEx.</span>
00454 <span class="comment">         */</span>
00455 MouseHook:
00456         nRet = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1165">fnHkINLPMOUSEHOOKSTRUCTEX</a>(MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nCode, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>),
00457                 wParam, (LPMOUSEHOOKSTRUCTEX)lParam,
00458                 (ULONG_PTR)pfnHookProc, ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>, &amp;phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a>);
00459         <span class="keywordflow">break</span>;
00460     
00461 <span class="preprocessor">#ifdef REDIRECTION</span>
00462 <span class="preprocessor"></span>    <span class="keywordflow">case</span> WH_HITTEST:
00463         <span class="comment">/*</span>
00464 <span class="comment">         * This takes an lpHTHookStruct.</span>
00465 <span class="comment">         */</span>
00466         nRet = fnHkINLPHTHOOKSTRUCT(MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nCode, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>),
00467                 wParam, (LPHTHOOKSTRUCT)lParam,
00468                 (ULONG_PTR)pfnHookProc, ppfnClient-&gt;<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>);
00469         <span class="keywordflow">break</span>;
00470 <span class="preprocessor">#endif // REDIRECTION</span>
00471 <span class="preprocessor"></span>
00472     }
00473 
00474     <span class="keywordflow">if</span> (fLockForeground) {
00475         <a class="code" href="../../d4/d1/userk_8h.html#a146">ThreadUnlockSFWLockCount</a>(&amp;tlSFWLock);
00476     }
00477 
00478     <span class="keywordflow">return</span> nRet;
00479 }
00480 
00481 <span class="comment">/***************************************************************************\</span>
00482 <span class="comment">* fnHkINLPCWPEXSTRUCT</span>
00483 <span class="comment">*</span>
00484 <span class="comment">* This gets thunked through the message thunks, so it has the format</span>
00485 <span class="comment">* of a c/s message thunk call.</span>
00486 <span class="comment">*</span>
00487 <span class="comment">* 05-09-91 ScottLu      Created.</span>
00488 <span class="comment">\***************************************************************************/</span>
00489 
<a name="l00490"></a><a class="code" href="../../d4/d1/userk_8h.html#a1820">00490</a> LRESULT <a class="code" href="../../d4/d1/userk_8h.html#a1820">fnHkINLPCWPEXSTRUCT</a>(
00491     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00492     UINT message,
00493     WPARAM wParam,
00494     LPARAM lParam,
00495     ULONG_PTR xParam)
00496 {
00497     <a class="code" href="../../d0/d0/struct__CWPSTRUCTEX.html">CWPSTRUCTEX</a> cwp;
00498     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
00499 
00500     UNREFERENCED_PARAMETER(xParam);
00501 
00502     cwp.hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
00503     cwp.message = message;
00504     cwp.wParam = wParam;
00505     cwp.lParam = lParam;
00506     cwp.<a class="code" href="../../d0/d0/struct__CWPSTRUCTEX.html#o0">psmsSender</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00507 
00508     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(HC_ACTION, (pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a116">CI_INTERTHREAD_HOOK</a>) != 0,
00509             (LPARAM)&amp;cwp);
00510 }
00511 
<a name="l00512"></a><a class="code" href="../../d4/d1/userk_8h.html#a1821">00512</a> LRESULT <a class="code" href="../../d4/d1/userk_8h.html#a1821">fnHkINLPCWPRETEXSTRUCT</a>(
00513     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00514     UINT message,
00515     WPARAM wParam,
00516     LPARAM lParam,
00517     ULONG_PTR xParam)
00518 {
00519     <a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html">CWPRETSTRUCTEX</a> cwp;
00520     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
00521 
00522     UNREFERENCED_PARAMETER(xParam);
00523 
00524     cwp.hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
00525     cwp.message = message;
00526     cwp.wParam = wParam;
00527     cwp.lParam = lParam;
00528     cwp.<a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html#o0">lResult</a> = pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o14">dwHookData</a>;
00529     cwp.<a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html#o1">psmsSender</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00530 
00531     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(HC_ACTION, (pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a116">CI_INTERTHREAD_HOOK</a>) != 0,
00532             (LPARAM)&amp;cwp);
00533 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:51 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
