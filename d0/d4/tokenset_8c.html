<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: tokenset.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>tokenset.c File Reference</h1><code>#include "<a class="el" href="../../d7/d5/sep_8h-source.html">sep.h</a>"</code><br>
<code>#include "sertlp.h"</code><br>
<code>#include "<a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>"</code><br>

<p>
<a href="../../d1/d3/tokenset_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/tokenset_8c.html#a0">NtSetInformationToken</a> (IN HANDLE TokenHandle, IN TOKEN_INFORMATION_CLASS TokenInformationClass, IN PVOID TokenInformation, IN ULONG TokenInformationLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/tokenset_8c.html#a1">SepFreePrimaryGroup</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/tokenset_8c.html#a2">SepFreeDefaultDacl</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/tokenset_8c.html#a3">SepAppendPrimaryGroup</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN PSID PSid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/tokenset_8c.html#a4">SepAppendDefaultDacl</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN PACL PAcl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/tokenset_8c.html#a5">SeSetSessionIdToken</a> (PACCESS_TOKEN <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, ULONG SessionId)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="tokenset.c::NtSetInformationToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetInformationToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN TOKEN_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenInformationLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">37</a> of file <a class="el" href="../../d1/d3/tokenset_8c-source.html">tokenset.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00148">CurrentLength</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01370">SeCaptureAcl()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01141">SeCaptureSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00416">SepAcquireTokenWriteLock</a>, <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00778">SepAppendDefaultDacl()</a>, <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00697">SepAppendPrimaryGroup()</a>, <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00635">SepFreeDefaultDacl()</a>, <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00576">SepFreePrimaryGroup()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00306">SepIdAssignableAsGroup()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02813">SepIdAssignableAsOwner()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00444">SepReleaseTokenWriteLock</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01560">SeReleaseAcl()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01320">SeReleaseSid()</a>, <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00851">SeSetSessionIdToken()</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00436">SeSinglePrivilegeCheck()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01675">SeTcbPrivilege</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/cttoken_8c-source.html#l03311">TestTokenSet()</a>.
<p>
<pre class="fragment"><div>00047                    :
00048 
00049     Modify information in a specified token.
00050 
00051 Arguments:
00052 
00053     TokenHandle - Provides a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to operate on.
00054 
00055     TokenInformationClass - The token information <span class="keyword">class </span>being set.
00056 
00057     TokenInformation - The buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> new values for <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00058         specified class of information.  The buffer must be aligned
00059         on at least a longword boundary.  The actual structures
00060         provided are dependent upon <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information class specified,
00061         as defined in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TokenInformationClass parameter
00062         description.
00063 
00064         TokenInformation Format By Information Class:
00065 
00066            TokenUser =&gt; This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a valid value for this API.
00067            The User <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> may not be replaced.
00068 
00069            TokenGroups =&gt; This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a valid value for this
00070            API.  The <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> IDs may not be replaced.  However, groups
00071            may be enabled and disabled using <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>().
00072 
00073            TokenPrivileges =&gt; This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a valid value for
00074            this API.  Privilege information may not be replaced.
00075            However, privileges may be explicitly enabled and disabled
00076            using <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a> API.
00077 
00078            TokenOwner =&gt; TOKEN_OWNER data structure.
00079            TOKEN_ADJUST_DEFAULT access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to replace this
00080            information in a token.  The owner values that may be
00081            specified are restricted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user and group IDs with an
00082            attribute indicating they may be assigned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of
00083            objects.
00084 
00085            TokenPrimaryGroup =&gt; TOKEN_PRIMARY_GROUP data structure.
00086            TOKEN_ADJUST_DEFAULT access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to replace this
00087            information in a token.  The primary group values that may
00088            be specified are restricted to be one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group IDs
00089            already in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00090 
00091            TokenDefaultDacl =&gt; TOKEN_DEFAULT_DACL data structure.
00092            TOKEN_ADJUST_DEFAULT access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to replace this
00093            information in a token.  The ACL provided as a new default
00094            discretionary ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not validated for structural
00095            correctness or consistency.
00096 
00097            TokenSource =&gt; This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a valid value for this
00098            API.  The source name and context handle  may not be
00099            replaced.
00100 
00101            TokenStatistics =&gt; This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a valid value for this
00102            API.  The statistics of a token are read-<a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
00103 
00104     TokenInformationLength - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00105         TokenInformation buffer.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary
00106         buffer.  All extensions of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary buffer are self describing.
00107 
00108 Return Value:
00109 
00110     STATUS_SUCCESS - The operation was successful.
00111 
00112     STATUS_INVALID_OWNER - The <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> specified to be an owner (or
00113         default owner) <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not one <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller may assign as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner
00114         of an object.
00115 
00116     STATUS_INVALID_INFO_CLASS - The specified information class <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00117         not one that may be specified in this API.
00118 
00119     STATUS_ALLOTTED_SPACE_EXCEEDED - The space allotted for storage
00120         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> default discretionary access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary
00121         group <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not large enough to accept <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> new value of one
00122         of these fields.
00123 
00124 --*/
00125 {
00126 
00127     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00128     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00129 
00130     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00131 
00132     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00133     BOOLEAN Found;
00134     BOOLEAN TokenModified = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00135 
00136     ULONG NewLength;
00137     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a>;
00138 
00139     PSID CapturedOwner;
00140     PSID CapturedPrimaryGroup;
00141     PACL CapturedDefaultDacl;
00142     ACCESS_MASK DesiredAccess;
00143 
00144     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00145 
00146     <span class="comment">//</span>
00147     <span class="comment">// Get previous processor mode and probe input buffer if necessary.</span>
00148     <span class="comment">//</span>
00149 
00150     PreviousMode = KeGetPreviousMode();
00151     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00152         <span class="keywordflow">try</span> {
00153 
00154             <span class="comment">//</span>
00155             <span class="comment">// This just probes the main part of the information buffer.</span>
00156             <span class="comment">// Any information class-specific data hung off the primary</span>
00157             <span class="comment">// buffer are self describing and must be probed separately</span>
00158             <span class="comment">// below.</span>
00159             <span class="comment">//</span>
00160 
00161             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00162                 TokenInformation,
00163                 TokenInformationLength,
00164                 <span class="keyword">sizeof</span>(ULONG)
00165                 );
00166 
00167         } except(EXCEPTION_EXECUTE_HANDLER) {
00168             <span class="keywordflow">return</span> GetExceptionCode();
00169         }
00170     }
00171 
00172     <span class="comment">//</span>
00173     <span class="comment">// Return error if not legal class</span>
00174     <span class="comment">//</span>
00175     <span class="keywordflow">if</span> ( (TokenInformationClass != TokenOwner)  &amp;&amp;
00176          (TokenInformationClass != TokenPrimaryGroup) &amp;&amp;
00177          (TokenInformationClass != TokenSessionId) &amp;&amp;
00178          (TokenInformationClass != TokenDefaultDacl) ) {
00179 
00180         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00181 
00182     }
00183 
00184     <span class="comment">//</span>
00185     <span class="comment">// Check access rights and reference token</span>
00186     <span class="comment">//</span>
00187 
00188 
00189     DesiredAccess = TOKEN_ADJUST_DEFAULT;
00190     <span class="keywordflow">if</span> (TokenInformationClass == TokenSessionId) {
00191         DesiredAccess |= TOKEN_ADJUST_SESSIONID;
00192     }
00193 
00194     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00195              TokenHandle,           <span class="comment">// Handle</span>
00196              DesiredAccess,         <span class="comment">// DesiredAccess</span>
00197              SepTokenObjectType,    <span class="comment">// ObjectType</span>
00198              PreviousMode,          <span class="comment">// AccessMode</span>
00199              (PVOID *)&amp;Token,       <span class="comment">// Object</span>
00200              NULL                   <span class="comment">// GrantedAccess</span>
00201              );
00202 
00203     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00204         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00205     }
00206 
00207 
00208     <span class="comment">//</span>
00209     <span class="comment">// Case on information class.</span>
00210     <span class="comment">//</span>
00211 
00212     <span class="keywordflow">switch</span> ( TokenInformationClass ) {
00213 
00214     <span class="keywordflow">case</span> TokenOwner:
00215 
00216         <span class="comment">//</span>
00217         <span class="comment">//  Make sure the buffer is large enough to hold the</span>
00218         <span class="comment">//  necessary information class data structure.</span>
00219         <span class="comment">//</span>
00220 
00221         <span class="keywordflow">if</span> (TokenInformationLength &lt; (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER)) {
00222 
00223             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00224             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00225         }
00226 
00227         <span class="comment">//</span>
00228         <span class="comment">//  Capture and copy</span>
00229 
00230         <span class="keywordflow">try</span> {
00231 
00232             <span class="comment">//</span>
00233             <span class="comment">//  Capture Owner SID</span>
00234             <span class="comment">//</span>
00235 
00236             CapturedOwner = ((PTOKEN_OWNER)TokenInformation)-&gt;Owner;
00237             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a8">SeCaptureSid</a>(
00238                          CapturedOwner,
00239                          PreviousMode,
00240                          NULL, 0,
00241                          PagedPool,
00242                          TRUE,
00243                          &amp;CapturedOwner
00244                          );
00245 
00246         } except(EXCEPTION_EXECUTE_HANDLER) {
00247 
00248             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00249             <span class="keywordflow">return</span> GetExceptionCode();
00250         }
00251 
00252         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00253             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00254             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00255         }
00256 
00257         <span class="comment">//</span>
00258         <span class="comment">//  Gain write access to the token.</span>
00259         <span class="comment">//</span>
00260 
00261         <a class="code" href="../../d8/d3/tokenp_8h.html#a7">SepAcquireTokenWriteLock</a>( Token );
00262 
00263         <span class="comment">//</span>
00264         <span class="comment">//  Walk through the list of user and group IDs looking</span>
00265         <span class="comment">//  for a match to the specified SID.  If one is found,</span>
00266         <span class="comment">//  make sure it may be assigned as an owner.  If it can,</span>
00267         <span class="comment">//  then set the index in the token's OwnerIndex field.</span>
00268         <span class="comment">//  Otherwise, return invalid owner error.</span>
00269         <span class="comment">//</span>
00270 
00271         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00272         <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount) {
00273 
00274             <span class="keywordflow">try</span> {
00275 
00276                 Found = <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(
00277                             CapturedOwner,
00278                             <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[Index].Sid
00279                             );
00280 
00281                 <span class="keywordflow">if</span> ( Found ) {
00282 
00283                     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a33">SepIdAssignableAsOwner</a>(Token,Index) ){
00284 
00285                         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00286                         TokenModified = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00287                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00288 
00289                     } <span class="keywordflow">else</span> {
00290 
00291                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OWNER;
00292 
00293                     } <span class="comment">//endif assignable</span>
00294 
00295                     <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, TokenModified );
00296                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00297                     <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedOwner, PreviousMode, TRUE);
00298                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00299 
00300                 }  <span class="comment">//endif Found</span>
00301 
00302             } except(EXCEPTION_EXECUTE_HANDLER) {
00303 
00304                 <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, TokenModified );
00305                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00306                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedOwner, PreviousMode, TRUE);
00307                 <span class="keywordflow">return</span> GetExceptionCode();
00308 
00309             }  <span class="comment">//endtry</span>
00310 
00311             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00312 
00313         } <span class="comment">//endwhile</span>
00314 
00315         <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, TokenModified );
00316         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00317         <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedOwner, PreviousMode, TRUE);
00318         <span class="keywordflow">return</span> STATUS_INVALID_OWNER;
00319 
00320     <span class="keywordflow">case</span> TokenPrimaryGroup:
00321 
00322         <span class="comment">//</span>
00323         <span class="comment">// Assuming everything works out, the strategy is to move everything</span>
00324         <span class="comment">// in the Dynamic part of the token (exept the primary group) to</span>
00325         <span class="comment">// the beginning of the dynamic part, freeing up the entire end of</span>
00326         <span class="comment">// the dynamic part for the new primary group.</span>
00327         <span class="comment">//</span>
00328 
00329         <span class="comment">//</span>
00330         <span class="comment">//  Make sure the buffer is large enough to hold the</span>
00331         <span class="comment">//  necessary information class data structure.</span>
00332         <span class="comment">//</span>
00333 
00334         <span class="keywordflow">if</span> (TokenInformationLength &lt; (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP)) {
00335 
00336             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00337             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00338         }
00339 
00340         <span class="comment">//</span>
00341         <span class="comment">// Capture And Validate TOKEN_PRIMARY_GROUP and corresponding SID.</span>
00342         <span class="comment">//</span>
00343 
00344         <span class="keywordflow">try</span> {
00345 
00346             CapturedPrimaryGroup =
00347                 ((PTOKEN_PRIMARY_GROUP)TokenInformation)-&gt;PrimaryGroup;
00348 
00349             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a8">SeCaptureSid</a>(
00350                          CapturedPrimaryGroup,
00351                          PreviousMode,
00352                          NULL, 0,
00353                          PagedPool,
00354                          TRUE,
00355                          &amp;CapturedPrimaryGroup
00356                          );
00357 
00358         } except(EXCEPTION_EXECUTE_HANDLER) {
00359 
00360             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00361             <span class="keywordflow">return</span> GetExceptionCode();
00362         }
00363 
00364         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00365             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00366             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00367         }
00368 
00369         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d8/subject_8c.html#a5">SepIdAssignableAsGroup</a>( Token, CapturedPrimaryGroup )) {
00370             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00371             <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedPrimaryGroup, PreviousMode, TRUE);
00372             <span class="keywordflow">return</span> STATUS_INVALID_PRIMARY_GROUP;
00373         }
00374 
00375         <span class="comment">//</span>
00376         <span class="comment">//  Gain write access to the token.</span>
00377         <span class="comment">//</span>
00378 
00379         <a class="code" href="../../d8/d3/tokenp_8h.html#a7">SepAcquireTokenWriteLock</a>( Token );
00380 
00381         <span class="comment">//</span>
00382         <span class="comment">// See if there is enough room in the dynamic part of the token</span>
00383         <span class="comment">// to replace the current Primary Group with the one specified.</span>
00384         <span class="comment">//</span>
00385 
00386         NewLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( CapturedPrimaryGroup );
00387         <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a> = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup );
00388 
00389         <span class="keywordflow">if</span> (NewLength &gt; (<a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a> + <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable) ) {
00390 
00391             <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, TokenModified );
00392             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00393             <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedPrimaryGroup, PreviousMode, TRUE);
00394             <span class="keywordflow">return</span> STATUS_ALLOTTED_SPACE_EXCEEDED;
00395         }
00396 
00397         <span class="comment">//</span>
00398         <span class="comment">// Free up the existing primary group</span>
00399         <span class="comment">//</span>
00400 
00401         <a class="code" href="../../d0/d4/tokenset_8c.html#a1">SepFreePrimaryGroup</a>( Token );
00402 
00403         <span class="comment">//</span>
00404         <span class="comment">// And put the new SID in its place</span>
00405         <span class="comment">//</span>
00406 
00407         <a class="code" href="../../d0/d4/tokenset_8c.html#a3">SepAppendPrimaryGroup</a>( Token, CapturedPrimaryGroup );
00408 
00409         TokenModified = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00410 
00411         <span class="comment">//</span>
00412         <span class="comment">// All done.</span>
00413         <span class="comment">//</span>
00414 
00415         <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, TokenModified );
00416         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00417         <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedPrimaryGroup, PreviousMode, TRUE);
00418         <span class="keywordflow">return</span> STATUS_SUCCESS;
00419 
00420 
00421     <span class="keywordflow">case</span> TokenDefaultDacl:
00422 
00423         <span class="comment">//</span>
00424         <span class="comment">// Assuming everything works out, the strategy is to move everything</span>
00425         <span class="comment">// in the Dynamic part of the token (exept the default Dacl) to</span>
00426         <span class="comment">// the beginning of the dynamic part, freeing up the entire end of</span>
00427         <span class="comment">// the dynamic part for the new default Dacl.</span>
00428         <span class="comment">//</span>
00429 
00430         <span class="comment">//</span>
00431         <span class="comment">//  Make sure the buffer is large enough to hold the</span>
00432         <span class="comment">//  necessary information class data structure.</span>
00433         <span class="comment">//</span>
00434 
00435         <span class="keywordflow">if</span> (TokenInformationLength &lt; (ULONG)<span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL)) {
00436 
00437             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00438             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00439         }
00440 
00441         <span class="comment">//</span>
00442         <span class="comment">// Capture And Validate TOKEN_DEFAULT_DACL and corresponding ACL.</span>
00443         <span class="comment">//</span>
00444 
00445         <span class="keywordflow">try</span> {
00446 
00447             CapturedDefaultDacl =
00448                 ((PTOKEN_DEFAULT_DACL)TokenInformation)-&gt;DefaultDacl;
00449 
00450             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedDefaultDacl)) {
00451                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a10">SeCaptureAcl</a>(
00452                              CapturedDefaultDacl,
00453                              PreviousMode,
00454                              NULL, 0,
00455                              PagedPool,
00456                              TRUE,
00457                              &amp;CapturedDefaultDacl,
00458                              &amp;NewLength
00459                              );
00460 
00461             } <span class="keywordflow">else</span> {
00462                 NewLength = 0;
00463                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00464             }
00465 
00466         } except(EXCEPTION_EXECUTE_HANDLER) {
00467 
00468             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00469             <span class="keywordflow">return</span> GetExceptionCode();
00470         }
00471 
00472         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00473             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00474             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00475         }
00476 
00477         <span class="comment">//</span>
00478         <span class="comment">//  Gain write access to the token.</span>
00479         <span class="comment">//</span>
00480 
00481         <a class="code" href="../../d8/d3/tokenp_8h.html#a7">SepAcquireTokenWriteLock</a>( Token );
00482 
00483         <span class="comment">//</span>
00484         <span class="comment">// See if there is enough room in the dynamic part of the token</span>
00485         <span class="comment">// to replace the current Default Dacl with the one specified.</span>
00486         <span class="comment">//</span>
00487 
00488         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00489             <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a> = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize;
00490         } <span class="keywordflow">else</span> {
00491             <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a> = 0;
00492         }
00493 
00494         <span class="keywordflow">if</span> (NewLength &gt; (<a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a> + <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable) ) {
00495 
00496             <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, TokenModified );
00497             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00498             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedDefaultDacl)) {
00499                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a11">SeReleaseAcl</a>( CapturedDefaultDacl, PreviousMode, TRUE);
00500             }
00501             <span class="keywordflow">return</span> STATUS_ALLOTTED_SPACE_EXCEEDED;
00502         }
00503 
00504         <span class="comment">//</span>
00505         <span class="comment">// Free up the existing Default Dacl</span>
00506         <span class="comment">//</span>
00507 
00508         <a class="code" href="../../d0/d4/tokenset_8c.html#a2">SepFreeDefaultDacl</a>( Token );
00509 
00510         <span class="comment">//</span>
00511         <span class="comment">// And put the new ACL in its place</span>
00512         <span class="comment">//</span>
00513 
00514         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedDefaultDacl)) {
00515             <a class="code" href="../../d0/d4/tokenset_8c.html#a4">SepAppendDefaultDacl</a>( Token, CapturedDefaultDacl );
00516         }
00517 
00518         TokenModified = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00519 
00520         <span class="comment">//</span>
00521         <span class="comment">// All done.</span>
00522         <span class="comment">//</span>
00523 
00524         <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, TokenModified );
00525         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00526         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedDefaultDacl)) {
00527             <a class="code" href="../../d2/d5/se_2capture_8c.html#a11">SeReleaseAcl</a>( CapturedDefaultDacl, PreviousMode, TRUE);
00528         }
00529         <span class="keywordflow">return</span> STATUS_SUCCESS;
00530 
00531     <span class="keywordflow">case</span> TokenSessionId:
00532     {
00533        ULONG SessionId;
00534 
00535         <span class="keywordflow">if</span> ( TokenInformationLength != <span class="keyword">sizeof</span>(ULONG) ) {
00536             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00537             <span class="keywordflow">return</span>( STATUS_INFO_LENGTH_MISMATCH );
00538         }
00539 
00540         <span class="keywordflow">try</span> {
00541 
00542            SessionId = *(PULONG)TokenInformation;
00543 
00544         } except(EXCEPTION_EXECUTE_HANDLER) {
00545             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00546             <span class="keywordflow">return</span> GetExceptionCode();
00547         }
00548 
00549         <span class="comment">//</span>
00550         <span class="comment">// We only allow TCB to set SessionId's</span>
00551         <span class="comment">//</span>
00552         <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(SeTcbPrivilege,PreviousMode) ) {
00553             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00554             <span class="keywordflow">return</span>( STATUS_PRIVILEGE_NOT_HELD );
00555         }
00556 
00557         <span class="comment">//</span>
00558         <span class="comment">// Set SessionId for the token</span>
00559         <span class="comment">//</span>
00560         <a class="code" href="../../d0/d4/tokenset_8c.html#a5">SeSetSessionIdToken</a>( (PACCESS_TOKEN)Token,
00561                              SessionId );
00562 
00563         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00564         <span class="keywordflow">return</span>( STATUS_SUCCESS );
00565     }
00566 
00567     } <span class="comment">//endswitch</span>
00568 
00569     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( TRUE == FALSE );  <span class="comment">// Should never reach here.</span>
00570     <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00571 
00572 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="tokenset.c::SepAppendDefaultDacl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAppendDefaultDacl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>PAcl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00778">778</a> of file <a class="el" href="../../d1/d3/tokenset_8c-source.html">tokenset.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>.
<p>
<pre class="fragment"><div>00786                    :
00787 
00788     Add a <span class="keywordflow">default</span> discretionary ACL to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> available space at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00789     dynamic part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's responsibility to ensure
00790     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> fits within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> available space of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dynamic
00791     part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00792 
00793     The token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be locked <span class="keywordflow">for</span> write access before calling
00794     <span class="keyword">this</span> routine.
00795 
00796 Arguments:
00797 
00798     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00799 
00800     PAcl - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL to add.
00801 
00802 Return Value:
00803 
00804     None.
00805 
00806 --*/
00807 {
00808    ULONG_PTR NextFree;
00809    ULONG AclSize;
00810 
00811    <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00812 
00813     <span class="comment">//</span>
00814     <span class="comment">// Add the size of the primary group to the</span>
00815     <span class="comment">// address of the Dynamic Part of the token to establish</span>
00816     <span class="comment">// where the primary group should be placed.</span>
00817     <span class="comment">//</span>
00818 
00819     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup));
00820 
00821     NextFree = (ULONG_PTR)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup);
00822 
00823     <span class="comment">//</span>
00824     <span class="comment">// Now copy the default Dacl</span>
00825     <span class="comment">//</span>
00826 
00827     AclSize = (ULONG)(PAcl-&gt;AclSize);
00828 <span class="comment">//    ASSERT(AclSize == (ULONG)LongAlignSize(AclSize));</span>
00829 
00830     RtlCopyMemory(
00831         (PVOID)NextFree,
00832         (PVOID)PAcl,
00833         AclSize
00834         );
00835 
00836     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl = (PACL)NextFree;
00837 
00838     <span class="comment">//</span>
00839     <span class="comment">// And decrement the amount of the dynamic part that is available.</span>
00840     <span class="comment">//</span>
00841 
00842     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( AclSize &lt;= (Token-&gt;DynamicAvailable) );
00843     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable -= AclSize;
00844 
00845     <span class="keywordflow">return</span>;
00846 
00847 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="tokenset.c::SepAppendPrimaryGroup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAppendPrimaryGroup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PSid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00697">697</a> of file <a class="el" href="../../d1/d3/tokenset_8c-source.html">tokenset.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>.
<p>
<pre class="fragment"><div>00705                    :
00706 
00707     Add a primary group SID to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> available space at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dynamic
00708     part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's responsibility to ensure that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00709     primary group SID fits within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> available space of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dynamic part of
00710     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00711 
00712     The token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be locked <span class="keywordflow">for</span> write access before calling
00713     <span class="keyword">this</span> routine.
00714 
00715 Arguments:
00716 
00717     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00718 
00719     PSid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID to add.
00720 
00721 Return Value:
00722 
00723     None.
00724 
00725 --*/
00726 {
00727    ULONG_PTR NextFree;
00728    ULONG SidSize;
00729 
00730    <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">// Add the size of the Default Dacl (if there is one) to the</span>
00734     <span class="comment">// address of the Dynamic Part of the token to establish</span>
00735     <span class="comment">// where the primary group should be placed.</span>
00736     <span class="comment">//</span>
00737 
00738     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00739 
00740 <span class="comment">//        ASSERT( (ULONG)(Token-&gt;DefaultDacl-&gt;AclSize) ==</span>
00741 <span class="comment">//                (ULONG)LongAlignSize(Token-&gt;DefaultDacl-&gt;AclSize) );</span>
00742 
00743         NextFree = (ULONG_PTR)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart) + <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize;
00744 
00745     } <span class="keywordflow">else</span> {
00746 
00747         NextFree = (ULONG_PTR)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart);
00748 
00749     }
00750 
00751     <span class="comment">//</span>
00752     <span class="comment">// Now copy the primary group SID.</span>
00753     <span class="comment">//</span>
00754 
00755 
00756     SidSize = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( PSid );
00757 
00758     RtlCopyMemory(
00759         (PVOID)NextFree,
00760         (PVOID)PSid,
00761         SidSize
00762         );
00763 
00764     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup = (PSID)NextFree;
00765 
00766     <span class="comment">//</span>
00767     <span class="comment">// And decrement the amount of the dynamic part that is available.</span>
00768     <span class="comment">//</span>
00769 
00770     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SidSize &lt;= (Token-&gt;DynamicAvailable) );
00771     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable -= SidSize;
00772 
00773     <span class="keywordflow">return</span>;
00774 
00775 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="tokenset.c::SepFreeDefaultDacl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepFreeDefaultDacl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Token</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00635">635</a> of file <a class="el" href="../../d1/d3/tokenset_8c-source.html">tokenset.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>.
<p>
<pre class="fragment"><div>00642                    :
00643 
00644     Free up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dynamic part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token take up by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span>
00645     discretionary access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> list.
00646 
00647     The token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be locked <span class="keywordflow">for</span> write access before calling
00648     <span class="keyword">this</span> routine.
00649 
00650 Arguments:
00651 
00652     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00653 
00654 Return Value:
00655 
00656     None.
00657 
00658 --*/
00659 {
00660    ULONG PrimaryGroupSize;
00661 
00662    <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">// Add the size of the Default Dacl (if there is one) to the</span>
00666     <span class="comment">// DynamicAvailable field.</span>
00667     <span class="comment">//</span>
00668     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00669 
00670         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable += <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize;
00671         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00672 
00673     }
00674 
00675     <span class="comment">//</span>
00676     <span class="comment">// If it is not already at the beginning of the dynamic part, move</span>
00677     <span class="comment">// the primary group there (remember to update the pointer to it).</span>
00678     <span class="comment">//</span>
00679 
00680     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart != (PULONG)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup)) {
00681 
00682         PrimaryGroupSize = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup );
00683 
00684         RtlMoveMemory(
00685             (PVOID)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart),
00686             (PVOID)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup),
00687             PrimaryGroupSize
00688             );
00689 
00690         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup = (PSID)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart);
00691     }
00692 
00693     <span class="keywordflow">return</span>;
00694 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="tokenset.c::SepFreePrimaryGroup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepFreePrimaryGroup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Token</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00576">576</a> of file <a class="el" href="../../d1/d3/tokenset_8c-source.html">tokenset.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>.
<p>
<pre class="fragment"><div>00583                    :
00584 
00585     Free up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dynamic part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token take up by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary
00586     group.
00587 
00588     The token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be locked <span class="keywordflow">for</span> write access before calling
00589     <span class="keyword">this</span> routine.
00590 
00591 Arguments:
00592 
00593     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00594 
00595 Return Value:
00596 
00597     None.
00598 
00599 --*/
00600 {
00601     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00602 
00603     <span class="comment">//</span>
00604     <span class="comment">// Add the size of the primary group to the DynamicAvailable field.</span>
00605     <span class="comment">//</span>
00606 
00607     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup );
00608 
00609     <span class="comment">//</span>
00610     <span class="comment">// If there is a default discretionary ACL, and it is not already at the</span>
00611     <span class="comment">// beginning of the dynamic part, move it there (remember to update the</span>
00612     <span class="comment">// pointer to it).</span>
00613     <span class="comment">//</span>
00614 
00615     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00616         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart != (PULONG)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00617 
00618             RtlMoveMemory(
00619                 (PVOID)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart),
00620                 (PVOID)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl),
00621                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize
00622                 );
00623 
00624             <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl = (PACL)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart);
00625 
00626         }
00627     }
00628 
00629     <span class="keywordflow">return</span>;
00630 
00631 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="tokenset.c::SeSetSessionIdToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeSetSessionIdToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SessionId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00851">851</a> of file <a class="el" href="../../d1/d3/tokenset_8c-source.html">tokenset.c</a>.
<p>
References <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00416">SepAcquireTokenWriteLock</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00444">SepReleaseTokenWriteLock</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>, and <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>.
<p>
<pre class="fragment"><div>00858                    :
00859 
00860     Sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SessionId <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified token object.
00861 
00862 Arguments:
00863 
00864     pOpaqueToken (input)
00865       Opaque kernel Token access pointer
00866 
00867     SessionId (input)
00868       SessionId to store in token
00869 
00870 Return Value:
00871 
00872     STATUS_SUCCESS - no error
00873 
00874 --*/
00875 {
00876 
00877 
00878    <span class="comment">//</span>
00879    <span class="comment">//  Gain write access to the token.</span>
00880    <span class="comment">//</span>
00881 
00882    <a class="code" href="../../d8/d3/tokenp_8h.html#a7">SepAcquireTokenWriteLock</a>( Token );
00883 
00884    ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;SessionId = SessionId;
00885 
00886    <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, TRUE );
00887 
00888    <span class="keywordflow">return</span>( STATUS_SUCCESS );
00889 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
