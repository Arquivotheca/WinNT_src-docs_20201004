<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: accessck.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>accessck.c File Reference</h1><code>#include "<a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>"</code><br>
<code>#include &lt;sertlp.h&gt;</code><br>

<p>
<a href="../../d1/d3/accessck_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a23">ACCESS_MASK_FIELD_TO_UPDATE</a> { <a class="el" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a>, 
<a class="el" href="../../d0/d4/accessck_8c.html#a23a1">UpdateCurrentGranted</a>, 
<a class="el" href="../../d0/d4/accessck_8c.html#a23a2">UpdateCurrentDenied</a>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a3">SepUpdateParentTypeList</a> (IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList, IN ULONG ObjectTypeListLength, IN ULONG StartIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a> (IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList, IN ULONG ObjectTypeListLength, IN ULONG StartIndex, IN ACCESS_MASK AccessMask, IN <a class="el" href="../../d0/d4/accessck_8c.html#a23">ACCESS_MASK_FIELD_TO_UPDATE</a> FieldToUpdate)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a5">SeAccessCheckByType</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN PSID PrincipalSelfSid, IN HANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>, IN ACCESS_MASK DesiredAccess, IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL, IN ULONG ObjectTypeListLength, IN PGENERIC_MAPPING GenericMapping, OUT PPRIVILEGE_SET PrivilegeSet, IN OUT PULONG PrivilegeSetLength, OUT PACCESS_MASK GrantedAccess, OUT PNTSTATUS AccessStatus, IN BOOLEAN ReturnResultList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a6">SepMaximumAccessCheck</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> EToken, IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>, IN PACL <a class="el" href="../../d2/d1/cttoken_8c.html#a55">Dacl</a>, IN PSID PrincipalSelfSid, IN ULONG LocalTypeListLength, IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalTypeList, IN ULONG ObjectTypeListLength, IN BOOLEAN <a class="el" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a7">SepNormalAccessCheck</a> (IN ACCESS_MASK Remaining, IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> EToken, IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>, IN PACL <a class="el" href="../../d2/d1/cttoken_8c.html#a55">Dacl</a>, IN PSID PrincipalSelfSid, IN ULONG LocalTypeListLength, IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalTypeList, IN ULONG ObjectTypeListLength, IN BOOLEAN <a class="el" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a> (IN PACCESS_TOKEN AToken, IN PSID PrincipalSelfSid, IN PSID Sid, IN BOOLEAN DenyAce, IN BOOLEAN <a class="el" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a9">SeCaptureObjectTypeList</a> (IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL, IN ULONG ObjectTypeListLength, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode, OUT <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> *CapturedObjectTypeList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a10">SeFreeCapturedObjectTypeList</a> (IN PVOID ObjectTypeList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a11">SepObjectInTypeList</a> (IN GUID *ObjectType, IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList, IN ULONG ObjectTypeListLength, OUT PULONG ReturnedIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a12">SepSidInToken</a> (IN PACCESS_TOKEN AToken, IN PSID PrincipalSelfSid, IN PSID Sid, IN BOOLEAN DenyAce)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a13">SepAccessCheck</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN PSID PrincipalSelfSid, IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>, IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a> OPTIONAL, IN ACCESS_MASK DesiredAccess, IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList OPTIONAL, IN ULONG ObjectTypeListLength, IN PGENERIC_MAPPING GenericMapping, IN ACCESS_MASK PreviouslyGrantedAccess, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, OUT PACCESS_MASK GrantedAccess, OUT PPRIVILEGE_SET *Privileges OPTIONAL, OUT PNTSTATUS AccessStatus, IN BOOLEAN ReturnResultList, OUT PBOOLEAN ReturnSomeAccessGranted, OUT PBOOLEAN ReturnSomeAccessDenied)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a14">NtAccessCheck</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN HANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>, IN ACCESS_MASK DesiredAccess, IN PGENERIC_MAPPING GenericMapping, OUT PPRIVILEGE_SET PrivilegeSet, IN OUT PULONG PrivilegeSetLength, OUT PACCESS_MASK GrantedAccess, OUT PNTSTATUS AccessStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a15">NtAccessCheckByType</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN PSID PrincipalSelfSid, IN HANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>, IN ACCESS_MASK DesiredAccess, IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL, IN ULONG ObjectTypeListLength, IN PGENERIC_MAPPING GenericMapping, OUT PPRIVILEGE_SET PrivilegeSet, IN OUT PULONG PrivilegeSetLength, OUT PACCESS_MASK GrantedAccess, OUT PNTSTATUS AccessStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a16">NtAccessCheckByTypeResultList</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN PSID PrincipalSelfSid, IN HANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>, IN ACCESS_MASK DesiredAccess, IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL, IN ULONG ObjectTypeListLength, IN PGENERIC_MAPPING GenericMapping, OUT PPRIVILEGE_SET PrivilegeSet, IN OUT PULONG PrivilegeSetLength, OUT PACCESS_MASK GrantedAccess, OUT PNTSTATUS AccessStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a> (IN PPRIVILEGE_SET Privileges)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext, IN BOOLEAN SubjectContextLocked, IN ACCESS_MASK DesiredAccess, IN ACCESS_MASK PreviouslyGrantedAccess, OUT PPRIVILEGE_SET *Privileges OPTIONAL, IN PGENERIC_MAPPING GenericMapping, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, OUT PACCESS_MASK GrantedAccess, OUT PNTSTATUS AccessStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a19">SeProxyAccessCheck</a> (IN PUNICODE_STRING Volume, IN PUNICODE_STRING RelativePath, IN BOOLEAN ContainerObject, IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext, IN BOOLEAN SubjectContextLocked, IN ACCESS_MASK DesiredAccess, IN ACCESS_MASK PreviouslyGrantedAccess, OUT PPRIVILEGE_SET *Privileges OPTIONAL, IN PGENERIC_MAPPING GenericMapping, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, OUT PACCESS_MASK GrantedAccess, OUT PNTSTATUS AccessStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a20">SePrivilegePolicyCheck</a> (IN OUT PACCESS_MASK RemainingDesiredAccess, IN OUT PACCESS_MASK PreviouslyGrantedAccess, IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext OPTIONAL, IN PACCESS_TOKEN ExplicitToken OPTIONAL, OUT PPRIVILEGE_SET *PrivilegeSet, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a21">SepTokenIsOwner</a> (IN PACCESS_TOKEN EffectiveToken, IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN BOOLEAN TokenLocked)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/accessck_8c.html#a22">SeFastTraverseCheck</a> (PSECURITY_DESCRIPTOR SecurityDescriptor, ACCESS_MASK TraverseAccess, <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode)</td></tr>

</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a23" doxytag="accessck.c::ACCESS_MASK_FIELD_TO_UPDATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d0/d4/accessck_8c.html#a23">ACCESS_MASK_FIELD_TO_UPDATE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a23a0" doxytag="UpdateRemaining" ></a>UpdateRemaining</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a23a1" doxytag="UpdateCurrentGranted" ></a>UpdateCurrentGranted</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a23a2" doxytag="UpdateCurrentDenied" ></a>UpdateCurrentDenied</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l00055">55</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
<pre class="fragment"><div>00055              {
00056     <a class="code" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a>,
00057     <a class="code" href="../../d0/d4/accessck_8c.html#a23a1">UpdateCurrentGranted</a>,
00058     <a class="code" href="../../d0/d4/accessck_8c.html#a23a2">UpdateCurrentDenied</a>
00059 } <a class="code" href="../../d0/d4/accessck_8c.html#a23">ACCESS_MASK_FIELD_TO_UPDATE</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a14" doxytag="accessck.c::NtAccessCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtAccessCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPRIVILEGE_SET&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeSet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeSetLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l02413">2413</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00299">CreateDAclToken()</a>, and <a class="el" href="../../d4/d5/tseum_8c-source.html#l00502">TestAccessCheck()</a>.
<p>
<pre class="fragment"><div>02427                    :
02428 
02429     See module <span class="keyword">abstract</span>.
02430 
02431 Arguments:
02432 
02433     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor protecting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
02434         being accessed
02435 
02436     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's token.
02437 
02438     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access mask.
02439 
02440     GenericMapping - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping associated with <span class="keyword">this</span>
02441         object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
02442 
02443     PrivilegeSet - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a buffer that upon <span class="keywordflow">return</span> will contain
02444         any privileges that were used to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access validation.
02445         If no privileges were used, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer will contain a privilege
02446         set consisting of zero privileges.
02447 
02448     PrivilegeSetLength - The size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PrivilegeSet buffer in bytes.
02449 
02450     GrantedAccess - Returns an access mask describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granted access.
02451 
02452     AccessStatus - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value that may be returned indicating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02453          <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> why access was denied.  Routines should avoid hardcoding a
02454          <span class="keywordflow">return</span> value of STATUS_ACCESS_DENIED so that a different value can
02455          be returned when mandatory access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> implemented.
02456 
02457 Return Value:
02458 
02459     STATUS_SUCCESS - The attempt proceeded normally.  This does not
02460         mean access was granted, rather that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameters were
02461         correct.
02462 
02463     STATUS_GENERIC_NOT_MAPPED - The DesiredAccess mask contained
02464         an unmapped generic access.
02465 
02466     STATUS_BUFFER_TOO_SMALL - The passed buffer was not large enough
02467         to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information being returned.
02468 
02469     STATUS_NO_IMPERSONTAION_TOKEN - The passed <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> was not an impersonation
02470         token.
02471 
02472 --*/
02473 
02474 {
02475 
02476     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02477 
02478     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/accessck_8c.html#a5">SeAccessCheckByType</a> (
02479                  SecurityDescriptor,
02480                  NULL,      <span class="comment">// No Principal Self sid</span>
02481                  ClientToken,
02482                  DesiredAccess,
02483                  NULL,      <span class="comment">// No ObjectType List</span>
02484                  0,         <span class="comment">// No ObjectType List</span>
02485                  GenericMapping,
02486                  PrivilegeSet,
02487                  PrivilegeSetLength,
02488                  GrantedAccess,
02489                  AccessStatus,
02490                  FALSE );  <span class="comment">// Return a single GrantedAccess and AccessStatus</span>
02491 
02492 
02493 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="accessck.c::NtAccessCheckByType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtAccessCheckByType           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrincipalSelfSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_TYPE_LIST ObjectTypeList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPRIVILEGE_SET&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeSet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeSetLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l02501">2501</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>.
<p>
<pre class="fragment"><div>02518                    :
02519 
02520     See module <span class="keyword">abstract</span>.
02521 
02522 Arguments:
02523 
02524     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor protecting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
02525         being accessed
02526 
02527     PrincipalSelfSid - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being access checked <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an object which
02528         represents a principal (e.g., a user object), <span class="keyword">this</span> parameter should
02529         be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  Any ACE containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> constant
02530         PRINCIPAL_SELF_SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> replaced by <span class="keyword">this</span> SID.
02531 
02532         The parameter should be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object does not represent a principal.
02533 
02534     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's token.
02535 
02536     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access mask.
02537 
02538     ObjectTypeList - Supplies a list of GUIDs representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object (and
02539         sub-objects) being accessed.  If no list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present, AccessCheckByType
02540         behaves identically to AccessCheck.
02541 
02542     ObjectTypeListLength - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of elements in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ObjectTypeList.
02543 
02544     GenericMapping - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping associated with <span class="keyword">this</span>
02545         object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
02546 
02547     PrivilegeSet - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a buffer that upon <span class="keywordflow">return</span> will contain
02548         any privileges that were used to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access validation.
02549         If no privileges were used, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer will contain a privilege
02550         set consisting of zero privileges.
02551 
02552     PrivilegeSetLength - The size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PrivilegeSet buffer in bytes.
02553 
02554     GrantedAccess - Returns an access mask describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granted access.
02555 
02556     AccessStatus - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value that may be returned indicating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02557          <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> why access was denied.  Routines should avoid hardcoding a
02558          <span class="keywordflow">return</span> value of STATUS_ACCESS_DENIED so that a different value can
02559          be returned when mandatory access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> implemented.
02560 
02561 Return Value:
02562 
02563     STATUS_SUCCESS - The attempt proceeded normally.  This does not
02564         mean access was granted, rather that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameters were
02565         correct.
02566 
02567     STATUS_GENERIC_NOT_MAPPED - The DesiredAccess mask contained
02568         an unmapped generic access.
02569 
02570     STATUS_BUFFER_TOO_SMALL - The passed buffer was not large enough
02571         to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information being returned.
02572 
02573     STATUS_NO_IMPERSONTAION_TOKEN - The passed <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> was not an impersonation
02574         token.
02575 
02576 --*/
02577 
02578 {
02579 
02580     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02581 
02582     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/accessck_8c.html#a5">SeAccessCheckByType</a> (
02583                  SecurityDescriptor,
02584                  PrincipalSelfSid,
02585                  ClientToken,
02586                  DesiredAccess,
02587                  ObjectTypeList,
02588                  ObjectTypeListLength,
02589                  GenericMapping,
02590                  PrivilegeSet,
02591                  PrivilegeSetLength,
02592                  GrantedAccess,
02593                  AccessStatus,
02594                  FALSE );  <span class="comment">// Return a single GrantedAccess and AccessStatus</span>
02595 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="accessck.c::NtAccessCheckByTypeResultList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtAccessCheckByTypeResultList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrincipalSelfSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_TYPE_LIST ObjectTypeList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPRIVILEGE_SET&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeSet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeSetLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l02602">2602</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>02619                    :
02620 
02621     See module <span class="keyword">abstract</span>.
02622 
02623 Arguments:
02624 
02625     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor protecting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
02626         being accessed
02627 
02628     PrincipalSelfSid - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being access checked <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an object which
02629         represents a principal (e.g., a user object), <span class="keyword">this</span> parameter should
02630         be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  Any ACE containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> constant
02631         PRINCIPAL_SELF_SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> replaced by <span class="keyword">this</span> SID.
02632 
02633         The parameter should be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object does not represent a principal.
02634 
02635     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's token.
02636 
02637     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access mask.
02638 
02639     ObjectTypeList - Supplies a list of GUIDs representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object (and
02640         sub-objects) being accessed.  If no list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present, AccessCheckByType
02641         behaves identically to AccessCheck.
02642 
02643     ObjectTypeListLength - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of elements in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ObjectTypeList.
02644 
02645     GenericMapping - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping associated with <span class="keyword">this</span>
02646         object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
02647 
02648     PrivilegeSet - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a buffer that upon <span class="keywordflow">return</span> will contain
02649         any privileges that were used to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access validation.
02650         If no privileges were used, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer will contain a privilege
02651         set consisting of zero privileges.
02652 
02653     PrivilegeSetLength - The size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PrivilegeSet buffer in bytes.
02654 
02655     GrantedAccess - Returns an access mask describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granted access.
02656 
02657     AccessStatus - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value that may be returned indicating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02658          <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> why access was denied.  Routines should avoid hardcoding a
02659          <span class="keywordflow">return</span> value of STATUS_ACCESS_DENIED so that a different value can
02660          be returned when mandatory access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> implemented.
02661 
02662 Return Value:
02663 
02664     STATUS_SUCCESS - The attempt proceeded normally.  This does not
02665         mean access was granted, rather that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameters were
02666         correct.
02667 
02668     STATUS_GENERIC_NOT_MAPPED - The DesiredAccess mask contained
02669         an unmapped generic access.
02670 
02671     STATUS_BUFFER_TOO_SMALL - The passed buffer was not large enough
02672         to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information being returned.
02673 
02674     STATUS_NO_IMPERSONTAION_TOKEN - The passed <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> was not an impersonation
02675         token.
02676 
02677 --*/
02678 
02679 {
02680 
02681     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02682 
02683     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/accessck_8c.html#a5">SeAccessCheckByType</a> (
02684                  SecurityDescriptor,
02685                  PrincipalSelfSid,
02686                  ClientToken,
02687                  DesiredAccess,
02688                  ObjectTypeList,
02689                  ObjectTypeListLength,
02690                  GenericMapping,
02691                  PrivilegeSet,
02692                  PrivilegeSetLength,
02693                  GrantedAccess,
02694                  AccessStatus,
02695                  TRUE );  <span class="comment">// Return an array of GrantedAccess and AccessStatus</span>
02696 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="accessck.c::SeAccessCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SeAccessCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SubjectSecurityContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SubjectContextLocked</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviouslyGrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPRIVILEGE_SET *Privileges&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">3323</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d5/se_8h.html#a22">PSECURITY_SUBJECT_CONTEXT</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00650">SeAssertMappedCanonicalAccess</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l01564">SepAccessCheck()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00650">SepDumpSecurityDescriptor()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00995">SepDumpTokenInfo()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03796">SepTokenIsOwner()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00917">CmpCheckCreateAccess()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01032">CmpCheckNotifyAccess()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00983">ObCheckCreateObjectAccess()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00392">ObCheckObjectAccess()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00602">ObpCheckObjectReference()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00778">ObpCheckTraverseAccess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00366">PspSetPrimaryToken()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03564">SeProxyAccessCheck()</a>, and <a class="el" href="../../d2/d5/tse_8c-source.html#l00503">TestAccessCheck()</a>.
<p>
<pre class="fragment"><div>03338                    :
03339 
03340     See module <span class="keyword">abstract</span>
03341 
03342     This routine MAY perform tests <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following
03343     privileges:
03344 
03345                 <a class="code" href="../../d0/d5/se_8h.html#a86">SeTakeOwnershipPrivilege</a>
03346                 <a class="code" href="../../d0/d5/se_8h.html#a85">SeSecurityPrivilege</a>
03347 
03348     depending upon <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> accesses being requested.
03349 
03350     This routine may also check to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner
03351     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object (to grant WRITE_DAC access).
03352 
03353 Arguments:
03354 
03355     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor protecting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03356          object being accessed
03357 
03358     SubjectSecurityContext - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject's captured security
03359          context
03360 
03361     SubjectContextLocked - Supplies a flag indiciating whether or not
03362         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's subject context <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked, so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not have
03363         to be locked again.
03364 
03365     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mask that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> attempting to
03366          acquire
03367 
03368     PreviouslyGrantedAccess - Supplies any accesses that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user has
03369         already been granted, <span class="keywordflow">for</span> example, as a result of holding a
03370         privilege.
03371 
03372     Privileges - Supplies a pointer in which will be returned a privilege
03373         set indicating any privileges that were used as part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03374         access validation.
03375 
03376     GenericMapping - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping associated with <span class="keyword">this</span>
03377         object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
03378 
03379     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mode to be used in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
03380 
03381     GrantedAccess - Pointer to a returned access mask indicatating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03382          granted access
03383 
03384     AccessStatus - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value that may be returned indicating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03385          <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> why access was denied.  Routines should avoid hardcoding a
03386          <span class="keywordflow">return</span> value of STATUS_ACCESS_DENIED so that a different value can
03387          be returned when mandatory access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> implemented.
03388 
03389 
03390 Return Value:
03391 
03392     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
03393 
03394 --*/
03395 
03396 {
03397     BOOLEAN Success;
03398 
03399     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03400 
03401     <span class="keywordflow">if</span> (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
03402 
03403         <span class="keywordflow">if</span> (DesiredAccess &amp; MAXIMUM_ALLOWED) {
03404 
03405             <span class="comment">//</span>
03406             <span class="comment">// Give him:</span>
03407             <span class="comment">//   GenericAll</span>
03408             <span class="comment">//   Anything else he asked for</span>
03409             <span class="comment">//</span>
03410 
03411             *GrantedAccess = GenericMapping-&gt;GenericAll;
03412             *GrantedAccess |= (DesiredAccess &amp; ~MAXIMUM_ALLOWED);
03413             *GrantedAccess |= PreviouslyGrantedAccess;
03414 
03415         } <span class="keywordflow">else</span> {
03416 
03417             *GrantedAccess = DesiredAccess | PreviouslyGrantedAccess;
03418         }
03419         *AccessStatus = STATUS_SUCCESS;
03420         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03421     }
03422 
03423     <span class="comment">//</span>
03424     <span class="comment">// If the object doesn't have a security descriptor (and it's supposed</span>
03425     <span class="comment">// to), return access denied.</span>
03426     <span class="comment">//</span>
03427 
03428     <span class="keywordflow">if</span> ( SecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03429 
03430        *AccessStatus = STATUS_ACCESS_DENIED;
03431        <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03432 
03433     }
03434 
03435     <span class="comment">//</span>
03436     <span class="comment">// If we're impersonating a client, we have to be at impersonation level</span>
03437     <span class="comment">// of SecurityImpersonation or above.</span>
03438     <span class="comment">//</span>
03439 
03440     <span class="keywordflow">if</span> ( (SubjectSecurityContext-&gt;ClientToken != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03441          (SubjectSecurityContext-&gt;ImpersonationLevel &lt; SecurityImpersonation)
03442        ) {
03443            *AccessStatus = STATUS_BAD_IMPERSONATION_LEVEL;
03444            <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03445     }
03446 
03447     <span class="keywordflow">if</span> ( DesiredAccess == 0 ) {
03448 
03449         <span class="keywordflow">if</span> ( PreviouslyGrantedAccess == 0 ) {
03450             *AccessStatus = STATUS_ACCESS_DENIED;
03451             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03452         }
03453 
03454         *GrantedAccess = PreviouslyGrantedAccess;
03455         *AccessStatus = STATUS_SUCCESS;
03456         *Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03457         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03458 
03459     }
03460 
03461     <a class="code" href="../../d0/d5/se_8h.html#a14">SeAssertMappedCanonicalAccess</a>( DesiredAccess );
03462 
03463 
03464     <span class="comment">//</span>
03465     <span class="comment">// If the caller did not lock the subject context for us,</span>
03466     <span class="comment">// lock it here to keep lower level routines from having</span>
03467     <span class="comment">// to lock it.</span>
03468     <span class="comment">//</span>
03469 
03470     <span class="keywordflow">if</span> ( !SubjectContextLocked ) {
03471         <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( SubjectSecurityContext );
03472     }
03473 
03474     <span class="comment">//</span>
03475     <span class="comment">// If the user in the token is the owner of the object, we</span>
03476     <span class="comment">// must automatically grant ReadControl and WriteDac access</span>
03477     <span class="comment">// if desired.  If the DesiredAccess mask is empty after</span>
03478     <span class="comment">// these bits are turned off, we don't have to do any more</span>
03479     <span class="comment">// access checking (ref section 4, DSA ACL Arch)</span>
03480     <span class="comment">//</span>
03481 
03482     <span class="keywordflow">if</span> ( DesiredAccess &amp; (WRITE_DAC | READ_CONTROL | MAXIMUM_ALLOWED) ) {
03483 
03484         <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a54">SepTokenIsOwner</a>(
03485                  <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext ),
03486                  SecurityDescriptor,
03487                  TRUE
03488                  ) ) {
03489 
03490             <span class="keywordflow">if</span> ( DesiredAccess &amp; MAXIMUM_ALLOWED ) {
03491 
03492                 PreviouslyGrantedAccess |= (WRITE_DAC | READ_CONTROL);
03493 
03494             } <span class="keywordflow">else</span> {
03495 
03496                 PreviouslyGrantedAccess |= (DesiredAccess &amp; (WRITE_DAC | READ_CONTROL));
03497             }
03498 
03499             DesiredAccess &amp;= ~(WRITE_DAC | READ_CONTROL);
03500         }
03501     }
03502 
03503     <span class="keywordflow">if</span> (DesiredAccess == 0) {
03504 
03505         <span class="keywordflow">if</span> ( !SubjectContextLocked ) {
03506             <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( SubjectSecurityContext );
03507         }
03508 
03509         *GrantedAccess = PreviouslyGrantedAccess;
03510         *AccessStatus = STATUS_SUCCESS;
03511         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03512 
03513     } <span class="keywordflow">else</span> {
03514 
03515         <a class="code" href="../../d8/d3/tokenp_8h.html#a38">SepAccessCheck</a>(
03516                     SecurityDescriptor,
03517                     NULL,   <span class="comment">// No PrincipalSelfSid</span>
03518                     SubjectSecurityContext-&gt;PrimaryToken,
03519                     SubjectSecurityContext-&gt;ClientToken,
03520                     DesiredAccess,
03521                     NULL,   <span class="comment">// No object type list</span>
03522                     0,      <span class="comment">// No object type list</span>
03523                     GenericMapping,
03524                     PreviouslyGrantedAccess,
03525                     AccessMode,
03526                     GrantedAccess,
03527                     Privileges,
03528                     AccessStatus,
03529                     FALSE,   <span class="comment">// Don't return a list</span>
03530                     &amp;Success,
03531                     NULL
03532                     );
03533 <span class="preprocessor">#if DBG</span>
03534 <span class="preprocessor"></span>          <span class="keywordflow">if</span> (!Success &amp;&amp; SepShowAccessFail) {
03535               <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SE: Access check failed, DesiredAccess = 0x%x\n"</span>,
03536                 DesiredAccess);
03537               SepDumpSD = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03538               <a class="code" href="../../d6/d6/sep_8h.html#a57">SepDumpSecurityDescriptor</a>(
03539                   SecurityDescriptor,
03540                   <span class="stringliteral">"Input to SeAccessCheck\n"</span>
03541                   );
03542               SepDumpSD = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03543               SepDumpToken = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03544               <a class="code" href="../../d6/d6/sep_8h.html#a59">SepDumpTokenInfo</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext ) );
03545               SepDumpToken = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03546           }
03547 <span class="preprocessor">#endif</span>
03548 <span class="preprocessor"></span>
03549         <span class="comment">//</span>
03550         <span class="comment">// If we locked it in this routine, unlock it before we</span>
03551         <span class="comment">// leave.</span>
03552         <span class="comment">//</span>
03553 
03554         <span class="keywordflow">if</span> ( !SubjectContextLocked ) {
03555             <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( SubjectSecurityContext );
03556         }
03557 
03558         <span class="keywordflow">return</span>( Success );
03559     }
03560 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="accessck.c::SeAccessCheckByType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeAccessCheckByType           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrincipalSelfSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_TYPE_LIST ObjectTypeList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPRIVILEGE_SET&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeSet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeSetLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnResultList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">2704</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00242">IsValidElementCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00102">_SECURITY_SUBJECT_CONTEXT::PrimaryToken</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01339">ProbeAndReadUlong</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00144">SeCaptureObjectTypeList()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00053">SeCaptureSecurityDescriptor()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01141">SeCaptureSid()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d0/d5/se_8h.html#a21">SECURITY_SUBJECT_CONTEXT</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00353">SeFreeCapturedObjectTypeList()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03294">SeFreePrivileges()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l01564">SepAccessCheck()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00147">SepPrivilegeSetSize</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03652">SePrivilegePolicyCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03796">SepTokenIsOwner()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00631">SeReleaseSecurityDescriptor()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01320">SeReleaseSid()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l02413">NtAccessCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l02501">NtAccessCheckByType()</a>, and <a class="el" href="../../d1/d3/accessck_8c-source.html#l02602">NtAccessCheckByTypeResultList()</a>.
<p>
<pre class="fragment"><div>02722                    :
02723 
02724     See module <span class="keyword">abstract</span>.
02725 
02726 Arguments:
02727 
02728     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor protecting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
02729         being accessed
02730 
02731     PrincipalSelfSid - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being access checked <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an object which
02732         represents a principal (e.g., a user object), <span class="keyword">this</span> parameter should
02733         be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  Any ACE containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> constant
02734         PRINCIPAL_SELF_SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> replaced by <span class="keyword">this</span> SID.
02735 
02736         The parameter should be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object does not represent a principal.
02737 
02738     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's token.
02739 
02740     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access mask.
02741 
02742     ObjectTypeList - Supplies a list of GUIDs representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object (and
02743         sub-objects) being accessed.  If no list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present, AccessCheckByType
02744         behaves identically to AccessCheck.
02745 
02746     ObjectTypeListLength - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of elements in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ObjectTypeList.
02747 
02748     GenericMapping - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping associated with <span class="keyword">this</span>
02749         object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
02750 
02751     PrivilegeSet - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a buffer that upon <span class="keywordflow">return</span> will contain
02752         any privileges that were used to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access validation.
02753         If no privileges were used, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer will contain a privilege
02754         set consisting of zero privileges.
02755 
02756     PrivilegeSetLength - The size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PrivilegeSet buffer in bytes.
02757 
02758     GrantedAccess - Returns an access mask describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granted access.
02759 
02760     AccessStatus - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value that may be returned indicating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02761          <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> why access was denied.  Routines should avoid hardcoding a
02762          <span class="keywordflow">return</span> value of STATUS_ACCESS_DENIED so that a different value can
02763          be returned when mandatory access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> implemented.
02764 
02765     ReturnResultList - If <span class="keyword">true</span>, GrantedAccess and AccessStatus are actually
02766         arrays of entries ObjectTypeListLength elements <span class="keywordtype">long</span>.
02767 
02768 Return Value:
02769 
02770     STATUS_SUCCESS - The attempt proceeded normally.  This does not
02771         mean access was granted, rather that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameters were
02772         correct.
02773 
02774     STATUS_GENERIC_NOT_MAPPED - The DesiredAccess mask contained
02775         an unmapped generic access.
02776 
02777     STATUS_BUFFER_TOO_SMALL - The passed buffer was not large enough
02778         to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information being returned.
02779 
02780     STATUS_NO_IMPERSONTAION_TOKEN - The passed <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> was not an impersonation
02781         token.
02782 
02783 --*/
02784 
02785 {
02786     ACCESS_MASK LocalGrantedAccess;
02787     PACCESS_MASK LocalGrantedAccessPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02788     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> LocalAccessStatus;
02789     PNTSTATUS LocalAccessStatusPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02790     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
02791     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02792     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02793     PSECURITY_DESCRIPTOR CapturedSecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02794     PSID CapturedPrincipalSelfSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02795     ACCESS_MASK PreviouslyGrantedAccess = 0;
02796     GENERIC_MAPPING LocalGenericMapping;
02797     <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalObjectTypeList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02798     PPRIVILEGE_SET Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02799     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectContext;
02800     ULONG LocalPrivilegeSetLength;
02801     ULONG ResultListIndex;
02802 
02803     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02804 
02805     PreviousMode = KeGetPreviousMode();
02806 
02807     <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
02808         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !ReturnResultList );
02809         *AccessStatus = STATUS_SUCCESS;
02810         *GrantedAccess = DesiredAccess;
02811         <span class="keywordflow">return</span>(STATUS_SUCCESS);
02812     }
02813 
02814     <span class="keywordflow">try</span> {
02815 
02816         <span class="keywordflow">if</span> ( ReturnResultList ) {
02817 
02818             <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
02819                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02820                 leave ;
02821             }
02822 
02823             <span class="keywordflow">if</span> ( !<a class="code" href="../../d6/d6/sep_8h.html#a11">IsValidElementCount</a>( ObjectTypeListLength, OBJECT_TYPE_LIST ) )
02824             {
02825                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER ;
02826 
02827                 leave ;
02828             }
02829 
02830             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
02831                 AccessStatus,
02832                 <span class="keyword">sizeof</span>(NTSTATUS) * ObjectTypeListLength,
02833                 <span class="keyword">sizeof</span>(ULONG)
02834                 );
02835 
02836             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
02837                 GrantedAccess,
02838                 <span class="keyword">sizeof</span>(ACCESS_MASK) * ObjectTypeListLength,
02839                 <span class="keyword">sizeof</span>(ULONG)
02840                 );
02841 
02842         } <span class="keywordflow">else</span> {
02843             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>((PULONG)AccessStatus);
02844             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>((PULONG)GrantedAccess);
02845         }
02846 
02847         LocalPrivilegeSetLength = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>( PrivilegeSetLength );
02848         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(
02849             PrivilegeSetLength
02850             );
02851 
02852         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
02853             PrivilegeSet,
02854             LocalPrivilegeSetLength,
02855             <span class="keyword">sizeof</span>(ULONG)
02856             );
02857 
02858         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
02859             GenericMapping,
02860             <span class="keyword">sizeof</span>(GENERIC_MAPPING),
02861             <span class="keyword">sizeof</span>(ULONG)
02862             );
02863 
02864         LocalGenericMapping = *GenericMapping;
02865 
02866     } except (EXCEPTION_EXECUTE_HANDLER) {
02867         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
02868     }
02869     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
02870         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02871     }
02872 
02873     <span class="keywordflow">if</span> (DesiredAccess &amp;
02874         ( GENERIC_READ | GENERIC_WRITE | GENERIC_EXECUTE | GENERIC_ALL )) {
02875 
02876 
02877         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_GENERIC_NOT_MAPPED;
02878         <span class="keywordflow">goto</span> Cleanup;
02879     }
02880 
02881     <span class="comment">//</span>
02882     <span class="comment">// Obtain a pointer to the passed token</span>
02883     <span class="comment">//</span>
02884 
02885     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02886                  ClientToken,                  <span class="comment">// Handle</span>
02887                  (ACCESS_MASK)TOKEN_QUERY,     <span class="comment">// DesiredAccess</span>
02888                  SepTokenObjectType,           <span class="comment">// ObjectType</span>
02889                  PreviousMode,                 <span class="comment">// AccessMode</span>
02890                  (PVOID *)&amp;Token,              <span class="comment">// Object</span>
02891                  0                             <span class="comment">// GrantedAccess</span>
02892                  );
02893 
02894     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02895         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02896         <span class="keywordflow">goto</span> Cleanup;
02897     }
02898 
02899     <span class="comment">//</span>
02900     <span class="comment">// It must be an impersonation token, and at impersonation</span>
02901     <span class="comment">// level of Identification or above.</span>
02902     <span class="comment">//</span>
02903 
02904     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType != TokenImpersonation) {
02905         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_IMPERSONATION_TOKEN;
02906         <span class="keywordflow">goto</span> Cleanup;
02907     }
02908 
02909     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel &lt; SecurityIdentification ) {
02910         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BAD_IMPERSONATION_LEVEL;
02911         <span class="keywordflow">goto</span> Cleanup;
02912     }
02913 
02914     <span class="comment">//</span>
02915     <span class="comment">// Capture any Object type list</span>
02916     <span class="comment">//</span>
02917 
02918     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a21">SeCaptureObjectTypeList</a>( ObjectTypeList,
02919                                       ObjectTypeListLength,
02920                                       PreviousMode,
02921                                       &amp;LocalObjectTypeList );
02922 
02923     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02924         <span class="keywordflow">goto</span> Cleanup;
02925     }
02926 
02927     <span class="comment">//</span>
02928     <span class="comment">// Compare the DesiredAccess with the privileges in the</span>
02929     <span class="comment">// passed token, and see if we can either satisfy the requested</span>
02930     <span class="comment">// access with a privilege, or bomb out immediately because</span>
02931     <span class="comment">// we don't have a privilege we need.</span>
02932     <span class="comment">//</span>
02933 
02934     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/accessck_8c.html#a20">SePrivilegePolicyCheck</a>(
02935                  &amp;DesiredAccess,
02936                  &amp;PreviouslyGrantedAccess,
02937                  NULL,
02938                  (PACCESS_TOKEN)Token,
02939                  &amp;Privileges,
02940                  PreviousMode
02941                  );
02942 
02943     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02944 
02945         <span class="keywordflow">try</span> {
02946 
02947             <span class="keywordflow">if</span> ( ReturnResultList ) {
02948                 <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
02949                     AccessStatus[ResultListIndex] = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02950                     GrantedAccess[ResultListIndex] = 0;
02951                 }
02952 
02953             } <span class="keywordflow">else</span> {
02954                 *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02955                 *GrantedAccess = 0;
02956             }
02957 
02958             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02959 
02960         } except(EXCEPTION_EXECUTE_HANDLER) {
02961 
02962             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
02963         }
02964 
02965         <span class="keywordflow">goto</span> Cleanup;
02966     }
02967 
02968     <span class="comment">//</span>
02969     <span class="comment">// Make sure the passed privileges buffer is large enough for</span>
02970     <span class="comment">// whatever we have to put into it.</span>
02971     <span class="comment">//</span>
02972 
02973     <span class="keywordflow">if</span> (Privileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02974 
02975         <span class="keywordflow">if</span> ( ((ULONG)<a class="code" href="../../d6/d6/sep_8h.html#a6">SepPrivilegeSetSize</a>( Privileges )) &gt; LocalPrivilegeSetLength ) {
02976 
02977             <span class="keywordflow">try</span> {
02978 
02979                 *PrivilegeSetLength = <a class="code" href="../../d6/d6/sep_8h.html#a6">SepPrivilegeSetSize</a>( Privileges );
02980                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
02981 
02982             } except ( EXCEPTION_EXECUTE_HANDLER ) {
02983 
02984                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
02985             }
02986 
02987             <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( Privileges );
02988 
02989             <span class="keywordflow">goto</span> Cleanup;
02990 
02991         } <span class="keywordflow">else</span> {
02992 
02993             <span class="keywordflow">try</span> {
02994 
02995                 RtlCopyMemory(
02996                     PrivilegeSet,
02997                     Privileges,
02998                     <a class="code" href="../../d6/d6/sep_8h.html#a6">SepPrivilegeSetSize</a>( Privileges )
02999                     );
03000 
03001             } except ( EXCEPTION_EXECUTE_HANDLER ) {
03002 
03003                 <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( Privileges );
03004                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03005                 <span class="keywordflow">goto</span> Cleanup;
03006             }
03007 
03008         }
03009         <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( Privileges );
03010 
03011     } <span class="keywordflow">else</span> {
03012 
03013         <span class="comment">//</span>
03014         <span class="comment">// No privileges were used, construct an empty privilege set</span>
03015         <span class="comment">//</span>
03016 
03017         <span class="keywordflow">if</span> ( LocalPrivilegeSetLength &lt; <span class="keyword">sizeof</span>(PRIVILEGE_SET) ) {
03018 
03019             <span class="keywordflow">try</span> {
03020 
03021                 *PrivilegeSetLength = <span class="keyword">sizeof</span>(PRIVILEGE_SET);
03022                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
03023 
03024             } except ( EXCEPTION_EXECUTE_HANDLER ) {
03025 
03026                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03027             }
03028 
03029             <span class="keywordflow">goto</span> Cleanup;
03030         }
03031 
03032         <span class="keywordflow">try</span> {
03033 
03034             PrivilegeSet-&gt;PrivilegeCount = 0;
03035             PrivilegeSet-&gt;Control = 0;
03036 
03037         } except ( EXCEPTION_EXECUTE_HANDLER ) {
03038 
03039             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03040             <span class="keywordflow">goto</span> Cleanup;
03041 
03042         }
03043 
03044     }
03045 
03046     <span class="comment">//</span>
03047     <span class="comment">// Capture the PrincipalSelfSid.</span>
03048     <span class="comment">//</span>
03049 
03050     <span class="keywordflow">if</span> ( PrincipalSelfSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03051         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a8">SeCaptureSid</a>(
03052                      PrincipalSelfSid,
03053                      PreviousMode,
03054                      NULL, 0,
03055                      PagedPool,
03056                      TRUE,
03057                      &amp;CapturedPrincipalSelfSid );
03058 
03059         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03060             CapturedPrincipalSelfSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03061             <span class="keywordflow">goto</span> Cleanup;
03062         }
03063     }
03064 
03065 
03066     <span class="comment">//</span>
03067     <span class="comment">// Capture the passed security descriptor.</span>
03068     <span class="comment">//</span>
03069     <span class="comment">// SeCaptureSecurityDescriptor probes the input security descriptor,</span>
03070     <span class="comment">// so we don't have to</span>
03071     <span class="comment">//</span>
03072 
03073     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a1">SeCaptureSecurityDescriptor</a> (
03074                 SecurityDescriptor,
03075                 PreviousMode,
03076                 PagedPool,
03077                 FALSE,
03078                 &amp;CapturedSecurityDescriptor
03079                 );
03080 
03081     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03082         <span class="keywordflow">goto</span> Cleanup;
03083     }
03084 
03085 
03086     <span class="comment">//</span>
03087     <span class="comment">// If there's no security descriptor, then we've been</span>
03088     <span class="comment">// called without all the parameters we need.</span>
03089     <span class="comment">// Return invalid security descriptor.</span>
03090     <span class="comment">//</span>
03091 
03092     <span class="keywordflow">if</span> ( CapturedSecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03093         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_SECURITY_DESCR;
03094         <span class="keywordflow">goto</span> Cleanup;
03095     }
03096 
03097     <span class="comment">//</span>
03098     <span class="comment">// A valid security descriptor must have an owner and a group</span>
03099     <span class="comment">//</span>
03100 
03101     <span class="keywordflow">if</span> ( RtlpOwnerAddrSecurityDescriptor(
03102                 (PISECURITY_DESCRIPTOR)CapturedSecurityDescriptor
03103                 ) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
03104          RtlpGroupAddrSecurityDescriptor(
03105                 (PISECURITY_DESCRIPTOR)CapturedSecurityDescriptor
03106                 ) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03107 
03108         <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> (
03109             CapturedSecurityDescriptor,
03110             PreviousMode,
03111             FALSE
03112             );
03113 
03114         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_SECURITY_DESCR;
03115         <span class="keywordflow">goto</span> Cleanup;
03116     }
03117 
03118 
03119     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>( &amp;SubjectContext );
03120 
03121     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
03122 
03123     <span class="comment">//</span>
03124     <span class="comment">// If the user in the token is the owner of the object, we</span>
03125     <span class="comment">// must automatically grant ReadControl and WriteDac access</span>
03126     <span class="comment">// if desired.  If the DesiredAccess mask is empty after</span>
03127     <span class="comment">// these bits are turned off, we don't have to do any more</span>
03128     <span class="comment">// access checking (ref section 4, DSA ACL Arch)</span>
03129     <span class="comment">//</span>
03130 
03131 
03132     <span class="keywordflow">if</span> ( DesiredAccess &amp; (WRITE_DAC | READ_CONTROL | MAXIMUM_ALLOWED) ) {
03133 
03134         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/sep_8h.html#a54">SepTokenIsOwner</a>( Token, CapturedSecurityDescriptor, TRUE )) {
03135 
03136             <span class="keywordflow">if</span> ( DesiredAccess &amp; MAXIMUM_ALLOWED ) {
03137 
03138                 PreviouslyGrantedAccess |= (WRITE_DAC | READ_CONTROL);
03139 
03140             } <span class="keywordflow">else</span> {
03141 
03142                 PreviouslyGrantedAccess |= (DesiredAccess &amp; (WRITE_DAC | READ_CONTROL));
03143             }
03144 
03145             DesiredAccess &amp;= ~(WRITE_DAC | READ_CONTROL);
03146         }
03147 
03148     }
03149 
03150     <span class="keywordflow">if</span> (DesiredAccess == 0) {
03151 
03152         <span class="keywordflow">try</span> {
03153 
03154 
03155             <span class="keywordflow">if</span> ( ReturnResultList ) {
03156                 <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
03157                     AccessStatus[ResultListIndex] = STATUS_SUCCESS;
03158                     GrantedAccess[ResultListIndex] = PreviouslyGrantedAccess;
03159                 }
03160 
03161             } <span class="keywordflow">else</span> {
03162                 *AccessStatus = STATUS_SUCCESS;
03163                 *GrantedAccess = PreviouslyGrantedAccess;
03164             }
03165             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03166 
03167         } except (EXCEPTION_EXECUTE_HANDLER) {
03168 
03169             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03170 
03171         }
03172 
03173         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
03174 
03175         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( &amp;SubjectContext );
03176 
03177         <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> (
03178             CapturedSecurityDescriptor,
03179             PreviousMode,
03180             FALSE
03181             );
03182 
03183         <span class="keywordflow">goto</span> Cleanup;
03184 
03185     }
03186 
03187 
03188     <span class="comment">//</span>
03189     <span class="comment">// Finally, handle the case where we actually have to check the DACL.</span>
03190     <span class="comment">//</span>
03191 
03192     <span class="keywordflow">if</span> ( ReturnResultList ) {
03193         LocalGrantedAccessPointer =
03194             <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, (<span class="keyword">sizeof</span>(ACCESS_MASK)+<span class="keyword">sizeof</span>(NTSTATUS)) * ObjectTypeListLength, 'aGeS' );
03195 
03196         <span class="keywordflow">if</span> (LocalGrantedAccessPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03197 
03198             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
03199 
03200             <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( &amp;SubjectContext );
03201 
03202             <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> (
03203                 CapturedSecurityDescriptor,
03204                 PreviousMode,
03205                 FALSE
03206                 );
03207 
03208             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
03209             <span class="keywordflow">goto</span> Cleanup;
03210         }
03211         LocalAccessStatusPointer = (PNTSTATUS)(LocalGrantedAccessPointer + ObjectTypeListLength);
03212     } <span class="keywordflow">else</span> {
03213         LocalGrantedAccessPointer = &amp;LocalGrantedAccess;
03214         LocalAccessStatusPointer =  &amp;LocalAccessStatus;
03215     }
03216 
03217     <a class="code" href="../../d8/d3/tokenp_8h.html#a38">SepAccessCheck</a> (
03218         CapturedSecurityDescriptor,
03219         CapturedPrincipalSelfSid,
03220         SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
03221         Token,
03222         DesiredAccess,
03223         LocalObjectTypeList,
03224         ObjectTypeListLength,
03225         &amp;LocalGenericMapping,
03226         PreviouslyGrantedAccess,
03227         PreviousMode,
03228         LocalGrantedAccessPointer,
03229         NULL,
03230         LocalAccessStatusPointer,
03231         ReturnResultList,
03232         NULL,
03233         NULL );
03234 
03235     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
03236 
03237     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( &amp;SubjectContext );
03238 
03239     <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> (
03240         CapturedSecurityDescriptor,
03241         PreviousMode,
03242         FALSE
03243         );
03244 
03245     <span class="keywordflow">try</span> {
03246 
03247         <span class="keywordflow">if</span> ( ReturnResultList ) {
03248             <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
03249                 AccessStatus[ResultListIndex] = LocalAccessStatusPointer[ResultListIndex];
03250                 GrantedAccess[ResultListIndex] = LocalGrantedAccessPointer[ResultListIndex];
03251             }
03252 
03253         } <span class="keywordflow">else</span> {
03254             *AccessStatus = *LocalAccessStatusPointer;
03255             *GrantedAccess = *LocalGrantedAccessPointer;
03256         }
03257 
03258         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03259 
03260     } except (EXCEPTION_EXECUTE_HANDLER) {
03261         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03262     }
03263 
03264     <span class="keywordflow">if</span> ( ReturnResultList ) {
03265         <span class="keywordflow">if</span> ( LocalGrantedAccessPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03266             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( LocalGrantedAccessPointer );
03267         }
03268     }
03269 
03270 
03271     <span class="comment">//</span>
03272     <span class="comment">// Free locally used resources.</span>
03273     <span class="comment">//</span>
03274 Cleanup:
03275 
03276     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03277         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
03278     }
03279 
03280     <span class="keywordflow">if</span> ( LocalObjectTypeList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03281         <a class="code" href="../../d8/d3/tokenp_8h.html#a22">SeFreeCapturedObjectTypeList</a>( LocalObjectTypeList );
03282     }
03283 
03284     <span class="keywordflow">if</span> (CapturedPrincipalSelfSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03285         <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedPrincipalSelfSid, PreviousMode, TRUE);
03286     }
03287 
03288     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03289 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="accessck.c::SeCaptureObjectTypeList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeCaptureObjectTypeList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_TYPE_LIST ObjectTypeList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedObjectTypeList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l00144">144</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00382">_IOBJECT_TYPE_LIST::CurrentDenied</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00381">_IOBJECT_TYPE_LIST::CurrentGranted</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00375">_IOBJECT_TYPE_LIST::Flags</a>, <a class="el" href="../../d8/d3/tokenp_8h.html#a16">IOBJECT_TYPE_LIST</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00242">IsValidElementCount</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00374">_IOBJECT_TYPE_LIST::Level</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00378">_IOBJECT_TYPE_LIST::ObjectType</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00379">_IOBJECT_TYPE_LIST::ParentIndex</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00380">_IOBJECT_TYPE_LIST::Remaining</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>.
<p>
<pre class="fragment"><div>00152                    :
00153 
00154     This routine probes and captures a copy of any object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list
00155     that might have been provided via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ObjectTypeList argument.
00156 
00157     The object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> converted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> internal form that explicitly
00158     specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hierarchical relationship between <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entries.
00159 
00160     The object typs list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> validated to ensure a valid hierarchical
00161     relationship <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> represented.
00162 
00163 Arguments:
00164 
00165     ObjectTypeList - The object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list from which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list
00166         information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be retrieved.
00167 
00168     ObjectTypeListLength - Number of elements in ObjectTypeList
00169 
00170     RequestorMode - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode by which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access
00171         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being requested.
00172 
00173     CapturedObjectTypeList - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> captured <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list which
00174         must be freed <span class="keyword">using</span> <a class="code" href="../../d8/d3/tokenp_8h.html#a22">SeFreeCapturedObjectTypeList</a>().
00175 
00176 Return Value:
00177 
00178     STATUS_SUCCESS indicates no exceptions were encountered.
00179 
00180     Any access violations encountered will be returned.
00181 
00182 --*/
00183 
00184 {
00185     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00186     ULONG i;
00187     <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalTypeList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00188 
00189     ULONG Levels[ACCESS_MAX_LEVEL+1];
00190 
00191     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">//  Set default return</span>
00195     <span class="comment">//</span>
00196 
00197     *CapturedObjectTypeList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00198 
00199     <span class="keywordflow">if</span> (RequestorMode != <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00200         <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00201     }
00202 
00203     <span class="keywordflow">try</span> {
00204 
00205         <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
00206 
00207             <span class="comment">// Drop through</span>
00208 
00209         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT(ObjectTypeList) ) {
00210 
00211             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00212 
00213         } <span class="keywordflow">else</span> {
00214 
00215             <span class="keywordflow">if</span> ( !<a class="code" href="../../d6/d6/sep_8h.html#a11">IsValidElementCount</a>( ObjectTypeListLength, <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">IOBJECT_TYPE_LIST</a> ) )
00216             {
00217                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER ;
00218 
00219                 <span class="comment">//</span>
00220                 <span class="comment">// No more to do, get out of the try statement:</span>
00221                 <span class="comment">//</span>
00222 
00223                 leave ;
00224             }
00225 
00226             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( ObjectTypeList,
00227                           <span class="keyword">sizeof</span>(OBJECT_TYPE_LIST) * ObjectTypeListLength,
00228                           <span class="keyword">sizeof</span>(ULONG)
00229                           );
00230 
00231             <span class="comment">//</span>
00232             <span class="comment">// Allocate a buffer to copy into.</span>
00233             <span class="comment">//</span>
00234 
00235             LocalTypeList = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">IOBJECT_TYPE_LIST</a>) * ObjectTypeListLength, 'tOeS' );
00236 
00237             <span class="keywordflow">if</span> ( LocalTypeList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00238                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00239 
00240             <span class="comment">//</span>
00241             <span class="comment">// Copy the callers structure to the local structure.</span>
00242             <span class="comment">//</span>
00243 
00244             } <span class="keywordflow">else</span> {
00245                 GUID * CapturedObjectType;
00246                 <span class="keywordflow">for</span> ( i=0; i&lt;ObjectTypeListLength; i++ ) {
00247                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> CurrentLevel;
00248 
00249                     <span class="comment">//</span>
00250                     <span class="comment">// Limit ourselves</span>
00251                     <span class="comment">//</span>
00252                     CurrentLevel = ObjectTypeList[i].Level;
00253                     <span class="keywordflow">if</span> ( CurrentLevel &gt; ACCESS_MAX_LEVEL ) {
00254                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00255                         <span class="keywordflow">break</span>;
00256                     }
00257 
00258                     <span class="comment">//</span>
00259                     <span class="comment">// Copy data the caller passed in</span>
00260                     <span class="comment">//</span>
00261                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o0">Level</a> = CurrentLevel;
00262                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o1">Flags</a> = 0;
00263                     CapturedObjectType = ObjectTypeList[i].ObjectType;
00264                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00265                         CapturedObjectType,
00266                         <span class="keyword">sizeof</span>(GUID),
00267                         <span class="keyword">sizeof</span>(ULONG)
00268                         );
00269                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o2">ObjectType</a> = *CapturedObjectType;
00270                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> = 0;
00271                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o5">CurrentGranted</a> = 0;
00272                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o6">CurrentDenied</a> = 0;
00273 
00274                     <span class="comment">//</span>
00275                     <span class="comment">// Ensure that the level number is consistent with the</span>
00276                     <span class="comment">//  level number of the previous entry.</span>
00277                     <span class="comment">//</span>
00278 
00279                     <span class="keywordflow">if</span> ( i == 0 ) {
00280                         <span class="keywordflow">if</span> ( CurrentLevel != 0 ) {
00281                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00282                             <span class="keywordflow">break</span>;
00283                         }
00284 
00285                     } <span class="keywordflow">else</span> {
00286 
00287                         <span class="comment">//</span>
00288                         <span class="comment">// The previous entry is either:</span>
00289                         <span class="comment">//  my immediate parent,</span>
00290                         <span class="comment">//  my sibling, or</span>
00291                         <span class="comment">//  the child (or grandchild, etc.) of my sibling.</span>
00292                         <span class="comment">//</span>
00293                         <span class="keywordflow">if</span> ( CurrentLevel &gt; LocalTypeList[i-1].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o0">Level</a> + 1 ) {
00294                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00295                             <span class="keywordflow">break</span>;
00296                         }
00297 
00298                         <span class="comment">//</span>
00299                         <span class="comment">// Don't support two roots.</span>
00300                         <span class="comment">//</span>
00301                         <span class="keywordflow">if</span> ( CurrentLevel == 0 ) {
00302                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00303                             <span class="keywordflow">break</span>;
00304                         }
00305 
00306                     }
00307 
00308                     <span class="comment">//</span>
00309                     <span class="comment">// If the above rules are maintained,</span>
00310                     <span class="comment">//  then my parent object is the last object seen that</span>
00311                     <span class="comment">//  has a level one less than mine.</span>
00312                     <span class="comment">//</span>
00313 
00314                     <span class="keywordflow">if</span> ( CurrentLevel == 0 ) {
00315                         LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o3">ParentIndex</a> = -1;
00316                     } <span class="keywordflow">else</span> {
00317                         LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o3">ParentIndex</a> = Levels[CurrentLevel-1];
00318                     }
00319 
00320                     <span class="comment">//</span>
00321                     <span class="comment">// Save this obect as the last object seen at this level.</span>
00322                     <span class="comment">//</span>
00323 
00324                     Levels[CurrentLevel] = i;
00325 
00326                 }
00327 
00328             }
00329 
00330         } <span class="comment">// end_if</span>
00331 
00332     } except(EXCEPTION_EXECUTE_HANDLER) {
00333 
00334 
00335         <span class="comment">//</span>
00336         <span class="comment">// If we captured any proxy data, we need to free it now.</span>
00337         <span class="comment">//</span>
00338 
00339         <span class="keywordflow">if</span> ( LocalTypeList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00340             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( LocalTypeList );
00341             LocalTypeList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00342         }
00343 
00344         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00345     } <span class="comment">// end_try</span>
00346 
00347     *CapturedObjectTypeList = LocalTypeList;
00348     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00349 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="accessck.c::SeFastTraverseCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SeFastTraverseCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>TraverseAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l03871">3871</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01609">SeWorldSid</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00778">ObpCheckTraverseAccess()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l01121">ObpProcessDosDeviceSymbolicLink()</a>, and <a class="el" href="../../d0/d1/obse_8c-source.html#l01748">ObSetSecurityDescriptorInfo()</a>.
<p>
<pre class="fragment"><div>03878                    :
03879 
03880     This routine will examine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DACL of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed Security Descriptor
03881     to see <span class="keywordflow">if</span> WORLD has Traverse access.  If so, no further access checking
03882     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary.
03883 
03884     Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SubjectContext <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client process does not have
03885     to be locked to make <span class="keyword">this</span> call, since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not examine any data
03886     structures in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>.
03887 
03888 Arguments:
03889 
03890     SecurityDescriptor - The Security Descriptor protecting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> container
03891         object being traversed.
03892 
03893     TraverseAccess - Access mask describing Traverse access <span class="keywordflow">for</span> <span class="keyword">this</span>
03894         object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
03895 
03896     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mode to be used in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
03897 
03898 
03899 Return Value:
03900 
03901     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - WORLD has Traverse access to <span class="keyword">this</span> container.  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03902     otherwise.
03903 
03904 --*/
03905 
03906 {
03907     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
03908     ULONG i;
03909     PVOID Ace;
03910     ULONG AceCount;
03911 
03912     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03913 
03914     <span class="keywordflow">if</span> ( AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
03915         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03916     }
03917 
03918     <span class="keywordflow">if</span> (SecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03919         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03920     }
03921 
03922     <span class="comment">//</span>
03923     <span class="comment">// See if there is a valid DACL in the passed Security Descriptor.</span>
03924     <span class="comment">// No DACL, no security, all is granted.</span>
03925     <span class="comment">//</span>
03926 
03927     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = RtlpDaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)SecurityDescriptor );
03928 
03929     <span class="comment">//</span>
03930     <span class="comment">//  If the SE_DACL_PRESENT bit is not set, the object has no</span>
03931     <span class="comment">//  security, so all accesses are granted.</span>
03932     <span class="comment">//</span>
03933     <span class="comment">//  Also grant all access if the Dacl is NULL.</span>
03934     <span class="comment">//</span>
03935 
03936     <span class="keywordflow">if</span> ( !RtlpAreControlBitsSet(
03937             (PISECURITY_DESCRIPTOR)SecurityDescriptor, SE_DACL_PRESENT
03938             )
03939          || (<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03940 
03941         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03942     }
03943 
03944     <span class="comment">//</span>
03945     <span class="comment">// There is security on this object.  If the DACL is empty,</span>
03946     <span class="comment">// deny all access immediately</span>
03947     <span class="comment">//</span>
03948 
03949     <span class="keywordflow">if</span> ((AceCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AceCount) == 0) {
03950 
03951         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03952     }
03953 
03954     <span class="comment">//</span>
03955     <span class="comment">// There's stuff in the DACL, walk down the list and see</span>
03956     <span class="comment">// if WORLD has been granted TraverseAccess</span>
03957     <span class="comment">//</span>
03958 
03959     <span class="keywordflow">for</span> ( i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Dacl ) ;
03960           i &lt; AceCount  ;
03961           i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace )
03962         ) {
03963 
03964         <span class="keywordflow">if</span> ( !(((PACE_HEADER)Ace)-&gt;AceFlags &amp; INHERIT_ONLY_ACE)) {
03965 
03966             <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_ACE_TYPE) ) {
03967 
03968                 <span class="keywordflow">if</span> ( (TraverseAccess &amp; ((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask) ) {
03969 
03970                     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SeWorldSid, &amp;((PACCESS_ALLOWED_ACE)Ace)-&gt;SidStart ) ) {
03971 
03972                         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03973                     }
03974                 }
03975 
03976             } <span class="keywordflow">else</span> {
03977 
03978                 <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_ACE_TYPE) ) {
03979 
03980                     <span class="keywordflow">if</span> ( (TraverseAccess &amp; ((PACCESS_DENIED_ACE)Ace)-&gt;Mask) ) {
03981 
03982                         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SeWorldSid, &amp;((PACCESS_DENIED_ACE)Ace)-&gt;SidStart ) ) {
03983 
03984                             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03985                         }
03986                     }
03987                 }
03988             }
03989         }
03990     }
03991 
03992     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03993 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="accessck.c::SeFreeCapturedObjectTypeList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeFreeCapturedObjectTypeList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ObjectTypeList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l00353">353</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>.
<p>
<pre class="fragment"><div>00359                    :
00360 
00361     This routine frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data associated with a captured ObjectTypeList
00362     structure.
00363 
00364 Arguments:
00365 
00366     ObjectTypeList - Points to a captured object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list structure.
00367 
00368 Return Value:
00369 
00370     None.
00371 
00372 --*/
00373 
00374 {
00375     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00376 
00377     <span class="keywordflow">if</span> ( ObjectTypeList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00378         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectTypeList );
00379     }
00380 
00381     <span class="keywordflow">return</span>;
00382 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="accessck.c::SeFreePrivileges" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeFreePrivileges           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PPRIVILEGE_SET&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Privileges</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l03294">3294</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00983">ObCheckCreateObjectAccess()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00392">ObCheckObjectAccess()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00778">ObpCheckTraverseAccess()</a>, and <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>.
<p>
<pre class="fragment"><div>03300                    :
03301 
03302     This routine frees a privilege set returned by <a class="code" href="../../d0/d5/se_8h.html#a135">SeAccessCheck</a>.
03303 
03304 Arguments:
03305 
03306     Privileges - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilege set to be freed.
03307 
03308 Return Value:
03309 
03310     None.
03311 
03312 --*/
03313 
03314 {
03315     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03316 
03317     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Privileges );
03318 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="accessck.c::SepAccessCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAccessCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrincipalSelfSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviouslyGrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPRIVILEGE_SET *Privileges&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnResultList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnSomeAccessGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnSomeAccessDenied</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l01564">1564</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00381">_IOBJECT_TYPE_LIST::CurrentGranted</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00126">PrimaryToken</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00380">_IOBJECT_TYPE_LIST::Remaining</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00650">SeAssertMappedCanonicalAccess</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00574">SepAddAccessTypeList()</a>, <a class="el" href="../../d9/d4/seglobal_8c-source.html#l01071">SepAssemblePrivileges()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00650">SepDumpSecurityDescriptor()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00995">SepDumpTokenInfo()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00992">SepMaximumAccessCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l01304">SepNormalAccessCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00388">SepObjectInTypeList()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00733">SepSidInToken()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00143">SepSinglePrivilegeCheck()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01676">SeSecurityPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01677">SeTakeOwnershipPrivilege</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00181">SeTokenIsRestricted()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>.
<p>
<pre class="fragment"><div>01585                    :
01586 
01587     Worker routine <span class="keywordflow">for</span> <a class="code" href="../../d0/d5/se_8h.html#a135">SeAccessCheck</a> and <a class="code" href="../../d0/d4/accessck_8c.html#a14">NtAccessCheck</a>.  We actually <span class="keywordflow">do</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01588     access checking here.
01589 
01590     Whether or not we actually evaluate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following
01591     interaction between <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SE_DACL_PRESENT bit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
01592     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DACL pointer itself.
01593 
01594 
01595                           SE_DACL_PRESENT
01596 
01597                         <a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>          CLEAR
01598 
01599                    +-------------+-------------+
01600                    |             |             |
01601              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  |    GRANT    |    GRANT    |
01602                    |     <a class="code" href="../../d0/d2/usrbench_8h.html#a13">ALL</a>     |     <a class="code" href="../../d0/d2/usrbench_8h.html#a13">ALL</a>     |
01603      DACL          |             |             |
01604      Pointer       +-------------+-------------+
01605                    |             |             |
01606             !<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  |  EVALUATE   |    GRANT    |
01607                    |    ACL      |     <a class="code" href="../../d0/d2/usrbench_8h.html#a13">ALL</a>     |
01608                    |             |             |
01609                    +-------------+-------------+
01610 
01611 Arguments:
01612 
01613     SecurityDescriptor - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
01614         being accessed.
01615 
01616     PrincipalSelfSid - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being access checked <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an object which
01617         represents a principal (e.g., a user object), <span class="keyword">this</span> parameter should
01618         be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  Any ACE containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> constant
01619         PRINCIPAL_SELF_SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> replaced by <span class="keyword">this</span> SID.
01620 
01621         The parameter should be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object does not represent a principal.
01622 
01623     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to user's token object.
01624 
01625     TokenLocked - <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> describing whether or not there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a read lock
01626         on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
01627 
01628     DesiredAccess - Access mask describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's desired access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01629         object.  This mask <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed not to contain generic access types.
01630 
01631     ObjectTypeList - Supplies a list of GUIDs representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object (and
01632         sub-objects) being accessed.  If no list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present, AccessCheckByType
01633         behaves identically to AccessCheck.
01634 
01635     ObjectTypeListLength - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of elements in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ObjectTypeList.
01636 
01637     GenericMapping - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping associated
01638         with <span class="keyword">this</span> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
01639 
01640     PreviouslyGrantedAccess - Access mask indicating any access' that have
01641         already been granted by higher level <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>
01642 
01643     PrivilgedAccessMask - Mask describing access types that may not be
01644         granted without a privilege.
01645 
01646     GrantedAccess - Returns an access mask describing all granted access',
01647         or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
01648 
01649     Privileges - Optionally supplies a pointer in which will be returned
01650         any privileges that were used <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> null,
01651         <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will be assumed that privilege checks have been done already.
01652 
01653     AccessStatus - Returns STATUS_SUCCESS or other error code to be
01654         propogated back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
01655 
01656     ReturnResultList - If <span class="keyword">true</span>, GrantedAccess and AccessStatus <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> actually
01657         an array of entries ObjectTypeListLength elements <span class="keywordtype">long</span>.
01658 
01659     ReturnSomeAccessGranted - Returns a value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to indicate that some access'
01660         were granted, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01661 
01662     ReturnSomeAccessDenied - Returns a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> some of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
01663         access was not granted.  This will alway be an inverse of SomeAccessGranted
01664         unless ReturnResultList <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.  In that <span class="keywordflow">case</span>,
01665 
01666 Return Value:
01667 
01668     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates that some access' were granted, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01669     otherwise.
01670 
01671 --*/
01672 {
01673     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01674     ACCESS_MASK Remaining;
01675 
01676 
01677     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
01678 
01679     PVOID Ace;
01680     ULONG AceCount;
01681 
01682     ULONG i;
01683     ULONG j;
01684     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01685     ULONG PrivilegeCount = 0;
01686     BOOLEAN Success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01687     BOOLEAN SystemSecurity = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01688     BOOLEAN WriteOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01689     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> EToken;
01690 
01691     <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">IOBJECT_TYPE_LIST</a> FixedTypeList;
01692     <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalTypeList;
01693     ULONG LocalTypeListLength;
01694     ULONG ResultListIndex;
01695 
01696     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01697 
01698 <span class="preprocessor">#if DBG</span>
01699 <span class="preprocessor"></span>
01700     <a class="code" href="../../d6/d6/sep_8h.html#a57">SepDumpSecurityDescriptor</a>(
01701         SecurityDescriptor,
01702         <span class="stringliteral">"Input to SeAccessCheck\n"</span>
01703         );
01704 
01705     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientToken )) {
01706         <a class="code" href="../../d6/d6/sep_8h.html#a59">SepDumpTokenInfo</a>( ClientToken );
01707     }
01708 
01709     <a class="code" href="../../d6/d6/sep_8h.html#a59">SepDumpTokenInfo</a>( PrimaryToken );
01710 
01711 <span class="preprocessor">#endif</span>
01712 <span class="preprocessor"></span>
01713 
01714     EToken = ARGUMENT_PRESENT( ClientToken ) ? <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> : <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>;
01715 
01716     <span class="comment">//</span>
01717     <span class="comment">// Assert that there are no generic accesses in the DesiredAccess</span>
01718     <span class="comment">//</span>
01719 
01720     <a class="code" href="../../d0/d5/se_8h.html#a14">SeAssertMappedCanonicalAccess</a>( DesiredAccess );
01721 
01722     Remaining = DesiredAccess;
01723 
01724 
01725     <span class="comment">//</span>
01726     <span class="comment">// Check for ACCESS_SYSTEM_SECURITY here,</span>
01727     <span class="comment">// fail if he's asking for it and doesn't have</span>
01728     <span class="comment">// the privilege.</span>
01729     <span class="comment">//</span>
01730 
01731     <span class="keywordflow">if</span> ( Remaining &amp; ACCESS_SYSTEM_SECURITY ) {
01732 
01733         <span class="comment">//</span>
01734         <span class="comment">// Bugcheck if we weren't given a pointer to return privileges</span>
01735         <span class="comment">// into.  Our caller was supposed to have taken care of this</span>
01736         <span class="comment">// in that case.</span>
01737         <span class="comment">//</span>
01738 
01739         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ARGUMENT_PRESENT( Privileges ));
01740 
01741         Success = <a class="code" href="../../d6/d6/sep_8h.html#a49">SepSinglePrivilegeCheck</a> (
01742                     SeSecurityPrivilege,
01743                     EToken,
01744                     PreviousMode
01745                     );
01746 
01747         <span class="keywordflow">if</span> (!Success) {
01748             PreviouslyGrantedAccess = 0;
01749             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
01750             <span class="keywordflow">goto</span> ReturnOneStatus;
01751         }
01752 
01753         <span class="comment">//</span>
01754         <span class="comment">// Success, remove ACCESS_SYSTEM_SECURITY from remaining, add it</span>
01755         <span class="comment">// to PreviouslyGrantedAccess</span>
01756         <span class="comment">//</span>
01757 
01758         Remaining &amp;= ~ACCESS_SYSTEM_SECURITY;
01759         PreviouslyGrantedAccess |= ACCESS_SYSTEM_SECURITY;
01760 
01761         PrivilegeCount++;
01762         SystemSecurity = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01763 
01764         <span class="keywordflow">if</span> ( Remaining == 0 ) {
01765             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01766             <span class="keywordflow">goto</span> ReturnOneStatus;
01767         }
01768 
01769     }
01770 
01771 
01772     <span class="comment">//</span>
01773     <span class="comment">// Get pointer to client SID's</span>
01774     <span class="comment">//</span>
01775 
01776     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = RtlpDaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)SecurityDescriptor );
01777 
01778     <span class="comment">//</span>
01779     <span class="comment">//  If the SE_DACL_PRESENT bit is not set, the object has no</span>
01780     <span class="comment">//  security, so all accesses are granted.  If he's asking for</span>
01781     <span class="comment">//  MAXIMUM_ALLOWED, return the GENERIC_ALL field from the generic</span>
01782     <span class="comment">//  mapping.</span>
01783     <span class="comment">//</span>
01784     <span class="comment">//  Also grant all access if the Dacl is NULL.</span>
01785     <span class="comment">//</span>
01786 
01787     <span class="keywordflow">if</span> ( !RtlpAreControlBitsSet(
01788              (PISECURITY_DESCRIPTOR)SecurityDescriptor,
01789              SE_DACL_PRESENT) || (<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01790 
01791 
01792         <span class="comment">//</span>
01793         <span class="comment">// Restricted tokens treat a NULL dacl the same as a DACL with no</span>
01794         <span class="comment">// ACEs.</span>
01795         <span class="comment">//</span>
01796 <span class="preprocessor">#ifdef SECURE_NULL_DACLS</span>
01797 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/token_8c.html#a5">SeTokenIsRestricted</a>( EToken )) {
01798             <span class="comment">//</span>
01799             <span class="comment">// We know that Remaining != 0 here, because we</span>
01800             <span class="comment">// know it was non-zero coming into this routine,</span>
01801             <span class="comment">// and we've checked it against 0 every time we've</span>
01802             <span class="comment">// cleared a bit.</span>
01803             <span class="comment">//</span>
01804 
01805             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Remaining != 0 );
01806 
01807             <span class="comment">//</span>
01808             <span class="comment">// There are ungranted accesses.  Since there is</span>
01809             <span class="comment">// nothing in the DACL, they will not be granted.</span>
01810             <span class="comment">// If, however, the only ungranted access at this</span>
01811             <span class="comment">// point is MAXIMUM_ALLOWED, and something has been</span>
01812             <span class="comment">// granted in the PreviouslyGranted mask, return</span>
01813             <span class="comment">// what has been granted.</span>
01814             <span class="comment">//</span>
01815 
01816             <span class="keywordflow">if</span> ( (Remaining == MAXIMUM_ALLOWED) &amp;&amp; (PreviouslyGrantedAccess != (ACCESS_MASK)0) ) {
01817                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01818                 <span class="keywordflow">goto</span> ReturnOneStatus;
01819 
01820             } <span class="keywordflow">else</span> {
01821                 PreviouslyGrantedAccess = 0;
01822                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01823                 <span class="keywordflow">goto</span> ReturnOneStatus;
01824             }
01825         }
01826 <span class="preprocessor">#endif //SECURE_NULL_DACLS</span>
01827 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (DesiredAccess &amp; MAXIMUM_ALLOWED) {
01828 
01829             <span class="comment">//</span>
01830             <span class="comment">// Give him:</span>
01831             <span class="comment">//   GenericAll</span>
01832             <span class="comment">//   Anything else he asked for</span>
01833             <span class="comment">//</span>
01834 
01835             PreviouslyGrantedAccess =
01836                 GenericMapping-&gt;GenericAll |
01837                 (DesiredAccess | PreviouslyGrantedAccess) &amp; ~MAXIMUM_ALLOWED;
01838 
01839         } <span class="keywordflow">else</span> {
01840 
01841             PreviouslyGrantedAccess |= DesiredAccess;
01842         }
01843 
01844         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01845         <span class="keywordflow">goto</span> ReturnOneStatus;
01846     }
01847 
01848     <span class="comment">//</span>
01849     <span class="comment">// There is security on this object.  Check to see</span>
01850     <span class="comment">// if he's asking for WRITE_OWNER, and perform the</span>
01851     <span class="comment">// privilege check if so.</span>
01852     <span class="comment">//</span>
01853 
01854     <span class="keywordflow">if</span> ( (Remaining &amp; WRITE_OWNER) &amp;&amp; ARGUMENT_PRESENT( Privileges ) ) {
01855 
01856         Success = <a class="code" href="../../d6/d6/sep_8h.html#a49">SepSinglePrivilegeCheck</a> (
01857                     SeTakeOwnershipPrivilege,
01858                     EToken,
01859                     PreviousMode
01860                     );
01861 
01862         <span class="keywordflow">if</span> (Success) {
01863 
01864             <span class="comment">//</span>
01865             <span class="comment">// Success, remove WRITE_OWNER from remaining, add it</span>
01866             <span class="comment">// to PreviouslyGrantedAccess</span>
01867             <span class="comment">//</span>
01868 
01869             Remaining &amp;= ~WRITE_OWNER;
01870             PreviouslyGrantedAccess |= WRITE_OWNER;
01871 
01872             PrivilegeCount++;
01873             WriteOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01874 
01875             <span class="keywordflow">if</span> ( Remaining == 0 ) {
01876                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01877                 <span class="keywordflow">goto</span> ReturnOneStatus;
01878             }
01879         }
01880     }
01881 
01882 
01883     <span class="comment">//</span>
01884     <span class="comment">// If the DACL is empty,</span>
01885     <span class="comment">// deny all access immediately.</span>
01886     <span class="comment">//</span>
01887 
01888     <span class="keywordflow">if</span> ((AceCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AceCount) == 0) {
01889 
01890         <span class="comment">//</span>
01891         <span class="comment">// We know that Remaining != 0 here, because we</span>
01892         <span class="comment">// know it was non-zero coming into this routine,</span>
01893         <span class="comment">// and we've checked it against 0 every time we've</span>
01894         <span class="comment">// cleared a bit.</span>
01895         <span class="comment">//</span>
01896 
01897         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Remaining != 0 );
01898 
01899         <span class="comment">//</span>
01900         <span class="comment">// There are ungranted accesses.  Since there is</span>
01901         <span class="comment">// nothing in the DACL, they will not be granted.</span>
01902         <span class="comment">// If, however, the only ungranted access at this</span>
01903         <span class="comment">// point is MAXIMUM_ALLOWED, and something has been</span>
01904         <span class="comment">// granted in the PreviouslyGranted mask, return</span>
01905         <span class="comment">// what has been granted.</span>
01906         <span class="comment">//</span>
01907 
01908         <span class="keywordflow">if</span> ( (Remaining == MAXIMUM_ALLOWED) &amp;&amp; (PreviouslyGrantedAccess != (ACCESS_MASK)0) ) {
01909             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01910             <span class="keywordflow">goto</span> ReturnOneStatus;
01911 
01912         } <span class="keywordflow">else</span> {
01913             PreviouslyGrantedAccess = 0;
01914             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01915             <span class="keywordflow">goto</span> ReturnOneStatus;
01916         }
01917     }
01918 
01919     <span class="comment">//</span>
01920     <span class="comment">// Fake out a top level ObjectType list if none is passed by the caller.</span>
01921     <span class="comment">//</span>
01922 
01923     <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
01924         LocalTypeList = &amp;FixedTypeList;
01925         LocalTypeListLength = 1;
01926         RtlZeroMemory( &amp;FixedTypeList, <span class="keyword">sizeof</span>(FixedTypeList) );
01927         FixedTypeList.ParentIndex = -1;
01928     } <span class="keywordflow">else</span> {
01929         LocalTypeList = ObjectTypeList;
01930         LocalTypeListLength = ObjectTypeListLength;
01931     }
01932 
01933     <span class="comment">//</span>
01934     <span class="comment">// If the caller wants the MAXIMUM_ALLOWED or the caller wants the</span>
01935     <span class="comment">//  results on all objects and subobjects, use a slower algorithm</span>
01936     <span class="comment">//  that traverses all the ACEs.</span>
01937     <span class="comment">//</span>
01938 
01939     <span class="keywordflow">if</span> ( (DesiredAccess &amp; MAXIMUM_ALLOWED) != 0 ||
01940          ReturnResultList ) {
01941 
01942         <span class="comment">//</span>
01943         <span class="comment">// Do the normal maximum-allowed access check</span>
01944         <span class="comment">//</span>
01945 
01946         <a class="code" href="../../d0/d4/accessck_8c.html#a6">SepMaximumAccessCheck</a>(
01947             EToken,
01948             PrimaryToken,
01949             Dacl,
01950             PrincipalSelfSid,
01951             LocalTypeListLength,
01952             LocalTypeList,
01953             ObjectTypeListLength,
01954             FALSE
01955             );
01956 
01957         <span class="comment">//</span>
01958         <span class="comment">// If this is a restricted token, do the additional access check</span>
01959         <span class="comment">//</span>
01960 
01961         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/token_8c.html#a5">SeTokenIsRestricted</a>( EToken ) ) {
01962             <a class="code" href="../../d0/d4/accessck_8c.html#a6">SepMaximumAccessCheck</a>(
01963                 EToken,
01964                 PrimaryToken,
01965                 Dacl,
01966                 PrincipalSelfSid,
01967                 LocalTypeListLength,
01968                 LocalTypeList,
01969                 ObjectTypeListLength,
01970                 TRUE
01971                 );
01972         }
01973 
01974 
01975         <span class="comment">//</span>
01976         <span class="comment">// If the caller wants to know the individual results of each sub-object,</span>
01977         <span class="comment">//  sub-object,</span>
01978         <span class="comment">//  break it down for him.</span>
01979         <span class="comment">//</span>
01980 
01981         <span class="keywordflow">if</span> ( ReturnResultList ) {
01982             ACCESS_MASK GrantedAccessMask;
01983             ACCESS_MASK RequiredAccessMask;
01984             BOOLEAN SomeAccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01985             BOOLEAN SomeAccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01986 
01987             <span class="comment">//</span>
01988             <span class="comment">// Compute mask of Granted access bits to tell the caller about.</span>
01989             <span class="comment">//  If he asked for MAXIMUM_ALLOWED,</span>
01990             <span class="comment">//      tell him everything,</span>
01991             <span class="comment">//  otherwise</span>
01992             <span class="comment">//      tell him what he asked about.</span>
01993             <span class="comment">//</span>
01994 
01995             <span class="keywordflow">if</span> (DesiredAccess &amp; MAXIMUM_ALLOWED) {
01996                 GrantedAccessMask = (ACCESS_MASK) ~MAXIMUM_ALLOWED;
01997                 RequiredAccessMask = (DesiredAccess | PreviouslyGrantedAccess) &amp; ~MAXIMUM_ALLOWED;
01998             } <span class="keywordflow">else</span> {
01999                 GrantedAccessMask = DesiredAccess | PreviouslyGrantedAccess;
02000                 RequiredAccessMask = DesiredAccess | PreviouslyGrantedAccess;
02001             }
02002 
02003 
02004 
02005 
02006             <span class="comment">//</span>
02007             <span class="comment">// Loop computing the access granted to each object and sub-object.</span>
02008             <span class="comment">//</span>
02009             <span class="keywordflow">for</span> ( ResultListIndex=0;
02010                   ResultListIndex&lt;LocalTypeListLength;
02011                   ResultListIndex++ ) {
02012 
02013                 <span class="comment">//</span>
02014                 <span class="comment">// Return the subset of the access granted that the caller</span>
02015                 <span class="comment">//  expressed interest in.</span>
02016                 <span class="comment">//</span>
02017 
02018                 GrantedAccess[ResultListIndex] =
02019                     (LocalTypeList[ResultListIndex].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o5">CurrentGranted</a> |
02020                      PreviouslyGrantedAccess ) &amp;
02021                     GrantedAccessMask;
02022 
02023                 <span class="comment">//</span>
02024                 <span class="comment">// If absolutely no access was granted,</span>
02025                 <span class="comment">//  indicate so.</span>
02026                 <span class="comment">//</span>
02027                 <span class="keywordflow">if</span> ( GrantedAccess[ResultListIndex] == 0 ) {
02028                     AccessStatus[ResultListIndex] = STATUS_ACCESS_DENIED;
02029                     SomeAccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02030                 } <span class="keywordflow">else</span> {
02031 
02032                     <span class="comment">//</span>
02033                     <span class="comment">// If some requested access is still missing,</span>
02034                     <span class="comment">//  the bottom line is that access is denied.</span>
02035                     <span class="comment">//</span>
02036                     <span class="comment">// Note, that ByTypeResultList actually returns the</span>
02037                     <span class="comment">// partially granted access mask even though the caller</span>
02038                     <span class="comment">// really has no access to the object.</span>
02039                     <span class="comment">//</span>
02040 
02041                     <span class="keywordflow">if</span>  ( ((~GrantedAccess[ResultListIndex]) &amp; RequiredAccessMask ) != 0 ) {
02042                         AccessStatus[ResultListIndex] = STATUS_ACCESS_DENIED;
02043                         SomeAccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02044                     } <span class="keywordflow">else</span> {
02045                         AccessStatus[ResultListIndex] = STATUS_SUCCESS;
02046                         SomeAccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02047                     }
02048                 }
02049             }
02050 
02051             <span class="keywordflow">if</span> ( SomeAccessGranted &amp;&amp; PrivilegeCount != 0 ) {
02052 
02053                 <a class="code" href="../../d6/d6/sep_8h.html#a64">SepAssemblePrivileges</a>(
02054                     PrivilegeCount,
02055                     SystemSecurity,
02056                     WriteOwner,
02057                     Privileges
02058                     );
02059             }
02060 
02061             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessGranted)) {
02062                 *ReturnSomeAccessGranted = SomeAccessGranted;
02063             }
02064             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessDenied)) {
02065                 *ReturnSomeAccessDenied = SomeAccessDenied;
02066             }
02067             <span class="keywordflow">return</span>;
02068 
02069         <span class="comment">//</span>
02070         <span class="comment">// If the caller is only interested in the access to the object itself,</span>
02071         <span class="comment">//  just summarize.</span>
02072         <span class="comment">//</span>
02073 
02074         } <span class="keywordflow">else</span> {
02075 
02076             <span class="comment">//</span>
02077             <span class="comment">// Turn off the MAXIMUM_ALLOWED bit and whatever we found that</span>
02078             <span class="comment">// he was granted.  If the user passed in extra bits in addition</span>
02079             <span class="comment">// to MAXIMUM_ALLOWED, make sure that he was granted those access</span>
02080             <span class="comment">// types.  If not, he didn't get what he wanted, so return failure.</span>
02081             <span class="comment">//</span>
02082 
02083             Remaining &amp;= ~(MAXIMUM_ALLOWED | LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o5">CurrentGranted</a>);
02084 
02085             <span class="keywordflow">if</span> (Remaining != 0) {
02086 
02087                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
02088                 PreviouslyGrantedAccess = 0;
02089                 <span class="keywordflow">goto</span> ReturnOneStatus;
02090 
02091             }
02092 
02093 
02094 
02095             PreviouslyGrantedAccess |= LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o5">CurrentGranted</a>;
02096             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02097             <span class="keywordflow">goto</span> ReturnOneStatus;
02098 
02099         }
02100 
02101     } <span class="comment">// if MAXIMUM_ALLOWED...</span>
02102 
02103 
02104 <span class="preprocessor">#ifdef notdef</span>
02105 <span class="preprocessor"></span>    <span class="comment">//</span>
02106     <span class="comment">// The remaining bits are "remaining" at all levels</span>
02107 
02108     <span class="keywordflow">for</span> ( j=0; j&lt;LocalTypeListLength; j++ ) {
02109         LocalTypeList[j].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> = Remaining;
02110     }
02111 
02112     <span class="comment">//</span>
02113     <span class="comment">// Process the DACL handling individual access bits.</span>
02114     <span class="comment">//</span>
02115 
02116     <span class="keywordflow">for</span> ( i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Dacl ) ;
02117           ( i &lt; AceCount ) &amp;&amp; ( LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> != 0 )  ;
02118           i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace ) ) {
02119 
02120         <span class="keywordflow">if</span> ( !(((PACE_HEADER)Ace)-&gt;AceFlags &amp; INHERIT_ONLY_ACE)) {
02121 
02122             <span class="comment">//</span>
02123             <span class="comment">// Handle an Access Allowed ACE</span>
02124             <span class="comment">//</span>
02125 
02126             <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_ACE_TYPE) ) {
02127 
02128                <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( EToken, PrincipalSelfSid, &amp;((PACCESS_ALLOWED_ACE)Ace)-&gt;SidStart, FALSE ) ) {
02129 
02130                    <span class="comment">// Optimize 'normal' case</span>
02131                    <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
02132                        LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp;= ~((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask;
02133                    } <span class="keywordflow">else</span> {
02134                        <span class="comment">//</span>
02135                        <span class="comment">// The zeroeth object type represents the object itself.</span>
02136                        <span class="comment">//</span>
02137                        <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
02138                             LocalTypeList,          <span class="comment">// List to modify</span>
02139                             LocalTypeListLength,    <span class="comment">// Length of list</span>
02140                             0,                      <span class="comment">// Element to update</span>
02141                             ((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
02142                             UpdateRemaining );
02143                    }
02144 
02145                }
02146 
02147 
02148             <span class="comment">//</span>
02149             <span class="comment">// Handle an object specific Access Allowed ACE</span>
02150             <span class="comment">//</span>
02151             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_OBJECT_ACE_TYPE) ) {
02152                 GUID *ObjectTypeInAce;
02153 
02154                 <span class="comment">//</span>
02155                 <span class="comment">// If no object type is in the ACE,</span>
02156                 <span class="comment">//  treat this as an ACCESS_ALLOWED_ACE.</span>
02157                 <span class="comment">//</span>
02158 
02159                 ObjectTypeInAce = RtlObjectAceObjectType(Ace);
02160 
02161                 <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02162 
02163                     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), FALSE ) ) {
02164 
02165                        <span class="comment">// Optimize 'normal' case</span>
02166                        <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
02167                            LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp;= ~((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask;
02168                        } <span class="keywordflow">else</span> {
02169                            <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
02170                                 LocalTypeList,          <span class="comment">// List to modify</span>
02171                                 LocalTypeListLength,    <span class="comment">// Length of list</span>
02172                                 0,                      <span class="comment">// Element to update</span>
02173                                 ((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
02174                                 UpdateRemaining );
02175                        }
02176                     }
02177 
02178                 <span class="comment">//</span>
02179                 <span class="comment">// If no object type list was passed,</span>
02180                 <span class="comment">//  don't grant access to anyone.</span>
02181                 <span class="comment">//</span>
02182 
02183                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
02184 
02185                     <span class="comment">// Drop through</span>
02186 
02187 
02188                <span class="comment">//</span>
02189                <span class="comment">// If an object type is in the ACE,</span>
02190                <span class="comment">//   Find it in the LocalTypeList before using the ACE.</span>
02191                <span class="comment">//</span>
02192                } <span class="keywordflow">else</span> {
02193 
02194                     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), FALSE ) ) {
02195 
02196                         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
02197                                                   LocalTypeList,
02198                                                   LocalTypeListLength,
02199                                                   &amp;Index ) ) {
02200                             <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
02201                                  LocalTypeList,          <span class="comment">// List to modify</span>
02202                                  LocalTypeListLength,   <span class="comment">// Length of list</span>
02203                                  Index,                  <span class="comment">// Element already updated</span>
02204                                  ((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
02205                                  UpdateRemaining );
02206                         }
02207                     }
02208                }
02209 
02210 
02211             <span class="comment">//</span>
02212             <span class="comment">// Handle a compound Access Allowed ACE</span>
02213             <span class="comment">//</span>
02214             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_COMPOUND_ACE_TYPE) ) {
02215 
02216                 <span class="comment">//</span>
02217                 <span class="comment">// See comment in MAXIMUM_ALLOWED case as to why we can use EToken here</span>
02218                 <span class="comment">// for the client.</span>
02219                 <span class="comment">//</span>
02220 
02221                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>(EToken, PrincipalSelfSid, RtlCompoundAceClientSid( Ace ), FALSE) &amp;&amp;
02222                      <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>(PrimaryToken, NULL, RtlCompoundAceServerSid( Ace ), FALSE) ) {
02223 
02224                     <span class="comment">// Optimize 'normal' case</span>
02225                     <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
02226                         LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp;= ~((PCOMPOUND_ACCESS_ALLOWED_ACE)Ace)-&gt;Mask;
02227                     } <span class="keywordflow">else</span> {
02228                         <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
02229                              LocalTypeList,          <span class="comment">// List to modify</span>
02230                              LocalTypeListLength,    <span class="comment">// Length of list</span>
02231                              0,                      <span class="comment">// Element to update</span>
02232                              ((PCOMPOUND_ACCESS_ALLOWED_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
02233                              UpdateRemaining );
02234                     }
02235                 }
02236 
02237 
02238 
02239             <span class="comment">//</span>
02240             <span class="comment">// Handle an Access Denied ACE</span>
02241             <span class="comment">//</span>
02242 
02243             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_ACE_TYPE) ) {
02244 
02245                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( EToken, PrincipalSelfSid, &amp;((PACCESS_DENIED_ACE)Ace)-&gt;SidStart, TRUE ) ) {
02246 
02247                     <span class="comment">//</span>
02248                     <span class="comment">// The zeroeth element represents the object itself.</span>
02249                     <span class="comment">//  Just check that element.</span>
02250                     <span class="comment">//</span>
02251                     <span class="keywordflow">if</span> (LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp; ((PACCESS_DENIED_ACE)Ace)-&gt;Mask) {
02252 
02253                         <span class="keywordflow">break</span>;
02254                     }
02255                 }
02256 
02257 
02258             <span class="comment">//</span>
02259             <span class="comment">// Handle an object specific Access Denied ACE</span>
02260             <span class="comment">//</span>
02261             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_OBJECT_ACE_TYPE) ) {
02262 
02263                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), TRUE ) ) {
02264                     GUID *ObjectTypeInAce;
02265 
02266                     <span class="comment">//</span>
02267                     <span class="comment">// If there is no object type in the ACE,</span>
02268                     <span class="comment">//  or if the caller didn't specify an object type list,</span>
02269                     <span class="comment">//  apply this deny ACE to the entire object.</span>
02270                     <span class="comment">//</span>
02271 
02272                     ObjectTypeInAce = RtlObjectAceObjectType(Ace);
02273                     <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
02274                          ObjectTypeListLength == 0 ) {
02275 
02276                         <span class="comment">//</span>
02277                         <span class="comment">// The zeroeth element represents the object itself.</span>
02278                         <span class="comment">//  Just check that element.</span>
02279                         <span class="comment">//</span>
02280                         <span class="keywordflow">if</span> (LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp; ((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask) {
02281                             <span class="keywordflow">break</span>;
02282                         }
02283 
02284                     <span class="comment">//</span>
02285                     <span class="comment">// Otherwise apply the deny ACE to the object specified</span>
02286                     <span class="comment">//  in the ACE.</span>
02287                     <span class="comment">//</span>
02288 
02289                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
02290                                                   LocalTypeList,
02291                                                   LocalTypeListLength,
02292                                                   &amp;Index ) ) {
02293 
02294                         <span class="keywordflow">if</span> (LocalTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp; ((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask) {
02295                             <span class="keywordflow">break</span>;
02296                         }
02297 
02298                     }
02299                }
02300             }
02301 
02302         }
02303     }
02304 
02305 <span class="preprocessor">#endif</span>
02306 <span class="preprocessor"></span>
02307     <span class="comment">//</span>
02308     <span class="comment">// Do the normal access check first</span>
02309     <span class="comment">//</span>
02310 
02311     <a class="code" href="../../d0/d4/accessck_8c.html#a7">SepNormalAccessCheck</a>(
02312         Remaining,
02313         EToken,
02314         PrimaryToken,
02315         Dacl,
02316         PrincipalSelfSid,
02317         LocalTypeListLength,
02318         LocalTypeList,
02319         ObjectTypeListLength,
02320         FALSE
02321         );
02322 
02323     <span class="keywordflow">if</span> (LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> != 0) {
02324         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
02325         PreviouslyGrantedAccess = 0;
02326         <span class="keywordflow">goto</span> ReturnOneStatus;
02327     }
02328 
02329     <span class="comment">//</span>
02330     <span class="comment">// If this is a restricted token, do the additional access check</span>
02331     <span class="comment">//</span>
02332 
02333     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/token_8c.html#a5">SeTokenIsRestricted</a>( EToken ) ) {
02334         <a class="code" href="../../d0/d4/accessck_8c.html#a7">SepNormalAccessCheck</a>(
02335             Remaining,
02336             EToken,
02337             PrimaryToken,
02338             Dacl,
02339             PrincipalSelfSid,
02340             LocalTypeListLength,
02341             LocalTypeList,
02342             ObjectTypeListLength,
02343             TRUE
02344             );
02345     }
02346 
02347 
02348     <span class="keywordflow">if</span> (LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> != 0) {
02349         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
02350         PreviouslyGrantedAccess = 0;
02351         <span class="keywordflow">goto</span> ReturnOneStatus;
02352     }
02353 
02354     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02355     PreviouslyGrantedAccess |= DesiredAccess;
02356 
02357     <span class="comment">//</span>
02358     <span class="comment">// Return a single status code to the caller.</span>
02359     <span class="comment">//</span>
02360 
02361     ReturnOneStatus:
02362     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS &amp;&amp; PreviouslyGrantedAccess == 0 ) {
02363         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
02364     }
02365 
02366     <span class="comment">//</span>
02367     <span class="comment">// If the caller asked for a list of status',</span>
02368     <span class="comment">//  duplicate the status all over.</span>
02369     <span class="comment">//</span>
02370     <span class="keywordflow">if</span> ( ReturnResultList ) {
02371         <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
02372             AccessStatus[ResultListIndex] = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02373             GrantedAccess[ResultListIndex] = PreviouslyGrantedAccess;
02374         }
02375     } <span class="keywordflow">else</span> {
02376         *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02377         *GrantedAccess = PreviouslyGrantedAccess;
02378     }
02379 
02380     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
02381         <span class="keywordflow">if</span> ( PrivilegeCount &gt; 0 ) {
02382 
02383             <a class="code" href="../../d6/d6/sep_8h.html#a64">SepAssemblePrivileges</a>(
02384                 PrivilegeCount,
02385                 SystemSecurity,
02386                 WriteOwner,
02387                 Privileges
02388                 );
02389         }
02390 
02391         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessGranted)) {
02392             *ReturnSomeAccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02393         }
02394         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessDenied)) {
02395             *ReturnSomeAccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02396         }
02397     } <span class="keywordflow">else</span> {
02398         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessGranted)) {
02399             *ReturnSomeAccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02400         }
02401         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessDenied)) {
02402             *ReturnSomeAccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;;
02403         }
02404     }
02405     <span class="keywordflow">return</span>;
02406 
02407 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="accessck.c::SepAddAccessTypeList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAddAccessTypeList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StartIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/accessck_8c.html#a23">ACCESS_MASK_FIELD_TO_UPDATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FieldToUpdate</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l00574">574</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00441">SepUpdateParentTypeList()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d4/accessck_8c.html#a23a2">UpdateCurrentDenied</a>, <a class="el" href="../../d0/d4/accessck_8c.html#a23a1">UpdateCurrentGranted</a>, and <a class="el" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l01564">SepAccessCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00992">SepMaximumAccessCheck()</a>, and <a class="el" href="../../d1/d3/accessck_8c-source.html#l01304">SepNormalAccessCheck()</a>.
<p>
<pre class="fragment"><div>00583                    :
00584 
00585     This routine grants <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified AccessMask to all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects that
00586     are descendents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object specified by StartIndex.
00587 
00588     The Access fields of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent objects are also recomputed as needed.
00589 
00590     For example, <span class="keywordflow">if</span> an ACE granting access to a Property Set <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> found,
00591         that access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> granted to all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Properties in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Property Set.
00592 
00593 Arguments:
00594 
00595     ObjectTypeList - The object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list to update.
00596 
00597     ObjectTypeListLength - Number of elements in ObjectTypeList
00598 
00599     StartIndex - <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target element to update.
00600 
00601     AccessMask - Mask of access to grant to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target element and
00602         all of its decendents
00603 
00604     FieldToUpdate - Indicate which fields to update in object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list
00605 
00606 Return Value:
00607 
00608     None.
00609 
00610 --*/
00611 
00612 {
00613     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00614     ACCESS_MASK OldRemaining;
00615     ACCESS_MASK OldCurrentGranted;
00616     ACCESS_MASK OldCurrentDenied;
00617     BOOLEAN AvoidParent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00618 
00619     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00620 
00621     <span class="comment">//</span>
00622     <span class="comment">// Update the requested field.</span>
00623     <span class="comment">//</span>
00624     <span class="comment">// Always handle the target entry.</span>
00625     <span class="comment">//</span>
00626     <span class="comment">// If we've not actually changed the bits,</span>
00627     <span class="comment">//  early out.</span>
00628     <span class="comment">//</span>
00629 
00630     <span class="keywordflow">switch</span> (FieldToUpdate ) {
00631     <span class="keywordflow">case</span> <a class="code" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a>:
00632 
00633         OldRemaining = ObjectTypeList[StartIndex].Remaining;
00634         ObjectTypeList[StartIndex].Remaining = OldRemaining &amp; ~AccessMask;
00635 
00636         <span class="keywordflow">if</span> ( OldRemaining == ObjectTypeList[StartIndex].Remaining ) {
00637             <span class="keywordflow">return</span>;
00638         }
00639         <span class="keywordflow">break</span>;
00640 
00641     <span class="keywordflow">case</span> <a class="code" href="../../d0/d4/accessck_8c.html#a23a1">UpdateCurrentGranted</a>:
00642 
00643         OldCurrentGranted = ObjectTypeList[StartIndex].CurrentGranted;
00644         ObjectTypeList[StartIndex].CurrentGranted |=
00645             AccessMask &amp; ~ObjectTypeList[StartIndex].CurrentDenied;
00646 
00647         <span class="keywordflow">if</span> ( OldCurrentGranted == ObjectTypeList[StartIndex].CurrentGranted ) {
00648             <span class="comment">//</span>
00649             <span class="comment">// We can't simply return here.</span>
00650             <span class="comment">// We have to visit our children.  Consider the case where there</span>
00651             <span class="comment">// was a previous deny ACE on a child.  That deny would have</span>
00652             <span class="comment">// propagated up the tree to this entry.  However, this allow ACE</span>
00653             <span class="comment">// needs to be added all of the children that haven't been</span>
00654             <span class="comment">// explictly denied.</span>
00655             <span class="comment">//</span>
00656             AvoidParent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00657         }
00658         <span class="keywordflow">break</span>;
00659 
00660     <span class="keywordflow">case</span> <a class="code" href="../../d0/d4/accessck_8c.html#a23a2">UpdateCurrentDenied</a>:
00661 
00662         OldCurrentDenied = ObjectTypeList[StartIndex].CurrentDenied;
00663         ObjectTypeList[StartIndex].CurrentDenied |=
00664             AccessMask &amp; ~ObjectTypeList[StartIndex].CurrentGranted;
00665 
00666         <span class="keywordflow">if</span> ( OldCurrentDenied == ObjectTypeList[StartIndex].CurrentDenied ) {
00667             <span class="keywordflow">return</span>;
00668         }
00669         <span class="keywordflow">break</span>;
00670 
00671     <span class="keywordflow">default</span>:
00672         <span class="keywordflow">return</span>;
00673     }
00674 
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">// Go update parent of the target.</span>
00678     <span class="comment">//</span>
00679 
00680     <span class="keywordflow">if</span> ( !AvoidParent ) {
00681         <a class="code" href="../../d0/d4/accessck_8c.html#a3">SepUpdateParentTypeList</a>( ObjectTypeList,
00682                                  ObjectTypeListLength,
00683                                  StartIndex );
00684     }
00685 
00686     <span class="comment">//</span>
00687     <span class="comment">// Loop handling all children of the target.</span>
00688     <span class="comment">//</span>
00689 
00690     <span class="keywordflow">for</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=StartIndex+1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>&lt;ObjectTypeListLength; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
00691 
00692         <span class="comment">//</span>
00693         <span class="comment">// By definition, the children of an object are all those entries</span>
00694         <span class="comment">// immediately following the target.  The list of children (or</span>
00695         <span class="comment">// grandchildren) stops as soon as we reach an entry the has the</span>
00696         <span class="comment">// same level as the target (a sibling) or lower than the target</span>
00697         <span class="comment">// (an uncle).</span>
00698         <span class="comment">//</span>
00699 
00700         <span class="keywordflow">if</span> ( ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Level &lt;= ObjectTypeList[StartIndex].Level ) {
00701             <span class="keywordflow">break</span>;
00702         }
00703 
00704         <span class="comment">//</span>
00705         <span class="comment">// Grant access to the children</span>
00706         <span class="comment">//</span>
00707 
00708         <span class="keywordflow">switch</span> (FieldToUpdate) {
00709         <span class="keywordflow">case</span> <a class="code" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a>:
00710 
00711             ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Remaining &amp;= ~AccessMask;
00712             <span class="keywordflow">break</span>;
00713 
00714         <span class="keywordflow">case</span> <a class="code" href="../../d0/d4/accessck_8c.html#a23a1">UpdateCurrentGranted</a>:
00715 
00716             ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].CurrentGranted |=
00717                 AccessMask &amp; ~ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].CurrentDenied;
00718             <span class="keywordflow">break</span>;
00719 
00720         <span class="keywordflow">case</span> <a class="code" href="../../d0/d4/accessck_8c.html#a23a2">UpdateCurrentDenied</a>:
00721 
00722             ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].CurrentDenied |=
00723                 AccessMask &amp; ~ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].CurrentGranted;
00724             <span class="keywordflow">break</span>;
00725 
00726         <span class="keywordflow">default</span>:
00727             <span class="keywordflow">return</span>;
00728         }
00729     }
00730 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="accessck.c::SepMaximumAccessCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepMaximumAccessCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>EToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Dacl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrincipalSelfSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LocalTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LocalTypeList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Restricted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l00992">992</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00126">PrimaryToken</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00574">SepAddAccessTypeList()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00388">SepObjectInTypeList()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00856">SepSidInTokenEx()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d4/accessck_8c.html#a23a2">UpdateCurrentDenied</a>, and <a class="el" href="../../d0/d4/accessck_8c.html#a23a1">UpdateCurrentGranted</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l01564">SepAccessCheck()</a>.
<p>
<pre class="fragment"><div>01004                    :
01005 
01006     Does an access check <span class="keywordflow">for</span> maximum allowed or with a result list. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01007     <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done <span class="keywordflow">for</span> a restricted token. The sids
01008     checked are <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restricted sids, not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> users and groups. The current
01009     granted access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Remaining access and then another access
01010     check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> run.
01011 
01012 Arguments:
01013 
01014     EToken - Effective token of caller.
01015 
01016     <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> - Process token of calling process
01017 
01018     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> - ACL to check
01019 
01020     PrincipalSelfSid - Sid to use in replacing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> well-known <span class="keyword">self</span> sid
01021 
01022     LocalTypeListLength - Length of list of types.
01023 
01024     LocalTypeList - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> of types.
01025 
01026     ObjectTypeList - Length of caller-supplied list of object types.
01027 
01028 Return Value:
01029 
01030     none
01031 
01032 --*/
01033 
01034 {
01035     ULONG i,j;
01036     PVOID Ace;
01037     ULONG AceCount;
01038     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01039     ULONG ResultListIndex;
01040 
01041     <span class="comment">//</span>
01042     <span class="comment">// The remaining bits are the granted bits for each object type on a</span>
01043     <span class="comment">// restricted check</span>
01044     <span class="comment">//</span>
01045 
01046     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> ) {
01047         <span class="keywordflow">for</span> ( j=0; j&lt;LocalTypeListLength; j++ ) {
01048             LocalTypeList[j].Remaining = LocalTypeList[j].CurrentGranted;
01049             LocalTypeList[j].CurrentGranted = 0;
01050         }
01051     }
01052 
01053 
01054     AceCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AceCount;
01055 
01056     <span class="comment">//</span>
01057     <span class="comment">// granted == NUL</span>
01058     <span class="comment">// denied == NUL</span>
01059     <span class="comment">//</span>
01060     <span class="comment">//  for each ACE</span>
01061     <span class="comment">//</span>
01062     <span class="comment">//      if grant</span>
01063     <span class="comment">//          for each SID</span>
01064     <span class="comment">//              if SID match, then add all that is not denied to grant mask</span>
01065     <span class="comment">//</span>
01066     <span class="comment">//      if deny</span>
01067     <span class="comment">//          for each SID</span>
01068     <span class="comment">//              if SID match, then add all that is not granted to deny mask</span>
01069     <span class="comment">//</span>
01070 
01071     <span class="keywordflow">for</span> ( i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Dacl ) ;
01072           i &lt; AceCount  ;
01073           i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace )
01074         ) {
01075 
01076         <span class="keywordflow">if</span> ( !(((PACE_HEADER)Ace)-&gt;AceFlags &amp; INHERIT_ONLY_ACE)) {
01077 
01078             <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_ACE_TYPE) ) {
01079 
01080                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, &amp;((PACCESS_ALLOWED_ACE)Ace)-&gt;SidStart, FALSE, Restricted )) {
01081 
01082                     <span class="comment">//</span>
01083                     <span class="comment">// Only grant access types from this mask that have</span>
01084                     <span class="comment">// not already been denied</span>
01085                     <span class="comment">//</span>
01086 
01087                     <span class="comment">// Optimize 'normal' case</span>
01088                     <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01089                         LocalTypeList-&gt;CurrentGranted |=
01090                            (((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask &amp; ~LocalTypeList-&gt;CurrentDenied);
01091                     } <span class="keywordflow">else</span> {
01092                        <span class="comment">//</span>
01093                        <span class="comment">// The zeroeth object type represents the object itself.</span>
01094                        <span class="comment">//</span>
01095                        <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01096                             LocalTypeList,          <span class="comment">// List to modify</span>
01097                             LocalTypeListLength,    <span class="comment">// Length of list</span>
01098                             0,                      <span class="comment">// Element to update</span>
01099                             ((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01100                             UpdateCurrentGranted );
01101                     }
01102                  }
01103 
01104 
01105              <span class="comment">//</span>
01106              <span class="comment">// Handle an object specific Access Allowed ACE</span>
01107              <span class="comment">//</span>
01108              } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_OBJECT_ACE_TYPE) ) {
01109                  GUID *ObjectTypeInAce;
01110 
01111                  <span class="comment">//</span>
01112                  <span class="comment">// If no object type is in the ACE,</span>
01113                  <span class="comment">//  treat this as an ACCESS_ALLOWED_ACE.</span>
01114                  <span class="comment">//</span>
01115 
01116                  ObjectTypeInAce = RtlObjectAceObjectType(Ace);
01117 
01118                  <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01119 
01120                      <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), FALSE, Restricted ) ) {
01121 
01122                          <span class="comment">// Optimize 'normal' case</span>
01123                          <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01124                              LocalTypeList-&gt;CurrentGranted |=
01125                                 (((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask &amp; ~LocalTypeList-&gt;CurrentDenied);
01126                          } <span class="keywordflow">else</span> {
01127                              <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01128                                  LocalTypeList,          <span class="comment">// List to modify</span>
01129                                  LocalTypeListLength,    <span class="comment">// Length of list</span>
01130                                  0,                      <span class="comment">// Element to update</span>
01131                                  ((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01132                                  UpdateCurrentGranted );
01133                          }
01134                      }
01135 
01136                  <span class="comment">//</span>
01137                  <span class="comment">// If no object type list was passed,</span>
01138                  <span class="comment">//  don't grant access to anyone.</span>
01139                  <span class="comment">//</span>
01140 
01141                  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
01142 
01143                      <span class="comment">// Drop through</span>
01144 
01145 
01146                 <span class="comment">//</span>
01147                 <span class="comment">// If an object type is in the ACE,</span>
01148                 <span class="comment">//   Find it in the LocalTypeList before using the ACE.</span>
01149                 <span class="comment">//</span>
01150                 } <span class="keywordflow">else</span> {
01151 
01152                      <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), FALSE, Restricted ) ) {
01153 
01154                          <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
01155                                                    LocalTypeList,
01156                                                    LocalTypeListLength,
01157                                                    &amp;Index ) ) {
01158                              <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01159                                   LocalTypeList,          <span class="comment">// List to modify</span>
01160                                   LocalTypeListLength,   <span class="comment">// Length of list</span>
01161                                   Index,                  <span class="comment">// Element already updated</span>
01162                                   ((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01163                                   UpdateCurrentGranted );
01164                          }
01165                      }
01166                 }
01167 
01168              } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_COMPOUND_ACE_TYPE) ) {
01169 
01170                  <span class="comment">//</span>
01171                  <span class="comment">//  If we're impersonating, EToken is set to the Client, and if we're not,</span>
01172                  <span class="comment">//  EToken is set to the Primary.  According to the DSA architecture, if</span>
01173                  <span class="comment">//  we're asked to evaluate a compound ACE and we're not impersonating,</span>
01174                  <span class="comment">//  pretend we are impersonating ourselves.  So we can just use the EToken</span>
01175                  <span class="comment">//  for the client token, since it's already set to the right thing.</span>
01176                  <span class="comment">//</span>
01177 
01178 
01179                  <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>(EToken, PrincipalSelfSid, RtlCompoundAceClientSid( Ace ), FALSE, Restricted) &amp;&amp;
01180                       <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>(PrimaryToken, NULL, RtlCompoundAceServerSid( Ace ), FALSE, FALSE)
01181                     ) {
01182 
01183                      <span class="comment">//</span>
01184                      <span class="comment">// Only grant access types from this mask that have</span>
01185                      <span class="comment">// not already been denied</span>
01186                      <span class="comment">//</span>
01187 
01188                      <span class="comment">// Optimize 'normal' case</span>
01189                      <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01190                          LocalTypeList-&gt;CurrentGranted |=
01191                             (((PCOMPOUND_ACCESS_ALLOWED_ACE)Ace)-&gt;Mask &amp; ~LocalTypeList-&gt;CurrentDenied);
01192                      } <span class="keywordflow">else</span> {
01193                         <span class="comment">//</span>
01194                         <span class="comment">// The zeroeth object type represents the object itself.</span>
01195                         <span class="comment">//</span>
01196                         <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01197                              LocalTypeList,          <span class="comment">// List to modify</span>
01198                              LocalTypeListLength,    <span class="comment">// Length of list</span>
01199                              0,                      <span class="comment">// Element to update</span>
01200                              ((PCOMPOUND_ACCESS_ALLOWED_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01201                              UpdateCurrentGranted );
01202                      }
01203 
01204                  }
01205 
01206 
01207              } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_ACE_TYPE) ) {
01208 
01209                  <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, &amp;((PACCESS_DENIED_ACE)Ace)-&gt;SidStart, TRUE, Restricted )) {
01210 
01211                       <span class="comment">//</span>
01212                       <span class="comment">// Only deny access types from this mask that have</span>
01213                       <span class="comment">// not already been granted</span>
01214                       <span class="comment">//</span>
01215 
01216                      <span class="comment">// Optimize 'normal' case</span>
01217                      <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01218                          LocalTypeList-&gt;CurrentDenied |=
01219                              (((PACCESS_DENIED_ACE)Ace)-&gt;Mask &amp; ~LocalTypeList-&gt;CurrentGranted);
01220                      } <span class="keywordflow">else</span> {
01221                          <span class="comment">//</span>
01222                          <span class="comment">// The zeroeth object type represents the object itself.</span>
01223                          <span class="comment">//</span>
01224                          <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01225                              LocalTypeList,          <span class="comment">// List to modify</span>
01226                              LocalTypeListLength,    <span class="comment">// Length of list</span>
01227                              0,                      <span class="comment">// Element to update</span>
01228                              ((PACCESS_DENIED_ACE)Ace)-&gt;Mask, <span class="comment">// Access denied</span>
01229                              UpdateCurrentDenied );
01230                     }
01231                  }
01232 
01233 
01234              <span class="comment">//</span>
01235              <span class="comment">// Handle an object specific Access Denied ACE</span>
01236              <span class="comment">//</span>
01237              } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_OBJECT_ACE_TYPE) ) {
01238 
01239                  <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), TRUE, Restricted ) ) {
01240                      GUID *ObjectTypeInAce;
01241 
01242                      <span class="comment">//</span>
01243                      <span class="comment">// If there is no object type in the ACE,</span>
01244                      <span class="comment">//  or if the caller didn't specify an object type list,</span>
01245                      <span class="comment">//  apply this deny ACE to the entire object.</span>
01246                      <span class="comment">//</span>
01247 
01248                      ObjectTypeInAce = RtlObjectAceObjectType(Ace);
01249 
01250                      <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01251 
01252                          <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01253                              LocalTypeList-&gt;CurrentDenied |=
01254                                  (((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask &amp; ~LocalTypeList-&gt;CurrentGranted);
01255                          } <span class="keywordflow">else</span> {
01256 
01257                              <span class="comment">//</span>
01258                              <span class="comment">// The zeroeth object type represents the object itself.</span>
01259                              <span class="comment">//</span>
01260 
01261                              <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01262                                  LocalTypeList,          <span class="comment">// List to modify</span>
01263                                  LocalTypeListLength,    <span class="comment">// Length of list</span>
01264                                  0,
01265                                  ((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access denied</span>
01266                                  UpdateCurrentDenied );
01267                          }
01268                      <span class="comment">//</span>
01269                      <span class="comment">// If no object type list was passed,</span>
01270                      <span class="comment">//  don't grant access to anyone.</span>
01271                      <span class="comment">//</span>
01272 
01273                      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
01274 
01275                          LocalTypeList-&gt;CurrentDenied |=
01276                              (((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask &amp; ~LocalTypeList-&gt;CurrentGranted);
01277 
01278 
01279                      <span class="comment">//</span>
01280                      <span class="comment">// If an object type is in the ACE,</span>
01281                      <span class="comment">//   Find it in the LocalTypeList before using the ACE.</span>
01282                      <span class="comment">//</span>
01283 
01284                      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
01285                                                           LocalTypeList,
01286                                                           LocalTypeListLength,
01287                                                           &amp;Index ) ) {
01288 
01289                             <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01290                                 LocalTypeList,          <span class="comment">// List to modify</span>
01291                                 LocalTypeListLength,    <span class="comment">// Length of list</span>
01292                                 Index,                  <span class="comment">// Element to update</span>
01293                                 ((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access denied</span>
01294                                 UpdateCurrentDenied );
01295 
01296                     }
01297                 }
01298             }
01299         }
01300     }
01301 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="accessck.c::SepNormalAccessCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepNormalAccessCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>Remaining</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>EToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Dacl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrincipalSelfSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LocalTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LocalTypeList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Restricted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l01304">1304</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00126">PrimaryToken</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00574">SepAddAccessTypeList()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00388">SepObjectInTypeList()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00856">SepSidInTokenEx()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l01564">SepAccessCheck()</a>.
<p>
<pre class="fragment"><div>01317                    :
01318 
01319     Does an access check when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller isn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> asking <span class="keywordflow">for</span> MAXIMUM_ALLOWED or
01320     a <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> result list. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sids checked are
01321     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restricted sids, not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> users and groups. The Remaining field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01322     reset to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original remaining value and then another access check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> run.
01323 
01324 Arguments:
01325 
01326     Remaining - Remaining access desired after special checks
01327 
01328     EToken - Effective token of caller.
01329 
01330     <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> - Process token of calling process
01331 
01332     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> - ACL to check
01333 
01334     PrincipalSelfSid - Sid to use in replacing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> well-known <span class="keyword">self</span> sid
01335 
01336     LocalTypeListLength - Length of list of types.
01337 
01338     LocalTypeList - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> of types.
01339 
01340     ObjectTypeList - Length of caller-supplied list of object types.
01341 
01342     <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> - Use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restricted sids <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access check.
01343 
01344 Return Value:
01345 
01346     none
01347 
01348 --*/
01349 {
01350     ULONG i,j;
01351     PVOID Ace;
01352     ULONG AceCount;
01353     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01354 
01355     AceCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AceCount;
01356 
01357     <span class="comment">//</span>
01358     <span class="comment">// The remaining bits are "remaining" at all levels</span>
01359     <span class="comment">//</span>
01360 
01361     <span class="keywordflow">for</span> ( j=0; j&lt;LocalTypeListLength; j++ ) {
01362         LocalTypeList[j].Remaining = Remaining;
01363     }
01364 
01365     <span class="comment">//</span>
01366     <span class="comment">// Process the DACL handling individual access bits.</span>
01367     <span class="comment">//</span>
01368 
01369     <span class="keywordflow">for</span> ( i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Dacl ) ;
01370           ( i &lt; AceCount ) &amp;&amp; ( LocalTypeList-&gt;Remaining != 0 )  ;
01371           i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace ) ) {
01372 
01373         <span class="keywordflow">if</span> ( !(((PACE_HEADER)Ace)-&gt;AceFlags &amp; INHERIT_ONLY_ACE)) {
01374 
01375             <span class="comment">//</span>
01376             <span class="comment">// Handle an Access Allowed ACE</span>
01377             <span class="comment">//</span>
01378 
01379             <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_ACE_TYPE) ) {
01380 
01381                <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, &amp;((PACCESS_ALLOWED_ACE   )Ace)-&gt;SidStart, FALSE, Restricted ) ) {
01382 
01383                    <span class="comment">// Optimize 'normal' case</span>
01384                    <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01385                        LocalTypeList-&gt;Remaining &amp;= ~((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask;
01386                    } <span class="keywordflow">else</span> {
01387                        <span class="comment">//</span>
01388                        <span class="comment">// The zeroeth object type represents the object itself.</span>
01389                        <span class="comment">//</span>
01390                        <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01391                             LocalTypeList,          <span class="comment">// List to modify</span>
01392                             LocalTypeListLength,    <span class="comment">// Length of list</span>
01393                             0,                      <span class="comment">// Element to update</span>
01394                             ((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01395                             UpdateRemaining );
01396                    }
01397 
01398                }
01399 
01400 
01401             <span class="comment">//</span>
01402             <span class="comment">// Handle an object specific Access Allowed ACE</span>
01403             <span class="comment">//</span>
01404             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_OBJECT_ACE_TYPE) ) {
01405                 GUID *ObjectTypeInAce;
01406 
01407                 <span class="comment">//</span>
01408                 <span class="comment">// If no object type is in the ACE,</span>
01409                 <span class="comment">//  treat this as an ACCESS_ALLOWED_ACE.</span>
01410                 <span class="comment">//</span>
01411 
01412                 ObjectTypeInAce = RtlObjectAceObjectType(Ace);
01413 
01414                 <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01415 
01416                     <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), FALSE, Restricted ) ) {
01417 
01418                        <span class="comment">// Optimize 'normal' case</span>
01419                        <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01420                            LocalTypeList-&gt;Remaining &amp;= ~((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask;
01421                        } <span class="keywordflow">else</span> {
01422                            <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01423                                 LocalTypeList,          <span class="comment">// List to modify</span>
01424                                 LocalTypeListLength,    <span class="comment">// Length of list</span>
01425                                 0,                      <span class="comment">// Element to update</span>
01426                                 ((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01427                                 UpdateRemaining );
01428                        }
01429                     }
01430 
01431                 <span class="comment">//</span>
01432                 <span class="comment">// If no object type list was passed,</span>
01433                 <span class="comment">//  don't grant access to anyone.</span>
01434                 <span class="comment">//</span>
01435 
01436                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
01437 
01438                     <span class="comment">// Drop through</span>
01439 
01440 
01441                <span class="comment">//</span>
01442                <span class="comment">// If an object type is in the ACE,</span>
01443                <span class="comment">//   Find it in the LocalTypeList before using the ACE.</span>
01444                <span class="comment">//</span>
01445                } <span class="keywordflow">else</span> {
01446 
01447                     <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), FALSE, Restricted ) ) {
01448 
01449                         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
01450                                                   LocalTypeList,
01451                                                   LocalTypeListLength,
01452                                                   &amp;Index ) ) {
01453                             <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01454                                  LocalTypeList,          <span class="comment">// List to modify</span>
01455                                  LocalTypeListLength,   <span class="comment">// Length of list</span>
01456                                  Index,                  <span class="comment">// Element already updated</span>
01457                                  ((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01458                                  UpdateRemaining );
01459                         }
01460                     }
01461                }
01462 
01463 
01464             <span class="comment">//</span>
01465             <span class="comment">// Handle a compound Access Allowed ACE</span>
01466             <span class="comment">//</span>
01467 
01468             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_COMPOUND_ACE_TYPE) ) {
01469 
01470                 <span class="comment">//</span>
01471                 <span class="comment">// See comment in MAXIMUM_ALLOWED case as to why we can use EToken here</span>
01472                 <span class="comment">// for the client.</span>
01473                 <span class="comment">//</span>
01474 
01475                 <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>(EToken, PrincipalSelfSid, RtlCompoundAceClientSid( Ace ), FALSE, Restricted) &amp;&amp;
01476                      <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>(PrimaryToken, NULL, RtlCompoundAceServerSid( Ace ), FALSE, Restricted) ) {
01477 
01478                     <span class="comment">// Optimize 'normal' case</span>
01479                     <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01480                         LocalTypeList-&gt;Remaining &amp;= ~((PCOMPOUND_ACCESS_ALLOWED_ACE)Ace)-&gt;Mask;
01481                     } <span class="keywordflow">else</span> {
01482                         <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01483                              LocalTypeList,          <span class="comment">// List to modify</span>
01484                              LocalTypeListLength,    <span class="comment">// Length of list</span>
01485                              0,                      <span class="comment">// Element to update</span>
01486                              ((PCOMPOUND_ACCESS_ALLOWED_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01487                              UpdateRemaining );
01488                     }
01489                 }
01490 
01491 
01492 
01493             <span class="comment">//</span>
01494             <span class="comment">// Handle an Access Denied ACE</span>
01495             <span class="comment">//</span>
01496 
01497             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_ACE_TYPE) ) {
01498 
01499                 <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, &amp;((PACCESS_DENIED_ACE)Ace)-&gt;SidStart, TRUE, Restricted ) ) {
01500 
01501                     <span class="comment">//</span>
01502                     <span class="comment">// The zeroeth element represents the object itself.</span>
01503                     <span class="comment">//  Just check that element.</span>
01504                     <span class="comment">//</span>
01505                     <span class="keywordflow">if</span> (LocalTypeList-&gt;Remaining &amp; ((PACCESS_DENIED_ACE)Ace)-&gt;Mask) {
01506 
01507                         <span class="keywordflow">break</span>;
01508                     }
01509                 }
01510 
01511 
01512             <span class="comment">//</span>
01513             <span class="comment">// Handle an object specific Access Denied ACE</span>
01514             <span class="comment">//</span>
01515             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_OBJECT_ACE_TYPE) ) {
01516 
01517                 <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), TRUE, Restricted ) ) {
01518                     GUID *ObjectTypeInAce;
01519 
01520                     <span class="comment">//</span>
01521                     <span class="comment">// If there is no object type in the ACE,</span>
01522                     <span class="comment">//  or if the caller didn't specify an object type list,</span>
01523                     <span class="comment">//  apply this deny ACE to the entire object.</span>
01524                     <span class="comment">//</span>
01525 
01526                     ObjectTypeInAce = RtlObjectAceObjectType(Ace);
01527                     <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01528                          ObjectTypeListLength == 0 ) {
01529 
01530                         <span class="comment">//</span>
01531                         <span class="comment">// The zeroeth element represents the object itself.</span>
01532                         <span class="comment">//  Just check that element.</span>
01533                         <span class="comment">//</span>
01534                         <span class="keywordflow">if</span> (LocalTypeList-&gt;Remaining &amp; ((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask) {
01535                             <span class="keywordflow">break</span>;
01536                         }
01537 
01538                     <span class="comment">//</span>
01539                     <span class="comment">// Otherwise apply the deny ACE to the object specified</span>
01540                     <span class="comment">//  in the ACE.</span>
01541                     <span class="comment">//</span>
01542 
01543                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
01544                                                   LocalTypeList,
01545                                                   LocalTypeListLength,
01546                                                   &amp;Index ) ) {
01547 
01548                         <span class="keywordflow">if</span> (LocalTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Remaining &amp; ((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask) {
01549                             <span class="keywordflow">break</span>;
01550                         }
01551 
01552                     }
01553                }
01554             }
01555 
01556         }
01557     }
01558 
01559 
01560 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="accessck.c::SepObjectInTypeList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepObjectInTypeList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN GUID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l00388">388</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l01564">SepAccessCheck()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04257">SepExamineSaclEx()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00992">SepMaximumAccessCheck()</a>, and <a class="el" href="../../d1/d3/accessck_8c-source.html#l01304">SepNormalAccessCheck()</a>.
<p>
<pre class="fragment"><div>00396                    :
00397 
00398     This routine searches an ObjectTypeList to determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00399     object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
00400 
00401 Arguments:
00402 
00403     ObjectType - Object Type to search <span class="keywordflow">for</span>.
00404 
00405     ObjectTypeList - The object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list to search.
00406 
00407     ObjectTypeListLength - Number of elements in ObjectTypeList
00408 
00409     ReturnedIndex - <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> element ObjectType was found in
00410 
00411 
00412 Return Value:
00413 
00414     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>: ObjectType was found in list.
00415     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>: ObjectType was not found in list.
00416 
00417 --*/
00418 
00419 {
00420     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00421     GUID *LocalObjectType;
00422 
00423     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00424 
00425     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(GUID) == <span class="keyword">sizeof</span>(ULONG) * 4 );
00426     <span class="keywordflow">for</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>&lt;ObjectTypeListLength; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
00427 
00428         LocalObjectType = &amp;ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].ObjectType;
00429 
00430         <span class="keywordflow">if</span>  ( RtlpIsEqualGuid( ObjectType, LocalObjectType ) ) {
00431             *ReturnedIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00432             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00433         }
00434     }
00435 
00436     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00437 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="accessck.c::SePrivilegePolicyCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SePrivilegePolicyCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingDesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviouslyGrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACCESS_TOKEN ExplicitToken&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPRIVILEGE_SET *&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeSet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l03652">3652</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00226">ANYSIZE_ARRAY</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00143">SepSinglePrivilegeCheck()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01676">SeSecurityPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01677">SeTakeOwnershipPrivilege</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>.
<p>
<pre class="fragment"><div>03663                    :
03664 
03665     This routine implements privilege policy by examining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bits in
03666     a DesiredAccess mask and adjusting them based on privilege checks.
03667 
03668     Currently, a request <span class="keywordflow">for</span> ACCESS_SYSTEM_SECURITY may <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be satisfied
03669     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller having <a class="code" href="../../d0/d5/se_8h.html#a85">SeSecurityPrivilege</a>.  WRITE_OWNER may optionally
03670     be satisfied via <a class="code" href="../../d0/d5/se_8h.html#a86">SeTakeOwnershipPrivilege</a>.
03671 
03672 Arguments:
03673 
03674     RemainingDesiredAccess - The desired access <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current operation.
03675         Bits may be cleared in <span class="keyword">this</span> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject has particular privileges.
03676 
03677     PreviouslyGrantedAccess - Supplies an access mask describing any
03678         accesses that have already been granted.  Bits may be set in
03679         here as a result of privilge checks.
03680 
03681     SubjectSecurityContext - Optionally provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject's security
03682         context.
03683 
03684     ExplicitToken - Optionally provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to be examined.
03685 
03686     PrivilegeSet - Supplies a pointer to a location in which will be
03687         returned a pointer to a privilege set.
03688 
03689     PreviousMode - The previous processor mode.
03690 
03691 Return Value:
03692 
03693     STATUS_SUCCESS - Any access requests that could be satisfied via
03694         privileges were done.
03695 
03696     STATUS_PRIVILEGE_NOT_HELD - An access <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> was being requested that
03697         requires a privilege, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current subject did not have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03698         privilege.
03699 
03700 
03701 
03702 --*/
03703 
03704 {
03705     BOOLEAN Success;
03706     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
03707     BOOLEAN WriteOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03708     BOOLEAN SystemSecurity = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03709     ULONG PrivilegeNumber = 0;
03710     ULONG PrivilegeCount = 0;
03711     ULONG SizeRequired;
03712 
03713     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03714 
03715     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( SubjectSecurityContext )) {
03716 
03717         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext );
03718 
03719     } <span class="keywordflow">else</span> {
03720 
03721         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)ExplicitToken;
03722     }
03723 
03724 
03725     <span class="keywordflow">if</span> (*RemainingDesiredAccess &amp; ACCESS_SYSTEM_SECURITY) {
03726 
03727         Success = <a class="code" href="../../d6/d6/sep_8h.html#a49">SepSinglePrivilegeCheck</a> (
03728                     SeSecurityPrivilege,
03729                     Token,
03730                     PreviousMode
03731                     );
03732 
03733         <span class="keywordflow">if</span> (!Success) {
03734 
03735             <span class="keywordflow">return</span>( STATUS_PRIVILEGE_NOT_HELD );
03736         }
03737 
03738         PrivilegeCount++;
03739         SystemSecurity = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03740 
03741         *RemainingDesiredAccess &amp;= ~ACCESS_SYSTEM_SECURITY;
03742         *PreviouslyGrantedAccess |= ACCESS_SYSTEM_SECURITY;
03743     }
03744 
03745     <span class="keywordflow">if</span> (*RemainingDesiredAccess &amp; WRITE_OWNER) {
03746 
03747         Success = <a class="code" href="../../d6/d6/sep_8h.html#a49">SepSinglePrivilegeCheck</a> (
03748                     SeTakeOwnershipPrivilege,
03749                     Token,
03750                     PreviousMode
03751                     );
03752 
03753         <span class="keywordflow">if</span> (Success) {
03754 
03755             PrivilegeCount++;
03756             WriteOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03757 
03758             *RemainingDesiredAccess &amp;= ~WRITE_OWNER;
03759             *PreviouslyGrantedAccess |= WRITE_OWNER;
03760 
03761         }
03762     }
03763 
03764     <span class="keywordflow">if</span> (PrivilegeCount &gt; 0) {
03765         SizeRequired = <span class="keyword">sizeof</span>(PRIVILEGE_SET) +
03766                         (PrivilegeCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>) *
03767                         (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES);
03768 
03769         *PrivilegeSet = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, SizeRequired, 'rPeS' );
03770 
03771         <span class="keywordflow">if</span> ( *PrivilegeSet == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03772             <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
03773         }
03774 
03775         (*PrivilegeSet)-&gt;PrivilegeCount = PrivilegeCount;
03776         (*PrivilegeSet)-&gt;Control = 0;
03777 
03778         <span class="keywordflow">if</span> (WriteOwner) {
03779             (*PrivilegeSet)-&gt;Privilege[PrivilegeNumber].Luid = <a class="code" href="../../d0/d5/se_8h.html#a86">SeTakeOwnershipPrivilege</a>;
03780             (*PrivilegeSet)-&gt;Privilege[PrivilegeNumber].Attributes = SE_PRIVILEGE_USED_FOR_ACCESS;
03781             PrivilegeNumber++;
03782         }
03783 
03784         <span class="keywordflow">if</span> (SystemSecurity) {
03785             (*PrivilegeSet)-&gt;Privilege[PrivilegeNumber].Luid = <a class="code" href="../../d0/d5/se_8h.html#a85">SeSecurityPrivilege</a>;
03786             (*PrivilegeSet)-&gt;Privilege[PrivilegeNumber].Attributes = SE_PRIVILEGE_USED_FOR_ACCESS;
03787         }
03788     }
03789 
03790     <span class="keywordflow">return</span>( STATUS_SUCCESS );
03791 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="accessck.c::SeProxyAccessCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SeProxyAccessCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Volume</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RelativePath</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ContainerObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SubjectSecurityContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SubjectContextLocked</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviouslyGrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPRIVILEGE_SET *Privileges&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l03564">3564</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>.
<p>
<pre class="fragment"><div>03582                    :
03583 
03584 
03585 Arguments:
03586 
03587     Volume - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume information of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> being opened.
03588 
03589     RelativePath - The volume-relative <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> being opened.  The full <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03590         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RelativePath appended to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Volume string.
03591 
03592     ContainerObject - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to a container object (TRUE), or a leaf object (FALSE).
03593 
03594     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor protecting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03595          object being accessed
03596 
03597     SubjectSecurityContext - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject's captured security
03598          context
03599 
03600     SubjectContextLocked - Supplies a flag indiciating whether or not
03601         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's subject context <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked, so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not have
03602         to be locked again.
03603 
03604     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mask that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> attempting to
03605          acquire
03606 
03607     PreviouslyGrantedAccess - Supplies any accesses that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user has
03608         already been granted, <span class="keywordflow">for</span> example, as a result of holding a
03609         privilege.
03610 
03611     Privileges - Supplies a pointer in which will be returned a privilege
03612         set indicating any privileges that were used as part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03613         access validation.
03614 
03615     GenericMapping - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping associated with <span class="keyword">this</span>
03616         object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
03617 
03618     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mode to be used in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
03619 
03620     GrantedAccess - Pointer to a returned access mask indicatating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03621          granted access
03622 
03623     AccessStatus - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value that may be returned indicating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03624          <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> why access was denied.  Routines should avoid hardcoding a
03625          <span class="keywordflow">return</span> value of STATUS_ACCESS_DENIED so that a different value can
03626          be returned when mandatory access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> implemented.
03627 
03628 
03629 Return Value:
03630 
03631     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
03632 
03633 --*/
03634 
03635 {
03636     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a> (
03637                 SecurityDescriptor,
03638                 SubjectSecurityContext,
03639                 SubjectContextLocked,
03640                 DesiredAccess,
03641                 PreviouslyGrantedAccess,
03642                 Privileges,
03643                 GenericMapping,
03644                 AccessMode,
03645                 GrantedAccess,
03646                 AccessStatus
03647                );
03648 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="accessck.c::SepSidInToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepSidInToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>AToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrincipalSelfSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DenyAce</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l00733">733</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00995">SepDumpTokenInfo()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01615">SePrincipalSelfSid</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l01564">SepAccessCheck()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03952">SepExamineSacl()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04257">SepExamineSaclEx()</a>, and <a class="el" href="../../d1/d3/accessck_8c-source.html#l03796">SepTokenIsOwner()</a>.
<p>
<pre class="fragment"><div>00742                    :
00743 
00744     Checks to see <span class="keywordflow">if</span> a given SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given token.
00745 
00746     N.B. The code to compute <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of a SID and test <span class="keywordflow">for</span> equality
00747          <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> duplicated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security runtime since <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> such a
00748          frequently used routine.
00749 
00750 Arguments:
00751 
00752     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to be examined
00753 
00754     PrincipalSelfSid - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being access checked <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an object which
00755         represents a principal (e.g., a user object), <span class="keyword">this</span> parameter should
00756         be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  Any ACE containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> constant
00757         PRINCIPAL_SELF_SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> replaced by <span class="keyword">this</span> SID.
00758 
00759         The parameter should be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object does not represent a principal.
00760 
00761 
00762     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of interest
00763 
00764 Return Value:
00765 
00766     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00767     otherwise.
00768 
00769 --*/
00770 
00771 {
00772 
00773     ULONG i;
00774     PISID MatchSid;
00775     ULONG SidLength;
00776     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00777     PSID_AND_ATTRIBUTES TokenSid;
00778     ULONG UserAndGroupCount;
00779 
00780     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00781 
00782 <span class="preprocessor">#if DBG</span>
00783 <span class="preprocessor"></span>
00784     <a class="code" href="../../d6/d6/sep_8h.html#a59">SepDumpTokenInfo</a>(AToken);
00785 
00786 <span class="preprocessor">#endif</span>
00787 <span class="preprocessor"></span>
00788     <span class="comment">//</span>
00789     <span class="comment">// If Sid is the constant PrincipalSelfSid,</span>
00790     <span class="comment">//  replace it with the passed in PrincipalSelfSid.</span>
00791     <span class="comment">//</span>
00792 
00793     <span class="keywordflow">if</span> ( PrincipalSelfSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00794          <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SePrincipalSelfSid, Sid ) ) {
00795         Sid = PrincipalSelfSid;
00796     }
00797 
00798     <span class="comment">//</span>
00799     <span class="comment">// Get the length of the source SID since this only needs to be computed</span>
00800     <span class="comment">// once.</span>
00801     <span class="comment">//</span>
00802 
00803     SidLength = 8 + (4 * ((PISID)Sid)-&gt;SubAuthorityCount);
00804 
00805     <span class="comment">//</span>
00806     <span class="comment">// Get address of user/group array and number of user/groups.</span>
00807     <span class="comment">//</span>
00808 
00809     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)AToken;
00810     TokenSid = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups;
00811     UserAndGroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount;
00812 
00813     <span class="comment">//</span>
00814     <span class="comment">// Scan through the user/groups and attempt to find a match with the</span>
00815     <span class="comment">// specified SID.</span>
00816     <span class="comment">//</span>
00817 
00818     <span class="keywordflow">for</span> (i = 0 ; i &lt; UserAndGroupCount ; i += 1) {
00819         MatchSid = (PISID)TokenSid-&gt;Sid;
00820 
00821         <span class="comment">//</span>
00822         <span class="comment">// If the SID revision and length matches, then compare the SIDs</span>
00823         <span class="comment">// for equality.</span>
00824         <span class="comment">//</span>
00825 
00826         <span class="keywordflow">if</span> ((((PISID)Sid)-&gt;Revision == MatchSid-&gt;Revision) &amp;&amp;
00827             (SidLength == (8 + (4 * (ULONG)MatchSid-&gt;SubAuthorityCount)))) {
00828             <span class="keywordflow">if</span> (RtlEqualMemory(Sid, MatchSid, SidLength)) {
00829 
00830                 <span class="comment">//</span>
00831                 <span class="comment">// If this is the first one in the list, then it is the User,</span>
00832                 <span class="comment">// and return success immediately.</span>
00833                 <span class="comment">//</span>
00834                 <span class="comment">// If this is not the first one, then it represents a group,</span>
00835                 <span class="comment">// and we must make sure the group is currently enabled before</span>
00836                 <span class="comment">// we can say that the group is "in" the token.</span>
00837                 <span class="comment">//</span>
00838 
00839                 <span class="keywordflow">if</span> ((i == 0) || (TokenSid-&gt;Attributes &amp; SE_GROUP_ENABLED) ||
00840                     (DenyAce &amp;&amp; (TokenSid-&gt;Attributes &amp; SE_GROUP_USE_FOR_DENY_ONLY))) {
00841                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00842 
00843                 } <span class="keywordflow">else</span> {
00844                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00845                 }
00846             }
00847         }
00848 
00849         TokenSid += 1;
00850     }
00851 
00852     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00853 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="accessck.c::SepSidInTokenEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepSidInTokenEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>AToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrincipalSelfSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DenyAce</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Restricted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l00856">856</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00995">SepDumpTokenInfo()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01615">SePrincipalSelfSid</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l00992">SepMaximumAccessCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l01304">SepNormalAccessCheck()</a>, and <a class="el" href="../../d1/d3/accessck_8c-source.html#l03796">SepTokenIsOwner()</a>.
<p>
<pre class="fragment"><div>00866                    :
00867 
00868     Checks to see <span class="keywordflow">if</span> a given restricted SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given token.
00869 
00870     N.B. The code to compute <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of a SID and test <span class="keywordflow">for</span> equality
00871          <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> duplicated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security runtime since <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> such a
00872          frequently used routine.
00873 
00874 Arguments:
00875 
00876     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to be examined
00877 
00878     PrincipalSelfSid - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being access checked <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an object which
00879         represents a principal (e.g., a user object), <span class="keyword">this</span> parameter should
00880         be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  Any ACE containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> constant
00881         PRINCIPAL_SELF_SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> replaced by <span class="keyword">this</span> SID.
00882 
00883         The parameter should be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object does not represent a principal.
00884 
00885 
00886     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of interest
00887 
00888     DenyAce - The ACE being evaluated <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a DENY or ACCESS DENIED ace
00889 
00890     <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> - The access check being performed uses <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restricted sids.
00891 
00892 Return Value:
00893 
00894     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00895     otherwise.
00896 
00897 --*/
00898 
00899 {
00900 
00901     ULONG i;
00902     PISID MatchSid;
00903     ULONG SidLength;
00904     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00905     PSID_AND_ATTRIBUTES TokenSid;
00906     ULONG UserAndGroupCount;
00907 
00908     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00909 
00910 <span class="preprocessor">#if DBG</span>
00911 <span class="preprocessor"></span>
00912     <a class="code" href="../../d6/d6/sep_8h.html#a59">SepDumpTokenInfo</a>(AToken);
00913 
00914 <span class="preprocessor">#endif</span>
00915 <span class="preprocessor"></span>
00916     <span class="comment">//</span>
00917     <span class="comment">// If Sid is the constant PrincipalSelfSid,</span>
00918     <span class="comment">//  replace it with the passed in PrincipalSelfSid.</span>
00919     <span class="comment">//</span>
00920 
00921     <span class="keywordflow">if</span> ( PrincipalSelfSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00922          <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SePrincipalSelfSid, Sid ) ) {
00923         Sid = PrincipalSelfSid;
00924     }
00925 
00926     <span class="comment">//</span>
00927     <span class="comment">// Get the length of the source SID since this only needs to be computed</span>
00928     <span class="comment">// once.</span>
00929     <span class="comment">//</span>
00930 
00931     SidLength = 8 + (4 * ((PISID)Sid)-&gt;SubAuthorityCount);
00932 
00933     <span class="comment">//</span>
00934     <span class="comment">// Get address of user/group array and number of user/groups.</span>
00935     <span class="comment">//</span>
00936 
00937     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)AToken;
00938     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>) {
00939         TokenSid = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSids;
00940         UserAndGroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSidCount;
00941     } <span class="keywordflow">else</span> {
00942         TokenSid = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups;
00943         UserAndGroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount;
00944     }
00945 
00946     <span class="comment">//</span>
00947     <span class="comment">// Scan through the user/groups and attempt to find a match with the</span>
00948     <span class="comment">// specified SID.</span>
00949     <span class="comment">//</span>
00950 
00951     <span class="keywordflow">for</span> (i = 0; i &lt; UserAndGroupCount ; i += 1) {
00952         MatchSid = (PISID)TokenSid-&gt;Sid;
00953 
00954         <span class="comment">//</span>
00955         <span class="comment">// If the SID revision and length matches, then compare the SIDs</span>
00956         <span class="comment">// for equality.</span>
00957         <span class="comment">//</span>
00958 
00959         <span class="keywordflow">if</span> ((((PISID)Sid)-&gt;Revision == MatchSid-&gt;Revision) &amp;&amp;
00960             (SidLength == (8 + (4 * (ULONG)MatchSid-&gt;SubAuthorityCount)))) {
00961             <span class="keywordflow">if</span> (RtlEqualMemory(Sid, MatchSid, SidLength)) {
00962 
00963                 <span class="comment">//</span>
00964                 <span class="comment">// If this is the first one in the list and not deny-only it</span>
00965                 <span class="comment">// is not a restricted token then it is the User, and return</span>
00966                 <span class="comment">// success immediately.</span>
00967                 <span class="comment">//</span>
00968                 <span class="comment">// If this is not the first one, then it represents a group,</span>
00969                 <span class="comment">// and we must make sure the group is currently enabled before</span>
00970                 <span class="comment">// we can say that the group is "in" the token.</span>
00971                 <span class="comment">//</span>
00972 
00973                 <span class="keywordflow">if</span> ((!<a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> &amp;&amp; (i == 0) &amp;&amp; ((TokenSid-&gt;Attributes &amp; SE_GROUP_USE_FOR_DENY_ONLY) == 0)) ||
00974                     (TokenSid-&gt;Attributes &amp; SE_GROUP_ENABLED) ||
00975                     (DenyAce &amp;&amp; (TokenSid-&gt;Attributes &amp; SE_GROUP_USE_FOR_DENY_ONLY))) {
00976                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00977 
00978                 } <span class="keywordflow">else</span> {
00979                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00980                 }
00981 
00982             }
00983         }
00984 
00985         TokenSid += 1;
00986     }
00987 
00988     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00989 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="accessck.c::SepTokenIsOwner" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepTokenIsOwner           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>EffectiveToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenLocked</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l03796">3796</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00159">Owner</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00733">SepSidInToken()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00856">SepSidInTokenEx()</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00076">TOKEN_IS_RESTRICTED</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>.
<p>
<pre class="fragment"><div>03804                    :
03805 
03806     This routine will determine of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed security descriptor
03807     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed token. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> restricted <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> cannot be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03808     owner.
03809 
03810 
03811 Arguments:
03812 
03813     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - The token representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current user.
03814 
03815     SecurityDescriptor - The security descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being
03816         accessed.
03817 
03818     TokenLocked - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> describing whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has taken
03819         a read lock <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
03820 
03821 
03822 Return Value:
03823 
03824     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The user of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
03825 
03826     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - The user of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
03827 
03828 --*/
03829 
03830 {
03831     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
03832     BOOLEAN rc;
03833 
03834     PISECURITY_DESCRIPTOR ISecurityDescriptor;
03835     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
03836 
03837     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03838 
03839     ISecurityDescriptor = (PISECURITY_DESCRIPTOR)SecurityDescriptor;
03840     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>;
03841 
03842     <span class="keywordflow">if</span> (!TokenLocked) {
03843         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
03844     }
03845 
03846     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = RtlpOwnerAddrSecurityDescriptor( ISecurityDescriptor );
03847     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Owner != NULL );
03848 
03849     rc = <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( Token, NULL, Owner, FALSE );
03850 
03851     <span class="comment">//</span>
03852     <span class="comment">// For restricted tokens, check the restricted sids too.</span>
03853     <span class="comment">//</span>
03854 
03855     <span class="keywordflow">if</span> (rc &amp;&amp; (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags &amp; <a class="code" href="../../d0/d5/se_8h.html#a5">TOKEN_IS_RESTRICTED</a>) != 0) {
03856         rc = <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( Token, NULL, Owner, FALSE, TRUE );
03857 
03858     }
03859 
03860     <span class="keywordflow">if</span> (!TokenLocked) {
03861         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
03862     }
03863 
03864     <span class="keywordflow">return</span>( rc );
03865 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="accessck.c::SepUpdateParentTypeList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepUpdateParentTypeList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StartIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l00441">441</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l00574">SepAddAccessTypeList()</a>.
<p>
<pre class="fragment"><div>00448                    :
00449 
00450     Update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Access fields of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified object.
00451 
00452 
00453         The <span class="stringliteral">"remaining"</span> field of a parent object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logical OR of
00454         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining field of all of its children.
00455 
00456         The CurrentGranted field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> collection of bits
00457         granted to every one of its children..
00458 
00459         The CurrentDenied fields of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logical OR of
00460         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bits denied to any of its children.
00461 
00462     This routine takes an index to one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> children and updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00463     remaining field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent (and grandparents recursively).
00464 
00465 Arguments:
00466 
00467     ObjectTypeList - The object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list to update.
00468 
00469     ObjectTypeListLength - Number of elements in ObjectTypeList
00470 
00471     StartIndex - <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"child"</span> element whose parents are to be updated.
00472 
00473 Return Value:
00474 
00475     None.
00476 
00477 
00478 --*/
00479 
00480 {
00481     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00482     ULONG ParentIndex;
00483     ULONG Level;
00484     ACCESS_MASK NewRemaining = 0;
00485     ACCESS_MASK NewCurrentGranted = 0xFFFFFFFF;
00486     ACCESS_MASK NewCurrentDenied = 0;
00487 
00488     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00489 
00490     <span class="comment">//</span>
00491     <span class="comment">// If the target node is at the root,</span>
00492     <span class="comment">//  we're all done.</span>
00493     <span class="comment">//</span>
00494 
00495     <span class="keywordflow">if</span> ( ObjectTypeList[StartIndex].ParentIndex == -1 ) {
00496         <span class="keywordflow">return</span>;
00497     }
00498 
00499     <span class="comment">//</span>
00500     <span class="comment">// Get the index to the parent that needs updating and the level of</span>
00501     <span class="comment">// the siblings.</span>
00502     <span class="comment">//</span>
00503 
00504     ParentIndex = ObjectTypeList[StartIndex].ParentIndex;
00505     Level = ObjectTypeList[StartIndex].Level;
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// Loop through all the children.</span>
00509     <span class="comment">//</span>
00510 
00511     <span class="keywordflow">for</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=ParentIndex+1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>&lt;ObjectTypeListLength; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
00512 
00513         <span class="comment">//</span>
00514         <span class="comment">// By definition, the children of an object are all those entries</span>
00515         <span class="comment">// immediately following the target.  The list of children (or</span>
00516         <span class="comment">// grandchildren) stops as soon as we reach an entry the has the</span>
00517         <span class="comment">// same level as the target (a sibling) or lower than the target</span>
00518         <span class="comment">// (an uncle).</span>
00519         <span class="comment">//</span>
00520 
00521         <span class="keywordflow">if</span> ( ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Level &lt;= ObjectTypeList[ParentIndex].Level ) {
00522             <span class="keywordflow">break</span>;
00523         }
00524 
00525         <span class="comment">//</span>
00526         <span class="comment">// Only handle direct children of the parent.</span>
00527         <span class="comment">//</span>
00528 
00529         <span class="keywordflow">if</span> ( ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Level != Level ) {
00530             <span class="keywordflow">continue</span>;
00531         }
00532 
00533         <span class="comment">//</span>
00534         <span class="comment">// Compute the new bits for the parent.</span>
00535         <span class="comment">//</span>
00536 
00537         NewRemaining |= ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Remaining;
00538         NewCurrentGranted &amp;= ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].CurrentGranted;
00539         NewCurrentDenied |= ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].CurrentDenied;
00540 
00541     }
00542 
00543     <span class="comment">//</span>
00544     <span class="comment">// If we've not changed the access to the parent,</span>
00545     <span class="comment">//  we're done.</span>
00546     <span class="comment">//</span>
00547 
00548     <span class="keywordflow">if</span> ( NewRemaining == ObjectTypeList[ParentIndex].Remaining &amp;&amp;
00549          NewCurrentGranted == ObjectTypeList[ParentIndex].CurrentGranted &amp;&amp;
00550         NewCurrentDenied == ObjectTypeList[ParentIndex].CurrentDenied ) {
00551         <span class="keywordflow">return</span>;
00552     }
00553 
00554 
00555     <span class="comment">//</span>
00556     <span class="comment">// Change the parent.</span>
00557     <span class="comment">//</span>
00558 
00559     ObjectTypeList[ParentIndex].Remaining = NewRemaining;
00560     ObjectTypeList[ParentIndex].CurrentGranted = NewCurrentGranted;
00561     ObjectTypeList[ParentIndex].CurrentDenied = NewCurrentDenied;
00562 
00563     <span class="comment">//</span>
00564     <span class="comment">// Go update the grand parents.</span>
00565     <span class="comment">//</span>
00566 
00567     <a class="code" href="../../d0/d4/accessck_8c.html#a3">SepUpdateParentTypeList</a>( ObjectTypeList,
00568                              ObjectTypeListLength,
00569                              ParentIndex );
00570 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:49 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
