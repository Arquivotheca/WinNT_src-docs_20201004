<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: edithive.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>edithive.c</h1><a href="../../d9/d4/edithive_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    edithive.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Provides functionality for dumping and editing registry hive files from</span>
00012 <span class="comment">    user-mode.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    John Vert (jvert) 26-Mar-1992</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 <span class="preprocessor">#include "<a class="code" href="../../d0/d5/edithive_8h.html">edithive.h</a>"</span>
00022 <span class="preprocessor">#include "nturtl.h"</span>
00023 
<a name="l00024"></a><a class="code" href="../../d9/d4/edithive_8c.html#a1">00024</a> <span class="keyword">extern</span> GENERIC_MAPPING <a class="code" href="../../d6/d3/cmwraper_8c.html#a3">CmpKeyMapping</a>;
<a name="l00025"></a><a class="code" href="../../d9/d4/edithive_8c.html#a2">00025</a> <span class="keyword">extern</span> LIST_ENTRY <a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>;            <span class="comment">// List of CMHIVEs</span>
00026 
<a name="l00027"></a><a class="code" href="../../d9/d4/edithive_8c.html#a0">00027</a> <span class="preprocessor">#define SECURITY_CELL_LENGTH(pDescriptor) \</span>
00028 <span class="preprocessor">    FIELD_OFFSET(CM_KEY_SECURITY,Descriptor) + \</span>
00029 <span class="preprocessor">    RtlLengthSecurityDescriptor(pDescriptor)</span>
00030 <span class="preprocessor"></span>
00031 
00032 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00033 <a class="code" href="../../d9/d4/edithive_8c.html#a3">EhpAttachSecurity</a>(
00034     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00035     IN HCELL_INDEX Cell
00036     );
00037 
00038 PVOID
00039 <a class="code" href="../../d9/d4/edithive_8c.html#a4">EhpAllocate</a>(
00040     ULONG   Size
00041     );
00042 
00043 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00044 <a class="code" href="../../d9/d4/edithive_8c.html#a5">EhpFree</a>(
00045     PVOID   MemoryBlock
00046     );
00047 
00048 BOOLEAN
00049 <a class="code" href="../../d9/d4/edithive_8c.html#a6">EhpFileRead</a> (
00050     HANDLE      FileHandle,
00051     PULONG      FileOffset,
00052     PVOID       DataBuffer,
00053     ULONG       DataLength
00054     );
00055 
00056 BOOLEAN
00057 <a class="code" href="../../d9/d4/edithive_8c.html#a7">EhpFileWrite</a>(
00058     HANDLE      FileHandle,
00059     PULONG      FileOffset,
00060     PVOID       DataBuffer,
00061     ULONG       DataLength
00062     );
00063 
00064 BOOLEAN
00065 <a class="code" href="../../d9/d4/edithive_8c.html#a8">EhpFileFlush</a> (
00066     HANDLE      FileHandle
00067     );
00068 
00069 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00070"></a><a class="code" href="../../d9/d4/edithive_8c.html#a9">00070</a> <a class="code" href="../../d9/d4/edithive_8c.html#a9">CmpGetObjectSecurity</a>(
00071     IN HCELL_INDEX Cell,
00072     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00073     OUT <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> *Security,
00074     OUT PHCELL_INDEX SecurityCell OPTIONAL
00075     )
00076 
00077 <span class="comment">/*++</span>
00078 <span class="comment"></span>
00079 <span class="comment">Routine Description:</span>
00080 <span class="comment"></span>
00081 <span class="comment">    This routine maps in the security cell of a registry object.</span>
00082 <span class="comment"></span>
00083 <span class="comment">Arguments:</span>
00084 <span class="comment"></span>
00085 <span class="comment">    Cell - Supplies the cell index of the object.</span>
00086 <span class="comment"></span>
00087 <span class="comment">    Hive - Supplies the hive the object's cell is in.</span>
00088 <span class="comment"></span>
00089 <span class="comment">    Security - Returns a pointer to the security cell of the object.</span>
00090 <span class="comment"></span>
00091 <span class="comment">    SecurityCell - Returns the index of the security cell</span>
00092 <span class="comment"></span>
00093 <span class="comment">Return Value:</span>
00094 <span class="comment"></span>
00095 <span class="comment">    NONE.</span>
00096 <span class="comment"></span>
00097 <span class="comment">--*/</span>
00098 
00099 {
00100     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CellIndex;
00101     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
00102 
00103     <span class="comment">//</span>
00104     <span class="comment">// Map the node we need to get the security descriptor for</span>
00105     <span class="comment">//</span>
00106     Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00107 
00108     CellIndex = Node-&gt;u1.s1.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>;
00109 
00110     <span class="comment">//</span>
00111     <span class="comment">// Map in the security descriptor cell</span>
00112     <span class="comment">//</span>
00113     *Security = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, CellIndex);
00114 
00115     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SecurityCell)) {
00116         *SecurityCell = CellIndex;
00117     }
00118 
00119     <span class="keywordflow">return</span>;
00120 }
00121 
00122 
00123 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00124"></a><a class="code" href="../../d0/d5/edithive_8h.html#a4">00124</a> <a class="code" href="../../d0/d5/edithive_8h.html#a4">EhCloseHive</a>(
00125     IN HANDLE HiveHandle
00126     )
00127 
00128 <span class="comment">/*++</span>
00129 <span class="comment"></span>
00130 <span class="comment">Routine Description:</span>
00131 <span class="comment"></span>
00132 <span class="comment">    Closes a hive, including writing all the data out to disk and freeing</span>
00133 <span class="comment">    the relevant structures.</span>
00134 <span class="comment"></span>
00135 <span class="comment">Arguments:</span>
00136 <span class="comment"></span>
00137 <span class="comment">    HiveHandle - Supplies a handle to the hive control structure</span>
00138 <span class="comment"></span>
00139 <span class="comment">Return Value:</span>
00140 <span class="comment"></span>
00141 <span class="comment">    None.</span>
00142 <span class="comment"></span>
00143 <span class="comment">--*/</span>
00144 
00145 {
00146     <a class="code" href="../../d0/d2/hivesync_8c.html#a13">HvSyncHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)HiveHandle);
00147     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)HiveHandle)-&gt;FileHandles[<a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>]);
00148     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)HiveHandle)-&gt;FileHandles[<a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>]);
00149     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)HiveHandle)-&gt;FileHandles[<a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>]);
00150     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)HiveHandle, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
00151 
00152 }
00153 
00154 
00155 HANDLE
<a name="l00156"></a><a class="code" href="../../d9/d4/edithive_8c.html#a11">00156</a> <a class="code" href="../../d0/d5/edithive_8h.html#a3">EhOpenHive</a>(
00157     IN PUNICODE_STRING FileName,
00158     OUT PHANDLE RootHandle,
00159     IN PUNICODE_STRING RootName,
00160     IN ULONG HiveType
00161     )
00162 
00163 <span class="comment">/*++</span>
00164 <span class="comment"></span>
00165 <span class="comment">Routine Description:</span>
00166 <span class="comment"></span>
00167 <span class="comment">    Opens an existing hive.  If the filename does not exist it will be</span>
00168 <span class="comment">    created.</span>
00169 <span class="comment"></span>
00170 <span class="comment">    WARNING:    Allocate FileName large enough to acomodate .log or</span>
00171 <span class="comment">                .alt extension.</span>
00172 <span class="comment"></span>
00173 <span class="comment">Arguments:</span>
00174 <span class="comment"></span>
00175 <span class="comment">    FileName - Supplies the NULL-terminated filename to open as a hive.</span>
00176 <span class="comment"></span>
00177 <span class="comment">    HiveType - TYPE_SIMPLE = no log or alternate</span>
00178 <span class="comment">               TYPE_LOG = log</span>
00179 <span class="comment">               TYPE_ALT = alternate</span>
00180 <span class="comment"></span>
00181 <span class="comment">Return Value:</span>
00182 <span class="comment"></span>
00183 <span class="comment">    != NULL - Handle to the opened hive.</span>
00184 <span class="comment">    == NULL - Indicates file could not be opened.</span>
00185 <span class="comment"></span>
00186 <span class="comment">--*/</span>
00187 
00188 {
00189     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00190     HANDLE <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
00191     BOOLEAN Allocate;
00192     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00193     IO_STATUS_BLOCK IoStatus;
00194     ULONG CreateDisposition;
00195     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00196     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> RootNode;
00197     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00198     HANDLE  Primary;
00199     HANDLE  Log;
00200     HANDLE  Alt;
00201     ULONG   FileType;
00202     ULONG   Disposition;
00203     ULONG   SecondaryDisposition;
00204     ULONG   Operation;
00205 
00206     Alt = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00207     Log = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00208     InitializeListHead(&amp;<a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>);
00209 
00210     <span class="keywordflow">switch</span> (HiveType) {
00211     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/edithive_8h.html#a0">TYPE_SIMPLE</a>:
00212         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a290">CmpOpenHiveFiles</a>(
00213                     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
00214                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00215                     &amp;Primary,
00216                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00217                     &amp;Disposition,
00218                     &amp;SecondaryDisposition,
00219                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00220                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00221                     );
00222         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00223         {
00224             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00225         }
00226         FileType = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
00227         <span class="keywordflow">break</span>;
00228 
00229     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/edithive_8h.html#a1">TYPE_LOG</a>:
00230         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a290">CmpOpenHiveFiles</a>(
00231                     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
00232                     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">".log"</span>,
00233                     &amp;Primary,
00234                     &amp;Log,
00235                     &amp;Disposition,
00236                     &amp;SecondaryDisposition,
00237                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00238                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00239                     );
00240         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00241         {
00242             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00243         }
00244         <span class="keywordflow">if</span> (Log == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00245             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00246         }
00247         FileType = <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>;
00248         <span class="keywordflow">break</span>;
00249 
00250     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/edithive_8h.html#a2">TYPE_ALT</a>:
00251         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a290">CmpOpenHiveFiles</a>(
00252                     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
00253                     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">".alt"</span>,
00254                     &amp;Primary,
00255                     &amp;Alt,
00256                     &amp;Disposition,
00257                     &amp;SecondaryDisposition,
00258                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00259                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00260                     );
00261         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00262         {
00263             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00264         }
00265         <span class="keywordflow">if</span> (Alt == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00266             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00267         }
00268         FileType = <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>;
00269         <span class="keywordflow">break</span>;
00270 
00271     <span class="keywordflow">default</span>:
00272         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00273     }
00274 
00275     <span class="comment">//</span>
00276     <span class="comment">// Initialize hive</span>
00277     <span class="comment">//</span>
00278     <span class="keywordflow">if</span> (Disposition == FILE_CREATED) {
00279         Operation = <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>;
00280         Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00281     } <span class="keywordflow">else</span> {
00282         Operation = <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>;
00283         Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00284     }
00285 
00286     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(
00287                     &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00288                     Operation,
00289                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00290                     FileType,
00291                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00292                     Primary,
00293                     Alt,
00294                     Log,
00295                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00296                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00297                     ))
00298     {
00299         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00300     }
00301 
00302     <span class="keywordflow">if</span> (!Allocate) {
00303         *RootHandle = (HANDLE)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Hive.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>);
00304         RootNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(
00305                                 (<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Hive.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>);
00306         RootName-&gt;Length = RootName-&gt;MaximumLength = RootNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
00307         RootName-&gt;Buffer = RootNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>;
00308     } <span class="keywordflow">else</span> {
00309         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(RootName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"HiveRoot"</span>);
00310         *RootHandle = (HANDLE)<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00311         <a class="code" href="../../d0/d2/hivesync_8c.html#a13">HvSyncHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00312     }
00313 
00314 
00315     <span class="keywordflow">return</span>((HANDLE)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00316 }
00317 
00318 
00319 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00320"></a><a class="code" href="../../d0/d5/edithive_8h.html#a6">00320</a> <a class="code" href="../../d0/d5/edithive_8h.html#a6">EhEnumerateKey</a>(
00321     IN HANDLE HiveHandle,
00322     IN HANDLE CellHandle,
00323     IN ULONG Index,
00324     IN KEY_INFORMATION_CLASS KeyInformationClass,
00325     IN PVOID KeyInformation,
00326     IN ULONG Length,
00327     IN PULONG ResultLength
00328     )
00329 <span class="comment">/*++</span>
00330 <span class="comment"></span>
00331 <span class="comment">Routine Description:</span>
00332 <span class="comment"></span>
00333 <span class="comment">    Enumerate sub keys, return data on Index'th entry.</span>
00334 <span class="comment"></span>
00335 <span class="comment">    CmEnumerateKey returns the name of the Index'th sub key of the open</span>
00336 <span class="comment">    key specified.  The value STATUS_NO_MORE_ENTRIES will be</span>
00337 <span class="comment">    returned if value of Index is larger than the number of sub keys.</span>
00338 <span class="comment"></span>
00339 <span class="comment">    Note that Index is simply a way to select among child keys.  Two calls</span>
00340 <span class="comment">    to CmEnumerateKey with the same Index are NOT guaranteed to return</span>
00341 <span class="comment">    the same results.</span>
00342 <span class="comment"></span>
00343 <span class="comment">    If KeyInformation is not long enough to hold all requested data,</span>
00344 <span class="comment">    STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be</span>
00345 <span class="comment">    set to the number of bytes actually required.</span>
00346 <span class="comment"></span>
00347 <span class="comment">Arguments:</span>
00348 <span class="comment"></span>
00349 <span class="comment">    Hive - supplies a pointer to the hive control structure for the hive</span>
00350 <span class="comment"></span>
00351 <span class="comment">    Cell - supplies index of node to whose sub keys are to be found</span>
00352 <span class="comment"></span>
00353 <span class="comment">    Index - Specifies the (0-based) number of the sub key to be returned.</span>
00354 <span class="comment"></span>
00355 <span class="comment">    KeyInformationClass - Specifies the type of information returned in</span>
00356 <span class="comment">        Buffer.  One of the following types:</span>
00357 <span class="comment"></span>
00358 <span class="comment">        KeyBasicInformation - return last write time, title index, and name.</span>
00359 <span class="comment">            (see KEY_BASIC_INFORMATION structure)</span>
00360 <span class="comment"></span>
00361 <span class="comment">        KeyNodeInformation - return last write time, title index, name, class.</span>
00362 <span class="comment">            (see KEY_NODE_INFORMATION structure)</span>
00363 <span class="comment"></span>
00364 <span class="comment">    KeyInformation -Supplies pointer to buffer to receive the data.</span>
00365 <span class="comment"></span>
00366 <span class="comment">    Length - Length of KeyInformation in bytes.</span>
00367 <span class="comment"></span>
00368 <span class="comment">    ResultLength - Number of bytes actually written into KeyInformation.</span>
00369 <span class="comment"></span>
00370 <span class="comment">Return Value:</span>
00371 <span class="comment"></span>
00372 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00373 <span class="comment"></span>
00374 <span class="comment">        &lt;TBS&gt;</span>
00375 <span class="comment"></span>
00376 <span class="comment">--*/</span>
00377 {
00378     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>    <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00379 
00380     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.Signature = CM_KEY_CONTROL_BLOCK_SIGNATURE;
00381     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00382     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.KeyHive = &amp;((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)HiveHandle)-&gt;Hive;
00383     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.KeyCell = (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)CellHandle;
00384     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.RefCount = 1;
00385 
00386     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a226">CmEnumerateKey</a>(&amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
00387                           <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,
00388                           KeyInformationClass,
00389                           KeyInformation,
00390                           Length,
00391                           ResultLength));
00392 }
00393 
00394 
00395 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00396"></a><a class="code" href="../../d0/d5/edithive_8h.html#a5">00396</a> <a class="code" href="../../d0/d5/edithive_8h.html#a5">EhEnumerateValueKey</a>(
00397     IN HANDLE HiveHandle,
00398     IN HANDLE CellHandle,
00399     IN ULONG Index,
00400     IN KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass,
00401     IN PVOID KeyValueInformation,
00402     IN ULONG Length,
00403     IN PULONG ResultLength
00404     )
00405 <span class="comment">/*++</span>
00406 <span class="comment"></span>
00407 <span class="comment">Routine Description:</span>
00408 <span class="comment"></span>
00409 <span class="comment">    The value entries of an open key may be enumerated.</span>
00410 <span class="comment"></span>
00411 <span class="comment">    CmEnumerateValueKey returns the name of the Index'th value</span>
00412 <span class="comment">    entry of the open key specified by KeyHandle.  The value</span>
00413 <span class="comment">    STATUS_NO_MORE_ENTRIES will be returned if value of Index is</span>
00414 <span class="comment">    larger than the number of sub keys.</span>
00415 <span class="comment"></span>
00416 <span class="comment">    Note that Index is simply a way to select among value</span>
00417 <span class="comment">    entries.  Two calls to NtEnumerateValueKey with the same Index</span>
00418 <span class="comment">    are NOT guaranteed to return the same results.</span>
00419 <span class="comment"></span>
00420 <span class="comment">    If KeyValueInformation is not long enough to hold all requested data,</span>
00421 <span class="comment">    STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be</span>
00422 <span class="comment">    set to the number of bytes actually required.</span>
00423 <span class="comment"></span>
00424 <span class="comment">Arguments:</span>
00425 <span class="comment"></span>
00426 <span class="comment">    Hive - supplies a handle to the hive</span>
00427 <span class="comment"></span>
00428 <span class="comment">    Cell - supplies handle to node whose sub keys are to be found</span>
00429 <span class="comment"></span>
00430 <span class="comment">    Index - Specifies the (0-based) number of the sub key to be returned.</span>
00431 <span class="comment"></span>
00432 <span class="comment">    KeyValueInformationClass - Specifies the type of information returned</span>
00433 <span class="comment">    in Buffer. One of the following types:</span>
00434 <span class="comment"></span>
00435 <span class="comment">        KeyValueBasicInformation - return time of last write,</span>
00436 <span class="comment">            title index, and name.  (See KEY_VALUE_BASIC_INFORMATION)</span>
00437 <span class="comment"></span>
00438 <span class="comment">        KeyValueFullInformation - return time of last write,</span>
00439 <span class="comment">            title index, name, class.  (See KEY_VALUE_FULL_INFORMATION)</span>
00440 <span class="comment"></span>
00441 <span class="comment">    KeyValueInformation -Supplies pointer to buffer to receive the data.</span>
00442 <span class="comment"></span>
00443 <span class="comment">    Length - Length of KeyValueInformation in bytes.</span>
00444 <span class="comment"></span>
00445 <span class="comment">    ResultLength - Number of bytes actually written into KeyValueInformation.</span>
00446 <span class="comment"></span>
00447 <span class="comment">Return Value:</span>
00448 <span class="comment"></span>
00449 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00450 <span class="comment"></span>
00451 <span class="comment">        &lt;TBS&gt;</span>
00452 <span class="comment"></span>
00453 <span class="comment">--*/</span>
00454 {
00455     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>    <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00456 
00457     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.Signature = CM_KEY_CONTROL_BLOCK_SIGNATURE;
00458     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00459     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.KeyHive = (<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)&amp;(((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)HiveHandle)-&gt;Hive);
00460     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.KeyCell = (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)CellHandle;
00461     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.RefCount = 1;
00462 
00463     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a227">CmEnumerateValueKey</a>(&amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
00464                                <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,
00465                                KeyValueInformationClass,
00466                                KeyValueInformation,
00467                                Length,
00468                                ResultLength));
00469 }
00470 
00471 
00472 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00473"></a><a class="code" href="../../d9/d4/edithive_8c.html#a14">00473</a> <a class="code" href="../../d9/d4/edithive_8c.html#a14">EhOpenChildByNumber</a>(
00474     IN HANDLE HiveHandle,
00475     IN HANDLE CellHandle,
00476     IN ULONG  Index,
00477     IN NODE_TYPE   Type,
00478     OUT PHANDLE ChildCell
00479     )
00480 <span class="comment">/*++</span>
00481 <span class="comment"></span>
00482 <span class="comment">Routine Description:</span>
00483 <span class="comment"></span>
00484 <span class="comment">    Return the cell index of the Nth child cell.</span>
00485 <span class="comment"></span>
00486 <span class="comment">Arguments:</span>
00487 <span class="comment"></span>
00488 <span class="comment">    HiveHandle - handle of hive control structure for hive of interest</span>
00489 <span class="comment"></span>
00490 <span class="comment">    CellHandle - handle for parent cell</span>
00491 <span class="comment"></span>
00492 <span class="comment">    Index - number of desired child</span>
00493 <span class="comment"></span>
00494 <span class="comment">    Type - type of the child object</span>
00495 <span class="comment"></span>
00496 <span class="comment">    ChildCell - supplies a pointer to a variable to receive the</span>
00497 <span class="comment">                    HCELL_INDEX of the Index'th child.</span>
00498 <span class="comment"></span>
00499 <span class="comment">Return Value:</span>
00500 <span class="comment"></span>
00501 <span class="comment">    status</span>
00502 <span class="comment"></span>
00503 <span class="comment">--*/</span>
00504 {
00505     <span class="keywordflow">return</span>(CmpFindChildByNumber(&amp;((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)HiveHandle)-&gt;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00506                                 (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)CellHandle,
00507                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,
00508                                 Type,
00509                                 (<a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>)ChildCell));
00510 
00511 }
00512 
00513 
00514 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00515"></a><a class="code" href="../../d0/d5/edithive_8h.html#a11">00515</a> <a class="code" href="../../d0/d5/edithive_8h.html#a11">EhSetValueKey</a>(
00516     IN HANDLE HiveHandle,
00517     IN HANDLE CellHandle,
00518     IN PUNICODE_STRING ValueName,
00519     IN ULONG TitleIndex OPTIONAL,
00520     IN ULONG Type,
00521     IN PVOID Data,
00522     IN ULONG DataSize
00523     )
00524 <span class="comment">/*++</span>
00525 <span class="comment"></span>
00526 <span class="comment">Routine Description:</span>
00527 <span class="comment"></span>
00528 <span class="comment">    A value entry may be created or replaced with EhSetValueKey.</span>
00529 <span class="comment"></span>
00530 <span class="comment">    If a value entry with a Value ID (i.e. name) matching the</span>
00531 <span class="comment">    one specified by ValueName exists, it is deleted and replaced</span>
00532 <span class="comment">    with the one specified.  If no such value entry exists, a new</span>
00533 <span class="comment">    one is created.  NULL is a legal Value ID.  While Value IDs must</span>
00534 <span class="comment">    be unique within any given key, the same Value ID may appear</span>
00535 <span class="comment">    in many different keys.</span>
00536 <span class="comment"></span>
00537 <span class="comment">Arguments:</span>
00538 <span class="comment"></span>
00539 <span class="comment">    HiveHandle - handle of hive control structure for hive of interest</span>
00540 <span class="comment"></span>
00541 <span class="comment">    CellHandle - handle for parent cell</span>
00542 <span class="comment"></span>
00543 <span class="comment">    ValueName - The unique (relative to the containing key) name</span>
00544 <span class="comment">        of the value entry.  May be NULL.</span>
00545 <span class="comment"></span>
00546 <span class="comment">    TitleIndex - Supplies the title index for ValueName.  The title</span>
00547 <span class="comment">        index specifies the index of the localized alias for the ValueName.</span>
00548 <span class="comment"></span>
00549 <span class="comment">    Type - The integer type number of the value entry.</span>
00550 <span class="comment"></span>
00551 <span class="comment">    Data - Pointer to buffer with actual data for the value entry.</span>
00552 <span class="comment"></span>
00553 <span class="comment">    DataSize - Size of Data buffer.</span>
00554 <span class="comment"></span>
00555 <span class="comment"></span>
00556 <span class="comment">Return Value:</span>
00557 <span class="comment"></span>
00558 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00559 <span class="comment"></span>
00560 <span class="comment">        &lt;TBS&gt;</span>
00561 <span class="comment"></span>
00562 <span class="comment">--*/</span>
00563 {
00564     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00565 
00566     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00567     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.Signature = CM_KEY_CONTROL_BLOCK_SIGNATURE;
00568     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.KeyHive = (<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)&amp;(((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)HiveHandle)-&gt;Hive);
00569     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.KeyCell = (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)CellHandle;
00570     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName.Length = 0;
00571     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName.MaximumLength = 0;
00572     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00573 
00574     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a237">CmSetValueKey</a>(&amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
00575                          *<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00576                          TitleIndex,
00577                          Type,
00578                          Data,
00579                          DataSize));
00580 
00581 }
00582 
00583 
00584 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00585"></a><a class="code" href="../../d0/d5/edithive_8h.html#a7">00585</a> <a class="code" href="../../d0/d5/edithive_8h.html#a7">EhOpenChildByName</a>(
00586     HANDLE HiveHandle,
00587     HANDLE CellHandle,
00588     PUNICODE_STRING  Name,
00589     PHANDLE ChildCell
00590     )
00591 <span class="comment">/*++</span>
00592 <span class="comment"></span>
00593 <span class="comment">Routine Description:</span>
00594 <span class="comment"></span>
00595 <span class="comment">    Find the child subkey cell specified by Name.</span>
00596 <span class="comment"></span>
00597 <span class="comment">Arguments:</span>
00598 <span class="comment"></span>
00599 <span class="comment">    HiveHandle - handle of hive control structure for hive of interest</span>
00600 <span class="comment"></span>
00601 <span class="comment">    CellHandle - handle for parent cell</span>
00602 <span class="comment"></span>
00603 <span class="comment">    Name - name of child object to find</span>
00604 <span class="comment"></span>
00605 <span class="comment">    ChildCell - pointer to variable to receive cell index of child</span>
00606 <span class="comment"></span>
00607 <span class="comment">Return Value:</span>
00608 <span class="comment"></span>
00609 <span class="comment">    status</span>
00610 <span class="comment"></span>
00611 <span class="comment">--*/</span>
00612 {
00613     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00614 
00615     <span class="keywordflow">return</span>(CmpFindChildByName(&amp;((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)HiveHandle)-&gt;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00616                               (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)CellHandle,
00617                               *<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,
00618                               <a class="code" href="../../d9/d0/cmdata_8h.html#a103a95">KeyBodyNode</a>,
00619                               (<a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>)ChildCell,
00620                               &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>));
00621 }
00622 
00623 
00624 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00625"></a><a class="code" href="../../d0/d5/edithive_8h.html#a8">00625</a> <a class="code" href="../../d0/d5/edithive_8h.html#a8">EhCreateChild</a>(
00626     IN HANDLE HiveHandle,
00627     IN HANDLE CellHandle,
00628     IN PUNICODE_STRING  Name,
00629     OUT PHANDLE ChildCell,
00630     OUT PULONG Disposition OPTIONAL
00631     )
00632 <span class="comment">/*++</span>
00633 <span class="comment"></span>
00634 <span class="comment">Routine Description:</span>
00635 <span class="comment"></span>
00636 <span class="comment">    Attempts to open the given child subkey specified by name.  If the</span>
00637 <span class="comment">    child does not exist, it is created.</span>
00638 <span class="comment"></span>
00639 <span class="comment">Arguments:</span>
00640 <span class="comment"></span>
00641 <span class="comment">    HiveHandle - handle of hive control structure for hive of interest</span>
00642 <span class="comment"></span>
00643 <span class="comment">    CellHandle - handle for parent cell</span>
00644 <span class="comment"></span>
00645 <span class="comment"></span>
00646 <span class="comment">    Name - name of child object to create</span>
00647 <span class="comment"></span>
00648 <span class="comment">    ChildCell - pointer to variable to receive cell index of child</span>
00649 <span class="comment"></span>
00650 <span class="comment">    Disposition - This optional parameter is a pointer to a variable</span>
00651 <span class="comment">        that will receive a value indicating whether a new Registry</span>
00652 <span class="comment">        key was created or an existing one opened:</span>
00653 <span class="comment"></span>
00654 <span class="comment">        REG_CREATED_NEW_KEY - A new Registry Key was created</span>
00655 <span class="comment">        REG_OPENED_EXISTING_KEY - An existing Registry Key was opened</span>
00656 <span class="comment"></span>
00657 <span class="comment">Return Value:</span>
00658 <span class="comment"></span>
00659 <span class="comment">    status</span>
00660 <span class="comment"></span>
00661 <span class="comment">--*/</span>
00662 {
00663     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00664     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00665     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00666     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NewCell;
00667     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NewListCell;
00668     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> OldListCell;
00669     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> NewList;
00670     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> OldList;
00671     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Child;
00672     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Parent;
00673     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
00674     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00675     ULONG oldcount;
00676 
00677     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = &amp;((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)HiveHandle)-&gt;Hive;
00678 
00679     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)CellHandle == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00680         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00681             *ChildCell = (HANDLE)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>);
00682             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Disposition)) {
00683                 *Disposition = REG_OPENED_EXISTING_KEY;
00684             }
00685             <span class="keywordflow">return</span>(STATUS_SUCCESS);
00686         } <span class="keywordflow">else</span> {
00687             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
00688         }
00689     } <span class="keywordflow">else</span> {
00690         Parent = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)CellHandle);
00691         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = CmpFindChildByName(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00692                                     (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)CellHandle,
00693                                     *<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,
00694                                     <a class="code" href="../../d9/d0/cmdata_8h.html#a103a95">KeyBodyNode</a>,
00695                                     (<a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>)ChildCell,
00696                                     &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
00697     }
00698     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_NAME_NOT_FOUND) {
00699 
00700         NewCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00701                                  <a class="code" href="../../d1/d2/cmp_8h.html#a98">CmpHKeyNodeSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length),
00702                                  <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>);
00703         <span class="keywordflow">if</span> (NewCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00704 
00705             *ChildCell = (HANDLE)NewCell;
00706             Child = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, NewCell);
00707 
00708             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a25">CM_KEY_NODE_SIGNATURE</a>;
00709             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> = 0;
00710 
00711             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;(Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a>));
00712 
00713             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o3">Spare</a> = 0;
00714             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)CellHandle;
00715 
00716             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = 0;
00717             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00718             Child-&gt;u1.s1.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00719             Child-&gt;u1.s1.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00720             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length;
00721             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> = 0;
00722 
00723             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = 0;
00724             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = 0;
00725             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00726             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00727 
00728             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> = 0;
00729             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = 0;
00730             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> = 0;
00731             Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> = 0;
00732 
00733             <span class="keywordflow">if</span>((<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)CellHandle == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00734                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = NewCell;
00735                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d4/edithive_8c.html#a3">EhpAttachSecurity</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, NewCell);
00736             } <span class="keywordflow">else</span> {
00737                 Child-&gt;u1.s1.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = Parent-&gt;u1.s1.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>;
00738                 Security = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Child-&gt;u1.s1.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>);
00739                 ++Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a>;
00740             }
00741 
00742             RtlMoveMemory(
00743                 &amp;(Child-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]),
00744                 <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer,
00745                 <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length
00746                 );
00747 
00748             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00749         } <span class="keywordflow">else</span> {
00750             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INSUFFICIENT_RESOURCES;
00751             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00752         }
00753         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Disposition)) {
00754             *Disposition = REG_CREATED_NEW_KEY;
00755         }
00756 
00757         <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)CellHandle != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00758 
00759             <span class="comment">//</span>
00760             <span class="comment">// put newly created child into parent's sub key list</span>
00761             <span class="comment">//</span>
00762             <span class="keywordflow">if</span> (! <a class="code" href="../../d1/d2/cmp_8h.html#a305">CmpAddSubKey</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)CellHandle, NewCell)) {
00763                 <a class="code" href="../../d3/d3/cmtredel_8c.html#a1">CmpFreeKeyByCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, NewCell, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00764                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00765             }
00766 
00767             Parent = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)CellHandle);
00768 
00769             <span class="keywordflow">if</span> (Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length) {
00770                 Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length;
00771             }
00772             Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> = 0;
00773         }
00774     } <span class="keywordflow">else</span> {
00775         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00776         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Disposition)) {
00777             *Disposition = REG_OPENED_EXISTING_KEY;
00778         }
00779     }
00780     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00781 }
00782 
00783 
00784 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00785"></a><a class="code" href="../../d0/d5/edithive_8h.html#a9">00785</a> <a class="code" href="../../d0/d5/edithive_8h.html#a9">EhQueryKey</a>(
00786     IN HANDLE HiveHandle,
00787     IN HANDLE KeyHandle,
00788     IN KEY_INFORMATION_CLASS KeyInformationClass,
00789     IN PVOID KeyInformation,
00790     IN ULONG Length,
00791     IN PULONG ResultLength
00792     )
00793 <span class="comment">/*++</span>
00794 <span class="comment"></span>
00795 <span class="comment">Routine Description:</span>
00796 <span class="comment"></span>
00797 <span class="comment">    Data about the class of a key, and the numbers and sizes of its</span>
00798 <span class="comment">    children and value entries may be queried with CmQueryKey.</span>
00799 <span class="comment"></span>
00800 <span class="comment">    NOTE: The returned lengths are guaranteed to be at least as</span>
00801 <span class="comment">          long as the described values, but may be longer in</span>
00802 <span class="comment">          some circumstances.</span>
00803 <span class="comment"></span>
00804 <span class="comment">Arguments:</span>
00805 <span class="comment"></span>
00806 <span class="comment">    Hive - supplies a handle to the hive control structure for the hive</span>
00807 <span class="comment"></span>
00808 <span class="comment">    Cell - supplies handle of node to whose sub keys are to be found</span>
00809 <span class="comment"></span>
00810 <span class="comment">    KeyInformationClass - Specifies the type of information</span>
00811 <span class="comment">        returned in Buffer.  One of the following types:</span>
00812 <span class="comment"></span>
00813 <span class="comment">        KeyBasicInformation - return last write time, title index, and name.</span>
00814 <span class="comment">            (See KEY_BASIC_INFORMATION)</span>
00815 <span class="comment"></span>
00816 <span class="comment">        KeyNodeInformation - return last write time, title index, name, class.</span>
00817 <span class="comment">            (See KEY_NODE_INFORMATION)</span>
00818 <span class="comment"></span>
00819 <span class="comment">        KeyFullInformation - return all data except for name and security.</span>
00820 <span class="comment">            (See KEY_FULL_INFORMATION)</span>
00821 <span class="comment"></span>
00822 <span class="comment">    KeyInformation -Supplies pointer to buffer to receive the data.</span>
00823 <span class="comment"></span>
00824 <span class="comment">    Length - Length of KeyInformation in bytes.</span>
00825 <span class="comment"></span>
00826 <span class="comment">    ResultLength - Number of bytes actually written into KeyInformation.</span>
00827 <span class="comment"></span>
00828 <span class="comment">Return Value:</span>
00829 <span class="comment"></span>
00830 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00831 <span class="comment"></span>
00832 <span class="comment">        &lt;TBS&gt;</span>
00833 <span class="comment"></span>
00834 <span class="comment">--*/</span>
00835 {
00836     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a> Kcb;
00837 
00838     Kcb.<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00839     Kcb.Signature = CM_KEY_CONTROL_BLOCK_SIGNATURE;
00840     Kcb.<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a> = &amp;((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)HiveHandle)-&gt;Hive;
00841     Kcb.<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a> = (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)KeyHandle;
00842     Kcb.FullName.Length = 0;
00843     Kcb.FullName.MaximumLength = 0;
00844     Kcb.FullName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00845 
00846     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a229">CmQueryKey</a>(&amp;Kcb,
00847                       KeyInformationClass,
00848                       KeyInformation,
00849                       Length,
00850                       ResultLength));
00851 }
00852 
00853 PSECURITY_DESCRIPTOR
<a name="l00854"></a><a class="code" href="../../d0/d5/edithive_8h.html#a13">00854</a> <a class="code" href="../../d0/d5/edithive_8h.html#a13">EhGetKeySecurity</a>(
00855     IN HANDLE HiveHandle,
00856     IN HANDLE KeyHandle
00857     )
00858 {
00859     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
00860 
00861     <a class="code" href="../../d9/d4/edithive_8c.html#a9">CmpGetObjectSecurity</a>((<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)KeyHandle,
00862                          &amp;((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)HiveHandle)-&gt;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00863                          &amp;Security,
00864                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00865 
00866     <span class="keywordflow">return</span>(&amp;Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>);
00867 }
00868 
00869 
00870 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00871"></a><a class="code" href="../../d0/d5/edithive_8h.html#a10">00871</a> <a class="code" href="../../d0/d5/edithive_8h.html#a10">EhQueryValueKey</a>(
00872     IN HANDLE HiveHandle,
00873     IN HANDLE KeyHandle,
00874     IN PUNICODE_STRING ValueName,
00875     IN KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass,
00876     IN PVOID KeyValueInformation,
00877     IN ULONG Length,
00878     IN PULONG ResultLength
00879     )
00880 <span class="comment">/*++</span>
00881 <span class="comment"></span>
00882 <span class="comment">Routine Description:</span>
00883 <span class="comment"></span>
00884 <span class="comment">    The ValueName, TitleIndex, Type, and Data for any one of a key's</span>
00885 <span class="comment">    value entries may be queried with CmQueryValueKey.</span>
00886 <span class="comment"></span>
00887 <span class="comment">    If KeyValueInformation is not long enough to hold all requested data,</span>
00888 <span class="comment">    STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be</span>
00889 <span class="comment">    set to the number of bytes actually required.</span>
00890 <span class="comment"></span>
00891 <span class="comment">Arguments:</span>
00892 <span class="comment"></span>
00893 <span class="comment">    Hive - supplies a pointer to the hive control structure for the hive</span>
00894 <span class="comment"></span>
00895 <span class="comment">    Cell - supplies index of node to whose sub keys are to be found</span>
00896 <span class="comment"></span>
00897 <span class="comment">    ValueName  - The name of the value entry to return data for.</span>
00898 <span class="comment"></span>
00899 <span class="comment">    KeyValueInformationClass - Specifies the type of information</span>
00900 <span class="comment">        returned in KeyValueInformation.  One of the following types:</span>
00901 <span class="comment"></span>
00902 <span class="comment">        KeyValueBasicInformation - return time of last write, title</span>
00903 <span class="comment">            index, and name.  (See KEY_VALUE_BASIC_INFORMATION)</span>
00904 <span class="comment"></span>
00905 <span class="comment">        KeyValueFullInformation - return time of last write, title</span>
00906 <span class="comment">            index, name, class.  (See KEY_VALUE_FULL_INFORMATION)</span>
00907 <span class="comment"></span>
00908 <span class="comment">    KeyValueInformation -Supplies pointer to buffer to receive the data.</span>
00909 <span class="comment"></span>
00910 <span class="comment">    Length - Length of KeyValueInformation in bytes.</span>
00911 <span class="comment"></span>
00912 <span class="comment">    ResultLength - Number of bytes actually written into KeyValueInformation.</span>
00913 <span class="comment"></span>
00914 <span class="comment">Return Value:</span>
00915 <span class="comment"></span>
00916 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00917 <span class="comment"></span>
00918 <span class="comment">        &lt;TBS&gt;</span>
00919 <span class="comment"></span>
00920 <span class="comment">--*/</span>
00921 {
00922     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00923 
00924     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00925     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.Signature = CM_KEY_CONTROL_BLOCK_SIGNATURE;
00926     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.KeyHive = &amp;((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)HiveHandle)-&gt;Hive;
00927     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.KeyCell = (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)KeyHandle;
00928     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName.Length = 0;
00929     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName.MaximumLength = 0;
00930     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00931 
00932     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a230">CmQueryValueKey</a>(&amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
00933                            *<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00934                            KeyValueInformationClass,
00935                            KeyValueInformation,
00936                            Length,
00937                            ResultLength));
00938 
00939 }
00940 
00941 
00942 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00943"></a><a class="code" href="../../d0/d5/edithive_8h.html#a12">00943</a> <a class="code" href="../../d0/d5/edithive_8h.html#a12">EhDeleteValueKey</a>(
00944     IN HANDLE HiveHandle,
00945     IN HANDLE CellHandle,
00946     IN PUNICODE_STRING ValueName         <span class="comment">// RAW</span>
00947     )
00948 <span class="comment">/*++</span>
00949 <span class="comment"></span>
00950 <span class="comment">Routine Description:</span>
00951 <span class="comment"></span>
00952 <span class="comment">    One of the value entries of a registry key may be removed with this call.</span>
00953 <span class="comment"></span>
00954 <span class="comment">    The value entry with ValueName matching ValueName is removed from the key.</span>
00955 <span class="comment">    If no such entry exists, an error is returned.</span>
00956 <span class="comment"></span>
00957 <span class="comment">Arguments:</span>
00958 <span class="comment"></span>
00959 <span class="comment">    Hive - Supplies a handle to the hive control structure</span>
00960 <span class="comment"></span>
00961 <span class="comment">    Cell - Supplies a handle to the registry key to be operated on</span>
00962 <span class="comment"></span>
00963 <span class="comment">    ValueName - The name of the value to be deleted.  NULL is a legal name.</span>
00964 <span class="comment"></span>
00965 <span class="comment">Return Value:</span>
00966 <span class="comment"></span>
00967 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00968 <span class="comment"></span>
00969 <span class="comment">        &lt;TBS&gt;</span>
00970 <span class="comment"></span>
00971 <span class="comment">--*/</span>
00972 {
00973     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00974 
00975     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00976     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.Signature = CM_KEY_CONTROL_BLOCK_SIGNATURE;
00977     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.KeyHive = &amp;((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)HiveHandle)-&gt;Hive;
00978     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.KeyCell = (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)CellHandle;
00979     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName.Length = 0;
00980     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName.MaximumLength = 0;
00981     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00982 
00983     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a225">CmDeleteValueKey</a>(&amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>, *<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>));
00984 }
00985 
00986 
00987 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00988"></a><a class="code" href="../../d9/d4/edithive_8c.html#a3">00988</a> <a class="code" href="../../d9/d4/edithive_8c.html#a3">EhpAttachSecurity</a>(
00989     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00990     IN HCELL_INDEX Cell
00991     )
00992 
00993 <span class="comment">/*++</span>
00994 <span class="comment"></span>
00995 <span class="comment">Routine Description:</span>
00996 <span class="comment"></span>
00997 <span class="comment">    Creates a security descriptor cell and attaches it to the given</span>
00998 <span class="comment">    node.</span>
00999 <span class="comment"></span>
01000 <span class="comment">Arguments:</span>
01001 <span class="comment"></span>
01002 <span class="comment">    Hive - Supplies a pointer to the hive control structure.</span>
01003 <span class="comment"></span>
01004 <span class="comment">    Cell - Supplies the cell index of the node to attach the security</span>
01005 <span class="comment">           descriptor to.</span>
01006 <span class="comment"></span>
01007 <span class="comment">Return Value:</span>
01008 <span class="comment"></span>
01009 <span class="comment">    None.</span>
01010 <span class="comment"></span>
01011 <span class="comment">--*/</span>
01012 
01013 {
01014     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01015     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
01016     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SecurityCell;
01017     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
01018     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
01019     PSECURITY_DESCRIPTOR Descriptor;
01020     ULONG DescriptorLength;
01021     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01022 
01023     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>( NtCurrentProcess(),
01024                                  TOKEN_QUERY,
01025                                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01026     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01027         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01028     }
01029 
01030     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d8/seurtl_8c.html#a1">RtlNewSecurityObject</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01031                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01032                                    &amp;Descriptor,
01033                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01034                                    <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
01035                                    &amp;<a class="code" href="../../d6/d3/cmwraper_8c.html#a3">CmpKeyMapping</a> );
01036     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01037         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01038     }
01039 
01040     Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
01041     SecurityCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01042                                   <a class="code" href="../../d7/d2/cmse_8c.html#a0">SECURITY_CELL_LENGTH</a>(Descriptor),
01043                                   <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>);
01044     <span class="keywordflow">if</span> (SecurityCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01045         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01046     }
01047     Node-&gt;u1.s1.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = SecurityCell;
01048     Security = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, SecurityCell);
01049     DescriptorLength = <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>(Descriptor);
01050     Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a39">CM_KEY_SECURITY_SIGNATURE</a>;
01051     Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> = 1;
01052     Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o5">DescriptorLength</a> = DescriptorLength;
01053     RtlMoveMemory( &amp;Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>,
01054                    Descriptor,
01055                    DescriptorLength );
01056     Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> = Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> = SecurityCell;
01057     <span class="keywordflow">return</span>(STATUS_SUCCESS);
01058 
01059 }
01060 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
