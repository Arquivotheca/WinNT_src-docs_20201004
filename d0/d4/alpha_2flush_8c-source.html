<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: flush.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>flush.c</h1><a href="../../d9/d4/alpha_2flush_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment">Copyright (c) 1993  Digital Equipment Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    flush.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module implements Alpha AXP machine dependent kernel functions to flush</span>
00013 <span class="comment">    the data and instruction caches and to flush I/O buffers.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    David N. Cutler (davec) 26-Apr-1990</span>
00018 <span class="comment">    Joe Notarangelo  29-Nov-1993</span>
00019 <span class="comment"></span>
00020 <span class="comment">Environment:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    Kernel mode only.</span>
00023 <span class="comment"></span>
00024 <span class="comment">Revision History:</span>
00025 <span class="comment"></span>
00026 <span class="comment">--*/</span>
00027 
00028 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00029 
00030 
00031 <span class="comment">//</span>
00032 <span class="comment">// Define forward referenced prototypes.</span>
00033 <span class="comment">//</span>
00034 
00035 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00036 <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a1">KiSweepDcacheTarget</a> (
00037     IN <a class="code" href="../../d0/d9/ntosdef_8h.html#a54">PKIPI_CONTEXT</a> SignalDone,
00038     IN PVOID Count,
00039     IN PVOID Parameter2,
00040     IN PVOID Parameter3
00041     );
00042 
00043 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00044 <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a2">KiSweepIcacheTarget</a> (
00045     IN PKIPI_CONTEXT SignalDone,
00046     IN PVOID Count,
00047     IN PVOID Parameter2,
00048     IN PVOID Parameter3
00049     );
00050 
00051 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00052 <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a4">KiFlushIoBuffersTarget</a> (
00053     IN PKIPI_CONTEXT SignalDone,
00054     IN PVOID Mdl,
00055     IN PVOID ReadOperation,
00056     IN PVOID DmaOperation
00057     );
00058 
00059 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00060 <a class="code" href="../../d9/d4/alpha_2flush_8c.html#a4">KiSynchronizeMemoryAccessTarget</a> (
00061     IN PKIPI_CONTEXT SignalDone,
00062     IN PVOID Parameter1,
00063     IN PVOID Parameter2,
00064     IN PVOID Parameter3
00065     );
00066 
<a name="l00067"></a><a class="code" href="../../d9/d4/alpha_2flush_8c.html#a0">00067</a> ULONG <a class="code" href="../../d9/d4/alpha_2flush_8c.html#a0">KiSynchronizeMemoryCallCount</a> = 0;
00068 
00069 
00070 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00071"></a><a class="code" href="../../d9/d4/alpha_2flush_8c.html#a5">00071</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a6">KeSweepDcache</a> (
00072     IN BOOLEAN AllProcessors
00073     )
00074 
00075 <span class="comment">/*++</span>
00076 <span class="comment"></span>
00077 <span class="comment">Routine Description:</span>
00078 <span class="comment"></span>
00079 <span class="comment">    This function flushes the data cache on all processors that are currently</span>
00080 <span class="comment">    running threads which are children of the current process or flushes the</span>
00081 <span class="comment">    data cache on all processors in the host configuration.</span>
00082 <span class="comment"></span>
00083 <span class="comment">Arguments:</span>
00084 <span class="comment"></span>
00085 <span class="comment">    AllProcessors - Supplies a boolean value that determines which data</span>
00086 <span class="comment">        caches are flushed.</span>
00087 <span class="comment"></span>
00088 <span class="comment">Return Value:</span>
00089 <span class="comment"></span>
00090 <span class="comment">    None.</span>
00091 <span class="comment"></span>
00092 <span class="comment">--*/</span>
00093 
00094 {
00095 
00096     KIRQL OldIrql;
00097     KAFFINITY TargetProcessors;
00098 
00099     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= KiSynchIrql);
00100 
00101     <span class="comment">//</span>
00102     <span class="comment">// Raise IRQL to synchronization level to prevent a context switch.</span>
00103     <span class="comment">//</span>
00104 
00105 <span class="preprocessor">#if !defined(NT_UP)</span>
00106 <span class="preprocessor"></span>
00107     OldIrql = KeRaiseIrqlToSynchLevel();
00108 
00109     <span class="comment">//</span>
00110     <span class="comment">// Compute the set of target processors and send the sweep parameters</span>
00111     <span class="comment">// to the target processors, if any, for execution.</span>
00112     <span class="comment">//</span>
00113 
00114     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; PCR-&gt;NotMember;
00115     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00116         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00117                         <a class="code" href="../../d9/d4/alpha_2flush_8c.html#a1">KiSweepDcacheTarget</a>,
00118                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00119                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00120                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00121     }
00122 
00123     <a class="code" href="../../d0/d0/ki_8h.html#a21">IPI_INSTRUMENT_COUNT</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number, SweepDcache);
00124 
00125 <span class="preprocessor">#endif</span>
00126 <span class="preprocessor"></span>
00127     <span class="comment">//</span>
00128     <span class="comment">// Sweep the data cache on the current processor.</span>
00129     <span class="comment">//</span>
00130 
00131     HalSweepDcache();
00132 
00133     <span class="comment">//</span>
00134     <span class="comment">// Wait until all target processors have finished sweeping the their</span>
00135     <span class="comment">// data cache.</span>
00136     <span class="comment">//</span>
00137 
00138 <span class="preprocessor">#if !defined(NT_UP)</span>
00139 <span class="preprocessor"></span>
00140     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00141         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00142     }
00143 
00144     <span class="comment">//</span>
00145     <span class="comment">// Lower IRQL to its previous level and return.</span>
00146     <span class="comment">//</span>
00147 
00148     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00149 
00150 <span class="preprocessor">#endif</span>
00151 <span class="preprocessor"></span>
00152     <span class="keywordflow">return</span>;
00153 }
00154 
00155 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00156"></a><a class="code" href="../../d9/d4/alpha_2flush_8c.html#a1">00156</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a1">KiSweepDcacheTarget</a> (
00157     IN PKIPI_CONTEXT SignalDone,
00158     IN PVOID Parameter1,
00159     IN PVOID Parameter2,
00160     IN PVOID Parameter3
00161     )
00162 
00163 <span class="comment">/*++</span>
00164 <span class="comment"></span>
00165 <span class="comment">Routine Description:</span>
00166 <span class="comment"></span>
00167 <span class="comment">    This is the target function for sweeping the data cache on target</span>
00168 <span class="comment">    processors.</span>
00169 <span class="comment"></span>
00170 <span class="comment">Arguments:</span>
00171 <span class="comment"></span>
00172 <span class="comment">    SignalDone - Supplies a pointer to a variable that is cleared when the</span>
00173 <span class="comment">        requested operation has been performed</span>
00174 <span class="comment"></span>
00175 <span class="comment">    Parameter1 - Parameter3 - not used</span>
00176 <span class="comment"></span>
00177 <span class="comment">Return Value:</span>
00178 <span class="comment"></span>
00179 <span class="comment">    None.</span>
00180 <span class="comment"></span>
00181 <span class="comment">--*/</span>
00182 
00183 {
00184 
00185     <span class="comment">//</span>
00186     <span class="comment">// Sweep the data cache on the current processor and clear the sweep</span>
00187     <span class="comment">// data cache packet address to signal the source to continue.</span>
00188     <span class="comment">//</span>
00189 
00190 <span class="preprocessor">#if !defined(NT_UP)</span>
00191 <span class="preprocessor"></span>
00192     HalSweepDcache();
00193     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00194     <a class="code" href="../../d0/d0/ki_8h.html#a21">IPI_INSTRUMENT_COUNT</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number, SweepDcache);
00195 
00196 <span class="preprocessor">#endif</span>
00197 <span class="preprocessor"></span>
00198     <span class="keywordflow">return</span>;
00199 }
00200 
00201 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00202"></a><a class="code" href="../../d9/d4/alpha_2flush_8c.html#a6">00202</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a7">KeSweepIcache</a> (
00203     IN BOOLEAN AllProcessors
00204     )
00205 
00206 <span class="comment">/*++</span>
00207 <span class="comment"></span>
00208 <span class="comment">Routine Description:</span>
00209 <span class="comment"></span>
00210 <span class="comment">    This function flushes the instruction cache on all processors that are</span>
00211 <span class="comment">    currently running threads which are children of the current process or</span>
00212 <span class="comment">    flushes the instruction cache on all processors in the host configuration.</span>
00213 <span class="comment"></span>
00214 <span class="comment">Arguments:</span>
00215 <span class="comment"></span>
00216 <span class="comment">    AllProcessors - Supplies a boolean value that determines which instruction</span>
00217 <span class="comment">        caches are flushed.</span>
00218 <span class="comment"></span>
00219 <span class="comment">Return Value:</span>
00220 <span class="comment"></span>
00221 <span class="comment">    None.</span>
00222 <span class="comment"></span>
00223 <span class="comment">--*/</span>
00224 
00225 {
00226 
00227     KIRQL OldIrql;
00228     KAFFINITY TargetProcessors;
00229 
00230     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= KiSynchIrql);
00231 
00232     <span class="comment">//</span>
00233     <span class="comment">// Raise IRQL to synchronization level to prevent a context switch.</span>
00234     <span class="comment">//</span>
00235 
00236 <span class="preprocessor">#if !defined(NT_UP)</span>
00237 <span class="preprocessor"></span>
00238     OldIrql = KeRaiseIrqlToSynchLevel();
00239 
00240     <span class="comment">//</span>
00241     <span class="comment">// Compute the set of target processors and send the sweep parameters</span>
00242     <span class="comment">// to the target processors, if any, for execution.</span>
00243     <span class="comment">//</span>
00244 
00245     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; PCR-&gt;NotMember;
00246     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00247         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00248                         <a class="code" href="../../d9/d4/alpha_2flush_8c.html#a2">KiSweepIcacheTarget</a>,
00249                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00250                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00251                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00252     }
00253 
00254     <a class="code" href="../../d0/d0/ki_8h.html#a21">IPI_INSTRUMENT_COUNT</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number, SweepIcache);
00255 
00256 <span class="preprocessor">#endif</span>
00257 <span class="preprocessor"></span>
00258     <span class="comment">//</span>
00259     <span class="comment">// Sweep the instruction cache on the current processor.</span>
00260     <span class="comment">//</span>
00261 
00262     KiImb();
00263 
00264     <span class="comment">//</span>
00265     <span class="comment">// Wait until all target processors have finished sweeping the their</span>
00266     <span class="comment">// instruction cache.</span>
00267     <span class="comment">//</span>
00268 
00269 <span class="preprocessor">#if !defined(NT_UP)</span>
00270 <span class="preprocessor"></span>
00271     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00272         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00273     }
00274 
00275     <span class="comment">//</span>
00276     <span class="comment">// Lower IRQL to its previous level and return.</span>
00277     <span class="comment">//</span>
00278 
00279     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00280 
00281 <span class="preprocessor">#endif</span>
00282 <span class="preprocessor"></span>
00283     <span class="keywordflow">return</span>;
00284 }
00285 
00286 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00287"></a><a class="code" href="../../d9/d4/alpha_2flush_8c.html#a2">00287</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a2">KiSweepIcacheTarget</a> (
00288     IN PKIPI_CONTEXT SignalDone,
00289     IN PVOID Parameter1,
00290     IN PVOID Parameter2,
00291     IN PVOID Parameter3
00292     )
00293 
00294 <span class="comment">/*++</span>
00295 <span class="comment"></span>
00296 <span class="comment">Routine Description:</span>
00297 <span class="comment"></span>
00298 <span class="comment">    This is the target function for sweeping the instruction cache on</span>
00299 <span class="comment">    target processors.</span>
00300 <span class="comment"></span>
00301 <span class="comment">Arguments:</span>
00302 <span class="comment"></span>
00303 <span class="comment">    SignalDone - Supplies a pointer to a variable that is cleared when the</span>
00304 <span class="comment">        requested operation has been performed</span>
00305 <span class="comment"></span>
00306 <span class="comment">    Parameter1 - Parameter3 - not used</span>
00307 <span class="comment"></span>
00308 <span class="comment"></span>
00309 <span class="comment">Return Value:</span>
00310 <span class="comment"></span>
00311 <span class="comment">    None.</span>
00312 <span class="comment"></span>
00313 <span class="comment">--*/</span>
00314 
00315 {
00316 
00317     <span class="comment">//</span>
00318     <span class="comment">// Sweep the instruction cache on the current processor and clear</span>
00319     <span class="comment">// the sweep instruction cache packet address to signal the source</span>
00320     <span class="comment">// to continue.</span>
00321     <span class="comment">//</span>
00322 
00323 <span class="preprocessor">#if !defined(NT_UP)</span>
00324 <span class="preprocessor"></span>
00325     KiImb();
00326     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00327     <a class="code" href="../../d0/d0/ki_8h.html#a21">IPI_INSTRUMENT_COUNT</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number, SweepIcache);
00328 
00329 <span class="preprocessor">#endif</span>
00330 <span class="preprocessor"></span>
00331     <span class="keywordflow">return</span>;
00332 }
00333 
00334 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00335"></a><a class="code" href="../../d9/d4/alpha_2flush_8c.html#a7">00335</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a8">KeSweepIcacheRange</a> (
00336     IN BOOLEAN AllProcessors,
00337     IN PVOID BaseAddress,
00338     IN ULONG_PTR Length
00339     )
00340 
00341 <span class="comment">/*++</span>
00342 <span class="comment"></span>
00343 <span class="comment">Routine Description:</span>
00344 <span class="comment"></span>
00345 <span class="comment">    This function flushes the an range of virtual addresses from the primary</span>
00346 <span class="comment">    instruction cache on all processors that are currently running threads</span>
00347 <span class="comment">    which are children of the current process or flushes the range of virtual</span>
00348 <span class="comment">    addresses from the primary instruction cache on all processors in the host</span>
00349 <span class="comment">    configuration.</span>
00350 <span class="comment"></span>
00351 <span class="comment">Arguments:</span>
00352 <span class="comment"></span>
00353 <span class="comment">    AllProcessors - Supplies a boolean value that determines which instruction</span>
00354 <span class="comment">        caches are flushed.</span>
00355 <span class="comment"></span>
00356 <span class="comment">    BaseAddress - Supplies a pointer to the base of the range that is flushed.</span>
00357 <span class="comment"></span>
00358 <span class="comment">    Length - Supplies the length of the range that is flushed if the base</span>
00359 <span class="comment">        address is specified.</span>
00360 <span class="comment"></span>
00361 <span class="comment">Return Value:</span>
00362 <span class="comment"></span>
00363 <span class="comment">    None.</span>
00364 <span class="comment"></span>
00365 <span class="comment">--*/</span>
00366 
00367 {
00368 
00369     <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a7">KeSweepIcache</a>(AllProcessors);
00370     <span class="keywordflow">return</span>;
00371 }
00372 
00373 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00374"></a><a class="code" href="../../d9/d4/alpha_2flush_8c.html#a8">00374</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a9">KeFlushIoBuffers</a> (
00375     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
00376     IN BOOLEAN ReadOperation,
00377     IN BOOLEAN DmaOperation
00378     )
00379 
00380 <span class="comment">/*++</span>
00381 <span class="comment"></span>
00382 <span class="comment">Routine Description:</span>
00383 <span class="comment"></span>
00384 <span class="comment">    This function flushes the I/O buffer specified by the memory descriptor</span>
00385 <span class="comment">    list from the data cache on all processors.</span>
00386 <span class="comment"></span>
00387 <span class="comment">    Alpha requires that caches be coherent with respect to I/O. All that</span>
00388 <span class="comment">    this routine needs to do is execute a memory barrier on the current</span>
00389 <span class="comment">    processor. However, in order to maintain i-stream coherency, all</span>
00390 <span class="comment">    processors must execute the IMB PAL call in the case of page reads.</span>
00391 <span class="comment">    Thus, all processors are IPI'd to perform the IMB for any flush</span>
00392 <span class="comment">    that is a DmaOperation, a ReadOperation, and an MDL_IO_PAGE_READ.</span>
00393 <span class="comment"></span>
00394 <span class="comment"></span>
00395 <span class="comment">Arguments:</span>
00396 <span class="comment"></span>
00397 <span class="comment">    Mdl - Supplies a pointer to a memory descriptor list that describes the</span>
00398 <span class="comment">        I/O buffer location.</span>
00399 <span class="comment"></span>
00400 <span class="comment">    ReadOperation - Supplies a boolean value that determines whether the I/O</span>
00401 <span class="comment">        operation is a read into memory.</span>
00402 <span class="comment"></span>
00403 <span class="comment">    DmaOperation - Supplies a boolean value that determines whether the I/O</span>
00404 <span class="comment">        operation is a DMA operation.</span>
00405 <span class="comment"></span>
00406 <span class="comment">Return Value:</span>
00407 <span class="comment"></span>
00408 <span class="comment">    None.</span>
00409 <span class="comment"></span>
00410 <span class="comment">--*/</span>
00411 
00412 {
00413     KIRQL OldIrql;
00414     KAFFINITY TargetProcessors;
00415 
00416     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= KiSynchIrql);
00417 
00418     KiMb();
00419 
00420     <span class="comment">//</span>
00421     <span class="comment">// If the operation is a DMA operation, then check if the flush</span>
00422     <span class="comment">// can be avoided because the host system supports the right set</span>
00423     <span class="comment">// of cache coherency attributes. Otherwise, the flush can also</span>
00424     <span class="comment">// be avoided if the operation is a programmed I/O and not a page</span>
00425     <span class="comment">// read.</span>
00426     <span class="comment">//</span>
00427 
00428     <span class="keywordflow">if</span> (DmaOperation != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00429         <span class="keywordflow">if</span> (ReadOperation != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00430             <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d9/kernldat_8c.html#a34">KiDmaIoCoherency</a> &amp; <a class="code" href="../../d4/d9/ke_8h.html#a41">DMA_READ_ICACHE_INVALIDATE</a>) != 0) {
00431 
00432                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d5/d9/kernldat_8c.html#a34">KiDmaIoCoherency</a> &amp; <a class="code" href="../../d4/d9/ke_8h.html#a40">DMA_READ_DCACHE_INVALIDATE</a>) != 0);
00433 
00434                 <span class="keywordflow">return</span>;
00435 
00436             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((Mdl-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a18">MDL_IO_PAGE_READ</a>) == 0) &amp;&amp;
00437                 ((<a class="code" href="../../d5/d9/kernldat_8c.html#a34">KiDmaIoCoherency</a> &amp; <a class="code" href="../../d4/d9/ke_8h.html#a40">DMA_READ_DCACHE_INVALIDATE</a>) != 0)) {
00438                 <span class="keywordflow">return</span>;
00439             }
00440 
00441         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d9/kernldat_8c.html#a34">KiDmaIoCoherency</a> &amp; <a class="code" href="../../d4/d9/ke_8h.html#a42">DMA_WRITE_DCACHE_SNOOP</a>) != 0) {
00442             <span class="keywordflow">return</span>;
00443         }
00444 
00445     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Mdl-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a18">MDL_IO_PAGE_READ</a>) == 0) {
00446         <span class="keywordflow">return</span>;
00447     }
00448 
00449     <span class="comment">//</span>
00450     <span class="comment">// Either the operation is a DMA operation and the right coherency</span>
00451     <span class="comment">// attributes are not supported by the host system, or the operation</span>
00452     <span class="comment">// is programmed I/O and a page read.</span>
00453     <span class="comment">//</span>
00454     <span class="comment">// Raise IRQL to synchronization level to prevent a context switch.</span>
00455     <span class="comment">//</span>
00456 
00457     OldIrql = KeRaiseIrqlToSynchLevel();
00458 
00459     <span class="comment">//</span>
00460     <span class="comment">// Compute the set of target processors, and send the flush I/O</span>
00461     <span class="comment">// parameters to the target processors, if any, for execution.</span>
00462     <span class="comment">//</span>
00463 
00464 <span class="preprocessor">#if !defined(NT_UP)</span>
00465 <span class="preprocessor"></span>
00466     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; PCR-&gt;NotMember;
00467     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00468         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00469                         <a class="code" href="../../d9/d4/alpha_2flush_8c.html#a3">KiFlushIoBuffersTarget</a>,
00470                         (PVOID)Mdl,
00471                         ULongToPtr((ULONG)ReadOperation),
00472                         ULongToPtr((ULONG)DmaOperation));
00473     }
00474 
00475 <span class="preprocessor">#endif</span>
00476 <span class="preprocessor"></span>
00477     <span class="comment">//</span>
00478     <span class="comment">// Flush I/O buffer on current processor.</span>
00479     <span class="comment">//</span>
00480 
00481     HalFlushIoBuffers(Mdl, ReadOperation, DmaOperation);
00482 
00483     <span class="comment">//</span>
00484     <span class="comment">// Wait until all target processors have finished flushing the</span>
00485     <span class="comment">// specified I/O buffer.</span>
00486     <span class="comment">//</span>
00487 
00488 <span class="preprocessor">#if !defined(NT_UP)</span>
00489 <span class="preprocessor"></span>
00490     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00491         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00492     }
00493 
00494 <span class="preprocessor">#endif</span>
00495 <span class="preprocessor"></span>
00496     <span class="comment">//</span>
00497     <span class="comment">// Lower IRQL to its previous level and return.</span>
00498     <span class="comment">//</span>
00499 
00500     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00501 
00502     <span class="keywordflow">return</span>;
00503 }
00504 
00505 <span class="preprocessor">#if !defined(NT_UP)</span>
00506 <span class="preprocessor"></span>
00507 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00508"></a><a class="code" href="../../d9/d4/alpha_2flush_8c.html#a3">00508</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a4">KiFlushIoBuffersTarget</a> (
00509     IN PKIPI_CONTEXT SignalDone,
00510     IN PVOID Mdl,
00511     IN PVOID ReadOperation,
00512     IN PVOID DmaOperation
00513     )
00514 
00515 <span class="comment">/*++</span>
00516 <span class="comment"></span>
00517 <span class="comment">Routine Description:</span>
00518 <span class="comment"></span>
00519 <span class="comment">    This is the target function for flushing an I/O buffer on target</span>
00520 <span class="comment">    processors.</span>
00521 <span class="comment"></span>
00522 <span class="comment">Arguments:</span>
00523 <span class="comment"></span>
00524 <span class="comment">    SignalDone Supplies a pointer to a variable that is cleared when the</span>
00525 <span class="comment">        requested operation has been performed.</span>
00526 <span class="comment"></span>
00527 <span class="comment">    Mdl - Supplies a pointer to a memory descriptor list that describes the</span>
00528 <span class="comment">        I/O buffer location.</span>
00529 <span class="comment"></span>
00530 <span class="comment">    ReadOperation - Supplies a boolean value that determines whether the I/O</span>
00531 <span class="comment">        operation is a read into memory.</span>
00532 <span class="comment"></span>
00533 <span class="comment">    DmaOperation - Supplies a boolean value that determines whether the I/O</span>
00534 <span class="comment">        operation is a DMA operation.</span>
00535 <span class="comment"></span>
00536 <span class="comment">Return Value:</span>
00537 <span class="comment"></span>
00538 <span class="comment">    None.</span>
00539 <span class="comment"></span>
00540 <span class="comment">--*/</span>
00541 
00542 {
00543 
00544     <span class="comment">//</span>
00545     <span class="comment">// Flush the specified I/O buffer on the current processor.</span>
00546     <span class="comment">//</span>
00547 
00548     HalFlushIoBuffers((<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)Mdl,
00549                       (BOOLEAN)((ULONG_PTR)ReadOperation),
00550                       (BOOLEAN)((ULONG_PTR)DmaOperation));
00551 
00552     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00553     <a class="code" href="../../d0/d0/ki_8h.html#a21">IPI_INSTRUMENT_COUNT</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number, FlushIoBuffers);
00554 
00555     <span class="keywordflow">return</span>;
00556 }
00557 
00558 <span class="preprocessor">#endif</span>
00559 <span class="preprocessor"></span>
00560 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00561"></a><a class="code" href="../../d9/d4/alpha_2flush_8c.html#a9">00561</a> <a class="code" href="../../d9/d4/alpha_2flush_8c.html#a9">KeSynchronizeMemoryAccess</a> (
00562     VOID
00563     )
00564 
00565 <span class="comment">/*++</span>
00566 <span class="comment"></span>
00567 <span class="comment">Routine Description:</span>
00568 <span class="comment"></span>
00569 <span class="comment">    This function synchronizes memory access across all processors in the</span>
00570 <span class="comment">    host configurarion.</span>
00571 <span class="comment"></span>
00572 <span class="comment">Arguments:</span>
00573 <span class="comment"></span>
00574 <span class="comment">    None.</span>
00575 <span class="comment"></span>
00576 <span class="comment">Return Value:</span>
00577 <span class="comment"></span>
00578 <span class="comment">    None.</span>
00579 <span class="comment"></span>
00580 <span class="comment">--*/</span>
00581 
00582 {
00583 
00584     KIRQL OldIrql;
00585     KAFFINITY TargetProcessors;
00586 
00587     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= KiSynchIrql);
00588 
00589     <a class="code" href="../../d9/d4/alpha_2flush_8c.html#a0">KiSynchronizeMemoryCallCount</a> += 1;
00590 
00591     <span class="comment">//</span>
00592     <span class="comment">// Raise IRQL to synchronization level to prevent a context switch.</span>
00593     <span class="comment">//</span>
00594 
00595 <span class="preprocessor">#if !defined(NT_UP)</span>
00596 <span class="preprocessor"></span>
00597     OldIrql = KeRaiseIrqlToSynchLevel();
00598 
00599     <span class="comment">//</span>
00600     <span class="comment">// Compute the set of target processors and send the synchronize message</span>
00601     <span class="comment">// to the target processors, if any, for execution.</span>
00602     <span class="comment">//</span>
00603 
00604     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; PCR-&gt;NotMember;
00605     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00606         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00607                         <a class="code" href="../../d9/d4/alpha_2flush_8c.html#a4">KiSynchronizeMemoryAccessTarget</a>,
00608                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00609                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00610                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00611     }
00612 
00613     <span class="comment">//</span>
00614     <span class="comment">// On an MP system an implicit memory barrier is executed during the</span>
00615     <span class="comment">// end of the IPI message. On a UP system, a memory barrier must be</span>
00616     <span class="comment">// executed.</span>
00617     <span class="comment">//</span>
00618 
00619 <span class="preprocessor">#else</span>
00620 <span class="preprocessor"></span>
00621     __MB();
00622 
00623 <span class="preprocessor">#endif</span>
00624 <span class="preprocessor"></span>
00625     <span class="comment">//</span>
00626     <span class="comment">// Wait until all target processors have finished sweeping the their</span>
00627     <span class="comment">// data cache.</span>
00628     <span class="comment">//</span>
00629 
00630 <span class="preprocessor">#if !defined(NT_UP)</span>
00631 <span class="preprocessor"></span>
00632     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00633         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00634     }
00635 
00636     <span class="comment">//</span>
00637     <span class="comment">// Lower IRQL to its previous level and return.</span>
00638     <span class="comment">//</span>
00639 
00640     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00641 
00642 <span class="preprocessor">#endif</span>
00643 <span class="preprocessor"></span>
00644     <span class="keywordflow">return</span>;
00645 }
00646 
00647 <span class="preprocessor">#if !defined(NT_UP)</span>
00648 <span class="preprocessor"></span>
00649 
00650 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00651"></a><a class="code" href="../../d9/d4/alpha_2flush_8c.html#a4">00651</a> <a class="code" href="../../d9/d4/alpha_2flush_8c.html#a4">KiSynchronizeMemoryAccessTarget</a> (
00652     IN PKIPI_CONTEXT SignalDone,
00653     IN PVOID Parameter1,
00654     IN PVOID Parameter2,
00655     IN PVOID Parameter3
00656     )
00657 
00658 <span class="comment">/*++</span>
00659 <span class="comment"></span>
00660 <span class="comment">Routine Description:</span>
00661 <span class="comment"></span>
00662 <span class="comment">    This function performs no operation, but an implicit memory barrier</span>
00663 <span class="comment">    is executed when the IPI message is received.</span>
00664 <span class="comment"></span>
00665 <span class="comment">Arguments:</span>
00666 <span class="comment"></span>
00667 <span class="comment">    SignalDone - Supplies a pointer to a variable that is cleared when the</span>
00668 <span class="comment">        requested operation has been performed</span>
00669 <span class="comment"></span>
00670 <span class="comment">    Parameter1 - Parameter3 - not used</span>
00671 <span class="comment"></span>
00672 <span class="comment">Return Value:</span>
00673 <span class="comment"></span>
00674 <span class="comment">    None.</span>
00675 <span class="comment"></span>
00676 <span class="comment">--*/</span>
00677 
00678 {
00679 
00680     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00681     <span class="keywordflow">return</span>;
00682 }
00683 
00684 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
