<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lfsprocs.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lfsprocs.h File Reference</h1><code>#include &lt;<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>&gt;</code><br>
<code>#include &lt;string.h&gt;</code><br>
<code>#include &lt;zwapi.h&gt;</code><br>
<code>#include &lt;<a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>&gt;</code><br>
<code>#include &lt;<a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>&gt;</code><br>
<code>#include "<a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html">nodetype.h</a>"</code><br>
<code>#include "LfsDisk.h"</code><br>
<code>#include "LfsStruc.h"</code><br>
<code>#include "LfsData.h"</code><br>

<p>
<a href="../../d1/d3/lfsprocs_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a0">FsRtlAllocatePool</a>(a, b)&nbsp;&nbsp;&nbsp;FsRtlAllocatePoolWithTag(a,b,' sfL')</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a1">FsRtlAllocatePoolWithQuota</a>(a, b)&nbsp;&nbsp;&nbsp;FsRtlAllocatePoolWithQuotaTag(a,b,' sfL')</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a2">LfsAllocatePoolNoRaise</a>(a, b)&nbsp;&nbsp;&nbsp;ExAllocatePoolWithTag((a),(b),MODULE_POOL_TAG)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a3">LfsAllocatePool</a>(a, b)&nbsp;&nbsp;&nbsp;ExAllocatePoolWithTag(((a) | POOL_RAISE_IF_ALLOCATION_FAILURE),(b),MODULE_POOL_TAG)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a4">LfsFreePool</a>(pv)&nbsp;&nbsp;&nbsp;ExFreePool(pv)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a5">LfsPreparePinWriteData</a>(L, FO, LEN, BUF, B)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a6">LfsTruncateOffsetToLogPage</a>(<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>, LI, OUTLI)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a7">LfsLogPageOffset</a>(<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>, <a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a>)&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a> &amp; (<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;LogPageMask)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a8">LfsFileOffsetToLsn</a>(<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>, FO, SN)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a9">LfsIsLsnInFile</a>(<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>, <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a10">LfsComputeLsnFromLbcb</a>(<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>, <a class="el" href="../../d4/d9/struct__LBCB.html">LBCB</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a11">LfsTruncateLsnToLogPage</a>(<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>, <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>, FO)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a12">LfsLsnToFileOffset</a>(<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>, <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>)&nbsp;&nbsp;&nbsp;/*xxShr*/( ((ULONGLONG)/*xxShl*/( (<a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>).QuadPart &lt;&lt; (<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;SeqNumberBits )) &gt;&gt; ((<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;SeqNumberBits - 3) )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a13">LfsLsnToSeqNumber</a>(<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>, <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>)&nbsp;&nbsp;&nbsp;/*xxShr*/Int64ShrlMod32( ((ULONGLONG)(<a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>).QuadPart), (<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;FileDataBits )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a14">LfsLsnToPageOffset</a>(<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>, <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>)&nbsp;&nbsp;&nbsp;LfsLogPageOffset( <a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>, (<a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>).LowPart &lt;&lt; 3 )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a15">LfsInitializeLcb</a>(<a class="el" href="../../d5/d9/struct__LCB.html">LCB</a>, ID, <a class="el" href="../../d0/d9/ntosdef_8h.html#a40">MODE</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a16">LfsAllocateLch</a>(NEW)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a17">LfsDeallocateLch</a>(<a class="el" href="../../d6/d9/struct__LCH.html">LCH</a>)&nbsp;&nbsp;&nbsp;ExFreePool( <a class="el" href="../../d6/d9/struct__LCH.html">LCH</a> )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a18">LfsAllocateRestartArea</a>(RS, SIZE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a19">LfsDeallocateRestartArea</a>(RS)&nbsp;&nbsp;&nbsp;ExFreePool( RS )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a20">LfsLbcbIsRestart</a>(<a class="el" href="../../d4/d9/struct__LBCB.html">LBCB</a>)&nbsp;&nbsp;&nbsp;(FlagOn( (<a class="el" href="../../d4/d9/struct__LBCB.html">LBCB</a>)-&gt;LbcbFlags, LBCB_RESTART_LBCB ))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a21">LfsAcquireLfsData</a>()&nbsp;&nbsp;&nbsp;ExAcquireFastMutex( &amp;<a class="el" href="../../d8/d3/lfsdata_8h.html#a5">LfsData</a>.LfsDataLock )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a22">LfsReleaseLfsData</a>()&nbsp;&nbsp;&nbsp;ExReleaseFastMutex( &amp;<a class="el" href="../../d8/d3/lfsdata_8h.html#a5">LfsData</a>.LfsDataLock )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a23">LfsAcquireBufferLock</a>()&nbsp;&nbsp;&nbsp;ExAcquireFastMutex( &amp;<a class="el" href="../../d8/d3/lfsdata_8h.html#a5">LfsData</a>.BufferLock )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a24">LfsReleaseBufferLock</a>()&nbsp;&nbsp;&nbsp;ExReleaseFastMutex( &amp;<a class="el" href="../../d8/d3/lfsdata_8h.html#a5">LfsData</a>.BufferLock )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a25">LfsWaitForBufferNotification</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a26">LfsNotifyBufferWaiters</a>()&nbsp;&nbsp;&nbsp;KeSetEvent( &amp;<a class="el" href="../../d8/d3/lfsdata_8h.html#a5">LfsData</a>.BufferNotification, 0, FALSE )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a27">LfsBlockBufferWaiters</a>()&nbsp;&nbsp;&nbsp;KeClearEvent( &amp;<a class="el" href="../../d8/d3/lfsdata_8h.html#a5">LfsData</a>.BufferNotification )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>(<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>)&nbsp;&nbsp;&nbsp;ExAcquireResourceExclusive( &amp;(<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;Sync-&gt;<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, TRUE )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>(<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>(<a class="el" href="../../d6/d9/struct__LCH.html">LCH</a>)&nbsp;&nbsp;&nbsp;ExAcquireResourceExclusive( &amp;(<a class="el" href="../../d6/d9/struct__LCH.html">LCH</a>)-&gt;Sync-&gt;<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, TRUE )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>(<a class="el" href="../../d6/d9/struct__LCH.html">LCH</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>(<a class="el" href="../../d6/d9/struct__LCH.html">LCH</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>(<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>, <a class="el" href="../../d6/d9/struct__LCH.html">LCH</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a34">LfsVerifyClientLsnInRange</a>(<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>, CLIENT, <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a35">LfsClientIdMatch</a>(CLIENT_A, CLIENT_B)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a36">LfsValidateLcb</a>(<a class="el" href="../../d5/d9/struct__LCB.html">LCB</a>, <a class="el" href="../../d6/d9/struct__LCH.html">LCH</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a37">FlagOn</a>(F, SF)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a38">BooleanFlagOn</a>(F, SF)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a39">SetFlag</a>(Flags, SingleFlag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a40">ClearFlag</a>(Flags, SingleFlag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a41">WordAlign</a>(<a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a42">LongAlign</a>(<a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a43">QuadAlign</a>(<a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a44">LiQuadAlign</a>(LI, OUT)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a45">Add2Ptr</a>(PTR, INC, CAST)&nbsp;&nbsp;&nbsp;((CAST)((PUCHAR)(PTR) + (INC)))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a46">PtrOffset</a>(BASE, OFFSET)&nbsp;&nbsp;&nbsp;((ULONG)((ULONG_PTR)(OFFSET) - (ULONG_PTR)(BASE)))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a47">try_return</a>(S)&nbsp;&nbsp;&nbsp;{ S; goto try_exit; }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN LONGLONG FileOffset, IN ULONG Length, IN BOOLEAN PinData, IN BOOLEAN AllowErrors, IN BOOLEAN IgnoreUsaErrors, OUT PBOOLEAN UsaError, OUT PVOID *<a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, OUT <a class="el" href="../../d4/d3/struct__BCB.html">PBCB</a> *Bcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a49">LfsPinOrMapLogRecordHeader</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> Lsn, IN BOOLEAN PinData, IN BOOLEAN IgnoreUsaErrors, OUT PBOOLEAN UsaError, OUT <a class="el" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> *RecordHeader, OUT <a class="el" href="../../d4/d3/struct__BCB.html">PBCB</a> *Bcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a50">LfsCopyReadLogRecord</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> RecordHeader, OUT PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a51">LfsFlushLfcb</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a> Lbcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a52">LfsReadRestart</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN LONGLONG FileSize, IN BOOLEAN FirstRestart, OUT PLONGLONG RestartPageOffset, OUT <a class="el" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> *RestartPage, OUT <a class="el" href="../../d4/d3/struct__BCB.html">PBCB</a> *RestartPageBcb, OUT PBOOLEAN ChkdskWasRun, OUT PBOOLEAN ValidPage, OUT PBOOLEAN UninitializedFile, OUT PBOOLEAN LogPacked, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> LastLsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a53">LfsFlushLbcb</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a> Lbcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a54">LfsFlushToLsnPriv</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> Lsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a55">LfsGetLbcb</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a> (IN PEXCEPTION_POINTERS ExceptionPointer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a57">LfsNextLogPageOffset</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN LONGLONG CurrentLogPageOffset, OUT PLONGLONG NextLogPageOffset, OUT PBOOLEAN Wrapped)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a58">LfsAllocateSpanningBuffer</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a59">LfsFreeSpanningBuffer</a> (IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a60">LfsWriteLogRecordIntoLogPage</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch, IN ULONG NumberOfWriteEntries, IN <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a> WriteEntries, IN <a class="el" href="../../d6/d3/lfs_8h.html#a13">LFS_RECORD_TYPE</a> RecordType, IN <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *TransactionId OPTIONAL, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> ClientUndoNextLsn OPTIONAL, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> ClientPreviousLsn OPTIONAL, IN LONG UndoRequirement, IN BOOLEAN ForceToDisk, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> Lsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a61">LfsLsnFinalOffset</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> Lsn, IN ULONG DataLength, OUT PLONGLONG FinalOffset)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a62">LfsFindNextLsn</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> RecordHeader, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> Lsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a63">LfsWriteLfsRestart</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN ULONG ThisRestartSize, IN BOOLEAN WaitForIo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a64">LfsFindOldestClientLsn</a> (IN <a class="el" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> RestartArea, IN <a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientArray, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> OldestLsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a65">LfsAllocateLfcb</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a66">LfsDeallocateLfcb</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN BOOLEAN CompleteTeardown)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a67">LfsAllocateLbcb</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, OUT <a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a> *Lbcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a68">LfsDeallocateLbcb</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a> Lbcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a69">LfsAllocateLcb</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, OUT <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> *NewLcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a70">LfsDeallocateLcb</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a71">LfsCurrentAvailSpace</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, OUT PLONGLONG CurrentAvailSpace, OUT PULONG CurrentPageBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a72">LfsVerifyLogSpaceAvail</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch, IN ULONG RemainingLogBytes, IN LONG UndoRequirement, IN BOOLEAN ForceToDisk)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/lfsprocs_8h.html#a73">LfsFindCurrentAvail</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a45" doxytag="lfsprocs.h::Add2Ptr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Add2Ptr          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PTR,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>INC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>CAST&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((CAST)((PUCHAR)(PTR) + (INC)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00721">721</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="lfsprocs.h::BooleanFlagOn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BooleanFlagOn          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">F,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SF&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(    \
    (BOOLEAN)(((F) &amp; (SF)) != 0) \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00658">658</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="lfsprocs.h::ClearFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ClearFlag          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Flags,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SingleFlag&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{ \
    (Flags) &amp;= ~(SingleFlag);         \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00666">666</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="lfsprocs.h::FlagOn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FlagOn          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">F,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SF&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>( \
    (((F) &amp; (SF)))     \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00654">654</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="lfsprocs.h::FsRtlAllocatePool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlAllocatePool          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;FsRtlAllocatePoolWithTag(a,b,' sfL')</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00043">43</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="lfsprocs.h::FsRtlAllocatePoolWithQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlAllocatePoolWithQuota          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;FsRtlAllocatePoolWithQuotaTag(a,b,' sfL')</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00044">44</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="lfsprocs.h::LfsAcquireBufferLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsAcquireBufferLock          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAcquireFastMutex( &amp;<a class="el" href="../../d8/d3/lfsdata_8h.html#a5">LfsData</a>.BufferLock )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00490">490</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00113">LfsAllocateSpanningBuffer()</a>, and <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00297">LfsFreeSpanningBuffer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="lfsprocs.h::LfsAcquireLch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsAcquireLch          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/struct__LCH.html">LCH</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAcquireResourceExclusive( &amp;(<a class="el" href="../../d6/d9/struct__LCH.html">LCH</a>)-&gt;Sync-&gt;<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, TRUE )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">517</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01063">LfsDeleteLogHandle()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00360">LfsFlushToLsn()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00197">LfsForceWrite()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00701">LfsQueryLastLsn()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01141">LfsReadLogFileInformation()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">LfsReadLogRecord()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00299">LfsReadNextLogRecord()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01361">LfsResetUndoTotal()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">LfsSetBaseLsn()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00594">LfsTerminateLogQuery()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01273">LfsVerifyLogFile()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00039">LfsWrite()</a>, and <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="lfsprocs.h::LfsAcquireLfcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsAcquireLfcb          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAcquireResourceExclusive( &amp;(<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;Sync-&gt;<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, TRUE )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00509">509</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00113">LfsAllocateSpanningBuffer()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00037">LfsFlushLbcb()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">LfsFlushLfcb()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>, and <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">LfsWriteLogRecordIntoLogPage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="lfsprocs.h::LfsAcquireLfsData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsAcquireLfsData          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAcquireFastMutex( &amp;<a class="el" href="../../d8/d3/lfsdata_8h.html#a5">LfsData</a>.LfsDataLock )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00484">484</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="lfsprocs.h::LfsAllocateLch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsAllocateLch          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">NEW&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                               \
    *(NEW) = <a class="code" href="../../d5/d5/cc_8h.html#a8">FsRtlAllocatePool</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d9/struct__LCH.html">LCH</a> ));      \
    RtlZeroMemory( (*NEW), <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d9/struct__LCH.html">LCH</a> ));                      \
    (*(NEW))-&gt;NodeTypeCode = <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a2">LFS_NTC_LCH</a>;                       \
    (*(NEW))-&gt;NodeByteSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d9/struct__LCH.html">LCH</a> );                     \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00428">428</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="lfsprocs.h::LfsAllocatePool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsAllocatePool          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePoolWithTag(((a) | POOL_RAISE_IF_ALLOCATION_FAILURE),(b),MODULE_POOL_TAG)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00047">47</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="lfsprocs.h::LfsAllocatePoolNoRaise" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsAllocatePoolNoRaise          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePoolWithTag((a),(b),MODULE_POOL_TAG)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00046">46</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00113">LfsAllocateSpanningBuffer()</a>, and <a class="el" href="../../d8/d7/sysinit_8c-source.html#l00040">LfsInitializeLogFileService()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="lfsprocs.h::LfsAllocateRestartArea" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsAllocateRestartArea          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">RS,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SIZE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>*(RS) = <a class="code" href="../../d5/d5/cc_8h.html#a8">FsRtlAllocatePool</a>( PagedPool, (SIZE) );             \
    RtlZeroMemory( *(RS), (SIZE) )
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00438">438</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>, and <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="lfsprocs.h::LfsBlockBufferWaiters" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsBlockBufferWaiters          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;KeClearEvent( &amp;<a class="el" href="../../d8/d3/lfsdata_8h.html#a5">LfsData</a>.BufferNotification )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00506">506</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00113">LfsAllocateSpanningBuffer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="lfsprocs.h::LfsClientIdMatch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsClientIdMatch          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">CLIENT_A,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>CLIENT_B&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>((BOOLEAN) ((CLIENT_A)-&gt;SeqNumber == (CLIENT_B)-&gt;SeqNumber          \
                &amp;&amp; (CLIENT_A)-&gt;ClientIndex == (CLIENT_B)-&gt;ClientIndex))
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00607">607</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l01116">LfsSearchForwardByClient()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="lfsprocs.h::LfsComputeLsnFromLbcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsComputeLsnFromLbcb          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d4/d9/struct__LBCB.html">LBCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                              \
    <a class="code" href="../../d0/d4/lfsprocs_8h.html#a8">LfsFileOffsetToLsn</a>( <a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a>,                                                           \
                        (<a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>)-&gt;FileOffset + (<a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>)-&gt;BufferOffset,    \
                        (LBCB)-&gt;SeqNumber )                                    \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00291">291</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">LfsWriteLogRecordIntoLogPage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="lfsprocs.h::LfsDeallocateLch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsDeallocateLch          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/struct__LCH.html">LCH</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExFreePool( <a class="el" href="../../d6/d9/struct__LCH.html">LCH</a> )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00435">435</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01063">LfsDeleteLogHandle()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="lfsprocs.h::LfsDeallocateRestartArea" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsDeallocateRestartArea          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">RS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExFreePool( RS )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00442">442</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00402">LfsDeallocateLbcb()</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00188">LfsDeallocateLfcb()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="lfsprocs.h::LfsFileOffsetToLsn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsFileOffsetToLsn          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FO,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                        \
    (((ULONGLONG)(FO)) &gt;&gt; 3) + Int64ShllMod32((SN), (<a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;FileDataBits)                                \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00283">283</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00148">LfsFindNextLsn()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02514">LfsUpdateLfcbFromNoRestart()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="lfsprocs.h::LfsFreePool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsFreePool          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">pv&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExFreePool(pv)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00048">48</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00297">LfsFreeSpanningBuffer()</a>, and <a class="el" href="../../d8/d7/sysinit_8c-source.html#l00040">LfsInitializeLogFileService()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="lfsprocs.h::LfsInitializeLcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsInitializeLcb          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d9/struct__LCB.html">LCB</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ID,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a40">MODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(<a class="code" href="../../d5/d9/struct__LCB.html">LCB</a>)-&gt;ClientId = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>;                                       \
    (<a class="code" href="../../d5/d9/struct__LCB.html">LCB</a>)-&gt;ContextMode = <a class="code" href="../../d3/d6/nec98_8h.html#a17">MODE</a>
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00423">423</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">LfsReadLogRecord()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="lfsprocs.h::LfsIsLsnInFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsIsLsnInFile          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(<span class="comment">/*xxGeq*/</span>( (<a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a>).QuadPart &gt;= ((<a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;OldestLsn).QuadPart )                                          \
     &amp;&amp; <span class="comment">/*xxLeq*/</span>( (<a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a>).QuadPart &lt;= ((<a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;RestartArea-&gt;CurrentLsn).QuadPart ))
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00287">287</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00148">LfsFindNextLsn()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="lfsprocs.h::LfsLbcbIsRestart" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsLbcbIsRestart          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/struct__LBCB.html">LBCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(FlagOn( (<a class="el" href="../../d4/d9/struct__LBCB.html">LBCB</a>)-&gt;LbcbFlags, LBCB_RESTART_LBCB ))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00445">445</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l02191">LfsFindFirstIo()</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00037">LfsFlushLbcb()</a>, and <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00134">LfsFlushToLsnPriv()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="lfsprocs.h::LfsLogPageOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsLogPageOffset          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a> &amp; (<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;LogPageMask)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00188">188</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="lfsprocs.h::LfsLsnToFileOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsLsnToFileOffset          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;/*xxShr*/( ((ULONGLONG)/*xxShl*/( (<a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>).QuadPart &lt;&lt; (<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;SeqNumberBits )) &gt;&gt; ((<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;SeqNumberBits - 3) )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00302">302</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00148">LfsFindNextLsn()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00582">LfsSetBaseLsnPriv()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="lfsprocs.h::LfsLsnToPageOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsLsnToPageOffset          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;LfsLogPageOffset( <a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>, (<a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>).LowPart &lt;&lt; 3 )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00308">308</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00339">LfsCopyReadLogRecord()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00809">LfsFindLogRecord()</a>, <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00036">LfsLsnFinalOffset()</a>, and <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00248">LfsPinOrMapLogRecordHeader()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="lfsprocs.h::LfsLsnToSeqNumber" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsLsnToSeqNumber          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;/*xxShr*/Int64ShrlMod32( ((ULONGLONG)(<a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>).QuadPart), (<a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;FileDataBits )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00305">305</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04188">LfsCheckSubsequentLogPage()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03193">LfsFindLastLsn()</a>, <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00148">LfsFindNextLsn()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02514">LfsUpdateLfcbFromNoRestart()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="lfsprocs.h::LfsNotifyBufferWaiters" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsNotifyBufferWaiters          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;KeSetEvent( &amp;<a class="el" href="../../d8/d3/lfsdata_8h.html#a5">LfsData</a>.BufferNotification, 0, FALSE )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00503">503</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00297">LfsFreeSpanningBuffer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="lfsprocs.h::LfsPreparePinWriteData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsPreparePinWriteData          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">L,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FO,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LEN,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BUF,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>B&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{    \
    LONGLONG _LocalFileOffset = (FO);          \
    <a class="code" href="../../d2/d9/pinsup_8c.html#a5">CcPreparePinWrite</a>( (L)-&gt;FileObject,             \
                       (PLARGE_INTEGER)&amp;_LocalFileOffset,           \
                       (LEN),                       \
                       FALSE,                       \
                       TRUE,                        \
                       (B),                         \
                       (BUF) );                     \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00080">80</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">LfsFlushLfcb()</a>, and <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00311">LfsGetLbcb()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="lfsprocs.h::LfsReleaseBufferLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsReleaseBufferLock          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExReleaseFastMutex( &amp;<a class="el" href="../../d8/d3/lfsdata_8h.html#a5">LfsData</a>.BufferLock )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00493">493</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00113">LfsAllocateSpanningBuffer()</a>, and <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00297">LfsFreeSpanningBuffer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="lfsprocs.h::LfsReleaseLch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsReleaseLch          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/struct__LCH.html">LCH</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> ((<a class="code" href="../../d6/d9/struct__LCH.html">LCH</a>)-&gt;Sync-&gt;Resource.OwnerThreads[0].OwnerThread == <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>()) { \
        <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;(<a class="code" href="../../d6/d9/struct__LCH.html">LCH</a>)-&gt;<a class="code" href="../../d9/d0/cmdata_8h.html#a104a98">Sync</a>-&gt;Resource );                                    \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">520</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01063">LfsDeleteLogHandle()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00360">LfsFlushToLsn()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00197">LfsForceWrite()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00701">LfsQueryLastLsn()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01141">LfsReadLogFileInformation()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">LfsReadLogRecord()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00299">LfsReadNextLogRecord()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01361">LfsResetUndoTotal()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">LfsSetBaseLsn()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00594">LfsTerminateLogQuery()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01273">LfsVerifyLogFile()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00039">LfsWrite()</a>, and <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="lfsprocs.h::LfsReleaseLfcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsReleaseLfcb          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;Sync-&gt;Resource.OwnerThreads[0].OwnerThread == <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>()) {\
        <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;(<a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;<a class="code" href="../../d9/d0/cmdata_8h.html#a104a98">Sync</a>-&gt;Resource );                                   \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">512</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00113">LfsAllocateSpanningBuffer()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00037">LfsFlushLbcb()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">LfsFlushLfcb()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00299">LfsReadNextLogRecord()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01273">LfsVerifyLogFile()</a>, and <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">LfsWriteLogRecordIntoLogPage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="lfsprocs.h::LfsReleaseLfsData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsReleaseLfsData          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExReleaseFastMutex( &amp;<a class="el" href="../../d8/d3/lfsdata_8h.html#a5">LfsData</a>.LfsDataLock )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00487">487</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="lfsprocs.h::LfsTruncateLsnToLogPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsTruncateLsnToLogPage          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FO&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                  \
    *(FO) = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a12">LfsLsnToFileOffset</a>( <a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a>, LSN );                                    \
    *((PULONG)(FO)) &amp;= (<a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;LogPageInverseMask;                                \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00297">297</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04188">LfsCheckSubsequentLogPage()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00339">LfsCopyReadLogRecord()</a>, <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00036">LfsLsnFinalOffset()</a>, and <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00248">LfsPinOrMapLogRecordHeader()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="lfsprocs.h::LfsTruncateOffsetToLogPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsTruncateOffsetToLogPage          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LI,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUTLI&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>*(OUTLI) = LI;                                      \
    *((PULONG)(OUTLI)) &amp;= (<a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;SystemPageInverseMask
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00184">184</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00412">LfsFindCurrentAvail()</a>, <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00148">LfsFindNextLsn()</a>, <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00040">LfsNextLogPageOffset()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="lfsprocs.h::LfsValidateClientId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsValidateClientId          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/struct__LCH.html">LCH</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> ((<a class="code" href="../../d6/d9/struct__LCH.html">LCH</a>)-&gt;ClientId.ClientIndex &gt;= (<a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;RestartArea-&gt;LogClients  \
        || (<a class="code" href="../../d6/d9/struct__LCH.html">LCH</a>)-&gt;ClientId.SeqNumber                                    \
           != <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lfcb-&gt;ClientArray,                               \
                       (<a class="code" href="../../d6/d9/struct__LCH.html">LCH</a>)-&gt;ClientArrayByteOffset,                    \
                       <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> )-&gt;SeqNumber) {               \
        <a class="code" href="../../d0/d4/ex_2alpha_2raisests_8c.html#a3">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );                          \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">593</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00360">LfsFlushToLsn()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00197">LfsForceWrite()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00701">LfsQueryLastLsn()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01141">LfsReadLogFileInformation()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">LfsReadLogRecord()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00299">LfsReadNextLogRecord()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01361">LfsResetUndoTotal()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">LfsSetBaseLsn()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00594">LfsTerminateLogQuery()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00039">LfsWrite()</a>, and <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="lfsprocs.h::LfsValidateLcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsValidateLcb          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d9/struct__LCB.html">LCB</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/struct__LCH.html">LCH</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                                                     \
        || (<a class="code" href="../../d5/d9/struct__LCB.html">LCB</a>)-&gt;NodeTypeCode != <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a1">LFS_NTC_LCB</a>                           \
        || !<a class="code" href="../../d0/d4/lfsprocs_8h.html#a35">LfsClientIdMatch</a>( &amp;(<a class="code" href="../../d5/d9/struct__LCB.html">LCB</a>)-&gt;ClientId, &amp;(<a class="code" href="../../d6/d9/struct__LCH.html">LCH</a>)-&gt;ClientId )) {   \
        <a class="code" href="../../d0/d4/ex_2alpha_2raisests_8c.html#a3">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );                          \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00611">611</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l00299">LfsReadNextLogRecord()</a>, and <a class="el" href="../../d4/d2/querylog_8c-source.html#l00594">LfsTerminateLogQuery()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="lfsprocs.h::LfsValidateLch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsValidateLch          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/struct__LCH.html">LCH</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> ((<a class="code" href="../../d6/d9/struct__LCH.html">LCH</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                                           \
        || (<a class="code" href="../../d6/d9/struct__LCH.html">LCH</a>)-&gt;NodeTypeCode != <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a2">LFS_NTC_LCH</a>                   \
        || ((<a class="code" href="../../d6/d9/struct__LCH.html">LCH</a>)-&gt;Lfcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                                 \
            &amp;&amp; (<a class="code" href="../../d6/d9/struct__LCH.html">LCH</a>)-&gt;Lfcb-&gt;NodeTypeCode != <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a4">LFS_NTC_LFCB</a>)) {    \
                                                                \
        <a class="code" href="../../d0/d4/ex_2alpha_2raisests_8c.html#a3">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );                  \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">584</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00360">LfsFlushToLsn()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00197">LfsForceWrite()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00701">LfsQueryLastLsn()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01141">LfsReadLogFileInformation()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">LfsReadLogRecord()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00299">LfsReadNextLogRecord()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01361">LfsResetUndoTotal()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">LfsSetBaseLsn()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00594">LfsTerminateLogQuery()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00039">LfsWrite()</a>, and <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="lfsprocs.h::LfsVerifyClientLsnInRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsVerifyClientLsnInRange          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d0/struct__LFCB.html">LFCB</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>CLIENT,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(<span class="comment">/*xxGeq*/</span>( (<a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a>).QuadPart &gt;= ((CLIENT)-&gt;OldestLsn).QuadPart )                                  \
     &amp;&amp; <span class="comment">/*xxLeq*/</span>( (<a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a>).QuadPart &lt;= ((<a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a>)-&gt;RestartArea-&gt;CurrentLsn).QuadPart )                   \
     &amp;&amp; <span class="comment">/*xxNeqZero*/</span>( (<a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a>).QuadPart != 0 ))
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00602">602</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l01004">LfsFindClientNextLsn()</a>, and <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">LfsReadLogRecord()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="lfsprocs.h::LfsWaitForBufferNotification" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LfsWaitForBufferNotification          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d6/d3/cmwraper_8c.html#a20">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o10">BufferNotification</a>,     \
                           Executive,                       \
                           KernelMode,                      \
                           FALSE,                           \
                           NULL )
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00496">496</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00113">LfsAllocateSpanningBuffer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="lfsprocs.h::LiQuadAlign" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LiQuadAlign          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LI,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{         \
    *(OUT) = <span class="comment">/*xxAdd*/</span>( (LI) + 7 );       \
    *((PULONG)(OUT)) &amp;= 0xfffffff8;       \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00701">701</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00148">LfsFindNextLsn()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="lfsprocs.h::LongAlign" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LongAlign          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                \
    ((((ULONG)(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a>)) + 3) &amp; 0xfffffffc) \
    )
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00684">684</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="lfsprocs.h::PtrOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PtrOffset          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">BASE,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OFFSET&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((ULONG)((ULONG_PTR)(OFFSET) - (ULONG_PTR)(BASE)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00723">723</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="lfsprocs.h::QuadAlign" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define QuadAlign          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                \
    ((((ULONG)(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a>)) + 7) &amp; 0xfffffff8) \
    )
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00693">693</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="lfsprocs.h::SetFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SetFlag          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Flags,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SingleFlag&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{ \
    (Flags) |= (SingleFlag);        \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00662">662</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="lfsprocs.h::try_return" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define try_return          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">S&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;{ S; goto try_exit; }</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00754">754</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="lfsprocs.h::WordAlign" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define WordAlign          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                \
    ((((ULONG)(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a>)) + 1) &amp; 0xfffffffe) \
    )
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00675">675</a> of file <a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a67" doxytag="lfsprocs.h::LfsAllocateLbcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsAllocateLbcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00315">315</a> of file <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html">lfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d1/d4/lfsstruc_8h.html#a31">LBCB</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00610">LFCB_RESERVE_LBCB_COUNT</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00034">LFS_NTC_LBCB</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00188">_LBCB::NodeByteSize</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00187">_LBCB::NodeTypeCode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00311">LfsGetLbcb()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02514">LfsUpdateLfcbFromNoRestart()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>, and <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>.
<p>
<pre class="fragment"><div>00322                    :
00323 
00324     This routine will allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next Lbcb.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocation fails
00325     we will look at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">private</span> queue of Lbcb's.
00326 
00327 Arguments:
00328 
00329     Lfcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00330 
00331     Lbcb - Address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated Lbcb.
00332 
00333 Return Value:
00334 
00335     None
00336 
00337 --*/
00338 
00339 {
00340     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> NewLbcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00341 
00342     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00343 
00344     <span class="comment">//</span>
00345     <span class="comment">//  If there are enough entries on the look-aside list then get one from</span>
00346     <span class="comment">//  there.</span>
00347     <span class="comment">//</span>
00348 
00349     <span class="keywordflow">if</span> (Lfcb-&gt;SpareLbcbCount &gt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a15">LFCB_RESERVE_LBCB_COUNT</a>) {
00350 
00351         NewLbcb = (<a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a>) Lfcb-&gt;SpareLbcbList.Flink;
00352 
00353         Lfcb-&gt;SpareLbcbCount -= 1;
00354         RemoveHeadList( &amp;Lfcb-&gt;SpareLbcbList );
00355 
00356     <span class="comment">//</span>
00357     <span class="comment">//  Otherwise try to allocate from pool.</span>
00358     <span class="comment">//</span>
00359 
00360     } <span class="keywordflow">else</span> {
00361 
00362         NewLbcb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a> ), ' sfL' );
00363     }
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">//  If we didn't get one then look at the look-aside list.</span>
00367     <span class="comment">//</span>
00368 
00369     <span class="keywordflow">if</span> (NewLbcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00370 
00371         <span class="keywordflow">if</span> (Lfcb-&gt;SpareLbcbCount != 0) {
00372 
00373             NewLbcb = (<a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a>) Lfcb-&gt;SpareLbcbList.Flink;
00374 
00375             Lfcb-&gt;SpareLbcbCount -= 1;
00376             RemoveHeadList( &amp;Lfcb-&gt;SpareLbcbList );
00377 
00378         } <span class="keywordflow">else</span> {
00379 
00380             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00381         }
00382     }
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">//  Initialize the structure.</span>
00386     <span class="comment">//</span>
00387 
00388     RtlZeroMemory( NewLbcb, <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a> ));
00389     NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o0">NodeTypeCode</a> = <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a3">LFS_NTC_LBCB</a>;
00390     NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o1">NodeByteSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a> );
00391 
00392     <span class="comment">//</span>
00393     <span class="comment">//  Return it to the user.</span>
00394     <span class="comment">//</span>
00395 
00396     *Lbcb = NewLbcb;
00397     <span class="keywordflow">return</span>;
00398 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="lfsprocs.h::LfsAllocateLcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsAllocateLcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewLcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00463">463</a> of file <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html">lfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d1/d4/lfsstruc_8h.html#a25">LCB</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00613">LFCB_RESERVE_LCB_COUNT</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00032">LFS_NTC_LCB</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">LfsReadLogRecord()</a>.
<p>
<pre class="fragment"><div>00469                    :
00470 
00471     This routine will allocate an Lcb. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> fails we will fall back
00472     on our spare list. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> then will result in an exception
00473     
00474 Arguments:
00475 
00476     Lfcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00477 
00478     Lcb - This will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> lcb 
00479 
00480 Return Value:
00481 
00482     None
00483 
00484 --*/
00485 {
00486 
00487     ExAcquireFastMutex( &amp;(Lfcb-&gt;Sync-&gt;SpareListMutex) );
00488     
00489     <span class="keywordflow">try</span> {
00490         
00491         *NewLcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00492         <span class="keywordflow">if</span> (Lfcb-&gt;SpareLcbCount &lt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a17">LFCB_RESERVE_LCB_COUNT</a>) {                   
00493             (*NewLcb) = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ), ' sfL' );  
00494         }
00495         
00496         <span class="keywordflow">if</span> ((*NewLcb) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {                                                   
00497             <span class="keywordflow">if</span> (Lfcb-&gt;SpareLcbCount &gt; 0) {                                    
00498                 *NewLcb = (<a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>) Lfcb-&gt;SpareLcbList.Flink;                     
00499                 Lfcb-&gt;SpareLcbCount -= 1;                                     
00500                 RemoveHeadList( &amp;Lfcb-&gt;SpareLcbList );                        
00501             } <span class="keywordflow">else</span> {                                                           
00502                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );                 
00503             }                                                                   
00504         }                                                                       
00505         
00506         RtlZeroMemory( (*NewLcb), <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ) );                      
00507         (*NewLcb)-&gt;NodeTypeCode = <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a1">LFS_NTC_LCB</a>;                         
00508         (*NewLcb)-&gt;NodeByteSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> );                       
00509     
00510     } finally {
00511         ExReleaseFastMutex( &amp;(Lfcb-&gt;Sync-&gt;SpareListMutex) );
00512     }
00513 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="lfsprocs.h::LfsAllocateLfcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> LfsAllocateLfcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00041">41</a> of file <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html">lfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00099">_LFCB_SYNC::Event</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00120">FsRtlAllocatePool</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00415">_LFCB::LbcbActive</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00414">_LFCB::LbcbWorkque</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00321">_LFCB::LchLinks</a>, <a class="el" href="../../d1/d4/lfsstruc_8h.html#a34">LFCB</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00610">LFCB_RESERVE_LBCB_COUNT</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00613">LFCB_RESERVE_LCB_COUNT</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00035">LFS_NTC_LFCB</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00188">LfsDeallocateLfcb()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00040">LfsLi1</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00459">_LFCB::NextRestartLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00308">_LFCB::NodeByteSize</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00307">_LFCB::NodeTypeCode</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00091">_LFCB_SYNC::Resource</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00555">_LFCB::SpareLbcbCount</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00556">_LFCB::SpareLbcbList</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00563">_LFCB::SpareLcbCount</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00564">_LFCB::SpareLcbList</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00112">_LFCB_SYNC::SpareListMutex</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00570">_LFCB::Sync</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00106">_LFCB_SYNC::UserCount</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.
<p>
<pre class="fragment"><div>00046                    :
00047 
00048     This routine allocates and initializes a log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00049 
00050 Arguments:
00051 
00052 Return Value:
00053 
00054     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block just
00055                               allocated and initialized.
00056 
00057 --*/
00058 
00059 {
00060     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00061     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00062     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> NextLbcb;
00063     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>  NextLcb;
00064 
00065     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00066 
00067     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsAllocateLfcb:  Entered\n"</span>, 0 );
00068 
00069     <span class="comment">//</span>
00070     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00071     <span class="comment">//</span>
00072 
00073     <span class="keywordflow">try</span> {
00074 
00075         <span class="comment">//</span>
00076         <span class="comment">//  Allocate and zero the structure for the Lfcb.</span>
00077         <span class="comment">//</span>
00078 
00079         Lfcb = <a class="code" href="../../d5/d5/cc_8h.html#a8">FsRtlAllocatePool</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a> ));
00080 
00081         <span class="comment">//</span>
00082         <span class="comment">//  Zero out the structure initially.</span>
00083         <span class="comment">//</span>
00084 
00085         RtlZeroMemory( Lfcb, <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a> ));
00086 
00087         <span class="comment">//</span>
00088         <span class="comment">//  Initialize the log file control block.</span>
00089         <span class="comment">//</span>
00090 
00091         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o0">NodeTypeCode</a> = <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a4">LFS_NTC_LFCB</a>;
00092         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o1">NodeByteSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a> );
00093 
00094         <span class="comment">//</span>
00095         <span class="comment">//  Initialize the client links.</span>
00096         <span class="comment">//</span>
00097 
00098         InitializeListHead( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o3">LchLinks</a> );
00099 
00100         <span class="comment">//</span>
00101         <span class="comment">//  Initialize the Lbcb links.</span>
00102         <span class="comment">//</span>
00103 
00104         InitializeListHead( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o25">LbcbWorkque</a> );
00105         InitializeListHead( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o26">LbcbActive</a> );
00106 
00107         <span class="comment">//</span>
00108         <span class="comment">//  Initialize and allocate the spare Lbcb queue.</span>
00109         <span class="comment">//</span>
00110 
00111         InitializeListHead( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o56">SpareLbcbList</a> );
00112 
00113         <span class="keywordflow">for</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &lt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a15">LFCB_RESERVE_LBCB_COUNT</a>; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++) {
00114 
00115             NextLbcb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a> ), ' sfL' );
00116 
00117             <span class="keywordflow">if</span> (NextLbcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00118 
00119                 InsertHeadList( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o56">SpareLbcbList</a>, (PLIST_ENTRY) NextLbcb );
00120                 Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o55">SpareLbcbCount</a> += 1;
00121             }
00122         }
00123 
00124         <span class="comment">//</span>
00125         <span class="comment">//  Initialize and allocate the spare Lcb queue.</span>
00126         <span class="comment">//</span>
00127 
00128         InitializeListHead( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o58">SpareLcbList</a> );
00129 
00130         <span class="keywordflow">for</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &lt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a17">LFCB_RESERVE_LCB_COUNT</a>; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++)  {
00131 
00132             NextLcb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ), ' sfL' );
00133 
00134             <span class="keywordflow">if</span> (NextLcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00135 
00136                 InsertHeadList( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o58">SpareLcbList</a>, (PLIST_ENTRY) NextLcb );
00137                 Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o57">SpareLcbCount</a> += 1;
00138             }
00139         }
00140 
00141         <span class="comment">//</span>
00142         <span class="comment">//  Allocate the Lfcb synchronization event.</span>
00143         <span class="comment">//</span>
00144 
00145         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a> = <a class="code" href="../../d5/d5/cc_8h.html#a8">FsRtlAllocatePool</a>( NonPagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d0/struct__LFCB__SYNC.html">LFCB_SYNC</a> ));
00146 
00147         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o0">Resource</a> );
00148 
00149         <span class="comment">//</span>
00150         <span class="comment">//  Initialize the pseudo Lsn for the restart Lbcb's</span>
00151         <span class="comment">//</span>
00152 
00153         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o37">NextRestartLsn</a> = <a class="code" href="../../d7/d3/lfsdata_8c.html#a3">LfsLi1</a>;
00154 
00155         <span class="comment">//</span>
00156         <span class="comment">//  Initialize the event to the signalled state.</span>
00157         <span class="comment">//</span>
00158 
00159         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o1">Event</a>, NotificationEvent, TRUE );
00160 
00161         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o2">UserCount</a> = 0;
00162 
00163         <span class="comment">//</span>
00164         <span class="comment">//  Initialize the spare list mutex</span>
00165         <span class="comment">//</span>
00166 
00167         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( &amp;(Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o3">SpareListMutex</a>) );
00168 
00169     } finally {
00170 
00171         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsAllocateFileControlBlock );
00172 
00173         <span class="keywordflow">if</span> (AbnormalTermination()
00174             &amp;&amp; Lfcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00175 
00176             <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a2">LfsDeallocateLfcb</a>( Lfcb, TRUE );
00177             Lfcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00178         }
00179 
00180         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsAllocateLfcb:  Exit -&gt; %08lx\n"</span>, Lfcb );
00181     }
00182 
00183     <span class="keywordflow">return</span> Lfcb;
00184 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="lfsprocs.h::LfsAllocateSpanningBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID LfsAllocateSpanningBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00113">113</a> of file <a class="el" href="../../d7/d4/logpgsup_8c-source.html">logpgsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00657">_LFS_DATA::Buffer1</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00658">_LFS_DATA::Buffer2</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00660">_LFS_DATA::BufferFlags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00659">_LFS_DATA::BufferOwner</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02455">ExGetCurrentResourceThread</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00670">LFS_BUFFER1_OWNED</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00671">LFS_BUFFER2_OWNED</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00673">LFS_BUFFER_SIZE</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00490">LfsAcquireBufferLock</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00509">LfsAcquireLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00046">LfsAllocatePoolNoRaise</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00506">LfsBlockBufferWaiters</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00033">LfsData</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00493">LfsReleaseBufferLock</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00496">LfsWaitForBufferNotification</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l00809">LfsFindLogRecord()</a>.
<p>
<pre class="fragment"><div>00120                    :
00121 
00122     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to allocate a spare buffer to read a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> record
00123     which spans a log page.  We will first <span class="keywordflow">try</span> to allocate one.  If that
00124     fails we will use one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> existing spare buffers.  If that fails then
00125     we will raise.
00126 
00127 Arguments:
00128 
00129     Lfcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00130 
00131     Length - Length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer required.
00132 
00133 Return Value:
00134 
00135     PVOID - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to use <span class="keywordflow">for</span> reading <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record.
00136         May be either from <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> or from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> auxilary buffer <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00137 
00138 --*/
00139 
00140 {
00141     PVOID NewBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00142     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> Thread;
00143     BOOLEAN Wait = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00144 
00145     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00146 
00147     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsAllocateSpanningBuffer:  Entered\n"</span>, 0 );
00148 
00149     <span class="comment">//</span>
00150     <span class="comment">//  Loop while we don't have a buffer.  First try to get our reserved buffer</span>
00151     <span class="comment">//  without waiting.  Then try to allocate a buffer.  Finally wait for the reserved</span>
00152     <span class="comment">//  buffer as the final alternative.</span>
00153     <span class="comment">//</span>
00154 
00155     <span class="keywordflow">do</span> {
00156 
00157         <span class="comment">//</span>
00158         <span class="comment">//  Skip the reserved buffer if the request is larger than we can read into it.</span>
00159         <span class="comment">//</span>
00160 
00161         <span class="keywordflow">if</span> (Length &lt;= <a class="code" href="../../d1/d4/lfsstruc_8h.html#a23">LFS_BUFFER_SIZE</a>) {
00162 
00163             <span class="comment">//</span>
00164             <span class="comment">//  If this thread already owns one buffer it can get the second directly.</span>
00165             <span class="comment">//</span>
00166 
00167             Thread = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
00168 
00169             <span class="keywordflow">if</span> (Thread == <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o7">BufferOwner</a>) {
00170 
00171                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER1_OWNED )) {
00172 
00173                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER1_OWNED );
00174                     NewBuffer = <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o5">Buffer1</a>;
00175                     <span class="keywordflow">break</span>;
00176 
00177                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER2_OWNED )) {
00178 
00179                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER2_OWNED );
00180                     NewBuffer = <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o6">Buffer2</a>;
00181                     <span class="keywordflow">break</span>;
00182 
00183                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Wait) {
00184 
00185                     <span class="comment">//</span>
00186                     <span class="comment">//  This shouldn't happen but handle anyway.</span>
00187                     <span class="comment">//</span>
00188 
00189                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsAllocateSpanningBuffer:  Exit\n"</span>, 0 );
00190                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00191                 }
00192 
00193             <span class="comment">//</span>
00194             <span class="comment">//  Otherwise acquire the buffer lock and check the state of the buffers.</span>
00195             <span class="comment">//</span>
00196 
00197             } <span class="keywordflow">else</span> {
00198 
00199                 BOOLEAN LfcbOwned = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00200 
00201                 <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00202 
00203                     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a23">LfsAcquireBufferLock</a>();
00204 
00205                     <span class="comment">//</span>
00206                     <span class="comment">//  Check to see if the buffers are available.  No</span>
00207                     <span class="comment">//  need to drop the Lfcb in the typical case.</span>
00208                     <span class="comment">//</span>
00209 
00210                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o7">BufferOwner</a> == (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00211 
00212                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER1_OWNED | LFS_BUFFER2_OWNED ));
00213                         NewBuffer = <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o5">Buffer1</a>;
00214                         <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o7">BufferOwner</a> = Thread;
00215                         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER1_OWNED );
00216                         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a27">LfsBlockBufferWaiters</a>();
00217                         
00218                         <span class="comment">//</span>
00219                         <span class="comment">//  Reacquire the Lfcb if needed.</span>
00220                         <span class="comment">//</span>
00221 
00222                         <span class="keywordflow">if</span> (!LfcbOwned) { 
00223 
00224                             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
00225                         }
00226 
00227                         <span class="comment">//</span>
00228                         <span class="comment">//  Break out.</span>
00229                         <span class="comment">//</span>
00230 
00231                         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a24">LfsReleaseBufferLock</a>();
00232                         <span class="keywordflow">break</span>;
00233                     }
00234 
00235                     <span class="comment">//</span>
00236                     <span class="comment">//  Release the Lfcb and wait on the notification for the buffers.</span>
00237                     <span class="comment">//</span>
00238 
00239                     <span class="keywordflow">if</span> (Wait) {
00240 
00241                         <span class="keywordflow">if</span> (LfcbOwned) { 
00242                             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
00243                             LfcbOwned = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00244                         }
00245 
00246                         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a24">LfsReleaseBufferLock</a>();
00247                         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a25">LfsWaitForBufferNotification</a>();
00248 
00249                     } <span class="keywordflow">else</span> {
00250 
00251                         <span class="comment">//</span>
00252                         <span class="comment">//  Go ahead and try to allocate a buffer from pool next.</span>
00253                         <span class="comment">//</span>
00254 
00255                         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a24">LfsReleaseBufferLock</a>();
00256                         <span class="keywordflow">break</span>;
00257                     }
00258                 }
00259             }
00260 
00261         <span class="comment">//</span>
00262         <span class="comment">//  Raise if we already tried the allocate path.</span>
00263         <span class="comment">//</span>
00264 
00265         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Wait) {
00266 
00267             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsAllocateSpanningBuffer:  Exit\n"</span>, 0 );
00268             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00269         }
00270 
00271         <span class="comment">//</span>
00272         <span class="comment">//  Try pool if we didn't get a buffer above.</span>
00273         <span class="comment">//</span>
00274 
00275         <span class="keywordflow">if</span> (NewBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00276 
00277             <span class="comment">//</span>
00278             <span class="comment">//  Try pool next but don't let this fail on pool allocation.</span>
00279             <span class="comment">//</span>
00280 
00281             NewBuffer = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a2">LfsAllocatePoolNoRaise</a>( PagedPool, Length );
00282         }
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">//  Wait on the next pass through the loop.</span>
00286         <span class="comment">//</span>
00287 
00288         Wait = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00289 
00290     } <span class="keywordflow">while</span> (NewBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00291 
00292     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsAllocateSpanningBuffer:  Exit\n"</span>, 0 );
00293     <span class="keywordflow">return</span> NewBuffer;
00294 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="lfsprocs.h::LfsCopyReadLogRecord" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsCopyReadLogRecord           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RecordHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00339">339</a> of file <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html">lfs/cachesup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00308">LfsLsnToPageOffset</a>, <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00040">LfsNextLogPageOffset()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">LfsPinOrMapData()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00297">LfsTruncateLsnToLogPage</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00253">LOG_PAGE_LOG_RECORD_END</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l00809">LfsFindLogRecord()</a>, and <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>.
<p>
<pre class="fragment"><div>00347                    :
00348 
00349     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> copies a log record from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to a buffer.  The log
00350     record may span several log pages and may even wrap in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00351 
00352 Arguments:
00353 
00354     Lfcb - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00355 
00356     RecordHeader - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record header <span class="keywordflow">for</span> <span class="keyword">this</span> log record.
00357 
00358     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record.
00359 
00360 Return Value:
00361 
00362     None.
00363 
00364 --*/
00365 
00366 {
00367     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> Bcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00368     BOOLEAN UsaError;
00369 
00370     <a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a> PageHeader;
00371 
00372     LONGLONG LogPageFileOffset;
00373     ULONG LogPageOffset;
00374 
00375     ULONG RemainingTransferBytes;
00376 
00377     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00378 
00379     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsCopyReadLogRecord:  Entered\n"</span>, 0 );
00380     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb           -&gt; %08lx\n"</span>, Lfcb );
00381     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"RecordHeader   -&gt; %08lx\n"</span>, RecordHeader );
00382     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer         -&gt; %08lx\n"</span>, Buffer );
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">//  We find the file offset of the log page containing the start of</span>
00386     <span class="comment">//  this log record, the offset within the page to start the transfer from,</span>
00387     <span class="comment">//  the number of bytes to transfer on this page and the starting</span>
00388     <span class="comment">//  position in the buffer to begin the transfer to.</span>
00389     <span class="comment">//</span>
00390 
00391     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a11">LfsTruncateLsnToLogPage</a>( Lfcb, RecordHeader-&gt;ThisLsn, &amp;LogPageFileOffset );
00392     LogPageOffset = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a14">LfsLsnToPageOffset</a>( Lfcb, RecordHeader-&gt;ThisLsn ) + Lfcb-&gt;RecordHeaderLength;
00393 
00394     RemainingTransferBytes = RecordHeader-&gt;ClientDataLength;
00395 
00396     <span class="comment">//</span>
00397     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00398     <span class="comment">//</span>
00399 
00400     <span class="keywordflow">try</span> {
00401 
00402         <span class="comment">//</span>
00403         <span class="comment">//  While there are more bytes to transfer, we continue to attempt to</span>
00404         <span class="comment">//  perform the read.</span>
00405         <span class="comment">//</span>
00406 
00407         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00408 
00409             ULONG RemainingPageBytes;
00410 
00411             BOOLEAN Wrapped;
00412 
00413             RemainingPageBytes = (ULONG)Lfcb-&gt;LogPageSize - LogPageOffset;
00414 
00415             <span class="comment">//</span>
00416             <span class="comment">//  We compute the number of bytes to read from this log page and</span>
00417             <span class="comment">//  call the cache package to perform the transfer.</span>
00418             <span class="comment">//</span>
00419 
00420             <span class="keywordflow">if</span> (RemainingTransferBytes &lt;= RemainingPageBytes) {
00421 
00422                 RemainingPageBytes = RemainingTransferBytes;
00423             }
00424 
00425             RemainingTransferBytes -= RemainingPageBytes;
00426 
00427             <span class="comment">//</span>
00428             <span class="comment">//  Unpin any previous buffer.</span>
00429             <span class="comment">//</span>
00430 
00431             <span class="keywordflow">if</span> (Bcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00432 
00433                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( Bcb );
00434                 Bcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00435             }
00436 
00437             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
00438                              LogPageFileOffset,
00439                              (ULONG)Lfcb-&gt;LogPageSize,
00440                              FALSE,
00441                              FALSE,
00442                              TRUE,
00443                              &amp;UsaError,
00444                              (PVOID *) &amp;PageHeader,
00445                              &amp;Bcb );
00446 
00447             <span class="comment">//</span>
00448             <span class="comment">//  The last Lsn on this page better be greater or equal to the Lsn we</span>
00449             <span class="comment">//  are copying.</span>
00450             <span class="comment">//</span>
00451 
00452             <span class="keywordflow">if</span> ( PageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.LastLsn.QuadPart &lt; RecordHeader-&gt;ThisLsn.QuadPart ) {
00453 
00454                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00455             }
00456 
00457             RtlCopyMemory( Buffer,
00458                            <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( PageHeader, LogPageOffset, PVOID ),
00459                            RemainingPageBytes );
00460 
00461             <span class="comment">//</span>
00462             <span class="comment">//  If there are no more bytes to transfer, we exit the loop.</span>
00463             <span class="comment">//</span>
00464 
00465             <span class="keywordflow">if</span> (RemainingTransferBytes == 0) {
00466 
00467                 <span class="comment">//</span>
00468                 <span class="comment">//  Our log record better not span this page.</span>
00469                 <span class="comment">//</span>
00470 
00471                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( PageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o4">Flags</a>, LOG_PAGE_LOG_RECORD_END )
00472 
00473                     || (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )
00474                         &amp;&amp; ( RecordHeader-&gt;ThisLsn.QuadPart &gt; PageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.LastEndLsn.QuadPart ))) {
00475 
00476                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00477                 }
00478 
00479                 <span class="keywordflow">break</span>;
00480             }
00481 
00482             <span class="comment">//</span>
00483             <span class="comment">//  If the page header indicates that the log record ended on this page,</span>
00484             <span class="comment">//  this is a disk corrupt condition.  For a packed page it means</span>
00485             <span class="comment">//  that the last Lsn and the last Ending Lsn are the same.</span>
00486             <span class="comment">//</span>
00487 
00488             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )) {
00489 
00490                 <span class="comment">//</span>
00491                 <span class="comment">//  If there is no spanning log record this is an error.</span>
00492                 <span class="comment">//</span>
00493 
00494                 <span class="keywordflow">if</span> (( PageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.LastLsn.QuadPart == PageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.LastEndLsn.QuadPart )
00495 
00496                     || ( RecordHeader-&gt;ThisLsn.QuadPart &gt; PageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.LastLsn.QuadPart )) {
00497 
00498                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00499                 }
00500 
00501             <span class="comment">//</span>
00502             <span class="comment">//  For an unpacked page it simply means that the page</span>
00503             <span class="comment">//  contains the end of a log record.</span>
00504             <span class="comment">//</span>
00505 
00506             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( PageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o4">Flags</a>, LOG_PAGE_LOG_RECORD_END )) {
00507 
00508                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00509             }
00510 
00511             <span class="comment">//</span>
00512             <span class="comment">//  We find the start of the next log page and the offset within</span>
00513             <span class="comment">//  that page to start transferring bytes.</span>
00514             <span class="comment">//</span>
00515 
00516             <a class="code" href="../../d6/d5/logpgsup_8c.html#a2">LfsNextLogPageOffset</a>( Lfcb,
00517                                   LogPageFileOffset,
00518                                   &amp;LogPageFileOffset,
00519                                   &amp;Wrapped );
00520 
00521             LogPageOffset = (ULONG)Lfcb-&gt;LogPageDataOffset;
00522 
00523             <span class="comment">//</span>
00524             <span class="comment">//  We also adjust our pointer in the user's buffer to transfer</span>
00525             <span class="comment">//  the next block to.</span>
00526             <span class="comment">//</span>
00527 
00528             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Buffer, RemainingPageBytes, PVOID );
00529         }
00530 
00531     } finally {
00532 
00533         <span class="comment">//</span>
00534         <span class="comment">//  Unpin any previous buffer.</span>
00535         <span class="comment">//</span>
00536 
00537         <span class="keywordflow">if</span> (Bcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00538 
00539             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( Bcb );
00540             Bcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00541         }
00542 
00543         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsCopyReadLogRecord:  Exit\n"</span>, 0 );
00544     }
00545 
00546     <span class="keywordflow">return</span>;
00547 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a71" doxytag="lfsprocs.h::LfsCurrentAvailSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsCurrentAvailSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentAvailSpace</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentPageBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00036">36</a> of file <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html">lfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00219">_LBCB::BufferOffset</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00286">LBCB_FLUSH_COPY</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00285">LBCB_NOT_EMPTY</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00273">_LBCB::LbcbFlags</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00134">LfsFlushToLsnPriv()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01141">LfsReadLogFileInformation()</a>, and <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00114">LfsVerifyLogSpaceAvail()</a>.
<p>
<pre class="fragment"><div>00044                    :
00045 
00046     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> available log space in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00047     It returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> total number of free bytes and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number available on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00048     active page <span class="keywordflow">if</span> present.  The total free bytes will reflect all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> empty
00049     pages as well as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active page.
00050 
00051 Arguments:
00052 
00053     Lfcb - Lfcb <span class="keywordflow">for</span> <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00054 
00055     CurrentAvailSpace - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes available <span class="keywordflow">for</span> log
00056                         records.
00057 
00058     CurrentPageBytes - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes remaining on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00059                        current log page.
00060 
00061 Return Value:
00062 
00063     None.
00064 
00065 --*/
00066 
00067 {
00068     *CurrentPageBytes = 0;
00069 
00070     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00071 
00072     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsCurrentAvailSpace:  Entered\n"</span>, 0 );
00073 
00074     <span class="comment">//</span>
00075     <span class="comment">//  Get the total number from the Lfcb.</span>
00076     <span class="comment">//</span>
00077 
00078     *CurrentAvailSpace = Lfcb-&gt;CurrentAvailable;
00079 
00080     <span class="comment">//</span>
00081     <span class="comment">//  We now look to see if there are any bytes available on the Lbcb in</span>
00082     <span class="comment">//  the active queue.  We can add this to the bytes available in the</span>
00083     <span class="comment">//  log pages and also give this back to the caller.</span>
00084     <span class="comment">//</span>
00085 
00086     <span class="keywordflow">if</span> (!IsListEmpty( &amp;Lfcb-&gt;LbcbActive )) {
00087 
00088         <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> ThisLbcb;
00089 
00090         ThisLbcb = CONTAINING_RECORD( Lfcb-&gt;LbcbActive.Flink,
00091                                       <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00092                                       ActiveLinks );
00093 
00094         <span class="comment">//</span>
00095         <span class="comment">//  If the page is not empty or the page is empty but this is a</span>
00096         <span class="comment">//  restart page then add the remaining bytes on this page.</span>
00097         <span class="comment">//</span>
00098 
00099         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_NOT_EMPTY | LBCB_FLUSH_COPY )) {
00100 
00101             *CurrentPageBytes = (ULONG)Lfcb-&gt;LogPageSize - (ULONG)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a>;
00102 
00103             *CurrentAvailSpace = *CurrentAvailSpace + *CurrentPageBytes;                                               <span class="comment">//**** xxAdd( *CurrentAvailSpace, xxFromUlong( *CurrentPageBytes ));</span>
00104         }
00105     }
00106 
00107     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsCurrentAvailSpace:  Exit\n"</span>, 0 );
00108 
00109     <span class="keywordflow">return</span>;
00110 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="lfsprocs.h::LfsDeallocateLbcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsDeallocateLbcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00402">402</a> of file <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html">lfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00287">LBCB_RESTART_LBCB</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00611">LFCB_MAX_LBCB_COUNT</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00442">LfsDeallocateRestartArea</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00188">LfsDeallocateLfcb()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">LfsFlushLfcb()</a>, and <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00311">LfsGetLbcb()</a>.
<p>
<pre class="fragment"><div>00409                    :
00410 
00411     This routine will deallocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lbcb.  If we need one <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> look-aside
00412     list we will put <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> there.
00413 
00414 Arguments:
00415 
00416     Lfcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00417 
00418     Lbcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lbcb to deallocate.
00419 
00420 Return Value:
00421 
00422     None
00423 
00424 --*/
00425 
00426 {
00427     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00428 
00429     <span class="comment">//</span>
00430     <span class="comment">//  Deallocate any restart area attached to this Lbcb.</span>
00431     <span class="comment">//</span>
00432 
00433     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lbcb-&gt;LbcbFlags, LBCB_RESTART_LBCB ) &amp;&amp;
00434         (Lbcb-&gt;PageHeader != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00435 
00436         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a19">LfsDeallocateRestartArea</a>( Lbcb-&gt;PageHeader );
00437     }
00438 
00439     <span class="comment">//</span>
00440     <span class="comment">//  Put this in the Lbcb queue if it is short.</span>
00441     <span class="comment">//</span>
00442 
00443     <span class="keywordflow">if</span> (Lfcb-&gt;SpareLbcbCount &lt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a16">LFCB_MAX_LBCB_COUNT</a>) {
00444 
00445         InsertHeadList( &amp;Lfcb-&gt;SpareLbcbList, (PLIST_ENTRY) Lbcb );
00446         Lfcb-&gt;SpareLbcbCount += 1;
00447 
00448     <span class="comment">//</span>
00449     <span class="comment">//  Otherwise just free the pool block.</span>
00450     <span class="comment">//</span>
00451 
00452     } <span class="keywordflow">else</span> {
00453 
00454         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lbcb );
00455     }
00456 
00457     <span class="keywordflow">return</span>;
00458 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="lfsprocs.h::LfsDeallocateLcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsDeallocateLcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00518">518</a> of file <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html">lfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00614">LFCB_MAX_LCB_COUNT</a>, <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00297">LfsFreeSpanningBuffer()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">LfsReadLogRecord()</a>, and <a class="el" href="../../d4/d2/querylog_8c-source.html#l00594">LfsTerminateLogQuery()</a>.
<p>
<pre class="fragment"><div>00524                    :
00525 
00526     This routine will deallocate an Lcb. We'll cache <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old lcb <span class="keywordflow">if</span> there
00527     aren'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> too many already on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> spare list
00528     
00529 Arguments:
00530 
00531     Lfcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00532 
00533     Lcb - This will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lcb to release
00534 
00535 Return Value:
00536 
00537     None
00538 
00539 --*/
00540 
00541 {
00542     <span class="keywordflow">if</span> (Lcb-&gt;RecordHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {                               
00543         <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( Lcb-&gt;RecordHeaderBcb );                          
00544     }                                                                   
00545     <span class="keywordflow">if</span> ((Lcb-&gt;CurrentLogRecord != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; Lcb-&gt;AuxilaryBuffer) {                             
00546         <a class="code" href="../../d6/d5/logpgsup_8c.html#a4">LfsFreeSpanningBuffer</a>( Lcb-&gt;CurrentLogRecord );                          
00547     }                                                                   
00548 
00549     ExAcquireFastMutex( &amp;(Lfcb-&gt;Sync-&gt;SpareListMutex) );
00550 
00551     <span class="keywordflow">try</span> {
00552         <span class="keywordflow">if</span> (Lfcb-&gt;SpareLcbCount &lt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a18">LFCB_MAX_LCB_COUNT</a>) {                   
00553             InsertHeadList( &amp;Lfcb-&gt;SpareLcbList, (PLIST_ENTRY) Lcb );   
00554             Lfcb-&gt;SpareLcbCount += 1;                                     
00555         } <span class="keywordflow">else</span> {                                                            
00556             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lcb );                                              
00557         }                                                                   
00558     } finally {
00559         ExReleaseFastMutex( &amp;(Lfcb-&gt;Sync-&gt;SpareListMutex) );    
00560     }
00561 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="lfsprocs.h::LfsDeallocateLfcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsDeallocateLfcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CompleteTeardown</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00188">188</a> of file <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html">lfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02478">ExDeleteResource</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00402">LfsDeallocateLbcb()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00442">LfsDeallocateRestartArea</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00041">LfsAllocateLfcb()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.
<p>
<pre class="fragment"><div>00195                    :
00196 
00197     This routine releases <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources associated with a log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>
00198     block.
00199 
00200 Arguments:
00201 
00202     Lfcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00203 
00204     CompleteTeardown - Indicates <span class="keywordflow">if</span> we are to completely remove <span class="keyword">this</span> Lfcb.
00205 
00206 Return Value:
00207 
00208     None
00209 
00210 --*/
00211 
00212 {
00213     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> NextLbcb;
00214     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>  NextLcb;
00215 
00216     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00217 
00218     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsDeallocateLfcb:  Entered\n"</span>, 0 );
00219     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb  -&gt; %08lx\n"</span>, Lfcb );
00220 
00221     <span class="comment">//</span>
00222     <span class="comment">//  Check that there are no buffer blocks.</span>
00223     <span class="comment">//</span>
00224 
00225     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IsListEmpty( &amp;Lfcb-&gt;LbcbActive ));
00226     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IsListEmpty( &amp;Lfcb-&gt;LbcbWorkque ));
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">//  Check that we have no clients.</span>
00230     <span class="comment">//</span>
00231 
00232     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IsListEmpty( &amp;Lfcb-&gt;LchLinks ));
00233 
00234     <span class="comment">//</span>
00235     <span class="comment">//  If there is a restart area we deallocate it.</span>
00236     <span class="comment">//</span>
00237 
00238     <span class="keywordflow">if</span> (Lfcb-&gt;RestartArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00239 
00240         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a19">LfsDeallocateRestartArea</a>( Lfcb-&gt;RestartArea );
00241     }
00242 
00243     <span class="comment">//</span>
00244     <span class="comment">//  If there are any of the tail Lbcb's, deallocate them now.</span>
00245     <span class="comment">//</span>
00246 
00247     <span class="keywordflow">if</span> (Lfcb-&gt;ActiveTail != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00248 
00249         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a>( Lfcb, Lfcb-&gt;ActiveTail );
00250         Lfcb-&gt;ActiveTail = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00251     }
00252 
00253     <span class="keywordflow">if</span> (Lfcb-&gt;PrevTail != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00254 
00255         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a>( Lfcb, Lfcb-&gt;PrevTail );
00256         Lfcb-&gt;PrevTail = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00257     }
00258 
00259     <span class="comment">//</span>
00260     <span class="comment">//  Only do the following if we are to remove the Lfcb completely.</span>
00261     <span class="comment">//</span>
00262 
00263     <span class="keywordflow">if</span> (CompleteTeardown) {
00264 
00265         <span class="comment">//</span>
00266         <span class="comment">//  If there is a resource structure we deallocate it.</span>
00267         <span class="comment">//</span>
00268 
00269         <span class="keywordflow">if</span> (Lfcb-&gt;Sync != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00270 
00271             <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>( &amp;Lfcb-&gt;Sync-&gt;Resource );
00272 
00273             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lfcb-&gt;Sync );
00274         }
00275     }
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">//  Deallocate all of the spare Lbcb's.</span>
00279     <span class="comment">//</span>
00280 
00281     <span class="keywordflow">while</span> (!IsListEmpty( &amp;Lfcb-&gt;SpareLbcbList )) {
00282 
00283         NextLbcb = (<a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a>) Lfcb-&gt;SpareLbcbList.Flink;
00284 
00285         RemoveHeadList( &amp;Lfcb-&gt;SpareLbcbList );
00286 
00287         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NextLbcb );
00288     }
00289 
00290     <span class="comment">//</span>
00291     <span class="comment">//  Deallocate all of the spare Lcb's.</span>
00292     <span class="comment">//</span>
00293 
00294     <span class="keywordflow">while</span> (!IsListEmpty( &amp;Lfcb-&gt;SpareLcbList )) {
00295 
00296         NextLcb = (<a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>) Lfcb-&gt;SpareLcbList.Flink;
00297 
00298         RemoveHeadList( &amp;Lfcb-&gt;SpareLcbList );
00299 
00300         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NextLcb );
00301     }
00302 
00303     <span class="comment">//</span>
00304     <span class="comment">//  Discard the Lfcb structure.</span>
00305     <span class="comment">//</span>
00306 
00307     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lfcb );
00308 
00309     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsDeallocateLfcb:  Exit\n"</span>, 0 );
00310     <span class="keywordflow">return</span>;
00311 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="lfsprocs.h::LfsExceptionFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG LfsExceptionFilter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_POINTERS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExceptionPointer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">58</a> of file <a class="el" href="../../d8/d2/lfsdata_8c-source.html">lfsdata.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00056">EXCEPTION_CONTINUE_SEARCH</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00082">FsRtlIsNtstatusExpected()</a>, and <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01063">LfsDeleteLogHandle()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00360">LfsFlushToLsn()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00197">LfsForceWrite()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">LfsPinOrMapData()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">LfsReadLogRecord()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00299">LfsReadNextLogRecord()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">LfsSetBaseLsn()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00039">LfsWrite()</a>, and <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>.
<p>
<pre class="fragment"><div>00064                    :
00065 
00066     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to decide <span class="keywordflow">if</span> we should or should not handle
00067     an exception status that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being raised.  It indicates that we should handle
00068     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception or bug check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
00069 
00070 Arguments:
00071 
00072     ExceptionCode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception code to being checked.
00073 
00074 Return Value:
00075 
00076     ULONG - returns <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> or bugchecks
00077 
00078 --*/
00079 
00080 {
00081     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ExceptionCode = ExceptionPointer-&gt;ExceptionRecord-&gt;ExceptionCode;
00082 
00083 <span class="preprocessor">#ifdef NTFS_RESTART</span>
00084 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ExceptionCode != STATUS_DISK_CORRUPT_ERROR) &amp;&amp;
00085             (ExceptionCode != STATUS_FILE_CORRUPT_ERROR) );
00086 <span class="preprocessor">#endif</span>
00087 <span class="preprocessor"></span>
00088     <span class="comment">//if (ExceptionCode != STATUS_LOG_FILE_FULL) {</span>
00089     <span class="comment">//</span>
00090     <span class="comment">//    DbgPrint("Status not LOGFILE FULL, ExceptionPointers = %08lx\n", ExceptionPointer);</span>
00091     <span class="comment">//    DbgBreakPoint();</span>
00092     <span class="comment">//}</span>
00093 
00094     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>( ExceptionCode )) {
00095 
00096         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a>;
00097 
00098     } <span class="keywordflow">else</span> {
00099 
00100         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00101     }
00102 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="lfsprocs.h::LfsFindCurrentAvail" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsFindCurrentAvail           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Lfcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00412">412</a> of file <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html">lfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00601">LFCB_NO_LAST_LSN</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00604">LFCB_NO_OLDEST_LSN</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00603">LFCB_REUSE_TAIL</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00184">LfsTruncateOffsetToLogPage</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00582">LfsSetBaseLsnPriv()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>.
<p>
<pre class="fragment"><div>00418                    :
00419 
00420     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to calculate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes available <span class="keywordflow">for</span> log
00421     records which are in completely empty log record pages.  It ignores any
00422     partial pages in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active work queue and ignores any page which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00423     going to be reused.
00424 
00425 Arguments:
00426 
00427     Lfcb - Lfcb <span class="keywordflow">for</span> <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00428 
00429 Return Value:
00430 
00431     None.
00432 
00433 --*/
00434 
00435 {
00436     LONGLONG OldestPageOffset;
00437     LONGLONG NextFreePageOffset;
00438     LONGLONG FreeBytes;
00439 
00440     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00441 
00442     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsFindCurrentAvail:  Entered\n"</span>, 0 );
00443     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb              -&gt; %08x\n"</span>, Lfcb );
00444 
00445     <span class="comment">//</span>
00446     <span class="comment">//  If there is a last lsn in the restart area then we know</span>
00447     <span class="comment">//  that we will have to compute the free range.</span>
00448     <span class="comment">//</span>
00449 
00450     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_NO_LAST_LSN )) {
00451 
00452         <span class="comment">//</span>
00453         <span class="comment">//  If there is no oldest Lsn then start at the</span>
00454         <span class="comment">//  first page of the file.</span>
00455         <span class="comment">//</span>
00456 
00457         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_NO_OLDEST_LSN )) {
00458 
00459             OldestPageOffset = Lfcb-&gt;FirstLogPage;
00460 
00461         } <span class="keywordflow">else</span> {
00462 
00463             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a6">LfsTruncateOffsetToLogPage</a>( Lfcb,
00464                                         Lfcb-&gt;OldestLsnOffset,
00465                                         &amp;OldestPageOffset );
00466         }
00467 
00468         <span class="comment">//</span>
00469         <span class="comment">//  We will use the next log page offset to compute the</span>
00470         <span class="comment">//  next free page.  If we are going to reuse this page</span>
00471         <span class="comment">//  go to the next page,  if we are at the first page then</span>
00472         <span class="comment">//  use the end of the file.</span>
00473         <span class="comment">//</span>
00474 
00475         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_REUSE_TAIL )) {
00476 
00477             NextFreePageOffset = Lfcb-&gt;NextLogPage + Lfcb-&gt;LogPageSize;                                                <span class="comment">//**** xxAdd( Lfcb-&gt;NextLogPage, Lfcb-&gt;LogPageSize );</span>
00478 
00479         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( Lfcb-&gt;NextLogPage == Lfcb-&gt;FirstLogPage ) {                                                        <span class="comment">//**** xxEql( Lfcb-&gt;NextLogPage, Lfcb-&gt;FirstLogPage )</span>
00480 
00481             NextFreePageOffset = Lfcb-&gt;FileSize;
00482 
00483         } <span class="keywordflow">else</span> {
00484 
00485             NextFreePageOffset = Lfcb-&gt;NextLogPage;
00486         }
00487 
00488         <span class="comment">//</span>
00489         <span class="comment">//  If the two offsets are the same then there is no available space.</span>
00490         <span class="comment">//</span>
00491 
00492         <span class="keywordflow">if</span> ( OldestPageOffset == NextFreePageOffset ) {                                                                <span class="comment">//**** xxEql( OldestPageOffset, NextFreePageOffset )</span>
00493 
00494             Lfcb-&gt;CurrentAvailable = 0;
00495 
00496         } <span class="keywordflow">else</span> {
00497 
00498             <span class="comment">//</span>
00499             <span class="comment">//  If the free offset follows the oldest offset then subtract</span>
00500             <span class="comment">//  this range from the total available pages.</span>
00501             <span class="comment">//</span>
00502 
00503             <span class="keywordflow">if</span> ( OldestPageOffset &lt; NextFreePageOffset ) {                                                             <span class="comment">//**** xxLtr( OldestPageOffset, NextFreePageOffset )</span>
00504 
00505                 FreeBytes = Lfcb-&gt;TotalAvailInPages - ( NextFreePageOffset - OldestPageOffset );                       <span class="comment">//**** xxSub( Lfcb-&gt;TotalAvailInPages, xxSub( NextFreePageOffset, OldestPageOffset ));</span>
00506 
00507             } <span class="keywordflow">else</span> {
00508 
00509                 FreeBytes = OldestPageOffset - NextFreePageOffset;                                                     <span class="comment">//**** xxSub( OldestPageOffset, NextFreePageOffset );</span>
00510             }
00511 
00512             <span class="comment">//</span>
00513             <span class="comment">//  We now have the total bytes in the pages available.  We</span>
00514             <span class="comment">//  now have to subtract the size of the page header to get</span>
00515             <span class="comment">//  the total available bytes.</span>
00516             <span class="comment">//</span>
00517             <span class="comment">//  We will convert the bytes to pages and then multiple</span>
00518             <span class="comment">//  by the data size of each page.</span>
00519             <span class="comment">//</span>
00520 
00521             FreeBytes = Int64ShrlMod32(((ULONGLONG)(FreeBytes)), Lfcb-&gt;LogPageShift);
00522 
00523             Lfcb-&gt;CurrentAvailable = FreeBytes * (ULONG)Lfcb-&gt;ReservedLogPageSize;                                     <span class="comment">//**** xxXMul( FreeBytes, Lfcb-&gt;ReservedLogPageSize.LowPart );</span>
00524         }
00525 
00526     <span class="comment">//</span>
00527     <span class="comment">//  Otherwise the entire file is available.</span>
00528     <span class="comment">//</span>
00529 
00530     } <span class="keywordflow">else</span> {
00531 
00532         Lfcb-&gt;CurrentAvailable = Lfcb-&gt;MaxCurrentAvail;
00533     }
00534 
00535     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsFindCurrentAvail:  Exit\n"</span>, 0 );
00536 
00537     <span class="keywordflow">return</span>;
00538 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="lfsprocs.h::LfsFindNextLsn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LfsFindNextLsn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RecordHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00148">148</a> of file <a class="el" href="../../d0/d7/lsnsup_8c-source.html">lsnsup.c</a>.
<p>
References <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00283">LfsFileOffsetToLsn</a>, <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00148">LfsFindNextLsn()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00287">LfsIsLsnInFile</a>, <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00036">LfsLsnFinalOffset()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00302">LfsLsnToFileOffset</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00305">LfsLsnToSeqNumber</a>, <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00040">LfsNextLogPageOffset()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">LfsPinOrMapData()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00184">LfsTruncateOffsetToLogPage</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00701">LiQuadAlign</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00148">LfsFindNextLsn()</a>, and <a class="el" href="../../d4/d2/querylog_8c-source.html#l01116">LfsSearchForwardByClient()</a>.
<p>
<pre class="fragment"><div>00156                    :
00157 
00158     This routine takes as a starting point <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record header of an
00159     Lsn in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  It searches <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next Lsn in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> and
00160     returns that value in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 'Lsn' argument.  The <span class="keywordtype">boolean</span> <span class="keywordflow">return</span> value
00161     indicates whether there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> another Lsn in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00162 
00163 Arguments:
00164 
00165     Lfcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00166 
00167     RecordHeader - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn starting point.
00168 
00169     Lsn - This supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next Lsn, <span class="keywordflow">if</span> found.
00170 
00171 Return Value:
00172 
00173     BOOLEAN - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next Lsn was found.
00174 
00175 --*/
00176 
00177 {
00178     BOOLEAN FoundNextLsn;
00179 
00180     LONGLONG LsnOffset;
00181     LONGLONG EndOfLogRecord;
00182     LONGLONG LogHeaderOffset;
00183 
00184     LONGLONG SequenceNumber;
00185 
00186     <a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a> LogRecordPage;
00187     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> LogRecordPageBcb;
00188     BOOLEAN UsaError;
00189 
00190     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00191 
00192     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsFindNextLsn:  Entered\n"</span>, 0 );
00193     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb          -&gt; %08lx\n"</span>, Lfcb );
00194     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Record Header -&gt; %08lx\n"</span>, RecordHeader );
00195 
00196     LogRecordPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00197     FoundNextLsn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00198 
00199     <span class="comment">//</span>
00200     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00201     <span class="comment">//</span>
00202 
00203     <span class="keywordflow">try</span> {
00204 
00205         <span class="comment">//</span>
00206         <span class="comment">//  Find the file offset of the log page which contains the end</span>
00207         <span class="comment">//  of the log record for this Lsn.</span>
00208         <span class="comment">//</span>
00209 
00210         LsnOffset = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a12">LfsLsnToFileOffset</a>( Lfcb, RecordHeader-&gt;ThisLsn );
00211 
00212         <a class="code" href="../../d9/d7/lsnsup_8c.html#a1">LfsLsnFinalOffset</a>( Lfcb,
00213                            RecordHeader-&gt;ThisLsn,
00214                            RecordHeader-&gt;ClientDataLength,
00215                            &amp;EndOfLogRecord );
00216 
00217         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a6">LfsTruncateOffsetToLogPage</a>( Lfcb, EndOfLogRecord, &amp;LogHeaderOffset );
00218 
00219         <span class="comment">//</span>
00220         <span class="comment">//  Remember the sequence number for this page.</span>
00221         <span class="comment">//</span>
00222 
00223         SequenceNumber = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a13">LfsLsnToSeqNumber</a>( Lfcb, RecordHeader-&gt;ThisLsn );
00224 
00225         <span class="comment">//</span>
00226         <span class="comment">//  Remember if we wrapped.</span>
00227         <span class="comment">//</span>
00228 
00229         <span class="keywordflow">if</span> ( EndOfLogRecord &lt;= LsnOffset ) {                                                                           <span class="comment">//**** xxLeq( EndOfLogRecord, LsnOffset )</span>
00230 
00231             SequenceNumber = SequenceNumber + 1;                                                                       <span class="comment">//**** xxAdd( SequenceNumber, LfsLi1 );</span>
00232         }
00233 
00234         <span class="comment">//</span>
00235         <span class="comment">//  Pin the log page header for this page.</span>
00236         <span class="comment">//</span>
00237 
00238         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
00239                          LogHeaderOffset,
00240                          (ULONG)Lfcb-&gt;LogPageSize,
00241                          FALSE,
00242                          FALSE,
00243                          FALSE,
00244                          &amp;UsaError,
00245                          (PVOID *)&amp;LogRecordPage,
00246                          &amp;LogRecordPageBcb );
00247 
00248         <span class="comment">//</span>
00249         <span class="comment">//  If the Lsn we were given was not the last Lsn on this page, then</span>
00250         <span class="comment">//  the starting offset for the next Lsn is on a quad word boundary</span>
00251         <span class="comment">//  following the last file offset for the current Lsn.  Otherwise</span>
00252         <span class="comment">//  the file offset is the start of the data on the next page.</span>
00253         <span class="comment">//</span>
00254 
00255         <span class="keywordflow">if</span> ( RecordHeader-&gt;ThisLsn.QuadPart == LogRecordPage-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.LastLsn.QuadPart ) {                                <span class="comment">//**** xxEql( RecordHeader-&gt;ThisLsn, LogRecordPage-&gt;Copy.LastLsn )</span>
00256 
00257             BOOLEAN Wrapped;
00258 
00259             <a class="code" href="../../d6/d5/logpgsup_8c.html#a2">LfsNextLogPageOffset</a>( Lfcb,
00260                                   LogHeaderOffset,
00261                                   &amp;LogHeaderOffset,
00262                                   &amp;Wrapped );
00263 
00264             LsnOffset = LogHeaderOffset + Lfcb-&gt;LogPageDataOffset;                                                     <span class="comment">//**** xxAdd( LogHeaderOffset, Lfcb-&gt;LogPageDataOffset );</span>
00265 
00266             <span class="comment">//</span>
00267             <span class="comment">//  If we wrapped, we need to increment the sequence number.</span>
00268             <span class="comment">//</span>
00269 
00270             <span class="keywordflow">if</span> (Wrapped) {
00271 
00272                 SequenceNumber = SequenceNumber + 1;                                                                   <span class="comment">//**** xxAdd( SequenceNumber, LfsLi1 );</span>
00273             }
00274 
00275         } <span class="keywordflow">else</span> {
00276 
00277             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a44">LiQuadAlign</a>( EndOfLogRecord, &amp;LsnOffset );
00278         }
00279 
00280         <span class="comment">//</span>
00281         <span class="comment">//  Compute the Lsn based on the file offset and the sequence count.</span>
00282         <span class="comment">//</span>
00283 
00284         Lsn-&gt;QuadPart = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a8">LfsFileOffsetToLsn</a>( Lfcb, LsnOffset, SequenceNumber );
00285 
00286         <span class="comment">//</span>
00287         <span class="comment">//  If this Lsn is within the legal range for the file, we return TRUE.</span>
00288         <span class="comment">//  Otherwise FALSE indicates that there are no more Lsn's.</span>
00289         <span class="comment">//</span>
00290 
00291         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a9">LfsIsLsnInFile</a>( Lfcb, *Lsn )) {
00292 
00293             FoundNextLsn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00294         }
00295 
00296     } finally {
00297 
00298         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsFindNextLsn );
00299 
00300         <span class="comment">//</span>
00301         <span class="comment">//  Unpin the log page header if held.</span>
00302         <span class="comment">//</span>
00303 
00304         <span class="keywordflow">if</span> (LogRecordPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00305 
00306             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( LogRecordPageBcb );
00307         }
00308 
00309         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)     -&gt; %08lx\n"</span>, Lsn-&gt;LowPart );
00310         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (High)    -&gt; %08lx\n"</span>, Lsn-&gt;HighPart );
00311         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsFindNextLsn:  Exit -&gt; %08x\n"</span>, FoundNextLsn );
00312     }
00313 
00314     <span class="keywordflow">return</span> FoundNextLsn;
00315 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="lfsprocs.h::LfsFindOldestClientLsn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsFindOldestClientLsn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartArea</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientArray</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OldestLsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00189">189</a> of file <a class="el" href="../../d8/d9/rstrtsup_8c-source.html">rstrtsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00355">LFS_NO_CLIENT</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00382">_LFS_CLIENT_RECORD::NextClient</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00365">_LFS_CLIENT_RECORD::OldestLsn</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/restart_8c-source.html#l00582">LfsSetBaseLsnPriv()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>.
<p>
<pre class="fragment"><div>00197                    :
00198 
00199     This routine walks through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active clients to determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oldest
00200     Lsn <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system must maintain.
00201 
00202 Arguments:
00203 
00204     RestartArea - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Restart Area to examine.
00205 
00206     ClientArray - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client data array.
00207 
00208     OldestLsn - We store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oldest Lsn we find in <span class="keyword">this</span> value.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00209         initialized with a starting value, we won'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> <span class="keywordflow">return</span> a more recent
00210         Lsn.
00211 
00212 Return Value:
00213 
00214     None.
00215 
00216 --*/
00217 
00218 {
00219     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NextClient;
00220 
00221     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientBlock;
00222 
00223     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00224 
00225     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsFindOldestClientLsn:  Entered\n"</span>, 0 );
00226     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"RestartArea       -&gt; %08lx\n"</span>, RestartArea );
00227     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Base Lsn (Low)    -&gt; %08lx\n"</span>, BaseLsn.LowPart );
00228     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Base Lsn (High)   -&gt; %08lx\n"</span>, BaseLsn.HighPart );
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">//  Take the first client off the in use list.</span>
00232     <span class="comment">//</span>
00233 
00234     NextClient = RestartArea-&gt;ClientInUseList;
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">//  While there are more clients, compare their oldest Lsn with the</span>
00238     <span class="comment">//  current oldest.</span>
00239     <span class="comment">//</span>
00240 
00241     <span class="keywordflow">while</span> (NextClient != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
00242 
00243         ClientBlock = ClientArray + NextClient;
00244 
00245         <span class="comment">//</span>
00246         <span class="comment">//  We ignore this block if it's oldest Lsn is 0.</span>
00247         <span class="comment">//</span>
00248 
00249         <span class="keywordflow">if</span> (( ClientBlock-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o0">OldestLsn</a>.QuadPart != 0 )
00250             &amp;&amp; ( ClientBlock-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o0">OldestLsn</a>.QuadPart &lt; OldestLsn-&gt;QuadPart )) {
00251 
00252             *OldestLsn = ClientBlock-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o0">OldestLsn</a>;
00253         }
00254 
00255         <span class="comment">//</span>
00256         <span class="comment">//  Try the next client block.</span>
00257         <span class="comment">//</span>
00258 
00259         NextClient = ClientBlock-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o3">NextClient</a>;
00260     }
00261 
00262     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"OldestLsn (Low)   -&gt; %08lx\n"</span>, BaseLsn.LowPart );
00263     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"OldestLsn (High)  -&gt; %08lx\n"</span>, BaseLsn.HighPart );
00264     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsFindOldestClientLsn:  Exit\n"</span>, 0 );
00265 
00266     <span class="keywordflow">return</span>;
00267 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="lfsprocs.h::LfsFlushLbcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsFlushLbcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00037">37</a> of file <a class="el" href="../../d8/d0/lbcbsup_8c-source.html">lbcbsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00509">LfsAcquireLfcb</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">LfsFlushLfcb()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00445">LfsLbcbIsRestart</a>, <a class="el" href="../../d1/d4/lfsstruc_8h.html#a40a38">LfsNoIoInProgress</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00140">LSN</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d2/lfs_8h-source.html#l00140">PLSN</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00134">LfsFlushToLsnPriv()</a>, and <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>.
<p>
<pre class="fragment"><div>00044                    :
00045 
00046     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to make sure <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data within an Lbcb makes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>
00047     to disk.  The Lbcb must either already be in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> workque or <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be
00048     a restart Lbcb.
00049 
00050 Arguments:
00051 
00052     Lfcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00053 
00054     Lbcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lbcb to flush.
00055 
00056 Return Value:
00057 
00058     None.
00059 
00060 --*/
00061 
00062 {
00063     <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> LastLsn;
00064     <a class="code" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> FlushedLsn;
00065 
00066     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00067 
00068     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsFlushLbcb:  Entered\n"</span>, 0 );
00069     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb      -&gt; %08lx\n"</span>, Lfcb );
00070     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lbcb      -&gt; %08lx\n"</span>, Lbcb );
00071 
00072     LastLsn = Lbcb-&gt;LastEndLsn;
00073 
00074     <span class="comment">//</span>
00075     <span class="comment">//  If this is a restart area we use the restart counter in the</span>
00076     <span class="comment">//  Lfcb.  Otherwise we can use the LastFlushedLsn value in the</span>
00077     <span class="comment">//  Lfcb.  This way we can determine that the Lbcb that interests</span>
00078     <span class="comment">//  us has made it out to disk.</span>
00079     <span class="comment">//</span>
00080 
00081     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a20">LfsLbcbIsRestart</a>( Lbcb )) {
00082 
00083         FlushedLsn = &amp;Lfcb-&gt;LastFlushedRestartLsn;
00084 
00085     } <span class="keywordflow">else</span> {
00086 
00087         FlushedLsn = &amp;Lfcb-&gt;LastFlushedLsn;
00088     }
00089 
00090     <span class="comment">//</span>
00091     <span class="comment">//  We loop here until the desired Lsn has made it to disk.</span>
00092     <span class="comment">//  If we are able to do the I/O, we will perform it.</span>
00093     <span class="comment">//</span>
00094 
00095     <span class="keywordflow">do</span> {
00096 
00097         <span class="comment">//</span>
00098         <span class="comment">//</span>
00099         <span class="comment">//  If we can do the Io, call down to flush the Lfcb.</span>
00100         <span class="comment">//</span>
00101 
00102         <span class="keywordflow">if</span> (Lfcb-&gt;LfsIoState == <a class="code" href="../../d1/d4/lfsstruc_8h.html#a40a38">LfsNoIoInProgress</a>) {
00103 
00104             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a51">LfsFlushLfcb</a>( Lfcb, Lbcb );
00105 
00106             <span class="keywordflow">break</span>;
00107         }
00108 
00109         <span class="comment">//</span>
00110         <span class="comment">//  Otherwise we release the Lfcb and immediately wait on the event.</span>
00111         <span class="comment">//</span>
00112 
00113         Lfcb-&gt;Waiters += 1;
00114 
00115         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
00116 
00117         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Lfcb-&gt;Sync-&gt;Event,
00118                                Executive,
00119                                KernelMode,
00120                                FALSE,
00121                                NULL );
00122 
00123         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
00124         Lfcb-&gt;Waiters -= 1;
00125 
00126     } <span class="keywordflow">while</span> ( LastLsn.QuadPart &gt; FlushedLsn-&gt;QuadPart );
00127 
00128     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsFlushLbcb:  Exit\n"</span>, 0 );
00129     <span class="keywordflow">return</span>;
00130 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="lfsprocs.h::LfsFlushLfcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsFlushLfcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">551</a> of file <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html">lfs/cachesup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l04411">CcFlushCache()</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00052">CcMapData()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l02560">CcSetDirtyPinnedData()</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01142">CcUnpinDataForThread()</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00281">_LFS_RESTART_PAGE_HEADER::ChkDskLsn</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">_LFS_RECORD_PAGE_HEADER::Copy</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02455">ExGetCurrentResourceThread</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00203">_LBCB::FileOffset</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00261">_LBCB::Flags</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00249">_LBCB::LastEndLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00242">_LBCB::LastLsn</a>, <a class="el" href="../../d1/d4/lfsstruc_8h.html#a31">LBCB</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00204">_LBCB::Length</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00606">LFCB_FINAL_SHUTDOWN</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00599">LFCB_LOG_WRAPPED</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00600">LFCB_MULTIPLE_PAGE_IO</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00607">LFCB_READ_FIRST_RESTART</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00608">LFCB_READ_SECOND_RESTART</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00341">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00339">LFS_SIGNATURE_RESTART_PAGE_ULONG</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00509">LfsAcquireLfcb</a>, <a class="el" href="../../d1/d4/lfsstruc_8h.html#a40a39">LfsClientThreadIo</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00402">LfsDeallocateLbcb()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l02191">LfsFindFirstIo()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">LfsFlushLfcb()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00039">LfsLi0</a>, <a class="el" href="../../d1/d4/lfsstruc_8h.html#a40a38">LfsNoIoInProgress</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">LfsPinOrMapData()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00080">LfsPreparePinWriteData</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00035">LfsUsaSeqNumber</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00253">LOG_PAGE_LOG_RECORD_END</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00235">_LBCB::LogPageBcb</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00298">_LFS_RESTART_PAGE_HEADER::LogPageSize</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00140">LSN</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00320">_LFS_RESTART_PAGE_HEADER::MajorVersion</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00319">_LFS_RESTART_PAGE_HEADER::MinorVersion</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00201">_LFS_RECORD_PAGE_HEADER::MultiSectorHeader</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00275">_LFS_RESTART_PAGE_HEADER::MultiSectorHeader</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00237">_LFS_RECORD_PAGE_HEADER::PageCount</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00228">_LBCB::PageHeader</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00238">_LFS_RECORD_PAGE_HEADER::PagePosition</a>, <a class="el" href="../../d9/d3/lfsdisk_8h.html#a40">PLFS_RESTART_AREA</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00279">_LBCB::ResourceThread</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00514">RESTART_SINGLE_PAGE_IO</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00305">_LFS_RESTART_PAGE_HEADER::RestartOffset</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00090">_MULTI_SECTOR_HEADER::Signature</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00291">_LFS_RESTART_PAGE_HEADER::SystemPageSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00099">_MULTI_SECTOR_HEADER::UpdateSequenceArrayOffset</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00105">_MULTI_SECTOR_HEADER::UpdateSequenceArraySize</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00195">_LBCB::WorkqueLinks</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00037">LfsFlushLbcb()</a>, and <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">LfsFlushLfcb()</a>.
<p>
<pre class="fragment"><div>00558                    :
00559 
00560     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to flush <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current Lbcbs in on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb
00561     work queue.  It will flush up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O which contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired
00562     Lbcb.
00563 
00564 Arguments:
00565 
00566     Lfcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00567 
00568     Lbcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to be flushed to disk.
00569 
00570 Return Value:
00571 
00572     None.
00573 
00574 --*/
00575 
00576 {
00577     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> FirstLbcb;
00578     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> ThisLbcb;
00579     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> NextLbcb;
00580 
00581     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> TargetLbcb;
00582     PULONG Signature;
00583 
00584     LONGLONG FileOffset;
00585     ULONG Length;
00586 
00587     BOOLEAN RaiseCorrupt = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00588     BOOLEAN ValidLastLsn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00589 
00590     BOOLEAN ContainsLastEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00591     BOOLEAN LfsRestart;
00592     BOOLEAN UseTailCopy;
00593 
00594     ULONG IoBlocks;
00595     ULONG NewLfcbFlags = 0;
00596 
00597     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> MapPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00598     PVOID MapPage;
00599 
00600     <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> LastLsn;
00601 
00602     IO_STATUS_BLOCK Iosb;
00603 
00604     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> PageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00605 
00606     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00607 
00608     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsFlushLfcb:  Entered\n"</span>, 0 );
00609     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb          -&gt; %08lx\n"</span>, Lfcb );
00610 
00611     <span class="comment">//</span>
00612     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00613     <span class="comment">//</span>
00614 
00615     <span class="keywordflow">try</span> {
00616 
00617         <span class="comment">//</span>
00618         <span class="comment">//  If there are no elements on the list, we are done.</span>
00619         <span class="comment">//</span>
00620 
00621         <span class="keywordflow">if</span> (IsListEmpty( &amp;Lfcb-&gt;LbcbWorkque )) {
00622 
00623             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00624         }
00625 
00626         <span class="comment">//</span>
00627         <span class="comment">//  Mark the Lfcb as Io in progress.</span>
00628         <span class="comment">//</span>
00629 
00630         Lfcb-&gt;LfsIoState = <a class="code" href="../../d1/d4/lfsstruc_8h.html#a40a39">LfsClientThreadIo</a>;
00631 <span class="preprocessor">#ifdef BRIANDBG</span>
00632 <span class="preprocessor"></span>        Lfcb-&gt;LfsIoThread = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
00633 <span class="preprocessor">#endif</span>
00634 <span class="preprocessor"></span>
00635         <span class="comment">//</span>
00636         <span class="comment">//  Remember the first Lbcb in the list.</span>
00637         <span class="comment">//</span>
00638 
00639         FirstLbcb = CONTAINING_RECORD( Lfcb-&gt;LbcbWorkque.Flink,
00640                                        <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00641                                        WorkqueLinks );
00642 
00643         <span class="comment">//</span>
00644         <span class="comment">//  We continue looping and performing I/o for as long as possible.</span>
00645         <span class="comment">//</span>
00646 
00647         <span class="keywordflow">while</span> (!ContainsLastEntry) {
00648 
00649             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Lfcb-&gt;PageToDirty == NULL );
00650 
00651             <span class="comment">//</span>
00652             <span class="comment">//  Reset the notify event for all of the waiting threads.</span>
00653             <span class="comment">//</span>
00654 
00655             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;Lfcb-&gt;Sync-&gt;Event );
00656 
00657             <span class="comment">//</span>
00658             <span class="comment">//  Find the block of Lbcb's that make up the first I/O, remembering</span>
00659             <span class="comment">//  how many there are.  Also remember if this I/O contains the</span>
00660             <span class="comment">//  last element on the list when we were called.</span>
00661             <span class="comment">//</span>
00662 
00663             <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a5">LfsFindFirstIo</a>( Lfcb,
00664                             Lbcb,
00665                             FirstLbcb,
00666                             &amp;NextLbcb,
00667                             &amp;FileOffset,
00668                             &amp;ContainsLastEntry,
00669                             &amp;LfsRestart,
00670                             &amp;UseTailCopy,
00671                             &amp;IoBlocks );
00672 
00673             Length = IoBlocks * (ULONG) Lfcb-&gt;LogPageSize;
00674             <span class="keywordflow">if</span> (UseTailCopy) {
00675 
00676                 TargetLbcb = Lfcb-&gt;ActiveTail;
00677                 Lfcb-&gt;ActiveTail = Lfcb-&gt;PrevTail;
00678                 Lfcb-&gt;PrevTail = TargetLbcb;
00679 
00680                 FileOffset = TargetLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a>;
00681 
00682             } <span class="keywordflow">else</span> {
00683 
00684                 TargetLbcb = FirstLbcb;
00685             }
00686 
00687             <span class="comment">//</span>
00688             <span class="comment">//  Give up the Lfcb unless we are looking at an active page.</span>
00689             <span class="comment">//</span>
00690 
00691             <span class="keywordflow">if</span> (!UseTailCopy) {
00692 
00693                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
00694             }
00695 
00696             <span class="comment">//</span>
00697             <span class="comment">//  If this I/O involves the Lfs restart area, write it to the</span>
00698             <span class="comment">//  cache pages.</span>
00699             <span class="comment">//</span>
00700 
00701             <span class="keywordflow">if</span> (LfsRestart) {
00702 
00703                 <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> RestartPage;
00704                 BOOLEAN UsaError;
00705                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00706 
00707                 <span class="comment">//</span>
00708                 <span class="comment">//  If there was some error in initially reading the restart page then</span>
00709                 <span class="comment">//  it is OK to settle for a page of zeroes.</span>
00710                 <span class="comment">//</span>
00711 
00712                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_READ_FIRST_RESTART | LFCB_READ_SECOND_RESTART ) &amp;&amp;
00713                     ((FileOffset == 0) ?
00714                      <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_READ_FIRST_RESTART ) :
00715                      <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a14">LFCB_READ_SECOND_RESTART</a> ))) {
00716 
00717                     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a5">LfsPreparePinWriteData</a>( Lfcb,
00718                                             FileOffset,
00719                                             (ULONG) Lfcb-&gt;SystemPageSize,
00720                                             &amp;RestartPage,
00721                                             &amp;PageBcb );
00722 
00723                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00724 
00725                     <span class="keywordflow">if</span> (FileOffset == 0) {
00726 
00727                         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( NewLfcbFlags, LFCB_READ_FIRST_RESTART );
00728 
00729                     } <span class="keywordflow">else</span> {
00730 
00731                         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( NewLfcbFlags, LFCB_READ_SECOND_RESTART );
00732                     }
00733 
00734                 } <span class="keywordflow">else</span> {
00735 
00736                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
00737                                               FileOffset,
00738                                               (ULONG)Lfcb-&gt;SystemPageSize,
00739                                               TRUE,
00740                                               TRUE,
00741                                               TRUE,
00742                                               &amp;UsaError,
00743                                               &amp;RestartPage,
00744                                               &amp;PageBcb );
00745                 }
00746 
00747                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00748 
00749                     <span class="comment">//</span>
00750                     <span class="comment">//  Initialize the restart page header.</span>
00751                     <span class="comment">//</span>
00752 
00753                     Signature = (PULONG) &amp;RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o0">Signature</a>;
00754 
00755                     *Signature = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a12">LFS_SIGNATURE_RESTART_PAGE_ULONG</a>;
00756                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o1">ChkDskLsn</a> = <a class="code" href="../../d7/d3/lfsdata_8c.html#a2">LfsLi0</a>;
00757 
00758                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o1">UpdateSequenceArrayOffset</a>
00759                                                         = Lfcb-&gt;RestartUsaOffset;
00760 
00761                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o2">UpdateSequenceArraySize</a>
00762                                                         = Lfcb-&gt;RestartUsaArraySize;
00763 
00764                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o2">SystemPageSize</a> = (ULONG)Lfcb-&gt;SystemPageSize;
00765                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o3">LogPageSize</a> = (ULONG)Lfcb-&gt;LogPageSize;
00766 
00767                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o4">RestartOffset</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) Lfcb-&gt;RestartDataOffset;
00768                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o6">MajorVersion</a> = Lfcb-&gt;MajorVersion;
00769                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o5">MinorVersion</a> = Lfcb-&gt;MinorVersion;
00770 
00771                     <span class="comment">//</span>
00772                     <span class="comment">//  If the Lfcb indicates that the file has wrapped, then clear the</span>
00773                     <span class="comment">//  first pass flag in the restart area.</span>
00774                     <span class="comment">//</span>
00775 
00776                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_LOG_WRAPPED )) {
00777 
00778                         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( ((<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a>) FirstLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>)-&gt;Flags, RESTART_SINGLE_PAGE_IO );
00779                         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, LFCB_MULTIPLE_PAGE_IO );
00780                     }
00781 
00782                     <span class="comment">//</span>
00783                     <span class="comment">//  Write the page header into the page and mark the page dirty.</span>
00784                     <span class="comment">//</span>
00785 
00786                     RtlCopyMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RestartPage, Lfcb-&gt;RestartDataOffset, PVOID ),
00787                                    FirstLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>,
00788                                    (ULONG)FirstLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o5">Length</a> );
00789 
00790                     <span class="comment">//</span>
00791                     <span class="comment">//  Make sure the modified bit gets set in the pfn database.  The</span>
00792                     <span class="comment">//  cache manager should do this even for files we told him not to</span>
00793                     <span class="comment">//  lazy write.</span>
00794                     <span class="comment">//</span>
00795 
00796                     <a class="code" href="../../d4/d2/cache_8h.html#a91">CcSetDirtyPinnedData</a>( PageBcb, NULL );
00797 
00798                     <span class="comment">//</span>
00799                     <span class="comment">//  We unpin any buffers pinned on this page.</span>
00800                     <span class="comment">//</span>
00801 
00802                     <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( PageBcb );
00803                     PageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00804 
00805                     LastLsn = FirstLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o10">LastLsn</a>;
00806                     ValidLastLsn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00807 
00808                     <span class="comment">//</span>
00809                     <span class="comment">//  Use a system page size as the length we need to flush.</span>
00810                     <span class="comment">//</span>
00811 
00812                     Length = (ULONG)Lfcb-&gt;SystemPageSize;
00813 
00814                 } <span class="keywordflow">else</span> {
00815 
00816                     RaiseCorrupt = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00817                 }
00818 
00819             <span class="comment">//</span>
00820             <span class="comment">//  Otherwise these are log record pages</span>
00821             <span class="comment">//</span>
00822 
00823             } <span class="keywordflow">else</span> {
00824 
00825                 <a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a> RecordPageHeader;
00826 
00827                 ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00828 
00829                 <span class="comment">//</span>
00830                 <span class="comment">//  Mark the last Lsn fields for the page headers and each</span>
00831                 <span class="comment">//  page's position in the transfer.  Also unpin all of the</span>
00832                 <span class="comment">//  log pages.</span>
00833                 <span class="comment">//</span>
00834 
00835                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 1;
00836 
00837                 ThisLbcb = FirstLbcb;
00838 
00839                 <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00840 
00841                     <span class="comment">//</span>
00842                     <span class="comment">//  If we have to use the tail copy, then pin a page to use.</span>
00843                     <span class="comment">//</span>
00844 
00845                     <span class="keywordflow">if</span> (UseTailCopy) {
00846 
00847                         BOOLEAN UsaError;
00848 
00849                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
00850                                                           TargetLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a>,
00851                                                           (ULONG)Lfcb-&gt;LogPageSize,
00852                                                           TRUE,
00853                                                           TRUE,
00854                                                           TRUE,
00855                                                           &amp;UsaError,
00856                                                           &amp;RecordPageHeader,
00857                                                           &amp;PageBcb ))) {
00858 
00859                             RaiseCorrupt = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00860                             <span class="keywordflow">break</span>;
00861                         }
00862 
00863                     } <span class="keywordflow">else</span> {
00864 
00865                         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> SeqNumber;
00866 
00867                         RecordPageHeader = (<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a>) ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>;
00868 
00869                         <span class="comment">//</span>
00870                         <span class="comment">//  If the sequence number is zero then this is probably a</span>
00871                         <span class="comment">//  page of zeroes produced by the cache manager.  In order</span>
00872                         <span class="comment">//  to insure that we don't have the same sequence number</span>
00873                         <span class="comment">//  on each page we will seed the sequence number.</span>
00874                         <span class="comment">//</span>
00875 
00876                         SeqNumber = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RecordPageHeader,
00877                                              Lfcb-&gt;LogRecordUsaOffset,
00878                                              PUSHORT );
00879 
00880                         <span class="keywordflow">if</span> (*SeqNumber == 0) {
00881 
00882                             *SeqNumber = <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a1">LfsUsaSeqNumber</a>;
00883                             <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a1">LfsUsaSeqNumber</a> += 1;
00884                         }
00885                     }
00886 
00887                     <span class="comment">//</span>
00888                     <span class="comment">//  Make sure the modified bit gets set in the pfn database.  The</span>
00889                     <span class="comment">//  cache manager should do this even for files we told him not to</span>
00890                     <span class="comment">//  lazy write.</span>
00891                     <span class="comment">//</span>
00892 
00893                     <span class="keywordflow">if</span> (UseTailCopy) {
00894 
00895                         <span class="comment">//</span>
00896                         <span class="comment">//  Store the file offset of the real page in the header.</span>
00897                         <span class="comment">//  Also set the flag indicating the page is a tail copy.</span>
00898                         <span class="comment">//</span>
00899 
00900                         RtlCopyMemory( RecordPageHeader,
00901                                        ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>,
00902                                        (ULONG)Lfcb-&gt;LogPageSize );
00903 
00904                         RecordPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.FileOffset = ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a>;
00905                     }
00906 
00907                     <span class="comment">//</span>
00908                     <span class="comment">//  We update all of fields as yet not updated.</span>
00909                     <span class="comment">//</span>
00910 
00911                     RecordPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o6">PagePosition</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00912                     RecordPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o5">PageCount</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) IoBlocks;
00913 
00914                     <span class="comment">//</span>
00915                     <span class="comment">//  We set up the update sequence array for this structure.</span>
00916                     <span class="comment">//</span>
00917 
00918                     Signature = (PULONG) &amp;RecordPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o0">Signature</a>;
00919                     *Signature = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a14">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>;
00920 
00921                     RecordPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o1">UpdateSequenceArrayOffset</a>
00922                                                         = Lfcb-&gt;LogRecordUsaOffset;
00923 
00924                     RecordPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o2">UpdateSequenceArraySize</a>
00925                                                         = Lfcb-&gt;LogRecordUsaArraySize;
00926 
00927                     <span class="comment">//</span>
00928                     <span class="comment">//  Make sure the modified bit gets set in the pfn database.  The</span>
00929                     <span class="comment">//  cache manager should do this even for files we told him not to</span>
00930                     <span class="comment">//  lazy write.</span>
00931                     <span class="comment">//</span>
00932 
00933                     <span class="keywordflow">if</span> (UseTailCopy) {
00934 
00935                         <a class="code" href="../../d4/d2/cache_8h.html#a91">CcSetDirtyPinnedData</a>( PageBcb, NULL );
00936 
00937                         <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( PageBcb );
00938                         PageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00939 
00940                     } <span class="keywordflow">else</span> {
00941 
00942                         <a class="code" href="../../d4/d2/cache_8h.html#a91">CcSetDirtyPinnedData</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o9">LogPageBcb</a>, NULL );
00943 
00944                         <span class="comment">//</span>
00945                         <span class="comment">//  We unpin any buffers pinned on this page.</span>
00946                         <span class="comment">//</span>
00947 
00948                         <a class="code" href="../../d4/d2/cache_8h.html#a94">CcUnpinDataForThread</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o9">LogPageBcb</a>, ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o14">ResourceThread</a> );
00949                     }
00950 
00951                     <span class="comment">//</span>
00952                     <span class="comment">//  Remember the last lsn and its length if this is the final</span>
00953                     <span class="comment">//  page of an Lsn.</span>
00954                     <span class="comment">//</span>
00955 
00956                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o12">Flags</a>, LOG_PAGE_LOG_RECORD_END )) {
00957 
00958                         LastLsn = ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o11">LastEndLsn</a>;
00959                         ValidLastLsn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00960                     }
00961 
00962                     <span class="comment">//</span>
00963                     <span class="comment">//  Exit the loop if this is the last block.</span>
00964                     <span class="comment">//</span>
00965 
00966                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == IoBlocks) {
00967 
00968                         <span class="keywordflow">break</span>;
00969                     }
00970 
00971                     <span class="comment">//</span>
00972                     <span class="comment">//  Otherwise move to the next entry.</span>
00973                     <span class="comment">//</span>
00974 
00975                     ThisLbcb = CONTAINING_RECORD( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o2">WorkqueLinks</a>.Flink,
00976                                                   <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00977                                                   WorkqueLinks );
00978 
00979                     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
00980                 }
00981             }
00982 
00983             <span class="comment">//</span>
00984             <span class="comment">//  Remember the range we are flushing and find the second half of a page</span>
00985             <span class="comment">//  if necessary.</span>
00986             <span class="comment">//</span>
00987 
00988             Lfcb-&gt;UserWriteData-&gt;FileOffset = FileOffset;
00989             Lfcb-&gt;UserWriteData-&gt;Length = Length;
00990 
00991             <span class="keywordflow">if</span> (!UseTailCopy &amp;&amp; !LfsRestart) {
00992 
00993                 <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> TailLbcb;
00994                 PLIST_ENTRY Links;
00995                 LONGLONG NextOffset;
00996 
00997                 <span class="comment">//</span>
00998                 <span class="comment">//  We are flushing log records.  If the current request does not end on</span>
00999                 <span class="comment">//  a system page boundary then check if there is another page in</span>
01000                 <span class="comment">//  memory that we are concerned with.</span>
01001                 <span class="comment">//</span>
01002 
01003                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( (ULONG)(FileOffset + Length), (PAGE_SIZE - 1) )) {
01004 
01005                     NextOffset = FileOffset + Length;
01006 
01007                     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
01008 
01009                     <span class="comment">//</span>
01010                     <span class="comment">//  Start by looking through the Lbcbs on the active queue.</span>
01011                     <span class="comment">//</span>
01012 
01013                     Links = Lfcb-&gt;LbcbActive.Flink;
01014 
01015                     <span class="keywordflow">while</span> (Links != &amp;Lfcb-&gt;LbcbActive) {
01016 
01017                         TailLbcb = CONTAINING_RECORD( Links,
01018                                                       <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
01019                                                       ActiveLinks );
01020 
01021                         <span class="keywordflow">if</span> (TailLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a> == NextOffset) {
01022 
01023                             Lfcb-&gt;PageToDirty = TailLbcb;
01024                             <span class="keywordflow">break</span>;
01025                         }
01026 
01027                         Links = Links-&gt;Flink;
01028                     }
01029 
01030                     <span class="comment">//</span>
01031                     <span class="comment">//  If we didn't find it then scan to the end of the workque.</span>
01032                     <span class="comment">//</span>
01033 
01034                     <span class="keywordflow">if</span> (Lfcb-&gt;PageToDirty == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01035 
01036                         Links = Lfcb-&gt;LbcbWorkque.Flink;
01037 
01038                         <span class="keywordflow">while</span> (Links != &amp;Lfcb-&gt;LbcbWorkque) {
01039     
01040                             TailLbcb = CONTAINING_RECORD( Links,
01041                                                           <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
01042                                                           WorkqueLinks );
01043     
01044                             <span class="keywordflow">if</span> (TailLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a> == NextOffset) {
01045     
01046                                 Lfcb-&gt;PageToDirty = TailLbcb;
01047                                 <span class="keywordflow">break</span>;
01048                             }
01049     
01050                             Links = Links-&gt;Flink;
01051                         }
01052                     }
01053 
01054                     <span class="comment">//</span>
01055                     <span class="comment">//  If we found an Lbcb then unpin the page temporarily.</span>
01056                     <span class="comment">//  Other users will have to detect this is not pinned.</span>
01057                     <span class="comment">//</span>
01058 
01059                     <span class="keywordflow">if</span> (Lfcb-&gt;PageToDirty != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01060 
01061                         <span class="comment">//</span>
01062                         <span class="comment">//  Go ahead and map this page to keep the virtual address</span>
01063                         <span class="comment">//  valid.</span>
01064                         <span class="comment">//</span>
01065 
01066                         <a class="code" href="../../d4/d2/cache_8h.html#a88">CcMapData</a>( Lfcb-&gt;FileObject, 
01067                                    (PLARGE_INTEGER) &amp;Lfcb-&gt;PageToDirty-&gt;FileOffset,
01068                                    (ULONG) Lfcb-&gt;LogPageSize,
01069                                    TRUE,
01070                                    &amp;MapPageBcb,
01071                                    &amp;MapPage );
01072 
01073                         <a class="code" href="../../d4/d2/cache_8h.html#a94">CcUnpinDataForThread</a>( Lfcb-&gt;PageToDirty-&gt;LogPageBcb,
01074                                               Lfcb-&gt;PageToDirty-&gt;ResourceThread );
01075 
01076                         Lfcb-&gt;PageToDirty-&gt;LogPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01077                     }
01078 
01079                     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
01080                 }
01081             }
01082 
01083             <span class="comment">//</span>
01084             <span class="comment">//  We are ready to do the I/O.  Flush the pages to the log file.</span>
01085             <span class="comment">//</span>
01086 
01087             <a class="code" href="../../d4/d2/cache_8h.html#a63">CcFlushCache</a>( Lfcb-&gt;FileObject-&gt;SectionObjectPointer,
01088                           (PLARGE_INTEGER)&amp;FileOffset,
01089                           Length,
01090                           &amp;Iosb );
01091 
01092             <span class="comment">//</span>
01093             <span class="comment">//  Recover the state of any partial page first.</span>
01094             <span class="comment">//</span>
01095 
01096             <span class="keywordflow">if</span> (Lfcb-&gt;PageToDirty != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01097 
01098                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a5">LfsPreparePinWriteData</a>( Lfcb, 
01099                                         Lfcb-&gt;PageToDirty-&gt;FileOffset,
01100                                         (ULONG) Lfcb-&gt;LogPageSize,
01101                                         &amp;Lfcb-&gt;PageToDirty-&gt;PageHeader,
01102                                         &amp;Lfcb-&gt;PageToDirty-&gt;LogPageBcb );
01103 
01104                 Lfcb-&gt;PageToDirty-&gt;ResourceThread = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
01105                 Lfcb-&gt;PageToDirty = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01106 
01107                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( MapPageBcb );
01108                 MapPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01109             }
01110 
01111             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Iosb.Status )) {
01112 
01113                 LONG BytesRemaining = (LONG) Length;
01114 
01115                 <span class="comment">//</span>
01116                 <span class="comment">//  If we get an error then try each individual page.</span>
01117                 <span class="comment">//</span>
01118 
01119                 <span class="keywordflow">while</span> (BytesRemaining &gt; 0) {
01120 
01121                     <span class="comment">//</span>
01122                     <span class="comment">//  Remember the range we are flushing and find the second half of a page</span>
01123                     <span class="comment">//  if necessary.</span>
01124                     <span class="comment">//</span>
01125         
01126                     Lfcb-&gt;UserWriteData-&gt;FileOffset = FileOffset;
01127                     Lfcb-&gt;UserWriteData-&gt;Length = Length;
01128         
01129                     <span class="keywordflow">if</span> (!UseTailCopy &amp;&amp; !LfsRestart) {
01130         
01131                         <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> TailLbcb;
01132                         PLIST_ENTRY Links;
01133                         LONGLONG NextOffset;
01134         
01135                         <span class="comment">//</span>
01136                         <span class="comment">//  We are flushing log records.  If the current request does not end on</span>
01137                         <span class="comment">//  a system page boundary then check if there is another page in</span>
01138                         <span class="comment">//  memory that we are concerned with.</span>
01139                         <span class="comment">//</span>
01140         
01141                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( (ULONG)(FileOffset + Length), (PAGE_SIZE - 1) )) {
01142         
01143                             NextOffset = FileOffset + Length;
01144         
01145                             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
01146 
01147                             <span class="comment">//</span>
01148                             <span class="comment">//  Start by looking through the Lbcbs on the active queue.</span>
01149                             <span class="comment">//</span>
01150         
01151                             Links = Lfcb-&gt;LbcbActive.Flink;
01152         
01153                             <span class="keywordflow">while</span> (Links != &amp;Lfcb-&gt;LbcbActive) {
01154         
01155                                 TailLbcb = CONTAINING_RECORD( Links,
01156                                                               <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
01157                                                               ActiveLinks );
01158         
01159                                 <span class="keywordflow">if</span> (TailLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a> == NextOffset) {
01160         
01161                                     Lfcb-&gt;PageToDirty = TailLbcb;
01162                                     <span class="keywordflow">break</span>;
01163                                 }
01164         
01165                                 Links = Links-&gt;Flink;
01166                             }
01167         
01168                             <span class="comment">//</span>
01169                             <span class="comment">//  If we didn't find it then scan to the end of the workque.</span>
01170                             <span class="comment">//</span>
01171         
01172                             <span class="keywordflow">if</span> (Lfcb-&gt;PageToDirty == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01173         
01174                                 Links = Lfcb-&gt;LbcbWorkque.Flink;
01175         
01176                                 <span class="keywordflow">while</span> (Links != &amp;Lfcb-&gt;LbcbWorkque) {
01177             
01178                                     TailLbcb = CONTAINING_RECORD( Links,
01179                                                                   <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
01180                                                                   WorkqueLinks );
01181             
01182                                     <span class="keywordflow">if</span> (TailLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a> == NextOffset) {
01183             
01184                                         Lfcb-&gt;PageToDirty = TailLbcb;
01185                                         <span class="keywordflow">break</span>;
01186                                     }
01187             
01188                                     Links = Links-&gt;Flink;
01189                                 }
01190                             }
01191         
01192                             <span class="comment">//</span>
01193                             <span class="comment">//  If we found an Lbcb then unpin the page temporarily.</span>
01194                             <span class="comment">//  Other users will have to detect this is not pinned.</span>
01195                             <span class="comment">//</span>
01196         
01197                             <span class="keywordflow">if</span> (Lfcb-&gt;PageToDirty != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01198         
01199                                 <a class="code" href="../../d4/d2/cache_8h.html#a88">CcMapData</a>( Lfcb-&gt;FileObject, 
01200                                            (PLARGE_INTEGER) &amp;Lfcb-&gt;PageToDirty-&gt;FileOffset,
01201                                            (ULONG) Lfcb-&gt;PageToDirty-&gt;Length,
01202                                            TRUE,
01203                                            &amp;MapPageBcb,
01204                                            &amp;MapPage );
01205         
01206                                 <a class="code" href="../../d4/d2/cache_8h.html#a94">CcUnpinDataForThread</a>( Lfcb-&gt;PageToDirty-&gt;LogPageBcb,
01207                                                       Lfcb-&gt;PageToDirty-&gt;ResourceThread );
01208         
01209                                 Lfcb-&gt;PageToDirty-&gt;LogPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01210                             }
01211                         }
01212                         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
01213                     }
01214         
01215                     <a class="code" href="../../d4/d2/cache_8h.html#a63">CcFlushCache</a>( Lfcb-&gt;FileObject-&gt;SectionObjectPointer,
01216                                   (PLARGE_INTEGER)&amp;FileOffset,
01217                                   (ULONG)Lfcb-&gt;SystemPageSize,
01218                                   &amp;Iosb );
01219 
01220                     <span class="comment">//</span>
01221                     <span class="comment">//  Recover the state of any partial page first.</span>
01222                     <span class="comment">//</span>
01223         
01224                     <span class="keywordflow">if</span> (Lfcb-&gt;PageToDirty != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01225         
01226                         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a5">LfsPreparePinWriteData</a>( Lfcb, 
01227                                                 Lfcb-&gt;PageToDirty-&gt;FileOffset,
01228                                                 (ULONG) Lfcb-&gt;PageToDirty-&gt;Length,
01229                                                 &amp;Lfcb-&gt;PageToDirty-&gt;PageHeader,
01230                                                 &amp;Lfcb-&gt;PageToDirty-&gt;LogPageBcb );
01231         
01232                         Lfcb-&gt;PageToDirty-&gt;ResourceThread = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
01233                         Lfcb-&gt;PageToDirty = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01234 
01235                         <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( MapPageBcb );
01236                         MapPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01237                     }
01238         
01239                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Iosb.Status )) {
01240 
01241 <span class="preprocessor">#ifdef NTFS_RESTART</span>
01242 <span class="preprocessor"></span>                        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FALSE );
01243 <span class="preprocessor">#endif</span>
01244 <span class="preprocessor"></span>                        RaiseCorrupt = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01245                     }
01246 
01247                     BytesRemaining -= (LONG)Lfcb-&gt;SystemPageSize;
01248                     FileOffset = FileOffset + Lfcb-&gt;SystemPageSize;
01249                 }
01250             }
01251 
01252             <span class="comment">//</span>
01253             <span class="comment">//  Reacquire the Lfcb, remembering that we have it.</span>
01254             <span class="comment">//</span>
01255 
01256             <span class="keywordflow">if</span> (!UseTailCopy) {
01257 
01258                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
01259             }
01260 
01261             <span class="comment">//</span>
01262             <span class="comment">//  Update the last flushed Lsn value if this isn't a</span>
01263             <span class="comment">//  restart write.</span>
01264             <span class="comment">//</span>
01265 
01266             <span class="keywordflow">if</span> (!LfsRestart) {
01267 
01268                 <span class="keywordflow">if</span> (ValidLastLsn) {
01269 
01270                     Lfcb-&gt;LastFlushedLsn = LastLsn;
01271                 }
01272 
01273             <span class="comment">//</span>
01274             <span class="comment">//  Remember the Lsn we assigned to this restart area.</span>
01275             <span class="comment">//</span>
01276 
01277             } <span class="keywordflow">else</span> {
01278 
01279                 Lfcb-&gt;LastFlushedRestartLsn = LastLsn;
01280 
01281                 <span class="comment">//</span>
01282                 <span class="comment">//  Clear any neccessary flags on a successful operation.</span>
01283                 <span class="comment">//</span>
01284 
01285                 <span class="keywordflow">if</span> (!RaiseCorrupt) {
01286 
01287                     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Lfcb-&gt;Flags, NewLfcbFlags );
01288                     NewLfcbFlags = 0;
01289                 }
01290 
01291                 <span class="comment">//</span>
01292                 <span class="comment">//  If this is the first write of a restart area and we have</span>
01293                 <span class="comment">//  updated the LogOpenCount then update the field in the Lfcb.</span>
01294                 <span class="comment">//</span>
01295 
01296                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Iosb.Status ) &amp;&amp;
01297                     (Lfcb-&gt;CurrentOpenLogCount != ((<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a>) FirstLbcb-&gt;PageHeader)-&gt;RestartOpenLogCount)) {
01298 
01299                     Lfcb-&gt;CurrentOpenLogCount = ((<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a>) FirstLbcb-&gt;PageHeader)-&gt;RestartOpenLogCount;
01300                 }
01301             }
01302 
01303             <span class="comment">//</span>
01304             <span class="comment">//  Walk through all the Lbcb's we flushed, deallocating the Lbcbs.</span>
01305             <span class="comment">//</span>
01306 
01307             <span class="keywordflow">if</span> (!UseTailCopy) {
01308 
01309                 <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> TempLbcb;
01310 
01311                 ThisLbcb = FirstLbcb;
01312 
01313                 <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01314 
01315                     <span class="comment">//</span>
01316                     <span class="comment">//  Remember the next entry on the list.</span>
01317                     <span class="comment">//</span>
01318 
01319                     TempLbcb = CONTAINING_RECORD( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o2">WorkqueLinks</a>.Flink,
01320                                                   <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
01321                                                   WorkqueLinks );
01322 
01323                     <span class="comment">//</span>
01324                     <span class="comment">//  Remove it from the LbcbWorkque queue.</span>
01325                     <span class="comment">//</span>
01326 
01327                     RemoveEntryList( &amp;ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o2">WorkqueLinks</a> );
01328 
01329                     <span class="comment">//</span>
01330                     <span class="comment">//  Deallocate the structure.</span>
01331                     <span class="comment">//</span>
01332 
01333                     <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a>( Lfcb, ThisLbcb );
01334 
01335                     <span class="keywordflow">if</span> (IoBlocks-- == 1) {
01336 
01337                         <span class="keywordflow">break</span>;
01338                     }
01339 
01340                     ThisLbcb = TempLbcb;
01341                 }
01342             }
01343 
01344             <span class="comment">//</span>
01345             <span class="comment">//  If we flushed the Lbcb we were interested in, we are done.</span>
01346             <span class="comment">//  We will signal all waiting threads regardless</span>
01347             <span class="comment">//</span>
01348 
01349             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;Lfcb-&gt;Sync-&gt;Event, 0, FALSE );
01350 
01351             <span class="comment">//</span>
01352             <span class="comment">//  Remember the starting Lbcb for the next I/O.</span>
01353             <span class="comment">//</span>
01354 
01355             FirstLbcb = NextLbcb;
01356         }
01357 
01358     try_exit:  NOTHING;
01359     } finally {
01360 
01361         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsFlushLfcb );
01362 
01363         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Lfcb-&gt;PageToDirty == NULL );
01364 
01365         <span class="comment">//</span>
01366         <span class="comment">//  Show that there is no Io in progress.</span>
01367         <span class="comment">//</span>
01368 
01369         Lfcb-&gt;LfsIoState = <a class="code" href="../../d1/d4/lfsstruc_8h.html#a40a38">LfsNoIoInProgress</a>;
01370 <span class="preprocessor">#ifdef BRIANDBG</span>
01371 <span class="preprocessor"></span>        Lfcb-&gt;LfsIoThread = 0;
01372 <span class="preprocessor">#endif</span>
01373 <span class="preprocessor"></span>
01374         <span class="comment">//</span>
01375         <span class="comment">//  Make sure we didn't leave any pages pinned.</span>
01376         <span class="comment">//</span>
01377 
01378         <span class="keywordflow">if</span> (PageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01379 
01380             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( PageBcb );
01381         }
01382 
01383         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsFlushLfcb:  Exit\n"</span>, 0 );
01384     }
01385 
01386     <span class="comment">//</span>
01387     <span class="comment">//  If the Io failed at some point, we raise a corrupt disk error.</span>
01388     <span class="comment">//  The only exception is if this is the final flush of the log file.</span>
01389     <span class="comment">//  In this case the client may not be able to cleanup after this error.</span>
01390     <span class="comment">//</span>
01391 
01392     <span class="keywordflow">if</span> (RaiseCorrupt &amp;&amp; (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_FINAL_SHUTDOWN ))) {
01393 
01394         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
01395     }
01396 
01397     <span class="keywordflow">return</span>;
01398 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="lfsprocs.h::LfsFlushToLsnPriv" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsFlushToLsnPriv           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00134">134</a> of file <a class="el" href="../../d8/d0/lbcbsup_8c-source.html">lbcbsup.c</a>.
<p>
References <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00196">_LBCB::ActiveLinks</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00261">_LBCB::Flags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00284">LBCB_ON_ACTIVE_QUEUE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00273">_LBCB::LbcbFlags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00036">LfsCurrentAvailSpace()</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00037">LfsFlushLbcb()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00445">LfsLbcbIsRestart</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00253">LOG_PAGE_LOG_RECORD_END</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00360">LfsFlushToLsn()</a>, and <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00197">LfsForceWrite()</a>.
<p>
<pre class="fragment"><div>00141                    :
00142 
00143     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> worker routine which performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work of flushing
00144     a particular Lsn to disk.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always called with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00145     Lfcb acquired.  This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> makes no guarantee about whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb
00146     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired on <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>.
00147 
00148 Arguments:
00149 
00150     Lfcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00151 
00152     Lsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn to flush to disk.
00153 
00154 Return Value:
00155 
00156     None.
00157 
00158 --*/
00159 
00160 {
00161     BOOLEAN UseLastRecordLbcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00162     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> LastRecordLbcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00163 
00164     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00165 
00166     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsFlushToLsnPriv:  Entered\n"</span>, 0 );
00167     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb          -&gt; %08lx\n"</span>, Lfcb );
00168     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)     -&gt; %08lx\n"</span>, Lsn.LowPart );
00169     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (High)    -&gt; %08lx\n"</span>, Lsn.HighPart );
00170 
00171     <span class="comment">//</span>
00172     <span class="comment">//  We check if the Lsn is in the valid range.  Raising an</span>
00173     <span class="comment">//  exception if not.</span>
00174     <span class="comment">//</span>
00175 
00176     <span class="keywordflow">if</span> (Lsn.QuadPart &gt; Lfcb-&gt;RestartArea-&gt;CurrentLsn.QuadPart) {
00177 
00178         UseLastRecordLbcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00179     }
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">//  If the Lsn has already been flushed we are done.</span>
00183     <span class="comment">//  Otherwise we need to look through the workqueues and the</span>
00184     <span class="comment">//  active queue.</span>
00185     <span class="comment">//</span>
00186 
00187     <span class="keywordflow">if</span> (Lsn.QuadPart &gt; Lfcb-&gt;LastFlushedLsn.QuadPart) {
00188 
00189         PLIST_ENTRY ThisEntry;
00190         <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> ThisLbcb;
00191 
00192         <span class="comment">//</span>
00193         <span class="comment">//  Check the workqueue first.  We are looking for the last</span>
00194         <span class="comment">//  buffer block of a log page block which contains this</span>
00195         <span class="comment">//  Lsn.</span>
00196         <span class="comment">//</span>
00197 
00198         ThisEntry = Lfcb-&gt;LbcbWorkque.Flink;
00199 
00200         <span class="comment">//</span>
00201         <span class="comment">//  We keep looping.</span>
00202         <span class="comment">//</span>
00203 
00204         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00205 
00206             ThisLbcb = CONTAINING_RECORD( ThisEntry,
00207                                           <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00208                                           WorkqueLinks );
00209 
00210             <span class="comment">//</span>
00211             <span class="comment">//  We pass over any restart areas.  We also skip any</span>
00212             <span class="comment">//  Lbcb's which do not contain the end of a log record.</span>
00213             <span class="comment">//</span>
00214 
00215             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d4/lfsprocs_8h.html#a20">LfsLbcbIsRestart</a>( ThisLbcb )
00216                 &amp;&amp; <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o12">Flags</a>, LOG_PAGE_LOG_RECORD_END )) {
00217 
00218                 LastRecordLbcb = ThisLbcb;
00219 
00220                 <span class="comment">//</span>
00221                 <span class="comment">//  If the last complete Lsn in this Lbcb is greater or equal</span>
00222                 <span class="comment">//  to the desired Lsn, we exit the loop.</span>
00223                 <span class="comment">//</span>
00224 
00225                 <span class="keywordflow">if</span> (ThisLbcb-&gt;LastEndLsn.QuadPart &gt;= Lsn.QuadPart) {
00226 
00227                     <span class="keywordflow">break</span>;
00228                 }
00229             }
00230 
00231             <span class="comment">//</span>
00232             <span class="comment">//  Otherwise move to the next Lbcb.</span>
00233             <span class="comment">//</span>
00234 
00235             ThisEntry = ThisEntry-&gt;Flink;
00236 
00237             <span class="comment">//</span>
00238             <span class="comment">//  If we have reached the end of the list then break out.  We</span>
00239             <span class="comment">//  were given an Lsn which is larger than any flushed Lsn so</span>
00240             <span class="comment">//  we will just flush to the end of the log file.</span>
00241             <span class="comment">//</span>
00242 
00243             <span class="keywordflow">if</span> (ThisEntry == &amp;Lfcb-&gt;LbcbWorkque) {
00244 
00245                 <span class="keywordflow">if</span> (UseLastRecordLbcb) {
00246 
00247                     ThisLbcb = LastRecordLbcb;
00248                 }
00249 
00250                 <span class="keywordflow">break</span>;
00251             }
00252         }
00253 
00254         <span class="keywordflow">if</span> (ThisLbcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00255 
00256             <span class="comment">//</span>
00257             <span class="comment">//  If we are not supporting a packed log file and this Lbcb is from</span>
00258             <span class="comment">//  the active queue, we need to check that losing the tail of the</span>
00259             <span class="comment">//  will not swallow up any of our reserved space.</span>
00260             <span class="comment">//</span>
00261 
00262             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )
00263                 &amp;&amp; <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_ON_ACTIVE_QUEUE )) {
00264 
00265                 LONGLONG CurrentAvail;
00266                 LONGLONG UnusedBytes;
00267 
00268                 <span class="comment">//</span>
00269                 <span class="comment">//  Find the unused bytes.</span>
00270                 <span class="comment">//</span>
00271 
00272                 UnusedBytes = 0;
00273 
00274                 <a class="code" href="../../d7/d5/lfs_2verfysup_8c.html#a0">LfsCurrentAvailSpace</a>( Lfcb,
00275                                       &amp;CurrentAvail,
00276                                       (PULONG)&amp;UnusedBytes );
00277 
00278                 CurrentAvail = CurrentAvail - Lfcb-&gt;TotalUndoCommitment;
00279 
00280                 <span class="keywordflow">if</span> (UnusedBytes &gt; CurrentAvail) {
00281 
00282                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"Have to preserve these bytes for possible aborts\n"</span>, 0 );
00283 
00284                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_LOG_FILE_FULL );
00285                 }
00286 
00287                 <span class="comment">//</span>
00288                 <span class="comment">//  We want to make sure we don't write any more data into this</span>
00289                 <span class="comment">//  page.  Remove this from the active queue.</span>
00290                 <span class="comment">//</span>
00291 
00292                 RemoveEntryList( &amp;ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o3">ActiveLinks</a> );
00293                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_ON_ACTIVE_QUEUE );
00294             }
00295 
00296             <span class="comment">//</span>
00297             <span class="comment">//  We now have the Lbcb we want to flush to disk.</span>
00298             <span class="comment">//</span>
00299 
00300             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a53">LfsFlushLbcb</a>( Lfcb, ThisLbcb );
00301         }
00302     }
00303 
00304     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsFlushToLsnPriv:  Exit\n"</span>, 0 );
00305 
00306     <span class="keywordflow">return</span>;
00307 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="lfsprocs.h::LfsFreeSpanningBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsFreeSpanningBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Buffer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00297">297</a> of file <a class="el" href="../../d7/d4/logpgsup_8c-source.html">logpgsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00657">_LFS_DATA::Buffer1</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00660">_LFS_DATA::BufferFlags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00659">_LFS_DATA::BufferOwner</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02455">ExGetCurrentResourceThread</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00670">LFS_BUFFER1_OWNED</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00671">LFS_BUFFER2_OWNED</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00490">LfsAcquireBufferLock</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00033">LfsData</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00048">LfsFreePool</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00503">LfsNotifyBufferWaiters</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00493">LfsReleaseBufferLock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00518">LfsDeallocateLcb()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00809">LfsFindLogRecord()</a>, and <a class="el" href="../../d4/d2/querylog_8c-source.html#l00299">LfsReadNextLogRecord()</a>.
<p>
<pre class="fragment"><div>00303                    :
00304 
00305     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to free a buffer used to read a log record
00306     which spans pages.  We will check <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one of our special buffers
00307     and deal with synchronization in that <span class="keywordflow">case</span>.
00308 
00309 Arguments:
00310 
00311     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> to free.
00312 
00313 Return Value:
00314 
00315     None.
00316 
00317 --*/
00318 
00319 {
00320     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> Thread;
00321 
00322     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00323 
00324     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsFreeSpanningBuffer:  Entered\n"</span>, 0 );
00325 
00326     <span class="comment">//</span>
00327     <span class="comment">//  Do an unsafe test of the buffer flags.  If we own a buffer then they must be non-zero.</span>
00328     <span class="comment">//  Otherwise do the correct check of the resource thread.</span>
00329     <span class="comment">//</span>
00330 
00331     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER1_OWNED | LFS_BUFFER2_OWNED ) ||
00332         (<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o7">BufferOwner</a> != <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>())) {
00333 
00334         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a4">LfsFreePool</a>( Buffer );
00335 
00336     } <span class="keywordflow">else</span> {
00337 
00338         <span class="comment">//</span>
00339         <span class="comment">//  Acquire the lock for synchronization.</span>
00340         <span class="comment">//</span>
00341 
00342         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a23">LfsAcquireBufferLock</a>();
00343 
00344         <span class="comment">//</span>
00345         <span class="comment">//  Check which buffer it is.</span>
00346         <span class="comment">//</span>
00347 
00348         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> == <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o5">Buffer1</a>) {
00349 
00350             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER1_OWNED );
00351 
00352         } <span class="keywordflow">else</span> {
00353 
00354             <span class="comment">//</span>
00355             <span class="comment">//  It better be buffer2</span>
00356             <span class="comment">//</span>
00357 
00358             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER2_OWNED ));
00359             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER2_OWNED );
00360         }
00361 
00362         <span class="comment">//</span>
00363         <span class="comment">//  If no buffers owned then signal the waiters.</span>
00364         <span class="comment">//</span>
00365 
00366         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER1_OWNED | LFS_BUFFER2_OWNED )) {
00367 
00368             <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o7">BufferOwner</a> = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00369             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a26">LfsNotifyBufferWaiters</a>();
00370         }
00371 
00372         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a24">LfsReleaseBufferLock</a>();
00373     }
00374 
00375     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsFreeSpanningBuffer:  Exit\n"</span>, 0 );
00376 
00377     <span class="keywordflow">return</span>;
00378 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="lfsprocs.h::LfsGetLbcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a> LfsGetLbcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Lfcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00311">311</a> of file <a class="el" href="../../d8/d0/lbcbsup_8c-source.html">lbcbsup.c</a>.
<p>
References <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00196">_LBCB::ActiveLinks</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00219">_LBCB::BufferOffset</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01078">CcSetBcbOwnerPointer()</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02455">ExGetCurrentResourceThread</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00203">_LBCB::FileOffset</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00261">_LBCB::Flags</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00249">_LBCB::LastEndLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00242">_LBCB::LastLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00286">LBCB_FLUSH_COPY</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00283">LBCB_LOG_WRAPPED</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00284">LBCB_ON_ACTIVE_QUEUE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00273">_LBCB::LbcbFlags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00204">_LBCB::Length</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00599">LFCB_LOG_WRAPPED</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00601">LFCB_NO_LAST_LSN</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00603">LFCB_REUSE_TAIL</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00341">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00315">LfsAllocateLbcb()</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00402">LfsDeallocateLbcb()</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00311">LfsGetLbcb()</a>, <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00040">LfsNextLogPageOffset()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00080">LfsPreparePinWriteData</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00235">_LBCB::LogPageBcb</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00228">_LBCB::PageHeader</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00279">_LBCB::ResourceThread</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00211">_LBCB::SeqNumber</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00311">LfsGetLbcb()</a>, and <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00431">LfsPrepareLfcbForLogRecord()</a>.
<p>
<pre class="fragment"><div>00317                    :
00318 
00319     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to add a Lbcb to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active queue.
00320 
00321 Arguments:
00322 
00323     Lfcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00324 
00325 Return Value:
00326 
00327     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lbcb allocated.
00328 
00329 --*/
00330 
00331 {
00332     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> Lbcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00333     PVOID PageHeader;
00334     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> PageHeaderBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00335 
00336     BOOLEAN WrappedOrUsaError;
00337 
00338     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00339 
00340     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsGetLbcb:  Entered\n"</span>, 0 );
00341     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb      -&gt; %08lx\n"</span>, Lfcb );
00342 
00343     <span class="comment">//</span>
00344     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00345     <span class="comment">//</span>
00346 
00347     <span class="keywordflow">try</span> {
00348 
00349         <span class="comment">//</span>
00350         <span class="comment">//  Pin the desired record page.</span>
00351         <span class="comment">//</span>
00352 
00353         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a5">LfsPreparePinWriteData</a>( Lfcb,
00354                                 Lfcb-&gt;NextLogPage,
00355                                 (ULONG)Lfcb-&gt;LogPageSize,
00356                                 &amp;PageHeader,
00357                                 &amp;PageHeaderBcb );
00358 
00359         <span class="comment">//</span>
00360         <span class="comment">//  Put our signature into the page so we won't fail if we</span>
00361         <span class="comment">//  see a previous 'BAAD' signature.</span>
00362         <span class="comment">//</span>
00363 
00364         *((PULONG) PageHeader) = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a14">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>;
00365 
00366         <span class="comment">//</span>
00367         <span class="comment">//  Now allocate an Lbcb.</span>
00368         <span class="comment">//</span>
00369 
00370         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a3">LfsAllocateLbcb</a>( Lfcb, &amp;Lbcb );
00371 
00372         <span class="comment">//</span>
00373         <span class="comment">//  If we are at the beginning of the file we test that the</span>
00374         <span class="comment">//  sequence number won't wrap to 0.</span>
00375         <span class="comment">//</span>
00376 
00377         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_NO_LAST_LSN | LFCB_REUSE_TAIL )
00378             &amp;&amp; ( Lfcb-&gt;NextLogPage == Lfcb-&gt;FirstLogPage )) {
00379 
00380             Lfcb-&gt;SeqNumber = Lfcb-&gt;SeqNumber + 1;
00381 
00382             <span class="comment">//</span>
00383             <span class="comment">//  If the sequence number is going from 0 to 1, then</span>
00384             <span class="comment">//  this is the first time the log file has wrapped.  We want</span>
00385             <span class="comment">//  to remember this because it means that we can now do</span>
00386             <span class="comment">//  large spiral writes.</span>
00387             <span class="comment">//</span>
00388 
00389             <span class="keywordflow">if</span> (Int64ShllMod32( Lfcb-&gt;SeqNumber, Lfcb-&gt;FileDataBits ) == 0) {
00390 
00391                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Log sequence number about to wrap:  Lfcb -&gt; %08lx\n"</span>, Lfcb );
00392                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>( FILE_SYSTEM );
00393             }
00394 
00395             <span class="comment">//</span>
00396             <span class="comment">//  If this number is greater or equal to  the wrap sequence number in</span>
00397             <span class="comment">//  the Lfcb, set the wrap flag in the Lbcb.</span>
00398             <span class="comment">//</span>
00399 
00400             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_LOG_WRAPPED )
00401                 &amp;&amp; ( Lfcb-&gt;SeqNumber &gt;= Lfcb-&gt;SeqNumberForWrap )) {
00402 
00403                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_LOG_WRAPPED );
00404                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, LFCB_LOG_WRAPPED );
00405             }
00406         }
00407 
00408         <span class="comment">//</span>
00409         <span class="comment">//  Now initialize the rest of the Lbcb fields.</span>
00410         <span class="comment">//</span>
00411 
00412         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a> = Lfcb-&gt;NextLogPage;
00413         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o6">SeqNumber</a> = Lfcb-&gt;SeqNumber;
00414         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a> = Lfcb-&gt;LogPageDataOffset;
00415 
00416         <span class="comment">//</span>
00417         <span class="comment">//  Store the next page in the Lfcb.</span>
00418         <span class="comment">//</span>
00419 
00420         <a class="code" href="../../d6/d5/logpgsup_8c.html#a2">LfsNextLogPageOffset</a>( Lfcb,
00421                               Lfcb-&gt;NextLogPage,
00422                               &amp;Lfcb-&gt;NextLogPage,
00423                               &amp;WrappedOrUsaError );
00424 
00425         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o5">Length</a> = Lfcb-&gt;LogPageSize;
00426         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a> = PageHeader;
00427         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o9">LogPageBcb</a> = PageHeaderBcb;
00428 
00429         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o14">ResourceThread</a> = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
00430         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o14">ResourceThread</a> = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>) ((ULONG) Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o14">ResourceThread</a> | 3);
00431 
00432         <span class="comment">//</span>
00433         <span class="comment">//  If we are reusing a previous page then set a flag in</span>
00434         <span class="comment">//  the Lbcb to indicate that we should flush a copy</span>
00435         <span class="comment">//  first.</span>
00436         <span class="comment">//</span>
00437 
00438         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_REUSE_TAIL )) {
00439 
00440             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_FLUSH_COPY );
00441             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Lfcb-&gt;Flags, LFCB_REUSE_TAIL );
00442 
00443             (ULONG)Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a> = Lfcb-&gt;ReusePageOffset;
00444 
00445             Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o12">Flags</a> = ((<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a>) PageHeader)-&gt;Flags;
00446             Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o10">LastLsn</a> = ((<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a>) PageHeader)-&gt;Copy.LastLsn;
00447             Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o11">LastEndLsn</a> = ((<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a>) PageHeader)-&gt;Header.Packed.LastEndLsn;
00448         }
00449 
00450         <span class="comment">//</span>
00451         <span class="comment">//  Put the Lbcb on the active queue</span>
00452         <span class="comment">//</span>
00453 
00454         InsertTailList( &amp;Lfcb-&gt;LbcbActive, &amp;Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o3">ActiveLinks</a> );
00455 
00456         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_ON_ACTIVE_QUEUE );
00457 
00458         <span class="comment">//</span>
00459         <span class="comment">//  Now that we have succeeded, set the owner thread to Thread + 1 so the resource</span>
00460         <span class="comment">//  package will know not to peek in this thread.  It may be deallocated before</span>
00461         <span class="comment">//  we release the Bcb during flush.</span>
00462         <span class="comment">//</span>
00463 
00464         <a class="code" href="../../d4/d2/cache_8h.html#a93">CcSetBcbOwnerPointer</a>( Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o9">LogPageBcb</a>, (PVOID) Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o14">ResourceThread</a> );
00465 
00466     } finally {
00467 
00468         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsGetLbcb );
00469 
00470         <span class="comment">//</span>
00471         <span class="comment">//  If an error occurred, we need to clean up any blocks which</span>
00472         <span class="comment">//  have not been added to the active queue.</span>
00473         <span class="comment">//</span>
00474 
00475         <span class="keywordflow">if</span> (AbnormalTermination()) {
00476 
00477             <span class="keywordflow">if</span> (Lbcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00478 
00479                 <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a>( Lfcb, Lbcb );
00480                 Lbcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00481             }
00482 
00483             <span class="comment">//</span>
00484             <span class="comment">//  Unpin the system page if pinned.</span>
00485             <span class="comment">//</span>
00486 
00487             <span class="keywordflow">if</span> (PageHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00488 
00489                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( PageHeaderBcb );
00490             }
00491         }
00492 
00493         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsGetLbcb:  Exit\n"</span>, 0 );
00494     }
00495 
00496     <span class="keywordflow">return</span> Lbcb;
00497 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="lfsprocs.h::LfsLsnFinalOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsLsnFinalOffset           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DataLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FinalOffset</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00036">36</a> of file <a class="el" href="../../d0/d7/lsnsup_8c-source.html">lsnsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00308">LfsLsnToPageOffset</a>, <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00040">LfsNextLogPageOffset()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00297">LfsTruncateLsnToLogPage</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00148">LfsFindNextLsn()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>.
<p>
<pre class="fragment"><div>00045                    :
00046 
00047     This routine will compute <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> offset of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last byte of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log
00048     record.  It does <span class="keyword">this</span> by computing how many bytes are on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
00049     page and then computing how many more pages will be needed.
00050 
00051 Arguments:
00052 
00053     Lfcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00054 
00055     Lsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record being considered.
00056 
00057     DataLength - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <span class="keywordflow">for</span> <span class="keyword">this</span> log record.  We will add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00058         header length here.
00059 
00060     FinalOffset - Address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result.
00061 
00062 Return Value:
00063 
00064     None.
00065 
00066 --*/
00067 
00068 {
00069     ULONG RemainingPageBytes;
00070     ULONG PageOffset;
00071 
00072     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00073 
00074     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsLsnFinalOffset:  Entered\n"</span>, 0 );
00075     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb          -&gt;  %08lx\n"</span>, Lfcb );
00076     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)     -&gt;  %08lx\n"</span>, Lsn.LowPart );
00077     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (High)    -&gt;  %08lx\n"</span>, Lsn.HighPart );
00078     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"DataLength    -&gt;  %08lx\n"</span>, DataLength );
00079 
00080     <span class="comment">//</span>
00081     <span class="comment">//  We compute the starting log page file offset, the number of bytes</span>
00082     <span class="comment">//  remaining in the current log page and the position on this page</span>
00083     <span class="comment">//  before any data bytes.</span>
00084     <span class="comment">//</span>
00085 
00086     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a11">LfsTruncateLsnToLogPage</a>( Lfcb, Lsn, FinalOffset );
00087 
00088     PageOffset = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a14">LfsLsnToPageOffset</a>( Lfcb, Lsn );
00089 
00090     RemainingPageBytes = (ULONG)Lfcb-&gt;LogPageSize - PageOffset;
00091 
00092     PageOffset -= 1;
00093 
00094     <span class="comment">//</span>
00095     <span class="comment">//  Add the length of the header.</span>
00096     <span class="comment">//</span>
00097 
00098     DataLength += Lfcb-&gt;RecordHeaderLength;
00099 
00100     <span class="comment">//</span>
00101     <span class="comment">//  If this Lsn is contained in this log page we are done.</span>
00102     <span class="comment">//  Otherwise we need to walk through several log pages.</span>
00103     <span class="comment">//</span>
00104 
00105     <span class="keywordflow">if</span> (DataLength &gt; RemainingPageBytes) {
00106 
00107         DataLength -= RemainingPageBytes;
00108 
00109         RemainingPageBytes = (ULONG)Lfcb-&gt;LogPageDataSize;
00110 
00111         PageOffset = (ULONG)Lfcb-&gt;LogPageDataOffset - 1;
00112 
00113         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00114 
00115             BOOLEAN Wrapped;
00116 
00117             <a class="code" href="../../d6/d5/logpgsup_8c.html#a2">LfsNextLogPageOffset</a>( Lfcb, *FinalOffset, FinalOffset, &amp;Wrapped );
00118 
00119             <span class="comment">//</span>
00120             <span class="comment">//  We are done if the remaining bytes fit on this page.</span>
00121             <span class="comment">//</span>
00122 
00123             <span class="keywordflow">if</span> (DataLength &lt;= RemainingPageBytes) {
00124 
00125                 <span class="keywordflow">break</span>;
00126             }
00127 
00128             DataLength -= RemainingPageBytes;
00129         }
00130     }
00131 
00132     <span class="comment">//</span>
00133     <span class="comment">//  We add the remaining bytes to our starting position on this page</span>
00134     <span class="comment">//  and then add that value to the file offset of this log page.</span>
00135     <span class="comment">//</span>
00136 
00137     *(PULONG)FinalOffset += (DataLength + PageOffset);
00138 
00139     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"FinalOffset (Low)     -&gt;  %08lx\n"</span>, LogPageFileOffset.LowPart );
00140     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"FinalOffset (High)    -&gt;  %08lx\n"</span>, LogPageFileOffset.HighPart );
00141     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsLsnFinalOffset:  Exit\n"</span>, 0 );
00142 
00143     <span class="keywordflow">return</span>;
00144 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="lfsprocs.h::LfsNextLogPageOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsNextLogPageOffset           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentLogPageOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NextLogPageOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wrapped</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00040">40</a> of file <a class="el" href="../../d7/d4/logpgsup_8c-source.html">logpgsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00184">LfsTruncateOffsetToLogPage</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00339">LfsCopyReadLogRecord()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03193">LfsFindLastLsn()</a>, <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00148">LfsFindNextLsn()</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00311">LfsGetLbcb()</a>, <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00036">LfsLsnFinalOffset()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>.
<p>
<pre class="fragment"><div>00049                    :
00050 
00051     This routine will compute <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next log
00052     page.
00053 
00054 Arguments:
00055 
00056     Lfcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00057 
00058     CurrentLogPageOffset - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current log page.
00059 
00060     NextLogPageOffset - Address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next log page to use.
00061 
00062     Wrapped - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to a <span class="keywordtype">boolean</span> variable that, <span class="keywordflow">if</span> present,
00063               we use to indicate whether we wrapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00064 
00065 Return Value:
00066 
00067     None.
00068 
00069 --*/
00070 
00071 {
00072     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00073 
00074     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsNextLogPageOffset:  Entered\n"</span>, 0 );
00075     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb                          -&gt;  %08lx\n"</span>, Lfcb );
00076     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"CurrentLogPageOffset (Low)    -&gt;  %08lx\n"</span>, CurrentLogPageOffset.LowPart );
00077     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"CurrentLogPageOffset (High)   -&gt;  %08lx\n"</span>, CurrentLogPageOffset.HighPart );
00078     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Wrapped                       -&gt;  %08lx\n"</span>, Wrapped );
00079 
00080     <span class="comment">//</span>
00081     <span class="comment">//  We add the log page size to the current log offset.</span>
00082     <span class="comment">//</span>
00083 
00084     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a6">LfsTruncateOffsetToLogPage</a>( Lfcb, CurrentLogPageOffset, &amp;CurrentLogPageOffset );
00085     *NextLogPageOffset = CurrentLogPageOffset + Lfcb-&gt;LogPageSize;                                                     <span class="comment">//**** xxAdd( CurrentLogPageOffset, Lfcb-&gt;LogPageSize );</span>
00086 
00087     <span class="comment">//</span>
00088     <span class="comment">//  If the result is larger than the file, we use the first page offset</span>
00089     <span class="comment">//  in the file.</span>
00090     <span class="comment">//</span>
00091 
00092     <span class="keywordflow">if</span> ( *NextLogPageOffset &gt;= Lfcb-&gt;FileSize ) {                                                                      <span class="comment">//**** xxGeq( *NextLogPageOffset, Lfcb-&gt;FileSize )</span>
00093 
00094         *NextLogPageOffset = Lfcb-&gt;FirstLogPage;
00095 
00096         *Wrapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00097 
00098     } <span class="keywordflow">else</span> {
00099 
00100         *Wrapped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00101     }
00102 
00103     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"NextLogPageOffset (Low)    -&gt;  %08lx\n"</span>, NextLogPageOffset-&gt;LowPart );
00104     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"NextLogPageOffset (High)   -&gt;  %08lx\n"</span>, NextLogPageOffset-&gt;HighPart );
00105     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Wrapped                    -&gt;  %08x\n"</span>, *Wrapped );
00106     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsNextLogPageOffset:  Exit\n"</span>, 0 );
00107 
00108     <span class="keywordflow">return</span>;
00109 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="lfsprocs.h::LfsPinOrMapData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LfsPinOrMapData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>PinData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AllowErrors</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreUsaErrors</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>UsaError</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d4/d3/struct__BCB.html">PBCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Bcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">84</a> of file <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html">lfs/cachesup.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00052">CcMapData()</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00524">CcPinRead()</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00343">LFS_SIGNATURE_BAD_USA_ULONG</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">LfsPinOrMapData()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00339">LfsCopyReadLogRecord()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03193">LfsFindLastLsn()</a>, <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00148">LfsFindNextLsn()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">LfsFlushLfcb()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03065">LfsInitializeLogFilePriv()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">LfsPinOrMapData()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00248">LfsPinOrMapLogRecordHeader()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01402">LfsReadRestart()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.
<p>
<pre class="fragment"><div>00098                    :
00099 
00100     This routine will pin or map a portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00101 
00102 Arguments:
00103 
00104     Lfcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00105 
00106     FileOffset - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log page to pin.
00107 
00108     Length - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data to access.
00109 
00110     PinData - <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> indicating <span class="keywordflow">if</span> we are to pin or map <span class="keyword">this</span> data.
00111 
00112     AllowErrors - This <span class="keywordtype">boolean</span> indicates whether we should raise on an
00113         I/O error or <span class="keywordflow">return</span> on an I/O error.
00114 
00115     IgnoreUsaErrors - <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> indicating whether we will raise on Usa
00116         errors.
00117 
00118     UsaError - Address to store whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Usa had an error.
00119 
00120     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.
00121 
00122     Bcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Bcb <span class="keywordflow">for</span> <span class="keyword">this</span> operation.
00123 
00124 Return Value:
00125 
00126     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O.
00127 
00128 --*/
00129 
00130 {
00131     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00132     ULONG Signature;
00133     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00134 
00135     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00136 
00137     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00138 
00139     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsPinReadLogPage:  Entered\n"</span>, 0 );
00140     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb              -&gt; %08lx\n"</span>, Lfcb );
00141     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"FileOffset (Low)  -&gt; %08lx\n"</span>, FileOffset.HighPart );
00142     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"FileOffset (High) -&gt; %08lx\n"</span>, FileOffset.LowPart );
00143     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Length            -&gt; %08lx\n"</span>, Length );
00144     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"PinData           -&gt; %04x\n"</span>, PinData );
00145     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"AllowErrors       -&gt; %08x\n"</span>, AllowErrors );
00146     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"IgnoreUsaErrors   -&gt; %04x\n"</span>, IgnoreUsaErrors );
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00150     <span class="comment">//</span>
00151 
00152     <span class="keywordflow">try</span> {
00153 
00154         <span class="comment">//</span>
00155         <span class="comment">//  Use a try-except to catch cache manager errors.</span>
00156         <span class="comment">//</span>
00157 
00158         <span class="keywordflow">try</span> {
00159 
00160             <span class="comment">//</span>
00161             <span class="comment">//  We call the cache to perform the work.</span>
00162             <span class="comment">//</span>
00163 
00164             <span class="keywordflow">if</span> (PinData) {
00165 
00166                 Result = <a class="code" href="../../d4/d2/cache_8h.html#a87">CcPinRead</a>( Lfcb-&gt;FileObject,
00167                                     (PLARGE_INTEGER)&amp;FileOffset,
00168                                     Length,
00169                                     TRUE,
00170                                     Bcb,
00171                                     Buffer );
00172 
00173             } <span class="keywordflow">else</span> {
00174 
00175                 Result = <a class="code" href="../../d4/d2/cache_8h.html#a88">CcMapData</a>( Lfcb-&gt;FileObject,
00176                                     (PLARGE_INTEGER)&amp;FileOffset,
00177                                     Length,
00178                                     TRUE,
00179                                     Bcb,
00180                                     Buffer );
00181             }
00182 
00183             <span class="comment">//</span>
00184             <span class="comment">//  Capture the signature now while we are within the</span>
00185             <span class="comment">//  exception filter.</span>
00186             <span class="comment">//</span>
00187 
00188             Signature = *((PULONG) *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00189 
00190         } except( <a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00191 
00192             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00193             <span class="keywordflow">if</span> (Result) {
00194                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( *Bcb );
00195                 *Bcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00196             }
00197         }
00198 
00199         *UsaError = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00200 
00201         <span class="comment">//</span>
00202         <span class="comment">//  If an error occurred, we raise the status.</span>
00203         <span class="comment">//</span>
00204 
00205         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00206 
00207             <span class="keywordflow">if</span> (!AllowErrors) {
00208 
00209                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Read on log page failed -&gt; %08lx\n"</span>, Status );
00210                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00211             }
00212 
00213         <span class="comment">//</span>
00214         <span class="comment">//  Check that the update sequence array for this</span>
00215         <span class="comment">//  page is valid.</span>
00216         <span class="comment">//</span>
00217 
00218         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Signature == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a16">LFS_SIGNATURE_BAD_USA_ULONG</a>) {
00219 
00220             <span class="comment">//</span>
00221             <span class="comment">//  If we don't allow errors, raise an error status.</span>
00222             <span class="comment">//</span>
00223 
00224             <span class="keywordflow">if</span> (!IgnoreUsaErrors) {
00225 
00226                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Usa error on log page\n"</span>, 0 );
00227                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00228             }
00229 
00230             *UsaError = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00231         }
00232 
00233     } finally {
00234 
00235         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsPinOrMapData );
00236 
00237         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer    -&gt; %08lx\n"</span>, *Buffer );
00238         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Bcb       -&gt; %08lx\n"</span>, *Bcb );
00239 
00240         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsPinOrMapData:  Exit -&gt; %08lx\n"</span>, Status );
00241     }
00242 
00243     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00244 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="lfsprocs.h::LfsPinOrMapLogRecordHeader" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsPinOrMapLogRecordHeader           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>PinData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreUsaErrors</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>UsaError</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>RecordHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d4/d3/struct__BCB.html">PBCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Bcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00248">248</a> of file <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html">lfs/cachesup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00308">LfsLsnToPageOffset</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">LfsPinOrMapData()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00297">LfsTruncateLsnToLogPage</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d3/lfsdisk_8h.html#a28">PLFS_RECORD_HEADER</a>, and <a class="el" href="../../d9/d3/lfsdisk_8h.html#a34">PLFS_RECORD_PAGE_HEADER</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l01004">LfsFindClientNextLsn()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00809">LfsFindLogRecord()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>, and <a class="el" href="../../d4/d2/querylog_8c-source.html#l01116">LfsSearchForwardByClient()</a>.
<p>
<pre class="fragment"><div>00260                    :
00261 
00262     This routine will pin or map a log record <span class="keywordflow">for</span> read access.
00263 
00264 Arguments:
00265 
00266     Lfcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00267 
00268     Lsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn whose header should be pinned.
00269 
00270     PinData - <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> indicating <span class="keywordflow">if</span> we are to pin or map <span class="keyword">this</span> data.
00271 
00272     IgnoreUsaErrors - <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> indicating whether we will raise on Usa
00273         errors.
00274 
00275     UsaError - Address to store whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Usa had an error.
00276 
00277     RecordHeader - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pinned data.
00278 
00279     Bcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Bcb <span class="keywordflow">for</span> <span class="keyword">this</span> pin operation.
00280 
00281 Return Value:
00282 
00283     None.
00284 
00285 --*/
00286 
00287 {
00288     <a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a> LogPageHeader;
00289     LONGLONG LogPage;
00290     ULONG PageOffset;
00291 
00292     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00293 
00294     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsPinOrMapLogRecordHeader:  Entered\n"</span>, 0 );
00295     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb       -&gt; %08lx\n"</span>, Lfcb );
00296     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)  -&gt; %08lx\n"</span>, Lsn.HighPart );
00297     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (High) -&gt; %08lx\n"</span>, Lsn.LowPart );
00298     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"PinData           -&gt; %04x\n"</span>, PinData );
00299     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"IgnoreUsaErrors   -&gt; %04x\n"</span>, IgnoreUsaErrors );
00300 
00301     <span class="comment">//</span>
00302     <span class="comment">//  Compute the log page and the offset of the log record header</span>
00303     <span class="comment">//  in the log page.</span>
00304     <span class="comment">//</span>
00305 
00306     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a11">LfsTruncateLsnToLogPage</a>( Lfcb, Lsn, &amp;LogPage );
00307     PageOffset = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a14">LfsLsnToPageOffset</a>( Lfcb, Lsn );
00308 
00309     <span class="comment">//</span>
00310     <span class="comment">//  Call the cache manager to pin the page.</span>
00311     <span class="comment">//</span>
00312 
00313     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
00314                      LogPage,
00315                      (ULONG)Lfcb-&gt;LogPageSize,
00316                      PinData,
00317                      FALSE,
00318                      IgnoreUsaErrors,
00319                      UsaError,
00320                      (PVOID *) &amp;LogPageHeader,
00321                      Bcb );
00322 
00323     <span class="comment">//</span>
00324     <span class="comment">//  The actual offset we need is at PageOffset from the start of the page.</span>
00325     <span class="comment">//</span>
00326 
00327     *RecordHeader = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( LogPageHeader, PageOffset, <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> );
00328 
00329     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Record Header -&gt; %08lx\n"</span>, *RecordHeader );
00330     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Bcb           -&gt; %08lx\n"</span>, *Bcb );
00331 
00332     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsPinOrMapLogRecordHeader:  Exit\n"</span>, 0 );
00333 
00334     <span class="keywordflow">return</span>;
00335 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="lfsprocs.h::LfsReadRestart" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LfsReadRestart           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FirstRestart</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartPageOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartPage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d4/d3/struct__BCB.html">PBCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartPageBcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ChkdskWasRun</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ValidPage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>UninitializedFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LogPacked</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LastLsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01402">1402</a> of file <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html">lfs/cachesup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00444">_LFS_RESTART_AREA::ClientInUseList</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00428">_LFS_RESTART_AREA::CurrentLsn</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00355">LFS_NO_CLIENT</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00345">LFS_SIGNATURE_MODIFIED_ULONG</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00341">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00339">LFS_SIGNATURE_RESTART_PAGE_ULONG</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00347">LFS_SIGNATURE_UNINITIALIZED_ULONG</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l02046">LfsIsClientAreaValid()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01885">LfsIsRestartAreaValid()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01711">LfsIsRestartPageHeaderValid()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">LfsPinOrMapData()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01402">LfsReadRestart()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00140">PLSN</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00073">SEQUENCE_NUMBER_STRIDE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01402">LfsReadRestart()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.
<p>
<pre class="fragment"><div>01418                    :
01419 
01420     This routine will walk through 512 blocks of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> looking <span class="keywordflow">for</span> a
01421     valid restart page header.  It will stop <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first time we find
01422     a valid page header.
01423 
01424 Arguments:
01425 
01426     Lfcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01427 
01428     FileSize - <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> in bytes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01429 
01430     FirstRestart - Indicates <span class="keywordflow">if</span> we are looking <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first valid
01431         restart area.
01432 
01433     RestartPageOffset - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> location to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01434         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log page was found.
01435 
01436     RestartPage - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> location to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01437         pinned restart page.
01438 
01439     RestartPageBcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> location to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Bcb <span class="keywordflow">for</span> <span class="keyword">this</span>
01440         cache pin operation.
01441 
01442     ChkdskWasRun - Address to store whether checkdisk was run on <span class="keyword">this</span> volume.
01443 
01444     ValidPage - Address to store whether there was valid data on <span class="keyword">this</span> page.
01445 
01446     UninitializedFile - Address to store whether <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an uninitialized
01447         log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  Return value <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> valid <span class="keywordflow">if</span> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first restart area.
01448 
01449     LogPacked - Address to store whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> packed.
01450 
01451     LastLsn - Address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last Lsn <span class="keywordflow">for</span> <span class="keyword">this</span> restart page.  It will be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01452         chkdsk value <span class="keywordflow">if</span> checkdisk was run.  Otherwise <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LastFlushedLsn
01453         <span class="keywordflow">for</span> <span class="keyword">this</span> restart page.
01454 
01455 Return Value:
01456 
01457     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> a restart area was found, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01458 
01459 --*/
01460 
01461 {
01462     ULONG FileOffsetIncrement;
01463     LONGLONG FileOffset;
01464 
01465     <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> RestartArea;
01466 
01467     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01468 
01469     <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> ThisPage;
01470     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> ThisPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01471 
01472     BOOLEAN FoundRestart = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01473 
01474     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01475 
01476     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsReadRestart:  Entered\n"</span>, 0 );
01477     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb   -&gt; %08lx\n"</span>, Lfcb );
01478 
01479     <span class="comment">//</span>
01480     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01481     <span class="comment">//</span>
01482 
01483     *UninitializedFile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01484     *ValidPage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01485     *ChkdskWasRun = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01486     *LogPacked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01487 
01488     <span class="keywordflow">try</span> {
01489 
01490         <span class="comment">//</span>
01491         <span class="comment">//  Determine which restart area we are looking for.</span>
01492         <span class="comment">//</span>
01493 
01494         <span class="keywordflow">if</span> (FirstRestart) {
01495 
01496             FileOffset = 0;
01497             FileOffsetIncrement = <a class="code" href="../../d6/d3/lfs_8h.html#a0">SEQUENCE_NUMBER_STRIDE</a>;
01498 
01499         } <span class="keywordflow">else</span> {
01500 
01501             FileOffset = <a class="code" href="../../d6/d3/lfs_8h.html#a0">SEQUENCE_NUMBER_STRIDE</a>;
01502             FileOffsetIncrement = 0;
01503         }
01504 
01505         <span class="comment">//</span>
01506         <span class="comment">//  We loop continuously until we succeed, pin a log record page</span>
01507         <span class="comment">//  or exhaust the number of possible tries.</span>
01508         <span class="comment">//</span>
01509 
01510         <span class="keywordflow">while</span> ( FileOffset &lt; FileSize ) {
01511 
01512             ULONG Signature;
01513             BOOLEAN UsaError;
01514 
01515             <span class="keywordflow">if</span> (ThisPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01516 
01517                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( ThisPageBcb );
01518                 ThisPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01519             }
01520 
01521             <span class="comment">//</span>
01522             <span class="comment">//  Attempt to pin a page header at the current offset.</span>
01523             <span class="comment">//</span>
01524 
01525             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
01526                                       FileOffset,
01527                                       SEQUENCE_NUMBER_STRIDE,
01528                                       TRUE,
01529                                       TRUE,
01530                                       TRUE,
01531                                       &amp;UsaError,
01532                                       (PVOID *)&amp;ThisPage,
01533                                       &amp;ThisPageBcb );
01534 
01535             <span class="comment">//</span>
01536             <span class="comment">//</span>
01537             <span class="comment">//  If we succeeded, we look at the 4 byte signature.</span>
01538             <span class="comment">//</span>
01539 
01540             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01541 
01542                 Signature = *((PULONG) &amp;ThisPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o0">Signature</a>);
01543 
01544                 <span class="comment">//</span>
01545                 <span class="comment">//  If the signature is a log record page, we will exit.</span>
01546                 <span class="comment">//</span>
01547 
01548                 <span class="keywordflow">if</span> (Signature == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a14">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>) {
01549 
01550                     *UninitializedFile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01551                     <span class="keywordflow">break</span>;
01552                 }
01553 
01554                 <span class="comment">//</span>
01555                 <span class="comment">//  Continue analyzing the page if the signature is chkdsk or</span>
01556                 <span class="comment">//  a restart page.</span>
01557                 <span class="comment">//</span>
01558 
01559                 <span class="keywordflow">if</span> (Signature == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a18">LFS_SIGNATURE_MODIFIED_ULONG</a>
01560                     || Signature == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a12">LFS_SIGNATURE_RESTART_PAGE_ULONG</a>) {
01561 
01562                     *UninitializedFile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01563 
01564                     <span class="comment">//</span>
01565                     <span class="comment">//  Remember where we found this page.</span>
01566                     <span class="comment">//</span>
01567 
01568                     *RestartPageOffset = FileOffset;
01569 
01570                     <span class="comment">//</span>
01571                     <span class="comment">//  Let's check the restart area if this is a valid page.</span>
01572                     <span class="comment">//</span>
01573 
01574                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a2">LfsIsRestartPageHeaderValid</a>( FileOffset,
01575                                                      ThisPage,
01576                                                      LogPacked )
01577 
01578                         &amp;&amp; <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a3">LfsIsRestartAreaValid</a>( ThisPage, *LogPacked )) {
01579 
01580                         <span class="comment">//</span>
01581                         <span class="comment">//  We have a valid restart page header and restart area.</span>
01582                         <span class="comment">//  If chkdsk was run or we have no clients then</span>
01583                         <span class="comment">//  we have no more checking to do.</span>
01584                         <span class="comment">//</span>
01585 
01586                         RestartArea = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( ThisPage,
01587                                                ThisPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o4">RestartOffset</a>,
01588                                                <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> );
01589 
01590                         <span class="keywordflow">if</span> (Signature == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a12">LFS_SIGNATURE_RESTART_PAGE_ULONG</a>
01591                             &amp;&amp; RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a> != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
01592 
01593                             <span class="comment">//</span>
01594                             <span class="comment">//  Pin the entire restart area if we didn't have an earlier</span>
01595                             <span class="comment">//</span>
01596 
01597                             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( ThisPageBcb );
01598                             ThisPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01599 
01600                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
01601                                                       FileOffset,
01602                                                       ThisPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o2">SystemPageSize</a>,
01603                                                       TRUE,
01604                                                       TRUE,
01605                                                       TRUE,
01606                                                       &amp;UsaError,
01607                                                       (PVOID *)&amp;ThisPage,
01608                                                       &amp;ThisPageBcb );
01609 
01610                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )
01611                                 &amp;&amp; <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a4">LfsIsClientAreaValid</a>( ThisPage, *LogPacked, UsaError )) {
01612 
01613                                 *ValidPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01614 
01615                                 RestartArea = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( ThisPage,
01616                                                        ThisPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o4">RestartOffset</a>,
01617                                                        <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> );
01618                             }
01619 
01620                         } <span class="keywordflow">else</span> {
01621 
01622                             *ValidPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01623                         }
01624                     }
01625 
01626                     <span class="comment">//</span>
01627                     <span class="comment">//  If chkdsk was run then update the caller's values and return.</span>
01628                     <span class="comment">//</span>
01629 
01630                     <span class="keywordflow">if</span> (Signature == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a18">LFS_SIGNATURE_MODIFIED_ULONG</a>) {
01631 
01632                         *ChkdskWasRun = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01633 
01634                         *LastLsn = ThisPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o1">ChkDskLsn</a>;
01635 
01636                         FoundRestart = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01637 
01638                         *RestartPageBcb = ThisPageBcb;
01639                         *RestartPage = ThisPage;
01640 
01641                         ThisPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01642                         <span class="keywordflow">break</span>;
01643                     }
01644 
01645                     <span class="comment">//</span>
01646                     <span class="comment">//  If we have a valid page then copy the values we need from it.</span>
01647                     <span class="comment">//</span>
01648 
01649                     <span class="keywordflow">if</span> (*ValidPage) {
01650 
01651                         *LastLsn = RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o0">CurrentLsn</a>;
01652 
01653                         FoundRestart = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01654 
01655                         *RestartPageBcb = ThisPageBcb;
01656                         *RestartPage = ThisPage;
01657 
01658                         ThisPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01659                         <span class="keywordflow">break</span>;
01660                     }
01661 
01662                 <span class="comment">//</span>
01663                 <span class="comment">//  Remember if the signature does not indicate uninitialized file.</span>
01664                 <span class="comment">//</span>
01665 
01666                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Signature != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a20">LFS_SIGNATURE_UNINITIALIZED_ULONG</a>) {
01667 
01668                     *UninitializedFile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01669                 }
01670             }
01671 
01672             <span class="comment">//</span>
01673             <span class="comment">//  Move to the next possible log page.</span>
01674             <span class="comment">//</span>
01675 
01676             FileOffset = FileOffset &lt;&lt; 1;
01677 
01678             (ULONG)FileOffset += FileOffsetIncrement;
01679 
01680             FileOffsetIncrement = 0;
01681         }
01682 
01683     } finally {
01684 
01685         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsReadRestart );
01686 
01687         <span class="comment">//</span>
01688         <span class="comment">//  Unpin the log pages if pinned.</span>
01689         <span class="comment">//</span>
01690 
01691         <span class="keywordflow">if</span> (ThisPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01692 
01693             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( ThisPageBcb );
01694         }
01695 
01696         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"RestartPageAddress (Low)  -&gt; %08lx\n"</span>, RestartPageAddress-&gt;LowPart );
01697         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"RestartPageAddress (High) -&gt; %08lx\n"</span>, RestartPageAddress-&gt;HighPart );
01698         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"FirstRestartPage          -&gt; %08lx\n"</span>, *FirstRestartPage );
01699         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsReadRestart:  Exit\n"</span>, 0 );
01700     }
01701 
01702     <span class="keywordflow">return</span> FoundRestart;
01703 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="lfsprocs.h::LfsVerifyLogSpaceAvail" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LfsVerifyLogSpaceAvail           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d9/struct__LCH.html">PLCH</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lch</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingLogBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UndoRequirement</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ForceToDisk</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00114">114</a> of file <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html">lfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00036">LfsCurrentAvailSpace()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">LfsWriteLogRecordIntoLogPage()</a>.
<p>
<pre class="fragment"><div>00124                    :
00125 
00126     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to verify that we may write <span class="keyword">this</span> log record into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00127     log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  We want to always leave room <span class="keywordflow">for</span> each transaction to abort.
00128 
00129     We determine how much space <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current log record will take and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00130     worst <span class="keywordflow">case</span> <span class="keywordflow">for</span> its undo operation.  If <span class="keyword">this</span> space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available we
00131     update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding values in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb and Lch <span class="keywordflow">for</span> bookkeeping.
00132     Otherwise we raise a status indicating that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> full.
00133 
00134     The disk usage <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> different <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packed and unpacked cases.  Make <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00135     following adjustments after finding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> total available and amount still
00136     remaining on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last active page,
00137 
00138     Packed Case:
00139 
00140         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> needed <span class="keywordflow">for</span> log record <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> data size plus header size.
00141 
00142         Undo requirement <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo data size plus <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> header size.
00143             We have already taken into account <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages
00144             except <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current page.
00145 
00146         Add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record size to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo requirement to get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00147             log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> usage.  <a class="code" href="../../d9/d1/lboxctl2_8c.html#a38">Compare</a> <span class="keyword">this</span> number with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual available
00148             space (Available - CommittedUndo).  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00149             available, then raise LOG_FILE_FULL.  Must take into account
00150             any unused bytes at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current page.
00151 
00152     Unpacked Case:
00153 
00154         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> needed <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initially header size plus data size.
00155 
00156         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record can'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> begin on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current page then
00157             add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bytes being thrown away to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record size.
00158 
00159         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being forced to disk then add any remaining
00160             bytes on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last page.  To <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bytes being used.
00161 
00162         Undo requirement <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> twice <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sum of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> header size and
00163             undo size.  We <span class="keywordtype">double</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested size since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log
00164             record will always fit on a page.  This can be a
00165             positive or negative number.
00166 
00167         Add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record usage to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo usage to get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00168             usage.  <a class="code" href="../../d9/d1/lboxctl2_8c.html#a38">Compare</a> <span class="keyword">this</span> number with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual available
00169             space (Available - CommittedUndo).  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00170             available, then raise LOG_FILE_FULL.
00171 
00172 Arguments:
00173 
00174     Lfcb - Lfcb <span class="keywordflow">for</span> <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00175 
00176     Lch - Client handle
00177 
00178     RemainingLogBytes - Number of bytes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current log record
00179 
00180     UndoRequirement - User's requirement <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo record.
00181 
00182     ForceToDisk - Indicates <span class="keywordflow">if</span> <span class="keyword">this</span> log record will be flushed to disk.
00183 
00184 Return Value:
00185 
00186     BOOLEAN - Advisory, indicates that there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> less than 1/4 of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> available.
00187 
00188 --*/
00189 
00190 {
00191     ULONG CurrentLogRecordSize;
00192     ULONG LogRecordStart;
00193     ULONG TailBytes;
00194 
00195     LONGLONG CurrentAvailSpace;
00196     ULONG CurrentPageBytes;
00197 
00198     LONGLONG LogFileUsage;
00199 
00200     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00201 
00202     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsVerifyLogSpaceAvail:  Entered\n"</span>, 0 );
00203     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb              -&gt; %08x\n"</span>, Lfcb );
00204     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lch               -&gt; %08lx\n"</span>, Lch );
00205     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"RemainingLogBytes -&gt; %08lx\n"</span>, RemainingLogBytes );
00206     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"UndoRequirement   -&gt; %08lx\n"</span>, UndoRequirement );
00207     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"ForceToDisk       -&gt; %04x\n"</span>, ForceToDisk );
00208 
00209     <span class="comment">//</span>
00210     <span class="comment">//  Start by collecting the current data on the file.</span>
00211     <span class="comment">//</span>
00212 
00213     <a class="code" href="../../d7/d5/lfs_2verfysup_8c.html#a0">LfsCurrentAvailSpace</a>( Lfcb,
00214                           &amp;CurrentAvailSpace,
00215                           &amp;CurrentPageBytes );
00216 
00217     <span class="comment">//</span>
00218     <span class="comment">//  We compute the amount of space needed for the current log record by</span>
00219     <span class="comment">//  adding up the following:</span>
00220     <span class="comment">//</span>
00221     <span class="comment">//      Space at end of current log page which won't be used.</span>
00222     <span class="comment">//      Size of header for log record.</span>
00223     <span class="comment">//      Size of client data in log record.</span>
00224     <span class="comment">//      Size of wasted portion of log page if this is forced to disk.</span>
00225     <span class="comment">//</span>
00226 
00227     <span class="comment">//</span>
00228     <span class="comment">//  Start with the size of the header and the client data.</span>
00229     <span class="comment">//</span>
00230 
00231     CurrentLogRecordSize = RemainingLogBytes + Lfcb-&gt;RecordHeaderLength;
00232 
00233     <span class="comment">//</span>
00234     <span class="comment">//  If the log is packed and there are bytes on the current page we need</span>
00235     <span class="comment">//  to take into account any bytes at the end of the page which won't</span>
00236     <span class="comment">//  be used.  This will happen if the log record spills into the end of</span>
00237     <span class="comment">//  the log page but doesn't use up the page.  If the remaining bytes are</span>
00238     <span class="comment">//  less than a record header size we must throw them away.</span>
00239     <span class="comment">//</span>
00240 
00241     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )) {
00242 
00243         <span class="keywordflow">if</span> (CurrentPageBytes != 0
00244             &amp;&amp; CurrentLogRecordSize &lt; CurrentPageBytes
00245             &amp;&amp; (CurrentPageBytes - CurrentLogRecordSize) &lt; Lfcb-&gt;RecordHeaderLength) {
00246 
00247             CurrentLogRecordSize += (CurrentPageBytes - CurrentLogRecordSize);
00248         }
00249 
00250     <span class="comment">//</span>
00251     <span class="comment">//  If this is the unpacked case we need to check for bytes being thrown away</span>
00252     <span class="comment">//  on the current page or the last page.</span>
00253     <span class="comment">//</span>
00254 
00255     } <span class="keywordflow">else</span> {
00256 
00257         <span class="comment">//</span>
00258         <span class="comment">//  If there is an active Lbcb, we need to add any bytes that</span>
00259         <span class="comment">//  would be thrown away at the end.</span>
00260         <span class="comment">//</span>
00261 
00262         <span class="keywordflow">if</span> (CurrentPageBytes != 0) {
00263 
00264             <span class="comment">//</span>
00265             <span class="comment">//  We won't use this log page unless the new log record will fit or</span>
00266             <span class="comment">//  unless this is the first log record in the page.</span>
00267             <span class="comment">//</span>
00268 
00269             <span class="keywordflow">if</span> ((CurrentPageBytes != (ULONG)Lfcb-&gt;LogPageDataSize)
00270                 &amp;&amp; (CurrentLogRecordSize &gt; CurrentPageBytes)) {
00271 
00272                 CurrentLogRecordSize += CurrentPageBytes;
00273 
00274                 <span class="comment">//</span>
00275                 <span class="comment">//  Remember that we will start this log record at the first</span>
00276                 <span class="comment">//  byte in the data portion of a page.</span>
00277                 <span class="comment">//</span>
00278 
00279                 LogRecordStart = 0;
00280 
00281             <span class="comment">//</span>
00282             <span class="comment">//  Otherwise this will start at the current offset into the</span>
00283             <span class="comment">//  data portion of the log page.</span>
00284             <span class="comment">//</span>
00285 
00286             } <span class="keywordflow">else</span> {
00287 
00288                 LogRecordStart = (ULONG)Lfcb-&gt;LogPageDataSize - CurrentPageBytes;
00289             }
00290 
00291         <span class="comment">//</span>
00292         <span class="comment">//  If there was no Lbcb, then we know that we will start at the first</span>
00293         <span class="comment">//  byte of the data portion.</span>
00294         <span class="comment">//</span>
00295 
00296         } <span class="keywordflow">else</span> {
00297 
00298             LogRecordStart = 0;
00299         }
00300 
00301         <span class="comment">//</span>
00302         <span class="comment">//  We always assume that we will use up the rest of the bytes on the last page</span>
00303         <span class="comment">//  in computing whether the log record will fit in the available space.  We</span>
00304         <span class="comment">//  only subtract that space from the available space if this is a force write.</span>
00305         <span class="comment">//</span>
00306 
00307         <span class="keywordflow">if</span> (ForceToDisk) {
00308 
00309             <span class="comment">//</span>
00310             <span class="comment">//  We take into account where we start on a log page and continue</span>
00311             <span class="comment">//  to subtract log pages until we know the amount on the last</span>
00312             <span class="comment">//  page.</span>
00313             <span class="comment">//</span>
00314 
00315             TailBytes = RemainingLogBytes + Lfcb-&gt;RecordHeaderLength + LogRecordStart;
00316 
00317             <span class="keywordflow">while</span> (TailBytes &gt; (ULONG)Lfcb-&gt;LogPageDataSize) {
00318 
00319                 TailBytes -= (ULONG)Lfcb-&gt;LogPageDataSize;
00320             }
00321 
00322             TailBytes = (ULONG)Lfcb-&gt;LogPageDataSize - TailBytes;
00323 
00324             CurrentLogRecordSize += TailBytes;
00325         }
00326     }
00327 
00328     <span class="comment">//</span>
00329     <span class="comment">//  We now know the number of bytes needed for the current log page.</span>
00330     <span class="comment">//  Next we compute the number of bytes being reserved by UndoRequirement.</span>
00331     <span class="comment">//  If the UndoRequirement is positive, we will add to the amount reserved</span>
00332     <span class="comment">//  in the log file.  If it is negative, we will subtract from the amount</span>
00333     <span class="comment">//  reserved in the log file.</span>
00334     <span class="comment">//</span>
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">//  When we have an actual reserve amount, we convert it to positive</span>
00338     <span class="comment">//  and then reserve twice the space required to hold the data and</span>
00339     <span class="comment">//  its header (up to the maximum of a single page.</span>
00340     <span class="comment">//</span>
00341 
00342     <span class="keywordflow">if</span> (UndoRequirement != 0) {
00343 
00344         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )) {
00345 
00346             UndoRequirement *= 2;
00347         }
00348 
00349         <span class="keywordflow">if</span> (UndoRequirement &lt; 0) {
00350 
00351             UndoRequirement -= (2 * Lfcb-&gt;RecordHeaderLength);
00352         } <span class="keywordflow">else</span> {
00353 
00354             UndoRequirement += (2 * Lfcb-&gt;RecordHeaderLength);
00355         }
00356     }
00357 
00358     <span class="comment">//</span>
00359     <span class="comment">//  Now compute the net log file usage.  The result may be positive or</span>
00360     <span class="comment">//  negative.</span>
00361     <span class="comment">//</span>
00362 
00363     LogFileUsage = ((LONG) CurrentLogRecordSize)  + UndoRequirement;                                                   <span class="comment">//**** xxFromLong( ((LONG) CurrentLogRecordSize)  + UndoRequirement );</span>
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">//  The actual available space is the CurrentAvail minus the reserved</span>
00367     <span class="comment">//  undo value in the Lfcb.</span>
00368     <span class="comment">//</span>
00369 
00370     CurrentAvailSpace = CurrentAvailSpace - Lfcb-&gt;TotalUndoCommitment;                                                 <span class="comment">//**** xxSub( CurrentAvailSpace, Lfcb-&gt;TotalUndoCommitment );</span>
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">//  If this log file usage is greater than the available log file space</span>
00374     <span class="comment">//  then we raise a status code.</span>
00375     <span class="comment">//</span>
00376 
00377 <span class="preprocessor">#ifdef LFS_RAISE</span>
00378 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (LfsRaiseFull) {
00379 
00380         LfsRaiseFull = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00381         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsVerifyLogSpaceAvail:  About to raise\n"</span>, 0 );
00382         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_LOG_FILE_FULL );
00383     }
00384 <span class="preprocessor">#endif</span>
00385 <span class="preprocessor"></span>
00386     <span class="keywordflow">if</span> (LogFileUsage &gt; CurrentAvailSpace) {
00387 
00388         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsVerifyLogSpaceAvail:  About to raise\n"</span>, 0 );
00389         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_LOG_FILE_FULL );
00390     }
00391 
00392     Lfcb-&gt;TotalUndoCommitment = Lfcb-&gt;TotalUndoCommitment + UndoRequirement;                                           <span class="comment">//**** xxAdd( Lfcb-&gt;TotalUndoCommitment, xxFromLong( UndoRequirement ));</span>
00393 
00394     Lch-&gt;ClientUndoCommitment = Lch-&gt;ClientUndoCommitment + UndoRequirement;                                           <span class="comment">//**** xxAdd( Lch-&gt;ClientUndoCommitment, xxFromLong( UndoRequirement ));</span>
00395 
00396     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsVerifyLogSpaceAvail:  Exit\n"</span>, 0 );
00397 
00398     <span class="comment">//</span>
00399     <span class="comment">//  Now check if the log file is almost used up.</span>
00400     <span class="comment">//</span>
00401 
00402     <span class="keywordflow">if</span> ((CurrentAvailSpace - LogFileUsage) &lt; (Lfcb-&gt;TotalAvailable &gt;&gt; 2)) {
00403 
00404         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00405     }
00406 
00407     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00408 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="lfsprocs.h::LfsWriteLfsRestart" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsWriteLfsRestart           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ThisRestartSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitForIo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">36</a> of file <a class="el" href="../../d8/d9/rstrtsup_8c-source.html">rstrtsup.c</a>.
<p>
References <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00196">_LBCB::ActiveLinks</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00471">_LFS_RESTART_AREA::ClientArrayOffset</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00203">_LBCB::FileOffset</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00249">_LBCB::LastEndLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00242">_LBCB::LastLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00285">LBCB_NOT_EMPTY</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00284">LBCB_ON_ACTIVE_QUEUE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00287">LBCB_RESTART_LBCB</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00273">_LBCB::LbcbFlags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00204">_LBCB::Length</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00315">LfsAllocateLbcb()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00438">LfsAllocateRestartArea</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00037">LfsFlushLbcb()</a>, <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00228">_LBCB::PageHeader</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00195">_LBCB::WorkqueLinks</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03065">LfsInitializeLogFilePriv()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">LfsSetBaseLsn()</a>, <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>, and <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>.
<p>
<pre class="fragment"><div>00044                    :
00045 
00046     This routine puts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfs restart area on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue of operations to
00047     write to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  We <span class="keywordflow">do</span> <span class="keyword">this</span> by allocating a second restart area
00048     and attaching <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb.  We also allocate a buffer <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>
00049     block to use <span class="keywordflow">for</span> <span class="keyword">this</span> write.  We look at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> WaitForIo <span class="keywordtype">boolean</span> to
00050     determine whether <span class="keyword">this</span> thread can perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O.  This also indicates
00051     whether <span class="keyword">this</span> thread gives up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb.
00052 
00053 Arguments:
00054 
00055     Lfcb - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <span class="keyword">this</span> operation.
00056 
00057     ThisRestartSize - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size to use <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restart area.
00058 
00059     WaitForIo - Indicates <span class="keywordflow">if</span> <span class="keyword">this</span> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work.
00060 
00061 Return Value:
00062 
00063     None.
00064 
00065 --*/
00066 
00067 {
00068     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> NewLbcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00069     <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> NewRestart = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00070 
00071     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00072 
00073     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsWriteLfsRestart:  Entered\n"</span>, 0 );
00074     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb          -&gt; %08lx\n"</span>, Lfcb );
00075     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Write Chkdsk  -&gt; %04x\n"</span>, WriteChkdsk );
00076     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Restart Size  -&gt; %08lx\n"</span>, ThisRestartSize );
00077     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"WaitForIo     -&gt; %08lx\n"</span>, WaitForIo );
00078 
00079     <span class="comment">//</span>
00080     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00081     <span class="comment">//</span>
00082 
00083     <span class="keywordflow">try</span> {
00084 
00085         <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> ActiveLbcb;
00086 
00087         <span class="comment">//</span>
00088         <span class="comment">//  We allocate another restart area and</span>
00089         <span class="comment">//  copy the current area into it.  Attach the new area to the Lfcb.</span>
00090         <span class="comment">//</span>
00091 
00092         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a18">LfsAllocateRestartArea</a>( &amp;NewRestart, ThisRestartSize );
00093 
00094         <span class="comment">//</span>
00095         <span class="comment">//  We allocate a Lbcb structure and update the values to</span>
00096         <span class="comment">//  reflect this restart area.</span>
00097         <span class="comment">//</span>
00098 
00099         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a3">LfsAllocateLbcb</a>( Lfcb, &amp;NewLbcb );
00100         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_RESTART_LBCB );
00101 
00102         <span class="comment">//</span>
00103         <span class="comment">//  If this is the second page, then add a system page to the offset.</span>
00104         <span class="comment">//</span>
00105 
00106         <span class="keywordflow">if</span> (!Lfcb-&gt;InitialRestartArea) {
00107 
00108             NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a> = Lfcb-&gt;SystemPageSize + NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a>;
00109         }
00110 
00111         (ULONG)NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o5">Length</a> = ThisRestartSize;
00112 
00113         NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a> = (PVOID) Lfcb-&gt;RestartArea;
00114 
00115         <span class="comment">//</span>
00116         <span class="comment">//  Lets put the current lsn in the Lbcb.</span>
00117         <span class="comment">//</span>
00118 
00119         NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o11">LastEndLsn</a> = NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o10">LastLsn</a> = Lfcb-&gt;NextRestartLsn;
00120         Lfcb-&gt;NextRestartLsn.QuadPart = 1 + Lfcb-&gt;NextRestartLsn.QuadPart;
00121 
00122         <span class="comment">//</span>
00123         <span class="comment">//  Copy the existing restart area into the new area.</span>
00124         <span class="comment">//</span>
00125 
00126         RtlCopyMemory( NewRestart, Lfcb-&gt;RestartArea, ThisRestartSize );
00127         Lfcb-&gt;RestartArea = NewRestart;
00128 
00129         Lfcb-&gt;ClientArray = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NewRestart, Lfcb-&gt;ClientArrayOffset, <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00130 
00131         NewRestart = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00132 
00133         <span class="comment">//</span>
00134         <span class="comment">//  Update the Lfcb to indicate that the other restart area</span>
00135         <span class="comment">//  on the disk is to be used.</span>
00136         <span class="comment">//</span>
00137 
00138         Lfcb-&gt;InitialRestartArea = !Lfcb-&gt;InitialRestartArea;
00139 
00140         <span class="comment">//</span>
00141         <span class="comment">//  Add this Lbcb to the end of the workque and flush to that point.</span>
00142         <span class="comment">//</span>
00143 
00144         InsertTailList( &amp;Lfcb-&gt;LbcbWorkque, &amp;NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o2">WorkqueLinks</a> );
00145 
00146         <span class="comment">//</span>
00147         <span class="comment">//  If we don't support a packed log file then we need to make</span>
00148         <span class="comment">//  sure that all file records written out ahead of this</span>
00149         <span class="comment">//  restart area make it out to disk and we don't add anything</span>
00150         <span class="comment">//  to this page.</span>
00151         <span class="comment">//</span>
00152 
00153         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )
00154             &amp;&amp; !IsListEmpty( &amp;Lfcb-&gt;LbcbActive )) {
00155 
00156             ActiveLbcb = CONTAINING_RECORD( Lfcb-&gt;LbcbActive.Flink,
00157                                             <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00158                                             ActiveLinks );
00159 
00160             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ActiveLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_NOT_EMPTY )) {
00161 
00162                 RemoveEntryList( &amp;ActiveLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o3">ActiveLinks</a> );
00163                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( ActiveLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_ON_ACTIVE_QUEUE );
00164             }
00165         }
00166 
00167         <span class="keywordflow">if</span> (WaitForIo) {
00168 
00169             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a53">LfsFlushLbcb</a>( Lfcb, NewLbcb );
00170         }
00171 
00172     } finally {
00173 
00174         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsWriteLfsRestart );
00175 
00176         <span class="keywordflow">if</span> (NewRestart != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00177 
00178             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewRestart );
00179         }
00180 
00181         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsWriteLfsRestart:  Exit\n"</span>, 0 );
00182     }
00183 
00184     <span class="keywordflow">return</span>;
00185 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="lfsprocs.h::LfsWriteLogRecordIntoLogPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LfsWriteLogRecordIntoLogPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d9/struct__LCH.html">PLCH</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lch</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfWriteEntries</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteEntries</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a13">LFS_RECORD_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RecordType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *TransactionId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> ClientUndoNextLsn&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> ClientPreviousLsn&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UndoRequirement</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ForceToDisk</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">55</a> of file <a class="el" href="../../d8/d4/logrcsup_8c-source.html">logrcsup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00210">_LFS_WRITE_ENTRY::Buffer</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00219">_LBCB::BufferOffset</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00211">_LFS_WRITE_ENTRY::ByteLength</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00092">_LFS_RECORD_HEADER::ClientDataLength</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00100">_LFS_RECORD_HEADER::ClientId</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00081">_LFS_RECORD_HEADER::ClientPreviousLsn</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00082">_LFS_RECORD_HEADER::ClientUndoNextLsn</a>, <a class="el" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">_LFS_RECORD_PAGE_HEADER::Copy</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00120">_LFS_RECORD_HEADER::Flags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00261">_LBCB::Flags</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00230">_LFS_RECORD_PAGE_HEADER::Flags</a>, <a class="el" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">_LFS_RECORD_PAGE_HEADER::Header</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00249">_LBCB::LastEndLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00242">_LBCB::LastLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00285">LBCB_NOT_EMPTY</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00284">LBCB_ON_ACTIVE_QUEUE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00273">_LBCB::LbcbFlags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00601">LFCB_NO_LAST_LSN</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00509">LfsAcquireLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00291">LfsComputeLsnFromLbcb</a>, <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00431">LfsPrepareLfcbForLogRecord()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00556">LfsTransferLogBytes()</a>, <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00114">LfsVerifyLogSpaceAvail()</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00253">LOG_PAGE_LOG_RECORD_END</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00130">LOG_RECORD_MULTI_PAGE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00235">_LBCB::LogPageBcb</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00140">LSN</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00228">_LBCB::PageHeader</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00513">QuadAlign</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00107">_LFS_RECORD_HEADER::RecordType</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00073">_LFS_RECORD_HEADER::ThisLsn</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00114">_LFS_RECORD_HEADER::TransactionId</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00195">_LBCB::WorkqueLinks</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00197">LfsForceWrite()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00039">LfsWrite()</a>, and <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>.
<p>
<pre class="fragment"><div>00071                    :
00072 
00073     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to write a log record into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00074     <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache manager.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> room in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current log
00075     page <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> added to that.  Otherwise we allocate a <span class="keyword">new</span> log page
00076     and write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record header <span class="keywordflow">for</span> <span class="keyword">this</span> log page.  We then
00077     write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining bytes of <span class="keyword">this</span> page and
00078     into any subsequent pages <span class="keywordflow">if</span> needed.
00079 
00080 Arguments:
00081 
00082     Lfcb - <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00083 
00084     Lch - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client handle, we may update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo space <span class="keywordflow">for</span> <span class="keyword">this</span>
00085           client.
00086 
00087     NumberOfWriteEntries - Number of components of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record.
00088 
00089     WriteEntries - Pointer to an array of write entries.
00090 
00091     UndoRequirement - Signed value indicating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requirement to write
00092                       an abort log record <span class="keywordflow">for</span> <span class="keyword">this</span> log record.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> negative
00093                       value indicates that <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> abort record.
00094 
00095     RecordType - The Lfs-defined <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <span class="keyword">this</span> log record.
00096 
00097     TransactionId - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transaction structure containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00098                     Id <span class="keywordflow">for</span> transaction containing <span class="keyword">this</span> operation.
00099 
00100     ClientUndoNextLsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn provided by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client <span class="keywordflow">for</span> use
00101                         in his restart.  Will be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> zero Lsn <span class="keywordflow">for</span>
00102                         a restart log record.
00103 
00104     ClientPreviousLsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn provided by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client <span class="keywordflow">for</span> use
00105                         in his restart.  Will <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> zero Lsn <span class="keywordflow">for</span> a
00106                         restart log record.
00107 
00108     UndoRequirement - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data size <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo record <span class="keywordflow">for</span>
00109                       <span class="keyword">this</span> log record.
00110 
00111     ForceToDisk - Indicates <span class="keywordflow">if</span> <span class="keyword">this</span> log record will be flushed immediately
00112                   to disk.
00113 
00114     Lsn - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn <span class="keywordflow">for</span> <span class="keyword">this</span> log record.
00115 
00116 Return Value:
00117 
00118     BOOLEAN - Advisory, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates that less than 1/4 of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00119         available.
00120 
00121 --*/
00122 
00123 {
00124     <a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a> ThisWriteEntry;
00125 
00126     ULONG RemainingLogBytes;
00127     ULONG OriginalLogBytes;
00128 
00129     ULONG RemainingPageBytes;
00130     ULONG HeaderAdjust;
00131 
00132     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> ThisLbcb;
00133 
00134     <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> NextLsn;
00135 
00136     <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> RecordHeader;
00137 
00138     PCHAR CurrentBuffer;
00139     ULONG CurrentByteCount;
00140     ULONG PadBytes;
00141 
00142     BOOLEAN LogFileFull = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00143 
00144     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00145 
00146     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsWriteLogRecordIntoLogPage:  Entered\n"</span>, 0 );
00147     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb                      -&gt; %08lx\n"</span>, Lfcb );
00148     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lch                       -&gt; %08lx\n"</span>, Lch );
00149     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Number of Write Entries   -&gt; %08lx\n"</span>, NumberOfWriteEntries );
00150     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Write Entries             -&gt; %08lx\n"</span>, WriteEntries );
00151     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Record Type               -&gt; %08lx\n"</span>, RecordType );
00152     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Transaction Id            -&gt; %08lx\n"</span>, TransactionId );
00153     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"ClientUndoNextLsn (Low)   -&gt; %08lx\n"</span>, ClientUndoNextLsn.LowPart );
00154     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"ClientUndoNextLsn (High)  -&gt; %08lx\n"</span>, ClientUndoNextLsn.HighPart );
00155     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"ClientPreviousLsn (Low)   -&gt; %08lx\n"</span>, ClientPreviousLsn.LowPart );
00156     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"ClientPreviousLsn (High)  -&gt; %08lx\n"</span>, ClientPreviousLsn.HighPart );
00157     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"UndoRequirement           -&gt; %08lx\n"</span>, UndoRequirement );
00158     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"ForceToDisk               -&gt; %04x\n"</span>, ForceToDisk );
00159 
00160     <span class="comment">//</span>
00161     <span class="comment">//  We compute the size of this log record.</span>
00162     <span class="comment">//</span>
00163 
00164     ThisWriteEntry = WriteEntries;
00165 
00166     RemainingLogBytes = 0;
00167 
00168     <span class="keywordflow">while</span> (NumberOfWriteEntries--) {
00169 
00170         RemainingLogBytes += <a class="code" href="../../d5/d5/cc_8h.html#a62">QuadAlign</a>( ThisWriteEntry-&gt;<a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html#o1">ByteLength</a> );
00171 
00172         ThisWriteEntry++;
00173     }
00174 
00175     OriginalLogBytes = RemainingLogBytes;
00176 
00177     ThisWriteEntry = WriteEntries;
00178 
00179     <span class="comment">//</span>
00180     <span class="comment">//  Loop until we have the Lbcb and we know it is not part of</span>
00181     <span class="comment">//  a partial page transfer.  We need to make sure we have</span>
00182     <span class="comment">//  a Bcb for this page.</span>
00183     <span class="comment">//</span>
00184 
00185     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00186 
00187         LogFileFull = <a class="code" href="../../d7/d5/lfs_2verfysup_8c.html#a1">LfsVerifyLogSpaceAvail</a>( Lfcb,
00188                                               Lch,
00189                                               RemainingLogBytes,
00190                                               UndoRequirement,
00191                                               ForceToDisk );
00192 
00193         <span class="comment">//</span>
00194         <span class="comment">//  We update the Lfcb so that we can start putting the log record into</span>
00195         <span class="comment">//  the top of the Lbcb active list.</span>
00196         <span class="comment">//</span>
00197 
00198         <a class="code" href="../../d7/d5/logrcsup_8c.html#a1">LfsPrepareLfcbForLogRecord</a>( Lfcb,
00199                                     RemainingLogBytes + Lfcb-&gt;RecordHeaderLength );
00200 
00201         ThisLbcb = CONTAINING_RECORD( Lfcb-&gt;LbcbActive.Flink,
00202                                       <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00203                                       ActiveLinks );
00204 
00205         <span class="comment">//</span>
00206         <span class="comment">//  If there is a Bcb then we are golden.</span>
00207         <span class="comment">//</span>
00208 
00209         <span class="keywordflow">if</span> (ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o9">LogPageBcb</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) { <span class="keywordflow">break</span>; }
00210 
00211         <span class="comment">//</span>
00212         <span class="comment">//  Otherwise we want to drop the Lfcb and wait for the IO to complete.</span>
00213         <span class="comment">//</span>
00214 
00215         Lfcb-&gt;Waiters += 1;
00216 
00217         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
00218 
00219         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Lfcb-&gt;Sync-&gt;Event,
00220                                Executive,
00221                                KernelMode,
00222                                FALSE,
00223                                NULL );
00224 
00225         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
00226         Lfcb-&gt;Waiters -= 1;
00227     }
00228 
00229     RemainingPageBytes = (ULONG)Lfcb-&gt;LogPageSize - (ULONG)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a>;
00230 
00231     <span class="comment">//</span>
00232     <span class="comment">//  Compute the Lsn starting in the next log buffer.</span>
00233     <span class="comment">//</span>
00234 
00235     NextLsn.QuadPart = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a10">LfsComputeLsnFromLbcb</a>( Lfcb, ThisLbcb );
00236 
00237     <span class="comment">//</span>
00238     <span class="comment">//  We get a pointer to the log record header and the start of the</span>
00239     <span class="comment">//  log record in the pinned buffer.</span>
00240     <span class="comment">//</span>
00241 
00242     RecordHeader = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>,
00243                             (ULONG)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a>,
00244                             <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> );
00245 
00246     <span class="comment">//</span>
00247     <span class="comment">//  We update the record header.</span>
00248     <span class="comment">//</span>
00249 
00250     <span class="comment">//</span>
00251     <span class="comment">//  Zero out the structure initially.</span>
00252     <span class="comment">//</span>
00253 
00254     RtlZeroMemory( RecordHeader, Lfcb-&gt;RecordHeaderLength );
00255 
00256     <span class="comment">//</span>
00257     <span class="comment">//  Update all the fields.</span>
00258     <span class="comment">//</span>
00259 
00260     RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o0">ThisLsn</a> = NextLsn;
00261     RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o1">ClientPreviousLsn</a> = ClientPreviousLsn;
00262     RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o2">ClientUndoNextLsn</a> = ClientUndoNextLsn;
00263 
00264     <span class="keywordflow">if</span> (TransactionId != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00265         RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o6">TransactionId</a> = *TransactionId;
00266     }
00267 
00268     RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o3">ClientDataLength</a> = RemainingLogBytes;
00269     RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o4">ClientId</a> = Lch-&gt;ClientId;
00270     RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o5">RecordType</a> = RecordType;
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">//  Check if this is a multi-page record.</span>
00274     <span class="comment">//</span>
00275 
00276     <span class="keywordflow">if</span> (RemainingLogBytes + Lfcb-&gt;RecordHeaderLength &gt; RemainingPageBytes) {
00277 
00278         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o7">Flags</a>, LOG_RECORD_MULTI_PAGE );
00279     }
00280 
00281     RemainingPageBytes -= Lfcb-&gt;RecordHeaderLength;
00282 
00283     <span class="comment">//</span>
00284     <span class="comment">//  Update the buffer position in the Lbcb</span>
00285     <span class="comment">//</span>
00286 
00287     (ULONG)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a> += Lfcb-&gt;RecordHeaderLength;
00288     HeaderAdjust = Lfcb-&gt;RecordHeaderLength;
00289 
00290     <span class="comment">//</span>
00291     <span class="comment">//  Remember the values in the current write entry.</span>
00292     <span class="comment">//</span>
00293 
00294     CurrentBuffer = ThisWriteEntry-&gt;<a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html#o0">Buffer</a>;
00295     CurrentByteCount = ThisWriteEntry-&gt;<a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html#o1">ByteLength</a>;
00296 
00297     PadBytes = (8 - (CurrentByteCount &amp; ~(0xfffffff8))) &amp; ~(0xfffffff8);
00298 
00299     <span class="comment">//</span>
00300     <span class="comment">//  Continue to transfer bytes until all the client's data has</span>
00301     <span class="comment">//  been transferred.</span>
00302     <span class="comment">//</span>
00303 
00304     <span class="keywordflow">while</span> (RemainingLogBytes != 0) {
00305 
00306         <a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a> PageHeader;
00307 
00308         PageHeader = (<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a>) ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>;
00309 
00310         <span class="comment">//</span>
00311         <span class="comment">//  If the Lbcb is empty and we are about to store data into it we</span>
00312         <span class="comment">//  subtract the data size of the page from the available space.</span>
00313         <span class="comment">//  Update all the information we want to put in the header.</span>
00314         <span class="comment">//</span>
00315 
00316         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_NOT_EMPTY )) {
00317 
00318             <span class="comment">//</span>
00319             <span class="comment">//  We subtract this page from the available pages only if</span>
00320             <span class="comment">//  we are at the beginning of the page.  Otherwise this</span>
00321             <span class="comment">//  could be a reuse page.  In that case it has already</span>
00322             <span class="comment">//  been subtracted.</span>
00323             <span class="comment">//</span>
00324 
00325             <span class="keywordflow">if</span> ((ULONG)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a> - HeaderAdjust == (ULONG)Lfcb-&gt;LogPageDataOffset) {
00326 
00327 
00328                 Lfcb-&gt;CurrentAvailable = Lfcb-&gt;CurrentAvailable - Lfcb-&gt;ReservedLogPageSize;                           <span class="comment">//**** xxSub( Lfcb-&gt;CurrentAvailable, Lfcb-&gt;ReservedLogPageSize );</span>
00329             }
00330 
00331             InsertTailList( &amp;Lfcb-&gt;LbcbWorkque, &amp;ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o2">WorkqueLinks</a> );
00332             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_NOT_EMPTY );
00333         }
00334 
00335         HeaderAdjust = 0;
00336 
00337         <span class="comment">//</span>
00338         <span class="comment">//  Compute the number of transfer bytes.  Update the remaining</span>
00339         <span class="comment">//  page bytes, remaining log bytes and position in the write</span>
00340         <span class="comment">//  buffer array.  This routine also copies the bytes into the buffer.</span>
00341         <span class="comment">//</span>
00342 
00343         <a class="code" href="../../d7/d5/logrcsup_8c.html#a2">LfsTransferLogBytes</a>( ThisLbcb,
00344                              &amp;ThisWriteEntry,
00345                              &amp;CurrentBuffer,
00346                              &amp;CurrentByteCount,
00347                              &amp;PadBytes,
00348                              &amp;RemainingPageBytes,
00349                              &amp;RemainingLogBytes );
00350 
00351         <span class="comment">//</span>
00352         <span class="comment">//  This log record ends on this page.  Update the fields for the</span>
00353         <span class="comment">//  ending Lsn.</span>
00354         <span class="comment">//</span>
00355 
00356         <span class="keywordflow">if</span> (RemainingLogBytes == 0) {
00357 
00358             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o12">Flags</a>, LOG_PAGE_LOG_RECORD_END );
00359             ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o11">LastEndLsn</a> = NextLsn;
00360 
00361             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )) {
00362 
00363                 PageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.LastEndLsn = NextLsn;
00364                 PageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.NextRecordOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a>;
00365             }
00366         }
00367 
00368         <span class="comment">//</span>
00369         <span class="comment">//  We are done with this page, update the fields in the page header.</span>
00370         <span class="comment">//</span>
00371 
00372         <span class="keywordflow">if</span> (RemainingPageBytes == 0
00373             || RemainingLogBytes == 0) {
00374 
00375             <span class="comment">//</span>
00376             <span class="comment">//  We are done with this page.  Update the Lbcb and page header.</span>
00377             <span class="comment">//</span>
00378 
00379             ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o10">LastLsn</a> = NextLsn;
00380             PageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.LastLsn = NextLsn;
00381             PageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o4">Flags</a> = ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o12">Flags</a>;
00382 
00383             <span class="comment">//</span>
00384             <span class="comment">//  We can't put any more log records on this page.  Remove</span>
00385             <span class="comment">//  it from the active queue.</span>
00386             <span class="comment">//</span>
00387 
00388             <span class="keywordflow">if</span> (RemainingPageBytes &lt; Lfcb-&gt;RecordHeaderLength) {
00389 
00390                 RemoveHeadList( &amp;Lfcb-&gt;LbcbActive );
00391                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_ON_ACTIVE_QUEUE );
00392 
00393                 <span class="comment">//</span>
00394                 <span class="comment">//  If there are more log bytes then get the next Lbcb.</span>
00395                 <span class="comment">//</span>
00396 
00397                 <span class="keywordflow">if</span> (RemainingLogBytes != 0) {
00398 
00399                     ThisLbcb = CONTAINING_RECORD( Lfcb-&gt;LbcbActive.Flink,
00400                                                   <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00401                                                   ActiveLinks );
00402 
00403                     RemainingPageBytes = (ULONG)Lfcb-&gt;LogPageSize
00404                                          - (ULONG)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a>;
00405                 }
00406             }
00407         }
00408     }
00409 
00410     *Lsn = NextLsn;
00411 
00412     Lfcb-&gt;RestartArea-&gt;CurrentLsn = NextLsn;
00413 
00414     Lfcb-&gt;RestartArea-&gt;LastLsnDataLength = OriginalLogBytes;
00415 
00416     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Lfcb-&gt;Flags, LFCB_NO_LAST_LSN );
00417 
00418     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)   -&gt; %08lx\n"</span>, Lsn-&gt;LowPart );
00419     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (High)  -&gt; %08lx\n"</span>, Lsn-&gt;HighPart );
00420     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsWriteLogRecordIntoLogPage:  Exit\n"</span>, 0 );
00421 
00422     <span class="keywordflow">return</span> LogFileFull;
00423 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:32 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
