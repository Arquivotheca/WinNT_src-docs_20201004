<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ex/handle.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>handle.c File Reference</h1><code>#include "<a class="el" href="../../d5/d9/exp_8h-source.html">exp.h</a>"</code><br>

<p>
<a href="../../d1/d7/ex_2handle_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a0">EXHANDLE_TABLE_ENTRY_LOCK_BIT</a>&nbsp;&nbsp;&nbsp;((ULONG_PTR)1 &lt;&lt; ((sizeof(ULONG_PTR) * 8) - 1))</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a4">ExpAllocateHandleTable</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a5">ExpFreeHandleTable</a> (IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a6">ExpAllocateHandleTableEntry</a> (IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable, OUT <a class="el" href="../../d7/d8/struct__EXHANDLE.html">PEXHANDLE</a> <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a7">ExpFreeHandleTableEntry</a> (IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable, IN <a class="el" href="../../d7/d8/struct__EXHANDLE.html">EXHANDLE</a> <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> HandleTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a8">ExpLookupHandleTableEntry</a> (IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable, IN <a class="el" href="../../d7/d8/struct__EXHANDLE.html">EXHANDLE</a> <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a9">ExLockHandleTableShared</a> (<a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a10">ExLockHandleTableExclusive</a> (<a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a11">ExUnlockHandleTableShared</a> (<a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a12">ExUnlockHandleTableExclusive</a> (<a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a13">ExLockHandleTableEntry</a> (<a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable, <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> HandleTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a14">ExUnlockHandleTableEntry</a> (<a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable, <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> HandleTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a15">ExInitializeHandleTablePackage</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a16">ExCreateHandleTable</a> (IN struct <a class="el" href="../../d0/d4/struct__EPROCESS.html">_EPROCESS</a> *Process OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a17">ExRemoveHandleTable</a> (IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a18">ExDestroyHandleTable</a> (IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable, IN <a class="el" href="../../d5/d8/ex_8h.html#a139">EX_DESTROY_HANDLE_ROUTINE</a> DestroyHandleProcedure OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a19">ExEnumHandleTable</a> (IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable, IN <a class="el" href="../../d5/d8/ex_8h.html#a140">EX_ENUMERATE_HANDLE_ROUTINE</a> EnumHandleProcedure, IN PVOID EnumParameter, OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a20">ExDupHandleTable</a> (IN struct <a class="el" href="../../d0/d4/struct__EPROCESS.html">_EPROCESS</a> *Process OPTIONAL, IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> OldHandleTable, IN <a class="el" href="../../d5/d8/ex_8h.html#a141">EX_DUPLICATE_HANDLE_ROUTINE</a> DupHandleProcedure OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a21">ExSnapShotHandleTables</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a142">PEX_SNAPSHOT_HANDLE_ENTRY</a> SnapShotHandleEntry, IN OUT PSYSTEM_HANDLE_INFORMATION HandleInformation, IN ULONG Length, IN OUT PULONG RequiredLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a22">ExCreateHandle</a> (IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable, IN <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> HandleTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a23">ExDestroyHandle</a> (IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable, IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> HandleTableEntry OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a24">ExChangeHandle</a> (IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable, IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN <a class="el" href="../../d5/d8/ex_8h.html#a143">PEX_CHANGE_HANDLE_ROUTINE</a> ChangeRoutine, IN ULONG_PTR Parameter)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a25">ExMapHandleToPointer</a> (IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable, IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a1">HandleTableListLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a2">HandleTableListHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LARGE_INTEGER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2handle_8c.html#a3">Ex10Milliseconds</a> = {(ULONG)(-10 * 1000 * 10), -1}</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="ex/handle.c::EXHANDLE_TABLE_ENTRY_LOCK_BIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define EXHANDLE_TABLE_ENTRY_LOCK_BIT&nbsp;&nbsp;&nbsp;((ULONG_PTR)1 &lt;&lt; ((sizeof(ULONG_PTR) * 8) - 1))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00044">44</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00240">ExLockHandleTableEntry()</a>, and <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00336">ExUnlockHandleTableEntry()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a24" doxytag="ex/handle.c::ExChangeHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN ExChangeHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a143">PEX_CHANGE_HANDLE_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ChangeRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01315">1315</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00240">ExLockHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l02195">ExpLookupHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00336">ExUnlockHandleTableEntry()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02630">_EXHANDLE::GenericHandleOverlay</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/obquery_8c-source.html#l00545">NtSetInformationObject()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.
<p>
<pre class="fragment"><div>01324                    :
01325 
01326     This function provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> capability to change <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01327     handle entry corrsponding to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle.
01328 
01329 Arguments:
01330 
01331     HandleTable - Supplies a pointer to a handle table.
01332 
01333     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle entry that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> changed.
01334 
01335     ChangeRoutine - Supplies a pointer to a function that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to
01336         perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> change.
01337 
01338     Parameter - Supplies an uninterpreted parameter that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed to
01339         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> change routine.
01340 
01341 Return Value:
01342 
01343     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was successfully performed, then a value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01344     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned. Otherwise, a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01345 
01346 --*/
01347 
01348 {
01349     <a class="code" href="../../d7/d8/struct__EXHANDLE.html">EXHANDLE</a> LocalHandle;
01350 
01351     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> HandleTableEntry;
01352     BOOLEAN ReturnValue;
01353 
01354     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01355 
01356     LocalHandle.<a class="code" href="../../d7/d8/struct__EXHANDLE.html#o2">GenericHandleOverlay</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01357 
01358     <span class="comment">//</span>
01359     <span class="comment">//  Translate the input handle to a handle table entry and make</span>
01360     <span class="comment">//  sure it is a valid handle.</span>
01361     <span class="comment">//</span>
01362 
01363     HandleTableEntry = <a class="code" href="../../d0/d8/ex_2handle_8c.html#a8">ExpLookupHandleTableEntry</a>( HandleTable,
01364                                                   LocalHandle );
01365 
01366     <span class="keywordflow">if</span> (HandleTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01367 
01368         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01369     }
01370 
01371     <span class="comment">//</span>
01372     <span class="comment">//  Try and lock the handle table entry,  If this fails then that's</span>
01373     <span class="comment">//  because someone freed the handle</span>
01374     <span class="comment">//</span>
01375 
01376     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a287">ExLockHandleTableEntry</a>( HandleTable, HandleTableEntry )) {
01377 
01378         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01379     }
01380 
01381     <span class="comment">//</span>
01382     <span class="comment">//  Make sure we can't get suspended and then invoke the callback</span>
01383     <span class="comment">//</span>
01384 
01385     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01386 
01387     <span class="keywordflow">try</span> {
01388 
01389         ReturnValue = (*ChangeRoutine)( HandleTableEntry, Parameter );
01390 
01391     } finally {
01392 
01393         <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( HandleTable, HandleTableEntry );
01394         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01395     }
01396 
01397     <span class="keywordflow">return</span> ReturnValue;
01398 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="ex/handle.c::ExCreateHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI HANDLE ExCreateHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTableEntry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01144">1144</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00146">ExLockHandleTableExclusive()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01825">ExpAllocateHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00336">ExUnlockHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00209">ExUnlockHandleTableExclusive()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/tex_8c-source.html#l01160">DoHandleTest()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, and <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00187">RtlpCreateHandleForAtom()</a>.
<p>
<pre class="fragment"><div>01151                    :
01152 
01153     This function creates a handle entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle table and
01154     returns a handle <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry.
01155 
01156 Arguments:
01157 
01158     HandleTable - Supplies a pointer to a handle table
01159 
01160     HandleEntry - Supplies a poiner to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle entry <span class="keywordflow">for</span> which a
01161         handle entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created.
01162 
01163 Return Value:
01164 
01165     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successfully created, then value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created
01166     handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value.  Otherwise, a value of zero <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01167     returned.
01168 
01169 --*/
01170 
01171 {
01172     <a class="code" href="../../d7/d8/struct__EXHANDLE.html">EXHANDLE</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01173     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> NewHandleTableEntry;
01174 
01175     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01176 
01177     <span class="comment">//</span>
01178     <span class="comment">//  Set out output variable to zero (i.e., null) before going on</span>
01179     <span class="comment">//</span>
01180 
01181     <span class="comment">//</span>
01182     <span class="comment">// Clears Handle.Index and Handle.TagBits</span>
01183     <span class="comment">//</span>
01184 
01185     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.GenericHandleOverlay = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01186 
01187     <span class="comment">//</span>
01188     <span class="comment">//  Lock the handle table for exclusive access</span>
01189     <span class="comment">//</span>
01190 
01191     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01192     <a class="code" href="../../d5/d8/ex_8h.html#a284">ExLockHandleTableExclusive</a>( HandleTable );
01193 
01194     <span class="keywordflow">try</span> {
01195 
01196         <span class="comment">//</span>
01197         <span class="comment">//  Allocate a new handle table entry, and get the handle value</span>
01198         <span class="comment">//</span>
01199 
01200         NewHandleTableEntry = <a class="code" href="../../d0/d8/ex_2handle_8c.html#a6">ExpAllocateHandleTableEntry</a>( HandleTable,
01201                                                            &amp;Handle );
01202 
01203         <span class="comment">//</span>
01204         <span class="comment">//  If we really got a handle then copy over the template and unlock</span>
01205         <span class="comment">//  the entry</span>
01206         <span class="comment">//</span>
01207 
01208         <span class="keywordflow">if</span> (NewHandleTableEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01209 
01210             *NewHandleTableEntry = *HandleTableEntry;
01211 
01212             <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( HandleTable, NewHandleTableEntry );
01213         }
01214 
01215     } finally {
01216 
01217         <a class="code" href="../../d5/d8/ex_8h.html#a286">ExUnlockHandleTableExclusive</a>( HandleTable );
01218         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01219     }
01220 
01221     <span class="keywordflow">return</span> <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.GenericHandleOverlay;
01222 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="ex/handle.c::ExCreateHandleTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> ExCreateHandleTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN struct <a class="el" href="../../d0/d4/struct__EPROCESS.html">_EPROCESS</a> *Process&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>OPTIONAL</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00457">457</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01475">ExpAllocateHandleTable()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/tex_8c-source.html#l01160">DoHandleTest()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00815">ObInitProcess()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>, and <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00112">RtlpInitializeHandleTableForAtomTable()</a>.
<p>
<pre class="fragment"><div>00463                    :
00464 
00465     This function allocate and initialize a <span class="keyword">new</span> <span class="keyword">new</span> handle table
00466 
00467 Arguments:
00468 
00469     Process - Supplies an optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process against which quota
00470         will be charged.
00471 
00472 Return Value:
00473 
00474     If a handle table <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successfully created, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00475     handle table <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value. Otherwize, a value
00476     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00477 
00478 --*/
00479 
00480 {
00481     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable;
00482 
00483     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00484 
00485     <span class="comment">//</span>
00486     <span class="comment">//  Allocate and initialize a handle table descriptor</span>
00487     <span class="comment">//</span>
00488 
00489     HandleTable = <a class="code" href="../../d0/d8/ex_2handle_8c.html#a4">ExpAllocateHandleTable</a>( Process );
00490 
00491     <span class="comment">//</span>
00492     <span class="comment">//  And return to our caller</span>
00493     <span class="comment">//</span>
00494 
00495     <span class="keywordflow">return</span> HandleTable;
00496 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="ex/handle.c::ExDestroyHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN ExDestroyHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> HandleTableEntry&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01227">1227</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00240">ExLockHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00146">ExLockHandleTableExclusive()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l02127">ExpFreeHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l02195">ExpLookupHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00209">ExUnlockHandleTableExclusive()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02630">_EXHANDLE::GenericHandleOverlay</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/tex_8c-source.html#l01160">DoHandleTest()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01438">PspThreadDelete()</a>, and <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00228">RtlpFreeHandleForAtom()</a>.
<p>
<pre class="fragment"><div>01235                    :
01236 
01237     This function removes a handle from a handle table.
01238 
01239 Arguments:
01240 
01241     HandleTable - Supplies a pointer to a handle table
01242 
01243     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry to remove.
01244 
01245     HandleTableEntry - Optionally supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle
01246         table entry being destroyed.  If supplied <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01247         assume to be locked.
01248 
01249 Return Value:
01250 
01251     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successfully removed, then a value of
01252     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned. Otherwise, a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01253 
01254 --*/
01255 
01256 {
01257     <a class="code" href="../../d7/d8/struct__EXHANDLE.html">EXHANDLE</a> LocalHandle;
01258 
01259     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01260 
01261     LocalHandle.<a class="code" href="../../d7/d8/struct__EXHANDLE.html#o2">GenericHandleOverlay</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01262 
01263     <span class="comment">//</span>
01264     <span class="comment">//  If the caller did not supply the optional handle table entry then</span>
01265     <span class="comment">//  locate the entry via the supplied handle, make sure it is real, and</span>
01266     <span class="comment">//  then lock the entry.</span>
01267     <span class="comment">//</span>
01268 
01269     <span class="keywordflow">if</span> (HandleTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01270 
01271         HandleTableEntry = <a class="code" href="../../d0/d8/ex_2handle_8c.html#a8">ExpLookupHandleTableEntry</a>( HandleTable,
01272                                                       LocalHandle );
01273 
01274         <span class="keywordflow">if</span> (HandleTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01275 
01276             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01277         }
01278 
01279         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a287">ExLockHandleTableEntry</a>( HandleTable, HandleTableEntry )) {
01280 
01281             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01282         }
01283     }
01284 
01285     <span class="comment">//</span>
01286     <span class="comment">//  At this point we have a locked handle table entry.  Now mark it free</span>
01287     <span class="comment">//  which does the implicit unlock.  The system will not allocate it</span>
01288     <span class="comment">//  again until we add it to the free list which we will do right after</span>
01289     <span class="comment">//  we take out the lock</span>
01290     <span class="comment">//</span>
01291 
01292     HandleTableEntry-&gt;Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01293 
01294     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01295     <a class="code" href="../../d5/d8/ex_8h.html#a284">ExLockHandleTableExclusive</a>( HandleTable );
01296 
01297     <span class="keywordflow">try</span> {
01298 
01299         <a class="code" href="../../d0/d8/ex_2handle_8c.html#a7">ExpFreeHandleTableEntry</a>( HandleTable,
01300                                  LocalHandle,
01301                                  HandleTableEntry );
01302 
01303     } finally {
01304 
01305         <a class="code" href="../../d5/d8/ex_8h.html#a286">ExUnlockHandleTableExclusive</a>( HandleTable );
01306         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01307     }
01308 
01309     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01310 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="ex/handle.c::ExDestroyHandleTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID ExDestroyHandleTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a139">EX_DESTROY_HANDLE_ROUTINE</a> DestroyHandleProcedure&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00560">560</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01667">ExpFreeHandleTable()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l02195">ExpLookupHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00501">ExRemoveHandleTable()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/tex_8c-source.html#l01160">DoHandleTest()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01022">ObKillProcess()</a>, and <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00139">RtlpDestroyHandleTableForAtomTable()</a>.
<p>
<pre class="fragment"><div>00567                    :
00568 
00569     This function destroys <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle table.
00570 
00571 Arguments:
00572 
00573     HandleTable - Supplies a pointer to a handle table
00574 
00575     DestroyHandleProcedure - Supplies a pointer to a function to call <span class="keywordflow">for</span> each
00576         valid handle entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table.
00577 
00578 Return Value:
00579 
00580     None.
00581 
00582 --*/
00583 
00584 {
00585     <a class="code" href="../../d7/d8/struct__EXHANDLE.html">EXHANDLE</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00586     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> HandleTableEntry;
00587 
00588     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00589 
00590     <span class="comment">//</span>
00591     <span class="comment">//  Remove the handle table from the handle table list</span>
00592     <span class="comment">//</span>
00593 
00594     <a class="code" href="../../d5/d8/ex_8h.html#a291">ExRemoveHandleTable</a>( HandleTable );
00595 
00596     <span class="comment">//</span>
00597     <span class="comment">//  Iterate through the handle table and for each handle that is allocated</span>
00598     <span class="comment">//  we'll invoke the call back.  Note that this loop exits when we get a</span>
00599     <span class="comment">//  null handle table entry.  We know there will be no more possible</span>
00600     <span class="comment">//  entries after the first null one is encountered because we allocate</span>
00601     <span class="comment">//  memory of the handles in a dense fashion.  But first test that we have</span>
00602     <span class="comment">//  call back to use</span>
00603     <span class="comment">//</span>
00604 
00605     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DestroyHandleProcedure)) {
00606 
00607         <span class="keywordflow">for</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.GenericHandleOverlay = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; <span class="comment">// does essentially the following "Handle.Index = 0, Handle.TagBits = 0;"</span>
00608              (HandleTableEntry = <a class="code" href="../../d0/d8/ex_2handle_8c.html#a8">ExpLookupHandleTableEntry</a>( HandleTable, Handle )) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00609              <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.Index += 1) {
00610 
00611             <span class="comment">//</span>
00612             <span class="comment">//  Only do the callback if the entry is not free</span>
00613             <span class="comment">//</span>
00614 
00615             <span class="keywordflow">if</span> (HandleTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00616 
00617                 (*DestroyHandleProcedure)( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.GenericHandleOverlay );
00618             }
00619         }
00620     }
00621 
00622     <span class="comment">//</span>
00623     <span class="comment">//  Now free up the handle table memory and return to our caller</span>
00624     <span class="comment">//</span>
00625 
00626     <a class="code" href="../../d0/d8/ex_2handle_8c.html#a5">ExpFreeHandleTable</a>( HandleTable );
00627 
00628     <span class="keywordflow">return</span>;
00629 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="ex/handle.c::ExDupHandleTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> ExDupHandleTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN struct <a class="el" href="../../d0/d4/struct__EPROCESS.html">_EPROCESS</a> *Process&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OldHandleTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a141">EX_DUPLICATE_HANDLE_ROUTINE</a> DupHandleProcedure&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00765">765</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00240">ExLockHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00114">ExLockHandleTableShared()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01475">ExpAllocateHandleTable()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01825">ExpAllocateHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01667">ExpFreeHandleTable()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l02127">ExpFreeHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l02195">ExpLookupHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00336">ExUnlockHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00178">ExUnlockHandleTableShared()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02746">_HANDLE_TABLE::FirstFreeTableEntry</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02723">_HANDLE_TABLE::HandleCount</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02699">_HANDLE_TABLE_ENTRY::NextFreeTableEntry</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02747">_HANDLE_TABLE::NextIndexNeedingPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/tex_8c-source.html#l01160">DoHandleTest()</a>, and <a class="el" href="../../d1/d0/obinit_8c-source.html#l00815">ObInitProcess()</a>.
<p>
<pre class="fragment"><div>00773                    :
00774 
00775     This function creates a duplicate copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle table.
00776 
00777 Arguments:
00778 
00779     Process - Supplies an optional to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to charge quota to.
00780 
00781     OldHandleTable - Supplies a pointer to a handle table.
00782 
00783     DupHandleProcedure - Supplies an optional pointer to a function to call
00784         <span class="keywordflow">for</span> each valid handle in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duplicated handle table.
00785 
00786 Return Value:
00787 
00788     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle table <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successfully duplicated, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00789     address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> handle table <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value.
00790     Otherwize, a value <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00791 
00792 --*/
00793 
00794 {
00795     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> NewHandleTable;
00796 
00797     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> AdditionalFreeEntries;
00798 
00799     <a class="code" href="../../d7/d8/struct__EXHANDLE.html">EXHANDLE</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00800 
00801     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> OldHandleTableEntry;
00802     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> NewHandleTableEntry;
00803 
00804     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00805 
00806     <span class="comment">//</span>
00807     <span class="comment">//  First allocate a new handle table.  If this fails then</span>
00808     <span class="comment">//  return immediately to our caller</span>
00809     <span class="comment">//</span>
00810 
00811     NewHandleTable = <a class="code" href="../../d0/d8/ex_2handle_8c.html#a4">ExpAllocateHandleTable</a>( Process );
00812 
00813     <span class="keywordflow">if</span> (NewHandleTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00814 
00815         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00816     }
00817 
00818     <span class="comment">//</span>
00819     <span class="comment">//  Now lock down the old handle table.  We will release it</span>
00820     <span class="comment">//  right after enumerating through the table</span>
00821     <span class="comment">//</span>
00822 
00823     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00824     <a class="code" href="../../d5/d8/ex_8h.html#a283">ExLockHandleTableShared</a>( OldHandleTable );
00825 
00826     AdditionalFreeEntries = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00827 
00828     <span class="keywordflow">try</span> {
00829 
00830         <span class="comment">//</span>
00831         <span class="comment">//  Now we'll build up the new handle table. We do this by calling</span>
00832         <span class="comment">//  allocating new handle table entries, and "fooling" the worker</span>
00833         <span class="comment">//  routine to allocate keep on allocating until the next free</span>
00834         <span class="comment">//  index needing pool are equal</span>
00835         <span class="comment">//</span>
00836 
00837         <span class="keywordflow">while</span> (NewHandleTable-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o6">NextIndexNeedingPool</a> &lt; OldHandleTable-&gt;NextIndexNeedingPool) {
00838 
00839             <span class="comment">//</span>
00840             <span class="comment">//  If we set the first free table entry to -1 then the worker</span>
00841             <span class="comment">//  routine will allocate another buffer</span>
00842             <span class="comment">//</span>
00843 
00844             NewHandleTable-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o5">FirstFreeTableEntry</a> = -1;
00845 
00846             <span class="comment">//</span>
00847             <span class="comment">//  Call the worker routine to grow the new handle table.  If</span>
00848             <span class="comment">//  not successful then free the new table as far as we got,</span>
00849             <span class="comment">//  set out output variable and exit out here</span>
00850             <span class="comment">//</span>
00851 
00852             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d8/ex_2handle_8c.html#a6">ExpAllocateHandleTableEntry</a>( NewHandleTable, &amp;Handle ) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00853 
00854                 <a class="code" href="../../d0/d8/ex_2handle_8c.html#a5">ExpFreeHandleTable</a>( NewHandleTable );
00855 
00856                 NewHandleTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00857 
00858                 leave;
00859             }
00860         }
00861 
00862         <span class="comment">//</span>
00863         <span class="comment">//  Now modify the new handle table to think it has zero handles</span>
00864         <span class="comment">//  and set its free list to start on the same index as the old</span>
00865         <span class="comment">//  free list</span>
00866         <span class="comment">//</span>
00867 
00868         NewHandleTable-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o1">HandleCount</a> = 0;
00869         NewHandleTable-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o5">FirstFreeTableEntry</a> = OldHandleTable-&gt;FirstFreeTableEntry;
00870 
00871         <span class="comment">//</span>
00872         <span class="comment">//  Now for every valid index value we'll copy over the old entry into</span>
00873         <span class="comment">//  the new entry</span>
00874         <span class="comment">//</span>
00875 
00876         <span class="keywordflow">for</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.GenericHandleOverlay = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; <span class="comment">// does essentially the following "Handle.Index = 0, Handle.TagBits = 0;"</span>
00877              (OldHandleTableEntry = <a class="code" href="../../d0/d8/ex_2handle_8c.html#a8">ExpLookupHandleTableEntry</a>( OldHandleTable, Handle )) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00878              <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.Index += 1) {
00879 
00880             <span class="comment">//</span>
00881             <span class="comment">//  The conditinal in the loop gives up the old handle table</span>
00882             <span class="comment">//  entry, by definition there must exist a corresponding new</span>
00883             <span class="comment">//  handle table entry, so now look it up</span>
00884             <span class="comment">//</span>
00885 
00886             NewHandleTableEntry = <a class="code" href="../../d0/d8/ex_2handle_8c.html#a8">ExpLookupHandleTableEntry</a>( NewHandleTable,
00887                                                              Handle );
00888 
00889             <span class="comment">//</span>
00890             <span class="comment">//  If the old entry is free then simply copy over the entire</span>
00891             <span class="comment">//  old entry to the new entry.  The lock command will tell us</span>
00892             <span class="comment">//  it entry is free.</span>
00893             <span class="comment">//</span>
00894 
00895             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a287">ExLockHandleTableEntry</a>( OldHandleTable, OldHandleTableEntry )) {
00896 
00897                 *NewHandleTableEntry = *OldHandleTableEntry;
00898 
00899             } <span class="keywordflow">else</span> {
00900 
00901                 <span class="comment">//</span>
00902                 <span class="comment">//  Otherwise we have a non empty entry.  So now copy it</span>
00903                 <span class="comment">//  over, and unlock the old entry.  In both cases we bump</span>
00904                 <span class="comment">//  the handle count because either the entry is going into</span>
00905                 <span class="comment">//  the new table or we're going to remove it with Exp Free</span>
00906                 <span class="comment">//  Handle Table Entry which will decrement the handle count</span>
00907                 <span class="comment">//</span>
00908 
00909                 *NewHandleTableEntry = *OldHandleTableEntry;
00910                 NewHandleTable-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o1">HandleCount</a> += 1;
00911 
00912                 <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( OldHandleTable, OldHandleTableEntry );
00913 
00914                 <span class="comment">//</span>
00915                 <span class="comment">//  Invoke the callback and if it returns true then we</span>
00916                 <span class="comment">//  unlock the new entry</span>
00917                 <span class="comment">//</span>
00918 
00919                 <span class="keywordflow">if</span> ((*DupHandleProcedure)( Process, NewHandleTableEntry )) {
00920 
00921                     <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( NewHandleTable, NewHandleTableEntry );
00922 
00923                 } <span class="keywordflow">else</span> {
00924 
00925                     <span class="comment">//</span>
00926                     <span class="comment">//  Otherwise this entry is going to be freed in the</span>
00927                     <span class="comment">//  new handle table.  So add it to the stack list of</span>
00928                     <span class="comment">//  additional freed entries</span>
00929                     <span class="comment">//</span>
00930 
00931                     NewHandleTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> = AdditionalFreeEntries;
00932                     NewHandleTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o5">NextFreeTableEntry</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.Index;
00933 
00934                     AdditionalFreeEntries = NewHandleTableEntry;
00935                 }
00936             }
00937         }
00938 
00939     } finally {
00940 
00941         <a class="code" href="../../d5/d8/ex_8h.html#a285">ExUnlockHandleTableShared</a>( OldHandleTable );
00942         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00943     }
00944 
00945     <span class="comment">//</span>
00946     <span class="comment">//  At this point we are through with the old handle table,</span>
00947     <span class="comment">//  and if present the new handle table is done with except</span>
00948     <span class="comment">//  for adding back the newly freed entrires.  The only time</span>
00949     <span class="comment">//  the additionalFreeEntries variable will not be null is if</span>
00950     <span class="comment">//  we successfully built the new table and the dup routine</span>
00951     <span class="comment">//  came back false.</span>
00952     <span class="comment">//</span>
00953     <span class="comment">//  While there are additional entries to add to the free list</span>
00954     <span class="comment">//  pop the entry off the stack and add it to the table</span>
00955     <span class="comment">//</span>
00956 
00957     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.GenericHandleOverlay = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00958     <span class="keywordflow">while</span> (AdditionalFreeEntries != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00959 
00960         PVOID Next;
00961 
00962         Next = AdditionalFreeEntries-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a>;
00963         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.Index = AdditionalFreeEntries-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o5">NextFreeTableEntry</a>;
00964 
00965         AdditionalFreeEntries-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00966 
00967         <a class="code" href="../../d0/d8/ex_2handle_8c.html#a7">ExpFreeHandleTableEntry</a>( NewHandleTable,
00968                                  Handle,
00969                                  AdditionalFreeEntries );
00970 
00971         AdditionalFreeEntries = Next;
00972     }
00973 
00974     <span class="comment">//</span>
00975     <span class="comment">//  lastly return the new handle table to our caller</span>
00976     <span class="comment">//</span>
00977 
00978     <span class="keywordflow">return</span> NewHandleTable;
00979 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="ex/handle.c::ExEnumHandleTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN ExEnumHandleTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a140">EX_ENUMERATE_HANDLE_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>EnumHandleProcedure</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>EnumParameter</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00634">634</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00240">ExLockHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00114">ExLockHandleTableShared()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l02195">ExpLookupHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00336">ExUnlockHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00178">ExUnlockHandleTableShared()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02630">_EXHANDLE::GenericHandleOverlay</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02627">_EXHANDLE::Index</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/tex_8c-source.html#l01160">DoHandleTest()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01234">ObFindHandleForObject()</a>, and <a class="el" href="../../d1/d0/obinit_8c-source.html#l00815">ObInitProcess()</a>.
<p>
<pre class="fragment"><div>00643                    :
00644 
00645     This function enumerates all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> valid handles in a handle table.
00646     For each valid handle in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified eumeration
00647     function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration function returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, then
00648     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stopped, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00649     caller via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> optional <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> parameter, and <span class="keyword">this</span> function returns
00650     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to indicated that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration stopped at a specific handle.
00651 
00652 Arguments:
00653 
00654     HandleTable - Supplies a pointer to a handle table.
00655 
00656     EnumHandleProcedure - Supplies a pointer to a fucntion to call <span class="keywordflow">for</span>
00657         each valid handle in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumerated handle table.
00658 
00659     EnumParameter - Supplies an uninterpreted 32-bit value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed
00660         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> EnumHandleProcedure each time <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00661 
00662     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies an optional pointer a variable that receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00663         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> value that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration stopped at. Contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00664         variable <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> valid <span class="keywordflow">if</span> <span class="keyword">this</span> function returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
00665 
00666 Return Value:
00667 
00668     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration stopped at a specific handle, then a value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00669     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned. Otherwise, a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00670 
00671 --*/
00672 
00673 {
00674     BOOLEAN ResultValue;
00675     <a class="code" href="../../d7/d8/struct__EXHANDLE.html">EXHANDLE</a> LocalHandle;
00676     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> HandleTableEntry;
00677 
00678     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00679 
00680     <span class="comment">//</span>
00681     <span class="comment">//  First lock the handle table shared to stop anyone from creating or</span>
00682     <span class="comment">//  destroying new handles.  We need to do this because out iteration</span>
00683     <span class="comment">//  function doesn't want the handles to be closed while we're doing</span>
00684     <span class="comment">//  our work</span>
00685     <span class="comment">//</span>
00686 
00687     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00688     <a class="code" href="../../d5/d8/ex_8h.html#a283">ExLockHandleTableShared</a>( HandleTable );
00689 
00690     <span class="keywordflow">try</span> {
00691 
00692         <span class="comment">//</span>
00693         <span class="comment">//  Our initial return value is false until the enumeration callback</span>
00694         <span class="comment">//  function tells us otherwise</span>
00695         <span class="comment">//</span>
00696 
00697         ResultValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00698 
00699         <span class="comment">//</span>
00700         <span class="comment">//  Iterate through the handle table and for each handle that is</span>
00701         <span class="comment">//  allocated we'll invoke the call back.  Note that this loop exits</span>
00702         <span class="comment">//  when we get a null handle table entry.  We know there will be no</span>
00703         <span class="comment">//  more possible entries after the first null one is encountered</span>
00704         <span class="comment">//  because we allocate memory of the handles in a dense fashion</span>
00705         <span class="comment">//</span>
00706 
00707         <span class="keywordflow">for</span> (LocalHandle.<a class="code" href="../../d7/d8/struct__EXHANDLE.html#o2">GenericHandleOverlay</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; <span class="comment">// does essentially the following "LocalHandle.Index = 0, LocalHandle.TagBits = 0;"</span>
00708              (HandleTableEntry = <a class="code" href="../../d0/d8/ex_2handle_8c.html#a8">ExpLookupHandleTableEntry</a>( HandleTable, LocalHandle )) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00709              LocalHandle.<a class="code" href="../../d7/d8/struct__EXHANDLE.html#o1">Index</a> += 1) {
00710 
00711             <span class="comment">//</span>
00712             <span class="comment">//  Only do the callback if the entry is not free</span>
00713             <span class="comment">//</span>
00714 
00715             <span class="keywordflow">if</span> (HandleTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00716 
00717                 <span class="comment">//</span>
00718                 <span class="comment">//  Lock the handle table entry because we're about to give</span>
00719                 <span class="comment">//  it to the callback function, then release the entry</span>
00720                 <span class="comment">//  right after the call back.</span>
00721                 <span class="comment">//</span>
00722 
00723                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a287">ExLockHandleTableEntry</a>( HandleTable, HandleTableEntry )) {
00724 
00725                     <span class="keywordflow">try</span> {
00726 
00727                         <span class="comment">//</span>
00728                         <span class="comment">//  Invoke the callback, and if it returns true then set</span>
00729                         <span class="comment">//  the proper output values and break out of the loop.</span>
00730                         <span class="comment">//</span>
00731 
00732                         <span class="keywordflow">if</span> ((*EnumHandleProcedure)( HandleTableEntry,
00733                                                     LocalHandle.<a class="code" href="../../d7/d8/struct__EXHANDLE.html#o2">GenericHandleOverlay</a>,
00734                                                     EnumParameter )) {
00735 
00736                             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Handle )) {
00737 
00738                                 *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = LocalHandle.<a class="code" href="../../d7/d8/struct__EXHANDLE.html#o2">GenericHandleOverlay</a>;
00739                             }
00740 
00741                             ResultValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00742                             <span class="keywordflow">break</span>;
00743                         }
00744 
00745                     } finally {
00746 
00747                         <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( HandleTable, HandleTableEntry );
00748                     }
00749                 }
00750             }
00751         }
00752 
00753     } finally {
00754 
00755         <a class="code" href="../../d5/d8/ex_8h.html#a285">ExUnlockHandleTableShared</a>( HandleTable );
00756         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00757     }
00758 
00759     <span class="keywordflow">return</span> ResultValue;
00760 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="ex/handle.c::ExInitializeHandleTablePackage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID ExInitializeHandleTablePackage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00422">422</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00037">HandleTableListHead</a>, and <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00036">HandleTableListLock</a>.
<p>
<pre class="fragment"><div>00428                    :
00429 
00430     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called once at system initialization to setup <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ex handle
00431     table <span class="keyword">package</span>
00432 <span class="keyword"></span>
00433 <span class="keyword"></span>Arguments:
00434 
00435     None.
00436 
00437 Return Value:
00438 
00439     None.
00440 
00441 --*/
00442 
00443 {
00444     <span class="comment">//</span>
00445     <span class="comment">//  Initialize the handle table synchronization resource and list head</span>
00446     <span class="comment">//</span>
00447 
00448     InitializeListHead( &amp;HandleTableListHead );
00449     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( &amp;HandleTableListLock );
00450 
00451     <span class="keywordflow">return</span>;
00452 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="ex/handle.c::ExLockHandleTableEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN ExLockHandleTableEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTableEntry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00240">240</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00051">Ex10Milliseconds</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00044">EXHANDLE_TABLE_ENTRY_LOCK_BIT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02771">_HANDLE_TABLE::HandleContentionEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d7/hal_8h.html#a206">KeStallExecutionProcessor()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01315">ExChangeHandle()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01227">ExDestroyHandle()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00765">ExDupHandleTable()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00634">ExEnumHandleTable()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01403">ExMapHandleToPointer()</a>, and <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00984">ExSnapShotHandleTables()</a>.
<p>
<pre class="fragment"><div>00247                    :
00248 
00249     This routine locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle table entry.  After <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00250     locked <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sign bit will be set.
00251 
00252 Arguments:
00253 
00254     HandleTable - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry being locked.
00255 
00256     HandleTableEntry - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table entry being locked.
00257 
00258 Return Value:
00259 
00260     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid and locked, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00261     marked free.
00262 
00263 --*/
00264 
00265 {
00266     LONG_PTR NewValue;
00267     LONG_PTR CurrentValue;
00268     ULONG LoopCount = 0;
00269 
00270     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">//  We'll keep on looping reading in the value, making sure it is not null,</span>
00274     <span class="comment">//  and if it is not currently locked we'll try for the lock and return</span>
00275     <span class="comment">//  true if we get it.  Otherwise we'll pause a bit and then try again.</span>
00276     <span class="comment">//</span>
00277 
00278     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00279 
00280         NewValue =
00281         CurrentValue = *((<span class="keyword">volatile</span> LONG_PTR *)&amp;HandleTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a>);
00282 
00283         <span class="comment">//</span>
00284         <span class="comment">//  Make sure the handle table entry is not freed</span>
00285         <span class="comment">//</span>
00286 
00287         <span class="keywordflow">if</span> (CurrentValue == 0) {
00288 
00289             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00290         }
00291 
00292         <span class="comment">//</span>
00293         <span class="comment">//  If the handle value is greater than zero then it is not currently</span>
00294         <span class="comment">//  locked and we should try for the lock, but setting the lock bit and</span>
00295         <span class="comment">//  doing an interlocked exchange.</span>
00296         <span class="comment">//</span>
00297 
00298         <span class="keywordflow">if</span> (CurrentValue &gt; 0) {
00299 
00300             NewValue |= <a class="code" href="../../d0/d8/ex_2handle_8c.html#a0">EXHANDLE_TABLE_ENTRY_LOCK_BIT</a>;
00301 
00302             <span class="keywordflow">if</span> ((LONG_PTR)(InterlockedCompareExchangePointer( &amp;HandleTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a>,
00303                                                              (PVOID)NewValue,
00304                                                              (PVOID)CurrentValue )) == CurrentValue) {
00305 
00306                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00307             }
00308         }
00309 
00310         <span class="comment">//</span>
00311         <span class="comment">//  Either someone already has the entry locked or the value changed</span>
00312         <span class="comment">//  somehow, either way we'll wait a bit and try again.  The first</span>
00313         <span class="comment">//  time we'll wait by spinning for 10us and if that doesn't work</span>
00314         <span class="comment">//  then we'll wait for the handle contention event to go off or</span>
00315         <span class="comment">//  for 10ms, whichever comes first.</span>
00316         <span class="comment">//</span>
00317 
00318         <span class="keywordflow">if</span> (LoopCount++ &lt; 1) {
00319 
00320             <a class="code" href="../../d2/d7/hal_8h.html#a206">KeStallExecutionProcessor</a>( 10 );
00321 
00322         } <span class="keywordflow">else</span> {
00323 
00324             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;HandleTable-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o9">HandleContentionEvent</a>,
00325                                    Executive,
00326                                    KernelMode,
00327                                    FALSE,
00328                                    &amp;Ex10Milliseconds );
00329         }
00330     }
00331 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ex/handle.c::ExLockHandleTableExclusive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID ExLockHandleTableExclusive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>HandleTable</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00146">146</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02755">_HANDLE_TABLE::HandleTableLock</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01144">ExCreateHandle()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01227">ExDestroyHandle()</a>, and <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00984">ExSnapShotHandleTables()</a>.
<p>
<pre class="fragment"><div>00152                    :
00153 
00154     This routine locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle table <span class="keywordflow">for</span> exclusive access.  Once
00155     locked <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> onwer can add or <span class="keyword">delete</span> entries from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table.
00156 
00157 Arguments:
00158 
00159     HandleTable - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table being locked.
00160 
00161 Return Value:
00162 
00163     None.
00164 
00165 --*/
00166 
00167 {
00168     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00169 
00170     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( &amp;HandleTable-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o7">HandleTableLock</a>, TRUE );
00171 
00172     <span class="keywordflow">return</span>;
00173 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ex/handle.c::ExLockHandleTableShared" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID ExLockHandleTableShared           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>HandleTable</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00114">114</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02755">_HANDLE_TABLE::HandleTableLock</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00765">ExDupHandleTable()</a>, and <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00634">ExEnumHandleTable()</a>.
<p>
<pre class="fragment"><div>00120                    :
00121 
00122     This routine locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle table <span class="keywordflow">for</span> shared access.  Once
00123     locked <span class="keyword">new</span> entries cannot be added to deleted from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table.
00124 
00125 Arguments:
00126 
00127     HandleTable - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table being locked.
00128 
00129 Return Value:
00130 
00131     None.
00132 
00133 --*/
00134 
00135 {
00136     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00137 
00138     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;HandleTable-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o7">HandleTableLock</a>, TRUE );
00139 
00140     <span class="keywordflow">return</span>;
00141 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="ex/handle.c::ExMapHandleToPointer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ExMapHandleToPointer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01403">1403</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00240">ExLockHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l02195">ExpLookupHandleTableEntry()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02630">_EXHANDLE::GenericHandleOverlay</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/tex_8c-source.html#l01160">DoHandleTest()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">NtWaitForMultipleObjects()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l01319">ObQueryObjectAuditingByHandle()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00094">PsLookupProcessByProcessId()</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00027">PsLookupProcessThreadByCid()</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00146">PsLookupThreadByThreadId()</a>, and <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00152">RtlpAtomMapAtomToHandleEntry()</a>.
<p>
<pre class="fragment"><div>01410                    :
01411 
01412     This function maps a handle to a pointer to a handle table entry. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01413     map operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked when
01414     we <span class="keywordflow">return</span>.
01415 
01416 Arguments:
01417 
01418     HandleTable - Supplies a pointer to a handle table.
01419 
01420     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to be mapped to a handle entry.
01421 
01422 Return Value:
01423 
01424     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle was successfully mapped to a pointer to a handle entry,
01425     then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function
01426     value with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry locked. Otherwise, a value of <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01427 
01428 --*/
01429 
01430 {
01431     <a class="code" href="../../d7/d8/struct__EXHANDLE.html">EXHANDLE</a> LocalHandle;
01432 
01433     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> HandleTableEntry;
01434 
01435     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01436 
01437     LocalHandle.<a class="code" href="../../d7/d8/struct__EXHANDLE.html#o2">GenericHandleOverlay</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01438 
01439     <span class="comment">//</span>
01440     <span class="comment">//  Translate the input handle to a handle table entry and make</span>
01441     <span class="comment">//  sure it is a valid handle.</span>
01442     <span class="comment">//</span>
01443 
01444     HandleTableEntry = <a class="code" href="../../d0/d8/ex_2handle_8c.html#a8">ExpLookupHandleTableEntry</a>( HandleTable,
01445                                                   LocalHandle );
01446 
01447     <span class="keywordflow">if</span> (HandleTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01448 
01449         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01450     }
01451 
01452     <span class="comment">//</span>
01453     <span class="comment">//  Try and lock the handle table entry,  If this fails then that's</span>
01454     <span class="comment">//  because someone freed the handle</span>
01455     <span class="comment">//</span>
01456 
01457     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a287">ExLockHandleTableEntry</a>( HandleTable, HandleTableEntry )) {
01458 
01459         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01460     }
01461 
01462     <span class="comment">//</span>
01463     <span class="comment">//  Return the locked valid handle table entry</span>
01464     <span class="comment">//</span>
01465 
01466     <span class="keywordflow">return</span> HandleTableEntry;
01467 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ex/handle.c::ExpAllocateHandleTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> ExpAllocateHandleTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>OPTIONAL</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01475">1475</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02746">_HANDLE_TABLE::FirstFreeTableEntry</a>, <a class="el" href="../../d5/d8/ex_8h.html#a137">HANDLE_TABLE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a135">HANDLE_TABLE_ENTRY</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02771">_HANDLE_TABLE::HandleContentionEvent</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02762">_HANDLE_TABLE::HandleTableList</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00037">HandleTableListHead</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00036">HandleTableListLock</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02755">_HANDLE_TABLE::HandleTableLock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02699">_HANDLE_TABLE_ENTRY::NextFreeTableEntry</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02747">_HANDLE_TABLE::NextIndexNeedingPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00144">POOL_RAISE_IF_ALLOCATION_FAILURE</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02736">_HANDLE_TABLE::QuotaProcess</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02729">_HANDLE_TABLE::Table</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l02737">_HANDLE_TABLE::UniqueProcessId</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00457">ExCreateHandleTable()</a>, and <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00765">ExDupHandleTable()</a>.
<p>
<pre class="fragment"><div>01481                    :
01482 
01483     This worker routine will allocate and initialize a <span class="keyword">new</span> handle table
01484     structure.  The <span class="keyword">new</span> structure consists of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> basic handle table
01485     <span class="keyword">struct </span>plus <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first allocation needed to store handles.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01486     really one page divided up into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top level node, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first mid
01487     level node, and one bottom level node.
01488 
01489 Arguments:
01490 
01491     Process - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to charge quota for <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01492         handle table
01493 
01494 Return Value:
01495 
01496     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> new handle table or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> if unsuccessful at getting
01497     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01498 
01499 --*/
01500 
01501 {
01502     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable;
01503     BOOLEAN HandleTableQuotaCharged;
01504 
01505     PVOID HandleTableTable;
01506     BOOLEAN HandleTableTableQuotaCharged;
01507 
01508     ULONG i;
01509 
01510     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01511 
01512     HandleTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01513     HandleTableQuotaCharged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01514 
01515     HandleTableTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01516     HandleTableTableQuotaCharged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01517 
01518     <span class="comment">//</span>
01519     <span class="comment">//  If any alloation or quota failures happen we will catch it in the</span>
01520     <span class="comment">//  following try-except clause and cleanup after outselves before</span>
01521     <span class="comment">//  we return null</span>
01522     <span class="comment">//</span>
01523 
01524     <span class="keywordflow">try</span> {
01525 
01526         <span class="comment">//</span>
01527         <span class="comment">//  First allocate the handle table, make sure we got one, charge quota</span>
01528         <span class="comment">//  for it and then zero it out</span>
01529         <span class="comment">//</span>
01530 
01531         HandleTable = (<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool | POOL_RAISE_IF_ALLOCATION_FAILURE,
01532                                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">HANDLE_TABLE</a>),
01533                                                             'btbO' );
01534 
01535         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Process)) {
01536 
01537             <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>( Process,
01538                                NonPagedPool,
01539                                <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">HANDLE_TABLE</a>));
01540 
01541             HandleTableQuotaCharged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01542         }
01543 
01544         RtlZeroMemory( HandleTable, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">HANDLE_TABLE</a>) );
01545 
01546         <span class="comment">//</span>
01547         <span class="comment">//  Now allocate space of the top level, one mid level and one bottom</span>
01548         <span class="comment">//  level table structure.  This will all fit on a page, maybe two.</span>
01549         <span class="comment">//</span>
01550 
01551         HandleTableTable =
01552         HandleTable-&gt;Table = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool | POOL_RAISE_IF_ALLOCATION_FAILURE,
01553                                                     (2 * <span class="keyword">sizeof</span>(ULONG_PTR) * 256) + (<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a>) * 256),
01554                                                     'btbO' );
01555 
01556         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Process)) {
01557 
01558             <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>( Process,
01559                                PagedPool,
01560                                (2 * <span class="keyword">sizeof</span>(ULONG_PTR) * 256) + (<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a>) * 256) );
01561 
01562             HandleTableTableQuotaCharged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01563 
01564         }
01565 
01566         RtlZeroMemory( HandleTable-&gt;Table,
01567                        (2 * <span class="keyword">sizeof</span>(ULONG_PTR) * 256) + (<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a>) * 256) );
01568 
01569     } except (EXCEPTION_EXECUTE_HANDLER) {
01570 
01571         <span class="keywordflow">if</span> (HandleTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01572 
01573             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( HandleTable );
01574 
01575             <span class="keywordflow">if</span> (HandleTableQuotaCharged) {
01576 
01577                 <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Process,
01578                                    NonPagedPool,
01579                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">HANDLE_TABLE</a>));
01580             }
01581         }
01582 
01583         <span class="keywordflow">if</span> (HandleTableTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01584 
01585             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( HandleTableTable );
01586 
01587             <span class="keywordflow">if</span> (HandleTableTableQuotaCharged) {
01588 
01589                 <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Process,
01590                                    PagedPool,
01591                                    (2 * <span class="keyword">sizeof</span>(ULONG_PTR) * 256) + (<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a>) * 256) );
01592             }
01593         }
01594 
01595         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01596     }
01597 
01598     <span class="comment">//</span>
01599     <span class="comment">//  Now setup the pointers for the initial handle table tree</span>
01600     <span class="comment">//</span>
01601 
01602     HandleTable-&gt;Table[0]    = (PVOID)(((PCHAR)(HandleTable-&gt;Table)) + 1 * (<span class="keyword">sizeof</span>(ULONG_PTR) * 256));
01603     HandleTable-&gt;Table[0][0] = (PVOID)(((PCHAR)(HandleTable-&gt;Table)) + 2 * (<span class="keyword">sizeof</span>(ULONG_PTR) * 256));
01604 
01605     <span class="comment">//</span>
01606     <span class="comment">//  Now setup the free list.  We do this by chaining together the free</span>
01607     <span class="comment">//  entries such that each free entry give the next free index (i.e.,</span>
01608     <span class="comment">//  like a fat chain).  The chain is terminated with a -1.  Note that</span>
01609     <span class="comment">//  we'll skip handle zero because our callers will get that value</span>
01610     <span class="comment">//  confused with null.</span>
01611     <span class="comment">//</span>
01612 
01613     <span class="keywordflow">for</span> (i = 0; i &lt; 255; i += 1) {
01614 
01615         (HandleTable-&gt;Table[0][0])[i].NextFreeTableEntry = i+1;
01616     }
01617 
01618     (HandleTable-&gt;Table[0][0])[255].NextFreeTableEntry = -1;
01619 
01620     HandleTable-&gt;FirstFreeTableEntry = 1;
01621     HandleTable-&gt;NextIndexNeedingPool = 256;
01622 
01623     <span class="comment">//</span>
01624     <span class="comment">//  Setup the necessary process information</span>
01625     <span class="comment">//</span>
01626 
01627     HandleTable-&gt;QuotaProcess = Process;
01628     HandleTable-&gt;UniqueProcessId = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId;
01629 
01630     <span class="comment">//</span>
01631     <span class="comment">//  Initialize the lock handle table resource</span>
01632     <span class="comment">//</span>
01633 
01634     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( &amp;HandleTable-&gt;HandleTableLock );
01635 
01636     <span class="comment">//</span>
01637     <span class="comment">//  Initialize the notification event for handle table entry contention</span>
01638     <span class="comment">//</span>
01639 
01640     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;HandleTable-&gt;HandleContentionEvent, NotificationEvent, FALSE );
01641 
01642     <span class="comment">//</span>
01643     <span class="comment">//  Insert the handle table in the handle table list.</span>
01644     <span class="comment">//</span>
01645 
01646     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01647     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( &amp;HandleTableListLock, TRUE );
01648 
01649     InsertTailList( &amp;HandleTableListHead, &amp;HandleTable-&gt;HandleTableList );
01650 
01651     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;HandleTableListLock );
01652     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01653 
01654     <span class="comment">//</span>
01655     <span class="comment">//  And return to our caller</span>
01656     <span class="comment">//</span>
01657 
01658     <span class="keywordflow">return</span> HandleTable;
01659 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ex/handle.c::ExpAllocateHandleTableEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ExpAllocateHandleTableEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d7/d8/struct__EXHANDLE.html">PEXHANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01825">1825</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l02195">ExpLookupHandleTableEntry()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d8/ex_8h.html#a135">HANDLE_TABLE_ENTRY</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02699">_HANDLE_TABLE_ENTRY::NextFreeTableEntry</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00144">POOL_RAISE_IF_ALLOCATION_FAILURE</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01144">ExCreateHandle()</a>, and <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00765">ExDupHandleTable()</a>.
<p>
<pre class="fragment"><div>01832                    :
01833 
01834     This worker routine allocates a <span class="keyword">new</span> handle table entry <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
01835     handle table.
01836 
01837     Note: The caller must have already locked <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table
01838 
01839 Arguments:
01840 
01841     HandleTable - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table being used
01842 
01843     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> entry <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01844         successful otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> null
01845 
01846 Return Value:
01847 
01848     Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> handle table entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01849         successful otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> null.
01850 
01851 --*/
01852 
01853 {
01854     ULONG i,j,k;
01855 
01856     PUCHAR NewMidLevel;
01857     BOOLEAN MidTableQuotaCharged;
01858 
01859     PUCHAR NewLowLevel;
01860     BOOLEAN LowTableQuotaCharged;
01861 
01862     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> HandleTableEntry;
01863 
01864     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01865 
01866     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>-&gt;GenericHandleOverlay = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01867 
01868     <span class="comment">//</span>
01869     <span class="comment">//  First see if the free stack is emtpy and if so then we need</span>
01870     <span class="comment">//  to add some more entries to it</span>
01871     <span class="comment">//</span>
01872 
01873     <span class="keywordflow">if</span> (HandleTable-&gt;FirstFreeTableEntry == -1) {
01874 
01875         <span class="comment">//</span>
01876         <span class="comment">//  We need to allocate some more pool.  We start by seeing</span>
01877         <span class="comment">//  if the next index is too large to allocate.  We only have</span>
01878         <span class="comment">//  24 bits of handle values to use</span>
01879         <span class="comment">//</span>
01880 
01881         <span class="keywordflow">if</span> (HandleTable-&gt;NextIndexNeedingPool &gt;= (1 &lt;&lt; 24)) {
01882 
01883             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01884         }
01885 
01886         <span class="comment">//  Now find the next index to allocate a buffer for</span>
01887         <span class="comment">//</span>
01888 
01889         i = (HandleTable-&gt;NextIndexNeedingPool &gt;&gt; 16) &amp; 255;
01890         j = (HandleTable-&gt;NextIndexNeedingPool &gt;&gt; 8)  &amp; 255;
01891 
01892         <span class="comment">//</span>
01893         <span class="comment">//  Within the following try body we'll be allocating and initializing</span>
01894         <span class="comment">//  a low level buffer and possibly a new mid level buffer.  The</span>
01895         <span class="comment">//  might seem a little odd but is necessary to handle the situation</span>
01896         <span class="comment">//  where our first buffer is allocated off a little bit (i.e., the</span>
01897         <span class="comment">//  next buffer index starts are [0][1]).  By the time we reach</span>
01898         <span class="comment">//  [0][255] we add only one new buffer.  Then start with even numbers</span>
01899         <span class="comment">//  at [1][0] and work our way to completion</span>
01900         <span class="comment">//</span>
01901 
01902         NewMidLevel = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01903         MidTableQuotaCharged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01904 
01905         NewLowLevel = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01906         LowTableQuotaCharged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01907 
01908         <span class="keywordflow">try</span> {
01909 
01910             <span class="comment">//</span>
01911             <span class="comment">//  Check if we need to allocate a new mid level buffer,  We do</span>
01912             <span class="comment">//  these allocations four at a time</span>
01913             <span class="comment">//</span>
01914 
01915             <span class="keywordflow">if</span> (HandleTable-&gt;Table[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01916 
01917                 NewMidLevel = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool | POOL_RAISE_IF_ALLOCATION_FAILURE,
01918                                                      4 * <span class="keyword">sizeof</span>(ULONG_PTR) * 256,
01919                                                      'btbO' );
01920 
01921                 RtlZeroMemory( NewMidLevel, 4 * <span class="keyword">sizeof</span>(ULONG_PTR) * 256 );
01922 
01923                 <span class="keywordflow">if</span> (HandleTable-&gt;QuotaProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01924 
01925                     <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>( HandleTable-&gt;QuotaProcess,
01926                                        PagedPool,
01927                                        (4 * <span class="keyword">sizeof</span>(ULONG_PTR) * 256) );
01928 
01929                     MidTableQuotaCharged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01930                 }
01931             }
01932 
01933             <span class="comment">//</span>
01934             <span class="comment">//  Now Allocate two new table entry buffers</span>
01935             <span class="comment">//</span>
01936 
01937             NewLowLevel = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool | POOL_RAISE_IF_ALLOCATION_FAILURE,
01938                                                  2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a>) * 256,
01939                                                  'btbO' );
01940 
01941             RtlZeroMemory( NewLowLevel, 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a>) * 256 );
01942 
01943             <span class="keywordflow">if</span> (HandleTable-&gt;QuotaProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01944 
01945                 <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>( HandleTable-&gt;QuotaProcess,
01946                                    PagedPool,
01947                                    (2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a>) * 256) );
01948 
01949                 LowTableQuotaCharged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01950             }
01951 
01952             <span class="comment">//</span>
01953             <span class="comment">//  Now to guard against reordering of code we need to do</span>
01954             <span class="comment">//  something to ensure that the last zero memory really has</span>
01955             <span class="comment">//  happened before setting up the rest of our work.  An</span>
01956             <span class="comment">//  interlocked exchance will do the trick.</span>
01957             <span class="comment">//</span>
01958 
01959             InterlockedExchangePointer( (PVOID *) NewLowLevel, NULL );
01960 
01961             <span class="comment">//</span>
01962             <span class="comment">//  Now if we've allocated a new mid level buffer we need to</span>
01963             <span class="comment">//  update the pointers from our handle table.  The if's are</span>
01964             <span class="comment">//  needed when we get near the end of the table</span>
01965             <span class="comment">//</span>
01966 
01967             <span class="keywordflow">if</span> (NewMidLevel != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01968 
01969                 <span class="keywordflow">if</span> (i+0 &lt; 256) { HandleTable-&gt;Table[i+0] = (PVOID)(NewMidLevel + 0 * <span class="keyword">sizeof</span>(ULONG_PTR) * 256); }
01970                 <span class="keywordflow">if</span> (i+1 &lt; 256) { HandleTable-&gt;Table[i+1] = (PVOID)(NewMidLevel + 1 * <span class="keyword">sizeof</span>(ULONG_PTR) * 256); }
01971                 <span class="keywordflow">if</span> (i+2 &lt; 256) { HandleTable-&gt;Table[i+2] = (PVOID)(NewMidLevel + 2 * <span class="keyword">sizeof</span>(ULONG_PTR) * 256); }
01972                 <span class="keywordflow">if</span> (i+3 &lt; 256) { HandleTable-&gt;Table[i+3] = (PVOID)(NewMidLevel + 3 * <span class="keyword">sizeof</span>(ULONG_PTR) * 256); }
01973             }
01974 
01975             <span class="comment">//</span>
01976             <span class="comment">//  Now fix up the low level buffers.  We are actually guaranteed</span>
01977             <span class="comment">//  that the first buffer will fit, because j starts out from a</span>
01978             <span class="comment">//  byte.</span>
01979             <span class="comment">//</span>
01980 
01981                            { HandleTable-&gt;Table[i][j+0] = (PVOID)(NewLowLevel + 0 * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a>) * 256); }
01982             <span class="keywordflow">if</span> (j+1 &lt; 256) { HandleTable-&gt;Table[i][j+1] = (PVOID)(NewLowLevel + 1 * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a>) * 256); }
01983 
01984             <span class="comment">//</span>
01985             <span class="comment">//  Now add the new entries to the free list.  To do this we</span>
01986             <span class="comment">//  chain the new free entries together.  We are guaranteed to</span>
01987             <span class="comment">//  have at least one new buffer.  The second buffer we need</span>
01988             <span class="comment">//  to check for.</span>
01989             <span class="comment">//</span>
01990             <span class="comment">//  Start by starting our stack top</span>
01991             <span class="comment">//</span>
01992 
01993             HandleTable-&gt;FirstFreeTableEntry = HandleTable-&gt;NextIndexNeedingPool;
01994 
01995             <span class="comment">//</span>
01996             <span class="comment">//  Do the guaranteed first buffer</span>
01997             <span class="comment">//</span>
01998 
01999             <span class="keywordflow">for</span> (k = 0; k &lt; 256; k += 1) {
02000 
02001                 HandleTable-&gt;Table[i][j+0][k].NextFreeTableEntry = HandleTable-&gt;NextIndexNeedingPool + k + 1;
02002             }
02003 
02004             <span class="comment">//</span>
02005             <span class="comment">//  Check if there is a second buffer</span>
02006             <span class="comment">//</span>
02007 
02008             <span class="keywordflow">if</span> ((j+1 &lt; 256) &amp;&amp; (HandleTable-&gt;Table[i][j+1] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02009 
02010                 <span class="comment">//</span>
02011                 <span class="comment">//  Do the second buffer</span>
02012                 <span class="comment">//</span>
02013 
02014                 <span class="keywordflow">for</span> (k = 0; k &lt; 255; k += 1) {
02015 
02016                     HandleTable-&gt;Table[i][j+1][k].NextFreeTableEntry = HandleTable-&gt;NextIndexNeedingPool + k + 1 + 256;
02017                 }
02018 
02019                 <span class="comment">//</span>
02020                 <span class="comment">//  Fixup the last entry and update the next index needing</span>
02021                 <span class="comment">//  pool.</span>
02022                 <span class="comment">//</span>
02023 
02024                 HandleTable-&gt;Table[i][j+1][255].NextFreeTableEntry = -1;
02025 
02026                 HandleTable-&gt;NextIndexNeedingPool += 512;
02027 
02028             } <span class="keywordflow">else</span> {
02029 
02030                 <span class="comment">//</span>
02031                 <span class="comment">//  Fixup the last entry and update the next index needing</span>
02032                 <span class="comment">//  pool.</span>
02033                 <span class="comment">//</span>
02034 
02035                 HandleTable-&gt;Table[i][j+0][255].NextFreeTableEntry = -1;
02036 
02037                 HandleTable-&gt;NextIndexNeedingPool += 256;
02038             }
02039 
02040         } except (EXCEPTION_EXECUTE_HANDLER) {
02041 
02042             <span class="comment">//</span>
02043             <span class="comment">//  We only execute this exception handler if the pool allocation</span>
02044             <span class="comment">//  raises or if the quota request fails.  In these cases we need</span>
02045             <span class="comment">//  to cleanup after ourselves and return null to our caller</span>
02046             <span class="comment">//</span>
02047 
02048             <span class="keywordflow">if</span> (NewMidLevel != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02049 
02050                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewMidLevel );
02051 
02052                 <span class="keywordflow">if</span> (MidTableQuotaCharged) {
02053 
02054                     <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( HandleTable-&gt;QuotaProcess,
02055                                        PagedPool,
02056                                        (4 * <span class="keyword">sizeof</span>(ULONG_PTR) * 256) );
02057                 }
02058             }
02059 
02060             <span class="keywordflow">if</span> (NewLowLevel != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02061 
02062                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewLowLevel );
02063 
02064                 <span class="keywordflow">if</span> (LowTableQuotaCharged) {
02065 
02066                     <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( HandleTable-&gt;QuotaProcess,
02067                                        PagedPool,
02068                                        (2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a>) * 256) );
02069                 }
02070             }
02071 
02072             <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>-&gt;Index = 0;
02073 
02074             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02075         }
02076     }
02077 
02078     <span class="comment">//</span>
02079     <span class="comment">//  At this point the free stack has some elements in it.  So we</span>
02080     <span class="comment">//  only need to pop off the first entry.</span>
02081     <span class="comment">//</span>
02082     <span class="comment">//  Get the top of the stack, both the index and table entry</span>
02083     <span class="comment">//</span>
02084 
02085     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>-&gt;Index = HandleTable-&gt;FirstFreeTableEntry;
02086 
02087     HandleTableEntry = <a class="code" href="../../d0/d8/ex_2handle_8c.html#a8">ExpLookupHandleTableEntry</a>( HandleTable,
02088                                                   *Handle );
02089 
02090     <span class="comment">//</span>
02091     <span class="comment">//  Do the pop</span>
02092     <span class="comment">//</span>
02093 
02094     HandleTable-&gt;FirstFreeTableEntry = HandleTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o5">NextFreeTableEntry</a>;
02095 
02096     <span class="comment">//</span>
02097     <span class="comment">//  Zero out the new table entry</span>
02098     <span class="comment">//</span>
02099 
02100     RtlZeroMemory( HandleTableEntry, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a> ));
02101 
02102     <span class="comment">//</span>
02103     <span class="comment">//  Update our bookkeeping counters and return the entry to our</span>
02104     <span class="comment">//  caller</span>
02105     <span class="comment">//</span>
02106 
02107     HandleTable-&gt;HandleCount += 1;
02108 
02109     <span class="keywordflow">return</span> HandleTableEntry;
02110 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ex/handle.c::ExpFreeHandleTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExpFreeHandleTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>HandleTable</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01667">1667</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02478">ExDeleteResource</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00560">ExDestroyHandleTable()</a>, and <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00765">ExDupHandleTable()</a>.
<p>
<pre class="fragment"><div>01673                    :
01674 
01675     This worker routine tearsdown and frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle table.
01676 
01677 Arguments:
01678 
01679     HandleTable - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table being freed
01680 
01681 Return Value:
01682 
01683     None.
01684 
01685 --*/
01686 
01687 {
01688     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01689     ULONG i,j;
01690 
01691     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01692 
01693     Process = HandleTable-&gt;QuotaProcess;
01694 
01695     <span class="comment">//</span>
01696     <span class="comment">//  First free the lock for the local handle table</span>
01697     <span class="comment">//</span>
01698 
01699     <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>( &amp;HandleTable-&gt;HandleTableLock );
01700 
01701     <span class="comment">//</span>
01702     <span class="comment">//  We first return all of the additional exhandle table entry buffers</span>
01703     <span class="comment">//  that we allocated.  Note that each pool buffer we allocated is for</span>
01704     <span class="comment">//  two subindex buffers in the table, and note also that we have to</span>
01705     <span class="comment">//  start a little funny to compensate for the first that really contains</span>
01706     <span class="comment">//  the top level and first mid level, and first entry buffer</span>
01707     <span class="comment">//</span>
01708     <span class="comment">//  Take care of the special case where the [0][0] index is really</span>
01709     <span class="comment">//  allocated up front, and we only need to examine [0][1] to see if</span>
01710     <span class="comment">//  anything special needs to be deallocated, followed by [0][3], [0][5],</span>
01711     <span class="comment">//  up to and including [0][255]</span>
01712     <span class="comment">//</span>
01713 
01714     <span class="keywordflow">for</span> (j = 1; j &lt; 256; j += 2) {
01715 
01716         <span class="keywordflow">if</span> (HandleTable-&gt;Table[0][j] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01717 
01718             <span class="keywordflow">break</span>;
01719         }
01720 
01721         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( HandleTable-&gt;Table[0][j] );
01722 
01723         <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01724 
01725             <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Process,
01726                                PagedPool,
01727                                2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a>) * 256 );
01728         }
01729     }
01730 
01731     <span class="comment">//</span>
01732     <span class="comment">//  Now that we've handle the special case we can do the rest of the table</span>
01733     <span class="comment">//  starting with index [1][0], [1][2], ... [1][254], [2][0], [2][2] ...</span>
01734     <span class="comment">//  up to and including [255][254]</span>
01735     <span class="comment">//</span>
01736 
01737     <span class="keywordflow">for</span> (i = 1; i &lt; 256; i += 1) {
01738 
01739         <span class="keywordflow">if</span> (HandleTable-&gt;Table[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01740 
01741             <span class="keywordflow">break</span>;
01742         }
01743 
01744         <span class="keywordflow">for</span> (j = 0; j &lt; 256; j += 2) {
01745 
01746             <span class="keywordflow">if</span> (HandleTable-&gt;Table[i][j] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01747 
01748                 <span class="keywordflow">break</span>;
01749             }
01750 
01751             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( HandleTable-&gt;Table[i][j] );
01752 
01753             <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01754 
01755                 <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Process,
01756                                    PagedPool,
01757                                    2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a>) * 256 );
01758             }
01759         }
01760     }
01761 
01762     <span class="comment">//</span>
01763     <span class="comment">//  Now that we've deallocated the handle table entry buffer we can</span>
01764     <span class="comment">//  deallocate the additional mid level buffers.  Note that that these</span>
01765     <span class="comment">//  start at index [0][1] and were allocated four a time from pool.</span>
01766     <span class="comment">//</span>
01767 
01768     <span class="keywordflow">for</span> (i = 1; i &lt; 256; i += 4) {
01769 
01770         <span class="keywordflow">if</span> (HandleTable-&gt;Table[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01771 
01772             <span class="keywordflow">break</span>;
01773         }
01774 
01775         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( HandleTable-&gt;Table[i] );
01776 
01777         <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01778 
01779             <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Process,
01780                                PagedPool,
01781                                4 * <span class="keyword">sizeof</span>(ULONG_PTR) * 256 );
01782         }
01783     }
01784 
01785     <span class="comment">//</span>
01786     <span class="comment">//  Now deallocate the original handle table buffer used to store</span>
01787     <span class="comment">//  the top level, first mid level, and first table entry buffer</span>
01788     <span class="comment">//</span>
01789 
01790     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( HandleTable-&gt;Table );
01791 
01792     <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01793 
01794         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Process,
01795                            PagedPool,
01796                            (2 * <span class="keyword">sizeof</span>(ULONG_PTR) * 256) + (<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a>) * 256) );
01797     }
01798 
01799     <span class="comment">//</span>
01800     <span class="comment">//  Finally deallocate the handle table itself</span>
01801     <span class="comment">//</span>
01802 
01803     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( HandleTable );
01804 
01805     <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01806 
01807         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Process,
01808                            NonPagedPool,
01809                            <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">HANDLE_TABLE</a>) );
01810     }
01811 
01812     <span class="comment">//</span>
01813     <span class="comment">//  And return to our caller</span>
01814     <span class="comment">//</span>
01815 
01816     <span class="keywordflow">return</span>;
01817 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ex/handle.c::ExpFreeHandleTableEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExpFreeHandleTableEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d8/struct__EXHANDLE.html">EXHANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTableEntry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l02127">2127</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01227">ExDestroyHandle()</a>, and <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00765">ExDupHandleTable()</a>.
<p>
<pre class="fragment"><div>02136                    :
02137 
02138     This worker routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle table entry to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free
02139     list <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table.
02140 
02141     Note: The caller must have already locked <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table
02142 
02143 Arguments:
02144 
02145     HandleTable - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent handle table being modified
02146 
02147     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry being freed
02148 
02149     HandleTableEntry - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table entry being freed
02150 
02151 Return Value:
02152 
02153     None.
02154 
02155 --*/
02156 
02157 {
02158     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02159 
02160     <span class="comment">//</span>
02161     <span class="comment">//  A free is simply a push onto the free table entry stack, or in the</span>
02162     <span class="comment">//  debug case we'll sometimes just float the entry to catch apps who</span>
02163     <span class="comment">//  reuse a recycled handle value.</span>
02164     <span class="comment">//</span>
02165 
02166 <span class="preprocessor">#if DBG</span>
02167 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ExReuseHandles) {
02168 <span class="preprocessor">#endif //DBG</span>
02169 <span class="preprocessor"></span>
02170         HandleTableEntry-&gt;NextFreeTableEntry = HandleTable-&gt;FirstFreeTableEntry;
02171         HandleTable-&gt;FirstFreeTableEntry = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.Index;
02172 
02173 <span class="preprocessor">#if DBG</span>
02174 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
02175 
02176         HandleTableEntry-&gt;NextFreeTableEntry = 0;
02177     }
02178 <span class="preprocessor">#endif //DBG</span>
02179 <span class="preprocessor"></span>
02180     <span class="comment">//</span>
02181     <span class="comment">//  And then update our handle count before returning to our caller</span>
02182     <span class="comment">//</span>
02183 
02184     HandleTable-&gt;HandleCount -= 1;
02185 
02186     <span class="keywordflow">return</span>;
02187 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ex/handle.c::ExpLookupHandleTableEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ExpLookupHandleTableEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d8/struct__EXHANDLE.html">EXHANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l02195">2195</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01315">ExChangeHandle()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01227">ExDestroyHandle()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00560">ExDestroyHandleTable()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00765">ExDupHandleTable()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00634">ExEnumHandleTable()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01403">ExMapHandleToPointer()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01825">ExpAllocateHandleTableEntry()</a>, and <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00984">ExSnapShotHandleTables()</a>.
<p>
<pre class="fragment"><div>02202                    :
02203 
02204     This routine looks up and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table entry <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02205     specified handle value.
02206 
02207 Arguments:
02208 
02209     HandleTable - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table being queried
02210 
02211     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle value being queried
02212 
02213 Return Value:
02214 
02215     Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding table entry <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input
02216         handle.  Or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invalid (i.e., too large
02217         <span class="keywordflow">for</span> the tables current allocation.
02218 
02219 --*/
02220 
02221 {
02222     ULONG i,j,k,l;
02223 
02224     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02225 
02226     <span class="comment">//</span>
02227     <span class="comment">//  Decode the handle index into its separate table indicies</span>
02228     <span class="comment">//</span>
02229 
02230     l = (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.Index &gt;&gt; 24) &amp; 255;
02231     i = (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.Index &gt;&gt; 16) &amp; 255;
02232     j = (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.Index &gt;&gt; 8)  &amp; 255;
02233     k = (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.Index)       &amp; 255;
02234 
02235     <span class="comment">//</span>
02236     <span class="comment">//  The last bits should be 0 into a valid handle. If a function calls</span>
02237     <span class="comment">//  ExpLookupHandleTableEntry for a kernel handle, it should decode the handle</span>
02238     <span class="comment">//  before.</span>
02239     <span class="comment">//</span>
02240 
02241     if ( l != 0 ) {
02242         
02243         <span class="comment">//</span>
02244         <span class="comment">//  Invalid handle. Return a NULL table entry.</span>
02245         <span class="comment">//</span>
02246 
02247         <span class="keywordflow">return</span> NULL;
02248     }
02249 
02250     <span class="comment">//</span>
02251     <span class="comment">//  Check that the top level table is present</span>
02252     <span class="comment">//</span>
02253 
02254     <span class="keywordflow">if</span> (HandleTable-&gt;Table[i] == NULL) {
02255 
02256         <span class="keywordflow">return</span> NULL;
02257     }
02258 
02259     <span class="comment">//</span>
02260     <span class="comment">//  Check that the mid level table is present</span>
02261     <span class="comment">//</span>
02262 
02263     <span class="keywordflow">if</span> (HandleTable-&gt;Table[i][j] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02264 
02265         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02266     }
02267 
02268     <span class="comment">//</span>
02269     <span class="comment">//  Return a pointer to the table entry</span>
02270     <span class="comment">//</span>
02271 
02272     <span class="keywordflow">return</span> &amp;(HandleTable-&gt;Table[i][j][k]);
02273 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="ex/handle.c::ExRemoveHandleTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID ExRemoveHandleTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>HandleTable</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00501">501</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00036">HandleTableListLock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00560">ExDestroyHandleTable()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>, and <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00112">RtlpInitializeHandleTableForAtomTable()</a>.
<p>
<pre class="fragment"><div>00507                    :
00508 
00509     This function removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified exhandle table from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of
00510     exhandle tables.  Used by PS and ATOM packages to make sure their handle
00511     tables are not in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list enumerated by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d8/ex_2handle_8c.html#a21">ExSnapShotHandleTables</a>
00512     routine and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> !handle debugger <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>.
00513 
00514 Arguments:
00515 
00516     HandleTable - Supplies a pointer to a handle table
00517 
00518 Return Value:
00519 
00520     None.
00521 
00522 --*/
00523 
00524 {
00525     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00526 
00527     <span class="comment">//</span>
00528     <span class="comment">//  First, acquire the global handle table lock</span>
00529     <span class="comment">//</span>
00530 
00531     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00532     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( &amp;HandleTableListLock, TRUE );
00533 
00534     <span class="comment">//</span>
00535     <span class="comment">//  Remove the handle table from the handle table list.  This routine is</span>
00536     <span class="comment">//  written so that multiple calls to remove a handle table will not</span>
00537     <span class="comment">//  corrupt the system.</span>
00538     <span class="comment">//</span>
00539 
00540     <span class="keywordflow">if</span> (!IsListEmpty( &amp;HandleTable-&gt;HandleTableList )) {
00541 
00542         RemoveEntryList( &amp;HandleTable-&gt;HandleTableList );
00543 
00544         InitializeListHead( &amp;HandleTable-&gt;HandleTableList );
00545     }
00546 
00547     <span class="comment">//</span>
00548     <span class="comment">//  Now release the global lock and return to our caller</span>
00549     <span class="comment">//</span>
00550 
00551     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;HandleTableListLock );
00552     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00553 
00554     <span class="keywordflow">return</span>;
00555 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="ex/handle.c::ExSnapShotHandleTables" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS ExSnapShotHandleTables           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a142">PEX_SNAPSHOT_HANDLE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SnapShotHandleEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSYSTEM_HANDLE_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RequiredLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00984">984</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00240">ExLockHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00146">ExLockHandleTableExclusive()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l02195">ExpLookupHandleTableEntry()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00336">ExUnlockHandleTableEntry()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00209">ExUnlockHandleTableExclusive()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00037">HandleTableListHead</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00036">HandleTableListLock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l02737">_HANDLE_TABLE::UniqueProcessId</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00745">ObGetHandleInformation()</a>.
<p>
<pre class="fragment"><div>00993                    :
00994 
00995     This function visits and invokes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified callback <span class="keywordflow">for</span> every valid
00996     handle that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can find off of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table.
00997 
00998 Arguments:
00999 
01000     SnapShotHandleEntry - Supplies a pointer to a function to call <span class="keywordflow">for</span>
01001         each valid handle we encounter.
01002 
01003     HandleInformation - Supplies a handle information structure to
01004         be filled in <span class="keywordflow">for</span> each handle table we encounter.  This routine
01005         fills in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle count, but relies on a callback to fill in
01006         entry info fields.
01007 
01008     Length - Supplies a parameter <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback.  In reality <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01009         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> total size, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> Information buffer.
01010 
01011     RequiredLength - Supplies a parameter <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback.  In reality
01012         <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">final</span> size in bytes used to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
01013         information.
01014 
01015 Return Value:
01016 
01017     The last <span class="keywordflow">return</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback
01018 
01019 --*/
01020 
01021 {
01022     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01023     PSYSTEM_HANDLE_TABLE_ENTRY_INFO HandleEntryInfo;
01024     PLIST_ENTRY NextEntry;
01025     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable;
01026     <a class="code" href="../../d7/d8/struct__EXHANDLE.html">EXHANDLE</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01027     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> HandleTableEntry;
01028 
01029     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01030 
01031     <span class="comment">//</span>
01032     <span class="comment">//  Lock the handle table list exclusive and traverse the list of handle</span>
01033     <span class="comment">//  tables.</span>
01034     <span class="comment">//</span>
01035 
01036     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01037 
01038     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01039     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( &amp;HandleTableListLock, TRUE );
01040 
01041     <span class="keywordflow">try</span> {
01042 
01043         <span class="comment">//</span>
01044         <span class="comment">//  Setup the output buffer pointer that the callback will maintain</span>
01045         <span class="comment">//</span>
01046 
01047         HandleEntryInfo = &amp;HandleInformation-&gt;Handles[0];
01048 
01049         <span class="comment">//</span>
01050         <span class="comment">//  Zero out the handle count</span>
01051         <span class="comment">//</span>
01052 
01053         HandleInformation-&gt;NumberOfHandles = 0;
01054 
01055         <span class="comment">//</span>
01056         <span class="comment">//  Iterate through all the handle tables in the system.</span>
01057         <span class="comment">//</span>
01058 
01059         <span class="keywordflow">for</span> (NextEntry = <a class="code" href="../../d0/d8/ex_2handle_8c.html#a2">HandleTableListHead</a>.Flink;
01060              NextEntry != &amp;<a class="code" href="../../d0/d8/ex_2handle_8c.html#a2">HandleTableListHead</a>;
01061              NextEntry = NextEntry-&gt;Flink) {
01062 
01063             <span class="comment">//</span>
01064             <span class="comment">//  Get the address of the next handle table, lock the handle</span>
01065             <span class="comment">//  table exclusive, and scan the list of handle entries.</span>
01066             <span class="comment">//</span>
01067 
01068             HandleTable = CONTAINING_RECORD( NextEntry,
01069                                              <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">HANDLE_TABLE</a>,
01070                                              HandleTableList );
01071 
01072             <a class="code" href="../../d5/d8/ex_8h.html#a284">ExLockHandleTableExclusive</a>( HandleTable );
01073 
01074             <span class="keywordflow">try</span> {
01075 
01076                 <span class="comment">//  Iterate through the handle table and for each handle that</span>
01077                 <span class="comment">//  is allocated we'll invoke the call back.  Note that this</span>
01078                 <span class="comment">//  loop exits when we get a null handle table entry.  We know</span>
01079                 <span class="comment">//  there will be no more possible entries after the first null</span>
01080                 <span class="comment">//  one is encountered because we allocate memory of the</span>
01081                 <span class="comment">//  handles in a dense fashion</span>
01082                 <span class="comment">//</span>
01083 
01084                 <span class="keywordflow">for</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.Index = 0, <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.TagBits = 0;
01085                      (HandleTableEntry = <a class="code" href="../../d0/d8/ex_2handle_8c.html#a8">ExpLookupHandleTableEntry</a>( HandleTable, Handle )) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01086                      <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.Index += 1) {
01087 
01088                     <span class="comment">//</span>
01089                     <span class="comment">//  Only do the callback if the entry is not free</span>
01090                     <span class="comment">//</span>
01091 
01092                     <span class="keywordflow">if</span> (HandleTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01093 
01094                         <span class="comment">//</span>
01095                         <span class="comment">//  Increment the handle count information in the</span>
01096                         <span class="comment">//  information buffer</span>
01097                         <span class="comment">//</span>
01098 
01099                         HandleInformation-&gt;NumberOfHandles += 1;
01100 
01101                         <span class="comment">//</span>
01102                         <span class="comment">//  Lock the handle table entry because we're about to</span>
01103                         <span class="comment">//  give it to the callback function, then release the</span>
01104                         <span class="comment">//  entry right after the call back.</span>
01105                         <span class="comment">//</span>
01106 
01107                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a287">ExLockHandleTableEntry</a>( HandleTable, HandleTableEntry )) {
01108 
01109                             <span class="keywordflow">try</span> {
01110 
01111                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (*SnapShotHandleEntry)( &amp;HandleEntryInfo,
01112                                                                  HandleTable-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o4">UniqueProcessId</a>,
01113                                                                  HandleTableEntry,
01114                                                                  <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>.GenericHandleOverlay,
01115                                                                  Length,
01116                                                                  RequiredLength );
01117 
01118                             } finally {
01119 
01120                                 <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( HandleTable, HandleTableEntry );
01121                             }
01122                         }
01123                     }
01124                 }
01125 
01126             } finally {
01127 
01128                 <a class="code" href="../../d5/d8/ex_8h.html#a286">ExUnlockHandleTableExclusive</a>( HandleTable );
01129             }
01130         }
01131 
01132     } finally {
01133 
01134         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;HandleTableListLock );
01135         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01136     }
01137 
01138     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01139 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="ex/handle.c::ExUnlockHandleTableEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID ExUnlockHandleTableEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTableEntry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00336">336</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00034">EVENT_INCREMENT</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00044">EXHANDLE_TABLE_ENTRY_LOCK_BIT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02771">_HANDLE_TABLE::HandleContentionEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00413">_KEVENT::Header</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00167">KePulseEvent()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00263">_DISPATCHER_HEADER::WaitListHead</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01315">ExChangeHandle()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01144">ExCreateHandle()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00765">ExDupHandleTable()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00634">ExEnumHandleTable()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00984">ExSnapShotHandleTables()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">NtWaitForMultipleObjects()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l01319">ObQueryObjectAuditingByHandle()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00094">PsLookupProcessByProcessId()</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00027">PsLookupProcessThreadByCid()</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00146">PsLookupThreadByThreadId()</a>, and <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00152">RtlpAtomMapAtomToHandleEntry()</a>.
<p>
<pre class="fragment"><div>00343                    :
00344 
00345     This routine unlocks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle table entry.  After <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00346     unlocked <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sign bit will be clear.
00347 
00348 Arguments:
00349 
00350     HandleTable - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry being unlocked.
00351 
00352     HandleTableEntry - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table entry being unlocked.
00353 
00354 Return Value:
00355 
00356     None.
00357 
00358 --*/
00359 
00360 {
00361     LONG_PTR NewValue;
00362     LONG_PTR CurrentValue;
00363 
00364     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00365 
00366     <span class="comment">//</span>
00367     <span class="comment">//  This routine does not need to loop and attempt the unlock opeation more</span>
00368     <span class="comment">//  than once because by defintion the caller has the entry already locked</span>
00369     <span class="comment">//  and no one can be changing the value without the lock.</span>
00370     <span class="comment">//</span>
00371     <span class="comment">//  So we'll read in the current value, check that the entry is really</span>
00372     <span class="comment">//  locked, clear the lock bit and make sure the compare exchange worked.</span>
00373     <span class="comment">//</span>
00374 
00375     NewValue = CurrentValue = *((<span class="keyword">volatile</span> LONG_PTR *)&amp;HandleTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a>);
00376 
00377     <span class="keywordflow">if</span> (CurrentValue &gt;= 0) {
00378 
00379         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( BAD_EXHANDLE, __LINE__, (LONG_PTR)HandleTableEntry, NewValue, CurrentValue );
00380     }
00381 
00382     NewValue &amp;= ~<a class="code" href="../../d0/d8/ex_2handle_8c.html#a0">EXHANDLE_TABLE_ENTRY_LOCK_BIT</a>;
00383 
00384     <span class="keywordflow">if</span> ((LONG_PTR)(InterlockedCompareExchangePointer( &amp;HandleTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a>,
00385                                                      (PVOID)NewValue,
00386                                                      (PVOID)CurrentValue )) != CurrentValue) {
00387 
00388         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( BAD_EXHANDLE, __LINE__, (LONG_PTR)HandleTableEntry, NewValue, CurrentValue );
00389     }
00390 
00391     <span class="comment">//</span>
00392     <span class="comment">//  Now that we've unlocked the event we'll see if there are any waiters</span>
00393     <span class="comment">//  for handle table entries in this table.  If there are any waiters</span>
00394     <span class="comment">//  we'll wake them up and let them try for their lock again.</span>
00395     <span class="comment">//</span>
00396     <span class="comment">//  Note that this will wake up all the waiters for all locks in a given</span>
00397     <span class="comment">//  handle table.   Each waiter also has a short time out so the worse</span>
00398     <span class="comment">//  that can happen is that we might wake someone too early.  It can also</span>
00399     <span class="comment">//  be that no one is waiting for this exact lock, or the one waiting for</span>
00400     <span class="comment">//  it has already gone off, but these are all benign.</span>
00401     <span class="comment">//</span>
00402     <span class="comment">//  **** Note that we're testing for a non empty event header wait list</span>
00403     <span class="comment">//       head.  This is sort of behind the back and a better design</span>
00404     <span class="comment">//       would get a macro from ke.h to do the test, but this will</span>
00405     <span class="comment">//       suffice for now.  This is actually an unsafe test in that it</span>
00406     <span class="comment">//       might return the wrong answer, but even then we are willing to</span>
00407     <span class="comment">//       live with it because any waiters will wake up in 10ms anyway and</span>
00408     <span class="comment">//       any extra call to pulse the event without waiters is benign.</span>
00409     <span class="comment">//</span>
00410 
00411     <span class="keywordflow">if</span> (!IsListEmpty( &amp;HandleTable-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o9">HandleContentionEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a> )) {
00412 
00413         <a class="code" href="../../d2/d8/eventobj_8c.html#a5">KePulseEvent</a>( &amp;HandleTable-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o9">HandleContentionEvent</a>, EVENT_INCREMENT, FALSE );
00414     }
00415 
00416     <span class="keywordflow">return</span>;
00417 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="ex/handle.c::ExUnlockHandleTableExclusive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID ExUnlockHandleTableExclusive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>HandleTable</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00209">209</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02755">_HANDLE_TABLE::HandleTableLock</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01144">ExCreateHandle()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01227">ExDestroyHandle()</a>, and <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00984">ExSnapShotHandleTables()</a>.
<p>
<pre class="fragment"><div>00215                    :
00216 
00217     This routine unlocks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle table from exclusive access.
00218 
00219 Arguments:
00220 
00221     HandleTable - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table being unlocked.
00222 
00223 Return Value:
00224 
00225     None.
00226 
00227 --*/
00228 
00229 {
00230     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00231 
00232     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;HandleTable-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o7">HandleTableLock</a> );
00233 
00234     <span class="keywordflow">return</span>;
00235 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="ex/handle.c::ExUnlockHandleTableShared" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID ExUnlockHandleTableShared           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>HandleTable</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00178">178</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02755">_HANDLE_TABLE::HandleTableLock</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00765">ExDupHandleTable()</a>, and <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00634">ExEnumHandleTable()</a>.
<p>
<pre class="fragment"><div>00184                    :
00185 
00186     This routine unlocks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle table from shared access.
00187 
00188 Arguments:
00189 
00190     HandleTable - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table being unlocked.
00191 
00192 Return Value:
00193 
00194     None.
00195 
00196 --*/
00197 
00198 {
00199     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00200 
00201     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;HandleTable-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o7">HandleTableLock</a> );
00202 
00203     <span class="keywordflow">return</span>;
00204 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a3" doxytag="ex/handle.c::Ex10Milliseconds" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LARGE_INTEGER <a class="el" href="../../d0/d8/ex_2handle_8c.html#a3">Ex10Milliseconds</a> = {(ULONG)(-10 * 1000 * 10), -1}          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00051">51</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00240">ExLockHandleTableEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ex/handle.c::HandleTableListHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d0/d8/ex_2handle_8c.html#a2">HandleTableListHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00037">37</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00422">ExInitializeHandleTablePackage()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01475">ExpAllocateHandleTable()</a>, and <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00984">ExSnapShotHandleTables()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ex/handle.c::HandleTableListLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="el" href="../../d0/d8/ex_2handle_8c.html#a1">HandleTableListLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00036">36</a> of file <a class="el" href="../../d1/d7/ex_2handle_8c-source.html">ex/handle.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00422">ExInitializeHandleTablePackage()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01475">ExpAllocateHandleTable()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00501">ExRemoveHandleTable()</a>, and <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00984">ExSnapShotHandleTables()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:01 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
