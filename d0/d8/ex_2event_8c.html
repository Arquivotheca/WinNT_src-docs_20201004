<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ex/event.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>event.c File Reference</h1><code>#include "<a class="el" href="../../d5/d9/exp_8h-source.html">exp.h</a>"</code><br>

<p>
<a href="../../d1/d7/ex_2event_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2event_8c.html#a3">ExpEventInitialization</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2event_8c.html#a4">NtClearEvent</a> (IN HANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a4">EventHandle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a> (OUT PHANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a4">EventHandle</a>, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a> OPTIONAL, IN EVENT_TYPE EventType, IN BOOLEAN InitialState)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2event_8c.html#a6">NtOpenEvent</a> (OUT PHANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a4">EventHandle</a>, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2event_8c.html#a7">NtPulseEvent</a> (IN HANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a4">EventHandle</a>, OUT PLONG PreviousState OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2event_8c.html#a8">NtQueryEvent</a> (IN HANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a4">EventHandle</a>, IN EVENT_INFORMATION_CLASS EventInformationClass, OUT PVOID EventInformation, IN ULONG EventInformationLength, OUT PULONG ReturnLength OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2event_8c.html#a9">NtResetEvent</a> (IN HANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a4">EventHandle</a>, OUT PLONG PreviousState OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a> (IN HANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a4">EventHandle</a>, OUT PLONG PreviousState OPTIONAL)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2event_8c.html#a0">ExpEventBoost</a> = EVENT_INCREMENT</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2event_8c.html#a1">ExEventObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>GENERIC_MAPPING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/ex_2event_8c.html#a2">ExpEventMapping</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="ex/event.c::ExpEventInitialization" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ExpEventInitialization           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00067">67</a> of file <a class="el" href="../../d1/d7/ex_2event_8c-source.html">ex/event.c</a>.
<p>
References <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00045">ExpEventMapping</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00072                    :
00073 
00074     This function creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor at system
00075     initialization and stores <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor
00076     in global storage.
00077 
00078 Arguments:
00079 
00080     None.
00081 
00082 Return Value:
00083 
00084     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00085     successfully initialized. Otherwise a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00086 
00087 --*/
00088 
00089 {
00090 
00091     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
00092     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00093     UNICODE_STRING TypeName;
00094 
00095     <span class="comment">//</span>
00096     <span class="comment">// Initialize string descriptor.</span>
00097     <span class="comment">//</span>
00098 
00099     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;TypeName, L<span class="stringliteral">"Event"</span>);
00100 
00101     <span class="comment">//</span>
00102     <span class="comment">// Create event object type descriptor.</span>
00103     <span class="comment">//</span>
00104 
00105     RtlZeroMemory(&amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>(ObjectTypeInitializer));
00106     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o0">Length</a> = <span class="keyword">sizeof</span>(ObjectTypeInitializer);
00107     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = OBJ_OPENLINK;
00108     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a2">ExpEventMapping</a>;
00109     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
00110     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>);
00111     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = EVENT_ALL_ACCESS;
00112     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;TypeName,
00113                                 &amp;ObjectTypeInitializer,
00114                                 (PSECURITY_DESCRIPTOR)NULL,
00115                                 &amp;ExEventObjectType);
00116 
00117     <span class="comment">//</span>
00118     <span class="comment">// If the event object type descriptor was successfully created, then</span>
00119     <span class="comment">// return a value of TRUE. Otherwise return a value of FALSE.</span>
00120     <span class="comment">//</span>
00121 
00122     <span class="keywordflow">return</span> (BOOLEAN)(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00123 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ex/event.c::NtClearEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtClearEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>EventHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00126">126</a> of file <a class="el" href="../../d1/d7/ex_2event_8c-source.html">ex/event.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00030">EventHandle</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l00050">_ExitWindowsEx()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l00401">FlushAllButKeys()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l00485">FlushInputBuffer()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l00959">ReadInputBuffer()</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l00184">ReinitializeInputBuffer()</a>.
<p>
<pre class="fragment"><div>00132                    :
00133 
00134     This function sets an event object to a Not-Signaled state.
00135 
00136 Arguments:
00137 
00138     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> - Supplies a handle to an event object.
00139 
00140 Return Value:
00141 
00142     TBS
00143 
00144 --*/
00145 
00146 {
00147 
00148     PVOID <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00149     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00150 
00151     <span class="comment">//</span>
00152     <span class="comment">// Reference event object by handle.</span>
00153     <span class="comment">//</span>
00154 
00155     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(EventHandle,
00156                                        EVENT_MODIFY_STATE,
00157                                        ExEventObjectType,
00158                                        KeGetPreviousMode(),
00159                                        &amp;Event,
00160                                        NULL);
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">// If the reference was successful, then set the state of the event</span>
00164     <span class="comment">// object to Not-Signaled and dereference event object.</span>
00165     <span class="comment">//</span>
00166 
00167     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00168         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)Event);
00169         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Event);
00170     }
00171 
00172     <span class="comment">//</span>
00173     <span class="comment">// Return service status.</span>
00174     <span class="comment">//</span>
00175 
00176     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00177 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ex/event.c::NtCreateEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtCreateEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>EventHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN EVENT_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>EventType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>InitialState</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00180">180</a> of file <a class="el" href="../../d1/d7/ex_2event_8c-source.html">ex/event.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00030">EventHandle</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">AllocateConsole()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l00103">CreateInputBuffer()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01165">CtLnpQos()</a>, <a class="el" href="../../d9/d9/ctlpcqos_8c-source.html#l01187">CtLpcQos()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00626">InitWindowsStuff()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00080">main()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00881">NotificationThread()</a>, <a class="el" href="../../d7/d3/icamsg_8c-source.html#l00167">RemoteMessageThread()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">RtlInitializeCriticalSectionAndSpinCount()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01412">RtlpCreateCriticalSectionSem()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05575">RtlpGetWaitEvent()</a>, <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00552">RtlShutdownLpcServer()</a>, <a class="el" href="../../d0/d5/seinit_8c-source.html#l00184">SepInitializationPhase1()</a>, <a class="el" href="../../d9/d3/ntcon_2client_2getset_8c-source.html#l01356">SetConsoleCP()</a>, <a class="el" href="../../d7/d3/client_2private_8c-source.html#l00225">SetConsoleDisplayMode()</a>, <a class="el" href="../../d1/d0/ctseacc_8c-source.html#l00636">TestSeAccess()</a>, <a class="el" href="../../d1/d0/ctseacc_8c-source.html#l00213">TestSeNamedCreate()</a>, <a class="el" href="../../d1/d0/ctseacc_8c-source.html#l00129">TestSeUnnamedCreate()</a>, and <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00192">UserServerDllInitialization()</a>.
<p>
<pre class="fragment"><div>00190                    :
00191 
00192     This function creates an event object, sets <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> initial state to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00193     specified value, and opens a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00194     desired access.
00195 
00196 Arguments:
00197 
00198     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> - Supplies a pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00199         event object handle.
00200 
00201     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired types of access <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event object.
00202 
00203     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies a pointer to an object attributes structure.
00204 
00205     EventType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event (autoclearing or notification).
00206 
00207     InitialState - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event object.
00208 
00209 Return Value:
00210 
00211     TBS
00212 
00213 --*/
00214 
00215 {
00216 
00217     PVOID <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00218     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00219     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00220     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00221 
00222     <span class="comment">//</span>
00223     <span class="comment">// Establish an exception handler, probe the output handle address, and</span>
00224     <span class="comment">// attempt to create an event object. If the probe fails, then return the</span>
00225     <span class="comment">// exception code as the service status. Otherwise return the status value</span>
00226     <span class="comment">// returned by the object insertion routine.</span>
00227     <span class="comment">//</span>
00228 
00229     <span class="keywordflow">try</span> {
00230 
00231         <span class="comment">//</span>
00232         <span class="comment">// Get previous processor mode and probe output handle address if</span>
00233         <span class="comment">// necessary.</span>
00234         <span class="comment">//</span>
00235 
00236         PreviousMode = KeGetPreviousMode();
00237         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00238             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(EventHandle);
00239         }
00240 
00241         <span class="comment">//</span>
00242         <span class="comment">// Check argument validity.</span>
00243         <span class="comment">//</span>
00244 
00245         <span class="keywordflow">if</span> ((EventType != NotificationEvent) &amp;&amp; (EventType != SynchronizationEvent)) {
00246             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00247         }
00248 
00249         <span class="comment">//</span>
00250         <span class="comment">// Allocate event object.</span>
00251         <span class="comment">//</span>
00252 
00253         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(PreviousMode,
00254                                 ExEventObjectType,
00255                                 ObjectAttributes,
00256                                 PreviousMode,
00257                                 NULL,
00258                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>),
00259                                 0,
00260                                 0,
00261                                 (PVOID *)&amp;Event);
00262 
00263         <span class="comment">//</span>
00264         <span class="comment">// If the event object was successfully allocated, then initialize the</span>
00265         <span class="comment">// event object and attempt to insert the event object in the current</span>
00266         <span class="comment">// process' handle table.</span>
00267         <span class="comment">//</span>
00268 
00269         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00270             <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)Event, EventType, InitialState);
00271             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(Event,
00272                                     NULL,
00273                                     DesiredAccess,
00274                                     0,
00275                                     (PVOID *)NULL,
00276                                     &amp;Handle);
00277 
00278             <span class="comment">//</span>
00279             <span class="comment">// If the event object was successfully inserted in the current</span>
00280             <span class="comment">// process' handle table, then attempt to write the event object</span>
00281             <span class="comment">// handle value. If the write attempt fails, then do not report</span>
00282             <span class="comment">// an error. When the caller attempts to access the handle value,</span>
00283             <span class="comment">// an access violation will occur.</span>
00284             <span class="comment">//</span>
00285 
00286             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00287                 <span class="keywordflow">try</span> {
00288                     *<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00289 
00290                 } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00291                 }
00292             }
00293         }
00294 
00295     <span class="comment">//</span>
00296     <span class="comment">// If an exception occurs during the probe of the output handle address,</span>
00297     <span class="comment">// then always handle the exception and return the exception code as the</span>
00298     <span class="comment">// status value.</span>
00299     <span class="comment">//</span>
00300 
00301     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00302         <span class="keywordflow">return</span> GetExceptionCode();
00303     }
00304 
00305     <span class="comment">//</span>
00306     <span class="comment">// Return service status.</span>
00307     <span class="comment">//</span>
00308 
00309     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00310 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ex/event.c::NtOpenEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtOpenEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>EventHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00313">313</a> of file <a class="el" href="../../d1/d7/ex_2event_8c-source.html">ex/event.c</a>.
<p>
References <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00030">EventHandle</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00321                    :
00322 
00323     This function opens a handle to an event object with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00324     desired access.
00325 
00326 Arguments:
00327 
00328     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> - Supplies a pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00329         event object handle.
00330 
00331     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired types of access <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event object.
00332 
00333     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies a pointer to an object attributes structure.
00334 
00335 Return Value:
00336 
00337     TBS
00338 
00339 --*/
00340 
00341 {
00342 
00343     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00344     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00345     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00346 
00347 
00348     <span class="comment">//</span>
00349     <span class="comment">// Establish an exception handler, probe the output handle address, and</span>
00350     <span class="comment">// attempt to open the event object. If the probe fails, then return the</span>
00351     <span class="comment">// exception code as the service status. Otherwise return the status value</span>
00352     <span class="comment">// returned by the object open routine.</span>
00353     <span class="comment">//</span>
00354 
00355     <span class="keywordflow">try</span> {
00356 
00357         <span class="comment">//</span>
00358         <span class="comment">// Get previous processor mode and probe output handle address</span>
00359         <span class="comment">// if necessary.</span>
00360         <span class="comment">//</span>
00361 
00362         PreviousMode = KeGetPreviousMode();
00363         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00364             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(EventHandle);
00365         }
00366 
00367         <span class="comment">//</span>
00368         <span class="comment">// Open handle to the event object with the specified desired access.</span>
00369         <span class="comment">//</span>
00370 
00371         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(ObjectAttributes,
00372                                     ExEventObjectType,
00373                                     PreviousMode,
00374                                     NULL,
00375                                     DesiredAccess,
00376                                     NULL,
00377                                     &amp;Handle);
00378 
00379         <span class="comment">//</span>
00380         <span class="comment">// If the open was successful, then attempt to write the event object</span>
00381         <span class="comment">// handle value. If the write attempt fails, then do not report an</span>
00382         <span class="comment">// error. When the caller attempts to access the handle value, an</span>
00383         <span class="comment">// access violation will occur.</span>
00384         <span class="comment">//</span>
00385 
00386         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00387             <span class="keywordflow">try</span> {
00388                 *<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00389 
00390             } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00391             }
00392         }
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">// If an exception occurs during the probe of the output event handle,</span>
00396     <span class="comment">// then always handle the exception and return the exception code as the</span>
00397     <span class="comment">// status value.</span>
00398     <span class="comment">//</span>
00399 
00400     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00401         <span class="keywordflow">return</span> GetExceptionCode();
00402     }
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// Return service status.</span>
00406     <span class="comment">//</span>
00407 
00408     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00409 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ex/event.c::NtPulseEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtPulseEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>EventHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONG PreviousState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00412">412</a> of file <a class="el" href="../../d1/d7/ex_2event_8c-source.html">ex/event.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00030">EventHandle</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00032">ExpEventBoost</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00167">KePulseEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01632">ProbeForWriteLong</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00419                    :
00420 
00421     This function sets an event object to a Signaled state, attempts to
00422     satisfy as many waits as possible, and then resets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00423     event object to Not-Signaled.
00424 
00425 Arguments:
00426 
00427     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> - Supplies a handle to an event object.
00428 
00429     PreviousState - Supplies an optional pointer to a variable that will
00430         receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event object.
00431 
00432 Return Value:
00433 
00434     TBS
00435 
00436 --*/
00437 
00438 {
00439 
00440     PVOID <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00441     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00442     LONG State;
00443     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00444 
00445     <span class="comment">//</span>
00446     <span class="comment">// Establish an exception handler, probe the previous state address if</span>
00447     <span class="comment">// specified, reference the event object, and pulse the event object. If</span>
00448     <span class="comment">// the probe fails, then return the exception code as the service status.</span>
00449     <span class="comment">// Otherwise return the status value returned by the reference object by</span>
00450     <span class="comment">// handle routine.</span>
00451     <span class="comment">//</span>
00452 
00453     <span class="keywordflow">try</span> {
00454 
00455         <span class="comment">//</span>
00456         <span class="comment">// Get previous processor mode and probe previous state address</span>
00457         <span class="comment">// if necessary.</span>
00458         <span class="comment">//</span>
00459 
00460         PreviousMode = KeGetPreviousMode();
00461         <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; (ARGUMENT_PRESENT(PreviousState))) {
00462             <a class="code" href="../../d5/d8/ex_8h.html#a39">ProbeForWriteLong</a>(PreviousState);
00463         }
00464 
00465         <span class="comment">//</span>
00466         <span class="comment">// Reference event object by handle.</span>
00467         <span class="comment">//</span>
00468 
00469         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(EventHandle,
00470                                            EVENT_MODIFY_STATE,
00471                                            ExEventObjectType,
00472                                            PreviousMode,
00473                                            &amp;Event,
00474                                            NULL);
00475 
00476         <span class="comment">//</span>
00477         <span class="comment">// If the reference was successful, then pulse the event object,</span>
00478         <span class="comment">// dereference event object, and write the previous state value if</span>
00479         <span class="comment">// specified. If the write of the previous state fails, then do not</span>
00480         <span class="comment">// report an error. When the caller attempts to access the previous</span>
00481         <span class="comment">// state value, an access violation will occur.</span>
00482         <span class="comment">//</span>
00483 
00484         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00485             State = <a class="code" href="../../d2/d8/eventobj_8c.html#a5">KePulseEvent</a>((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)Event, ExpEventBoost, FALSE);
00486             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Event);
00487             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00488                 <span class="keywordflow">try</span> {
00489                     *PreviousState = State;
00490 
00491                 } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00492                 }
00493             }
00494         }
00495 
00496     <span class="comment">//</span>
00497     <span class="comment">// If an exception occurs during the probe of the previous state, then</span>
00498     <span class="comment">// always handle the exception and return the exception code as the status</span>
00499     <span class="comment">// value.</span>
00500     <span class="comment">//</span>
00501 
00502     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00503         <span class="keywordflow">return</span> GetExceptionCode();
00504     }
00505 
00506     <span class="comment">//</span>
00507     <span class="comment">// Return service status.</span>
00508     <span class="comment">//</span>
00509 
00510     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00511 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ex/event.c::NtQueryEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>EventHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN EVENT_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>EventInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>EventInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>EventInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ReturnLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00514">514</a> of file <a class="el" href="../../d1/d7/ex_2event_8c-source.html">ex/event.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00030">EventHandle</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00253">KeReadStateEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00524                    :
00525 
00526     This function queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of an event object and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00527     requested information in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified record structure.
00528 
00529 Arguments:
00530 
00531     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> - Supplies a handle to an event object.
00532 
00533     EventInformationClass - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">class </span>of information being requested.
00534 
00535     EventInformation - Supplies a pointer to a record that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00536         requested information.
00537 
00538     EventInformationLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> record that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
00539         receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information.
00540 
00541     ReturnLength - Supplies an optional pointer to a variable that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
00542         receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual length of information that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00543 
00544 Return Value:
00545 
00546     TBS
00547 
00548 --*/
00549 
00550 {
00551 
00552     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00553     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00554     LONG State;
00555     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00556     EVENT_TYPE EventType;
00557 
00558     <span class="comment">//</span>
00559     <span class="comment">// Check argument validity.</span>
00560     <span class="comment">//</span>
00561 
00562     <span class="keywordflow">if</span> (EventInformationClass != EventBasicInformation) {
00563         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00564     }
00565 
00566     <span class="keywordflow">if</span> (EventInformationLength != <span class="keyword">sizeof</span>(EVENT_BASIC_INFORMATION)) {
00567         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00568     }
00569 
00570     <span class="comment">//</span>
00571     <span class="comment">// Establish an exception handler, probe the output arguments, reference</span>
00572     <span class="comment">// the event object, and return the specified information. If the probe</span>
00573     <span class="comment">// fails, then return the exception code as the service status. Otherwise</span>
00574     <span class="comment">// return the status value returned by the reference object by handle</span>
00575     <span class="comment">// routine.</span>
00576     <span class="comment">//</span>
00577 
00578     <span class="keywordflow">try</span> {
00579 
00580         <span class="comment">//</span>
00581         <span class="comment">// Get previous processor mode and probe output arguments if necessary.</span>
00582         <span class="comment">//</span>
00583 
00584         PreviousMode = KeGetPreviousMode();
00585         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00586             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(EventInformation,
00587                           <span class="keyword">sizeof</span>(EVENT_BASIC_INFORMATION),
00588                           <span class="keyword">sizeof</span>(ULONG));
00589 
00590             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00591                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
00592             }
00593         }
00594 
00595         <span class="comment">//</span>
00596         <span class="comment">// Reference event object by handle.</span>
00597         <span class="comment">//</span>
00598 
00599         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(EventHandle,
00600                                            EVENT_QUERY_STATE,
00601                                            ExEventObjectType,
00602                                            PreviousMode,
00603                                            (PVOID *)&amp;Event,
00604                                            NULL);
00605 
00606         <span class="comment">//</span>
00607         <span class="comment">// If the reference was successful, then read the current state of</span>
00608         <span class="comment">// the event object, deference event object, fill in the information</span>
00609         <span class="comment">// structure, and return the length of the information structure if</span>
00610         <span class="comment">// specified. If the write of the event information or the return</span>
00611         <span class="comment">// length fails, then do not report an error. When the caller accesses</span>
00612         <span class="comment">// the information structure or length an access violation will occur.</span>
00613         <span class="comment">//</span>
00614 
00615         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00616             State = <a class="code" href="../../d2/d8/eventobj_8c.html#a6">KeReadStateEvent</a>(Event);
00617             EventType = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Header.Type;
00618             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Event);
00619             <span class="keywordflow">try</span> {
00620                 ((PEVENT_BASIC_INFORMATION)EventInformation)-&gt;EventType = EventType;
00621                 ((PEVENT_BASIC_INFORMATION)EventInformation)-&gt;EventState = State;
00622                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00623                     *ReturnLength = <span class="keyword">sizeof</span>(EVENT_BASIC_INFORMATION);
00624                 }
00625 
00626             } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00627             }
00628         }
00629 
00630     <span class="comment">//</span>
00631     <span class="comment">// If an exception occurs during the probe of the output arguments, then</span>
00632     <span class="comment">// always handle the exception and return the exception code as the status</span>
00633     <span class="comment">// value.</span>
00634     <span class="comment">//</span>
00635 
00636     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00637         <span class="keywordflow">return</span> GetExceptionCode();
00638     }
00639 
00640     <span class="comment">//</span>
00641     <span class="comment">// Return service status.</span>
00642     <span class="comment">//</span>
00643 
00644     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00645 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ex/event.c::NtResetEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtResetEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>EventHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONG PreviousState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00648">648</a> of file <a class="el" href="../../d1/d7/ex_2event_8c-source.html">ex/event.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00030">EventHandle</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00285">KeResetEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01632">ProbeForWriteLong</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00881">NotificationThread()</a>, and <a class="el" href="../../d7/d3/icamsg_8c-source.html#l00167">RemoteMessageThread()</a>.
<p>
<pre class="fragment"><div>00655                    :
00656 
00657     This function sets an event object to a Not-Signaled state.
00658 
00659 Arguments:
00660 
00661     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> - Supplies a handle to an event object.
00662 
00663     PreviousState - Supplies an optional pointer to a variable that will
00664         receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event object.
00665 
00666 Return Value:
00667 
00668     TBS
00669 
00670 --*/
00671 
00672 {
00673 
00674     PVOID <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00675     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00676     LONG State;
00677     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00678 
00679     <span class="comment">//</span>
00680     <span class="comment">// Establish an exception handler, probe the previous state address if</span>
00681     <span class="comment">// specified, reference the event object, and reset the event object. If</span>
00682     <span class="comment">// the probe fails, then return the exception code as the service status.</span>
00683     <span class="comment">// Otherwise return the status value returned by the reference object by</span>
00684     <span class="comment">// handle routine.</span>
00685     <span class="comment">//</span>
00686 
00687     <span class="keywordflow">try</span> {
00688 
00689         <span class="comment">//</span>
00690         <span class="comment">// Get previous processor mode and probe previous state address</span>
00691         <span class="comment">// if necessary.</span>
00692         <span class="comment">//</span>
00693 
00694         PreviousMode = KeGetPreviousMode();
00695         <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; (ARGUMENT_PRESENT(PreviousState))) {
00696             <a class="code" href="../../d5/d8/ex_8h.html#a39">ProbeForWriteLong</a>(PreviousState);
00697         }
00698 
00699         <span class="comment">//</span>
00700         <span class="comment">// Reference event object by handle.</span>
00701         <span class="comment">//</span>
00702 
00703         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(EventHandle,
00704                                            EVENT_MODIFY_STATE,
00705                                            ExEventObjectType,
00706                                            PreviousMode,
00707                                            &amp;Event,
00708                                            NULL);
00709 
00710         <span class="comment">//</span>
00711         <span class="comment">// If the reference was successful, then set the state of the event</span>
00712         <span class="comment">// object to Not-Signaled, dereference event object, and write the</span>
00713         <span class="comment">// previous state value if specified. If the write of the previous</span>
00714         <span class="comment">// state fails, then do not report an error. When the caller attempts</span>
00715         <span class="comment">// to access the previous state value, an access violation will occur.</span>
00716         <span class="comment">//</span>
00717 
00718         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00719             State = <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)Event);
00720             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Event);
00721             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00722                 <span class="keywordflow">try</span> {
00723                     *PreviousState = State;
00724 
00725                 } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00726                 }
00727             }
00728         }
00729 
00730     <span class="comment">//</span>
00731     <span class="comment">// If an exception occurs during the probe of the previous state, then</span>
00732     <span class="comment">// always handle the exception and return the exception code as the status</span>
00733     <span class="comment">// value.</span>
00734     <span class="comment">//</span>
00735 
00736     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00737         <span class="keywordflow">return</span> GetExceptionCode();
00738     }
00739 
00740     <span class="comment">//</span>
00741     <span class="comment">// Return service status.</span>
00742     <span class="comment">//</span>
00743 
00744     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00745 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ex/event.c::NtSetEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>EventHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONG PreviousState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00748">748</a> of file <a class="el" href="../../d1/d7/ex_2event_8c-source.html">ex/event.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00030">EventHandle</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00032">ExpEventBoost</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00056">_OBJECT_HANDLE_INFORMATION::HandleAttributes</a>, <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00925">KeRaiseUserException()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01632">ProbeForWriteLong</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l00050">_ExitWindowsEx()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04423">AbortCreateConsole()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04375">CleanupConsoleMessages()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01946">ConsoleInputThread()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04700">ConsoleWindowProc()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l00834">CreateWindowsWindow()</a>, <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00517">DbgSsHandleKmApiMsg()</a>, <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00737">DbgSspSrvApiLoop()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01110">FreeCon()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01410">PrependInputBuffer()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>, <a class="el" href="../../d7/d3/icamsg_8c-source.html#l00068">RemoteDoMessage()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00310">ReplyHardError()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04271">RtlpDeleteTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05462">RtlpDeleteTimerQueueComplete()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03573">RtlpDeleteWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03397">RtlpDeregisterWait()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01675">RtlpUnWaitCriticalSection()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00553">SepClientInitialize()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l01121">SrvLogon()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01229">SrvSetConsoleCP()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00853">SrvSetConsoleDisplayMode()</a>, <a class="el" href="../../d1/d0/ctseacc_8c-source.html#l00636">TestSeAccess()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l00818">W32WinStationTerminate()</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01522">WriteInputBuffer()</a>.
<p>
<pre class="fragment"><div>00755                    :
00756 
00757     This function sets an event object to a Signaled state and attempts to
00758     satisfy as many waits as possible.
00759 
00760 Arguments:
00761 
00762     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> - Supplies a handle to an event object.
00763 
00764     PreviousState - Supplies an optional pointer to a variable that will
00765         receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event object.
00766 
00767 Return Value:
00768 
00769     TBS
00770 
00771 --*/
00772 
00773 {
00774 
00775     PVOID <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00776     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00777     LONG State;
00778     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00779 <span class="preprocessor">#if DBG</span>
00780 <span class="preprocessor"></span>
00781     <span class="comment">//</span>
00782     <span class="comment">// Sneaky trick here to catch sleazy apps (csrss) that erroneously call</span>
00783     <span class="comment">// NtSetEvent on an event that happens to be somebody else's </span>
00784     <span class="comment">// critical section. Only allow setting a protected handle if the low</span>
00785     <span class="comment">// bit of PreviousState is set.</span>
00786     <span class="comment">//</span>
00787     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInfo;
00788 
00789 <span class="preprocessor">#endif</span>
00790 <span class="preprocessor"></span>
00791     <span class="comment">//</span>
00792     <span class="comment">// Establish an exception handler, probe the previous state address if</span>
00793     <span class="comment">// specified, reference the event object, and set the event object. If</span>
00794     <span class="comment">// the probe fails, then return the exception code as the service status.</span>
00795     <span class="comment">// Otherwise return the status value returned by the reference object by</span>
00796     <span class="comment">// handle routine.</span>
00797     <span class="comment">//</span>
00798 
00799     <span class="keywordflow">try</span> {
00800 
00801         <span class="comment">//</span>
00802         <span class="comment">// Get previous processor mode and probe previous state address</span>
00803         <span class="comment">// if necessary.</span>
00804         <span class="comment">//</span>
00805 
00806         PreviousMode = KeGetPreviousMode();
00807 <span class="preprocessor">#if DBG</span>
00808 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; 
00809             (ARGUMENT_PRESENT(PreviousState)) &amp;&amp;
00810             (PreviousState != (PLONG)1)) {
00811             <a class="code" href="../../d5/d8/ex_8h.html#a39">ProbeForWriteLong</a>(PreviousState);
00812         }
00813 <span class="preprocessor">#else</span>
00814 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; (ARGUMENT_PRESENT(PreviousState))) {
00815             <a class="code" href="../../d5/d8/ex_8h.html#a39">ProbeForWriteLong</a>(PreviousState);
00816         }
00817 <span class="preprocessor">#endif</span>
00818 <span class="preprocessor"></span>
00819         <span class="comment">//</span>
00820         <span class="comment">// Reference event object by handle.</span>
00821         <span class="comment">//</span>
00822 
00823 <span class="preprocessor">#if DBG</span>
00824 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(EventHandle,
00825                                            EVENT_MODIFY_STATE,
00826                                            ExEventObjectType,
00827                                            PreviousMode,
00828                                            &amp;Event,
00829                                            &amp;HandleInfo);
00830         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00831 
00832             <span class="keywordflow">if</span> ((HandleInfo.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o0">HandleAttributes</a> &amp; 1) &amp;&amp;
00833                 (PreviousState != (PLONG)1)) {
00834 <span class="preprocessor">#if 0</span>
00835 <span class="preprocessor"></span>                <span class="comment">//</span>
00836                 <span class="comment">// This is a protected handle. If the low bit of PreviousState is NOT set,</span>
00837                 <span class="comment">// break into the debugger</span>
00838                 <span class="comment">//</span>
00839 
00840                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NtSetEvent: Illegal call to NtSetEvent on a protected handle\n"</span>);
00841                 DbgBreakPoint();
00842                 PreviousState = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00843 <span class="preprocessor">#endif</span>
00844 <span class="preprocessor"></span>            }
00845         } <span class="keywordflow">else</span> {
00846             <span class="keywordflow">if</span> ((KeGetPreviousMode() != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
00847                 (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00848                 ((<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_CLOSE_EXCEPTIONS) ||
00849                  (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
00850 
00851                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a13">KeRaiseUserException</a>(STATUS_INVALID_HANDLE);
00852 
00853             }
00854         }
00855 <span class="preprocessor">#else</span>
00856 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(EventHandle,
00857                                            EVENT_MODIFY_STATE,
00858                                            ExEventObjectType,
00859                                            PreviousMode,
00860                                            &amp;Event,
00861                                            NULL);
00862 <span class="preprocessor">#endif</span>
00863 <span class="preprocessor"></span>
00864         <span class="comment">//</span>
00865         <span class="comment">// If the reference was successful, then set the event object to the</span>
00866         <span class="comment">// Signaled state, dereference event object, and write the previous</span>
00867         <span class="comment">// state value if specified. If the write of the previous state fails,</span>
00868         <span class="comment">// then do not report an error. When the caller attempts to access the</span>
00869         <span class="comment">// previous state value, an access violation will occur.</span>
00870         <span class="comment">//</span>
00871 
00872         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00873             State = <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)Event, ExpEventBoost, FALSE);
00874             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Event);
00875             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00876                 <span class="keywordflow">try</span> {
00877                     *PreviousState = State;
00878 
00879                 } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00880                 }
00881             }
00882         }
00883 
00884     <span class="comment">//</span>
00885     <span class="comment">// If an exception occurs during the probe of the previous state, then</span>
00886     <span class="comment">// always handle the exception and return the exception code as the status</span>
00887     <span class="comment">// value.</span>
00888     <span class="comment">//</span>
00889 
00890     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00891         <span class="keywordflow">return</span> GetExceptionCode();
00892     }
00893 
00894     <span class="comment">//</span>
00895     <span class="comment">// Return service status.</span>
00896     <span class="comment">//</span>
00897 
00898     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00899 }
}
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="ex/event.c::ExEventObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d4/d1/userk_8h.html#a786">ExEventObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00038">38</a> of file <a class="el" href="../../d1/d7/ex_2event_8c-source.html">ex/event.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="ex/event.c::ExpEventBoost" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d8/ex_2event_8c.html#a0">ExpEventBoost</a> = EVENT_INCREMENT          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00032">32</a> of file <a class="el" href="../../d1/d7/ex_2event_8c-source.html">ex/event.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00412">NtPulseEvent()</a>, and <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00748">NtSetEvent()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ex/event.c::ExpEventMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> GENERIC_MAPPING <a class="el" href="../../d0/d8/ex_2event_8c.html#a2">ExpEventMapping</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    STANDARD_RIGHTS_READ |
        EVENT_QUERY_STATE,
    STANDARD_RIGHTS_WRITE |
        EVENT_MODIFY_STATE,
    STANDARD_RIGHTS_EXECUTE |
        SYNCHRONIZE,
    EVENT_ALL_ACCESS
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00045">45</a> of file <a class="el" href="../../d1/d7/ex_2event_8c-source.html">ex/event.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00067">ExpEventInitialization()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
