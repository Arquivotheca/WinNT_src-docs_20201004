<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dir.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dir.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>

<p>
<a href="../../d1/d7/dir_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/dir_8c.html#a0">BuildQueryDirectoryIrp</a> (IN HANDLE FileHandle, IN HANDLE Event OPTIONAL, IN PIO_APC_ROUTINE ApcRoutine OPTIONAL, IN PVOID ApcContext OPTIONAL, OUT PIO_STATUS_BLOCK IoStatusBlock, OUT PVOID FileInformation, IN ULONG Length, IN FILE_INFORMATION_CLASS FileInformationClass, IN BOOLEAN ReturnSingleEntry, IN PUNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a> OPTIONAL, IN BOOLEAN RestartScan, IN UCHAR MinorFunction, OUT BOOLEAN *SynchronousIo, OUT <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *DeviceObject, OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> *<a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, OUT <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> *FileObject, OUT <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> *RequestorMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/dir_8c.html#a1">NtQueryDirectoryFile</a> (IN HANDLE FileHandle, IN HANDLE Event OPTIONAL, IN PIO_APC_ROUTINE ApcRoutine OPTIONAL, IN PVOID ApcContext OPTIONAL, OUT PIO_STATUS_BLOCK IoStatusBlock, OUT PVOID FileInformation, IN ULONG Length, IN FILE_INFORMATION_CLASS FileInformationClass, IN BOOLEAN ReturnSingleEntry, IN PUNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a> OPTIONAL, IN BOOLEAN RestartScan)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/dir_8c.html#a2">NtNotifyChangeDirectoryFile</a> (IN HANDLE FileHandle, IN HANDLE Event OPTIONAL, IN PIO_APC_ROUTINE ApcRoutine OPTIONAL, IN PVOID ApcContext OPTIONAL, OUT PIO_STATUS_BLOCK IoStatusBlock, OUT PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG Length, IN ULONG CompletionFilter, IN BOOLEAN <a class="el" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="dir.c::BuildQueryDirectoryIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS BuildQueryDirectoryIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE Event&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_APC_ROUTINE ApcRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID ApcContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN FILE_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnSingleEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartScan</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>MinorFunction</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT BOOLEAN *&nbsp;</td>
          <td class="mdname" nowrap> <em>SynchronousIo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">57</a> of file <a class="el" href="../../d1/d7/dir_8c-source.html">dir.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01154">DO_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01156">DO_DIRECT_IO</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00127">ExAllocatePoolWithQuota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02030">_IO_STACK_LOCATION::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00768">IopApcRoutinePresent</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01934">IopExceptionCleanup()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00460">IopQuerySetAlignmentRequirement</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01564">IRP_DEFER_IO_COMPLETION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01556">IRP_INPUT_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00067">IRP_MJ_DIRECTORY_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00103">IRP_MN_QUERY_DIRECTORY</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01417">ProbeAndReadUnicodeString</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01518">ProbeForWriteIoStatusEx</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01896">SL_RESTART_SCAN</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01897">SL_RETURN_SINGLE_ENTRY</a>, <a class="el" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/dir_8c-source.html#l00682">NtQueryDirectoryFile()</a>.
<p>
<pre class="fragment"><div>00079                    :
00080 
00081     This service operates on a directory <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> or OLE container specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00082     FileHandle parameter.  The service returns information about files in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00083     directory or embeddings and streams in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> container specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00084     handle.  The ReturnSingleEntry parameter specifies that <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> a single entry
00085     should be returned rather than filling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.  The actual number of
00086     files whose information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned, <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> smallest of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00087 
00088         o  One entry, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ReturnSingleEntry parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
00089 
00090         o  The number of entries whose information fits into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00091            buffer.
00092 
00093         o  The number of entries that exist.
00094 
00095         o  One entry <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> optional <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified.
00096 
00097     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> optional <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> information
00098     that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> that single entries, <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> exists.  Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00099     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name may not specify any wildcard characters according to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> naming
00100     conventions of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system.  The ReturnSingleEntry parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00101     simply ignored.
00102 
00103     The information that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> obtained about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entries in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory or OLE
00104     container <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileInformationClass parameter.  Legal values are
00105     hard coded based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MinorFunction.
00106 
00107 Arguments:
00108 
00109     FileHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> or OLE container <span class="keywordflow">for</span>
00110         which information should be returned.
00111 
00112     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - Supplies an optional event to be set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Signaled state when
00113         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete.
00114 
00115     ApcRoutine - Supplies an optional APC routine to be executed when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00116         query <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete.
00117 
00118     ApcContext - Supplies a context parameter to be passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ApcRoutine,
00119         <span class="keywordflow">if</span> an ApcRoutine was specified.
00120 
00121     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
00122 
00123     FileInformation - Supplies a buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information
00124         returned about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory.
00125 
00126     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileInformation buffer.
00127 
00128     FileInformationClass - Specfies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
00129         returned about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> files in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified directory or OLE container.
00130 
00131     ReturnSingleEntry - Supplies a BOOLEAN value that, <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, indicates that
00132         <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> a single entry should be returned.
00133 
00134     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> - Optionally supplies a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified directory
00135         or OLE container.
00136 
00137     RestartScan - Supplies a BOOLEAN value that, <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00138         scan should be restarted from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning.  This parameter must be
00139         set to <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first time <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked.
00140 
00141     MinorFunction - <a class="code" href="../../d0/d5/io_8h.html#a44">IRP_MN_QUERY_DIRECTORY</a> or IRP_MN_QUERY_OLE_DIRECTORY
00142 
00143     <a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a> - pointer to returned BOOLEAN; <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> synchronous I/O
00144 
00145     DeviceObject - pointer to returned pointer to device object
00146 
00147     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - pointer to returned pointer to device object
00148 
00149     FileObject - pointer to returned pointer to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object
00150 
00151     RequestorMode - pointer to returned requestor mode
00152 
00153 Return Value:
00154 
00155     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> STATUS_SUCCESS <span class="keywordflow">if</span> a valid irp was created <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00156     query operation.
00157 
00158 --*/
00159 
00160 {
00161     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00162     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00163     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00164     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00165     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> eventObject = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00166     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00167     PCHAR auxiliaryBuffer = (PCHAR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00168     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00169     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl;
00170 
00171     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00172 
00173     <span class="comment">//</span>
00174     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00175     <span class="comment">//</span>
00176 
00177     requestorMode = KeGetPreviousMode();
00178     *RequestorMode = requestorMode;
00179 
00180     <span class="keywordflow">try</span> {
00181 
00182         <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00183 
00184             ULONG operationlength = 0;  <span class="comment">// assume invalid</span>
00185 
00186             <span class="comment">//</span>
00187             <span class="comment">// The caller's access mode is not kernel so probe and validate</span>
00188             <span class="comment">// each of the arguments as necessary.  If any failures occur,</span>
00189             <span class="comment">// the condition handler will be invoked to handle them.  It</span>
00190             <span class="comment">// will simply cleanup and return an access violation status</span>
00191             <span class="comment">// code back to the system service dispatcher.</span>
00192             <span class="comment">//</span>
00193 
00194             <span class="comment">//</span>
00195             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
00196             <span class="comment">//</span>
00197 
00198             <a class="code" href="../../d5/d8/ex_8h.html#a32">ProbeForWriteIoStatusEx</a>( IoStatusBlock, ApcRoutine);
00199 
00200             <span class="comment">//</span>
00201             <span class="comment">// Ensure that the FileInformationClass parameter is legal for</span>
00202             <span class="comment">// querying information about files in the directory or object.</span>
00203             <span class="comment">//</span>
00204 
00205             <span class="keywordflow">if</span> (FileInformationClass == FileDirectoryInformation) {
00206                 operationlength = <span class="keyword">sizeof</span>(FILE_DIRECTORY_INFORMATION);
00207             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (MinorFunction == <a class="code" href="../../d0/d5/io_8h.html#a44">IRP_MN_QUERY_DIRECTORY</a>) {
00208                 <span class="keywordflow">switch</span> (FileInformationClass)
00209                 {
00210                 <span class="keywordflow">case</span> FileFullDirectoryInformation:
00211                     operationlength = <span class="keyword">sizeof</span>(FILE_FULL_DIR_INFORMATION);
00212                     <span class="keywordflow">break</span>;
00213 
00214                 <span class="keywordflow">case</span> FileBothDirectoryInformation:
00215                     operationlength = <span class="keyword">sizeof</span>(FILE_BOTH_DIR_INFORMATION);
00216                     <span class="keywordflow">break</span>;
00217 
00218                 <span class="keywordflow">case</span> FileNamesInformation:
00219                     operationlength = <span class="keyword">sizeof</span>(FILE_NAMES_INFORMATION);
00220                     <span class="keywordflow">break</span>;
00221 
00222                 <span class="keywordflow">case</span> FileObjectIdInformation:
00223                     operationlength = <span class="keyword">sizeof</span>(FILE_OBJECTID_INFORMATION);
00224                     <span class="keywordflow">break</span>;
00225 
00226                 <span class="keywordflow">case</span> FileQuotaInformation:
00227                     operationlength = <span class="keyword">sizeof</span>(FILE_QUOTA_INFORMATION);
00228                     <span class="keywordflow">break</span>;
00229 
00230                 <span class="keywordflow">case</span> FileReparsePointInformation:
00231                     operationlength = <span class="keyword">sizeof</span>(FILE_REPARSE_POINT_INFORMATION);
00232                     <span class="keywordflow">break</span>;                    
00233                 }
00234             }
00235 
00236             <span class="comment">//</span>
00237             <span class="comment">// If the FileInformationClass parameter is illegal, fail now.</span>
00238             <span class="comment">//</span>
00239 
00240             <span class="keywordflow">if</span> (operationlength == 0) {
00241                 <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00242             }
00243 
00244             <span class="comment">//</span>
00245             <span class="comment">// Ensure that the caller's supplied buffer is at least large enough</span>
00246             <span class="comment">// to contain the fixed part of the structure required for this</span>
00247             <span class="comment">// query.</span>
00248             <span class="comment">//</span>
00249 
00250             <span class="keywordflow">if</span> (Length &lt; operationlength) {
00251                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00252             }
00253 
00254 
00255             <span class="comment">//</span>
00256             <span class="comment">// The FileInformation buffer must be writeable by the caller.</span>
00257             <span class="comment">//</span>
00258 
00259 <span class="preprocessor">#if defined(_X86_)</span>
00260 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FileInformation, Length, <span class="keyword">sizeof</span>( ULONG ) );
00261 <span class="preprocessor">#elif defined(_WIN64)</span>
00262 <span class="preprocessor"></span>
00263             <span class="comment">//</span>
00264             <span class="comment">// If we are a wow64 process, follow the X86 rules</span>
00265             <span class="comment">//</span>
00266 
00267             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process) {
00268                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FileInformation, Length, <span class="keyword">sizeof</span>( ULONG ) );
00269             } <span class="keywordflow">else</span> {
00270                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FileInformation,
00271                                Length,
00272                                IopQuerySetAlignmentRequirement[FileInformationClass] );
00273             }
00274             
00275 <span class="preprocessor">#else</span>
00276 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FileInformation,
00277                            Length,
00278                            IopQuerySetAlignmentRequirement[FileInformationClass] );
00279 <span class="preprocessor">#endif</span>
00280 <span class="preprocessor"></span>        }
00281 
00282         <span class="comment">//</span>
00283         <span class="comment">// If the optional FileName parameter was specified, then it must be</span>
00284         <span class="comment">// readable by the caller.  Capture the file name string in a pool</span>
00285         <span class="comment">// block.  Note that if an error occurs during the copy, the cleanup</span>
00286         <span class="comment">// code in the exception handler will deallocate the pool before</span>
00287         <span class="comment">// returning an access violation status.</span>
00288         <span class="comment">//</span>
00289 
00290         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( FileName )) {
00291 
00292             UNICODE_STRING fileName;
00293             PUNICODE_STRING nameBuffer;
00294 
00295             <span class="comment">//</span>
00296             <span class="comment">// Capture the string descriptor itself to ensure that the</span>
00297             <span class="comment">// string is readable by the caller without the caller being</span>
00298             <span class="comment">// able to change the memory while its being checked.</span>
00299             <span class="comment">//</span>
00300 
00301             <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00302                 fileName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>( FileName );
00303             } <span class="keywordflow">else</span> {
00304                 fileName = *<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00305             }
00306 
00307             <span class="keywordflow">if</span> (fileName.Length) {
00308 
00309                 <span class="comment">//</span>
00310                 <span class="comment">// The length of the string is non-zero, so probe the</span>
00311                 <span class="comment">// buffer described by the descriptor if the caller was</span>
00312                 <span class="comment">// not kernel mode.  Likewise, if the caller's mode was</span>
00313                 <span class="comment">// not kernel, then check the length of the name string</span>
00314                 <span class="comment">// to ensure that it is not too long.</span>
00315                 <span class="comment">//</span>
00316 
00317                 <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00318                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( fileName.Buffer,
00319                                   fileName.Length,
00320                                   <span class="keyword">sizeof</span>( UCHAR ) );
00321                     <span class="comment">//</span>
00322                     <span class="comment">// account for unicode</span>
00323                     <span class="comment">//</span>
00324 
00325                     <span class="keywordflow">if</span> (fileName.Length &gt; MAXIMUM_FILENAME_LENGTH&lt;&lt;1) {
00326                         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INVALID_PARAMETER );
00327                     }
00328                 }
00329 
00330                 <span class="comment">//</span>
00331                 <span class="comment">// Allocate an auxiliary buffer large enough to contain</span>
00332                 <span class="comment">// a file name descriptor and to hold the entire file</span>
00333                 <span class="comment">// name itself.  Copy the body of the string into the</span>
00334                 <span class="comment">// buffer.</span>
00335                 <span class="comment">//</span>
00336 
00337                 auxiliaryBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( NonPagedPool,
00338                                                            fileName.Length + <span class="keyword">sizeof</span>( UNICODE_STRING ) );
00339                 RtlCopyMemory( auxiliaryBuffer + <span class="keyword">sizeof</span>( UNICODE_STRING ),
00340                                fileName.Buffer,
00341                                fileName.Length );
00342 
00343                 <span class="comment">//</span>
00344                 <span class="comment">// Finally, build the Unicode string descriptor in the</span>
00345                 <span class="comment">// auxiliary buffer.</span>
00346                 <span class="comment">//</span>
00347 
00348                 nameBuffer = (PUNICODE_STRING) auxiliaryBuffer;
00349                 nameBuffer-&gt;Length = fileName.Length;
00350                 nameBuffer-&gt;MaximumLength = fileName.Length;
00351                 nameBuffer-&gt;Buffer = (PWSTR) (auxiliaryBuffer + <span class="keyword">sizeof</span>( UNICODE_STRING ) );
00352             }
00353         }
00354 
00355     } except(EXCEPTION_EXECUTE_HANDLER) {
00356 
00357         <span class="comment">//</span>
00358         <span class="comment">// An exception was incurred while probing the caller's buffers,</span>
00359         <span class="comment">// attempting to allocate a pool buffer, or while trying to copy</span>
00360         <span class="comment">// the caller's data.  Determine what happened, clean everything</span>
00361         <span class="comment">// up, and return an appropriate error status code.</span>
00362         <span class="comment">//</span>
00363 
00364         <span class="keywordflow">if</span> (auxiliaryBuffer) {
00365             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00366         }
00367 
00368 <span class="preprocessor">#if DBG</span>
00369 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (GetExceptionCode() == STATUS_DATATYPE_MISALIGNMENT) {
00370             DbgBreakPoint();
00371         }
00372 <span class="preprocessor">#endif // DBG</span>
00373 <span class="preprocessor"></span>
00374         <span class="keywordflow">return</span> GetExceptionCode();
00375     }
00376 
00377     <span class="comment">//</span>
00378     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
00379     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
00380     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
00381     <span class="comment">// access to the file, then it will fail.</span>
00382     <span class="comment">//</span>
00383 
00384     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
00385                                         FILE_LIST_DIRECTORY,
00386                                         IoFileObjectType,
00387                                         requestorMode,
00388                                         (PVOID *) &amp;fileObject,
00389                                         (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) NULL );
00390     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00391         <span class="keywordflow">if</span> (auxiliaryBuffer) {
00392             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00393         }
00394         <span class="keywordflow">return</span> status;
00395     }
00396     *FileObject = fileObject;
00397 
00398     <span class="comment">//</span>
00399     <span class="comment">// If this file has an I/O completion port associated w/it, then ensure</span>
00400     <span class="comment">// that the caller did not supply an APC routine, as the two are mutually</span>
00401     <span class="comment">// exclusive methods for I/O completion notification.</span>
00402     <span class="comment">//</span>
00403 
00404     <span class="keywordflow">if</span> (fileObject-&gt;CompletionContext &amp;&amp; <a class="code" href="../../d0/d6/iop_8h.html#a19">IopApcRoutinePresent</a>( ApcRoutine )) {
00405         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00406         <span class="keywordflow">if</span> (auxiliaryBuffer) {
00407             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00408         }
00409         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00410 
00411     }
00412 
00413     <span class="comment">//</span>
00414     <span class="comment">// Get the address of the event object and set the event to the Not-</span>
00415     <span class="comment">// Signaled state, if an event was specified.  Note here, too, that if</span>
00416     <span class="comment">// the handle does not refer to an event, or if the event cannot be</span>
00417     <span class="comment">// written, then the reference will fail.</span>
00418     <span class="comment">//</span>
00419 
00420     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Event )) {
00421         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( Event,
00422                                             EVENT_MODIFY_STATE,
00423                                             ExEventObjectType,
00424                                             requestorMode,
00425                                             (PVOID *) &amp;eventObject,
00426                                             (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) NULL );
00427         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00428             <span class="keywordflow">if</span> (auxiliaryBuffer) {
00429                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00430             }
00431             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00432             <span class="keywordflow">return</span> status;
00433         } <span class="keywordflow">else</span> {
00434             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( eventObject );
00435         }
00436     }
00437 
00438     <span class="comment">//</span>
00439     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
00440     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
00441     <span class="comment">// the current thread.</span>
00442     <span class="comment">//</span>
00443 
00444     <span class="keywordflow">if</span> (fileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00445 
00446         BOOLEAN interrupted;
00447 
00448         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
00449             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
00450                                                requestorMode,
00451                                                (BOOLEAN) ((fileObject-&gt;Flags &amp; FO_ALERTABLE_IO) != 0),
00452                                                &amp;interrupted );
00453             <span class="keywordflow">if</span> (interrupted) {
00454                 <span class="keywordflow">if</span> (auxiliaryBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00455                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00456                 }
00457                 <span class="keywordflow">if</span> (eventObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00458                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( eventObject );
00459                 }
00460                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00461                 <span class="keywordflow">return</span> status;
00462             }
00463         }
00464         *<a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00465     } <span class="keywordflow">else</span> {
00466         *<a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00467     }
00468 
00469     <span class="comment">//</span>
00470     <span class="comment">// Set the file object to the Not-Signaled state.</span>
00471     <span class="comment">//</span>
00472 
00473     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;Event );
00474 
00475     <span class="comment">//</span>
00476     <span class="comment">// Get the address of the target device object.</span>
00477     <span class="comment">//</span>
00478 
00479     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
00480     *DeviceObject = deviceObject;
00481 
00482     <span class="comment">//</span>
00483     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
00484     <span class="comment">// The allocation is performed with an exception handler in case the</span>
00485     <span class="comment">// caller does not have enough quota to allocate the packet.</span>
00486 
00487     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;StackSize, TRUE );
00488     <span class="keywordflow">if</span> (!irp) {
00489 
00490         <span class="comment">//</span>
00491         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
00492         <span class="comment">// error status code.</span>
00493         <span class="comment">//</span>
00494 
00495         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( fileObject, eventObject );
00496         <span class="keywordflow">if</span> (auxiliaryBuffer) {
00497             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00498         }
00499 
00500         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00501     }
00502     *<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = irp;
00503 
00504     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
00505     irp-&gt;Tail.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00506     irp-&gt;RequestorMode = requestorMode;
00507 
00508     <span class="comment">//</span>
00509     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
00510     <span class="comment">//</span>
00511 
00512     irp-&gt;UserEvent = eventObject;
00513     irp-&gt;UserIosb = IoStatusBlock;
00514     irp-&gt;Overlay.AsynchronousParameters.UserApcRoutine = ApcRoutine;
00515     irp-&gt;Overlay.AsynchronousParameters.UserApcContext = ApcContext;
00516 
00517     <span class="comment">//</span>
00518     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
00519     <span class="comment">// used to pass the original function codes and parameters.</span>
00520     <span class="comment">//</span>
00521 
00522     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00523     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a25">IRP_MJ_DIRECTORY_CONTROL</a>;
00524     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = MinorFunction;
00525     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
00526 
00527     <span class="comment">// Also, copy the caller's parameters to the service-specific portion of</span>
00528     <span class="comment">// the IRP.</span>
00529     <span class="comment">//</span>
00530 
00531     irp-&gt;Tail.Overlay.AuxiliaryBuffer = auxiliaryBuffer;
00532     irp-&gt;AssociatedIrp.SystemBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00533     irp-&gt;MdlAddress = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00534 
00535     <span class="comment">//</span>
00536     <span class="comment">// Now determine whether this driver expects to have data buffered to it</span>
00537     <span class="comment">// or whether it performs direct I/O.  This is based on the DO_BUFFERED_IO</span>
00538     <span class="comment">// flag in the device object.  If the flag is set, then a system buffer is</span>
00539     <span class="comment">// allocated and the driver's data will be copied into it.  Otherwise, a</span>
00540     <span class="comment">// Memory Descriptor List (MDL) is allocated and the caller's buffer is</span>
00541     <span class="comment">// locked down using it.</span>
00542     <span class="comment">//</span>
00543 
00544     <span class="keywordflow">if</span> (deviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a123">DO_BUFFERED_IO</a>) {
00545 
00546         <span class="comment">//</span>
00547         <span class="comment">// The device does not support direct I/O.  Allocate a system buffer</span>
00548         <span class="comment">// and specify that it should be deallocated on completion.  Also</span>
00549         <span class="comment">// indicate that this is an input operation so the data will be copied</span>
00550         <span class="comment">// into the caller's buffer.  This is done using an exception handler</span>
00551         <span class="comment">// that will perform cleanup if the operation fails.</span>
00552         <span class="comment">//</span>
00553 
00554         <span class="keywordflow">try</span> {
00555 
00556             <span class="comment">//</span>
00557             <span class="comment">// Allocate the intermediary system buffer from nonpaged pool and</span>
00558             <span class="comment">// charge quota for it.</span>
00559             <span class="comment">//</span>
00560 
00561             irp-&gt;AssociatedIrp.SystemBuffer =
00562                 <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( NonPagedPool, Length );
00563 
00564         } except(EXCEPTION_EXECUTE_HANDLER) {
00565 
00566             <span class="comment">//</span>
00567             <span class="comment">// An exception was incurred while either probing the caller's</span>
00568             <span class="comment">// buffer or allocate the system buffer.  Determine what actually</span>
00569             <span class="comment">// happened, clean everything up, and return an appropriate error</span>
00570             <span class="comment">// status code.</span>
00571             <span class="comment">//</span>
00572 
00573             <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
00574                                  irp,
00575                                  eventObject,
00576                                  (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
00577 
00578             <span class="keywordflow">if</span> (auxiliaryBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00579                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00580             }
00581 
00582             <span class="keywordflow">return</span> GetExceptionCode();
00583 
00584         }
00585 
00586         <span class="comment">//</span>
00587         <span class="comment">// Remember the address of the caller's buffer so the copy can take</span>
00588         <span class="comment">// place during I/O completion.  Also, set the flags so that the</span>
00589         <span class="comment">// completion code knows to do the copy and to deallocate the buffer.</span>
00590         <span class="comment">//</span>
00591 
00592         irp-&gt;UserBuffer = FileInformation;
00593         irp-&gt;Flags = (ULONG) (<a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> |
00594                               <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a> |
00595                               <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a>);
00596 
00597     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a125">DO_DIRECT_IO</a>) {
00598 
00599         <span class="comment">//</span>
00600         <span class="comment">// This is a direct I/O operation.  Allocate an MDL and invoke the</span>
00601         <span class="comment">// memory management routine to lock the buffer into memory.  This is</span>
00602         <span class="comment">// done using an exception handler that will perform cleanup if the</span>
00603         <span class="comment">// operation fails.</span>
00604         <span class="comment">//</span>
00605 
00606         mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00607 
00608         <span class="keywordflow">try</span> {
00609 
00610             <span class="comment">//</span>
00611             <span class="comment">// Allocate an MDL, charging quota for it, and hang it off of the</span>
00612             <span class="comment">// IRP.  Probe and lock the pages associated with the caller's</span>
00613             <span class="comment">// buffer for write access and fill in the MDL with the PFNs of</span>
00614             <span class="comment">// those pages.</span>
00615             <span class="comment">//</span>
00616 
00617             mdl = <a class="code" href="../../d4/d6/iosubs_8c.html#a19">IoAllocateMdl</a>( FileInformation, Length, FALSE, TRUE, irp );
00618             <span class="keywordflow">if</span> (mdl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00619                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00620             }
00621             <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a>( mdl, requestorMode, IoWriteAccess );
00622 
00623         } except(EXCEPTION_EXECUTE_HANDLER) {
00624 
00625             <span class="comment">//</span>
00626             <span class="comment">// An exception was incurred while either probing the caller's</span>
00627             <span class="comment">// buffer or allocating the MDL.  Determine what actually happened,</span>
00628             <span class="comment">// clean everything up, and return an appropriate error status code.</span>
00629             <span class="comment">//</span>
00630 
00631             <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
00632                                  irp,
00633                                  eventObject,
00634                                  (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
00635 
00636             <span class="keywordflow">if</span> (auxiliaryBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00637                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00638             }
00639 
00640             <span class="keywordflow">return</span> GetExceptionCode();
00641 
00642         }
00643 
00644     } <span class="keywordflow">else</span> {
00645 
00646         <span class="comment">//</span>
00647         <span class="comment">// Pass the address of the user's buffer so the driver has access to</span>
00648         <span class="comment">// it.  It is now the driver's responsibility to do everything.</span>
00649         <span class="comment">//</span>
00650 
00651         irp-&gt;UserBuffer = FileInformation;
00652 
00653     }
00654 
00655     <span class="comment">//</span>
00656     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
00657     <span class="comment">// IRP.</span>
00658     <span class="comment">//</span>
00659 
00660     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDirectory.Length = Length;
00661     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDirectory.FileInformationClass = FileInformationClass;
00662     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDirectory.FileIndex = 0;
00663     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDirectory.FileName = (PSTRING) auxiliaryBuffer;
00664     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> = 0;
00665     <span class="keywordflow">if</span> (RestartScan) {
00666         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a208">SL_RESTART_SCAN</a>;
00667     }
00668     <span class="keywordflow">if</span> (ReturnSingleEntry) {
00669         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a209">SL_RETURN_SINGLE_ENTRY</a>;
00670     }
00671 
00672     irp-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a186">IRP_DEFER_IO_COMPLETION</a>;
00673 
00674     <span class="comment">//</span>
00675     <span class="comment">// Return with everything set up for the caller to complete the I/O.</span>
00676     <span class="comment">//</span>
00677 
00678     <span class="keywordflow">return</span> STATUS_SUCCESS;
00679 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="dir.c::NtNotifyChangeDirectoryFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtNotifyChangeDirectoryFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE Event&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_APC_ROUTINE ApcRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID ApcContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionFilter</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WatchTree</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">821</a> of file <a class="el" href="../../d1/d7/dir_8c-source.html">dir.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01154">DO_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01156">DO_DIRECT_IO</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00127">ExAllocatePoolWithQuota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02030">_IO_STACK_LOCATION::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00768">IopApcRoutinePresent</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01934">IopExceptionCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01556">IRP_INPUT_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00067">IRP_MJ_DIRECTORY_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00104">IRP_MN_NOTIFY_CHANGE_DIRECTORY</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01518">ProbeForWriteIoStatusEx</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01904">SL_WATCH_TREE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00070">WatchTree</a>.
<p>
<pre class="fragment"><div>00835                    :
00836 
00837     This service monitors a directory <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> changes.  Once a change <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00838     <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileHandle parameter, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O
00839     operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> completed.
00840 
00841 Arguments:
00842 
00843     FileHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> whose EAs should be changed.
00844 
00845     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - Supplies an optional event to be set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Signaled state when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00846         change <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete.
00847 
00848     ApcRoutine - Supplies an optional APC routine to be executed when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> change
00849         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete.
00850 
00851     ApcContext - Supplies a context parameter to be passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ApcRoutine,
00852         <span class="keywordflow">if</span> an ApcRoutine was specified.
00853 
00854     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
00855 
00856     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Address of variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> names of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> files or
00857         directories that have changed since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last time that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service
00858         was invoked.
00859 
00860     Length - Length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output buffer.  On <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first call, <span class="keyword">this</span> parameter
00861         also serves as a guideline <span class="keywordflow">for</span> how large to make <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system's
00862         internal buffer.  Specifying a buffer length of zero causes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request
00863         to complete when changes are <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>, but no information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00864         changes are returned.
00865 
00866     CompletionFilter - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> types of changes to files or directories
00867         within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory that will complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O operation.
00868 
00869     <a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> BOOLEAN value that indicates whether or not changes to
00870         directories below <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory referred to by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileHandle
00871         parameter cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation to complete.
00872 
00873 Return Value:
00874 
00875     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> success <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was properly queued to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00876     I/O system.  Once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation completes, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation can
00877     be determined by examining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O status block.
00878 
00879 --*/
00880 
00881 {
00882     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00883     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00884     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00885     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00886     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> eventObject = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00887     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00888     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00889     BOOLEAN synchronousIo;
00890 
00891     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00892 
00893     <span class="comment">//</span>
00894     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00895     <span class="comment">//</span>
00896 
00897     requestorMode = KeGetPreviousMode();
00898 
00899     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00900 
00901         <span class="comment">//</span>
00902         <span class="comment">// The caller's access mode is user, so probe each of the arguments</span>
00903         <span class="comment">// and capture them as necessary.  If any failures occur, the condition</span>
00904         <span class="comment">// handler will be invoked to handle them.  It will simply cleanup and</span>
00905         <span class="comment">// return an access violation status code back to the system service</span>
00906         <span class="comment">// dispatcher.</span>
00907         <span class="comment">//</span>
00908 
00909         <span class="keywordflow">try</span> {
00910 
00911             <span class="comment">//</span>
00912             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
00913             <span class="comment">//</span>
00914 
00915             <a class="code" href="../../d5/d8/ex_8h.html#a32">ProbeForWriteIoStatusEx</a>( IoStatusBlock , ApcRoutine);
00916 
00917             <span class="comment">//</span>
00918             <span class="comment">// The Buffer parameter must be writeable by the caller.</span>
00919             <span class="comment">//</span>
00920 
00921             <span class="keywordflow">if</span> (Length != 0) {
00922                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( Buffer,
00923                                Length,
00924                                <span class="keyword">sizeof</span>( ULONG ) );
00925             }
00926 
00927         } except(EXCEPTION_EXECUTE_HANDLER) {
00928 
00929             <span class="comment">//</span>
00930             <span class="comment">// An exception was incurred probing the caller's I/O status</span>
00931             <span class="comment">// block.  Simply return the appropriate error status code.</span>
00932             <span class="comment">//</span>
00933 
00934             <span class="keywordflow">return</span> GetExceptionCode();
00935 
00936         }
00937 
00938         <span class="comment">//</span>
00939         <span class="comment">// The CompletionFilter parameter must not contain any values which</span>
00940         <span class="comment">// are illegal, nor may it not specifiy anything at all.  Likewise,</span>
00941         <span class="comment">// the caller must supply a non-null buffer.</span>
00942         <span class="comment">//</span>
00943 
00944         <span class="keywordflow">if</span> (((CompletionFilter &amp; ~FILE_NOTIFY_VALID_MASK) ||
00945             !CompletionFilter)) {
00946             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00947         }
00948 
00949     }
00950 
00951     <span class="comment">//</span>
00952     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
00953     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
00954     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
00955     <span class="comment">// access to the file, then it will fail.</span>
00956     <span class="comment">//</span>
00957 
00958     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
00959                                         FILE_LIST_DIRECTORY,
00960                                         IoFileObjectType,
00961                                         requestorMode,
00962                                         (PVOID *) &amp;fileObject,
00963                                         (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) NULL );
00964     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00965         <span class="keywordflow">return</span> status;
00966     }
00967 
00968     <span class="comment">//</span>
00969     <span class="comment">// If this file has an I/O completion port associated w/it, then ensure</span>
00970     <span class="comment">// that the caller did not supply an APC routine, as the two are mutually</span>
00971     <span class="comment">// exclusive methods for I/O completion notification.</span>
00972     <span class="comment">//</span>
00973 
00974     <span class="keywordflow">if</span> (fileObject-&gt;CompletionContext &amp;&amp; <a class="code" href="../../d0/d6/iop_8h.html#a19">IopApcRoutinePresent</a>( ApcRoutine )) {
00975         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00976         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00977     }
00978 
00979     <span class="comment">//</span>
00980     <span class="comment">// Get the address of the event object and set the event to the Not-</span>
00981     <span class="comment">// Signaled state, if an event was specified.  Note here too, that if</span>
00982     <span class="comment">// the handle does not refer to an event, or if the event cannot be</span>
00983     <span class="comment">// written, then the reference will fail.</span>
00984     <span class="comment">//</span>
00985 
00986     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Event )) {
00987         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( Event,
00988                                             EVENT_MODIFY_STATE,
00989                                             ExEventObjectType,
00990                                             requestorMode,
00991                                             (PVOID *) &amp;eventObject,
00992                                             (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) NULL );
00993         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00994             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00995             <span class="keywordflow">return</span> status;
00996         } <span class="keywordflow">else</span> {
00997             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( eventObject );
00998         }
00999     }
01000 
01001     <span class="comment">//</span>
01002     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
01003     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
01004     <span class="comment">// the current thread.</span>
01005     <span class="comment">//</span>
01006 
01007     <span class="keywordflow">if</span> (fileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
01008 
01009         BOOLEAN interrupted;
01010 
01011         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
01012             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
01013                                                requestorMode,
01014                                                (BOOLEAN) ((fileObject-&gt;Flags &amp; FO_ALERTABLE_IO) != 0),
01015                                                &amp;interrupted );
01016             <span class="keywordflow">if</span> (interrupted) {
01017                 <span class="keywordflow">if</span> (eventObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01018                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( eventObject );
01019                 }
01020                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01021                 <span class="keywordflow">return</span> status;
01022             }
01023         }
01024         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01025     } <span class="keywordflow">else</span> {
01026         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01027     }
01028 
01029     <span class="comment">//</span>
01030     <span class="comment">// Set the file object to the Not-Signaled state.</span>
01031     <span class="comment">//</span>
01032 
01033     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;Event );
01034 
01035     <span class="comment">//</span>
01036     <span class="comment">// Get the address of the target device object.</span>
01037     <span class="comment">//</span>
01038 
01039     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
01040 
01041     <span class="comment">//</span>
01042     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
01043     <span class="comment">// The allocation is performed with an exception handler in case the</span>
01044     <span class="comment">// caller does not have enough quota to allocate the packet.</span>
01045 
01046     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, TRUE );
01047     <span class="keywordflow">if</span> (!irp) {
01048 
01049         <span class="comment">//</span>
01050         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
01051         <span class="comment">// error status code.</span>
01052         <span class="comment">//</span>
01053 
01054         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( fileObject, eventObject );
01055 
01056         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01057     }
01058     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
01059     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01060     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = requestorMode;
01061 
01062     <span class="comment">//</span>
01063     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
01064     <span class="comment">//</span>
01065 
01066     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = eventObject;
01067     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = IoStatusBlock;
01068     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = ApcRoutine;
01069     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcContext = ApcContext;
01070 
01071     <span class="comment">//</span>
01072     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
01073     <span class="comment">// used to pass the original function codes and the parameters.</span>
01074     <span class="comment">//</span>
01075 
01076     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
01077     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a25">IRP_MJ_DIRECTORY_CONTROL</a>;
01078     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a45">IRP_MN_NOTIFY_CHANGE_DIRECTORY</a>;
01079     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
01080 
01081     <span class="comment">//</span>
01082     <span class="comment">// Now determine whether this device expects to have data buffered to it</span>
01083     <span class="comment">// or whether it performs direct I/O.  This is based on the DO_BUFFERED_IO</span>
01084     <span class="comment">// flag in the device object.  If the flag is set, then a system buffer is</span>
01085     <span class="comment">// allocated and the driver's data will be copied into it.  Otherwise, a</span>
01086     <span class="comment">// Memory Descriptor List (MDL) is allocated and the caller's buffer is</span>
01087     <span class="comment">// locked down using it.</span>
01088     <span class="comment">//</span>
01089 
01090     <span class="keywordflow">if</span> (Length != 0) {
01091 
01092         <span class="keywordflow">if</span> (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a123">DO_BUFFERED_IO</a>) {
01093 
01094             <span class="comment">//</span>
01095             <span class="comment">// The device does not support direct I/O.  Allocate a system</span>
01096             <span class="comment">// buffer and specify that it should be deallocated on completion.</span>
01097             <span class="comment">// Also indicate that this is an input operation so the data will</span>
01098             <span class="comment">// be copied into the caller's buffer.  This is done using an</span>
01099             <span class="comment">// exception handler that will perform cleanup if the operation</span>
01100             <span class="comment">// fails.</span>
01101             <span class="comment">//</span>
01102 
01103             <span class="keywordflow">try</span> {
01104 
01105                 <span class="comment">//</span>
01106                 <span class="comment">// Allocate the intermediary system buffer from nonpaged pool</span>
01107                 <span class="comment">// and charge quota for it.</span>
01108                 <span class="comment">//</span>
01109 
01110                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer =
01111                      <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( NonPagedPool, Length );
01112 
01113             } except(EXCEPTION_EXECUTE_HANDLER) {
01114 
01115                 <span class="comment">//</span>
01116                 <span class="comment">// An exception was incurred while attempting to allocate the</span>
01117                 <span class="comment">// intermediary system buffer.  Clean everything up and return</span>
01118                 <span class="comment">// an appropriate error status code.</span>
01119                 <span class="comment">//</span>
01120 
01121                 <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
01122                                      irp,
01123                                      eventObject,
01124                                      (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
01125 
01126                 <span class="keywordflow">return</span> GetExceptionCode();
01127 
01128             }
01129 
01130             <span class="comment">//</span>
01131             <span class="comment">// Remember the address of the caller's buffer so the copy can take</span>
01132             <span class="comment">// place during I/O completion.  Also, set the flags so that the</span>
01133             <span class="comment">// completion code knows to do the copy and to deallocate the</span>
01134             <span class="comment">// buffer.</span>
01135             <span class="comment">//</span>
01136 
01137             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01138             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> |
01139                          <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a> |
01140                          <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a>;
01141 
01142         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a125">DO_DIRECT_IO</a>) {
01143 
01144             <span class="comment">//</span>
01145             <span class="comment">// This is a direct I/O operation.  Allocate an MDL and invoke the</span>
01146             <span class="comment">// memory management routine to lock the buffer into memory.  This</span>
01147             <span class="comment">// is done using an exception handler that will perform cleanup if</span>
01148             <span class="comment">// the operation fails.</span>
01149             <span class="comment">//</span>
01150 
01151             <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl;
01152 
01153             mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01154 
01155             <span class="keywordflow">try</span> {
01156 
01157                 <span class="comment">//</span>
01158                 <span class="comment">// Allocate an MDL, charging quota for it, and hang it off of</span>
01159                 <span class="comment">// the IRP.  Probe and lock the pages associated with the</span>
01160                 <span class="comment">// caller's buffer for write access and fill in the MDL with</span>
01161                 <span class="comment">// the PFNs of those pages.</span>
01162                 <span class="comment">//</span>
01163 
01164                 mdl = <a class="code" href="../../d4/d6/iosubs_8c.html#a19">IoAllocateMdl</a>( Buffer, Length, FALSE, TRUE, irp );
01165                 <span class="keywordflow">if</span> (mdl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01166                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
01167                 }
01168                 <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a>( mdl, requestorMode, IoWriteAccess );
01169 
01170             } except(EXCEPTION_EXECUTE_HANDLER) {
01171 
01172                 <span class="comment">//</span>
01173                 <span class="comment">// An exception was incurred while either probing the caller's</span>
01174                 <span class="comment">// buffer of allocating the MDL.  Determine what actually</span>
01175                 <span class="comment">// happened, clean everything up, and return an appropriate</span>
01176                 <span class="comment">// error status code.</span>
01177                 <span class="comment">//</span>
01178 
01179                 <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
01180                                      irp,
01181                                      eventObject,
01182                                      (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
01183 
01184                 <span class="keywordflow">return</span> GetExceptionCode();
01185 
01186             }
01187 
01188         } <span class="keywordflow">else</span> {
01189 
01190             <span class="comment">//</span>
01191             <span class="comment">// Pass the address of the user's buffer so the driver has access</span>
01192             <span class="comment">// to it.  It is now the driver's responsibility to do everything.</span>
01193             <span class="comment">//</span>
01194 
01195             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01196 
01197         }
01198     }
01199 
01200     <span class="comment">//</span>
01201     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
01202     <span class="comment">// IRP.</span>
01203     <span class="comment">//</span>
01204 
01205     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.NotifyDirectory.Length = Length;
01206     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.NotifyDirectory.CompletionFilter = CompletionFilter;
01207     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>) {
01208         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a211">SL_WATCH_TREE</a>;
01209     }
01210 
01211     <span class="comment">//</span>
01212     <span class="comment">// Queue the packet, call the driver, and synchronize appopriately with</span>
01213     <span class="comment">// I/O completion.</span>
01214     <span class="comment">//</span>
01215 
01216     <span class="keywordflow">return</span> <a class="code" href="../../d0/d6/iop_8h.html#a212">IopSynchronousServiceTail</a>( deviceObject,
01217                                       irp,
01218                                       fileObject,
01219                                       FALSE,
01220                                       requestorMode,
01221                                       synchronousIo,
01222                                       OtherTransfer );
01223 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="dir.c::NtQueryDirectoryFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryDirectoryFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE Event&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_APC_ROUTINE ApcRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID ApcContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN FILE_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnSingleEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartScan</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/dir_8c-source.html#l00682">682</a> of file <a class="el" href="../../d1/d7/dir_8c-source.html">dir.c</a>.
<p>
References <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00103">IRP_MN_QUERY_DIRECTORY</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00698                    :
00699 
00700     This service operates on a directory <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileHandle
00701     parameter.  The service returns information about files in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory
00702     specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> handle.  The ReturnSingleEntry parameter specifies
00703     that <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> a single entry should be returned rather than filling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
00704     The actual number of files whose information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned, <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> smallest
00705     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00706 
00707         o  One entry, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ReturnSingleEntry parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
00708 
00709         o  The number of files whose information fits into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00710            buffer.
00711 
00712         o  The number of files that exist.
00713 
00714         o  One entry <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> optional <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified.
00715 
00716     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> optional <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> information
00717     that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> that single <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> exists.  Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00718     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name may not specify any wildcard characters according to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> naming
00719     conventions of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system.  The ReturnSingleEntry parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00720     simply ignored.
00721 
00722     The information that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> obtained about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> files in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> based
00723     on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileInformationClass parameter.  The legal values are as follows:
00724 
00725         o  FileNamesInformation
00726 
00727         o  FileDirectoryInformation
00728 
00729         o  FileFullDirectoryInformation
00730 
00731 Arguments:
00732 
00733     FileHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> which information
00734         should be returned.
00735 
00736     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - Supplies an optional event to be set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Signaled state when
00737         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete.
00738 
00739     ApcRoutine - Supplies an optional APC routine to be executed when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00740         query <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete.
00741 
00742     ApcContext - Supplies a context parameter to be passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ApcRoutine,
00743         <span class="keywordflow">if</span> an ApcRoutine was specified.
00744 
00745     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
00746 
00747     FileInformation - Supplies a buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information
00748         returned about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory.
00749 
00750     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileInformation buffer.
00751 
00752     FileInformationClass - Specfies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
00753         returned about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> files in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified directory.
00754 
00755     ReturnSingleEntry - Supplies a BOOLEAN value that, <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, indicates that
00756         <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> a single entry should be returned.
00757 
00758     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> - Optionally supplies a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified directory.
00759 
00760     RestartScan - Supplies a BOOLEAN value that, <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00761         scan should be restarted from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning.  This parameter must be
00762         set to <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first time <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked.
00763 
00764 Return Value:
00765 
00766     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> success <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation was properly queued
00767     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system.  Once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation completes, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query
00768     can be determined by examining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O status block.
00769 
00770 --*/
00771 
00772 {
00773     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00774     BOOLEAN synchronousIo;
00775     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00776     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00777     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00778     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00779 
00780     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00781 
00782     <span class="comment">//</span>
00783     <span class="comment">// Build the irp with the appropriate minor function &amp; allowed info levels.</span>
00784     <span class="comment">//</span>
00785 
00786     status = <a class="code" href="../../d0/d8/dir_8c.html#a0">BuildQueryDirectoryIrp</a>( FileHandle,
00787                                      Event,
00788                                      ApcRoutine,
00789                                      ApcContext,
00790                                      IoStatusBlock,
00791                                      FileInformation,
00792                                      Length,
00793                                      FileInformationClass,
00794                                      ReturnSingleEntry,
00795                                      FileName,
00796                                      RestartScan,
00797                                      IRP_MN_QUERY_DIRECTORY,
00798                                      &amp;synchronousIo,
00799                                      &amp;deviceObject,
00800                                      &amp;irp,
00801                                      &amp;fileObject,
00802                                      &amp;requestorMode);
00803     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00804 
00805         <span class="comment">//</span>
00806         <span class="comment">// Queue the packet, call the driver, and synchronize appopriately with</span>
00807         <span class="comment">// I/O completion.</span>
00808         <span class="comment">//</span>
00809         status = <a class="code" href="../../d0/d6/iop_8h.html#a212">IopSynchronousServiceTail</a>( deviceObject,
00810                                             irp,
00811                                             fileObject,
00812                                             TRUE,
00813                                             requestorMode,
00814                                             synchronousIo,
00815                                             OtherTransfer );
00816     }
00817     <span class="keywordflow">return</span> status;
00818 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:27 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
