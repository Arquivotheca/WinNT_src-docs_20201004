<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpres.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpres.c</h1><a href="../../d5/d1/pnpres_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1995  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    pnpres.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the plug-and-play resource allocation and translation</span>
00012 <span class="comment">    routines</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Shie-Lin Tzong (shielint) 1-Mar-1997</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">    25-Sept-1998    SantoshJ    Made IopAssign non-recursive.</span>
00025 <span class="comment">    01-Oct-1998     SantoshJ    Replaced "complex (broken)" hypercube code and replaced with</span>
00026 <span class="comment">                                cascading counters. Simple, faster, smaller code.</span>
00027 <span class="comment">                                Added timeouts to IopAssign.</span>
00028 <span class="comment">                                Added more self-debugging capability by generating more</span>
00029 <span class="comment">                                meaningful debug spew.</span>
00030 <span class="comment">    03-Feb-1999     SantoshJ    Do allocation one device at a time.</span>
00031 <span class="comment">                                Do devices with BOOT config before others.</span>
00032 <span class="comment">                                Optimize IopFindBusDeviceNode.</span>
00033 <span class="comment">--*/</span>
00034 
00035 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00036 <span class="preprocessor">#pragma hdrstop</span>
00037 <span class="preprocessor"></span>
<a name="l00038"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a0">00038</a> <span class="preprocessor">#define MYDBG 0</span>
00039 <span class="preprocessor"></span>
00040 <span class="preprocessor">#ifdef POOL_TAGGING</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#undef ExAllocatePool</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePool(a,b) ExAllocatePoolWithTag(a,b,'erpP')</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#endif // POOL_TAGGING</span>
00044 <span class="preprocessor"></span>
00045 <span class="preprocessor">#if MYDBG</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolAT(a,b) ExAllocatePoolWithTag(a,b,'0rpP')</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolRD(a,b) ExAllocatePoolWithTag(a,b,'1rpP')</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolCMRL(a,b) ExAllocatePoolWithTag(a,b,'2rpP')</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolCMRR(a,b) ExAllocatePoolWithTag(a,b,'3rpP')</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolAE(a,b) ExAllocatePoolWithTag(a,b,'4rpP')</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolTE(a,b) ExAllocatePoolWithTag(a,b,'5rpP')</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolPRD(a,b) ExAllocatePoolWithTag(a,b,'6rpP')</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolIORD(a,b) ExAllocatePoolWithTag(a,b,'7rpP')</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePool1RD(a,b) ExAllocatePoolWithTag(a,b,'8rpP')</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolPDO(a,b) ExAllocatePoolWithTag(a,b,'9rpP')</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolIORR(a,b) ExAllocatePoolWithTag(a,b,'ArpP')</span>
00057 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolIORL(a,b) ExAllocatePoolWithTag(a,b,'BrpP')</span>
00058 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolIORRR(a,b) ExAllocatePoolWithTag(a,b,'CrpP')</span>
00059 <span class="preprocessor"></span><span class="preprocessor">#else  // MYDBG</span>
<a name="l00060"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a1">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolAT(a,b) ExAllocatePool(a,b)</span>
<a name="l00061"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a2">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolRD(a,b) ExAllocatePool(a,b)</span>
<a name="l00062"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a3">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolCMRL(a,b) ExAllocatePool(a,b)</span>
<a name="l00063"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a4">00063</a> <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolCMRR(a,b) ExAllocatePool(a,b)</span>
<a name="l00064"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a5">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolAE(a,b) ExAllocatePool(a,b)</span>
<a name="l00065"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a6">00065</a> <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolTE(a,b) ExAllocatePool(a,b)</span>
<a name="l00066"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a7">00066</a> <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolPRD(a,b) ExAllocatePool(a,b)</span>
<a name="l00067"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a8">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolIORD(a,b) ExAllocatePool(a,b)</span>
<a name="l00068"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a9">00068</a> <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePool1RD(a,b) ExAllocatePool(a,b)</span>
<a name="l00069"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a10">00069</a> <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolPDO(a,b) ExAllocatePool(a,b)</span>
<a name="l00070"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a11">00070</a> <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolIORR(a,b) ExAllocatePool(a,b)</span>
<a name="l00071"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a12">00071</a> <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolIORL(a,b) ExAllocatePool(a,b)</span>
<a name="l00072"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a13">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolIORRR(a,b) ExAllocatePool(a,b)</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#endif // MYDBG</span>
00074 <span class="preprocessor"></span>
00075 <span class="comment">//</span>
00076 <span class="comment">// Forward typedefs.</span>
00077 <span class="comment">//</span>
00078 
<a name="l00079"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a28">00079</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d4/struct__REQ__DESC.html">_REQ_DESC</a>
00080     REQ_DESC, *<a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>;
<a name="l00081"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a29">00081</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d3/struct__REQ__ALTERNATIVE.html">_REQ_ALTERNATIVE</a>
00082     REQ_ALTERNATIVE, *<a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a>;
<a name="l00083"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a30">00083</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d4/struct__REQ__LIST.html">_REQ_LIST</a>
00084     REQ_LIST, *<a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a>;
00085 
00086 <span class="comment">//</span>
00087 <span class="comment">// An IO_RESOURCE_REQUIREMENTS_LIST is translated into a tree of these data strucures:</span>
00088 <span class="comment">//     REQ_LIST</span>
00089 <span class="comment">//     REQ_ALTERNATIVE</span>
00090 <span class="comment">//     REQ_DESC</span>
00091 <span class="comment">// which are easier to manipulate while exploring the solution space.</span>
00092 <span class="comment">//</span>
00093 
<a name="l00094"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html">00094</a> <span class="keyword">struct </span><a class="code" href="../../d0/d4/struct__REQ__DESC.html">_REQ_DESC</a> {
<a name="l00095"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html#o0">00095</a>     BOOLEAN <a class="code" href="../../d0/d4/struct__REQ__DESC.html#o0">ArbitrationRequired</a>;
<a name="l00096"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html#o1">00096</a>     UCHAR <a class="code" href="../../d0/d4/struct__REQ__DESC.html#o1">Reserved</a>[3];
<a name="l00097"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html#o2">00097</a>     INTERFACE_TYPE <a class="code" href="../../d0/d4/struct__REQ__DESC.html#o2">InterfaceType</a>;
<a name="l00098"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html#o3">00098</a>     ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
<a name="l00099"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html#o4">00099</a>     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> <a class="code" href="../../d0/d4/struct__REQ__DESC.html#o4">ReqAlternative</a>;              <span class="comment">// REQ_ALTERNATIVE back pointer</span>
<a name="l00100"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html#o5">00100</a>     ULONG <a class="code" href="../../d0/d4/struct__REQ__DESC.html#o5">ReqDescIndex</a>;                           <span class="comment">// REQ_ALTERNATIVE.ReqDescTable[] index</span>
<a name="l00101"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html#o6">00101</a>     ULONG <a class="code" href="../../d0/d4/struct__REQ__DESC.html#o6">DevicePrivateCount</a>;                     <span class="comment">// DevicePrivate info for the LogConf</span>
<a name="l00102"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html#o7">00102</a>     PIO_RESOURCE_DESCRIPTOR <a class="code" href="../../d0/d4/struct__REQ__DESC.html#o7">DevicePrivate</a>;        <span class="comment">// (DevicePrivate is per-LogConf)</span>
<a name="l00103"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html#o8">00103</a>     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> <a class="code" href="../../d0/d4/struct__REQ__DESC.html#o8">TranslatedReqDesc</a>;                     <span class="comment">// Stack pointer for translated REQ_DESC</span>
00104     <span class="keyword">union </span>{
<a name="l00105"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html#o9">00105</a>         <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> <a class="code" href="../../d0/d4/struct__REQ__DESC.html#o9">Arbiter</a>;       <span class="comment">// Used in Original REQ_DESC</span>
<a name="l00106"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html#o10">00106</a>         <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PPI_RESOURCE_TRANSLATOR_ENTRY</a> <a class="code" href="../../d0/d4/struct__REQ__DESC.html#o10">Translator</a>; <span class="comment">// Used in translated/adjusted REQ_DESC</span>
00107     } u;
<a name="l00108"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html#o12">00108</a>     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">ARBITER_LIST_ENTRY</a> <a class="code" href="../../d0/d4/struct__REQ__DESC.html#o12">AlternativeTable</a>;
<a name="l00109"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html#o13">00109</a>     CM_PARTIAL_RESOURCE_DESCRIPTOR <a class="code" href="../../d0/d4/struct__REQ__DESC.html#o13">Allocation</a>;
00110 
00111     <span class="comment">// This two fields are just a place holder</span>
00112     <span class="comment">// They have to be copied back to AlternativeTable</span>
00113     <span class="comment">// and Allocation to be useful.</span>
00114 
<a name="l00115"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html#o14">00115</a>     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">ARBITER_LIST_ENTRY</a> <a class="code" href="../../d0/d4/struct__REQ__DESC.html#o14">BestAlternativeTable</a>;
<a name="l00116"></a><a class="code" href="../../d0/d4/struct__REQ__DESC.html#o15">00116</a>     CM_PARTIAL_RESOURCE_DESCRIPTOR <a class="code" href="../../d0/d4/struct__REQ__DESC.html#o15">BestAllocation</a>;
00117 };
00118 
<a name="l00119"></a><a class="code" href="../../d9/d3/struct__REQ__ALTERNATIVE.html">00119</a> <span class="keyword">struct </span><a class="code" href="../../d9/d3/struct__REQ__ALTERNATIVE.html">_REQ_ALTERNATIVE</a> {
<a name="l00120"></a><a class="code" href="../../d9/d3/struct__REQ__ALTERNATIVE.html#o0">00120</a>     <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> <a class="code" href="../../d9/d3/struct__REQ__ALTERNATIVE.html#o0">ReqList</a>;                            <span class="comment">// Containing REQ_LIST</span>
<a name="l00121"></a><a class="code" href="../../d9/d3/struct__REQ__ALTERNATIVE.html#o1">00121</a>     ULONG <a class="code" href="../../d9/d3/struct__REQ__ALTERNATIVE.html#o1">ReqAlternativeIndex</a>;                    <span class="comment">// Containing REQ_LIST.ReqAlternativeTable[] index</span>
<a name="l00122"></a><a class="code" href="../../d9/d3/struct__REQ__ALTERNATIVE.html#o2">00122</a>     ULONG <a class="code" href="../../d9/d3/struct__REQ__ALTERNATIVE.html#o2">Priority</a>;
<a name="l00123"></a><a class="code" href="../../d9/d3/struct__REQ__ALTERNATIVE.html#o3">00123</a>     ULONG <a class="code" href="../../d9/d3/struct__REQ__ALTERNATIVE.html#o3">ReqDescCount</a>;
<a name="l00124"></a><a class="code" href="../../d9/d3/struct__REQ__ALTERNATIVE.html#o4">00124</a>     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> *<a class="code" href="../../d9/d3/struct__REQ__ALTERNATIVE.html#o4">ReqDescTableEnd</a>;
<a name="l00125"></a><a class="code" href="../../d9/d3/struct__REQ__ALTERNATIVE.html#o5">00125</a>     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> <a class="code" href="../../d9/d3/struct__REQ__ALTERNATIVE.html#o5">ReqDescTable</a>[1];                    <span class="comment">// Variable length</span>
00126 };
00127 
<a name="l00128"></a><a class="code" href="../../d2/d4/struct__REQ__LIST.html">00128</a> <span class="keyword">struct </span><a class="code" href="../../d2/d4/struct__REQ__LIST.html">_REQ_LIST</a> {
<a name="l00129"></a><a class="code" href="../../d2/d4/struct__REQ__LIST.html#o0">00129</a>     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> <a class="code" href="../../d2/d4/struct__REQ__LIST.html#o0">AssignEntry</a>;
<a name="l00130"></a><a class="code" href="../../d2/d4/struct__REQ__LIST.html#o1">00130</a>     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> <a class="code" href="../../d2/d4/struct__REQ__LIST.html#o1">PhysicalDevice</a>;
<a name="l00131"></a><a class="code" href="../../d2/d4/struct__REQ__LIST.html#o2">00131</a>     INTERFACE_TYPE <a class="code" href="../../d2/d4/struct__REQ__LIST.html#o2">InterfaceType</a>;
<a name="l00132"></a><a class="code" href="../../d2/d4/struct__REQ__LIST.html#o3">00132</a>     ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
<a name="l00133"></a><a class="code" href="../../d2/d4/struct__REQ__LIST.html#o4">00133</a>     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *<a class="code" href="../../d2/d4/struct__REQ__LIST.html#o4">SelectedAlternative</a>;         <span class="comment">// Alternative under processed.</span>
<a name="l00134"></a><a class="code" href="../../d2/d4/struct__REQ__LIST.html#o5">00134</a>     ULONG <a class="code" href="../../d2/d4/struct__REQ__LIST.html#o5">ReqAlternativeCount</a>;
<a name="l00135"></a><a class="code" href="../../d2/d4/struct__REQ__LIST.html#o6">00135</a>     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *<a class="code" href="../../d2/d4/struct__REQ__LIST.html#o6">ReqBestAlternative</a>;          <span class="comment">// Best alternative so far.</span>
00136                                                    <span class="comment">// (Initialize it to the end of the table)</span>
<a name="l00137"></a><a class="code" href="../../d2/d4/struct__REQ__LIST.html#o7">00137</a>     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> <a class="code" href="../../d2/d4/struct__REQ__LIST.html#o7">ReqAlternativeTable</a>[1];       <span class="comment">// Variable length</span>
00138 };
00139 
00140 <span class="comment">//</span>
00141 <span class="comment">// Structure to represent a cascading counter.</span>
00142 <span class="comment">//</span>
00143 
<a name="l00144"></a><a class="code" href="../../d0/d9/struct__Counter.html">00144</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d9/struct__Counter.html">_Counter</a> {
<a name="l00145"></a><a class="code" href="../../d0/d9/struct__Counter.html#o0">00145</a>     ULONG   <a class="code" href="../../d0/d9/struct__Counter.html#o0">Count</a>;          <span class="comment">// Current counter value.</span>
<a name="l00146"></a><a class="code" href="../../d0/d9/struct__Counter.html#o1">00146</a>     ULONG   <a class="code" href="../../d0/d9/struct__Counter.html#o1">ResetValue</a>;     <span class="comment">// Reset value for this counter.</span>
<a name="l00147"></a><a class="code" href="../../d0/d9/struct__Counter.html#o2">00147</a>     ULONG   <a class="code" href="../../d0/d9/struct__Counter.html#o2">MaximumValue</a>;   <span class="comment">// Maximum value for this counter.</span>
00148 } <a class="code" href="../../d0/d9/struct__Counter.html">COUNTER</a>, *<a class="code" href="../../d0/d9/struct__Counter.html">PCOUNTER</a>;
00149 
00150 
<a name="l00151"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a14">00151</a> <span class="preprocessor">#define IS_TRANSLATED_REQ_DESC(r)   ((r)-&gt;ReqAlternative ? FALSE : TRUE)</span>
00152 <span class="preprocessor"></span>
00153 <span class="comment">//</span>
00154 <span class="comment">// IopReleaseBootResources can only be called for non ROOT enumerated devices</span>
00155 <span class="comment">//</span>
00156 
<a name="l00157"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a15">00157</a> <span class="preprocessor">#define IopReleaseBootResources(DeviceNode)                          \</span>
00158 <span class="preprocessor">    ASSERT(((DeviceNode)-&gt;Flags &amp; DNF_MADEUP) == 0);                 \</span>
00159 <span class="preprocessor">    IopReleaseResourcesInternal(DeviceNode);                         \</span>
00160 <span class="preprocessor">    (DeviceNode)-&gt;Flags &amp;= ~DNF_HAS_BOOT_CONFIG;                     \</span>
00161 <span class="preprocessor">    (DeviceNode)-&gt;Flags &amp;= ~DNF_BOOT_CONFIG_RESERVED;                \</span>
00162 <span class="preprocessor">    if ((DeviceNode)-&gt;BootResources) {                               \</span>
00163 <span class="preprocessor">        ExFreePool((DeviceNode)-&gt;BootResources);                     \</span>
00164 <span class="preprocessor">        (DeviceNode)-&gt;BootResources = NULL;                          \</span>
00165 <span class="preprocessor">    }</span>
00166 <span class="preprocessor"></span>
00167 <span class="comment">//</span>
00168 <span class="comment">// Duplicate_detection_Context</span>
00169 <span class="comment">//</span>
00170 
<a name="l00171"></a><a class="code" href="../../d2/d1/struct__DUPLICATE__DETECTION__CONTEXT.html">00171</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d1/struct__DUPLICATE__DETECTION__CONTEXT.html">_DUPLICATE_DETECTION_CONTEXT</a> {
<a name="l00172"></a><a class="code" href="../../d2/d1/struct__DUPLICATE__DETECTION__CONTEXT.html#o0">00172</a>     PCM_RESOURCE_LIST <a class="code" href="../../d2/d1/struct__DUPLICATE__DETECTION__CONTEXT.html#o0">TranslatedResources</a>;
<a name="l00173"></a><a class="code" href="../../d2/d1/struct__DUPLICATE__DETECTION__CONTEXT.html#o1">00173</a>     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> <a class="code" href="../../d2/d1/struct__DUPLICATE__DETECTION__CONTEXT.html#o1">Duplicate</a>;
00174 } <a class="code" href="../../d2/d1/struct__DUPLICATE__DETECTION__CONTEXT.html">DUPLICATE_DETECTION_CONTEXT</a>, *<a class="code" href="../../d2/d1/struct__DUPLICATE__DETECTION__CONTEXT.html">PDUPLICATE_DETECTION_CONTEXT</a>;
00175 
00176 <span class="comment">//</span>
00177 <span class="comment">// Reused device node fields</span>
00178 <span class="comment">//</span>
00179 
<a name="l00180"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a16">00180</a> <span class="preprocessor">#define NextDeviceNode     Sibling</span>
<a name="l00181"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a17">00181</a> <span class="preprocessor"></span><span class="preprocessor">#define PreviousDeviceNode Child</span>
00182 <span class="preprocessor"></span>
00183 <span class="comment">//</span>
00184 <span class="comment">// Macros and definitions</span>
00185 <span class="comment">//</span>
00186 
<a name="l00187"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a18">00187</a> <span class="preprocessor">#define STRUCTURE_ALIGNMENT 1  // disable the structure alignment.</span>
00188 <span class="preprocessor"></span>
00189 <span class="comment">//</span>
00190 <span class="comment">// Pool Management macros</span>
00191 <span class="comment">//</span>
00192 
<a name="l00193"></a><a class="code" href="../../d2/d1/struct__IOP__POOL.html">00193</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d1/struct__IOP__POOL.html">_IOP_POOL</a> {
<a name="l00194"></a><a class="code" href="../../d2/d1/struct__IOP__POOL.html#o0">00194</a>     PUCHAR <a class="code" href="../../d2/d1/struct__IOP__POOL.html#o0">PoolStart</a>;
<a name="l00195"></a><a class="code" href="../../d2/d1/struct__IOP__POOL.html#o1">00195</a>     PUCHAR <a class="code" href="../../d2/d1/struct__IOP__POOL.html#o1">PoolEnd</a>;
<a name="l00196"></a><a class="code" href="../../d2/d1/struct__IOP__POOL.html#o2">00196</a>     ULONG <a class="code" href="../../d2/d1/struct__IOP__POOL.html#o2">PoolSize</a>;
00197 } <a class="code" href="../../d2/d1/struct__IOP__POOL.html">IOP_POOL</a>, *<a class="code" href="../../d2/d1/struct__IOP__POOL.html">PIOP_POOL</a>;
00198 
00199 <span class="preprocessor">#define IopInitPool(                                                   \</span>
00200 <span class="preprocessor">    </span><span class="comment">/* IN PIOP_POOL */</span> Pool,                                           \
00201     <span class="comment">/* IN PUCHAR */</span> Start,                                             \
00202     <span class="comment">/* IN ULONG */</span> Size                                                \
<a name="l00203"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a19">00203</a>     )                                                                  \
00204 {                                                                      \
00205     (Pool)-&gt;PoolStart = (Start);                                       \
00206     (Pool)-&gt;PoolEnd = (Start) + (Size);                                \
00207     (Pool)-&gt;PoolSize = (Size);                                         \
00208     RtlZeroMemory(Start, Size);                                        \
00209 }
00210 
00211 <span class="preprocessor">#define IopAllocPoolAligned(                                           \</span>
00212 <span class="preprocessor">    </span><span class="comment">/* OUT PUCHAR */</span> Memory,                                           \
00213     <span class="comment">/* IN PIOP_POOL */</span> Pool,                                           \
00214     <span class="comment">/* IN ULONG */</span> Size                                                \
<a name="l00215"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a20">00215</a>     )                                                                  \
00216     (Pool)-&gt;PoolStart = (PUCHAR)                                       \
00217         (((ULONG_PTR) (Pool)-&gt;PoolStart + STRUCTURE_ALIGNMENT - 1)     \
00218         &amp; ~(STRUCTURE_ALIGNMENT - 1));                                 \
00219     IopAllocPool(Memory, Pool, Size);
00220 
00221 <span class="preprocessor">#define IopAllocPool(                                                  \</span>
00222 <span class="preprocessor">    </span><span class="comment">/* OUT PUCHAR */</span> Memory,                                           \
00223     <span class="comment">/* IN PIOP_POOL */</span> Pool,                                           \
00224     <span class="comment">/* IN ULONG */</span> Size                                                \
<a name="l00225"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a21">00225</a>     )                                                                  \
00226     *(Memory) = (PVOID) (Pool)-&gt;PoolStart;                             \
00227     (Pool)-&gt;PoolStart += (Size);                                       \
00228     ASSERT((Pool)-&gt;PoolStart &lt;= (Pool)-&gt;PoolEnd);
00229 
00230 <span class="comment">//</span>
00231 <span class="comment">// static variables</span>
00232 <span class="comment">//</span>
00233 
<a name="l00234"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a37">00234</a> LIST_ENTRY <a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>;       <span class="comment">// The List of arbiters being processed.</span>
<a name="l00235"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a38">00235</a> LIST_ENTRY <a class="code" href="../../d5/d1/pnpres_8c.html#a38">PiBestArbiterList</a>;         <span class="comment">// The list of arbiters for the best alternative so far</span>
<a name="l00236"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a39">00236</a> ULONG <a class="code" href="../../d5/d1/pnpres_8c.html#a39">PiBestPriority</a>;                 <span class="comment">// The best score so far</span>
<a name="l00237"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a40">00237</a> <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a>;
<a name="l00238"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a41">00238</a> ULONG <a class="code" href="../../d5/d1/pnpres_8c.html#a41">PiAssignTableCount</a>;
<a name="l00239"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a42">00239</a> <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a>;     <span class="comment">// head pointer of the list of made up device node for</span>
00240                                       <span class="comment">// IoAssignResources and IoReportResourceUsage</span>
<a name="l00241"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a43">00241</a> BOOLEAN <a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a>;
00242 <span class="preprocessor">#if DBG</span>
00243 <span class="preprocessor"></span>BOOLEAN <a class="code" href="../../d5/d1/pnpres_8c.html#a44">PiUseTimeout</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00244 <span class="preprocessor">#else</span>
<a name="l00245"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a44">00245</a> <span class="preprocessor"></span>BOOLEAN <a class="code" href="../../d5/d1/pnpres_8c.html#a44">PiUseTimeout</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00246 <span class="preprocessor">#endif</span>
00247 <span class="preprocessor"></span>
00248 <span class="comment">//</span>
00249 <span class="comment">// Timeout value for IopAssign in milliseconds.</span>
00250 <span class="comment">//</span>
00251 
<a name="l00252"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a22">00252</a> <span class="preprocessor">#define FIND_BEST_ASSIGNMENT_TIMEOUT    5000</span>
00253 <span class="preprocessor"></span>
00254 <span class="comment">//</span>
00255 <span class="comment">// External references</span>
00256 <span class="comment">//</span>
00257 
<a name="l00258"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a45">00258</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d7/d9/assign_8c.html#a28">IopWstrTranslated</a>[];
<a name="l00259"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a46">00259</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d3/d5/iodata_8c.html#a75">IopWstrRaw</a>[];
00260 
00261 <span class="comment">//</span>
00262 <span class="comment">// Debug support</span>
00263 <span class="comment">//</span>
00264 
00265 <span class="preprocessor">#if DBG_SCOPE</span>
00266 <span class="preprocessor"></span>
<a name="l00267"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a23">00267</a> <span class="preprocessor">#define DUMP_ERROR  0x0001</span>
<a name="l00268"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a24">00268</a> <span class="preprocessor"></span><span class="preprocessor">#define DUMP_INFO   0x0002</span>
<a name="l00269"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a25">00269</a> <span class="preprocessor"></span><span class="preprocessor">#define DUMP_DETAIL 0x0004</span>
<a name="l00270"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a26">00270</a> <span class="preprocessor"></span><span class="preprocessor">#define STOP_ERROR  0x1000</span>
00271 <span class="preprocessor"></span>
00272 <span class="comment">//ULONG PnpResDebugLevel = DUMP_INFO + DUMP_ERROR;</span>
<a name="l00273"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a47">00273</a> ULONG <a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> = 0;
00274 
<a name="l00275"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a27">00275</a> <span class="preprocessor">#define DebugMessage(Level,Message)         \</span>
00276 <span class="preprocessor">    if (PnpResDebugLevel &amp; (Level)) {       \</span>
00277 <span class="preprocessor">        DbgPrint Message;                   \</span>
00278 <span class="preprocessor">    }</span>
00279 <span class="preprocessor"></span>
<a name="l00280"></a><a class="code" href="../../d3/d5/structPNPRESDEBUGTRANSLATIONFAILURE.html">00280</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00281"></a><a class="code" href="../../d3/d5/structPNPRESDEBUGTRANSLATIONFAILURE.html#o0">00281</a>     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devnode;
<a name="l00282"></a><a class="code" href="../../d3/d5/structPNPRESDEBUGTRANSLATIONFAILURE.html#o1">00282</a>     CM_PARTIAL_RESOURCE_DESCRIPTOR resource;
00283 } <a class="code" href="../../d3/d5/structPNPRESDEBUGTRANSLATIONFAILURE.html">PNPRESDEBUGTRANSLATIONFAILURE</a>;
00284 
<a name="l00285"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a48">00285</a> ULONG <a class="code" href="../../d5/d1/pnpres_8c.html#a48">PnpResDebugTranslationFailureCount</a> = 32;  <span class="comment">// get count in both this line and the next.</span>
<a name="l00286"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a49">00286</a> <a class="code" href="../../d3/d5/structPNPRESDEBUGTRANSLATIONFAILURE.html">PNPRESDEBUGTRANSLATIONFAILURE</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a49">PnpResDebugTranslationFailureArray</a>[32];
<a name="l00287"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a50">00287</a> <a class="code" href="../../d3/d5/structPNPRESDEBUGTRANSLATIONFAILURE.html">PNPRESDEBUGTRANSLATIONFAILURE</a> *<a class="code" href="../../d5/d1/pnpres_8c.html#a50">PnpResDebugTranslationFailure</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a49">PnpResDebugTranslationFailureArray</a>;
00288 
00289 <span class="preprocessor">#else</span>
00290 <span class="preprocessor"></span>
00291 <span class="preprocessor">#define DebugMessage(Level,Message)</span>
00292 <span class="preprocessor"></span>
00293 <span class="preprocessor">#endif</span>
00294 <span class="preprocessor"></span>
00295 <span class="comment">//</span>
00296 <span class="comment">// Internal/Forward function references</span>
00297 <span class="comment">//</span>
00298 
00299 PCM_RESOURCE_LIST
00300 <a class="code" href="../../d5/d1/pnpres_8c.html#a51">IopCreateCmResourceList</a>(
00301     IN PCM_RESOURCE_LIST ResourceList,
00302     IN INTERFACE_TYPE InterfaceType,
00303     IN ULONG   BusNumber,
00304     OUT PCM_RESOURCE_LIST *RemainingList
00305     );
00306 
00307 PCM_RESOURCE_LIST
00308 <a class="code" href="../../d5/d1/pnpres_8c.html#a52">IopCombineCmResourceList</a>(
00309     IN PCM_RESOURCE_LIST ResourceListA,
00310     IN PCM_RESOURCE_LIST ResourceListB
00311     );
00312 
00313 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00314 <a class="code" href="../../d5/d1/pnpres_8c.html#a53">IopRemoveLegacyDeviceNode</a> (
00315     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>   DeviceObject OPTIONAL,
00316     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>     LegacyDeviceNode
00317     );
00318 
00319 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00320 <a class="code" href="../../d5/d1/pnpres_8c.html#a54">IopFindLegacyDeviceNode</a> (
00321     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00322     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL,
00323     OUT <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> *LegacyDeviceNode,
00324     OUT <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *LegacyPDO
00325     );
00326 
00327 <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>
00328 <a class="code" href="../../d5/d1/pnpres_8c.html#a55">IopFindBusDeviceNodeInternal</a> (
00329     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00330     IN INTERFACE_TYPE InterfaceType,
00331     IN ULONG BusNumber
00332     );
00333 
00334 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00335 <a class="code" href="../../d5/d1/pnpres_8c.html#a56">IopGetResourceRequirementsForAssignTable</a>(
00336     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable,
00337     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTableEnd,
00338     OUT PULONG DeviceCount
00339     );
00340 
00341 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00342 <a class="code" href="../../d5/d1/pnpres_8c.html#a57">IopResourceRequirementsListToReqList</a>(
00343     IN ARBITER_REQUEST_SOURCE AllocationType,
00344     IN PIO_RESOURCE_REQUIREMENTS_LIST IoResources,
00345     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDevice,
00346     OUT PVOID *ResReqList
00347     );
00348 
00349 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00350 <a class="code" href="../../d5/d1/pnpres_8c.html#a58">IopRearrangeReqList</a> (
00351     IN PREQ_LIST ReqList
00352     );
00353 
00354 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00355 <a class="code" href="../../d5/d1/pnpres_8c.html#a59">IopRearrangeAssignTable</a> (
00356     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable,
00357     IN ULONG Count
00358     );
00359 
00360 <span class="keywordtype">int</span>
00361 __cdecl
00362 <a class="code" href="../../d5/d1/pnpres_8c.html#a60">IopComparePriority</a>(
00363     <span class="keyword">const</span> <span class="keywordtype">void</span> *arg1,
00364     <span class="keyword">const</span> <span class="keywordtype">void</span> *arg2
00365     );
00366 
00367 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00368 <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(
00369     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable,
00370     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTableEnd
00371     );
00372 
00373 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00374 <a class="code" href="../../d5/d1/pnpres_8c.html#a62">IopFreeReqAlternative</a> (
00375     IN PREQ_ALTERNATIVE ReqAlternative
00376     );
00377 
00378 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00379 <a class="code" href="../../d5/d1/pnpres_8c.html#a63">IopFreeReqList</a> (
00380     IN PREQ_LIST ReqList
00381     );
00382 
00383 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00384 <a class="code" href="../../d5/d1/pnpres_8c.html#a64">IopAssign</a>(
00385     IN ULONG AssignTableCount,
00386     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable,
00387     IN BOOLEAN Rebalance
00388     );
00389 
00390 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00391 <a class="code" href="../../d5/d1/pnpres_8c.html#a65">IopBuildCmResourceLists</a>(
00392     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable,
00393     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTableEnd
00394     );
00395 
00396 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00397 <a class="code" href="../../d5/d1/pnpres_8c.html#a66">IopBuildCmResourceList</a> (
00398     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignEntry
00399     );
00400 
00401 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00402 <a class="code" href="../../d5/d1/pnpres_8c.html#a67">IopAssignInner</a>(
00403     IN ULONG AssignTableCount,
00404     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>  AssignTable,
00405     IN BOOLEAN Rebalance
00406     );
00407 
00408 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00409 <a class="code" href="../../d5/d1/pnpres_8c.html#a68">IopPlacement</a>(
00410     IN ARBITER_ACTION ArbiterAction,
00411     IN BOOLEAN Rebalance
00412     );
00413 
00414 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00415 <a class="code" href="../../d5/d1/pnpres_8c.html#a69">IopAddReqDescsToArbiters</a> (
00416     IN ULONG ReqDescCount,
00417     IN PREQ_DESC *ReqDescTable
00418     );
00419 
00420 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00421 <a class="code" href="../../d5/d1/pnpres_8c.html#a70">IopRemoveReqDescsFromArbiters</a> (
00422     ULONG ReqDescCount,
00423     PREQ_DESC *ReqDescTable
00424     );
00425 
00426 BOOLEAN
00427 <a class="code" href="../../d5/d1/pnpres_8c.html#a71">IopIsBestConfiguration</a>(
00428     IN VOID
00429     );
00430 
00431 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00432 <a class="code" href="../../d5/d1/pnpres_8c.html#a72">IopSaveCurrentConfiguration</a> (
00433     IN VOID
00434     );
00435 
00436 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00437 <a class="code" href="../../d5/d1/pnpres_8c.html#a73">IopRestoreBestConfiguration</a>(
00438     IN VOID
00439     );
00440 
00441 BOOLEAN
00442 <a class="code" href="../../d5/d1/pnpres_8c.html#a74">IopFindResourceHandlerInfo</a>(
00443     IN RESOURCE_HANDLER_TYPE HandlerType,
00444     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00445     IN UCHAR ResourceType,
00446     OUT PVOID *HandlerEntry
00447     );
00448 
00449 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00450 <a class="code" href="../../d5/d1/pnpres_8c.html#a75">IopSetupArbiterAndTranslators</a>(
00451     IN PREQ_DESC ReqDesc
00452     );
00453 
00454 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00455 <a class="code" href="../../d5/d1/pnpres_8c.html#a76">IopParentToRawTranslation</a>(
00456     IN OUT PREQ_DESC ReqDesc
00457     );
00458 
00459 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00460 <a class="code" href="../../d5/d1/pnpres_8c.html#a77">IopChildToRootTranslation</a>(
00461     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,  OPTIONAL
00462     IN INTERFACE_TYPE InterfaceType,
00463     IN ULONG BusNumber,
00464     IN ARBITER_REQUEST_SOURCE ArbiterRequestSource,
00465     IN PCM_PARTIAL_RESOURCE_DESCRIPTOR Source,
00466     OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR *Target
00467     );
00468 
00469 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00470 <a class="code" href="../../d5/d1/pnpres_8c.html#a78">IopTranslateAndAdjustReqDesc</a>(
00471     IN PREQ_DESC ReqDesc,
00472     IN <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PPI_RESOURCE_TRANSLATOR_ENTRY</a> TranslatorEntry,
00473     OUT PREQ_DESC *TranslatedReqDesc
00474     );
00475 
00476 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00477 <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(
00478     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> ArbiterEntry,
00479     ARBITER_ACTION Command,
00480     PVOID Input1,
00481     PVOID Input2,
00482     PVOID Input3
00483     );
00484 
00485 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00486 <a class="code" href="../../d5/d1/pnpres_8c.html#a80">IopQueryRebalance</a> (
00487     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00488     IN ULONG Phase,
00489     IN PULONG RebalanceCount,
00490     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> **DeviceTable
00491     );
00492 
00493 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00494 <a class="code" href="../../d5/d1/pnpres_8c.html#a81">IopQueryRebalanceWorker</a> (
00495     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00496     IN ULONG RebalancePhase,
00497     IN PULONG RebalanceCount,
00498     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> **DeviceTable
00499     );
00500 
00501 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00502 <a class="code" href="../../d5/d1/pnpres_8c.html#a82">IopTestForReconfiguration</a> (
00503     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00504     IN ULONG RebalancePhase,
00505     IN PULONG RebalanceCount,
00506     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> **DeviceTable
00507     );
00508 
00509 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00510 <a class="code" href="../../d5/d1/pnpres_8c.html#a83">IopPlacementForRebalance</a> (
00511     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00512     IN ARBITER_ACTION ArbiterAction
00513     );
00514 
00515 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00516 <a class="code" href="../../d5/d1/pnpres_8c.html#a84">IopArbitrateDeviceResources</a> (
00517     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00518     IN ARBITER_ACTION ArbiterAction
00519     );
00520 
00521 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00522 <a class="code" href="../../d5/d1/pnpres_8c.html#a85">IopRebalance</a> (
00523     IN ULONG AssignTableCont,
00524     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable
00525     );
00526 
00527 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00528 <a class="code" href="../../d5/d1/pnpres_8c.html#a86">IopFindResourcesForArbiter</a> (
00529     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00530     IN UCHAR ResourceType,
00531     OUT ULONG *Count,
00532     OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR *CmDesc
00533     );
00534 
00535 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00536 <a class="code" href="../../d5/d1/pnpres_8c.html#a87">IopReleaseResourcesInternal</a> (
00537     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
00538     );
00539 
00540 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00541 <a class="code" href="../../d5/d1/pnpres_8c.html#a88">IopReleaseResources</a> (
00542     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
00543     );
00544 
00545 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00546 <a class="code" href="../../d5/d1/pnpres_8c.html#a89">IopRestoreResourcesInternal</a> (
00547     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
00548     );
00549 
00550 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00551 <a class="code" href="../../d5/d1/pnpres_8c.html#a90">IopSetLegacyDeviceInstance</a> (
00552     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00553     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
00554     );
00555 
00556 PCM_RESOURCE_LIST
00557 <a class="code" href="../../d5/d1/pnpres_8c.html#a91">IopCombineLegacyResources</a> (
00558     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
00559     );
00560 
00561 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00562 <a class="code" href="../../d5/d1/pnpres_8c.html#a92">IopPlacementForReservation</a>(
00563     VOID
00564     );
00565 
00566 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00567 <a class="code" href="../../d5/d1/pnpres_8c.html#a93">IopReserve</a>(
00568     IN PREQ_LIST ReqList
00569     );
00570 
00571 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00572 <a class="code" href="../../d5/d1/pnpres_8c.html#a94">IopReserveBootResourcesInternal</a> (
00573     IN ARBITER_REQUEST_SOURCE ArbiterRequestSource,
00574     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00575     IN PCM_RESOURCE_LIST BootResources
00576     );
00577 
00578 BOOLEAN
00579 <a class="code" href="../../d5/d1/pnpres_8c.html#a95">IopNeedToReleaseBootResources</a>(
00580     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00581     IN PCM_RESOURCE_LIST AllocatedResources
00582     );
00583 
00584 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00585 <a class="code" href="../../d5/d1/pnpres_8c.html#a96">IopReleaseFilteredBootResources</a>(
00586     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable,
00587     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTableEnd
00588     );
00589 
00590 <span class="preprocessor">#if DBG_SCOPE</span>
00591 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00592 <a class="code" href="../../d5/d1/pnpres_8c.html#a97">IopDumpResourceRequirementsList</a>(
00593     IN PIO_RESOURCE_REQUIREMENTS_LIST IoResources
00594     );
00595 
00596 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00597 <a class="code" href="../../d5/d1/pnpres_8c.html#a98">IopDumpResourceDescriptor</a> (
00598     IN PUCHAR Indent,
00599     IN PIO_RESOURCE_DESCRIPTOR Desc
00600     );
00601 
00602 <span class="preprocessor">#endif</span>
00603 <span class="preprocessor"></span>
00604 <span class="preprocessor">#if DBG_SCOPE</span>
00605 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00606 <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a> (
00607     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
00608     );
00609 
00610 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00611 <a class="code" href="../../d5/d1/pnpres_8c.html#a100">IopCheckDataStructuresWorker</a> (
00612     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> Device
00613     );
00614 
00615 <span class="preprocessor">#endif</span>
00616 <span class="preprocessor"></span>
00617 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00618 <a class="code" href="../../d5/d1/pnpres_8c.html#a101">IopQueryConflictListInternal</a>(
00619     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>        PhysicalDeviceObject,
00620     IN PCM_RESOURCE_LIST  ResourceList,
00621     IN ULONG              ResourceListSize,
00622     OUT PPLUGPLAY_CONTROL_CONFLICT_LIST ConflictList,
00623     IN ULONG              ConflictListSize,
00624     IN ULONG              Flags
00625     );
00626 
00627 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00628 <a class="code" href="../../d5/d1/pnpres_8c.html#a102">IopQueryConflictFillConflicts</a>(
00629     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>              PhysicalDeviceObject,
00630     IN ULONG                    ConflictCount,
00631     IN <a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">PARBITER_CONFLICT_INFO</a>   ConflictInfoList,
00632     OUT PPLUGPLAY_CONTROL_CONFLICT_LIST ConflictList,
00633     IN ULONG                    ConflictListSize,
00634     IN ULONG                    Flags
00635     );
00636 
00637 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00638 <a class="code" href="../../d5/d1/pnpres_8c.html#a103">IopQueryConflictFillString</a>(
00639     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>   DeviceObject,
00640     IN PWSTR            Buffer,
00641     IN OUT PULONG       Length,
00642     IN OUT PULONG       Flags
00643     );
00644 
00645 BOOLEAN
00646 <a class="code" href="../../d5/d1/pnpres_8c.html#a104">IopEliminateBogusConflict</a>(
00647     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>   PhysicalDeviceObject,
00648     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>   ConflictDeviceObject
00649     );
00650 
00651 
00652 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00653 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopAllocateResources)</span>
00654 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGetResourceRequirementsForAssignTable)</span>
00655 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopResourceRequirementsListToReqList)</span>
00656 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopComparePriority)</span>
00657 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRearrangeReqList)</span>
00658 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRearrangeAssignTable)</span>
00659 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopFreeResourceRequirementsForAssignTable)</span>
00660 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopFreeReqList)</span>
00661 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopFreeReqAlternative)</span>
00662 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopAssign)</span>
00663 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopBuildCmResourceLists)</span>
00664 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopBuildCmResourceList)</span>
00665 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopAssignInner)</span>
00666 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopPlacement)</span>
00667 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopAddReqDescsToArbiters)</span>
00668 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRemoveReqDescsFromArbiters)</span>
00669 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopIsBestConfiguration)</span>
00670 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopSaveCurrentConfiguration)</span>
00671 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRestoreBestConfiguration)</span>
00672 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopFindResourceHandlerInfo)</span>
00673 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopSetupArbiterAndTranslators)</span>
00674 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopParentToRawTranslation)</span>
00675 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopChildToRootTranslation)</span>
00676 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopTranslateAndAdjustReqDesc)</span>
00677 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopCallArbiter)</span>
00678 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopQueryRebalance)</span>
00679 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopTestForReconfiguration)</span>
00680 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopPlacementForRebalance)</span>
00681 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopArbitrateDeviceResources)</span>
00682 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRebalance)</span>
00683 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopFindResourcesForArbiter)</span>
00684 <span class="preprocessor"></span><span class="comment">//#pragma alloc_text(PAGE, IopLegacyResourceAllocation)</span>
00685 <span class="preprocessor">#pragma alloc_text(PAGE, IopFindLegacyDeviceNode)</span>
00686 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRemoveLegacyDeviceNode)</span>
00687 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopFindBusDeviceNode)</span>
00688 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopFindBusDeviceNodeInternal)</span>
00689 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDuplicateDetection)</span>
00690 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopReleaseResourcesInternal)</span>
00691 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRestoreResourcesInternal)</span>
00692 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopSetLegacyDeviceInstance)</span>
00693 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopCombineLegacyResources)</span>
00694 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopReserve)</span>
00695 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopPlacementForReservation)</span>
00696 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopAllocateBootResources)</span>
00697 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopReserveBootResourcesInternal)</span>
00698 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopReleaseResources)</span>
00699 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopReallocateResources)</span>
00700 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopReleaseFilteredBootResources)</span>
00701 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopNeedToReleaseBootResources)</span>
00702 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopQueryConflictList)</span>
00703 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopQueryConflictListInternal)</span>
00704 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopQueryConflictFillConflicts)</span>
00705 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopQueryConflictFillString)</span>
00706 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopEliminateBogusConflict)</span>
00707 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopCreateCmResourceList)</span>
00708 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopCombineCmResourceList)</span>
00709 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, IopReserveLegacyBootResources)</span>
00710 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, IopReserveBootResources)</span>
00711 <span class="preprocessor"></span><span class="preprocessor">#if DBG_SCOPE</span>
00712 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopCheckDataStructures)</span>
00713 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopCheckDataStructuresWorker)</span>
00714 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDumpResourceRequirementsList)</span>
00715 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDumpResourceDescriptor)</span>
00716 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00717 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00718 <span class="preprocessor"></span>
00719 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00720"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a105">00720</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a105">IopAllocateResources</a>(
00721     IN PULONG DeviceCountP,
00722     IN OUT <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> *AssignTablePP,
00723     IN BOOLEAN Locked,
00724     IN BOOLEAN BootConfigsOK
00725     )
00726 
00727 <span class="comment">/*++</span>
00728 <span class="comment"></span>
00729 <span class="comment">Routine Description:</span>
00730 <span class="comment"></span>
00731 <span class="comment">    For each AssignTable entry, this routine queries device's IO resource requirements</span>
00732 <span class="comment">    list and converts it to our internal REQ_LIST format; calls worker routine to perform</span>
00733 <span class="comment">    the resources assignment.</span>
00734 <span class="comment"></span>
00735 <span class="comment">Parameters:</span>
00736 <span class="comment"></span>
00737 <span class="comment">    AssignTable - supplies a pointer to the first entry of a IOP_RESOURCE_REQUEST table.</span>
00738 <span class="comment"></span>
00739 <span class="comment">    AssignTableEnd - supplies a pointer to the end of IOP_RESOURCE_REQUEST table.</span>
00740 <span class="comment"></span>
00741 <span class="comment">    Locked - Indicates whether the IopRegistrySemaphore is acquired by the caller.</span>
00742 <span class="comment"></span>
00743 <span class="comment">    BootConfigsOK - Indicates whether we should assign BOOT configs.</span>
00744 <span class="comment"></span>
00745 <span class="comment">Return Value:</span>
00746 <span class="comment"></span>
00747 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00748 <span class="comment"></span>
00749 <span class="comment">--*/</span>
00750 
00751 {
00752     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>   AssignTable;
00753     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>   AssignTableEnd;
00754     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>   AssignTableTail;
00755     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>   AssignEntry;
00756     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>   AssignEntryOriginal;
00757     ULONG                   AssignTableCount;
00758     ULONG                   DeviceCount;
00759     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00760     BOOLEAN                 FreeAssignTable;
00761     BOOLEAN                 tryRebalance;
00762 
00763     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00764 
00765     DeviceCount = *DeviceCountP;
00766     FreeAssignTable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00767     tryRebalance = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00768     AssignTable = *AssignTablePP;
00769     AssignTableEnd = AssignTable + DeviceCount;
00770 
00771     <span class="comment">//</span>
00772     <span class="comment">// If legacy device resource allocation, don't rebalance on failure,</span>
00773     <span class="comment">// if the resource they want is already assigned, what they are looking</span>
00774     <span class="comment">// for isn't there.</span>
00775     <span class="comment">//</span>
00776 
00777     <span class="keywordflow">if</span> ((DeviceCount == 1) &amp;&amp; (AssignTable-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a70">IOP_ASSIGN_NO_REBALANCE</a>)) {
00778 
00779         tryRebalance = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00780 
00781     }
00782 
00783     <span class="comment">//</span>
00784     <span class="comment">// Grab the IO registry semaphore to make sure no other device is</span>
00785     <span class="comment">// reporting it's resource usage while we are searching for conflicts.</span>
00786     <span class="comment">//</span>
00787 
00788     <span class="keywordflow">if</span> (!Locked) {
00789 
00790         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00791 
00792         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>,
00793                                         <a class="code" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>,
00794                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00795                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00796                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00797 
00798         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00799 
00800             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"IopAllocateResources: Get RegistrySemaphore failed. Status %x\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00801             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00802             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00803 
00804         }
00805     }
00806 
00807     <span class="comment">//</span>
00808     <span class="comment">// Get the resource requirements.</span>
00809     <span class="comment">//</span>
00810 
00811     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a56">IopGetResourceRequirementsForAssignTable</a>(AssignTable, AssignTableEnd, &amp;DeviceCount);
00812     <span class="keywordflow">if</span> (DeviceCount == 0) {
00813 
00814         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>, (<span class="stringliteral">"IopAllocateResources: Get Requirements for Assign Table found nothing. status %x\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00815 
00816         <span class="keywordflow">if</span> (!Locked) {
00817 
00818             <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>, 0, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00819             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00820 
00821         }
00822 
00823         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00824 
00825     }
00826 
00827     <span class="comment">//</span>
00828     <span class="comment">// Check if it is OK to assign resources to devices with BOOT configs.</span>
00829     <span class="comment">//</span>
00830 
00831     <span class="keywordflow">if</span> (BootConfigsOK) {
00832 
00833         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/pnpdata_8c.html#a18">IopBootConfigsReserved</a>) {
00834 
00835             <span class="comment">//</span>
00836             <span class="comment">// Process devices with BOOT configs or no requirements first.</span>
00837             <span class="comment">//</span>
00838 
00839             <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; AssignEntry++) {
00840 
00841                 <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00842 
00843                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>) {
00844 
00845                     <span class="keywordflow">break</span>;
00846                 }
00847             }
00848 
00849             <span class="keywordflow">if</span> (AssignEntry != AssignTableEnd) {
00850 
00851                 <span class="comment">//</span>
00852                 <span class="comment">// There are devices with BOOT config.</span>
00853                 <span class="comment">//</span>
00854 
00855                 <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; AssignEntry++) {
00856 
00857                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00858 
00859                     <span class="keywordflow">if</span> (    !(AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>) &amp;&amp;
00860                             !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>) &amp;&amp;
00861                             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> &amp;&amp;
00862                             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a> != <a class="code" href="../../d6/d9/pnp_8h.html#a174a129">ArbiterRequestPnpDetected</a>) {
00863 
00864                         DeviceCount--;
00865                         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>, (<span class="stringliteral">"Delaying non BOOT config device %ws...\n"</span>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
00866                         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_RETRY;
00867                         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>;
00868                         <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(AssignEntry, AssignEntry + 1);
00869 
00870                     }
00871                 }
00872             }
00873 
00874             <span class="keywordflow">if</span> (DeviceCount == 0) {
00875 
00876                 <span class="keywordflow">if</span> (!Locked) {
00877 
00878                     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>, 0, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00879                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00880 
00881                 }
00882 
00883                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00884             }
00885         }
00886 
00887         <span class="comment">//</span>
00888         <span class="comment">// Check if we need to allocate a new table.</span>
00889         <span class="comment">//</span>
00890 
00891         <span class="keywordflow">if</span> (DeviceCount != *DeviceCountP) {
00892 
00893             <span class="comment">//</span>
00894             <span class="comment">// Allocate a new table.</span>
00895             <span class="comment">//</span>
00896 
00897             AssignTable = (<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>) <a class="code" href="../../d5/d1/pnpres_8c.html#a1">ExAllocatePoolAT</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00898                                                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>) * DeviceCount);
00899             <span class="keywordflow">if</span> (AssignTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00900 
00901                 <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(*AssignTablePP, AssignTableEnd);
00902 
00903                 <span class="keywordflow">if</span> (!Locked) {
00904 
00905                     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>, 0, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00906                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00907 
00908                 }
00909 
00910                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00911             }
00912 
00913             FreeAssignTable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00914 
00915             <span class="comment">//</span>
00916             <span class="comment">// Process the AssignTable to remove any entry which is marked as IOP_ASSIGN_IGNORE.</span>
00917             <span class="comment">//</span>
00918 
00919             AssignEntryOriginal = *AssignTablePP;
00920             AssignTableEnd = AssignTable + DeviceCount;
00921             <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd;) {
00922 
00923                 <span class="keywordflow">if</span> (!(AssignEntryOriginal-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>)) {
00924 
00925                     *AssignEntry = *AssignEntryOriginal;
00926                     AssignEntry++;
00927 
00928                 }
00929                 AssignEntryOriginal++;
00930             }
00931         }
00932 
00933     } <span class="keywordflow">else</span> {
00934 
00935         <span class="comment">//</span>
00936         <span class="comment">// Only process devices with no resource requirements. Rest get STATUS_RETRY.</span>
00937         <span class="comment">//</span>
00938 
00939         <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; AssignEntry++) {
00940 
00941             <span class="keywordflow">if</span> (    !(AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>) &amp;&amp;
00942                     AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>) {
00943 
00944                 <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00945 
00946                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>, (<span class="stringliteral">"Delaying resources requiring device %ws...\n"</span>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
00947                 <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(AssignEntry, AssignEntry + 1);
00948                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_RETRY;
00949 
00950             }
00951         }
00952 
00953         <span class="comment">//</span>
00954         <span class="comment">// Release the I/O Registry Semaphore</span>
00955         <span class="comment">//</span>
00956 
00957         <span class="keywordflow">if</span> (!Locked) {
00958 
00959             <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>, 0, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00960             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00961 
00962         }
00963 
00964         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00965     }
00966     AssignTableCount = (ULONG)(AssignTableEnd - AssignTable);
00967     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AssignTableCount == DeviceCount);
00968 
00969     <span class="comment">//</span>
00970     <span class="comment">// Sort the AssignTable</span>
00971     <span class="comment">//</span>
00972 
00973     <a class="code" href="../../d5/d1/pnpres_8c.html#a59">IopRearrangeAssignTable</a>(AssignTable, DeviceCount);
00974 
00975     <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; AssignEntry++) {
00976 
00977         <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00978 
00979         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>, (<span class="stringliteral">"Pnpres: Trying to allocate resources for %ws.\n"</span>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
00980 
00981         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a67">IopAssignInner</a>(1, AssignEntry, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00982         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00983 
00984             <a class="code" href="../../d5/d1/pnpres_8c.html#a65">IopBuildCmResourceLists</a>(AssignEntry, AssignEntry + 1);
00985             <span class="keywordflow">if</span> (AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>) {
00986 
00987                 <a class="code" href="../../d5/d1/pnpres_8c.html#a96">IopReleaseFilteredBootResources</a>(AssignEntry, AssignEntry + 1);
00988             }
00989         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INSUFFICIENT_RESOURCES) {
00990 
00991             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"IopAllocateResource: Failed to allocate Pool.\n"</span>));
00992             <span class="keywordflow">break</span>;
00993 
00994         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tryRebalance) {
00995 
00996             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>, (<span class="stringliteral">"IopAllocateResources: Initiating REBALANCE...\n"</span>));
00997 
00998             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a35">DNF_NEEDS_REBALANCE</a>;
00999             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a85">IopRebalance</a>(1, AssignEntry);
01000             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a35">DNF_NEEDS_REBALANCE</a>;
01001             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01002                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_CONFLICTING_ADDRESSES;
01003             }
01004         } <span class="keywordflow">else</span> {
01005             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_CONFLICTING_ADDRESSES;
01006         }
01007     }
01008 
01009     <span class="comment">//</span>
01010     <span class="comment">// IF we did not go through the entire table without any error,</span>
01011     <span class="comment">// mark remaining entries as RETRY.</span>
01012     <span class="comment">//</span>
01013 
01014     <span class="keywordflow">for</span> (; AssignEntry &lt; AssignTableEnd; AssignEntry++) {
01015 
01016         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_RETRY;
01017     }
01018 
01019     <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(AssignTable, AssignTableEnd);
01020 
01021     <span class="comment">//</span>
01022     <span class="comment">// Release the I/O Registry Semaphore</span>
01023     <span class="comment">//</span>
01024 
01025     <span class="keywordflow">if</span> (!Locked) {
01026         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>, 0, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01027         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>( );
01028     }
01029 
01030     <span class="comment">//</span>
01031     <span class="comment">// Copy the information in our own AssignTable to caller's AssignTable</span>
01032     <span class="comment">//</span>
01033 
01034     <span class="keywordflow">if</span> (FreeAssignTable) {
01035         AssignEntryOriginal = *AssignTablePP;
01036         <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd;) {
01037             <span class="keywordflow">if</span> (AssignEntryOriginal-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a67">IOP_ASSIGN_RETRY</a>)) {
01038                 AssignEntryOriginal++;
01039                 <span class="keywordflow">continue</span>;
01040             }
01041             *AssignEntryOriginal = *AssignEntry;
01042             AssignEntry++;
01043             AssignEntryOriginal++;
01044         }
01045         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AssignEntryOriginal &lt;= *AssignTablePP + *DeviceCountP);
01046         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(AssignTable);
01047     }
01048 
01049     AssignEntry = *AssignTablePP;
01050     <span class="keywordflow">while</span> (AssignEntry &lt; *AssignTablePP + *DeviceCountP) {
01051         <span class="keywordflow">if</span> (AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a67">IOP_ASSIGN_RETRY</a>)) {
01052             AssignEntry++;
01053             <span class="keywordflow">continue</span>;
01054         }
01055         <span class="keywordflow">if</span> ((AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>) || AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01056 
01057             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_CONFLICTING_ADDRESSES;
01058         }
01059         AssignEntry++;
01060     }
01061 
01062     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01063 }
01064 
01065 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01066"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a56">01066</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a56">IopGetResourceRequirementsForAssignTable</a>(
01067     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable,
01068     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTableEnd,
01069     OUT PULONG DeviceCount
01070     )
01071 
01072 <span class="comment">/*++</span>
01073 <span class="comment"></span>
01074 <span class="comment">Routine Description:</span>
01075 <span class="comment"></span>
01076 <span class="comment">    For each AssignTable entry, this routine queries device's IO resource requirements</span>
01077 <span class="comment">    list and converts it to our internal REQ_LIST format.</span>
01078 <span class="comment"></span>
01079 <span class="comment">Parameters:</span>
01080 <span class="comment"></span>
01081 <span class="comment">    AssignTable - supplies a pointer to the first entry of a IOP_RESOURCE_REQUEST table.</span>
01082 <span class="comment"></span>
01083 <span class="comment">    AssignTableEnd - supplies a pointer to the end of IOP_RESOURCE_REQUEST table.</span>
01084 <span class="comment"></span>
01085 <span class="comment">Return Value:</span>
01086 <span class="comment"></span>
01087 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
01088 <span class="comment"></span>
01089 <span class="comment">--*/</span>
01090 
01091 {
01092     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, FinalStatus = STATUS_UNSUCCESSFUL;
01093     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignEntry;
01094     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDevice;
01095     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode;
01096     ULONG Length, <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
01097 
01098     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01099 
01100     <span class="comment">//</span>
01101     <span class="comment">// Go thru each entry, if the io resource requirements is not established,</span>
01102     <span class="comment">// we will first see if the device node contains an io resreq, if yes, we will</span>
01103     <span class="comment">// use it.  Otherwise, we will query resource requirements from the driver and cache</span>
01104     <span class="comment">// it in our device node structure.</span>
01105     <span class="comment">//</span>
01106 
01107     <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; ++AssignEntry) {
01108 
01109         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01110         <span class="keywordflow">if</span> (AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>) {
01111             FinalStatus = STATUS_SUCCESS;
01112             <span class="keywordflow">continue</span>;
01113         }
01114 
01115         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01116         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01117         PhysicalDevice = AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>;
01118         DeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)PhysicalDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01119 
01120         <span class="keywordflow">if</span> (DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>) {
01121             <span class="keywordflow">if</span> (DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>) {
01122                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>);
01123                 DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01124 
01125                 <span class="comment">//</span>
01126                 <span class="comment">// Mark that we need to cleare the resource requirements changed flag when</span>
01127                 <span class="comment">// succeed.</span>
01128                 <span class="comment">//</span>
01129 
01130                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a73">IOP_ASSIGN_CLEAR_RESOURCE_REQUIREMENTS_CHANGE_FLAG</a>;
01131                 DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a16">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>;
01132                 <span class="comment">//DeviceNode-&gt;Flags &amp;= ~DNF_RESOURCE_REQUIREMENTS_CHANGED;</span>
01133             }
01134         }
01135 
01136         <span class="keywordflow">if</span> (!AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>) {
01137             <span class="keywordflow">if</span> (DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a> &amp;&amp;
01138                 !(DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a16">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>)) {
01139                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"Pnpres: Resource requirements list already exists for %ws\n"</span>, DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
01140                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>;
01141                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a> = <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>;
01142             } <span class="keywordflow">else</span> {
01143                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>,(<span class="stringliteral">"Pnpres: Query Resource requirements list for %ws...\n"</span>, DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
01144                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d1/pnpirp_8c.html#a27">IopQueryDeviceResources</a> (PhysicalDevice,
01145                                                   <a class="code" href="../../d9/d0/pnpiop_8h.html#a61">QUERY_RESOURCE_REQUIREMENTS</a>,
01146                                                   &amp;AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>,
01147                                                   &amp;Length
01148                                                   );
01149                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01150                     AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>;
01151                     AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01152                     <span class="keywordflow">continue</span>;
01153                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01154 
01155                     <span class="comment">//</span>
01156                     <span class="comment">// Status Success with NULL ResourceRequirements means</span>
01157                     <span class="comment">// no resource required.</span>
01158                     <span class="comment">//</span>
01159 
01160                     AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>;
01161                     AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01162                     <span class="keywordflow">continue</span>;
01163                 }
01164                 <span class="keywordflow">if</span> (DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>) {
01165                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>);
01166                     DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a16">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>;
01167                 }
01168                 DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a> = AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>;
01169             }
01170         }
01171 
01172         <span class="comment">//</span>
01173         <span class="comment">// For non-stop case, even though the res req list has changed, we need</span>
01174         <span class="comment">// to guarantee that it still get its current setting, if possible.</span>
01175         <span class="comment">// Note, if the new resreq list does not cover the old setting.  It's bus</span>
01176         <span class="comment">// drivers' responsibility to guarantee that non of their child would be</span>
01177         <span class="comment">// affected. Otherwise, the bus drivers should not ask for non-stop.</span>
01178         <span class="comment">//</span>
01179 
01180         <span class="keywordflow">if</span> (AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a72">IOP_ASSIGN_KEEP_CURRENT_CONFIG</a>) {
01181             PIO_RESOURCE_REQUIREMENTS_LIST filteredList;
01182             BOOLEAN exactMatch;
01183 
01184             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a29">IopFilterResourceRequirementsList</a> (
01185                          AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>,
01186                          DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>,
01187                          &amp;filteredList,
01188                          &amp;exactMatch
01189                          );
01190             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01191 
01192                 <span class="comment">//</span>
01193                 <span class="comment">// Do not free the original AssignEntry-&gt;ResourceRequirements.</span>
01194                 <span class="comment">// It is used by deviceNode-&gt;ResourceRequirements.</span>
01195                 <span class="comment">//</span>
01196 
01197                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> = filteredList;
01198             } <span class="keywordflow">else</span> {
01199                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a72">IOP_ASSIGN_KEEP_CURRENT_CONFIG</a>;
01200             }
01201         }
01202 
01203 <span class="preprocessor">#if DBG_SCOPE</span>
01204 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>) {
01205             <a class="code" href="../../d5/d1/pnpres_8c.html#a97">IopDumpResourceRequirementsList</a>(AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>);
01206         }
01207 <span class="preprocessor">#endif</span>
01208 <span class="preprocessor"></span>
01209         <span class="comment">//</span>
01210         <span class="comment">// Convert Io resource requirements list to our internal representation.</span>
01211         <span class="comment">//</span>
01212 
01213         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a57">IopResourceRequirementsListToReqList</a>(
01214                         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a>,
01215                         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>,
01216                         PhysicalDevice,
01217                         &amp;AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>);
01218 
01219         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01220             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>;
01221             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01222             <span class="keywordflow">continue</span>;
01223         } <span class="keywordflow">else</span> {
01224             <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> ReqList;
01225 
01226             ReqList = (<a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a>)AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>;
01227             ReqList-&gt;AssignEntry = AssignEntry;
01228 
01229             <span class="comment">//</span>
01230             <span class="comment">// Sort the ReqList such that the higher priority Alternative list are</span>
01231              <span class="comment">// placed in the front of the list.</span>
01232             <span class="comment">//</span>
01233 
01234             <a class="code" href="../../d5/d1/pnpres_8c.html#a58">IopRearrangeReqList</a>(ReqList);
01235             <span class="keywordflow">if</span> (ReqList-&gt;ReqBestAlternative == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01236 
01237                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>;
01238                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_DEVICE_CONFIGURATION_ERROR;
01239                 <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(AssignEntry, AssignEntry + 1);
01240                 <span class="keywordflow">continue</span>;
01241 
01242             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReqList-&gt;ReqAlternativeCount &lt; 3) {
01243 
01244                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a> = 0;
01245 
01246             } <span class="keywordflow">else</span> {
01247 
01248                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a> = ReqList-&gt;ReqAlternativeCount;
01249 
01250             }
01251         }
01252 
01253         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_SUCCESS;
01254         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++;
01255 
01256         <span class="comment">//</span>
01257         <span class="comment">// As long as there is one entry established, we will return success.</span>
01258         <span class="comment">//</span>
01259 
01260         FinalStatus = STATUS_SUCCESS;
01261     }
01262     *DeviceCount = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
01263     <span class="keywordflow">return</span> FinalStatus;
01264 }
01265 
01266 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01267"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a57">01267</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a57">IopResourceRequirementsListToReqList</a>(
01268     IN ARBITER_REQUEST_SOURCE AllocationType,
01269     IN PIO_RESOURCE_REQUIREMENTS_LIST IoResources,
01270     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDevice,
01271     OUT PVOID *ResReqList
01272     )
01273 
01274 <span class="comment">/*++</span>
01275 <span class="comment"></span>
01276 <span class="comment">Routine Description:</span>
01277 <span class="comment"></span>
01278 <span class="comment">    This routine processes the input Io resource requirements list and</span>
01279 <span class="comment">    generates an internal REQ_LIST and its related structures.</span>
01280 <span class="comment"></span>
01281 <span class="comment">Parameters:</span>
01282 <span class="comment"></span>
01283 <span class="comment">    IoResources - supplies a pointer to the Io resource requirements List.</span>
01284 <span class="comment"></span>
01285 <span class="comment">    PhysicalDevice - supplies a pointer to the physical device object requesting</span>
01286 <span class="comment">            the resources.</span>
01287 <span class="comment"></span>
01288 <span class="comment">    ReqList - supplies a pointer to a variable to receive the returned REQ_LIST.</span>
01289 <span class="comment"></span>
01290 <span class="comment">Return Value:</span>
01291 <span class="comment"></span>
01292 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
01293 <span class="comment"></span>
01294 <span class="comment">--*/</span>
01295 
01296 {
01297     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01298     PIO_RESOURCE_LIST IoResourceList = IoResources-&gt;List;
01299     PIO_RESOURCE_DESCRIPTOR IoResourceDescriptor, BaseDescriptor, firstDescriptor;
01300     PIO_RESOURCE_DESCRIPTOR IoResourceDescriptorEnd;
01301     LONG IoResourceListCount = (LONG) IoResources-&gt;AlternativeLists;
01302     PUCHAR CoreEnd = (PUCHAR) IoResources + IoResources-&gt;ListSize;
01303     ULONG ReqAlternativeCount = IoResourceListCount;
01304     ULONG ReqDescAlternativeCount = 0;
01305     ULONG AlternativeDescriptorCount = 0;  <span class="comment">// count of descriptors with IO_RESOURCE_ALTERNATIVE flag set</span>
01306     <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> ReqList;
01307     BOOLEAN NoAlternativeDescriptor;
01308     INTERFACE_TYPE interfaceType;
01309     ULONG busNumber;
01310     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    failureStatus = STATUS_UNSUCCESSFUL;
01311     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    finalStatus = STATUS_SUCCESS;
01312 
01313     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01314 
01315     *ResReqList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01316 
01317     <span class="comment">//</span>
01318     <span class="comment">// Make sure there is some resource requirements to be fulfilled.</span>
01319     <span class="comment">//</span>
01320 
01321     <span class="keywordflow">if</span> (IoResourceListCount == 0) {
01322         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>, (<span class="stringliteral">"PnpRes: No ResReqList to convert to ReqList\n"</span>));
01323         <span class="keywordflow">return</span> STATUS_SUCCESS;
01324     }
01325 
01326     <span class="comment">//</span>
01327     <span class="comment">// ***** Phase 1 *****</span>
01328     <span class="comment">//</span>
01329     <span class="comment">// Parse the IO ResReq list to make sure it is valid and to determine the sizes of</span>
01330     <span class="comment">// internal structures.</span>
01331     <span class="comment">//</span>
01332 
01333     <span class="keywordflow">while</span> (--IoResourceListCount &gt;= 0) {
01334 
01335         IoResourceDescriptor = firstDescriptor = IoResourceList-&gt;Descriptors;
01336         IoResourceDescriptorEnd = IoResourceDescriptor + IoResourceList-&gt;Count;
01337 
01338         <span class="keywordflow">if</span> (IoResourceDescriptor == IoResourceDescriptorEnd) {
01339 
01340             <span class="comment">//</span>
01341             <span class="comment">// An alternative list with zero descriptor count</span>
01342             <span class="comment">//</span>
01343 
01344             <span class="keywordflow">return</span> STATUS_SUCCESS;
01345         }
01346         <span class="comment">//</span>
01347         <span class="comment">// Perform sanity check.  We have not allocated any pool space.</span>
01348         <span class="comment">// If failed, simply return failure status.</span>
01349         <span class="comment">//</span>
01350 
01351         <span class="keywordflow">if</span> ((PUCHAR) IoResourceDescriptor &gt; CoreEnd) {
01352 
01353             <span class="comment">//</span>
01354             <span class="comment">// The structure header (excluding the variable length Descriptors array) is</span>
01355             <span class="comment">// invalid.</span>
01356             <span class="comment">//</span>
01357 
01358             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes: Invalid ResReqList\n"</span>));
01359             <span class="keywordflow">goto</span> InvalidParameter;
01360         }
01361 
01362         <span class="keywordflow">if</span> (IoResourceDescriptor &gt; IoResourceDescriptorEnd ||
01363             (PUCHAR) IoResourceDescriptorEnd &gt; CoreEnd) {
01364 
01365             <span class="comment">//</span>
01366             <span class="comment">// IoResourceDescriptorEnd is the result of arithmetic overflow;</span>
01367             <span class="comment">// or, the descriptor array is outside of the valid memory.</span>
01368             <span class="comment">//</span>
01369 
01370             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes: Invalid ResReqList\n"</span>));
01371             <span class="keywordflow">goto</span> InvalidParameter;
01372         }
01373 
01374         <span class="keywordflow">if</span> (IoResourceDescriptor-&gt;Type == CmResourceTypeConfigData) {
01375             IoResourceDescriptor++;
01376             firstDescriptor++;
01377         }
01378         NoAlternativeDescriptor = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01379         <span class="keywordflow">while</span> (IoResourceDescriptor &lt; IoResourceDescriptorEnd) {
01380             <span class="keywordflow">switch</span> (IoResourceDescriptor-&gt;Type) {
01381             <span class="keywordflow">case</span> CmResourceTypeConfigData:
01382 <span class="preprocessor">#if DBG_SCOPE</span>
01383 <span class="preprocessor"></span>                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>) {
01384                      <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PnPRes: Invalid ResReq list !!!\n"</span>);
01385                      <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        ConfigData descriptors are per-LogConf and\n"</span>);
01386                      <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        should be at the beginning of an AlternativeList\n"</span>);
01387                      <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
01388                  }
01389 <span class="preprocessor">#endif</span>
01390 <span class="preprocessor"></span>                 <span class="keywordflow">goto</span> InvalidParameter;
01391 
01392             <span class="keywordflow">case</span> CmResourceTypeDevicePrivate:
01393                  <span class="keywordflow">while</span> (IoResourceDescriptor &lt; IoResourceDescriptorEnd &amp;&amp;
01394                         IoResourceDescriptor-&gt;Type == CmResourceTypeDevicePrivate) {
01395                      <span class="keywordflow">if</span> (IoResourceDescriptor == firstDescriptor) {
01396 <span class="preprocessor">#if DBG_SCOPE</span>
01397 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>) {
01398                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PnPRes: Invalid ResReq list !!!\n"</span>);
01399                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        The first descriptor of a LogConf can not be\n"</span>);
01400                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        a DevicePrivate descriptor.\n"</span>);
01401                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
01402                         }
01403 <span class="preprocessor">#endif</span>
01404 <span class="preprocessor"></span>                        <span class="keywordflow">goto</span> InvalidParameter;
01405                      }
01406                      ReqDescAlternativeCount++;   <span class="comment">// Count number of descriptors</span>
01407                      IoResourceDescriptor++;
01408                  }
01409                  NoAlternativeDescriptor = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01410                  <span class="keywordflow">break</span>;
01411 
01412             <span class="keywordflow">default</span>:
01413 
01414                 ++ReqDescAlternativeCount;        <span class="comment">// Count number of descriptors</span>
01415 
01416                 <span class="comment">//</span>
01417                 <span class="comment">// For non-arbitrated resource type, set its Option to preferred such</span>
01418                 <span class="comment">// that we won't get confused.</span>
01419                 <span class="comment">//</span>
01420 
01421                 <span class="keywordflow">if</span> ((IoResourceDescriptor-&gt;Type &amp; CmResourceTypeNonArbitrated) ||
01422                     (IoResourceDescriptor-&gt;Type == CmResourceTypeNull)) {
01423 
01424                     <span class="keywordflow">if</span> (IoResourceDescriptor-&gt;Type == <a class="code" href="../../d9/d0/pnpiop_8h.html#a74">CmResourceTypeReserved</a>) {
01425                         --ReqDescAlternativeCount;
01426                     }
01427                     IoResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
01428                     IoResourceDescriptor++;
01429                     NoAlternativeDescriptor = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01430                     <span class="keywordflow">break</span>;
01431                 }
01432                 <span class="keywordflow">if</span> (IoResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
01433                     <span class="keywordflow">if</span> (NoAlternativeDescriptor) {
01434 <span class="preprocessor">#if DBG_SCOPE</span>
01435 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>) {
01436                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PnPRes: Invalid ResReq list !!!\n"</span>);
01437                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        Alternative descriptor without Default or Preferred descriptor.\n"</span>);
01438                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
01439                         }
01440 <span class="preprocessor">#endif</span>
01441 <span class="preprocessor"></span>                       <span class="keywordflow">goto</span> InvalidParameter;
01442                     }
01443                     ++AlternativeDescriptorCount; <span class="comment">// Count number of Alternative descriptors</span>
01444                 } <span class="keywordflow">else</span> {
01445                     NoAlternativeDescriptor = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01446                 }
01447                 IoResourceDescriptor++;
01448                 <span class="keywordflow">break</span>;
01449             }
01450         }
01451         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IoResourceDescriptor == IoResourceDescriptorEnd);
01452         IoResourceList = (PIO_RESOURCE_LIST) IoResourceDescriptorEnd;
01453     }
01454 
01455     <span class="comment">//</span>
01456     <span class="comment">// ***** Phase 2 *****</span>
01457     <span class="comment">//</span>
01458     <span class="comment">// Allocate structures and initialize them according to caller's Io ResReq list.</span>
01459     <span class="comment">//</span>
01460 
01461     {
01462         ULONG ReqDescCount = ReqDescAlternativeCount - AlternativeDescriptorCount;
01463         PUCHAR PoolStart;
01464         ULONG PoolSize;
01465         <a class="code" href="../../d2/d1/struct__IOP__POOL.html">IOP_POOL</a> OuterPool;
01466         <a class="code" href="../../d2/d1/struct__IOP__POOL.html">IOP_POOL</a> ReqAlternativePool;
01467         <a class="code" href="../../d2/d1/struct__IOP__POOL.html">IOP_POOL</a> ReqDescPool;
01468 
01469         <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> ReqAlternative;
01470         <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *ReqAlternativePP;
01471 <span class="preprocessor">#if DBG</span>
01472 <span class="preprocessor"></span>        <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *ReqAlternativeEndPP;
01473 <span class="preprocessor">#endif</span>
01474 <span class="preprocessor"></span>        <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> ReqDesc;
01475         <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> *ReqDescPP;
01476         ULONG ReqAlternativeIndex;
01477         ULONG ReqDescIndex;
01478 
01479         <span class="comment">//</span>
01480         <span class="comment">// Each structure in the list has a variable length array.</span>
01481         <span class="comment">// Those arrays are declared in their typedefs as arrays with one element,</span>
01482         <span class="comment">// that extra element is not being substracted because it provides an</span>
01483         <span class="comment">// extra 4 bytes of memory that is 50% (statistically) wasted and 50%</span>
01484         <span class="comment">// (statistically) used to allow for 8 byte alignment of all the structures.</span>
01485         <span class="comment">//</span>
01486         <span class="comment">// Allocate the pool and fail if the allocation failed.</span>
01487         <span class="comment">//</span>
01488 
01489         {
01490             ULONG ReqListPoolSize =
01491                 (FIELD_OFFSET(REQ_LIST, ReqAlternativeTable) +
01492                 <span class="keyword">sizeof</span>(PVOID) * ReqAlternativeCount + <a class="code" href="../../d5/d1/pnpres_8c.html#a18">STRUCTURE_ALIGNMENT</a> - 1) &amp;
01493                 ~(<a class="code" href="../../d5/d1/pnpres_8c.html#a18">STRUCTURE_ALIGNMENT</a> - 1);
01494 
01495             ULONG ReqAlternativePoolSize = (ReqAlternativeCount *
01496                 (FIELD_OFFSET(REQ_ALTERNATIVE, ReqDescTable) +
01497                 + <span class="keyword">sizeof</span>(PVOID) * ReqDescCount + <a class="code" href="../../d5/d1/pnpres_8c.html#a18">STRUCTURE_ALIGNMENT</a> - 1))
01498                 &amp; ~(<a class="code" href="../../d5/d1/pnpres_8c.html#a18">STRUCTURE_ALIGNMENT</a> - 1);
01499 
01500             ULONG ReqDescPoolSize = (ReqDescCount * (<span class="keyword">sizeof</span>(REQ_DESC) + <a class="code" href="../../d5/d1/pnpres_8c.html#a18">STRUCTURE_ALIGNMENT</a> - 1))
01501                 &amp; ~(<a class="code" href="../../d5/d1/pnpres_8c.html#a18">STRUCTURE_ALIGNMENT</a> - 1);
01502 
01503             PoolSize = ReqListPoolSize + ReqAlternativePoolSize + ReqDescPoolSize;
01504 
01505             PoolStart = <a class="code" href="../../d5/d1/pnpres_8c.html#a2">ExAllocatePoolRD</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, PoolSize);
01506             <span class="keywordflow">if</span> (!PoolStart) {
01507                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01508             }
01509             <a class="code" href="../../d5/d1/pnpres_8c.html#a19">IopInitPool</a>(&amp;OuterPool, PoolStart, PoolSize);
01510 
01511             <span class="comment">//</span>
01512             <span class="comment">// Partition the OuterPool into inner pools.</span>
01513             <span class="comment">//</span>
01514 
01515             <a class="code" href="../../d5/d1/pnpres_8c.html#a20">IopAllocPoolAligned</a>(&amp;ReqList, &amp;OuterPool, ReqListPoolSize);
01516 
01517             <a class="code" href="../../d5/d1/pnpres_8c.html#a20">IopAllocPoolAligned</a>(&amp;PoolStart, &amp;OuterPool, ReqAlternativePoolSize);
01518             <a class="code" href="../../d5/d1/pnpres_8c.html#a19">IopInitPool</a>(&amp;ReqAlternativePool, PoolStart, ReqAlternativePoolSize);
01519 
01520             <a class="code" href="../../d5/d1/pnpres_8c.html#a20">IopAllocPoolAligned</a>(&amp;PoolStart, &amp;OuterPool, ReqDescPoolSize);
01521             <a class="code" href="../../d5/d1/pnpres_8c.html#a19">IopInitPool</a>(&amp;ReqDescPool, PoolStart, ReqDescPoolSize);
01522         }
01523 
01524         <span class="comment">//</span>
01525         <span class="comment">// Convert the IO_RESOURCE_REQUIREMENTS_LIST into the REQ_LIST.</span>
01526         <span class="comment">//</span>
01527 
01528         ReqAlternativePP = ReqList-&gt;ReqAlternativeTable;
01529         RtlZeroMemory(ReqAlternativePP, ReqAlternativeCount * <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a>));
01530 <span class="preprocessor">#if DBG</span>
01531 <span class="preprocessor"></span>        ReqAlternativeEndPP = ReqAlternativePP + ReqAlternativeCount;
01532 <span class="preprocessor">#endif</span>
01533 <span class="preprocessor"></span>        ReqList-&gt;ReqAlternativeCount = ReqAlternativeCount;
01534         ReqList-&gt;PhysicalDevice = PhysicalDevice;
01535         ReqList-&gt;InterfaceType = IoResources-&gt;InterfaceType;
01536         <span class="keywordflow">if</span> (ReqList-&gt;InterfaceType == InterfaceTypeUndefined) {
01537             ReqList-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
01538         }
01539 
01540         ReqList-&gt;BusNumber = IoResources-&gt;BusNumber;
01541         ReqList-&gt;SelectedAlternative = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01542         ReqAlternativeIndex = 0;
01543 
01544         interfaceType = IoResources-&gt;InterfaceType;
01545         <span class="keywordflow">if</span> (interfaceType == InterfaceTypeUndefined) {
01546             interfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
01547         }
01548         busNumber = IoResources-&gt;BusNumber;
01549         IoResourceList = IoResources-&gt;List;
01550         IoResourceListCount = IoResources-&gt;AlternativeLists;
01551 
01552         <span class="keywordflow">while</span> (--IoResourceListCount &gt;= 0) {
01553             ULONG arbiterFlag;
01554 
01555             IoResourceDescriptor = IoResourceList-&gt;Descriptors;
01556             IoResourceDescriptorEnd = IoResourceDescriptor + IoResourceList-&gt;Count;
01557 
01558             <span class="comment">//</span>
01559             <span class="comment">// For each Io alternate list, we create a REQ_ALTERNATE table</span>
01560             <span class="comment">//</span>
01561 
01562             <a class="code" href="../../d5/d1/pnpres_8c.html#a20">IopAllocPoolAligned</a>(&amp;ReqAlternative, &amp;ReqAlternativePool, FIELD_OFFSET(REQ_ALTERNATIVE, ReqDescTable));
01563             ReqAlternative-&gt;ReqList = ReqList;
01564             ReqAlternative-&gt;ReqAlternativeIndex = ReqAlternativeIndex++;
01565             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ReqAlternativePP &lt; ReqAlternativeEndPP);
01566             *ReqAlternativePP++ = ReqAlternative;
01567             ReqAlternative-&gt;ReqDescCount = 0;
01568             ReqAlternative-&gt;ReqDescTableEnd = ReqAlternative-&gt;ReqDescTable;
01569 
01570             <span class="comment">//</span>
01571             <span class="comment">// If the first descriptor of the alternative is a CmResourceTypeConfigData</span>
01572             <span class="comment">// it contains priority information.</span>
01573             <span class="comment">//</span>
01574 
01575             <span class="keywordflow">if</span> (IoResourceDescriptor-&gt;Type == CmResourceTypeConfigData) {
01576                 ReqAlternative-&gt;Priority = IoResourceDescriptor-&gt;u.ConfigData.Priority;
01577                 IoResourceDescriptor++;
01578             } <span class="keywordflow">else</span> {
01579                 ReqAlternative-&gt;Priority = LCPRI_NORMAL;
01580             }
01581 
01582             <span class="keywordflow">if</span> (ReqAlternative-&gt;Priority == LCPRI_BOOTCONFIG) {
01583                 arbiterFlag = <a class="code" href="../../d6/d9/pnp_8h.html#a8">ARBITER_FLAG_BOOT_CONFIG</a>;
01584             } <span class="keywordflow">else</span> {
01585                 arbiterFlag = 0;
01586             }
01587 
01588             ReqDescPP = ReqAlternative-&gt;ReqDescTable;
01589             ReqDescIndex = 0;
01590 
01591             <span class="keywordflow">while</span> (IoResourceDescriptor &lt; IoResourceDescriptorEnd) {
01592 
01593                 <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a> ArbiterListEntry;
01594 
01595                 <span class="keywordflow">if</span> (IoResourceDescriptor-&gt;Type == <a class="code" href="../../d9/d0/pnpiop_8h.html#a74">CmResourceTypeReserved</a>) {
01596                     interfaceType = IoResourceDescriptor-&gt;u.DevicePrivate.Data[0];
01597                     <span class="keywordflow">if</span> (interfaceType == InterfaceTypeUndefined) {
01598                         interfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
01599                     }
01600                     busNumber = IoResourceDescriptor-&gt;u.DevicePrivate.Data[1];
01601                     IoResourceDescriptor++;
01602                 } <span class="keywordflow">else</span> {
01603                     <a class="code" href="../../d5/d1/pnpres_8c.html#a20">IopAllocPoolAligned</a>(&amp;ReqDesc, &amp;ReqDescPool, <span class="keyword">sizeof</span>(REQ_DESC));
01604                     ReqDesc-&gt;ArbitrationRequired =
01605                         (IoResourceDescriptor-&gt;Type &amp; CmResourceTypeNonArbitrated ||
01606                          IoResourceDescriptor-&gt;Type == CmResourceTypeNull) ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01607                     ReqDesc-&gt;ReqAlternative = ReqAlternative;
01608                     ReqDesc-&gt;ReqDescIndex = ReqDescIndex++;
01609                     ReqDesc-&gt;DevicePrivateCount = 0;
01610                     ReqDesc-&gt;DevicePrivate = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01611                     ReqDesc-&gt;InterfaceType = interfaceType;
01612                     ReqDesc-&gt;BusNumber = busNumber;
01613 
01614                     <a class="code" href="../../d5/d1/pnpres_8c.html#a21">IopAllocPool</a>(&amp;PoolStart, &amp;ReqAlternativePool, <span class="keyword">sizeof</span>(PVOID));
01615 
01616                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PoolStart == (PUCHAR) ReqDescPP);
01617 
01618                     *ReqDescPP++ = ReqDesc;
01619                     ++ReqAlternative-&gt;ReqDescCount;
01620                     ++ReqAlternative-&gt;ReqDescTableEnd;
01621 
01622                     ReqDesc-&gt;TranslatedReqDesc = ReqDesc;  <span class="comment">// TranslatedReqDesc points to itself.</span>
01623 
01624                     ArbiterListEntry = &amp;ReqDesc-&gt;AlternativeTable;
01625                     InitializeListHead(&amp;ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>);
01626                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a> = 0;
01627                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o2">Alternatives</a> = IoResourceDescriptor;
01628                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a> = PhysicalDevice;
01629                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o4">RequestSource</a> = AllocationType;
01630                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o5">Flags</a> = arbiterFlag;
01631                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o6">WorkSpace</a> = 0;
01632                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o7">InterfaceType</a> = interfaceType;
01633                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o8">SlotNumber</a> = IoResources-&gt;SlotNumber;
01634                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o9">BusNumber</a> = IoResources-&gt;BusNumber;
01635                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o10">Assignment</a> = &amp;ReqDesc-&gt;Allocation;
01636                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o12">Result</a> = <a class="code" href="../../d6/d9/pnp_8h.html#a175a131">ArbiterResultUndefined</a>;
01637 
01638                     <span class="keywordflow">if</span> (ReqDesc-&gt;ArbitrationRequired) {
01639 
01640                         <span class="comment">//</span>
01641                         <span class="comment">// The BestAlternativeTable and BestAllocation are not initialized.</span>
01642                         <span class="comment">// They will be initialized when needed.</span>
01643 
01644                         <span class="comment">//</span>
01645                         <span class="comment">// Initialize the Cm partial resource descriptor to NOT_ALLOCATED.</span>
01646                         <span class="comment">//</span>
01647 
01648                         ReqDesc-&gt;Allocation.Type = CmResourceTypeMaximum;
01649 
01650                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((IoResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) == 0);
01651 
01652                         ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a>++;
01653                         IoResourceDescriptor++;
01654                         <span class="keywordflow">while</span> (IoResourceDescriptor &lt; IoResourceDescriptorEnd) {
01655                             <span class="keywordflow">if</span> (IoResourceDescriptor-&gt;Type == CmResourceTypeDevicePrivate) {
01656                                 ReqDesc-&gt;DevicePrivate = IoResourceDescriptor;
01657                                 <span class="keywordflow">while</span> (IoResourceDescriptor &lt; IoResourceDescriptorEnd &amp;&amp;
01658                                        IoResourceDescriptor-&gt;Type == CmResourceTypeDevicePrivate) {
01659                                     ReqDesc-&gt;DevicePrivateCount++;
01660                                     ++IoResourceDescriptor;
01661                                 }
01662                                 <span class="keywordflow">break</span>;
01663                             }
01664                             <span class="keywordflow">if</span> (IoResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
01665                                 ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a>++;
01666                                 IoResourceDescriptor++;
01667                             } <span class="keywordflow">else</span> {
01668                                 <span class="keywordflow">break</span>;
01669                             }
01670                         }
01671 
01672                         <span class="comment">//</span>
01673                         <span class="comment">// Next query Arbiter and Translator interfaces for the resource desc.</span>
01674                         <span class="comment">//</span>
01675 
01676                         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a75">IopSetupArbiterAndTranslators</a>(ReqDesc);
01677                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01678                             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes: Unable to setup Arbiter and Translators\n"</span>));
01679                             ReqAlternativeIndex--;
01680                             ReqAlternativePP--;
01681                             ReqList-&gt;ReqAlternativeCount--;
01682                             <a class="code" href="../../d5/d1/pnpres_8c.html#a62">IopFreeReqAlternative</a>(ReqAlternative);
01683                             failureStatus = status;
01684                             <span class="keywordflow">break</span>;
01685                         }
01686                     } <span class="keywordflow">else</span> {
01687                         ReqDesc-&gt;Allocation.Type = IoResourceDescriptor-&gt;Type;
01688                         ReqDesc-&gt;Allocation.ShareDisposition = IoResourceDescriptor-&gt;ShareDisposition;
01689                         ReqDesc-&gt;Allocation.Flags = IoResourceDescriptor-&gt;Flags;
01690                         ReqDesc-&gt;Allocation.u.DevicePrivate.Data[0] =
01691                             IoResourceDescriptor-&gt;u.DevicePrivate.Data[0];
01692                         ReqDesc-&gt;Allocation.u.DevicePrivate.Data[1] =
01693                             IoResourceDescriptor-&gt;u.DevicePrivate.Data[1];
01694                         ReqDesc-&gt;Allocation.u.DevicePrivate.Data[2] =
01695                             IoResourceDescriptor-&gt;u.DevicePrivate.Data[2];
01696 
01697                         IoResourceDescriptor++;
01698                     }
01699                 }
01700 
01701                 <span class="keywordflow">if</span> (IoResourceDescriptor &gt;= IoResourceDescriptorEnd) <span class="keywordflow">break</span>;
01702             }
01703             IoResourceList = (PIO_RESOURCE_LIST) IoResourceDescriptorEnd;
01704         }
01705         <span class="keywordflow">if</span> (ReqAlternativeIndex == 0) {
01706             finalStatus = failureStatus;
01707             <a class="code" href="../../d5/d1/pnpres_8c.html#a63">IopFreeReqList</a>(ReqList);
01708         }
01709     }
01710 
01711     <span class="keywordflow">if</span> (finalStatus == STATUS_SUCCESS) {
01712         *ResReqList = ReqList;
01713     }
01714 
01715     <span class="keywordflow">return</span> finalStatus;
01716 
01717 InvalidParameter:
01718     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01719 }
01720 
01721 <span class="keywordtype">int</span>
01722 __cdecl
<a name="l01723"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a60">01723</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a60">IopComparePriority</a>(
01724     <span class="keyword">const</span> <span class="keywordtype">void</span> *arg1,
01725     <span class="keyword">const</span> <span class="keywordtype">void</span> *arg2
01726     )
01727 
01728 <span class="comment">/*++</span>
01729 <span class="comment"></span>
01730 <span class="comment">Routine Description:</span>
01731 <span class="comment"></span>
01732 <span class="comment">    This routine compares the priority of arg1 and arg1.  It is used in C run time sort.</span>
01733 <span class="comment"></span>
01734 <span class="comment">Parameters:</span>
01735 <span class="comment"></span>
01736 <span class="comment">    Arg1, arg2 - a pointer to PREQ_ALTERNATIVE</span>
01737 <span class="comment"></span>
01738 <span class="comment">Return Value:</span>
01739 <span class="comment"></span>
01740 <span class="comment">    &lt; 0 if arg1 &lt; arg2</span>
01741 <span class="comment">    = 0 if arg1 = arg2</span>
01742 <span class="comment">    &gt; 0 if arg1 &gt; arg2</span>
01743 <span class="comment"></span>
01744 <span class="comment">--*/</span>
01745 
01746 {
01747     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> RA1 = *(<a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *)arg1;
01748     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> RA2 = *(<a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *)arg2;
01749 
01750     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01751 
01752     <span class="keywordflow">if</span> (RA1-&gt;Priority == RA2-&gt;Priority) {
01753         <span class="keywordflow">if</span> ((ULONG_PTR)RA1 &lt; (ULONG_PTR)RA2) {
01754             <span class="keywordflow">return</span> -1;
01755         } <span class="keywordflow">else</span> {
01756             <span class="keywordflow">return</span> 1;
01757         }
01758     }
01759     <span class="keywordflow">if</span> (RA1-&gt;Priority &gt; RA2-&gt;Priority) {
01760         <span class="keywordflow">return</span> 1;
01761     } <span class="keywordflow">else</span> {
01762         <span class="keywordflow">return</span> -1;
01763     }
01764 }
01765 <span class="keywordtype">int</span>
01766 __cdecl
<a name="l01767"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a106">01767</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a106">IopCompareAlternativeCount</a>(
01768     <span class="keyword">const</span> <span class="keywordtype">void</span> *arg1,
01769     <span class="keyword">const</span> <span class="keywordtype">void</span> *arg2
01770     )
01771 
01772 <span class="comment">/*++</span>
01773 <span class="comment"></span>
01774 <span class="comment">Routine Description:</span>
01775 <span class="comment"></span>
01776 <span class="comment">    This routine compares the priority of arg1 and arg1.  It is used in C run time sort.</span>
01777 <span class="comment"></span>
01778 <span class="comment">Parameters:</span>
01779 <span class="comment"></span>
01780 <span class="comment">    Arg1, arg2 - a pointer to PREQ_ALTERNATIVE</span>
01781 <span class="comment"></span>
01782 <span class="comment">Return Value:</span>
01783 <span class="comment"></span>
01784 <span class="comment">    &lt; 0 if arg1 &lt; arg2</span>
01785 <span class="comment">    = 0 if arg1 = arg2</span>
01786 <span class="comment">    &gt; 0 if arg1 &gt; arg2</span>
01787 <span class="comment"></span>
01788 <span class="comment">--*/</span>
01789 
01790 {
01791     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> RR1 = (<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>)arg1;
01792     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> RR2 = (<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>)arg2;
01793 
01794     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01795 
01796     <span class="keywordflow">if</span> (RR1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a> == RR2-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a>) {
01797         <span class="keywordflow">if</span> ((ULONG_PTR)RR1 &lt; (ULONG_PTR)RR2) {
01798             <span class="keywordflow">return</span> -1;
01799         } <span class="keywordflow">else</span> {
01800             <span class="keywordflow">return</span> 1;
01801         }
01802     }
01803     <span class="keywordflow">if</span> (RR1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a> &gt; RR2-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a>) {
01804         <span class="keywordflow">return</span> 1;
01805     } <span class="keywordflow">else</span> {
01806         <span class="keywordflow">return</span> -1;
01807     }
01808 }
01809 
01810 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01811"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a58">01811</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a58">IopRearrangeReqList</a> (
01812     IN PREQ_LIST ReqList
01813     )
01814 
01815 <span class="comment">/*++</span>
01816 <span class="comment"></span>
01817 <span class="comment">Routine Description:</span>
01818 <span class="comment"></span>
01819 <span class="comment">    This routine sorts the REQ_ALTERNATIVE lists of REQ_LIST in increasing order (in terms of</span>
01820 <span class="comment">    priority value.)  Priority 1 is considered better than priority 2.</span>
01821 <span class="comment"></span>
01822 <span class="comment">    So, the better choice is placed in front of the list.</span>
01823 <span class="comment"></span>
01824 <span class="comment">Parameters:</span>
01825 <span class="comment"></span>
01826 <span class="comment">    ReqList - Supplies a pointer to a REQ_LIST.</span>
01827 <span class="comment"></span>
01828 <span class="comment">Return Value:</span>
01829 <span class="comment"></span>
01830 <span class="comment">    None.</span>
01831 <span class="comment"></span>
01832 <span class="comment">--*/</span>
01833 
01834 {
01835     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *alternative;
01836     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *lastAlternative;
01837 
01838     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01839 
01840     <span class="keywordflow">if</span> (ReqList-&gt;ReqAlternativeCount &gt; 1) {
01841 
01842         qsort(  (<span class="keywordtype">void</span> *)ReqList-&gt;ReqAlternativeTable,
01843                 ReqList-&gt;ReqAlternativeCount,
01844                 <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a>),
01845                 <a class="code" href="../../d5/d1/pnpres_8c.html#a60">IopComparePriority</a>);
01846 
01847     }
01848 
01849     <span class="comment">//</span>
01850     <span class="comment">// Set the BestAlternative so that we try alternatives with priority &lt;= LCPRI_LASTSOFTCONFIG.</span>
01851     <span class="comment">//</span>
01852 
01853     alternative = &amp;ReqList-&gt;ReqAlternativeTable[0];
01854     <span class="keywordflow">for</span> (lastAlternative = alternative + ReqList-&gt;ReqAlternativeCount; alternative &lt; lastAlternative; alternative++) {
01855 
01856         <span class="keywordflow">if</span> ((*alternative)-&gt;Priority &gt; LCPRI_LASTSOFTCONFIG) {
01857 
01858             <span class="keywordflow">break</span>;
01859 
01860         }
01861     }
01862 
01863     <span class="keywordflow">if</span> (alternative == &amp;ReqList-&gt;ReqAlternativeTable[0]) {
01864 
01865         <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)ReqList-&gt;PhysicalDevice-&gt;DeviceObjectExtension-&gt;DeviceNode;
01866 
01867         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PNPRES: Invalid priorities in the logical configs for %ws\n"</span>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
01868 <span class="comment">//        ASSERT(alternative != &amp;ReqList-&gt;ReqAlternativeTable[0]);</span>
01869         ReqList-&gt;ReqBestAlternative = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01870 
01871     } <span class="keywordflow">else</span> {
01872 
01873         ReqList-&gt;ReqBestAlternative = alternative;
01874     }
01875 }
01876 
01877 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01878"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a59">01878</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a59">IopRearrangeAssignTable</a> (
01879     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable,
01880     IN ULONG Count
01881     )
01882 
01883 <span class="comment">/*++</span>
01884 <span class="comment"></span>
01885 <span class="comment">Routine Description:</span>
01886 <span class="comment"></span>
01887 <span class="comment">    This routine sorts the REQ_ALTERNATIVE lists of REQ_LIST in increasing order (in terms of</span>
01888 <span class="comment">    priority value.)  Priority 1 is considered better than priority 2.</span>
01889 <span class="comment"></span>
01890 <span class="comment">    So, the better choice is placed in front of the list.</span>
01891 <span class="comment"></span>
01892 <span class="comment">Parameters:</span>
01893 <span class="comment"></span>
01894 <span class="comment">    ReqList - Supplies a pointer to a REQ_LIST.</span>
01895 <span class="comment"></span>
01896 <span class="comment">Return Value:</span>
01897 <span class="comment"></span>
01898 <span class="comment">    None.</span>
01899 <span class="comment"></span>
01900 <span class="comment">--*/</span>
01901 
01902 {
01903     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01904 
01905     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == 1 || <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == 0) {
01906 
01907         <span class="comment">//</span>
01908         <span class="comment">// Most ReqLists only have one alternative...</span>
01909         <span class="comment">//</span>
01910 
01911         <span class="keywordflow">return</span>;
01912     }
01913 
01914     qsort((<span class="keywordtype">void</span> *)AssignTable,
01915           <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>,
01916           <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>),
01917           <a class="code" href="../../d5/d1/pnpres_8c.html#a106">IopCompareAlternativeCount</a>
01918           );
01919 }
01920 
01921 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01922"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a62">01922</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a62">IopFreeReqAlternative</a> (
01923     IN PREQ_ALTERNATIVE ReqAlternative
01924     )
01925 {
01926     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>   reqDesc, reqDescx;
01927     ULONG       i;
01928 
01929     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01930 
01931     <span class="keywordflow">if</span> (ReqAlternative) {
01932         <span class="keywordflow">for</span> (i = 0; i &lt; ReqAlternative-&gt;ReqDescCount; i++) {
01933             reqDesc = ReqAlternative-&gt;ReqDescTable[i];
01934             reqDescx = reqDesc-&gt;TranslatedReqDesc;
01935             <span class="keywordflow">while</span> (reqDescx &amp;&amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a14">IS_TRANSLATED_REQ_DESC</a>(reqDescx)) {
01936                 reqDesc = reqDescx;
01937                 <span class="keywordflow">if</span> (reqDescx-&gt;AlternativeTable.Alternatives) {
01938                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reqDescx-&gt;AlternativeTable.Alternatives);
01939                 }
01940                 reqDescx = reqDescx-&gt;TranslatedReqDesc;
01941                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reqDesc);
01942             }
01943         }
01944     }
01945 }
01946 
01947 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01948"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a63">01948</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a63">IopFreeReqList</a> (
01949     IN PREQ_LIST ReqList
01950     )
01951 
01952 <span class="comment">/*++</span>
01953 <span class="comment"></span>
01954 <span class="comment">Routine Description:</span>
01955 <span class="comment"></span>
01956 <span class="comment">    This routine release the ReqList associated with a resource requirements list</span>
01957 <span class="comment"></span>
01958 <span class="comment">Parameters:</span>
01959 <span class="comment"></span>
01960 <span class="comment">    ReqList - supplies a pointer to the REQ_LIST.</span>
01961 <span class="comment"></span>
01962 <span class="comment">Return Value:</span>
01963 <span class="comment"></span>
01964 <span class="comment">    None.</span>
01965 <span class="comment"></span>
01966 <span class="comment">--*/</span>
01967 
01968 {
01969     ULONG i;
01970 
01971     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01972 
01973     <span class="keywordflow">if</span> (ReqList) {
01974 
01975         <span class="comment">//</span>
01976         <span class="comment">// First we need to free all the *extra* req descs for translators.</span>
01977         <span class="comment">// The default Req Desc will be freed when the ReqList is freed.</span>
01978         <span class="comment">//</span>
01979 
01980         <span class="keywordflow">for</span> (i = 0; i &lt; ReqList-&gt;ReqAlternativeCount; i++) {
01981             <a class="code" href="../../d5/d1/pnpres_8c.html#a62">IopFreeReqAlternative</a>(ReqList-&gt;ReqAlternativeTable[i]);
01982         }
01983         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ReqList);
01984     }
01985 }
01986 
01987 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01988"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a61">01988</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(
01989     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable,
01990     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTableEnd
01991     )
01992 
01993 <span class="comment">/*++</span>
01994 <span class="comment"></span>
01995 <span class="comment">Routine Description:</span>
01996 <span class="comment"></span>
01997 <span class="comment">    For each AssignTable entry, this routine frees its attached REQ_LIST.</span>
01998 <span class="comment"></span>
01999 <span class="comment">Parameters:</span>
02000 <span class="comment"></span>
02001 <span class="comment">    AssignTable - supplies a pointer to the first entry of a IOP_RESOURCE_REQUEST table.</span>
02002 <span class="comment"></span>
02003 <span class="comment">    AssignTableEnd - supplies a pointer to the end of IOP_RESOURCE_REQUEST table.</span>
02004 <span class="comment"></span>
02005 <span class="comment">Return Value:</span>
02006 <span class="comment"></span>
02007 <span class="comment">    None.</span>
02008 <span class="comment"></span>
02009 <span class="comment">--*/</span>
02010 
02011 {
02012     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignEntry;
02013 
02014     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02015 
02016     <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; ++AssignEntry) {
02017         <a class="code" href="../../d5/d1/pnpres_8c.html#a63">IopFreeReqList</a>(AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>);
02018         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02019         <span class="keywordflow">if</span> (AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a72">IOP_ASSIGN_KEEP_CURRENT_CONFIG</a> &amp;&amp;
02020             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>) {
02021 
02022             <span class="comment">//</span>
02023             <span class="comment">// The REAL resreq list is cached in DeviceNode-&gt;ResourceRequirements.</span>
02024             <span class="comment">// We need to free the filtered list.</span>
02025             <span class="comment">//</span>
02026 
02027             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>);
02028             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02029         }
02030     }
02031 }
02032 
02033 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02034"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a66">02034</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a66">IopBuildCmResourceList</a> (
02035     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignEntry
02036     )
02037 <span class="comment">/*++</span>
02038 <span class="comment"></span>
02039 <span class="comment">Routine Description:</span>
02040 <span class="comment"></span>
02041 <span class="comment">    This routine walks REQ_LIST of the AssignEntry to build a corresponding</span>
02042 <span class="comment">    Cm Resource lists.  It also reports the resources to ResourceMap.</span>
02043 <span class="comment"></span>
02044 <span class="comment">Parameters:</span>
02045 <span class="comment"></span>
02046 <span class="comment">    AssignEntry - Supplies a pointer to an IOP_ASSIGN_REQUEST structure</span>
02047 <span class="comment"></span>
02048 <span class="comment">Return Value:</span>
02049 <span class="comment"></span>
02050 <span class="comment">    None.  The ResourceAssignment in AssignEntry is initialized.</span>
02051 <span class="comment"></span>
02052 <span class="comment">--*/</span>
02053 
02054 {
02055     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02056     HANDLE resourceMapKey;
02057     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> physicalDevice;
02058     <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> reqList = AssignEntry-&gt;ReqList;
02059     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> reqAlternative;
02060     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> reqDesc, reqDescx;
02061     PIO_RESOURCE_DESCRIPTOR privateData;
02062     ULONG count = 0, size, i;
02063     PCM_RESOURCE_LIST cmResources, cmResourcesRaw;
02064     PCM_FULL_RESOURCE_DESCRIPTOR cmFullResource, cmFullResourceRaw;
02065     PCM_PARTIAL_RESOURCE_LIST cmPartialList, cmPartialListRaw;
02066     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDescriptor, cmDescriptorRaw, assignment, tAssignment;
02067 <span class="preprocessor">#if DBG</span>
02068 <span class="preprocessor"></span>    PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDescriptorEnd, cmDescriptorEndRaw;
02069 <span class="preprocessor">#endif</span>
02070 <span class="preprocessor"></span>
02071     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02072 
02073     <span class="comment">//</span>
02074     <span class="comment">// Determine the size of the CmResourceList</span>
02075     <span class="comment">//</span>
02076 
02077     <span class="comment">//</span>
02078     <span class="comment">// Determine the size of the CmResourceList</span>
02079     <span class="comment">//</span>
02080 
02081     reqAlternative = *reqList-&gt;SelectedAlternative;
02082     <span class="keywordflow">for</span> (i = 0; i &lt; reqAlternative-&gt;ReqDescCount; i++) {
02083         reqDesc = reqAlternative-&gt;ReqDescTable[i];
02084         count += reqDesc-&gt;DevicePrivateCount + 1;
02085     }
02086 
02087     size = <span class="keyword">sizeof</span>(CM_RESOURCE_LIST) + <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR) * (count - 1);
02088     cmResources = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d1/pnpres_8c.html#a3">ExAllocatePoolCMRL</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size);
02089     <span class="keywordflow">if</span> (!cmResources) {
02090 
02091         <span class="comment">//</span>
02092         <span class="comment">// If we can not find memory, the resources will not be committed by arbiter.</span>
02093         <span class="comment">//</span>
02094 
02095         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes: Not enough memory to build Translated CmResourceList\n"</span>));
02096         AssignEntry-&gt;Status = STATUS_INSUFFICIENT_RESOURCES;
02097         AssignEntry-&gt;ResourceAssignment = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02098         AssignEntry-&gt;TranslatedResourceAssignment = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02099         <span class="keywordflow">return</span>;
02100     }
02101     cmResourcesRaw = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d1/pnpres_8c.html#a4">ExAllocatePoolCMRR</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size);
02102     <span class="keywordflow">if</span> (!cmResourcesRaw) {
02103         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes: Not enough memory to build Raw CmResourceList\n"</span>));
02104         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResources);
02105         AssignEntry-&gt;Status = STATUS_INSUFFICIENT_RESOURCES;
02106         AssignEntry-&gt;ResourceAssignment = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02107         AssignEntry-&gt;TranslatedResourceAssignment = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02108         <span class="keywordflow">return</span>;
02109     }
02110     cmResources-&gt;Count = 1;
02111     cmFullResource = cmResources-&gt;List;
02112 
02113     <span class="comment">//</span>
02114     <span class="comment">// The CmResourceList we build here does not distinguish the</span>
02115     <span class="comment">// Interface Type on descriptor level.  This should be fine because</span>
02116     <span class="comment">// for IoReportResourceUsage we ignore the CmResourceList we build</span>
02117     <span class="comment">// here.</span>
02118     <span class="comment">//</span>
02119 
02120     cmFullResource-&gt;InterfaceType = reqList-&gt;InterfaceType;
02121     cmFullResource-&gt;BusNumber = reqList-&gt;BusNumber;
02122     cmPartialList = &amp;cmFullResource-&gt;PartialResourceList;
02123     cmPartialList-&gt;Version = 0;
02124     cmPartialList-&gt;Revision = 0;
02125     cmPartialList-&gt;Count = count;
02126     cmDescriptor = cmPartialList-&gt;PartialDescriptors;
02127 <span class="preprocessor">#if DBG</span>
02128 <span class="preprocessor"></span>    cmDescriptorEnd = cmDescriptor + count;
02129 <span class="preprocessor">#endif</span>
02130 <span class="preprocessor"></span>    cmResourcesRaw-&gt;Count = 1;
02131     cmFullResourceRaw = cmResourcesRaw-&gt;List;
02132     cmFullResourceRaw-&gt;InterfaceType = reqList-&gt;InterfaceType;
02133     cmFullResourceRaw-&gt;BusNumber = reqList-&gt;BusNumber;
02134     cmPartialListRaw = &amp;cmFullResourceRaw-&gt;PartialResourceList;
02135     cmPartialListRaw-&gt;Version = 0;
02136     cmPartialListRaw-&gt;Revision = 0;
02137     cmPartialListRaw-&gt;Count = count;
02138     cmDescriptorRaw = cmPartialListRaw-&gt;PartialDescriptors;
02139 <span class="preprocessor">#if DBG</span>
02140 <span class="preprocessor"></span>    cmDescriptorEndRaw = cmDescriptorRaw + count;
02141 <span class="preprocessor">#endif</span>
02142 <span class="preprocessor"></span>
02143     <span class="keywordflow">for</span> (i = 0; i &lt; reqAlternative-&gt;ReqDescCount; i++) {
02144         reqDesc = reqAlternative-&gt;ReqDescTable[i];
02145 
02146         <span class="keywordflow">if</span> (reqDesc-&gt;ArbitrationRequired) {
02147 
02148             <span class="comment">//</span>
02149             <span class="comment">// Get raw assignment and copy it to our raw resource list</span>
02150             <span class="comment">//</span>
02151 
02152             reqDescx = reqDesc-&gt;TranslatedReqDesc;
02153             <span class="keywordflow">if</span> (reqDescx-&gt;AlternativeTable.Result != <a class="code" href="../../d6/d9/pnp_8h.html#a175a134">ArbiterResultNullRequest</a>) {
02154                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a76">IopParentToRawTranslation</a>(reqDescx);
02155                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02156                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes: Parent To Raw translation failed\n"</span>));
02157                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResources);
02158                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResourcesRaw);
02159                     AssignEntry-&gt;Status = STATUS_INSUFFICIENT_RESOURCES;
02160                     AssignEntry-&gt;ResourceAssignment = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02161                     <span class="keywordflow">return</span>;
02162                 }
02163                 assignment = reqDesc-&gt;AlternativeTable.Assignment;
02164             } <span class="keywordflow">else</span> {
02165                 assignment = reqDescx-&gt;AlternativeTable.Assignment;
02166             }
02167             *cmDescriptorRaw = *assignment;
02168             cmDescriptorRaw++;
02169 
02170             <span class="comment">//</span>
02171             <span class="comment">// Translate assignment and copy it to our translated resource list</span>
02172             <span class="comment">//</span>
02173             <span class="keywordflow">if</span> (reqDescx-&gt;AlternativeTable.Result != <a class="code" href="../../d6/d9/pnp_8h.html#a175a134">ArbiterResultNullRequest</a>) {
02174                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a77">IopChildToRootTranslation</a>(
02175                              (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)reqDesc-&gt;AlternativeTable.PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode,
02176                              reqDesc-&gt;InterfaceType,
02177                              reqDesc-&gt;BusNumber,
02178                              reqDesc-&gt;AlternativeTable.RequestSource,
02179                              &amp;reqDesc-&gt;Allocation,
02180                              &amp;tAssignment
02181                              );
02182                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02183                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes: Child to Root translation failed\n"</span>));
02184                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResources);
02185                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResourcesRaw);
02186                     AssignEntry-&gt;Status = STATUS_INSUFFICIENT_RESOURCES;
02187                     AssignEntry-&gt;ResourceAssignment = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02188                     <span class="keywordflow">return</span>;
02189                 }
02190                 *cmDescriptor = *tAssignment;
02191                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(tAssignment);
02192             } <span class="keywordflow">else</span> {
02193                 *cmDescriptor = *(reqDescx-&gt;AlternativeTable.Assignment);
02194             }
02195             cmDescriptor++;
02196 
02197         } <span class="keywordflow">else</span> {
02198             *cmDescriptorRaw = reqDesc-&gt;Allocation;
02199             *cmDescriptor = reqDesc-&gt;Allocation;
02200             cmDescriptorRaw++;
02201             cmDescriptor++;
02202         }
02203 
02204         <span class="comment">//</span>
02205         <span class="comment">// Next copy the device private descriptors to CmResourceLists</span>
02206         <span class="comment">//</span>
02207 
02208         count = reqDesc-&gt;DevicePrivateCount;
02209         privateData = reqDesc-&gt;DevicePrivate;
02210         <span class="keywordflow">while</span> (count != 0) {
02211 
02212             cmDescriptor-&gt;Type = cmDescriptorRaw-&gt;Type = CmResourceTypeDevicePrivate;
02213             cmDescriptor-&gt;ShareDisposition = cmDescriptorRaw-&gt;ShareDisposition =
02214                          CmResourceShareDeviceExclusive;
02215             cmDescriptor-&gt;Flags = cmDescriptorRaw-&gt;Flags = privateData-&gt;Flags;
02216             RtlMoveMemory(&amp;cmDescriptorRaw-&gt;u.DevicePrivate,
02217                           &amp;privateData-&gt;u.DevicePrivate,
02218                           <span class="keyword">sizeof</span>(cmDescriptorRaw-&gt;u.DevicePrivate.Data)
02219                           );
02220             RtlMoveMemory(&amp;cmDescriptor-&gt;u.DevicePrivate,
02221                           &amp;privateData-&gt;u.DevicePrivate,
02222                           <span class="keyword">sizeof</span>(cmDescriptor-&gt;u.DevicePrivate.Data)
02223                           );
02224             privateData++;
02225             cmDescriptorRaw++;
02226             cmDescriptor++;
02227             count--;
02228             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(cmDescriptorRaw &lt;= cmDescriptorEndRaw);
02229             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(cmDescriptor &lt;= cmDescriptorEnd);
02230         }
02231         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(cmDescriptor &lt;= cmDescriptorEnd);
02232         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(cmDescriptorRaw &lt;= cmDescriptorEndRaw);
02233 
02234     }
02235 
02236     <span class="comment">//</span>
02237     <span class="comment">// report assigned resources to ResourceMap</span>
02238     <span class="comment">//</span>
02239 
02240     physicalDevice = AssignEntry-&gt;PhysicalDevice;
02241 
02242     <span class="comment">//</span>
02243     <span class="comment">// Open ResourceMap key</span>
02244     <span class="comment">//</span>
02245 
02246     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;resourceMapKey,
02247                                      (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02248                                      &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a19">CmRegistryMachineHardwareResourceMapName</a>,
02249                                      KEY_READ | KEY_WRITE,
02250                                      REG_OPTION_VOLATILE,
02251                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02252                                      );
02253     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status )) {
02254         WCHAR DeviceBuffer[256];
02255         POBJECT_NAME_INFORMATION NameInformation;
02256         ULONG NameLength;
02257         UNICODE_STRING UnicodeClassName;
02258         UNICODE_STRING UnicodeDriverName;
02259         UNICODE_STRING UnicodeDeviceName;
02260 
02261         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeClassName, PNPMGR_STR_PNP_MANAGER);
02262 
02263         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeDriverName, REGSTR_KEY_PNP_DRIVER);
02264 
02265         NameInformation = (POBJECT_NAME_INFORMATION) DeviceBuffer;
02266         status = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>( physicalDevice,
02267                                     NameInformation,
02268                                     <span class="keyword">sizeof</span>( DeviceBuffer ),
02269                                     &amp;NameLength );
02270         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02271             NameInformation-&gt;Name.MaximumLength = <span class="keyword">sizeof</span>(DeviceBuffer) - <span class="keyword">sizeof</span>(OBJECT_NAME_INFORMATION);
02272             <span class="keywordflow">if</span> (NameInformation-&gt;Name.Length == 0) {
02273                 NameInformation-&gt;Name.Buffer = (PVOID)((ULONG_PTR)DeviceBuffer + <span class="keyword">sizeof</span>(OBJECT_NAME_INFORMATION));
02274             }
02275 
02276             UnicodeDeviceName = NameInformation-&gt;Name;
02277             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeDeviceName, <a class="code" href="../../d3/d5/iodata_8c.html#a75">IopWstrRaw</a>);
02278 
02279             <span class="comment">//</span>
02280             <span class="comment">// IopWriteResourceList should remove all the device private and device</span>
02281             <span class="comment">// specifiec descriptors.</span>
02282             <span class="comment">//</span>
02283 
02284             status = <a class="code" href="../../d1/d8/report_8c.html#a15">IopWriteResourceList</a>(
02285                          resourceMapKey,
02286                          &amp;UnicodeClassName,
02287                          &amp;UnicodeDriverName,
02288                          &amp;UnicodeDeviceName,
02289                          cmResourcesRaw,
02290                          size
02291                          );
02292             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02293                 UnicodeDeviceName = NameInformation-&gt;Name;
02294                 <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a> (&amp;UnicodeDeviceName, <a class="code" href="../../d7/d9/assign_8c.html#a28">IopWstrTranslated</a>);
02295                 status = <a class="code" href="../../d1/d8/report_8c.html#a15">IopWriteResourceList</a>(
02296                              resourceMapKey,
02297                              &amp;UnicodeClassName,
02298                              &amp;UnicodeDriverName,
02299                              &amp;UnicodeDeviceName,
02300                              cmResources,
02301                              size
02302                              );
02303             }
02304         }
02305         ZwClose(resourceMapKey);
02306     }
02307 <span class="preprocessor">#if 0 // Ignore the registry writing status.</span>
02308 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02309         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResources);
02310         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResourcesRaw);
02311         cmResources = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02312         cmResourcesRaw = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02313     }
02314 <span class="preprocessor">#endif</span>
02315 <span class="preprocessor"></span>    AssignEntry-&gt;ResourceAssignment = cmResourcesRaw;
02316     AssignEntry-&gt;TranslatedResourceAssignment = cmResources;
02317 }
02318 
02319 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02320"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a65">02320</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a65">IopBuildCmResourceLists</a>(
02321     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable,
02322     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTableEnd
02323     )
02324 
02325 <span class="comment">/*++</span>
02326 <span class="comment"></span>
02327 <span class="comment">Routine Description:</span>
02328 <span class="comment"></span>
02329 <span class="comment">    For each AssignTable entry, this routine queries device's IO resource requirements</span>
02330 <span class="comment">    list and converts it to our internal REQ_LIST format.</span>
02331 <span class="comment"></span>
02332 <span class="comment">Parameters:</span>
02333 <span class="comment"></span>
02334 <span class="comment">    AssignTable - supplies a pointer to the first entry of a IOP_RESOURCE_REQUEST table.</span>
02335 <span class="comment"></span>
02336 <span class="comment">    AssignTableEnd - supplies a pointer to the end of IOP_RESOURCE_REQUEST table.</span>
02337 <span class="comment"></span>
02338 <span class="comment">Return Value:</span>
02339 <span class="comment"></span>
02340 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
02341 <span class="comment"></span>
02342 <span class="comment">--*/</span>
02343 
02344 {
02345     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02346     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> assignEntry;
02347     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> physicalDevice;
02348     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
02349 
02350     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02351 
02352     <span class="comment">//</span>
02353     <span class="comment">// Go thru each entry, for each Physical device object, we build a CmResourceList</span>
02354     <span class="comment">// from its ListOfAssignedResources.</span>
02355     <span class="comment">//</span>
02356 
02357     <span class="keywordflow">for</span> (assignEntry = AssignTable; assignEntry &lt; AssignTableEnd; ++assignEntry) {
02358 
02359         assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02360         <span class="keywordflow">if</span> (assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a> || assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a67">IOP_ASSIGN_RETRY</a>) {
02361             <span class="keywordflow">continue</span>;
02362         }
02363         <span class="keywordflow">if</span> (assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>) {
02364             assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_UNSUCCESSFUL;
02365             <span class="keywordflow">continue</span>;
02366         }
02367         assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_SUCCESS;
02368         <a class="code" href="../../d5/d1/pnpres_8c.html#a66">IopBuildCmResourceList</a> (assignEntry);
02369         <span class="keywordflow">if</span> (assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>) {
02370             physicalDevice = assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>;
02371             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)physicalDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
02372             <a class="code" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry</a>(
02373                   deviceNode,
02374                   assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>,
02375                   <a class="code" href="../../d9/d0/pnpiop_8h.html#a254">IopDetermineResourceListSize</a>(assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>)
02376                   );
02377 <span class="preprocessor">#if DBG_SCOPE</span>
02378 <span class="preprocessor"></span>            <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>,(<span class="stringliteral">"Pnpres: Building CM resource lists for %ws...\n"</span>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
02379             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>) {
02380                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Raw resources "</span>);
02381                 <a class="code" href="../../d1/d8/report_8c.html#a17">IopDumpCmResourceList</a>(assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>);
02382                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Translated resources "</span>);
02383                 <a class="code" href="../../d1/d8/report_8c.html#a17">IopDumpCmResourceList</a>(assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a>);
02384             }
02385 <span class="preprocessor">#endif</span>
02386 <span class="preprocessor"></span>        }
02387     }
02388 }
02389 
02390 BOOLEAN
<a name="l02391"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a95">02391</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a95">IopNeedToReleaseBootResources</a>(
02392     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
02393     IN PCM_RESOURCE_LIST AllocatedResources
02394     )
02395 
02396 <span class="comment">/*++</span>
02397 <span class="comment"></span>
02398 <span class="comment">Routine Description:</span>
02399 <span class="comment"></span>
02400 <span class="comment">    This routine checks the AllocatedResources against boot allocated resources.</span>
02401 <span class="comment">    If the allocated resources do not cover all the resource types in boot resources,</span>
02402 <span class="comment">    in another words some types of boot resources have not been released by arbiter,</span>
02403 <span class="comment">    we will return TRUE to indicate we need to release the boot resources manually.</span>
02404 <span class="comment"></span>
02405 <span class="comment">Parameters:</span>
02406 <span class="comment"></span>
02407 <span class="comment">    DeviceNode -  A device node</span>
02408 <span class="comment"></span>
02409 <span class="comment">    AllocatedResources - the resources assigned to the devicenode by arbiters.</span>
02410 <span class="comment"></span>
02411 <span class="comment">Return Value:</span>
02412 <span class="comment"></span>
02413 <span class="comment">    TRUE or FALSE.</span>
02414 <span class="comment"></span>
02415 <span class="comment">--*/</span>
02416 
02417 {
02418     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc_a, cmFullDesc_b;
02419     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDescriptor_a, cmDescriptor_b;
02420     ULONG size_a, size_b, i, j, k;
02421     BOOLEAN returnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, found;
02422     PCM_RESOURCE_LIST bootResources;
02423 
02424     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02425 
02426     bootResources = DeviceNode-&gt;BootResources;
02427     <span class="keywordflow">if</span> (AllocatedResources-&gt;Count == 1 &amp;&amp; bootResources &amp;&amp; bootResources-&gt;Count != 0) {
02428 
02429         cmFullDesc_a = &amp;AllocatedResources-&gt;List[0];
02430         cmFullDesc_b = &amp;bootResources-&gt;List[0];
02431         <span class="keywordflow">for</span> (i = 0; i &lt; bootResources-&gt;Count; i++) {
02432             cmDescriptor_b = &amp;cmFullDesc_b-&gt;PartialResourceList.PartialDescriptors[0];
02433             <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc_b-&gt;PartialResourceList.Count; j++) {
02434                 size_b = 0;
02435                 <span class="keywordflow">switch</span> (cmDescriptor_b-&gt;Type) {
02436                 <span class="keywordflow">case</span> CmResourceTypeNull:
02437                     <span class="keywordflow">break</span>;
02438                 <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
02439                      size_b = cmDescriptor_b-&gt;u.DeviceSpecificData.DataSize;
02440                      <span class="keywordflow">break</span>;
02441                 <span class="keywordflow">default</span>:
02442                      <span class="keywordflow">if</span> (cmDescriptor_b-&gt;Type &lt; CmResourceTypeMaximum) {
02443                          found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02444                          cmDescriptor_a = &amp;cmFullDesc_a-&gt;PartialResourceList.PartialDescriptors[0];
02445                          <span class="keywordflow">for</span> (k = 0; k &lt; cmFullDesc_a-&gt;PartialResourceList.Count; k++) {
02446                              size_a = 0;
02447                              <span class="keywordflow">if</span> (cmDescriptor_a-&gt;Type == CmResourceTypeDeviceSpecific) {
02448                                  size_a = cmDescriptor_a-&gt;u.DeviceSpecificData.DataSize;
02449                              } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmDescriptor_b-&gt;Type == cmDescriptor_a-&gt;Type) {
02450                                  found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02451                                  <span class="keywordflow">break</span>;
02452                              }
02453                              cmDescriptor_a++;
02454                              cmDescriptor_a = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmDescriptor_a + size_a);
02455                          }
02456                          <span class="keywordflow">if</span> (found == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02457                              returnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02458                              <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
02459                          }
02460                      }
02461                 }
02462                 cmDescriptor_b++;
02463                 cmDescriptor_b = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmDescriptor_b + size_b);
02464             }
02465             cmFullDesc_b = (PCM_FULL_RESOURCE_DESCRIPTOR)cmDescriptor_b;
02466         }
02467     }
02468 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
02469     <span class="keywordflow">return</span> returnValue;
02470 }
02471 
02472 
02473 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02474"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a96">02474</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a96">IopReleaseFilteredBootResources</a>(
02475     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable,
02476     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTableEnd
02477     )
02478 
02479 <span class="comment">/*++</span>
02480 <span class="comment"></span>
02481 <span class="comment">Routine Description:</span>
02482 <span class="comment"></span>
02483 <span class="comment">    For each AssignTable entry, this routine checks if we need to manually release the device's</span>
02484 <span class="comment">    boot resources.</span>
02485 <span class="comment"></span>
02486 <span class="comment">Parameters:</span>
02487 <span class="comment"></span>
02488 <span class="comment">    AssignTable - supplies a pointer to the first entry of a IOP_RESOURCE_REQUEST table.</span>
02489 <span class="comment"></span>
02490 <span class="comment">    AssignTableEnd - supplies a pointer to the end of IOP_RESOURCE_REQUEST table.</span>
02491 <span class="comment"></span>
02492 <span class="comment">Return Value:</span>
02493 <span class="comment"></span>
02494 <span class="comment">    None.</span>
02495 <span class="comment"></span>
02496 <span class="comment">--*/</span>
02497 
02498 {
02499     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02500     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> assignEntry;
02501     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> physicalDevice;
02502     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
02503 
02504     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02505 
02506     <span class="comment">//</span>
02507     <span class="comment">// Go thru each entry, for each Physical device object, we build a CmResourceList</span>
02508     <span class="comment">// from its ListOfAssignedResources.</span>
02509     <span class="comment">//</span>
02510 
02511     <span class="keywordflow">for</span> (assignEntry = AssignTable; assignEntry &lt; AssignTableEnd; ++assignEntry) {
02512 
02513         <span class="keywordflow">if</span> (assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>) {
02514             physicalDevice = assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>;
02515             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)physicalDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
02516 
02517             <span class="comment">//</span>
02518             <span class="comment">// Release the device's boot resources if desired</span>
02519             <span class="comment">// (If a driver filters its res req list and removes some boot resources, after arbiter satisfies</span>
02520             <span class="comment">// the new res req list, the filtered out boot resources do not get</span>
02521             <span class="comment">// released by arbiters.  Because they no longer passed to arbiters. )</span>
02522             <span class="comment">// I am not 100% sure we should release the filtered boot resources.  But that's what arbiters try</span>
02523             <span class="comment">// to achieve.  So, we will do it.</span>
02524             <span class="comment">//</span>
02525 
02526             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a95">IopNeedToReleaseBootResources</a>(deviceNode, assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>)) {
02527                 <a class="code" href="../../d5/d1/pnpres_8c.html#a87">IopReleaseResourcesInternal</a>(deviceNode);
02528                 <a class="code" href="../../d5/d1/pnpres_8c.html#a94">IopReserveBootResourcesInternal</a>(
02529                         <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>,
02530                         physicalDevice,
02531                         assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>);
02532                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a13">DNF_BOOT_CONFIG_RESERVED</a>;  <span class="comment">// Keep DeviceNode-&gt;BootResources</span>
02533                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>;
02534                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a89">IopRestoreResourcesInternal</a>(deviceNode);
02535                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
02536                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02537 
02538                     <span class="comment">//</span>
02539                     <span class="comment">// BUGBUG - according to arbiter design, we should bugcheck.</span>
02540                     <span class="comment">//</span>
02541 
02542                     assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>;
02543                     assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = status;
02544                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>);
02545                     assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02546                 }
02547                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02548             }
02549         }
02550     }
02551 }
02552 
02553 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02554"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a68">02554</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a68">IopPlacement</a>(
02555     IN ARBITER_ACTION ArbiterAction,
02556     IN BOOLEAN Rebalance
02557     )
02558 
02559 <span class="comment">/*++</span>
02560 <span class="comment"></span>
02561 <span class="comment">Routine Description:</span>
02562 <span class="comment"></span>
02563 <span class="comment">    This routine examines each arbiter if its resreq list changed its test function will be</span>
02564 <span class="comment">    called.</span>
02565 <span class="comment"></span>
02566 <span class="comment">Parameters:</span>
02567 <span class="comment"></span>
02568 <span class="comment">    ArbiterAction - supplies an arbiter action code to perform TEST or RETEST.</span>
02569 <span class="comment"></span>
02570 <span class="comment">Return Value:</span>
02571 <span class="comment"></span>
02572 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
02573 <span class="comment"></span>
02574 <span class="comment">--*/</span>
02575 
02576 {
02577     PLIST_ENTRY listEntry;
02578     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
02579     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02580 
02581     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ArbiterAction == <a class="code" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>)   ||
02582            (ArbiterAction == <a class="code" href="../../d6/d9/pnp_8h.html#a173a116">ArbiterActionRetestAllocation</a>) ||
02583            (ArbiterAction == <a class="code" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>));
02584 
02585     <span class="keywordflow">if</span> (Rebalance) {
02586 
02587         <span class="comment">//</span>
02588         <span class="comment">// For rebalance case, we always start from the root and work our way up.</span>
02589         <span class="comment">//</span>
02590 
02591         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a83">IopPlacementForRebalance</a> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>, ArbiterAction);
02592     } <span class="keywordflow">else</span> {
02593         listEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>.Flink;
02594         <span class="keywordflow">while</span> (listEntry != &amp;<a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>) {
02595             arbiterEntry = CONTAINING_RECORD(listEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, ActiveArbiterList);
02596             listEntry = listEntry-&gt;Flink;
02597             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02598             <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02599 
02600                 <span class="comment">//</span>
02601                 <span class="comment">// If the resource requirements are the same and it failed before, we know it</span>
02602                 <span class="comment">// won't be able to succeed.  So, return failure.</span>
02603                 <span class="comment">//</span>
02604 
02605                 <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a59">PI_ARBITER_TEST_FAILED</a>) {
02606                     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02607                 }
02608             } <span class="keywordflow">else</span> {
02609 
02610                 <span class="comment">//</span>
02611                 <span class="comment">// If the resource requirements are changed, we need to call arbiter to test it.</span>
02612                 <span class="comment">//</span>
02613 
02614                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry,
02615                                         ArbiterAction,
02616                                         &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>,
02617                                         0,
02618                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02619                                         );
02620                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02621                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ArbiterAction == <a class="code" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>);
02622                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a59">PI_ARBITER_TEST_FAILED</a>;
02623                     <span class="keywordflow">return</span> status;
02624                 } <span class="keywordflow">else</span> {
02625                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a59">PI_ARBITER_TEST_FAILED</a>;
02626                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02627                     <span class="keywordflow">if</span> (ArbiterAction == <a class="code" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>) {
02628                         arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a58">PI_ARBITER_HAS_SOMETHING</a>;
02629                     } <span class="keywordflow">else</span> {
02630                         <span class="keywordflow">if</span> (ArbiterAction == <a class="code" href="../../d6/d9/pnp_8h.html#a173a116">ArbiterActionRetestAllocation</a>) {
02631                             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry, <a class="code" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02632                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
02633                         }
02634                         arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> = 0;
02635                         InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
02636                         InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o5">BestConfig</a>);
02637                         InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>);
02638                         InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o4">BestResourceList</a>);
02639                     }
02640                 }
02641             }
02642         }
02643         status = STATUS_SUCCESS;
02644     }
02645     <span class="keywordflow">return</span> status;
02646 }
02647 
02648 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02649"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a92">02649</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a92">IopPlacementForReservation</a>(
02650     VOID
02651     )
02652 
02653 <span class="comment">/*++</span>
02654 <span class="comment"></span>
02655 <span class="comment">Routine Description:</span>
02656 <span class="comment"></span>
02657 <span class="comment">    This routine examines each arbiter if its resreq list changed its test function will be</span>
02658 <span class="comment">    called.</span>
02659 <span class="comment"></span>
02660 <span class="comment">Parameters:</span>
02661 <span class="comment"></span>
02662 <span class="comment">    None.</span>
02663 <span class="comment"></span>
02664 <span class="comment">Return Value:</span>
02665 <span class="comment"></span>
02666 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
02667 <span class="comment"></span>
02668 <span class="comment">--*/</span>
02669 
02670 {
02671     PLIST_ENTRY listEntry;
02672     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
02673     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status, returnStatus = STATUS_SUCCESS;
02674 
02675     listEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>.Flink;
02676     <span class="keywordflow">while</span> (listEntry != &amp;<a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>) {
02677         arbiterEntry = CONTAINING_RECORD(listEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, ActiveArbiterList);
02678         listEntry = listEntry-&gt;Flink;
02679         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02680         <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a>) {
02681 
02682             <span class="comment">//</span>
02683             <span class="comment">// If the resource requirements are changed, we need to call arbiter to reserve it.</span>
02684             <span class="comment">//</span>
02685 
02686             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry,
02687                                     <a class="code" href="../../d6/d9/pnp_8h.html#a173a124">ArbiterActionBootAllocation</a>,
02688                                     &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>,
02689                                     0,
02690                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02691                                     );
02692             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02693 <span class="preprocessor">#if MYDBG</span>
02694 <span class="preprocessor"></span>                <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a> arbiterListEntry = (<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a>) arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>.Flink;
02695                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Allocate Boot Resources Failed ::\n"</span>);
02696                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        Count = %x, PDO = %x\n"</span>,
02697                          arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a>, arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>);
02698                 <a class="code" href="../../d5/d1/pnpres_8c.html#a98">IopDumpResourceDescriptor</a>(
02699                    <span class="stringliteral">"        "</span>,
02700                    arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o2">Alternatives</a>);
02701 <span class="preprocessor">#endif</span>
02702 <span class="preprocessor"></span>                returnStatus = status;
02703             }
02704             arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02705             arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> = 0;
02706             InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
02707             InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o5">BestConfig</a>);
02708             InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>);
02709             InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o4">BestResourceList</a>);
02710         }
02711     }
02712     <span class="keywordflow">return</span> returnStatus;
02713 }
02714 
02715 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02716"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a69">02716</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a69">IopAddReqDescsToArbiters</a> (
02717     IN ULONG ReqDescCount,
02718     IN PREQ_DESC *ReqDescTable
02719     )
02720 
02721 <span class="comment">/*++</span>
02722 <span class="comment"></span>
02723 <span class="comment">Routine Description:</span>
02724 <span class="comment"></span>
02725 <span class="comment">    This routine adds a list of a req descriptors to their arbiters.</span>
02726 <span class="comment"></span>
02727 <span class="comment">Parameters:</span>
02728 <span class="comment"></span>
02729 <span class="comment">    P1 -</span>
02730 <span class="comment"></span>
02731 <span class="comment">Return Value:</span>
02732 <span class="comment"></span>
02733 <span class="comment">    None.</span>
02734 <span class="comment"></span>
02735 <span class="comment">--*/</span>
02736 {
02737     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>                   reqDesc;
02738     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>                   reqDescTranslated;
02739     PLIST_ENTRY                 listHead;
02740     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a>  arbiterEntry;
02741     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>                   *reqDescTableEnd;
02742 
02743     <span class="keywordflow">for</span> (reqDescTableEnd = ReqDescTable + ReqDescCount; ReqDescTable &lt; reqDescTableEnd; ReqDescTable++) {
02744 
02745         <span class="comment">//</span>
02746         <span class="comment">// For each req desc, find its arbiter, link the translated req desc to its arbiter.</span>
02747         <span class="comment">//</span>
02748 
02749         reqDesc = *ReqDescTable;
02750         <span class="keywordflow">if</span> (reqDesc-&gt;ArbitrationRequired) {
02751 
02752             reqDescTranslated = reqDesc-&gt;<a class="code" href="../../d0/d4/struct__REQ__DESC.html#o8">TranslatedReqDesc</a>;  <span class="comment">// Could be reqDesc itself</span>
02753 
02754             InitializeListHead(&amp;reqDescTranslated-&gt;AlternativeTable.ListEntry);
02755             arbiterEntry = reqDesc-&gt;u.Arbiter;
02756             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(arbiterEntry);
02757             listHead = &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>;
02758             InsertTailList(listHead, &amp;reqDescTranslated-&gt;AlternativeTable.ListEntry);
02759 
02760             arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02761             <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a58">PI_ARBITER_HAS_SOMETHING</a>) {
02762 
02763                 <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry, <a class="code" href="../../d6/d9/pnp_8h.html#a173a118">ArbiterActionRollbackAllocation</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02764                 arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a58">PI_ARBITER_HAS_SOMETHING</a>;
02765             }
02766 
02767             <span class="comment">//</span>
02768             <span class="comment">// Link the arbiter entry to our active arbiter list if it has not been</span>
02769             <span class="comment">//</span>
02770 
02771             <span class="keywordflow">if</span> (IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>)) {
02772 
02773                 InsertTailList(&amp;<a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>, &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
02774             }
02775         }
02776     }
02777 }
02778 
02779 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02780"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a70">02780</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a70">IopRemoveReqDescsFromArbiters</a> (
02781     ULONG ReqDescCount,
02782     PREQ_DESC *ReqDescTable
02783     )
02784 
02785 <span class="comment">/*++</span>
02786 <span class="comment"></span>
02787 <span class="comment">Routine Description:</span>
02788 <span class="comment"></span>
02789 <span class="comment">    This routine removes a list of a req descriptors from their arbiters.</span>
02790 <span class="comment"></span>
02791 <span class="comment">Parameters:</span>
02792 <span class="comment"></span>
02793 <span class="comment">    P1 -</span>
02794 <span class="comment"></span>
02795 <span class="comment">Return Value:</span>
02796 <span class="comment"></span>
02797 <span class="comment">    None.</span>
02798 <span class="comment"></span>
02799 <span class="comment">--*/</span>
02800 {
02801     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>                   reqDesc;
02802     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>                   reqDescTranslated;
02803     PLIST_ENTRY                 listHead;
02804     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a>  arbiterEntry;
02805     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>                   *reqDescTableEnd;
02806 
02807     <span class="keywordflow">for</span> (reqDescTableEnd = ReqDescTable + ReqDescCount; ReqDescTable &lt; reqDescTableEnd; ReqDescTable++) {
02808 
02809         <span class="comment">//</span>
02810         <span class="comment">// For each req desc, find its arbiter, remove the req desc from its arbiter.</span>
02811         <span class="comment">//</span>
02812 
02813         reqDesc = *ReqDescTable;
02814         <span class="keywordflow">if</span> (reqDesc-&gt;ArbitrationRequired) {
02815 
02816             reqDescTranslated = reqDesc-&gt;<a class="code" href="../../d0/d4/struct__REQ__DESC.html#o8">TranslatedReqDesc</a>;
02817             arbiterEntry = reqDesc-&gt;u.Arbiter;
02818             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02819 
02820             arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02821             <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a58">PI_ARBITER_HAS_SOMETHING</a>) {
02822 
02823                 <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry, <a class="code" href="../../d6/d9/pnp_8h.html#a173a118">ArbiterActionRollbackAllocation</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02824                 arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a58">PI_ARBITER_HAS_SOMETHING</a>;
02825             }
02826 
02827             RemoveEntryList(&amp;reqDescTranslated-&gt;AlternativeTable.ListEntry);
02828             InitializeListHead(&amp;reqDescTranslated-&gt;AlternativeTable.ListEntry);
02829             listHead = &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>;
02830             <span class="keywordflow">if</span> (IsListEmpty(listHead)) {
02831 
02832                 <span class="comment">//</span>
02833                 <span class="comment">// Remove the arbiter entry from our active arbiter list if it has no resource</span>
02834                 <span class="comment">// to arbitrate.</span>
02835                 <span class="comment">//</span>
02836 
02837                 RemoveEntryList(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
02838                 InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
02839             }
02840         }
02841     }
02842 }
02843 
02844 BOOLEAN
<a name="l02845"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a71">02845</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a71">IopIsBestConfiguration</a>(
02846     IN VOID
02847     )
02848 
02849 <span class="comment">/*++</span>
02850 <span class="comment"></span>
02851 <span class="comment">Routine Description:</span>
02852 <span class="comment"></span>
02853 <span class="comment">    This routine checks if the current resource assignment yields the best score.</span>
02854 <span class="comment">    If yes, this routine updates the static variable to reflect the best score.</span>
02855 <span class="comment"></span>
02856 <span class="comment">Parameters:</span>
02857 <span class="comment"></span>
02858 <span class="comment">    None.</span>
02859 <span class="comment"></span>
02860 <span class="comment">Return Value:</span>
02861 <span class="comment"></span>
02862 <span class="comment">    TRUE or FALSE.</span>
02863 <span class="comment"></span>
02864 <span class="comment">--*/</span>
02865 
02866 {
02867     ULONG i, priority = 0;
02868     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> reqAlternative;
02869     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> assignEntry;
02870 
02871     <span class="comment">//</span>
02872     <span class="comment">// If PiNoRetest is set.  There is only one.  So, it is the best.</span>
02873     <span class="comment">//</span>
02874 
02875     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a>) {
02876         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02877     }
02878 
02879     <span class="comment">//</span>
02880     <span class="comment">// Go thru all the assign tables to collect priority</span>
02881     <span class="comment">//</span>
02882 
02883     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d5/d1/pnpres_8c.html#a41">PiAssignTableCount</a>; i++) {
02884         assignEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a> + i;
02885 
02886         <span class="keywordflow">if</span> (!(assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>)) {
02887             reqAlternative = *((<a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a>)assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>)-&gt;SelectedAlternative;
02888             priority += reqAlternative-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a>;
02889         }
02890     }
02891 
02892     <span class="comment">//</span>
02893     <span class="comment">// If the new priority is better than current best priority.</span>
02894     <span class="comment">// Update the current best.</span>
02895     <span class="comment">//</span>
02896 
02897     <span class="keywordflow">if</span> (priority &lt; <a class="code" href="../../d5/d1/pnpres_8c.html#a39">PiBestPriority</a>) {
02898         <a class="code" href="../../d5/d1/pnpres_8c.html#a39">PiBestPriority</a> = priority;
02899         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02900     } <span class="keywordflow">else</span> {
02901         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02902     }
02903 }
02904 
02905 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02906"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a72">02906</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a72">IopSaveCurrentConfiguration</a>(
02907     IN VOID
02908     )
02909 
02910 <span class="comment">/*++</span>
02911 <span class="comment"></span>
02912 <span class="comment">Routine Description:</span>
02913 <span class="comment"></span>
02914 <span class="comment">    This routine goes thru every resource requirememts list to save the current</span>
02915 <span class="comment">    best resource assignments.</span>
02916 <span class="comment"></span>
02917 <span class="comment">Parameters:</span>
02918 <span class="comment"></span>
02919 <span class="comment">    None.</span>
02920 <span class="comment"></span>
02921 <span class="comment">Return Value:</span>
02922 <span class="comment"></span>
02923 <span class="comment">    None.</span>
02924 <span class="comment"></span>
02925 <span class="comment">--*/</span>
02926 
02927 {
02928     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> reqAlternative;
02929     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> assignEntry;
02930     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> reqDesc, *reqDescpp;
02931     <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> reqList;
02932     PLIST_ENTRY listEntry;
02933     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
02934     ULONG i;
02935 
02936     <span class="comment">//</span>
02937     <span class="comment">// If PiNoRetest is set, do nothing.  We don't need to save/restore</span>
02938     <span class="comment">//</span>
02939 
02940     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a>) {
02941         <a class="code" href="../../d5/d1/pnpres_8c.html#a38">PiBestArbiterList</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>;
02942         <span class="keywordflow">return</span>;
02943     }
02944 
02945     <span class="comment">//</span>
02946     <span class="comment">// Go thru all the assign tables to save the current assignment and mark</span>
02947     <span class="comment">// it as the current best selection.</span>
02948     <span class="comment">//</span>
02949 
02950     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d5/d1/pnpres_8c.html#a41">PiAssignTableCount</a>; i++) {
02951         assignEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a> + i;
02952 
02953         <span class="keywordflow">if</span> (!(assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>)) {
02954             reqList = assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>;
02955 
02956             <span class="comment">//</span>
02957             <span class="comment">// Save the current selected Alternative as the BestAlternative.</span>
02958             <span class="comment">//</span>
02959 
02960             reqAlternative = *reqList-&gt;SelectedAlternative;
02961             reqList-&gt;ReqBestAlternative = reqList-&gt;SelectedAlternative;
02962 
02963             <span class="comment">//</span>
02964             <span class="comment">// For each REQ_DESC in the best alternative list, save its arbiter list entry</span>
02965             <span class="comment">// and its assignments.</span>
02966             <span class="comment">//</span>
02967 
02968             <span class="keywordflow">for</span> (reqDescpp = reqAlternative-&gt;ReqDescTable;
02969                  reqDescpp &lt; reqAlternative-&gt;ReqDescTableEnd;
02970                  reqDescpp++) {
02971 
02972                  <span class="keywordflow">if</span> ((*reqDescpp)-&gt;ArbitrationRequired) {
02973                      reqDesc = (*reqDescpp)-&gt;TranslatedReqDesc;
02974                      reqDesc-&gt;BestAlternativeTable = reqDesc-&gt;AlternativeTable;
02975                      reqDesc-&gt;BestAllocation = reqDesc-&gt;Allocation;
02976                  }
02977             }
02978         }
02979     }
02980 
02981     <span class="comment">//</span>
02982     <span class="comment">// Go throught the active arbiter list to save the current assignment</span>
02983     <span class="comment">// for retest.</span>
02984     <span class="comment">//</span>
02985 
02986     listEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>.Flink;
02987     <span class="keywordflow">while</span> (listEntry != &amp;<a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>) {
02988         arbiterEntry = CONTAINING_RECORD(listEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, ActiveArbiterList);
02989         arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o4">BestResourceList</a> = arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>;
02990         arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o5">BestConfig</a> = arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>;
02991         listEntry = listEntry-&gt;Flink;
02992     }
02993     <a class="code" href="../../d5/d1/pnpres_8c.html#a38">PiBestArbiterList</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>;
02994 }
02995 
02996 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02997"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a73">02997</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a73">IopRestoreBestConfiguration</a>(
02998     IN VOID
02999     )
03000 
03001 <span class="comment">/*++</span>
03002 <span class="comment"></span>
03003 <span class="comment">Routine Description:</span>
03004 <span class="comment"></span>
03005 <span class="comment">    This routine restores the arbiters info and all the resources requirements</span>
03006 <span class="comment">    info to prepare arbiter restest.</span>
03007 <span class="comment"></span>
03008 <span class="comment">Parameters:</span>
03009 <span class="comment"></span>
03010 <span class="comment">    None.</span>
03011 <span class="comment"></span>
03012 <span class="comment">Return Value:</span>
03013 <span class="comment"></span>
03014 <span class="comment">    None.</span>
03015 <span class="comment"></span>
03016 <span class="comment">--*/</span>
03017 
03018 {
03019     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> reqAlternative;
03020     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> assignEntry;
03021     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> reqDesc, *reqDescpp;
03022     <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> reqList;
03023     PLIST_ENTRY listEntry;
03024     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
03025     ULONG i;
03026 
03027     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03028 
03029         <span class="comment">//</span>
03030         <span class="comment">// Go thru all the assign tables to save the current configuration.</span>
03031         <span class="comment">//</span>
03032 
03033         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d5/d1/pnpres_8c.html#a41">PiAssignTableCount</a>; i++) {
03034             assignEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a> + i;
03035 
03036             <span class="keywordflow">if</span> (!(assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>)) {
03037                 reqList = assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>;
03038 
03039                 <span class="comment">//</span>
03040                 <span class="comment">// Set the BestAlternative as the current selection.</span>
03041                 <span class="comment">//</span>
03042 
03043                 reqAlternative = *reqList-&gt;ReqBestAlternative;
03044                 reqList-&gt;SelectedAlternative = reqList-&gt;ReqBestAlternative;
03045 
03046                 <span class="comment">//</span>
03047                 <span class="comment">// For each REQ_DESC in the best alternative list, restore its arbiter list entry</span>
03048                 <span class="comment">// and its assignments from saved area.</span>
03049                 <span class="comment">//</span>
03050 
03051                 <span class="keywordflow">for</span> (reqDescpp = reqAlternative-&gt;ReqDescTable;
03052                      reqDescpp &lt; reqAlternative-&gt;ReqDescTableEnd;
03053                      reqDescpp++) {
03054 
03055                      <span class="keywordflow">if</span> ((*reqDescpp)-&gt;ArbitrationRequired) {
03056                          reqDesc = (*reqDescpp)-&gt;TranslatedReqDesc;
03057                          reqDesc-&gt;AlternativeTable = reqDesc-&gt;BestAlternativeTable;
03058                          reqDesc-&gt;Allocation = reqDesc-&gt;BestAllocation;
03059                      }
03060                 }
03061             }
03062         }
03063         <a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a38">PiBestArbiterList</a>;
03064     }
03065 
03066     <span class="comment">//</span>
03067     <span class="comment">// Go throught the active arbiter list to restore the current configuration</span>
03068     <span class="comment">// for retest.</span>
03069     <span class="comment">//</span>
03070 
03071     listEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>.Flink;
03072     <span class="keywordflow">while</span> (listEntry != &amp;<a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>) {
03073         arbiterEntry = CONTAINING_RECORD(listEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, ActiveArbiterList);
03074         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03075             arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a> = arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o4">BestResourceList</a>;
03076             arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a> = arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o5">BestConfig</a>;
03077         }
03078         arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03079         listEntry = listEntry-&gt;Flink;
03080     }
03081 }
03082 
03083 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03084"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a64">03084</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a64">IopAssign</a>(
03085     IN ULONG AssignTableCount,
03086     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable,
03087     IN BOOLEAN Rebalance
03088     )
03089 
03090 <span class="comment">/*++</span>
03091 <span class="comment"></span>
03092 <span class="comment">Routine Description:</span>
03093 <span class="comment"></span>
03094 <span class="comment">    This routine performs the resource allocation for the passed in AssignTables.</span>
03095 <span class="comment"></span>
03096 <span class="comment">Parameters:</span>
03097 <span class="comment"></span>
03098 <span class="comment">    AssignTableCount - supplies the number of AssignTable</span>
03099 <span class="comment"></span>
03100 <span class="comment">    AssignTable - supplies a pointer to the first AssignTable.</span>
03101 <span class="comment"></span>
03102 <span class="comment">Return Value:</span>
03103 <span class="comment"></span>
03104 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03105 <span class="comment"></span>
03106 <span class="comment">--*/</span>
03107 
03108 {
03109     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status = STATUS_INSUFFICIENT_RESOURCES;
03110     LONG                tableIndex;
03111     <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a>           reqList;
03112     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a>    reqAlternative;
03113     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>        deviceNode;
03114     LARGE_INTEGER       startTime;
03115     BOOLEAN             timeoutExpired;
03116     ULONG               spewCount = 0;
03117 
03118     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03119 
03120     timeoutExpired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03121 
03122     <span class="comment">//</span>
03123     <span class="comment">// Initialize our starting time.</span>
03124     <span class="comment">//</span>
03125 
03126     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;startTime);
03127 
03128     <span class="comment">//</span>
03129     <span class="comment">// Initialize the selected alternative for each entry to the first</span>
03130     <span class="comment">// possible alternative.</span>
03131     <span class="comment">//</span>
03132 
03133     <span class="keywordflow">for</span> (tableIndex = 0; tableIndex &lt; (LONG)AssignTableCount; tableIndex++) {
03134 
03135         <span class="keywordflow">if</span> (!(AssignTable[tableIndex].Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>)) {
03136 
03137             reqList = AssignTable[tableIndex].ReqList;
03138             reqList-&gt;SelectedAlternative = &amp;reqList-&gt;ReqAlternativeTable[0];
03139         }
03140     }
03141 
03142     <span class="comment">//</span>
03143     <span class="comment">// Go through all possible combinations of req alternatives for all devices.</span>
03144     <span class="comment">//</span>
03145 
03146     <span class="keywordflow">while</span> (tableIndex &gt;= 0) {
03147 
03148         <span class="comment">//</span>
03149         <span class="comment">// Add the currently selected alternative to the arbiters iff</span>
03150         <span class="comment">// it has changed since the last time.</span>
03151         <span class="comment">//</span>
03152 
03153         <span class="keywordflow">for</span> (tableIndex = AssignTableCount - 1; tableIndex &gt;= 0;) {
03154 
03155             <span class="keywordflow">if</span> (AssignTable[tableIndex].Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>) {
03156 
03157                 tableIndex--;
03158             } <span class="keywordflow">else</span> {
03159 
03160                 reqList = AssignTable[tableIndex].ReqList;
03161                 reqAlternative = *reqList-&gt;SelectedAlternative;
03162                 deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignTable[tableIndex].PhysicalDevice-&gt;DeviceObjectExtension-&gt;DeviceNode;
03163                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"PnpRes: Adding %d/%d req alt to the arbiters for %ws.\n"</span>, reqAlternative-&gt;ReqAlternativeIndex + 1, reqList-&gt;ReqAlternativeCount, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
03164                 <a class="code" href="../../d5/d1/pnpres_8c.html#a69">IopAddReqDescsToArbiters</a>(   reqAlternative-&gt;ReqDescCount,
03165                                             reqAlternative-&gt;ReqDescTable);
03166                 <span class="keywordflow">if</span> (reqList-&gt;SelectedAlternative == &amp;reqList-&gt;ReqAlternativeTable[0]) {
03167 
03168                     tableIndex--;
03169                 } <span class="keywordflow">else</span> {
03170 
03171                     <span class="keywordflow">break</span>;
03172                 }
03173             }
03174         }
03175 
03176         <span class="comment">//</span>
03177         <span class="comment">// Test this configuration.</span>
03178         <span class="comment">//</span>
03179 
03180         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a68">IopPlacement</a>(<a class="code" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>, Rebalance);
03181         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03182             <span class="comment">//</span>
03183             <span class="comment">// Compute priority and update best configuration if needed.</span>
03184             <span class="comment">//</span>
03185 
03186             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a71">IopIsBestConfiguration</a>()) {
03187 
03188                 <span class="comment">//</span>
03189                 <span class="comment">// This assignment gets the best score.  Update its ReqBestAlternative</span>
03190                 <span class="comment">// and return.</span>
03191                 <span class="comment">//</span>
03192 
03193                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"PnpRes: Found a best assignment.  Save it\n"</span>));
03194                 <a class="code" href="../../d5/d1/pnpres_8c.html#a72">IopSaveCurrentConfiguration</a>();
03195 
03196                 <span class="comment">//</span>
03197                 <span class="comment">// The reqList-&gt;ReqBestAlternative will be set to reqAlternative, i.e.</span>
03198                 <span class="comment">//     reqList-&gt;ReqBestAlternative = reqAlternative;</span>
03199                 <span class="comment">// in IopSaveCurrentConfiguration().</span>
03200                 <span class="comment">// This will cause the control to exit the for-loop.</span>
03201                 <span class="comment">//</span>
03202 
03203             }
03204 
03205             <span class="comment">//</span>
03206             <span class="comment">// Do we need to stop?</span>
03207             <span class="comment">//</span>
03208 
03209             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a>) {
03210 
03211                 <span class="keywordflow">break</span>;
03212             }
03213         }
03214 
03215         <span class="comment">//</span>
03216         <span class="comment">// Algorithm to select the next alternative.</span>
03217         <span class="comment">//</span>
03218         <span class="comment">// We go through the table in the reverse direction.</span>
03219         <span class="comment">// We first remove the currently selected alternative.</span>
03220         <span class="comment">// We update the selected alternative to the next possible</span>
03221         <span class="comment">// alternative. If we roll over, we go to the next entry in</span>
03222         <span class="comment">// the table.</span>
03223         <span class="comment">//</span>
03224 
03225         <span class="keywordflow">for</span> (tableIndex = AssignTableCount - 1; tableIndex &gt;= 0; ) {
03226 
03227             <span class="keywordflow">if</span> (AssignTable[tableIndex].Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>) {
03228 
03229                 tableIndex--;
03230             } <span class="keywordflow">else</span> {
03231 
03232                 reqList = AssignTable[tableIndex].ReqList;
03233                 reqAlternative = *reqList-&gt;SelectedAlternative;
03234                 deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignTable[tableIndex].PhysicalDevice-&gt;DeviceObjectExtension-&gt;DeviceNode;
03235                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"PnpRes: Removing %d/%d req alt from the arbiters for %ws.\n"</span>, reqAlternative-&gt;ReqAlternativeIndex + 1, reqList-&gt;ReqAlternativeCount, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
03236                 <a class="code" href="../../d5/d1/pnpres_8c.html#a70">IopRemoveReqDescsFromArbiters</a>(  reqAlternative-&gt;ReqDescCount,
03237                                                 reqAlternative-&gt;ReqDescTable);
03238                 <span class="keywordflow">if</span> (++reqList-&gt;SelectedAlternative &lt; reqList-&gt;ReqBestAlternative &amp;&amp; !timeoutExpired) {
03239 
03240                     <span class="keywordflow">break</span>;
03241                 } <span class="keywordflow">else</span> {
03242 
03243                     reqList-&gt;SelectedAlternative = &amp;reqList-&gt;ReqAlternativeTable[0];
03244                     tableIndex--;
03245                 }
03246             }
03247 
03248         }
03249 
03250         <span class="comment">//</span>
03251         <span class="comment">// Check if timeout has expired.</span>
03252         <span class="comment">//</span>
03253 
03254         <span class="keywordflow">if</span> (tableIndex &gt;= 0) {
03255 
03256             LARGE_INTEGER   currentTime;
03257             ULONG           timeDiff;
03258 
03259             <span class="comment">//</span>
03260             <span class="comment">// Compute time difference in milliseconds.</span>
03261             <span class="comment">//</span>
03262 
03263             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;currentTime);
03264             timeDiff = (ULONG)((currentTime.QuadPart - startTime.QuadPart) / 10000);
03265 
03266             <span class="comment">//</span>
03267             <span class="comment">// We are done if timeout has expired.</span>
03268             <span class="comment">//</span>
03269 
03270             <span class="keywordflow">if</span> (timeDiff &gt;= <a class="code" href="../../d5/d1/pnpres_8c.html#a22">FIND_BEST_ASSIGNMENT_TIMEOUT</a>)
03271             {
03272                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a44">PiUseTimeout</a>) {
03273 
03274                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes: Timeout expired, bailing out!\n"</span>));
03275                     timeoutExpired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03276 
03277                 } <span class="keywordflow">else</span> {
03278 
03279                     spewCount = (spewCount + 1) % 50;
03280                     <span class="keywordflow">if</span> (spewCount == 0) {
03281                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PnpRes: Timeout expired.\n"</span>);
03282                     }
03283                 }
03284             }
03285         }
03286     }
03287 
03288     <span class="keywordflow">return</span> (status);
03289 }
03290 
03291 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03292"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a67">03292</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a67">IopAssignInner</a>(
03293     IN ULONG AssignTableCount,
03294     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable,
03295     IN BOOLEAN Rebalance
03296     )
03297 
03298 <span class="comment">/*++</span>
03299 <span class="comment"></span>
03300 <span class="comment">Routine Description:</span>
03301 <span class="comment"></span>
03302 <span class="comment">    This routine sets up static variables and invokes the real resource allocation</span>
03303 <span class="comment">    routine.</span>
03304 <span class="comment"></span>
03305 <span class="comment">Parameters:</span>
03306 <span class="comment"></span>
03307 <span class="comment">    AssignTableCount - supplies the number of AssignTable</span>
03308 <span class="comment"></span>
03309 <span class="comment">    AssignTable - supplies a pointer to the first AssignTable.</span>
03310 <span class="comment"></span>
03311 <span class="comment">Return Value:</span>
03312 <span class="comment"></span>
03313 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03314 <span class="comment"></span>
03315 <span class="comment">--*/</span>
03316 
03317 {
03318     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03319     <a class="code" href="../../d6/d9/pnp_8h.html#a52">ARBITER_ACTION</a> arbiterAction;
03320 
03321     <span class="comment">//</span>
03322     <span class="comment">// Initialize static variable</span>
03323     <span class="comment">//</span>
03324 
03325     InitializeListHead(&amp;<a class="code" href="../../d5/d1/pnpres_8c.html#a38">PiBestArbiterList</a>);
03326     InitializeListHead(&amp;<a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>);
03327     <a class="code" href="../../d5/d1/pnpres_8c.html#a41">PiAssignTableCount</a> = AssignTableCount;
03328     <a class="code" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a> = AssignTable;
03329     <a class="code" href="../../d5/d1/pnpres_8c.html#a39">PiBestPriority</a> = (ULONG) -1;
03330     <span class="keywordflow">if</span> (AssignTableCount == 1) {
03331         <a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03332         arbiterAction = <a class="code" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>;
03333     } <span class="keywordflow">else</span> {
03334         <a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03335         arbiterAction = <a class="code" href="../../d6/d9/pnp_8h.html#a173a116">ArbiterActionRetestAllocation</a>;
03336     }
03337 
03338     <span class="comment">//</span>
03339     <span class="comment">// Try to solve the inner NP-complete problem.</span>
03340     <span class="comment">//</span>
03341 
03342     <a class="code" href="../../d5/d1/pnpres_8c.html#a64">IopAssign</a>(AssignTableCount, AssignTable, Rebalance);
03343 <span class="preprocessor">#if DBG_SCOPE</span>
03344 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a26">STOP_ERROR</a>) &amp;&amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03345         <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>);
03346     }
03347 <span class="preprocessor">#endif</span>
03348 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d5/d1/pnpres_8c.html#a38">PiBestArbiterList</a>)) {
03349         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"PnpRes: IoAssignInner failed to find an assignment.\n"</span>));
03350         status = STATUS_UNSUCCESSFUL;
03351     } <span class="keywordflow">else</span> {
03352 
03353         <span class="keywordflow">if</span> (Rebalance) {
03354             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"PnpRes: Restore the best assignment.\n"</span>));
03355         } <span class="keywordflow">else</span> {
03356             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"PnpRes: Restore the best assignment and commit it.\n"</span>));
03357         }
03358 
03359         <a class="code" href="../../d5/d1/pnpres_8c.html#a73">IopRestoreBestConfiguration</a>();
03360         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a68">IopPlacement</a>(arbiterAction, Rebalance);
03361 <span class="preprocessor">#if DBG_SCOPE</span>
03362 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!Rebalance) {
03363             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a26">STOP_ERROR</a>) {
03364                 <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>);
03365             }
03366         }
03367 <span class="preprocessor">#endif</span>
03368 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
03369     }
03370     <a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03371     <span class="keywordflow">return</span> status;
03372 }
03373 
03374 
03375 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03376"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a93">03376</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a93">IopReserve</a>(
03377     IN PREQ_LIST ReqList
03378     )
03379 
03380 <span class="comment">/*++</span>
03381 <span class="comment"></span>
03382 <span class="comment">Routine Description:</span>
03383 <span class="comment"></span>
03384 <span class="comment">    This routine performs the resource allocation for the passed in AssignTables.</span>
03385 <span class="comment"></span>
03386 <span class="comment">Parameters:</span>
03387 <span class="comment"></span>
03388 <span class="comment"></span>
03389 <span class="comment">Return Value:</span>
03390 <span class="comment"></span>
03391 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03392 <span class="comment"></span>
03393 <span class="comment">--*/</span>
03394 
03395 {
03396     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03397     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> <a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a>;
03398     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *reqAlternative;
03399 
03400     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03401 
03402     <span class="comment">//</span>
03403     <span class="comment">// Initialize static variable</span>
03404     <span class="comment">//</span>
03405 
03406     InitializeListHead(&amp;<a class="code" href="../../d5/d1/pnpres_8c.html#a38">PiBestArbiterList</a>);
03407     InitializeListHead(&amp;<a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>);
03408 
03409     reqAlternative = ReqList-&gt;ReqAlternativeTable;
03410 
03411     <a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a> = *reqAlternative;
03412     ReqList-&gt;SelectedAlternative = reqAlternative;
03413     <a class="code" href="../../d5/d1/pnpres_8c.html#a69">IopAddReqDescsToArbiters</a>(<a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a>-&gt;ReqDescCount, <a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a>-&gt;ReqDescTable);
03414     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a92">IopPlacementForReservation</a>();
03415 <span class="preprocessor">#if DBG_SCOPE</span>
03416 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a26">STOP_ERROR</a>) {
03417         <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>);
03418     }
03419 <span class="preprocessor">#endif</span>
03420 <span class="preprocessor"></span>    <span class="keywordflow">return</span> status;
03421 }
03422 
03423 BOOLEAN
<a name="l03424"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a74">03424</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a74">IopFindResourceHandlerInfo</a>(
03425     IN RESOURCE_HANDLER_TYPE HandlerType,
03426     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
03427     IN UCHAR ResourceType,
03428     OUT PVOID *HandlerEntry
03429     )
03430 
03431 <span class="comment">/*++</span>
03432 <span class="comment"></span>
03433 <span class="comment">Routine Description:</span>
03434 <span class="comment"></span>
03435 <span class="comment">    This routine finds the desired resource handler interface for the specified</span>
03436 <span class="comment">    resource type in the specified Device node.</span>
03437 <span class="comment"></span>
03438 <span class="comment">Parameters:</span>
03439 <span class="comment"></span>
03440 <span class="comment">    HandlerType - Specifies the type of handler needed.</span>
03441 <span class="comment"></span>
03442 <span class="comment">    DeviceNode - specifies the device node from where to search for handler</span>
03443 <span class="comment"></span>
03444 <span class="comment">    ResourceTYpe - specifies the type of resource.</span>
03445 <span class="comment"></span>
03446 <span class="comment">    HandlerEntry - supplies a pointer to a variable to receive the handler.</span>
03447 <span class="comment"></span>
03448 <span class="comment">Return Value:</span>
03449 <span class="comment"></span>
03450 <span class="comment">    TRUE + non-null HandlerEntry : Find handler info and there is a handler</span>
03451 <span class="comment">    TRUE + NULL HandlerEntry     : Find handler info and there is NO handler</span>
03452 <span class="comment">    FALSE + NULL HandlerEntry    : No handler info found.</span>
03453 <span class="comment"></span>
03454 <span class="comment">--*/</span>
03455 {
03456     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> resourceMask;
03457     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> noHandlerMask, queryHandlerMask;
03458     PLIST_ENTRY listHead, nextEntry;
03459     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
03460 
03461     *HandlerEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03462 
03463     <span class="keywordflow">switch</span> (HandlerType) {
03464     <span class="keywordflow">case</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a216">ResourceArbiter</a>:
03465         noHandlerMask = DeviceNode-&gt;NoArbiterMask;
03466         queryHandlerMask = DeviceNode-&gt;QueryArbiterMask;
03467         listHead = &amp;DeviceNode-&gt;DeviceArbiterList;
03468         <span class="keywordflow">break</span>;
03469 
03470     <span class="keywordflow">case</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a215">ResourceTranslator</a>:
03471         noHandlerMask = DeviceNode-&gt;NoTranslatorMask;
03472         queryHandlerMask = DeviceNode-&gt;QueryTranslatorMask;
03473         listHead = &amp;DeviceNode-&gt;DeviceTranslatorList;
03474         <span class="keywordflow">break</span>;
03475 
03476     <span class="keywordflow">default</span>:
03477         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03478     }
03479 
03480     resourceMask = 1 &lt;&lt; ResourceType;
03481     <span class="keywordflow">if</span> (noHandlerMask &amp; resourceMask) {
03482 
03483         <span class="comment">//</span>
03484         <span class="comment">// There is no desired handler for the resource type in this device node</span>
03485         <span class="comment">//</span>
03486 
03487         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03488     }
03489 
03490     <span class="keywordflow">if</span> (queryHandlerMask &amp; resourceMask) {
03491 
03492         <span class="comment">//</span>
03493         <span class="comment">// Has handler for the resource type in this device node.</span>
03494         <span class="comment">// look for it ...</span>
03495         <span class="comment">//</span>
03496 
03497         nextEntry = listHead-&gt;Flink;
03498         <span class="keywordflow">for</span> (; nextEntry != listHead; nextEntry = nextEntry-&gt;Flink) {
03499             arbiterEntry = CONTAINING_RECORD(nextEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, DeviceArbiterList);
03500             <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o1">ResourceType</a> == ResourceType) {
03501                 <span class="keywordflow">break</span>;
03502             }
03503         }
03504         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(nextEntry != listHead);     <span class="comment">// There must be one ...</span>
03505         *HandlerEntry = arbiterEntry;
03506         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03507 
03508     } <span class="keywordflow">else</span> {
03509 
03510         <span class="comment">//</span>
03511         <span class="comment">// If we are here there are two cases:</span>
03512         <span class="comment">//   We have not query the desired interface yet  or</span>
03513         <span class="comment">//   the resource type is out of the range we are tracking using masks.</span>
03514         <span class="comment">//   In this case, we need to go thru the link list.</span>
03515         <span class="comment">//</span>
03516 
03517         <span class="keywordflow">if</span> (ResourceType &gt; <a class="code" href="../../d9/d0/pnpiop_8h.html#a57">PI_MAXIMUM_RESOURCE_TYPE_TRACKED</a>) {
03518             nextEntry = listHead-&gt;Flink;
03519             <span class="keywordflow">for</span> (; nextEntry != listHead; nextEntry = nextEntry-&gt;Flink) {
03520                 arbiterEntry = CONTAINING_RECORD(nextEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, DeviceArbiterList);
03521                 <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o1">ResourceType</a> == ResourceType) {
03522                     <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o2">ArbiterInterface</a>) {
03523                         *HandlerEntry = arbiterEntry;
03524                     }
03525                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03526                 }
03527             }
03528         }
03529         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03530     }
03531 }
03532 
03533 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03534"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a75">03534</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a75">IopSetupArbiterAndTranslators</a>(
03535     IN PREQ_DESC ReqDesc
03536     )
03537 
03538 <span class="comment">/*++</span>
03539 <span class="comment"></span>
03540 <span class="comment">Routine Description:</span>
03541 <span class="comment"></span>
03542 <span class="comment">    This routine searches the arbiter and translators which arbitrates and translate</span>
03543 <span class="comment">    the resources for the specified device.  This routine tries to find all the</span>
03544 <span class="comment">    translator on the path of current device node to root device node</span>
03545 <span class="comment"></span>
03546 <span class="comment">Parameters:</span>
03547 <span class="comment"></span>
03548 <span class="comment">    ReqDesc - supplies a pointer to REQ_DESC which contains all the required information</span>
03549 <span class="comment"></span>
03550 <span class="comment">Return Value:</span>
03551 <span class="comment"></span>
03552 <span class="comment">    NTSTATUS value to indicate success or failure.</span>
03553 <span class="comment"></span>
03554 <span class="comment">--*/</span>
03555 
03556 {
03557     PLIST_ENTRY listHead, nextEntry;
03558     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
03559     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = ReqDesc-&gt;AlternativeTable.PhysicalDeviceObject;
03560     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03561     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> reqDesc = ReqDesc, translatedReqDesc;
03562     BOOLEAN found, arbiterFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, restartedAlready;
03563     BOOLEAN  searchTranslator = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, translatorFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03564     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03565     <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PPI_RESOURCE_TRANSLATOR_ENTRY</a> translatorEntry;
03566     UCHAR resourceType = ReqDesc-&gt;TranslatedReqDesc-&gt;AlternativeTable.Alternatives-&gt;Type;
03567     <a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a> interface;
03568     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> resourceMask;
03569 
03570     <span class="keywordflow">if</span> ((ReqDesc-&gt;AlternativeTable.RequestSource == <a class="code" href="../../d6/d9/pnp_8h.html#a174a127">ArbiterRequestHalReported</a>) &amp;&amp;
03571         (ReqDesc-&gt;InterfaceType == Internal)) {
03572 
03573         <span class="comment">// Trust hal if it says internal bus.</span>
03574 
03575         restartedAlready = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03576     } <span class="keywordflow">else</span> {
03577         restartedAlready = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03578     }
03579 
03580     <span class="comment">//</span>
03581     <span class="comment">// If ReqDesc contains DeviceObject, this is for regular resources allocation</span>
03582     <span class="comment">// or boot resources preallocation.  Otherwise, it is for resources reservation.</span>
03583     <span class="comment">//</span>
03584 
03585     <span class="keywordflow">if</span> (deviceObject &amp;&amp; ReqDesc-&gt;AlternativeTable.RequestSource != <a class="code" href="../../d6/d9/pnp_8h.html#a174a127">ArbiterRequestHalReported</a>) {
03586         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03587         <span class="comment">// We want to start with the deviceNode instead of its parent.  Because the</span>
03588         <span class="comment">// deviceNode may provide a translator interface.</span>
03589         <span class="comment">// deviceNode = deviceNode-&gt;Parent;</span>
03590     } <span class="keywordflow">else</span> {
03591 
03592         <span class="comment">//</span>
03593         <span class="comment">// For resource reservation, we always need to find the arbiter and translators</span>
03594         <span class="comment">// so set the device node to Root.</span>
03595         <span class="comment">//</span>
03596 
03597         deviceNode = <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>;
03598     }
03599     <span class="keywordflow">while</span> (deviceNode) {
03600         <span class="keywordflow">if</span> ((deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) &amp;&amp; (translatorFound == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03601 
03602             <span class="comment">//</span>
03603             <span class="comment">// If we reach the root and have not find any translator, the device is on the</span>
03604             <span class="comment">// wrong way.</span>
03605             <span class="comment">//</span>
03606 
03607             <span class="keywordflow">if</span> (restartedAlready == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03608                 restartedAlready = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03609 
03610                 deviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a> (
03611                                  <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>,
03612                                  ReqDesc-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o17">InterfaceType</a>,
03613                                  ReqDesc-&gt;BusNumber,
03614                                  0
03615                                  );
03616 
03617                 <span class="comment">//</span>
03618                 <span class="comment">// If we did not find a PDO, try again with InterfaceType == Isa. This allows</span>
03619                 <span class="comment">// drivers that request Internal to get resources even if there is no PDO</span>
03620                 <span class="comment">// that is Internal. (but if there is an Internal PDO, they get that one)</span>
03621                 <span class="comment">//</span>
03622 
03623                 <span class="keywordflow">if</span> ((deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) &amp;&amp;
03624                     (ReqDesc-&gt;ReqAlternative-&gt;ReqList-&gt;InterfaceType == Internal)) {
03625                     deviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a>(
03626                                  <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>,
03627                                  Isa,
03628                                  0,
03629                                  0
03630                                  );
03631                 }
03632 
03633                 <span class="comment">//if ((PVOID)deviceNode == deviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode) {</span>
03634                 <span class="comment">//    deviceNode = IopRootDeviceNode;</span>
03635                 <span class="comment">//} else {</span>
03636                     <span class="keywordflow">continue</span>;
03637                 <span class="comment">//}</span>
03638             }
03639         }
03640 
03641         <span class="comment">//</span>
03642         <span class="comment">// Check is there an arbiter for the device node?</span>
03643         <span class="comment">//   if yes, set up ReqDesc-&gt;u.Arbiter and set ArbiterFound to true.</span>
03644         <span class="comment">//   else move up to the parent of current device node.</span>
03645         <span class="comment">//</span>
03646 
03647         <span class="keywordflow">if</span> ((arbiterFound == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a> != deviceObject)) {
03648             found = <a class="code" href="../../d5/d1/pnpres_8c.html#a74">IopFindResourceHandlerInfo</a>(
03649                                <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a216">ResourceArbiter</a>,
03650                                deviceNode,
03651                                resourceType,
03652                                &amp;arbiterEntry);
03653             <span class="keywordflow">if</span> (found == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03654 
03655                 <span class="comment">//</span>
03656                 <span class="comment">// no information found on arbiter.  Try to query translator interface ...</span>
03657                 <span class="comment">//</span>
03658 
03659                 <span class="keywordflow">if</span> (resourceType &lt;= <a class="code" href="../../d9/d0/pnpiop_8h.html#a57">PI_MAXIMUM_RESOURCE_TYPE_TRACKED</a>) {
03660                     resourceMask = 1 &lt;&lt; resourceType;
03661                 } <span class="keywordflow">else</span> {
03662                     resourceMask = 0;
03663                 }
03664                 status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a28">IopQueryResourceHandlerInterface</a>(<a class="code" href="../../d9/d0/pnpiop_8h.html#a390a216">ResourceArbiter</a>,
03665                                                           deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
03666                                                           resourceType,
03667                                                           &amp;interface);
03668                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o29">QueryArbiterMask</a> |= resourceMask;
03669                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03670                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o28">NoArbiterMask</a> |= resourceMask;
03671                     <span class="keywordflow">if</span> (resourceType &lt;= <a class="code" href="../../d9/d0/pnpiop_8h.html#a57">PI_MAXIMUM_RESOURCE_TYPE_TRACKED</a>) {
03672                         found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03673                     } <span class="keywordflow">else</span> {
03674                         interface = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03675                     }
03676                 }
03677                 <span class="keywordflow">if</span> (found == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03678                     arbiterEntry = (<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a>)<a class="code" href="../../d5/d1/pnpres_8c.html#a5">ExAllocatePoolAE</a>(
03679                                        <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03680                                        <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>));
03681                     <span class="keywordflow">if</span> (!arbiterEntry) {
03682                         status = STATUS_INSUFFICIENT_RESOURCES;
03683                         <span class="keywordflow">return</span> status;
03684                     }
03685                     InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
03686                     InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o0">DeviceArbiterList</a>);
03687                     InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o5">BestConfig</a>);
03688                     InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>);
03689                     InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o4">BestResourceList</a>);
03690                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o1">ResourceType</a> =resourceType;
03691                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> = 0;
03692                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03693                     listHead = &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o24">DeviceArbiterList</a>;
03694                     InsertTailList(listHead, &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o0">DeviceArbiterList</a>);
03695                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o2">ArbiterInterface</a> = (<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html">PARBITER_INTERFACE</a>)interface;
03696                     <span class="keywordflow">if</span> (!interface) {
03697 
03698                         <span class="comment">//</span>
03699                         <span class="comment">// if interface is NULL we really don't have translator.</span>
03700                         <span class="comment">//</span>
03701 
03702                         arbiterEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03703                     }
03704                 }
03705             }
03706 
03707             <span class="comment">//</span>
03708             <span class="comment">// If there is an desired resourcetype arbiter in the device node, make sure</span>
03709             <span class="comment">// it handle this resource requriements.</span>
03710             <span class="comment">//</span>
03711 
03712             <span class="keywordflow">if</span> (arbiterEntry) {
03713                 arbiterFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03714                 <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o2">ArbiterInterface</a>-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o6">Flags</a> &amp; <a class="code" href="../../d6/d9/pnp_8h.html#a9">ARBITER_PARTIAL</a>) {
03715 
03716                     <span class="comment">//</span>
03717                     <span class="comment">// If the arbiter is partial, ask if it handles the resources</span>
03718                     <span class="comment">// if not, goto its parent.</span>
03719                     <span class="comment">//</span>
03720 
03721                     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(
03722                                 arbiterEntry,
03723                                 <a class="code" href="../../d6/d9/pnp_8h.html#a173a122">ArbiterActionQueryArbitrate</a>,
03724                                 ReqDesc-&gt;TranslatedReqDesc,
03725                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03726                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03727                                 );
03728                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03729                         arbiterFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03730                     }
03731                 }
03732             }
03733             <span class="keywordflow">if</span> (arbiterFound) {
03734                 ReqDesc-&gt;u.Arbiter = arbiterEntry;
03735 
03736                 <span class="comment">//</span>
03737                 <span class="comment">// Initialize the arbiter entry</span>
03738                 <span class="comment">//</span>
03739 
03740                 arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> = 0;
03741                 arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03742             }
03743 
03744         }
03745 
03746         <span class="keywordflow">if</span> (searchTranslator) {
03747             <span class="comment">//</span>
03748             <span class="comment">// First, check if there is a translator for the device node?</span>
03749             <span class="comment">// If yes, translate the req desc and link it to the front of ReqDesc-&gt;TranslatedReqDesc</span>
03750             <span class="comment">// else do nothing.</span>
03751             <span class="comment">//</span>
03752 
03753             found = <a class="code" href="../../d5/d1/pnpres_8c.html#a74">IopFindResourceHandlerInfo</a>(
03754                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a215">ResourceTranslator</a>,
03755                         deviceNode,
03756                         resourceType,
03757                         &amp;translatorEntry);
03758 
03759             <span class="keywordflow">if</span> (found == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03760 
03761                 <span class="comment">//</span>
03762                 <span class="comment">// no information found on translator.  Try to query translator interface ...</span>
03763                 <span class="comment">//</span>
03764 
03765                 <span class="keywordflow">if</span> (resourceType &lt;= <a class="code" href="../../d9/d0/pnpiop_8h.html#a57">PI_MAXIMUM_RESOURCE_TYPE_TRACKED</a>) {
03766                     resourceMask = 1 &lt;&lt; resourceType;
03767                 } <span class="keywordflow">else</span> {
03768                     resourceMask = 0;
03769                 }
03770                 status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a28">IopQueryResourceHandlerInterface</a>(<a class="code" href="../../d9/d0/pnpiop_8h.html#a390a215">ResourceTranslator</a>,
03771                                                           deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
03772                                                           resourceType,
03773                                                           &amp;interface);
03774                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o27">QueryTranslatorMask</a> |= resourceMask;
03775                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03776                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o26">NoTranslatorMask</a> |= resourceMask;
03777                     <span class="keywordflow">if</span> (resourceType &lt;= <a class="code" href="../../d9/d0/pnpiop_8h.html#a57">PI_MAXIMUM_RESOURCE_TYPE_TRACKED</a>) {
03778                         found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03779                     } <span class="keywordflow">else</span> {
03780                         interface = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03781                     }
03782                 }
03783                 <span class="keywordflow">if</span> (found == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03784                     translatorEntry = (<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PPI_RESOURCE_TRANSLATOR_ENTRY</a>)<a class="code" href="../../d5/d1/pnpres_8c.html#a6">ExAllocatePoolTE</a>(
03785                                        <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03786                                        <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PI_RESOURCE_TRANSLATOR_ENTRY</a>));
03787                     <span class="keywordflow">if</span> (!translatorEntry) {
03788                         status = STATUS_INSUFFICIENT_RESOURCES;
03789                         <span class="keywordflow">return</span> status;
03790                     }
03791                     translatorEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o1">ResourceType</a> = resourceType;
03792                     InitializeListHead(&amp;translatorEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o0">DeviceTranslatorList</a>);
03793                     translatorEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o2">TranslatorInterface</a> = (<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">PTRANSLATOR_INTERFACE</a>)interface;
03794                     translatorEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o3">DeviceNode</a> = deviceNode;
03795                     listHead = &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o25">DeviceTranslatorList</a>;
03796                     InsertTailList(listHead, &amp;translatorEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o0">DeviceTranslatorList</a>);
03797                     <span class="keywordflow">if</span> (!interface) {
03798 
03799                         <span class="comment">//</span>
03800                         <span class="comment">// if interface is NULL we really don't have translator.</span>
03801                         <span class="comment">//</span>
03802 
03803                         translatorEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03804                     }
03805                 }
03806             }
03807             <span class="keywordflow">if</span> (translatorEntry) {
03808                 translatorFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03809             }
03810             <span class="keywordflow">if</span> ((arbiterFound == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; translatorEntry) {
03811 
03812                 <span class="comment">//</span>
03813                 <span class="comment">// Find a translator to translate the req desc ... Translate it and link it to</span>
03814                 <span class="comment">// the front of ReqDesc-&gt;TranslatedReqDesc such that the first in the list is for</span>
03815                 <span class="comment">// the Arbiter to use.</span>
03816                 <span class="comment">//</span>
03817 
03818                 reqDesc = ReqDesc-&gt;TranslatedReqDesc;
03819                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a78">IopTranslateAndAdjustReqDesc</a>(
03820                               reqDesc,
03821                               translatorEntry,
03822                               &amp;translatedReqDesc);
03823                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03824                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(translatedReqDesc);
03825                     resourceType = translatedReqDesc-&gt;AlternativeTable.Alternatives-&gt;Type;
03826                     translatedReqDesc-&gt;TranslatedReqDesc = ReqDesc-&gt;TranslatedReqDesc;
03827                     ReqDesc-&gt;TranslatedReqDesc = translatedReqDesc;
03828                     <span class="comment">//</span>
03829                     <span class="comment">// If the translator is non-hierarchial and performs a complete</span>
03830                     <span class="comment">// translation to root (eg ISA interrups for PCI devices) then</span>
03831                     <span class="comment">// don't pass translations to parent.</span>
03832                     <span class="comment">//</span>
03833 
03834                     <span class="keywordflow">if</span> (status == STATUS_TRANSLATION_COMPLETE) {
03835                         searchTranslator = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03836                     }
03837                 } <span class="keywordflow">else</span> {
03838                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>, (<span class="stringliteral">"PnpResr: resreq list TranslationAndAdjusted failed\n"</span>));
03839                     <span class="keywordflow">return</span> status;
03840                 }
03841             }
03842 
03843         }
03844 
03845         <span class="comment">//</span>
03846         <span class="comment">// Move up to current device node's parent</span>
03847         <span class="comment">//</span>
03848 
03849         deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
03850     }
03851 
03852     <span class="keywordflow">if</span> (arbiterFound) {
03853         <span class="keywordflow">return</span> STATUS_SUCCESS;
03854     } <span class="keywordflow">else</span> {
03855 
03856         <span class="comment">//</span>
03857         <span class="comment">// We should BugCheck in this case.</span>
03858         <span class="comment">//</span>
03859 
03860         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpResr: can not find resource type %x arbiter\n"</span>, resourceType));
03861         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
03862         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03863     }
03864 
03865 }
03866 
03867 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03868"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a76">03868</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a76">IopParentToRawTranslation</a>(
03869     IN OUT PREQ_DESC ReqDesc
03870     )
03871 
03872 <span class="comment">/*++</span>
03873 <span class="comment"></span>
03874 <span class="comment">Routine Description:</span>
03875 <span class="comment"></span>
03876 <span class="comment">    This routine translates an CmPartialResourceDescriptors</span>
03877 <span class="comment">    from their translated form to their raw counterparts..</span>
03878 <span class="comment"></span>
03879 <span class="comment">Parameters:</span>
03880 <span class="comment"></span>
03881 <span class="comment">    ReqDesc - supplies a translated ReqDesc to be translated back to its raw form</span>
03882 <span class="comment"></span>
03883 <span class="comment">Return Value:</span>
03884 <span class="comment"></span>
03885 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03886 <span class="comment"></span>
03887 <span class="comment">--*/</span>
03888 {
03889     <a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">PTRANSLATOR_INTERFACE</a> translator;
03890     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
03891     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> rawReqDesc;
03892 
03893     <span class="keywordflow">if</span> (ReqDesc-&gt;AlternativeTable.AlternativeCount == 0 ||
03894         ReqDesc-&gt;Allocation.Type == CmResourceTypeMaximum) {
03895         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes : Invalid ReqDesc for parent-to-raw translation.\n"</span>));
03896         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
03897     }
03898 
03899     <span class="comment">//</span>
03900     <span class="comment">// If this ReqDesc is the raw reqDesc then we are done.</span>
03901     <span class="comment">// Else call its translator to translate the resource and leave the result</span>
03902     <span class="comment">// in its raw (next level) reqdesc.</span>
03903     <span class="comment">//</span>
03904 
03905     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a14">IS_TRANSLATED_REQ_DESC</a>(ReqDesc)) {
03906         rawReqDesc = ReqDesc-&gt;TranslatedReqDesc;
03907         translator = ReqDesc-&gt;u.Translator-&gt;TranslatorInterface;
03908         status = (translator-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o5">TranslateResources</a>)(
03909                       translator-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o2">Context</a>,
03910                       ReqDesc-&gt;AlternativeTable.Assignment,
03911                       <a class="code" href="../../d6/d9/pnp_8h.html#a176a136">TranslateParentToChild</a>,
03912                       rawReqDesc-&gt;AlternativeTable.AlternativeCount,
03913                       rawReqDesc-&gt;AlternativeTable.Alternatives,
03914                       rawReqDesc-&gt;AlternativeTable.PhysicalDeviceObject,
03915                       rawReqDesc-&gt;AlternativeTable.Assignment
03916                       );
03917         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03918 
03919             <span class="comment">//</span>
03920             <span class="comment">// If the translator is non-hierarchial and performs a complete</span>
03921             <span class="comment">// translation to root (eg ISA interrups for PCI devices) then</span>
03922             <span class="comment">// don't pass translations to parent.</span>
03923             <span class="comment">//</span>
03924 
03925             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status != STATUS_TRANSLATION_COMPLETE);
03926             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a76">IopParentToRawTranslation</a>(rawReqDesc);
03927         }
03928     }
03929     <span class="keywordflow">return</span> status;
03930 }
03931 
03932 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03933"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a77">03933</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a77">IopChildToRootTranslation</a>(
03934     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, OPTIONAL
03935     IN INTERFACE_TYPE InterfaceType,
03936     IN ULONG BusNumber,
03937     IN ARBITER_REQUEST_SOURCE ArbiterRequestSource,
03938     IN PCM_PARTIAL_RESOURCE_DESCRIPTOR Source,
03939     OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR *Target
03940     )
03941 
03942 <span class="comment">/*++</span>
03943 <span class="comment"></span>
03944 <span class="comment">Routine Description:</span>
03945 <span class="comment"></span>
03946 <span class="comment">    This routine translates a CmPartialResourceDescriptors from</span>
03947 <span class="comment">    their intermediate translated form to their final translated form.</span>
03948 <span class="comment">    The translated CM_PARTIAL_RESOURCE_DESCRIPTOR is returned via Target variable.</span>
03949 <span class="comment"></span>
03950 <span class="comment">    The caller is responsible to release the translated descriptor.</span>
03951 <span class="comment"></span>
03952 <span class="comment">Parameters:</span>
03953 <span class="comment"></span>
03954 <span class="comment">    DeviceNode - Specified the device object.  If The DeviceNode is specified,</span>
03955 <span class="comment">                 the InterfaceType and BusNumber are ignored and we will</span>
03956 <span class="comment">                 use DeviceNode as a starting point to find various translators to</span>
03957 <span class="comment">                 translate the Source descriptor.  If DeviceNode is not specified,</span>
03958 <span class="comment">                 the InterfaceType and BusNumber must be specified.</span>
03959 <span class="comment"></span>
03960 <span class="comment">    InterfaceType, BusNumber - must be supplied if DeviceNode is not specified.</span>
03961 <span class="comment"></span>
03962 <span class="comment">    Source - A pointer to the resource descriptor to be translated.</span>
03963 <span class="comment"></span>
03964 <span class="comment">    Target - Supplies an address to receive the translated resource descriptor.</span>
03965 <span class="comment"></span>
03966 <span class="comment">Return Value:</span>
03967 <span class="comment"></span>
03968 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03969 <span class="comment"></span>
03970 <span class="comment">--*/</span>
03971 {
03972     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03973     PLIST_ENTRY listHead, nextEntry;
03974     PCM_PARTIAL_RESOURCE_DESCRIPTOR target, source, tmp;
03975     <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PPI_RESOURCE_TRANSLATOR_ENTRY</a> translatorEntry;
03976     <a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">PTRANSLATOR_INTERFACE</a> translator;
03977     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
03978     BOOLEAN done = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, foundTranslator = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, restartedAlready;
03979 
03980     <span class="keywordflow">if</span> (ArbiterRequestSource == <a class="code" href="../../d6/d9/pnp_8h.html#a174a127">ArbiterRequestHalReported</a>) {
03981        restartedAlready = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03982     } <span class="keywordflow">else</span> {
03983        restartedAlready = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03984     }
03985 
03986     source = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) <a class="code" href="../../d5/d1/pnpres_8c.html#a7">ExAllocatePoolPRD</a>(
03987                          <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03988                          <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR)
03989                          );
03990     <span class="keywordflow">if</span> (source == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03991         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03992     }
03993     target = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) <a class="code" href="../../d5/d1/pnpres_8c.html#a7">ExAllocatePoolPRD</a>(
03994                          <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03995                          <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR)
03996                          );
03997     <span class="keywordflow">if</span> (target == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03998         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(source);
03999         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04000     }
04001     *source = *Source;
04002 
04003     <span class="comment">//</span>
04004     <span class="comment">// Move up to current device node's parent to start translation</span>
04005     <span class="comment">//</span>
04006 
04007     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(DeviceNode)) {
04008         deviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>, <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>, <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>, 0);
04009     } <span class="keywordflow">else</span> {
04010         <span class="comment">// We want to start with the deviceNode instead of its parent.  Because the</span>
04011         <span class="comment">// deviceNode may provide a translator interface.</span>
04012         deviceNode = DeviceNode;
04013     }
04014     <span class="keywordflow">while</span> (deviceNode &amp;&amp; !done) {
04015 
04016         <span class="keywordflow">if</span> ((deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) &amp;&amp; (foundTranslator == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
04017             <span class="keywordflow">if</span> (restartedAlready == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04018                 restartedAlready = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04019                 deviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>, <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>, <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>, 0);
04020 
04021                 <span class="comment">//</span>
04022                 <span class="comment">// If we did not find a PDO, try again with InterfaceType == Isa. This allows</span>
04023                 <span class="comment">// drivers that request Internal to get resources even if there is no PDO</span>
04024                 <span class="comment">// that is Internal. (but if there is an Internal PDO, they get that one)</span>
04025                 <span class="comment">//</span>
04026 
04027                 <span class="keywordflow">if</span> ((deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) &amp;&amp; (<a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> == Internal)) {
04028                     deviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>, Isa, 0, 0);
04029                 }
04030 
04031                 <span class="keywordflow">continue</span>;
04032             }
04033         }
04034         <span class="comment">//</span>
04035         <span class="comment">// First, check if there is a translator for the device node?</span>
04036         <span class="comment">// If yes, translate the req desc and link it to the front of ReqDesc-&gt;TranslatedReqDesc</span>
04037         <span class="comment">// else do nothing.</span>
04038         <span class="comment">//</span>
04039 
04040         listHead = &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o25">DeviceTranslatorList</a>;
04041         nextEntry = listHead-&gt;Flink;
04042         <span class="keywordflow">for</span> (; nextEntry != listHead; nextEntry = nextEntry-&gt;Flink) {
04043             translatorEntry = CONTAINING_RECORD(nextEntry, <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PI_RESOURCE_TRANSLATOR_ENTRY</a>, DeviceTranslatorList);
04044             <span class="keywordflow">if</span> (translatorEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o1">ResourceType</a> == Source-&gt;Type) {
04045                 <span class="keywordflow">if</span> (translator = translatorEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o2">TranslatorInterface</a>) {
04046 
04047                     <span class="comment">//</span>
04048                     <span class="comment">// Find a translator to translate the req desc ... Translate it and link it to</span>
04049                     <span class="comment">// the front of ReqDesc-&gt;TranslatedReqDesc.</span>
04050                     <span class="comment">//</span>
04051 
04052 doitagain:
04053                     status = (translator-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o5">TranslateResources</a>) (
04054                                   translator-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o2">Context</a>,
04055                                   source,
04056                                   <a class="code" href="../../d6/d9/pnp_8h.html#a176a135">TranslateChildToParent</a>,
04057                                   0,
04058                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04059                                   DeviceNode ? DeviceNode-&gt;PhysicalDeviceObject : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04060                                   target
04061                                   );
04062                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04063                         tmp = source;
04064                         source = target;
04065                         target = tmp;
04066 
04067                         <span class="comment">//</span>
04068                         <span class="comment">// If the translator is non-hierarchial and performs a complete</span>
04069                         <span class="comment">// translation to root (eg ISA interrups for PCI devices) then</span>
04070                         <span class="comment">// don't pass translations to parent.</span>
04071                         <span class="comment">//</span>
04072 
04073                         <span class="keywordflow">if</span> (status == STATUS_TRANSLATION_COMPLETE) {
04074                             done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04075                         }
04076 
04077                     } <span class="keywordflow">else</span> {
04078 <span class="preprocessor">#if DBG_SCOPE</span>
04079 <span class="preprocessor"></span>                        <span class="comment">// DebugMessage(DUMP_ERROR, ("PnpRes: Child to Root Translation failed\n"));</span>
04080                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PnpRes: Child to Root Translation failed\n"</span>);
04081                         <span class="keywordflow">if</span> (DeviceNode) {
04082                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(
04083                                 <span class="stringliteral">"        DeviceNode %08x (PDO %08x)\n"</span>,
04084                                 DeviceNode,
04085                                 DeviceNode-&gt;PhysicalDeviceObject
04086                                 );
04087                         }
04088                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(
04089                             <span class="stringliteral">"        Resource Type %02x Data %08x %08x %08x\n"</span>,
04090                             source-&gt;Type,
04091                             source-&gt;u.DevicePrivate.Data[0],
04092                             source-&gt;u.DevicePrivate.Data[1],
04093                             source-&gt;u.DevicePrivate.Data[2]
04094                             );
04095                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a48">PnpResDebugTranslationFailureCount</a>) {
04096                             <a class="code" href="../../d5/d1/pnpres_8c.html#a48">PnpResDebugTranslationFailureCount</a>--;
04097                             <a class="code" href="../../d5/d1/pnpres_8c.html#a50">PnpResDebugTranslationFailure</a>-&gt;<a class="code" href="../../d3/d5/structPNPRESDEBUGTRANSLATIONFAILURE.html#o0">devnode</a> = DeviceNode;
04098                             <a class="code" href="../../d5/d1/pnpres_8c.html#a50">PnpResDebugTranslationFailure</a>-&gt;<a class="code" href="../../d3/d5/structPNPRESDEBUGTRANSLATIONFAILURE.html#o1">resource</a> = *source;
04099                             <a class="code" href="../../d5/d1/pnpres_8c.html#a50">PnpResDebugTranslationFailure</a>++;
04100                         }
04101                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a26">STOP_ERROR</a>) {
04102                             DbgBreakPoint();
04103                             <span class="keywordflow">goto</span> doitagain;
04104                         }
04105 <span class="preprocessor">#endif</span>
04106 <span class="preprocessor"></span>                        <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
04107                     }
04108                 }
04109                 <span class="keywordflow">break</span>;
04110             }
04111         }
04112 
04113         <span class="comment">//</span>
04114         <span class="comment">// Move up to current device node's parent</span>
04115         <span class="comment">//</span>
04116 
04117         deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
04118     }
04119     *Target = source;
04120     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(target);
04121     <span class="keywordflow">return</span> status;
04122 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
04123     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(source);
04124     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(target);
04125     <span class="keywordflow">return</span> status;
04126 }
04127 
04128 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04129"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a78">04129</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a78">IopTranslateAndAdjustReqDesc</a>(
04130     IN PREQ_DESC ReqDesc,
04131     IN <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PPI_RESOURCE_TRANSLATOR_ENTRY</a> TranslatorEntry,
04132     OUT PREQ_DESC *TranslatedReqDesc
04133     )
04134 
04135 <span class="comment">/*++</span>
04136 <span class="comment"></span>
04137 <span class="comment">Routine Description:</span>
04138 <span class="comment"></span>
04139 <span class="comment">    This routine translates and adjusts ReqDesc IoResourceDescriptors to</span>
04140 <span class="comment">    their translated and adjusted form.</span>
04141 <span class="comment"></span>
04142 <span class="comment">Parameters:</span>
04143 <span class="comment"></span>
04144 <span class="comment">    ReqDesc - supplies a pointer to the REQ_DESC to be translated.</span>
04145 <span class="comment"></span>
04146 <span class="comment">    TranslatorEntry - supplies a pointer to the translator infor structure.</span>
04147 <span class="comment"></span>
04148 <span class="comment">    TranslatedReqDesc - supplies a pointer to a variable to receive the</span>
04149 <span class="comment">                        translated REQ_DESC.</span>
04150 <span class="comment"></span>
04151 <span class="comment">Return Value:</span>
04152 <span class="comment"></span>
04153 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
04154 <span class="comment"></span>
04155 <span class="comment">--*/</span>
04156 {
04157     ULONG i, total = 0, *targetCount;
04158     <a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">PTRANSLATOR_INTERFACE</a> translator = TranslatorEntry-&gt;TranslatorInterface;
04159     PIO_RESOURCE_DESCRIPTOR ioDesc, *target, tIoDesc;
04160     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> tReqDesc;
04161     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a> arbiterEntry;
04162     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status, returnStatus = STATUS_SUCCESS;
04163     BOOLEAN reqTranslated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04164 
04165     <span class="keywordflow">if</span> (ReqDesc-&gt;AlternativeTable.AlternativeCount == 0) {
04166         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
04167     }
04168 
04169     *TranslatedReqDesc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04170 
04171     target = (PIO_RESOURCE_DESCRIPTOR *) <a class="code" href="../../d5/d1/pnpres_8c.html#a8">ExAllocatePoolIORD</a>(
04172                            <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04173                            <span class="keyword">sizeof</span>(PIO_RESOURCE_DESCRIPTOR) * ReqDesc-&gt;AlternativeTable.AlternativeCount
04174                            );
04175     <span class="keywordflow">if</span> (target == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04176         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes: Not Enough memory to perform resreqlist adjustment\n"</span>));
04177         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04178     }
04179     RtlZeroMemory(target, <span class="keyword">sizeof</span>(PIO_RESOURCE_DESCRIPTOR) * ReqDesc-&gt;AlternativeTable.AlternativeCount);
04180 
04181     targetCount = (PULONG) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
04182                            <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04183                            <span class="keyword">sizeof</span>(ULONG) * ReqDesc-&gt;AlternativeTable.AlternativeCount
04184                            );
04185     <span class="keywordflow">if</span> (targetCount == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04186         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes: Not Enough memory to perform resreqlist adjustment\n"</span>));
04187         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(target);
04188         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04189     }
04190 
04191     RtlZeroMemory(targetCount, <span class="keyword">sizeof</span>(ULONG) * ReqDesc-&gt;AlternativeTable.AlternativeCount);
04192 
04193     <span class="comment">//</span>
04194     <span class="comment">// Determine the number of IO_RESOURCE_DESCRIPTORs after translation.</span>
04195     <span class="comment">//</span>
04196 
04197     ioDesc = ReqDesc-&gt;AlternativeTable.Alternatives;
04198     <span class="keywordflow">for</span> (i = 0; i &lt; ReqDesc-&gt;AlternativeTable.AlternativeCount; i++) {
04199         status = (translator-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o6">TranslateResourceRequirements</a>)(
04200                            translator-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o2">Context</a>,
04201                            ioDesc,
04202                            ReqDesc-&gt;AlternativeTable.PhysicalDeviceObject,
04203                            &amp;targetCount[i],
04204                            &amp;target[i]
04205                            );
04206         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || targetCount[i] == 0) {
04207             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes:Translator failed to adjust resreqlist\n"</span>));
04208             target[i] = ioDesc;
04209             targetCount[i] = 0;
04210             total++;
04211         } <span class="keywordflow">else</span> {
04212             total += targetCount[i];
04213             reqTranslated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04214         }
04215         ioDesc++;
04216         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (returnStatus != STATUS_TRANSLATION_COMPLETE)) {
04217             returnStatus = status;
04218         }
04219     }
04220 
04221     <span class="keywordflow">if</span> (!reqTranslated) {
04222         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes:Failed to translate any requirement for %ws!\n"</span>, ((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)(ReqDesc-&gt;AlternativeTable.PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode))-&gt;InstancePath.Buffer));
04223         returnStatus = status;
04224     }
04225 
04226     <span class="comment">//</span>
04227     <span class="comment">// Allocate memory for the adjusted/translated resources descriptors</span>
04228     <span class="comment">//</span>
04229 
04230     tIoDesc = (PIO_RESOURCE_DESCRIPTOR) <a class="code" href="../../d5/d1/pnpres_8c.html#a8">ExAllocatePoolIORD</a>(
04231                            <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04232                            total * <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR));
04233     <span class="keywordflow">if</span> (!tIoDesc) {
04234         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes: Not Enough memory to perform resreqlist adjustment\n"</span>));
04235         returnStatus = STATUS_INSUFFICIENT_RESOURCES;
04236         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
04237     }
04238 
04239     tReqDesc = (<a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>) <a class="code" href="../../d5/d1/pnpres_8c.html#a9">ExAllocatePool1RD</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(REQ_DESC));
04240     <span class="keywordflow">if</span> (tReqDesc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04241         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes: Not Enough memory to perform resreqlist adjustment\n"</span>));
04242         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(tIoDesc);
04243         returnStatus = STATUS_INSUFFICIENT_RESOURCES;
04244         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
04245     }
04246 
04247     <span class="comment">//</span>
04248     <span class="comment">// Create and initialize a new REQ_DESC for the translated/adjusted io resources</span>
04249     <span class="comment">//</span>
04250 
04251     RtlMoveMemory(tReqDesc, ReqDesc, <span class="keyword">sizeof</span>(REQ_DESC));
04252 
04253     <span class="comment">//</span>
04254     <span class="comment">// Set the translated req desc's ReqAlternative to NULL to indicated this</span>
04255     <span class="comment">// is not the original req desc.</span>
04256     <span class="comment">//</span>
04257 
04258     tReqDesc-&gt;ReqAlternative = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04259 
04260     tReqDesc-&gt;u.Translator = TranslatorEntry;
04261     tReqDesc-&gt;TranslatedReqDesc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04262     arbiterEntry = &amp;tReqDesc-&gt;AlternativeTable;
04263     InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>);
04264     arbiterEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a> = total;
04265     arbiterEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o2">Alternatives</a> = tIoDesc;
04266     arbiterEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o10">Assignment</a> = &amp;tReqDesc-&gt;Allocation;
04267 
04268     ioDesc = ReqDesc-&gt;AlternativeTable.Alternatives;
04269     <span class="keywordflow">for</span> (i = 0; i &lt; ReqDesc-&gt;AlternativeTable.AlternativeCount; i++) {
04270         <span class="keywordflow">if</span> (targetCount[i] != 0) {
04271             RtlMoveMemory(tIoDesc, target[i], targetCount[i] * <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR));
04272             tIoDesc += targetCount[i];
04273         } <span class="keywordflow">else</span> {
04274 
04275             <span class="comment">//</span>
04276             <span class="comment">// Make it become impossible to satisfy.</span>
04277             <span class="comment">//</span>
04278 
04279             RtlMoveMemory(tIoDesc, ioDesc, <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR));
04280             <span class="keywordflow">switch</span> (tIoDesc-&gt;Type) {
04281             <span class="keywordflow">case</span> CmResourceTypePort:
04282             <span class="keywordflow">case</span> CmResourceTypeMemory:
04283                 tIoDesc-&gt;u.Port.MinimumAddress.LowPart = 2;
04284                 tIoDesc-&gt;u.Port.MinimumAddress.HighPart = 0;
04285                 tIoDesc-&gt;u.Port.MaximumAddress.LowPart = 1;
04286                 tIoDesc-&gt;u.Port.MaximumAddress.HighPart = 0;
04287                 <span class="keywordflow">break</span>;
04288             <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04289                 tIoDesc-&gt;u.BusNumber.MinBusNumber = 2;
04290                 tIoDesc-&gt;u.BusNumber.MaxBusNumber = 1;
04291                 <span class="keywordflow">break</span>;
04292 
04293             <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04294                 tIoDesc-&gt;u.Interrupt.MinimumVector = 2;
04295                 tIoDesc-&gt;u.Interrupt.MaximumVector = 1;
04296                 <span class="keywordflow">break</span>;
04297 
04298             <span class="keywordflow">case</span> CmResourceTypeDma:
04299                 tIoDesc-&gt;u.Dma.MinimumChannel = 2;
04300                 tIoDesc-&gt;u.Dma.MaximumChannel = 1;
04301                 <span class="keywordflow">break</span>;
04302             <span class="keywordflow">default</span>:
04303                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
04304                 <span class="keywordflow">break</span>;
04305             }
04306             tIoDesc += 1;
04307         }
04308         ioDesc++;
04309 
04310     }
04311 
04312 <span class="preprocessor">#if DBG</span>
04313 <span class="preprocessor"></span>    <span class="comment">//</span>
04314     <span class="comment">// Verify the adjusted resource descriptors are valid</span>
04315     <span class="comment">//</span>
04316 
04317     ioDesc = arbiterEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o2">Alternatives</a>;
04318     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ioDesc-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) == 0);
04319     ioDesc++;
04320     <span class="keywordflow">for</span> (i = 1; i &lt; total; i++) {
04321         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ioDesc-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE);
04322         ioDesc++;
04323     }
04324 <span class="preprocessor">#endif</span>
04325 <span class="preprocessor"></span>    *TranslatedReqDesc = tReqDesc;
04326 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
04327     <span class="keywordflow">for</span> (i = 0; i &lt; ReqDesc-&gt;AlternativeTable.AlternativeCount; i++) {
04328         <span class="keywordflow">if</span> (targetCount[i] != 0) {
04329             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(target[i]);
04330             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(target[i]);
04331         }
04332     }
04333     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(target);
04334     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(targetCount);
04335     <span class="keywordflow">return</span> returnStatus;
04336 }
04337 
04338 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04339"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a79">04339</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(
04340     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> ArbiterEntry,
04341     ARBITER_ACTION Command,
04342     PVOID Input1,
04343     PVOID Input2,
04344     PVOID Input3
04345     )
04346 
04347 <span class="comment">/*++</span>
04348 <span class="comment"></span>
04349 <span class="comment">Routine Description:</span>
04350 <span class="comment"></span>
04351 <span class="comment">    This routine builds a Parameter block from Input structure and calls specified</span>
04352 <span class="comment">    arbiter to carry out the Command.</span>
04353 <span class="comment"></span>
04354 <span class="comment">Parameters:</span>
04355 <span class="comment"></span>
04356 <span class="comment">    ArbiterEntry - Supplies a pointer to our PI_RESOURCE_ARBITER_ENTRY such that</span>
04357 <span class="comment">                   we know everything about the arbiter.</span>
04358 <span class="comment"></span>
04359 <span class="comment">    Command - Supplies the Action code for the arbiter.</span>
04360 <span class="comment"></span>
04361 <span class="comment">    Input - Supplies a PVOID pointer to a structure.</span>
04362 <span class="comment"></span>
04363 <span class="comment">Return Value:</span>
04364 <span class="comment"></span>
04365 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
04366 <span class="comment"></span>
04367 <span class="comment">--*/</span>
04368 {
04369     <a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html">ARBITER_PARAMETERS</a> parameters;
04370     <a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html">PARBITER_INTERFACE</a> arbiterInterface = ArbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o2">ArbiterInterface</a>;
04371     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04372     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a> arbiterListEntry;
04373     LIST_ENTRY listHead;
04374     PVOID *ExtParams;
04375 
04376     <span class="keywordflow">switch</span> (Command) {
04377     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>:
04378     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a116">ArbiterActionRetestAllocation</a>:
04379 
04380         <span class="comment">//</span>
04381         <span class="comment">// For ArbiterActionTestAllocation, the Input is a pointer to the doubly</span>
04382         <span class="comment">// linked list of ARBITER_LIST_ENTRY's.</span>
04383         <span class="comment">//</span>
04384 
04385         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.TestAllocation.ArbitrationList = (PLIST_ENTRY)Input1;
04386         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.TestAllocation.AllocateFromCount = (ULONG)((ULONG_PTR)Input2);
04387         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.TestAllocation.AllocateFrom =
04388                                             (PCM_PARTIAL_RESOURCE_DESCRIPTOR)Input3;
04389         status = (arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o5">ArbiterHandler</a>)(
04390                       arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a>,
04391                       Command,
04392                       &amp;parameters
04393                       );
04394         <span class="keywordflow">break</span>;
04395 
04396     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a124">ArbiterActionBootAllocation</a>:
04397 
04398         <span class="comment">//</span>
04399         <span class="comment">// For ArbiterActionBootAllocation, the input is a pointer to the doubly</span>
04400         <span class="comment">// linked list of ARBITER_LIST_ENTRY'S.</span>
04401         <span class="comment">//</span>
04402 
04403         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.BootAllocation.ArbitrationList = (PLIST_ENTRY)Input1;
04404 
04405         status = (arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o5">ArbiterHandler</a>)(
04406                       arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a>,
04407                       Command,
04408                       &amp;parameters
04409                       );
04410         <span class="keywordflow">break</span>;
04411 
04412     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a122">ArbiterActionQueryArbitrate</a>:
04413 
04414         <span class="comment">//</span>
04415         <span class="comment">// For QueryArbiter, the input is a pointer to REQ_DESC</span>
04416         <span class="comment">//</span>
04417 
04418         arbiterListEntry = &amp;((<a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>)Input1)-&gt;AlternativeTable;
04419         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>));
04420         listHead = arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>;
04421         arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>.Flink = arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>.Blink = &amp;listHead;
04422         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.QueryArbitrate.ArbitrationList = &amp;listHead;
04423         status = (arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o5">ArbiterHandler</a>)(
04424                       arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a>,
04425                       Command,
04426                       &amp;parameters
04427                       );
04428         arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a> = listHead;
04429         <span class="keywordflow">break</span>;
04430 
04431     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>:
04432     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a118">ArbiterActionRollbackAllocation</a>:
04433     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a120">ArbiterActionWriteReservedResources</a>:
04434 
04435         <span class="comment">//</span>
04436         <span class="comment">// Commit, Rollback and WriteReserved do not have parmater.</span>
04437         <span class="comment">//</span>
04438 
04439         status = (arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o5">ArbiterHandler</a>)(
04440                       arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a>,
04441                       Command,
04442                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04443                       );
04444         <span class="keywordflow">break</span>;
04445 
04446     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a119">ArbiterActionQueryAllocatedResources</a>:
04447         status = STATUS_NOT_IMPLEMENTED;
04448         <span class="keywordflow">break</span>;
04449 
04450     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a121">ArbiterActionQueryConflict</a>:
04451         <span class="comment">//</span>
04452         <span class="comment">// For QueryConflict</span>
04453         <span class="comment">// Ex0 is PDO</span>
04454         <span class="comment">// Ex1 is PIO_RESOURCE_DESCRIPTOR</span>
04455         <span class="comment">// Ex2 is PULONG</span>
04456         <span class="comment">// Ex3 is PARBITER_CONFLICT_INFO *</span>
04457         ExtParams = (PVOID*)Input1;
04458 
04459         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.QueryConflict.PhysicalDeviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)ExtParams[0];
04460         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.QueryConflict.ConflictingResource = (PIO_RESOURCE_DESCRIPTOR)ExtParams[1];
04461         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.QueryConflict.ConflictCount = (PULONG)ExtParams[2];
04462         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.QueryConflict.Conflicts = (<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">PARBITER_CONFLICT_INFO</a> *)ExtParams[3];
04463         status = (arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o5">ArbiterHandler</a>)(
04464                       arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a>,
04465                       Command,
04466                       &amp;parameters
04467                       );
04468         <span class="keywordflow">break</span>;
04469 
04470     <span class="keywordflow">default</span>:
04471         status = STATUS_INVALID_PARAMETER;
04472         <span class="keywordflow">break</span>;
04473     }
04474 
04475     <span class="keywordflow">return</span> status;
04476 }
04477 
04478 <span class="preprocessor">#if DBG_SCOPE</span>
04479 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04480"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a97">04480</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a97">IopDumpResourceRequirementsList</a>(
04481     IN PIO_RESOURCE_REQUIREMENTS_LIST IoResources
04482     )
04483 
04484 <span class="comment">/*++</span>
04485 <span class="comment"></span>
04486 <span class="comment">Routine Description:</span>
04487 <span class="comment"></span>
04488 <span class="comment">    This routine dumps IoResources</span>
04489 <span class="comment"></span>
04490 <span class="comment">Parameters:</span>
04491 <span class="comment"></span>
04492 <span class="comment">    IoResources - supplies a pointer to the IO resource requirements list</span>
04493 <span class="comment"></span>
04494 <span class="comment">Return Value:</span>
04495 <span class="comment"></span>
04496 <span class="comment">    None.</span>
04497 <span class="comment"></span>
04498 <span class="comment">--*/</span>
04499 
04500 {
04501     PIO_RESOURCE_LIST IoResourceList;
04502     PIO_RESOURCE_DESCRIPTOR IoResourceDescriptor;
04503     PIO_RESOURCE_DESCRIPTOR IoResourceDescriptorEnd;
04504     LONG IoResourceListCount;
04505 
04506     <span class="keywordflow">if</span> (IoResources == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04507         <span class="keywordflow">return</span>;
04508     }
04509     IoResourceList = IoResources-&gt;List;
04510     IoResourceListCount = (LONG) IoResources-&gt;AlternativeLists;
04511     <span class="comment">//</span>
04512     <span class="comment">// For old IO resource requirements list there is no assigned resources associated with</span>
04513     <span class="comment">// it.  We simply free the memory.</span>
04514     <span class="comment">//</span>
04515 
04516     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"** ResReqList: Interface: %x, Bus: %x, Slot: %x, AlternativeLists: %x\n"</span>,
04517              IoResources-&gt;InterfaceType,
04518              IoResources-&gt;BusNumber,
04519              IoResources-&gt;SlotNumber,
04520              IoResources-&gt;AlternativeLists);
04521     <span class="keywordflow">while</span> (--IoResourceListCount &gt;= 0) {
04522         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"  Alternative List: DescCount: %x\n"</span>, IoResourceList-&gt;Count);
04523         IoResourceDescriptor = IoResourceList-&gt;Descriptors;
04524         IoResourceDescriptorEnd = IoResourceDescriptor + IoResourceList-&gt;Count;
04525         <span class="keywordflow">for</span> (; IoResourceDescriptor &lt; IoResourceDescriptorEnd; ++IoResourceDescriptor) {
04526             <a class="code" href="../../d5/d1/pnpres_8c.html#a98">IopDumpResourceDescriptor</a>(<span class="stringliteral">"    "</span>, IoResourceDescriptor);
04527         }
04528         IoResourceList = (PIO_RESOURCE_LIST) IoResourceDescriptorEnd;
04529     }
04530     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
04531 }
04532 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04533"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a98">04533</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a98">IopDumpResourceDescriptor</a> (
04534     IN PUCHAR Indent,
04535     IN PIO_RESOURCE_DESCRIPTOR  Desc
04536     )
04537 {
04538     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"%sOpt: %x, Share: %x\t"</span>, Indent, Desc-&gt;Option, Desc-&gt;ShareDisposition);
04539     <span class="keywordflow">switch</span> (Desc-&gt;Type) {
04540         <span class="keywordflow">case</span> CmResourceTypePort:
04541             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"IO  Min: %x:%08x, Max: %x:%08x, Algn: %x, Len %x\n"</span>,
04542                 Desc-&gt;u.Port.MinimumAddress.HighPart, Desc-&gt;u.Port.MinimumAddress.LowPart,
04543                 Desc-&gt;u.Port.MaximumAddress.HighPart, Desc-&gt;u.Port.MaximumAddress.LowPart,
04544                 Desc-&gt;u.Port.Alignment,
04545                 Desc-&gt;u.Port.Length
04546                 );
04547             <span class="keywordflow">break</span>;
04548 
04549         <span class="keywordflow">case</span> CmResourceTypeMemory:
04550             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MEM Min: %x:%08x, Max: %x:%08x, Algn: %x, Len %x\n"</span>,
04551                 Desc-&gt;u.Memory.MinimumAddress.HighPart, Desc-&gt;u.Memory.MinimumAddress.LowPart,
04552                 Desc-&gt;u.Memory.MaximumAddress.HighPart, Desc-&gt;u.Memory.MaximumAddress.LowPart,
04553                 Desc-&gt;u.Memory.Alignment,
04554                 Desc-&gt;u.Memory.Length
04555                 );
04556             <span class="keywordflow">break</span>;
04557 
04558         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04559             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"INT Min: %x, Max: %x\n"</span>,
04560                 Desc-&gt;u.Interrupt.MinimumVector,
04561                 Desc-&gt;u.Interrupt.MaximumVector
04562                 );
04563             <span class="keywordflow">break</span>;
04564 
04565         <span class="keywordflow">case</span> CmResourceTypeDma:
04566             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"DMA Min: %x, Max: %x\n"</span>,
04567                 Desc-&gt;u.Dma.MinimumChannel,
04568                 Desc-&gt;u.Dma.MaximumChannel
04569                 );
04570             <span class="keywordflow">break</span>;
04571 
04572         <span class="keywordflow">case</span> CmResourceTypeDevicePrivate:
04573             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"DevicePrivate Data: %x, %x, %x\n"</span>,
04574                 Desc-&gt;u.DevicePrivate.Data[0],
04575                 Desc-&gt;u.DevicePrivate.Data[1],
04576                 Desc-&gt;u.DevicePrivate.Data[2]
04577                 );
04578             <span class="keywordflow">break</span>;
04579 
04580         <span class="keywordflow">default</span>:
04581             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Unknown Descriptor type %x\n"</span>,
04582                 Desc-&gt;Type
04583                 );
04584             <span class="keywordflow">break</span>;
04585     }
04586 }
04587 <span class="preprocessor">#endif</span>
04588 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04589"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a80">04589</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a80">IopQueryRebalance</a> (
04590     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
04591     IN ULONG Phase,
04592     IN PULONG RebalanceCount,
04593     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> **DeviceTable
04594     )
04595 
04596 <span class="comment">/*++</span>
04597 <span class="comment"></span>
04598 <span class="comment">Routine Description:</span>
04599 <span class="comment"></span>
04600 <span class="comment">    This routine walks hardware tree depth first.  For each device node it visits,</span>
04601 <span class="comment">    it call IopQueryReconfigureDevice to query-stop device for resource</span>
04602 <span class="comment">    reconfiguration.</span>
04603 <span class="comment"></span>
04604 <span class="comment">    Note, Under rebalancing situation, all the participated devices will be asked to</span>
04605 <span class="comment">    stop.  Even they support non-stopped rebalancing.</span>
04606 <span class="comment"></span>
04607 <span class="comment">Parameters:</span>
04608 <span class="comment"></span>
04609 <span class="comment">    DeviceNode - supplies a pionter a device node which is the root of the tree to</span>
04610 <span class="comment">                 be tested.</span>
04611 <span class="comment"></span>
04612 <span class="comment">    Phase - Supplies a value to specify the phase of the rebalance.</span>
04613 <span class="comment"></span>
04614 <span class="comment">    RebalanceCount - supplies a pointer to a variable to receive the number of devices</span>
04615 <span class="comment">                 participating the rebalance.</span>
04616 <span class="comment"></span>
04617 <span class="comment">Return Value:</span>
04618 <span class="comment"></span>
04619 <span class="comment">    None.</span>
04620 <span class="comment"></span>
04621 <span class="comment">--*/</span>
04622 
04623 {
04624     LONG oldState;
04625     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *deviceList, *deviceTable, *device;
04626     ULONG count;
04627     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
04628 
04629 
04630     <span class="comment">//</span>
04631     <span class="comment">// Call worker routine to get a list of devices to be rebalanced.</span>
04632     <span class="comment">//</span>
04633 
04634     deviceTable = *DeviceTable;
04635     <a class="code" href="../../d5/d1/pnpres_8c.html#a81">IopQueryRebalanceWorker</a> (DeviceNode, Phase, RebalanceCount, DeviceTable);
04636 
04637     count = *RebalanceCount;
04638     <span class="keywordflow">if</span> (count != 0 &amp;&amp; Phase == 0) {
04639 
04640         <span class="comment">//</span>
04641         <span class="comment">// At phase 0, we did not actually query-stop the device.</span>
04642         <span class="comment">// We need to do it now.</span>
04643         <span class="comment">//</span>
04644 
04645         deviceList = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *)<a class="code" href="../../d5/d1/pnpres_8c.html#a10">ExAllocatePoolPDO</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, count * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>));
04646         <span class="keywordflow">if</span> (deviceList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04647             *RebalanceCount = 0;
04648             <span class="keywordflow">return</span>;
04649         }
04650         RtlMoveMemory(deviceList, deviceTable, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/io_8h.html#a340">PDEVICE_OBJECT</a>) * count);
04651 
04652         <span class="comment">//</span>
04653         <span class="comment">// Rebuild the returned device list</span>
04654         <span class="comment">//</span>
04655 
04656         *RebalanceCount = 0;
04657         *DeviceTable = deviceTable;
04658         <span class="keywordflow">for</span> (device = deviceList; device &lt; (deviceList + count); device++) {
04659             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)((*device)-&gt;DeviceObjectExtension-&gt;DeviceNode);
04660             <a class="code" href="../../d5/d1/pnpres_8c.html#a81">IopQueryRebalanceWorker</a> (deviceNode, 1, RebalanceCount, DeviceTable);
04661         }
04662         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceList);
04663     }
04664     <span class="keywordflow">return</span>;
04665 }
04666 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04667"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a81">04667</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a81">IopQueryRebalanceWorker</a> (
04668     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
04669     IN ULONG Phase,
04670     IN PULONG RebalanceCount,
04671     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> **DeviceTable
04672     )
04673 
04674 <span class="comment">/*++</span>
04675 <span class="comment"></span>
04676 <span class="comment">Routine Description:</span>
04677 <span class="comment"></span>
04678 <span class="comment">    This routine walks hardware tree depth first.  For each device node it visits,</span>
04679 <span class="comment">    it call IopQueryReconfigureDevice to query-stop and stop device for resource</span>
04680 <span class="comment">    reconfiguration.</span>
04681 <span class="comment"></span>
04682 <span class="comment">Parameters:</span>
04683 <span class="comment"></span>
04684 <span class="comment">    DeviceNode - supplies a pionter a device node which is the root of the tree to</span>
04685 <span class="comment">                 be tested.</span>
04686 <span class="comment"></span>
04687 <span class="comment">    Phase - Supplies a value to specify the phase of the rebalance.</span>
04688 <span class="comment"></span>
04689 <span class="comment">    RebalanceCount - supplies a pointer to a variable to receive the number of devices</span>
04690 <span class="comment">                 participating the rebalance.</span>
04691 <span class="comment"></span>
04692 <span class="comment">Return Value:</span>
04693 <span class="comment"></span>
04694 <span class="comment">    None.</span>
04695 <span class="comment"></span>
04696 <span class="comment">--*/</span>
04697 
04698 {
04699     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> node;
04700 
04701     <span class="keywordflow">if</span> (DeviceNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04702     {
04703         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode);
04704         <span class="keywordflow">return</span>;
04705     }
04706 
04707     <span class="comment">//</span>
04708     <span class="comment">// Include Insufficient_resources checking.  THis is because a driver (scsiminiport) may call</span>
04709     <span class="comment">// IoReportResourceUsage to perform detection and cause the (Isapnp) enumerated device</span>
04710     <span class="comment">// insufficient_resources to start.  At this point, the enumerated device resources should be locked down</span>
04711     <span class="comment">// for the detected instance.</span>
04712     <span class="comment">//</span>
04713 
04714     <span class="keywordflow">if</span> (((DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a44">DNF_ASYNC_REQUEST_PENDING</a>)  ||
04715         (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>)                ||
04716         (<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode))          ||
04717         (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a>)          ||
04718         (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>))   &amp;&amp;
04719         !(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a35">DNF_NEEDS_REBALANCE</a>)) {
04720 
04721         node = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
04722 
04723     } <span class="keywordflow">else</span> {
04724 
04725         node = DeviceNode;
04726 
04727     }
04728 
04729     <span class="keywordflow">for</span> (; node; node = node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>) {
04730 
04731         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>) {
04732 
04733             <span class="comment">//</span>
04734             <span class="comment">// If this subtree is not being removed, wait for current enumeration to complete.</span>
04735             <span class="comment">//</span>
04736 
04737             <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
04738 
04739                 <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>,
04740                                        <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
04741                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04742                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04743                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04744 
04745                 <a class="code" href="../../d5/d1/pnpres_8c.html#a81">IopQueryRebalanceWorker</a> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>, Phase, RebalanceCount, DeviceTable);
04746 
04747                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04748             }
04749         }
04750     }
04751 
04752     <span class="keywordflow">for</span> (node = DeviceNode; node; node = node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>) {
04753 
04754         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
04755 
04756             <a class="code" href="../../d5/d1/pnpres_8c.html#a82">IopTestForReconfiguration</a> (node, Phase, RebalanceCount, DeviceTable);
04757 
04758         } <span class="keywordflow">else</span> {
04759 
04760             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PNPRES: %ws enum lock is taken, skipping during REBALANCE!\n"</span>, node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
04761 
04762         }
04763     }
04764 }
04765 
04766 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04767"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a82">04767</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a82">IopTestForReconfiguration</a> (
04768     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
04769     IN ULONG Phase,
04770     IN PULONG RebalanceCount,
04771     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> **DeviceTable
04772     )
04773 
04774 
04775 <span class="comment">/*++</span>
04776 <span class="comment"></span>
04777 <span class="comment">Routine Description:</span>
04778 <span class="comment"></span>
04779 <span class="comment">    This routine query-stops a device which is started and owns resources.</span>
04780 <span class="comment">    Note the resources for the device are not released at this point.</span>
04781 <span class="comment"></span>
04782 <span class="comment">Parameters:</span>
04783 <span class="comment"></span>
04784 <span class="comment">    DeviceNode - supplies a pointer to the device node to be tested for reconfiguration.</span>
04785 <span class="comment"></span>
04786 <span class="comment">    Phase - Supplies a value to specify the phase of the rebalance.</span>
04787 <span class="comment"></span>
04788 <span class="comment">    RebalanceCount - supplies a pointer to a variable to receive the number of devices</span>
04789 <span class="comment">                 participating the rebalance.</span>
04790 <span class="comment"></span>
04791 <span class="comment">Return Value:</span>
04792 <span class="comment"></span>
04793 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
04794 <span class="comment"></span>
04795 <span class="comment">--*/</span>
04796 
04797 {
04798     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> nodex;
04799     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04800     BOOLEAN addToList = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04801 
04802     <span class="comment">//</span>
04803     <span class="comment">// We still need to perform the test for sibling nodes.</span>
04804     <span class="comment">//</span>
04805 
04806     <span class="keywordflow">if</span> ((DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a44">DNF_ASYNC_REQUEST_PENDING</a>)  ||
04807         (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>)                ||
04808         (<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode))          ||
04809         (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a>)          ||
04810         (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>)) {
04811         <span class="keywordflow">return</span>;
04812     }
04813 
04814     <span class="keywordflow">if</span> (Phase == 0) {
04815 
04816         <span class="comment">//</span>
04817         <span class="comment">// At phase zero, this routine only wants to find out which devices's resource</span>
04818         <span class="comment">// requirements lists chagned.  No one actually gets stopped.</span>
04819         <span class="comment">//</span>
04820 
04821         <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a> &amp;&amp;
04822             !(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a21">DNF_NON_STOPPED_REBALANCE</a>) ) {
04823 
04824             <span class="comment">//</span>
04825             <span class="comment">// It's too hard to handle non-stop rebalancing devices during rebalance.</span>
04826             <span class="comment">// So, We will skip it.</span>
04827             <span class="comment">//</span>
04828 
04829             addToList = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04830         } <span class="keywordflow">else</span> {
04831 
04832             <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
04833                 status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (<a class="code" href="../../d0/d5/io_8h.html#a70">IRP_MN_QUERY_STOP_DEVICE</a>, DeviceNode-&gt;PhysicalDeviceObject);
04834                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04835                     <span class="keywordflow">if</span> (status == STATUS_RESOURCE_REQUIREMENTS_CHANGED) {
04836 
04837                         <span class="comment">//</span>
04838                         <span class="comment">// If we find out a device's resource requirements changed this way,</span>
04839                         <span class="comment">// it will be stopped and reassigned resources even if it supports</span>
04840                         <span class="comment">// non-stopped rebalance.</span>
04841                         <span class="comment">//</span>
04842 
04843                         DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>;
04844                         addToList = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04845                     }
04846                 }
04847                 <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (<a class="code" href="../../d0/d5/io_8h.html#a71">IRP_MN_CANCEL_STOP_DEVICE</a>, DeviceNode-&gt;PhysicalDeviceObject);
04848             }
04849         }
04850         <span class="keywordflow">if</span> (addToList) {
04851             *RebalanceCount = *RebalanceCount + 1;
04852             **DeviceTable = DeviceNode-&gt;PhysicalDeviceObject;
04853             *DeviceTable = *DeviceTable + 1;
04854         }
04855     } <span class="keywordflow">else</span> {
04856 
04857         <span class="comment">//</span>
04858         <span class="comment">// Phase 1</span>
04859         <span class="comment">//</span>
04860 
04861         <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
04862 
04863             <span class="comment">//</span>
04864             <span class="comment">// Make sure all the resources required children of the DeviceNode are stopped.</span>
04865             <span class="comment">//</span>
04866 
04867             nodex = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
04868             <span class="keywordflow">while</span> (nodex) {
04869                 <span class="keywordflow">if</span> (!(nodex-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>)) ||
04870                     (nodex-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>) ||
04871                     (nodex-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a35">DNF_NEEDS_REBALANCE</a>)) {
04872                     nodex = nodex-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
04873                 } <span class="keywordflow">else</span> {
04874                     <span class="keywordflow">break</span>;
04875                 }
04876             }
04877             <span class="keywordflow">if</span> (nodex) {
04878 
04879                 <span class="comment">//</span>
04880                 <span class="comment">// If any resource required child of the DeviceNode does not stopped,</span>
04881                 <span class="comment">// we won't ask the DeviceNode to stop.</span>
04882                 <span class="comment">// BUGBUG: We may want to restart the stopped subtrees.</span>
04883                 <span class="comment">//</span>
04884 
04885                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>, (<span class="stringliteral">"Rebalance: Child %ws not stopped for %ws\n"</span>, nodex-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer, DeviceNode-&gt;InstancePath.Buffer));
04886                 <span class="keywordflow">return</span>;
04887             }
04888         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>) == 0 ||
04889                    !(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>) ||
04890                    DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) {
04891 
04892             <span class="comment">//</span>
04893             <span class="comment">// The device is not started and has no boot config.  There is no need to query-stop it.</span>
04894             <span class="comment">// Or if the device has BOOT config but there is no driver installed for it.  We don't query</span>
04895             <span class="comment">// stop it. (There may be legacy drivers are using the resources.)</span>
04896             <span class="comment">// We also don't want to query stop root enumerated devices (for performance reason.)</span>
04897             <span class="comment">// BUGBUG - We really want to query stop the root enumerated devices which do not have</span>
04898             <span class="comment">//          Boot Config and have resource requirement alternatives.  (But today some legacy</span>
04899             <span class="comment">//          driver installers do not create boot resources.)</span>
04900             <span class="comment">//</span>
04901 
04902             <span class="keywordflow">return</span>;
04903         }
04904         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (<a class="code" href="../../d0/d5/io_8h.html#a70">IRP_MN_QUERY_STOP_DEVICE</a>, DeviceNode-&gt;PhysicalDeviceObject);
04905         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04906             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>, (<span class="stringliteral">"Rebalance: %ws succeeded QueryStop\n"</span>, DeviceNode-&gt;InstancePath.Buffer));
04907             <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
04908 
04909                 <span class="comment">//DeviceNode-&gt;Flags &amp;= ~DNF_STARTED;</span>
04910                 DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>;
04911                 *RebalanceCount = *RebalanceCount + 1;
04912                 **DeviceTable = DeviceNode-&gt;PhysicalDeviceObject;
04913 
04914                 <span class="comment">//</span>
04915                 <span class="comment">// Add a reference to the device object such that it won't disapear during rebalance.</span>
04916                 <span class="comment">//</span>
04917 
04918                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(DeviceNode-&gt;PhysicalDeviceObject);
04919                 *DeviceTable = *DeviceTable + 1;
04920             } <span class="keywordflow">else</span> {
04921 
04922                 <span class="comment">//</span>
04923                 <span class="comment">// We need to release the device's prealloc boot config.  This device will NOT</span>
04924                 <span class="comment">// participate in resource rebalancing.</span>
04925                 <span class="comment">//</span>
04926 
04927                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>);
04928                 status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (<a class="code" href="../../d0/d5/io_8h.html#a69">IRP_MN_STOP_DEVICE</a>, DeviceNode-&gt;PhysicalDeviceObject);
04929                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
04930                 <a class="code" href="../../d5/d1/pnpres_8c.html#a15">IopReleaseBootResources</a>(DeviceNode);
04931 
04932                 <span class="comment">//</span>
04933                 <span class="comment">// Reset BOOT CONFIG flags.  DO NOT set DNF_STOPPED.</span>
04934                 <span class="comment">//</span>
04935 
04936                 DeviceNode-&gt;Flags &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a13">DNF_BOOT_CONFIG_RESERVED</a>);
04937             }
04938         } <span class="keywordflow">else</span> {
04939             <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (<a class="code" href="../../d0/d5/io_8h.html#a71">IRP_MN_CANCEL_STOP_DEVICE</a>, DeviceNode-&gt;PhysicalDeviceObject);
04940         }
04941     }
04942 
04943 }
04944 
04945 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04946"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a83">04946</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a83">IopPlacementForRebalance</a> (
04947     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
04948     IN ARBITER_ACTION ArbiterAction
04949     )
04950 
04951 <span class="comment">/*++</span>
04952 <span class="comment"></span>
04953 <span class="comment">Routine Description:</span>
04954 <span class="comment"></span>
04955 <span class="comment">    This routine walks the device tree bredth-first to arbitrate resources for</span>
04956 <span class="comment">    device node it visits.</span>
04957 <span class="comment"></span>
04958 <span class="comment">Parameters:</span>
04959 <span class="comment"></span>
04960 <span class="comment">    DeviceNode - supplies a pointer to a device node whoes subtree needs to be rebalanced.</span>
04961 <span class="comment"></span>
04962 <span class="comment">    ArbiterAction - specifies TEST or RETEST.</span>
04963 <span class="comment"></span>
04964 <span class="comment">Return Value:</span>
04965 <span class="comment"></span>
04966 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
04967 <span class="comment"></span>
04968 <span class="comment">--*/</span>
04969 
04970 {
04971     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
04972     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> node;
04973 
04974     <span class="comment">//</span>
04975     <span class="comment">// Perform breadth-first.  Arbitrate resource for the current device node;</span>
04976     <span class="comment">// Place resources for its sibling subtree and then child subtree.</span>
04977     <span class="comment">//</span>
04978 
04979     node = DeviceNode;
04980     <span class="keywordflow">while</span> (node) {
04981 
04982         <span class="comment">//</span>
04983         <span class="comment">// Arbitrate device resources iff its not locked for remove.</span>
04984         <span class="comment">//</span>
04985 
04986         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
04987 
04988             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a84">IopArbitrateDeviceResources</a> (node, ArbiterAction);
04989             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04990                 <span class="keywordflow">return</span> status;
04991             }
04992         }
04993         node = node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
04994     }
04995     node = DeviceNode;
04996     <span class="keywordflow">while</span> (node) {
04997 
04998         <span class="comment">//</span>
04999         <span class="comment">// If this subtree is not being removed, then process it.</span>
05000         <span class="comment">//</span>
05001 
05002         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a> &amp;&amp; node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
05003 
05004             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a83">IopPlacementForRebalance</a> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>, ArbiterAction);
05005             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05006                 <span class="keywordflow">return</span> status;
05007             }
05008         }
05009         node = node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
05010     }
05011 
05012     <span class="keywordflow">return</span> status;
05013 }
05014 
05015 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05016"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a84">05016</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a84">IopArbitrateDeviceResources</a> (
05017     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
05018     IN ARBITER_ACTION ArbiterAction
05019     )
05020 
05021 <span class="comment">/*++</span>
05022 <span class="comment"></span>
05023 <span class="comment">Routine Description:</span>
05024 <span class="comment"></span>
05025 <span class="comment">    This routine</span>
05026 <span class="comment"></span>
05027 <span class="comment">Parameters:</span>
05028 <span class="comment"></span>
05029 <span class="comment">    P1 -</span>
05030 <span class="comment"></span>
05031 <span class="comment">Return Value:</span>
05032 <span class="comment"></span>
05033 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
05034 <span class="comment"></span>
05035 <span class="comment">--*/</span>
05036 
05037 {
05038     PLIST_ENTRY listEntry, listHead;
05039     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
05040     ULONG count = 0;
05041     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDesc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05042     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05043 
05044     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ArbiterAction == <a class="code" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>)   ||
05045            (ArbiterAction == <a class="code" href="../../d6/d9/pnp_8h.html#a173a116">ArbiterActionRetestAllocation</a>) ||
05046            (ArbiterAction == <a class="code" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>));
05047 
05048 
05049     listHead = &amp;DeviceNode-&gt;DeviceArbiterList;
05050     listEntry = listHead-&gt;Flink;
05051     <span class="keywordflow">while</span> (listEntry != listHead) {
05052         arbiterEntry = CONTAINING_RECORD(listEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, DeviceArbiterList);
05053         listEntry = listEntry-&gt;Flink;
05054         <span class="keywordflow">if</span> (IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
05055 
05056             <span class="keywordflow">if</span> (ArbiterAction == <a class="code" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>) {
05057 
05058                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry, <a class="code" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05059                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
05060                 arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> = 0;
05061                 InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
05062                 InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o5">BestConfig</a>);
05063                 InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>);
05064                 InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o4">BestResourceList</a>);
05065 
05066             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
05067 
05068                 <span class="comment">//</span>
05069                 <span class="comment">// If the resource requirements are the same and it failed before, we know it</span>
05070                 <span class="comment">// won't be able to succeed.  So, return failure.</span>
05071                 <span class="comment">//</span>
05072 
05073                 <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a59">PI_ARBITER_TEST_FAILED</a>) {
05074                     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
05075                 }
05076             } <span class="keywordflow">else</span> {
05077 
05078 
05079                 <span class="comment">//</span>
05080                 <span class="comment">// If the resource requirements are changed, we need to call arbiter to test it.</span>
05081                 <span class="comment">// First find out what resources *could* be owned by the arbiter.</span>
05082                 <span class="comment">// And then call the Arbiter to try to satisfy the request from the resources</span>
05083                 <span class="comment">// it *could* have.</span>
05084 
05085                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a86">IopFindResourcesForArbiter</a>(
05086                                         DeviceNode,
05087                                         arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o1">ResourceType</a>,
05088                                         &amp;count,
05089                                         &amp;cmDesc
05090                                         );
05091                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05092                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"Rebalance: Failed to find required resources for Arbiter\n"</span>));
05093                     <span class="keywordflow">return</span> status;
05094                 }
05095                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry,
05096                                         ArbiterAction,
05097                                         &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>,
05098                                         (PVOID)ULongToPtr(count),
05099                                         cmDesc
05100                                         );
05101                 <span class="keywordflow">if</span> (cmDesc) {
05102                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmDesc);
05103                 }
05104                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05105                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a59">PI_ARBITER_TEST_FAILED</a>;
05106                     <span class="keywordflow">return</span> status;
05107                 } <span class="keywordflow">else</span> {
05108                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a59">PI_ARBITER_TEST_FAILED</a>;
05109                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05110                     <span class="keywordflow">if</span> (ArbiterAction == <a class="code" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>) {
05111                         arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a58">PI_ARBITER_HAS_SOMETHING</a>;
05112                     }
05113                 }
05114             }
05115         }
05116     }
05117     <span class="keywordflow">return</span> STATUS_SUCCESS;
05118 }
05119 
05120 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05121"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a86">05121</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a86">IopFindResourcesForArbiter</a> (
05122     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
05123     IN UCHAR ResourceType,
05124     OUT ULONG *Count,
05125     OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR *CmDesc
05126     )
05127 
05128 <span class="comment">/*++</span>
05129 <span class="comment"></span>
05130 <span class="comment">Routine Description:</span>
05131 <span class="comment"></span>
05132 <span class="comment">    This routine returns the resources required by the ResourceType arbiter in DeviceNode.</span>
05133 <span class="comment"></span>
05134 <span class="comment">Parameters:</span>
05135 <span class="comment"></span>
05136 <span class="comment">    DeviceNode -specifies the device node whose ResourceType arbiter is requesting for resources</span>
05137 <span class="comment"></span>
05138 <span class="comment">    ResourceType - specifies the resource type</span>
05139 <span class="comment"></span>
05140 <span class="comment">    Count - specifies a pointer to a varaible to receive the count of Cm descriptors returned</span>
05141 <span class="comment"></span>
05142 <span class="comment">    CmDesc - specifies a pointer to a varibble to receive the returned cm descriptor.</span>
05143 <span class="comment"></span>
05144 <span class="comment">Return Value:</span>
05145 <span class="comment"></span>
05146 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
05147 <span class="comment"></span>
05148 <span class="comment">--*/</span>
05149 
05150 {
05151     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> assignEntry;
05152     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> reqAlternative;
05153     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> reqDesc;
05154     ULONG i, count = 0;
05155     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDescriptor;
05156 
05157     *<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
05158     *CmDesc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05159     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
05160         <span class="keywordflow">return</span> STATUS_SUCCESS;
05161     }
05162 
05163     <span class="comment">//</span>
05164     <span class="comment">// Find this device node's IOP_RESOURCE_REQUEST structure first</span>
05165     <span class="comment">//</span>
05166 
05167     <span class="keywordflow">for</span> (assignEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a> + <a class="code" href="../../d5/d1/pnpres_8c.html#a41">PiAssignTableCount</a> - 1;
05168          assignEntry &gt;= <a class="code" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a>;
05169          assignEntry--) {
05170         <span class="keywordflow">if</span> (assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> == DeviceNode-&gt;PhysicalDeviceObject) {
05171             <span class="keywordflow">break</span>;
05172         }
05173     }
05174     <span class="keywordflow">if</span> (assignEntry &lt; <a class="code" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a>) {
05175         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"Rebalance: No resreqlist for Arbiter? Can not find Arbiter assign table entry\n"</span>));
05176         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
05177     }
05178 
05179     reqAlternative = *((<a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a>)assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>)-&gt;SelectedAlternative;
05180     <span class="keywordflow">for</span> (i = 0; i &lt; reqAlternative-&gt;ReqDescCount; i++) {
05181         reqDesc = reqAlternative-&gt;ReqDescTable[i]-&gt;TranslatedReqDesc;
05182         <span class="keywordflow">if</span> (reqDesc-&gt;Allocation.Type == ResourceType) {
05183             count++;
05184         }
05185     }
05186 
05187     cmDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) <a class="code" href="../../d5/d1/pnpres_8c.html#a7">ExAllocatePoolPRD</a>(
05188                        <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
05189                        <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR) * count
05190                        );
05191     <span class="keywordflow">if</span> (!cmDescriptor) {
05192 
05193         <span class="comment">//</span>
05194         <span class="comment">// If we can not find memory, the resources will not be committed by arbiter.</span>
05195         <span class="comment">//</span>
05196 
05197         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"Rebalance: Not enough memory to perform rebalance\n"</span>));
05198         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05199     }
05200 
05201     *<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = count;
05202     *CmDesc = cmDescriptor;
05203 
05204     <span class="keywordflow">for</span> (i = 0; i &lt; reqAlternative-&gt;ReqDescCount; i++) {
05205         reqDesc = reqAlternative-&gt;ReqDescTable[i]-&gt;TranslatedReqDesc;
05206         <span class="keywordflow">if</span> (reqDesc-&gt;Allocation.Type == ResourceType) {
05207             *cmDescriptor = reqDesc-&gt;Allocation;
05208             cmDescriptor++;
05209         }
05210     }
05211     <span class="keywordflow">return</span> STATUS_SUCCESS;
05212 }
05213 
05214 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05215"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a85">05215</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a85">IopRebalance</a> (
05216     IN ULONG AssignTableCount,
05217     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable
05218     )
05219 
05220 
05221 <span class="comment">/*++</span>
05222 <span class="comment"></span>
05223 <span class="comment">Routine Description:</span>
05224 <span class="comment"></span>
05225 <span class="comment">    This routine performs rebalancing operation.  There are two rebalance phases:</span>
05226 <span class="comment">    In the phase 0, we only consider the devices whoes resource requirements changed</span>
05227 <span class="comment">    and their children; in phase 1, we consider anyone who succeeds the query-stop.</span>
05228 <span class="comment"></span>
05229 <span class="comment">Parameters:</span>
05230 <span class="comment"></span>
05231 <span class="comment">    AssignTableCount,</span>
05232 <span class="comment">    AssignTable - Supplies the number of origianl AssignTableCout and AssignTable which</span>
05233 <span class="comment">                  triggers the rebalance operation.</span>
05234 <span class="comment"></span>
05235 <span class="comment">        (if AssignTableCount == 0, we are processing device state change.)</span>
05236 <span class="comment"></span>
05237 <span class="comment">Return Value:</span>
05238 <span class="comment"></span>
05239 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
05240 <span class="comment"></span>
05241 <span class="comment">--*/</span>
05242 
05243 {
05244     ULONG count, i;
05245     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> table = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, tableEnd, newEntry;
05246     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> requestTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, requestTableEnd, entry1, entry2;
05247     ULONG phase0RebalanceCount = 0, rebalanceCount = 0, deviceCount;
05248     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status, statusx;
05249     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *deviceTable, *deviceTablex;
05250     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
05251     ULONG rebalancePhase = 0;
05252 
05253     <span class="comment">//</span>
05254     <span class="comment">// Query all the device nodes to see who are willing to participate the rebalance</span>
05255     <span class="comment">// process.</span>
05256     <span class="comment">//</span>
05257 
05258     deviceTable = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *) <a class="code" href="../../d5/d1/pnpres_8c.html#a10">ExAllocatePoolPDO</a>(
05259                       <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
05260                       <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) * <a class="code" href="../../d1/d0/pnpdata_8c.html#a12">IopNumberDeviceNodes</a>);
05261     <span class="keywordflow">if</span> (deviceTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05262         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"Rebalance: Not enough memory to perform rebalance\n"</span>));
05263         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05264     }
05265 
05266 
05267 tryAgain:
05268     deviceTablex = deviceTable + phase0RebalanceCount;
05269 
05270     <span class="comment">//</span>
05271     <span class="comment">// Walk device node tree depth-first to query-stop and stop devices.</span>
05272     <span class="comment">// At this point the resources of the stopped devices are not released yet.</span>
05273     <span class="comment">// Also, the leaf nodes are in the front of the device table and non leaf nodes</span>
05274     <span class="comment">// are at the end of the table.</span>
05275     <span class="comment">//</span>
05276 
05277     <a class="code" href="../../d5/d1/pnpres_8c.html#a80">IopQueryRebalance</a> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>, rebalancePhase, &amp;rebalanceCount, &amp;deviceTablex);
05278     <span class="keywordflow">if</span> (rebalanceCount == 0) {
05279 
05280         <span class="comment">//</span>
05281         <span class="comment">// If no one is interested and we are not processing resources req change,</span>
05282         <span class="comment">// move to next phase.</span>
05283         <span class="comment">//</span>
05284 
05285         <span class="keywordflow">if</span> (rebalancePhase == 0 &amp;&amp; AssignTableCount != 0) {
05286             rebalancePhase = 1;
05287             <span class="keywordflow">goto</span> tryAgain;
05288         }
05289         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>, (<span class="stringliteral">"Rebalance: No device participates in rebalance phase %x\n"</span>, rebalancePhase));
05290         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceTable);
05291         deviceTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05292         status = STATUS_UNSUCCESSFUL;
05293         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
05294     }
05295     <span class="keywordflow">if</span> (rebalanceCount == phase0RebalanceCount) {
05296 
05297         <span class="comment">//</span>
05298         <span class="comment">// Phase 0 failed and no new device participates. failed the rebalance.</span>
05299         <span class="comment">//</span>
05300 
05301         status = STATUS_UNSUCCESSFUL;
05302         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
05303     }
05304     <span class="keywordflow">if</span> (rebalancePhase == 0) {
05305         phase0RebalanceCount = rebalanceCount;
05306     }
05307 
05308     <span class="comment">//</span>
05309     <span class="comment">// Allocate pool for the new reconfiguration requests and the original requests.</span>
05310     <span class="comment">//</span>
05311 
05312     table = (<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>) <a class="code" href="../../d5/d1/pnpres_8c.html#a11">ExAllocatePoolIORR</a>(
05313                  <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
05314                  <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>) * (AssignTableCount + rebalanceCount)
05315                  );
05316     <span class="keywordflow">if</span> (table == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05317         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"Rebalance: Not enough memory to perform rebalance\n"</span>));
05318         status = STATUS_INSUFFICIENT_RESOURCES;
05319         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
05320     }
05321     tableEnd = table + AssignTableCount + rebalanceCount;
05322 
05323     <span class="comment">//</span>
05324     <span class="comment">// Build a new resource request table.  The original requests will be at the beginning</span>
05325     <span class="comment">// of the table and new requests (reconfigured devices) are at the end.</span>
05326     <span class="comment">// After the new request table is built, the leaf nodes will be in front of the table,</span>
05327     <span class="comment">// and non leaf nodes will be close to the end of the table.  This is for optimization.</span>
05328     <span class="comment">//</span>
05329 
05330     <span class="comment">//</span>
05331     <span class="comment">// Copy the original request to the front of our new request table.</span>
05332     <span class="comment">//</span>
05333 
05334     <span class="keywordflow">if</span> (AssignTableCount != 0) {
05335         RtlMoveMemory(table, AssignTable, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d0/pnpiop_8h.html#a131">IOP_RESOURCE_REQUEST</a>) * AssignTableCount);
05336     }
05337 
05338     <span class="comment">//</span>
05339     <span class="comment">// Initialize all the new entries of our new request table,</span>
05340     <span class="comment">//</span>
05341 
05342     newEntry = table + AssignTableCount;
05343     RtlZeroMemory(newEntry, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d0/pnpiop_8h.html#a131">IOP_RESOURCE_REQUEST</a>) * rebalanceCount);
05344     <span class="keywordflow">for</span> (i = 0, deviceTablex = deviceTable; i &lt; rebalanceCount; i++, deviceTablex++) {
05345         newEntry[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a> = <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>;
05346         newEntry[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> = *deviceTablex;
05347     }
05348 
05349     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a56">IopGetResourceRequirementsForAssignTable</a>(
05350                  newEntry,
05351                  tableEnd ,
05352                  &amp;deviceCount);
05353     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || deviceCount == 0) {
05354          <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"Rebalance: GetResourceRequirementsForAssignTable failed\n"</span>));
05355          status = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)? STATUS_UNSUCCESSFUL : status;
05356          <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
05357     }
05358 
05359     <span class="comment">//</span>
05360     <span class="comment">// Process the AssignTable to remove any entry which is marked as IOP_ASSIGN_IGNORE</span>
05361     <span class="comment">//</span>
05362 
05363     <span class="keywordflow">if</span> (deviceCount != rebalanceCount) {
05364 
05365         deviceCount += AssignTableCount;
05366         requestTable = (<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>) <a class="code" href="../../d5/d1/pnpres_8c.html#a11">ExAllocatePoolIORR</a>(
05367                              <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
05368                              <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d0/pnpiop_8h.html#a131">IOP_RESOURCE_REQUEST</a>) * deviceCount
05369                              );
05370         <span class="keywordflow">if</span> (requestTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05371             <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(newEntry, tableEnd);
05372             status = STATUS_INSUFFICIENT_RESOURCES;
05373             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
05374         }
05375         <span class="keywordflow">for</span> (entry1 = table, entry2 = requestTable; entry1 &lt; tableEnd; entry1++) {
05376             <span class="keywordflow">if</span> (!(entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>)) {
05377                 *entry2 = *entry1;
05378                 entry2++;
05379             } <span class="keywordflow">else</span> {
05380                 <span class="comment">//</span>
05381                 <span class="comment">// BUGBUG!!! ??? (jamiehun)</span>
05382                 <span class="comment">// if this assert fails, parts of this code are broken</span>
05383                 <span class="comment">//</span>
05384                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(entry1 &gt;= newEntry);
05385             }
05386         }
05387         requestTableEnd = requestTable + deviceCount;
05388     } <span class="keywordflow">else</span> {
05389         requestTable = table;
05390         requestTableEnd = tableEnd;
05391         deviceCount += AssignTableCount;
05392     }
05393 
05394     <span class="comment">//</span>
05395     <span class="comment">// DO NOT Sort the AssignTable</span>
05396     <span class="comment">//</span>
05397 
05398     <span class="comment">//IopRearrangeAssignTable(requestTable, deviceCount);</span>
05399 
05400 <span class="preprocessor">#if 0</span>
05401 <span class="preprocessor"></span>
05402     <span class="comment">//</span>
05403     <span class="comment">// We are about to perform rebalance.  Release the resources of the reconfiguration devices</span>
05404     <span class="comment">//</span>
05405 
05406     <span class="keywordflow">for</span> (entry1 = newEntry; entry1 &lt; tableEnd; entry1++) {
05407         <span class="keywordflow">if</span> (!(entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>) &amp;&amp;
05408             !(entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a71">IOP_ASSIGN_RESOURCES_RELEASED</a>)) {
05409             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
05410             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
05411 
05412                 <span class="comment">//</span>
05413                 <span class="comment">// Call IopReleaseResourcesInternal instead of IopReleaseResources such that</span>
05414                 <span class="comment">// the pool for devicenode-&gt;ResourceList is not freed.  We need it to restart</span>
05415                 <span class="comment">// the reconfigured devices in case rebalance failed.</span>
05416                 <span class="comment">//</span>
05417 
05418                 <a class="code" href="../../d5/d1/pnpres_8c.html#a87">IopReleaseResourcesInternal</a>(deviceNode);
05419                 entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a71">IOP_ASSIGN_RESOURCES_RELEASED</a>;
05420             }
05421         }
05422     }
05423 
05424 <span class="preprocessor">#endif</span>
05425 <span class="preprocessor"></span>
05426     <span class="comment">//</span>
05427     <span class="comment">// Assign the resources. If we succeed, or if</span>
05428     <span class="comment">// there is a memory shortage return immediately.</span>
05429     <span class="comment">//</span>
05430 
05431     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a67">IopAssignInner</a>(deviceCount, requestTable, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05432     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05433 
05434         <span class="comment">//</span>
05435         <span class="comment">// If the rebalance succeeded, we need to restart all the reconfigured devices.</span>
05436         <span class="comment">// For the original devices, we will return and let IopAllocateResources to deal</span>
05437         <span class="comment">// with them.</span>
05438         <span class="comment">//</span>
05439 
05440         <a class="code" href="../../d5/d1/pnpres_8c.html#a65">IopBuildCmResourceLists</a>(requestTable, requestTableEnd);
05441 
05442         <span class="comment">//</span>
05443         <span class="comment">// Copy the new status back to the original AssignTable.</span>
05444         <span class="comment">//</span>
05445 
05446         <span class="keywordflow">if</span> (AssignTableCount != 0) {
05447             RtlMoveMemory(AssignTable, requestTable, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d0/pnpiop_8h.html#a131">IOP_RESOURCE_REQUEST</a>) * AssignTableCount);
05448         }
05449         <span class="comment">//</span>
05450         <span class="comment">// free resource requirements we allocated while here</span>
05451         <span class="comment">//</span>
05452         <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(requestTable+AssignTableCount, requestTableEnd);
05453 
05454         <span class="keywordflow">if</span> (table != requestTable) {
05455 
05456             <span class="comment">//</span>
05457             <span class="comment">// If we switched request table ... copy the contents of new table back to</span>
05458             <span class="comment">// the old table.</span>
05459             <span class="comment">//</span>
05460 
05461             <span class="keywordflow">for</span> (entry1 = table, entry2 = requestTable; entry2 &lt; requestTableEnd;) {
05462 
05463                 <span class="keywordflow">if</span> (entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>) {
05464                     entry1++;
05465                     <span class="keywordflow">continue</span>;
05466                 }
05467                 *entry1 = *entry2;
05468                 <span class="keywordflow">if</span> (entry2-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>) {
05469                     entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_CONFLICTING_ADDRESSES;
05470                 }
05471                 entry2++;
05472                 entry1++;
05473             }
05474         }
05475 
05476         <span class="comment">//</span>
05477         <span class="comment">// Go thru the origianl request table to stop each query-stopped/reconfigured device.</span>
05478         <span class="comment">//</span>
05479 
05480         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"PnpRes: STOP reconfigured devices during REBALANCE.\n"</span>));
05481 
05482         <span class="keywordflow">for</span> (entry1 = newEntry; entry1 &lt; tableEnd; entry1++) {
05483             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a>)) {
05484                 <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (<a class="code" href="../../d0/d5/io_8h.html#a69">IRP_MN_STOP_DEVICE</a>, entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>);
05485             } <span class="keywordflow">else</span> {
05486                 <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (<a class="code" href="../../d0/d5/io_8h.html#a71">IRP_MN_CANCEL_STOP_DEVICE</a>, entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>);
05487                 deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
05488                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>;
05489             }
05490         }
05491 
05492         <span class="comment">//</span>
05493         <span class="comment">// Commit the allocation AFTER stopping rebalance candidates.</span>
05494         <span class="comment">//</span>
05495 
05496         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"PnpRes: Commit the new allocation during REBALANCE.\n"</span>));
05497 
05498         <a class="code" href="../../d5/d1/pnpres_8c.html#a68">IopPlacement</a>(<a class="code" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05499 
05500 <span class="preprocessor">#if DBG_SCOPE</span>
05501 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a26">STOP_ERROR</a>) {
05502             <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>);
05503         }
05504 <span class="preprocessor">#endif</span>
05505 <span class="preprocessor"></span>
05506         <span class="comment">//</span>
05507         <span class="comment">// Go thru the origianl request table to start each stopped/reconfigured device.</span>
05508         <span class="comment">//</span>
05509 
05510         <span class="keywordflow">for</span> (entry1 = tableEnd - 1; entry1 &gt;= newEntry; entry1--) {
05511             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
05512 
05513             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a>)) {
05514 
05515                 <span class="comment">//</span>
05516                 <span class="comment">// We need to release the pool space for ResourceList and ResourceListTranslated.</span>
05517                 <span class="comment">// Because the earlier IopReleaseResourcesInternal does not release the pool.</span>
05518                 <span class="comment">//</span>
05519 
05520                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
05521                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>);
05522                 }
05523                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>;
05524                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a>) {
05525                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a>);
05526                 }
05527                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a> = entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a>;
05528                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
05529                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>;
05530                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>;
05531                 } <span class="keywordflow">else</span> {
05532                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>;
05533                 }
05534                 <span class="keywordflow">if</span> (entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a73">IOP_ASSIGN_CLEAR_RESOURCE_REQUIREMENTS_CHANGE_FLAG</a>) {
05535 
05536                     <span class="comment">//</span>
05537                     <span class="comment">// If we are processing the resource requirements change request,</span>
05538                     <span class="comment">// clear its related flags.</span>
05539                     <span class="comment">//</span>
05540 
05541                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a21">DNF_NON_STOPPED_REBALANCE</a>);
05542                 }
05543 
05544                 <span class="comment">//</span>
05545                 <span class="comment">// Some drivers (like ndis) may want to do resource allocation during START.</span>
05546                 <span class="comment">// So let go of the IopRegistrySemaphore during the start.</span>
05547                 <span class="comment">//</span>
05548 
05549                 <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>, 0, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05550                 <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
05551                 <a class="code" href="../../d0/d1/pnpirp_8c.html#a19">IopStartDevice</a>(entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>);
05552                 <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
05553                 <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(  &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>,
05554                                         <a class="code" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>,
05555                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
05556                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
05557                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
05558             }
05559         }
05560 
05561         <span class="comment">//</span>
05562         <span class="comment">// Finally release the references of the reconfigured device objects</span>
05563         <span class="comment">//</span>
05564 
05565         <span class="keywordflow">for</span> (deviceTablex = (deviceTable + rebalanceCount - 1);
05566              deviceTablex &gt;= deviceTable;
05567              deviceTablex--) {
05568              <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*deviceTablex);
05569         }
05570         status = STATUS_SUCCESS;
05571     } <span class="keywordflow">else</span> {
05572 
05573         <span class="comment">//</span>
05574         <span class="comment">// Rebalance failed. Free our internal representation of the rebalance</span>
05575         <span class="comment">// candidates' resource requirements lists.</span>
05576         <span class="comment">// BugBug - should optimize the code.</span>
05577         <span class="comment">//</span>
05578 
05579         <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(requestTable + AssignTableCount, requestTableEnd);
05580         <span class="keywordflow">if</span> (rebalancePhase == 0) {
05581             rebalancePhase++;
05582             <span class="keywordflow">if</span> (requestTable) {
05583                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(requestTable);
05584             }
05585             <span class="keywordflow">if</span> (table &amp;&amp; (table != requestTable)) {
05586                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(table);
05587             }
05588             table = requestTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05589             <span class="keywordflow">goto</span> tryAgain;
05590         }
05591 
05592         <span class="comment">//</span>
05593         <span class="comment">// Rebalance failed.  Restore the resources for the reconfiguration participated devices.</span>
05594         <span class="comment">// Note, for some devices, their resource requirements may already changed.  In this</span>
05595         <span class="comment">// case, the resources we restore do not reflect the new requirements.</span>
05596         <span class="comment">//</span>
05597 
05598         <span class="keywordflow">for</span> (deviceTablex = (deviceTable + rebalanceCount - 1);
05599              deviceTablex &gt;= deviceTable;
05600              deviceTablex--) {
05601              deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)((*deviceTablex)-&gt;DeviceObjectExtension-&gt;DeviceNode);
05602 <span class="preprocessor">#if 0</span>
05603 <span class="preprocessor"></span>             statusx = <a class="code" href="../../d5/d1/pnpres_8c.html#a89">IopRestoreResourcesInternal</a>(deviceNode);
05604              <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(statusx)) {
05605                  <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (<a class="code" href="../../d0/d5/io_8h.html#a71">IRP_MN_CANCEL_STOP_DEVICE</a>, *deviceTablex);
05606                  deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>;
05607              } <span class="keywordflow">else</span> {
05608                  <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
05609                  <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(*deviceTablex);
05610              }
05611 <span class="preprocessor">#else</span>
05612 <span class="preprocessor"></span>             <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (<a class="code" href="../../d0/d5/io_8h.html#a71">IRP_MN_CANCEL_STOP_DEVICE</a>, *deviceTablex);
05613              deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>;
05614 <span class="preprocessor">#endif</span>
05615 <span class="preprocessor"></span>             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*deviceTablex);
05616         }
05617     }
05618     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceTable);
05619     deviceTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05620 
05621 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
05622 
05623     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; deviceTable) {
05624 
05625         <span class="comment">//</span>
05626         <span class="comment">// If we failed before trying to perform resource assignment,</span>
05627         <span class="comment">// we will end up here.</span>
05628         <span class="comment">//</span>
05629 
05630         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>, (<span class="stringliteral">"Rebalance: Rebalance failed\n"</span>));
05631 
05632         <span class="comment">//</span>
05633         <span class="comment">// Somehow we failed to start the rebalance operation.</span>
05634         <span class="comment">// We will cancel the query-stop request for the query-stopped devices bredth first.</span>
05635         <span class="comment">//</span>
05636 
05637         <span class="keywordflow">for</span> (deviceTablex = (deviceTable + rebalanceCount - 1);
05638              deviceTablex &gt;= deviceTable;
05639              deviceTablex--) {
05640 
05641              deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)((*deviceTablex)-&gt;DeviceObjectExtension-&gt;DeviceNode);
05642              <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (<a class="code" href="../../d0/d5/io_8h.html#a71">IRP_MN_CANCEL_STOP_DEVICE</a>, *deviceTablex);
05643              deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>;
05644              <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*deviceTablex);
05645         }
05646     }
05647     <span class="keywordflow">if</span> (deviceTable) {
05648         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceTable);
05649     }
05650     <span class="keywordflow">if</span> (requestTable) {
05651         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(requestTable);
05652     }
05653     <span class="keywordflow">if</span> (table &amp;&amp; (table != requestTable)) {
05654         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(table);
05655     }
05656     <span class="keywordflow">return</span> status;
05657 }
05658 
05659 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05660"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a89">05660</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a89">IopRestoreResourcesInternal</a> (
05661     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
05662     )
05663 
05664 <span class="comment">/*++</span>
05665 <span class="comment"></span>
05666 <span class="comment">Routine Description:</span>
05667 <span class="comment"></span>
05668 <span class="comment">    This routine reassigns the released resources for device specified by DeviceNode.</span>
05669 <span class="comment"></span>
05670 <span class="comment">Parameters:</span>
05671 <span class="comment"></span>
05672 <span class="comment">    DeviceNode - specifies the device node whose resources are goint to be released.</span>
05673 <span class="comment"></span>
05674 <span class="comment">Return Value:</span>
05675 <span class="comment"></span>
05676 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
05677 <span class="comment"></span>
05678 <span class="comment">--*/</span>
05679 
05680 {
05681     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> requestTable;
05682     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05683 
05684     <span class="keywordflow">if</span> (DeviceNode-&gt;ResourceList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05685         <span class="keywordflow">return</span> STATUS_SUCCESS;
05686     }
05687     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> =
05688         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, DeviceNode-&gt;ResourceList, LCPRI_FORCECONFIG);
05689     <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05690         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes: Not enough memory to clean up rebalance failure\n"</span>));
05691         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05692     }
05693     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a> = 0;
05694     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> = 0;
05695     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a> = <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>;
05696     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> = DeviceNode-&gt;PhysicalDeviceObject;
05697     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05698     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05699     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05700     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = 0;
05701 
05702     <span class="comment">//</span>
05703     <span class="comment">// rebuild internal representation of the resource requirements list</span>
05704     <span class="comment">//</span>
05705 
05706     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a57">IopResourceRequirementsListToReqList</a>(
05707                     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a>,
05708                     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>,
05709                     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>,
05710                     &amp;requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>);
05711 
05712     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05713         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PnpRes: Not enough memory to restore previous resources\n"</span>));
05714         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>);
05715         <span class="keywordflow">return</span> status;
05716     } <span class="keywordflow">else</span> {
05717         <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> reqList;
05718 
05719         reqList = (<a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a>)requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>;
05720         reqList-&gt;AssignEntry = &amp;requestTable;
05721 
05722         <span class="comment">//</span>
05723         <span class="comment">// Sort the ReqList such that the higher priority Alternative list are</span>
05724         <span class="comment">// placed in the front of the list.</span>
05725         <span class="comment">//</span>
05726 
05727         <a class="code" href="../../d5/d1/pnpres_8c.html#a58">IopRearrangeReqList</a>(reqList);
05728         <span class="keywordflow">if</span> (reqList-&gt;ReqBestAlternative == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05729 
05730             <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(&amp;requestTable, (&amp;requestTable) + 1);
05731             <span class="keywordflow">return</span> STATUS_DEVICE_CONFIGURATION_ERROR;
05732 
05733         }
05734     }
05735 
05736     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a67">IopAssignInner</a>(1, &amp;requestTable, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05737     <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(&amp;requestTable, (&amp;requestTable) + 1);
05738     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05739         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopRestoreResourcesInternal: BOOT conflict for %ws\n"</span>, DeviceNode-&gt;InstancePath.Buffer);
05740         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
05741     }
05742     <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>) {
05743         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>);
05744     }
05745     <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a>) {
05746         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a>);
05747     }
05748     <a class="code" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry</a> (
05749         DeviceNode,
05750         DeviceNode-&gt;ResourceList,
05751         <a class="code" href="../../d9/d0/pnpiop_8h.html#a254">IopDetermineResourceListSize</a>(DeviceNode-&gt;ResourceList)
05752         );
05753     <span class="keywordflow">return</span> status;
05754 }
05755 
05756 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05757"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a87">05757</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a87">IopReleaseResourcesInternal</a> (
05758     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
05759     )
05760 
05761 <span class="comment">/*++</span>
05762 <span class="comment"></span>
05763 <span class="comment">Routine Description:</span>
05764 <span class="comment"></span>
05765 <span class="comment">    This routine releases the assigned resources for device specified by DeviceNode.</span>
05766 <span class="comment">    Note, this routine does not reset the resource related fields in DeviceNode structure.</span>
05767 <span class="comment"></span>
05768 <span class="comment">Parameters:</span>
05769 <span class="comment"></span>
05770 <span class="comment">    DeviceNode - specifies the device node whose resources are goint to be released.</span>
05771 <span class="comment"></span>
05772 <span class="comment">Return Value:</span>
05773 <span class="comment"></span>
05774 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
05775 <span class="comment"></span>
05776 <span class="comment">--*/</span>
05777 
05778 {
05779     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> device;
05780     PLIST_ENTRY listHead, listEntry;
05781     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
05782     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">ARBITER_LIST_ENTRY</a> arbiterListEntry;
05783     INTERFACE_TYPE interfaceType;
05784     ULONG busNumber, listCount, i, j, size;
05785     PCM_RESOURCE_LIST resourceList;
05786     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
05787     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmPartDesc;
05788     BOOLEAN search = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05789 <span class="preprocessor">#if DBG</span>
05790 <span class="preprocessor"></span>    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05791 <span class="preprocessor">#endif</span>
05792 <span class="preprocessor"></span>
05793     InitializeListHead(&amp;arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>);
05794     arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a> = 0;
05795     arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o2">Alternatives</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05796     arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a> = DeviceNode-&gt;PhysicalDeviceObject;
05797     arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o5">Flags</a> = 0;
05798     arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o6">WorkSpace</a> = 0;
05799     arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o10">Assignment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05800     arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o4">RequestSource</a> = <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>;
05801 
05802     resourceList = DeviceNode-&gt;ResourceList;
05803     <span class="keywordflow">if</span> (resourceList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05804         resourceList = DeviceNode-&gt;BootResources;
05805     }
05806     <span class="keywordflow">if</span> (resourceList &amp;&amp; resourceList-&gt;Count &gt; 0) {
05807         listCount = resourceList-&gt;Count;
05808         cmFullDesc = &amp;resourceList-&gt;List[0];
05809     } <span class="keywordflow">else</span> {
05810         listCount = 1;
05811         resourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05812     }
05813     <span class="keywordflow">for</span> (i = 0; i &lt; listCount; i++) {
05814 
05815         <span class="keywordflow">if</span> (resourceList) {
05816             interfaceType = cmFullDesc-&gt;InterfaceType;
05817             busNumber = cmFullDesc-&gt;BusNumber;
05818             <span class="keywordflow">if</span> (interfaceType == InterfaceTypeUndefined) {
05819                 interfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
05820             }
05821         } <span class="keywordflow">else</span> {
05822             interfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
05823             busNumber = 0;
05824         }
05825 
05826         device = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
05827         <span class="keywordflow">while</span> (device) {
05828             <span class="keywordflow">if</span> ((device == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) &amp;&amp; search) {
05829                 device = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a> (
05830                                  <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>,
05831                                  interfaceType,
05832                                  busNumber,
05833                                  0
05834                                  );
05835 
05836                 <span class="comment">//</span>
05837                 <span class="comment">// If we did not find a PDO, try again with InterfaceType == Isa. This allows</span>
05838                 <span class="comment">// drivers that request Internal to get resources even if there is no PDO</span>
05839                 <span class="comment">// that is Internal. (but if there is an Internal PDO, they get that one)</span>
05840                 <span class="comment">//</span>
05841 
05842                 <span class="keywordflow">if</span> ((device == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) &amp;&amp; (interfaceType == Internal)) {
05843                     device = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>, Isa, 0, 0);
05844                 }
05845                 search = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05846 
05847             }
05848             listHead = &amp;device-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o24">DeviceArbiterList</a>;
05849             listEntry = listHead-&gt;Flink;
05850             <span class="keywordflow">while</span> (listEntry != listHead) {
05851                 arbiterEntry = CONTAINING_RECORD(listEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, DeviceArbiterList);
05852                 <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o2">ArbiterInterface</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05853                     search = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05854                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>));
05855                     InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>);  <span class="comment">// Recover from assert</span>
05856                     InsertTailList(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>, &amp;arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>);
05857 <span class="preprocessor">    #if DBG</span>
05858 <span class="preprocessor"></span>                    status =
05859 <span class="preprocessor">    #endif</span>
05860 <span class="preprocessor"></span>                    <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry,
05861                                    <a class="code" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>,
05862                                    &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>,
05863                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05864                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
05865                                    );
05866 <span class="preprocessor">    #if DBG</span>
05867 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
05868                     status =
05869 <span class="preprocessor">    #endif</span>
05870 <span class="preprocessor"></span>                    <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry,
05871                                    <a class="code" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>,
05872                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05873                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05874                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
05875                                    );
05876 <span class="preprocessor">    #if DBG</span>
05877 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
05878 <span class="preprocessor">    #endif</span>
05879 <span class="preprocessor"></span>                    RemoveEntryList(&amp;arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>);
05880                     InitializeListHead(&amp;arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>);
05881                 }
05882                 listEntry = listEntry-&gt;Flink;
05883             }
05884             device = device-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
05885         }
05886 
05887         <span class="comment">//</span>
05888         <span class="comment">// If there are more than 1 list, move to next list</span>
05889         <span class="comment">//</span>
05890 
05891         <span class="keywordflow">if</span> (listCount &gt; 1) {
05892             cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
05893             <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
05894                 size = 0;
05895                 <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
05896                 <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
05897                      size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
05898                      <span class="keywordflow">break</span>;
05899                 }
05900                 cmPartDesc++;
05901                 cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
05902             }
05903             cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
05904         }
05905     }
05906 
05907     <a class="code" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry</a> (DeviceNode, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
05908 }
05909 
05910 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05911"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a54">05911</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a54">IopFindLegacyDeviceNode</a> (
05912     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
05913     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL,
05914     OUT <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> *LegacyDeviceNode,
05915     OUT <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *LegacyPDO
05916     )
05917 
05918 <span class="comment">/*++</span>
05919 <span class="comment"></span>
05920 <span class="comment">Routine Description:</span>
05921 <span class="comment"></span>
05922 <span class="comment">    This routine searches for the device node and device object created for legacy resource</span>
05923 <span class="comment">    allocation for the DriverObject and DeviceObject.</span>
05924 <span class="comment"></span>
05925 <span class="comment">Parameters:</span>
05926 <span class="comment"></span>
05927 <span class="comment">    DriverObject - specifies the driver object doing the legacy allocation.</span>
05928 <span class="comment"></span>
05929 <span class="comment">    DeviceObject - specifies the device object.</span>
05930 <span class="comment"></span>
05931 <span class="comment">    LegacyDeviceNode - receives the pointer to the legacy device node if found.</span>
05932 <span class="comment"></span>
05933 <span class="comment">    LegacyDeviceObject - receives the pointer to the legacy device object if found.</span>
05934 <span class="comment"></span>
05935 <span class="comment"></span>
05936 <span class="comment">Return Value:</span>
05937 <span class="comment"></span>
05938 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
05939 <span class="comment"></span>
05940 <span class="comment">--*/</span>
05941 
05942 {
05943     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status = STATUS_UNSUCCESSFUL;
05944     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode;
05945 
05946     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LegacyDeviceNode &amp;&amp; LegacyPDO);
05947 
05948 
05949     <span class="comment">//</span>
05950     <span class="comment">// Use the device object if it exists.</span>
05951     <span class="comment">//</span>
05952 
05953     <span class="keywordflow">if</span> (DeviceObject) {
05954 
05955         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
05956         <span class="keywordflow">if</span> (deviceNode) {
05957 
05958             *LegacyPDO = DeviceObject;
05959             *LegacyDeviceNode = deviceNode;
05960             status = STATUS_SUCCESS;
05961 
05962         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(DeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>)) {
05963 
05964             deviceNode = <a class="code" href="../../d9/d0/pnpiop_8h.html#a252">IopAllocateDeviceNode</a>(DeviceObject);
05965             <span class="keywordflow">if</span> (deviceNode) {
05966 
05967                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a34">DNF_LEGACY_RESOURCE_DEVICENODE</a>;
05968                 <a class="code" href="../../d5/d1/pnpres_8c.html#a90">IopSetLegacyDeviceInstance</a> (DriverObject, deviceNode);
05969                 *LegacyPDO = DeviceObject;
05970                 *LegacyDeviceNode = deviceNode;
05971                 status = STATUS_SUCCESS;
05972 
05973             } <span class="keywordflow">else</span> {
05974 
05975                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PNPRES: Failed to allocate device node for PDO %08X\n"</span>, DeviceObject));
05976                 status = STATUS_INSUFFICIENT_RESOURCES;
05977 
05978             }
05979 
05980         } <span class="keywordflow">else</span> {
05981 
05982             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PNPRES: %08X PDO without a device node!\n"</span>, DeviceObject));
05983             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode);
05984 
05985         }
05986 
05987     } <span class="keywordflow">else</span> {
05988 
05989         <span class="comment">//</span>
05990         <span class="comment">// Search our list of legacy device nodes.</span>
05991         <span class="comment">//</span>
05992 
05993         <span class="keywordflow">for</span> (   deviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a>;
05994                 deviceNode &amp;&amp; deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o15">DuplicatePDO</a> != (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)DriverObject;
05995                 deviceNode = deviceNode-&gt;NextDeviceNode);
05996 
05997         <span class="keywordflow">if</span> (deviceNode) {
05998 
05999             *LegacyPDO = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
06000             *LegacyDeviceNode = deviceNode;
06001             status = STATUS_SUCCESS;
06002 
06003         } <span class="keywordflow">else</span> {
06004 
06005             WCHAR           buffer[60];
06006             UNICODE_STRING  deviceName;
06007             LARGE_INTEGER   tickCount;
06008             ULONG           length;
06009             <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  pdo;
06010 
06011             <span class="comment">//</span>
06012             <span class="comment">// We are seeing this for the first time.</span>
06013             <span class="comment">// Create a madeup device node.</span>
06014             <span class="comment">//</span>
06015 
06016             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a4">KeQueryTickCount</a>(&amp;tickCount);
06017             length = _snwprintf(buffer, <span class="keyword">sizeof</span>(buffer) / <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Device\\Resource%04u%x"</span>, <a class="code" href="../../d1/d0/pnpdata_8c.html#a12">IopNumberDeviceNodes</a>, tickCount.LowPart);
06018             deviceName.MaximumLength = <span class="keyword">sizeof</span>(buffer);
06019             deviceName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(length * <span class="keyword">sizeof</span>(WCHAR));
06020             deviceName.Buffer = buffer;
06021 
06022             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>, (<span class="stringliteral">"PNPRES: Creating dummy PDO %ws\n"</span>, deviceName.Buffer));
06023 
06024             status = <a class="code" href="../../d4/d6/iosubs_8c.html#a45">IoCreateDevice</a>( <a class="code" href="../../d6/d9/pnp_8h.html#a14">IoPnpDriverObject</a>,
06025                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">IOPNP_DEVICE_EXTENSION</a>),
06026                                      &amp;deviceName,
06027                                      FILE_DEVICE_CONTROLLER,
06028                                      0,
06029                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
06030                                      &amp;pdo);
06031 
06032             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06033 
06034                 pdo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>;
06035                 deviceNode = <a class="code" href="../../d9/d0/pnpiop_8h.html#a252">IopAllocateDeviceNode</a>(pdo);
06036                 <span class="keywordflow">if</span> (deviceNode) {
06037 
06038                     <span class="comment">//</span>
06039                     <span class="comment">// Change driver object to the caller even though the owner</span>
06040                     <span class="comment">// of the pdo is IoPnpDriverObject.  This is to support</span>
06041                     <span class="comment">// DriverExclusive for legacy interface.</span>
06042                     <span class="comment">//</span>
06043 
06044                     pdo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a> = DriverObject;
06045                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a34">DNF_LEGACY_RESOURCE_DEVICENODE</a>;
06046                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o15">DuplicatePDO</a> = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)DriverObject;
06047                     <a class="code" href="../../d5/d1/pnpres_8c.html#a90">IopSetLegacyDeviceInstance</a> (DriverObject, deviceNode);
06048 
06049                     <span class="comment">//</span>
06050                     <span class="comment">// Add it to our list of legacy device nodes rather than adding it to the HW tree.</span>
06051                     <span class="comment">//</span>
06052 
06053                     deviceNode-&gt;NextDeviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a>;
06054                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a>) {
06055 
06056                         <a class="code" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a>-&gt;PreviousDeviceNode = deviceNode;
06057 
06058                     }
06059                     <a class="code" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a> = deviceNode;
06060                     *LegacyPDO = pdo;
06061                     *LegacyDeviceNode = deviceNode;
06062 
06063                 } <span class="keywordflow">else</span> {
06064 
06065                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PNPRES: Failed to allocate device node for PDO %08X\n"</span>, pdo));
06066                     <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(pdo);
06067                     status = STATUS_INSUFFICIENT_RESOURCES;
06068 
06069                 }
06070 
06071             } <span class="keywordflow">else</span> {
06072 
06073                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PNPRES: IoCreateDevice failed for %ws with status %08X\n"</span>, deviceName.Buffer, status));
06074 
06075             }
06076         }
06077     }
06078 
06079     <span class="keywordflow">return</span> status;
06080 }
06081 
06082 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l06083"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a53">06083</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a53">IopRemoveLegacyDeviceNode</a> (
06084     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>   DeviceObject OPTIONAL,
06085     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>     LegacyDeviceNode
06086     )
06087 
06088 <span class="comment">/*++</span>
06089 <span class="comment"></span>
06090 <span class="comment">Routine Description:</span>
06091 <span class="comment"></span>
06092 <span class="comment">    This routine removes the device node and device object created for legacy resource</span>
06093 <span class="comment">    allocation for the DeviceObject.</span>
06094 <span class="comment"></span>
06095 <span class="comment">Parameters:</span>
06096 <span class="comment"></span>
06097 <span class="comment">    DeviceObject - specifies the device object.</span>
06098 <span class="comment"></span>
06099 <span class="comment">    LegacyDeviceNode - receives the pointer to the legacy device node if found.</span>
06100 <span class="comment"></span>
06101 <span class="comment">Return Value:</span>
06102 <span class="comment"></span>
06103 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
06104 <span class="comment"></span>
06105 <span class="comment">--*/</span>
06106 
06107 {
06108     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LegacyDeviceNode);
06109 
06110 
06111     <span class="keywordflow">if</span> (!DeviceObject) {
06112 
06113         <span class="keywordflow">if</span> (LegacyDeviceNode-&gt;DuplicatePDO) {
06114 
06115             LegacyDeviceNode-&gt;DuplicatePDO = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06116             <span class="keywordflow">if</span> (LegacyDeviceNode-&gt;PreviousDeviceNode) {
06117 
06118                 LegacyDeviceNode-&gt;PreviousDeviceNode-&gt;NextDeviceNode = LegacyDeviceNode-&gt;NextDeviceNode;
06119 
06120             }
06121 
06122             <span class="keywordflow">if</span> (LegacyDeviceNode-&gt;NextDeviceNode) {
06123 
06124                 LegacyDeviceNode-&gt;NextDeviceNode-&gt;PreviousDeviceNode = LegacyDeviceNode-&gt;PreviousDeviceNode;
06125 
06126             }
06127 
06128             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a> == LegacyDeviceNode) {
06129 
06130                 <a class="code" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a> = LegacyDeviceNode-&gt;NextDeviceNode;
06131 
06132             }
06133 
06134         } <span class="keywordflow">else</span> {
06135 
06136             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PNPRES: %ws does not have a duplicate PDO\n"</span>, LegacyDeviceNode-&gt;InstancePath.Buffer));
06137             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LegacyDeviceNode-&gt;DuplicatePDO);
06138             <span class="keywordflow">return</span>;
06139 
06140         }
06141     }
06142 
06143     <span class="keywordflow">if</span> (!(DeviceObject &amp;&amp; (DeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>))) {
06144 
06145         <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    resourceDeviceNode;
06146         <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  pdo;
06147 
06148         <span class="keywordflow">for</span> (   resourceDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)LegacyDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.LegacyDeviceNode;
06149                 resourceDeviceNode;
06150                 resourceDeviceNode = resourceDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode) {
06151 
06152                 <span class="keywordflow">if</span> (resourceDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode == LegacyDeviceNode) {
06153 
06154                     resourceDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode = LegacyDeviceNode-&gt;OverUsed2.NextResourceDeviceNode;
06155                     <span class="keywordflow">break</span>;
06156 
06157                 }
06158         }
06159 
06160         LegacyDeviceNode-&gt;Parent = LegacyDeviceNode-&gt;Sibling =
06161             LegacyDeviceNode-&gt;Child = LegacyDeviceNode-&gt;LastChild = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06162 
06163         <span class="comment">//</span>
06164         <span class="comment">// Delete the dummy PDO and device node.</span>
06165         <span class="comment">//</span>
06166 
06167         pdo = LegacyDeviceNode-&gt;PhysicalDeviceObject;
06168         <a class="code" href="../../d9/d0/pnpiop_8h.html#a284">IopDestroyDeviceNode</a>(LegacyDeviceNode);
06169 
06170         <span class="keywordflow">if</span> (!DeviceObject) {
06171 
06172             pdo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a> = <a class="code" href="../../d6/d9/pnp_8h.html#a14">IoPnpDriverObject</a>;
06173             <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(pdo);
06174         }
06175     }
06176 }
06177 
06178 
06179 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l06180"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a107">06180</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a107">IopLegacyResourceAllocation</a> (
06181     IN ARBITER_REQUEST_SOURCE AllocationType,
06182     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
06183     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL,
06184     IN PIO_RESOURCE_REQUIREMENTS_LIST ResourceRequirements,
06185     IN OUT PCM_RESOURCE_LIST *AllocatedResources OPTIONAL
06186     )
06187 
06188 <span class="comment">/*++</span>
06189 <span class="comment"></span>
06190 <span class="comment">Routine Description:</span>
06191 <span class="comment"></span>
06192 <span class="comment">    This routine handles legacy interface IoAssignResources and IoReportResourcesUsage,</span>
06193 <span class="comment">    It converts the request to call IopAllocateResources.</span>
06194 <span class="comment"></span>
06195 <span class="comment">Parameters:</span>
06196 <span class="comment"></span>
06197 <span class="comment">    AllocationType - Allocation type for the legacy request.</span>
06198 <span class="comment"></span>
06199 <span class="comment">    DriverObject - Driver object doing the legacy allocation.</span>
06200 <span class="comment"></span>
06201 <span class="comment">    DeviceObject - Device object.</span>
06202 <span class="comment"></span>
06203 <span class="comment">    ResourceRequirements - Legacy resource requirements. If NULL, caller want to free resources.</span>
06204 <span class="comment"></span>
06205 <span class="comment">    AllocatedResources - Pointer to a variable that receives pointer to allocated resources.</span>
06206 <span class="comment"></span>
06207 <span class="comment">Return Value:</span>
06208 <span class="comment"></span>
06209 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
06210 <span class="comment"></span>
06211 <span class="comment">--*/</span>
06212 
06213 {
06214     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>      pdo;
06215     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>        deviceNode;
06216     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>        legacyDeviceNode;
06217     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
06218     PCM_RESOURCE_LIST   combinedResources;
06219     KIRQL               irql;
06220 
06221     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DriverObject);
06222 
06223     <span class="comment">//</span>
06224     <span class="comment">// Grab the IO registry semaphore to make sure no other device is</span>
06225     <span class="comment">// reporting it's resource usage while we are searching for conflicts.</span>
06226     <span class="comment">//</span>
06227 
06228     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
06229 
06230     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>,
06231                                     <a class="code" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>,
06232                                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
06233                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
06234                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06235     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06236 
06237         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a54">IopFindLegacyDeviceNode</a>(DriverObject, DeviceObject, &amp;deviceNode, &amp;pdo);
06238         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06239 
06240             legacyDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06241             <span class="keywordflow">if</span> (!deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a> &amp;&amp; ResourceRequirements) {
06242 
06243                 <span class="comment">//</span>
06244                 <span class="comment">// Make IopRootDeviceNode the bus pdo so we will search the right bus pdo</span>
06245                 <span class="comment">// on resource descriptor level.</span>
06246                 <span class="comment">//</span>
06247 
06248                 <span class="keywordflow">if</span> (ResourceRequirements-&gt;InterfaceType == InterfaceTypeUndefined) {
06249 
06250                     ResourceRequirements-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
06251 
06252                 }
06253                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a> = <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>;
06254 
06255             }
06256 
06257             <span class="comment">//</span>
06258             <span class="comment">// Release resources for this device node.</span>
06259             <span class="comment">//</span>
06260 
06261             <span class="keywordflow">if</span> (    (!ResourceRequirements &amp;&amp; deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>) ||
06262                     (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>))) {
06263 
06264                 <a class="code" href="../../d5/d1/pnpres_8c.html#a88">IopReleaseResources</a>(deviceNode);
06265 
06266             }
06267 
06268             <span class="keywordflow">if</span> (ResourceRequirements) {
06269 
06270                 <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>    requestTable;
06271                 <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>    *requestTablep;
06272                 ULONG                   count;
06273 
06274                 <span class="comment">//</span>
06275                 <span class="comment">// Try to allocate these resource requirements.</span>
06276                 <span class="comment">//</span>
06277 
06278                 count = 1;
06279                 RtlZeroMemory(&amp;requestTable, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>));
06280                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> = ResourceRequirements;
06281                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> = pdo;
06282                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a70">IOP_ASSIGN_NO_REBALANCE</a>;
06283                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a> =  AllocationType;
06284 
06285                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>;
06286                 requestTablep = &amp;requestTable;
06287                 <a class="code" href="../../d5/d1/pnpres_8c.html#a105">IopAllocateResources</a>(&amp;count, &amp;requestTablep, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
06288                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>;
06289                 status = requestTable.Status;
06290                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06291 
06292                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>;
06293                     <span class="comment">//deviceNode-&gt;Flags &amp;= ~DNF_INSUFFICIENT_RESOURCES;</span>
06294                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a> = requestTable.TranslatedResourceAssignment;
06295                     count = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>((*AllocatedResources) ? *AllocatedResources : requestTable.ResourceAssignment);
06296                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a12">ExAllocatePoolIORL</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, count);
06297                     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
06298 
06299                         <span class="keywordflow">if</span> (*AllocatedResources) {
06300 
06301                             <span class="comment">//</span>
06302                             <span class="comment">// We got called from IoReportResourceUsage.</span>
06303                             <span class="comment">//</span>
06304 
06305                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(requestTable.ResourceAssignment);
06306                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(requestTable.ResourceAssignment);
06307 
06308                         } <span class="keywordflow">else</span> {
06309 
06310                             <span class="comment">//</span>
06311                             <span class="comment">// We got called from IoAssignResources.</span>
06312                             <span class="comment">//</span>
06313 
06314                             *AllocatedResources = requestTable.ResourceAssignment;
06315 
06316                         }
06317                         RtlCopyMemory(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>, *AllocatedResources, count);
06318                         legacyDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.LegacyDeviceNode;
06319 
06320                     } <span class="keywordflow">else</span> {
06321 
06322                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = requestTable.ResourceAssignment;
06323                         <a class="code" href="../../d5/d1/pnpres_8c.html#a88">IopReleaseResources</a>(deviceNode);
06324                         status = STATUS_INSUFFICIENT_RESOURCES;
06325 
06326                     }
06327                 }
06328 
06329                 <span class="comment">//</span>
06330                 <span class="comment">// Remove the madeup PDO and device node if there was some error.</span>
06331                 <span class="comment">//</span>
06332 
06333                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06334 
06335                     <a class="code" href="../../d5/d1/pnpres_8c.html#a53">IopRemoveLegacyDeviceNode</a>(DeviceObject, deviceNode);
06336 
06337                 }
06338 
06339             } <span class="keywordflow">else</span> {
06340 
06341                 <span class="comment">//</span>
06342                 <span class="comment">// Caller wants to release resources.</span>
06343                 <span class="comment">//</span>
06344 
06345                 legacyDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.LegacyDeviceNode;
06346                 <a class="code" href="../../d5/d1/pnpres_8c.html#a53">IopRemoveLegacyDeviceNode</a>(DeviceObject, deviceNode);
06347 
06348             }
06349 
06350             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06351 
06352                 <span class="keywordflow">if</span> (legacyDeviceNode) {
06353 
06354                     <span class="comment">//</span>
06355                     <span class="comment">// After the resource is modified, update the allocated resource list</span>
06356                     <span class="comment">// for the Root\Legacy_xxxx\0000 device instance.</span>
06357                     <span class="comment">//</span>
06358 
06359                     combinedResources = <a class="code" href="../../d5/d1/pnpres_8c.html#a91">IopCombineLegacyResources</a>(legacyDeviceNode);
06360                     <span class="keywordflow">if</span> (combinedResources) {
06361 
06362                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry</a>(   legacyDeviceNode,
06363                                                                 combinedResources,
06364                                                                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(combinedResources));
06365                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(combinedResources);
06366                     }
06367                 }
06368 
06369                 <span class="comment">//</span>
06370                 <span class="comment">// BUGBUG: Santoshj 10/01/99</span>
06371                 <span class="comment">// Since IoReportDetectedDevice always uses IoPnpDriverObject instead of the one</span>
06372                 <span class="comment">// passed in, we put in this hack so that we dont taint ourselves. Other bugs need</span>
06373                 <span class="comment">// to be fixed before removing this hack (dont do resource allocation if this</span>
06374                 <span class="comment">// was already reported).</span>
06375                 <span class="comment">//</span>
06376 
06377                 <span class="keywordflow">if</span> (AllocationType != <a class="code" href="../../d6/d9/pnp_8h.html#a174a129">ArbiterRequestPnpDetected</a> &amp;&amp; DriverObject != <a class="code" href="../../d6/d9/pnp_8h.html#a14">IoPnpDriverObject</a>) {
06378                     <span class="comment">//</span>
06379                     <span class="comment">// Modify the DRVOBJ flags.</span>
06380                     <span class="comment">//</span>
06381                     ExAcquireFastLock(&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a3">IopDatabaseLock</a>, &amp;irql);
06382                     <span class="keywordflow">if</span> (ResourceRequirements) {
06383                         <span class="comment">//</span>
06384                         <span class="comment">// Once tainted, a driver can never lose it's legacy history</span>
06385                         <span class="comment">// (unless unloaded). This is because the device object</span>
06386                         <span class="comment">// field is optional, and we don't bother counting here...</span>
06387                         <span class="comment">//</span>
06388                         DriverObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a149">DRVO_LEGACY_RESOURCES</a>;
06389                     }
06390                     ExReleaseFastLock(&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a3">IopDatabaseLock</a>, irql);
06391                 }
06392             }
06393         }
06394 
06395         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>, 0, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06396 
06397     } <span class="keywordflow">else</span> {
06398 
06399         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PNPRES: IopLegacyResourceAllocation: Failed to acquire registry semaphore, status %08X\n"</span>, status));
06400     }
06401 
06402     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
06403 
06404     <span class="keywordflow">return</span> status;
06405 }
06406 
06407 <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>
<a name="l06408"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a108">06408</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a> (
06409     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
06410     IN INTERFACE_TYPE InterfaceType,
06411     IN ULONG BusNumber,
06412     IN ULONG SlotNumber
06413     )
06414 
06415 <span class="comment">/*++</span>
06416 <span class="comment"></span>
06417 <span class="comment">Routine Description:</span>
06418 <span class="comment"></span>
06419 <span class="comment">    This routine finds the bus PDO which performs translation and arbitration for the</span>
06420 <span class="comment">    specified InterfaceType, BusNumber and SlotNumber.</span>
06421 <span class="comment"></span>
06422 <span class="comment">Parameters:</span>
06423 <span class="comment"></span>
06424 <span class="comment">    DeviceNode - the root of the PDO to start our search</span>
06425 <span class="comment"></span>
06426 <span class="comment">    InterfaceType - Specifies the PDO's interface type.</span>
06427 <span class="comment"></span>
06428 <span class="comment">    BusNumber - specifies the PDO's bus number.</span>
06429 <span class="comment"></span>
06430 <span class="comment">    SlotNumber - specified the PDO's slot number (UNUSED).</span>
06431 <span class="comment"></span>
06432 <span class="comment">Return Value:</span>
06433 <span class="comment"></span>
06434 <span class="comment">    A pointer to the BUS PDO.</span>
06435 <span class="comment"></span>
06436 <span class="comment">--*/</span>
06437 
06438 {
06439     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> busDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06440 
06441     UNREFERENCED_PARAMETER(SlotNumber);
06442 
06443     <span class="keywordflow">if</span> (DeviceNode &amp;&amp; <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> != InterfaceTypeUndefined) {
06444 
06445         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> == PNPBus) {
06446             <span class="comment">//</span>
06447             <span class="comment">// if we specified PnpBus as InterfaceType, we know nobody specifies such a bus</span>
06448             <span class="comment">// don't waste time looking for BusNumber because it doesn't exist</span>
06449             <span class="comment">//</span>
06450             busDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06451         } <span class="keywordflow">else</span> {
06452             <span class="comment">//</span>
06453             <span class="comment">// search for bus (recursive)</span>
06454             <span class="comment">//</span>
06455             busDeviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a55">IopFindBusDeviceNodeInternal</a>(DeviceNode, (<a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> == Eisa) ? Isa : <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>, <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>);
06456         }
06457 
06458         <span class="keywordflow">if</span> (busDeviceNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; DeviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
06459 
06460             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"IopFindBusDeviceNode: Found %ws with interface=%08X &amp; bus=%08X\n"</span>, DeviceNode-&gt;InstancePath.Buffer, <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>, <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>));
06461             <span class="keywordflow">return</span> DeviceNode;
06462         }
06463 
06464         <span class="keywordflow">if</span> (busDeviceNode) {
06465 
06466             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"IopFindBusDeviceNode: Found %ws with interface=%08X &amp; bus=%08X\n"</span>, busDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer, <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>, <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>));
06467         }
06468     }
06469 
06470     <span class="keywordflow">return</span> busDeviceNode;
06471 }
06472 
06473 <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>
<a name="l06474"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a55">06474</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a55">IopFindBusDeviceNodeInternal</a> (
06475     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
06476     IN INTERFACE_TYPE InterfaceType,
06477     IN ULONG BusNumber
06478     )
06479 
06480 <span class="comment">/*++</span>
06481 <span class="comment"></span>
06482 <span class="comment">Routine Description:</span>
06483 <span class="comment"></span>
06484 <span class="comment">    This worker routine finds the bus PDO which performs translation and arbitration for the</span>
06485 <span class="comment">    specified InterfaceType and BusNumber.</span>
06486 <span class="comment"></span>
06487 <span class="comment">Parameters:</span>
06488 <span class="comment"></span>
06489 <span class="comment">    DeviceNode - the root of the PDO to start our search</span>
06490 <span class="comment"></span>
06491 <span class="comment">    InterfaceType - Specifies the PDO's interface type.</span>
06492 <span class="comment"></span>
06493 <span class="comment">    BusNumber - specifies the PDO's bus number.</span>
06494 <span class="comment"></span>
06495 <span class="comment">Return Value:</span>
06496 <span class="comment"></span>
06497 <span class="comment">    A pointer to the BUS PDO.</span>
06498 <span class="comment"></span>
06499 <span class="comment">--*/</span>
06500 
06501 {
06502     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> current;
06503 
06504     <span class="keywordflow">for</span> (current = DeviceNode; current; current = current-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>) {
06505 
06506         <span class="keywordflow">if</span> (    <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> == current-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o18">BusNumber</a> &amp;&amp;
06507                 (<a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> == current-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o17">InterfaceType</a> ||
06508                     (<a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> == Isa &amp;&amp; current-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o17">InterfaceType</a> == Eisa))) {
06509 
06510             <span class="keywordflow">return</span> current;
06511         }
06512 
06513         <span class="keywordflow">if</span> (current-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>) {
06514 
06515             <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> busDeviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a55">IopFindBusDeviceNodeInternal</a>(current-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>, <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>, <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>);
06516 
06517             <span class="keywordflow">if</span> (busDeviceNode) {
06518 
06519                 <span class="keywordflow">return</span> busDeviceNode;
06520             }
06521         }
06522     }
06523 
06524     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06525 }
06526 
06527 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l06528"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a109">06528</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a109">IopDuplicateDetection</a> (
06529     IN INTERFACE_TYPE LegacyBusType,
06530     IN ULONG BusNumber,
06531     IN ULONG SlotNumber,
06532     OUT <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> *DeviceNode
06533     )
06534 
06535 <span class="comment">/*++</span>
06536 <span class="comment"></span>
06537 <span class="comment">Routine Description:</span>
06538 <span class="comment"></span>
06539 <span class="comment">    This routine searches for the bus device driver for a given legacy device,</span>
06540 <span class="comment">    sends a query interface IRP for legacy device detection, and if the driver</span>
06541 <span class="comment">    implements this interface, requests the PDO for the given legacy device.</span>
06542 <span class="comment"></span>
06543 <span class="comment">Parameters:</span>
06544 <span class="comment"></span>
06545 <span class="comment">    LegacyBusType - The legacy device's interface type.</span>
06546 <span class="comment"></span>
06547 <span class="comment">    BusNumber - The legacy device's bus number.</span>
06548 <span class="comment"></span>
06549 <span class="comment">    SlotNumber - The legacy device's slot number.</span>
06550 <span class="comment"></span>
06551 <span class="comment">    DeviceNode - specifies a pointer to a variable to receive the duplicated device node</span>
06552 <span class="comment"></span>
06553 <span class="comment">Return Value:</span>
06554 <span class="comment"></span>
06555 <span class="comment">    NTSTATUS code.</span>
06556 <span class="comment"></span>
06557 <span class="comment">--*/</span>
06558 
06559 {
06560     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
06561     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> busDeviceObject;
06562     <a class="code" href="../../d0/d0/struct__LEGACY__DEVICE__DETECTION__INTERFACE.html">PLEGACY_DEVICE_DETECTION_INTERFACE</a> interface;
06563     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06564     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
06565 
06566     <span class="comment">//</span>
06567     <span class="comment">// Initialize return parameter to "not found".</span>
06568     <span class="comment">//</span>
06569 
06570     *DeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06571 
06572     <span class="comment">//</span>
06573     <span class="comment">// Search the device tree for the bus of the legacy device.</span>
06574     <span class="comment">//</span>
06575 
06576     deviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a>(
06577                      <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>,
06578                      LegacyBusType,
06579                      <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>,
06580                      SlotNumber
06581                  );
06582 
06583     <span class="comment">//</span>
06584     <span class="comment">// Either a bus driver does not exist (or more likely, the legacy bus</span>
06585     <span class="comment">// type and bus number were unspecified).  Either way, we can't make</span>
06586     <span class="comment">// any further progress.</span>
06587     <span class="comment">//</span>
06588 
06589     <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06590 
06591         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
06592 
06593     }
06594 
06595     <span class="comment">//</span>
06596     <span class="comment">// We found the legacy device's bus driver.  Query it to determine</span>
06597     <span class="comment">// whether it implements the LEGACY_DEVICE_DETECTION interface.</span>
06598     <span class="comment">//</span>
06599 
06600     busDeviceObject = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
06601 
06602     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a28">IopQueryResourceHandlerInterface</a>(
06603                  <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a217">ResourceLegacyDeviceDetection</a>,
06604                  busDeviceObject,
06605                  0,
06606                  (<a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a> *)&amp;interface
06607              );
06608 
06609     <span class="comment">//</span>
06610     <span class="comment">// If it doesn't, we're stuck.</span>
06611     <span class="comment">//</span>
06612 
06613     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || interface == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06614 
06615         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
06616 
06617     }
06618 
06619     <span class="comment">//</span>
06620     <span class="comment">// Invoke the bus driver's legacy device detection method.</span>
06621     <span class="comment">//</span>
06622 
06623     status = (*interface-&gt;LegacyDeviceDetection)(
06624                  interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o2">Context</a>,
06625                  LegacyBusType,
06626                  <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>,
06627                  SlotNumber,
06628                  &amp;deviceObject
06629              );
06630 
06631     <span class="comment">//</span>
06632     <span class="comment">// If it found a legacy device, update the return parameter.</span>
06633     <span class="comment">//</span>
06634 
06635     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; deviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06636 
06637         *DeviceNode =
06638             (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
06639 
06640         status = STATUS_SUCCESS;
06641 
06642     } <span class="keywordflow">else</span> {
06643 
06644         status = STATUS_INVALID_DEVICE_REQUEST;
06645 
06646     }
06647 
06648     <span class="comment">//</span>
06649     <span class="comment">// Free the interface.</span>
06650     <span class="comment">//</span>
06651 
06652     (*interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o4">InterfaceDereference</a>)(interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o2">Context</a>);
06653 
06654     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(interface);
06655 
06656     <span class="keywordflow">return</span> status;
06657 }
06658 
06659 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l06660"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a90">06660</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a90">IopSetLegacyDeviceInstance</a> (
06661     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
06662     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
06663     )
06664 
06665 <span class="comment">/*++</span>
06666 <span class="comment"></span>
06667 <span class="comment">Routine Description:</span>
06668 <span class="comment"></span>
06669 <span class="comment">    This routine sets the Root\Legacy_xxxx\0000 device instance path to the</span>
06670 <span class="comment">    madeup PDO (i.e. DeviceNode) which is created only for legacy resource allocation.</span>
06671 <span class="comment">    This routine also links the madeup PDO to the Root\Legacy_xxxx\0000 device node</span>
06672 <span class="comment">    to keep track what resources are assigned to the driver which services the</span>
06673 <span class="comment">    root\legacy_xxxx\0000 device.</span>
06674 <span class="comment"></span>
06675 <span class="comment">Parameters:</span>
06676 <span class="comment"></span>
06677 <span class="comment">    P1 -</span>
06678 <span class="comment"></span>
06679 <span class="comment">Return Value:</span>
06680 <span class="comment"></span>
06681 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
06682 <span class="comment"></span>
06683 <span class="comment">--*/</span>
06684 
06685 {
06686     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06687     UNICODE_STRING instancePath, rootString;
06688     HANDLE handle;
06689     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> legacyDeviceNode;
06690     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> legacyPdo;
06691 
06692     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06693 
06694     DeviceNode-&gt;OverUsed1.LegacyDeviceNode = 0;
06695     instancePath.Length = 0;
06696     instancePath.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06697 
06698     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a> (
06699                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
06700                  &amp;DriverObject-&gt;DriverExtension-&gt;ServiceKeyName,
06701                  0,
06702                  &amp;instancePath,
06703                  &amp;handle,
06704                  KEY_READ
06705                  );
06706     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (instancePath.Length != 0)) {
06707         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;rootString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ROOT\\LEGACY"</span>);
06708         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a43">RtlPrefixUnicodeString</a>(&amp;rootString, &amp;instancePath, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
06709             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;instancePath);
06710         } <span class="keywordflow">else</span> {
06711             DeviceNode-&gt;InstancePath = instancePath;
06712             legacyPdo = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a> (handle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06713             <span class="keywordflow">if</span> (legacyPdo) {
06714                 legacyDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)legacyPdo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
06715                 DeviceNode-&gt;OverUsed2.NextResourceDeviceNode =
06716                     legacyDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode;
06717                 legacyDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode = DeviceNode;
06718                 DeviceNode-&gt;OverUsed1.LegacyDeviceNode = legacyDeviceNode;
06719             }
06720         }
06721         ZwClose(handle);
06722     }
06723 }
06724 
06725 PCM_RESOURCE_LIST
<a name="l06726"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a91">06726</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a91">IopCombineLegacyResources</a> (
06727     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
06728     )
06729 
06730 <span class="comment">/*++</span>
06731 <span class="comment"></span>
06732 <span class="comment">Routine Description:</span>
06733 <span class="comment"></span>
06734 <span class="comment">    This routine sets the Root\Legacy_xxxx\0000 device instance path to the</span>
06735 <span class="comment">    madeup PDO (i.e. DeviceNode) which is created only for legacy resource allocation.</span>
06736 <span class="comment">    This routine also links the madeup PDO to the Root\Legacy_xxxx\0000 device node</span>
06737 <span class="comment">    to keep track what resources are assigned to the driver which services the</span>
06738 <span class="comment">    root\legacy_xxxx\0000 device.</span>
06739 <span class="comment"></span>
06740 <span class="comment">Parameters:</span>
06741 <span class="comment"></span>
06742 <span class="comment">    DeviceNode - The legacy device node whose resources need to be combined.</span>
06743 <span class="comment"></span>
06744 <span class="comment">Return Value:</span>
06745 <span class="comment"></span>
06746 <span class="comment">    Return the combined resource list.</span>
06747 <span class="comment"></span>
06748 <span class="comment">--*/</span>
06749 
06750 {
06751     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06752     PCM_RESOURCE_LIST combinedList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06753     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devNode = DeviceNode;
06754     ULONG size = 0;
06755     PUCHAR p;
06756 
06757     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06758 
06759     <span class="keywordflow">if</span> (DeviceNode) {
06760 
06761         <span class="comment">//</span>
06762         <span class="comment">// First determine how much memory is needed for the new combined list.</span>
06763         <span class="comment">//</span>
06764 
06765         <span class="keywordflow">while</span> (devNode) {
06766             <span class="keywordflow">if</span> (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
06767                 size += <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>);
06768             }
06769             devNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode;
06770         }
06771         <span class="keywordflow">if</span> (size != 0) {
06772             combinedList = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d1/pnpres_8c.html#a3">ExAllocatePoolCMRL</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size);
06773             devNode = DeviceNode;
06774             <span class="keywordflow">if</span> (combinedList) {
06775                 combinedList-&gt;Count = 0;
06776                 p = (PUCHAR)combinedList;
06777                 p += <span class="keyword">sizeof</span>(ULONG);  <span class="comment">// Skip Count</span>
06778                 <span class="keywordflow">while</span> (devNode) {
06779                     <span class="keywordflow">if</span> (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
06780                         size = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>);
06781                         <span class="keywordflow">if</span> (size != 0) {
06782                             size -= <span class="keyword">sizeof</span>(ULONG);
06783                             RtlMoveMemory(
06784                                 p,
06785                                 devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>-&gt;List,
06786                                 size
06787                                 );
06788                             p += size;
06789                             combinedList-&gt;Count += devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>-&gt;Count;
06790                         }
06791                     }
06792                     devNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode;
06793                 }
06794             }
06795         }
06796     }
06797     <span class="keywordflow">return</span> combinedList;
06798 }
06799 
06800 PCM_RESOURCE_LIST
<a name="l06801"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a51">06801</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a51">IopCreateCmResourceList</a>(
06802     IN PCM_RESOURCE_LIST ResourceList,
06803     IN INTERFACE_TYPE InterfaceType,
06804     IN ULONG   BusNumber,
06805     OUT PCM_RESOURCE_LIST  *RemainingList
06806     )
06807 {
06808     PCM_RESOURCE_LIST               newList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06809     ULONG                           i, j;
06810     ULONG                           totalSize, matchSize, remainingSize, listSize;
06811     PCM_FULL_RESOURCE_DESCRIPTOR    fullResourceDesc, newFullResourceDesc, remainingFullResourceDesc;
06812     PCM_PARTIAL_RESOURCE_DESCRIPTOR partialDescriptor;
06813 
06814 
06815     <span class="comment">//</span>
06816     <span class="comment">// Determine the size of memory to be allocated for the matching resource list.</span>
06817     <span class="comment">//</span>
06818 
06819     fullResourceDesc = &amp;ResourceList-&gt;List[0];
06820     totalSize = FIELD_OFFSET(CM_RESOURCE_LIST, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
06821     matchSize = 0;
06822     <span class="keywordflow">for</span> (i = 0; i &lt; ResourceList-&gt;Count; i++) {
06823 
06824         <span class="comment">//</span>
06825         <span class="comment">// Add the size of this descriptor.</span>
06826         <span class="comment">//</span>
06827 
06828         listSize = FIELD_OFFSET(CM_FULL_RESOURCE_DESCRIPTOR,
06829                                 PartialResourceList) +
06830                    FIELD_OFFSET(CM_PARTIAL_RESOURCE_LIST,
06831                                 PartialDescriptors);
06832 
06833         partialDescriptor = &amp;fullResourceDesc-&gt;PartialResourceList.PartialDescriptors[0];
06834         <span class="keywordflow">for</span> (j = 0; j &lt; fullResourceDesc-&gt;PartialResourceList.Count; j++) {
06835 
06836             ULONG descriptorSize = <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR);
06837 
06838             <span class="keywordflow">if</span> (partialDescriptor-&gt;Type == CmResourceTypeDeviceSpecific) {
06839 
06840                 descriptorSize += partialDescriptor-&gt;u.DeviceSpecificData.DataSize;
06841             }
06842 
06843             listSize += descriptorSize;
06844             partialDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR)
06845                                     ((PUCHAR)partialDescriptor + descriptorSize);
06846 
06847         }
06848 
06849         <span class="keywordflow">if</span> (    fullResourceDesc-&gt;InterfaceType == <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> &amp;&amp;
06850                 fullResourceDesc-&gt;BusNumber == <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>) {
06851 
06852 
06853             matchSize += listSize;
06854         }
06855 
06856         totalSize += listSize;
06857         fullResourceDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)
06858                                   ((PUCHAR)fullResourceDesc + listSize);
06859     }
06860 
06861     <span class="keywordflow">if</span> (totalSize) {
06862 
06863         <span class="keywordflow">if</span> (matchSize) {
06864 
06865             matchSize += FIELD_OFFSET(CM_RESOURCE_LIST, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
06866 
06867         }
06868         <span class="keywordflow">if</span> (matchSize == totalSize) {
06869 
06870             *RemainingList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06871             newList = ResourceList;
06872 
06873         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (matchSize == 0) {
06874 
06875             *RemainingList = ResourceList;
06876 
06877         } <span class="keywordflow">else</span> {
06878 
06879             <span class="comment">//</span>
06880             <span class="comment">// Allocate memory for both lists.</span>
06881             <span class="comment">//</span>
06882 
06883             newList = (PCM_RESOURCE_LIST)<a class="code" href="../../d5/d1/pnpres_8c.html#a13">ExAllocatePoolIORRR</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, matchSize);
06884 
06885             <span class="keywordflow">if</span> (newList) {
06886 
06887                 *RemainingList = (PCM_RESOURCE_LIST)<a class="code" href="../../d5/d1/pnpres_8c.html#a13">ExAllocatePoolIORRR</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, totalSize - matchSize + FIELD_OFFSET(CM_RESOURCE_LIST, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>));
06888 
06889                 <span class="keywordflow">if</span> (*RemainingList) {
06890 
06891                     newList-&gt;Count = 0;
06892                     (*RemainingList)-&gt;Count = 0;
06893                     newFullResourceDesc = &amp;newList-&gt;List[0];
06894                     remainingFullResourceDesc = &amp;(*RemainingList)-&gt;List[0];
06895                     fullResourceDesc = &amp;ResourceList-&gt;List[0];
06896                     <span class="keywordflow">for</span> (i = 0; i &lt; ResourceList-&gt;Count; i++) {
06897 
06898                         listSize = FIELD_OFFSET(CM_FULL_RESOURCE_DESCRIPTOR,
06899                                                 PartialResourceList) +
06900                                    FIELD_OFFSET(CM_PARTIAL_RESOURCE_LIST,
06901                                                 PartialDescriptors);
06902 
06903                         partialDescriptor = &amp;fullResourceDesc-&gt;PartialResourceList.PartialDescriptors[0];
06904                         <span class="keywordflow">for</span> (j = 0; j &lt; fullResourceDesc-&gt;PartialResourceList.Count; j++) {
06905 
06906                             ULONG descriptorSize = <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR);
06907 
06908                             <span class="keywordflow">if</span> (partialDescriptor-&gt;Type == CmResourceTypeDeviceSpecific) {
06909 
06910                                 descriptorSize += partialDescriptor-&gt;u.DeviceSpecificData.DataSize;
06911                             }
06912 
06913                             listSize += descriptorSize;
06914                             partialDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR)
06915                                                     ((PUCHAR)partialDescriptor + descriptorSize);
06916 
06917                         }
06918 
06919                         <span class="keywordflow">if</span> (    fullResourceDesc-&gt;InterfaceType == <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> &amp;&amp;
06920                                 fullResourceDesc-&gt;BusNumber == <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>) {
06921 
06922                             newList-&gt;Count++;
06923                             RtlMoveMemory(newFullResourceDesc, fullResourceDesc, listSize);
06924                             newFullResourceDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)
06925                                                           ((PUCHAR)newFullResourceDesc + listSize);
06926                         } <span class="keywordflow">else</span> {
06927 
06928                             (*RemainingList)-&gt;Count++;
06929                             RtlMoveMemory(remainingFullResourceDesc, fullResourceDesc, listSize);
06930                             remainingFullResourceDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)
06931                                                           ((PUCHAR)remainingFullResourceDesc + listSize);
06932                         }
06933 
06934                         fullResourceDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)
06935                                                   ((PUCHAR)fullResourceDesc + listSize);
06936                     }
06937 
06938                 } <span class="keywordflow">else</span> {
06939 
06940                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(newList);
06941                     newList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06942 
06943                 }
06944 
06945             } <span class="keywordflow">else</span> {
06946 
06947                 *RemainingList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06948             }
06949         }
06950     }
06951     <span class="keywordflow">return</span> newList;
06952 }
06953 
06954 PCM_RESOURCE_LIST
<a name="l06955"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a52">06955</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a52">IopCombineCmResourceList</a>(
06956     IN PCM_RESOURCE_LIST ResourceListA,
06957     IN PCM_RESOURCE_LIST ResourceListB
06958     )
06959 {
06960     PCM_RESOURCE_LIST newList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06961     ULONG   sizeA, sizeB, size;
06962 
06963     <span class="keywordflow">if</span> (ResourceListA == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06964 
06965         <span class="keywordflow">return</span> ResourceListB;
06966 
06967     }
06968 
06969     <span class="keywordflow">if</span> (ResourceListB == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06970 
06971         <span class="keywordflow">return</span> ResourceListA;
06972 
06973     }
06974 
06975     sizeA = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(ResourceListA);
06976     sizeB = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(ResourceListB);
06977 
06978     <span class="keywordflow">if</span> (sizeA &amp;&amp; sizeB) {
06979 
06980         size = sizeA + sizeB - (<span class="keyword">sizeof</span>(CM_RESOURCE_LIST) - <span class="keyword">sizeof</span>(CM_FULL_RESOURCE_DESCRIPTOR));
06981         newList = (PCM_RESOURCE_LIST)<a class="code" href="../../d5/d1/pnpres_8c.html#a13">ExAllocatePoolIORRR</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size);
06982         <span class="keywordflow">if</span> (newList) {
06983 
06984             RtlMoveMemory(newList, ResourceListA, sizeA);
06985             RtlMoveMemory(  (PUCHAR)newList + sizeA,
06986                             (PUCHAR)ResourceListB + (<span class="keyword">sizeof</span>(CM_RESOURCE_LIST) - <span class="keyword">sizeof</span>(CM_FULL_RESOURCE_DESCRIPTOR)),
06987                             sizeB - (<span class="keyword">sizeof</span>(CM_RESOURCE_LIST) - <span class="keyword">sizeof</span>(CM_FULL_RESOURCE_DESCRIPTOR)));
06988             newList-&gt;Count += ResourceListB-&gt;Count;
06989         }
06990     }
06991 
06992     <span class="keywordflow">return</span> newList;
06993 }
06994 
06995 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l06996"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a110">06996</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a110">IopReserveLegacyBootResources</a>(
06997     IN INTERFACE_TYPE InterfaceType,
06998     IN ULONG   BusNumber
06999     )
07000 
07001 <span class="comment">/*++</span>
07002 <span class="comment"></span>
07003 <span class="comment">Routine Description:</span>
07004 <span class="comment"></span>
07005 <span class="comment">    This routine is called to reserve legacy BOOT resources for the specified InterfaceType</span>
07006 <span class="comment">    and BusNumber. This is done everytime a new bus with a legacy InterfaceType gets enumerated.</span>
07007 <span class="comment"></span>
07008 <span class="comment">Arguments:</span>
07009 <span class="comment"></span>
07010 <span class="comment">    InterfaceType - Legacy InterfaceType.</span>
07011 <span class="comment"></span>
07012 <span class="comment">    BusNumber - Legacy BusNumber</span>
07013 <span class="comment"></span>
07014 <span class="comment">Return Value:</span>
07015 <span class="comment"></span>
07016 <span class="comment">    The status returned is the final completion status of the operation.</span>
07017 <span class="comment"></span>
07018 <span class="comment">--*/</span>
07019 
07020 {
07021     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
07022     <a class="code" href="../../d9/d0/pnpiop_8h.html#a138">PIOP_RESERVED_RESOURCES_RECORD</a>  resourceRecord, prevRecord;
07023     PCM_RESOURCE_LIST   newList, remainingList;
07024 
07025     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a> &amp;&amp; <a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a>) {
07026 
07027         remainingList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07028         newList = <a class="code" href="../../d5/d1/pnpres_8c.html#a51">IopCreateCmResourceList</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a>, <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>, <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>, &amp;remainingList);
07029         <span class="keywordflow">if</span> (newList) {
07030 
07031             <span class="keywordflow">if</span> (remainingList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07032 
07033                 <span class="comment">//</span>
07034                 <span class="comment">// Full match. Check for error.</span>
07035                 <span class="comment">//</span>
07036 
07037                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(newList == <a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a>);
07038 
07039             } <span class="keywordflow">else</span> {
07040 
07041                 <span class="comment">//</span>
07042                 <span class="comment">// Partial match. Check for error.</span>
07043                 <span class="comment">//</span>
07044 
07045                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a> != newList);
07046                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a> != remainingList);
07047 
07048             }
07049 
07050             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>, (<span class="stringliteral">"IopReserveLegacyBootResources: Allocating HAL BOOT config for interface %08X and bus %08X...\n"</span>, <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>, <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>));
07051             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>) {
07052 
07053                 <a class="code" href="../../d1/d8/report_8c.html#a17">IopDumpCmResourceList</a>(newList);
07054 
07055             }
07056             <span class="keywordflow">if</span> (remainingList) {
07057                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a>);
07058             }
07059             <a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a> = remainingList;
07060             remainingList = <a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>;
07061             <a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>;
07062             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a111">IopAllocateBootResources</a>(  <a class="code" href="../../d6/d9/pnp_8h.html#a174a127">ArbiterRequestHalReported</a>,
07063                                                 <a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
07064                                                 newList);
07065             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
07066             <a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a52">IopCombineCmResourceList</a>(remainingList, newList);
07067             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>);
07068 
07069             <span class="comment">//</span>
07070             <span class="comment">// Free previous BOOT config if any.</span>
07071             <span class="comment">//</span>
07072 
07073             <span class="keywordflow">if</span> (remainingList) {
07074 
07075                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(remainingList);
07076 
07077             }
07078         } <span class="keywordflow">else</span> {
07079 
07080             <span class="comment">//</span>
07081             <span class="comment">// No match. Check that there was no error.</span>
07082             <span class="comment">//</span>
07083 
07084             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(remainingList &amp;&amp; remainingList == <a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a>);
07085         }
07086     }
07087 
07088     <span class="keywordflow">for</span> (prevRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, resourceRecord = <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a>; resourceRecord;) {
07089 
07090         <span class="keywordflow">if</span> (    resourceRecord-&gt;ReservedResources &amp;&amp;
07091                 resourceRecord-&gt;ReservedResources-&gt;List[0].InterfaceType == <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> &amp;&amp;
07092                 resourceRecord-&gt;ReservedResources-&gt;List[0].BusNumber == <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>) {
07093 
07094             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>, (<span class="stringliteral">"IopReserveLegacyBootResources: Allocating BOOT config...\n"</span>));
07095             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>) {
07096 
07097                 <a class="code" href="../../d1/d8/report_8c.html#a17">IopDumpCmResourceList</a>(resourceRecord-&gt;ReservedResources);
07098 
07099             }
07100 
07101             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a111">IopAllocateBootResources</a>(  <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>,
07102                                                 resourceRecord-&gt;DeviceObject,
07103                                                 resourceRecord-&gt;ReservedResources);
07104             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07105 
07106                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopReserveLegacyBootResources: IopAllocateBootResources failed with status = %08X\n"</span>, status);
07107                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
07108 
07109             }
07110 
07111             <span class="keywordflow">if</span> (resourceRecord-&gt;DeviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07112 
07113                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resourceRecord-&gt;ReservedResources);
07114 
07115             }
07116 
07117             <span class="keywordflow">if</span> (prevRecord) {
07118 
07119                 prevRecord-&gt;Next = resourceRecord-&gt;Next;
07120 
07121             } <span class="keywordflow">else</span> {
07122 
07123                 <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a> = resourceRecord-&gt;Next;
07124 
07125             }
07126             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resourceRecord);
07127             resourceRecord = (prevRecord)? prevRecord-&gt;Next : <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a>;
07128 
07129         } <span class="keywordflow">else</span> {
07130 
07131             prevRecord = resourceRecord;
07132             resourceRecord = resourceRecord-&gt;Next;
07133 
07134         }
07135     }
07136 
07137     <span class="keywordflow">return</span> STATUS_SUCCESS;
07138 }
07139 
07140 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l07141"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a111">07141</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a111">IopAllocateBootResources</a> (
07142     IN ARBITER_REQUEST_SOURCE ArbiterRequestSource,
07143     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
07144     IN PCM_RESOURCE_LIST BootResources
07145     )
07146 
07147 <span class="comment">/*++</span>
07148 <span class="comment"></span>
07149 <span class="comment">Routine Description:</span>
07150 <span class="comment"></span>
07151 <span class="comment">    This routine reports boot resources for the specified device to</span>
07152 <span class="comment">    arbiters.</span>
07153 <span class="comment"></span>
07154 <span class="comment">Arguments:</span>
07155 <span class="comment"></span>
07156 <span class="comment">    DeviceObject - Supplies a pointer to the device object, could be NULL</span>
07157 <span class="comment">        if DeviceObject is NULL, the BootResources are reserved and will not be given</span>
07158 <span class="comment">            to a device unless there is no other choice. The caller must release the</span>
07159 <span class="comment">            pool for BootResources.</span>
07160 <span class="comment">        if DeviceObject is NON_NULL, BootResources are BOOT reserved (preallocated.)</span>
07161 <span class="comment"></span>
07162 <span class="comment">    BootResources - Supplies a pointer to the Boot resources.</span>
07163 <span class="comment"></span>
07164 <span class="comment">Return Value:</span>
07165 <span class="comment"></span>
07166 <span class="comment">    None.</span>
07167 <span class="comment"></span>
07168 <span class="comment">--*/</span>
07169 {
07170     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
07171 
07172     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07173 
07174     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>( );
07175 
07176     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>,
07177                                     <a class="code" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>,
07178                                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
07179                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
07180                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
07181 
07182     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07183 
07184         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a94">IopReserveBootResourcesInternal</a>(ArbiterRequestSource, DeviceObject, BootResources);
07185         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>, 0, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
07186 
07187     } <span class="keywordflow">else</span> {
07188 
07189         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"IopReserveBootResources: Get RegustrySemaphore failed. Status %x\n"</span>, status));
07190     }
07191 
07192     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
07193 
07194     <span class="keywordflow">return</span> status;
07195 }
07196 
07197 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l07198"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a94">07198</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a94">IopReserveBootResourcesInternal</a> (
07199     IN ARBITER_REQUEST_SOURCE ArbiterRequestSource,
07200     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
07201     IN PCM_RESOURCE_LIST BootResources
07202     )
07203 
07204 <span class="comment">/*++</span>
07205 <span class="comment"></span>
07206 <span class="comment">Routine Description:</span>
07207 <span class="comment"></span>
07208 <span class="comment">    This routine reports boot resources for the specified device to</span>
07209 <span class="comment">    arbiters.</span>
07210 <span class="comment"></span>
07211 <span class="comment">Arguments:</span>
07212 <span class="comment"></span>
07213 <span class="comment">    DeviceObject - Supplies a pointer to the device object, could be NULL</span>
07214 <span class="comment">        if DeviceObject is NULL, the BootResources are reserved and will not be given</span>
07215 <span class="comment">            to a device unless there is no other choice. The caller must release the</span>
07216 <span class="comment">            pool for BootResources.</span>
07217 <span class="comment">        if DeviceObject is NON_NULL, BootResources are BOOT reserved (preallocated.)</span>
07218 <span class="comment"></span>
07219 <span class="comment">    BootResources - Supplies a pointer to the Boot resources.</span>
07220 <span class="comment"></span>
07221 <span class="comment">Return Value:</span>
07222 <span class="comment"></span>
07223 <span class="comment">    None.</span>
07224 <span class="comment"></span>
07225 <span class="comment">--*/</span>
07226 {
07227     PIO_RESOURCE_REQUIREMENTS_LIST ioResources;
07228     <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> reqList;
07229     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
07230     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
07231 
07232     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07233 
07234     <span class="keywordflow">if</span> (DeviceObject) {
07235         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
07236     }
07237     ioResources = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a>(0, BootResources, LCPRI_BOOTCONFIG);
07238     <span class="keywordflow">if</span> (ioResources) {
07239 <span class="preprocessor">#if MYDBG</span>
07240 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (deviceNode) {
07241             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n===================================\n"</span>);
07242             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PreAllocate Resource List for %wZ :: \n"</span>, &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>);
07243         } <span class="keywordflow">else</span> {
07244             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Reserve Resource List :: "</span>);
07245         }
07246         <a class="code" href="../../d5/d1/pnpres_8c.html#a97">IopDumpResourceRequirementsList</a>(ioResources);
07247         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" ++++++++++++++++++++++++++++++\n"</span>);
07248 <span class="preprocessor">#endif</span>
07249 <span class="preprocessor"></span>
07250         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a57">IopResourceRequirementsListToReqList</a>(
07251                         ArbiterRequestSource,
07252                         ioResources,
07253                         DeviceObject,
07254                         &amp;reqList);
07255 
07256         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; reqList) {
07257             <a class="code" href="../../d5/d1/pnpres_8c.html#a93">IopReserve</a>(reqList);
07258             <span class="keywordflow">if</span> (DeviceObject) {
07259                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a13">DNF_BOOT_CONFIG_RESERVED</a>;
07260                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07261                     ULONG size;
07262 
07263                     <span class="comment">//</span>
07264                     <span class="comment">// If we have not remember the root enumerated device's boot resources</span>
07265                     <span class="comment">// do it now.  We always need to pre-allocate boot config for root enumerated</span>
07266                     <span class="comment">// devices when their resources are released.</span>
07267                     <span class="comment">//</span>
07268 
07269                     size = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a> (BootResources);
07270                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a12">ExAllocatePoolIORL</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size);
07271                     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>) {
07272                         RtlMoveMemory(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>, BootResources, size);
07273                     } <span class="keywordflow">else</span> {
07274                         status = STATUS_INSUFFICIENT_RESOURCES;
07275                     }
07276                 }
07277             }
07278             <a class="code" href="../../d5/d1/pnpres_8c.html#a63">IopFreeReqList</a>(reqList);
07279         } <span class="keywordflow">else</span> {
07280 <span class="preprocessor">#if MYDBG</span>
07281 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);                         <span class="comment">// For now</span>
07282 <span class="preprocessor">#endif</span>
07283 <span class="preprocessor"></span>        }
07284         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioResources);
07285     }
07286 
07287     <span class="keywordflow">return</span> status;
07288 }
07289 
07290 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l07291"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a112">07291</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a112">IopReserveBootResources</a> (
07292     IN ARBITER_REQUEST_SOURCE ArbiterRequestSource,
07293     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
07294     IN PCM_RESOURCE_LIST BootResources
07295     )
07296 
07297 <span class="comment">/*++</span>
07298 <span class="comment"></span>
07299 <span class="comment">Routine Description:</span>
07300 <span class="comment"></span>
07301 <span class="comment">    This routine reports boot resources for the specified device to</span>
07302 <span class="comment">    arbiters.  Since the real resource pre-alloc routine can only be called after</span>
07303 <span class="comment">    all the arbiters and translators are present, all the calls to pre-alloc resources</span>
07304 <span class="comment">    before the preallocation routine is available will be routed to this routine.</span>
07305 <span class="comment"></span>
07306 <span class="comment">Arguments:</span>
07307 <span class="comment"></span>
07308 <span class="comment">    DeviceObject - Supplies a pointer to the device object.  If present, caller wants to</span>
07309 <span class="comment">        preallocate BOOT resources for a device object.  If NULL, caller wants to reserved</span>
07310 <span class="comment">        resources for some unknown devices.</span>
07311 <span class="comment"></span>
07312 <span class="comment">    BootResources - Supplies a pointer to the Boot resources.</span>
07313 <span class="comment"></span>
07314 <span class="comment">Return Value:</span>
07315 <span class="comment"></span>
07316 <span class="comment">    None.</span>
07317 <span class="comment"></span>
07318 <span class="comment">--*/</span>
07319 {
07320     <a class="code" href="../../d9/d0/pnpiop_8h.html#a138">PIOP_RESERVED_RESOURCES_RECORD</a>  resourceRecord;
07321     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>                    deviceNode;
07322     ULONG                           size;
07323     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
07324 
07325     status = STATUS_SUCCESS;;
07326     size = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(BootResources);
07327     <span class="keywordflow">if</span> (size != 0) {
07328 
07329         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)((DeviceObject)?  DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
07330 
07331         <span class="comment">//</span>
07332         <span class="comment">// Pre-allocate BOOT configs right away for non-madeup devices.</span>
07333         <span class="comment">//</span>
07334 
07335         <span class="keywordflow">if</span> (DeviceObject &amp;&amp; !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>)) {
07336 
07337             <span class="keywordflow">return</span> <a class="code" href="../../d5/d1/pnpres_8c.html#a111">IopAllocateBootResources</a>(ArbiterRequestSource, DeviceObject, BootResources);
07338 
07339         }
07340 
07341 
07342         <span class="keywordflow">if</span> (DeviceObject) {
07343 
07344             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode);
07345             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a12">ExAllocatePoolIORL</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size);
07346             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>) {
07347 
07348                 RtlMoveMemory(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>, BootResources, size);
07349 
07350             } <span class="keywordflow">else</span> {
07351 
07352                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
07353 
07354             }
07355         }
07356 
07357         resourceRecord = (<a class="code" href="../../d9/d0/pnpiop_8h.html#a138">PIOP_RESERVED_RESOURCES_RECORD</a>) <a class="code" href="../../d5/d1/pnpres_8c.html#a13">ExAllocatePoolIORRR</a>(  <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
07358                                                                                 <span class="keyword">sizeof</span>(IOP_RESERVED_RESOURCES_RECORD));
07359         <span class="keywordflow">if</span> (resourceRecord) {
07360 
07361             resourceRecord-&gt;ReservedResources = (DeviceObject)? deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a> : BootResources;
07362             resourceRecord-&gt;DeviceObject = DeviceObject;
07363             resourceRecord-&gt;Next = <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a>;
07364             <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a> = resourceRecord;
07365 
07366         } <span class="keywordflow">else</span> {
07367 
07368             <span class="keywordflow">if</span> (deviceNode &amp;&amp; deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>) {
07369 
07370                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>);
07371 
07372             }
07373 
07374             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
07375 
07376         }
07377     }
07378 
07379     <span class="keywordflow">return</span> status;
07380 }
07381 
07382 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l07383"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a88">07383</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a88">IopReleaseResources</a> (
07384     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
07385     )
07386 
07387 <span class="comment">/*++</span>
07388 <span class="comment"></span>
07389 <span class="comment">Routine Description:</span>
07390 <span class="comment"></span>
07391 <span class="comment">    IopReleaseResources releases resources owned by the device and release</span>
07392 <span class="comment">    the memory pool.  We also release the cached resource requirements list.</span>
07393 <span class="comment">    If the device is a root enumerated device with BOOT config, we will preallocate</span>
07394 <span class="comment">    boot config resources for this device.</span>
07395 <span class="comment"></span>
07396 <span class="comment">    NOTE, this is a routine INTERNAL to this file.  NO one should call this function</span>
07397 <span class="comment">    outside of this file.  Outside of this file, IopReleaseDeviceResources should be</span>
07398 <span class="comment">    used.</span>
07399 <span class="comment"></span>
07400 <span class="comment">Arguments:</span>
07401 <span class="comment"></span>
07402 <span class="comment">    DeviceNode - Supplies a pointer to the device node.object.  If present, caller wants to</span>
07403 <span class="comment"></span>
07404 <span class="comment">Return Value:</span>
07405 <span class="comment"></span>
07406 <span class="comment">    None.</span>
07407 <span class="comment"></span>
07408 <span class="comment">--*/</span>
07409 {
07410 
07411     <span class="comment">//</span>
07412     <span class="comment">// Release the resources owned by the device</span>
07413     <span class="comment">//</span>
07414 
07415     <a class="code" href="../../d5/d1/pnpres_8c.html#a87">IopReleaseResourcesInternal</a>(DeviceNode);
07416     DeviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>;
07417     DeviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>;
07418 
07419 <span class="preprocessor">#if DBG_SCOPE</span>
07420 <span class="preprocessor"></span>
07421     <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceList) {
07422         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceList);
07423         DeviceNode-&gt;PreviousResourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07424     }
07425     <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceRequirements) {
07426         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceRequirements);
07427         DeviceNode-&gt;PreviousResourceRequirements = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07428     }
07429 <span class="preprocessor">#endif</span>
07430 <span class="preprocessor"></span>
07431     <span class="keywordflow">if</span> (DeviceNode-&gt;ResourceList) {
07432 
07433 <span class="preprocessor">#if DBG_SCOPE</span>
07434 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(DeviceNode-&gt;FailureStatus)) {
07435             DeviceNode-&gt;PreviousResourceList = DeviceNode-&gt;ResourceList;
07436         } <span class="keywordflow">else</span> {
07437             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ResourceList);
07438         }
07439 <span class="preprocessor">#else</span>
07440 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ResourceList);
07441 <span class="preprocessor">#endif</span>
07442 <span class="preprocessor"></span>
07443         DeviceNode-&gt;ResourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07444     }
07445     <span class="keywordflow">if</span> (DeviceNode-&gt;ResourceListTranslated) {
07446         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ResourceListTranslated);
07447         DeviceNode-&gt;ResourceListTranslated = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07448     }
07449 
07450     <span class="comment">//</span>
07451     <span class="comment">// If this device is a root enumerated device, preallocate its BOOT resources</span>
07452     <span class="comment">//</span>
07453 
07454     <span class="keywordflow">if</span> ((DeviceNode-&gt;Flags &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a33">DNF_DEVICE_GONE</a>)) == <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) {
07455         <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a> &amp;&amp; DeviceNode-&gt;BootResources) {
07456             <a class="code" href="../../d5/d1/pnpres_8c.html#a94">IopReserveBootResourcesInternal</a>(<a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>,
07457                                             DeviceNode-&gt;PhysicalDeviceObject,
07458                                             DeviceNode-&gt;BootResources);
07459         }
07460     } <span class="keywordflow">else</span> {
07461         DeviceNode-&gt;Flags &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a13">DNF_BOOT_CONFIG_RESERVED</a>);
07462         <span class="keywordflow">if</span> (DeviceNode-&gt;BootResources) {
07463             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;BootResources);
07464             DeviceNode-&gt;BootResources = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07465         }
07466     }
07467 }
07468 
07469 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l07470"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a113">07470</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a113">IopReallocateResources</a> (
07471     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
07472     )
07473 
07474 <span class="comment">/*++</span>
07475 <span class="comment"></span>
07476 <span class="comment">Routine Description:</span>
07477 <span class="comment"></span>
07478 <span class="comment">    This routine performs the real work for IoInvalidateDeviceState - ResourceRequirementsChanged.</span>
07479 <span class="comment"></span>
07480 <span class="comment">Arguments:</span>
07481 <span class="comment"></span>
07482 <span class="comment">    DeviceObject - Supplies a pointer to the device object.</span>
07483 <span class="comment"></span>
07484 <span class="comment">Return Value:</span>
07485 <span class="comment"></span>
07486 <span class="comment">    None.</span>
07487 <span class="comment"></span>
07488 <span class="comment">--*/</span>
07489 {
07490     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
07491     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> requestTable, *requestTablep;
07492     ULONG deviceCount, oldFlags;
07493     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
07494 
07495     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07496 
07497     <span class="comment">//</span>
07498     <span class="comment">// Grab the IO registry semaphore to make sure no other device is</span>
07499     <span class="comment">// reporting it's resource usage while we are searching for conflicts.</span>
07500     <span class="comment">//</span>
07501 
07502     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
07503     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>,
07504                                     <a class="code" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>,
07505                                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
07506                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
07507                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
07508     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07509 
07510         <span class="comment">//</span>
07511         <span class="comment">// Acquire the tree lock so we block remove for this device node.</span>
07512         <span class="comment">//</span>
07513 
07514         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a8">IopDeviceTreeLock</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
07515 
07516         <span class="comment">//</span>
07517         <span class="comment">// Check the flags after acquiring the semaphore.</span>
07518         <span class="comment">//</span>
07519 
07520         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>) {
07521             <span class="comment">//</span>
07522             <span class="comment">// Save the flags which we may have to restore in case of failure.</span>
07523             <span class="comment">//</span>
07524 
07525             oldFlags = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a46">DNF_HAS_RESOURCE</a>;
07526             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a46">DNF_HAS_RESOURCE</a>);
07527 
07528             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a21">DNF_NON_STOPPED_REBALANCE</a>) {
07529 
07530                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(deviceNode);
07531 
07532                 <span class="comment">//</span>
07533                 <span class="comment">// Set up parameters to call real routine</span>
07534                 <span class="comment">//</span>
07535 
07536                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>;
07537 
07538                 RtlZeroMemory(&amp;requestTable, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>));
07539                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> = DeviceObject;
07540                 requestTablep = &amp;requestTable;
07541                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a70">IOP_ASSIGN_NO_REBALANCE</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a72">IOP_ASSIGN_KEEP_CURRENT_CONFIG</a>;
07542 
07543                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a56">IopGetResourceRequirementsForAssignTable</a>(  requestTablep,
07544                                                                     requestTablep + 1,
07545                                                                     &amp;deviceCount);
07546                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; deviceCount) {
07547 
07548                     <span class="comment">//</span>
07549                     <span class="comment">// Release the current resources to the arbiters.</span>
07550                     <span class="comment">// Memory for ResourceList is not released.</span>
07551                     <span class="comment">//</span>
07552 
07553                     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
07554 
07555                         <a class="code" href="../../d5/d1/pnpres_8c.html#a87">IopReleaseResourcesInternal</a>(deviceNode);
07556                     }
07557 
07558                     <span class="comment">//</span>
07559                     <span class="comment">// Try to do the assignment.</span>
07560                     <span class="comment">//</span>
07561 
07562                     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a67">IopAssignInner</a>(deviceCount, requestTablep, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
07563                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07564 
07565                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a21">DNF_NON_STOPPED_REBALANCE</a>);
07566 
07567                         <a class="code" href="../../d5/d1/pnpres_8c.html#a65">IopBuildCmResourceLists</a>(requestTablep, requestTablep + 1);
07568 
07569                         <span class="comment">//</span>
07570                         <span class="comment">// We need to release the pool space for ResourceList and ResourceListTranslated.</span>
07571                         <span class="comment">// Because the earlier IopReleaseResourcesInternal does not release the pool.</span>
07572                         <span class="comment">//</span>
07573 
07574                         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
07575 
07576                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>);
07577 
07578                         }
07579                         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a>) {
07580 
07581                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a>);
07582 
07583                         }
07584 
07585                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = requestTablep-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>;
07586                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a> = requestTablep-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a>;
07587                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>;
07588                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>;
07589 
07590                         <a class="code" href="../../d0/d1/pnpirp_8c.html#a19">IopStartDevice</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
07591 
07592                     } <span class="keywordflow">else</span> {
07593 
07594                         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> restoreResourcesStatus;
07595 
07596                         restoreResourcesStatus = <a class="code" href="../../d5/d1/pnpres_8c.html#a89">IopRestoreResourcesInternal</a>(deviceNode);
07597                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(restoreResourcesStatus)) {
07598 
07599                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(restoreResourcesStatus));
07600                             <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(DeviceObject, CM_PROB_NORMAL_CONFLICT);
07601 
07602                         }
07603 
07604                         <span class="comment">//</span>
07605                         <span class="comment">// BUGBUG - once we failed, what will trigger us to try again?</span>
07606                         <span class="comment">//</span>
07607                     }
07608 
07609                     <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(requestTablep, requestTablep + 1);
07610 
07611 
07612                 } <span class="keywordflow">else</span> {
07613 
07614                     status = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)? STATUS_UNSUCCESSFUL : status;
07615 
07616                 }
07617 
07618                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>;
07619                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(deviceNode);
07620 
07621             } <span class="keywordflow">else</span> {
07622 
07623                 <span class="comment">//</span>
07624                 <span class="comment">// The device needs to be stopped to change resources.</span>
07625                 <span class="comment">//</span>
07626 
07627                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a85">IopRebalance</a>(0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
07628 
07629             }
07630 
07631             <span class="comment">//</span>
07632             <span class="comment">// Restore the flags in case of failure.</span>
07633             <span class="comment">//</span>
07634 
07635             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07636 
07637                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a46">DNF_HAS_RESOURCE</a>;
07638                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= oldFlags;
07639 
07640             }
07641 
07642         } <span class="keywordflow">else</span> {
07643 
07644             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PNPRES: Resource requirements not changed in IopReallocateResources, returning error!\n"</span>));
07645         }
07646 
07647         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a8">IopDeviceTreeLock</a>);
07648         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>, 0, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
07649 
07650     } <span class="keywordflow">else</span> {
07651 
07652         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"PNPRES: IopReallocateResources failed to acquire Registry semaphore, status %08X\n"</span>, status));
07653 
07654     }
07655 
07656     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
07657 }
07658 
07659 <span class="preprocessor">#if DBG_SCOPE</span>
07660 <span class="preprocessor"></span>
07661 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l07662"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a99">07662</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a> (
07663     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
07664     )
07665 
07666 {
07667     <span class="keywordflow">if</span> (DeviceNode) {
07668         <a class="code" href="../../d5/d1/pnpres_8c.html#a100">IopCheckDataStructuresWorker</a> (DeviceNode);
07669         <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a> (DeviceNode-&gt;Sibling);
07670         <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a> (DeviceNode-&gt;Child);
07671     }
07672 }
07673 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l07674"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a100">07674</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a100">IopCheckDataStructuresWorker</a> (
07675     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> Device
07676     )
07677 
07678 <span class="comment">/*++</span>
07679 <span class="comment"></span>
07680 <span class="comment">Routine Description:</span>
07681 <span class="comment"></span>
07682 <span class="comment">    This routine releases the assigned resources for device specified by DeviceNode.</span>
07683 <span class="comment">    Note, this routine does not reset the resource related fields in DeviceNode structure.</span>
07684 <span class="comment"></span>
07685 <span class="comment">Parameters:</span>
07686 <span class="comment"></span>
07687 <span class="comment">    DeviceNode - specifies the device node whose resources are goint to be released.</span>
07688 <span class="comment"></span>
07689 <span class="comment">Return Value:</span>
07690 <span class="comment"></span>
07691 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
07692 <span class="comment"></span>
07693 <span class="comment">--*/</span>
07694 
07695 {
07696     PLIST_ENTRY listHead, listEntry;
07697     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
07698 
07699     listHead = &amp;Device-&gt;DeviceArbiterList;
07700     listEntry = listHead-&gt;Flink;
07701     <span class="keywordflow">while</span> (listEntry != listHead) {
07702         arbiterEntry = CONTAINING_RECORD(listEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, DeviceArbiterList);
07703         <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o2">ArbiterInterface</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07704             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>));
07705             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>));
07706             InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
07707             InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>);
07708         }
07709         listEntry = listEntry-&gt;Flink;
07710     }
07711 }
07712 
07713 <span class="preprocessor">#endif</span>
07714 <span class="preprocessor"></span>
07715 
07716 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l07717"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a114">07717</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a114">IopQueryConflictList</a>(
07718     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>        PhysicalDeviceObject,
07719     IN PCM_RESOURCE_LIST  ResourceList,
07720     IN ULONG              ResourceListSize,
07721     OUT PPLUGPLAY_CONTROL_CONFLICT_LIST ConflictList,
07722     IN ULONG              ConflictListSize,
07723     IN ULONG              Flags
07724     )
07725 <span class="comment">/*++</span>
07726 <span class="comment"></span>
07727 <span class="comment">Routine Description:</span>
07728 <span class="comment"></span>
07729 <span class="comment">    This routine performs the querying of device conflicts</span>
07730 <span class="comment">    returning data in ConflictList</span>
07731 <span class="comment"></span>
07732 <span class="comment">Arguments:</span>
07733 <span class="comment"></span>
07734 <span class="comment">    PhysicalDeviceObject PDO of device to Query</span>
07735 <span class="comment">    ResourceList      CM resource list containing single resource to query</span>
07736 <span class="comment">    ResourceListSize  Size of ResourceList</span>
07737 <span class="comment">    ConflictList      Conflict list to fill query details in</span>
07738 <span class="comment">    ConflictListSize  Size of buffer that we can fill with Conflict information</span>
07739 <span class="comment">    Flags             Currently unused (zero) for future passing of flags</span>
07740 <span class="comment"></span>
07741 <span class="comment">Return Value:</span>
07742 <span class="comment"></span>
07743 <span class="comment">    Should be success in most cases</span>
07744 <span class="comment"></span>
07745 <span class="comment">--*/</span>
07746 {
07747     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
07748 
07749     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07750 
07751     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>( );
07752 
07753     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>,
07754                                     <a class="code" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>,
07755                                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
07756                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
07757                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
07758 
07759     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07760         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>, (<span class="stringliteral">"IopQueryConflictList: Get RegustrySemaphore failed. Status %x\n"</span>, status));
07761         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>( );
07762         <span class="keywordflow">return</span> status;
07763     } <span class="keywordflow">else</span> {
07764         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a101">IopQueryConflictListInternal</a>(PhysicalDeviceObject, ResourceList, ResourceListSize, ConflictList, ConflictListSize, Flags);
07765         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a>, 0, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
07766         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>( );
07767     }
07768 
07769     <span class="keywordflow">return</span> status;
07770 }
07771 
07772 
07773 
07774 BOOLEAN
<a name="l07775"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a104">07775</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a104">IopEliminateBogusConflict</a>(
07776     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>   PhysicalDeviceObject,
07777     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>   ConflictDeviceObject
07778     )
07779 <span class="comment">/*++</span>
07780 <span class="comment"></span>
07781 <span class="comment">Routine Description:</span>
07782 <span class="comment"></span>
07783 <span class="comment">    Determine if we're really conflicting with ourselves</span>
07784 <span class="comment">    if this is the case, we ignore it</span>
07785 <span class="comment"></span>
07786 <span class="comment">Arguments:</span>
07787 <span class="comment"></span>
07788 <span class="comment">    PhysicalDeviceObject  PDO we're performing the test for</span>
07789 <span class="comment">    ConflictDeviceObject  The object we've determined is conflicting</span>
07790 <span class="comment"></span>
07791 <span class="comment">Return Value:</span>
07792 <span class="comment"></span>
07793 <span class="comment">    TRUE to eliminate the conflict</span>
07794 <span class="comment"></span>
07795 <span class="comment">--*/</span>
07796 {
07797     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
07798     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
07799     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
07800     KIRQL           irql;
07801     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  attachedDevice;
07802 
07803     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07804 
07805     <span class="comment">//</span>
07806     <span class="comment">// simple cases</span>
07807     <span class="comment">//</span>
07808     <span class="keywordflow">if</span> (PhysicalDeviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ConflictDeviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07809         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07810     }
07811     <span class="comment">//</span>
07812     <span class="comment">// if ConflictDeviceObject is on PDO's stack, this is a non-conflict</span>
07813     <span class="comment">// nb at least PDO has to be checked</span>
07814     <span class="comment">//</span>
07815     ExAcquireFastLock( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a3">IopDatabaseLock</a>, &amp;irql );
07816 
07817     <span class="keywordflow">for</span> (attachedDevice = PhysicalDeviceObject;
07818          attachedDevice;
07819          attachedDevice = attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>) {
07820 
07821         <span class="keywordflow">if</span> (attachedDevice == ConflictDeviceObject) {
07822             ExReleaseFastLock( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a3">IopDatabaseLock</a>, irql );
07823             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07824         }
07825     }
07826 
07827     ExReleaseFastLock( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a3">IopDatabaseLock</a>, irql );
07828 
07829     <span class="comment">//</span>
07830     <span class="comment">// legacy case</span>
07831     <span class="comment">//</span>
07832     deviceNode = PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
07833     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode);
07834     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a>) {
07835         <span class="comment">//</span>
07836         <span class="comment">// hmmm, let's see if our ConflictDeviceObject is resources associated with a legacy device</span>
07837         <span class="comment">//</span>
07838         <span class="keywordflow">if</span> (ConflictDeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>) {
07839             <span class="comment">//</span>
07840             <span class="comment">// if not, we have a legacy conflicting with non-legacy, we're interested!</span>
07841             <span class="comment">//</span>
07842             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07843         }
07844         <span class="comment">//</span>
07845         <span class="comment">// FDO, report driver name</span>
07846         <span class="comment">//</span>
07847         driverObject = ConflictDeviceObject-&gt;DriverObject;
07848         <span class="keywordflow">if</span>(driverObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07849             <span class="comment">//</span>
07850             <span class="comment">// should not be NULL</span>
07851             <span class="comment">//</span>
07852             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(driverObject);
07853             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07854         }
07855         <span class="comment">//</span>
07856         <span class="comment">// compare deviceNode-&gt;Service with driverObject-&gt;Service</span>
07857         <span class="comment">//</span>
07858         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>.Length != 0 &amp;&amp;
07859             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>.Length == driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Length &amp;&amp;
07860             <a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>,&amp;driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)==0) {
07861             <span class="comment">//</span>
07862             <span class="comment">// the driver's service name is the same that this PDO is associated with</span>
07863             <span class="comment">// by ignoring it we could end up ignoring conflicts of simular types of legacy devices</span>
07864             <span class="comment">// but since these have to be hand-config'd anyhow, it's prob better than having false conflicts</span>
07865             <span class="comment">// (jamiehun)</span>
07866             <span class="comment">//</span>
07867             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07868         }
07869 
07870     }
07871     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07872 }
07873 
07874 
07875 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l07876"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a103">07876</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a103">IopQueryConflictFillString</a>(
07877     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>   DeviceObject,
07878     IN PWSTR            Buffer,
07879     IN OUT PULONG       Length,
07880     IN OUT PULONG       Flags
07881     )
07882 <span class="comment">/*++</span>
07883 <span class="comment"></span>
07884 <span class="comment">Routine Description:</span>
07885 <span class="comment"></span>
07886 <span class="comment">    Obtain string or string-length for details of conflicting device</span>
07887 <span class="comment"></span>
07888 <span class="comment">Arguments:</span>
07889 <span class="comment"></span>
07890 <span class="comment">    DeviceObject        Device object we want Device-Instance-String or Service Name</span>
07891 <span class="comment">    Buffer              Buffer to Fill, NULL if we just want length</span>
07892 <span class="comment">    Length              Filled with length of Buffer, including terminated NULL (Words)</span>
07893 <span class="comment">    Flags               Apropriate flags set describing what the string represents</span>
07894 <span class="comment"></span>
07895 <span class="comment">Return Value:</span>
07896 <span class="comment"></span>
07897 <span class="comment">    Should be success in most cases</span>
07898 <span class="comment"></span>
07899 <span class="comment">--*/</span>
07900 {
07901     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
07902     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
07903     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
07904     PUNICODE_STRING infoString = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07905     ULONG MaxLength = 0;        <span class="comment">// words</span>
07906     ULONG ReqLength = 0;        <span class="comment">// words</span>
07907     ULONG flags = 0;
07908 
07909     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07910 
07911     <span class="keywordflow">if</span> (Length != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07912         MaxLength = *Length;
07913     }
07914 
07915     <span class="keywordflow">if</span> (Flags != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07916         flags = *Flags;
07917     }
07918 
07919     <span class="keywordflow">if</span> (DeviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07920         <span class="comment">//</span>
07921         <span class="comment">// unknown</span>
07922         <span class="comment">//</span>
07923         <span class="keywordflow">goto</span> <span class="keyword">final</span>;
07924 
07925     }
07926 
07927     <span class="keywordflow">if</span> ((DeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>) == 0 ) {
07928         <span class="comment">//</span>
07929         <span class="comment">// FDO, report driver name</span>
07930         <span class="comment">//</span>
07931         driverObject = DeviceObject-&gt;DriverObject;
07932         <span class="keywordflow">if</span>(driverObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07933             <span class="comment">//</span>
07934             <span class="comment">// should not be NULL</span>
07935             <span class="comment">//</span>
07936             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(driverObject);
07937             <span class="keywordflow">goto</span> <span class="keyword">final</span>;
07938         }
07939         infoString = &amp; (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>);
07940         flags |= PNP_CE_LEGACY_DRIVER;
07941         <span class="keywordflow">goto</span> <span class="keyword">final</span>;
07942     }
07943 
07944     <span class="comment">//</span>
07945     <span class="comment">// we should in actual fact have a PDO</span>
07946     <span class="comment">//</span>
07947     <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceObjectExtension == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07948         <span class="comment">//</span>
07949         <span class="comment">// should not be NULL</span>
07950         <span class="comment">//</span>
07951         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceObject-&gt;DeviceObjectExtension);
07952         <span class="keywordflow">goto</span> <span class="keyword">final</span>;
07953     }
07954 
07955     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
07956     <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07957         <span class="comment">//</span>
07958         <span class="comment">// should not be NULL</span>
07959         <span class="comment">//</span>
07960         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode);
07961         <span class="keywordflow">goto</span> <span class="keyword">final</span>;
07962     }
07963 
07964     <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
07965         <span class="comment">//</span>
07966         <span class="comment">// owned by root device</span>
07967         <span class="comment">//</span>
07968         flags |= PNP_CE_ROOT_OWNED;
07969 
07970     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceNode -&gt; Parent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07971         <span class="comment">//</span>
07972         <span class="comment">// faked out PDO - must be legacy device</span>
07973         <span class="comment">//</span>
07974         driverObject = (<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>)(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o15">DuplicatePDO</a>);
07975         <span class="keywordflow">if</span>(driverObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07976             <span class="comment">//</span>
07977             <span class="comment">// should not be NULL</span>
07978             <span class="comment">//</span>
07979             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(driverObject);
07980             <span class="keywordflow">goto</span> <span class="keyword">final</span>;
07981         }
07982         infoString = &amp; (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>);
07983         flags |= PNP_CE_LEGACY_DRIVER;
07984         <span class="keywordflow">goto</span> <span class="keyword">final</span>;
07985     }
07986 
07987     <span class="comment">//</span>
07988     <span class="comment">// we should be happy with what we have</span>
07989     <span class="comment">//</span>
07990     infoString = &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>;
07991 
07992 <span class="keyword">final</span>:
07993 
07994     <span class="keywordflow">if</span> (infoString != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07995         <span class="comment">//</span>
07996         <span class="comment">// we have a string to copy</span>
07997         <span class="comment">//</span>
07998         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (MaxLength*<span class="keyword">sizeof</span>(WCHAR) &gt; infoString-&gt;Length)) {
07999             RtlCopyMemory(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, infoString-&gt;Buffer, infoString-&gt;Length);
08000         }
08001         ReqLength += infoString-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
08002     }
08003 
08004     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (MaxLength &gt; ReqLength)) {
08005         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[ReqLength] = 0;
08006     }
08007 
08008     ReqLength++;
08009 
08010     <span class="keywordflow">if</span> (Length != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08011         *Length = ReqLength;
08012     }
08013     <span class="keywordflow">if</span> (Flags != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08014         *Flags = flags;
08015     }
08016 
08017     <span class="keywordflow">return</span> status;
08018 }
08019 
08020 
08021 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l08022"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a102">08022</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a102">IopQueryConflictFillConflicts</a>(
08023     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>                  PhysicalDeviceObject,
08024     IN ULONG                        ConflictCount,
08025     IN <a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">PARBITER_CONFLICT_INFO</a>       ConflictInfoList,
08026     OUT PPLUGPLAY_CONTROL_CONFLICT_LIST ConflictList,
08027     IN ULONG                        ConflictListSize,
08028     IN ULONG                        Flags
08029     )
08030 <span class="comment">/*++</span>
08031 <span class="comment"></span>
08032 <span class="comment">Routine Description:</span>
08033 <span class="comment"></span>
08034 <span class="comment">    Fill ConflictList with information on as many conflicts as possible</span>
08035 <span class="comment"></span>
08036 <span class="comment">Arguments:</span>
08037 <span class="comment"></span>
08038 <span class="comment">    PhysicalDeviceObject The PDO we're performing the test on</span>
08039 <span class="comment">    ConflictCount       Number of Conflicts.</span>
08040 <span class="comment">    ConflictInfoList    List of conflicting device info, can be NULL if ConflictCount is 0</span>
08041 <span class="comment">    ConflictList        Structure to fill in with conflicts</span>
08042 <span class="comment">    ConflictListSize    Size of Conflict List</span>
08043 <span class="comment">    Flags               if non-zero, dummy conflict is created</span>
08044 <span class="comment"></span>
08045 <span class="comment">Return Value:</span>
08046 <span class="comment"></span>
08047 <span class="comment">    Should be success in most cases</span>
08048 <span class="comment"></span>
08049 <span class="comment">--*/</span>
08050 {
08051     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
08052     ULONG ConflictListIdealSize;
08053     ULONG ConflictListBaseSize;
08054     ULONG ConflictListCount;
08055     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
08056     ULONG ConflictIndex;
08057     ULONG EntrySize;
08058     ULONG ConflictStringsOffset;
08059     ULONG stringSize;
08060     ULONG stringTotalSize;
08061     ULONG DummyCount;
08062     PPLUGPLAY_CONTROL_CONFLICT_STRINGS ConfStrings;
08063 
08064     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
08065 
08066     <span class="comment">//</span>
08067     <span class="comment">// determine how many conflicts we can</span>
08068     <span class="comment">//</span>
08069     <span class="comment">// for each conflict</span>
08070     <span class="comment">// translate to bus/resource/address in respect to conflicting device</span>
08071     <span class="comment">// add to conflict list</span>
08072     <span class="comment">//</span>
08073     <span class="comment">//</span>
08074 
08075     <span class="comment">//</span>
08076     <span class="comment">// preprocessing - given our ConflictInfoList and ConflictCount</span>
08077     <span class="comment">// remove any that appear to be bogus - ie, that are the same device that we are testing against</span>
08078     <span class="comment">// this stops mostly legacy issues</span>
08079     <span class="comment">//</span>
08080     <span class="keywordflow">for</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ConflictCount; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
08081         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a104">IopEliminateBogusConflict</a>(PhysicalDeviceObject,ConflictInfoList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].OwningObject)) {
08082 
08083             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"IopQueryConflictFillConflicts: eliminating \"identical\" PDO %08x conflicting with self (%08x)\n"</span>,
08084                                         ConflictInfoList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].OwningObject,PhysicalDeviceObject));
08085             <span class="comment">//</span>
08086             <span class="comment">// move the last listed conflict into this space</span>
08087             <span class="comment">//</span>
08088             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1 &lt; ConflictCount) {
08089                 RtlCopyMemory(&amp;ConflictInfoList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>],&amp;ConflictInfoList[ConflictCount-1],<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">ARBITER_CONFLICT_INFO</a>));
08090             }
08091             <span class="comment">//</span>
08092             <span class="comment">// account for deleting this item</span>
08093             <span class="comment">//</span>
08094             ConflictCount--;
08095             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>--;
08096         }
08097     }
08098 
08099     <span class="comment">//</span>
08100     <span class="comment">// preprocessing - in our conflict list, we may have PDO's for legacy devices, and resource nodes for the same</span>
08101     <span class="comment">// or other duplicate entities (we only ever want to report a conflict once, even if there's multiple conflicting ranges)</span>
08102     <span class="comment">//</span>
08103 
08104   RestartScan:
08105 
08106     <span class="keywordflow">for</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ConflictCount; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
08107         <span class="keywordflow">if</span> (ConflictInfoList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].OwningObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08108 
08109             ULONG Index2;
08110 
08111             <span class="keywordflow">for</span> (Index2 = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1; Index2 &lt; ConflictCount; Index2++) {
08112                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a104">IopEliminateBogusConflict</a>(ConflictInfoList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].OwningObject,ConflictInfoList[Index2].OwningObject)) {
08113                     <span class="comment">//</span>
08114                     <span class="comment">// Index2 is considered a dup of Index</span>
08115                     <span class="comment">//</span>
08116 
08117                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"IopQueryConflictFillConflicts: eliminating \"identical\" PDO %08x conflicting with PDO %08x\n"</span>,
08118                                                 ConflictInfoList[Index2].OwningObject,ConflictInfoList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].OwningObject));
08119                     <span class="comment">//</span>
08120                     <span class="comment">// move the last listed conflict into this space</span>
08121                     <span class="comment">//</span>
08122                     <span class="keywordflow">if</span> (Index2+1 &lt; ConflictCount) {
08123                         RtlCopyMemory(&amp;ConflictInfoList[Index2],&amp;ConflictInfoList[ConflictCount-1],<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">ARBITER_CONFLICT_INFO</a>));
08124                     }
08125                     <span class="comment">//</span>
08126                     <span class="comment">// account for deleting this item</span>
08127                     <span class="comment">//</span>
08128                     ConflictCount--;
08129                     Index2--;
08130                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a104">IopEliminateBogusConflict</a>(ConflictInfoList[Index2].OwningObject,ConflictInfoList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].OwningObject)) {
08131                     <span class="comment">//</span>
08132                     <span class="comment">// Index is considered a dup of Index2 (some legacy case)</span>
08133                     <span class="comment">//</span>
08134                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"IopQueryConflictFillConflicts: eliminating \"identical\" PDO %08x conflicting with PDO %08x\n"</span>,
08135                                                 ConflictInfoList[Index2].OwningObject,ConflictInfoList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].OwningObject));
08136                     <span class="comment">//</span>
08137                     <span class="comment">// move the one we want (Index2) into the space occupied by Index</span>
08138                     <span class="comment">//</span>
08139                     RtlCopyMemory(&amp;ConflictInfoList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>],&amp;ConflictInfoList[Index2],<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">ARBITER_CONFLICT_INFO</a>));
08140                     <span class="comment">//</span>
08141                     <span class="comment">// move the last listed conflict into the space we just created</span>
08142                     <span class="comment">//</span>
08143                     <span class="keywordflow">if</span> (Index2+1 &lt; ConflictCount) {
08144                         RtlCopyMemory(&amp;ConflictInfoList[Index2],&amp;ConflictInfoList[ConflictCount-1],<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/pnp_8h.html#a54">ARBITER_CONFLICT_INFO</a>));
08145                     }
08146                     <span class="comment">//</span>
08147                     <span class="comment">// account for deleting this item</span>
08148                     <span class="comment">//</span>
08149                     ConflictCount--;
08150                     <span class="comment">//</span>
08151                     <span class="comment">// but as this is quirky, restart the scan</span>
08152                     <span class="comment">//</span>
08153                     <span class="keywordflow">goto</span> RestartScan;
08154                 }
08155             }
08156         }
08157     }
08158 
08159     <span class="comment">//</span>
08160     <span class="comment">// preprocessing - if we have any known reported conflicts, don't report back any unknown</span>
08161     <span class="comment">//</span>
08162 
08163     <span class="keywordflow">for</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ConflictCount; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
08164         <span class="comment">//</span>
08165         <span class="comment">// find first unknown</span>
08166         <span class="comment">//</span>
08167         <span class="keywordflow">if</span> (ConflictInfoList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].OwningObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08168             <span class="comment">//</span>
08169             <span class="comment">// eliminate all other unknowns</span>
08170             <span class="comment">//</span>
08171 
08172             ULONG Index2;
08173 
08174             <span class="keywordflow">for</span> (Index2 = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1; Index2 &lt; ConflictCount; Index2++) {
08175                 <span class="keywordflow">if</span> (ConflictInfoList[Index2].OwningObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08176 
08177                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"IopQueryConflictFillConflicts: eliminating extra unknown\n"</span>));
08178                     <span class="comment">//</span>
08179                     <span class="comment">// move the last listed conflict into this space</span>
08180                     <span class="comment">//</span>
08181                     <span class="keywordflow">if</span> (Index2+1 &lt; ConflictCount) {
08182                         RtlCopyMemory(&amp;ConflictInfoList[Index2],&amp;ConflictInfoList[ConflictCount-1],<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">ARBITER_CONFLICT_INFO</a>));
08183                     }
08184                     <span class="comment">//</span>
08185                     <span class="comment">// account for deleting this item</span>
08186                     <span class="comment">//</span>
08187                     ConflictCount--;
08188                     Index2--;
08189                 }
08190             }
08191 
08192             <span class="keywordflow">if</span>(ConflictCount != 1) {
08193 
08194                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"IopQueryConflictFillConflicts: eliminating first unknown\n"</span>));
08195                 <span class="comment">//</span>
08196                 <span class="comment">// there were others, so ignore the unknown</span>
08197                 <span class="comment">//</span>
08198                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1 &lt; ConflictCount) {
08199                     RtlCopyMemory(&amp;ConflictInfoList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>],&amp;ConflictInfoList[ConflictCount-1],<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">ARBITER_CONFLICT_INFO</a>));
08200                 }
08201                 ConflictCount --;
08202             }
08203 
08204             <span class="keywordflow">break</span>;
08205         }
08206     }
08207 
08208     <span class="comment">//</span>
08209     <span class="comment">// set number of actual and listed conflicts</span>
08210     <span class="comment">//</span>
08211 
08212     ConflictListIdealSize = (<span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_LIST) - <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_ENTRY)) + <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_STRINGS);
08213     ConflictListCount = 0;
08214     stringTotalSize = 0;
08215     DummyCount = 0;
08216 
08217     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ConflictListSize &gt;= ConflictListIdealSize); <span class="comment">// we should have checked to see if buffer is at least this big</span>
08218 
08219     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"IopQueryConflictFillConflicts: Detected %d conflicts\n"</span>, ConflictCount));
08220 
08221     <span class="comment">//</span>
08222     <span class="comment">// estimate sizes</span>
08223     <span class="comment">//</span>
08224     <span class="keywordflow">if</span> (Flags) {
08225         <span class="comment">//</span>
08226         <span class="comment">// flags entry required (ie resource not available for some specified reason)</span>
08227         <span class="comment">//</span>
08228         stringSize = 1; <span class="comment">// null-length string</span>
08229         DummyCount ++;
08230         EntrySize = <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_ENTRY);
08231         EntrySize += <span class="keyword">sizeof</span>(WCHAR) * stringSize;
08232 
08233         <span class="keywordflow">if</span>((ConflictListIdealSize+EntrySize) &lt;= ConflictListSize) {
08234             <span class="comment">//</span>
08235             <span class="comment">// we can fit this one in</span>
08236             <span class="comment">//</span>
08237             ConflictListCount++;
08238             stringTotalSize += stringSize;
08239         }
08240         ConflictListIdealSize += EntrySize;
08241     }
08242     <span class="comment">//</span>
08243     <span class="comment">// report conflicts</span>
08244     <span class="comment">//</span>
08245     <span class="keywordflow">for</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ConflictCount; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> ++) {
08246 
08247         stringSize = 0;
08248         <a class="code" href="../../d5/d1/pnpres_8c.html#a103">IopQueryConflictFillString</a>(ConflictInfoList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].OwningObject,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,&amp;stringSize,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
08249 
08250         <span class="comment">//</span>
08251         <span class="comment">// account for entry</span>
08252         <span class="comment">//</span>
08253         EntrySize = <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_ENTRY);
08254         EntrySize += <span class="keyword">sizeof</span>(WCHAR) * stringSize;
08255 
08256         <span class="keywordflow">if</span>((ConflictListIdealSize+EntrySize) &lt;= ConflictListSize) {
08257             <span class="comment">//</span>
08258             <span class="comment">// we can fit this one in</span>
08259             <span class="comment">//</span>
08260             ConflictListCount++;
08261             stringTotalSize += stringSize;
08262         }
08263         ConflictListIdealSize += EntrySize;
08264     }
08265 
08266     ConflictList-&gt;ConflictsCounted = ConflictCount+DummyCount; <span class="comment">// number of conflicts detected including any dummy conflict</span>
08267     ConflictList-&gt;ConflictsListed = ConflictListCount;         <span class="comment">// how many we could fit in</span>
08268     ConflictList-&gt;RequiredBufferSize = ConflictListIdealSize;  <span class="comment">// how much buffer space to supply on next call</span>
08269 
08270     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"IopQueryConflictFillConflicts: Listing %d conflicts\n"</span>, ConflictListCount));
08271     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"IopQueryConflictFillConflicts: Need %08x bytes to list all conflicts\n"</span>, ConflictListIdealSize));
08272 
08273     ConfStrings = (PPLUGPLAY_CONTROL_CONFLICT_STRINGS)&amp;(ConflictList-&gt;ConflictEntry[ConflictListCount]);
08274     ConfStrings-&gt;NullDeviceInstance = (ULONG)(-1);
08275     ConflictStringsOffset = 0;
08276 
08277     <span class="keywordflow">for</span>(ConflictIndex = 0; ConflictIndex &lt; DummyCount; ConflictIndex++) {
08278         <span class="comment">//</span>
08279         <span class="comment">// flags entry required (ie resource not available for some specified reason)</span>
08280         <span class="comment">//</span>
08281         <span class="keywordflow">if</span> (Flags &amp;&amp; ConflictIndex == 0) {
08282             ConflictList-&gt;ConflictEntry[ConflictIndex].DeviceInstance = ConflictStringsOffset;
08283             ConflictList-&gt;ConflictEntry[ConflictIndex].DeviceFlags = Flags;
08284             ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceType = 0;
08285             ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceStart = 0;
08286             ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceEnd = 0;
08287             ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceFlags = 0;
08288 
08289             ConfStrings-&gt;DeviceInstanceStrings[ConflictStringsOffset] = 0; <span class="comment">// null string</span>
08290             stringTotalSize --;
08291             ConflictStringsOffset ++;
08292             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"IopQueryConflictFillConflicts: Listing flags %08x\n"</span>, Flags));
08293         }
08294     }
08295     <span class="comment">//</span>
08296     <span class="comment">// get/fill in details for all those we can fit into the buffer</span>
08297     <span class="comment">//</span>
08298     <span class="keywordflow">for</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; ConflictIndex &lt; ConflictListCount ; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> ++, ConflictIndex++) {
08299 
08300         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ConflictCount);
08301         <span class="comment">//</span>
08302         <span class="comment">// assign conflict information</span>
08303         <span class="comment">//</span>
08304         ConflictList-&gt;ConflictEntry[ConflictIndex].DeviceInstance = ConflictStringsOffset;
08305         ConflictList-&gt;ConflictEntry[ConflictIndex].DeviceFlags = 0;
08306         ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceType = 0; <span class="comment">// BUGBUG!!! (jamiehun) remember to do this (post NT5)!</span>
08307         ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceStart = (ULONGLONG)(1); <span class="comment">// for now, return totally invalid range (1-0)</span>
08308         ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceEnd = 0;
08309         ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceFlags = 0;
08310 
08311         <span class="comment">//</span>
08312         <span class="comment">// fill string details</span>
08313         <span class="comment">//</span>
08314         stringSize = stringTotalSize;
08315         <a class="code" href="../../d5/d1/pnpres_8c.html#a103">IopQueryConflictFillString</a>(ConflictInfoList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].OwningObject,
08316                                     &amp;(ConfStrings-&gt;DeviceInstanceStrings[ConflictStringsOffset]),
08317                                     &amp;stringSize,
08318                                     &amp;(ConflictList-&gt;ConflictEntry[ConflictIndex].DeviceFlags));
08319         stringTotalSize -= stringSize;
08320         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(<a class="code" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>, (<span class="stringliteral">"IopQueryConflictFillConflicts: Listing \"%S\"\n"</span>, &amp;(ConfStrings-&gt;DeviceInstanceStrings[ConflictStringsOffset])));
08321         ConflictStringsOffset += stringSize;
08322     }
08323 
08324     <span class="comment">//</span>
08325     <span class="comment">// another NULL at end of strings (this is accounted for in the PPLUGPLAY_CONTROL_CONFLICT_STRINGS structure)</span>
08326     <span class="comment">//</span>
08327     ConfStrings-&gt;DeviceInstanceStrings[ConflictStringsOffset] = 0;
08328 
08329     <span class="comment">//Clean0:</span>
08330     ;
08331     <span class="keywordflow">return</span> status;
08332 }
08333 
08334 
08335 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l08336"></a><a class="code" href="../../d5/d1/pnpres_8c.html#a101">08336</a> <a class="code" href="../../d5/d1/pnpres_8c.html#a101">IopQueryConflictListInternal</a>(
08337     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>        PhysicalDeviceObject,
08338     IN PCM_RESOURCE_LIST  ResourceList,
08339     IN ULONG              ResourceListSize,
08340     OUT PPLUGPLAY_CONTROL_CONFLICT_LIST ConflictList,
08341     IN ULONG              ConflictListSize,
08342     IN ULONG              Flags
08343     )
08344 <span class="comment">/*++</span>
08345 <span class="comment"></span>
08346 <span class="comment">Routine Description:</span>
08347 <span class="comment"></span>
08348 <span class="comment">    Version of IopQueryConflictList without the locking</span>
08349 <span class="comment"></span>
08350 <span class="comment">--*/</span>
08351 {
08352 
08353     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
08354     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08355     PIO_RESOURCE_REQUIREMENTS_LIST ioResources;
08356     <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> reqList;
08357     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> reqDesc, reqDescTranslated;
08358     PLIST_ENTRY listHead;
08359     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
08360     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> <a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a>;
08361     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *reqAlternative;
08362     ULONG ConflictCount = 0;
08363     <a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">PARBITER_CONFLICT_INFO</a> ConflictInfoList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08364     PIO_RESOURCE_DESCRIPTOR ConflictDesc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08365     ULONG ReqDescCount = 0;
08366     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> *ReqDescTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08367     PIO_RESOURCE_REQUIREMENTS_LIST pIoReqList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08368     PVOID ExtParams[4];
08369 
08370     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
08371 
08372     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PhysicalDeviceObject);
08373     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ResourceList);
08374     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ResourceListSize);
08375     <span class="comment">//</span>
08376     <span class="comment">// these parameters were generated by umpnpmgr</span>
08377     <span class="comment">// so should be correct - one resource, and one resource only</span>
08378     <span class="comment">//</span>
08379     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ResourceList-&gt;Count == 1);
08380     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ResourceList-&gt;List[0].PartialResourceList.Count == 1);
08381 
08382     <span class="keywordflow">if</span> (ConflictList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || (ConflictListSize &lt; (<span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_LIST) - <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_ENTRY)) + <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_STRINGS))) {
08383         <span class="comment">//</span>
08384         <span class="comment">// sanity check</span>
08385         <span class="comment">//</span>
08386         status = STATUS_BUFFER_TOO_SMALL;
08387         <span class="keywordflow">goto</span> Clean0;
08388     }
08389     <span class="comment">//</span>
08390     <span class="comment">// whatever other error we return, ensure that ConflictList is interpretable</span>
08391     <span class="comment">//</span>
08392 
08393     ConflictList-&gt;ConflictsCounted = 0;
08394     ConflictList-&gt;ConflictsListed = 0;
08395     ConflictList-&gt;RequiredBufferSize = (<span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_LIST) - <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_ENTRY)) + <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_STRINGS);
08396 
08397     <span class="comment">//</span>
08398     <span class="comment">// Retrieve the devnode from the PDO</span>
08399     <span class="comment">//</span>
08400     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)PhysicalDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
08401     <span class="keywordflow">if</span> (!deviceNode) {
08402         status = STATUS_NO_SUCH_DEVICE;
08403         <span class="keywordflow">goto</span> Clean0;
08404     }
08405 
08406     <span class="comment">//</span>
08407     <span class="comment">// type-specific validation</span>
08408     <span class="comment">//</span>
08409     <span class="keywordflow">switch</span>(ResourceList-&gt;List[0].PartialResourceList.PartialDescriptors[0].Type) {
08410         <span class="keywordflow">case</span> CmResourceTypePort:
08411         <span class="keywordflow">case</span> CmResourceTypeMemory:
08412             <span class="keywordflow">if</span>(ResourceList-&gt;List[0].PartialResourceList.PartialDescriptors[0].u.Generic.Length == 0) {
08413                 <span class="comment">//</span>
08414                 <span class="comment">// zero-range resource can never conflict</span>
08415                 <span class="comment">//</span>
08416                 status = STATUS_SUCCESS;
08417                 <span class="keywordflow">goto</span> Clean0;
08418             }
08419             <span class="keywordflow">break</span>;
08420         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
08421         <span class="keywordflow">case</span> CmResourceTypeDma:
08422             <span class="keywordflow">break</span>;
08423         <span class="keywordflow">default</span>:
08424             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
08425             status = STATUS_INVALID_PARAMETER;
08426             <span class="keywordflow">goto</span> Clean0;
08427     }
08428 
08429     <span class="comment">//</span>
08430     <span class="comment">// apply bus details from node</span>
08431     <span class="comment">//</span>
08432     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o19">ChildInterfaceType</a> == InterfaceTypeUndefined) {
08433         <span class="comment">//</span>
08434         <span class="comment">// we have to grovel around to find real Interface Type</span>
08435         <span class="comment">//</span>
08436         pIoReqList = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>;
08437         <span class="keywordflow">if</span> (pIoReqList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pIoReqList-&gt;InterfaceType != InterfaceTypeUndefined) {
08438             ResourceList-&gt;List[0].InterfaceType = pIoReqList-&gt;InterfaceType;
08439         } <span class="keywordflow">else</span> {
08440             <span class="comment">//</span>
08441             <span class="comment">// BUGBUG!!! (jamiehun)</span>
08442             <span class="comment">// we should never get here</span>
08443             <span class="comment">// if we do, I need to look at this more</span>
08444             <span class="comment">//</span>
08445 <span class="preprocessor">#if MYDBG</span>
08446 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
08447 <span class="preprocessor">#endif</span>
08448 <span class="preprocessor"></span>            ResourceList-&gt;List[0].InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
08449         }
08450 
08451     } <span class="keywordflow">else</span> {
08452         <span class="comment">//</span>
08453         <span class="comment">// we trust the deviceNode to tell us Interface Type</span>
08454         <span class="comment">//</span>
08455         ResourceList-&gt;List[0].InterfaceType = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o19">ChildInterfaceType</a>;
08456     }
08457     <span class="comment">//</span>
08458     <span class="comment">// HACKHACK!!! (jamiehun) some bus-types we are better off considered as default</span>
08459     <span class="comment">//</span>
08460     <span class="keywordflow">switch</span>(ResourceList-&gt;List[0].InterfaceType) {
08461         <span class="keywordflow">case</span> InterfaceTypeUndefined:
08462         <span class="keywordflow">case</span> PCMCIABus:
08463             ResourceList-&gt;List[0].InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
08464     }
08465     <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o20">ChildBusNumber</a> &amp; 0x80000000) == 0x80000000) {
08466         <span class="comment">//</span>
08467         <span class="comment">// we have to grovel around to find real Bus Number</span>
08468         <span class="comment">//</span>
08469         pIoReqList = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>;
08470         <span class="keywordflow">if</span> (pIoReqList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (pIoReqList-&gt;BusNumber &amp; 0x80000000) != 0x80000000) {
08471             ResourceList-&gt;List[0].BusNumber = pIoReqList-&gt;BusNumber;
08472         } <span class="keywordflow">else</span> {
08473             <span class="comment">//</span>
08474             <span class="comment">// a resonable default, but assert is here so I remember to look at this more</span>
08475             <span class="comment">// BUGBUG!!! (jamiehun)</span>
08476             <span class="comment">//</span>
08477 <span class="preprocessor">#if MYDBG</span>
08478 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
08479 <span class="preprocessor">#endif</span>
08480 <span class="preprocessor"></span>            ResourceList-&gt;List[0].BusNumber = 0;
08481         }
08482 
08483     } <span class="keywordflow">else</span> {
08484         <span class="comment">//</span>
08485         <span class="comment">// we trust the deviceNode to tell us Bus Number</span>
08486         <span class="comment">//</span>
08487         ResourceList-&gt;List[0].BusNumber = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o20">ChildBusNumber</a>;
08488     }
08489 
08490     <span class="comment">//</span>
08491     <span class="comment">// from our CM Resource List, obtain an IO Resource Requirements List</span>
08492     <span class="comment">//</span>
08493     ioResources = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a>(0, ResourceList, LCPRI_FORCECONFIG);
08494     <span class="keywordflow">if</span> (!ioResources) {
08495         status = STATUS_INVALID_PARAMETER;
08496         <span class="keywordflow">goto</span> Clean0;
08497     }
08498     <span class="comment">//</span>
08499     <span class="comment">// Convert ioResources to a Request list</span>
08500     <span class="comment">// and in the processess, determine any Arbiters/Translators to use</span>
08501     <span class="comment">//</span>
08502     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a57">IopResourceRequirementsListToReqList</a>(
08503                     <a class="code" href="../../d6/d9/pnp_8h.html#a174a125">ArbiterRequestUndefined</a>,    <span class="comment">// BUGBUG!!! (jamiehun) better alternative???</span>
08504                     ioResources,
08505                     PhysicalDeviceObject,
08506                     &amp;reqList);
08507 
08508     <span class="comment">//</span>
08509     <span class="comment">// get arbitrator/translator for current device/bus</span>
08510     <span class="comment">//</span>
08511 
08512     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; reqList) {
08513 
08514         reqAlternative = reqList-&gt;ReqAlternativeTable;
08515         <a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a> = *reqAlternative;
08516         reqList-&gt;SelectedAlternative = reqAlternative;
08517 
08518         ReqDescCount = <a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a>-&gt;ReqDescCount;
08519         ReqDescTable = <a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a>-&gt;ReqDescTable;
08520 
08521         <span class="comment">//</span>
08522         <span class="comment">// we should have got only one descriptor, use only the first one</span>
08523         <span class="comment">//</span>
08524         <span class="keywordflow">if</span> (ReqDescCount&gt;0) {
08525 
08526             <span class="comment">//</span>
08527             <span class="comment">// get first descriptor &amp; it's arbitor</span>
08528             <span class="comment">//</span>
08529 
08530             reqDesc = *ReqDescTable;
08531             <span class="keywordflow">if</span> (reqDesc-&gt;ArbitrationRequired) {
08532                 reqDescTranslated = reqDesc-&gt;TranslatedReqDesc;  <span class="comment">// Could be reqDesc itself</span>
08533 
08534                 arbiterEntry = reqDesc-&gt;u.Arbiter;
08535                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(arbiterEntry);
08536                 <span class="comment">//</span>
08537                 <span class="comment">// the descriptor of interest - translated, first alternative in the table</span>
08538                 <span class="comment">//</span>
08539                 ConflictDesc = reqDescTranslated-&gt;AlternativeTable.Alternatives;
08540                 <span class="comment">//</span>
08541                 <span class="comment">// skip special descriptor</span>
08542                 <span class="comment">// to get to the actual descriptor</span>
08543                 <span class="comment">//</span>
08544                 <span class="keywordflow">if</span>(ConflictDesc-&gt;Type == CmResourceTypeConfigData || ConflictDesc-&gt;Type == <a class="code" href="../../d9/d0/pnpiop_8h.html#a74">CmResourceTypeReserved</a>)
08545                         ConflictDesc++;
08546 
08547                 <span class="comment">//</span>
08548                 <span class="comment">// finally we can call the arbiter to get a conflict list (returning PDO's and Global Address Ranges)</span>
08549                 <span class="comment">//</span>
08550                 ExtParams[0] = PhysicalDeviceObject;
08551                 ExtParams[1] = ConflictDesc;
08552                 ExtParams[2] = &amp;ConflictCount;
08553                 ExtParams[3] = &amp;ConflictInfoList;
08554                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry, <a class="code" href="../../d6/d9/pnp_8h.html#a173a121">ArbiterActionQueryConflict</a> , ExtParams, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> , <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
08555 
08556                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08557                     <span class="comment">//</span>
08558                     <span class="comment">// fill in user-memory buffer with conflict</span>
08559                     <span class="comment">//</span>
08560                     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a102">IopQueryConflictFillConflicts</a>(PhysicalDeviceObject,ConflictCount,ConflictInfoList,ConflictList,ConflictListSize,0);
08561                     <span class="keywordflow">if</span>(ConflictInfoList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08562                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ConflictInfoList);
08563                     }
08564                 }
08565                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == STATUS_RANGE_NOT_FOUND) {
08566                     <span class="comment">//</span>
08567                     <span class="comment">// fill in with flag indicating bad range (this means range is not available)</span>
08568                     <span class="comment">// ConflictInfoList should not be allocated</span>
08569                     <span class="comment">//</span>
08570                     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a102">IopQueryConflictFillConflicts</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,ConflictList,ConflictListSize,PNP_CE_TRANSLATE_FAILED);
08571                 }
08572 
08573             } <span class="keywordflow">else</span> {
08574 <span class="preprocessor">#if MYDBG</span>
08575 <span class="preprocessor"></span>                <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);                         <span class="comment">// For now</span>
08576 <span class="preprocessor">#endif</span>
08577 <span class="preprocessor"></span>                status = STATUS_INVALID_PARAMETER;  <span class="comment">// if we failed, it's prob because ResourceList was invalid</span>
08578             }
08579         } <span class="keywordflow">else</span> {
08580 <span class="preprocessor">#if MYDBG</span>
08581 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);                         <span class="comment">// For now</span>
08582 <span class="preprocessor">#endif</span>
08583 <span class="preprocessor"></span>            status = STATUS_INVALID_PARAMETER;  <span class="comment">// if we failed, it's prob because ResourceList was invalid</span>
08584         }
08585 
08586 <span class="preprocessor">#if DBG_SCOPE</span>
08587 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a26">STOP_ERROR</a>) {
08588             <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>);
08589         }
08590 <span class="preprocessor">#endif</span>
08591 <span class="preprocessor"></span>
08592         <a class="code" href="../../d5/d1/pnpres_8c.html#a63">IopFreeReqList</a>(reqList);
08593     } <span class="keywordflow">else</span> {
08594 <span class="preprocessor">#if MYDBG</span>
08595 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);                         <span class="comment">// For now</span>
08596 <span class="preprocessor">#endif</span>
08597 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08598             <span class="comment">//</span>
08599             <span class="comment">// it was NULL because we had a zero resource count, must be invalid parameter</span>
08600             <span class="comment">//</span>
08601             status = STATUS_INVALID_PARAMETER;
08602         }
08603 
08604     }
08605     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioResources);
08606 
08607     Clean0:
08608     ;
08609 
08610     <span class="keywordflow">return</span> status;
08611 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:22 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
