<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: thredini.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>thredini.c</h1><a href="../../d5/d1/i386_2thredini_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    thredini.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the machine dependent function to set the initial</span>
00012 <span class="comment">    context and data alignment handling mode for a process or thread object.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    David N. Cutler (davec) 31-Mar-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">    3 April 90  bryan willman</span>
00025 <span class="comment"></span>
00026 <span class="comment">        This version ported to 386.</span>
00027 <span class="comment"></span>
00028 <span class="comment">--*/</span>
00029 
00030 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00031 
00032 <span class="comment">//</span>
00033 <span class="comment">// The following assert macros are used to check that an input object is</span>
00034 <span class="comment">// really the proper type.</span>
00035 <span class="comment">//</span>
00036 
<a name="l00037"></a><a class="code" href="../../d5/d1/i386_2thredini_8c.html#a0">00037</a> <span class="preprocessor">#define ASSERT_PROCESS(E) {                    \</span>
00038 <span class="preprocessor">    ASSERT((E)-&gt;Header.Type == ProcessObject); \</span>
00039 <span class="preprocessor">}</span>
00040 <span class="preprocessor"></span>
<a name="l00041"></a><a class="code" href="../../d5/d1/i386_2thredini_8c.html#a1">00041</a> <span class="preprocessor">#define ASSERT_THREAD(E) {                    \</span>
00042 <span class="preprocessor">    ASSERT((E)-&gt;Header.Type == ThreadObject); \</span>
00043 <span class="preprocessor">}</span>
00044 <span class="preprocessor"></span>
00045 <span class="comment">//</span>
00046 <span class="comment">// Our notion of alignment is different, so force use of ours</span>
00047 <span class="comment">//</span>
00048 <span class="preprocessor">#undef  ALIGN_UP</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#undef  ALIGN_DOWN</span>
<a name="l00050"></a><a class="code" href="../../d5/d1/i386_2thredini_8c.html#a2">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define ALIGN_DOWN(address,amt) ((ULONG)(address) &amp; ~(( amt ) - 1))</span>
<a name="l00051"></a><a class="code" href="../../d5/d1/i386_2thredini_8c.html#a3">00051</a> <span class="preprocessor"></span><span class="preprocessor">#define ALIGN_UP(address,amt) (ALIGN_DOWN( (address + (amt) - 1), (amt) ))</span>
00052 <span class="preprocessor"></span>
00053 <span class="comment">//</span>
00054 <span class="comment">// The function prototype for the special APC we use to set the</span>
00055 <span class="comment">// hardware alignment state for a thread</span>
00056 <span class="comment">//</span>
00057 
00058 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00059 <a class="code" href="../../d5/d1/i386_2thredini_8c.html#a5">KepSetAlignmentSpecialApc</a>(
00060     IN <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc,
00061     IN PKNORMAL_ROUTINE *NormalRoutine,
00062     IN PVOID *NormalContext,
00063     IN PVOID *SystemArgument1,
00064     IN PVOID *SystemArgument2
00065     );
00066 
<a name="l00067"></a><a class="code" href="../../d5/d1/i386_2thredini_8c.html#a4">00067</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d9/d8/i386_2exceptn_8c.html#a9">KeI386XMMIPresent</a>;
00068 
00069 
00070 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00071"></a><a class="code" href="../../d0/d0/ki_8h.html#a117">00071</a> <a class="code" href="../../d8/d1/ppc_2thredini_8c.html#a2">KiInitializeContextThread</a> (
00072     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread,
00073     IN PKSYSTEM_ROUTINE SystemRoutine,
00074     IN PKSTART_ROUTINE StartRoutine OPTIONAL,
00075     IN PVOID StartContext OPTIONAL,
00076     IN PCONTEXT ContextFrame OPTIONAL
00077     )
00078 
00079 <span class="comment">/*++</span>
00080 <span class="comment"></span>
00081 <span class="comment">Routine Description:</span>
00082 <span class="comment"></span>
00083 <span class="comment">    This function initializes the machine dependent context of a thread object.</span>
00084 <span class="comment"></span>
00085 <span class="comment">    N.B. This function does not check the accessibility of the context record.</span>
00086 <span class="comment">         It is assumed the the caller of this routine is either prepared to</span>
00087 <span class="comment">         handle access violations or has probed and copied the context record</span>
00088 <span class="comment">         as appropriate.</span>
00089 <span class="comment"></span>
00090 <span class="comment">Arguments:</span>
00091 <span class="comment"></span>
00092 <span class="comment">    Thread - Supplies a pointer to a dispatcher object of type thread.</span>
00093 <span class="comment"></span>
00094 <span class="comment">    SystemRoutine - Supplies a pointer to the system function that is to be</span>
00095 <span class="comment">        called when the thread is first scheduled for execution.</span>
00096 <span class="comment"></span>
00097 <span class="comment">    StartRoutine - Supplies an optional pointer to a function that is to be</span>
00098 <span class="comment">        called after the system has finished initializing the thread. This</span>
00099 <span class="comment">        parameter is specified if the thread is a system thread and will</span>
00100 <span class="comment">        execute totally in kernel mode.</span>
00101 <span class="comment"></span>
00102 <span class="comment">    StartContext - Supplies an optional pointer to an arbitrary data structure</span>
00103 <span class="comment">        which will be passed to the StartRoutine as a parameter. This</span>
00104 <span class="comment">        parameter is specified if the thread is a system thread and will</span>
00105 <span class="comment">        execute totally in kernel mode.</span>
00106 <span class="comment"></span>
00107 <span class="comment">    ContextFrame - Supplies an optional pointer a context frame which contains</span>
00108 <span class="comment">        the initial user mode state of the thread. This parameter is specified</span>
00109 <span class="comment">        if the thread is a user thread and will execute in user mode. If this</span>
00110 <span class="comment">        parameter is not specified, then the Teb parameter is ignored.</span>
00111 <span class="comment"></span>
00112 <span class="comment">Return Value:</span>
00113 <span class="comment"></span>
00114 <span class="comment">    None.</span>
00115 <span class="comment"></span>
00116 <span class="comment">--*/</span>
00117 
00118 {
00119     PFX_SAVE_AREA NpxFrame;
00120     PKSWITCHFRAME SwitchFrame;
00121     PKTRAP_FRAME TrFrame;
00122     PULONG PSystemRoutine;
00123     PULONG PStartRoutine;
00124     PULONG PStartContext;
00125     PULONG PUserContextFlag;
00126     ULONG  ContextFlags;
00127     CONTEXT <a class="code" href="../../d3/d1/threads_8h.html#a108">Context2</a>;
00128     PCONTEXT ContextFrame2 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00129     PFXSAVE_FORMAT   PFxSaveArea;
00130 
00131     <span class="comment">//</span>
00132     <span class="comment">// If a context frame is specified, then initialize a trap frame and</span>
00133     <span class="comment">// and an exception frame with the specified user mode context.</span>
00134     <span class="comment">//</span>
00135 
00136     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ContextFrame)) {
00137 
00138         RtlMoveMemory(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a108">Context2</a>, ContextFrame, <span class="keyword">sizeof</span>(CONTEXT));
00139         ContextFrame2 = &amp;<a class="code" href="../../d3/d1/threads_8h.html#a108">Context2</a>;
00140         ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>;
00141 
00142         <span class="comment">//</span>
00143         <span class="comment">// The 80387 save area is at the very base of the kernel stack.</span>
00144         <span class="comment">//</span>
00145 
00146         NpxFrame = (PFX_SAVE_AREA)(((ULONG)(Thread-&gt;InitialStack) -
00147                     <span class="keyword">sizeof</span>(FX_SAVE_AREA)));
00148 
00149         <span class="comment">//</span>
00150         <span class="comment">// Load up an initial NPX state.</span>
00151         <span class="comment">//</span>
00152 
00153         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d8/i386_2exceptn_8c.html#a9">KeI386XMMIPresent</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00154             PFxSaveArea = (PFXSAVE_FORMAT)ContextFrame2-&gt;ExtendedRegisters;
00155     
00156             PFxSaveArea-&gt;ControlWord   = 0x27f;  <span class="comment">// like fpinit but 64bit mode</span>
00157             PFxSaveArea-&gt;StatusWord    = 0;
00158             PFxSaveArea-&gt;TagWord       = 0;
00159             PFxSaveArea-&gt;ErrorOffset   = 0;
00160             PFxSaveArea-&gt;ErrorSelector = 0;
00161             PFxSaveArea-&gt;DataOffset    = 0;
00162             PFxSaveArea-&gt;DataSelector  = 0;
00163             PFxSaveArea-&gt;MXCsr         = 0x1f80; <span class="comment">// mask all the exceptions</span>
00164         } <span class="keywordflow">else</span> {
00165             ContextFrame2-&gt;FloatSave.ControlWord   = 0x27f;  <span class="comment">// like fpinit but 64bit mode</span>
00166             ContextFrame2-&gt;FloatSave.StatusWord    = 0;
00167             ContextFrame2-&gt;FloatSave.TagWord       = 0xffff;
00168             ContextFrame2-&gt;FloatSave.ErrorOffset   = 0;
00169             ContextFrame2-&gt;FloatSave.ErrorSelector = 0;
00170             ContextFrame2-&gt;FloatSave.DataOffset    = 0;
00171             ContextFrame2-&gt;FloatSave.DataSelector  = 0;
00172         }
00173 
00174 
00175         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a>) {
00176             ContextFrame2-&gt;FloatSave.Cr0NpxState = 0;
00177             NpxFrame-&gt;Cr0NpxState = 0;
00178             NpxFrame-&gt;NpxSavedCpu = 0;
00179             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d8/i386_2exceptn_8c.html#a9">KeI386XMMIPresent</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00180                 ContextFlags |= CONTEXT_EXTENDED_REGISTERS;
00181             } <span class="keywordflow">else</span> {
00182                 ContextFlags |= <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>;
00183             }
00184 
00185             <span class="comment">//</span>
00186             <span class="comment">// Threads NPX state is not in the coprocessor.</span>
00187             <span class="comment">//</span>
00188 
00189             Thread-&gt;NpxState = NPX_STATE_NOT_LOADED;
00190             Thread-&gt;NpxIrql = <a class="code" href="../../d1/d3/ppcdef_8h.html#a21">PASSIVE_LEVEL</a>;
00191 
00192         } <span class="keywordflow">else</span> {
00193             NpxFrame-&gt;Cr0NpxState = CR0_EM;
00194 
00195             <span class="comment">//</span>
00196             <span class="comment">// Threads NPX state is not in the coprocessor.</span>
00197             <span class="comment">// In the emulator case, do not set the CR0_EM bit as their</span>
00198             <span class="comment">// emulators may not want exceptions on FWAIT instructions.</span>
00199             <span class="comment">//</span>
00200 
00201             Thread-&gt;NpxState = NPX_STATE_NOT_LOADED &amp; ~CR0_MP;
00202         }
00203 
00204         <span class="comment">//</span>
00205         <span class="comment">// Force debug registers off.  They won't work anyway from an</span>
00206         <span class="comment">// initial frame, debuggers must set a hard breakpoint in the target</span>
00207         <span class="comment">//</span>
00208 
00209         ContextFrame2-&gt;Dr0 = 0;
00210         ContextFrame2-&gt;Dr1 = 0;
00211         ContextFrame2-&gt;Dr2 = 0;
00212         ContextFrame2-&gt;Dr3 = 0;
00213         ContextFrame2-&gt;Dr6 = 0;
00214         ContextFrame2-&gt;Dr7 = 0;
00215         ContextFrame2-&gt;ContextFlags &amp;= ~(CONTEXT_DEBUG_REGISTERS);
00216 <span class="preprocessor">#if 0</span>
00217 <span class="preprocessor"></span>        <span class="comment">//</span>
00218         <span class="comment">// If AutoAlignment is FALSE, we want to set the Alignment Check bit</span>
00219         <span class="comment">// in Eflags, so we will get alignment faults.</span>
00220         <span class="comment">//</span>
00221 
00222         <span class="keywordflow">if</span> (Thread-&gt;AutoAlignment == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00223             ContextFrame2-&gt;EFlags |= EFLAGS_ALIGN_CHECK;
00224         }
00225 <span class="preprocessor">#endif</span>
00226 <span class="preprocessor"></span>        <span class="comment">//</span>
00227         <span class="comment">// If the thread is set</span>
00228 
00229         TrFrame = (PKTRAP_FRAME)(((ULONG)NpxFrame - KTRAP_FRAME_LENGTH));
00230 
00231         <span class="comment">//  Space for arguments to KiThreadStartup.  Order is important,</span>
00232         <span class="comment">//  Since args are passed on stack through KiThreadStartup to</span>
00233         <span class="comment">//  PStartRoutine with PStartContext as an argument.</span>
00234 
00235         PUserContextFlag = (PULONG)TrFrame - 1;
00236         PStartContext = PUserContextFlag - 1;
00237         PStartRoutine = PStartContext - 1;
00238         PSystemRoutine = PStartRoutine - 1;
00239 
00240         SwitchFrame = (PKSWITCHFRAME)((PUCHAR)PSystemRoutine -
00241                                     <span class="keyword">sizeof</span>(KSWITCHFRAME));
00242 
00243         <span class="comment">//</span>
00244         <span class="comment">// Copy information from the specified context frame to the trap and</span>
00245         <span class="comment">// exception frames.</span>
00246         <span class="comment">//</span>
00247 
00248         <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrFrame, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ContextFrame2,
00249                            ContextFrame2-&gt;ContextFlags | ContextFlags,
00250                            <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00251 
00252         TrFrame-&gt;HardwareSegSs |= RPL_MASK;
00253         TrFrame-&gt;SegDs |= RPL_MASK;
00254         TrFrame-&gt;SegEs |= RPL_MASK;
00255 
00256 <span class="preprocessor">#if DBG</span>
00257 <span class="preprocessor"></span>        TrFrame-&gt;DbgArgMark = 0xBADB0D00;
00258 <span class="preprocessor">#endif</span>
00259 <span class="preprocessor"></span>
00260         <span class="comment">//</span>
00261         <span class="comment">// Tell KiThreadStartup that a user context is present.</span>
00262         <span class="comment">//</span>
00263 
00264         *PUserContextFlag = 1;
00265 
00266 
00267         <span class="comment">//</span>
00268         <span class="comment">// Initialize the kernel mode ExceptionList pointer</span>
00269         <span class="comment">//</span>
00270 
00271         TrFrame-&gt;ExceptionList = EXCEPTION_CHAIN_END;
00272 
00273         <span class="comment">//</span>
00274         <span class="comment">// Initialize the saved previous processor mode.</span>
00275         <span class="comment">//</span>
00276 
00277         TrFrame-&gt;PreviousPreviousMode = <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>;
00278 
00279         <span class="comment">//</span>
00280         <span class="comment">// Set the previous mode in thread object to user.</span>
00281         <span class="comment">//</span>
00282 
00283         Thread-&gt;PreviousMode = <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>;
00284 
00285 
00286     } <span class="keywordflow">else</span> {
00287 
00288         <span class="comment">//</span>
00289         <span class="comment">// Dummy floating save area.  Kernel threads don't have or use</span>
00290         <span class="comment">// the floating point - the dummy save area is make the stacks</span>
00291         <span class="comment">// consistent.</span>
00292         <span class="comment">//</span>
00293 
00294         NpxFrame = (PFX_SAVE_AREA)(((ULONG)(Thread-&gt;InitialStack) -
00295                     <span class="keyword">sizeof</span>(FX_SAVE_AREA)));
00296 
00297         <span class="comment">//</span>
00298         <span class="comment">// Load up an initial NPX state.</span>
00299         <span class="comment">//</span>
00300         RtlZeroMemory((PVOID)NpxFrame, <span class="keyword">sizeof</span>(FX_SAVE_AREA));
00301 
00302         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a24">KeI386FxsrPresent</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00303             NpxFrame-&gt;U.FxArea.ControlWord = 0x27f;<span class="comment">//like fpinit but 64bit mode</span>
00304             NpxFrame-&gt;U.FxArea.MXCsr       = 0x1f80;<span class="comment">// mask all the exceptions</span>
00305         } <span class="keywordflow">else</span> {
00306             NpxFrame-&gt;U.FnArea.ControlWord  = 0x27f;<span class="comment">//like fpinit but 64bit mode</span>
00307             NpxFrame-&gt;U.FnArea.TagWord      = 0xffff;
00308         }
00309 
00310         <span class="comment">//</span>
00311         <span class="comment">// Threads NPX state is not in the coprocessor.</span>
00312         <span class="comment">//</span>
00313 
00314         Thread-&gt;NpxState = NPX_STATE_NOT_LOADED;
00315 
00316         <span class="comment">//</span>
00317         <span class="comment">//  Space for arguments to KiThreadStartup.</span>
00318         <span class="comment">//  Order of fields in the switchframe is important,</span>
00319         <span class="comment">//  Since args are passed on stack through KiThreadStartup to</span>
00320         <span class="comment">//  PStartRoutine with PStartContext as an argument.</span>
00321         <span class="comment">//</span>
00322 
00323         PUserContextFlag = (PULONG)((ULONG)NpxFrame) - 1;
00324 
00325         PStartContext = PUserContextFlag - 1;
00326         PStartRoutine = PStartContext - 1;
00327         PSystemRoutine = PStartRoutine - 1;
00328 
00329         SwitchFrame = (PKSWITCHFRAME)((PUCHAR)PSystemRoutine -
00330                                         <span class="keyword">sizeof</span>(KSWITCHFRAME));
00331 
00332 
00333         <span class="comment">//</span>
00334         <span class="comment">// Tell KiThreadStartup that a user context is NOT present.</span>
00335         <span class="comment">//</span>
00336 
00337         *PUserContextFlag = 0;
00338 
00339 
00340         <span class="comment">//</span>
00341         <span class="comment">// Set the previous mode in thread object to kernel.</span>
00342         <span class="comment">//</span>
00343 
00344         Thread-&gt;PreviousMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00345     }
00346 
00347     <span class="comment">//</span>
00348     <span class="comment">//  Set up thread start parameters.</span>
00349     <span class="comment">//  (UserContextFlag set above)</span>
00350     <span class="comment">//</span>
00351 
00352     *PStartContext = (ULONG)StartContext;
00353     *PStartRoutine = (ULONG)StartRoutine;
00354     *PSystemRoutine = (ULONG)SystemRoutine;
00355 
00356 
00357     <span class="comment">//</span>
00358     <span class="comment">//  Set up switch frame.  Assume the thread doesn't use the 80387;</span>
00359     <span class="comment">//  if it ever does (and there is one), these flags will get reset.</span>
00360     <span class="comment">//  Each thread starts with these same flags set, regardless of</span>
00361     <span class="comment">//  whether the hardware exists or not.</span>
00362     <span class="comment">//</span>
00363 
00364     SwitchFrame-&gt;RetAddr = (ULONG)<a class="code" href="../../d0/d0/ki_8h.html#a139">KiThreadStartup</a>;
00365 
00366     SwitchFrame-&gt;Eflags = EFLAGS_INTERRUPT_MASK;
00367 
00368 <span class="preprocessor">#if 0</span>
00369 <span class="preprocessor"></span>    <span class="comment">//</span>
00370     <span class="comment">// If AutoAlignment is FALSE, we want to set the Alignment Check bit</span>
00371     <span class="comment">// in Eflags, so we will get alignment faults.</span>
00372     <span class="comment">//</span>
00373 
00374     <span class="keywordflow">if</span> (Thread-&gt;AutoAlignment == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00375         SwitchFrame-&gt;Eflags |= EFLAGS_ALIGN_CHECK;
00376     }
00377 <span class="preprocessor">#endif</span>
00378 <span class="preprocessor"></span>
00379     SwitchFrame-&gt;ExceptionList = (ULONG)(EXCEPTION_CHAIN_END);
00380 
00381     <span class="comment">//</span>
00382     <span class="comment">// Set the initial kernel stack pointer.</span>
00383     <span class="comment">//</span>
00384 
00385 <span class="comment">//DbgPrint("KiInitializeContextThread Thread %08x  SwitchFrame %08x\n", Thread, SwitchFrame);</span>
00386 <span class="comment">//DbgPrint("PSystemRoutine %08x  PStartRoutine %08x  PStartContext %08x\n", *PSystemRoutine, *PStartRoutine, *PStartContext);</span>
00387 
00388     Thread-&gt;KernelStack = (PVOID)SwitchFrame;
00389     <span class="keywordflow">return</span>;
00390 }
00391 
00392 BOOLEAN
<a name="l00393"></a><a class="code" href="../../d5/d1/i386_2thredini_8c.html#a7">00393</a> <a class="code" href="../../d8/d1/ppc_2thredini_8c.html#a3">KeSetAutoAlignmentProcess</a> (
00394     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process,
00395     IN BOOLEAN Enable
00396     )
00397 
00398 <span class="comment">/*++</span>
00399 <span class="comment"></span>
00400 <span class="comment">Routine Description:</span>
00401 <span class="comment"></span>
00402 <span class="comment">    This function sets the data alignment handling mode for the specified</span>
00403 <span class="comment">    process and returns the previous data alignment handling mode.</span>
00404 <span class="comment"></span>
00405 <span class="comment">Arguments:</span>
00406 <span class="comment"></span>
00407 <span class="comment">    Process  - Supplies a pointer to a dispatcher object of type process.</span>
00408 <span class="comment"></span>
00409 <span class="comment">    Enable - Supplies a boolean value that determines the handling of data</span>
00410 <span class="comment">        alignment exceptions for the process. A value of TRUE causes all</span>
00411 <span class="comment">        data alignment exceptions to be automatically handled by the kernel.</span>
00412 <span class="comment">        A value of FALSE causes all data alignment exceptions to be actually</span>
00413 <span class="comment">        raised as exceptions.</span>
00414 <span class="comment"></span>
00415 <span class="comment">Return Value:</span>
00416 <span class="comment"></span>
00417 <span class="comment">    A value of TRUE is returned if data alignment exceptions were</span>
00418 <span class="comment">    previously automatically handled by the kernel. Otherwise, a value</span>
00419 <span class="comment">    of FALSE is returned.</span>
00420 <span class="comment"></span>
00421 <span class="comment">--*/</span>
00422 
00423 {
00424 
00425     KIRQL OldIrql;
00426     BOOLEAN Previous;
00427 
00428     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00429 
00430     <span class="comment">//</span>
00431     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00432     <span class="comment">//</span>
00433 
00434     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00435 
00436     <span class="comment">//</span>
00437     <span class="comment">// Capture the previous data alignment handling mode and set the</span>
00438     <span class="comment">// specified data alignment mode.</span>
00439     <span class="comment">//</span>
00440 
00441     Previous = Process-&gt;AutoAlignment;
00442     Process-&gt;AutoAlignment = Enable;
00443 
00444     <span class="comment">//</span>
00445     <span class="comment">// Unlock dispatcher database, lower IRQL to its previous value, and</span>
00446     <span class="comment">// return the previous data alignment mode.</span>
00447     <span class="comment">//</span>
00448 
00449     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00450     <span class="keywordflow">return</span> Previous;
00451 }
00452 
00453 BOOLEAN
<a name="l00454"></a><a class="code" href="../../d5/d1/i386_2thredini_8c.html#a8">00454</a> <a class="code" href="../../d8/d1/ppc_2thredini_8c.html#a4">KeSetAutoAlignmentThread</a> (
00455     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread,
00456     IN BOOLEAN Enable
00457     )
00458 
00459 <span class="comment">/*++</span>
00460 <span class="comment"></span>
00461 <span class="comment">Routine Description:</span>
00462 <span class="comment"></span>
00463 <span class="comment">    This function sets the data alignment handling mode for the specified</span>
00464 <span class="comment">    thread and returns the previous data alignment handling mode.</span>
00465 <span class="comment"></span>
00466 <span class="comment">Arguments:</span>
00467 <span class="comment"></span>
00468 <span class="comment">    Thread - Supplies a pointer to a dispatcher object of type thread.</span>
00469 <span class="comment"></span>
00470 <span class="comment">    Enable - Supplies a boolean value that determines the handling of data</span>
00471 <span class="comment">        alignment exceptions for the specified thread. A value of TRUE causes</span>
00472 <span class="comment">        all data alignment exceptions to be automatically handled by the kernel.</span>
00473 <span class="comment">        A value of FALSE causes all data alignment exceptions to be actually</span>
00474 <span class="comment">        raised as exceptions.</span>
00475 <span class="comment"></span>
00476 <span class="comment">Return Value:</span>
00477 <span class="comment"></span>
00478 <span class="comment">    A value of TRUE is returned if data alignment exceptions were</span>
00479 <span class="comment">    previously automatically handled by the kernel. Otherwise, a value</span>
00480 <span class="comment">    of FALSE is returned.</span>
00481 <span class="comment"></span>
00482 <span class="comment">--*/</span>
00483 
00484 {
00485 
00486     BOOLEAN Previous;
00487     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc;
00488     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00489     KIRQL OldIrql;
00490 
00491     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
00492 
00493     <span class="comment">//</span>
00494     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00495     <span class="comment">//</span>
00496 
00497     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00498 
00499     <span class="comment">//</span>
00500     <span class="comment">// Capture the previous data alignment handling mode and set the</span>
00501     <span class="comment">// specified data alignment mode.</span>
00502     <span class="comment">//</span>
00503 
00504     Previous = Thread-&gt;AutoAlignment;
00505     Thread-&gt;AutoAlignment = Enable;
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous value.</span>
00509     <span class="comment">//</span>
00510 
00511     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00512 
00513 <span class="preprocessor">#if 0</span>
00514 <span class="preprocessor"></span>    Apc = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>));
00515     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>));
00516 
00517     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00518 
00519     <span class="keywordflow">if</span> ( Thread == <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>() ) {
00520 
00521         Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a> = Thread;
00522         Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a> = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00523 
00524         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;Irql);
00525         <a class="code" href="../../d5/d1/i386_2thredini_8c.html#a5">KepSetAlignmentSpecialApc</a>( Apc, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00526                                    &amp;Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a>,
00527                                    &amp;Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a> );
00528         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(Irql);
00529     } <span class="keywordflow">else</span> {
00530         <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>( Apc,
00531                          Thread,
00532                          <a class="code" href="../../d4/d9/ke_8h.html#a403a183">CurrentApcEnvironment</a>,
00533                          <a class="code" href="../../d5/d1/i386_2thredini_8c.html#a5">KepSetAlignmentSpecialApc</a>,
00534                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00535                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00536                          <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00537                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00538 
00539         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>( Apc,
00540                                Thread,
00541                                <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
00542                                2 ) ) {
00543             <span class="comment">//</span>
00544             <span class="comment">// We couldn't queue the APC, so we will not be able to change</span>
00545             <span class="comment">// the AutoAlignment.  Update the thread object so that it</span>
00546             <span class="comment">// stays in sync with the hardware state.</span>
00547             <span class="comment">//</span>
00548 <span class="preprocessor">#if DBG</span>
00549 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeSetAutoAlignmentThread: unable to change thread's context\n"</span>);
00550 <span class="preprocessor">#endif</span>
00551 <span class="preprocessor"></span>            Thread-&gt;AutoAlignment = Previous;
00552         }
00553 
00554         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
00555                                <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00556                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00557                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00558                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00559     }
00560 
00561     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Apc);
00562     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>);
00563 <span class="preprocessor">#endif</span>
00564 <span class="preprocessor"></span>
00565     <span class="keywordflow">return</span>(Previous);
00566 }
00567 
00568 <span class="preprocessor">#if 0</span>
00569 <span class="preprocessor"></span>
00570 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00571 <a class="code" href="../../d5/d1/i386_2thredini_8c.html#a5">KepSetAlignmentSpecialApc</a>(
00572     IN <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc,
00573     IN PKNORMAL_ROUTINE *NormalRoutine,
00574     IN PVOID *NormalContext,
00575     IN PVOID *SystemArgument1,
00576     IN PVOID *SystemArgument2
00577     )
00578 
00579 <span class="comment">/*++</span>
00580 <span class="comment"></span>
00581 <span class="comment">Routine Description:</span>
00582 <span class="comment"></span>
00583 <span class="comment">    This function updates the alignment check bit of the current thread's</span>
00584 <span class="comment">    EFLAGS to reflect the AutoAlignment setting of the thread object.</span>
00585 <span class="comment"></span>
00586 <span class="comment">Arguments:</span>
00587 <span class="comment"></span>
00588 <span class="comment">    Apc - Supplies a pointer to the APC control object that caused entry</span>
00589 <span class="comment">          into this routine.</span>
00590 <span class="comment"></span>
00591 <span class="comment">    NormalRoutine - Supplies a pointer to a pointer to the normal routine</span>
00592 <span class="comment">        function that was specifed when the APC was initialized.</span>
00593 <span class="comment"></span>
00594 <span class="comment">    NormalContext - Supplies a pointer to a pointer to an arbitrary data</span>
00595 <span class="comment">        structure that was specified when the APC was initialized.</span>
00596 <span class="comment"></span>
00597 <span class="comment">    SystemArgument1 - Supplies a pointer to a PKTHREAD</span>
00598 <span class="comment"></span>
00599 <span class="comment">    SystemArgument2 - Supplies a pointer to a PKEVENT</span>
00600 <span class="comment"></span>
00601 <span class="comment">Return Value:</span>
00602 <span class="comment"></span>
00603 <span class="comment">    None.</span>
00604 <span class="comment"></span>
00605 <span class="comment">--*/</span>
00606 
00607 {
00608     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00609     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00610     PKTRAP_FRAME TrapFrame;
00611     CONTEXT ContextFrame;
00612 
00613     Thread = *(<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> *)SystemArgument1;
00614     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = *(<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> *)SystemArgument2;
00615 
00616     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Thread == <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>() );
00617 
00618     <span class="comment">//</span>
00619     <span class="comment">// Find the trap frame on the stack, so we can get the thread context</span>
00620     <span class="comment">//</span>
00621     TrapFrame = (PKTRAP_FRAME)((PUCHAR)Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a> -
00622                 <a class="code" href="../../d0/d9/ntosdef_8h.html#a4">ALIGN_UP</a>(<span class="keyword">sizeof</span>(KTRAP_FRAME),KTRAP_FRAME_ALIGN) -
00623                 <span class="keyword">sizeof</span>(FX_SAVE_AREA));
00624 
00625     ContextFrame.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>;
00626 
00627     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a>( TrapFrame,
00628                           NULL,
00629                           &amp;ContextFrame );
00630 
00631     <span class="comment">//</span>
00632     <span class="comment">// If AutoAlignment is TRUE, we want the processor to transparently fixup</span>
00633     <span class="comment">// all alignment faults, so we clear the Alignment Check bit.  If</span>
00634     <span class="comment">// AutoAlignment is FALSE, we set the bit, so 486 processors will</span>
00635     <span class="comment">// give us alignment faults.</span>
00636     <span class="comment">//</span>
00637 
00638     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o60">AutoAlignment</a>) {
00639         ContextFrame.EFlags &amp;= (~EFLAGS_ALIGN_CHECK);
00640     } <span class="keywordflow">else</span> {
00641         ContextFrame.EFlags |= EFLAGS_ALIGN_CHECK;
00642     }
00643 
00644     <span class="comment">//</span>
00645     <span class="comment">// Replace the modified EFlags in the trap frame.  When the thread returns</span>
00646     <span class="comment">// to user mode, it will be running with the new alignment setting.</span>
00647     <span class="comment">//</span>
00648 
00649     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>( TrapFrame,
00650                         NULL,
00651                         &amp;ContextFrame,
00652                         CONTEXT_CONTROL,
00653                         KeGetPreviousMode() );
00654 
00655     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(Event,0,FALSE);
00656 }
00657 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:58 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
