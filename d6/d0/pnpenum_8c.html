<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpenum.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpenum.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>
<code>#include &lt;<a class="el" href="../../d4/d7/setupblk_8h-source.html">setupblk.h</a>&gt;</code><br>

<p>
<a href="../../d7/d9/pnpenum_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d9/struct__DRIVER__LIST__ENTRY.html">_DRIVER_LIST_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/structQUERY__CONTEXT.html">QUERY_CONTEXT</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a0">ASSERT_INITED</a>(x)&nbsp;&nbsp;&nbsp;/* nothing */</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a1">DebugPrint</a>(level, x)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a2">DEVICE_PREFIX_STRING</a>&nbsp;&nbsp;&nbsp;TEXT("\\Device\\")</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a3">DOSDEVICES_PREFIX_STRING</a>&nbsp;&nbsp;&nbsp;TEXT("\\DosDevices\\")</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a4">INITIAL_INFOBUFFER_SIZE</a>&nbsp;&nbsp;&nbsp;sizeof(KEY_VALUE_FULL_INFORMATION) + 8*sizeof(WCHAR) + 255*sizeof(WCHAR)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a5">NUM_QUERIES</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d9/struct__DRIVER__LIST__ENTRY.html">_DRIVER_LIST_ENTRY</a> <br>
DRIVER_LIST_ENTRY *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a6">PDRIVER_LIST_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d6/d0/pnpenum_8c.html#a41">_ADD_DRIVER_STAGE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a7">ADD_DRIVER_STAGE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a8">PQUERY_CONTEXT</a></td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a41">_ADD_DRIVER_STAGE</a> { <br>
&nbsp;&nbsp;<a class="el" href="../../d6/d0/pnpenum_8c.html#a41a12">LowerDeviceFilters</a>, 
<a class="el" href="../../d6/d0/pnpenum_8c.html#a41a13">LowerClassFilters</a>, 
<a class="el" href="../../d6/d0/pnpenum_8c.html#a41a14">DeviceService</a>, 
<a class="el" href="../../d6/d0/pnpenum_8c.html#a41a15">UpperDeviceFilters</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="../../d6/d0/pnpenum_8c.html#a41a16">UpperClassFilters</a>, 
<a class="el" href="../../d6/d0/pnpenum_8c.html#a41a17">MaximumAddStage</a>
<br>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a18">IopBusCheck</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN BOOLEAN LoadDriver, IN BOOLEAN AsyncOk)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a19">IopDeviceActionWorker</a> (PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a20">IopEnumerateDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">PSTART_CONTEXT</a> StartContext, IN BOOLEAN AsyncOk)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a21">IopCallDriverAddDeviceQueryRoutine</a> (IN PWSTR <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, IN ULONG ValueType, IN PWCHAR ValueData, IN ULONG ValueLength, IN <a class="el" href="../../d6/d0/pnpenum_8c.html#a8">PQUERY_CONTEXT</a> Context, IN ULONG ServiceType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a22">IopProcessCriticalDeviceRoutine</a> (IN HANDLE hDevInstance, IN PBOOLEAN FoundMatch, IN PUNICODE_STRING ServiceName, IN PUNICODE_STRING ClassGuid, IN PUNICODE_STRING LowerFilters, IN PUNICODE_STRING UpperFilters)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a23">IopProcessCriticalDevice</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a24">IopProcessNewChildren</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">PSTART_CONTEXT</a> StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a25">IopProcessStartDevicesWorker</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, OUT PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a26">IopGetBusTypeGuidIndex</a> (IN LPGUID busTypeGuid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a27">IopFixupDeviceId</a> (PWCHAR DeviceId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a28">IopFixupIds</a> (IN PWCHAR Ids, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a29">IopGetRegistryDwordWithFallback</a> (IN PUNICODE_STRING valueName, IN HANDLE PrimaryKey, IN HANDLE SecondaryKey, IN OUT PULONG Value)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PSECURITY_DESCRIPTOR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a30">IopGetRegistrySecurityWithFallback</a> (IN PUNICODE_STRING valueName, IN HANDLE PrimaryKey, IN HANDLE SecondaryKey)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a31">IopChangeDeviceObjectFromRegistryProperties</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject, IN HANDLE DeviceClassPropKey, IN HANDLE DevicePropKey, IN BOOLEAN UsePdoCharacteristics)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a32">IopRequestDeviceAction</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL, IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a133">DEVICE_REQUEST_TYPE</a> RequestType, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> CompletionEvent OPTIONAL, IN PNTSTATUS CompletionStatus OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a33">IopProcessStartDevices</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">PSTART_CONTEXT</a> StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a34">IopStartAndEnumerateDevice</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">PSTART_CONTEXT</a> StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a35">IopProcessNewDeviceNode</a> (IN OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a36">IopCallDriverAddDevice</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN BOOLEAN LoadDriver, IN <a class="el" href="../../d8/d5/struct__ADD__CONTEXT.html">PADD_CONTEXT</a> Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a37">IopQueryDeviceCapabilities</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, OUT <a class="el" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a> Capabilities)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a38">IopProcessNewProfile</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a39">IopProcessNewProfileWorker</a> (IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a40">IopProcessNewProfileStateCallback</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN PVOID Context)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a9">PnpEnumDebugLevel</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a10">IopEnumerationInProgress</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/pnpenum_8c.html#a11">IopDeviceEnumerationWorkItem</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="pnpenum.c::ASSERT_INITED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_INITED          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">x&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;/* nothing */</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00069">69</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="pnpenum.c::DebugPrint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DebugPrint          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">level,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>x&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> (level &lt;= <a class="code" href="../../d6/d0/pnpenum_8c.html#a9">PnpEnumDebugLevel</a>) { \
        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> x;                  \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00169">169</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="pnpenum.c::DEVICE_PREFIX_STRING" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEVICE_PREFIX_STRING&nbsp;&nbsp;&nbsp;TEXT("\\Device\\")          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00203">203</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="pnpenum.c::DOSDEVICES_PREFIX_STRING" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DOSDEVICES_PREFIX_STRING&nbsp;&nbsp;&nbsp;TEXT("\\DosDevices\\")          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00204">204</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="pnpenum.c::INITIAL_INFOBUFFER_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define INITIAL_INFOBUFFER_SIZE&nbsp;&nbsp;&nbsp;sizeof(KEY_VALUE_FULL_INFORMATION) + 8*sizeof(WCHAR) + 255*sizeof(WCHAR)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04000">IopProcessCriticalDeviceRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="pnpenum.c::NUM_QUERIES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NUM_QUERIES&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04000">IopProcessCriticalDeviceRoutine()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a7" doxytag="pnpenum.c::ADD_DRIVER_STAGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d6/d0/pnpenum_8c.html#a41">_ADD_DRIVER_STAGE</a>  <a class="el" href="../../d6/d0/pnpenum_8c.html#a7">ADD_DRIVER_STAGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="pnpenum.c::PDRIVER_LIST_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d9/struct__DRIVER__LIST__ENTRY.html">_DRIVER_LIST_ENTRY</a> DRIVER_LIST_ENTRY* <a class="el" href="../../d6/d0/pnpenum_8c.html#a6">PDRIVER_LIST_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00033">33</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="pnpenum.c::PQUERY_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef   * <a class="el" href="../../d6/d0/pnpenum_8c.html#a8">PQUERY_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a41" doxytag="pnpenum.c::_ADD_DRIVER_STAGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d6/d0/pnpenum_8c.html#a41">_ADD_DRIVER_STAGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a41a12" doxytag="LowerDeviceFilters" ></a>LowerDeviceFilters</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a41a13" doxytag="LowerClassFilters" ></a>LowerClassFilters</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a41a14" doxytag="DeviceService" ></a>DeviceService</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a41a15" doxytag="UpperDeviceFilters" ></a>UpperDeviceFilters</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a41a16" doxytag="UpperClassFilters" ></a>UpperClassFilters</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a41a17" doxytag="MaximumAddStage" ></a>MaximumAddStage</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00040">40</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
<pre class="fragment"><div>00040                                {
00041     <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a12">LowerDeviceFilters</a>,
00042     <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a13">LowerClassFilters</a>,
00043     <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a14">DeviceService</a>,
00044     <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a15">UpperDeviceFilters</a>,
00045     <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a16">UpperClassFilters</a>,
00046     <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a17">MaximumAddStage</a>
00047 } <a class="code" href="../../d6/d0/pnpenum_8c.html#a7">ADD_DRIVER_STAGE</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a18" doxytag="pnpenum.c::IopBusCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopBusCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LoadDriver</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AsyncOk</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00728">728</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00684">_START_CONTEXT::AddContext</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00678">_ADD_CONTEXT::DriverStartType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00676">_ADD_CONTEXT::GroupsToStart</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00677">_ADD_CONTEXT::GroupToStartNext</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01185">IopProcessAssignResources()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00821">IopProcessStartDevices()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00682">_START_CONTEXT::LoadDriver</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00683">_START_CONTEXT::NewDevice</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00671">NO_MORE_GROUP</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>.
<p>
<pre class="fragment"><div>00736                    :
00737 
00738     This routine performs bus check operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device/bus.
00739 
00740 Arguments:
00741 
00742     DeviceObject - Supplies a pointer to a device object which will be enumerated.
00743 
00744     LoadDriver - Supplies a BOOLEAN value to indicate should a driver be loaded
00745                  to complete a enumeration.  If <span class="keyword">false</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration will stop
00746                  once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's controlling service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not loaded yet.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00747                  mainly <span class="keywordflow">for</span> boot device driver initialization.
00748 
00749     ParentLockOwned - Specifies <span class="keywordflow">if</span> caller already owns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's parent's lock.
00750 
00751     AsyncOk - Specifies can QueryDeviceRelation be done at Async way.
00752 
00753 Return Value:
00754 
00755     None.
00756 
00757 --*/
00758 
00759 {
00760     BOOLEAN newDevice;
00761     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode, parent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00762     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00763     <a class="code" href="../../d0/d6/struct__START__CONTEXT.html">START_CONTEXT</a> startContext;
00764 
00765     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00766 
00767     <span class="comment">//</span>
00768     <span class="comment">// First get a reference to the PDO to make sure it won't go away.</span>
00769     <span class="comment">//</span>
00770 
00771     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(DeviceObject);
00772     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00773 
00774     <span class="comment">//</span>
00775     <span class="comment">// Enumerate the specified device node.</span>
00776     <span class="comment">// If any new device node is found, its controlling driver is loaded and</span>
00777     <span class="comment">// its AddDevice entry is called.</span>
00778     <span class="comment">//</span>
00779 
00780     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o0">LoadDriver</a> = LoadDriver;
00781     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00782     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o0">GroupsToStart</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
00783     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o1">GroupToStartNext</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
00784     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o2">DriverStartType</a> = SERVICE_DEMAND_START;
00785 
00786     status = <a class="code" href="../../d6/d0/pnpenum_8c.html#a20">IopEnumerateDevice</a>( deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
00787                                  &amp;startContext,
00788                                  AsyncOk);
00789 
00790     <span class="keywordflow">if</span> (status != STATUS_PNP_RESTART_ENUMERATION) {
00791 
00792         <span class="keywordflow">do</span> {
00793 
00794             startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00795 
00796             <span class="comment">//</span>
00797             <span class="comment">// Process the whole device tree to assign resources to those devices who</span>
00798             <span class="comment">// have been successfully added to their drivers.</span>
00799             <span class="comment">//</span>
00800 
00801             newDevice = <a class="code" href="../../d9/d0/pnpiop_8h.html#a262">IopProcessAssignResources</a>(deviceNode, FALSE, TRUE);
00802 
00803             <span class="comment">//</span>
00804             <span class="comment">// Process the device subtree to start those devices who have been allocated</span>
00805             <span class="comment">// resources and waiting to be started.</span>
00806             <span class="comment">// Note, the IopProcessStartDevices routine may enumerate new devices.</span>
00807             <span class="comment">//</span>
00808 
00809             <a class="code" href="../../d9/d0/pnpiop_8h.html#a263">IopProcessStartDevices</a>(deviceNode, &amp;startContext);
00810             newDevice |= startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a>;
00811 
00812         } <span class="keywordflow">while</span> (newDevice);
00813     }
00814 
00815     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DeviceObject);
00816 
00817     <span class="keywordflow">return</span> status;
00818 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="pnpenum.c::IopCallDriverAddDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCallDriverAddDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LoadDriver</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d5/struct__ADD__CONTEXT.html">PADD_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">2525</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00069">ASSERT_INITED</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00147">ASSERTMSG</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00180">CmRegistryMachineSystemCurrentControlSetControlClass</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00052">DebugPrint</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d6/d0/pnpenum_8c.html#a41a14">DeviceService</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00493">DNF_LEGACY_DRIVER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01159">DO_DEVICE_INITIALIZING</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00089">DOE_BOTTOM_OF_FDO_STACK</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00088">DOE_DESIGNATED_FDO</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00090">DOE_RAW_FDO</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00044">InitSafeBootMode</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06786">IoGetAttachedDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09046">IopBootLog()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04759">IopChangeDeviceObjectFromRegistryProperties()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00831">IopClearDevNodeProblem</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01870">IopDeviceNodeFlagsToCapabilities</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02793">IopQueryLegacyBusInformation()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">IopRequestDeviceRemoval()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08822">IopSafebootDriverLoad()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d0/pnpenum_8c.html#a41a13">LowerClassFilters</a>, <a class="el" href="../../d6/d0/pnpenum_8c.html#a41a12">LowerDeviceFilters</a>, <a class="el" href="../../d6/d0/pnpenum_8c.html#a41a17">MaximumAddStage</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00037">_DRIVER_LIST_ENTRY::NextEntry</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00615">OK_TO_ADD_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00590">PDRIVER_ADD_DEVICE</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00033">PDRIVER_LIST_ENTRY</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l00744">RtlQueryRegistryValues()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d0/pnpenum_8c.html#a41a16">UpperClassFilters</a>, and <a class="el" href="../../d6/d0/pnpenum_8c.html#a41a15">UpperDeviceFilters</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00166">IopAddDevicesToBootDriverWorker()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01117">IopProcessAddDevicesWorker()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01488">IopProcessNewChildren()</a>.
<p>
<pre class="fragment"><div>02533                    :
02534 
02535     This function checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceNode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present and loads
02536     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <span class="keywordflow">if</span> necessary.
02537 
02538 Arguments:
02539 
02540     DeviceNode - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node to be enumerated.
02541 
02542     LoadDriver - Supplies a BOOLEAN value to indicate should a driver be loaded
02543                  to complete enumeration.
02544 
02545     Context - Supplies a pointer to <a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html">ADD_CONTEXT</a> to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> how <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device be added.
02546 
02547 Return Value:
02548 
02549     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
02550 
02551 --*/
02552 
02553 {
02554     HANDLE enumKey;
02555     HANDLE instanceKey;
02556     HANDLE classKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02557     HANDLE classPropsKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02558     PKEY_VALUE_FULL_INFORMATION keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02559     RTL_QUERY_REGISTRY_TABLE queryTable[3];
02560     <a class="code" href="../../d4/d6/structQUERY__CONTEXT.html">QUERY_CONTEXT</a> queryContext;
02561     BOOLEAN deviceRaw = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02562     BOOLEAN usePdoCharacteristics = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02563     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02564     <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a> capabilities;
02565     ULONG index;
02566     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
02567 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
02568 <span class="preprocessor"></span>    <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> fdoDeviceObject, topOfPdoStack, topOfLowerFilterStack;
02569     BOOLEAN deviceObjectHasBeenAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02570 <span class="preprocessor">#endif</span>
02571 <span class="preprocessor"></span>
02572     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: Processing devnode %#08lx\n"</span>,
02573                    DeviceNode));
02574 
02575     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: DevNode flags going in = %#08lx\n"</span>,
02576                    DeviceNode-&gt;Flags));
02577 
02578     <span class="comment">//</span>
02579     <span class="comment">// The device node may have been started at this point.  This is because</span>
02580     <span class="comment">// some ill-behaved miniport drivers call IopReportedDetectedDevice at</span>
02581     <span class="comment">// DriverEntry for the devices which we already know about.</span>
02582     <span class="comment">//</span>
02583 
02584     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a42">OK_TO_ADD_DEVICE</a>(DeviceNode)) {
02585         <span class="keywordflow">return</span> STATUS_SUCCESS;
02586     }
02587 
02588     <a class="code" href="../../d6/d0/pnpenum_8c.html#a0">ASSERT_INITED</a>(DeviceNode-&gt;PhysicalDeviceObject);
02589 
02590     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t%s load driver\n"</span>,
02591                    (LoadDriver ? <span class="stringliteral">"Will"</span> : <span class="stringliteral">"Won't"</span>)));
02592 
02593     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\tOpening registry key %wZ\n"</span>,
02594                    &amp;DeviceNode-&gt;InstancePath));
02595 
02596     <span class="comment">//</span>
02597     <span class="comment">// Open the HKLM\System\CCS\Enum key.</span>
02598     <span class="comment">//</span>
02599 
02600     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumKey,
02601                                    NULL,
02602                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
02603                                    KEY_READ
02604                                    );
02605 
02606     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02607         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\tUnable to open "</span>
02608                        <span class="stringliteral">"HKLM\\SYSTEM\\CCS\\ENUM\n"</span>));
02609         <span class="keywordflow">return</span> status;
02610     }
02611 
02612     <span class="comment">//</span>
02613     <span class="comment">// Open the instance key for this devnode</span>
02614     <span class="comment">//</span>
02615 
02616     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;instanceKey,
02617                                    enumKey,
02618                                    &amp;DeviceNode-&gt;InstancePath,
02619                                    KEY_READ
02620                                    );
02621 
02622     ZwClose(enumKey);
02623 
02624     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02625 
02626         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\tError %#08lx opening enum key\n"</span>,
02627                     status));
02628         <span class="keywordflow">return</span> status;
02629     }
02630 
02631     <span class="comment">//</span>
02632     <span class="comment">// Get the class value to locate the class key for this devnode</span>
02633     <span class="comment">//</span>
02634 
02635     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(instanceKey,
02636                                  REGSTR_VALUE_CLASSGUID,
02637                                  &amp;keyValueInformation);
02638 
02639     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; ((keyValueInformation-&gt;Type == REG_SZ) &amp;&amp;
02640                               (keyValueInformation-&gt;DataLength != 0))) {
02641 
02642         HANDLE controlKey;
02643         UNICODE_STRING unicodeClassGuid;
02644 
02645         <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(
02646             &amp;unicodeClassGuid,
02647             (PWSTR) <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
02648             keyValueInformation-&gt;DataLength);
02649 
02650         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\tClass GUID is %wZ\n"</span>,
02651                        &amp;unicodeClassGuid));
02652 
02653         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/init_8h.html#a18">InitSafeBootMode</a>) {
02654             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a223">IopSafebootDriverLoad</a>(&amp;unicodeClassGuid)) {
02655                 PKEY_VALUE_FULL_INFORMATION ClassValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02656                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> s;
02657 
02658                 <span class="comment">//</span>
02659                 <span class="comment">// don't load the driver</span>
02660                 <span class="comment">//</span>
02661                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SAFEBOOT: skipping device = %wZ\n"</span>,&amp;unicodeClassGuid);
02662                 s = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(instanceKey,
02663                                         REGSTR_VAL_DEVDESC,
02664                                         &amp;ClassValueInformation);
02665                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(s)) {
02666                     UNICODE_STRING ClassString;
02667 
02668                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ClassString, (PCWSTR) <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(ClassValueInformation));
02669 
02670                     <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;ClassString, FALSE);
02671                 } <span class="keywordflow">else</span> {
02672                     <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;unicodeClassGuid, FALSE);
02673                 }
02674                 <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02675             }
02676         }
02677 
02678         <span class="comment">//</span>
02679         <span class="comment">// Open the class key</span>
02680         <span class="comment">//</span>
02681 
02682         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;controlKey,
02683                                        NULL,
02684                                        &amp;CmRegistryMachineSystemCurrentControlSetControlClass,
02685                                        KEY_READ
02686                                        );
02687 
02688         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02689 
02690             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\tUnable to open "</span>
02691                         <span class="stringliteral">"HKLM\\SYSTEM\\CCS\\CONTROL\\CLASS - %#08lx\n"</span>,
02692                         status));
02693             classKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02694         } <span class="keywordflow">else</span> {
02695 
02696             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;classKey,
02697                                            controlKey,
02698                                            &amp;unicodeClassGuid,
02699                                            KEY_READ
02700                                            );
02701 
02702             ZwClose(controlKey);
02703 
02704             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02705 
02706                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\tUnable to open GUID key "</span>
02707                             <span class="stringliteral">"%wZ - %#08lx\n"</span>,
02708                             &amp;unicodeClassGuid,
02709                             status));
02710 
02711                 classKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02712             }
02713         }
02714 
02715         <span class="keywordflow">if</span> (classKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02716 
02717             UNICODE_STRING unicodeProperties;
02718 
02719             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeProperties, REGSTR_KEY_DEVICE_PROPERTIES );
02720 
02721             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;classPropsKey,
02722                                            classKey,
02723                                            &amp;unicodeProperties,
02724                                            KEY_READ
02725                                            );
02726 
02727             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02728 
02729                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(2, (<span class="stringliteral">"IopCallDriverAddDevice:\tUnable to open GUID\\Properties key "</span>
02730                             <span class="stringliteral">"%wZ - %#08lx\n"</span>,
02731                             &amp;unicodeClassGuid,
02732                             status));
02733 
02734                 classPropsKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02735             }
02736         }
02737 
02738         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
02739         keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02740 
02741     }
02742 
02743     <span class="comment">//</span>
02744     <span class="comment">// Check to see if there's a service assigned to this device node.  If</span>
02745     <span class="comment">// there's not then we can bail out without wasting too much time.</span>
02746     <span class="comment">//</span>
02747 
02748     RtlZeroMemory(&amp;queryContext, <span class="keyword">sizeof</span>(queryContext));
02749 
02750     queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o0">DeviceNode</a> = DeviceNode;
02751     queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o1">LoadDriver</a> = LoadDriver;
02752 
02753     queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o2">AddContext</a> = Context;
02754 
02755     RtlZeroMemory(queryTable, <span class="keyword">sizeof</span>(queryTable));
02756 
02757     queryTable[0].QueryRoutine =
02758         (PRTL_QUERY_REGISTRY_ROUTINE) <a class="code" href="../../d6/d0/pnpenum_8c.html#a21">IopCallDriverAddDeviceQueryRoutine</a>;
02759     queryTable[0].Name = REGSTR_VAL_LOWERFILTERS;
02760     queryTable[0].EntryContext = (PVOID) UIntToPtr(LowerDeviceFilters);
02761 
02762     status = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_HANDLE,
02763                                     (PWSTR) instanceKey,
02764                                     queryTable,
02765                                     &amp;queryContext,
02766                                     NULL);
02767     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02768 
02769         <span class="keywordflow">if</span> (classKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02770 
02771             queryTable[0].QueryRoutine =
02772                 (PRTL_QUERY_REGISTRY_ROUTINE) <a class="code" href="../../d6/d0/pnpenum_8c.html#a21">IopCallDriverAddDeviceQueryRoutine</a>;
02773             queryTable[0].Name = REGSTR_VAL_LOWERFILTERS;
02774             queryTable[0].EntryContext = (PVOID) UIntToPtr(LowerClassFilters);
02775             status = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_HANDLE,
02776                                             (PWSTR) classKey,
02777                                             queryTable,
02778                                             &amp;queryContext,
02779                                             NULL);
02780         }
02781 
02782         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02783             queryTable[0].QueryRoutine = (PRTL_QUERY_REGISTRY_ROUTINE) <a class="code" href="../../d6/d0/pnpenum_8c.html#a21">IopCallDriverAddDeviceQueryRoutine</a>;
02784             queryTable[0].Name = REGSTR_VALUE_SERVICE;
02785             queryTable[0].EntryContext = (PVOID) UIntToPtr(DeviceService);
02786             queryTable[0].Flags = RTL_QUERY_REGISTRY_REQUIRED;
02787 
02788             status = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_HANDLE,
02789                                             (PWSTR) instanceKey,
02790                                             queryTable,
02791                                             &amp;queryContext,
02792                                             NULL);
02793         }
02794     }
02795 
02796     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a>) {
02797 
02798         <span class="comment">//</span>
02799         <span class="comment">// One of the services for this device is a legacy driver.  Don't try</span>
02800         <span class="comment">// to add any filters since we'll just screw up the device stack.</span>
02801         <span class="comment">//</span>
02802 
02803         status = STATUS_SUCCESS;
02804         <span class="keywordflow">goto</span> Cleanup;
02805 
02806     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02807 
02808         <span class="comment">//</span>
02809         <span class="comment">// Call was successful so we must have been able to reference the</span>
02810         <span class="comment">// driver object.</span>
02811         <span class="comment">//</span>
02812 
02813         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[DeviceService] != NULL);
02814 
02815         <span class="keywordflow">if</span> (queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[<a class="code" href="../../d6/d0/pnpenum_8c.html#a41a14">DeviceService</a>]-&gt;NextEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02816 
02817             <span class="comment">//</span>
02818             <span class="comment">// There's more than one service assigned to this device.  Configuration</span>
02819             <span class="comment">// error</span>
02820 
02821             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: Configuration Error - more "</span>
02822                         <span class="stringliteral">"than one service in driver list\n"</span>));
02823 
02824             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_REGISTRY);
02825 
02826             status = STATUS_UNSUCCESSFUL;
02827 
02828             <span class="keywordflow">goto</span> Cleanup;
02829         }
02830         <span class="comment">//</span>
02831         <span class="comment">// this is the only case (FDO specified) where we can ignore PDO's characteristics</span>
02832         <span class="comment">//</span>
02833         usePdoCharacteristics = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02834 
02835     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
02836 
02837         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice\t\tError %#08lx reading service "</span>
02838                        <span class="stringliteral">"value for devnode %#08lx\n"</span>, status, DeviceNode));
02839 
02840         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a101">IopDeviceNodeFlagsToCapabilities</a>(DeviceNode)-&gt;RawDeviceOK) {
02841 
02842             <span class="comment">//</span>
02843             <span class="comment">// The device cannot be used raw.  Bail out now.</span>
02844             <span class="comment">//</span>
02845 
02846             status = STATUS_UNSUCCESSFUL;
02847             <span class="keywordflow">goto</span> Cleanup;
02848 
02849         } <span class="keywordflow">else</span> {
02850 
02851             <span class="comment">//</span>
02852             <span class="comment">// Raw device access is okay.</span>
02853             <span class="comment">//</span>
02854 
02855             <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(DeviceNode);
02856 
02857             usePdoCharacteristics = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; <span class="comment">// shouldn't need to do this, but better be safe than sorry</span>
02858             deviceRaw = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02859             status = STATUS_SUCCESS;
02860 
02861         }
02862 
02863     } <span class="keywordflow">else</span> {
02864 
02865         <span class="comment">//</span>
02866         <span class="comment">// something else went wrong while parsing the service key.  The</span>
02867         <span class="comment">// query routine will have set the flags appropriately so we can</span>
02868         <span class="comment">// just bail out.</span>
02869         <span class="comment">//</span>
02870 
02871         <span class="keywordflow">goto</span> Cleanup;
02872 
02873     }
02874 
02875     <span class="comment">//</span>
02876     <span class="comment">// For each type of filter driver we want to build a list of the driver</span>
02877     <span class="comment">// objects to be loaded.  We'll build all the driver lists if we can</span>
02878     <span class="comment">// and deal with error conditions afterwards.</span>
02879     <span class="comment">//</span>
02880 
02881      <span class="comment">//</span>
02882      <span class="comment">// First get all the information we have to out of the instance key and</span>
02883      <span class="comment">// the device node.</span>
02884      <span class="comment">//</span>
02885 
02886      RtlZeroMemory(queryTable, <span class="keyword">sizeof</span>(queryTable));
02887 
02888      queryTable[0].QueryRoutine =
02889          (PRTL_QUERY_REGISTRY_ROUTINE) <a class="code" href="../../d6/d0/pnpenum_8c.html#a21">IopCallDriverAddDeviceQueryRoutine</a>;
02890      queryTable[0].Name = REGSTR_VAL_UPPERFILTERS;
02891      queryTable[0].EntryContext = (PVOID) UIntToPtr(UpperDeviceFilters);
02892      status = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_HANDLE,
02893                                      (PWSTR) instanceKey,
02894                                      queryTable,
02895                                      &amp;queryContext,
02896                                      NULL);
02897 
02898      <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; classKey) {
02899          queryTable[0].QueryRoutine =
02900              (PRTL_QUERY_REGISTRY_ROUTINE) <a class="code" href="../../d6/d0/pnpenum_8c.html#a21">IopCallDriverAddDeviceQueryRoutine</a>;
02901          queryTable[0].Name = REGSTR_VAL_UPPERFILTERS;
02902          queryTable[0].EntryContext = (PVOID) UIntToPtr(UpperClassFilters);
02903 
02904          status = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_HANDLE,
02905                                          (PWSTR) classKey,
02906                                          queryTable,
02907                                          &amp;queryContext,
02908                                          NULL);
02909     }
02910 
02911     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02912 
02913         UCHAR serviceType = 0;
02914         <a class="code" href="../../d6/d0/pnpenum_8c.html#a6">PDRIVER_LIST_ENTRY</a> listEntry = queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[serviceType];
02915 
02916         <span class="comment">//</span>
02917         <span class="comment">// Make sure there's no more than one device service.  Anything else is</span>
02918         <span class="comment">// a configuration error.</span>
02919         <span class="comment">//</span>
02920 
02921         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(DeviceNode-&gt;Flags &amp; DNF_LEGACY_DRIVER));
02922         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(DeviceNode-&gt;Flags &amp; DNF_ADDED));
02923 
02924         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(
02925             <span class="stringliteral">"Error - Device has no service but cannot be run RAW\n"</span>,
02926             ((queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[DeviceService] != NULL) || (deviceRaw)));
02927 
02928 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
02929 <span class="preprocessor"></span>        <span class="comment">//</span>
02930         <span class="comment">// Grab the top of PDO stack</span>
02931         <span class="comment">//</span>
02932         topOfPdoStack = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(DeviceNode-&gt;PhysicalDeviceObject);
02933 <span class="preprocessor">#endif</span>
02934 <span class="preprocessor"></span>
02935         <span class="comment">//</span>
02936         <span class="comment">// It's okay to try adding all the drivers.</span>
02937         <span class="comment">//</span>
02938         <span class="keywordflow">for</span> (serviceType = 0; serviceType &lt; <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a17">MaximumAddStage</a>; serviceType++) {
02939 
02940             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: Adding Services (type %d)\n"</span>,
02941                         serviceType));
02942 
02943             <span class="keywordflow">if</span> (serviceType == <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a14">DeviceService</a>) {
02944 
02945                 <span class="keywordflow">if</span> (deviceRaw&amp;&amp;(queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[serviceType]==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02946 
02947                     <span class="comment">//</span>
02948                     <span class="comment">// Mark the devnode as added, as it has no service.</span>
02949                     <span class="comment">//</span>
02950 
02951                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[serviceType] == NULL);
02952                     DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>;
02953 
02954 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
02955 <span class="preprocessor"></span>                    <span class="comment">//</span>
02956                     <span class="comment">// For the purpose of asserting IRPs, we mark the FDO. We</span>
02957                     <span class="comment">// don't mark a raw PDO as the BOTTOM of the FDO stack as</span>
02958                     <span class="comment">// that would be the lower filter in this case.</span>
02959                     <span class="comment">//</span>
02960                     DeviceNode-&gt;PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags |=
02961                         <a class="code" href="../../d9/d4/trackirp_8h.html#a41">DOE_DESIGNATED_FDO</a> | <a class="code" href="../../d9/d4/trackirp_8h.html#a43">DOE_RAW_FDO</a>;
02962 
02963                 } <span class="keywordflow">else</span> {
02964 
02965                     <span class="comment">//</span>
02966                     <span class="comment">// Since we are going to see a service, grab a pointer to</span>
02967                     <span class="comment">// the current top of the stack. While here, assert there</span>
02968                     <span class="comment">// is exactly one service driver to load...</span>
02969                     <span class="comment">//</span>
02970                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[serviceType]);
02971                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[serviceType]-&gt;NextEntry);
02972                     topOfLowerFilterStack = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(DeviceNode-&gt;PhysicalDeviceObject);
02973 <span class="preprocessor">#endif</span>
02974 <span class="preprocessor"></span>                }
02975             }
02976 
02977             <span class="keywordflow">for</span> (listEntry = queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[serviceType];
02978                 listEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02979                 listEntry = listEntry-&gt;NextEntry) {
02980 
02981                 <a class="code" href="../../d0/d5/io_8h.html#a290">PDRIVER_ADD_DEVICE</a> addDeviceRoutine;
02982 
02983                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\tAdding driver %#08lx\n"</span>,
02984                             listEntry-&gt;DriverObject));
02985 
02986                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(listEntry-&gt;DriverObject);
02987                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(listEntry-&gt;DriverObject-&gt;DriverExtension);
02988                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(listEntry-&gt;DriverObject-&gt;DriverExtension-&gt;AddDevice);
02989 
02990                 <span class="comment">//</span>
02991                 <span class="comment">// Invoke the driver's AddDevice() entry point.</span>
02992                 <span class="comment">//</span>
02993                 addDeviceRoutine =
02994                     listEntry-&gt;DriverObject-&gt;DriverExtension-&gt;AddDevice;
02995 
02996                 status = (addDeviceRoutine)(listEntry-&gt;DriverObject,
02997                                             DeviceNode-&gt;PhysicalDeviceObject);
02998 
02999                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\tRoutine returned "</span>
03000                             <span class="stringliteral">"%#08lx\n"</span>, status));
03001 
03002                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03003 
03004 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
03005 <span class="preprocessor"></span>                   <span class="keywordflow">if</span> (!deviceObjectHasBeenAttached) {
03006 
03007                        <span class="comment">//</span>
03008                        <span class="comment">// Mark the first driver loaded by this routine as the</span>
03009                        <span class="comment">// bottom of the FDO stack. These must detach on a remove.</span>
03010                        <span class="comment">// Note we can't simply flag the top of the stack, as</span>
03011                        <span class="comment">// someone might attach in AddDevice...</span>
03012                        <span class="comment">//</span>
03013                        fdoDeviceObject = topOfPdoStack-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
03014                        <span class="keywordflow">if</span> (fdoDeviceObject) {
03015 
03016                           fdoDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a42">DOE_BOTTOM_OF_FDO_STACK</a>;
03017                           deviceObjectHasBeenAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03018                        }
03019                    }
03020 
03021                    <span class="comment">//</span>
03022                    <span class="comment">// Also note it is legal for a filter to succeed AddDevice</span>
03023                    <span class="comment">// but fail to attach anything to the top of the stack.</span>
03024                    <span class="comment">//</span>
03025                    <span class="keywordflow">if</span> (serviceType == <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a14">DeviceService</a>) {
03026 
03027                        <span class="comment">//</span>
03028                        <span class="comment">// ADRIAO BUGBUG 10/07/98 - Since we are temporarily</span>
03029                        <span class="comment">// letting successful but Noop'd AddDevice's through,</span>
03030                        <span class="comment">// mark the stack appropriately. We will make it look</span>
03031                        <span class="comment">// like a RAW FDO</span>
03032                        <span class="comment">//</span>
03033                        fdoDeviceObject = topOfLowerFilterStack-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
03034 
03035                        <span class="comment">//ASSERT(fdoDeviceObject != NULL);</span>
03036 
03037                        <span class="keywordflow">if</span> (!fdoDeviceObject) {
03038 
03039                            <span class="comment">//</span>
03040                            <span class="comment">// Nope, didn't get an FDO. Mark the PDO raw.</span>
03041                            <span class="comment">// ADRIAO BUGBUG 10/07/98 -</span>
03042                            <span class="comment">//      Another reason to complain about the legality</span>
03043                            <span class="comment">// of succeeding a FDO AddDevice without attaching</span>
03044                            <span class="comment">// anything - how does the PDO know he also has to</span>
03045                            <span class="comment">// respond as an FDO????</span>
03046                            <span class="comment">//</span>
03047                            fdoDeviceObject = DeviceNode-&gt;PhysicalDeviceObject;
03048                            fdoDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a43">DOE_RAW_FDO</a>;
03049                        }
03050 
03051                        <span class="comment">//</span>
03052                        <span class="comment">// Mark appropriate node "FDO".</span>
03053                        <span class="comment">//</span>
03054                        fdoDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a41">DOE_DESIGNATED_FDO</a>;
03055                    }
03056 <span class="preprocessor">#endif</span>
03057 <span class="preprocessor"></span>
03058                    DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>;
03059                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (serviceType == <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a14">DeviceService</a>) {
03060 
03061                     <span class="comment">//</span>
03062                     <span class="comment">// If filter drivers return failure, keep going.</span>
03063                     <span class="comment">//</span>
03064 
03065                     DeviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>;
03066                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_FAILED_ADD);
03067                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(DeviceNode-&gt;PhysicalDeviceObject, CM_PROB_FAILED_ADD);
03068                     <span class="keywordflow">goto</span> Cleanup;
03069                 }
03070 
03071                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(DeviceNode-&gt;PhysicalDeviceObject)-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a128">DO_DEVICE_INITIALIZING</a>) {
03072                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"***************** DO_DEVICE_INITIALIZING not cleared on %#08lx\n"</span>,
03073                                 <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(DeviceNode-&gt;PhysicalDeviceObject)));
03074                 }
03075 
03076                 <a class="code" href="../../d6/d0/pnpenum_8c.html#a0">ASSERT_INITED</a>(<a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(DeviceNode-&gt;PhysicalDeviceObject));
03077             }
03078         }
03079 
03080         <span class="comment">//</span>
03081         <span class="comment">// change PDO and all attached objects</span>
03082         <span class="comment">// to have properties specified in the registry</span>
03083         <span class="comment">//</span>
03084 
03085         <a class="code" href="../../d6/d0/pnpenum_8c.html#a31">IopChangeDeviceObjectFromRegistryProperties</a>(DeviceNode-&gt;PhysicalDeviceObject, classPropsKey, instanceKey, usePdoCharacteristics);
03086 
03087         <span class="comment">//</span>
03088         <span class="comment">// CapabilityFlags are refreshed with call to IopDeviceCapabilitiesToRegistry after device is started</span>
03089         <span class="comment">//</span>
03090 
03091     } <span class="keywordflow">else</span> {
03092 
03093         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: Error %#08lx while building "</span>
03094                     <span class="stringliteral">"driver load list\n"</span>, status));
03095     }
03096 
03097     deviceObject = DeviceNode-&gt;PhysicalDeviceObject;
03098 
03099     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a30">IopQueryLegacyBusInformation</a>(
03100                  deviceObject,
03101                  NULL,
03102                  &amp;DeviceNode-&gt;InterfaceType,
03103                  &amp;DeviceNode-&gt;BusNumber
03104              );
03105 
03106     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03107 
03108         DeviceNode-&gt;InterfaceType = InterfaceTypeUndefined;
03109         DeviceNode-&gt;BusNumber = 0xfffffff0;
03110 
03111     }
03112 
03113     status = STATUS_SUCCESS;
03114 
03115 Cleanup:
03116     {
03117 
03118         UCHAR i;
03119 
03120         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: DevNode flags leaving = %#08lx\n"</span>,
03121                     DeviceNode-&gt;Flags));
03122 
03123         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: Cleaning up\n"</span>));
03124 
03125         <span class="comment">//</span>
03126         <span class="comment">// Free the entries in the driver load list &amp; release the references on</span>
03127         <span class="comment">// their driver objects.</span>
03128         <span class="comment">//</span>
03129 
03130         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a17">MaximumAddStage</a>; i++) {
03131 
03132             <a class="code" href="../../d6/d0/pnpenum_8c.html#a6">PDRIVER_LIST_ENTRY</a> listHead = queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[i];
03133 
03134             <span class="keywordflow">while</span>(listHead != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03135 
03136                 <a class="code" href="../../d6/d0/pnpenum_8c.html#a6">PDRIVER_LIST_ENTRY</a> tmp = listHead;
03137 
03138                 listHead = listHead-&gt;<a class="code" href="../../d3/d9/struct__DRIVER__LIST__ENTRY.html#o1">NextEntry</a>;
03139 
03140                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(tmp-&gt;DriverObject != NULL);
03141 
03142                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(tmp-&gt;DriverObject);
03143 
03144                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(tmp);
03145             }
03146         }
03147     }
03148 
03149     ZwClose(instanceKey);
03150 
03151     <span class="keywordflow">if</span> (classKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03152         ZwClose(classKey);
03153     }
03154 
03155     <span class="keywordflow">if</span> (classPropsKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03156         ZwClose(classPropsKey);
03157     }
03158 
03159     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: Returning status %#08lx\n"</span>, status));
03160 
03161     <span class="keywordflow">return</span> status;
03162 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="pnpenum.c::IopCallDriverAddDeviceQueryRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCallDriverAddDeviceQueryRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d0/pnpenum_8c.html#a8">PQUERY_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">3165</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00345">_REINIT_PACKET::Context</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01330">_DRIVER_EXTENSION::Count</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00052">DebugPrint</a>, <a class="el" href="../../d6/d0/pnpenum_8c.html#a41a14">DeviceService</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00493">DNF_LEGACY_DRIVER</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01378">_DRIVER_OBJECT::DriverExtension</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00343">_REINIT_PACKET::DriverObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00344">_REINIT_PACKET::DriverReinitializationRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01304">DRVO_INITIALIZED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01303">DRVO_REINIT_REGISTERED</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01367">_DRIVER_OBJECT::Flags</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00128">IopDriverReinitializeQueueHead</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02072">IopGetDriverNameFromKeyNode()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05221">IopGetGroupOrderIndex()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05177">IopIsLegacyDriver()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04654">IopLoadBootFilterDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03578">IopReferenceDriverObjectByName()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00615">OK_TO_ADD_DEVICE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00033">PDRIVER_LIST_ENTRY</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00122">PnPBootDriversInitialized</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00110">PnPInitialized</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>.
<p>
<pre class="fragment"><div>03176                    :
03177 
03178     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to build a list of driver objects which need to
03179     be Added to a physical device object.  Each time <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called with a
03180     service name <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will locate a driver object <span class="keywordflow">for</span> that device and append
03181     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proper driver list <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node.
03182 
03183     In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event a driver object cannot be located or that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> cannot be loaded
03184     at <span class="keyword">this</span> time, <span class="keyword">this</span> routine will <span class="keywordflow">return</span> an error and will set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flags
03185     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context appropriately.
03186 
03187 Arguments:
03188 
03189     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value
03190 
03191     ValueType - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value
03192 
03193     ValueData - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value (unicode string data)
03194 
03195     ValueLength - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value data
03196 
03197     Context - a structure which contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context passed
03198               to <a class="code" href="../../d6/d0/pnpenum_8c.html#a36">IopCallDriverAddDevice</a> and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver lists <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
03199               node.
03200 
03201     EntryContext - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver list <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine should append
03202                    nodes to.
03203 
03204 Return Value:
03205 
03206     STATUS_SUCCESS <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver was located and added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list
03207     successfully or <span class="keywordflow">if</span> there was a non-fatal error <span class="keywordflow">while</span> handling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03208     driver.
03209 
03210     an error value indicating why <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver could not be added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
03211 
03212 --*/
03213 
03214 {
03215     UNICODE_STRING unicodeServiceName;
03216     UNICODE_STRING unicodeDriverName;
03217     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03218 
03219     ULONG i;
03220     ULONG loadType;
03221 
03222     PWSTR prefixString = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Driver\\"</span>;
03223     BOOLEAN madeupService;
03224 
03225     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> groupIndex;
03226     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03227 
03228     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
03229     BOOLEAN freeDriverName = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03230 
03231     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\tValue %ws [Type %d, Len %d] @ "</span>
03232                 <span class="stringliteral">"%#08lx\n"</span>,
03233                 ValueName, ValueType, ValueLength, ValueData));
03234 
03235     <span class="comment">//</span>
03236     <span class="comment">// First check and make sure that the value type is okay.  An invalid type</span>
03237     <span class="comment">// is not a fatal error.</span>
03238     <span class="comment">//</span>
03239 
03240     <span class="keywordflow">if</span> (ValueType != REG_SZ) {
03241 
03242         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\tValueType %d invalid for "</span>
03243                     <span class="stringliteral">"ServiceType %d\n"</span>,
03244                     ValueType,
03245                     ServiceType));
03246 
03247         <span class="keywordflow">return</span> STATUS_SUCCESS;
03248     }
03249 
03250     <span class="comment">//</span>
03251     <span class="comment">// Make sure the string is a reasonable length.</span>
03252     <span class="comment">//</span>
03253 
03254     <span class="keywordflow">if</span> (ValueLength &lt;= <span class="keyword">sizeof</span>(WCHAR)) {
03255 
03256         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\tValueLength %d is too short\n"</span>,
03257                     ValueLength));
03258 
03259         <span class="keywordflow">return</span> STATUS_SUCCESS;
03260     }
03261 
03262     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeServiceName, ValueData);
03263 
03264     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tService Name %wZ\n"</span>,
03265                 &amp;unicodeServiceName));
03266 
03267     <span class="comment">//</span>
03268     <span class="comment">// Check the service name to see if it should be used directly to reference</span>
03269     <span class="comment">// the driver object.  If the string begins with "\Driver", make sure the</span>
03270     <span class="comment">// madeupService flag is set.</span>
03271     <span class="comment">//</span>
03272 
03273     madeupService = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03274     i = 0;
03275 
03276     <span class="keywordflow">while</span>(*prefixString != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) {
03277 
03278         <span class="keywordflow">if</span> (unicodeServiceName.Buffer[i] != *prefixString) {
03279 
03280             madeupService = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03281             <span class="keywordflow">break</span>;
03282         }
03283 
03284         i++;
03285         prefixString++;
03286     }
03287 
03288     <span class="keywordflow">if</span> (madeupService) {
03289 
03290         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeDriverName, unicodeServiceName.Buffer);
03291 
03292         groupIndex = 0;
03293         loadType = SERVICE_BOOT_START;
03294 
03295     } <span class="keywordflow">else</span> {
03296 
03297         HANDLE serviceKey;
03298 
03299         <span class="comment">//</span>
03300         <span class="comment">// BUGBUG - (RBN) Hack to set the service name in the devnode if it</span>
03301         <span class="comment">//      isn't already set.</span>
03302         <span class="comment">//</span>
03303         <span class="comment">//      This probably should be done earlier somewhere else after the</span>
03304         <span class="comment">//      INF is run, but if we don't do it now we'll blow up when we</span>
03305         <span class="comment">//      call IopGetDriverLoadType below.</span>
03306         <span class="comment">//</span>
03307 
03308         <span class="keywordflow">if</span> (Context-&gt;DeviceNode-&gt;ServiceName.Length == 0) {
03309 
03310             Context-&gt;DeviceNode-&gt;ServiceName = unicodeServiceName;
03311             Context-&gt;DeviceNode-&gt;ServiceName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool,
03312                                                                       unicodeServiceName.MaximumLength );
03313 
03314             <span class="keywordflow">if</span> (Context-&gt;DeviceNode-&gt;ServiceName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03315                 RtlCopyMemory( Context-&gt;DeviceNode-&gt;ServiceName.Buffer,
03316                                unicodeServiceName.Buffer,
03317                                unicodeServiceName.MaximumLength );
03318             } <span class="keywordflow">else</span> {
03319                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;Context-&gt;DeviceNode-&gt;ServiceName, NULL );
03320 
03321                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tCannot allocate memory for service name in devnode\n"</span>));
03322 
03323                 status = STATUS_UNSUCCESSFUL;
03324 
03325                 <span class="keywordflow">goto</span> Cleanup;
03326             }
03327         }
03328 
03329         <span class="comment">//</span>
03330         <span class="comment">// Check in the registry to find the name of the driver object</span>
03331         <span class="comment">// for this device.</span>
03332         <span class="comment">//</span>
03333 
03334         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(&amp;unicodeServiceName,
03335                                         KEY_READ,
03336                                         &amp;serviceKey,
03337                                         NULL,
03338                                         FALSE);
03339 
03340         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03341 
03342             <span class="comment">//</span>
03343             <span class="comment">// Cannot open the service key for this driver.  This is a</span>
03344             <span class="comment">// fatal error.</span>
03345             <span class="comment">//</span>
03346 
03347             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tStatus %#08lx "</span>
03348                         <span class="stringliteral">"opening service key\n"</span>,
03349                         status));
03350 
03351             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(Context-&gt;DeviceNode, CM_PROB_REGISTRY);
03352 
03353             <span class="keywordflow">goto</span> Cleanup;
03354         }
03355 
03356         groupIndex = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a33">IopGetGroupOrderIndex</a>(serviceKey);
03357 
03358         status = <a class="code" href="../../d0/d6/iop_8h.html#a175">IopGetDriverNameFromKeyNode</a>(serviceKey, &amp;unicodeDriverName);
03359 
03360         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03361 
03362             ZwClose(serviceKey);
03363 
03364             <span class="comment">//</span>
03365             <span class="comment">// Can't get the driver name from the service key.  This is a</span>
03366             <span class="comment">// fatal error.</span>
03367             <span class="comment">//</span>
03368 
03369             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tStatus %#08lx "</span>
03370                         <span class="stringliteral">"getting driver name\n"</span>,
03371                         status));
03372 
03373             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(Context-&gt;DeviceNode, CM_PROB_REGISTRY);
03374             <span class="keywordflow">goto</span> Cleanup;
03375         } <span class="keywordflow">else</span> {
03376             freeDriverName = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03377         }
03378 
03379         loadType = SERVICE_DISABLED;
03380 
03381         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(serviceKey, L<span class="stringliteral">"Start"</span>, &amp;keyValueInformation);
03382         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03383             <span class="keywordflow">if</span> (keyValueInformation-&gt;Type == REG_DWORD) {
03384                 <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)) {
03385                     loadType = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03386                 }
03387             }
03388             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03389         }
03390 
03391         ZwClose(serviceKey);
03392     }
03393 
03394     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tDriverName is %wZ\n"</span>,
03395                 &amp;unicodeDriverName));
03396 
03397     driverObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a22">IopReferenceDriverObjectByName</a>(&amp;unicodeDriverName);
03398 
03399     <span class="keywordflow">if</span> (driverObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03400 
03401         PWCHAR buffer;
03402         UNICODE_STRING unicodeServicePath;
03403 
03404         <span class="comment">//</span>
03405         <span class="comment">// We couldn't find a driver object.  It's possible the driver isn't</span>
03406         <span class="comment">// loaded &amp; initialized so check to see if we can try to load it</span>
03407         <span class="comment">// now.</span>
03408         <span class="comment">//</span>
03409 
03410         <span class="keywordflow">if</span> (madeupService) {
03411 
03412             <span class="comment">//</span>
03413             <span class="comment">// The madeup service's driver doesn't seem to exist yet.</span>
03414             <span class="comment">// We will fail the request without setting DNF_ADD_FAILED such that</span>
03415             <span class="comment">// we will try it again later.  (Root Enumerated devices...)</span>
03416             <span class="comment">//</span>
03417 
03418             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tCannot find driver "</span>
03419                         <span class="stringliteral">"object for madeup service\n"</span>));
03420 
03421             status = STATUS_UNSUCCESSFUL;
03422 
03423             <span class="keywordflow">goto</span> Cleanup;
03424         }
03425 
03426         <span class="keywordflow">if</span> (ServiceType != <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a14">DeviceService</a> &amp;&amp; !<a class="code" href="../../d1/d0/pnpdata_8c.html#a16">PnPBootDriversInitialized</a>) {
03427 
03428             <span class="comment">//</span>
03429             <span class="comment">// If we are in BootDriverInitialization phase and trying to load a filter driver</span>
03430             <span class="comment">//</span>
03431 
03432             driverObject = <a class="code" href="../../d9/d0/pnpiop_8h.html#a327">IopLoadBootFilterDriver</a>(&amp;unicodeDriverName, groupIndex);
03433             <span class="keywordflow">if</span> (driverObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03434                 status = STATUS_UNSUCCESSFUL;
03435                 <span class="keywordflow">goto</span> Cleanup;
03436             }
03437         } <span class="keywordflow">else</span> {
03438             <span class="keywordflow">if</span> (!Context-&gt;LoadDriver) {
03439 
03440                 <span class="comment">//</span>
03441                 <span class="comment">// We're not supposed to try and load a driver - most likely our</span>
03442                 <span class="comment">// disk drivers aren't initialized yet.  We need to stop the add</span>
03443                 <span class="comment">// process but we can't mark the devnode as failed or we won't</span>
03444                 <span class="comment">// be called again when we can load the drivers.</span>
03445                 <span class="comment">//</span>
03446 
03447                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tNot allowed to load "</span>
03448                             <span class="stringliteral">"drivers yet\n"</span>));
03449 
03450                 status = STATUS_UNSUCCESSFUL;
03451                 <span class="keywordflow">goto</span> Cleanup;
03452             }
03453 
03454             <span class="keywordflow">if</span> (groupIndex &gt; Context-&gt;AddContext-&gt;GroupsToStart) {
03455 
03456                 <span class="comment">//</span>
03457                 <span class="comment">// We're not allowed to initialize this driver until drivers in</span>
03458                 <span class="comment">// previous groups are loaded.  Leave the devnode flags untouched</span>
03459                 <span class="comment">// so we get called again, but stop the add process now.</span>
03460                 <span class="comment">//</span>
03461 
03462                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tLower group drivers "</span>
03463                             <span class="stringliteral">"have not been initialized yet\n"</span>));
03464                 <span class="keywordflow">if</span> (groupIndex &lt; Context-&gt;AddContext-&gt;GroupToStartNext) {
03465                     Context-&gt;AddContext-&gt;GroupToStartNext = groupIndex;
03466                 }
03467 
03468                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tGroup = %d, To Start = "</span>
03469                             <span class="stringliteral">"Start Next = %d\n"</span>,
03470                             groupIndex,
03471                             Context-&gt;AddContext-&gt;GroupsToStart,
03472                             Context-&gt;AddContext-&gt;GroupToStartNext));
03473 
03474                 status = STATUS_UNSUCCESSFUL;
03475                 <span class="keywordflow">goto</span> Cleanup;
03476             }
03477 
03478 
03479 
03480             <span class="keywordflow">if</span> (loadType &gt; Context-&gt;AddContext-&gt;DriverStartType) {
03481 
03482                 <span class="keywordflow">if</span> (loadType == SERVICE_DISABLED &amp;&amp;
03483                     !<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(Context-&gt;DeviceNode)) {
03484                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(Context-&gt;DeviceNode, CM_PROB_DISABLED_SERVICE);
03485                 }
03486 
03487                 <span class="comment">//</span>
03488                 <span class="comment">// The service is either disabled or we are not at the right</span>
03489                 <span class="comment">// time to load it.  Don't load it, but make sure we can get</span>
03490                 <span class="comment">// called again.  If a service is marked as demand start, we</span>
03491                 <span class="comment">// always load it.</span>
03492                 <span class="comment">//</span>
03493 
03494                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tService is disabled or not at right time to load it\n"</span>));
03495                 status = STATUS_UNSUCCESSFUL;
03496                 <span class="keywordflow">goto</span> Cleanup;
03497             }
03498 
03499             {
03500                 HANDLE handle;
03501 
03502                 <span class="comment">//</span>
03503                 <span class="comment">// Check in the registry to find the name of the driver object</span>
03504                 <span class="comment">// for this device.</span>
03505                 <span class="comment">//</span>
03506 
03507                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(&amp;unicodeServiceName,
03508                                                 KEY_READ,
03509                                                 &amp;handle,
03510                                                 NULL,
03511                                                 FALSE);
03512 
03513                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03514 
03515                     <span class="comment">//</span>
03516                     <span class="comment">// Cannot open the service key for this driver.  This is a</span>
03517                     <span class="comment">// fatal error.</span>
03518                     <span class="comment">//</span>
03519 
03520                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tStatus %#08lx "</span>
03521                                 <span class="stringliteral">"opening service key\n"</span>,
03522                                 status));
03523                 } <span class="keywordflow">else</span> {
03524                     status = <a class="code" href="../../d0/d6/iop_8h.html#a191">IopLoadDriver</a>(handle,FALSE);              <span class="comment">// handle will be closed by IopLoadDriver</span>
03525 
03526                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a14">PnPInitialized</a>) {
03527 
03528                         PLIST_ENTRY entry;
03529                         <a class="code" href="../../d5/d3/struct__REINIT__PACKET.html">PREINIT_PACKET</a> reinitEntry;
03530 
03531                         <span class="comment">//</span>
03532                         <span class="comment">// Walk the list reinitialization list in case this driver, or</span>
03533                         <span class="comment">// some other driver, has requested to be invoked at a re-</span>
03534                         <span class="comment">// initialization entry point.</span>
03535                         <span class="comment">//</span>
03536 
03537                         <span class="keywordflow">while</span> (entry = <a class="code" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList</a>( &amp;IopDriverReinitializeQueueHead, &amp;IopDatabaseLock )) {
03538                             reinitEntry = CONTAINING_RECORD( entry, <a class="code" href="../../d5/d3/struct__REINIT__PACKET.html">REINIT_PACKET</a>, ListEntry );
03539                             reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o2">Count</a>++;
03540                             reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a146">DRVO_REINIT_REGISTERED</a>;
03541                             reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o2">DriverReinitializationRoutine</a>( reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>,
03542                                                                         reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o3">Context</a>,
03543                                                                         reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o2">Count</a> );
03544                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( reinitEntry );
03545                         }
03546                     }
03547                 }
03548 
03549             }
03550             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03551 
03552                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a16">PnPBootDriversInitialized</a>) {
03553                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tStatus %#08lx "</span>
03554                                 <span class="stringliteral">"from loading driver\n"</span>, status));
03555                 }
03556             }
03557 
03558         }
03559     } <span class="keywordflow">else</span> {
03560         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(driverObject);
03561         <span class="keywordflow">if</span> (!(driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a147">DRVO_INITIALIZED</a>)) {
03562             status = STATUS_UNSUCCESSFUL;
03563             <span class="keywordflow">goto</span> Cleanup;
03564         }
03565     }
03566 
03567     <span class="comment">//</span>
03568     <span class="comment">// Ignore the return value from the driver load - just try and get a</span>
03569     <span class="comment">// pointer to the driver object for the service.</span>
03570     <span class="comment">//</span>
03571 
03572     driverObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a22">IopReferenceDriverObjectByName</a>(&amp;unicodeDriverName);
03573 
03574     <span class="keywordflow">if</span> (driverObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03575 
03576         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a16">PnPBootDriversInitialized</a>) {
03577 
03578             <span class="comment">//</span>
03579             <span class="comment">// Apparently the load didn't work out very well.  This is a</span>
03580             <span class="comment">// fatal error.</span>
03581             <span class="comment">//</span>
03582 
03583             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tUnable to reference "</span>
03584                         <span class="stringliteral">"driver %wZ\n"</span>, &amp;unicodeDriverName));
03585 
03586             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(Context-&gt;DeviceNode)) {
03587                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(Context-&gt;DeviceNode, CM_PROB_FAILED_ADD);
03588             }
03589         }
03590 
03591         status = STATUS_UNSUCCESSFUL;
03592         <span class="keywordflow">goto</span> Cleanup;
03593     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a147">DRVO_INITIALIZED</a>)) {
03594         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(driverObject);
03595         status = STATUS_UNSUCCESSFUL;
03596         <span class="keywordflow">goto</span> Cleanup;
03597     }
03598 
03599     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tDriver Reference %#08lx\n"</span>,
03600                 driverObject));
03601 
03602     <span class="comment">//</span>
03603     <span class="comment">// Check to see if the driver is a legacy driver rather than a Pnp one.</span>
03604     <span class="comment">//</span>
03605 
03606     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a32">IopIsLegacyDriver</a>(driverObject)) {
03607 
03608         <span class="comment">//</span>
03609         <span class="comment">// It is.  Since the legacy driver may have already obtained a</span>
03610         <span class="comment">// handle to the device object, we need to assume this device</span>
03611         <span class="comment">// has been added and started.</span>
03612         <span class="comment">//</span>
03613 
03614         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tDriver is a legacy "</span>
03615                     <span class="stringliteral">"driver\n"</span>));
03616 
03617         <span class="keywordflow">if</span> (ServiceType == <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a14">DeviceService</a>) {
03618             Context-&gt;DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a> +
03619                                           <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a> +
03620                                           <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a>;
03621 
03622             status = STATUS_UNSUCCESSFUL;
03623         } <span class="keywordflow">else</span> {
03624 
03625             <span class="comment">//</span>
03626             <span class="comment">// We allow someone to plug in a legacy driver as a filter driver.</span>
03627             <span class="comment">// In this case, the legacy driver will be loaded but will not be part</span>
03628             <span class="comment">// of our pnp driver stack.</span>
03629             <span class="comment">//</span>
03630 
03631             status = STATUS_SUCCESS;
03632         }
03633         <span class="keywordflow">goto</span> Cleanup;
03634     }
03635 
03636     <span class="comment">//</span>
03637     <span class="comment">// There's a chance the driver detected this PDO during it's driver entry</span>
03638     <span class="comment">// routine.  If it did then just bail out.</span>
03639     <span class="comment">//</span>
03640 
03641     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a42">OK_TO_ADD_DEVICE</a>(Context-&gt;DeviceNode)) {
03642 
03643         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice\t\t\tDevNode was reported "</span>
03644                        <span class="stringliteral">"as detected during driver entry\n"</span>));
03645         status = STATUS_UNSUCCESSFUL;
03646         <span class="keywordflow">goto</span> Cleanup;
03647     }
03648 
03649     <span class="comment">//</span>
03650     <span class="comment">// Add the driver to the list.</span>
03651     <span class="comment">//</span>
03652 
03653     {
03654         <a class="code" href="../../d6/d0/pnpenum_8c.html#a6">PDRIVER_LIST_ENTRY</a> listEntry;
03655         <a class="code" href="../../d6/d0/pnpenum_8c.html#a6">PDRIVER_LIST_ENTRY</a> *runner = &amp;(Context-&gt;DriverLists[ServiceType]);
03656 
03657         status = STATUS_SUCCESS;
03658 
03659         <span class="comment">//</span>
03660         <span class="comment">// Allocate a new list entry to queue this driver object for the caller</span>
03661         <span class="comment">//</span>
03662 
03663         listEntry = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <span class="keyword">sizeof</span>(DRIVER_LIST_ENTRY));
03664 
03665         <span class="keywordflow">if</span> (listEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03666 
03667             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\t\tUnable to allocate list "</span>
03668                         <span class="stringliteral">"entry\n"</span>));
03669 
03670             status = STATUS_INSUFFICIENT_RESOURCES;
03671             <span class="keywordflow">goto</span> Cleanup;
03672         }
03673 
03674         listEntry-&gt;DriverObject = driverObject;
03675         listEntry-&gt;NextEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03676 
03677         <span class="keywordflow">while</span>(*runner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03678             runner = &amp;((*runner)-&gt;NextEntry);
03679         }
03680 
03681         *runner = listEntry;
03682     }
03683 
03684 Cleanup:
03685 
03686     <span class="keywordflow">if</span> (freeDriverName) {
03687         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeDriverName);
03688     }
03689     <span class="keywordflow">return</span> status;
03690 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="pnpenum.c::IopChangeDeviceObjectFromRegistryProperties" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopChangeDeviceObjectFromRegistryProperties           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalDeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceClassPropKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>DevicePropKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>UsePdoCharacteristics</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04759">4759</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01185">_DEVICE_OBJECT::Characteristics</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00052">DebugPrint</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01158">DO_DEVICE_HAS_NAME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01155">DO_EXCLUSIVE</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12098">IopCreateDefaultDeviceSecurityDescriptor()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04610">IopGetRegistryDwordWithFallback()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04679">IopGetRegistrySecurityWithFallback()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00174">ObSetSecurityObjectByPointer()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02665">RtlGetDaclSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03232">RtlGetGroupSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03059">RtlGetOwnerSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02871">RtlGetSaclSecurityDescriptor()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>.
<p>
<pre class="fragment"><div>04767                    :
04768 
04769     This routine will obtain settings from either
04770     (1) DevNode settings (via DevicePropKey) or
04771     (2) Class settings (via DeviceClassPropKey)
04772     applying to PDO and all attached device objects
04773 
04774     Properties set/ changed are:
04775 
04776         * DeviceType - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object
04777         * DeviceCharacteristics - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system characteristic flags to be
04778                                   set <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object
04779         * Exclusive - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be accessed exclusively
04780         * Security - security <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
04781 
04782     The routine will then use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceType and DeviceCharacteristics specified
04783     to determine whether a <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a> should be allocated as well as to set <span class="keywordflow">default</span>
04784     security <span class="keywordflow">if</span> none <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
04785 
04786 Arguments:
04787 
04788     PhysicalDeviceObject - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO we are to configure
04789 
04790     DeviceClassPropKey - a handle to Control\&lt;Class&gt;\Properties <span class="keyword">protected</span> key
04791     DevicePropKey      - a handle to Enum\&lt;Instance&gt;  <span class="keyword">protected</span> key
04792 
04793 Return Value:
04794 
04795     status
04796 
04797 --*/
04798 
04799 {
04800     UNICODE_STRING valueName;
04801     PKEY_VALUE_FULL_INFORMATION info;
04802     PUCHAR data;
04803     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04804 
04805     BOOLEAN deviceTypeSpec = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04806     BOOLEAN characteristicsSpec = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04807     BOOLEAN exclusiveSpec = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04808     BOOLEAN securityForce = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04809     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> buffer[SECURITY_DESCRIPTOR_MIN_LENGTH];
04810     SECURITY_INFORMATION securityInformation = 0;
04811 
04812     PSECURITY_DESCRIPTOR securityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04813     PACL allocatedAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04814     ULONG deviceType = 0;
04815     ULONG characteristics = 0;
04816     ULONG exclusive = 0;
04817     ULONG prevCharacteristics = 0;
04818     ULONG prevExclusive = 0;
04819     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> StackIterator = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04820     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04821 
04822     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PhysicalDeviceObject);
04823     deviceNode = PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
04824     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode);
04825 
04826     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(2, (<span class="stringliteral">"IopChangeDeviceObjectFromRegistryProperties: Modifying device stack for PDO: %08x\n"</span>,PhysicalDeviceObject));
04827 
04828     <span class="comment">//</span>
04829     <span class="comment">// Iterate through all device objects to get our starting settings (OR everyone together)</span>
04830     <span class="comment">// generally, a PDO should take on the characteristics of whoever is above the PDO, and not used in the equation</span>
04831     <span class="comment">// the exception being if it's being used RAW</span>
04832     <span class="comment">// we detect this by absense of service name, or it's the only Device Object.</span>
04833     <span class="comment">//</span>
04834     StackIterator = PhysicalDeviceObject;
04835     <span class="keywordflow">if</span> (UsePdoCharacteristics || StackIterator-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04836         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(2, (<span class="stringliteral">"IopChangeDeviceObjectFromRegistryProperties: Assuming PDO is being used RAW\n"</span>));
04837     } <span class="keywordflow">else</span> {
04838         StackIterator = StackIterator-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
04839         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(2, (<span class="stringliteral">"IopChangeDeviceObjectFromRegistryProperties: Ignoring PDO's settings\n"</span>));
04840     }
04841     <span class="keywordflow">for</span> ( ; StackIterator != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; StackIterator = StackIterator-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>) {
04842 <span class="preprocessor">#if 0 // BUGBUG (jamiehun) we were breaking serial, I'd like to put this back in though...</span>
04843 <span class="preprocessor"></span>        prevExclusive |= StackIterator-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a124">DO_EXCLUSIVE</a>;
04844 <span class="preprocessor">#endif</span>
04845 <span class="preprocessor"></span>        prevCharacteristics |= StackIterator-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o9">Characteristics</a>;
04846     }
04847 
04848     <span class="comment">//</span>
04849     <span class="comment">// 1) Get Device type, DevicePropKey preferred over DeviceClassPropKey</span>
04850     <span class="comment">//</span>
04851     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, REGSTR_VAL_DEVICE_TYPE);
04852     deviceTypeSpec = <a class="code" href="../../d6/d0/pnpenum_8c.html#a29">IopGetRegistryDwordWithFallback</a>(&amp;valueName,DevicePropKey,DeviceClassPropKey,&amp;deviceType);
04853     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, REGSTR_VAL_DEVICE_CHARACTERISTICS);
04854     characteristicsSpec = <a class="code" href="../../d6/d0/pnpenum_8c.html#a29">IopGetRegistryDwordWithFallback</a>(&amp;valueName,DevicePropKey,DeviceClassPropKey,&amp;characteristics);
04855     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, REGSTR_VAL_DEVICE_EXCLUSIVE);
04856     exclusiveSpec = <a class="code" href="../../d6/d0/pnpenum_8c.html#a29">IopGetRegistryDwordWithFallback</a>(&amp;valueName,DevicePropKey,DeviceClassPropKey,&amp;exclusive);
04857 
04858     <span class="keywordflow">if</span> (exclusive) {
04859         <span class="comment">//</span>
04860         <span class="comment">// make sure a TRUE maps to a bit-mask</span>
04861         <span class="comment">//</span>
04862         exclusive = <a class="code" href="../../d0/d5/io_8h.html#a124">DO_EXCLUSIVE</a>;
04863     }
04864 
04865     <span class="keywordflow">if</span> (exclusiveSpec) {
04866         exclusive |= prevExclusive;
04867     } <span class="keywordflow">else</span> {
04868         exclusive = prevExclusive;
04869     }
04870     <span class="keywordflow">if</span> (!characteristicsSpec) {
04871         characteristics = 0;
04872     }
04873     characteristics = (characteristics | prevCharacteristics) &amp; FILE_CHARACTERISTICS_PROPAGATED; <span class="comment">// mask only applicable characteristics</span>
04874 
04875     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, REGSTR_VAL_DEVICE_SECURITY_DESCRIPTOR);
04876     securityDescriptor = <a class="code" href="../../d6/d0/pnpenum_8c.html#a30">IopGetRegistrySecurityWithFallback</a>(&amp;valueName,DevicePropKey,DeviceClassPropKey);
04877 
04878     <span class="keywordflow">if</span> (securityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04879         <span class="comment">//</span>
04880         <span class="comment">// determine if we should create internal default</span>
04881         <span class="comment">//</span>
04882         <span class="keywordflow">if</span> (deviceTypeSpec) {
04883             BOOLEAN hasName = (PhysicalDeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a127">DO_DEVICE_HAS_NAME</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04884 
04885             securityDescriptor = <a class="code" href="../../d4/d6/iosubs_8c.html#a127">IopCreateDefaultDeviceSecurityDescriptor</a>(
04886                                     (DEVICE_TYPE)deviceType,
04887                                     characteristics,
04888                                     hasName,
04889                                     buffer,
04890                                     &amp;allocatedAcl,
04891                                     &amp;securityInformation
04892                                     );
04893             <span class="keywordflow">if</span> (securityDescriptor) {
04894                 securityForce = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; <span class="comment">// forced default security descriptor</span>
04895             } <span class="keywordflow">else</span> {
04896                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopChangeDeviceObjectFromRegistryProperties: Was not able to get default security descriptor\n"</span>));
04897             }
04898         }
04899     } <span class="keywordflow">else</span> {
04900         <span class="comment">//</span>
04901         <span class="comment">// further process the security information we're given to set "securityInformation"</span>
04902         <span class="comment">//</span>
04903         PSID sid;
04904         PACL acl;
04905         BOOLEAN present, tmp;
04906 
04907         securityInformation = 0;
04908 
04909         <span class="comment">//</span>
04910         <span class="comment">// See what information is in the captured descriptor so we can build</span>
04911         <span class="comment">// up a securityInformation block to go with it.</span>
04912         <span class="comment">//</span>
04913 
04914         status = <a class="code" href="../../d8/d6/sertl_8c.html#a65">RtlGetOwnerSecurityDescriptor</a>(securityDescriptor, &amp;sid, &amp;tmp);
04915 
04916         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (sid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
04917             securityInformation |= OWNER_SECURITY_INFORMATION;
04918         }
04919 
04920         status = <a class="code" href="../../d8/d6/sertl_8c.html#a67">RtlGetGroupSecurityDescriptor</a>(securityDescriptor, &amp;sid, &amp;tmp);
04921 
04922         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (sid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
04923             securityInformation |= GROUP_SECURITY_INFORMATION;
04924         }
04925 
04926         status = <a class="code" href="../../d8/d6/sertl_8c.html#a63">RtlGetSaclSecurityDescriptor</a>(securityDescriptor,
04927                                               &amp;present,
04928                                               &amp;acl,
04929                                               &amp;tmp);
04930 
04931         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (present)) {
04932             securityInformation |= SACL_SECURITY_INFORMATION;
04933         }
04934 
04935         status = <a class="code" href="../../d8/d6/sertl_8c.html#a61">RtlGetDaclSecurityDescriptor</a>(securityDescriptor,
04936                                               &amp;present,
04937                                               &amp;acl,
04938                                               &amp;tmp);
04939 
04940         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (present)) {
04941             securityInformation |= DACL_SECURITY_INFORMATION;
04942         }
04943 
04944     }
04945 
04946 <span class="preprocessor">#if DBG</span>
04947 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (deviceTypeSpec == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; characteristicsSpec == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; exclusiveSpec == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; securityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04948         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(2, (<span class="stringliteral">"IopChangeDeviceObjectFromRegistryProperties: No property changes\n"</span>));
04949     } <span class="keywordflow">else</span> {
04950         <span class="keywordflow">if</span> (deviceTypeSpec) {
04951             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(2, (<span class="stringliteral">"IopChangeDeviceObjectFromRegistryProperties: Overide DeviceType=%08x\n"</span>,
04952                            deviceType));
04953         }
04954         <span class="keywordflow">if</span> (characteristicsSpec) {
04955             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(2, (<span class="stringliteral">"IopChangeDeviceObjectFromRegistryProperties: Overide DeviceCharacteristics=%08x\n"</span>,
04956                            characteristics));
04957         }
04958         <span class="keywordflow">if</span> (exclusiveSpec) {
04959             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(2, (<span class="stringliteral">"IopChangeDeviceObjectFromRegistryProperties: Overide Exclusive=%d\n"</span>,(exclusive?1:0)));
04960         }
04961         <span class="keywordflow">if</span> (securityForce) {
04962             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(2, (<span class="stringliteral">"IopChangeDeviceObjectFromRegistryProperties: Overide Security based on DeviceType &amp; DeviceCharacteristics\n"</span>));
04963         }
04964         <span class="keywordflow">if</span> (securityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04965             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(2, (<span class="stringliteral">"IopChangeDeviceObjectFromRegistryProperties: Overide Security\n"</span>));
04966         }
04967     }
04968 <span class="preprocessor">#endif</span>
04969 <span class="preprocessor"></span>    <span class="comment">//</span>
04970     <span class="comment">// modify apropriate characteristics of PDO to be the same as those of rest of stack</span>
04971     <span class="comment">// eg, PDO may be initialized as Raw-Capable Secure Open, but then be modified to be more lax</span>
04972     <span class="comment">//</span>
04973     PhysicalDeviceObject-&gt;Characteristics = (PhysicalDeviceObject-&gt;Characteristics &amp; ~FILE_CHARACTERISTICS_PROPAGATED) | characteristics;
04974     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((PhysicalDeviceObject-&gt;Characteristics &amp; FILE_CHARACTERISTICS_PROPAGATED) == characteristics); <span class="comment">// sanity (checks bit bounds)</span>
04975     <span class="comment">//</span>
04976     <span class="comment">// modify exclusivity of PDO to be the same as those of rest of stack</span>
04977     <span class="comment">// eg, PDO may be initialized as Exclusive open, but be modified to be more lax</span>
04978     <span class="comment">//</span>
04979 <span class="preprocessor">#if 0 // BUGBUG (jamiehun) we were breaking serial, I'd like to put this back in though...</span>
04980 <span class="preprocessor"></span>    PhysicalDeviceObject-&gt;Flags = (PhysicalDeviceObject-&gt;Flags &amp; ~<a class="code" href="../../d0/d5/io_8h.html#a124">DO_EXCLUSIVE</a>) | exclusive;
04981     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((PhysicalDeviceObject-&gt;Flags &amp; DO_EXCLUSIVE) == exclusive); <span class="comment">// sanity (checks bit bounds)</span>
04982 <span class="preprocessor">#endif</span>
04983 <span class="preprocessor"></span>
04984     <span class="comment">//</span>
04985     <span class="comment">// iterate through rest of objects</span>
04986     <span class="comment">// these flags were used to create characteristics &amp; deviceType, so</span>
04987     <span class="comment">// we will only end up setting flags, not clearing them</span>
04988     <span class="comment">//</span>
04989     <span class="keywordflow">for</span> ( StackIterator = PhysicalDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a> ; StackIterator != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ; StackIterator = StackIterator-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>) {
04990         <span class="comment">//</span>
04991         <span class="comment">// modify characteristics (set only)</span>
04992         <span class="comment">//</span>
04993         StackIterator-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o9">Characteristics</a> |= characteristics;
04994         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((StackIterator-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o9">Characteristics</a> &amp; FILE_CHARACTERISTICS_PROPAGATED) == characteristics); <span class="comment">// sanity (checks we only needed to set)</span>
04995         <span class="comment">//</span>
04996         <span class="comment">// modify exclusivity flag (set only)</span>
04997         <span class="comment">//</span>
04998         StackIterator-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> |= exclusive;
04999 <span class="preprocessor">#if 0 // BUGBUG (jamiehun) we were breaking serial, I'd like to put this back in though...</span>
05000 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((StackIterator-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; DO_EXCLUSIVE) == exclusive); <span class="comment">// sanity (checks we only needed to set)</span>
05001 <span class="preprocessor">#endif</span>
05002 <span class="preprocessor"></span>    }
05003     <span class="keywordflow">if</span> (deviceTypeSpec) {
05004         <span class="comment">//</span>
05005         <span class="comment">// modify device type - PDO only</span>
05006         <span class="comment">//</span>
05007         PhysicalDeviceObject-&gt;DeviceType = deviceType;
05008     }
05009     <span class="keywordflow">if</span> (securityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05010         <span class="comment">//</span>
05011         <span class="comment">// modify security (applied to whole stack)</span>
05012         <span class="comment">//</span>
05013         status = <a class="code" href="../../d9/d1/obse_8c.html#a1">ObSetSecurityObjectByPointer</a>(PhysicalDeviceObject,
05014                                               securityInformation,
05015                                               securityDescriptor);
05016         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
05017             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopChangeDeviceObjectFromRegistryProperties: Set security failed (%08x)\n"</span>,status));
05018         }
05019     }
05020     <span class="comment">//</span>
05021     <span class="comment">// cleanup</span>
05022     <span class="comment">//</span>
05023     <span class="keywordflow">if</span> ((securityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !securityForce) {
05024         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(securityDescriptor);
05025     }
05026     <span class="keywordflow">if</span> (allocatedAcl) {
05027         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(allocatedAcl);
05028     }
05029 
05030     <span class="keywordflow">return</span> STATUS_SUCCESS;
05031 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="pnpenum.c::IopDeviceActionWorker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDeviceActionWorker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">307</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00684">_START_CONTEXT::AddContext</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00799">_PI_DEVICE_REQUEST::CompletionEvent</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00800">_PI_DEVICE_REQUEST::CompletionStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00797">_PI_DEVICE_REQUEST::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00396">DNF_ENUMERATED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00678">_ADD_CONTEXT::DriverStartType</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00170">_DEVICE_NODE::EnumerationMutex</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00676">_ADD_CONTEXT::GroupsToStart</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00677">_ADD_CONTEXT::GroupToStartNext</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01293">IopAcquireDeviceTreeLock</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01266">IopAcquireEnumerationLock</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00728">IopBusCheck()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00074">IopDeviceTreeLock</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00195">IopEnumerationInProgress</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00104">IopPnpEnumerationRequestList</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00068">IopPnPSpinLock</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01185">IopProcessAssignResources()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00821">IopProcessStartDevices()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01294">IopReleaseDeviceTreeLock</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01276">IopReleaseEnumerationLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00142">IopResourcesReleased</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05597">IopRestartDeviceNode()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00682">_START_CONTEXT::LoadDriver</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00301">_DEVICE_NODE::LockCount</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00683">_START_CONTEXT::NewDevice</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00671">NO_MORE_GROUP</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00086">PiEnumerationLock</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a120">PNEW_DEVICE_WORK_ITEM</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00173">PnpAsyncOk</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00122">PnPBootDriversInitialized</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a167">PpSynchronizeDeviceEventQueue()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a220">ReenumerateBootDevices</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a219">ReenumerateDeviceOnly</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00798">_PI_DEVICE_REQUEST::RequestType</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a223">ResourceRequirementsChanged</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a224">StartDevice</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>.
<p>
<pre class="fragment"><div>00313                    :
00314 
00315     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> worker routine of <a class="code" href="../../d7/d7/fs__rec_8h.html#a37">ZwLoadDriver</a>.
00316     Its <a class="code" href="../../d3/d9/arcinst_8c.html#a19">main</a> purpose <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to start and enumerate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device controlled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly
00317     loaded drivers.
00318 
00319     Caller must obtain a reference of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> *<span class="keyword">new</span>* device object.
00320 
00321 Parameters:
00322 
00323     Context - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BUS_CHECK_WORK_ITEM.
00324 
00325 ReturnValue:
00326 
00327     None.
00328 
00329 --*/
00330 
00331 {
00332     <a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html">PPI_DEVICE_REQUEST</a>  request;
00333     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>      deviceObject;
00334     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>        deviceNode;
00335     PLIST_ENTRY         entry;
00336     BOOLEAN             assignResources = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, allocateResources = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00337     BOOLEAN             bootConfigsOK = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, bootProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00338     BOOLEAN             newDevice, moreProcessing;
00339     <a class="code" href="../../d0/d6/struct__START__CONTEXT.html">START_CONTEXT</a>       startContext;
00340     KIRQL               oldIrql;
00341     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status = STATUS_UNSUCCESSFUL;
00342 
00343     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00344 
00345     <span class="keywordflow">for</span> (; ;) {
00346 
00347         ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
00348         entry = RemoveHeadList(&amp;IopPnpEnumerationRequestList);
00349         <span class="keywordflow">if</span> (entry == &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a13">IopPnpEnumerationRequestList</a>) {
00350             entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00351         }
00352         ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
00353 
00354         <span class="keywordflow">if</span> (!entry) {
00355 
00356             <span class="comment">//</span>
00357             <span class="comment">// BUGBUG</span>
00358             <span class="comment">//</span>
00359             <span class="comment">// This code will get run whenever we remove a device (amongst other</span>
00360             <span class="comment">// situations).  However, if we are trying to start boot devices, we</span>
00361             <span class="comment">// don't want to start other devices.  The startContext should</span>
00362             <span class="comment">// probably be based on some global state that knows what devices</span>
00363             <span class="comment">// should be (and more importantly should not be) started.</span>
00364             <span class="comment">//</span>
00365             <span class="keywordflow">if</span> ((allocateResources &amp;&amp; <a class="code" href="../../d1/d0/pnpdata_8c.html#a19">IopResourcesReleased</a>) || assignResources || bootProcess) {
00366 
00367                 <span class="comment">//</span>
00368                 <span class="comment">// Retry resource allocation for the DNF_INSUFFICIENT_RESOURCES devices</span>
00369                 <span class="comment">// if there are new resources become available.</span>
00370                 <span class="comment">//</span>
00371 
00372                 newDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00373 
00374                 startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o0">LoadDriver</a> = <a class="code" href="../../d1/d0/pnpdata_8c.html#a16">PnPBootDriversInitialized</a>;
00375                 startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o0">GroupsToStart</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
00376                 startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o1">GroupToStartNext</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
00377                 startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o2">DriverStartType</a> = SERVICE_DEMAND_START;
00378 
00379                 <span class="keywordflow">do</span> {
00380 
00381                     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00382 
00383                     <span class="comment">//</span>
00384                     <span class="comment">// Process the whole device tree to assign resources to those devices who</span>
00385                     <span class="comment">// have been successfully added to their drivers.</span>
00386                     <span class="comment">//</span>
00387 
00388                     moreProcessing = <a class="code" href="../../d9/d0/pnpiop_8h.html#a262">IopProcessAssignResources</a>(IopRootDeviceNode, newDevice, bootConfigsOK);
00389 
00390                     <span class="comment">//</span>
00391                     <span class="comment">// Process the device subtree to start those devices who have been allocated</span>
00392                     <span class="comment">// resources and waiting to be started.</span>
00393                     <span class="comment">// Note, the IopProcessStartDevices routine may enumerate new devices.</span>
00394                     <span class="comment">//</span>
00395 
00396                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a263">IopProcessStartDevices</a>(IopRootDeviceNode, &amp;startContext);
00397                     newDevice = startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a>;
00398 
00399                 } <span class="keywordflow">while</span> ((moreProcessing || newDevice) &amp;&amp; !bootProcess);
00400 
00401                 allocateResources = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00402                 assignResources = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00403                 bootProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00404                 <a class="code" href="../../d1/d0/pnpdata_8c.html#a19">IopResourcesReleased</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;                  <span class="comment">// This flag is set on device removal</span>
00405 
00406             } <span class="keywordflow">else</span> {
00407 
00408                 ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
00409 
00410                 <span class="keywordflow">if</span> (IsListEmpty(&amp;IopPnpEnumerationRequestList)) {
00411                     <a class="code" href="../../d6/d0/pnpenum_8c.html#a10">IopEnumerationInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00412                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;PiEnumerationLock, 0, FALSE);
00413                     ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
00414                     <span class="keywordflow">return</span>;
00415                 }
00416 
00417                 ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
00418             }
00419 
00420             <span class="keywordflow">continue</span>;
00421         }
00422 
00423         request = CONTAINING_RECORD(entry, <a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html">PI_DEVICE_REQUEST</a>, ListEntry);
00424         <span class="keywordflow">if</span> (request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o1">DeviceObject</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00425 
00426             <span class="comment">//</span>
00427             <span class="comment">// This is a request to retry resource allocation for the</span>
00428             <span class="comment">// DNF_INSUFFICIENT_RESOURCES or ResourceRequirementsChanged devices</span>
00429             <span class="comment">//</span>
00430 
00431             <span class="keywordflow">if</span> (request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o2">RequestType</a> == <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a220">ReenumerateBootDevices</a>) {
00432 
00433                 <span class="comment">//</span>
00434                 <span class="comment">// Indicate that this is during boot driver initialization phase.</span>
00435                 <span class="comment">//</span>
00436 
00437                 bootProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00438 
00439                 <span class="comment">//</span>
00440                 <span class="comment">// Get whether this driver allows BOOT config assignment at its level.</span>
00441                 <span class="comment">//</span>
00442 
00443                 <span class="keywordflow">if</span> (Context) {
00444 
00445                     bootConfigsOK = *(PBOOLEAN)Context;
00446 
00447                 }
00448 
00449             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o2">RequestType</a> == <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a223">ResourceRequirementsChanged</a>) {
00450                 <span class="comment">//</span>
00451                 <span class="comment">// The device wasn't started when IopResourceRequirementsChanged</span>
00452                 <span class="comment">// was called.</span>
00453                 <span class="comment">//</span>
00454                 assignResources = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00455             } <span class="keywordflow">else</span> {
00456                 <span class="comment">//</span>
00457                 <span class="comment">// Resources were freed we want to try to satisfy any</span>
00458                 <span class="comment">// DNF_INSUFFICIENT_RESOURCES devices.</span>
00459                 <span class="comment">//</span>
00460                 allocateResources = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00461             }
00462             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(request);
00463 
00464             <span class="comment">//</span>
00465             <span class="comment">// We've set the flags, we'll do the actual work once we've</span>
00466             <span class="comment">// processed any other requests in the queue.</span>
00467             <span class="comment">//</span>
00468             <span class="keywordflow">continue</span>;
00469         }
00470 
00471         <span class="keywordflow">if</span> (request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o2">RequestType</a> == <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a223">ResourceRequirementsChanged</a>) {
00472 
00473             deviceObject = request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o1">DeviceObject</a>;
00474 
00475             <span class="comment">//</span>
00476             <span class="comment">// Enumerate this object</span>
00477             <span class="comment">//</span>
00478 
00479             <a class="code" href="../../d5/d1/pnpres_8c.html#a113">IopReallocateResources</a>(deviceObject);
00480 
00481         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o2">RequestType</a> == <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a224">StartDevice</a>) {
00482 
00483             <a class="code" href="../../d8/d1/struct__NEW__DEVICE__WORK__ITEM.html">PNEW_DEVICE_WORK_ITEM</a>   newDeviceWorkItem;
00484             <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>            parentNode;
00485 
00486             deviceObject = request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o1">DeviceObject</a>;
00487             deviceNode = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00488 
00489             <span class="comment">//</span>
00490             <span class="comment">// Start the specific device (reenumeration of parent not required in</span>
00491             <span class="comment">// this case) by first registering it then calling kernel-mode new</span>
00492             <span class="comment">// dev routine (note that this routine is normally called via a work</span>
00493             <span class="comment">// item but we're already in a work item now so call it directly.</span>
00494             <span class="comment">//</span>
00495 
00496             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode);
00497 
00498             <span class="comment">//</span>
00499             <span class="comment">// Make sure we don't step on another enumerator's toes</span>
00500             <span class="comment">//</span>
00501 
00502             <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
00503 
00504             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00505             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
00506 
00507             parentNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
00508             <span class="keywordflow">if</span> (parentNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00509                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00510             }
00511 
00512             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
00513             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00514 
00515             <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
00516 
00517             <span class="keywordflow">if</span> (parentNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00518                 status = STATUS_UNSUCCESSFUL;
00519                 <span class="keywordflow">goto</span> Clean0;
00520             }
00521 
00522             <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(parentNode);
00523 
00524             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
00525 
00526                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(parentNode);
00527                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00528                 status = STATUS_SUCCESS;
00529                 <span class="keywordflow">goto</span> Clean0;
00530             }
00531 
00532             <span class="keywordflow">if</span> ((parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; parentNode != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) ||
00533                 !(parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) ||
00534                 !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>) ||
00535                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(deviceNode) ||
00536                 (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>) ||
00537                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> != 0)  {
00538 
00539                 <span class="comment">//</span>
00540                 <span class="comment">// If the parent or child is going away bail now.</span>
00541                 <span class="comment">//</span>
00542                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(parentNode);
00543                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00544                 status = STATUS_UNSUCCESSFUL;
00545                 <span class="keywordflow">goto</span> Clean0;
00546             }
00547 
00548             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a36">IopRestartDeviceNode</a>(deviceNode);
00549 
00550             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a290">IopProcessNewDeviceNode</a>(deviceNode);
00551 
00552             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>, 0, FALSE );
00553 
00554             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; !<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(deviceNode)) {
00555                 PIDBGMSG( PIDBG_EVENTS,
00556                         (<span class="stringliteral">"IopDeviceActionWorker: START_REQUEST - calling IopNewDevice\n"</span>));
00557 
00558                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a289">IopNewDevice</a>(deviceObject);
00559             }
00560 
00561             <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
00562 
00563             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00564         } <span class="keywordflow">else</span> {
00565 
00566             <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    RootNode, parentNode;
00567 
00568             <span class="comment">//</span>
00569             <span class="comment">// Acquire the tree lock so no new removals get processed.</span>
00570             <span class="comment">// Note that devnodes already locked might still get removed while we hold the tree lock.</span>
00571             <span class="comment">//</span>
00572 
00573             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;IopDeviceTreeLock, TRUE);
00574 
00575             <span class="comment">//</span>
00576             <span class="comment">// Reenumerate the target devnode.</span>
00577             <span class="comment">//</span>
00578 
00579             deviceNode = RootNode = request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o1">DeviceObject</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00580             <span class="keywordflow">while</span>(1) {
00581 
00582                 <span class="comment">//</span>
00583                 <span class="comment">// Validate that the devnode is not already removed.</span>
00584                 <span class="comment">//</span>
00585 
00586                 <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00587                 <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
00588 
00589                 parentNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
00590                 <span class="keywordflow">if</span> (parentNode) {
00591                     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00592                 }
00593                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00594 
00595                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
00596                 <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00597 
00598                 <span class="keywordflow">if</span> (parentNode) {
00599 
00600                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> tempNode;
00601 
00602                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(parentNode);
00603                     tempNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
00604                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(parentNode);
00605                     <span class="keywordflow">if</span> (!tempNode) {
00606                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00607                     }
00608                     parentNode = tempNode;
00609                 }
00610 
00611                 <span class="keywordflow">if</span> (!parentNode &amp;&amp; deviceNode != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
00612                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00613                     <span class="keywordflow">break</span>;
00614                 }
00615 
00616                 <span class="comment">//</span>
00617                 <span class="comment">// Make sure that the devnode is ready for enumeration.</span>
00618                 <span class="comment">//</span>
00619 
00620                 <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(deviceNode) &amp;&amp;
00621                     (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>)) == (<a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>)) {
00622 
00623                     <span class="comment">//</span>
00624                     <span class="comment">// Enumerate this object</span>
00625                     <span class="comment">//</span>
00626 
00627                     status = <a class="code" href="../../d6/d0/pnpenum_8c.html#a18">IopBusCheck</a>( deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
00628                                           PnPBootDriversInitialized,     <span class="comment">// LoadDriver</span>
00629                                           (BOOLEAN)(request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o3">CompletionEvent</a> != NULL ? FALSE : PnpAsyncOk));
00630                     <span class="keywordflow">if</span> (status == STATUS_PNP_RESTART_ENUMERATION) {
00631 
00632                         <span class="keywordflow">if</span> (parentNode) {
00633                             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00634                         }
00635                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00636                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;IopDeviceTreeLock);
00637                         <a class="code" href="../../d6/d9/pnp_8h.html#a167">PpSynchronizeDeviceEventQueue</a>();
00638                         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;IopDeviceTreeLock, TRUE);
00639                         deviceNode = RootNode;
00640                         <span class="keywordflow">continue</span>;
00641                     }
00642                 }
00643 
00644                 <span class="comment">//</span>
00645                 <span class="comment">// Process the whole subtree unless specified otherwise.</span>
00646                 <span class="comment">//</span>
00647 
00648                 <span class="keywordflow">if</span> (request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o2">RequestType</a> != <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a219">ReenumerateDeviceOnly</a>) {
00649 
00650                     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>) {
00651 
00652                         <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> child = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00653 
00654                         <span class="keywordflow">if</span> (parentNode) {
00655                             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00656                         }
00657                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00658                         deviceNode = child;
00659 
00660                     } <span class="keywordflow">else</span> {
00661 
00662                         <span class="keywordflow">while</span> (deviceNode != RootNode) {
00663 
00664                             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>) {
00665 
00666                                 <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> sibling = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00667 
00668                                 <span class="keywordflow">if</span> (parentNode) {
00669                                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00670                                 }
00671                                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00672                                 deviceNode = sibling;
00673                                 <span class="keywordflow">break</span>;
00674 
00675                             } <span class="keywordflow">else</span> {
00676 
00677                                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00678                                 deviceNode = parentNode;
00679                                 parentNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
00680                                 <span class="keywordflow">if</span> (parentNode) {
00681                                     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(parentNode-&gt;PhysicalDeviceObject);
00682                                 }
00683                             }
00684                         }
00685                     }
00686                 }
00687 
00688                 <span class="comment">//</span>
00689                 <span class="comment">// We are done if we are back where we started.</span>
00690                 <span class="comment">//</span>
00691 
00692                 <span class="keywordflow">if</span> (deviceNode == RootNode) {
00693 
00694                     <span class="keywordflow">if</span> (parentNode) {
00695                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00696                     }
00697                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00698                     <span class="keywordflow">break</span>;
00699                 }
00700             }
00701 
00702             <span class="comment">//</span>
00703             <span class="comment">// Unlock the tree so removals can proceed.</span>
00704             <span class="comment">//</span>
00705 
00706             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;IopDeviceTreeLock);
00707             status = STATUS_SUCCESS;
00708         }
00709 
00710 Clean0:
00711         <span class="comment">//</span>
00712         <span class="comment">// Done with this enumeration request</span>
00713         <span class="comment">//</span>
00714 
00715         <span class="keywordflow">if</span> (request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o4">CompletionStatus</a>) {
00716             *request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o4">CompletionStatus</a> = status;
00717         }
00718 
00719         <span class="keywordflow">if</span> (request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o3">CompletionEvent</a>) {
00720             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o3">CompletionEvent</a>, 0, FALSE);
00721         }
00722         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o1">DeviceObject</a>);
00723         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(request);
00724     }
00725 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="pnpenum.c::IopEnumerateDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopEnumerateDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">PSTART_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StartContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AsyncOk</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">1163</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00069">ASSERT_INITED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00208">_DEVICE_NODE::BusNumber</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01927">_DEVICE_RELATIONS::Count</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00515">DNF_BEING_ENUMERATED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00563">DNF_DEVICE_GONE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00396">DNF_ENUMERATED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00529">DNF_ENUMERATION_REQUEST_PENDING</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00500">DNF_NEED_ENUMERATION_ONLY</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00553">DNF_REMOVE_PENDING_CLOSES</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01164">DO_BUS_ENUMERATED_DEVICE</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o42">_DEVICE_NODE::DockInfo</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01221">DOE_DELETE_PENDING</a>, <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00207">_DEVICE_NODE::InterfaceType</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00628">IOP_DIAG_THROW_CHAFF_AT_STARTED_PDO_STACK</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01266">IopAcquireEnumerationLock</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00056">IopAllocateDeviceNode()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00134">IopBootConfigsReserved</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00572">IopHardwareProfileCancelRemovedDock()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00447">IopInsertTreeDeviceNode()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01488">IopProcessNewChildren()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">IopQueryDeviceRelations()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01276">IopReleaseEnumerationLock</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">IopRequestDeviceRemoval()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01928">_DEVICE_RELATIONS::Objects</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o32">_DEVICE_NODE::OverUsed1</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00634">PNP_ERR_PDO_ENUMERATED_AFTER_DELETION</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a162">PpSetPlugPlayEvent()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00185">_DEVICE_NODE::ServiceName</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00728">IopBusCheck()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>.
<p>
<pre class="fragment"><div>01171                    :
01172 
01173     This function assumes that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01174     a bus and will enumerate all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> children PDOs on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bus.
01175 
01176 Arguments:
01177 
01178     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical device object to be
01179                    enumerated.
01180 
01181     StartContext - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/struct__START__CONTEXT.html">START_CONTEXT</a> to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> how to
01182                    add/start <span class="keyword">new</span> devices.
01183 
01184     AsyncOk - Specifies can QueryDeviceRelation be done at Async way.
01185 
01186 Return Value:
01187 
01188     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
01189 
01190 --*/
01191 
01192 {
01193     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01194     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
01195     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> childDeviceNode, nextChildDeviceNode;
01196     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> childDeviceObject;
01197     <a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> deviceRelations;
01198     ULONG i;
01199     BOOLEAN childRemoved, newChildPostponed;
01200 
01201     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01202 
01203     <span class="comment">//</span>
01204     <span class="comment">// First get a reference to the PDO to make sure it won't go away.</span>
01205     <span class="comment">//</span>
01206 
01207     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(DeviceObject);
01208 
01209     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
01210 
01211     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a25">DNF_NEED_ENUMERATION_ONLY</a>) {
01212 
01213         <span class="comment">//</span>
01214         <span class="comment">// This means this device was just started and needed enumeration.</span>
01215         <span class="comment">// So, we will report the device arrival.</span>
01216         <span class="comment">//</span>
01217 
01218         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a25">DNF_NEED_ENUMERATION_ONLY</a>;
01219         <span class="comment">//</span>
01220         <span class="comment">// The device has been started, attempt to enumerate the device.</span>
01221         <span class="comment">//</span>
01222 
01223         <a class="code" href="../../d6/d9/pnp_8h.html#a162">PpSetPlugPlayEvent</a>( &amp;GUID_DEVICE_ARRIVAL,
01224                             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
01225 
01226         <a class="code" href="../../d9/d4/trackirp_8h.html#a78">IOP_DIAG_THROW_CHAFF_AT_STARTED_PDO_STACK</a>(DeviceObject);
01227 <span class="preprocessor">#if DBG</span>
01228 <span class="preprocessor"></span>        {
01229 
01230             <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
01231             ULONG <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
01232 
01233             <span class="comment">//</span>
01234             <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
01235             <span class="comment">//</span>
01236 
01237             RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
01238 
01239             <span class="comment">//</span>
01240             <span class="comment">// Set the function codes.</span>
01241             <span class="comment">//</span>
01242 
01243             irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
01244             irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = 0xff;
01245 
01246             <span class="comment">//</span>
01247             <span class="comment">// Make the call and return.</span>
01248             <span class="comment">//</span>
01249 
01250             status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, (PVOID)&amp;dummy);
01251             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a> != 0) {
01252                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>.Buffer) {
01253                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** BugBug : Driver %wZ returned status = %lx and Information = %lx\n"</span>,
01254                              &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>, status, dummy);
01255                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    for IRP_MN_BOGUS.  "</span>);
01256                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
01257                 } <span class="keywordflow">else</span> {
01258                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** BugBug : Driver returned status = %lx and Information = %lx\n"</span>, status, dummy);
01259                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    for IRP_MN_BOGUS.  "</span>);
01260                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
01261                 }
01262             }
01263         }
01264 
01265 <span class="preprocessor">#endif</span>
01266 <span class="preprocessor"></span>    }
01267 
01268     <span class="comment">//</span>
01269     <span class="comment">// Make sure we don't step on another enumerator's toes</span>
01270     <span class="comment">//</span>
01271 
01272     <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(deviceNode);
01273 
01274     <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a>)) != <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
01275         status = STATUS_UNSUCCESSFUL;
01276     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a29">DNF_ENUMERATION_REQUEST_PENDING</a>) {
01277         <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a27">DNF_BEING_ENUMERATED</a>)) {
01278 
01279             <span class="comment">//</span>
01280             <span class="comment">// The enumeration lock of the device must be acquired already</span>
01281             <span class="comment">// before performing following instructions.</span>
01282             <span class="comment">//</span>
01283 
01284             deviceRelations = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.PendingDeviceRelations;
01285             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.PendingDeviceRelations = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01286             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a29">DNF_ENUMERATION_REQUEST_PENDING</a>;
01287             status = STATUS_SUCCESS;
01288         } <span class="keywordflow">else</span> {
01289             status = STATUS_UNSUCCESSFUL;
01290         }
01291     } <span class="keywordflow">else</span> {
01292         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a22">IopQueryDeviceRelations</a>(BusRelations, DeviceObject, AsyncOk, &amp;deviceRelations);
01293     }
01294     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || (status == STATUS_PENDING) || !deviceRelations) {
01295         status = STATUS_SUCCESS;
01296         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01297     }
01298 
01299     <span class="comment">//</span>
01300     <span class="comment">// Walk all the child device nodes and mark them as not present</span>
01301     <span class="comment">//</span>
01302 
01303     childDeviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
01304     <span class="keywordflow">while</span> (childDeviceNode) {
01305         childDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>;
01306         childDeviceNode = childDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
01307     }
01308 
01309     <span class="comment">//</span>
01310     <span class="comment">// Check all the PDOs returned see if any new one or any one disappeared.</span>
01311     <span class="comment">//</span>
01312 
01313     <span class="keywordflow">for</span> (i = 0; i &lt; deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o0">Count</a>; i++) {
01314 
01315         childDeviceObject = deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o1">Objects</a>[i];
01316 
01317         <a class="code" href="../../d6/d0/pnpenum_8c.html#a0">ASSERT_INITED</a>(childDeviceObject);
01318 
01319         <span class="keywordflow">if</span> (childDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a139">DOE_DELETE_PENDING</a>) {
01320 
01321             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
01322                           PNP_ERR_PDO_ENUMERATED_AFTER_DELETION,
01323                           (ULONG_PTR)childDeviceObject,
01324                           0,
01325                           0);
01326         }
01327 
01328         <span class="comment">//</span>
01329         <span class="comment">// We've found another physical device, see if there is</span>
01330         <span class="comment">// already a devnode for it.</span>
01331         <span class="comment">//</span>
01332 
01333         childDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)childDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01334         <span class="keywordflow">if</span> (childDeviceNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01335 
01336             <span class="comment">//</span>
01337             <span class="comment">// Device node doesn't exist, create one.</span>
01338             <span class="comment">//</span>
01339 
01340             childDeviceNode = <a class="code" href="../../d9/d0/pnpiop_8h.html#a252">IopAllocateDeviceNode</a>(childDeviceObject);
01341 
01342             <span class="keywordflow">if</span> (childDeviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01343 
01344                 <span class="comment">//</span>
01345                 <span class="comment">// We've found or created a devnode for the PDO that the</span>
01346                 <span class="comment">// bus driver just enumerated.</span>
01347                 <span class="comment">//</span>
01348 
01349                 childDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>;
01350 
01351                 <span class="comment">//</span>
01352                 <span class="comment">// Mark the device object a bus enumerated device</span>
01353                 <span class="comment">// BUGBUG - should be an ASSERT.  This should be set by bus drivers.</span>
01354                 <span class="comment">//</span>
01355 
01356                 childDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>;
01357 
01358                 <span class="comment">//</span>
01359                 <span class="comment">// Put this new device node at the head of the parent's list</span>
01360                 <span class="comment">// of children.</span>
01361                 <span class="comment">//</span>
01362 
01363                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a250">IopInsertTreeDeviceNode</a> (
01364                     deviceNode,
01365                     childDeviceNode
01366                     );
01367 
01368             } <span class="keywordflow">else</span> {
01369 
01370                 <span class="comment">//</span>
01371                 <span class="comment">// Had a problem creating a devnode.  Pretend we've never</span>
01372                 <span class="comment">// seen it.</span>
01373                 <span class="comment">//</span>
01374                 KdPrint((<span class="stringliteral">"IopEnumerateDevice: Failed to allocate device node space\n"</span>));
01375                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(childDeviceObject);
01376             }
01377         } <span class="keywordflow">else</span> {
01378 
01379             <span class="comment">//</span>
01380             <span class="comment">// The device is alreay enumerated.  Remark it and release the</span>
01381             <span class="comment">// device object reference.</span>
01382             <span class="comment">//</span>
01383             childDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>;
01384 
01385             <span class="keywordflow">if</span> (childDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a>) {
01386 
01387                 <span class="comment">//</span>
01388                 <span class="comment">// A dock that was listed as departing in an eject relation</span>
01389                 <span class="comment">// didn't actually leave. Remove it from the profile transition</span>
01390                 <span class="comment">// list...</span>
01391                 <span class="comment">//</span>
01392                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a382">IopHardwareProfileCancelRemovedDock</a>(childDeviceNode);
01393             }
01394 
01395             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(childDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; DNF_DEVICE_GONE));
01396 
01397             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(childDeviceObject);
01398         }
01399     }
01400 
01401     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceRelations);
01402 
01403     <span class="comment">//</span>
01404     <span class="comment">// If we get here, the enumeration was successful.  First process</span>
01405     <span class="comment">// any missing devnodes.</span>
01406     <span class="comment">//</span>
01407 
01408     childRemoved = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01409 
01410     <span class="keywordflow">for</span> (childDeviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
01411          childDeviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01412          childDeviceNode = nextChildDeviceNode) {
01413 
01414         <span class="comment">//</span>
01415         <span class="comment">// First, we need to remember the 'next child' because the 'child' will be</span>
01416         <span class="comment">// removed and we won't be able to find the 'next child.'</span>
01417         <span class="comment">//</span>
01418 
01419         nextChildDeviceNode = childDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
01420 
01421         <span class="keywordflow">if</span> (!(childDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>)) {
01422 
01423             <span class="keywordflow">if</span> (!(childDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a33">DNF_DEVICE_GONE</a>)) {
01424 
01425                 childDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a33">DNF_DEVICE_GONE</a>;
01426 
01427                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>( childDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
01428                                          CM_PROB_DEVICE_NOT_THERE);
01429 
01430                 childRemoved = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01431             }
01432         }
01433     }
01434 
01435     <span class="comment">//</span>
01436     <span class="comment">// BUGBUG - currently the root enumerator gets confused if we reenumerate it</span>
01437     <span class="comment">// before we process newly reported PDOs.  Since it can't possibly create</span>
01438     <span class="comment">// the scenario we are trying to fix, we won't bother waiting for the</span>
01439     <span class="comment">// removes to complete before processing the new devnodes.</span>
01440     <span class="comment">//</span>
01441 
01442     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; childRemoved) {
01443 
01444         status = STATUS_PNP_RESTART_ENUMERATION;
01445 
01446         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01447     }
01448 
01449     <span class="comment">//</span>
01450     <span class="comment">// Reserve legacy resources for the legacy interface and bus number.</span>
01451     <span class="comment">//</span>
01452 
01453     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/pnpdata_8c.html#a18">IopBootConfigsReserved</a> &amp;&amp; deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o17">InterfaceType</a> != InterfaceTypeUndefined) {
01454 
01455         <span class="comment">//</span>
01456         <span class="comment">// EISA = ISA.</span>
01457         <span class="comment">//</span>
01458 
01459         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o17">InterfaceType</a> == Isa) {
01460 
01461             <a class="code" href="../../d5/d1/pnpres_8c.html#a110">IopReserveLegacyBootResources</a>(Eisa, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o18">BusNumber</a>);
01462 
01463         }
01464 
01465         <a class="code" href="../../d5/d1/pnpres_8c.html#a110">IopReserveLegacyBootResources</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o17">InterfaceType</a>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o18">BusNumber</a>);
01466 
01467     }
01468 
01469     <span class="comment">//</span>
01470     <span class="comment">// Now process new devnodes that have just appeared.</span>
01471     <span class="comment">//</span>
01472     <span class="comment">// Walk all of the children to perform driver loading and device addition operations.</span>
01473     <span class="comment">//</span>
01474 
01475     <a class="code" href="../../d6/d0/pnpenum_8c.html#a24">IopProcessNewChildren</a>(deviceNode, StartContext);
01476 
01477     status = STATUS_SUCCESS;
01478 
01479 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
01480 
01481     <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(deviceNode);
01482     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DeviceObject);
01483 
01484     <span class="keywordflow">return</span> status;
01485 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="pnpenum.c::IopFixupDeviceId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopFixupDeviceId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PWCHAR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04514">4514</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>04520                    :
04521 
04522     This routine parses <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance string and replaces any invalid
04523     characters (not allowed in a <span class="stringliteral">"device instance"</span>) with an underscore
04524     character.
04525 
04526     Invalid characters are:
04527         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &lt;= 0x20 (<span class="charliteral">' '</span>)
04528         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &gt;  0x7F
04529         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> == 0x2C (<span class="charliteral">','</span>)
04530 
04531 Arguments:
04532 
04533     DeviceId - specifies a device instance string (or part of one), must be
04534                null-terminated.
04535 
04536 Return Value:
04537 
04538     None.
04539 
04540 --*/
04541 
04542 {
04543     PWCHAR p;
04544 
04545     <span class="comment">// BUGBUG - do we need to uppercase these!?</span>
04546 
04547     <span class="keywordflow">for</span> (p = DeviceId; *p; p++) {
04548         <span class="keywordflow">if</span> (*p == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>) {
04549             *p = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'_'</span>;
04550         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((*p &lt; L' ')  || (*p &gt; (WCHAR)0x7F) || (*p == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">','</span>)) {
04551             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04552         }
04553     }
04554 
04555     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04556 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="pnpenum.c::IopFixupIds" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopFixupIds           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Ids</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04559">4559</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a376">IopFixupDeviceId()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>.
<p>
<pre class="fragment"><div>04566                    :
04567 
04568     This routine parses multiple IDs and replaces any invalid
04569     characters (not allowed in a <span class="stringliteral">"device instance"</span>) with an underscore
04570     character.
04571 
04572     Invalid characters are:
04573         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &lt;= 0x20 (<span class="charliteral">' '</span>)
04574         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &gt;  0x7F
04575         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> == 0x2C (<span class="charliteral">','</span>)
04576 
04577 Arguments:
04578 
04579     Ids - specifies MULTI_SZ ids.
04580 
04581     Length - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lenght of Ids
04582 
04583 Return Value:
04584 
04585     None.
04586 
04587 --*/
04588 
04589 {
04590     PWCHAR p, end;
04591 
04592     p = Ids;
04593     end = p + Length / <span class="keyword">sizeof</span>(WCHAR);
04594 
04595     <span class="keywordflow">while</span> ((p &lt; end) &amp;&amp; (*p)) {
04596         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a376">IopFixupDeviceId</a>(p)) {
04597             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04598         }
04599 
04600         <span class="keywordflow">while</span> (*p) {
04601             p++;
04602         }
04603         p++;
04604     }
04605     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04606 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="pnpenum.c::IopGetBusTypeGuidIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> IopGetBusTypeGuidIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN LPGUID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>busTypeGuid</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04425">4425</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a186">BUS_TYPE_GUID_LIST</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02415">_BUS_TYPE_GUID_LIST::Count</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02425">_BUS_TYPE_GUID_LIST::Guid</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00161">IopBusTypeGuidList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02070">IopCompareGuid</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02420">_BUS_TYPE_GUID_LIST::Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>04431                    :
04432 
04433     This routine returns an index into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> global table of bus <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> guids <span class="keywordflow">for</span>
04434     guid specified. If <span class="keyword">this</span> guid <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not already in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table, then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will be
04435     added and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> table entry will be returned. This index
04436     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> later used by <a class="code" href="../../d6/d9/pnp_8h.html#a144">IoGetDeviceProperty</a> to retrieve and <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bus <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
04437     guid back to callers but allows us not to bother storing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire guid
04438     in each devnode (just once per guid in the table).
04439 
04440 Arguments:
04441 
04442     BusTypeGuid - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> guid to retrieve an index <span class="keywordflow">for</span>
04443 
04444 Return Value:
04445 
04446     The index (into the IopBusTypeGuidList table) <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified guid.
04447 
04448 --*/
04449 
04450 {
04451     PCHAR p;
04452     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i, busTypeIndex = 0xffff;   <span class="comment">// unreported</span>
04453     ULONG size;
04454 
04455     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IopBusTypeGuidList != NULL);
04456 
04457     ExAcquireFastMutex(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a>-&gt;<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html#o1">Lock</a>);
04458 
04459     <span class="comment">//</span>
04460     <span class="comment">// Search the guid list for a match</span>
04461     <span class="comment">//</span>
04462     <span class="keywordflow">for</span> (i = 0; i &lt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a>-&gt;<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html#o0">Count</a>; i++) {
04463         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(BusTypeGuid, &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a>-&gt;<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html#o2">Guid</a>[i])) {
04464             busTypeIndex = i;
04465             <span class="keywordflow">goto</span> Clean0;
04466         }
04467     }
04468 
04469     <span class="comment">//</span>
04470     <span class="comment">// Bus type guid doesn't exist in the list.</span>
04471     <span class="comment">//</span>
04472 
04473     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a>-&gt;<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html#o0">Count</a> &gt; 0) {
04474 
04475         <span class="comment">//</span>
04476         <span class="comment">// Reallocate to hold one more guid.</span>
04477         <span class="comment">//</span>
04478 
04479         size = <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">BUS_TYPE_GUID_LIST</a>) +
04480                <span class="keyword">sizeof</span>(GUID) * (<a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a>-&gt;<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html#o0">Count</a>);
04481 
04482         p = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, size);
04483         <span class="keywordflow">if</span> (!p) {
04484             <span class="keywordflow">goto</span> Clean0;    <span class="comment">// oops, no more room, return unreported</span>
04485         }
04486 
04487         size = <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">BUS_TYPE_GUID_LIST</a>) +
04488                <span class="keyword">sizeof</span>(GUID) * (<a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a>-&gt;<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html#o0">Count</a> - 1);
04489 
04490         RtlCopyMemory(p, IopBusTypeGuidList, size);
04491 
04492         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IopBusTypeGuidList);
04493         <a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a> = (<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">PBUS_TYPE_GUID_LIST</a>)p;
04494     }
04495 
04496     <span class="comment">//</span>
04497     <span class="comment">// Add the new guid to the list.</span>
04498     <span class="comment">//</span>
04499     RtlCopyMemory(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a>-&gt;<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html#o2">Guid</a>[<a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a>-&gt;<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html#o0">Count</a>],
04500                   BusTypeGuid,
04501                   <span class="keyword">sizeof</span>(GUID));
04502 
04503     busTypeIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a>-&gt;<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html#o0">Count</a>;
04504     <a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a>-&gt;<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html#o0">Count</a> += 1;
04505 
04506 Clean0:
04507 
04508     ExReleaseFastMutex(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a>-&gt;<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html#o1">Lock</a>);
04509 
04510     <span class="keywordflow">return</span> busTypeIndex;
04511 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="pnpenum.c::IopGetRegistryDwordWithFallback" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopGetRegistryDwordWithFallback           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>valueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SecondaryKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Value</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04610">4610</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04759">IopChangeDeviceObjectFromRegistryProperties()</a>.
<p>
<pre class="fragment"><div>04617                    :
04618 
04619     If
04620         (1) Primary key has a value named <span class="stringliteral">"ValueName"</span> that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> REG_DWORD, <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
04621     Else If
04622         (2) Secondary key has a value named <span class="stringliteral">"ValueName"</span> that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> REG_DWORD, <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
04623     Else
04624         (3) Leave Value untouched and <span class="keywordflow">return</span> error
04625 
04626 Arguments:
04627 
04628     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>          - <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> name of value to query
04629     PrimaryKey         - If non-null, check <span class="keyword">this</span> first
04630     SecondaryKey       - If non-null, check <span class="keyword">this</span> second
04631     Value              - IN = <span class="keywordflow">default</span> value, OUT = actual value
04632 
04633 Return Value:
04634 
04635     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> value found
04636 
04637 --*/
04638 {
04639     PKEY_VALUE_FULL_INFORMATION info;
04640     PUCHAR data;
04641     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04642     HANDLE Keys[3];
04643     <span class="keywordtype">int</span> count = 0;
04644     <span class="keywordtype">int</span> index;
04645     BOOLEAN set = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04646 
04647     <span class="keywordflow">if</span> (PrimaryKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04648         Keys[count++] = PrimaryKey;
04649     }
04650     <span class="keywordflow">if</span> (SecondaryKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04651         Keys[count++] = SecondaryKey;
04652     }
04653     Keys[count] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04654 
04655     <span class="keywordflow">for</span> (index = 0; index &lt; count &amp;&amp; !set; index ++) {
04656         info = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04657         <span class="keywordflow">try</span> {
04658             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(Keys[index],
04659                                          valueName-&gt;Buffer,
04660                                          &amp;info);
04661             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; info-&gt;Type == REG_DWORD) {
04662                 data = ((PUCHAR) info) + info-&gt;DataOffset;
04663                 *Value = *((PULONG) data);
04664                 set = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04665             }
04666         } except(EXCEPTION_EXECUTE_HANDLER) {
04667             <span class="comment">//</span>
04668             <span class="comment">// do nothing</span>
04669             <span class="comment">//</span>
04670         }
04671         <span class="keywordflow">if</span> (info) {
04672             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(info);
04673         }
04674     }
04675     <span class="keywordflow">return</span> set;
04676 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="pnpenum.c::IopGetRegistrySecurityWithFallback" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PSECURITY_DESCRIPTOR IopGetRegistrySecurityWithFallback           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>valueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SecondaryKey</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04679">4679</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00053">SeCaptureSecurityDescriptor()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04759">IopChangeDeviceObjectFromRegistryProperties()</a>.
<p>
<pre class="fragment"><div>04685                    :
04686 
04687     If
04688         (1) Primary key has a binary value named <span class="stringliteral">"ValueName"</span> that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04689         REG_BINARY and appears to be a valid security descriptor, <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
04690     Else
04691         (2) <span class="keywordflow">do</span> same <span class="keywordflow">for</span> Secondary key
04692     Else
04693         (3) Return <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04694 
04695 Arguments:
04696 
04697     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>          - <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> name of value to query
04698     PrimaryKey         - If non-null, check <span class="keyword">this</span> first
04699     SecondaryKey       - If non-null, check <span class="keyword">this</span> second
04700 
04701 Return Value:
04702 
04703     Security Descriptor <span class="keywordflow">if</span> found, <span class="keywordflow">else</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04704 
04705 --*/
04706 {
04707     PKEY_VALUE_FULL_INFORMATION info;
04708     PUCHAR data;
04709     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04710     HANDLE Keys[3];
04711     <span class="keywordtype">int</span> count = 0;
04712     <span class="keywordtype">int</span> index;
04713     BOOLEAN set = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04714     PSECURITY_DESCRIPTOR secDesc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04715     PSECURITY_DESCRIPTOR allocDesc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04716 
04717     <span class="keywordflow">if</span> (PrimaryKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04718         Keys[count++] = PrimaryKey;
04719     }
04720     <span class="keywordflow">if</span> (SecondaryKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04721         Keys[count++] = SecondaryKey;
04722     }
04723     Keys[count] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04724 
04725     <span class="keywordflow">for</span> (index = 0; index &lt; count &amp;&amp; !set; index ++) {
04726         info = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04727         <span class="keywordflow">try</span> {
04728             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(Keys[index],
04729                                          valueName-&gt;Buffer,
04730                                          &amp;info);
04731             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; info-&gt;Type == REG_BINARY) {
04732                 data = ((PUCHAR) info) + info-&gt;DataOffset;
04733                 secDesc = (PSECURITY_DESCRIPTOR)data;
04734                 status = <a class="code" href="../../d2/d5/se_2capture_8c.html#a1">SeCaptureSecurityDescriptor</a>(secDesc,
04735                                              KernelMode,
04736                                              PagedPool,
04737                                              TRUE,
04738                                              &amp;allocDesc);
04739                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04740                     set = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04741                 }
04742             }
04743         } except(EXCEPTION_EXECUTE_HANDLER) {
04744             <span class="comment">//</span>
04745             <span class="comment">// do nothing</span>
04746             <span class="comment">//</span>
04747         }
04748         <span class="keywordflow">if</span> (info) {
04749             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(info);
04750         }
04751     }
04752     <span class="keywordflow">if</span> (set) {
04753         <span class="keywordflow">return</span> allocDesc;
04754     }
04755     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04756 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="pnpenum.c::IopProcessCriticalDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopProcessCriticalDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03762">3762</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00052">DebugPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00831">IopClearDevNodeProblem</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05668">IopFreeAllocatedUnicodeString()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00828">IopIsDevNodeProblem</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04000">IopProcessCriticalDeviceRoutine()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>.
<p>
<pre class="fragment"><div>03768                    :
03769 
03770     This routine will check whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="stringliteral">"critical"</span> one (see the
03771     top of <span class="keyword">this</span> file <span class="keywordflow">for</span> a description of critical).  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> critical
03772     then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will be assigned a service based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of
03773     IopCriticalDeviceList.
03774 
03775 Arguments:
03776 
03777     DeviceNode - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node to process
03778 
03779 Return Value:
03780 
03781     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> critical
03782     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
03783 
03784 --*/
03785 
03786 {
03787     HANDLE enumKey;
03788     HANDLE instanceKey;
03789 
03790     UNICODE_STRING service, classGuid, lowerFilters, upperFilters;
03791     BOOLEAN foundMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03792 
03793     RTL_QUERY_REGISTRY_TABLE queryTable[2];
03794 
03795     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03796 
03797 <span class="preprocessor">#if DBG_SCOPE</span>
03798 <span class="preprocessor"></span>    PWCHAR str;
03799     ULONG length;
03800 <span class="preprocessor">#endif</span>
03801 <span class="preprocessor"></span>
03802     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopIsCriticalPnpDevice called for devnode %#08lx\n"</span>, DeviceNode));
03803 
03804     <span class="comment">//</span>
03805     <span class="comment">// Open the HKLM\System\CCS\Enum key.</span>
03806     <span class="comment">//</span>
03807 
03808     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumKey,
03809                                    NULL,
03810                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
03811                                    KEY_READ
03812                                    );
03813 
03814     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03815         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IICPD: couldn't open enum key %#08lx\n"</span>, status));
03816         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03817     }
03818 
03819     <span class="comment">//</span>
03820     <span class="comment">// Open the instance key for this devnode</span>
03821     <span class="comment">//</span>
03822 
03823     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;instanceKey,
03824                                    enumKey,
03825                                    &amp;DeviceNode-&gt;InstancePath,
03826                                    KEY_ALL_ACCESS
03827                                    );
03828 
03829     ZwClose(enumKey);
03830 
03831     <span class="comment">//</span>
03832     <span class="comment">// First determine if this is a critical device type</span>
03833     <span class="comment">//</span>
03834 
03835     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03836         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IICPD: couldn't open instance path key %wZ [%#08lx]\n"</span>,
03837                        &amp;(DeviceNode-&gt;InstancePath)));
03838         ZwClose(instanceKey);
03839         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03840 
03841     } <span class="keywordflow">else</span> {
03842         <span class="comment">//</span>
03843         <span class="comment">// Call IopProcessCriticalDeviceRoutine to</span>
03844         <span class="comment">// enumerate entries in the CriticalDeviceDatabase</span>
03845         <span class="comment">// and compare with HardwareId and CompatibleIds</span>
03846         <span class="comment">// value data from instanceKey.</span>
03847         <span class="comment">//</span>
03848         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;service, NULL);
03849         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;classGuid, NULL);
03850         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;lowerFilters, NULL);
03851         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;upperFilters, NULL);
03852         status = <a class="code" href="../../d6/d0/pnpenum_8c.html#a22">IopProcessCriticalDeviceRoutine</a>(instanceKey,
03853                                                  &amp;foundMatch,
03854                                                  &amp;service,
03855                                                  &amp;classGuid,
03856                                                  &amp;lowerFilters,
03857                                                  &amp;upperFilters);
03858         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03859             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IICPD: IopProcessCriticalDeviceRoutine failed with status %#08lx\n"</span>, status));
03860             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03861         }
03862 
03863     }
03864 
03865     <span class="comment">//</span>
03866     <span class="comment">// If we get here then this is a "critical" device and we know the service</span>
03867     <span class="comment">// to setup for it.  Set the service value in the registry.</span>
03868     <span class="comment">//</span>
03869 
03870     <span class="keywordflow">if</span> (!foundMatch) {
03871         ZwClose(instanceKey);
03872         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03873 
03874     } <span class="keywordflow">else</span> {
03875         UNICODE_STRING serviceValue, classGuidValue, lowerFiltersValue,
03876                        upperFiltersValue;
03877 
03878         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDevice: Setting up critical service\n"</span>));
03879 
03880         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;serviceValue, REGSTR_VALUE_SERVICE);
03881         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;classGuidValue, REGSTR_VALUE_CLASSGUID);
03882         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;lowerFiltersValue, REGSTR_VALUE_LOWERFILTERS);
03883         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;upperFiltersValue, REGSTR_VALUE_UPPERFILTERS);
03884 
03885         <span class="keywordflow">if</span> (classGuid.Buffer) {
03886             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDevice: classGuid is %wZ\n"</span>,
03887                            &amp;classGuid));
03888             status = ZwSetValueKey(instanceKey,
03889                                    &amp;classGuidValue,
03890                                    0L,
03891                                    REG_SZ,
03892                                    classGuid.Buffer,
03893                                    classGuid.Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
03894         }
03895         <span class="keywordflow">if</span> (lowerFilters.Buffer) {
03896 <span class="preprocessor">#if DBG_SCOPE</span>
03897 <span class="preprocessor"></span>            str = lowerFilters.Buffer;
03898             <span class="keywordflow">while</span> ((length = wcslen(str)) != 0) {
03899                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDevice: lower filter is %ws\n"</span>,
03900                                str));
03901                 str += (length + 1);
03902             }
03903 <span class="preprocessor">#endif</span>
03904 <span class="preprocessor"></span>            status = ZwSetValueKey(instanceKey,
03905                                    &amp;lowerFiltersValue,
03906                                    0L,
03907                                    REG_MULTI_SZ,
03908                                    lowerFilters.Buffer,
03909                                    lowerFilters.Length); <span class="comment">// + sizeof(UNICODE_NULL));</span>
03910         }
03911 
03912         <span class="keywordflow">if</span> (upperFilters.Buffer) {
03913 <span class="preprocessor">#if DBG_SCOPE</span>
03914 <span class="preprocessor"></span>            str = upperFilters.Buffer;
03915             <span class="keywordflow">while</span> ((length = wcslen(str)) != 0) {
03916                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDevice: upper filter is %ws\n"</span>,
03917                                str));
03918                 str += (length + 1);
03919             }
03920 <span class="preprocessor">#endif</span>
03921 <span class="preprocessor"></span>            status = ZwSetValueKey(instanceKey,
03922                                    &amp;upperFiltersValue,
03923                                    0L,
03924                                    REG_MULTI_SZ,
03925                                    upperFilters.Buffer,
03926                                    upperFilters.Length); <span class="comment">// + sizeof(UNICODE_NULL));</span>
03927         }
03928 
03929         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDevice: service is %wZ\n"</span>,
03930                        &amp;service));
03931         status = ZwSetValueKey(instanceKey,
03932                                &amp;serviceValue,
03933                                0L,
03934                                REG_SZ,
03935                                service.Buffer,
03936                                service.Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
03937 
03938         <span class="comment">//</span>
03939         <span class="comment">// If the service was set properly set the CONFIGFLAG_FINISH_INSTALL so</span>
03940         <span class="comment">// we will still get a new hw found popup and go through the class</span>
03941         <span class="comment">// installer.</span>
03942         <span class="comment">//</span>
03943 
03944         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03945 
03946             UCHAR buffer[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <span class="keyword">sizeof</span>(ULONG)];
03947             UNICODE_STRING valueName;
03948             PKEY_VALUE_PARTIAL_INFORMATION keyInfo =
03949                 (PKEY_VALUE_PARTIAL_INFORMATION) buffer;
03950             ULONG flags = 0;
03951 
03952             ULONG length;
03953 
03954             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> tmpStatus;
03955 
03956             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, REGSTR_VALUE_CONFIG_FLAGS);
03957 
03958             tmpStatus = ZwQueryValueKey(instanceKey,
03959                                         &amp;valueName,
03960                                         KeyValuePartialInformation,
03961                                         keyInfo,
03962                                         <span class="keyword">sizeof</span>(buffer),
03963                                         &amp;length);
03964 
03965             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(tmpStatus) &amp;&amp; (keyInfo-&gt;Type == REG_DWORD)) {
03966 
03967                 flags = *(PULONG)keyInfo-&gt;Data;
03968             }
03969 
03970             flags &amp;= ~(CONFIGFLAG_REINSTALL | CONFIGFLAG_FAILEDINSTALL);
03971             flags |= CONFIGFLAG_FINISH_INSTALL;
03972 
03973             ZwSetValueKey(instanceKey,
03974                           &amp;valueName,
03975                           0L,
03976                           REG_DWORD,
03977                           &amp;flags,
03978                           <span class="keyword">sizeof</span>(ULONG));
03979 
03980             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode) ||
03981                    <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED) ||
03982                    <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_FAILED_INSTALL) ||
03983                    <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_REINSTALL));
03984 
03985             <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(DeviceNode);
03986         }
03987         ZwClose(instanceKey);
03988     }
03989 
03990     <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(&amp;service);
03991     <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(&amp;classGuid);
03992     <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(&amp;lowerFilters);
03993     <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(&amp;upperFilters);
03994 
03995     <span class="keywordflow">return</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
03996 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="pnpenum.c::IopProcessCriticalDeviceRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopProcessCriticalDeviceRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>hDevInstance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FoundMatch</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ClassGuid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>LowerFilters</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>UpperFilters</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04000">4000</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02394">_BUFFER_INFO::Buffer</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a184">BUFFER_INFO</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00167">CmRegistryMachineName</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00052">DebugPrint</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d0/pnpenum_8c.html#a4">INITIAL_INFOBUFFER_SIZE</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02427">IopAllocateBuffer()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02536">IopFreeBuffer()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a358">IopReplaceSeperatorWithPound()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02467">IopResizeBuffer()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02406">_BUFFER_INFO::MaxSize</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d0/pnpenum_8c.html#a5">NUM_QUERIES</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l00744">RtlQueryRegistryValues()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03762">IopProcessCriticalDevice()</a>.
<p>
<pre class="fragment"><div>04012                    :
04013 
04014     This routine will enumerate all values of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CriticalDeviceDatabase
04015     registry key, and compare each with entries within
04016     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> HardwareId and CompatibleIds values of key associated
04017     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current device instance.
04018 
04019 Arguments:
04020 
04021     HDevInstance - HANDLE to device instance.
04022 
04023     FoundMatch - receives <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> a match was found.
04024 
04025     ServiceName - receives name of service to be assigned to
04026                   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance pointed to by
04027           HDevInstance.
04028 
04029 Return Value:
04030 
04031     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code
04032 
04033          STATUS_SUCCESS
04034      STATUS_INVALID_PARAMETER
04035 
04036 --*/
04037 
04038 {
04039     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    status;
04040     HANDLE                      hRegistryMachine, hCriticalDeviceKey,
04041                                 hCriticalEntry;
04042     PWSTR                       keyValueInfoTag[2];
04043     PKEY_VALUE_FULL_INFORMATION keyValueInfo[2], matchedKeyValFullInfo;
04044     <a class="code" href="../../d4/d5/struct__BUFFER__INFO.html">BUFFER_INFO</a>                 infoBuffer;
04045     ULONG                       enumIndex, idIndex, resultSize, stringLength;
04046     UNICODE_STRING              tmpUnicodeString, unicodeCriticalEntry,
04047                                 unicodeCriticalDeviceKeyName;
04048     PWCHAR                      stringStart, bufferEnd, ptr;
04049     PRTL_QUERY_REGISTRY_TABLE   parameters = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04050 
04051 <span class="preprocessor">#define INITIAL_INFOBUFFER_SIZE sizeof(KEY_VALUE_FULL_INFORMATION) + 8*sizeof(WCHAR) + 255*sizeof(WCHAR)</span>
04052 <span class="preprocessor"></span>
04053     hRegistryMachine = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04054     hCriticalDeviceKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04055     infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04056 
04057     <span class="comment">//</span>
04058     <span class="comment">//  Read Key Value Information</span>
04059     <span class="comment">//  from HardwareId and CompatibleIds values</span>
04060     <span class="comment">//</span>
04061     <span class="comment">// keyValueInfo[idIndex == 0] == REGSTR_VAL_HARDWAREID == "HardwareId"</span>
04062     <span class="comment">// keyValueInfo[idIndex == 1] == REGSTR_VAL_COMPATIBLEIDS == "CompatibleIds"</span>
04063     <span class="comment">//</span>
04064     keyValueInfoTag[0] = REGSTR_VAL_HARDWAREID;
04065     keyValueInfoTag[1] = REGSTR_VAL_COMPATIBLEIDS;
04066 
04067     <span class="keywordflow">for</span> (idIndex = 0; idIndex &lt; 2; idIndex++) {
04068 
04069         keyValueInfo[idIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04070         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(HDevInstance,
04071                                      keyValueInfoTag[idIndex],
04072                                      &amp;keyValueInfo[idIndex]);
04073         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04074 
04075             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDeviceRoutine: Unable to get some "</span>
04076                            <span class="stringliteral">"%ws value info, %#08lx. continuing.\n"</span>,
04077                            keyValueInfoTag[idIndex], status));
04078 
04079         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((keyValueInfo[idIndex]-&gt;Type != REG_MULTI_SZ) ||
04080                    (keyValueInfo[idIndex]-&gt;DataLength == 0)) {
04081 
04082             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInfo[idIndex]);
04083             keyValueInfo[idIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04084             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDeviceRoutine: some %ws"</span>
04085                            <span class="stringliteral">"Key Value Info not in expected format\n"</span>,
04086                            keyValueInfoTag[idIndex]));
04087         } <span class="keywordflow">else</span> {
04088 
04089             <span class="comment">//</span>
04090             <span class="comment">// It is good, make sure all of the IDs match '\' replacement policy</span>
04091             <span class="comment">//</span>
04092             tmpUnicodeString.Buffer = (PWCHAR) <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInfo[idIndex]);
04093             tmpUnicodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyValueInfo[idIndex]-&gt;DataLength;
04094             tmpUnicodeString.MaximumLength = tmpUnicodeString.Length;
04095 
04096             <a class="code" href="../../d9/d0/pnpiop_8h.html#a358">IopReplaceSeperatorWithPound</a>(&amp;tmpUnicodeString,
04097                                          &amp;tmpUnicodeString);
04098         }
04099     }
04100 
04101     <span class="comment">//</span>
04102     <span class="comment">// Get handle to \REGISTRY\MACHINE registry key.</span>
04103     <span class="comment">//</span>
04104     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hRegistryMachine,
04105                                    NULL,
04106                                    &amp;CmRegistryMachineName,
04107                                    KEY_READ
04108                                    );
04109     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04110         <span class="keywordflow">goto</span> cleanup;
04111     }
04112 
04113     <span class="comment">//</span>
04114     <span class="comment">// Open CriticalDeviceDatabase registry key to enumerate through.</span>
04115     <span class="comment">//</span>
04116     <span class="comment">// This key contains hardware id's for so called "critical" devices.  These</span>
04117     <span class="comment">// are devices for which, for one reason or another, we cannot wait for</span>
04118     <span class="comment">// config manager to bring them on line.  These are primarily devices which</span>
04119     <span class="comment">// are necessary in order to bring the system up into user mode so that</span>
04120     <span class="comment">// config manager can be run (disks, keyboards, video, etc...)</span>
04121     <span class="comment">//</span>
04122     PiWstrToUnicodeString(&amp;unicodeCriticalDeviceKeyName, REGSTR_PATH_CRITICALDEVICEDATABASE);
04123     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hCriticalDeviceKey,
04124                                    hRegistryMachine,
04125                                    &amp;unicodeCriticalDeviceKeyName,
04126                                    KEY_READ
04127                                    );
04128     <span class="comment">//</span>
04129     <span class="comment">// Close handle to \REGISTRY\MACHINE.</span>
04130     <span class="comment">//</span>
04131     ZwClose(hRegistryMachine);
04132 
04133     <span class="comment">//</span>
04134     <span class="comment">// Check success in opening CriticalDeviceDatabase key.</span>
04135     <span class="comment">//</span>
04136     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
04137         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDeviceRoutine: Unable to open %wZ key.  exiting...\n"</span>,
04138                        &amp;unicodeCriticalDeviceKeyName));
04139         <span class="keywordflow">goto</span> cleanup;
04140     }
04141     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDeviceRoutine: Successfully opened %wZ key.\n"</span>,
04142                    &amp;unicodeCriticalDeviceKeyName));
04143 
04144     <span class="comment">//</span>
04145     <span class="comment">// Allocate a buffer to store KeyValueFullInformation</span>
04146     <span class="comment">// of values from CriticalDeviceDatabase key.</span>
04147     <span class="comment">//</span>
04148     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a370">IopAllocateBuffer</a>( &amp;infoBuffer,
04149                                 INITIAL_INFOBUFFER_SIZE );
04150     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04151         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDeviceRoutine: Unable to allocate buffer to hold key values.  exiting...\n"</span>,
04152                        &amp;unicodeCriticalDeviceKeyName));
04153         <span class="keywordflow">goto</span> cleanup;
04154     }
04155 
04156     <span class="comment">//</span>
04157     <span class="comment">// Enumerate through Critical Device entries.</span>
04158     <span class="comment">//</span>
04159     <span class="comment">// For each CriticalDeviceDatabase value entry compare with all entries of HardwareId</span>
04160     <span class="comment">// and CompatibleIds REG_MULTI_SZ for a match</span>
04161     <span class="comment">//</span>
04162     enumIndex = 0;
04163     <span class="keywordflow">while</span> (((status = ZwEnumerateKey( hCriticalDeviceKey,
04164                                       enumIndex,
04165                                       KeyBasicInformation,
04166                                       (PVOID) infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>,
04167                                       infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o2">MaxSize</a>,
04168                                       &amp;resultSize)) != STATUS_NO_MORE_ENTRIES)) {
04169         <span class="keywordflow">if</span> (status == STATUS_BUFFER_OVERFLOW) {
04170             <span class="comment">//</span>
04171             <span class="comment">// Buffer allocated to hold value was too small;</span>
04172             <span class="comment">// resize to specified length, and try again.</span>
04173             <span class="comment">//</span>
04174             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>( &amp;infoBuffer,
04175                                       resultSize,
04176                                       FALSE );
04177             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDeviceRoutine: ZwEnumerateKey returned STATUS_BUFFER_OVERFLOW, %#08lx\n"</span>,
04178                            status));
04179             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDeviceRoutine: (resizing buffer...)\n"</span>));
04180             <span class="keywordflow">continue</span>;
04181 
04182         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04183             <span class="comment">//</span>
04184             <span class="comment">// ZwEnumerateKey returned failure status other than</span>
04185             <span class="comment">// STATUS_NO_MORE_ENTRIES or STATUS_BUFFER_OVERFLOW.</span>
04186             <span class="comment">//</span>
04187             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDeviceRoutine: ZwEnumerateValueKey failed, %#08lx  exiting...\n"</span>,
04188                            status));
04189             <span class="keywordflow">goto</span> cleanup;
04190         }
04191         <span class="comment">//</span>
04192         <span class="comment">// Store CriticalDeviceDatabase entry in a unicode string to do</span>
04193         <span class="comment">// case-insensitive comparisons with HardwareId/CompatibleIds entries</span>
04194         <span class="comment">// from the new device's instance key.</span>
04195         <span class="comment">//</span>
04196 
04197         unicodeCriticalEntry.Buffer = ((PKEY_BASIC_INFORMATION)(infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;Name;
04198         unicodeCriticalEntry.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((PKEY_BASIC_INFORMATION)(infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;NameLength;
04199         unicodeCriticalEntry.MaximumLength = unicodeCriticalEntry.Length;
04200 
04201         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDeviceRoutine: \t key (%u) enumerated: %wZ\n"</span>,
04202                        enumIndex,
04203                        &amp;unicodeCriticalEntry));
04204 
04205 
04206         <span class="comment">//</span>
04207         <span class="comment">// Look at HardwareId and CompatibleIds of new device...</span>
04208         <span class="comment">//</span>
04209         <span class="keywordflow">for</span> ( idIndex=0; idIndex &lt; 2; idIndex++) {
04210 
04211             <span class="keywordflow">if</span> (!keyValueInfo[idIndex]){
04212                 <span class="comment">//</span>
04213                 <span class="comment">// keyValueInfo[idIndex == 0] == REGSTR_VAL_HARDWAREID</span>
04214                 <span class="comment">// keyValueInfo[idIndex == 1] == REGSTR_VAL_COMPATIBLEIDS</span>
04215                 <span class="comment">//</span>
04216                 <span class="comment">// Corresponding HardwareId or CompatibleIds value entry was invalid or not found.</span>
04217                 <span class="comment">//      keyValueInfo[idIndex] set to NULL above when</span>
04218                 <span class="comment">//      Type != REG_MULTI_SZ or DataLength == 0</span>
04219                 <span class="comment">// Just skip, and move on.</span>
04220                 <span class="comment">//</span>
04221                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDeviceRoutine: No %ws value was found, move on to next\n"</span>,
04222                            keyValueInfoTag[idIndex]));
04223                 <span class="keywordflow">continue</span>;
04224             }
04225 
04226             <span class="comment">//</span>
04227             <span class="comment">// Find start and end of this REG_MULTI_SZ</span>
04228             <span class="comment">//</span>
04229             ptr = (PWCHAR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInfo[idIndex]);
04230             stringStart = ptr;
04231             bufferEnd = (PWCHAR)((PUCHAR)ptr + keyValueInfo[idIndex]-&gt;DataLength);
04232 
04233             <span class="keywordflow">while</span>(ptr != bufferEnd) {
04234 
04235                 <span class="keywordflow">if</span> (!*ptr) {
04236                     <span class="comment">//</span>
04237                     <span class="comment">// Found null-terminated end of a single SZ within the MULTI_SZ.</span>
04238                     <span class="comment">//</span>
04239                     stringLength = (ULONG)((PUCHAR)ptr - (PUCHAR)stringStart);
04240                     tmpUnicodeString.Buffer = stringStart;
04241                     tmpUnicodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)stringLength;
04242                     tmpUnicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)stringLength  + <span class="keyword">sizeof</span>(UNICODE_NULL);
04243 
04244                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(2, (<span class="stringliteral">"IopProcessCriticalDeviceRoutine: comparing %wZ with %wZ\n"</span>,
04245                              &amp;tmpUnicodeString, &amp;unicodeCriticalEntry));
04246                     <span class="comment">//</span>
04247                     <span class="comment">// Check for a case-insenitive unicode string match.</span>
04248                     <span class="comment">//</span>
04249                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;tmpUnicodeString,
04250                                               &amp;unicodeCriticalEntry,
04251                                               TRUE)) {
04252 
04253                         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDeviceRoutine: ***** Critical Device %wZ: Matched to Device %wZ.\n"</span>,
04254                                  &amp;tmpUnicodeString,
04255                                  &amp;unicodeCriticalEntry));
04256 
04257 <span class="preprocessor">                        #define NUM_QUERIES 4</span>
04258 <span class="preprocessor"></span>                        status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hCriticalEntry,
04259                                                        hCriticalDeviceKey,
04260                                                        &amp;unicodeCriticalEntry,
04261                                                        KEY_READ
04262                                                        );
04263 
04264                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04265                             <span class="keywordflow">goto</span> cleanup;
04266                         }
04267 
04268                         parameters = (PRTL_QUERY_REGISTRY_TABLE)
04269                             <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPool,
04270                                            <span class="keyword">sizeof</span>(RTL_QUERY_REGISTRY_TABLE)*(NUM_QUERIES+1));
04271 
04272                         <span class="keywordflow">if</span> (!parameters) {
04273                             ZwClose(hCriticalEntry);
04274                             status = STATUS_INSUFFICIENT_RESOURCES;
04275                             <span class="keywordflow">goto</span> cleanup;
04276                         }
04277 
04278                         RtlZeroMemory(parameters,
04279                                       <span class="keyword">sizeof</span>(RTL_QUERY_REGISTRY_TABLE) * (NUM_QUERIES + 1));
04280 
04281                         parameters[0].Flags = RTL_QUERY_REGISTRY_DIRECT;
04282                         parameters[0].Name = REGSTR_VALUE_SERVICE;
04283                         parameters[0].EntryContext = ServiceName;
04284                         parameters[0].DefaultType = REG_SZ;
04285                         parameters[0].DefaultData = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
04286                         parameters[0].DefaultLength = 0;
04287 
04288                         parameters[1].Flags = RTL_QUERY_REGISTRY_DIRECT;
04289                         parameters[1].Name = REGSTR_VALUE_CLASSGUID;
04290                         parameters[1].EntryContext = ClassGuid;
04291                         parameters[1].DefaultType = REG_SZ;
04292                         parameters[1].DefaultData = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
04293                         parameters[1].DefaultLength = 0;
04294 
04295                         parameters[2].Flags = RTL_QUERY_REGISTRY_DIRECT | RTL_QUERY_REGISTRY_NOEXPAND;
04296                         parameters[2].Name = REGSTR_VALUE_LOWERFILTERS;
04297                         parameters[2].EntryContext = LowerFilters;
04298                         parameters[2].DefaultType = REG_MULTI_SZ;
04299                         parameters[2].DefaultData = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
04300                         parameters[2].DefaultLength = 0;
04301 
04302                         parameters[3].Flags = RTL_QUERY_REGISTRY_DIRECT | RTL_QUERY_REGISTRY_NOEXPAND;
04303                         parameters[3].Name = REGSTR_VALUE_UPPERFILTERS;
04304                         parameters[3].EntryContext = UpperFilters;
04305                         parameters[3].DefaultType = REG_MULTI_SZ;
04306                         parameters[3].DefaultData = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
04307                         parameters[3].DefaultLength = 0;
04308 
04309                         status = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(
04310                                      RTL_REGISTRY_HANDLE | RTL_REGISTRY_OPTIONAL,
04311                                      (PWSTR) hCriticalEntry,
04312                                      parameters,
04313                                      NULL,
04314                                      NULL
04315                                      );
04316 
04317                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(parameters);
04318                         ZwClose(hCriticalEntry);
04319 
04320                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04321 
04322                             <span class="comment">//</span>
04323                             <span class="comment">// Sanity check all of the values...</span>
04324                             <span class="comment">// 1)  There is a service name</span>
04325                             <span class="comment">// 2)  If there is a class guid, it is of the proper length</span>
04326                             <span class="comment">//</span>
04327                             <span class="keywordflow">if</span> (!ServiceName-&gt;Buffer || !ServiceName-&gt;Length ||
04328                                 (ClassGuid-&gt;Length &amp;&amp; (ClassGuid-&gt;Length &lt; 38 * <span class="keyword">sizeof</span> (WCHAR)))) {
04329                                 <span class="keywordflow">goto</span> FreeStrings;
04330                             }
04331 
04332                             <span class="comment">//</span>
04333                             <span class="comment">// Caller expects XxxFilters-&gt;Buffer == NULL, so make</span>
04334                             <span class="comment">// the default case look like that</span>
04335                             <span class="comment">//</span>
04336                             <span class="keywordflow">if</span> (UpperFilters-&gt;Length &lt;= 2 &amp;&amp; UpperFilters-&gt;Buffer) {
04337                                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(UpperFilters);
04338                             }
04339                             <span class="keywordflow">if</span> (LowerFilters-&gt;Length &lt;= 2 &amp;&amp; LowerFilters-&gt;Buffer) {
04340                                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(LowerFilters);
04341                             }
04342                             <span class="keywordflow">if</span> (ClassGuid-&gt;Length == 0 &amp;&amp; ClassGuid-&gt;Buffer) {
04343                                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(ClassGuid);
04344                             }
04345 
04346 <span class="preprocessor">#if DBG</span>
04347 <span class="preprocessor"></span>                            <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDeviceRoutine: ***** Using ServiceName %wZ.\n"</span>,
04348                                      ServiceName));
04349 
04350                             <span class="keywordflow">if</span> (ClassGuid-&gt;Buffer) {
04351                                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDeviceRoutine: ***** Using ClassGuid %wZ.\n"</span>,
04352                                          ClassGuid));
04353                             }
04354 <span class="preprocessor">#endif</span>
04355 <span class="preprocessor"></span>
04356                         } <span class="keywordflow">else</span> {
04357 FreeStrings:
04358                             <span class="comment">//</span>
04359                             <span class="comment">// Free any strings that may have been allocated by</span>
04360                             <span class="comment">// RtlQueryRegistryValues</span>
04361                             <span class="comment">//</span>
04362                             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(ServiceName);
04363                             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(ClassGuid);
04364                             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(LowerFilters);
04365                             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(UpperFilters);
04366                         }
04367 
04368                         <span class="keywordflow">if</span> (ServiceName-&gt;Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04369                             *FoundMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04370                             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
04371                         }
04372                     }
04373 
04374                     <span class="comment">//</span>
04375                     <span class="comment">// See if we're at the end of the MULTI_SZ</span>
04376                     <span class="comment">//</span>
04377                     <span class="keywordflow">if</span> (((ptr + 1) == bufferEnd) || !*(ptr + 1)) {
04378                         <span class="keywordflow">break</span>;
04379                     } <span class="keywordflow">else</span> {
04380                         stringStart = ptr + 1;
04381                     }
04382 
04383                 }
04384                 <span class="comment">//</span>
04385                 <span class="comment">// advance to next character.</span>
04386                 <span class="comment">//</span>
04387                 ptr++;
04388             }
04389         }
04390         <span class="comment">//</span>
04391         <span class="comment">// enumerate next key value.</span>
04392         <span class="comment">//</span>
04393         enumIndex++;
04394     }
04395 
04396 
04397     <span class="comment">//</span>
04398     <span class="comment">// No match found, and no more values to enumerate.</span>
04399     <span class="comment">//</span>
04400     <span class="keywordflow">if</span> (status == STATUS_NO_MORE_ENTRIES) {
04401         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopProcessCriticalDeviceRoutine: No match found for this device.\n"</span>));
04402     }
04403 
04404 
04405 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
04406     status = STATUS_SUCCESS;
04407 
04408 cleanup:
04409     <span class="keywordflow">if</span> (infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>) {
04410         <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(&amp;infoBuffer);
04411     }
04412     <span class="keywordflow">if</span> (hCriticalDeviceKey) {
04413         ZwClose(hCriticalDeviceKey);
04414     }
04415     <span class="keywordflow">if</span> (keyValueInfo[0]) {
04416         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInfo[0]);
04417     }
04418     <span class="keywordflow">if</span> (keyValueInfo[1]) {
04419         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInfo[1]);
04420     }
04421     <span class="keywordflow">return</span> status;
04422 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="pnpenum.c::IopProcessNewChildren" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopProcessNewChildren           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">PSTART_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StartContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01488">1488</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00563">DNF_DEVICE_GONE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00396">DNF_ENUMERATED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00390">DNF_PROCESSED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00615">OK_TO_ADD_DEVICE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>.
<p>
<pre class="fragment"><div>01492 {
01493     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status;
01494     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    childDeviceNode;
01495 
01496     <span class="keywordflow">for</span> (childDeviceNode = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
01497          childDeviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01498          childDeviceNode = childDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>) {
01499 
01500 
01501         <span class="keywordflow">if</span> (childDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>) {
01502 
01503             <span class="comment">//</span>
01504             <span class="comment">// Make sure they aren't resurrecting dead PDOs.</span>
01505             <span class="comment">//</span>
01506 
01507             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(childDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; DNF_DEVICE_GONE));
01508 
01509             <span class="comment">//</span>
01510             <span class="comment">// If the device is not processed ...</span>
01511             <span class="comment">//</span>
01512 
01513             <span class="keywordflow">if</span> (!(childDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a>)) {
01514 
01515                 <span class="comment">//</span>
01516                 <span class="comment">// Setup registry key for the newly enumerated device</span>
01517                 <span class="comment">//</span>
01518 
01519                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a290">IopProcessNewDeviceNode</a>(childDeviceNode);
01520             }
01521 
01522             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/pnpiop_8h.html#a42">OK_TO_ADD_DEVICE</a>(childDeviceNode)) {
01523                 status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a286">IopCallDriverAddDevice</a>(childDeviceNode,
01524                                                 StartContext-&gt;LoadDriver,
01525                                                 &amp;StartContext-&gt;AddContext);
01526 
01527                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01528                     StartContext-&gt;NewDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01529                 }
01530             }
01531         }
01532     }
01533 
01534     <span class="keywordflow">return</span> STATUS_SUCCESS;
01535 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="pnpenum.c::IopProcessNewDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopProcessNewDeviceNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">1538</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a422">BusQueryHardwareIDs</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00052">DebugPrint</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d5/io_8h.html#a605a426">DeviceTextDescription</a>, <a class="el" href="../../d0/d5/io_8h.html#a605a427">DeviceTextLocationInformation</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">DNF_HAS_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00390">DNF_PROCESSED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00440">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00595">DNUF_DONT_SHOW_IN_UI</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01959">_DEVICE_CAPABILITIES::DockDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01224">DOE_START_PENDING</a>, <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01968">_DEVICE_CAPABILITIES::HardwareDisabled</a>, <a class="el" href="../../d0/d5/io_8h.html#a373">IO_STACK_LOCATION</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00831">IopClearDevNodeProblem</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00695">IopConcatenateUnicodeStrings()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05524">IopDeviceCapabilitiesToRegistry()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a376">IopFixupDeviceId()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04559">IopFixupIds()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04425">IopGetBusTypeGuidIndex()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03332">IopIsDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00828">IopIsDevNodeProblem</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l01903">IopIsRemoteBootCard()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00719">IopLoaderBlock</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01891">IopMakeGloballyUniqueId()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08162">IopNotifySetupDeviceArrival()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a281">IopProcessCriticalDevice()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02173">IopQueryCompatibleIds()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03694">IopQueryDeviceCapabilities()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01762">IopQueryDeviceId()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02885">IopQueryPnpBusInformation()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01820">IopQueryUniqueId()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">IopRequestDeviceRemoval()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l01982">IopSetupRemoteBootCard()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04577">IoRemoteBootClient</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00173">IRP_MN_QUERY_DEVICE_TEXT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00172">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01971">_DEVICE_CAPABILITIES::NoDisplayInUI</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00633">PNP_ERR_BOGUS_ID</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00631">PNP_ERR_DUPLICATE_PDO</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration()</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a162">PpSetPlugPlayEvent()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00584">PsDefaultSystemLocaleId</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00740">QUERY_RESOURCE_LIST</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01962">_DEVICE_CAPABILITIES::RawDeviceOK</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01960">_DEVICE_CAPABILITIES::UniqueID</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01488">IopProcessNewChildren()</a>.
<p>
<pre class="fragment"><div>01544                    :
01545 
01546     This function creates a device instance key <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device.
01547     If LoadDriver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">true</span> and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device driver <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> installed,
01548     <span class="keyword">this</span> routine will load <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to start enumerating its children.
01549 
01550 Arguments:
01551 
01552     DeviceNode - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node to be processed.
01553 
01554 Return Value:
01555 
01556     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
01557 
01558 --*/
01559 
01560 {
01561     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01562     PWCHAR deviceId, busId, uniqueId, compatibleIds, <span class="keywordtype">id</span>, hwIds, deviceText, globallyUniqueId;
01563     HANDLE handle, enumHandle, busIdHandle, deviceIdHandle;
01564     HANDLE uniqueIdHandle, logConfHandle;
01565     UNICODE_STRING unicodeName, unicodeString, unicodeDeviceInstance;
01566     ULONG disposition, tmpValue, length, cmLength, ioLength, hwIdLength, compatibleIdLength;
01567     PCM_RESOURCE_LIST cmResource;
01568     PIO_RESOURCE_REQUIREMENTS_LIST ioResource;
01569     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01570     PWCHAR buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01571     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
01572     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
01573     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
01574     <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a> capabilities;
01575     PVOID <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01576     BOOLEAN globallyUnique = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01577     PWCHAR location = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, description = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01578     PKEY_VALUE_PARTIAL_INFORMATION keyValue;
01579     UCHAR CLSIDBuffer[FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + 128];
01580 
01581     BOOLEAN processCriticalDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01582     BOOLEAN isRemoteBootCard = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01583     BOOLEAN configuredBySetup;
01584     PWCHAR wp;
01585     GUID busTypeGuid;
01586 
01587     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01588 
01589     deviceObject = DeviceNode-&gt;PhysicalDeviceObject;
01590 
01591     <span class="comment">//</span>
01592     <span class="comment">// First open HKLM\System\CCS\Enum key.</span>
01593     <span class="comment">//</span>
01594 
01595     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumHandle,
01596                                    NULL,
01597                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
01598                                    KEY_ALL_ACCESS
01599                                    );
01600     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01601         KdPrint((<span class="stringliteral">"IopProcessNewDeviceNode: Unable to open HKLM\\SYSTEM\\CCS\\ENUM\n"</span>));
01602         <span class="keywordflow">return</span> status;
01603     }
01604 
01605     <span class="comment">//</span>
01606     <span class="comment">// First, get the device id and this will be the device key name</span>
01607     <span class="comment">//</span>
01608 
01609     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a23">IopQueryDeviceId</a>(deviceObject, &amp;<span class="keywordtype">id</span>);
01610 
01611     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || <span class="keywordtype">id</span> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01612         ZwClose(enumHandle);
01613         <span class="keywordflow">return</span> status;
01614     }
01615 
01616     <span class="comment">//</span>
01617     <span class="comment">// Fix up the id if necessary</span>
01618     <span class="comment">//</span>
01619     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a376">IopFixupDeviceId</a>(<span class="keywordtype">id</span>)) {
01620         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
01621                       PNP_ERR_BOGUS_ID,
01622                       (ULONG_PTR)deviceObject,
01623                       (ULONG_PTR)<span class="keywordtype">id</span>,
01624                       1);
01625 
01626 
01627     }
01628 
01629     <span class="comment">//</span>
01630     <span class="comment">// Extract  bus id out of the returned id</span>
01631     <span class="comment">//</span>
01632 
01633     <span class="keywordflow">for</span> (wp = <span class="keywordtype">id</span>; *wp != UNICODE_NULL; wp++) {
01634         <span class="keywordflow">if</span> (*wp == OBJ_NAME_PATH_SEPARATOR) {
01635             deviceId = wp + 1;
01636             busId = <span class="keywordtype">id</span>;
01637             <span class="keywordflow">break</span>;
01638         }
01639     }
01640 
01641     <span class="keywordflow">if</span> (*wp != OBJ_NAME_PATH_SEPARATOR) {
01642         ZwClose(enumHandle);
01643         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<span class="keywordtype">id</span>);
01644         KdPrint((<span class="stringliteral">"IopProcessNewDevice: Invalid device id return by driver (not in bus\\device format)\n"</span>));
01645         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01646     }
01647 
01648     *wp = UNICODE_NULL;
01649 
01650     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01651     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
01652 
01653     <span class="comment">//</span>
01654     <span class="comment">// Open/Create enumerator key under HKLM\CCS\System\Enum</span>
01655     <span class="comment">//</span>
01656 
01657     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, busId);
01658 
01659     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;busIdHandle,
01660                                      enumHandle,
01661                                      &amp;unicodeName,
01662                                      KEY_ALL_ACCESS,
01663                                      REG_OPTION_NON_VOLATILE,
01664                                      NULL
01665                                      );
01666 
01667     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01668         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<span class="keywordtype">id</span>);
01669         ZwClose(enumHandle);
01670         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01671     }
01672 
01673     <span class="comment">//</span>
01674     <span class="comment">// Open/create this registry path under HKLM\CCS\System\Enum&lt;Enumerator&gt;</span>
01675     <span class="comment">//</span>
01676 
01677     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, deviceId);
01678     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;deviceIdHandle,
01679                                      busIdHandle,
01680                                      &amp;unicodeName,
01681                                      KEY_ALL_ACCESS,
01682                                      REG_OPTION_NON_VOLATILE,
01683                                      NULL
01684                                      );
01685 
01686     ZwClose(busIdHandle);
01687     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01688         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<span class="keywordtype">id</span>);
01689         ZwClose(enumHandle);
01690         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01691     }
01692 
01693     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
01694     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01695 
01696     <span class="comment">//</span>
01697     <span class="comment">// Query the device's capabilities</span>
01698     <span class="comment">// we will add this stuff to registry once we've processed it a bit</span>
01699     <span class="comment">//</span>
01700 
01701     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a330">IopQueryDeviceCapabilities</a>(DeviceNode, &amp;capabilities);
01702 
01703     <span class="keywordflow">if</span> (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o19">NoDisplayInUI</a>) {
01704 
01705         DeviceNode-&gt;UserFlags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a38">DNUF_DONT_SHOW_IN_UI</a>;
01706     }
01707 
01708     <span class="comment">//</span>
01709     <span class="comment">// From the query capabilities call, determine if this a globally unique ID?</span>
01710     <span class="comment">//</span>
01711 
01712     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o8">UniqueID</a>)) {
01713         globallyUnique = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01714     }
01715 
01716     <span class="comment">//</span>
01717     <span class="comment">// Record, is this a dock?</span>
01718     <span class="comment">//</span>
01719     DeviceNode-&gt;DockInfo.DockStatus =
01720         capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o7">DockDevice</a> ? <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a> : <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>;
01721 
01722     <span class="comment">//</span>
01723     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
01724     <span class="comment">//</span>
01725 
01726     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
01727 
01728     <span class="comment">//</span>
01729     <span class="comment">// Query the device's description.</span>
01730     <span class="comment">//</span>
01731 
01732     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
01733     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a77">IRP_MN_QUERY_DEVICE_TEXT</a>;
01734     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceText.DeviceTextType = <a class="code" href="../../d0/d5/io_8h.html#a605a426">DeviceTextDescription</a>;
01735     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceText.LocaleId = <a class="code" href="../../d1/d9/ps_8h.html#a58">PsDefaultSystemLocaleId</a>;
01736     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(deviceObject, &amp;irpSp, &amp;description);
01737 
01738     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01739         description = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01740     }
01741 
01742     <span class="comment">//</span>
01743     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
01744     <span class="comment">//</span>
01745 
01746     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
01747 
01748     <span class="comment">//</span>
01749     <span class="comment">// Query the device's location information.</span>
01750     <span class="comment">//</span>
01751 
01752     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
01753     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a77">IRP_MN_QUERY_DEVICE_TEXT</a>;
01754     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceText.DeviceTextType = <a class="code" href="../../d0/d5/io_8h.html#a605a427">DeviceTextLocationInformation</a>;
01755     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceText.LocaleId = <a class="code" href="../../d1/d9/ps_8h.html#a58">PsDefaultSystemLocaleId</a>;
01756     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(deviceObject, &amp;irpSp, &amp;location);
01757 
01758     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01759         location = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01760     }
01761 
01762     <span class="comment">//</span>
01763     <span class="comment">// Query the unique id for the device</span>
01764     <span class="comment">//</span>
01765 
01766     <a class="code" href="../../d0/d1/pnpirp_8c.html#a24">IopQueryUniqueId</a>(deviceObject, &amp;uniqueId);
01767 
01768     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01769 
01770     <span class="keywordflow">if</span> (!globallyUnique &amp;&amp; deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a> != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
01771         globallyUniqueId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01772 
01773         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a25">IopMakeGloballyUniqueId</a>(deviceObject, uniqueId, &amp;globallyUniqueId);
01774 
01775         <span class="keywordflow">if</span> (uniqueId != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01776             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(uniqueId);
01777         }
01778 
01779         uniqueId = globallyUniqueId;
01780 
01781     } <span class="keywordflow">else</span> {
01782 
01783         status = STATUS_SUCCESS;
01784     }
01785 
01786     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || uniqueId == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01787         <span class="keywordflow">if</span> (description) {
01788             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(description);
01789         }
01790         <span class="keywordflow">if</span> (location) {
01791             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(location);
01792         }
01793         ZwClose(deviceIdHandle);
01794         ZwClose(enumHandle);
01795         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<span class="keywordtype">id</span>);
01796         <span class="keywordflow">return</span> status;
01797     }
01798 
01799     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01800     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
01801 
01802 RetryDuplicateId:
01803 
01804     <span class="comment">//</span>
01805     <span class="comment">// Fixup the unique instance id if necessary</span>
01806     <span class="comment">//</span>
01807     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a376">IopFixupDeviceId</a>(uniqueId)) {
01808         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
01809                       PNP_ERR_BOGUS_ID,
01810                       (ULONG_PTR)deviceObject,
01811                       (ULONG_PTR)uniqueId,
01812                       2);
01813     }
01814 
01815     length = (wcslen(busId) + wcslen(deviceId) + wcslen(uniqueId) + 5) * <span class="keyword">sizeof</span>(WCHAR);
01816     buffer = (PWCHAR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, length);
01817     <span class="keywordflow">if</span> (!buffer) {
01818 
01819         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
01820         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01821 
01822         <span class="keywordflow">if</span> (description) {
01823             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(description);
01824         }
01825         <span class="keywordflow">if</span> (location) {
01826             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(location);
01827         }
01828         ZwClose(deviceIdHandle);
01829         ZwClose(enumHandle);
01830         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<span class="keywordtype">id</span>);
01831         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01832     }
01833     swprintf(buffer, L<span class="stringliteral">"%s\\%s\\%s"</span>, busId, deviceId, uniqueId);
01834     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeDeviceInstance, buffer);
01835 
01836     <span class="keywordflow">if</span> (DeviceNode-&gt;InstancePath.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01837 
01838         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;InstancePath.Buffer);
01839         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;DeviceNode-&gt;InstancePath, NULL);
01840     }
01841 
01842     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(&amp;DeviceNode-&gt;InstancePath, &amp;unicodeDeviceInstance, NULL);
01843 
01844     <span class="comment">//</span>
01845     <span class="comment">// Open/create this registry device instance path under</span>
01846     <span class="comment">// HKLM\System\Enum&lt;Enumerator&gt;\deviceId</span>
01847     <span class="comment">//</span>
01848 
01849     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, uniqueId);
01850     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;uniqueIdHandle,
01851                                      deviceIdHandle,
01852                                      &amp;unicodeName,
01853                                      KEY_ALL_ACCESS,
01854                                      REG_OPTION_NON_VOLATILE,
01855                                      &amp;disposition
01856                                      );
01857 
01858     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01859         ZwClose(enumHandle);
01860         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<span class="keywordtype">id</span>);
01861         ZwClose(deviceIdHandle);
01862         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(uniqueId);
01863         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01864     }
01865 
01866     deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a142">DOE_START_PENDING</a>;
01867 
01868     DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a>;
01869 
01870     <span class="comment">//</span>
01871     <span class="comment">// Check if the device instance is already reported.  If yes fail this request.</span>
01872     <span class="comment">//</span>
01873 
01874     <span class="keywordflow">if</span> (disposition != REG_CREATED_NEW_KEY) {
01875 
01876         <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> dupCheckDeviceObject;
01877 
01878         <span class="comment">//</span>
01879         <span class="comment">// Retrieve the device node associated with this device instance name (if</span>
01880         <span class="comment">// there is one).  If it's different from the device node we're currently</span>
01881         <span class="comment">// working with, then we have a duplicate, and we want to remove it.</span>
01882         <span class="comment">//</span>
01883 
01884         dupCheckDeviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(uniqueIdHandle, NULL);
01885 
01886         <span class="keywordflow">if</span> (dupCheckDeviceObject) {
01887 
01888             <span class="comment">//</span>
01889             <span class="comment">// Go ahead and dereference the device object now--we only need the</span>
01890             <span class="comment">// value for comparison.</span>
01891             <span class="comment">//</span>
01892 
01893             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(dupCheckDeviceObject);
01894 
01895             <span class="keywordflow">if</span> (dupCheckDeviceObject != deviceObject) {
01896 
01897                 <span class="keywordflow">if</span> (globallyUnique) {
01898                     globallyUnique = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01899 
01900                     <a class="code" href="../../d0/d1/pnpirp_8c.html#a25">IopMakeGloballyUniqueId</a>(deviceObject, uniqueId, &amp;globallyUniqueId);
01901 
01902                     <span class="keywordflow">if</span> (uniqueId != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01903                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(uniqueId);
01904                     }
01905 
01906                     uniqueId = globallyUniqueId;
01907 
01908                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
01909                     buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01910                     ZwClose(uniqueIdHandle);
01911                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART);
01912                     <span class="keywordflow">goto</span> RetryDuplicateId;
01913                 }
01914 
01915                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
01916                               PNP_ERR_DUPLICATE_PDO,
01917                               (ULONG_PTR)deviceObject,
01918                               (ULONG_PTR)dupCheckDeviceObject,
01919                               0);
01920 
01921 <span class="preprocessor">#if 0</span>
01922 <span class="preprocessor"></span>                ZwClose(enumHandle);
01923                 ZwClose(uniqueIdHandle);
01924 
01925                 <span class="keywordflow">if</span> (DeviceNode-&gt;InstancePath.Length != 0) {
01926                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;InstancePath.Buffer);
01927                     DeviceNode-&gt;InstancePath.Length = 0;
01928                     DeviceNode-&gt;InstancePath.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01929                 }
01930 
01931                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(deviceObject, CM_PROB_DEVICE_NOT_THERE);
01932                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01933 <span class="preprocessor">#endif</span>
01934 <span class="preprocessor"></span>            }
01935         }
01936     } <span class="keywordflow">else</span> {
01937 
01938         <span class="keywordflow">if</span> (description) {
01939             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_DEVDESC);
01940             ZwSetValueKey(uniqueIdHandle,
01941                             &amp;unicodeName,
01942                             TITLE_INDEX_VALUE,
01943                             REG_SZ,
01944                             description,
01945                             (wcslen(description)+1) * <span class="keyword">sizeof</span>(WCHAR)
01946                             );
01947             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(description);
01948             description = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01949         }
01950     }
01951 
01952     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<span class="keywordtype">id</span>);
01953     ZwClose(deviceIdHandle);
01954     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(uniqueId);
01955 
01956     <span class="keywordflow">if</span> (location) {
01957         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_LOCATION_INFORMATION);
01958         ZwSetValueKey(uniqueIdHandle,
01959                       &amp;unicodeName,
01960                       TITLE_INDEX_VALUE,
01961                       REG_SZ,
01962                       location,
01963                       (wcslen(location)+1) * <span class="keyword">sizeof</span>(WCHAR)
01964                       );
01965         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(location);
01966         location = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01967     }
01968 
01969     <span class="comment">//</span>
01970     <span class="comment">// now add the capabilities and UI_NUMBER into registry</span>
01971     <span class="comment">//</span>
01972     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a35">IopDeviceCapabilitiesToRegistry</a>(DeviceNode, &amp;capabilities);
01973 
01974 <span class="preprocessor">#if DBG</span>
01975 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
01976 <span class="preprocessor">#endif</span>
01977 <span class="preprocessor"></span>
01978     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
01979     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;logConfHandle,
01980                                      uniqueIdHandle,
01981                                      &amp;unicodeName,
01982                                      KEY_ALL_ACCESS,
01983                                      REG_OPTION_NON_VOLATILE,
01984                                      NULL
01985                                      );
01986     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01987         logConfHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;          <span class="comment">// just to make sure</span>
01988     }
01989 
01990     <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {    <span class="comment">// disposition from uniqueId</span>
01991 
01992         <span class="comment">//</span>
01993         <span class="comment">// "new registry key" device installation case</span>
01994         <span class="comment">//</span>
01995         <span class="comment">// Set flags to control whether device installation needs to</span>
01996         <span class="comment">// happen later. This means setting the devnode flag to</span>
01997         <span class="comment">// DNF_NOT_CONFIGURED and setting the ConfigFlag ONLY if it's</span>
01998         <span class="comment">// raw.</span>
01999         <span class="comment">//</span>
02000 
02001         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART)) {
02002             <span class="keywordflow">if</span> (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o10">RawDeviceOK</a>) {
02003                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_CONFIG_FLAGS);
02004                 tmpValue = CONFIGFLAG_FINISH_INSTALL;
02005                 ZwSetValueKey(uniqueIdHandle,
02006                                 &amp;unicodeName,
02007                                 TITLE_INDEX_VALUE,
02008                                 REG_DWORD,
02009                                 &amp;tmpValue,
02010                                 <span class="keyword">sizeof</span>(tmpValue)
02011                                 );
02012             } <span class="keywordflow">else</span> {
02013                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED);
02014             }
02015 
02016             <span class="comment">//</span>
02017             <span class="comment">// Process this as a critical device node.  This will setup</span>
02018             <span class="comment">// the service, if necessary, so that the system can boot far</span>
02019             <span class="comment">// enough to get to the config manager</span>
02020             <span class="comment">//</span>
02021 
02022             processCriticalDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02023         }
02024 
02025     } <span class="keywordflow">else</span> {
02026 
02027         UCHAR buffer[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION)+<span class="keyword">sizeof</span>(ULONG)];
02028         PKEY_VALUE_PARTIAL_INFORMATION keyInfo =
02029             (PKEY_VALUE_PARTIAL_INFORMATION) buffer;
02030 
02031         ULONG length;
02032 
02033         UNICODE_STRING valueName;
02034 
02035         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> tmpStatus;
02036 
02037         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART)) {
02038 
02039             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, REGSTR_VALUE_CONFIG_FLAGS);
02040             tmpStatus = ZwQueryValueKey(uniqueIdHandle,
02041                                         &amp;valueName,
02042                                         KeyValuePartialInformation,
02043                                         keyInfo,
02044                                         <span class="keyword">sizeof</span>(buffer),
02045                                         &amp;length);
02046 
02047             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(tmpStatus)) {
02048 
02049                 ULONG configFlags = *(PULONG)keyInfo-&gt;Data;
02050 
02051                 <span class="comment">//</span>
02052                 <span class="comment">// The ConfigFlags value exists in the registry</span>
02053                 <span class="comment">// If DNF_REINSTALL is set.  We mark it as DNF_DELETED such that we will not</span>
02054                 <span class="comment">// start the device.  Later when the reinstallation completes, the</span>
02055                 <span class="comment">// DNF_RESTART_OK bit will be set and DNF_DELETED will be deleted.</span>
02056                 <span class="comment">//</span>
02057 
02058                 <span class="keywordflow">if</span> (configFlags &amp; CONFIGFLAG_REINSTALL) {
02059                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_REINSTALL);
02060                     processCriticalDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;  <span class="comment">// to install critical driver</span>
02061                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (configFlags &amp; CONFIGFLAG_FAILEDINSTALL) {
02062                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_FAILED_INSTALL);
02063                     processCriticalDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;  <span class="comment">// to install critical driver</span>
02064                 }
02065             } <span class="keywordflow">else</span> {
02066                 <span class="comment">//</span>
02067                 <span class="comment">// The ConfigFlag value does not exist in the registry</span>
02068                 <span class="comment">//</span>
02069                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED);
02070             }
02071         }
02072 
02073         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, REGSTR_VALUE_SERVICE);
02074 
02075         tmpStatus = ZwQueryValueKey(uniqueIdHandle,
02076                                     &amp;valueName,
02077                                     KeyValuePartialInformation,
02078                                     keyInfo,
02079                                     <span class="keyword">sizeof</span>(buffer),
02080                                     &amp;length);
02081 
02082         <span class="comment">//</span>
02083         <span class="comment">// if there's no service setup then check to see if this should</span>
02084         <span class="comment">// be processed as a critical device.</span>
02085         <span class="comment">//</span>
02086 
02087         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(tmpStatus) &amp;&amp; (keyInfo-&gt;DataLength &lt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>))) {
02088             processCriticalDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02089         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmpStatus == STATUS_OBJECT_NAME_NOT_FOUND) {
02090             processCriticalDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02091         }
02092     }
02093 
02094     <span class="keywordflow">if</span> (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o16">HardwareDisabled</a> &amp;&amp;
02095         !<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED) &amp;&amp;
02096         !<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART)) {
02097         <span class="comment">//</span>
02098         <span class="comment">// mark the node as hardware disabled, if no configuration problems</span>
02099         <span class="comment">//</span>
02100         <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(DeviceNode);
02101         <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_HARDWARE_DISABLED);
02102         <span class="comment">//</span>
02103         <span class="comment">// Issue a PNP REMOVE_DEVICE Irp so when we query resources</span>
02104         <span class="comment">// we have those required after boot</span>
02105         <span class="comment">//</span>
02106         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a>(deviceObject, IRP_MN_REMOVE_DEVICE);
02107         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
02108 
02109     } <span class="keywordflow">else</span> {
02110         <span class="comment">//</span>
02111         <span class="comment">// these are the only problems I expect at this point</span>
02112         <span class="comment">//</span>
02113         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode) ||
02114                <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED) ||
02115                <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_REINSTALL) ||
02116                <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_FAILED_INSTALL) ||
02117                <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART));
02118     }
02119 
02120     <span class="comment">//</span>
02121     <span class="comment">// Create all the default value entry for the newly created key.</span>
02122     <span class="comment">// Configuration = REG_RESOURCE_LIST</span>
02123     <span class="comment">// ConfigurationVector = REG_RESOUCE_REQUIREMENTS_LIST</span>
02124     <span class="comment">// HardwareID = MULTI_SZ</span>
02125     <span class="comment">// CompatibleIDs = MULTI_SZ</span>
02126     <span class="comment">// Create "Control" volatile subkey.</span>
02127     <span class="comment">//</span>
02128 
02129     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
02130     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
02131                                      uniqueIdHandle,
02132                                      &amp;unicodeName,
02133                                      KEY_ALL_ACCESS,
02134                                      REG_OPTION_VOLATILE,
02135                                      NULL
02136                                      );
02137     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02138 
02139         <span class="comment">//</span>
02140         <span class="comment">// Write DeviceObject reference ...</span>
02141         <span class="comment">//</span>
02142 
02143         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_DEVICE_REFERENCE);
02144         status = ZwSetValueKey( handle,
02145                                 &amp;unicodeName,
02146                                 TITLE_INDEX_VALUE,
02147                                 REG_DWORD,
02148                                 (PULONG_PTR)&amp;deviceObject,
02149                                 <span class="keyword">sizeof</span>(ULONG_PTR)
02150                                 );
02151         ZwClose(handle);
02152     }
02153 
02154     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02155         ZwClose(enumHandle);
02156         ZwClose(uniqueIdHandle);
02157         <span class="keywordflow">if</span> (logConfHandle) {
02158             ZwClose(logConfHandle);
02159         }
02160         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
02161     }
02162 
02163     ZwClose(enumHandle);
02164 
02165     <span class="comment">//</span>
02166     <span class="comment">// Release registry lock before calling device driver</span>
02167     <span class="comment">//</span>
02168 
02169     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
02170     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02171 
02172     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a26">IopQueryCompatibleIds</a>( deviceObject,
02173                                     BusQueryHardwareIDs,
02174                                     &amp;hwIds,
02175                                     &amp;hwIdLength);
02176 
02177     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02178         hwIds = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02179     }
02180 
02181     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a26">IopQueryCompatibleIds</a>( deviceObject,
02182                                     BusQueryCompatibleIDs,
02183                                     &amp;compatibleIds,
02184                                     &amp;compatibleIdLength);
02185     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02186         compatibleIds = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02187     }
02188 
02189     <span class="comment">//</span>
02190     <span class="comment">// Query the device's basic config vector. This needs to be done before we check if</span>
02191     <span class="comment">// this is a remote BOOT card.</span>
02192     <span class="comment">//</span>
02193 
02194     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
02195     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
02196     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a76">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>;
02197     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(deviceObject, &amp;irpSp, &amp;ioResource);
02198 
02199     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02200         ioResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02201     }
02202     <span class="keywordflow">if</span> (ioResource) {
02203         ioLength = ioResource-&gt;ListSize;
02204     }
02205 
02206     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02207     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
02208 
02209     <span class="comment">//</span>
02210     <span class="comment">// Write resource requirements to registry</span>
02211     <span class="comment">//</span>
02212 
02213     <span class="keywordflow">if</span> (logConfHandle) {
02214         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_BASIC_CONFIG_VECTOR);
02215         <span class="keywordflow">if</span> (ioResource) {
02216             ZwSetValueKey(logConfHandle,
02217                             &amp;unicodeName,
02218                             TITLE_INDEX_VALUE,
02219                             REG_RESOURCE_REQUIREMENTS_LIST,
02220                             ioResource,
02221                             ioLength
02222                             );
02223             DeviceNode-&gt;ResourceRequirements = ioResource;
02224             DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a16">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>;
02225         } <span class="keywordflow">else</span> {
02226             ZwDeleteValueKey(logConfHandle, &amp;unicodeName);
02227         }
02228     }
02229 
02230     <span class="comment">//</span>
02231     <span class="comment">// While we have the hwIds, check if this is the device node</span>
02232     <span class="comment">// for the remote boot net card. If IopLoaderBlock is NULL</span>
02233     <span class="comment">// then we are not initilizing boot drivers so we don't have</span>
02234     <span class="comment">// to check for this.</span>
02235     <span class="comment">//</span>
02236 
02237     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a399">IoRemoteBootClient</a> &amp;&amp; (<a class="code" href="../../d3/d5/iodata_8c.html#a73">IopLoaderBlock</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02238 
02239         <span class="keywordflow">if</span> (hwIds) {
02240             isRemoteBootCard = <a class="code" href="../../d4/d6/netboot_8c.html#a14">IopIsRemoteBootCard</a>(
02241                                     DeviceNode,
02242                                     (<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>)IopLoaderBlock,
02243                                     hwIds);
02244         }
02245         <span class="keywordflow">if</span> (!isRemoteBootCard &amp;&amp; compatibleIds) {
02246             isRemoteBootCard = <a class="code" href="../../d4/d6/netboot_8c.html#a14">IopIsRemoteBootCard</a>(
02247                                     DeviceNode,
02248                                     (<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>)IopLoaderBlock,
02249                                     compatibleIds);
02250         }
02251     }
02252 
02253     <span class="comment">//</span>
02254     <span class="comment">// create HardwareId value name.  It is a MULTI_SZ,</span>
02255     <span class="comment">//</span>
02256 
02257     <span class="keywordflow">if</span> (hwIds) {
02258 
02259         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/pnpenum_8c.html#a28">IopFixupIds</a>(hwIds, hwIdLength)) {
02260             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
02261                           PNP_ERR_BOGUS_ID,
02262                           (ULONG_PTR)deviceObject,
02263                           (ULONG_PTR)hwIds,
02264                           3);
02265         }
02266         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_HARDWAREID);
02267         ZwSetValueKey(uniqueIdHandle,
02268                         &amp;unicodeName,
02269                         TITLE_INDEX_VALUE,
02270                         REG_MULTI_SZ,
02271                         hwIds,
02272                         hwIdLength
02273                         );
02274         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(hwIds);
02275     }
02276 
02277     <span class="comment">//</span>
02278     <span class="comment">// create CompatibleId value name.  It is a MULTI_SZ,</span>
02279     <span class="comment">//</span>
02280 
02281     <span class="keywordflow">if</span> (compatibleIds) {
02282 
02283         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/pnpenum_8c.html#a28">IopFixupIds</a>(compatibleIds, compatibleIdLength)) {
02284             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
02285                             PNP_ERR_BOGUS_ID,
02286                             (ULONG_PTR)deviceObject,
02287                             (ULONG_PTR)compatibleIds,
02288                             4);
02289         }
02290         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_COMPATIBLEIDS);
02291         ZwSetValueKey(uniqueIdHandle,
02292                         &amp;unicodeName,
02293                         TITLE_INDEX_VALUE,
02294                         REG_MULTI_SZ,
02295                         compatibleIds,
02296                         compatibleIdLength
02297                         );
02298         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(compatibleIds);
02299     }
02300 
02301     <span class="comment">//</span>
02302     <span class="comment">// If this is the devnode for the remote boot card, do</span>
02303     <span class="comment">// special setup for it.</span>
02304     <span class="comment">//</span>
02305 
02306     <span class="keywordflow">if</span> (isRemoteBootCard) {
02307 
02308         status = <a class="code" href="../../d4/d6/netboot_8c.html#a15">IopSetupRemoteBootCard</a>(
02309                         (<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>)IopLoaderBlock,
02310                         uniqueIdHandle,
02311                         &amp;unicodeDeviceInstance);
02312 
02313         <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
02314             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
02315         }
02316 
02317         <span class="comment">//</span>
02318         <span class="comment">// HACK BUGBUG: Need to turn this off, or else the device won't</span>
02319         <span class="comment">// be allowed to be opened until the PNP start IRP is done. Unfortunately</span>
02320         <span class="comment">// that is exactly what NDIS does in the start IRP handler - adamba 3/31/99</span>
02321         <span class="comment">//</span>
02322 
02323         deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a142">DOE_START_PENDING</a>;
02324 
02325     }
02326 
02327     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
02328     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02329 
02330     <span class="comment">//</span>
02331     <span class="comment">// we've pretty much got the PDO information ready, apart from Child bus information</span>
02332     <span class="comment">// get that now, because class-installer may want it</span>
02333     <span class="comment">//</span>
02334     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a31">IopQueryPnpBusInformation</a>(
02335                  deviceObject,
02336                  &amp;busTypeGuid,
02337                  &amp;DeviceNode-&gt;ChildInterfaceType,
02338                  &amp;DeviceNode-&gt;ChildBusNumber
02339              );
02340 
02341     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02342 
02343         DeviceNode-&gt;ChildBusTypeIndex = <a class="code" href="../../d6/d0/pnpenum_8c.html#a26">IopGetBusTypeGuidIndex</a>(&amp;busTypeGuid);
02344 
02345     } <span class="keywordflow">else</span> {
02346 
02347         DeviceNode-&gt;ChildBusTypeIndex = 0xffff;
02348         DeviceNode-&gt;ChildInterfaceType = InterfaceTypeUndefined;
02349         DeviceNode-&gt;ChildBusNumber = 0xfffffff0;
02350 
02351     }
02352 
02353     <span class="comment">//</span>
02354     <span class="comment">// we check HardwareDisabled directly in case it's a new device</span>
02355     <span class="comment">//</span>
02356     <span class="keywordflow">if</span> (processCriticalDevice &amp;&amp; !capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o16">HardwareDisabled</a> &amp;&amp;
02357         !<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART)) {
02358 
02359         <a class="code" href="../../d9/d0/pnpiop_8h.html#a281">IopProcessCriticalDevice</a>(DeviceNode);
02360     }
02361 
02362     <span class="comment">//</span>
02363     <span class="comment">// Set DNF_DISABLED flag if the device instance is disabled.</span>
02364     <span class="comment">//</span>
02365 
02366     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode) ||
02367            <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED) ||
02368            <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_REINSTALL) ||
02369            <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_FAILED_INSTALL) ||
02370            <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_PARTIAL_LOG_CONF) ||
02371            <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_HARDWARE_DISABLED) ||
02372            <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART));
02373     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_DISABLED) &amp;&amp;
02374         !<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_HARDWARE_DISABLED) &amp;&amp;
02375         !<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART)) {
02376 
02377         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a20">IopIsDeviceInstanceEnabled</a>(uniqueIdHandle, &amp;unicodeDeviceInstance, TRUE);
02378     }
02379 
02380     <span class="comment">//</span>
02381     <span class="comment">// This code HAS to be after we have checked for DISABLED device.</span>
02382     <span class="comment">// We could end up here from an ENABLE following a DISABLE.</span>
02383     <span class="comment">// Query for BOOT config if there is none already present.</span>
02384     <span class="comment">//</span>
02385 
02386     cmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02387     <span class="keywordflow">if</span> (DeviceNode-&gt;BootResources == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02388         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a27">IopQueryDeviceResources</a>( deviceObject,
02389                                           QUERY_RESOURCE_LIST,
02390                                           &amp;cmResource,
02391                                           &amp;cmLength );
02392         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02393             cmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02394         }
02395     } <span class="keywordflow">else</span> {
02396 
02397         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1,
02398                    (<span class="stringliteral">"PNPENUM: %ws already has BOOT config in IopProcessNewDeviceNode!\n"</span>,
02399                    DeviceNode-&gt;InstancePath.Buffer));
02400     }
02401 
02402     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02403     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
02404 
02405     <span class="comment">//</span>
02406     <span class="comment">// Write boot resources to registry</span>
02407     <span class="comment">//</span>
02408     <span class="keywordflow">if</span> (logConfHandle &amp;&amp; DeviceNode-&gt;BootResources == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02409         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_BOOTCONFIG);
02410         <span class="keywordflow">if</span> (cmResource) {
02411             ZwSetValueKey(
02412                         logConfHandle,
02413                         &amp;unicodeName,
02414                         TITLE_INDEX_VALUE,
02415                         REG_RESOURCE_LIST,
02416                         cmResource,
02417                         cmLength
02418                         );
02419 
02420             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
02421 
02422             <span class="comment">//</span>
02423             <span class="comment">// This device consumes BOOT resources.  Reserve its boot resources</span>
02424             <span class="comment">//</span>
02425 
02426             status = (*IopReserveResourcesRoutine)(<a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>,
02427                                                     deviceObject,
02428                                                     cmResource);
02429 
02430             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
02431 
02432             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02433                 DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>;
02434             }
02435             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResource);
02436         } <span class="keywordflow">else</span> {
02437             ZwDeleteValueKey(logConfHandle, &amp;unicodeName);
02438         }
02439     }
02440 
02441     <span class="comment">//</span>
02442     <span class="comment">// SurpriseRemovalOK bits may have changed due to DNF_HAS_BOOT_CONFIG.</span>
02443     <span class="comment">//</span>
02444     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a35">IopDeviceCapabilitiesToRegistry</a>(DeviceNode,&amp;capabilities);
02445 
02446 <span class="preprocessor">#if DBG</span>
02447 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
02448 <span class="preprocessor">#endif</span>
02449 <span class="preprocessor"></span>
02450     <span class="comment">//</span>
02451     <span class="comment">// Clean up</span>
02452     <span class="comment">//</span>
02453 
02454     <span class="keywordflow">if</span> (logConfHandle) {
02455         ZwClose(logConfHandle);
02456     }
02457 
02458     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
02459     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02460 
02461     <span class="comment">//</span>
02462     <span class="comment">// Create new value entry under ServiceKeyName\Enum to reflect the newly</span>
02463     <span class="comment">// added made-up device instance node.</span>
02464     <span class="comment">//</span>
02465 
02466     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a347">IopNotifySetupDeviceArrival</a>( deviceObject,
02467                                           uniqueIdHandle,
02468                                           TRUE);
02469 
02470     configuredBySetup = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status);
02471 
02472     status = <a class="code" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration</a>(
02473                  &amp;unicodeDeviceInstance,
02474                  TRUE,
02475                  &amp;DeviceNode-&gt;ServiceName
02476                  );
02477 
02478     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (configuredBySetup || isRemoteBootCard) &amp;&amp;
02479         <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED)) {
02480 
02481         <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(DeviceNode);
02482     }
02483 
02484     <span class="comment">//</span>
02485     <span class="comment">// Add an event so user-mode will attempt to install this device later.</span>
02486     <span class="comment">//</span>
02487     <a class="code" href="../../d6/d9/pnp_8h.html#a162">PpSetPlugPlayEvent</a>( &amp;GUID_DEVICE_ENUMERATED,
02488                         deviceObject);
02489 
02490     ZwClose(uniqueIdHandle);
02491 
02492     <span class="keywordflow">if</span> (buffer) {
02493         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
02494     }
02495     <span class="keywordflow">if</span> (description) {
02496         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(description);
02497     }
02498     <span class="keywordflow">if</span> (location) {
02499         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(location);
02500     }
02501     <span class="keywordflow">return</span> STATUS_SUCCESS;
02502 
02503 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
02504 
02505     <span class="comment">//</span>
02506     <span class="comment">// In case of failure, we don't set the DNF_PROCESSED flags.  So the device</span>
02507     <span class="comment">// will be processed again later.</span>
02508     <span class="comment">//</span>
02509 
02510     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
02511     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02512     <span class="keywordflow">if</span> (buffer) {
02513         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
02514     }
02515     <span class="keywordflow">if</span> (description) {
02516         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(description);
02517     }
02518     <span class="keywordflow">if</span> (location) {
02519         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(location);
02520     }
02521     <span class="keywordflow">return</span> status;
02522 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="pnpenum.c::IopProcessNewProfile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopProcessNewProfile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05034">5034</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a332a205">CriticalWorkQueue</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05109">IopProcessNewProfileWorker()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00572">IopHardwareProfileCancelRemovedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00465">IopHardwareProfileCommitRemovedDock()</a>, and <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00370">IopHardwareProfileCommitStartedDock()</a>.
<p>
<pre class="fragment"><div>05040                    :
05041 
05042     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has transitioned into a <span class="keyword">new</span>
05043     hardware profile. The thread from which <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called may be holding an
05044     enumeration lock. Calling <span class="keyword">this</span> function does two tasks:
05045 
05046     1) If a disabled devnode in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree should be enabled in <span class="keyword">this</span> <span class="keyword">new</span> hardware
05047        profile state, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will be started.
05048 
05049     2) If an enabled devnode in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree should be disabled in <span class="keyword">this</span> <span class="keyword">new</span> hardware
05050        profile state, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will be (surprise) removed.
05051 
05052     ADRIAO N.B. 02/19/1999 -
05053         Why surprise remove? There are four cases to be handled:
05054         a) Dock disappearing, need to enable device in new profile
05055         b) Dock appearing, need to enable device in new profile
05056         c) Dock disappearing, need to disable device in new profile
05057         d) Dock appearing, need to disable device in new profile
05058 
05059         a) and b) are trivial. c) involves treating the appropriate devices as
05060         if they were in the removal relation lists for the dock. d) is another
05061         matter altogether as we need to query-remove/remove devices before
05062         starting another. NT5's PnP state machine cannot handle this, so for
05063         this release we cleanup rather hastily after the profile change.
05064 
05065 Parameters:
05066 
05067     NONE.
05068 
05069 Return Value:
05070 
05071     NTSTATUS.
05072 
05073 --*/
05074 {
05075     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a> workQueueItem;
05076 
05077     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05078 
05079     workQueueItem = (<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
05080         NonPagedPool,
05081         <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a>)
05082         );
05083 
05084     <span class="keywordflow">if</span> (workQueueItem) {
05085 
05086         <span class="comment">//</span>
05087         <span class="comment">// Queue this up so we can walk the tree outside of the enumeration lock.</span>
05088         <span class="comment">//</span>
05089         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(
05090             workQueueItem,
05091             IopProcessNewProfileWorker,
05092             workQueueItem
05093             );
05094 
05095         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(
05096             workQueueItem,
05097             CriticalWorkQueue
05098             );
05099 
05100         <span class="keywordflow">return</span> STATUS_SUCCESS;
05101 
05102     } <span class="keywordflow">else</span> {
05103 
05104         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05105     }
05106 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="pnpenum.c::IopProcessNewProfileStateCallback" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopProcessNewProfileStateCallback           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05138">5138</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01395">IoInvalidateDeviceRelations()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00831">IopClearDevNodeProblem</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03332">IopIsDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00828">IopIsDevNodeProblem</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">IopRequestDeviceRemoval()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05109">IopProcessNewProfileWorker()</a>.
<p>
<pre class="fragment"><div>05145                    :
05146 
05147     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> each devnode after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has transitioned
05148     hardware profile states.
05149 
05150 Parameters:
05151 
05152     NONE.
05153 
05154 Return Value:
05155 
05156     NONE.
05157 
05158 --*/
05159 {
05160     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> parentDevNode;
05161 
05162     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05163 
05164     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
05165 
05166         <span class="comment">//</span>
05167         <span class="comment">// Calling this function will disable the device if it is appropriate</span>
05168         <span class="comment">// to do so.</span>
05169         <span class="comment">//</span>
05170         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a20">IopIsDeviceInstanceEnabled</a>(NULL, &amp;DeviceNode-&gt;InstancePath, FALSE)) {
05171 
05172             <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(
05173                 DeviceNode-&gt;PhysicalDeviceObject,
05174                 CM_PROB_DISABLED
05175                 );
05176         }
05177 
05178     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_DISABLED)) {
05179 
05180         <span class="comment">//</span>
05181         <span class="comment">// We might be turning on the device. So we will clear the problem</span>
05182         <span class="comment">// flags iff the device problem was CM_PROB_DISABLED.</span>
05183         <span class="comment">//</span>
05184         <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(DeviceNode);
05185 
05186         <span class="comment">//</span>
05187         <span class="comment">// Make sure the device stays down iff appropriate.</span>
05188         <span class="comment">//</span>
05189         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a20">IopIsDeviceInstanceEnabled</a>(NULL, &amp;DeviceNode-&gt;InstancePath, FALSE)) {
05190 
05191             <span class="comment">//</span>
05192             <span class="comment">// This device should come back online. Queue up an enumeration</span>
05193             <span class="comment">// at the parent level for him.</span>
05194             <span class="comment">//</span>
05195             parentDevNode = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
05196 
05197             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a79">IoInvalidateDeviceRelations</a>(
05198                 parentDevNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
05199                 BusRelations
05200                 );
05201         }
05202     }
05203 
05204     <span class="keywordflow">return</span> STATUS_SUCCESS;
05205 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="pnpenum.c::IopProcessNewProfileWorker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopProcessNewProfileWorker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05109">5109</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00127">IopForAllDeviceNodes()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05138">IopProcessNewProfileStateCallback()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05034">IopProcessNewProfile()</a>.
<p>
<pre class="fragment"><div>05115                    :
05116 
05117     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> each devnode after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has transitioned
05118     to a <span class="keyword">new</span> hardware profile.
05119 
05120 Parameters:
05121 
05122     NONE.
05123 
05124 Return Value:
05125 
05126     NONE.
05127 
05128 --*/
05129 {
05130     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05131 
05132     <a class="code" href="../../d9/d0/pnpiop_8h.html#a253">IopForAllDeviceNodes</a>(IopProcessNewProfileStateCallback, NULL);
05133 
05134     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Context);
05135 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="pnpenum.c::IopProcessStartDevices" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopProcessStartDevices           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">PSTART_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StartContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00821">821</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00074">IopDeviceTreeLock</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00912">IopProcessStartDevicesWorker()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01276">IopReleaseEnumerationLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a167">PpSynchronizeDeviceEventQueue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00728">IopBusCheck()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, and <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>.
<p>
<pre class="fragment"><div>00828                    :
00829 
00830     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by Pnp manager to start <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devices which have been
00831     allocated resources and waiting to be started.
00832 
00833 Parameters:
00834 
00835     DeviceNode - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node whose subtree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be checked <span class="keywordflow">for</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a224">StartDevice</a>.
00836 
00837     StartContext - specifies <span class="keywordflow">if</span> <span class="keyword">new</span> driver should be loaded to complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration.
00838 
00839 Return Value:
00840 
00841     NONE.
00842 
00843 --*/
00844 {
00845     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00846     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode, nextDeviceNode;
00847 
00848     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00849 
00850     <span class="comment">//</span>
00851     <span class="comment">// Parse the device node subtree to determine which devices need to be started</span>
00852     <span class="comment">//</span>
00853 
00854     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;IopDeviceTreeLock, TRUE);
00855     <span class="keywordflow">if</span> (DeviceNode-&gt;LockCount == 0) {
00856 
00857         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;DeviceNode-&gt;EnumerationMutex,
00858                                Executive,
00859                                KernelMode,
00860                                FALSE,
00861                                NULL );
00862 
00863         deviceNode = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00864         <span class="keywordflow">while</span> (deviceNode) {
00865             nextDeviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00866             status = <a class="code" href="../../d6/d0/pnpenum_8c.html#a25">IopProcessStartDevicesWorker</a>(deviceNode, StartContext);
00867 
00868             <span class="keywordflow">if</span> (status == STATUS_PNP_RESTART_ENUMERATION) {
00869 
00870                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(DeviceNode);
00871 
00872                 <a class="code" href="../../d6/d9/pnp_8h.html#a167">PpSynchronizeDeviceEventQueue</a>();
00873 
00874                 <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;IopDeviceTreeLock, TRUE);
00875                 <span class="keywordflow">if</span> (DeviceNode-&gt;LockCount == 0) {
00876 
00877                     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;DeviceNode-&gt;EnumerationMutex,
00878                                            Executive,
00879                                            KernelMode,
00880                                            FALSE,
00881                                            NULL );
00882 
00883 
00884                     <span class="keywordflow">if</span> (!(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>)) {
00885                         <span class="keywordflow">break</span>;
00886                     }
00887 
00888                     deviceNode = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00889 
00890                     <span class="keywordflow">continue</span>;
00891 
00892                 } <span class="keywordflow">else</span> {
00893 
00894                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;IopDeviceTreeLock);
00895                     <span class="keywordflow">return</span>;
00896 
00897                 }
00898             }
00899 
00900             deviceNode = nextDeviceNode;
00901         }
00902 
00903         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;DeviceNode-&gt;EnumerationMutex,
00904                     0,
00905                     FALSE );
00906     }
00907 
00908     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;IopDeviceTreeLock);
00909 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="pnpenum.c::IopProcessStartDevicesWorker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopProcessStartDevicesWorker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00912">912</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00625">DNF_HAS_RESOURCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00402">DNF_NEED_QUERY_IDS</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00619">DNF_START_PHASE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00074">IopDeviceTreeLock</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00179">IopForAllChildDeviceNodes()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00912">IopProcessStartDevicesWorker()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00821">IopProcessStartDevices()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00912">IopProcessStartDevicesWorker()</a>.
<p>
<pre class="fragment"><div>00919                    :
00920 
00921     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by Pnp manager to start <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devices which have been allocated
00922     resources and waiting to be started.
00923 
00924 Parameters:
00925 
00926     DeviceNode - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node whose subtree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be checked <span class="keywordflow">for</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a224">StartDevice</a>.
00927 
00928     Context - specifies a pointer to <a class="code" href="../../d0/d6/struct__START__CONTEXT.html">START_CONTEXT</a> to pass start device info.
00929 
00930 Return Value:
00931 
00932     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
00933 
00934 --*/
00935 {
00936     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status = STATUS_SUCCESS;
00937 
00938     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00939 
00940     <span class="keywordflow">if</span> ( (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a10">DNF_NEED_QUERY_IDS</a>) ||   <span class="comment">// Reported devices are Started but not enumerated</span>
00941          ((DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>) &amp;&amp;
00942           !(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a43">DNF_START_PHASE</a>) &amp;&amp;
00943           (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a46">DNF_HAS_RESOURCE</a>)) ) {
00944 
00945         <span class="comment">//</span>
00946         <span class="comment">// If device has been added and resources acquired, we will start it by</span>
00947         <span class="comment">// sending StartDevice irp and enumerate the device.</span>
00948         <span class="comment">//</span>
00949 
00950         status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a285">IopStartAndEnumerateDevice</a>(DeviceNode, (<a class="code" href="../../d0/d6/struct__START__CONTEXT.html">PSTART_CONTEXT</a>)Context);
00951 
00952     } <span class="keywordflow">else</span> {
00953 
00954         <span class="comment">//</span>
00955         <span class="comment">// Acquire enumeration mutex to make sure its children won't change by</span>
00956         <span class="comment">// someone else.  Note, the current device node is protected by its parent's</span>
00957         <span class="comment">// Enumeration mutex and it won't disappear either.</span>
00958         <span class="comment">//</span>
00959 
00960         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;IopDeviceTreeLock, TRUE);
00961 
00962         <span class="keywordflow">if</span> (DeviceNode-&gt;LockCount == 0) {
00963 
00964             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;DeviceNode-&gt;EnumerationMutex,
00965                                    Executive,
00966                                    KernelMode,
00967                                    FALSE,
00968                                    NULL );
00969 
00970 
00971             <span class="comment">//</span>
00972             <span class="comment">// Recursively mark all of our children deleted.</span>
00973             <span class="comment">//</span>
00974 
00975             <a class="code" href="../../d9/d0/pnpiop_8h.html#a270">IopForAllChildDeviceNodes</a>(DeviceNode, IopProcessStartDevicesWorker, Context);
00976 
00977             <span class="comment">//</span>
00978             <span class="comment">// Release the enumeration mutex of the device node.</span>
00979             <span class="comment">//</span>
00980 
00981             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;DeviceNode-&gt;EnumerationMutex,
00982                         0,
00983                         FALSE );
00984 
00985         }
00986 
00987         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;IopDeviceTreeLock);
00988     }
00989 
00990     <span class="keywordflow">return</span> status;
00991 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="pnpenum.c::IopQueryDeviceCapabilities" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDeviceCapabilities           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Capabilities</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03694">3694</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/io_8h.html#a365">DEVICE_CAPABILITIES</a>, <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00170">IRP_MN_QUERY_CAPABILITIES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00373">IoGetDeviceProperty()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05524">IopDeviceCapabilitiesToRegistry()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05633">IopDeviceNodeCapabilitiesToRegistry()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>03701                    :
03702 
03703     This routine will issue an irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceObject to retrieve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03704     pnp device capabilities.
03705     Should <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be called twice - first from <a class="code" href="../../d6/d0/pnpenum_8c.html#a35">IopProcessNewDeviceNode</a>,
03706     and second from <a class="code" href="../../d9/d0/pnpiop_8h.html#a328">IopDeviceNodeCapabilitiesToRegistry</a>, called after
03707     device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> started. If you consider calling <span class="keyword">this</span> device, see <span class="keywordflow">if</span>
03708     DeviceNode-&gt;CapabilityFlags does what you need instead (accessed
03709     via <a class="code" href="../../d9/d0/pnpiop_8h.html#a101">IopDeviceNodeFlagsToCapabilities</a>(...).
03710 
03711 Arguments:
03712 
03713     DeviceNode - the device object the request should be sent to.
03714 
03715     Capabilities - a capabilities structure to be filled in by the driver.
03716 
03717 Return Value:
03718 
03719     status
03720 
03721 --*/
03722 
03723 {
03724     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpStack;
03725     PVOID dummy;
03726 
03727     NTSTATUS status;
03728 
03729     <span class="comment">//</span>
03730     <span class="comment">// Initialize the capabilities structure.</span>
03731     <span class="comment">//</span>
03732 
03733     RtlZeroMemory(Capabilities, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a>));
03734     Capabilities-&gt;Size = <span class="keyword">sizeof</span>(DEVICE_CAPABILITIES);
03735     Capabilities-&gt;Version = 1;
03736     Capabilities-&gt;Address = Capabilities-&gt;UINumber = (ULONG)-1;
03737 
03738     <span class="comment">//</span>
03739     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
03740     <span class="comment">//</span>
03741 
03742     RtlZeroMemory(&amp;irpStack, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
03743 
03744     <span class="comment">//</span>
03745     <span class="comment">// Query the device's capabilities</span>
03746     <span class="comment">//</span>
03747 
03748     irpStack.MajorFunction = IRP_MJ_PNP;
03749     irpStack.MinorFunction = IRP_MN_QUERY_CAPABILITIES;
03750     irpStack.Parameters.DeviceCapabilities.Capabilities = Capabilities;
03751 
03752     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a291">IopSynchronousCall</a>(DeviceNode-&gt;PhysicalDeviceObject,
03753                                 &amp;irpStack,
03754                                 &amp;dummy);
03755 
03756     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status != STATUS_PENDING);
03757 
03758     <span class="keywordflow">return</span> status;
03759 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="pnpenum.c::IopRequestDeviceAction" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRequestDeviceAction           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a133">DEVICE_REQUEST_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> CompletionEvent&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PNTSTATUS CompletionStatus&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">207</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00799">_PI_DEVICE_REQUEST::CompletionEvent</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00800">_PI_DEVICE_REQUEST::CompletionStatus</a>, <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a133">DEVICE_REQUEST_TYPE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00797">_PI_DEVICE_REQUEST::DeviceObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00196">IopDeviceEnumerationWorkItem</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00195">IopEnumerationInProgress</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00104">IopPnpEnumerationRequestList</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00068">IopPnPSpinLock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00796">_PI_DEVICE_REQUEST::ListEntry</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a134">PI_DEVICE_REQUEST</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00086">PiEnumerationLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00128">PnPBootDriversLoaded</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a135">PPI_DEVICE_REQUEST</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a220">ReenumerateBootDevices</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a225">ReenumerateRootDevices</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00798">_PI_DEVICE_REQUEST::RequestType</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01395">IoInvalidateDeviceRelations()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00557">IopDeleteLockedDeviceNodes()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01496">IopDeviceRelationsComplete()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01250">IopInvalidateRelationsInList()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">IopQueryDeviceRelations()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06439">IopResourceRequirementsChanged()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01740">IopStartDriverDevices()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01291">IoSynchronousInvalidateDeviceRelations()</a>.
<p>
<pre class="fragment"><div>00216                    :
00217 
00218     This routine queues a work item to enumerate a device. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> IO
00219     internal use <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
00220 
00221 Arguments:
00222 
00223     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object to be enumerated.
00224                    <span class="keywordflow">if</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a request to retry resources allocation
00225                    failed devices.
00226 
00227     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration.
00228 
00229 Return Value:
00230 
00231     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00232 
00233 --*/
00234 
00235 {
00236     <a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html">PPI_DEVICE_REQUEST</a>  request;
00237     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>        deviceNode;
00238     KIRQL               oldIrql;
00239 
00240     <span class="comment">//</span>
00241     <span class="comment">// If this node is ready for enumeration, enqueue it</span>
00242     <span class="comment">//</span>
00243 
00244     request = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html">PI_DEVICE_REQUEST</a>));
00245 
00246     <span class="keywordflow">if</span> (request) {
00247         <span class="comment">//</span>
00248         <span class="comment">// Put this request onto the pending list</span>
00249         <span class="comment">//</span>
00250 
00251         <span class="keywordflow">if</span> (DeviceObject) {
00252             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(DeviceObject);
00253         }
00254 
00255         request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o1">DeviceObject</a> = DeviceObject;
00256         request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o2">RequestType</a> = RequestType;
00257         request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o3">CompletionEvent</a> = CompletionEvent;
00258         request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o4">CompletionStatus</a> = (RequestType == <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a220">ReenumerateBootDevices</a>)? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : CompletionStatus;
00259 
00260         InitializeListHead(&amp;request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o0">ListEntry</a>);
00261 
00262         <span class="comment">//</span>
00263         <span class="comment">// Insert the  request to the request queue.  If the request queue is</span>
00264         <span class="comment">// not currently being worked on, request a worker thread to start it.</span>
00265         <span class="comment">//</span>
00266 
00267         ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
00268 
00269         InsertTailList(&amp;IopPnpEnumerationRequestList, &amp;request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o0">ListEntry</a>);
00270 
00271         <span class="keywordflow">if</span> (    RequestType == <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a220">ReenumerateBootDevices</a> ||
00272                 RequestType == <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a225">ReenumerateRootDevices</a>) {
00273             <span class="comment">//</span>
00274             <span class="comment">// This is a special request used when booting the system.  Instead</span>
00275             <span class="comment">// of queuing a work item it synchronously calls the work routine.</span>
00276             <span class="comment">//</span>
00277 
00278             <a class="code" href="../../d6/d0/pnpenum_8c.html#a10">IopEnumerationInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00279             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(&amp;PiEnumerationLock);
00280             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
00281 
00282             <a class="code" href="../../d6/d0/pnpenum_8c.html#a19">IopDeviceActionWorker</a>((PVOID)CompletionStatus);
00283 
00284         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a17">PnPBootDriversLoaded</a> &amp;&amp; !<a class="code" href="../../d6/d0/pnpenum_8c.html#a10">IopEnumerationInProgress</a>) {
00285             <a class="code" href="../../d6/d0/pnpenum_8c.html#a10">IopEnumerationInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00286             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(&amp;PiEnumerationLock);
00287             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
00288 
00289             <span class="comment">//</span>
00290             <span class="comment">// Queue a work item to do the enumeration</span>
00291             <span class="comment">//</span>
00292 
00293             <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(&amp;IopDeviceEnumerationWorkItem, IopDeviceActionWorker, NULL);
00294             <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(&amp;IopDeviceEnumerationWorkItem, DelayedWorkQueue);
00295         } <span class="keywordflow">else</span> {
00296             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
00297         }
00298     } <span class="keywordflow">else</span> {
00299         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00300     }
00301 
00302     <span class="keywordflow">return</span> STATUS_SUCCESS;
00303 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="pnpenum.c::IopStartAndEnumerateDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopStartAndEnumerateDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">PSTART_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StartContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">994</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a422">BusQueryHardwareIDs</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00625">DNF_HAS_RESOURCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00500">DNF_NEED_ENUMERATION_ONLY</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00402">DNF_NEED_QUERY_IDS</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00433">DNF_NO_RESOURCE_REQUIRED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00619">DNF_START_PHASE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05633">IopDeviceNodeCapabilitiesToRegistry()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03776">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04559">IopFixupIds()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02173">IopQueryCompatibleIds()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">IopQueryDeviceState()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00633">PNP_ERR_BOGUS_ID</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00173">PnpAsyncOk</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00912">IopProcessStartDevicesWorker()</a>.
<p>
<pre class="fragment"><div>01001                    :
01002 
01003     This routine starts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device and enumerates <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01004 
01005     NOTE: The resources <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device should already been allocated.
01006 
01007 Arguments:
01008 
01009     DeviceNode - Supplies a pointer to a device node which will be started and
01010                  enumerated.
01011 
01012     StartContext - Supplies a pointer to <a class="code" href="../../d0/d6/struct__START__CONTEXT.html">START_CONTEXT</a> structure to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>
01013                  how <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start should be handled.
01014 
01015 Return Value:
01016 
01017     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
01018 
01019 --*/
01020 
01021 {
01022     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01023     UNICODE_STRING unicodeName;
01024     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
01025     HANDLE         handle;
01026 
01027     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01028 
01029     <span class="comment">//</span>
01030     <span class="comment">// If no driver is loaded or add device failed, don't start it.</span>
01031     <span class="comment">//</span>
01032 
01033     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((DeviceNode-&gt;Flags &amp; DNF_ADDED) &amp;&amp;
01034            (DeviceNode-&gt;Flags &amp; (DNF_HAS_RESOURCE | DNF_NO_RESOURCE_REQUIRED)) &amp;&amp;
01035            (!(DeviceNode-&gt;Flags &amp; DNF_START_PHASE) || (DeviceNode-&gt;Flags &amp; DNF_NEED_QUERY_IDS))
01036            );
01037 
01038     deviceObject = DeviceNode-&gt;PhysicalDeviceObject;
01039 
01040     <span class="comment">//</span>
01041     <span class="comment">// First start the device, if it hasn't</span>
01042     <span class="comment">//</span>
01043 
01044     <span class="keywordflow">if</span> (!(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>)) {
01045 
01046         <a class="code" href="../../d0/d1/pnpirp_8c.html#a19">IopStartDevice</a>(deviceObject);
01047 
01048         <span class="comment">//</span>
01049         <span class="comment">// ADRIAO BUGBUG 11/11/98 -</span>
01050         <span class="comment">//     Everything in this if clause expects the start call to</span>
01051         <span class="comment">// returns synchronously. When AsyncOk == TRUE functionality is fixed,</span>
01052         <span class="comment">// code in here should be moved into IopStartDevice.</span>
01053         <span class="comment">//</span>
01054         <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
01055 
01056             <a class="code" href="../../d9/d1/pnpsubs_8c.html#a37">IopDeviceNodeCapabilitiesToRegistry</a>(DeviceNode);
01057             <a class="code" href="../../d0/d1/pnpirp_8c.html#a32">IopQueryDeviceState</a>(deviceObject);
01058         }
01059     }
01060 
01061     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a10">DNF_NEED_QUERY_IDS</a>) {
01062 
01063         PWCHAR compatibleIds, hwIds;
01064         ULONG hwIdLength, compatibleIdLength;
01065 
01066         <span class="comment">//</span>
01067         <span class="comment">// If the DNF_NEED_QUERY_IDS is set, the device is a reported device.</span>
01068         <span class="comment">// It should already be started.  We need to enumerate its children and ask</span>
01069         <span class="comment">// the HardwareId and the Compatible ids of the detected device.</span>
01070         <span class="comment">//</span>
01071 
01072         DeviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a10">DNF_NEED_QUERY_IDS</a>;
01073         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a> (deviceObject,
01074                                                   &amp;handle,
01075                                                   KEY_READ
01076                                                   );
01077         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01078             status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a26">IopQueryCompatibleIds</a>(deviceObject,
01079                                            BusQueryHardwareIDs,
01080                                            &amp;hwIds,
01081                                            &amp;hwIdLength);
01082 
01083             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01084                 hwIds = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01085             }
01086 
01087             status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a26">IopQueryCompatibleIds</a>(deviceObject,
01088                                            BusQueryCompatibleIDs,
01089                                            &amp;compatibleIds,
01090                                            &amp;compatibleIdLength);
01091             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01092                 compatibleIds = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01093             }
01094 
01095             <span class="keywordflow">if</span> (hwIds || compatibleIds) {
01096                 <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01097                 <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
01098 
01099                 <span class="keywordflow">if</span> (hwIds) {
01100 
01101                     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/pnpenum_8c.html#a28">IopFixupIds</a>(hwIds, hwIdLength)) {
01102                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
01103                                       PNP_ERR_BOGUS_ID,
01104                                       (ULONG_PTR)deviceObject,
01105                                       (ULONG_PTR)hwIds,
01106                                       3);
01107                     }
01108                     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_HARDWAREID);
01109                     ZwSetValueKey(handle,
01110                                   &amp;unicodeName,
01111                                   TITLE_INDEX_VALUE,
01112                                   REG_MULTI_SZ,
01113                                   hwIds,
01114                                   hwIdLength
01115                                   );
01116                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(hwIds);
01117                 }
01118 
01119                 <span class="comment">//</span>
01120                 <span class="comment">// create CompatibleId value name.  It is a MULTI_SZ,</span>
01121                 <span class="comment">//</span>
01122 
01123                 <span class="keywordflow">if</span> (compatibleIds) {
01124 
01125                     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/pnpenum_8c.html#a28">IopFixupIds</a>(compatibleIds, compatibleIdLength)) {
01126                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
01127                                       PNP_ERR_BOGUS_ID,
01128                                       (ULONG_PTR)deviceObject,
01129                                       (ULONG_PTR)compatibleIds,
01130                                       4);
01131                     }
01132 
01133                     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_COMPATIBLEIDS);
01134                     ZwSetValueKey(handle,
01135                                   &amp;unicodeName,
01136                                   TITLE_INDEX_VALUE,
01137                                   REG_MULTI_SZ,
01138                                   compatibleIds,
01139                                   compatibleIdLength
01140                                   );
01141                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(compatibleIds);
01142                 }
01143 
01144                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
01145                 <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01146             }
01147             ZwClose(handle);
01148         }
01149     }
01150 
01151     <span class="keywordflow">if</span> ((DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) &amp;&amp;
01152         (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a25">DNF_NEED_ENUMERATION_ONLY</a>)) {
01153 
01154         status = <a class="code" href="../../d6/d0/pnpenum_8c.html#a20">IopEnumerateDevice</a>(deviceObject, StartContext, PnpAsyncOk);
01155     } <span class="keywordflow">else</span> {
01156         status = STATUS_SUCCESS;
01157     }
01158 
01159     <span class="keywordflow">return</span> status;
01160 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a11" doxytag="pnpenum.c::IopDeviceEnumerationWorkItem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> <a class="el" href="../../d6/d0/pnpenum_8c.html#a11">IopDeviceEnumerationWorkItem</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00196">196</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="pnpenum.c::IopEnumerationInProgress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d6/d0/pnpenum_8c.html#a10">IopEnumerationInProgress</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00195">195</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="pnpenum.c::PnpEnumDebugLevel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d0/pnpenum_8c.html#a9">PnpEnumDebugLevel</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00168">168</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:10 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
