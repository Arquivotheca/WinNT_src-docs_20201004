<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hiveinit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hiveinit.c</h1><a href="../../d5/d1/hiveinit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    hiveinit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Hive initialization code.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Bryan M. Willman (bryanwi) 12-Sep-91</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment">    Dragos C. Sambotin (dragoss) 25-Jan-99</span>
00022 <span class="comment">        Implementation of bin-size chunk loading of hives.</span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00026 
00027 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00028 <a class="code" href="../../d5/d1/hiveinit_8c.html#a1">HvpFillFileName</a>(
00029     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>            BaseBlock,
00030     PUNICODE_STRING         FileName
00031     );
00032 
00033 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvInitializeHive)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpFillFileName)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpFreeAllocatedBins)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span>
00039 
00040 
00041 <span class="preprocessor">#if 0</span>
00042 <span class="preprocessor"></span>
00043 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00044 <a class="code" href="../../d5/d1/hiveinit_8c.html#a0">HvpDumpFreeDisplay</a>(     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive
00045                    )
00046 {
00047     ULONG       <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00048     ULONG       Mask;
00049     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> cell;
00050     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>      pcell;
00051 
00052     KdPrint((<span class="stringliteral">"\nHvpDumpFreeDisplay:\n"</span>));
00053 
00054     <span class="keywordflow">for</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> =0;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>&lt;<a class="code" href="../../d0/d1/hivedata_8h.html#a45">HHIVE_FREE_DISPLAY_SIZE</a>;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++){
00055         Mask = 1;
00056         Mask &lt;&lt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00057         KdPrint((<span class="stringliteral">"\nFreeDisplay[%lu]\n"</span>,Index));
00058         <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeSummary &amp; Mask) {
00059         <span class="comment">//</span>
00060         <span class="comment">// there is something on this list</span>
00061         <span class="comment">//</span>
00062             
00063             cell = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeDisplay[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00064             <span class="keywordflow">while</span> (cell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00065 
00066                 KdPrint((<span class="stringliteral">"0x%08lx "</span>,cell));
00067                 pcell = <a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive, cell);
00068 
00069                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00070                     cell = pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.Next;
00071                 } <span class="keywordflow">else</span> {
00072                     cell = pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.Next;
00073                 }
00074             }
00075         }
00076     }
00077 }
00078 <span class="preprocessor">#else</span>
00079 <span class="preprocessor"></span>
<a name="l00080"></a><a class="code" href="../../d5/d1/hiveinit_8c.html#a0">00080</a> <span class="preprocessor">#define HvpDumpFreeDisplay(Hive) //nothing</span>
00081 <span class="preprocessor"></span>
00082 <span class="preprocessor">#endif</span>
00083 <span class="preprocessor"></span>
00084 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00085"></a><a class="code" href="../../d5/d1/hiveinit_8c.html#a2">00085</a> <a class="code" href="../../d5/d1/hiveinit_8c.html#a2">HvpFreeAllocatedBins</a>(
00086     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive
00087     )
00088 <span class="comment">/*++</span>
00089 <span class="comment"></span>
00090 <span class="comment">Routine Description:</span>
00091 <span class="comment"></span>
00092 <span class="comment">    Free all the bins allocated for the specified hive.</span>
00093 <span class="comment">    It applies only to stable storage. Not all bins are allocated.</span>
00094 <span class="comment">    Those that are not allocated have BinAddress set to 0</span>
00095 <span class="comment">    </span>
00096 <span class="comment">Arguments:</span>
00097 <span class="comment"></span>
00098 <span class="comment">    Hive - supplies a pointer to hive control structure for hive who's bin to free.</span>
00099 <span class="comment"></span>
00100 <span class="comment">Return Value:</span>
00101 <span class="comment"></span>
00102 <span class="comment">    NONE.</span>
00103 <span class="comment"></span>
00104 <span class="comment">--*/</span>
00105 {
00106     ULONG           Length;
00107     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00108     ULONG           MapSlots;
00109     ULONG           Tables;
00110     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00111     <a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>     Tab;
00112     ULONG           i;
00113     ULONG           j;
00114 
00115     <span class="comment">//</span>
00116     <span class="comment">// calculate the number of tables in the map</span>
00117     <span class="comment">//</span>
00118     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length;
00119     MapSlots = Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00120     <span class="keywordflow">if</span>( MapSlots &gt; 0 ) {
00121         Tables = (MapSlots-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00122     } <span class="keywordflow">else</span> {
00123         Tables = 0;
00124     }
00125 
00126     <span class="keywordflow">if</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map ) {
00127         <span class="comment">//</span>
00128         <span class="comment">// iterate through the directory </span>
00129         <span class="comment">//</span>
00130         <span class="keywordflow">for</span> (i = 0; i &lt;= Tables; i++) {
00131             Tab = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map-&gt;Directory[i];
00132 
00133             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Tab);
00134             
00135             <span class="comment">//</span>
00136             <span class="comment">// iterate through the slots in the directory</span>
00137             <span class="comment">//</span>
00138             <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;j++) {
00139                 Me = &amp;(Tab-&gt;<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html#o0">Table</a>[j]);
00140                 <span class="comment">//</span>
00141                 <span class="comment">// BinAddress non-zero means allocated bin</span>
00142                 <span class="comment">//</span>
00143                 <span class="keywordflow">if</span>( Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> ) {
00144                     <span class="keywordflow">if</span>( Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a> ) {
00145                         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00146                         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>);
00147                     }
00148                     
00149                     Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> = 0;
00150                 }
00151             }
00152         }
00153     }
00154    
00155 }
00156 
00157 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00158"></a><a class="code" href="../../d5/d1/hiveinit_8c.html#a3">00158</a> <a class="code" href="../../d5/d1/hiveinit_8c.html#a3">HvInitializeHive</a>(
00159     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>                  Hive,
00160     ULONG                   OperationType,
00161     ULONG                   HiveFlags,
00162     ULONG                   FileType,
00163     PVOID                   HiveData OPTIONAL,
00164     PALLOCATE_ROUTINE       AllocateRoutine,
00165     PFREE_ROUTINE           FreeRoutine,
00166     PFILE_SET_SIZE_ROUTINE  FileSetSizeRoutine,
00167     PFILE_WRITE_ROUTINE     FileWriteRoutine,
00168     PFILE_READ_ROUTINE      FileReadRoutine,
00169     PFILE_FLUSH_ROUTINE     FileFlushRoutine,
00170     ULONG                   Cluster,
00171     PUNICODE_STRING         FileName OPTIONAL
00172     )
00173 <span class="comment">/*++</span>
00174 <span class="comment"></span>
00175 <span class="comment">Routine Description:</span>
00176 <span class="comment"></span>
00177 <span class="comment">    Initialize a hive.</span>
00178 <span class="comment"></span>
00179 <span class="comment">    Core HHive fields are always inited.</span>
00180 <span class="comment"></span>
00181 <span class="comment">    File calls WILL be made BEFORE this call returns.</span>
00182 <span class="comment"></span>
00183 <span class="comment">    Caller is expected to create/open files and store file handles</span>
00184 <span class="comment">    in a way that can be derived from the hive pointer.</span>
00185 <span class="comment"></span>
00186 <span class="comment">    Three kinds of initialization can be done, selected by OperationType:</span>
00187 <span class="comment"></span>
00188 <span class="comment">        HINIT_CREATE</span>
00189 <span class="comment"></span>
00190 <span class="comment">            Create a new hive from scratch.  Will have 0 storage.</span>
00191 <span class="comment">            [Used to do things like create HARDWARE hive and for parts</span>
00192 <span class="comment">             of SaveKey and RestoreKey]</span>
00193 <span class="comment"></span>
00194 <span class="comment"></span>
00195 <span class="comment">        HINIT_MEMORY_INPLACE</span>
00196 <span class="comment"></span>
00197 <span class="comment">            Build a hive control structure which allows read only</span>
00198 <span class="comment">            access to a contiguous in-memory image of a hive.</span>
00199 <span class="comment">            No part of the image will be copied, but a map will</span>
00200 <span class="comment">            be made.</span>
00201 <span class="comment">            [Used by osloader.]</span>
00202 <span class="comment"></span>
00203 <span class="comment"></span>
00204 <span class="comment">        HINIT_FLAT</span>
00205 <span class="comment"></span>
00206 <span class="comment">            Support very limited (read-only, no checking code) operation</span>
00207 <span class="comment">            against a hive image.</span>
00208 <span class="comment"></span>
00209 <span class="comment"></span>
00210 <span class="comment">        HINIT_MEMORY</span>
00211 <span class="comment"></span>
00212 <span class="comment">            Create a new hive, using a hive image already in memory,</span>
00213 <span class="comment">            at address supplied by pointer HiveData.  The data will</span>
00214 <span class="comment">            be copied.  Caller is expected to free HiveData.</span>
00215 <span class="comment">            [Used for SYSTEM hive]</span>
00216 <span class="comment"></span>
00217 <span class="comment"></span>
00218 <span class="comment">        HINIT_FILE</span>
00219 <span class="comment"></span>
00220 <span class="comment">            Create a hive, reading its data from a file.  Recovery processing</span>
00221 <span class="comment">            via log file will be done if a log is available.  If a log</span>
00222 <span class="comment">            is recovered, flush and clear operation will proceed.</span>
00223 <span class="comment"></span>
00224 <span class="comment"></span>
00225 <span class="comment">    NOTE:   The HHive is not a completely opaque structure, because it</span>
00226 <span class="comment">            is really only used by a limited set of code.  Do not assume</span>
00227 <span class="comment">            that only this routine sets all of these values.</span>
00228 <span class="comment"></span>
00229 <span class="comment"></span>
00230 <span class="comment">Arguments:</span>
00231 <span class="comment"></span>
00232 <span class="comment">    Hive - supplies a pointer to hive control structure to be initialized</span>
00233 <span class="comment">            to describe this hive.</span>
00234 <span class="comment"></span>
00235 <span class="comment">    OperationType - specifies whether to create a new hive from scratch,</span>
00236 <span class="comment">            from a memory image, or by reading a file from disk.</span>
00237 <span class="comment"></span>
00238 <span class="comment">    HiveFlags - HIVE_VOLATILE - Entire hive is to be volatile, regardless</span>
00239 <span class="comment">                                   of the types of cells allocated</span>
00240 <span class="comment">                HIVE_NO_LAZY_FLUSH - Data in this hive is never written</span>
00241 <span class="comment">                                   to disk except by an explicit FlushKey</span>
00242 <span class="comment"></span>
00243 <span class="comment">    FileType - HFILE_TYPE_*, HFILE_TYPE_LOG or HFILE_TYPE_ALTERNATE set</span>
00244 <span class="comment">            up for logging or alternate support respectively.</span>
00245 <span class="comment"></span>
00246 <span class="comment">    HiveData - if present, supplies a pointer to an in memory image of</span>
00247 <span class="comment">            from which to init the hive.  Only useful when OperationType</span>
00248 <span class="comment">            is set to HINIT_MEMORY.</span>
00249 <span class="comment"></span>
00250 <span class="comment">    AllocateRoutine - supplies a pointer to routine called to allocate</span>
00251 <span class="comment">                        memory.  WILL be called before this routine returns.</span>
00252 <span class="comment"></span>
00253 <span class="comment">    FreeRoutine - supplies a pointer to routine called to free memory.</span>
00254 <span class="comment">                   CAN be called before this routine returns.</span>
00255 <span class="comment"></span>
00256 <span class="comment">    FileSetSizeRoutine - supplies a pointer to a routine used to set the</span>
00257 <span class="comment">                         size of a file. CAN be called before this</span>
00258 <span class="comment">                         routine returns.</span>
00259 <span class="comment"></span>
00260 <span class="comment">    FileWriteRoutine - supplies a pointer to routine called to write memory</span>
00261 <span class="comment">                        to a file.</span>
00262 <span class="comment"></span>
00263 <span class="comment">    FileReadRoutine - supplies a pointer to routine called to read from</span>
00264 <span class="comment">                        a file into memory. CAN be called before this</span>
00265 <span class="comment">                        routine returns.</span>
00266 <span class="comment"></span>
00267 <span class="comment">    FileFlushRoutine - supplies a pointer to routine called to flush a file.</span>
00268 <span class="comment"></span>
00269 <span class="comment">    Cluster - clustering factor in HSECTOR_SIZE units.  (i.e.  Size of</span>
00270 <span class="comment">            physical sector in media / HSECTOR_SIZE.  1 for 512 byte</span>
00271 <span class="comment">            physical sectors (or smaller), 2 for 1024, 4 for 2048, etc.</span>
00272 <span class="comment">            (Numbers greater than 8 won't work.)</span>
00273 <span class="comment"></span>
00274 <span class="comment">    FileName - some path like "...\system32\config\system", last</span>
00275 <span class="comment">                32 or so characters will be copied into baseblock</span>
00276 <span class="comment">                (and thus to disk) as a debugging aid.  May be null.</span>
00277 <span class="comment"></span>
00278 <span class="comment"></span>
00279 <span class="comment">Return Value:</span>
00280 <span class="comment"></span>
00281 <span class="comment">    NTSTATUS code.</span>
00282 <span class="comment"></span>
00283 <span class="comment">--*/</span>
00284 {
00285     BOOLEAN         UseForIo;
00286     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00287     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00288     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        Status2;
00289     PVOID           Image;
00290     ULONG           i;
00291     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           Pbin;
00292     ULONG           Alignment;
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">// this array stores the last elements in each free cell list for the stable storage</span>
00296     <span class="comment">//</span>
00297     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     TailDisplay[<a class="code" href="../../d0/d1/hivedata_8h.html#a45">HHIVE_FREE_DISPLAY_SIZE</a>];
00298 
00299     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
00300         KdPrint((<span class="stringliteral">"HvInitializeHive:\n"</span>));
00301         KdPrint((<span class="stringliteral">"\tHive=%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
00302     }
00303 
00304     <span class="comment">//</span>
00305     <span class="comment">// reject invalid parameter combinations</span>
00306     <span class="comment">//</span>
00307     <span class="keywordflow">if</span> ( (! ARGUMENT_PRESENT(HiveData)) &amp;&amp;
00308          ((OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>) ||
00309           (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a8">HINIT_FLAT</a>) ||
00310           (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a7">HINIT_MEMORY_INPLACE</a>))
00311        )
00312     {
00313         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00314     }
00315 
00316     <span class="keywordflow">if</span> ( ! ((OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>) ||
00317             (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>) ||
00318             (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a7">HINIT_MEMORY_INPLACE</a>) ||
00319             (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a8">HINIT_FLAT</a>) ||
00320             (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>))
00321        )
00322     {
00323         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00324     }
00325 
00326 
00327     <span class="comment">//</span>
00328     <span class="comment">// static and global control values</span>
00329     <span class="comment">//</span>
00330     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a37">HHIVE_SIGNATURE</a>;
00331 
00332     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a> = AllocateRoutine;
00333     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a> = FreeRoutine;
00334     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a> = FileSetSizeRoutine;
00335     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a> = FileWriteRoutine;
00336     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a> = FileReadRoutine;
00337     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a> = FileFlushRoutine;
00338 
00339     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> = (BOOLEAN)((FileType == <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00340     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o16">Alternate</a> = (BOOLEAN)((FileType == <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00341 
00342     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> || <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o16">Alternate</a>)  &amp;&amp; (HiveFlags &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>)) {
00343         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00344     }
00345 
00346     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> = HiveFlags;
00347 
00348     <span class="keywordflow">if</span> ((Cluster == 0) || (Cluster &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a16">HSECTOR_COUNT</a>)) {
00349         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00350     }
00351     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> = Cluster;
00352 
00353     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o19">RefreshCount</a> = 0;
00354 
00355     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a5">HTYPE_COUNT</a>;
00356 
00357 
00358     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Length = 0;
00359     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Map = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00360     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].SmallDir = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00361     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Guard = (ULONG)-1;
00362     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].FreeSummary = 0;
00363     InitializeListHead(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].FreeBins);
00364     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d1/hivedata_8h.html#a45">HHIVE_FREE_DISPLAY_SIZE</a>; i++) {
00365         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].FreeDisplay[i] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00366     }
00367 
00368     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length = 0;
00369     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00370     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00371     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Guard = (ULONG)-1;
00372     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeSummary = 0;
00373     InitializeListHead(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeBins);
00374     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d1/hivedata_8h.html#a45">HHIVE_FREE_DISPLAY_SIZE</a>; i++) {
00375         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeDisplay[i] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00376         TailDisplay[i] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00377     }
00378 
00379     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00380     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = 0;
00381     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a> = 0;
00382     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> = 0;
00383 
00384     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o1">GetCellRoutine</a> = <a class="code" href="../../d6/d0/hive_8h.html#a29">HvpGetCellPaged</a>;
00385     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00386     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00387     UseForIo = (BOOLEAN)!(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>);
00388 
00389     <span class="comment">//</span>
00390     <span class="comment">// new create case</span>
00391     <span class="comment">//</span>
00392     <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>) {
00393 
00394         BaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>), UseForIo));
00395         <span class="keywordflow">if</span> (BaseBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00396             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00397         }
00398         <span class="comment">//</span>
00399         <span class="comment">// Make sure the buffer we got back is cluster-aligned. If not, try</span>
00400         <span class="comment">// harder to get an aligned buffer.</span>
00401         <span class="comment">//</span>
00402         Alignment = Cluster * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> - 1;
00403         <span class="keywordflow">if</span> (((ULONG_PTR)BaseBlock &amp; Alignment) != 0) {
00404             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(BaseBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00405             BaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00406             <span class="keywordflow">if</span> (BaseBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00407                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00408             }
00409 
00410             <span class="comment">//</span>
00411             <span class="comment">// Return the quota for the extra allocation, as we are not really using</span>
00412             <span class="comment">// it and it will not be accounted for later when we free it.</span>
00413             <span class="comment">//</span>
00414             <a class="code" href="../../d1/d2/cmp_8h.html#a248">CmpReleaseGlobalQuota</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00415         }
00416 
00417         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>;
00418         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a> = 1;
00419         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a> = 1;
00420         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>.HighPart = 0;
00421         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>.LowPart = 0;
00422         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>;
00423         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>;
00424         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
00425         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a29">HBASE_FORMAT_MEMORY</a>;
00426         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00427         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> = 0;
00428         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o10">Cluster</a> = Cluster;
00429         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a> = 0;
00430         <a class="code" href="../../d5/d1/hiveinit_8c.html#a1">HvpFillFileName</a>(BaseBlock, <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>);
00431         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = BaseBlock;
00432         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>;
00433 
00434         <span class="keywordflow">return</span> STATUS_SUCCESS;
00435     }
00436 
00437     <span class="comment">//</span>
00438     <span class="comment">// flat image case</span>
00439     <span class="comment">//</span>
00440     <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a8">HINIT_FLAT</a>) {
00441         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)HiveData;
00442         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a>;
00443         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00444         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00445         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o1">GetCellRoutine</a> = <a class="code" href="../../d6/d0/hive_8h.html#a28">HvpGetCellFlat</a>;
00446         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>;
00447         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a> = 1;
00448         <span class="keywordflow">return</span> STATUS_SUCCESS;
00449     }
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">// readonly image case</span>
00453     <span class="comment">//</span>
00454     <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a7">HINIT_MEMORY_INPLACE</a>) {
00455         BaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)HiveData;
00456 
00457         <span class="keywordflow">if</span> ( (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>)   ||
00458              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>)           ||
00459              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>)                  ||
00460              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a> &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>)                   ||
00461              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a29">HBASE_FORMAT_MEMORY</a>)        ||
00462              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a> != BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>)    ||
00463              (<a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock) !=
00464               (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a>))
00465            )
00466         {
00467             <span class="keywordflow">return</span> STATUS_REGISTRY_CORRUPT;
00468         }
00469 
00470         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = BaseBlock;
00471         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a>;
00472         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00473         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a> = 1;
00474 
00475         <span class="keywordflow">if</span> (FileType == <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>) {
00476             <span class="comment">//</span>
00477             <span class="comment">// Mark the baseblock with Type==HFILE_TYPE_ALTERNATE.  This</span>
00478             <span class="comment">// case will never show up on disk, because we always flush</span>
00479             <span class="comment">// Type==HFILE_TYPE_PRIMARY to the alternate file.  Any</span>
00480             <span class="comment">// baseblock with Type==HFILE_TYPE_ALTERNATE indicates that</span>
00481             <span class="comment">// the primary is corrupt and must be rewritten.</span>
00482             <span class="comment">//</span>
00483             BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a>=<a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>;
00484 
00485             <span class="comment">//</span>
00486             <span class="comment">// baseblock has changed, recompute the checksum.</span>
00487             <span class="comment">//</span>
00488             BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a>=<a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock);
00489         }
00490 
00491         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/hivemap_8c.html#a9">HvpBuildMap</a>(
00492                             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00493                             (PUCHAR)HiveData + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>,
00494                             TailDisplay
00495                             )))
00496         {
00497             <span class="keywordflow">return</span> STATUS_REGISTRY_CORRUPT;
00498         }
00499 
00500         <span class="comment">// debug-only</span>
00501         <a class="code" href="../../d5/d1/hiveinit_8c.html#a0">HvpDumpFreeDisplay</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00502 
00503         <span class="keywordflow">return</span>(STATUS_SUCCESS);
00504     }
00505 
00506     <span class="comment">//</span>
00507     <span class="comment">// memory copy case</span>
00508     <span class="comment">//</span>
00509     <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>) {
00510         BaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)HiveData;
00511 
00512         <span class="keywordflow">if</span> ( (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>)   ||
00513              ((BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>)    &amp;&amp;
00514               (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>))       ||
00515              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a29">HBASE_FORMAT_MEMORY</a>)        ||
00516              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>)                  ||
00517              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a> &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>)                   ||
00518              (<a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock) !=
00519               (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a>))
00520            )
00521         {
00522             <span class="keywordflow">return</span> STATUS_REGISTRY_CORRUPT;
00523         }
00524 
00525         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>), UseForIo));
00526         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00527             <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00528         }
00529         <span class="comment">//</span>
00530         <span class="comment">// Make sure the buffer we got back is cluster-aligned. If not, try</span>
00531         <span class="comment">// harder to get an aligned buffer.</span>
00532         <span class="comment">//</span>
00533         Alignment = Cluster * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> - 1;
00534         <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> &amp; Alignment) != 0) {
00535             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00536             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00537             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00538                 <span class="keywordflow">return</span> (STATUS_INSUFFICIENT_RESOURCES);
00539             }
00540         }
00541         RtlCopyMemory(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, BaseBlock, <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>);
00542 
00543         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a>;
00544 
00545         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/hivemap_8c.html#a6">HvpBuildMapAndCopy</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00546                                             (PUCHAR)HiveData + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>,
00547                                             TailDisplay))) {
00548 
00549             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00550             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00551             <span class="keywordflow">return</span> STATUS_REGISTRY_CORRUPT;
00552         }
00553 
00554         <span class="keywordflow">if</span> (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>) {
00555             <span class="comment">//</span>
00556             <span class="comment">// Note that Type==HFILE_TYPE_ALTERNATE will NEVER occur in</span>
00557             <span class="comment">// an on-disk image.  The only way this can show up in the</span>
00558             <span class="comment">// baseblock is when the osloader rejects the SYSTEM hive and</span>
00559             <span class="comment">// successfully loads SYSTEM.ALT.  When this happens, it</span>
00560             <span class="comment">// forces HFILE_TYPE_ALTERNATE into the in-memory image of</span>
00561             <span class="comment">// the baseblock.</span>
00562             <span class="comment">//</span>
00563             <span class="comment">// We've booted from SYSTEM.ALT.  Mark the whole hive dirty</span>
00564             <span class="comment">// so everything gets flushed to SYSTEM as soon as we can</span>
00565             <span class="comment">// do I/O.</span>
00566             <span class="comment">//</span>
00567             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a28">RtlSetAllBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00568             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a>=<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap;
00569 
00570         }
00571         <a class="code" href="../../d5/d1/hiveinit_8c.html#a1">HvpFillFileName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>);
00572         
00573         <span class="comment">// debug - only</span>
00574         <a class="code" href="../../d5/d1/hiveinit_8c.html#a0">HvpDumpFreeDisplay</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00575        
00576         <span class="keywordflow">return</span>(STATUS_SUCCESS);
00577     }
00578 
00579     <span class="comment">//</span>
00580     <span class="comment">// file read case</span>
00581     <span class="comment">//</span>
00582     <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>) {
00583 
00584         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a25">CML_BIN</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a40">CMS_BIN_MAP</a>) {
00585             KdPrint((<span class="stringliteral">"HvInitializeHive(%wZ,HINIT_FILE) :\n"</span>, <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>));
00586         }
00587         <span class="comment">//</span>
00588         <span class="comment">// get the file image (possible recovered via log) into memory</span>
00589         <span class="comment">//</span>
00590         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/hiveload_8c.html#a19">HvLoadHive</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, TailDisplay);
00591         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) &amp;&amp; (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_REGISTRY_RECOVERED)) {
00592             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00593         }
00594 
00595         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a25">CML_BIN</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a40">CMS_BIN_MAP</a>) {
00596             KdPrint((<span class="stringliteral">"\n"</span>));
00597         }
00598         
00599         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_REGISTRY_RECOVERED) {
00600 
00601             <span class="comment">//</span>
00602             <span class="comment">// We have a good hive, with a log, and a dirty map,</span>
00603             <span class="comment">// all set up.  Only problem is that we need to flush</span>
00604             <span class="comment">// the file so the log can be cleared and new writes</span>
00605             <span class="comment">// posted against the hive.  Since we know we have</span>
00606             <span class="comment">// a good log in hand, we just write the hive image.</span>
00607             <span class="comment">//</span>
00608             <span class="keywordflow">if</span> ( ! <a class="code" href="../../d0/d2/hivesync_8c.html#a14">HvpDoWriteHive</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>)) {
00609                 <span class="comment">//</span>
00610                 <span class="comment">// DRAGOS: Here we need cleanup </span>
00611                 <span class="comment">// Clean up the bins already allocated </span>
00612                 <span class="comment">//</span>
00613                 <a class="code" href="../../d5/d1/hiveinit_8c.html#a2">HvpFreeAllocatedBins</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> );
00614 
00615                 <span class="keywordflow">return</span> STATUS_REGISTRY_IO_FAILED;
00616             }
00617 
00618             <span class="comment">//</span>
00619             <span class="comment">// If we get here, we have recovered the hive, and</span>
00620             <span class="comment">// written it out to disk correctly.  So we clear</span>
00621             <span class="comment">// the log here.</span>
00622             <span class="comment">//</span>
00623             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00624             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = 0;
00625             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>, 0);
00626             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> = 0;
00627         }
00628 
00629         <span class="comment">//</span>
00630         <span class="comment">// slam debug name data into base block</span>
00631         <span class="comment">//</span>
00632         <a class="code" href="../../d5/d1/hiveinit_8c.html#a1">HvpFillFileName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>);
00633 
00634         <span class="comment">// debug - only</span>
00635         <a class="code" href="../../d5/d1/hiveinit_8c.html#a0">HvpDumpFreeDisplay</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00636 
00637         <span class="keywordflow">return</span> STATUS_SUCCESS;
00638     }
00639 
00640     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00641 }
00642 
00643 
00644 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00645"></a><a class="code" href="../../d5/d1/hiveinit_8c.html#a1">00645</a> <a class="code" href="../../d5/d1/hiveinit_8c.html#a1">HvpFillFileName</a>(
00646     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>            BaseBlock,
00647     PUNICODE_STRING         FileName
00648     )
00649 <span class="comment">/*++</span>
00650 <span class="comment"></span>
00651 <span class="comment">Routine Description:</span>
00652 <span class="comment"></span>
00653 <span class="comment">    Zero out the filename portion of the base block.</span>
00654 <span class="comment">    If FileName is not NULL, copy last 64 bytes into name tail</span>
00655 <span class="comment">        field of base block</span>
00656 <span class="comment"></span>
00657 <span class="comment">Arguments:</span>
00658 <span class="comment"></span>
00659 <span class="comment">    BaseBlock - supplies pointer to a base block</span>
00660 <span class="comment"></span>
00661 <span class="comment">    FileName - supplies pointer to a unicode STRING</span>
00662 <span class="comment"></span>
00663 <span class="comment">Return Value:</span>
00664 <span class="comment"></span>
00665 <span class="comment">    None.</span>
00666 <span class="comment"></span>
00667 <span class="comment">--*/</span>
00668 {
00669     ULONG   offset;
00670     ULONG   length;
00671     PUCHAR  sptr;
00672 
00673 <span class="preprocessor">#if 0</span>
00674 <span class="preprocessor"></span>    KdPrint((<span class="stringliteral">"HvpFillFileName: %wZ\n"</span>, <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>));
00675 <span class="preprocessor">#endif</span>
00676 <span class="preprocessor"></span>
00677     RtlZeroMemory((PVOID)&amp;(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o11">FileName</a>[0]), <a class="code" href="../../d0/d1/hivedata_8h.html#a30">HBASE_NAME_ALLOC</a>);
00678 
00679     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00680         <span class="keywordflow">return</span>;
00681     }
00682 
00683     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length &lt;= <a class="code" href="../../d0/d1/hivedata_8h.html#a30">HBASE_NAME_ALLOC</a>) {
00684         offset = 0;
00685         length = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length;
00686     } <span class="keywordflow">else</span> {
00687         offset = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length - <a class="code" href="../../d0/d1/hivedata_8h.html#a30">HBASE_NAME_ALLOC</a>;
00688         length = <a class="code" href="../../d0/d1/hivedata_8h.html#a30">HBASE_NAME_ALLOC</a>;
00689     }
00690 
00691     sptr = (PUCHAR)&amp;(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[0]);
00692     RtlMoveMemory(
00693         (PVOID)&amp;(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o11">FileName</a>[0]),
00694         (PVOID)&amp;(sptr[offset]),
00695         length
00696         );
00697 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:17 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
