<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mminit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mminit.c</h1><a href="../../d5/d1/mminit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    mminit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the initialization for the memory management</span>
00012 <span class="comment">    system.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 20-Mar-1989</span>
00017 <span class="comment">    Landy Wang (landyw) 02-Jun-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00024 
<a name="l00025"></a><a class="code" href="../../d5/d1/mminit_8c.html#a5">00025</a> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d5/d1/mminit_8c.html#a5">MmSharedUserDataPte</a>;
00026 
<a name="l00027"></a><a class="code" href="../../d5/d1/mminit_8c.html#a6">00027</a> <span class="keyword">extern</span> <a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html">MMINPAGE_SUPPORT_LIST</a> <a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>;
<a name="l00028"></a><a class="code" href="../../d5/d1/mminit_8c.html#a7">00028</a> <span class="keyword">extern</span> <a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html">MMEVENT_COUNT_LIST</a> <a class="code" href="../../d5/d1/mminit_8c.html#a7">MmEventCountList</a>;
<a name="l00029"></a><a class="code" href="../../d5/d1/mminit_8c.html#a8">00029</a> <span class="keyword">extern</span> <a class="code" href="../../d3/d7/struct__KMUTANT.html">KMUTANT</a> <a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>;
<a name="l00030"></a><a class="code" href="../../d5/d1/mminit_8c.html#a9">00030</a> <span class="keyword">extern</span> ULONG_PTR <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a771">MaximumPtePoolTypes</a>];
<a name="l00031"></a><a class="code" href="../../d5/d1/mminit_8c.html#a10">00031</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d1/d6/allocpag_8c.html#a26">MiSpecialPoolPtes</a>;
<a name="l00032"></a><a class="code" href="../../d5/d1/mminit_8c.html#a11">00032</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d5/kddata_8c.html#a34">MmPagedPoolCommit</a>;
00033 
<a name="l00034"></a><a class="code" href="../../d5/d1/mminit_8c.html#a12">00034</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d5/d1/mminit_8c.html#a12">BBTBuffer</a>;
<a name="l00035"></a><a class="code" href="../../d5/d1/mminit_8c.html#a13">00035</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d5/d1/mminit_8c.html#a13">BBTPagesToReserve</a>;
00036 
<a name="l00037"></a><a class="code" href="../../d5/d1/mminit_8c.html#a14">00037</a> ULONG_PTR <a class="code" href="../../d8/d5/kddata_8c.html#a16">MmSubsectionBase</a>;
<a name="l00038"></a><a class="code" href="../../d5/d1/mminit_8c.html#a15">00038</a> ULONG_PTR <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a>;
<a name="l00039"></a><a class="code" href="../../d5/d1/mminit_8c.html#a16">00039</a> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a682">MmDataClusterSize</a>;
<a name="l00040"></a><a class="code" href="../../d5/d1/mminit_8c.html#a17">00040</a> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a683">MmCodeClusterSize</a>;
<a name="l00041"></a><a class="code" href="../../d5/d1/mminit_8c.html#a18">00041</a> PFN_NUMBER <a class="code" href="../../d5/d1/mminit_8c.html#a18">MmResidentAvailableAtInit</a>;
<a name="l00042"></a><a class="code" href="../../d5/d1/mminit_8c.html#a19">00042</a> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d8/mi_8h.html#a681">MmImageMappingPteEvent</a>;
<a name="l00043"></a><a class="code" href="../../d5/d1/mminit_8c.html#a20">00043</a> <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>;
<a name="l00044"></a><a class="code" href="../../d5/d1/mminit_8c.html#a21">00044</a> LIST_ENTRY <a class="code" href="../../d4/d8/mi_8h.html#a433">MmLockConflictList</a>;
<a name="l00045"></a><a class="code" href="../../d5/d1/mminit_8c.html#a22">00045</a> LOGICAL <a class="code" href="../../d1/d6/allocpag_8c.html#a10">MmPagedPoolMaximumDesired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00046 
<a name="l00047"></a><a class="code" href="../../d5/d1/mminit_8c.html#a23">00047</a> <a class="code" href="../../d2/d1/mm_8h.html#a77">PERFINFO_MMINIT_DECL</a>;
00048 
00049 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00050 <a class="code" href="../../d5/d1/mminit_8c.html#a43">MiMapBBTMemory</a> (
00051     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00052     );
00053 
00054 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00055 <a class="code" href="../../d5/d1/mminit_8c.html#a44">MiInitializeSpecialPool</a>(
00056     VOID
00057     );
00058 
00059 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00060 <a class="code" href="../../d5/d1/mminit_8c.html#a45">MiEnablePagingTheExecutive</a>(
00061     VOID
00062     );
00063 
00064 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00065 <a class="code" href="../../d5/d1/mminit_8c.html#a46">MiEnablePagingOfDriverAtInit</a> (
00066     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
00067     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte
00068     );
00069 
00070 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00071 <a class="code" href="../../d5/d1/mminit_8c.html#a47">MiBuildPagedPool</a> (
00072     );
00073 
00074 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00075 <a class="code" href="../../d5/d1/mminit_8c.html#a48">MiMergeMemoryLimit</a> (
00076     IN OUT <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> Memory,
00077     IN PFN_NUMBER StartPage,
00078     IN PFN_NUMBER NumberOfPages
00079     );
00080 
00081 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00082 <a class="code" href="../../d8/d8/sysload_8c.html#a47">MiWriteProtectSystemImage</a> (
00083     IN PVOID DllBase
00084     );
00085 
00086 <span class="preprocessor">#ifndef NO_POOL_CHECKS</span>
00087 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00088 <a class="code" href="../../d5/d1/mminit_8c.html#a50">MiInitializeSpecialPoolCriteria</a> (
00089     IN VOID
00090     );
00091 <span class="preprocessor">#endif</span>
00092 <span class="preprocessor"></span>
00093 <span class="preprocessor">#if defined (_X86PAE_)</span>
00094 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00095 MiCheckPaeLicense (
00096     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock,
00097     IN PBOOLEAN IncludeType,
00098     OUT <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> Memory
00099     );
00100 <span class="preprocessor">#endif</span>
00101 <span class="preprocessor"></span>
00102 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00103 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MmInitSystem)</span>
00104 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiMapBBTMemory)</span>
00105 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MmInitializeMemoryLimits)</span>
00106 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiMergeMemoryLimit)</span>
00107 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MmFreeLoaderBlock)</span>
00108 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiBuildPagedPool)</span>
00109 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiFindInitializationCode)</span>
00110 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiEnablePagingTheExecutive)</span>
00111 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiEnablePagingOfDriverAtInit)</span>
00112 <span class="preprocessor"></span><span class="preprocessor">#if defined (_X86PAE_)</span>
00113 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiCheckPaeLicense)</span>
00114 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00115 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MiFreeInitializationCode)</span>
00116 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00117 <span class="preprocessor"></span>
<a name="l00118"></a><a class="code" href="../../d5/d1/mminit_8c.html#a0">00118</a> <span class="preprocessor">#define MM_MAX_LOADER_BLOCKS 30</span>
00119 <span class="preprocessor"></span>
00120 <span class="comment">//</span>
00121 <span class="comment">// Default is a 300 second life span for modified mapped pages -</span>
00122 <span class="comment">// This can be overridden in the registry.</span>
00123 <span class="comment">//</span>
00124 
<a name="l00125"></a><a class="code" href="../../d5/d1/mminit_8c.html#a24">00125</a> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a27">MmModifiedPageLifeInSeconds</a> = 300;
00126 
<a name="l00127"></a><a class="code" href="../../d5/d1/mminit_8c.html#a25">00127</a> LARGE_INTEGER <a class="code" href="../../d4/d8/mi_8h.html#a734">MiModifiedPageLife</a>;
00128 
<a name="l00129"></a><a class="code" href="../../d5/d1/mminit_8c.html#a26">00129</a> BOOLEAN <a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00130 
<a name="l00131"></a><a class="code" href="../../d5/d1/mminit_8c.html#a27">00131</a> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d8/mi_8h.html#a736">MiMappedPagesTooOldEvent</a>;
00132 
<a name="l00133"></a><a class="code" href="../../d5/d1/mminit_8c.html#a28">00133</a> <a class="code" href="../../d1/d6/struct__KDPC.html">KDPC</a> <a class="code" href="../../d4/d8/mi_8h.html#a737">MiModifiedPageWriterTimerDpc</a>;
00134 
<a name="l00135"></a><a class="code" href="../../d5/d1/mminit_8c.html#a29">00135</a> <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a> <a class="code" href="../../d4/d8/mi_8h.html#a738">MiModifiedPageWriterTimer</a>;
00136 
00137 <span class="comment">//</span>
00138 <span class="comment">// The following constants are based on the number PAGES not the</span>
00139 <span class="comment">// memory size.  For convenience the number of pages is calculated</span>
00140 <span class="comment">// based on a 4k page size.  Hence 12mb with 4k page is 3072.</span>
00141 <span class="comment">//</span>
00142 
<a name="l00143"></a><a class="code" href="../../d5/d1/mminit_8c.html#a1">00143</a> <span class="preprocessor">#define MM_SMALL_SYSTEM ((13*1024*1024) / 4096)</span>
00144 <span class="preprocessor"></span>
<a name="l00145"></a><a class="code" href="../../d5/d1/mminit_8c.html#a2">00145</a> <span class="preprocessor">#define MM_MEDIUM_SYSTEM ((19*1024*1024) / 4096)</span>
00146 <span class="preprocessor"></span>
<a name="l00147"></a><a class="code" href="../../d5/d1/mminit_8c.html#a3">00147</a> <span class="preprocessor">#define MM_MIN_INITIAL_PAGED_POOL ((32*1024*1024) &gt;&gt; PAGE_SHIFT)</span>
00148 <span class="preprocessor"></span>
<a name="l00149"></a><a class="code" href="../../d5/d1/mminit_8c.html#a4">00149</a> <span class="preprocessor">#define MM_DEFAULT_IO_LOCK_LIMIT (2 * 1024 * 1024)</span>
00150 <span class="preprocessor"></span>
<a name="l00151"></a><a class="code" href="../../d5/d1/mminit_8c.html#a30">00151</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a>;
00152 
<a name="l00153"></a><a class="code" href="../../d5/d1/mminit_8c.html#a31">00153</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a30">MmEnforceWriteProtection</a>;
00154 
<a name="l00155"></a><a class="code" href="../../d5/d1/mminit_8c.html#a32">00155</a> <span class="keyword">extern</span> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d5/d1/mminit_8c.html#a32">MiPteStr</a>[];
00156 
<a name="l00157"></a><a class="code" href="../../d5/d1/mminit_8c.html#a33">00157</a> <span class="keyword">extern</span> LONG <a class="code" href="../../d5/d1/mminit_8c.html#a33">MiTrimInProgressCount</a>;
00158 
00159 <span class="preprocessor">#if !defined (_WIN64)</span>
00160 <span class="preprocessor"></span>
00161 <span class="preprocessor">#if !defined (_X86PAE_)</span>
<a name="l00162"></a><a class="code" href="../../d5/d1/mminit_8c.html#a34">00162</a> <span class="preprocessor"></span>PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a637">MmSystemPageDirectory</a>;
00163 <span class="preprocessor">#else</span>
00164 <span class="preprocessor"></span>PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a637">MmSystemPageDirectory</a>[PD_PER_SYSTEM];
00165 <span class="preprocessor">#endif</span>
00166 <span class="preprocessor"></span>
<a name="l00167"></a><a class="code" href="../../d5/d1/mminit_8c.html#a35">00167</a> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d4/d8/mi_8h.html#a636">MmSystemPagePtes</a>;
00168 <span class="preprocessor">#endif</span>
00169 <span class="preprocessor"></span>
<a name="l00170"></a><a class="code" href="../../d5/d1/mminit_8c.html#a36">00170</a> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a13">MmTotalSystemCodePages</a>;
00171 
<a name="l00172"></a><a class="code" href="../../d5/d1/mminit_8c.html#a37">00172</a> <a class="code" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a> <a class="code" href="../../d5/d1/mminit_8c.html#a37">MmSystemSize</a>;
00173 
<a name="l00174"></a><a class="code" href="../../d5/d1/mminit_8c.html#a38">00174</a> ULONG <a class="code" href="../../d5/d8/fssup_8c.html#a4">MmLargeSystemCache</a>;
00175 
<a name="l00176"></a><a class="code" href="../../d5/d1/mminit_8c.html#a39">00176</a> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a>;
00177 
<a name="l00178"></a><a class="code" href="../../d5/d1/mminit_8c.html#a40">00178</a> LIST_ENTRY <a class="code" href="../../d6/d8/sysinfo_8c.html#a20">MmLoadedUserImageList</a>;
<a name="l00179"></a><a class="code" href="../../d5/d1/mminit_8c.html#a41">00179</a> <a class="code" href="../../d2/d1/mm_8h.html#a163">PPAGE_FAULT_NOTIFY_ROUTINE</a> <a class="code" href="../../d4/d8/mi_8h.html#a746">MmPageFaultNotifyRoutine</a>;
<a name="l00180"></a><a class="code" href="../../d5/d1/mminit_8c.html#a42">00180</a> <a class="code" href="../../d2/d1/mm_8h.html#a164">PHARD_FAULT_NOTIFY_ROUTINE</a> <a class="code" href="../../d4/d8/mi_8h.html#a747">MmHardFaultNotifyRoutine</a>;
00181 
00182 
00183 BOOLEAN
<a name="l00184"></a><a class="code" href="../../d5/d1/mminit_8c.html#a51">00184</a> <a class="code" href="../../d5/d1/mminit_8c.html#a51">MmInitSystem</a> (
00185     IN ULONG Phase,
00186     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock,
00187     IN <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> PhysicalMemoryBlock
00188     )
00189 
00190 <span class="comment">/*++</span>
00191 <span class="comment"></span>
00192 <span class="comment">Routine Description:</span>
00193 <span class="comment"></span>
00194 <span class="comment">    This function is called during Phase 0, phase 1 and at the end</span>
00195 <span class="comment">    of phase 1 ("phase 2") initialization.</span>
00196 <span class="comment"></span>
00197 <span class="comment">    Phase 0 initializes the memory management paging functions,</span>
00198 <span class="comment">    nonpaged and paged pool, the PFN database, etc.</span>
00199 <span class="comment"></span>
00200 <span class="comment">    Phase 1 initializes the section objects, the physical memory</span>
00201 <span class="comment">    object, and starts the memory management system threads.</span>
00202 <span class="comment"></span>
00203 <span class="comment">    Phase 2 frees memory used by the OsLoader.</span>
00204 <span class="comment"></span>
00205 <span class="comment">Arguments:</span>
00206 <span class="comment"></span>
00207 <span class="comment">    Phase - System initialization phase.</span>
00208 <span class="comment"></span>
00209 <span class="comment">    LoaderBlock - Supplies a pointer to the system loader block.</span>
00210 <span class="comment"></span>
00211 <span class="comment">Return Value:</span>
00212 <span class="comment"></span>
00213 <span class="comment">    Returns TRUE if the initialization was successful.</span>
00214 <span class="comment"></span>
00215 <span class="comment">Environment:</span>
00216 <span class="comment"></span>
00217 <span class="comment">    Kernel Mode Only.  System initialization.</span>
00218 <span class="comment"></span>
00219 <span class="comment">--*/</span>
00220 
00221 {
00222     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
00223     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00224     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00225     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00226     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde;
00227     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPpe;
00228     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte;
00229     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
00230     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00231     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> Pointer;
00232     PFN_NUMBER i, j;
00233     PFN_NUMBER PageFrameIndex;
00234     PFN_NUMBER DirectoryFrameIndex;
00235     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00236     KIRQL OldIrql;
00237     LOGICAL First;
00238     PLIST_ENTRY NextEntry;
00239     PLDR_DATA_TABLE_ENTRY DataTableEntry;
00240     ULONG MaximumSystemCacheSize;
00241     ULONG MaximumSystemCacheSizeTotal;
00242     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00243     PIMAGE_NT_HEADERS NtHeaders;
00244     ULONG_PTR SystemPteMultiplier;
00245 
00246     BOOLEAN IncludeType[<a class="code" href="../../d1/d9/arc_8h.html#a320a278">LoaderMaximum</a>];
00247     ULONG MemoryAlloc[(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a>) +
00248             <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a>)*<a class="code" href="../../d2/d1/mm_8h.html#a0">MAX_PHYSICAL_MEMORY_FRAGMENTS</a>) /
00249               <span class="keyword">sizeof</span>(ULONG)];
00250 
00251     <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> Memory;
00252 
00253     <span class="comment">//</span>
00254     <span class="comment">// Make sure structure alignment is okay.</span>
00255     <span class="comment">//</span>
00256 
00257     <span class="keywordflow">if</span> (Phase == 0) {
00258         <a class="code" href="../../d2/d1/mm_8h.html#a151">MmThrottleTop</a> = 450;
00259         <a class="code" href="../../d2/d1/mm_8h.html#a152">MmThrottleBottom</a> = 127;
00260 
00261         <span class="comment">//</span>
00262         <span class="comment">// Set the highest user address, the system range start address, the</span>
00263         <span class="comment">// user probe address, and the virtual bias.</span>
00264         <span class="comment">//</span>
00265 
00266 <span class="preprocessor">#if defined(_AXP64_) || defined(_IA64_)</span>
00267 <span class="preprocessor"></span>
00268         <a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a> = MM_HIGHEST_USER_ADDRESS;
00269         <a class="code" href="../../d0/d9/miglobal_8c.html#a2">MmUserProbeAddress</a> = MM_USER_PROBE_ADDRESS;
00270         <a class="code" href="../../d0/d9/miglobal_8c.html#a1">MmSystemRangeStart</a> = MM_SYSTEM_RANGE_START;
00271 
00272 <span class="preprocessor">#else</span>
00273 <span class="preprocessor"></span>
00274         <a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a> = (PVOID)(<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> - 0x10000 - 1);
00275         <a class="code" href="../../d0/d9/miglobal_8c.html#a2">MmUserProbeAddress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> - 0x10000;
00276         <a class="code" href="../../d0/d9/miglobal_8c.html#a1">MmSystemRangeStart</a> = (PVOID)<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a>;
00277 
00278 <span class="preprocessor">#endif</span>
00279 <span class="preprocessor"></span>
00280         <a class="code" href="../../d4/d8/mi_8h.html#a755">MiHighestUserPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a>);
00281         <a class="code" href="../../d4/d8/mi_8h.html#a756">MiHighestUserPde</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a>);
00282 
00283         <a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> = 0;
00284 
00285         <span class="comment">//</span>
00286         <span class="comment">// Set the highest section base address.</span>
00287         <span class="comment">//</span>
00288         <span class="comment">// N.B. In 32-bit systems this address must be 2gb or less even for</span>
00289         <span class="comment">//      systems that run with 3gb enabled. Otherwise, it would not</span>
00290         <span class="comment">//      be possible to map based sections identically in all processes.</span>
00291         <span class="comment">//</span>
00292 
00293         <a class="code" href="../../d4/d8/mi_8h.html#a676">MmHighSectionBase</a> = ((PCHAR)<a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a> - 0x800000);
00294 
00295         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a325">ExVerifySuite</a>(TerminalServer) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00296             <a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00297             <a class="code" href="../../d4/d8/mi_8h.html#a656">MiSystemViewStart</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a19">MM_SYSTEM_VIEW_START_IF_HYDRA</a>;
00298             <a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a> = (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a14">MM_SESSION_SPACE_DEFAULT</a>;
00299 
00300         } <span class="keywordflow">else</span> {
00301             <a class="code" href="../../d4/d8/mi_8h.html#a656">MiSystemViewStart</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a17">MM_SYSTEM_VIEW_START</a>;
00302             <a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00303         }
00304 
00305         MaximumSystemCacheSize = (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a13">MM_SYSTEM_CACHE_END</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a12">MM_SYSTEM_CACHE_START</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00306 
00307         <span class="comment">//</span>
00308         <span class="comment">// If the system has been biased to an alternate base address to</span>
00309         <span class="comment">// allow 3gb of user address space, then set the user probe address</span>
00310         <span class="comment">// and the maximum system cache size.</span>
00311         <span class="comment">//</span>
00312 
00313 <span class="preprocessor">#if defined(_X86_)</span>
00314 <span class="preprocessor"></span>
00315         <a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> = LoaderBlock-&gt;u.I386.VirtualBias;
00316 
00317         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> != 0) {
00318             <a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a> = ((PCHAR)<a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a> + 0x40000000);
00319             <a class="code" href="../../d0/d9/miglobal_8c.html#a1">MmSystemRangeStart</a> = ((PCHAR)<a class="code" href="../../d0/d9/miglobal_8c.html#a1">MmSystemRangeStart</a> + 0x40000000);
00320             <a class="code" href="../../d0/d9/miglobal_8c.html#a2">MmUserProbeAddress</a> += 0x40000000;
00321             <a class="code" href="../../d2/d2/data386_8c.html#a20">MiMaximumWorkingSet</a> += 0x40000000 &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00322 
00323             <a class="code" href="../../d4/d8/mi_8h.html#a755">MiHighestUserPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a>);
00324             <a class="code" href="../../d4/d8/mi_8h.html#a756">MiHighestUserPde</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a>);
00325 
00326             MaximumSystemCacheSize -= <a class="code" href="../../d6/d8/mi386_8h.html#a4">MM_BOOT_IMAGE_SIZE</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00327 
00328             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00329 
00330                 <span class="comment">//</span>
00331                 <span class="comment">// Moving to 3GB means moving session space to just above</span>
00332                 <span class="comment">// the system cache (and lowering the system cache max size</span>
00333                 <span class="comment">// accordingly).</span>
00334                 <span class="comment">//</span>
00335 
00336                 MaximumSystemCacheSize -= (<a class="code" href="../../d4/d8/mi_8h.html#a339">MI_SESSION_SPACE_TOTAL_SIZE</a> + <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a20">MM_SYSTEM_VIEW_SIZE_IF_HYDRA</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00337 
00338                 <a class="code" href="../../d4/d8/mi_8h.html#a656">MiSystemViewStart</a> = (ULONG_PTR)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a12">MM_SYSTEM_CACHE_START</a> +
00339                                       (MaximumSystemCacheSize &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
00340 
00341                 <a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a> = <a class="code" href="../../d4/d8/mi_8h.html#a656">MiSystemViewStart</a> + <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a20">MM_SYSTEM_VIEW_SIZE_IF_HYDRA</a> + <a class="code" href="../../d6/d8/mi386_8h.html#a4">MM_BOOT_IMAGE_SIZE</a>;
00342 
00343             } <span class="keywordflow">else</span> {
00344                 MaximumSystemCacheSize -= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a18">MM_SYSTEM_VIEW_SIZE</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00345                 <a class="code" href="../../d4/d8/mi_8h.html#a656">MiSystemViewStart</a> = (ULONG_PTR)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a12">MM_SYSTEM_CACHE_START</a> +
00346                                       (MaximumSystemCacheSize &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) +
00347                                       <a class="code" href="../../d6/d8/mi386_8h.html#a4">MM_BOOT_IMAGE_SIZE</a>);
00348             }
00349         }
00350 
00351 <span class="preprocessor">#else</span>
00352 <span class="preprocessor"></span>
00353         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00354             MaximumSystemCacheSize -= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a20">MM_SYSTEM_VIEW_SIZE_IF_HYDRA</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00355             <a class="code" href="../../d4/d8/mi_8h.html#a656">MiSystemViewStart</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a19">MM_SYSTEM_VIEW_START_IF_HYDRA</a>;
00356         }
00357 
00358 <span class="preprocessor">#endif</span>
00359 <span class="preprocessor"></span>
00360         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00361             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a> = (<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a>)((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a> + <a class="code" href="../../d4/d8/mi_8h.html#a335">MI_SESSION_IMAGE_SIZE</a>);
00362 
00363             <a class="code" href="../../d4/d8/mi_8h.html#a757">MiSessionBasePte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>);
00364             <a class="code" href="../../d4/d8/mi_8h.html#a758">MiSessionLastPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a351">MI_SESSION_SPACE_END</a>);
00365         }
00366 
00367         <span class="comment">//</span>
00368         <span class="comment">// A few sanity checks to ensure things are as they should be.</span>
00369         <span class="comment">//</span>
00370 
00371 <span class="preprocessor">#if DBG</span>
00372 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/struct__MMWSL.html">MMWSL</a>) % 8) != 0) {
00373             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"working set list is not a quadword sized structure\n"</span>);
00374         }
00375 
00376         <span class="keywordflow">if</span> ((<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">CONTROL_AREA</a>) % 8) != 0) {
00377             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"control area list is not a quadword sized structure\n"</span>);
00378         }
00379 
00380         <span class="keywordflow">if</span> ((<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>) % 8) != 0) {
00381             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"subsection list is not a quadword sized structure\n"</span>);
00382         }
00383 
00384         <span class="comment">//</span>
00385         <span class="comment">// Some checks to make sure prototype PTEs can be placed in</span>
00386         <span class="comment">// either paged or nonpaged (prototype PTEs for paged pool are here)</span>
00387         <span class="comment">// can be put into pte format.</span>
00388         <span class="comment">//</span>
00389 
00390         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>;
00391         Pointer.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (PointerPte);
00392         TempPte = Pointer;
00393         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a>(&amp;TempPte);
00394         <span class="keywordflow">if</span> (PointerPte != PointerPde) {
00395             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"unable to map start of paged pool as prototype pte %p %p\n"</span>,
00396                      PointerPde,
00397                      PointerPte);
00398         }
00399 
00400         PointerPte =
00401                 (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a23">MM_NONPAGED_POOL_END</a> &amp; ~((1 &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>) - 1));
00402 
00403         Pointer.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (PointerPte);
00404         TempPte = Pointer;
00405         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a>(&amp;TempPte);
00406         <span class="keywordflow">if</span> (PointerPte != PointerPde) {
00407             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"unable to map end of nonpaged pool as prototype pte %p %p\n"</span>,
00408                      PointerPde,
00409                      PointerPte);
00410         }
00411 
00412         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(((ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a24">NON_PAGED_SYSTEM_END</a> -
00413                         0x37000 + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
00414 
00415         <span class="keywordflow">for</span> (j = 0; j &lt; 20; j++) {
00416             Pointer.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (PointerPte);
00417             TempPte = Pointer;
00418             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a>(&amp;TempPte);
00419             <span class="keywordflow">if</span> (PointerPte != PointerPde) {
00420                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"unable to map end of nonpaged pool as prototype pte %p %p\n"</span>,
00421                          PointerPde,
00422                          PointerPte);
00423             }
00424 
00425             PointerPte++;
00426         }
00427 
00428         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(((ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a23">MM_NONPAGED_POOL_END</a> - 0x133448) &amp; ~(ULONG_PTR)7);
00429         Pointer.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a149">MiGetSubsectionAddressForPte</a> (PointerPte);
00430         TempPte = Pointer;
00431         PointerPde = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a>(&amp;TempPte);
00432         <span class="keywordflow">if</span> (PointerPte != PointerPde) {
00433             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"unable to map end of nonpaged pool as section pte %p %p\n"</span>,
00434                      PointerPde,
00435                      PointerPte);
00436 
00437             <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(&amp;TempPte);
00438         }
00439 
00440         <span class="comment">//</span>
00441         <span class="comment">// End of sanity checks.</span>
00442         <span class="comment">//</span>
00443 
00444 <span class="preprocessor">#endif //dbg</span>
00445 <span class="preprocessor"></span>
00446         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a30">MmEnforceWriteProtection</a>) {
00447             <a class="code" href="../../d5/d1/mminit_8c.html#a32">MiPteStr</a>[0] = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)1;
00448         }
00449     
00450         InitializeListHead( &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a20">MmLoadedUserImageList</a> );
00451         InitializeListHead( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a433">MmLockConflictList</a> );
00452 
00453         <a class="code" href="../../d4/d8/mi_8h.html#a423">MmCriticalSectionTimeout</a>.QuadPart = Int32x32To64(
00454                                                  <a class="code" href="../../d8/d0/cmdat3_8c.html#a45">MmCritsectTimeoutSeconds</a>,
00455                                                 -10000000);
00456 
00457 
00458         <span class="comment">//</span>
00459         <span class="comment">// Initialize PFN database mutex and System Address Space creation</span>
00460         <span class="comment">// mutex.</span>
00461         <span class="comment">//</span>
00462 
00463         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
00464         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a678">MmSectionBasedMutex</a>);
00465         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a> (&amp;<a class="code" href="../../d9/d3/dynmem_8c.html#a1">MmDynamicMemoryMutex</a>);
00466 
00467         <a class="code" href="../../d3/d5/mutntobj_8c.html#a1">KeInitializeMutant</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00468 
00469         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a609">MmAvailablePagesEvent</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00470         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a610">MmAvailablePagesEventHigh</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00471         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a614">MmMappedFileIoComplete</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00472         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a681">MmImageMappingPteEvent</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00473         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a611">MmZeroingPageEvent</a>, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00474         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a720">MmCollidedFlushEvent</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00475         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d5/d6/iosup_8c.html#a18">MmCollidedLockEvent</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00476         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a736">MiMappedPagesTooOldEvent</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00477 
00478         <a class="code" href="../../d4/d1/dpcobj_8c.html#a1">KeInitializeDpc</a>( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a737">MiModifiedPageWriterTimerDpc</a>, <a class="code" href="../../d4/d8/mi_8h.html#a951">MiModifiedPageWriterTimerDispatch</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00479         <a class="code" href="../../d3/d2/timerobj_8c.html#a2">KeInitializeTimerEx</a>( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a738">MiModifiedPageWriterTimer</a>, SynchronizationTimer );
00480 
00481         <a class="code" href="../../d4/d8/mi_8h.html#a734">MiModifiedPageLife</a>.QuadPart = Int32x32To64(
00482                                                  <a class="code" href="../../d8/d0/cmdat3_8c.html#a27">MmModifiedPageLifeInSeconds</a>,
00483                                                 -10000000);
00484 
00485         InitializeListHead (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>);
00486         InitializeListHead (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>.<a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o0">ListHead</a>);
00487         InitializeListHead (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a7">MmEventCountList</a>.<a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html#o0">ListHead</a>);
00488 
00489         <a class="code" href="../../d4/d8/mi_8h.html#a612">MmZeroingPageThreadActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00490 
00491         <span class="comment">//</span>
00492         <span class="comment">// Compute physical memory blocks yet again</span>
00493         <span class="comment">//</span>
00494 
00495         Memory = (<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a>)&amp;MemoryAlloc;
00496         Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> = <a class="code" href="../../d2/d1/mm_8h.html#a0">MAX_PHYSICAL_MEMORY_FRAGMENTS</a>;
00497 
00498         <span class="comment">// include all memory types ...</span>
00499         <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="../../d1/d9/arc_8h.html#a320a278">LoaderMaximum</a>; i++) {
00500             IncludeType[i] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00501         }
00502 
00503         <span class="comment">// ... expect these..</span>
00504         IncludeType[<a class="code" href="../../d1/d9/arc_8h.html#a320a257">LoaderBad</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00505         IncludeType[<a class="code" href="../../d1/d9/arc_8h.html#a320a260">LoaderFirmwarePermanent</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00506         IncludeType[<a class="code" href="../../d1/d9/arc_8h.html#a320a276">LoaderSpecialMemory</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00507         IncludeType[<a class="code" href="../../d1/d9/arc_8h.html#a320a277">LoaderBBTMemory</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00508 
00509         <a class="code" href="../../d5/d1/mminit_8c.html#a52">MmInitializeMemoryLimits</a>(LoaderBlock, IncludeType, Memory);
00510 
00511 <span class="preprocessor">#if defined (_X86PAE_)</span>
00512 <span class="preprocessor"></span>        MiCheckPaeLicense (LoaderBlock, IncludeType, Memory);
00513 <span class="preprocessor">#endif</span>
00514 <span class="preprocessor"></span>
00515 <span class="preprocessor">#if defined (_X86PAE_) || defined (_WIN64)</span>
00516 <span class="preprocessor"></span>        <a class="code" href="../../d2/d1/mm_8h.html#a132">Mm64BitPhysicalAddress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00517 <span class="preprocessor">#endif</span>
00518 <span class="preprocessor"></span>
00519         <span class="comment">//</span>
00520         <span class="comment">// Add all memory runs in PhysicalMemoryBlock to Memory</span>
00521         <span class="comment">//</span>
00522 
00523         <span class="keywordflow">for</span> (i = 0; i &lt; PhysicalMemoryBlock-&gt;NumberOfRuns; i += 1) {
00524             <a class="code" href="../../d5/d1/mminit_8c.html#a48">MiMergeMemoryLimit</a> (Memory,
00525                                 PhysicalMemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>,
00526                                 PhysicalMemoryBlock-&gt;Run[i].PageCount
00527                                 );
00528         }
00529 
00530         <span class="comment">//</span>
00531         <span class="comment">// Sort and merge adjacent runs.</span>
00532         <span class="comment">//</span>
00533 
00534         <span class="keywordflow">for</span> (i=0; i &lt; Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>; i++) {
00535             <span class="keywordflow">for</span> (j=i+1; j &lt; Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>; j++) {
00536                 <span class="keywordflow">if</span> (Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[j].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> &lt; Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>) {
00537                     <span class="comment">// swap runs</span>
00538                     PhysicalMemoryBlock-&gt;Run[0] = Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[j];
00539                     Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[j] = Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i];
00540                     Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i] = PhysicalMemoryBlock-&gt;Run[0];
00541                 }
00542 
00543                 <span class="keywordflow">if</span> (Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> + Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> ==
00544                     Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[j].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>) {
00545                     <span class="comment">// merge runs</span>
00546                     Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> -= 1;
00547                     Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> += Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[j].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
00548                     Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[j] = Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>];
00549                     i -= 1;
00550                     <span class="keywordflow">break</span>;
00551                 }
00552             }
00553         }
00554 
00555         <span class="comment">//</span>
00556         <span class="comment">// When safebooting, don't enable special pool, the verifier or any</span>
00557         <span class="comment">// other options that track corruption regardless of registry settings.</span>
00558         <span class="comment">//</span>
00559     
00560         <span class="keywordflow">if</span> (strstr(LoaderBlock-&gt;LoadOptions, SAFEBOOT_LOAD_OPTION_A)) {
00561             <a class="code" href="../../d8/d0/cmdat3_8c.html#a10">MmVerifyDriverBufferLength</a> = (ULONG)-1;
00562             <a class="code" href="../../d8/d0/cmdat3_8c.html#a13">MmDontVerifyRandomDrivers</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00563             <a class="code" href="../../d2/d1/mm_8h.html#a159">MmSpecialPoolTag</a> = (ULONG)-1;
00564             <a class="code" href="../../d8/d0/cmdat3_8c.html#a32">MmSnapUnloads</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00565             <a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00566             <a class="code" href="../../d8/d0/cmdat3_8c.html#a30">MmEnforceWriteProtection</a> = 0;
00567             <a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00568             <a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00569         }
00570         <span class="keywordflow">else</span> {
00571             <a class="code" href="../../d4/d8/mi_8h.html#a957">MiTriageSystem</a> (LoaderBlock);
00572         }
00573 
00574         SystemPteMultiplier = 0;
00575 
00576         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> == 0) {
00577 <span class="preprocessor">#if defined (_WIN64)</span>
00578 <span class="preprocessor"></span>
00579             <span class="comment">//</span>
00580             <span class="comment">// 64-bit NT is not contrained by virtual address space.  No</span>
00581             <span class="comment">// tradeoffs between nonpaged pool, paged pool and system PTEs</span>
00582             <span class="comment">// need to be made.  So just allocate PTEs on a linear scale as</span>
00583             <span class="comment">// a function of the amount of RAM.</span>
00584             <span class="comment">//</span>
00585             <span class="comment">// For example on Alpha64, 4gb of RAM gets 128gb of PTEs by default.</span>
00586             <span class="comment">// The page table cost is the inversion of the multiplier based</span>
00587             <span class="comment">// on the PTE_PER_PAGE.</span>
00588             <span class="comment">//</span>
00589 
00590             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (<a class="code" href="../../d8/d0/cmdat3_8c.html#a54">ExpMultiUserTS</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00591                 SystemPteMultiplier = 128;
00592             }
00593             <span class="keywordflow">else</span> {
00594                 SystemPteMultiplier = 64;
00595             }
00596             <span class="keywordflow">if</span> (Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> &lt; 0x8000) {
00597                 SystemPteMultiplier &gt;&gt;= 1;
00598             }
00599 <span class="preprocessor">#else</span>
00600 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> &lt; <a class="code" href="../../d5/d1/mminit_8c.html#a2">MM_MEDIUM_SYSTEM</a>) {
00601                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a27">MM_MINIMUM_SYSTEM_PTES</a>;
00602             } <span class="keywordflow">else</span> {
00603                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a29">MM_DEFAULT_SYSTEM_PTES</a>;
00604                 <span class="keywordflow">if</span> (Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> &gt; 8192) {
00605                     <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> += <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a>;
00606 
00607                     <span class="comment">//</span>
00608                     <span class="comment">// Any reasonable Hydra machine gets the maximum.</span>
00609                     <span class="comment">//</span>
00610 
00611                     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (<a class="code" href="../../d8/d0/cmdat3_8c.html#a54">ExpMultiUserTS</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00612                         <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a28">MM_MAXIMUM_SYSTEM_PTES</a>;
00613                     }
00614                 }
00615             }
00616 <span class="preprocessor">#endif</span>
00617 <span class="preprocessor"></span>        }
00618         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> == (ULONG)-1) {
00619 
00620             <span class="comment">//</span>
00621             <span class="comment">// This registry setting indicates the maximum number of</span>
00622             <span class="comment">// system PTEs possible for this machine must be allocated.</span>
00623             <span class="comment">// Snap this for later reference.</span>
00624             <span class="comment">//</span>
00625         
00626             <a class="code" href="../../d4/d8/mi_8h.html#a633">MiRequestedSystemPtes</a> = <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a>;
00627 
00628 <span class="preprocessor">#if defined (_WIN64)</span>
00629 <span class="preprocessor"></span>            SystemPteMultiplier = 256;
00630 <span class="preprocessor">#else</span>
00631 <span class="preprocessor"></span>            <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a28">MM_MAXIMUM_SYSTEM_PTES</a>;
00632 <span class="preprocessor">#endif</span>
00633 <span class="preprocessor"></span>        }
00634 
00635         <span class="keywordflow">if</span> (SystemPteMultiplier != 0) {
00636             <span class="keywordflow">if</span> (Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> * SystemPteMultiplier &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a28">MM_MAXIMUM_SYSTEM_PTES</a>) {
00637                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a28">MM_MAXIMUM_SYSTEM_PTES</a>;
00638             }
00639             <span class="keywordflow">else</span> {
00640                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = (ULONG)(Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> * SystemPteMultiplier);
00641             }
00642         }
00643 
00644         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a28">MM_MAXIMUM_SYSTEM_PTES</a>)  {
00645             <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a28">MM_MAXIMUM_SYSTEM_PTES</a>;
00646         }
00647 
00648         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a27">MM_MINIMUM_SYSTEM_PTES</a>) {
00649             <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a27">MM_MINIMUM_SYSTEM_PTES</a>;
00650         }
00651 
00652         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a46">MmHeapSegmentReserve</a> == 0) {
00653             <a class="code" href="../../d8/d0/cmdat3_8c.html#a46">MmHeapSegmentReserve</a> = 1024 * 1024;
00654         }
00655 
00656         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a47">MmHeapSegmentCommit</a> == 0) {
00657             <a class="code" href="../../d8/d0/cmdat3_8c.html#a47">MmHeapSegmentCommit</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> * 2;
00658         }
00659 
00660         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a48">MmHeapDeCommitTotalFreeThreshold</a> == 0) {
00661             <a class="code" href="../../d8/d0/cmdat3_8c.html#a48">MmHeapDeCommitTotalFreeThreshold</a> = 64 * 1024;
00662         }
00663 
00664         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a49">MmHeapDeCommitFreeBlockThreshold</a> == 0) {
00665             <a class="code" href="../../d8/d0/cmdat3_8c.html#a49">MmHeapDeCommitFreeBlockThreshold</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00666         }
00667 
00668 <span class="preprocessor">#ifndef NO_POOL_CHECKS</span>
00669 <span class="preprocessor"></span>        <a class="code" href="../../d5/d1/mminit_8c.html#a50">MiInitializeSpecialPoolCriteria</a> ();
00670 <span class="preprocessor">#endif</span>
00671 <span class="preprocessor"></span>
00672         <span class="comment">//</span>
00673         <span class="comment">// If the registry indicates drivers are in the suspect list,</span>
00674         <span class="comment">// extra system PTEs need to be allocated to support special pool</span>
00675         <span class="comment">// for their allocations.</span>
00676         <span class="comment">//</span>
00677 
00678         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a10">MmVerifyDriverBufferLength</a> != (ULONG)-1) ||
00679             ((<a class="code" href="../../d2/d1/mm_8h.html#a159">MmSpecialPoolTag</a> != 0) &amp;&amp; (<a class="code" href="../../d2/d1/mm_8h.html#a159">MmSpecialPoolTag</a> != (ULONG)-1))) {
00680             <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> += <a class="code" href="../../d4/d8/mi_8h.html#a248">MM_SPECIAL_POOL_PTES</a>;
00681         }
00682 
00683         <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> += <a class="code" href="../../d5/d1/mminit_8c.html#a13">BBTPagesToReserve</a>;
00684 
00685         <span class="comment">//</span>
00686         <span class="comment">// Initialize the machine dependent portion of the hardware.</span>
00687         <span class="comment">//</span>
00688 
00689         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a688">MmSystemWsLock</a>);
00690 
00691         <a class="code" href="../../d2/d3/initppc_8c.html#a1">MiInitMachineDependent</a> (LoaderBlock);
00692 
00693 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00694 <span class="preprocessor"></span>        MiPfnProtectionEnabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00695 <span class="preprocessor">#endif</span>
00696 <span class="preprocessor"></span>
00697         <a class="code" href="../../d8/d8/sysload_8c.html#a64">MiReloadBootLoadedDrivers</a> (LoaderBlock);
00698 
00699         <a class="code" href="../../d9/d5/verifier_8c.html#a109">MiInitializeDriverVerifierList</a> (LoaderBlock);
00700 
00701         j = (<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a>) +
00702              (<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a>) *
00703                     (Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> - 1)));
00704 
00705         <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
00706                                                        j,
00707                                                        '  mM');
00708 
00709         RtlCopyMemory (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>, Memory, j);
00710 
00711         <span class="comment">//</span>
00712         <span class="comment">// Setup the system size as small, medium, or large depending</span>
00713         <span class="comment">// on memory available.</span>
00714         <span class="comment">//</span>
00715         <span class="comment">// For internal MM tuning, the following applies</span>
00716         <span class="comment">//</span>
00717         <span class="comment">// 12Mb  is small</span>
00718         <span class="comment">// 12-19 is medium</span>
00719         <span class="comment">// &gt; 19 is large</span>
00720         <span class="comment">//</span>
00721         <span class="comment">//</span>
00722         <span class="comment">// For all other external tuning,</span>
00723         <span class="comment">// &lt; 19 is small</span>
00724         <span class="comment">// 19 - 31 is medium for workstation</span>
00725         <span class="comment">// 19 - 63 is medium for server</span>
00726         <span class="comment">// &gt;= 32 is large for workstation</span>
00727         <span class="comment">// &gt;= 64 is large for server</span>
00728         <span class="comment">//</span>
00729 
00730         <a class="code" href="../../d2/d1/mm_8h.html#a134">MmReadClusterSize</a> = 7;
00731         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt;= <a class="code" href="../../d5/d1/mminit_8c.html#a1">MM_SMALL_SYSTEM</a> ) {
00732             <a class="code" href="../../d5/d1/mminit_8c.html#a37">MmSystemSize</a> = <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>;
00733             <a class="code" href="../../d4/d8/mi_8h.html#a669">MmMaximumDeadKernelStacks</a> = 0;
00734             <a class="code" href="../../d4/d8/mi_8h.html#a729">MmModifiedPageMinimum</a> = 40;
00735             <a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a> = 100;
00736             <a class="code" href="../../d4/d8/mi_8h.html#a682">MmDataClusterSize</a> = 0;
00737             <a class="code" href="../../d4/d8/mi_8h.html#a683">MmCodeClusterSize</a> = 1;
00738             <a class="code" href="../../d2/d1/mm_8h.html#a134">MmReadClusterSize</a> = 2;
00739 
00740         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt;= <a class="code" href="../../d5/d1/mminit_8c.html#a2">MM_MEDIUM_SYSTEM</a> ) {
00741             <a class="code" href="../../d5/d1/mminit_8c.html#a37">MmSystemSize</a> = <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>;
00742             <a class="code" href="../../d4/d8/mi_8h.html#a669">MmMaximumDeadKernelStacks</a> = 2;
00743             <a class="code" href="../../d4/d8/mi_8h.html#a729">MmModifiedPageMinimum</a> = 80;
00744             <a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a> = 150;
00745             <a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a> += 100;
00746             <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> += 150;
00747             <a class="code" href="../../d4/d8/mi_8h.html#a682">MmDataClusterSize</a> = 1;
00748             <a class="code" href="../../d4/d8/mi_8h.html#a683">MmCodeClusterSize</a> = 2;
00749             <a class="code" href="../../d2/d1/mm_8h.html#a134">MmReadClusterSize</a> = 4;
00750 
00751         } <span class="keywordflow">else</span> {
00752             <a class="code" href="../../d5/d1/mminit_8c.html#a37">MmSystemSize</a> = <a class="code" href="../../d2/d1/mm_8h.html#a343a166">MmMediumSystem</a>;
00753             <a class="code" href="../../d4/d8/mi_8h.html#a669">MmMaximumDeadKernelStacks</a> = 5;
00754             <a class="code" href="../../d4/d8/mi_8h.html#a729">MmModifiedPageMinimum</a> = 150;
00755             <a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a> = 300;
00756             <a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a> += 400;
00757             <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> += 800;
00758             <a class="code" href="../../d4/d8/mi_8h.html#a682">MmDataClusterSize</a> = 3;
00759             <a class="code" href="../../d4/d8/mi_8h.html#a683">MmCodeClusterSize</a> = 7;
00760         }
00761 
00762         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt; ((24*1024*1024)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
00763             <a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a> = 32;
00764         }
00765 
00766         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt;= ((32*1024*1024)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
00767 
00768             <span class="comment">//</span>
00769             <span class="comment">// If we are on a workstation, 32Mb and above are considered large systems</span>
00770             <span class="comment">//</span>
00771             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a> == 0x00690057 ) {
00772                 <a class="code" href="../../d5/d1/mminit_8c.html#a37">MmSystemSize</a> = <a class="code" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a>;
00773 
00774             } <span class="keywordflow">else</span> {
00775 
00776                 <span class="comment">//</span>
00777                 <span class="comment">// For servers, 64Mb and greater is a large system</span>
00778                 <span class="comment">//</span>
00779 
00780                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt;= ((64*1024*1024)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
00781                     <a class="code" href="../../d5/d1/mminit_8c.html#a37">MmSystemSize</a> = <a class="code" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a>;
00782                 }
00783             }
00784         }
00785 
00786         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt; ((33*1024*1024)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
00787             <a class="code" href="../../d4/d8/mi_8h.html#a729">MmModifiedPageMinimum</a> = 400;
00788             <a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a> = 800;
00789             <a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a> += 500;
00790             <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> += 900;
00791         }
00792 
00793         <span class="comment">//</span>
00794         <span class="comment">// determine if we are on an AS system ( Winnt is not AS)</span>
00795         <span class="comment">//</span>
00796 
00797         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a> == 0x00690057) {
00798             SharedUserData-&gt;NtProductType = NtProductWinNt;
00799             <a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a> = 0;
00800             <a class="code" href="../../d2/d1/mm_8h.html#a151">MmThrottleTop</a> = 250;
00801             <a class="code" href="../../d2/d1/mm_8h.html#a152">MmThrottleBottom</a> = 30;
00802 
00803         } <span class="keywordflow">else</span> {
00804             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a> == 0x0061004c ) {
00805                 SharedUserData-&gt;NtProductType = NtProductLanManNt;
00806 
00807             } <span class="keywordflow">else</span> {
00808                 SharedUserData-&gt;NtProductType = NtProductServer;
00809             }
00810 
00811             <a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a> = 1;
00812             <a class="code" href="../../d2/d1/mm_8h.html#a151">MmThrottleTop</a> = 450;
00813             <a class="code" href="../../d2/d1/mm_8h.html#a152">MmThrottleBottom</a> = 80;
00814             <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a> = 81;
00815         }
00816 
00817         <a class="code" href="../../d5/d0/wsmanage_8c.html#a39">MiAdjustWorkingSetManagerParameters</a>((BOOLEAN)(<a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a> == 0 ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>));
00818 
00819         <span class="comment">//</span>
00820         <span class="comment">// Set the ResidentAvailablePages to the number of available</span>
00821         <span class="comment">// pages minus the fluid value.</span>
00822         <span class="comment">//</span>
00823 
00824         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> = <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> - <a class="code" href="../../d4/d8/mi_8h.html#a16">MM_FLUID_PHYSICAL_PAGES</a>;
00825 
00826         <span class="comment">//</span>
00827         <span class="comment">// Subtract off the size of the system cache working set.</span>
00828         <span class="comment">//</span>
00829 
00830         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= <a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a>;
00831         <a class="code" href="../../d5/d1/mminit_8c.html#a18">MmResidentAvailableAtInit</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a>;
00832 
00833 
00834         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> &lt; 0) {
00835 <span class="preprocessor">#if DBG</span>
00836 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"system cache working set too big\n"</span>);
00837 <span class="preprocessor">#endif</span>
00838 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00839         }
00840 
00841         <span class="comment">//</span>
00842         <span class="comment">// Initialize spin lock for charging and releasing page file</span>
00843         <span class="comment">// commitment.</span>
00844         <span class="comment">//</span>
00845 
00846         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>);
00847 
00848         <a class="code" href="../../d4/d8/mi_8h.html#a817">MiInitializeIoTrackers</a> ();
00849 
00850         <span class="comment">//</span>
00851         <span class="comment">// Initialize spin lock for allowing working set expansion.</span>
00852         <span class="comment">//</span>
00853 
00854         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a691">MmExpansionLock</a>);
00855 
00856         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a684">MmPageFileCreationLock</a>);
00857 
00858         <span class="comment">//</span>
00859         <span class="comment">// Initialize resource for extending sections.</span>
00860         <span class="comment">//</span>
00861 
00862         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a679">MmSectionExtendResource</a>);
00863         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a680">MmSectionExtendSetResource</a>);
00864 
00865         <span class="comment">//</span>
00866         <span class="comment">// Build the system cache structures.</span>
00867         <span class="comment">//</span>
00868 
00869         StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a657">MmSystemCacheWorkingSetList</a>);
00870         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a657">MmSystemCacheWorkingSetList</a>);
00871 
00872 <span class="preprocessor">#if defined (_WIN64)</span>
00873 <span class="preprocessor"></span>
00874         StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(StartPde);
00875 
00876         TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
00877 
00878         <span class="keywordflow">if</span> (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00879 
00880             <span class="comment">//</span>
00881             <span class="comment">// Map in a page directory page for the system cache working set.</span>
00882             <span class="comment">// Note that we only populate one page table for this.</span>
00883             <span class="comment">//</span>
00884 
00885             DirectoryFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
00886                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (StartPpe));
00887             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = DirectoryFrameIndex;
00888             *StartPpe = TempPte;
00889 
00890 
00891             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(DirectoryFrameIndex);
00892             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (
00893                                   <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d9/d8/axp64_2mialpha_8h.html#a5">PDE_KTBASE</a>));
00894             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = StartPpe;
00895             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00896             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00897             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
00898             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
00899 
00900             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (StartPde,
00901                              <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
00902                              <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00903         }
00904 
00905         <span class="comment">//</span>
00906         <span class="comment">// Map in a page table page.</span>
00907         <span class="comment">//</span>
00908 
00909         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00910 
00911         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
00912                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (StartPde));
00913         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
00914         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (StartPde, TempPte);
00915 
00916         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
00917         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = DirectoryFrameIndex;
00918         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = StartPde;
00919         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00920         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00921         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
00922         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
00923 
00924         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartPde),
00925                          <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
00926                          <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00927 
00928         StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a11">MmSystemCacheStart</a>);
00929         StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a11">MmSystemCacheStart</a>);
00930         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartPde);
00931 
00932 <span class="preprocessor">#else</span>
00933 <span class="preprocessor"></span><span class="preprocessor">#if !defined(_X86PAE_)</span>
00934 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((StartPde + 1) == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a11">MmSystemCacheStart</a>));
00935 <span class="preprocessor">#endif</span>
00936 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00937 <span class="preprocessor"></span>
00938         MaximumSystemCacheSizeTotal = MaximumSystemCacheSize;
00939 
00940 <span class="preprocessor">#if defined(_X86_)</span>
00941 <span class="preprocessor"></span>        MaximumSystemCacheSizeTotal += <a class="code" href="../../d2/d2/data386_8c.html#a28">MiMaximumSystemCacheSizeExtra</a>;
00942 <span class="preprocessor">#endif</span>
00943 <span class="preprocessor"></span>
00944         <span class="comment">//</span>
00945         <span class="comment">// Size the system cache based on the amount of physical memory.</span>
00946         <span class="comment">//</span>
00947 
00948         i = (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> + 65) / 1024;
00949 
00950         <span class="keywordflow">if</span> (i &gt;= 4) {
00951 
00952             <span class="comment">//</span>
00953             <span class="comment">// System has at least 4032 pages.  Make the system</span>
00954             <span class="comment">// cache 128mb + 64mb for each additional 1024 pages.</span>
00955             <span class="comment">//</span>
00956 
00957             <a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a> = (PFN_COUNT)(
00958                             ((128*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) +
00959                             ((i - 4) * ((64*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)));
00960             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a> &gt; MaximumSystemCacheSizeTotal) {
00961                 <a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a> = MaximumSystemCacheSizeTotal;
00962             }
00963         }
00964 
00965         <a class="code" href="../../d8/d5/kddata_8c.html#a12">MmSystemCacheEnd</a> = (PVOID)(((PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a11">MmSystemCacheStart</a> +
00966                     <a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a> * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - 1);
00967 
00968 <span class="preprocessor">#if defined(_X86_)</span>
00969 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a> &gt; MaximumSystemCacheSize) {
00970             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d2/data386_8c.html#a28">MiMaximumSystemCacheSizeExtra</a> != 0);
00971             <a class="code" href="../../d8/d5/kddata_8c.html#a12">MmSystemCacheEnd</a> = (PVOID)(((PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a11">MmSystemCacheStart</a> +
00972                         MaximumSystemCacheSize * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - 1);
00973 
00974             <a class="code" href="../../d2/d2/data386_8c.html#a29">MiSystemCacheStartExtra</a> = (PVOID)<a class="code" href="../../d6/d8/mi386_8h.html#a33">MM_SYSTEM_CACHE_START_EXTRA</a>;
00975             <a class="code" href="../../d2/d2/data386_8c.html#a30">MiSystemCacheEndExtra</a> = (PVOID)(((PCHAR)<a class="code" href="../../d2/d2/data386_8c.html#a29">MiSystemCacheStartExtra</a> +
00976                         (<a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a> - MaximumSystemCacheSize) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - 1);
00977         }
00978                 <span class="keywordflow">else</span> {
00979             <a class="code" href="../../d2/d2/data386_8c.html#a29">MiSystemCacheStartExtra</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a11">MmSystemCacheStart</a>;
00980             <a class="code" href="../../d2/d2/data386_8c.html#a30">MiSystemCacheEndExtra</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a12">MmSystemCacheEnd</a>;
00981                 }
00982 <span class="preprocessor">#endif</span>
00983 <span class="preprocessor"></span>
00984         EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a12">MmSystemCacheEnd</a>);
00985 
00986         TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
00987 
00988 <span class="preprocessor">#if defined(_WIN64)</span>
00989 <span class="preprocessor"></span>        First = (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00990 <span class="preprocessor">#endif</span>
00991 <span class="preprocessor"></span>
00992 <span class="preprocessor">#if !defined (_WIN64)</span>
00993 <span class="preprocessor"></span>        DirectoryFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PDE_BASE));
00994 <span class="preprocessor">#endif</span>
00995 <span class="preprocessor"></span>
00996         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00997         <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
00998 
00999 <span class="preprocessor">#if defined (_WIN64)</span>
01000 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (First == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(StartPde)) {
01001                 First = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01002                 StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(StartPde);
01003 
01004                 <span class="comment">//</span>
01005                 <span class="comment">// Map in a page directory page.</span>
01006                 <span class="comment">//</span>
01007 
01008                 DirectoryFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
01009                                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (StartPpe));
01010                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = DirectoryFrameIndex;
01011                 *StartPpe = TempPte;
01012 
01013                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(DirectoryFrameIndex);
01014                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (
01015                                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d9/d8/axp64_2mialpha_8h.html#a5">PDE_KTBASE</a>));
01016                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = StartPpe;
01017                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01018                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01019                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01020                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
01021 
01022                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (StartPde,
01023                                  <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
01024                                  <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01025             }
01026 <span class="preprocessor">#endif</span>
01027 <span class="preprocessor"></span>
01028             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPde-&gt;u.Hard.Valid == 0);
01029 
01030             <span class="comment">//</span>
01031             <span class="comment">// Map in a page table page.</span>
01032             <span class="comment">//</span>
01033 
01034             PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
01035                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (StartPde));
01036             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
01037             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (StartPde, TempPte);
01038 
01039             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
01040             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = DirectoryFrameIndex;
01041             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = StartPde;
01042             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01043             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01044             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01045             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
01046 
01047             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (PointerPte,
01048                              <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
01049                              <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01050 
01051             StartPde += 1;
01052             PointerPte += <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>;
01053         }
01054 
01055 <span class="preprocessor">#if defined(_X86_)</span>
01056 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/data386_8c.html#a30">MiSystemCacheEndExtra</a> != <a class="code" href="../../d8/d5/kddata_8c.html#a12">MmSystemCacheEnd</a>) {
01057 
01058             StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d2/d2/data386_8c.html#a29">MiSystemCacheStartExtra</a>);
01059                         EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(<a class="code" href="../../d2/d2/data386_8c.html#a30">MiSystemCacheEndExtra</a>);
01060 
01061                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d2/d2/data386_8c.html#a29">MiSystemCacheStartExtra</a>);
01062 
01063                         <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
01064 
01065                                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPde-&gt;u.Hard.Valid == 0);
01066 
01067                 <span class="comment">//</span>
01068                 <span class="comment">// Map in a page directory page.</span>
01069                 <span class="comment">//</span>
01070 
01071                 PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
01072                                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (StartPde));
01073                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
01074                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (StartPde, TempPte);
01075 
01076                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
01077                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (
01078                                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PDE_BASE));
01079                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = StartPde;
01080                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01081                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01082                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01083                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
01084 
01085                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (PointerPte,
01086                                  <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
01087                                  <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01088 
01089                 StartPde += 1;
01090                 PointerPte += <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>;
01091             }
01092         }
01093 <span class="preprocessor">#endif</span>
01094 <span class="preprocessor"></span>
01095         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01096 
01097         <span class="comment">//</span>
01098         <span class="comment">// Initialize the system cache.  Only set the large system cache if</span>
01099         <span class="comment">// we have a large amount of physical memory.</span>
01100         <span class="comment">//</span>
01101 
01102         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/fssup_8c.html#a4">MmLargeSystemCache</a> != 0 &amp;&amp; <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt; 0x7FF0) {
01103             <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt;
01104                     <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> + ((64*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>))) {
01105                 <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> =
01106                             <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> - ((32*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01107                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)<a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> &gt; (LONG)<a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a>);
01108                 <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a> = 256;
01109             }
01110         }
01111 
01112         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> &gt; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a70">MM_MAXIMUM_WORKING_SET</a> - 5)) {
01113             <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a70">MM_MAXIMUM_WORKING_SET</a> - 5;
01114         }
01115 
01116         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> &gt; <a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a>) {
01117             <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> = <a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a>;
01118             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a> + 500) &gt; <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a>) {
01119                 <a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a> = <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> - 500;
01120             }
01121         }
01122 
01123         <a class="code" href="../../d4/d8/mi_8h.html#a910">MiInitializeSystemCache</a> ((ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a>,
01124                                  (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a>);
01125 
01126         <span class="comment">//</span>
01127         <span class="comment">// Set the commit page limit to four times the number of available</span>
01128         <span class="comment">// pages. This value is updated as paging files are created.</span>
01129         <span class="comment">//</span>
01130 
01131         <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> = <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt;&lt; 2;
01132         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>;
01133 
01134         <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o0">Segment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01135         <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o2">RequestedExpansionSize</a> = 1;
01136         <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o3">ActualExpansion</a> = 1;
01137         <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o5">InProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01138         <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o6">PageFileNumber</a> = <a class="code" href="../../d4/d8/mi_8h.html#a221">MI_EXTEND_ANY_PAGEFILE</a>;
01139 
01140         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o4">Event</a>,
01141                            NotificationEvent,
01142                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01143 
01144         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a20">MmOverCommit</a> == 0) {
01145 
01146             <span class="comment">// If this value was not set via the registry, set the</span>
01147             <span class="comment">// over commit value to the number of available pages</span>
01148             <span class="comment">// minus 1024 pages (4mb with 4k pages).</span>
01149             <span class="comment">//</span>
01150 
01151             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; 1024) {
01152                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a20">MmOverCommit</a> = <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> - 1024;
01153             }
01154         }
01155 
01156         <span class="comment">//</span>
01157         <span class="comment">// Set maximum working set size to 512 pages less total available</span>
01158         <span class="comment">// memory.  2mb on machine with 4k pages.</span>
01159         <span class="comment">//</span>
01160 
01161         <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a> = (ULONG)(<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> - 512);
01162 
01163         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a> &gt; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a70">MM_MAXIMUM_WORKING_SET</a> - 5)) {
01164             <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a70">MM_MAXIMUM_WORKING_SET</a> - 5;
01165         }
01166 
01167         <span class="comment">//</span>
01168         <span class="comment">// Create the modified page writer event.</span>
01169         <span class="comment">//</span>
01170 
01171         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a719">MmModifiedPageWriterEvent</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01172 
01173         <span class="comment">//</span>
01174         <span class="comment">// Build paged pool.</span>
01175         <span class="comment">//</span>
01176 
01177         <a class="code" href="../../d5/d1/mminit_8c.html#a47">MiBuildPagedPool</a> ();
01178 
01179         <span class="comment">//</span>
01180         <span class="comment">// Initialize the loaded module list.  This cannot be done until</span>
01181         <span class="comment">// paged pool has been built.</span>
01182         <span class="comment">//</span>
01183 
01184         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a66">MiInitializeLoadedModuleList</a> (LoaderBlock) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01185 <span class="preprocessor">#if DBG</span>
01186 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Loaded module list initialization failed\n"</span>);
01187 <span class="preprocessor">#endif</span>
01188 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01189         }
01190 
01191         <span class="comment">//</span>
01192         <span class="comment">// Initialize the unused segment thresholds.  The assumption is made</span>
01193         <span class="comment">// that the filesystem will tack on approximately a 1024-byte paged</span>
01194         <span class="comment">// pool charge (regardless of file size) for each file in the cache.</span>
01195         <span class="comment">//</span>
01196 
01197         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a24">MmUnusedSegmentTrimLevel</a> &lt; 5) {
01198             <a class="code" href="../../d8/d0/cmdat3_8c.html#a24">MmUnusedSegmentTrimLevel</a> = 5;
01199         }
01200         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a24">MmUnusedSegmentTrimLevel</a> &gt; 40) {
01201             <a class="code" href="../../d8/d0/cmdat3_8c.html#a24">MmUnusedSegmentTrimLevel</a> = 40;
01202         }
01203         
01204         <a class="code" href="../../d4/d8/mi_8h.html#a700">MmMaxUnusedSegmentPagedPoolUsage</a> = (<a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> / 100) * (<a class="code" href="../../d8/d0/cmdat3_8c.html#a24">MmUnusedSegmentTrimLevel</a> &lt;&lt; 1);
01205         <a class="code" href="../../d4/d8/mi_8h.html#a703">MmUnusedSegmentPagedPoolReduction</a> = <a class="code" href="../../d4/d8/mi_8h.html#a700">MmMaxUnusedSegmentPagedPoolUsage</a> &gt;&gt; 2;
01206 
01207         <a class="code" href="../../d4/d8/mi_8h.html#a704">MmMaxUnusedSegmentNonPagedPoolUsage</a> = (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> / 100) * (<a class="code" href="../../d8/d0/cmdat3_8c.html#a24">MmUnusedSegmentTrimLevel</a> &lt;&lt; 1);
01208         <a class="code" href="../../d4/d8/mi_8h.html#a707">MmUnusedSegmentNonPagedPoolReduction</a> = <a class="code" href="../../d4/d8/mi_8h.html#a704">MmMaxUnusedSegmentNonPagedPoolUsage</a> &gt;&gt; 2;
01209 
01210         <span class="comment">//</span>
01211         <span class="comment">// Add more system PTEs if this is a large memory system.</span>
01212         <span class="comment">// Note that 64 bit systems can determine the right value at the</span>
01213         <span class="comment">// beginning since there is no virtual address space crunch.</span>
01214         <span class="comment">//</span>
01215 
01216 <span class="preprocessor">#if !defined (_WIN64)</span>
01217 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt; ((127*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01218 
01219             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> ((PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a> + 1);
01220             StartingPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a> + 1);
01221             j = 0;
01222 
01223             TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a7">ValidKernelPde</a>;
01224             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01225             <span class="keywordflow">while</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01226 
01227                 <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01228                 <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a271">MM_DBG_COMMIT_EXTRA_SYSTEM_PTES</a>, 1);
01229 
01230                 PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (
01231                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (PointerPde));
01232                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
01233                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPde, TempPte);
01234                 <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPde, 1);
01235                 PointerPde += 1;
01236                 StartingPte += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>);
01237                 j += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>);
01238             }
01239 
01240             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01241 
01242             <span class="keywordflow">if</span> (j != 0) {
01243                 StartingPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a> + 1);
01244                 <a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartingPte);
01245                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> += j;
01246                 <a class="code" href="../../d0/d9/sysptes_8c.html#a28">MiAddSystemPtes</a> (StartingPte, j, <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>);
01247             }
01248         }
01249 <span class="preprocessor">#endif</span>
01250 <span class="preprocessor"></span>
01251 
01252 <span class="preprocessor">#if DBG</span>
01253 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a68">MM_DBG_DUMP_BOOT_PTES</a>) {
01254             <a class="code" href="../../d4/d8/mi_8h.html#a965">MiDumpValidAddresses</a> ();
01255             <a class="code" href="../../d4/d8/mi_8h.html#a966">MiDumpPfn</a> ();
01256         }
01257 <span class="preprocessor">#endif</span>
01258 <span class="preprocessor"></span>
01259         <a class="code" href="../../d4/d8/mi_8h.html#a746">MmPageFaultNotifyRoutine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01260         <a class="code" href="../../d4/d8/mi_8h.html#a747">MmHardFaultNotifyRoutine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01261 
01262         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01263     }
01264 
01265     <span class="keywordflow">if</span> (Phase == 1) {
01266 
01267 <span class="preprocessor">#if DBG</span>
01268 <span class="preprocessor"></span>        MmDebug |= <a class="code" href="../../d4/d8/mi_8h.html#a74">MM_DBG_CHECK_PFN_LOCK</a>;
01269 <span class="preprocessor">#endif</span>
01270 <span class="preprocessor"></span>
01271 <span class="preprocessor">#ifdef _X86_</span>
01272 <span class="preprocessor"></span>        <a class="code" href="../../d2/d3/initppc_8c.html#a1">MiInitMachineDependent</a> (LoaderBlock);
01273 <span class="preprocessor">#endif</span>
01274 <span class="preprocessor"></span>        <a class="code" href="../../d5/d1/mminit_8c.html#a43">MiMapBBTMemory</a>(LoaderBlock);
01275 
01276         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/sectsup_8c.html#a20">MiSectionInitialization</a> ()) {
01277             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01278         }
01279 
01280         Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
01281         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o61">PhysicalVadList</a>.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01282             <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o90">AweLock</a>);
01283             InitializeListHead (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o61">PhysicalVadList</a>);
01284         }
01285 
01286 <span class="preprocessor">#if defined(MM_SHARED_USER_DATA_VA)</span>
01287 <span class="preprocessor"></span>
01288         <span class="comment">//</span>
01289         <span class="comment">// Create double mapped page between kernel and user mode.</span>
01290         <span class="comment">//</span>
01291 
01292         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(KI_USER_SHARED_DATA);
01293         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
01294         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01295 
01296         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (<a class="code" href="../../d5/d1/mminit_8c.html#a5">MmSharedUserDataPte</a>,
01297                            PageFrameIndex,
01298                            <a class="code" href="../../d4/d8/mi_8h.html#a36">MM_READONLY</a>,
01299                            PointerPte);
01300         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01301 
01302         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01303 
01304         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
01305 
01306         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01307 <span class="preprocessor">#endif</span>
01308 <span class="preprocessor"></span>
01309         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01310             <a class="code" href="../../d4/d7/sessload_8c.html#a15">MiSessionWideInitializeAddresses</a> ();
01311             <a class="code" href="../../d4/d0/wslist_8c.html#a28">MiInitializeSessionWsSupport</a> ();
01312             <a class="code" href="../../d3/d7/session_8c.html#a7">MiInitializeSessionIds</a> ();
01313         }
01314 
01315         <span class="comment">//</span>
01316         <span class="comment">// Set up system wide lock pages limit.</span>
01317         <span class="comment">//</span>
01318 
01319         <span class="keywordflow">if</span> ((MmLockPagesPercentage &lt; 5) || (MmLockPagesPercentage &gt;= 100)) {
01320 
01321             <span class="comment">//</span>
01322             <span class="comment">// No (reasonable or max) registry override from the user</span>
01323             <span class="comment">// so default to allowing all available memory.</span>
01324             <span class="comment">//</span>
01325 
01326             <a class="code" href="../../d4/d8/mi_8h.html#a635">MmLockPagesLimit</a> = (PFN_NUMBER)-1;
01327         }
01328         <span class="keywordflow">else</span> {
01329 
01330             <span class="comment">//</span>
01331             <span class="comment">// Use the registry value - note it is expressed as a percentage.</span>
01332             <span class="comment">//</span>
01333 
01334             <a class="code" href="../../d4/d8/mi_8h.html#a635">MmLockPagesLimit</a> = (PFN_NUMBER)((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> * <a class="code" href="../../d8/d0/cmdat3_8c.html#a21">MmLockPagesPercentage</a>) / 100);
01335         }
01336 
01337         <span class="comment">//</span>
01338         <span class="comment">// Start the modified page writer.</span>
01339         <span class="comment">//</span>
01340 
01341         InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01342 
01343         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>(
01344                         &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
01345                         THREAD_ALL_ACCESS,
01346                         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01347                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01348                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01349                         <a class="code" href="../../d4/d8/mi_8h.html#a877">MiModifiedPageWriter</a>,
01350                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01351                         ))) {
01352             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01353         }
01354         ZwClose (<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>);
01355 
01356         <span class="comment">//</span>
01357         <span class="comment">// Start the balance set manager.</span>
01358         <span class="comment">//</span>
01359         <span class="comment">// The balance set manager performs stack swapping and working</span>
01360         <span class="comment">// set management and requires two threads.</span>
01361         <span class="comment">//</span>
01362 
01363         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d2/d1/mm_8h.html#a139">MmWorkingSetManagerEvent</a>,
01364                            SynchronizationEvent,
01365                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01366 
01367         InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01368 
01369         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>(
01370                         &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
01371                         THREAD_ALL_ACCESS,
01372                         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01373                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01374                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01375                         <a class="code" href="../../d4/d9/ke_8h.html#a392">KeBalanceSetManager</a>,
01376                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01377                         ))) {
01378 
01379             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01380         }
01381         ZwClose (<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>);
01382 
01383         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>(
01384                         &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
01385                         THREAD_ALL_ACCESS,
01386                         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01387                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01388                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01389                         <a class="code" href="../../d4/d9/ke_8h.html#a393">KeSwapProcessOrStack</a>,
01390                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01391                         ))) {
01392 
01393             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01394         }
01395         ZwClose (<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>);
01396 
01397 <span class="preprocessor">#ifndef NO_POOL_CHECKS</span>
01398 <span class="preprocessor"></span>        <a class="code" href="../../d5/d1/mminit_8c.html#a50">MiInitializeSpecialPoolCriteria</a> ();
01399 <span class="preprocessor">#endif</span>
01400 <span class="preprocessor"></span>
01401 <span class="preprocessor">#if defined(_X86_)</span>
01402 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a964">MiEnableKernelVerifier</a> ();
01403 <span class="preprocessor">#endif</span>
01404 <span class="preprocessor"></span>
01405         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01406 
01407         NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
01408     
01409         <span class="keywordflow">for</span> ( ; NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>; NextEntry = NextEntry-&gt;Flink) {
01410     
01411             DataTableEntry = CONTAINING_RECORD(NextEntry,
01412                                                LDR_DATA_TABLE_ENTRY,
01413                                                InLoadOrderLinks);
01414     
01415             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DataTableEntry-&gt;DllBase);
01416 
01417             <span class="keywordflow">if</span> ((NtHeaders-&gt;OptionalHeader.MajorOperatingSystemVersion &gt;= 5) &amp;&amp;
01418                 (NtHeaders-&gt;OptionalHeader.MajorImageVersion &gt;= 5)) {
01419                 DataTableEntry-&gt;Flags |= LDRP_ENTRY_NATIVE;
01420             }
01421 
01422             <a class="code" href="../../d8/d8/sysload_8c.html#a47">MiWriteProtectSystemImage</a> (DataTableEntry-&gt;DllBase);
01423         }
01424         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>);
01425 
01426         InterlockedDecrement (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a33">MiTrimInProgressCount</a>);
01427 
01428         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01429     }
01430 
01431     <span class="keywordflow">if</span> (Phase == 2) {
01432         <a class="code" href="../../d5/d1/mminit_8c.html#a45">MiEnablePagingTheExecutive</a>();
01433         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01434     }
01435 
01436     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01437 }
01438 
01439 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01440"></a><a class="code" href="../../d5/d1/mminit_8c.html#a43">01440</a> <a class="code" href="../../d5/d1/mminit_8c.html#a43">MiMapBBTMemory</a> (
01441     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
01442     )
01443 
01444 <span class="comment">/*++</span>
01445 <span class="comment"></span>
01446 <span class="comment">Routine Description:</span>
01447 <span class="comment"></span>
01448 <span class="comment">    This function walks through the loader block's memory descriptor list</span>
01449 <span class="comment">    and maps memory reserved for the BBT buffer into the system.</span>
01450 <span class="comment"></span>
01451 <span class="comment">    The mapped PTEs are PDE-aligned and made user accessible.</span>
01452 <span class="comment"></span>
01453 <span class="comment">Arguments:</span>
01454 <span class="comment"></span>
01455 <span class="comment">    LoaderBlock - Supplies a pointer to the system loader block.</span>
01456 <span class="comment"></span>
01457 <span class="comment">Return Value:</span>
01458 <span class="comment"></span>
01459 <span class="comment">    None.</span>
01460 <span class="comment"></span>
01461 <span class="comment">Environment:</span>
01462 <span class="comment"></span>
01463 <span class="comment">    Kernel Mode Only.  System initialization.</span>
01464 <span class="comment"></span>
01465 <span class="comment">--*/</span>
01466 {
01467     PVOID Va;
01468     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> MemoryDescriptor;
01469     PLIST_ENTRY NextMd;
01470     PFN_NUMBER NumberOfPagesMapped;
01471     PFN_NUMBER NumberOfPages;
01472     PFN_NUMBER PageFrameIndex;
01473     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01474     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01475     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPde;
01476     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01477 
01478     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/mminit_8c.html#a13">BBTPagesToReserve</a> &lt;= 0) {
01479         <span class="keywordflow">return</span>;
01480     }
01481 
01482     <span class="comment">//</span>
01483     <span class="comment">// Request enough PTEs such that protection can be applied to the PDEs.</span>
01484     <span class="comment">//</span>
01485 
01486     NumberOfPages = (<a class="code" href="../../d5/d1/mminit_8c.html#a13">BBTPagesToReserve</a> + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a> - 1)) &amp; ~(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a> - 1);
01487 
01488     PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a>((ULONG)NumberOfPages,
01489                                      <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>,
01490                                      <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>,
01491                                      0,
01492                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01493 
01494     <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01495         <a class="code" href="../../d5/d1/mminit_8c.html#a13">BBTPagesToReserve</a> = 0;
01496         <span class="keywordflow">return</span>;
01497     }
01498 
01499     <span class="comment">//</span>
01500     <span class="comment">// Allow user access to the buffer.</span>
01501     <span class="comment">//</span>
01502 
01503     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
01504     LastPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte + NumberOfPages);
01505 
01506     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LastPde != PointerPde);
01507 
01508     <span class="keywordflow">do</span> {
01509         TempPte = *PointerPde;
01510         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long |= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a79">MM_PTE_OWNER_MASK</a>;
01511         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPde, TempPte);
01512         PointerPde += 1;
01513     } <span class="keywordflow">while</span> (PointerPde &lt; LastPde);
01514 
01515     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01516 
01517     Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01518 
01519     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a4">ValidUserPte</a>;
01520     NumberOfPagesMapped = 0;
01521 
01522     NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
01523 
01524     <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
01525 
01526         MemoryDescriptor = CONTAINING_RECORD(NextMd,
01527                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
01528                                              ListEntry);
01529 
01530         <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a277">LoaderBBTMemory</a>) {
01531 
01532             PageFrameIndex = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01533             NumberOfPages = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01534 
01535             <span class="keywordflow">if</span> (NumberOfPagesMapped + NumberOfPages &gt; <a class="code" href="../../d5/d1/mminit_8c.html#a13">BBTPagesToReserve</a>) {
01536                 NumberOfPages = <a class="code" href="../../d5/d1/mminit_8c.html#a13">BBTPagesToReserve</a> - NumberOfPagesMapped;
01537             }
01538 
01539             NumberOfPagesMapped += NumberOfPages;
01540 
01541             <span class="keywordflow">do</span> {
01542 
01543                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
01544                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01545 
01546                 PointerPte += 1;
01547                 PageFrameIndex += 1;
01548                 NumberOfPages -= 1;
01549             } <span class="keywordflow">while</span> (NumberOfPages);
01550 
01551             <span class="keywordflow">if</span> (NumberOfPagesMapped == <a class="code" href="../../d5/d1/mminit_8c.html#a13">BBTPagesToReserve</a>) {
01552                 <span class="keywordflow">break</span>;
01553             }
01554         }
01555 
01556         NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
01557     }
01558 
01559     RtlZeroMemory(Va, <a class="code" href="../../d5/d1/mminit_8c.html#a13">BBTPagesToReserve</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01560 
01561     <span class="comment">//</span>
01562     <span class="comment">// Tell BBT_Init how many pages were allocated.</span>
01563     <span class="comment">//</span>
01564 
01565     <span class="keywordflow">if</span> (NumberOfPagesMapped &lt; <a class="code" href="../../d5/d1/mminit_8c.html#a13">BBTPagesToReserve</a>) {
01566         <a class="code" href="../../d5/d1/mminit_8c.html#a13">BBTPagesToReserve</a> = (ULONG)NumberOfPagesMapped;
01567     }
01568     *(PULONG)Va = <a class="code" href="../../d5/d1/mminit_8c.html#a13">BBTPagesToReserve</a>;
01569 
01570     <span class="comment">//</span>
01571     <span class="comment">// At this point instrumentation code will detect the existence of</span>
01572     <span class="comment">// buffer and initialize the structures.</span>
01573     <span class="comment">//</span>
01574 
01575     <a class="code" href="../../d5/d1/mminit_8c.html#a12">BBTBuffer</a> = Va;
01576 
01577     <a class="code" href="../../d2/d1/mm_8h.html#a78">PERFINFO_MMINIT_START</a>();
01578 }
01579 
01580 
01581 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01582"></a><a class="code" href="../../d5/d1/mminit_8c.html#a52">01582</a> <a class="code" href="../../d5/d1/mminit_8c.html#a52">MmInitializeMemoryLimits</a> (
01583     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock,
01584     IN PBOOLEAN IncludeType,
01585     OUT <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> Memory
01586     )
01587 
01588 <span class="comment">/*++</span>
01589 <span class="comment"></span>
01590 <span class="comment">Routine Description:</span>
01591 <span class="comment"></span>
01592 <span class="comment">    This function walks through the loader block's memory</span>
01593 <span class="comment">    descriptor list and builds a list of contiguous physical</span>
01594 <span class="comment">    memory blocks of the desired types.</span>
01595 <span class="comment"></span>
01596 <span class="comment">Arguments:</span>
01597 <span class="comment"></span>
01598 <span class="comment">    LoaderBlock - Supplies a pointer the system loader block.</span>
01599 <span class="comment"></span>
01600 <span class="comment">    IncludeType - Array of BOOLEANS of size LoaderMaximum.</span>
01601 <span class="comment">                  TRUE means include this type of memory in return.</span>
01602 <span class="comment"></span>
01603 <span class="comment">    Memory - Returns the physical memory blocks.</span>
01604 <span class="comment"></span>
01605 <span class="comment">Return Value:</span>
01606 <span class="comment"></span>
01607 <span class="comment">    None.</span>
01608 <span class="comment"></span>
01609 <span class="comment">Environment:</span>
01610 <span class="comment"></span>
01611 <span class="comment">    Kernel Mode Only.  System initialization.</span>
01612 <span class="comment"></span>
01613 <span class="comment">--*/</span>
01614 {
01615 
01616     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> MemoryDescriptor;
01617     PLIST_ENTRY NextMd;
01618     PFN_NUMBER i;
01619     PFN_NUMBER LowestFound;
01620     PFN_NUMBER Found;
01621     PFN_NUMBER Merged;
01622     PFN_NUMBER NextPage;
01623     PFN_NUMBER <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a>;
01624 
01625     <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a> = 0;
01626 
01627     <span class="comment">//</span>
01628     <span class="comment">// Walk through the memory descriptors and build the physical memory list.</span>
01629     <span class="comment">//</span>
01630 
01631     LowestFound = 0;
01632     Memory-&gt;Run[0].BasePage = 0xffffffff;
01633     NextPage = 0xffffffff;
01634     Memory-&gt;Run[0].PageCount = 0;
01635     i = 0;
01636 
01637     <span class="keywordflow">do</span> {
01638         Merged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01639         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01640         NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
01641 
01642         <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
01643 
01644             MemoryDescriptor = CONTAINING_RECORD(NextMd,
01645                                                  <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
01646                                                  ListEntry);
01647 
01648             <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> &lt; <a class="code" href="../../d1/d9/arc_8h.html#a320a278">LoaderMaximum</a> &amp;&amp;
01649                 IncludeType [MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a>] ) {
01650 
01651                 <span class="comment">//</span>
01652                 <span class="comment">// Try to merge runs.</span>
01653                 <span class="comment">//</span>
01654 
01655                 <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> == NextPage) {
01656                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> != 0);
01657                     Memory-&gt;Run[i - 1].PageCount += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01658                     NextPage += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01659                     <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a> += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01660                     Merged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01661                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01662                     <span class="keywordflow">break</span>;
01663                 }
01664 
01665                 <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &gt;= LowestFound) {
01666                     <span class="keywordflow">if</span> (Memory-&gt;Run[i].BasePage &gt; MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>) {
01667                         Memory-&gt;Run[i].BasePage = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01668                         Memory-&gt;Run[i].PageCount = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01669                     }
01670                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01671                 }
01672             }
01673             NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
01674         }
01675 
01676         <span class="keywordflow">if</span> (!Merged &amp;&amp; Found) {
01677             NextPage = Memory-&gt;Run[i].BasePage + Memory-&gt;Run[i].PageCount;
01678             <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a> += Memory-&gt;Run[i].PageCount;
01679             i += 1;
01680         }
01681         Memory-&gt;Run[i].BasePage = 0xffffffff;
01682         LowestFound = NextPage;
01683 
01684     } <span class="keywordflow">while</span> (Found);
01685     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (i &lt;= Memory-&gt;NumberOfRuns);
01686     Memory-&gt;NumberOfRuns = (ULONG)i;
01687     Memory-&gt;NumberOfPages = <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a>;
01688 
01689     <span class="keywordflow">return</span>;
01690 }
01691 
01692 <span class="preprocessor">#if defined (_X86PAE_)</span>
01693 <span class="preprocessor"></span>
01694 <span class="keyword">static</span>
01695 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01696 MiCheckPaeLicense (
01697     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock,
01698     IN PBOOLEAN IncludeType,
01699     OUT <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> Memory
01700     )
01701 
01702 <span class="comment">/*++</span>
01703 <span class="comment"></span>
01704 <span class="comment">Routine Description:</span>
01705 <span class="comment"></span>
01706 <span class="comment">    This function walks through the loader block's memory descriptor list</span>
01707 <span class="comment">    and removes descriptors above 4gb if the license does not allow them.</span>
01708 <span class="comment"></span>
01709 <span class="comment">Arguments:</span>
01710 <span class="comment"></span>
01711 <span class="comment">    LoaderBlock - Supplies a pointer the system loader block.</span>
01712 <span class="comment"></span>
01713 <span class="comment">    IncludeType - Array of BOOLEANS of size LoaderMaximum.</span>
01714 <span class="comment">                  TRUE means include this type of memory in return.</span>
01715 <span class="comment"></span>
01716 <span class="comment">    Memory - Returns the physical memory blocks.</span>
01717 <span class="comment"></span>
01718 <span class="comment">Return Value:</span>
01719 <span class="comment"></span>
01720 <span class="comment">    None.</span>
01721 <span class="comment"></span>
01722 <span class="comment">Environment:</span>
01723 <span class="comment"></span>
01724 <span class="comment">    Kernel Mode Only.  System initialization.</span>
01725 <span class="comment"></span>
01726 <span class="comment">--*/</span>
01727 {
01728     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> MemoryDescriptor;
01729     PLIST_ENTRY NextMd;
01730     PFN_NUMBER i;
01731     PFN_NUMBER LowestFound;
01732     PFN_NUMBER Found;
01733     PFN_NUMBER Merged;
01734     PFN_NUMBER NextPage;
01735     PFN_NUMBER LastPage;
01736     PFN_NUMBER MaxPage;
01737     PFN_NUMBER <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a>;
01738     <span class="keyword">static</span> BOOLEAN BeenHere = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01739 
01740     <span class="keywordflow">if</span> (BeenHere == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01741         <span class="keywordflow">return</span>;
01742     }
01743 
01744     BeenHere = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01745 
01746     <span class="comment">//</span>
01747     <span class="comment">// If properly licensed for PAE (ie: DataCenter) and booted without the</span>
01748     <span class="comment">// 3gb switch, then use all available physical memory.</span>
01749     <span class="comment">//</span>
01750 
01751     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a325">ExVerifySuite</a>(DataCenter) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01752 
01753         <span class="comment">//</span>
01754         <span class="comment">// Note MmVirtualBias has not yet been initialized at the time of the</span>
01755         <span class="comment">// first call to this routine, so use the LoaderBlock directly.</span>
01756         <span class="comment">//</span>
01757 
01758         <span class="keywordflow">if</span> (LoaderBlock-&gt;u.I386.VirtualBias == 0) {
01759 
01760             <span class="comment">//</span>
01761             <span class="comment">// Limit the maximum physical memory to the amount we have</span>
01762             <span class="comment">// actually physically seen in a machine inhouse.</span>
01763             <span class="comment">//</span>
01764 
01765             MaxPage = 8 * 1024 * 1024;
01766         }
01767         <span class="keywordflow">else</span> {
01768 
01769             <span class="comment">//</span>
01770             <span class="comment">// The system is booting /3gb, so don't use more than 16gb of</span>
01771             <span class="comment">// physical memory.  This ensures enough virtual space to map</span>
01772             <span class="comment">// the PFN database.</span>
01773             <span class="comment">//</span>
01774 
01775             MaxPage = 4 * 1024 * 1024;
01776         }
01777     }
01778     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a> != 0x00690057) &amp;&amp;
01779              (<a class="code" href="../../d5/d8/ex_8h.html#a325">ExVerifySuite</a>(Enterprise) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01780 
01781         <span class="comment">//</span>
01782         <span class="comment">// Advanced Server is permitted a maximum of 8gb physical memory.</span>
01783         <span class="comment">// The system continues to operate in 8-byte PTE mode.</span>
01784         <span class="comment">//</span>
01785 
01786         MaxPage = 2 * 1024 * 1024;
01787     }
01788     <span class="keywordflow">else</span> {
01789 
01790         <span class="comment">//</span>
01791         <span class="comment">// All other configurations get a maximum of 4gb physical memory.</span>
01792         <span class="comment">// The system continues to operate in 8-byte PTE mode.</span>
01793         <span class="comment">//</span>
01794 
01795         MaxPage = 1024 * 1024;
01796     }
01797 
01798     <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a> = 0;
01799 
01800     <span class="comment">//</span>
01801     <span class="comment">// Walk through the memory descriptors and make sure no descriptors</span>
01802     <span class="comment">// reach or exceed the physical addressing limit.</span>
01803     <span class="comment">//</span>
01804 
01805     NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
01806     <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
01807 
01808         MemoryDescriptor = CONTAINING_RECORD(NextMd,
01809                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
01810                                              ListEntry);
01811 
01812         <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &gt;= MaxPage) {
01813             MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> = 0;
01814             MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = 0;
01815         }
01816 
01817         LastPage = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01818 
01819         <span class="keywordflow">if</span> (LastPage &gt;= MaxPage || LastPage &lt; MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>) {
01820             MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = MaxPage - MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> - 1;
01821         }
01822 
01823         NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
01824     }
01825 
01826     <span class="comment">//</span>
01827     <span class="comment">// Walk through the memory descriptors and truncate the physical memory</span>
01828     <span class="comment">// list.</span>
01829     <span class="comment">//</span>
01830 
01831     LowestFound = 0;
01832     Memory-&gt;Run[0].BasePage = 0xffffffff;
01833     NextPage = 0xffffffff;
01834     Memory-&gt;Run[0].PageCount = 0;
01835     i = 0;
01836 
01837     <span class="keywordflow">do</span> {
01838         Merged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01839         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01840         NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
01841 
01842         <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
01843 
01844             MemoryDescriptor = CONTAINING_RECORD(NextMd,
01845                                                  <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
01846                                                  ListEntry);
01847 
01848 
01849             <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> || MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>) {
01850 
01851                 <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> &lt; <a class="code" href="../../d1/d9/arc_8h.html#a320a278">LoaderMaximum</a> &amp;&amp;
01852                     IncludeType [MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a>] ) {
01853     
01854                     <span class="comment">//</span>
01855                     <span class="comment">// Try to merge runs.</span>
01856                     <span class="comment">//</span>
01857     
01858                     <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> == NextPage) {
01859                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> != 0);
01860                         Memory-&gt;Run[i - 1].PageCount += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01861                         NextPage += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01862                         <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a> += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01863                         Merged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01864                         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01865                         <span class="keywordflow">break</span>;
01866                     }
01867     
01868                     <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &gt;= LowestFound) {
01869                         <span class="keywordflow">if</span> (Memory-&gt;Run[i].BasePage &gt; MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>) {
01870                             Memory-&gt;Run[i].BasePage = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01871                             Memory-&gt;Run[i].PageCount = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01872                         }
01873                         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01874                     }
01875                 }
01876             }
01877             NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
01878         }
01879 
01880         <span class="keywordflow">if</span> (!Merged &amp;&amp; Found) {
01881             NextPage = Memory-&gt;Run[i].BasePage + Memory-&gt;Run[i].PageCount;
01882             <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a> += Memory-&gt;Run[i].PageCount;
01883             i += 1;
01884         }
01885         Memory-&gt;Run[i].BasePage = 0xffffffff;
01886         LowestFound = NextPage;
01887 
01888     } <span class="keywordflow">while</span> (Found);
01889     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (i &lt;= Memory-&gt;NumberOfRuns);
01890     Memory-&gt;NumberOfRuns = (ULONG)i;
01891     Memory-&gt;NumberOfPages = <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a>;
01892 
01893     <span class="keywordflow">return</span>;
01894 }
01895 <span class="preprocessor">#endif</span>
01896 <span class="preprocessor"></span>
01897 
01898 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01899"></a><a class="code" href="../../d5/d1/mminit_8c.html#a48">01899</a> <a class="code" href="../../d5/d1/mminit_8c.html#a48">MiMergeMemoryLimit</a> (
01900     IN OUT <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> Memory,
01901     IN PFN_NUMBER StartPage,
01902     IN PFN_NUMBER NumberOfPages
01903     )
01904 <span class="comment">/*++</span>
01905 <span class="comment"></span>
01906 <span class="comment">Routine Description:</span>
01907 <span class="comment"></span>
01908 <span class="comment">    This function ensures the passed range is in the passed in Memory</span>
01909 <span class="comment">    block adding any new data as needed.</span>
01910 <span class="comment"></span>
01911 <span class="comment">    The passed memory block is assumed to be at least</span>
01912 <span class="comment">    MAX_PHYSICAL_MEMORY_FRAGMENTS large</span>
01913 <span class="comment"></span>
01914 <span class="comment">Arguments:</span>
01915 <span class="comment"></span>
01916 <span class="comment">    Memory - Supplies the memory block to verify run is present in.</span>
01917 <span class="comment"></span>
01918 <span class="comment">    StartPage - Supplies the first page of the run.</span>
01919 <span class="comment"></span>
01920 <span class="comment">    NumberOfPages - Supplies the number of pages in the run.</span>
01921 <span class="comment"></span>
01922 <span class="comment">Return Value:</span>
01923 <span class="comment"></span>
01924 <span class="comment">    None.</span>
01925 <span class="comment"></span>
01926 <span class="comment">Environment:</span>
01927 <span class="comment"></span>
01928 <span class="comment">    Kernel Mode Only.  System initialization.</span>
01929 <span class="comment"></span>
01930 <span class="comment">--*/</span>
01931 {
01932     PFN_NUMBER EndPage, sp, ep, i;
01933 
01934     EndPage = StartPage + NumberOfPages;
01935 
01936     <span class="comment">//</span>
01937     <span class="comment">// Clip range to area which is not already described</span>
01938     <span class="comment">//</span>
01939 
01940     <span class="keywordflow">for</span> (i=0; i &lt; Memory-&gt;NumberOfRuns; i++) {
01941         sp = Memory-&gt;Run[i].BasePage;
01942         ep = sp + Memory-&gt;Run[i].PageCount;
01943 
01944         <span class="keywordflow">if</span> (sp &lt; StartPage) {
01945             <span class="keywordflow">if</span> (ep &gt; StartPage  &amp;&amp;  ep &lt; EndPage) {
01946                 <span class="comment">// bump beginning page of the target area</span>
01947                 StartPage = ep;
01948             }
01949 
01950             <span class="keywordflow">if</span> (ep &gt; EndPage) {
01951                 <span class="comment">//</span>
01952                 <span class="comment">// Target area is contained totally within this</span>
01953                 <span class="comment">// descriptor.  This range is fully accounted for.</span>
01954                 <span class="comment">//</span>
01955 
01956                 StartPage = EndPage;
01957             }
01958 
01959         } <span class="keywordflow">else</span> {
01960             <span class="comment">// sp &gt;= StartPage</span>
01961 
01962             <span class="keywordflow">if</span> (sp &lt; EndPage) {
01963                 <span class="keywordflow">if</span> (ep &lt; EndPage) {
01964                     <span class="comment">//</span>
01965                     <span class="comment">// This descriptor is totally within the target area -</span>
01966                     <span class="comment">// check the area on either side of this descriptor</span>
01967                     <span class="comment">//</span>
01968 
01969                     <a class="code" href="../../d5/d1/mminit_8c.html#a48">MiMergeMemoryLimit</a> (Memory, StartPage, sp - StartPage);
01970                     StartPage = ep;
01971 
01972                 }  <span class="keywordflow">else</span> {
01973                     <span class="comment">// clip the ending page of the target area</span>
01974                     EndPage = sp;
01975                 }
01976             }
01977         }
01978 
01979         <span class="comment">//</span>
01980         <span class="comment">// Anything left of target area?</span>
01981         <span class="comment">//</span>
01982 
01983         <span class="keywordflow">if</span> (StartPage == EndPage) {
01984             <span class="keywordflow">return</span> ;
01985         }
01986     }   <span class="comment">// next descriptor</span>
01987 
01988     <span class="comment">//</span>
01989     <span class="comment">// The range StartPage - EndPage is a missing. Add it.</span>
01990     <span class="comment">//</span>
01991 
01992     <span class="keywordflow">if</span> (Memory-&gt;NumberOfRuns == <a class="code" href="../../d2/d1/mm_8h.html#a0">MAX_PHYSICAL_MEMORY_FRAGMENTS</a>) {
01993         <span class="keywordflow">return</span> ;
01994     }
01995 
01996     Memory-&gt;Run[Memory-&gt;NumberOfRuns].BasePage  = StartPage;
01997     Memory-&gt;Run[Memory-&gt;NumberOfRuns].PageCount = EndPage - StartPage;
01998     Memory-&gt;NumberOfPages += EndPage - StartPage;
01999     Memory-&gt;NumberOfRuns  += 1;
02000 }
02001 
02002 
02003 
02004 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02005"></a><a class="code" href="../../d5/d1/mminit_8c.html#a53">02005</a> <a class="code" href="../../d5/d1/mminit_8c.html#a53">MmFreeLoaderBlock</a> (
02006     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
02007     )
02008 
02009 <span class="comment">/*++</span>
02010 <span class="comment"></span>
02011 <span class="comment">Routine Description:</span>
02012 <span class="comment"></span>
02013 <span class="comment">    This function is called as the last routine in phase 1 initialization.</span>
02014 <span class="comment">    It frees memory used by the OsLoader.</span>
02015 <span class="comment"></span>
02016 <span class="comment">Arguments:</span>
02017 <span class="comment"></span>
02018 <span class="comment">    LoadBlock - Supplies a pointer the system loader block.</span>
02019 <span class="comment"></span>
02020 <span class="comment">Return Value:</span>
02021 <span class="comment"></span>
02022 <span class="comment">    None.</span>
02023 <span class="comment"></span>
02024 <span class="comment">Environment:</span>
02025 <span class="comment"></span>
02026 <span class="comment">    Kernel Mode Only.  System initialization.</span>
02027 <span class="comment"></span>
02028 <span class="comment">--*/</span>
02029 
02030 {
02031 
02032     PLIST_ENTRY NextMd;
02033     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Pde;
02034     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> MemoryDescriptor;
02035     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a> SavedDescriptor[<a class="code" href="../../d5/d1/mminit_8c.html#a0">MM_MAX_LOADER_BLOCKS</a>];
02036     PFN_NUMBER i;
02037     PFN_NUMBER NextPhysicalPage;
02038     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02039     LONG BlockNumber = -1;
02040     KIRQL OldIrql;
02041 
02042     <span class="comment">//</span>
02043     <span class="comment">//</span>
02044     <span class="comment">// Walk through the memory descriptors and add pages to the</span>
02045     <span class="comment">// free list in the PFN database.</span>
02046     <span class="comment">//</span>
02047 
02048     NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
02049 
02050     <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
02051 
02052         MemoryDescriptor = CONTAINING_RECORD(NextMd,
02053                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
02054                                              ListEntry);
02055 
02056 
02057         <span class="keywordflow">switch</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a>) {
02058             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a261">LoaderOsloaderHeap</a>:
02059             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a273">LoaderRegistryData</a>:
02060             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a275">LoaderNlsData</a>:
02061             <span class="comment">//case LoaderMemoryData:  //this has page table and other stuff.</span>
02062 
02063                 <span class="comment">//</span>
02064                 <span class="comment">// Capture the data to temporary storage so we won't</span>
02065                 <span class="comment">// free memory we are referencing.  Coalesce it if</span>
02066                 <span class="comment">// the blocks are adjacent and of the same type.</span>
02067                 <span class="comment">//</span>
02068 
02069                 <span class="keywordflow">if</span> (BlockNumber != -1 &amp;&amp;
02070                     MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == SavedDescriptor[BlockNumber].<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> &amp;&amp;
02071                     MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> == SavedDescriptor[BlockNumber].<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + SavedDescriptor[BlockNumber].<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>) {
02072 
02073                         <span class="comment">//</span>
02074                         <span class="comment">// these blocks are adjacent - merge them</span>
02075                         <span class="comment">//</span>
02076 
02077                         SavedDescriptor[BlockNumber].<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
02078                 }
02079                 <span class="keywordflow">else</span> {
02080                     BlockNumber += 1;
02081                     <span class="keywordflow">if</span> (BlockNumber &gt;= <a class="code" href="../../d5/d1/mminit_8c.html#a0">MM_MAX_LOADER_BLOCKS</a>) {
02082                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT, 0, 0, 0, 0);
02083                     }
02084                     SavedDescriptor[BlockNumber] = *MemoryDescriptor;
02085                 }
02086 
02087                 <span class="keywordflow">break</span>;
02088 
02089             <span class="keywordflow">default</span>:
02090 
02091                 <span class="keywordflow">break</span>;
02092         }
02093 
02094         NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
02095     }
02096 
02097     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02098 
02099     <span class="keywordflow">while</span> (BlockNumber &gt;= 0) {
02100 
02101         i = SavedDescriptor[BlockNumber].<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
02102         NextPhysicalPage = SavedDescriptor[BlockNumber].BasePage;
02103 
02104         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (NextPhysicalPage);
02105         <span class="keywordflow">while</span> (i != 0) {
02106 
02107             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
02108                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink == 0) {
02109 
02110                     <span class="comment">//</span>
02111                     <span class="comment">// Set the PTE address to the physical page for</span>
02112                     <span class="comment">// virtual address alignment checking.</span>
02113                     <span class="comment">//</span>
02114 
02115                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> =
02116                                (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(NextPhysicalPage &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
02117                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
02118                                         NextPhysicalPage);
02119                 }
02120             } <span class="keywordflow">else</span> {
02121 
02122                 <span class="keywordflow">if</span> (NextPhysicalPage != 0) {
02123                     <span class="comment">//</span>
02124                     <span class="comment">// Remove PTE and insert into the free list.  If it is</span>
02125                     <span class="comment">// a physical address within the PFN database, the PTE</span>
02126                     <span class="comment">// element does not exist and therefore cannot be updated.</span>
02127                     <span class="comment">//</span>
02128 
02129                     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a> (
02130                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>))) {
02131 
02132                         <span class="comment">//</span>
02133                         <span class="comment">// Not a physical address.</span>
02134                         <span class="comment">//</span>
02135 
02136                         *(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>) = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
02137                     }
02138 
02139                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
02140                     <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (NextPhysicalPage);
02141                 }
02142             }
02143 
02144             Pfn1++;
02145             i -= 1;
02146             NextPhysicalPage += 1;
02147         }
02148 
02149         BlockNumber -= 1;
02150     }
02151 
02152     <span class="comment">//</span>
02153     <span class="comment">// If the kernel has been biased to allow for 3gb of user address space,</span>
02154     <span class="comment">// then the first 16mb of memory is doubly mapped to KSEG0_BASE and to</span>
02155     <span class="comment">// ALTERNATE_BASE. Therefore, the KSEG0_BASE entries must be unmapped.</span>
02156     <span class="comment">//</span>
02157 
02158 <span class="preprocessor">#if defined(_X86_)</span>
02159 <span class="preprocessor"></span>
02160     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> != 0) {
02161         Pde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a>);
02162         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
02163         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde + 1, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
02164         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde + 2, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
02165         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde + 3, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
02166 
02167 <span class="preprocessor">#if defined(_X86PAE_)</span>
02168 <span class="preprocessor"></span>        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde + 4, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
02169         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde + 5, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
02170         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde + 6, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
02171         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde + 7, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
02172 <span class="preprocessor">#endif</span>
02173 <span class="preprocessor"></span>
02174     }
02175 
02176 <span class="preprocessor">#endif</span>
02177 <span class="preprocessor"></span>
02178     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02179     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02180     <span class="keywordflow">return</span>;
02181 }
02182 
02183 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02184"></a><a class="code" href="../../d5/d1/mminit_8c.html#a54">02184</a> <a class="code" href="../../d5/d1/mminit_8c.html#a47">MiBuildPagedPool</a> (
02185     VOID
02186     )
02187 
02188 <span class="comment">/*++</span>
02189 <span class="comment"></span>
02190 <span class="comment">Routine Description:</span>
02191 <span class="comment"></span>
02192 <span class="comment">    This function is called to build the structures required for paged</span>
02193 <span class="comment">    pool and initialize the pool.  Once this routine is called, paged</span>
02194 <span class="comment">    pool may be allocated.</span>
02195 <span class="comment"></span>
02196 <span class="comment">Arguments:</span>
02197 <span class="comment"></span>
02198 <span class="comment">    None.</span>
02199 <span class="comment"></span>
02200 <span class="comment">Return Value:</span>
02201 <span class="comment"></span>
02202 <span class="comment">    None.</span>
02203 <span class="comment"></span>
02204 <span class="comment">Environment:</span>
02205 <span class="comment"></span>
02206 <span class="comment">    Kernel Mode Only.  System initialization.</span>
02207 <span class="comment"></span>
02208 <span class="comment">--*/</span>
02209 
02210 {
02211     SIZE_T <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02212     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02213     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
02214     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
02215     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpeEnd;
02216     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02217     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02218     PFN_NUMBER PageFrameIndex;
02219     KIRQL OldIrql;
02220     ULONG i;
02221 
02222 <span class="preprocessor">#if !defined (_WIN64)</span>
02223 <span class="preprocessor"></span>
02224     <span class="comment">//</span>
02225     <span class="comment">// Double map system page directory page.</span>
02226     <span class="comment">//</span>
02227 
02228 <span class="preprocessor">#if defined (_X86PAE_)</span>
02229 <span class="preprocessor"></span>
02230     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PDE_BASE);
02231 
02232     <span class="keywordflow">for</span> (i = 0 ; i &lt; PD_PER_SYSTEM; i += 1) {
02233         <a class="code" href="../../d4/d8/mi_8h.html#a637">MmSystemPageDirectory</a>[i] = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
02234         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(<a class="code" href="../../d4/d8/mi_8h.html#a637">MmSystemPageDirectory</a>[i]);
02235         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
02236         PointerPte += 1;
02237     }
02238 
02239     <span class="comment">//</span>
02240     <span class="comment">// Was not mapped physically, map it virtually in system space.</span>
02241     <span class="comment">//</span>
02242 
02243     PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (
02244                                 PD_PER_SYSTEM,
02245                                 <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>,
02246                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a58">MM_COLOR_ALIGNMENT</a>,
02247                                 ((ULONG_PTR)PDE_BASE &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a59">MM_COLOR_MASK_VIRTUAL</a>),
02248                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02249 
02250     <a class="code" href="../../d4/d8/mi_8h.html#a636">MmSystemPagePtes</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02251 
02252     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a7">ValidKernelPde</a>;
02253 
02254     <span class="keywordflow">for</span> (i = 0 ; i &lt; PD_PER_SYSTEM; i += 1) {
02255         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = <a class="code" href="../../d4/d8/mi_8h.html#a637">MmSystemPageDirectory</a>[i];
02256         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
02257         PointerPte += 1;
02258     }
02259 
02260 <span class="preprocessor">#else</span>
02261 <span class="preprocessor"></span>
02262     <a class="code" href="../../d4/d8/mi_8h.html#a637">MmSystemPageDirectory</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PDE_BASE));
02263 
02264     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(<a class="code" href="../../d4/d8/mi_8h.html#a637">MmSystemPageDirectory</a>);
02265 
02266     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
02267 
02268     <a class="code" href="../../d4/d8/mi_8h.html#a636">MmSystemPagePtes</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (<a class="code" href="../../d4/d8/mi_8h.html#a637">MmSystemPageDirectory</a>,
02269                                                       &amp;OldIrql);
02270     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02271 
02272     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(<a class="code" href="../../d4/d8/mi_8h.html#a636">MmSystemPagePtes</a>)) {
02273 
02274         <span class="comment">//</span>
02275         <span class="comment">// Was not mapped physically, map it virtually in system space.</span>
02276         <span class="comment">//</span>
02277 
02278         PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (
02279                                     1,
02280                                     <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>,
02281                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a58">MM_COLOR_ALIGNMENT</a>,
02282                                     ((ULONG_PTR)PDE_BASE &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a59">MM_COLOR_MASK_VIRTUAL</a>),
02283                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02284         TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a7">ValidKernelPde</a>;
02285         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = <a class="code" href="../../d4/d8/mi_8h.html#a637">MmSystemPageDirectory</a>;
02286         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
02287         <a class="code" href="../../d4/d8/mi_8h.html#a636">MmSystemPagePtes</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02288     }
02289 <span class="preprocessor">#endif</span>
02290 <span class="preprocessor"></span>
02291 <span class="preprocessor">#endif</span>
02292 <span class="preprocessor"></span>
02293     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/allocpag_8c.html#a10">MmPagedPoolMaximumDesired</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02294         <a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> =
02295                     ((PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> - (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>);
02296     }
02297 
02298     <span class="comment">//</span>
02299     <span class="comment">// A size of 0 means size the pool based on physical memory.</span>
02300     <span class="comment">//</span>
02301 
02302     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> == 0) {
02303         <a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> = 2 * <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a>;
02304     }
02305 
02306     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/mminit_8c.html#a58">MmIsThisAnNtAsSystem</a>()) {
02307         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt; ((24*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) &amp;&amp;
02308             (<a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a12">MM_MINIMUM_PAGED_POOL_NTAS</a>)) {
02309 
02310             <a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> = <a class="code" href="../../d4/d8/mi_8h.html#a12">MM_MINIMUM_PAGED_POOL_NTAS</a>;
02311         }
02312     }
02313 
02314     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> &gt;
02315               (ULONG_PTR)((PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> - (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>)) {
02316         <a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> =
02317                     ((PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> - (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>);
02318     }
02319 
02320     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(<a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a>);
02321 
02322     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt; <a class="code" href="../../d5/d1/mminit_8c.html#a3">MM_MIN_INITIAL_PAGED_POOL</a>) {
02323         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d5/d1/mminit_8c.html#a3">MM_MIN_INITIAL_PAGED_POOL</a>;
02324     }
02325 
02326     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a32">MM_MAX_PAGED_POOL</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
02327         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a32">MM_MAX_PAGED_POOL</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
02328     }
02329 
02330     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a> - 1)) / <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>;
02331     <a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> = (ULONG_PTR)<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> * <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>;
02332 
02333     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> + (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>) &lt;=
02334             (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>);
02335 
02336     <span class="comment">//</span>
02337     <span class="comment">// Set size to the number of pages in the pool.</span>
02338     <span class="comment">//</span>
02339 
02340     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> * <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>;
02341 
02342     <a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a> = (PVOID)(((PUCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a> +
02343                             <a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a>) - 1);
02344 
02345     <a class="code" href="../../d4/d8/mi_8h.html#a653">MmPageAlignedPoolBase</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] = <a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>;
02346 
02347     <span class="comment">//</span>
02348     <span class="comment">// Build page table page for paged pool.</span>
02349     <span class="comment">//</span>
02350 
02351     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>);
02352     <a class="code" href="../../d4/d8/mi_8h.html#a638">MmPagedPoolBasePde</a> = PointerPde;
02353 
02354     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a7">ValidKernelPde</a>;
02355 
02356 <span class="preprocessor">#if defined (_WIN64)</span>
02357 <span class="preprocessor"></span>
02358     <span class="comment">//</span>
02359     <span class="comment">// Map in all the page directory pages to span all of paged pool.</span>
02360     <span class="comment">// This removes the need for a system lookup directory.</span>
02361     <span class="comment">//</span>
02362 
02363     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>);
02364     PointerPpeEnd = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a>);
02365 
02366     <span class="keywordflow">while</span> (PointerPpe &lt;= PointerPpeEnd) {
02367 
02368         <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
02369             PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
02370                                      <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (PointerPpe));
02371             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
02372             *PointerPpe = TempPte;
02373 
02374             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
02375             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (
02376                                      <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d9/d8/axp64_2mialpha_8h.html#a5">PDE_KTBASE</a>));
02377             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPpe;
02378             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 1;
02379             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
02380             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
02381             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
02382         }
02383 
02384         PointerPpe += 1;
02385     }
02386 
02387 <span class="preprocessor">#endif</span>
02388 <span class="preprocessor"></span>
02389     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>);
02390     <a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>.FirstPteForPagedPool = PointerPte;
02391     <a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>.LastPteForPagedPool = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a>);
02392 
02393     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (PointerPde,
02394                      <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>) *
02395                          (1 + <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a>) - PointerPde),
02396                      <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a97">MM_KERNEL_NOACCESS_PTE</a>);
02397 
02398     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02399 
02400     <span class="comment">//</span>
02401     <span class="comment">// Map in a page table page.</span>
02402     <span class="comment">//</span>
02403 
02404     PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
02405                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (PointerPde));
02406     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
02407     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPde, TempPte);
02408 
02409     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
02410 <span class="preprocessor">#if defined (_WIN64)</span>
02411 <span class="preprocessor"></span>    Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>));
02412 <span class="preprocessor">#else</span>
02413 <span class="preprocessor"></span><span class="preprocessor">#if !defined (_X86PAE_)</span>
02414 <span class="preprocessor"></span>    Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d4/d8/mi_8h.html#a637">MmSystemPageDirectory</a>;
02415 <span class="preprocessor">#else</span>
02416 <span class="preprocessor"></span>    Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d4/d8/mi_8h.html#a637">MmSystemPageDirectory</a>[(PointerPde - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(0)) / <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a>];
02417 <span class="preprocessor">#endif</span>
02418 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02419 <span class="preprocessor"></span>    Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPde;
02420     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 1;
02421     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
02422     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
02423     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
02424     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (PointerPte, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a97">MM_KERNEL_NOACCESS_PTE</a>);
02425 
02426     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02427 
02428     <a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>.NextPdeForPagedPoolExpansion = PointerPde + 1;
02429 
02430     <span class="comment">//</span>
02431     <span class="comment">// Build bitmaps for paged pool.</span>
02432     <span class="comment">//</span>
02433 
02434     <a class="code" href="../../d4/d8/mi_8h.html#a233">MiCreateBitMap</a> (&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>.PagedPoolAllocationMap, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
02435     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a28">RtlSetAllBits</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>.PagedPoolAllocationMap);
02436 
02437     <span class="comment">//</span>
02438     <span class="comment">// Indicate first page worth of PTEs are available.</span>
02439     <span class="comment">//</span>
02440 
02441     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>.PagedPoolAllocationMap, 0, <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>);
02442 
02443     <a class="code" href="../../d4/d8/mi_8h.html#a233">MiCreateBitMap</a> (&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>.EndOfPagedPoolBitmap, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
02444     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>.EndOfPagedPoolBitmap);
02445 
02446     <span class="comment">//</span>
02447     <span class="comment">// If verifier is present then build the verifier paged pool bitmap.</span>
02448     <span class="comment">//</span>
02449 
02450     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a10">MmVerifyDriverBufferLength</a> != (ULONG)-1) {
02451         <a class="code" href="../../d4/d8/mi_8h.html#a233">MiCreateBitMap</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a654">VerifierLargePagedPoolMap</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
02452         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a> (<a class="code" href="../../d4/d8/mi_8h.html#a654">VerifierLargePagedPoolMap</a>);
02453     }
02454 
02455     <span class="comment">//</span>
02456     <span class="comment">// Initialize paged pool.</span>
02457     <span class="comment">//</span>
02458 
02459     <a class="code" href="../../d5/d8/ex_8h.html#a215">InitializePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02460 
02461     <a class="code" href="../../d5/d1/mminit_8c.html#a44">MiInitializeSpecialPool</a>();
02462 
02463     <span class="comment">//</span>
02464     <span class="comment">// Allow mapping of views into system space.</span>
02465     <span class="comment">//</span>
02466 
02467     <a class="code" href="../../d4/d8/mi_8h.html#a779">MiInitializeSystemSpaceMap</a> ((PVOID)0);
02468 
02469     <span class="keywordflow">return</span>;
02470 }
02471 
02472 
02473 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02474"></a><a class="code" href="../../d5/d1/mminit_8c.html#a55">02474</a> <a class="code" href="../../d5/d1/mminit_8c.html#a55">MiFindInitializationCode</a> (
02475     OUT PVOID *StartVa,
02476     OUT PVOID *EndVa
02477     )
02478 
02479 <span class="comment">/*++</span>
02480 <span class="comment"></span>
02481 <span class="comment">Routine Description:</span>
02482 <span class="comment"></span>
02483 <span class="comment">    This function locates the start and end of the kernel initialization</span>
02484 <span class="comment">    code.  This code resides in the "init" section of the kernel image.</span>
02485 <span class="comment"></span>
02486 <span class="comment">Arguments:</span>
02487 <span class="comment"></span>
02488 <span class="comment">    StartVa - Returns the starting address of the init section.</span>
02489 <span class="comment"></span>
02490 <span class="comment">    EndVa - Returns the ending address of the init section.</span>
02491 <span class="comment"></span>
02492 <span class="comment">Return Value:</span>
02493 <span class="comment"></span>
02494 <span class="comment">    None.</span>
02495 <span class="comment"></span>
02496 <span class="comment">Environment:</span>
02497 <span class="comment"></span>
02498 <span class="comment">    Kernel Mode Only.  End of system initialization.</span>
02499 <span class="comment"></span>
02500 <span class="comment">--*/</span>
02501 
02502 {
02503     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
02504     PVOID CurrentBase;
02505     PVOID InitStart;
02506     PVOID InitEnd;
02507     PLIST_ENTRY Next;
02508     PIMAGE_NT_HEADERS NtHeader;
02509     PIMAGE_SECTION_HEADER SectionTableEntry;
02510     PIMAGE_SECTION_HEADER LastDiscard;
02511     LONG i;
02512     PVOID MiFindInitializationCodeAddress;
02513 
02514     MiFindInitializationCodeAddress = MmGetProcedureAddress((PVOID)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a780">MiFindInitializationCode</a>);
02515 
02516     *StartVa = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02517 
02518     <span class="comment">//</span>
02519     <span class="comment">// Walk through the loader blocks looking for the base which</span>
02520     <span class="comment">// contains this routine.</span>
02521     <span class="comment">//</span>
02522 
02523     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02524     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02525     Next = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
02526 
02527     <span class="keywordflow">while</span> ( Next != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a> ) {
02528         LdrDataTableEntry = CONTAINING_RECORD( Next,
02529                                                LDR_DATA_TABLE_ENTRY,
02530                                                InLoadOrderLinks
02531                                              );
02532         <span class="keywordflow">if</span> (LdrDataTableEntry-&gt;SectionPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02533 
02534             <span class="comment">//</span>
02535             <span class="comment">// This entry was loaded by MmLoadSystemImage so it's already</span>
02536             <span class="comment">// had its init section removed.</span>
02537             <span class="comment">//</span>
02538 
02539             Next = Next-&gt;Flink;
02540             <span class="keywordflow">continue</span>;
02541         }
02542 
02543         CurrentBase = (PVOID)LdrDataTableEntry-&gt;DllBase;
02544         NtHeader = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(CurrentBase);
02545 
02546         SectionTableEntry = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeader +
02547                                 <span class="keyword">sizeof</span>(ULONG) +
02548                                 <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
02549                                 NtHeader-&gt;FileHeader.SizeOfOptionalHeader);
02550 
02551         <span class="comment">//</span>
02552         <span class="comment">// From the image header, locate the section named 'INIT'.</span>
02553         <span class="comment">//</span>
02554 
02555         i = NtHeader-&gt;FileHeader.NumberOfSections;
02556 
02557         InitStart = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02558         <span class="keywordflow">while</span> (i &gt; 0) {
02559 
02560 <span class="preprocessor">#if DBG</span>
02561 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((*(PULONG)SectionTableEntry-&gt;Name == 'tini') ||
02562                 (*(PULONG)SectionTableEntry-&gt;Name == 'egap')) {
02563                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"driver %wZ has lower case sections (init or pagexxx)\n"</span>,
02564                     &amp;LdrDataTableEntry-&gt;FullDllName);
02565             }
02566 <span class="preprocessor">#endif //DBG</span>
02567 <span class="preprocessor"></span>
02568             <span class="comment">//</span>
02569             <span class="comment">// Free any INIT sections (or relocation sections that haven't</span>
02570             <span class="comment">// been already).  Note a driver may have a relocation section</span>
02571             <span class="comment">// but not have any INIT code.</span>
02572             <span class="comment">//</span>
02573 
02574             <span class="keywordflow">if</span> ((*(PULONG)SectionTableEntry-&gt;Name == 'TINI') ||
02575                 ((SectionTableEntry-&gt;Characteristics &amp; IMAGE_SCN_MEM_DISCARDABLE) != 0)) {
02576 
02577 
02578                 InitStart = (PVOID)((PCHAR)CurrentBase + SectionTableEntry-&gt;VirtualAddress);
02579                 InitEnd = (PVOID)((PCHAR)InitStart + SectionTableEntry-&gt;SizeOfRawData - 1);
02580                 InitEnd = (PVOID)((PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> ((PCHAR)InitEnd +
02581                         (NtHeader-&gt;OptionalHeader.SectionAlignment - 1)) - 1);
02582                 InitStart = (PVOID)<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (InitStart);
02583 
02584                 <span class="comment">//</span>
02585                 <span class="comment">// Check if more sections are discardable after this one so</span>
02586                 <span class="comment">// even small INIT sections can be discarded.</span>
02587                 <span class="comment">//</span>
02588 
02589                 <span class="keywordflow">if</span> (i == 1) {
02590                     LastDiscard = SectionTableEntry;
02591                 }
02592                 <span class="keywordflow">else</span> {
02593                     LastDiscard = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02594                     <span class="keywordflow">do</span> {
02595                         i -= 1;
02596                         SectionTableEntry += 1;
02597     
02598                         <span class="keywordflow">if</span> ((SectionTableEntry-&gt;Characteristics &amp;
02599                              IMAGE_SCN_MEM_DISCARDABLE) != 0) {
02600     
02601                             <span class="comment">//</span>
02602                             <span class="comment">// Discard this too.</span>
02603                             <span class="comment">//</span>
02604     
02605                             LastDiscard = SectionTableEntry;
02606                         } <span class="keywordflow">else</span> {
02607                             <span class="keywordflow">break</span>;
02608                         }
02609                     } <span class="keywordflow">while</span> (i &gt; 1);
02610                 }
02611 
02612                 <span class="keywordflow">if</span> (LastDiscard) {
02613                     InitEnd = (PVOID)(((PCHAR)CurrentBase +
02614                                        LastDiscard-&gt;VirtualAddress) +
02615                                       (LastDiscard-&gt;SizeOfRawData - 1));
02616 
02617                     <span class="comment">//</span>
02618                     <span class="comment">// If this isn't the last section in the driver then the</span>
02619                     <span class="comment">// the next section is not discardable.  So the last</span>
02620                     <span class="comment">// section is not rounded down, but all others must be.</span>
02621                     <span class="comment">//</span>
02622 
02623                     <span class="keywordflow">if</span> (i != 1) {
02624                         InitEnd = (PVOID)((PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> ((PCHAR)InitEnd +
02625                                                              (NtHeader-&gt;OptionalHeader.SectionAlignment - 1)) - 1);
02626                     }
02627                 }
02628 
02629                 <span class="keywordflow">if</span> (InitEnd &gt; (PVOID)((PCHAR)CurrentBase +
02630                                       LdrDataTableEntry-&gt;SizeOfImage)) {
02631                     InitEnd = (PVOID)(((ULONG_PTR)CurrentBase +
02632                                        (LdrDataTableEntry-&gt;SizeOfImage - 1)) |
02633                                       (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
02634                 }
02635 
02636                 <span class="keywordflow">if</span> (InitStart &lt;= InitEnd) {
02637                     <span class="keywordflow">if</span> ((MiFindInitializationCodeAddress &gt;= InitStart) &amp;&amp;
02638                         (MiFindInitializationCodeAddress &lt;= InitEnd)) {
02639 
02640                         <span class="comment">//</span>
02641                         <span class="comment">// This init section is in the kernel, don't free it</span>
02642                         <span class="comment">// now as it would free this code!</span>
02643                         <span class="comment">//</span>
02644 
02645                         *StartVa = InitStart;
02646                         *EndVa = InitEnd;
02647                     }
02648                     <span class="keywordflow">else</span> {
02649                         <a class="code" href="../../d5/d1/mminit_8c.html#a56">MiFreeInitializationCode</a> (InitStart, InitEnd);
02650                     }
02651                 }
02652             }
02653             i -= 1;
02654             SectionTableEntry += 1;
02655         }
02656         Next = Next-&gt;Flink;
02657     }
02658     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>);
02659     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02660     <span class="keywordflow">return</span>;
02661 }
02662 
02663 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02664"></a><a class="code" href="../../d5/d1/mminit_8c.html#a56">02664</a> <a class="code" href="../../d5/d1/mminit_8c.html#a56">MiFreeInitializationCode</a> (
02665     IN PVOID StartVa,
02666     IN PVOID EndVa
02667     )
02668 
02669 <span class="comment">/*++</span>
02670 <span class="comment"></span>
02671 <span class="comment">Routine Description:</span>
02672 <span class="comment"></span>
02673 <span class="comment">    This function is called to delete the initialization code.</span>
02674 <span class="comment"></span>
02675 <span class="comment">Arguments:</span>
02676 <span class="comment"></span>
02677 <span class="comment">    StartVa - Supplies the starting address of the range to delete.</span>
02678 <span class="comment"></span>
02679 <span class="comment">    EndVa - Supplies the ending address of the range to delete.</span>
02680 <span class="comment"></span>
02681 <span class="comment">Return Value:</span>
02682 <span class="comment"></span>
02683 <span class="comment">    None.</span>
02684 <span class="comment"></span>
02685 <span class="comment">Environment:</span>
02686 <span class="comment"></span>
02687 <span class="comment">    Kernel Mode Only.  Runs after system initialization.</span>
02688 <span class="comment"></span>
02689 <span class="comment">--*/</span>
02690 
02691 {
02692     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02693     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02694     PFN_NUMBER PageFrameIndex;
02695     KIRQL OldIrql;
02696     PVOID UnlockHandle;
02697 
02698     UnlockHandle = MmLockPagableCodeSection((PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a781">MiFreeInitializationCode</a>);
02699     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(UnlockHandle);
02700 
02701     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(StartVa)) {
02702         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02703         <span class="keywordflow">while</span> (StartVa &lt; EndVa) {
02704 
02705             <span class="comment">//</span>
02706             <span class="comment">// On certain architectures (e.g., MIPS) virtual addresses</span>
02707             <span class="comment">// may be physical and hence have no corresponding PTE.</span>
02708             <span class="comment">//</span>
02709 
02710             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (StartVa);
02711 
02712             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02713             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
02714             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;
02715             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
02716             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>], PageFrameIndex);
02717             StartVa = (PVOID)((PUCHAR)StartVa + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02718         }
02719         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02720     } <span class="keywordflow">else</span> {
02721         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartVa);
02722         <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (PointerPte,
02723                                  (PFN_NUMBER) (1 + <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndVa) -
02724                                      PointerPte),
02725                                  <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>,
02726                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02727                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02728     }
02729     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(UnlockHandle);
02730     <span class="keywordflow">return</span>;
02731 }
02732 
02733 
02734 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02735"></a><a class="code" href="../../d5/d1/mminit_8c.html#a45">02735</a> <a class="code" href="../../d5/d1/mminit_8c.html#a45">MiEnablePagingTheExecutive</a> (
02736     VOID
02737     )
02738 
02739 <span class="comment">/*++</span>
02740 <span class="comment"></span>
02741 <span class="comment">Routine Description:</span>
02742 <span class="comment"></span>
02743 <span class="comment">    This function locates the start and end of the kernel initialization</span>
02744 <span class="comment">    code.  This code resides in the "init" section of the kernel image.</span>
02745 <span class="comment"></span>
02746 <span class="comment">Arguments:</span>
02747 <span class="comment"></span>
02748 <span class="comment">    StartVa - Returns the starting address of the init section.</span>
02749 <span class="comment"></span>
02750 <span class="comment">    EndVa - Returns the ending address of the init section.</span>
02751 <span class="comment"></span>
02752 <span class="comment">Return Value:</span>
02753 <span class="comment"></span>
02754 <span class="comment">    None.</span>
02755 <span class="comment"></span>
02756 <span class="comment">Environment:</span>
02757 <span class="comment"></span>
02758 <span class="comment">    Kernel Mode Only.  End of system initialization.</span>
02759 <span class="comment"></span>
02760 <span class="comment">--*/</span>
02761 
02762 {
02763     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
02764     PVOID CurrentBase;
02765     PLIST_ENTRY Next;
02766     PIMAGE_NT_HEADERS NtHeader;
02767     PIMAGE_SECTION_HEADER SectionTableEntry;
02768     LONG i;
02769     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02770     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02771     BOOLEAN PageSection;
02772     PVOID SectionBaseAddress;
02773 
02774     <span class="comment">//</span>
02775     <span class="comment">// Don't page kernel mode code if customer does not want it paged or if</span>
02776     <span class="comment">// this is a diskless remote boot client.</span>
02777     <span class="comment">//</span>
02778 
02779     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a26">MmDisablePagingExecutive</a>
02780 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
02781 <span class="preprocessor"></span>        || (<a class="code" href="../../d0/d5/io_8h.html#a399">IoRemoteBootClient</a> &amp;&amp; IoCscInitializationFailed)
02782 <span class="preprocessor">#endif</span>
02783 <span class="preprocessor"></span>        ) {
02784         <span class="keywordflow">return</span>;
02785     }
02786 
02787     <span class="comment">//</span>
02788     <span class="comment">// Walk through the loader blocks looking for the base which</span>
02789     <span class="comment">// contains this routine.</span>
02790     <span class="comment">//</span>
02791 
02792     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02793     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02794     Next = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
02795     <span class="keywordflow">while</span> ( Next != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a> ) {
02796         LdrDataTableEntry = CONTAINING_RECORD( Next,
02797                                                LDR_DATA_TABLE_ENTRY,
02798                                                InLoadOrderLinks
02799                                              );
02800         <span class="keywordflow">if</span> (LdrDataTableEntry-&gt;SectionPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02801 
02802             <span class="comment">//</span>
02803             <span class="comment">// This entry was loaded by MmLoadSystemImage so it's already paged.</span>
02804             <span class="comment">//</span>
02805 
02806             Next = Next-&gt;Flink;
02807             <span class="keywordflow">continue</span>;
02808         }
02809 
02810         CurrentBase = (PVOID)LdrDataTableEntry-&gt;DllBase;
02811         NtHeader = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(CurrentBase);
02812 
02813         SectionTableEntry = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeader +
02814                                 <span class="keyword">sizeof</span>(ULONG) +
02815                                 <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
02816                                 NtHeader-&gt;FileHeader.SizeOfOptionalHeader);
02817 
02818         <span class="comment">//</span>
02819         <span class="comment">// From the image header, locate the section named 'PAGE' or</span>
02820         <span class="comment">// '.edata'.</span>
02821         <span class="comment">//</span>
02822 
02823         i = NtHeader-&gt;FileHeader.NumberOfSections;
02824 
02825         PointerPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02826 
02827         <span class="keywordflow">while</span> (i &gt; 0) {
02828 
02829             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a> (CurrentBase)) {
02830 
02831                 <span class="comment">//</span>
02832                 <span class="comment">// Mapped physically, can't be paged.</span>
02833                 <span class="comment">//</span>
02834 
02835                 <span class="keywordflow">break</span>;
02836             }
02837 
02838             SectionBaseAddress = <a class="code" href="../../d4/d8/mi_8h.html#a217">SECTION_BASE_ADDRESS</a>(SectionTableEntry);
02839 
02840             PageSection = ((*(PULONG)SectionTableEntry-&gt;Name == 'EGAP') ||
02841                           (*(PULONG)SectionTableEntry-&gt;Name == 'ade.')) &amp;&amp;
02842                            (SectionBaseAddress !=
02843                             ((PUCHAR)CurrentBase + SectionTableEntry-&gt;VirtualAddress));
02844 
02845             <span class="keywordflow">if</span> (*(PULONG)SectionTableEntry-&gt;Name == 'EGAP' &amp;&amp;
02846                 SectionTableEntry-&gt;Name[4] == <span class="charliteral">'K'</span>  &amp;&amp;
02847                 SectionTableEntry-&gt;Name[5] == <span class="charliteral">'D'</span>) {
02848 
02849                 <span class="comment">//</span>
02850                 <span class="comment">// Only pageout PAGEKD if KdPitchDebugger is TRUE.</span>
02851                 <span class="comment">//</span>
02852 
02853                 PageSection = <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a>;
02854             }
02855 
02856             <span class="keywordflow">if</span> ((*(PULONG)SectionTableEntry-&gt;Name == 'EGAP') &amp;&amp;
02857                 (*(PULONG)&amp;SectionTableEntry-&gt;Name[4] == 'RDYH')) {
02858 
02859                 <span class="comment">//</span>
02860                 <span class="comment">// Pageout PAGEHYDRA on non Hydra systems.</span>
02861                 <span class="comment">//</span>
02862 
02863                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02864                     PageSection = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02865                 }
02866             }
02867 
02868             <span class="keywordflow">if</span> ((*(PULONG)SectionTableEntry-&gt;Name == 'EGAP') &amp;&amp;
02869                 (*(PULONG)&amp;SectionTableEntry-&gt;Name[4] == 'YFRV')) {
02870 
02871                 <span class="comment">//</span>
02872                 <span class="comment">// Pageout PAGEVRFY if no drivers are being instrumented.</span>
02873                 <span class="comment">//</span>
02874 
02875                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a10">MmVerifyDriverBufferLength</a> != (ULONG)-1) {
02876                     PageSection = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02877                 }
02878             }
02879 
02880             <span class="keywordflow">if</span> ((*(PULONG)SectionTableEntry-&gt;Name == 'EGAP') &amp;&amp;
02881                 (*(PULONG)&amp;SectionTableEntry-&gt;Name[4] == 'CEPS')) {
02882 
02883                 <span class="comment">//</span>
02884                 <span class="comment">// Pageout PAGESPEC special pool code if it's not enabled.</span>
02885                 <span class="comment">//</span>
02886 
02887                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/allocpag_8c.html#a26">MiSpecialPoolPtes</a> != 0) {
02888                     PageSection = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02889                 }
02890             }
02891 
02892             <span class="keywordflow">if</span> (PageSection) {
02893                  <span class="comment">//</span>
02894                  <span class="comment">// This section is pagable, save away the start and end.</span>
02895                  <span class="comment">//</span>
02896 
02897                  <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02898 
02899                      <span class="comment">//</span>
02900                      <span class="comment">// Previous section was NOT pagable, get the start address.</span>
02901                      <span class="comment">//</span>
02902 
02903                      PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (
02904                                   (ULONG_PTR)CurrentBase +
02905                                   SectionTableEntry-&gt;VirtualAddress));
02906                  }
02907                  LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((ULONG_PTR)CurrentBase +
02908                              SectionTableEntry-&gt;VirtualAddress +
02909                              (NtHeader-&gt;OptionalHeader.SectionAlignment - 1) +
02910                              SectionTableEntry-&gt;SizeOfRawData -
02911                              <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02912 
02913             } <span class="keywordflow">else</span> {
02914 
02915                 <span class="comment">//</span>
02916                 <span class="comment">// This section is not pagable, if the previous section was</span>
02917                 <span class="comment">// pagable, enable it.</span>
02918                 <span class="comment">//</span>
02919 
02920                 <span class="keywordflow">if</span> (PointerPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02921                     <a class="code" href="../../d5/d1/mminit_8c.html#a46">MiEnablePagingOfDriverAtInit</a> (PointerPte, LastPte);
02922                     PointerPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02923                 }
02924             }
02925             i -= 1;
02926             SectionTableEntry += 1;
02927         } <span class="comment">//end while</span>
02928 
02929         <span class="keywordflow">if</span> (PointerPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02930             <a class="code" href="../../d5/d1/mminit_8c.html#a46">MiEnablePagingOfDriverAtInit</a> (PointerPte, LastPte);
02931         }
02932 
02933         Next = Next-&gt;Flink;
02934     } <span class="comment">//end while</span>
02935 
02936     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>);
02937     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02938 
02939     <span class="keywordflow">return</span>;
02940 }
02941 
02942 
02943 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02944"></a><a class="code" href="../../d5/d1/mminit_8c.html#a46">02944</a> <a class="code" href="../../d5/d1/mminit_8c.html#a46">MiEnablePagingOfDriverAtInit</a> (
02945     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
02946     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte
02947     )
02948 
02949 <span class="comment">/*++</span>
02950 <span class="comment"></span>
02951 <span class="comment">Routine Description:</span>
02952 <span class="comment"></span>
02953 <span class="comment">    This routine marks the specified range of PTEs as pagable.</span>
02954 <span class="comment"></span>
02955 <span class="comment">Arguments:</span>
02956 <span class="comment"></span>
02957 <span class="comment">    PointerPte - Supplies the starting PTE.</span>
02958 <span class="comment"></span>
02959 <span class="comment">    LastPte - Supplies the ending PTE.</span>
02960 <span class="comment"></span>
02961 <span class="comment">Return Value:</span>
02962 <span class="comment"></span>
02963 <span class="comment">    None.</span>
02964 <span class="comment"></span>
02965 <span class="comment">--*/</span>
02966 
02967 {
02968     PVOID Base;
02969     PFN_NUMBER PageFrameIndex;
02970     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn;
02971     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02972     KIRQL OldIrql;
02973     KIRQL OldIrqlWs;
02974     LOGICAL SessionAddress;
02975 
02976     Base = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02977     SessionAddress = <a class="code" href="../../d4/d8/mi_8h.html#a355">MI_IS_SESSION_PTE</a> (PointerPte);
02978 
02979     <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrqlWs);
02980     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02981 
02982     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
02983 
02984         <span class="comment">//</span>
02985         <span class="comment">// The PTE must be carefully checked as drivers may call MmPageEntire</span>
02986         <span class="comment">// during their DriverEntry yet faults may occur prior to this routine</span>
02987         <span class="comment">// running which cause pages to already be resident and in the working</span>
02988         <span class="comment">// set at this point.  So checks for validity and wsindex must be</span>
02989         <span class="comment">// applied.</span>
02990         <span class="comment">//</span>
02991 
02992         <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 1) {
02993             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
02994             Pfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02995             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
02996     
02997             <span class="keywordflow">if</span> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0) {
02998 
02999                 <span class="comment">//</span>
03000                 <span class="comment">// Set the working set index to zero.  This allows page table</span>
03001                 <span class="comment">// pages to be brought back in with the proper WSINDEX.</span>
03002                 <span class="comment">//</span>
03003     
03004                 <a class="code" href="../../d4/d8/mi_8h.html#a190">MI_ZERO_WSINDEX</a> (Pfn);
03005 
03006                 <span class="comment">//</span>
03007                 <span class="comment">// Original PTE may need to be set for drivers loaded via</span>
03008                 <span class="comment">// ntldr.</span>
03009                 <span class="comment">//</span>
03010 
03011                 <span class="keywordflow">if</span> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
03012                     Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a96">MM_KERNEL_DEMAND_ZERO_PTE</a>;
03013 <span class="preprocessor">#if defined(_IA64_)</span>
03014 <span class="preprocessor"></span>                    Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection |= <a class="code" href="../../d4/d8/mi_8h.html#a37">MM_EXECUTE</a>;
03015 <span class="preprocessor">#endif</span>
03016 <span class="preprocessor"></span>                }
03017 
03018                 Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
03019                 TempPte = *PointerPte;
03020         
03021                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
03022                                               Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
03023         
03024                 <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (Base,
03025                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03026                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03027                                  (PHARDWARE_PTE)PointerPte,
03028                                  TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
03029         
03030                 <span class="comment">//</span>
03031                 <span class="comment">// Flush the translation buffer and decrement the number of valid</span>
03032                 <span class="comment">// PTEs within the containing page table page.  Note that for a</span>
03033                 <span class="comment">// private page, the page table page is still needed because the</span>
03034                 <span class="comment">// page is in transition.</span>
03035                 <span class="comment">//</span>
03036         
03037                 <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PageFrameIndex);
03038     
03039                 <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += 1;
03040                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a13">MmTotalSystemCodePages</a> += 1;
03041             }
03042             <span class="keywordflow">else</span> {
03043 
03044                 <span class="comment">//</span>
03045                 <span class="comment">// This would need to be taken out of the WSLEs so skip it for</span>
03046                 <span class="comment">// now and let the normal paging algorithms remove it if we</span>
03047                 <span class="comment">// run into memory pressure.</span>
03048                 <span class="comment">//</span>
03049             }
03050 
03051         }
03052         Base = (PVOID)((PCHAR)Base + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03053         PointerPte += 1;
03054     }
03055 
03056     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03057     <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrqlWs);
03058 
03059     <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03060 
03061         <span class="comment">//</span>
03062         <span class="comment">// Session space has no ASN - flush the entire TB.</span>
03063         <span class="comment">//</span>
03064     
03065         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a200">MI_FLUSH_ENTIRE_SESSION_TB</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03066     }
03067 
03068     <span class="keywordflow">return</span>;
03069 }
03070 
03071 
03072 <a class="code" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a>
<a name="l03073"></a><a class="code" href="../../d5/d1/mminit_8c.html#a57">03073</a> <a class="code" href="../../d5/d1/mminit_8c.html#a57">MmQuerySystemSize</a>(
03074     VOID
03075     )
03076 {
03077     <span class="comment">//</span>
03078     <span class="comment">// 12Mb  is small</span>
03079     <span class="comment">// 12-19 is medium</span>
03080     <span class="comment">// &gt; 19 is large</span>
03081     <span class="comment">//</span>
03082     <span class="keywordflow">return</span> <a class="code" href="../../d5/d1/mminit_8c.html#a37">MmSystemSize</a>;
03083 }
03084 
03085 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
03086 BOOLEAN
<a name="l03087"></a><a class="code" href="../../d5/d1/mminit_8c.html#a58">03087</a> <a class="code" href="../../d5/d1/mminit_8c.html#a58">MmIsThisAnNtAsSystem</a>(
03088     VOID
03089     )
03090 {
03091     <span class="keywordflow">return</span> (BOOLEAN)<a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a>;
03092 }
03093 
03094 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
03095 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03096 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l03097"></a><a class="code" href="../../d5/d1/mminit_8c.html#a59">03097</a> <a class="code" href="../../d5/d1/mminit_8c.html#a59">MmSetPageFaultNotifyRoutine</a>(
03098     PPAGE_FAULT_NOTIFY_ROUTINE NotifyRoutine
03099     )
03100 {
03101     <a class="code" href="../../d4/d8/mi_8h.html#a746">MmPageFaultNotifyRoutine</a> = NotifyRoutine;
03102 }
03103 
03104 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
03105 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03106 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l03107"></a><a class="code" href="../../d5/d1/mminit_8c.html#a60">03107</a> <a class="code" href="../../d5/d1/mminit_8c.html#a60">MmSetHardFaultNotifyRoutine</a>(
03108     PHARD_FAULT_NOTIFY_ROUTINE NotifyRoutine
03109     )
03110 {
03111     <a class="code" href="../../d4/d8/mi_8h.html#a747">MmHardFaultNotifyRoutine</a> = NotifyRoutine;
03112 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:50 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
