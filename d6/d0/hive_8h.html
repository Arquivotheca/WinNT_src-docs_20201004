<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hive.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hive.h File Reference</h1><code>#include "<a class="el" href="../../d1/d0/hivedata_8h-source.html">hivedata.h</a>"</code><br>

<p>
<a href="../../d7/d9/hive_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a0">DHvCheckHive</a>(a)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a1">DHvCheckBin</a>(h, a)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(a, b)&nbsp;&nbsp;&nbsp;( ((ULONG)(a) + (ULONG)(b) - 1) &amp; ~((ULONG)(b) - 1) )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a3">ASSERT_LISTENTRY</a>(ListEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a7">HINIT_MEMORY_INPLACE</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a8">HINIT_FLAT</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a11">HIVE_HAS_BEEN_REPLACED</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)&nbsp;&nbsp;&nbsp;(((<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)-&gt;GetCellRoutine)(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a14">HvpAddBin</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG NewSize, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a15">HvpGetCellMap</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a16">HvpFreeMap</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> Dir, ULONG <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>, ULONG <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a15">End</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a17">HvpAllocateMap</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> Dir, ULONG <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>, ULONG <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a15">End</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a18">HvpGrowLog1</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG <a class="el" href="../../d6/d0/cmdat_8c.html#a5">Count</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a19">HvpGrowLog2</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a20">HvpHeaderCheckSum</a> (<a class="el" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a> BaseBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a21">HvpBuildMap</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, PVOID Image, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a22">HvpBuildMapAndCopy</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, PVOID Image, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a23">HvpInitMap</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a24">HvpCleanMap</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a25">HvpEnlistBinInMap</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG Length, <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="el" href="../../d9/d0/hivechek_8c.html#a6">Bin</a>, ULONG <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a26">HvpFreeAllocatedBins</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a27">HvpDoWriteHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG FileType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/struct__CELL__DATA.html">_CELL_DATA</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a28">HvpGetCellFlat</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/struct__CELL__DATA.html">_CELL_DATA</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a29">HvpGetCellPaged</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a30">HvpEnlistFreeCell</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type, BOOLEAN CoalesceForward, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a31">HvpEnlistFreeCells</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="el" href="../../d9/d0/hivechek_8c.html#a6">Bin</a>, ULONG BinOffset, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a32">HvpDelistFreeCell</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d8/d4/struct__HCELL.html">PHCELL</a> Pcell, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a33">HvInitializeHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG OperationType, ULONG HiveFlags, ULONG FileTypes, PVOID HiveData OPTIONAL, <a class="el" href="../../d0/d1/hivedata_8h.html#a63">PALLOCATE_ROUTINE</a> AllocateRoutine, <a class="el" href="../../d0/d1/hivedata_8h.html#a64">PFREE_ROUTINE</a> FreeRoutine, <a class="el" href="../../d0/d1/hivedata_8h.html#a65">PFILE_SET_SIZE_ROUTINE</a> FileSetSizeRoutine, <a class="el" href="../../d0/d1/hivedata_8h.html#a67">PFILE_WRITE_ROUTINE</a> FileWriteRoutine, <a class="el" href="../../d0/d1/hivedata_8h.html#a68">PFILE_READ_ROUTINE</a> FileReadRoutine, <a class="el" href="../../d0/d1/hivedata_8h.html#a69">PFILE_FLUSH_ROUTINE</a> FileFlushRoutine, ULONG Cluster, PUNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a34">HvSyncHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a35">HvWriteHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a36">HvLoadHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a37">HvRefreshHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a38">HvReadInMemoryHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, PVOID *HiveImage)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a39">HvCheckHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, PULONG Storage OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a40">HvCheckBin</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="el" href="../../d9/d0/hivechek_8c.html#a6">Bin</a>, PULONG Storage)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a41">HvMarkCellDirty</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a42">HvIsBinDirty</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a43">HvMarkDirty</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>, ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a44">HvMarkClean</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>, ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a45">HvGetCellSize</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, PVOID Address)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a46">HvAllocateCell</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG NewSize, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a47">HvFreeCell</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a48">HvReallocateCell</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, ULONG NewSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a49">HvIsCellAllocated</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a50">HvFreeHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d0/hive_8h.html#a51">HvFreeHivePartial</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a3" doxytag="hive.h::ASSERT_LISTENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_LISTENTRY          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ListEntry&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ListEntry)-&gt;Flink-&gt;Blink==ListEntry); \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ListEntry)-&gt;Blink-&gt;Flink==ListEntry);
</div></pre>
<p>
Definition at line <a class="el" href="../../d7/d9/hive_8h-source.html#l00058">58</a> of file <a class="el" href="../../d7/d9/hive_8h-source.html">hive.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01885">HvpDiscardBins()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="hive.h::DHvCheckBin" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DHvCheckBin          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">h,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/hive_8h-source.html#l00046">46</a> of file <a class="el" href="../../d7/d9/hive_8h-source.html">hive.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="hive.h::DHvCheckHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DHvCheckHive          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/hive_8h-source.html#l00045">45</a> of file <a class="el" href="../../d7/d9/hive_8h-source.html">hive.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="hive.h::HINIT_CREATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HINIT_CREATE&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/hive_8h-source.html#l00197">197</a> of file <a class="el" href="../../d7/d9/hive_8h-source.html">hive.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01439">CmpCreateTemporaryHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02422">CmpInitHiveFromFile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00156">EhOpenHive()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, and <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00405">MyCmpInitHiveFromFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="hive.h::HINIT_FILE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HINIT_FILE&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/hive_8h-source.html#l00199">199</a> of file <a class="el" href="../../d7/d9/hive_8h-source.html">hive.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02422">CmpInitHiveFromFile()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04077">CmpValidateAlternate()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00156">EhOpenHive()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, and <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00405">MyCmpInitHiveFromFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="hive.h::HINIT_FLAT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HINIT_FLAT&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/hive_8h-source.html#l00201">201</a> of file <a class="el" href="../../d7/d9/hive_8h-source.html">hive.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00050">CmGetSystemControlValues()</a>, and <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="hive.h::HINIT_MEMORY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HINIT_MEMORY&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/hive_8h-source.html#l00198">198</a> of file <a class="el" href="../../d7/d9/hive_8h-source.html">hive.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>, and <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="hive.h::HINIT_MEMORY_INPLACE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HINIT_MEMORY_INPLACE&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/hive_8h-source.html#l00200">200</a> of file <a class="el" href="../../d7/d9/hive_8h-source.html">hive.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, and <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="hive.h::HIVE_HAS_BEEN_REPLACED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HIVE_HAS_BEEN_REPLACED&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/hive_8h-source.html#l00205">205</a> of file <a class="el" href="../../d7/d9/hive_8h-source.html">hive.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="hive.h::HIVE_NOLAZYFLUSH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HIVE_NOLAZYFLUSH&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/hive_8h-source.html#l00204">204</a> of file <a class="el" href="../../d7/d9/hive_8h-source.html">hive.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01901">CmLoadKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02195">CmpDoFlushAll()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00731">CmpRefreshHive()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">HvMarkDirty()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01584">HvRefreshHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="hive.h::HIVE_VOLATILE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HIVE_VOLATILE&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">203</a> of file <a class="el" href="../../d7/d9/hive_8h-source.html">hive.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00050">CmGetSystemControlValues()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00042">CmpAddToHiveFileList()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01439">CmpCreateTemporaryHive()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00200">HvIsBinDirty()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00401">HvMarkClean()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">HvMarkDirty()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="hive.h::HvGetCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HvGetCell          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(((<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)-&gt;GetCellRoutine)(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">290</a> of file <a class="el" href="../../d7/d9/hive_8h-source.html">hive.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00285">CmEnumerateKey()</a>, <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00050">CmGetSystemControlValues()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00538">CmpAddDriverToList()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l02056">CmpAddInfoAfterParseFailure()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01087">CmpAddToLeaf()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00323">CmpCheckKey()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00210">CmpCheckRegistry2()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00588">CmpCheckValueList()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01009">CmpCopyCell()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00895">CmpCopyValue()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01328">CmpCreateRootNode()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00034">CmpDeleteTree()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00667">CmpDestroyHive()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00722">CmpDoCompareKeyName()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00833">CmpDoFindSubKeyByNumber()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01082">CmpFindControlSet()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00333">CmpFindDrivers()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01545">CmpFindMatchingDescriptorCell()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00033">CmpFindNameInList()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00108">CmpFindNLSData()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">CmpFindSubKeyByNumber()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00266">CmpFindSubKeyInRoot()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01693">CmpFindTagIndex()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01297">CmpFreeKeyBody()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01064">CmpFreeKeyValues()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01464">CmpFreeSecurityDescriptor()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00053">CmpFreeValue()</a>, <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00251">CmpGetHiveName()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01165">CmpGetKeySecurity()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01109">CmpGetObjectSecurity()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00403">CmpGetValueDataFromCache()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00200">CmpGetValueKeyFromCache()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00115">CmpGetValueListFromCache()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01704">CmpInsertSecurityCellList()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00473">CmpIsLoadType()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01608">CmpMarkIndexDirty()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00245">CmpMarkKeyDirty()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01870">CmpMarkKeyParentDirty()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01767">CmpMarkKeyValuesDirty()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01150">CmpMergeKeyValues()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00110">CmpQueryKeyData()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00847">CmpQuerySecurityDescriptorInfo()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00731">CmpRefreshHive()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01823">CmpRemoveSecurityCellList()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01714">CmpRemoveSubKey()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00191">CmpReportNotify()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01257">CmpSelectLeaf()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01221">CmpSetCurrentProfile()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00744">CmpSortDriverList()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01472">CmpSplitLeaf()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">CmpSyncKeyValues()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01648">CmpSyncSubKeysAfterDelete()</a>, <a class="el" href="../../d3/d9/cmchek2_8c-source.html#l00034">CmpValidateHiveSecurityDescriptors()</a>, <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00256">CmpWalkPath()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00940">CmQueryMultipleValueKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00625">EhCreateChild()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00156">EhOpenHive()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00988">EhpAttachSecurity()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01584">HvRefreshHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="hive.h::HvpGetHCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HvpGetHCell          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>( <a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive) ?                      \
                                  CONTAINING_RECORD(<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Cell),   \
                                                    <a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>,                  \
                                                    u.OldCell.u.UserData) : \
                                  CONTAINING_RECORD(<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>),   \
                                                    <a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>,                  \
                                                    u.NewCell.u.UserData))
</div></pre>
<p>
Definition at line <a class="el" href="../../d7/d9/hive_8h-source.html#l00292">292</a> of file <a class="el" href="../../d7/d9/hive_8h-source.html">hive.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01453">HvIsCellAllocated()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="hive.h::ROUND_UP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ROUND_UP          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( ((ULONG)(a) + (ULONG)(b) - 1) &amp; ~((ULONG)(b) - 1) )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">49</a> of file <a class="el" href="../../d7/d9/hive_8h-source.html">hive.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00278">ExAllocatePool()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03060">ExpGetProcessInformation()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00401">HvMarkClean()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">HvMarkDirty()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01233">HvpFindNextDirtyBlock()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00495">HvpGrowLog1()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00565">HvpGrowLog2()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00304">HvpInitMap()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00847">HvpRecoverData()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01025">HvpWriteLog()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>, <a class="el" href="../../d5/d5/alpha_2allproc_8c-source.html#l00078">KeStartAllProcessors()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04466">MmGetPageFileInformation()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l04046">MmGetVerifierInformation()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00110">RtlCreateProcessParameters()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00083">RtlpCopyProcString()</a>, and <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00539">RtlpCreateStack()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a46" doxytag="hive.h::HvAllocateCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> HvAllocateCell           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">386</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01009">CmpCopyCell()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01328">CmpCreateRootNode()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01472">CmpSplitLeaf()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">CmpSyncKeyValues()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00625">EhCreateChild()</a>, and <a class="el" href="../../d0/d4/edithive_8c-source.html#l00988">EhpAttachSecurity()</a>.
<p>
<pre class="fragment"><div>00398                    :
00399 
00400     Allocates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell index <span class="keywordflow">for</span> a <span class="keyword">new</span> cell.
00401 
00402 Arguments:
00403 
00404     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00405             hive of interest
00406 
00407     NewSize - size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell to allocate
00408 
00409     Type - indicates whether <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> or <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a> storage <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> desired.
00410 
00411 Return Value:
00412 
00413     New <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <span class="keywordflow">if</span> success, <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00414 
00415 --*/
00416 {
00417     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NewCell;
00418 
00419     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_HIVE) {
00420         KdPrint((<span class="stringliteral">"HvAllocateCell:\n"</span>));
00421         KdPrint((<span class="stringliteral">"\tHive=%08lx NewSize=%08lx\n"</span>,Hive,NewSize));
00422     }
00423     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00424     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00425     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">// Make room for overhead fields and round up to HCELL_PAD boundary</span>
00429     <span class="comment">//</span>
00430     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00431         NewSize += FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.OldCell.u.UserData);
00432     } <span class="keywordflow">else</span> {
00433         NewSize += FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.NewCell.u.UserData);
00434     }
00435     NewSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(NewSize, <a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(Hive));
00436 
00437     <span class="comment">// </span>
00438     <span class="comment">// Adjust the size (an easy fix for granularity)</span>
00439     <span class="comment">//</span>
00440     <a class="code" href="../../d8/d0/hivecell_8c.html#a4">HvpAdjustCellSize</a>(NewSize);
00441     <span class="comment">//</span>
00442     <span class="comment">// reject impossible/unreasonable values</span>
00443     <span class="comment">//</span>
00444     <span class="keywordflow">if</span> (NewSize &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a0">HSANE_CELL_MAX</a>) {
00445         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00446     }
00447 
00448     <span class="comment">//</span>
00449     <span class="comment">// Do the actual storage allocation</span>
00450     <span class="comment">//</span>
00451     NewCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a7">HvpDoAllocateCell</a>(Hive, NewSize, Type);
00452 
00453 <span class="preprocessor">#if DBG</span>
00454 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (NewCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00455         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a>(Hive, NewCell));
00456     }
00457 <span class="preprocessor">#endif</span>
00458 <span class="preprocessor"></span>
00459 
    <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_HIVE) {
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="hive.h::HvCheckBin" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG HvCheckBin           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Bin</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Storage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00175">175</a> of file <a class="el" href="../../d0/d0/hivechek_8c-source.html">hivechek.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00188">HBIN_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, and <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00161">USE_OLD_CELL</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00054">HvCheckHive()</a>.
<p>
<pre class="fragment"><div>00182                    :
00183 
00184     Step through all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cells in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bin.  Make sure that
00185     they are consistent with each other, and with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bin header.
00186 
00187 Arguments:
00188 
00189     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure
00190 
00191     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> - pointer to bin to check
00192 
00193     Storage - pointer to a ulong to get allocated user data size
00194 
00195 Return Value:
00196 
00197     0 <span class="keywordflow">if</span> <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> OK.  Number of test in <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> that failed <span class="keywordflow">if</span> not.
00198 
00199     RANGE:  1 - 1999
00200 
00201 --*/
00202 {
00203     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  p;
00204     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  np;
00205     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  lp;
00206     ULONG   freespace = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00207     ULONG   allocated = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00208     ULONG   userallocated = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00209 
00210     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Bin = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00211     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 0;
00212     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = 0;
00213 
00214     <span class="comment">//</span>
00215     <span class="comment">// Scan all the cells in the bin, total free and allocated, check</span>
00216     <span class="comment">// for impossible pointers.</span>
00217     <span class="comment">//</span>
00218     p = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));
00219     lp = p;
00220 
00221     <span class="comment">// DRAGOS:</span>
00222     <span class="comment">// The way allocated and freespace are computed implies the following invariants:</span>
00223     <span class="comment">// 1. allocated + freespace = p + p-&gt;Size - (Bin + sizeof(HBIN)). This is because p-&gt;Size is added either to allocated or to freespace.</span>
00224     <span class="comment">//    So, assuming that allocated &gt; Bin-&gt;Size , then</span>
00225     <span class="comment">//              ==&gt; p + p-&gt;Size - (Bin + sizeof(HBIN)) &gt; Bin-&gt;Size.</span>
00226     <span class="comment">//              ==&gt; p + p-&gt;Size &gt; Bin + Bin-&gt;Size + sizeof(HBIN)</span>
00227     <span class="comment">//              ==&gt; p + p-&gt;Size &gt; Bin + Bin-&gt;Size</span>
00228     <span class="comment">//      This proves that the test "NeverFail 1" (see bellow) will never fail, because when something is wrong, the test above it (namely "Fail 1") will fail </span>
00229     <span class="comment">//      and the function will exit.</span>
00230     <span class="comment">//</span>
00231     <span class="comment">//    The same logic applies to the test "NeverFail 2", so it can be removed also.</span>
00232     <span class="comment">//</span>
00233     <span class="comment">// 2. The new value of p is always calculated as p = p + p-&gt;Size. By the time this is done, the new value of p (ie. p + p-&gt;Size) is already checked against </span>
00234     <span class="comment">//      Bin + Bin-&gt;Size (see tests "Fail 1" and "Fail 2"). So, if p &gt; Bin + Bin-&gt;Size, either "Fail 1" or "Fail 2" will fail before asigning the new bogus value </span>
00235     <span class="comment">//      to p. Therefore, the only possible path to exit the while loop (except a return 20 or return 40), is when p == Bin + Bin-&gt;Size.</span>
00236     <span class="comment">//      ==&gt; test "NeverFail 3" can be removed as it will never fail !</span>
00237     <span class="comment">//</span>
00238     <span class="comment">// 3. Considering 1 (where p + p-&gt;Size became p) </span>
00239     <span class="comment">//              ==&gt; allocated + freespace =  p - (Bin + sizeof(HBIN))</span>
00240     <span class="comment">//    But, Considering 2 (above), when the while loop exits, p = Bin + Bin-&gt;Size</span>
00241     <span class="comment">//              ==&gt; allocated + freespace = Bin + Bin-&gt;Size - (Bin + sizeof(HBIN))</span>
00242     <span class="comment">//              ==&gt; allocated + freespace + sizeof(HBIN) = Bin-&gt;Size</span>
00243     <span class="comment">//       This proves that test "NeverFail 4" (see bellow) will never fail as the expresion tested is always true (if the flow of execution reaches the test point).</span>
00244     <span class="comment">//</span>
00245 
00246     <span class="keywordflow">while</span> (p &lt; (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)) {
00247 
00248         <span class="comment">//</span>
00249         <span class="comment">// Check last pointer</span>
00250         <span class="comment">//</span>
00251         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00252             <span class="keywordflow">if</span> (lp == p) {
00253                 <span class="keywordflow">if</span> (p-&gt;u.OldCell.Last != <a class="code" href="../../d0/d1/hivedata_8h.html#a25">HBIN_NIL</a>) {
00254                     KdPrint((<span class="stringliteral">"HvCheckBin 20: First cell has wrong last pointer\n"</span>));
00255                     KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00256                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 20;
00257                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00258                     <span class="keywordflow">return</span> 20;
00259                 }
00260             } <span class="keywordflow">else</span> {
00261                 <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(p-&gt;u.OldCell.Last + (PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>) != lp) {
00262                     KdPrint((<span class="stringliteral">"HvCheckBin 30: incorrect last pointer\n"</span>));
00263                     KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00264                     KdPrint((<span class="stringliteral">"p = %08lx\n"</span>, (ULONG_PTR)p));
00265                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 30;
00266                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00267                     <span class="keywordflow">return</span> 30;
00268                 }
00269             }
00270         }
00271 
00272         
00273         <span class="comment">//</span>
00274         <span class="comment">// Check size</span>
00275         <span class="comment">//</span>
00276         <span class="keywordflow">if</span> (p-&gt;Size &lt; 0) {
00277 
00278             <span class="comment">//</span>
00279             <span class="comment">// allocated cell</span>
00280             <span class="comment">//</span>
00281 
00282             <span class="comment">// DRAGOS:    Fail 1</span>
00283             <span class="comment">// This test will alway fail prior to the failure of the bellow test</span>
00284             <span class="comment">//</span>
00285             <span class="keywordflow">if</span> ( ((ULONG)(p-&gt;Size * -1) &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)        ||
00286                  ( (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((p-&gt;Size * -1) + (PUCHAR)p) &gt;
00287                    (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) )
00288                )
00289             {
00290                 KdPrint((<span class="stringliteral">"HvCheckBin 40: impossible allocation\n"</span>));
00291                 KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00292                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 40;
00293                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00294                 <span class="keywordflow">return</span> 40;
00295             }
00296 
00297             allocated += (p-&gt;Size * -1);
00298             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00299                 userallocated += (p-&gt;Size * -1) - FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.OldCell.u.UserData);
00300             } <span class="keywordflow">else</span> {
00301                 userallocated += (p-&gt;Size * -1) - FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.NewCell.u.UserData);
00302             }
00303 
00304             <span class="comment">//</span>
00305             <span class="comment">// DRAGOS:   NeverFail 1</span>
00306             <span class="comment">// This test will never fail. If a size is wrong the above test (Fail 1)will fail. We can remove this test (it's useless).</span>
00307             <span class="comment">//</span>
00308             <span class="keywordflow">if</span> (allocated &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) {
00309                 KdPrint((<span class="stringliteral">"HvCheckBin 50: allocated exceeds available\n"</span>));
00310                 KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00311                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 50;
00312                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00313                 <span class="keywordflow">return</span> 50;
00314             }
00315 
00316             np = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)p + (p-&gt;Size * -1));
00317 
00318 
00319 
00320         } <span class="keywordflow">else</span> {
00321 
00322             <span class="comment">//</span>
00323             <span class="comment">// free cell</span>
00324             <span class="comment">//</span>
00325 
00326             <span class="comment">// DRAGOS:    Fail 2</span>
00327             <span class="comment">// This test will alway fail prior to the failure of the bellow test</span>
00328             <span class="comment">//</span>
00329             <span class="keywordflow">if</span> ( ((ULONG)p-&gt;Size &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)               ||
00330                  ( (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(p-&gt;Size + (PUCHAR)p) &gt;
00331                    (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) ) ||
00332                  (p-&gt;Size == 0) )
00333             {
00334                 KdPrint((<span class="stringliteral">"HvCheckBin 60: impossible free block\n"</span>));
00335                 KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00336                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 60;
00337                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00338                 <span class="keywordflow">return</span> 60;
00339             }
00340 
00341             freespace = freespace + p-&gt;Size;
00342 
00343             <span class="comment">//</span>
00344             <span class="comment">// DRAGOS:   NeverFail 2</span>
00345             <span class="comment">// This test will never fail. If a size is wrong the above test (Fail 2) will fail. We can remove this test (it's useless).</span>
00346             <span class="comment">//</span>
00347             <span class="keywordflow">if</span> (freespace &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) {
00348                 KdPrint((<span class="stringliteral">"HvCheckBin 70: free exceeds available\n"</span>));
00349                 KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00350                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 70;
00351                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00352                 <span class="keywordflow">return</span> 70;
00353             }
00354 
00355             np = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)p + p-&gt;Size);
00356 
00357         }
00358 
00359         lp = p;
00360         p = np;
00361     }
00362 
00363     <span class="comment">// DRAGOS:  NeverFail 4</span>
00364     <span class="comment">// This test never fails. If the while loop exits, the condition tested here is always true!!!</span>
00365     <span class="comment">// We can remove this test (it's useless)</span>
00366     <span class="comment">//</span>
00367     <span class="keywordflow">if</span> ((freespace + allocated + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>)) != <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) {
00368         KdPrint((<span class="stringliteral">"HvCheckBin 995: sizes do not add up\n"</span>));
00369         KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00370         KdPrint((<span class="stringliteral">"freespace = %08lx  "</span>, freespace));
00371         KdPrint((<span class="stringliteral">"allocated = %08lx  "</span>, allocated));
00372         KdPrint((<span class="stringliteral">"size = %08lx\n"</span>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>));
00373         <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 995;
00374         <span class="keywordflow">return</span> 995;
00375     }
00376 
00377     <span class="comment">// DRAGOS:  NeverFail 3</span>
00378     <span class="comment">// This test never fails. The only way out of the while loop is when p == Bin + Bin-&gt;Size !!!!!!!</span>
00379     <span class="comment">// We can remove this test (it's useless)</span>
00380     <span class="comment">//</span>
00381     <span class="keywordflow">if</span> (p != (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)) {
00382         KdPrint((<span class="stringliteral">"HvCheckBin 1000: last cell points off the end\n"</span>));
00383         KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00384         <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 1000;
00385         <span class="keywordflow">return</span> 1000;
00386     }
00387 
00388     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Storage)) {
00389         *Storage += userallocated;
00390     }
00391     <span class="keywordflow">return</span> 0;
00392 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="hive.h::HvCheckHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG HvCheckHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG Storage&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00054">54</a> of file <a class="el" href="../../d0/d0/hivechek_8c-source.html">hivechek.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00187">HBIN_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00414">HMAP_DISCARDABLE</a>, <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00175">HvCheckBin()</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00192">_HBIN::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00587">_FREE_HBIN::Size</a>, <a class="el" href="../../d5/d0/genmips_8c-source.html#l00109">t()</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00108">CmCheckRegistry()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01584">HvRefreshHive()</a>.
<p>
<pre class="fragment"><div>00060                    :
00061 
00062     Check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> consistency of a hive.  Apply CheckBin to bins, make sure
00063     all pointers in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell map point to correct places.
00064 
00065 Arguments:
00066 
00067     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00068             hive of interest.
00069 
00070     Storage - supplies adddress of ULONG to receive size of allocated user data
00071 
00072 Return Value:
00073 
00074     0 <span class="keywordflow">if</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> OK.  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a> <span class="keywordflow">return</span> indicator <span class="keywordflow">if</span> not.  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a> value
00075     comes from one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check procedures.
00076 
00077     RANGE:  2000 - 2999
00078 
00079 --*/
00080 {
00081     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> p;
00082     ULONG       Length;
00083     ULONG       localstorage = 0;
00084     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00085     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00086     ULONG   i;
00087     ULONG   rc;
00088     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>  FreeBin;
00089 
00090     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Hive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00091     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 0;
00092     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = (ULONG)-1;
00093     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00094     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = 0;
00095 
00096     p = 0;
00097 
00098 
00099     <span class="comment">//</span>
00100     <span class="comment">// one pass for Stable space, one pass for Volatile</span>
00101     <span class="comment">//</span>
00102     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>; i++) {
00103         Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[i].Length;
00104 
00105         <span class="comment">//</span>
00106         <span class="comment">// for each bin in the space</span>
00107         <span class="comment">//</span>
00108         <span class="keywordflow">while</span> (p &lt; Length) {
00109             <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, p);
00110             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00111                 KdPrint((<span class="stringliteral">"HvCheckHive:"</span>));
00112                 KdPrint((<span class="stringliteral">"\tBin@:%08lx invalid\n"</span>, Bin));
00113                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 2005;
00114                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = i;
00115                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = p;
00116                 <span class="keywordflow">return</span> 2005;
00117             }
00118 
00119 
00120             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) == 0) {
00121 
00122                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress) &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00123 
00124                 <span class="comment">//</span>
00125                 <span class="comment">// bin header valid?</span>
00126                 <span class="comment">//</span>
00127                 <span class="keywordflow">if</span> ( (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> &gt; Length)                           ||
00128                      (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>)             ||
00129                      (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> != p)
00130                    )
00131                 {
00132                     KdPrint((<span class="stringliteral">"HvCheckHive:"</span>));
00133                     KdPrint((<span class="stringliteral">"\tBin@:%08lx invalid\n"</span>, Bin));
00134                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 2010;
00135                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = i;
00136                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = p;
00137                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00138                     <span class="keywordflow">return</span> 2010;
00139                 }
00140 
00141                 <span class="comment">//</span>
00142                 <span class="comment">// structure inside the bin valid?</span>
00143                 <span class="comment">//</span>
00144                 rc = <a class="code" href="../../d9/d0/hivechek_8c.html#a10">HvCheckBin</a>(Hive, Bin, &amp;localstorage);
00145                 <span class="keywordflow">if</span> (rc != 0) {
00146                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = rc;
00147                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = i;
00148                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = p;
00149                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00150                     <span class="keywordflow">return</span> rc;
00151                 }
00152 
00153                 p = (ULONG)p + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00154 
00155             } <span class="keywordflow">else</span> {
00156                 <span class="comment">//</span>
00157                 <span class="comment">// Bin is not present, skip it and advance to the next one.</span>
00158                 <span class="comment">//</span>
00159                 FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BlockAddress;
00160                 p+=FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
00161             }
00162         }
00163 
00164         p = 0x80000000;     <span class="comment">// Beginning of Volatile space</span>
00165     }
00166 
00167     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Storage)) {
00168         *Storage = localstorage;
00169     }
00170     <span class="keywordflow">return</span> 0;
00171 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="hive.h::HvFreeCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvFreeCell           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">688</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00258">CMS_HIVE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00046">DHvCheckBin</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00151">HCELL_FREE_FILL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00111">HCELL_TYPE_MASK</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00947">HvpEnlistFreeCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00292">HvpGetHCell</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00832">HvpIsFreeNeighbor()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00164">_HCELL::Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d4/struct__HCELL.html#o4">_HCELL::u</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00161">USE_OLD_CELL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00895">CmpCopyValue()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01297">CmpFreeKeyBody()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01064">CmpFreeKeyValues()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01464">CmpFreeSecurityDescriptor()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00053">CmpFreeValue()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01150">CmpMergeKeyValues()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01714">CmpRemoveSubKey()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01472">CmpSplitLeaf()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">CmpSyncKeyValues()</a>.
<p>
<pre class="fragment"><div>00699                    :
00700 
00701 
00702     Frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> storage <span class="keywordflow">for</span> a cell.
00703 
00704     NOTE:   CALLER <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to mark relevent data dirty, so as to
00705             allow <span class="keyword">this</span> call to always succeed.
00706 
00707 Arguments:
00708 
00709     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00710             hive of interest
00711 
00712     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> to free.
00713 
00714 Return Value:
00715 
00716     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - failed, presumably <span class="keywordflow">for</span> want of log space.
00717 
00718     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00719 
00720 --*/
00721 {
00722     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00723     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>          tmp;
00724     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     newfreecell;
00725     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>          freebase;
00726     ULONG           savesize;
00727     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>          neighbor;
00728     ULONG           Type;
00729     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00730 
00731 
00732     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_HIVE) {
00733         KdPrint((<span class="stringliteral">"HvFreeCell:\n"</span>));
00734         KdPrint((<span class="stringliteral">"\tHive=%08lx Cell=%08lx\n"</span>,Hive,Cell));
00735     }
00736     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00737     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00738 
00739     <span class="comment">//</span>
00740     <span class="comment">// Get sizes and addresses</span>
00741     <span class="comment">//</span>
00742     Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Cell);
00743     <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Cell);
00744     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00745 
00746     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a>) &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00747     <a class="code" href="../../d6/d0/hive_8h.html#a1">DHvCheckBin</a>(Hive,Bin);
00748 
00749     freebase = <a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive, Cell);
00750 
00751     <span class="comment">//</span>
00752     <span class="comment">// go do actual frees, cannot fail from this point on</span>
00753     <span class="comment">//</span>
00754     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &lt; 0);
00755     freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> *= -1;
00756 
00757     savesize = freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00758 
00759     <span class="comment">//</span>
00760     <span class="comment">// Look for free neighbors and coalesce them.  We will never travel</span>
00761     <span class="comment">// around this loop more than twice.</span>
00762     <span class="comment">//</span>
00763     <span class="keywordflow">while</span> (
00764         <a class="code" href="../../d8/d0/hivecell_8c.html#a10">HvpIsFreeNeighbor</a>(
00765             Hive,
00766             Bin,
00767             freebase,
00768             &amp;neighbor,
00769             Type
00770             ) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00771         )
00772     {
00773 
00774         <span class="keywordflow">if</span> (neighbor &gt; freebase) {
00775 
00776             <span class="comment">//</span>
00777             <span class="comment">// Neighboring free cell is immediately above us in memory.</span>
00778             <span class="comment">//</span>
00779             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00780                 tmp = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)neighbor + neighbor-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>);
00781                 <span class="keywordflow">if</span> ( ((ULONG)((ULONG_PTR)tmp - (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>)) &lt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) {
00782                         tmp-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.Last = (ULONG)((ULONG_PTR)freebase - (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>);
00783                 }
00784             }
00785             freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> += neighbor-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00786 
00787         } <span class="keywordflow">else</span> {
00788 
00789             <span class="comment">//</span>
00790             <span class="comment">// Neighboring free cell is immediately below us in memory.</span>
00791             <span class="comment">//</span>
00792 
00793             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00794                 tmp = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)freebase + freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>);
00795                 <span class="keywordflow">if</span> ( ((ULONG)((ULONG_PTR)tmp - (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>)) &lt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> ) {
00796                     tmp-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.Last = (ULONG)((ULONG_PTR)neighbor - (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>);
00797                 }
00798             }
00799             neighbor-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> += freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00800             freebase = neighbor;
00801         }
00802     }
00803 
00804     <span class="comment">//</span>
00805     <span class="comment">// freebase now points to the biggest free cell we could make, none</span>
00806     <span class="comment">// of which is on the free list.  So put it on the list.</span>
00807     <span class="comment">//</span>
00808     newfreecell = (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>) +
00809                ((ULONG)((ULONG_PTR)freebase - (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>)) +
00810                (Type*<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a>);
00811 
00812     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive, newfreecell) == freebase);
00813 
00814 <span class="preprocessor">#if DBG</span>
00815 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00816         RtlFillMemory(
00817             &amp;(freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.UserData),
00818             (freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> - FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.OldCell.u.UserData)),
00819             HCELL_FREE_FILL
00820             );
00821     } <span class="keywordflow">else</span> {
00822         RtlFillMemory(
00823             &amp;(freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.UserData),
00824             (freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> - FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.NewCell.u.UserData)),
00825             HCELL_FREE_FILL
00826             );
00827     }
00828 <span class="preprocessor">#endif</span>
</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="hive.h::HvFreeHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvFreeHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">34</a> of file <a class="el" href="../../d3/d0/hivefree_8c-source.html">hivefree.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00249">CML_BIN</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00269">CMS_BIN_MAP</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00609">_HHIVE::DirtyAlloc</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00346">_HBASE_BLOCK::FileName</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00589">_FREE_HBIN::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00616">_HHIVE::Flat</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00583">FREE_HBIN_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00111">HCELL_TYPE_MASK</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00414">HMAP_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00413">HMAP_NEWALLOC</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00132">HTABLE_SLOTS</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00807">HvpFreeMap()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00200">_HBIN::MemAlloc</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00587">_FREE_HBIN::Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01490">CmpDestroyTemporaryHive()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04077">CmpValidateAlternate()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>.
<p>
<pre class="fragment"><div>00039                    :
00040 
00041     Free all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pieces of a hive.
00042 
00043 Arguments:
00044 
00045     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive to free.
00046             <span class="keyword">this</span> structure itself will NOT be freed, but everything <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00047             points to will.
00048 
00049 Return Value:
00050 
00051     NONE.
00052 
00053 --*/
00054 {
00055     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> Dir;
00056     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00057     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Address;
00058     ULONG           Type;
00059     ULONG           Length;
00060     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00061     ULONG           Tables;
00062     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>      FreeBin;
00063 
00064     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> == FALSE);
00065     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00066     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Stable == 0);
00067     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Volatile == 1);
00068 
00069     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BIN, CMS_BIN_MAP) {
00070         KdPrint((<span class="stringliteral">"HvFreeHive(%ws) :\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o11">FileName</a>));
00071     }
00072     <span class="comment">//</span>
00073     <span class="comment">// Iterate through both types of storage</span>
00074     <span class="comment">//</span>
00075     <span class="keywordflow">for</span> (Type = 0; Type &lt;= <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>; Type++) {
00076 
00077         Address = <a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a> * Type;
00078         Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length + (<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a> * Type);
00079 
00080         <span class="keywordflow">if</span> (Length &gt; (<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a> * Type)) {
00081 
00082             <span class="comment">//</span>
00083             <span class="comment">// Sweep through bin set</span>
00084             <span class="comment">//</span>
00085             <span class="keywordflow">do</span> {
00086                 Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Address);
00087                 <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Address);
00088                 <span class="keywordflow">if</span> (Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) {
00089                     <span class="comment">//</span>
00090                     <span class="comment">// hbin is either discarded or discardable, check the tombstone</span>
00091                     <span class="comment">//</span>
00092                     FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
00093                     Address += FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
00094                     <span class="keywordflow">if</span> (FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>) {
00095                         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; HMAP_BASE), FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>);
00096                     }
00097                     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(FreeBin, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>));
00098                 } <span class="keywordflow">else</span> {
00099                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00100                     Address += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>;
00101 <span class="preprocessor">#if DBG</span>
00102 <span class="preprocessor"></span>                    <span class="comment">//</span>
00103                     <span class="comment">// Make sure that the next bin in the list is</span>
00104                     <span class="comment">// actually the start of an alloc before freeing it</span>
00105                     <span class="comment">//</span>
00106                     <span class="keywordflow">if</span> (Address &lt; Length) {
00107                         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Address);
00108                         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Address);
00109                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; HMAP_NEWALLOC);
00110                     }
00111 <span class="preprocessor">#endif</span>
00112 <span class="preprocessor"></span>
00113                     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BIN, CMS_BIN_MAP) {
00114                         <span class="keywordflow">if</span>( Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> ) {
00115                             KdPrint((<span class="stringliteral">"HvFreeHive: BinAddress = 0x%08lx\t Size = 0x%lx\n"</span>, Bin, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>));
00116                         }
00117                     }
00118 
00119                     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(Bin, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>);
00120                 }
00121 
00122             } <span class="keywordflow">while</span> (Address &lt; Length);
00123 
00124             <span class="comment">//</span>
00125             <span class="comment">// Free map table storage</span>
00126             <span class="comment">//</span>
00127             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length != (HCELL_TYPE_MASK * Type));
00128             Tables = (((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length) / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>)-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00129             Dir = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Map;
00130             <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(Hive, Dir, 0, Tables);
00131 
00132             <span class="keywordflow">if</span> (Tables &gt; 0) {
00133                 <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Map, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));  <span class="comment">// free dir if it exists</span>
00134             }
00135         }
00136         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length = 0;
00137     }
00138 
00139     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BIN, CMS_BIN_MAP) {
00140         KdPrint((<span class="stringliteral">"\n"</span>));
00141     }
00142     <span class="comment">//</span>
00143     <span class="comment">// Free the base block</span>
00144     <span class="comment">//</span>
00145     (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00146     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">// Free the dirty vector</span>
00150     <span class="comment">//</span>
00151     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00152         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>((PVOID)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer), <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a>);
00153     }
00154 
00155     <span class="keywordflow">return</span>;
00156 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="hive.h::HvFreeHivePartial" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvFreeHivePartial           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Start</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00160">160</a> of file <a class="el" href="../../d3/d0/hivefree_8c-source.html">hivefree.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00265">CmpReleaseGlobalQuota()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00589">_FREE_HBIN::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00616">_HHIVE::Flat</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00583">FREE_HBIN_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00111">HCELL_TYPE_MASK</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00414">HMAP_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00132">HTABLE_SLOTS</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00807">HvpFreeMap()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00586">_FREE_HBIN::ListEntry</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00200">_HBIN::MemAlloc</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00587">_FREE_HBIN::Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01946">HvpTruncateBins()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01584">HvRefreshHive()</a>.
<p>
<pre class="fragment"><div>00167                    :
00168 
00169     Free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory and associated maps <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of a hive
00170     starting at <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>.  The baseblock, hive, etc will not be touched.
00171 
00172 Arguments:
00173 
00174     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive to
00175             partially free.
00176 
00177     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of first bin to free, will free from <span class="keyword">this</span>
00178             bin (inclusive) to the end of the hives stable storage.
00179 
00180     Type - Type of storage (Stable or Volatile) to be freed.
00181 
00182 Return Value:
00183 
00184     NONE.
00185 
00186 --*/
00187 {
00188     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> Dir;
00189     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00190     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Address;
00191     ULONG           StartTable;
00192     ULONG           Length;
00193     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00194     ULONG           Tables;
00195     ULONG           FirstBit;
00196     ULONG           LastBit;
00197     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>      FreeBin;
00198 
00199     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> == FALSE);
00200     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00201 
00202     Address = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00203     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length;
00204     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Address &lt;= Length);
00205 
00206     <span class="keywordflow">if</span> (Address == Length) {
00207         <span class="keywordflow">return</span>;
00208     }
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">// Sweep through bin set</span>
00212     <span class="comment">//</span>
00213     <span class="keywordflow">do</span> {
00214         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Address + (Type*HCELL_TYPE_MASK));
00215         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Address + (Type*HCELL_TYPE_MASK));
00216         <span class="keywordflow">if</span> (Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) {
00217             FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
00218             <span class="keywordflow">if</span> (FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>) {
00219                 <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>((PVOID)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; HMAP_BASE), FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>);
00220             } <span class="keywordflow">else</span> {
00221                 <span class="comment">//</span>
00222                 <span class="comment">// The bin has been freed, but quota is still charged.</span>
00223                 <span class="comment">// Since the file will now shrink, the quota must be</span>
00224                 <span class="comment">// returned here.</span>
00225                 <span class="comment">//</span>
00226                 <a class="code" href="../../d1/d2/cmp_8h.html#a248">CmpReleaseGlobalQuota</a>(FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>);
00227             }
00228             RemoveEntryList(&amp;FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>);
00229             Address += FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
00230             <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(FreeBin, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>));
00231 
00232         } <span class="keywordflow">else</span> {
00233             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00234 
00235             Address += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>;
00236             <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(Bin, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>);
00237         }
00238     } <span class="keywordflow">while</span> (Address &lt; Length);
00239 
00240     <span class="comment">//</span>
00241     <span class="comment">// Free map table storage</span>
00242     <span class="comment">//</span>
00243     Tables = (((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length) / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) - 1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00244     Dir = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Map;
00245     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &gt; 0) {
00246         StartTable = ((<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00247     } <span class="keywordflow">else</span> {
00248         StartTable = (ULONG)-1;
00249     }
00250     <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(Hive, Dir, StartTable+1, Tables);
00251 
00252     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00253 
00254     <span class="keywordflow">if</span> (Type==<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>) {
00255         <span class="comment">//</span>
00256         <span class="comment">// Clear dirty vector for data past Hive-&gt;Storage[Stable].Length</span>
00257         <span class="comment">//</span>
00258         FirstBit = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00259         LastBit = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap;
00260         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00261         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>, FirstBit, LastBit-FirstBit);
00262         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00263     }
00264 
00265     <span class="keywordflow">return</span>;
00266 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="hive.h::HvGetCellSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG HvGetCellSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="hive.h::HvInitializeHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvInitializeHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OperationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HiveFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileTypes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID HiveData&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a63">PALLOCATE_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocateRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a64">PFREE_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FreeRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a65">PFILE_SET_SIZE_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSetSizeRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a67">PFILE_WRITE_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileWriteRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a68">PFILE_READ_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileReadRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a69">PFILE_FLUSH_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileFlushRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Cluster</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FileName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">158</a> of file <a class="el" href="../../d6/d0/hiveinit_8c-source.html">hiveinit.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00620">_HHIVE::Alternate</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00348">_HBASE_BLOCK::CheckSum</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00345">_HBASE_BLOCK::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00249">CML_BIN</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00265">CmpReleaseGlobalQuota()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00269">CMS_BIN_MAP</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">CMS_INIT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00609">_HHIVE::DirtyAlloc</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00603">_HHIVE::FileFlush</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00602">_HHIVE::FileRead</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00600">_HHIVE::FileSetSize</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00601">_HHIVE::FileWrite</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00616">_HHIVE::Flat</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00342">_HBASE_BLOCK::Format</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00595">_HHIVE::GetCellRoutine</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00323">HBASE_BLOCK_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00329">HBASE_FORMAT_MEMORY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00569">HFILE_TYPE_ALTERNATE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00577">HHIVE_FREE_DISPLAY_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00197">HINIT_CREATE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00199">HINIT_FILE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00201">HINIT_FLAT</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00198">HINIT_MEMORY</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00200">HINIT_MEMORY_INPLACE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00130">HSECTOR_COUNT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00325">HSYS_MAJOR</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00326">HSYS_MINOR</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00076">HTYPE_COUNT</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00100">HvLoadHive()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00536">HvpBuildMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00080">HvpDumpFreeDisplay</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00645">HvpFillFileName()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00085">HvpFreeAllocatedBins()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00221">HvpGetCellFlat()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00146">HvpGetCellPaged()</a>, <a class="el" href="../../d0/d1/hivesum_8c-source.html#l00031">HvpHeaderCheckSum()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00344">_HBASE_BLOCK::Length</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00619">_HHIVE::Log</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00624">_HHIVE::LogSize</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00339">_HBASE_BLOCK::Major</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00340">_HBASE_BLOCK::Minor</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00626">_HHIVE::RefreshCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00266">RtlClearAllBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00219">RtlInitializeBitMap()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00305">RtlSetAllBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00336">_HBASE_BLOCK::Sequence1</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00337">_HBASE_BLOCK::Sequence2</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00335">_HBASE_BLOCK::Signature</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00629">_HHIVE::StorageTypeCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00338">_HBASE_BLOCK::TimeStamp</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00341">_HBASE_BLOCK::Type</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00633">_HHIVE::Version</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00050">CmGetSystemControlValues()</a>, and <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>.
<p>
<pre class="fragment"><div>00175                    :
00176 
00177     Initialize a hive.
00178 
00179     Core HHive fields are always inited.
00180 
00181     <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> calls WILL be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> BEFORE <span class="keyword">this</span> call returns.
00182 
00183     Caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to create/open files and store <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> handles
00184     in a way that can be derived from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive pointer.
00185 
00186     Three kinds of initialization can be done, selected by OperationType:
00187 
00188         <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>
00189 
00190             <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> a <span class="keyword">new</span> hive from scratch.  Will have 0 storage.
00191             [Used to <span class="keywordflow">do</span> things like create HARDWARE hive and <span class="keywordflow">for</span> parts
00192              of SaveKey and RestoreKey]
00193 
00194 
00195         <a class="code" href="../../d6/d0/hive_8h.html#a7">HINIT_MEMORY_INPLACE</a>
00196 
00197             Build a hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure which allows read <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
00198             access to a contiguous in-memory image of a hive.
00199             No part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image will be copied, but a map will
00200             be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>.
00201             [Used by osloader.]
00202 
00203 
00204         <a class="code" href="../../d6/d0/hive_8h.html#a8">HINIT_FLAT</a>
00205 
00206             Support very limited (read-only, no checking code) operation
00207             against a hive image.
00208 
00209 
00210         <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>
00211 
00212             <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> a <span class="keyword">new</span> hive, <span class="keyword">using</span> a hive image already in memory,
00213             at address supplied by pointer HiveData.  The data will
00214             be copied.  Caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to free HiveData.
00215             [Used <span class="keywordflow">for</span> SYSTEM hive]
00216 
00217 
00218         <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>
00219 
00220             <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> a hive, reading its data from a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  Recovery processing
00221             via log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> will be done <span class="keywordflow">if</span> a log <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available.  If a log
00222             <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> recovered, flush and clear operation will proceed.
00223 
00224 
00225     NOTE:   The HHive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a completely opaque structure, because <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00226             <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> really <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> used by a limited set of code.  Do not assume
00227             that <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keyword">this</span> routine sets all of these values.
00228 
00229 
00230 Arguments:
00231 
00232     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure to be initialized
00233             to describe <span class="keyword">this</span> hive.
00234 
00235     OperationType - specifies whether to create a <span class="keyword">new</span> hive from scratch,
00236             from a memory image, or by reading a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> from disk.
00237 
00238     HiveFlags - <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a> - Entire hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be <span class="keyword">volatile</span>, regardless
00239                                    of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> types of cells allocated
00240                 HIVE_NO_LAZY_FLUSH - Data in <span class="keyword">this</span> hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> never written
00241                                    to disk except by an <span class="keyword">explicit</span> FlushKey
00242 
00243     FileType - HFILE_TYPE_*, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a> or <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a> set
00244             up <span class="keywordflow">for</span> logging or alternate support respectively.
00245 
00246     HiveData - <span class="keywordflow">if</span> present, supplies a pointer to an in memory image of
00247             from which to init <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.  Only useful when OperationType
00248             <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>.
00249 
00250     AllocateRoutine - supplies a pointer to routine called to allocate
00251                         memory.  WILL be called before <span class="keyword">this</span> routine returns.
00252 
00253     FreeRoutine - supplies a pointer to routine called to free memory.
00254                    CAN be called before <span class="keyword">this</span> routine returns.
00255 
00256     FileSetSizeRoutine - supplies a pointer to a routine used to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00257                          size of a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>. CAN be called before <span class="keyword">this</span>
00258                          routine returns.
00259 
00260     FileWriteRoutine - supplies a pointer to routine called to write memory
00261                         to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00262 
00263     FileReadRoutine - supplies a pointer to routine called to read from
00264                         a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> into memory. CAN be called before <span class="keyword">this</span>
00265                         routine returns.
00266 
00267     FileFlushRoutine - supplies a pointer to routine called to flush a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00268 
00269     Cluster - clustering factor in <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> units.  (i.e.  <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of
00270             physical sector in media / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>.  1 <span class="keywordflow">for</span> 512 byte
00271             physical sectors (or smaller), 2 <span class="keywordflow">for</span> 1024, 4 <span class="keywordflow">for</span> 2048, etc.
00272             (Numbers greater than 8 won'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> work.)
00273 
00274     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> - some <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> like <span class="stringliteral">"...\system32\config\system"</span>, last
00275                 32 or so characters will be copied into baseblock
00276                 (and thus to disk) as a debugging aid.  May be null.
00277 
00278 
00279 Return Value:
00280 
00281     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00282 
00283 --*/
00284 {
00285     BOOLEAN         UseForIo;
00286     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00287     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00288     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        Status2;
00289     PVOID           Image;
00290     ULONG           i;
00291     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           Pbin;
00292     ULONG           Alignment;
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">// this array stores the last elements in each free cell list for the stable storage</span>
00296     <span class="comment">//</span>
00297     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     TailDisplay[<a class="code" href="../../d0/d1/hivedata_8h.html#a45">HHIVE_FREE_DISPLAY_SIZE</a>];
00298 
00299     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT) {
00300         KdPrint((<span class="stringliteral">"HvInitializeHive:\n"</span>));
00301         KdPrint((<span class="stringliteral">"\tHive=%08lx\n"</span>, Hive));
00302     }
00303 
00304     <span class="comment">//</span>
00305     <span class="comment">// reject invalid parameter combinations</span>
00306     <span class="comment">//</span>
00307     <span class="keywordflow">if</span> ( (! ARGUMENT_PRESENT(HiveData)) &amp;&amp;
00308          ((OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>) ||
00309           (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a8">HINIT_FLAT</a>) ||
00310           (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a7">HINIT_MEMORY_INPLACE</a>))
00311        )
00312     {
00313         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00314     }
00315 
00316     <span class="keywordflow">if</span> ( ! ((OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>) ||
00317             (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>) ||
00318             (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a7">HINIT_MEMORY_INPLACE</a>) ||
00319             (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a8">HINIT_FLAT</a>) ||
00320             (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>))
00321        )
00322     {
00323         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00324     }
00325 
00326 
00327     <span class="comment">//</span>
00328     <span class="comment">// static and global control values</span>
00329     <span class="comment">//</span>
00330     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a37">HHIVE_SIGNATURE</a>;
00331 
00332     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a> = AllocateRoutine;
00333     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a> = FreeRoutine;
00334     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a> = FileSetSizeRoutine;
00335     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a> = FileWriteRoutine;
00336     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a> = FileReadRoutine;
00337     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a> = FileFlushRoutine;
00338 
00339     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> = (BOOLEAN)((FileType == <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00340     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o16">Alternate</a> = (BOOLEAN)((FileType == <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00341 
00342     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> || <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o16">Alternate</a>)  &amp;&amp; (HiveFlags &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>)) {
00343         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00344     }
00345 
00346     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> = HiveFlags;
00347 
00348     <span class="keywordflow">if</span> ((Cluster == 0) || (Cluster &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a16">HSECTOR_COUNT</a>)) {
00349         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00350     }
00351     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> = Cluster;
00352 
00353     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o19">RefreshCount</a> = 0;
00354 
00355     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a5">HTYPE_COUNT</a>;
00356 
00357 
00358     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Length = 0;
00359     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Map = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00360     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].SmallDir = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00361     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Guard = (ULONG)-1;
00362     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].FreeSummary = 0;
00363     InitializeListHead(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Volatile].FreeBins);
00364     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d1/hivedata_8h.html#a45">HHIVE_FREE_DISPLAY_SIZE</a>; i++) {
00365         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].FreeDisplay[i] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00366     }
00367 
00368     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length = 0;
00369     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00370     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00371     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Guard = (ULONG)-1;
00372     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeSummary = 0;
00373     InitializeListHead(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Stable].FreeBins);
00374     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d1/hivedata_8h.html#a45">HHIVE_FREE_DISPLAY_SIZE</a>; i++) {
00375         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeDisplay[i] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00376         TailDisplay[i] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00377     }
00378 
00379     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>), NULL, 0);
00380     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = 0;
00381     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a> = 0;
00382     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> = 0;
00383 
00384     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o1">GetCellRoutine</a> = <a class="code" href="../../d6/d0/hive_8h.html#a29">HvpGetCellPaged</a>;
00385     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00386     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00387     UseForIo = (BOOLEAN)!(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>);
00388 
00389     <span class="comment">//</span>
00390     <span class="comment">// new create case</span>
00391     <span class="comment">//</span>
00392     <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>) {
00393 
00394         BaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>), UseForIo));
00395         <span class="keywordflow">if</span> (BaseBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00396             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00397         }
00398         <span class="comment">//</span>
00399         <span class="comment">// Make sure the buffer we got back is cluster-aligned. If not, try</span>
00400         <span class="comment">// harder to get an aligned buffer.</span>
00401         <span class="comment">//</span>
00402         Alignment = Cluster * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> - 1;
00403         <span class="keywordflow">if</span> (((ULONG_PTR)BaseBlock &amp; Alignment) != 0) {
00404             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(BaseBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00405             BaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00406             <span class="keywordflow">if</span> (BaseBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00407                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00408             }
00409 
00410             <span class="comment">//</span>
00411             <span class="comment">// Return the quota for the extra allocation, as we are not really using</span>
00412             <span class="comment">// it and it will not be accounted for later when we free it.</span>
00413             <span class="comment">//</span>
00414             <a class="code" href="../../d1/d2/cmp_8h.html#a248">CmpReleaseGlobalQuota</a>(PAGE_SIZE - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00415         }
00416 
00417         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>;
00418         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a> = 1;
00419         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a> = 1;
00420         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>.HighPart = 0;
00421         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>.LowPart = 0;
00422         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>;
00423         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>;
00424         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
00425         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a29">HBASE_FORMAT_MEMORY</a>;
00426         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00427         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> = 0;
00428         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o10">Cluster</a> = Cluster;
00429         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a> = 0;
00430         <a class="code" href="../../d5/d1/hiveinit_8c.html#a1">HvpFillFileName</a>(BaseBlock, FileName);
00431         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = BaseBlock;
00432         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>;
00433 
00434         <span class="keywordflow">return</span> STATUS_SUCCESS;
00435     }
00436 
00437     <span class="comment">//</span>
00438     <span class="comment">// flat image case</span>
00439     <span class="comment">//</span>
00440     <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a8">HINIT_FLAT</a>) {
00441         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)HiveData;
00442         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a>;
00443         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00444         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00445         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o1">GetCellRoutine</a> = <a class="code" href="../../d6/d0/hive_8h.html#a28">HvpGetCellFlat</a>;
00446         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>;
00447         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a> = 1;
00448         <span class="keywordflow">return</span> STATUS_SUCCESS;
00449     }
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">// readonly image case</span>
00453     <span class="comment">//</span>
00454     <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a7">HINIT_MEMORY_INPLACE</a>) {
00455         BaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)HiveData;
00456 
00457         <span class="keywordflow">if</span> ( (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>)   ||
00458              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>)           ||
00459              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>)                  ||
00460              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a> &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>)                   ||
00461              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a29">HBASE_FORMAT_MEMORY</a>)        ||
00462              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a> != BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>)    ||
00463              (<a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock) !=
00464               (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a>))
00465            )
00466         {
00467             <span class="keywordflow">return</span> STATUS_REGISTRY_CORRUPT;
00468         }
00469 
00470         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = BaseBlock;
00471         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a>;
00472         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00473         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a> = 1;
00474 
00475         <span class="keywordflow">if</span> (FileType == <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>) {
00476             <span class="comment">//</span>
00477             <span class="comment">// Mark the baseblock with Type==HFILE_TYPE_ALTERNATE.  This</span>
00478             <span class="comment">// case will never show up on disk, because we always flush</span>
00479             <span class="comment">// Type==HFILE_TYPE_PRIMARY to the alternate file.  Any</span>
00480             <span class="comment">// baseblock with Type==HFILE_TYPE_ALTERNATE indicates that</span>
00481             <span class="comment">// the primary is corrupt and must be rewritten.</span>
00482             <span class="comment">//</span>
00483             BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a>=<a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>;
00484 
00485             <span class="comment">//</span>
00486             <span class="comment">// baseblock has changed, recompute the checksum.</span>
00487             <span class="comment">//</span>
00488             BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a>=<a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock);
00489         }
00490 
00491         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/hivemap_8c.html#a9">HvpBuildMap</a>(
00492                             Hive,
00493                             (PUCHAR)HiveData + HBLOCK_SIZE,
00494                             TailDisplay
00495                             )))
00496         {
00497             <span class="keywordflow">return</span> STATUS_REGISTRY_CORRUPT;
00498         }
00499 
00500         <span class="comment">// debug-only</span>
00501         <a class="code" href="../../d5/d1/hiveinit_8c.html#a0">HvpDumpFreeDisplay</a>(Hive);
00502 
00503         <span class="keywordflow">return</span>(STATUS_SUCCESS);
00504     }
00505 
00506     <span class="comment">//</span>
00507     <span class="comment">// memory copy case</span>
00508     <span class="comment">//</span>
00509     <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>) {
00510         BaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)HiveData;
00511 
00512         <span class="keywordflow">if</span> ( (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>)   ||
00513              ((BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>)    &amp;&amp;
00514               (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>))       ||
00515              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a29">HBASE_FORMAT_MEMORY</a>)        ||
00516              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>)                  ||
00517              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a> &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>)                   ||
00518              (<a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock) !=
00519               (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a>))
00520            )
00521         {
00522             <span class="keywordflow">return</span> STATUS_REGISTRY_CORRUPT;
00523         }
00524 
00525         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>), UseForIo));
00526         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00527             <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00528         }
00529         <span class="comment">//</span>
00530         <span class="comment">// Make sure the buffer we got back is cluster-aligned. If not, try</span>
00531         <span class="comment">// harder to get an aligned buffer.</span>
00532         <span class="comment">//</span>
00533         Alignment = Cluster * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> - 1;
00534         <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> &amp; Alignment) != 0) {
00535             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00536             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00537             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00538                 <span class="keywordflow">return</span> (STATUS_INSUFFICIENT_RESOURCES);
00539             }
00540         }
00541         RtlCopyMemory(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, BaseBlock, HSECTOR_SIZE);
00542 
00543         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a>;
00544 
00545         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/hivemap_8c.html#a6">HvpBuildMapAndCopy</a>(Hive,
00546                                             (PUCHAR)HiveData + HBLOCK_SIZE,
00547                                             TailDisplay))) {
00548 
00549             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00550             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00551             <span class="keywordflow">return</span> STATUS_REGISTRY_CORRUPT;
00552         }
00553 
00554         <span class="keywordflow">if</span> (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>) {
00555             <span class="comment">//</span>
00556             <span class="comment">// Note that Type==HFILE_TYPE_ALTERNATE will NEVER occur in</span>
00557             <span class="comment">// an on-disk image.  The only way this can show up in the</span>
00558             <span class="comment">// baseblock is when the osloader rejects the SYSTEM hive and</span>
00559             <span class="comment">// successfully loads SYSTEM.ALT.  When this happens, it</span>
00560             <span class="comment">// forces HFILE_TYPE_ALTERNATE into the in-memory image of</span>
00561             <span class="comment">// the baseblock.</span>
00562             <span class="comment">//</span>
00563             <span class="comment">// We've booted from SYSTEM.ALT.  Mark the whole hive dirty</span>
00564             <span class="comment">// so everything gets flushed to SYSTEM as soon as we can</span>
00565             <span class="comment">// do I/O.</span>
00566             <span class="comment">//</span>
00567             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a28">RtlSetAllBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00568             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a>=<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap;
00569 
00570         }
00571         <a class="code" href="../../d5/d1/hiveinit_8c.html#a1">HvpFillFileName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, FileName);
00572         
00573         <span class="comment">// debug - only</span>
00574         <a class="code" href="../../d5/d1/hiveinit_8c.html#a0">HvpDumpFreeDisplay</a>(Hive);
00575        
00576         <span class="keywordflow">return</span>(STATUS_SUCCESS);
00577     }
00578 
00579     <span class="comment">//</span>
00580     <span class="comment">// file read case</span>
00581     <span class="comment">//</span>
00582     <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>) {
00583 
00584         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BIN, CMS_BIN_MAP) {
00585             KdPrint((<span class="stringliteral">"HvInitializeHive(%wZ,HINIT_FILE) :\n"</span>, FileName));
00586         }
00587         <span class="comment">//</span>
00588         <span class="comment">// get the file image (possible recovered via log) into memory</span>
00589         <span class="comment">//</span>
00590         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/hiveload_8c.html#a19">HvLoadHive</a>(Hive, TailDisplay);
00591         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) &amp;&amp; (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_REGISTRY_RECOVERED)) {
00592             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00593         }
00594 
00595         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BIN, CMS_BIN_MAP) {
00596             KdPrint((<span class="stringliteral">"\n"</span>));
00597         }
00598         
00599         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_REGISTRY_RECOVERED) {
00600 
00601             <span class="comment">//</span>
00602             <span class="comment">// We have a good hive, with a log, and a dirty map,</span>
00603             <span class="comment">// all set up.  Only problem is that we need to flush</span>
00604             <span class="comment">// the file so the log can be cleared and new writes</span>
00605             <span class="comment">// posted against the hive.  Since we know we have</span>
00606             <span class="comment">// a good log in hand, we just write the hive image.</span>
00607             <span class="comment">//</span>
00608             <span class="keywordflow">if</span> ( ! <a class="code" href="../../d0/d2/hivesync_8c.html#a14">HvpDoWriteHive</a>(Hive, HFILE_TYPE_PRIMARY)) {
00609                 <span class="comment">//</span>
00610                 <span class="comment">// DRAGOS: Here we need cleanup </span>
00611                 <span class="comment">// Clean up the bins already allocated </span>
00612                 <span class="comment">//</span>
00613                 <a class="code" href="../../d5/d1/hiveinit_8c.html#a2">HvpFreeAllocatedBins</a>( Hive );
00614 
00615                 <span class="keywordflow">return</span> STATUS_REGISTRY_IO_FAILED;
00616             }
00617 
00618             <span class="comment">//</span>
00619             <span class="comment">// If we get here, we have recovered the hive, and</span>
00620             <span class="comment">// written it out to disk correctly.  So we clear</span>
00621             <span class="comment">// the log here.</span>
00622             <span class="comment">//</span>
00623             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00624             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = 0;
00625             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>, 0);
00626             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> = 0;
00627         }
00628 
00629         <span class="comment">//</span>
00630         <span class="comment">// slam debug name data into base block</span>
00631         <span class="comment">//</span>
00632         <a class="code" href="../../d5/d1/hiveinit_8c.html#a1">HvpFillFileName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, FileName);
00633 
00634         <span class="comment">// debug - only</span>
00635         <a class="code" href="../../d5/d1/hiveinit_8c.html#a0">HvpDumpFreeDisplay</a>(Hive);
00636 
00637         <span class="keywordflow">return</span> STATUS_SUCCESS;
00638     }
00639 
00640     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00641 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="hive.h::HvIsBinDirty" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvIsBinDirty           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00200">200</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
<pre class="fragment"><div>00207                    :
00208 
00209     Given a hive and a cell, checks whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bin containing
00210     that cell has any dirty clusters or not.
00211 
00212 Arguments:
00213 
00214     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure
00215 
00216     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>.
00217 
00218 Return Value:
00219 
00220     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> contains dirty data.
00221 
00222     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> does not contain dirty data.
00223 
00224 --*/
00225 
00226 {
00227     ULONG       Type;
00228     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>      pcell;
00229     PRTL_BITMAP Bitmap;
00230     ULONG       First;
00231     ULONG       Last;
00232     ULONG       i;
00233     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Map;
00234     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00235 
00236     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_IO) {
00237         KdPrint((<span class="stringliteral">"HvIsBinDirty:\n\t"</span>));
00238         KdPrint((<span class="stringliteral">"Hive:%08lx Cell:%08lx\n"</span>, Hive, Cell));
00239     }
00240 
00241     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00242     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00243 
00244     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00245 
00246     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) ||
00247          (Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) )
00248     {
00249         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00250     }
00251 
00252     Bitmap = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00253 
00254     Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Cell);
00255     <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,Cell);
00256     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00257     First = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00258     Last = (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> - 1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00259 
00260     <span class="keywordflow">for</span> (i=First; i&lt;=Last; i++) {
00261         <span class="keywordflow">if</span> (RtlCheckBit(Bitmap, i)==1) {
00262             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00263         }
00264     }
00265     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00266 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="hive.h::HvIsCellAllocated" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvIsCellAllocated           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01453">1453</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00616">_HHIVE::Flat</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00188">HBIN_NIL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00143">HCELL_PAD</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00111">HCELL_TYPE_MASK</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00292">HvpGetHCell</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00164">_HCELL::Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d4/struct__HCELL.html#o4">_HCELL::u</a>, and <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00161">USE_OLD_CELL</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00323">CmpCheckKey()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00588">CmpCheckValueList()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01608">CmpMarkIndexDirty()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01714">CmpRemoveSubKey()</a>, and <a class="el" href="../../d3/d9/cmchek2_8c-source.html#l00034">CmpValidateHiveSecurityDescriptors()</a>.
<p>
<pre class="fragment"><div>01464                    :
01465 
01466     Report whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested cell <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated or not.
01467 
01468 Arguments:
01469 
01470     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - containing <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>.
01471 
01472     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - cel of interest
01473 
01474 Return Value:
01475 
01476     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> allocated, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
01477 
01478 --*/
01479 {
01480     ULONG   Type;
01481     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  Address;
01482     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  Below;
01483     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Me;
01484     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>   <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
01485     ULONG   <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01486     LONG    <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01487 
01488 
01489     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
01490 
01491     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01492         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01493     }
01494 
01495     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
01496 
01497     <span class="keywordflow">if</span> ( ((<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> &amp; ~<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a>) &gt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length) || <span class="comment">// off end</span>
01498          (<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> % <a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(Hive) != 0)                    <span class="comment">// wrong alignment</span>
01499        )
01500     {
01501         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01502     }
01503 
01504     Address = <a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive, Cell);
01505     Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Cell);
01506     <span class="keywordflow">if</span> (Me == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01507         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01508     }
01509     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((ULONG_PTR)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a>) &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01510     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = (ULONG)((ULONG_PTR)Address - (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>);
01511     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = Address-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> * -1;
01512 
01513     <span class="keywordflow">if</span> ( (Address-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt; 0) ||                     <span class="comment">// not allocated</span>
01514          ((<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + (ULONG)<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) ||    <span class="comment">// runs off bin, or too big</span>
01515          (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>))                    <span class="comment">// pts into bin header</span>
01516        )
01517     {
01518         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01519     }
01520 
01521     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01522         <span class="keywordflow">if</span> (Address-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.Last != <a class="code" href="../../d0/d1/hivedata_8h.html#a25">HBIN_NIL</a>) {
01523 
01524             <span class="keywordflow">if</span> (Address-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.Last &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) {            <span class="comment">// bogus back pointer</span>
01525                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01526             }
01527 
01528             Below = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + Address-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.Last);
01529             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (Below-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &lt; 0) ?
01530                         Below-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> * -1 :
01531                         Below-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
01532 
01533             <span class="keywordflow">if</span> ( ((ULONG_PTR)Below + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) != (ULONG_PTR)Address ) {    <span class="comment">// no pt back</span>
01534                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01535             }
01536         }
    }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="hive.h::HvLoadHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvLoadHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00100">100</a> of file <a class="el" href="../../d7/d0/hiveload_8c-source.html">hiveload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00751">HvpCleanMap()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00085">HvpFreeAllocatedBins()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00592">HvpGetHiveHeader()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00758">HvpGetLogHeader()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00311">HvpReadFileImageAndBuildMap()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00847">HvpRecoverData()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00344">_HBASE_BLOCK::Length</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00619">_HHIVE::Log</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00340">_HBASE_BLOCK::Minor</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a8">NotHive</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00336">_HBASE_BLOCK::Sequence1</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00337">_HBASE_BLOCK::Sequence2</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00341">_HBASE_BLOCK::Type</a>, and <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00633">_HHIVE::Version</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.
<p>
<pre class="fragment"><div>00106                    :
00107 
00108     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> must be fully initialized, in particular, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> handles
00109     must be set up.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not intended <span class="keywordflow">for</span> loading hives
00110     from images already in memory.
00111 
00112     This routine will apply whatever fixes are available <span class="keywordflow">for</span> errors
00113     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive image.  In particular, <span class="keywordflow">if</span> a log exists, and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> applicable,
00114     <span class="keyword">this</span> routine will automatically apply <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00115 
00116     ALGORITHM:
00117 
00118         call <a class="code" href="../../d6/d1/hiveload_8c.html#a14">HvpGetHiveHeader</a>()
00119 
00120         if (NoMemory or NoHive)
00121             return failure
00122 
00123         if (RecoverData or RecoverHeader) and (no log)
00124             return falure
00125 
00126         if (RecoverHeader)
00127             call HvpGetLogHeader
00128             if (fail)
00129                 return failure
00130             fix up baseblock
00131 
00132         Read Data
00133 
00134         if (RecoverData or RecoverHeader)
00135             HvpRecoverData
00136             return STATUS_REGISTRY_RECOVERED
00137 
00138         clean up sequence numbers
00139 
00140         return success OR STATUS_REGISTRY_RECOVERED
00141 
00142     If STATUS_REGISTRY_RECOVERED is returned, then
00143 
00144         If (Log) was used, DirtyVector and DirtyCount are set,
00145             caller is expected to flush the changes (using a
00146             NEW log file)
00147 
00148 Arguments:
00149 
00150     Hive - supplies a pointer to the hive control structure for the
00151             hive of interest
00152 
00153     TailDisplay - array containing the tail ends of the free cell lists - optional
00154 
00155 Return Value:
00156 
00157     STATUS:
00158 
00159         STATUS_INSUFFICIENT_RESOURCES   - memory alloc failure, etc
00160         STATUS_NOT_REGISTRY_FILE        - bad signatures and the like
00161         STATUS_REGISTRY_CORRUPT         - bad signatures in the log,
00162                                           bad stuff in both in alternate,
00163                                           inconsistent log
00164 
00165         STATUS_REGISTRY_IO_FAILED       - data read failed
00166 
00167         STATUS_RECOVERED                - successfully recovered the hive,
00168                                           a semi-flush of logged data
00169                                           is necessary.
00170 
00171         STATUS_SUCCESS                  - it worked, no recovery needed
00172 
00173 --*/
00174 {
00175     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
00176     ULONG           result1;
00177     ULONG           result2;
00178     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status;
00179     LARGE_INTEGER   TimeStamp;
00180     ULONG           FileOffset;
00181     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           pbin;
00182     BOOLEAN         ReadOnlyFlagCopy;
00183 
00184     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00185 
00186     BaseBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00187     result1 = <a class="code" href="../../d6/d1/hiveload_8c.html#a14">HvpGetHiveHeader</a>(Hive, &amp;BaseBlock, &amp;TimeStamp);
00188 
00189     <span class="comment">//</span>
00190     <span class="comment">// bomb out for total errors</span>
00191     <span class="comment">//</span>
00192     <span class="keywordflow">if</span> (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>) {
00193         status = STATUS_INSUFFICIENT_RESOURCES;
00194         <span class="keywordflow">goto</span> Exit1;
00195     }
00196     <span class="keywordflow">if</span> (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a8">NotHive</a>) {
00197         status = STATUS_NOT_REGISTRY_FILE;
00198         <span class="keywordflow">goto</span> Exit1;
00199     }
00200 
00201     
00202     ReadOnlyFlagCopy = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a>;
00203     <span class="comment">//</span>
00204     <span class="comment">// if recovery needed, and no log, bomb out</span>
00205     <span class="comment">//</span>
00206     <span class="keywordflow">if</span> ( ((result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>) ||
00207           (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>)) )
00208     {
00209         <span class="comment">//</span>
00210         <span class="comment">// recovery needed</span>
00211         <span class="comment">//</span>
00212         <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
00213         {
00214             <span class="comment">//</span>
00215             <span class="comment">// no log ==&gt; bomb out</span>
00216             <span class="comment">//</span>
00217             status = STATUS_REGISTRY_CORRUPT;
00218             <span class="keywordflow">goto</span> Exit1;
00219         } <span class="keywordflow">else</span> {
00220             <span class="comment">//</span>
00221             <span class="comment">// TRICK: simulate hive as read-only; Free cells will not </span>
00222             <span class="comment">// be enlisted in HvpReadFileImageAndBuildMap; Instead, they</span>
00223             <span class="comment">// will be enlisted in HvpRecoverData, when we are sure we have </span>
00224             <span class="comment">// the right info loaded up into memory</span>
00225             <span class="comment">//</span>
00226             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00227         }
00228     }
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">// need to recover header using log, so try to get it from log</span>
00232     <span class="comment">//</span>
00233     <span class="keywordflow">if</span> (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>) {
00234         result2 = <a class="code" href="../../d6/d1/hiveload_8c.html#a15">HvpGetLogHeader</a>(Hive, &amp;BaseBlock, &amp;TimeStamp);
00235         <span class="keywordflow">if</span> (result2 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>) {
00236             status =  STATUS_INSUFFICIENT_RESOURCES;
00237             <span class="keywordflow">goto</span> Exit1;
00238         }
00239         <span class="keywordflow">if</span> (result2 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>) {
00240             status = STATUS_REGISTRY_CORRUPT;
00241             <span class="keywordflow">goto</span> Exit1;
00242         }
00243         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
00244     }
00245     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = BaseBlock;
00246     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a>;
00247 
00248     <span class="comment">//</span>
00249     <span class="comment">// at this point, we have a sane baseblock.  we may or may not still</span>
00250     <span class="comment">// need to apply data recovery</span>
00251     <span class="comment">//</span>
00252     status = <a class="code" href="../../d6/d1/hiveload_8c.html#a17">HvpReadFileImageAndBuildMap</a>(Hive,BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>,TailDisplay);
00253     
00254     
00255     <span class="comment">//</span>
00256     <span class="comment">// if STATUS_REGISTRY_CORRUPT and RecoverData don't bail out, keep recovering</span>
00257     <span class="comment">//</span>
00258     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; ((status != STATUS_REGISTRY_CORRUPT) || (result1 != <a class="code" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>)) ) {
00259         <span class="keywordflow">goto</span> Exit2;
00260     }
00261     
00262     <span class="comment">//</span>
00263     <span class="comment">// apply data recovery if we need it</span>
00264     <span class="comment">//</span>
00265     status = STATUS_SUCCESS;
00266     <span class="keywordflow">if</span> ( (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>) ||      <span class="comment">// -&gt; implies recover data</span>
00267          (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>) )
00268     {
00269         <span class="comment">//</span>
00270         <span class="comment">// recover data will enllist the free cells as well and </span>
00271         <span class="comment">// will restore the original read-only state of the hive</span>
00272         <span class="comment">//</span>
00273         result2 = <a class="code" href="../../d6/d1/hiveload_8c.html#a16">HvpRecoverData</a>(Hive,ReadOnlyFlagCopy,TailDisplay);
00274         <span class="keywordflow">if</span> (result2 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>) {
00275             status = STATUS_INSUFFICIENT_RESOURCES;
00276             <span class="keywordflow">goto</span> Exit2;
00277         }
00278         <span class="keywordflow">if</span> (result2 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>) {
00279             status = STATUS_REGISTRY_CORRUPT;
00280             <span class="keywordflow">goto</span> Exit2;
00281         }
00282         status = STATUS_REGISTRY_RECOVERED;
00283     }
00284 
00285     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a> = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a>;
00286     <span class="keywordflow">return</span> status;
00287 
00288 
00289 Exit2:
00290     <span class="comment">//</span>
00291     <span class="comment">// Clean up the bins already allocated </span>
00292     <span class="comment">//</span>
00293     <a class="code" href="../../d5/d1/hiveinit_8c.html#a2">HvpFreeAllocatedBins</a>( Hive );
00294 
00295     <span class="comment">//</span>
00296     <span class="comment">// Clean up the directory table</span>
00297     <span class="comment">//</span>
00298     <a class="code" href="../../d7/d1/hivemap_8c.html#a11">HvpCleanMap</a>( Hive );
00299 
00300 Exit1:
00301     <span class="keywordflow">if</span> (BaseBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00302         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(BaseBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00303     }
00304 
00305     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00306     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = 0;
00307     <span class="keywordflow">return</span> status;
00308 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="hive.h::HvMarkCellDirty" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvMarkCellDirty           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">117</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00187">HBIN_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">HvMarkDirty()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00292">HvpGetHCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00192">_HBIN::Signature</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00164">_HCELL::Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00161">USE_OLD_CELL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01087">CmpAddToLeaf()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00323">CmpCheckKey()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01704">CmpInsertSecurityCellList()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01608">CmpMarkIndexDirty()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00245">CmpMarkKeyDirty()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01870">CmpMarkKeyParentDirty()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01767">CmpMarkKeyValuesDirty()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01257">CmpSelectLeaf()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01472">CmpSplitLeaf()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01841">CmSetLastWriteTimeKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>.
<p>
<pre class="fragment"><div>00123                    :
00124 
00125     Marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified cell dirty.
00126 
00127 Arguments:
00128 
00129     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00130             hive of interest
00131 
00132     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - hcell_index of cell that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being edited
00133 
00134 Return Value:
00135 
00136     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00137 
00138     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - could not allocate log space, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>!
00139 
00140 --*/
00141 {
00142     ULONG       Type;
00143     ULONG       <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00144     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>      pCell;
00145     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Me;
00146     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Base;
00147     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00148 
00149     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_IO) {
00150         KdPrint((<span class="stringliteral">"HvMarkCellDirty:\n\t"</span>));
00151         KdPrint((<span class="stringliteral">"Hive:%08lx Cell:%08lx\n"</span>, Hive, Cell));
00152     }
00153 
00154     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00155     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00156     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00157 
00158     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00159 
00160     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) ||
00161          (Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) )
00162     {
00163         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00164     }
00165 
00166     pCell = <a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive,Cell);
00167 <span class="preprocessor">#if DBG</span>
00168 <span class="preprocessor"></span>    Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Cell);
00169     <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Cell);
00170     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00171     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> == HBIN_SIGNATURE);
00172 <span class="preprocessor">#endif</span>
00173 <span class="preprocessor"></span>    <span class="comment">//</span>
00174     <span class="comment">// If it's an old format hive, mark the entire</span>
00175     <span class="comment">// bin dirty, because the Last backpointers are</span>
00176     <span class="comment">// such a pain to deal with in the partial</span>
00177     <span class="comment">// alloc and free-coalescing cases.</span>
00178     <span class="comment">//</span>
00179 
00180     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00181         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Cell);
00182         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Cell);
00183         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00184         Base = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>;
00185         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00186         <span class="keywordflow">return</span> <a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(Hive, Base, Size);
00187     } <span class="keywordflow">else</span> {
00188         <span class="keywordflow">if</span> (pCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &lt; 0) {
00189             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = -pCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00190         } <span class="keywordflow">else</span> {
00191             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = pCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00192         }
00193         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Size &lt; Bin-&gt;Size);
00194         <span class="keywordflow">return</span> <a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(Hive, Cell-FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>,u.NewCell), Size);
00195     }
00196 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="hive.h::HvMarkClean" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvMarkClean           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Start</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00401">401</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d8/tbitmap_8c-source.html#l00028">BitMap</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>.
<p>
<pre class="fragment"><div>00408                    :
00409 
00410     Clears <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dirty bits <span class="keywordflow">for</span> a given portion of a hive.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00411     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inverse of <a class="code" href="../../d6/d0/hive_8h.html#a43">HvMarkDirty</a>, although <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not give up any
00412     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> space in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary or log that <a class="code" href="../../d6/d0/hive_8h.html#a43">HvMarkDirty</a> may have reserved.
00413 
00414     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a noop <span class="keywordflow">for</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a> address range.
00415 
00416 Arguments:
00417 
00418     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00419             hive of interest
00420 
00421     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - supplies a hive <span class="keyword">virtual</span> address (i.e., an HCELL_INDEX or
00422              like form address) of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> area to mark dirty.
00423 
00424     Length - inclusive length in bytes of area to mark dirty.
00425 
00426 Return Value:
00427 
00428     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00429 
00430 --*/
00431 {
00432     ULONG       Type;
00433     PRTL_BITMAP <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
00434     ULONG       First;
00435     ULONG       Last;
00436     ULONG       i;
00437     ULONG       Cluster;
00438 
00439     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_IO) {
00440         KdPrint((<span class="stringliteral">"HvMarkClean:\n\t"</span>));
00441         KdPrint((<span class="stringliteral">"Hive:%08lx Start:%08lx Length:%08lx\n"</span>, Hive, Start, Length));
00442     }
00443 
00444 
00445     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00446     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00447     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00448 
00449     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Start);
00450 
00451     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) ||
00452          (Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) )
00453     {
00454         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00455     }
00456 
00457     <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00458 
00459     First = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00460     Last = (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> + Length - 1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00461 
00462     Cluster = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00463     <span class="keywordflow">if</span> (Cluster &gt; 1) {
00464 
00465         <span class="comment">//</span>
00466         <span class="comment">// Force Start down to base of cluster</span>
00467         <span class="comment">// Force End up to top of cluster</span>
00468         <span class="comment">//</span>
00469         First = First &amp; ~(Cluster - 1);
00470         Last = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Last+1, Cluster) - 1;
00471     }
00472 
00473     <span class="keywordflow">if</span> (Last &gt;= <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>-&gt;SizeOfBitMap) {
00474         Last = <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>-&gt;SizeOfBitMap-1;
00475     }
00476 
00477     <span class="comment">//</span>
00478     <span class="comment">// Subtract out the dirty count and</span>
00479     <span class="comment">// and clear the dirty bits.</span>
00480     <span class="comment">//</span>
00481     <span class="keywordflow">for</span> (i=First; i&lt;=Last; i++) {
00482         <span class="keywordflow">if</span> (RtlCheckBit(BitMap,i)==1) {
00483             --<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a>;
00484             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a>(BitMap, i, 1);
00485         }
00486     }
00487     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00488 
00489     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00490 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="hive.h::HvMarkDirty" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvMarkDirty           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Start</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">270</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d8/tbitmap_8c-source.html#l00028">BitMap</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00097">CmpLazyFlush()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00204">HIVE_NOLAZYFLUSH</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00495">HvpGrowLog1()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00171">HvpMarkBinReadWrite</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01634">RtlSetBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>, and <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00847">HvpRecoverData()</a>.
<p>
<pre class="fragment"><div>00277                    :
00278 
00279     Marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relevent parts of a hive dirty, so that they will
00280     be flushed to backing store.
00281 
00282     If <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not 1, then adjacent all logical sectors
00283     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given cluster will be forced dirty (and log space
00284     allocated <span class="keywordflow">for</span> them.)  This must be done here rather than in
00285     HvSyncHive so that we can know how much to grow the log.
00286 
00287     This is a noop <span class="keywordflow">for</span> Volatile address range.
00288 
00289     NOTE:   Range will not be marked dirty <span class="keywordflow">if</span> operation fails.
00290 
00291 Arguments:
00292 
00293     Hive - supplies a pointer to the hive control structure <span class="keywordflow">for</span> the
00294             hive of interest
00295 
00296     Start - supplies a hive <span class="keyword">virtual</span> address (i.e., an HCELL_INDEX or
00297              like form address) of the start of the area to mark dirty.
00298 
00299     Length - inclusive length in bytes of area to mark dirty.
00300 
00301 Return Value:
00302 
00303     TRUE - it worked
00304 
00305     FALSE - could not allocate log space, failure!
00306 
00307 --*/
00308 {
00309     ULONG       Type;
00310     PRTL_BITMAP <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
00311     ULONG       First;
00312     ULONG       Last;
00313     ULONG       i;
00314     ULONG       Cluster;
00315     ULONG       OriginalDirtyCount;
00316     ULONG       DirtySectors;
00317     BOOLEAN     Result = TRUE;
00318 
00319     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_IO) {
00320         KdPrint((<span class="stringliteral">"HvMarkDirty:\n\t"</span>));
00321         KdPrint((<span class="stringliteral">"Hive:%08lx Start:%08lx Length:%08lx\n"</span>, Hive, Start, Length));
00322     }
00323 
00324 
00325     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00326     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00327     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00328 
00329     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Start);
00330 
00331     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; HIVE_VOLATILE) ||
00332          (Type == Volatile) )
00333     {
00334         <span class="keywordflow">return</span> TRUE;
00335     }
00336 
00337 
00338     <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00339     OriginalDirtyCount = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a>;
00340 
00341     First = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00342     Last = (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> + Length - 1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00343 
00344     Cluster = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00345     <span class="keywordflow">if</span> (Cluster &gt; 1) {
00346 
00347         <span class="comment">//</span>
00348         <span class="comment">// Force Start down to base of cluster</span>
00349         <span class="comment">// Force End up to top of cluster</span>
00350         <span class="comment">//</span>
00351         First = First &amp; ~(Cluster - 1);
00352         Last = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Last+1, Cluster) - 1;
00353     }
00354 
00355     <span class="keywordflow">if</span> (Last &gt;= <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>-&gt;SizeOfBitMap) {
00356         Last = <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>-&gt;SizeOfBitMap-1;
00357     }
00358 
00359     <span class="comment">//</span>
00360     <span class="comment">// Try and grow the log enough to accomodate all the dirty sectors.</span>
00361     <span class="comment">//</span>
00362     DirtySectors = 0;
00363     <span class="keywordflow">for</span> (i = First; i &lt;= Last; i++) {
00364         <span class="keywordflow">if</span> (RtlCheckBit(<a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>, i)==0) {
00365             ++DirtySectors;
00366         }
00367     }
00368     <span class="keywordflow">if</span> (DirtySectors != 0) {
00369         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a11">HvpGrowLog1</a>(Hive, DirtySectors) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00370             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00371         }
00372     
00373         <span class="keywordflow">if</span> ((OriginalDirtyCount == 0) &amp;&amp; (First != 0)) {
00374             Result = <a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(Hive, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));  <span class="comment">// force header of 1st bin dirty</span>
00375             <span class="keywordflow">if</span> (Result==<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00376                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00377             }
00378         }
00379     
00380         <span class="comment">//</span>
00381         <span class="comment">// Log has been successfully grown, go ahead</span>
00382         <span class="comment">// and set the dirty bits.</span>
00383         <span class="comment">//</span>
00384         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00385         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> += DirtySectors;
00386         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a>(<a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>, First, Last-First+1);
00387     }
00388 
00389     <span class="comment">// mark this bin as writable</span>
00390     <a class="code" href="../../d1/d2/cmp_8h.html#a12">HvpMarkBinReadWrite</a>(Hive,Start);
00391         
00392     <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>)) {
00393         <a class="code" href="../../d6/d3/cmwraper_8c.html#a11">CmpLazyFlush</a>();
00394     }
00395     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00396     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00397 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="hive.h::HvpAddBin" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> HvpAddBin           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="hive.h::HvpAllocateMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvpAllocateMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Dir</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Start</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>End</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00853">853</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00447">_HMAP_DIRECTORY::Directory</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00050">End</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>, <a class="el" href="../../d5/d0/genmips_8c-source.html#l00109">t()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, and <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00304">HvpInitMap()</a>.
<p>
<pre class="fragment"><div>00861                    :
00862 
00863     Sweeps through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory Dir points to and allocates Tables.
00864     Will allocate <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>-th through <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>-th entries, INCLUSIVE.
00865 
00866     Does NOT clean up when <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of memory, call <a class="code" href="../../d6/d0/hive_8h.html#a16">HvpFreeMap</a> to <span class="keywordflow">do</span> that.
00867 Arguments:
00868 
00869     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block of interest
00870 
00871     Dir - supplies address of an <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a> structure
00872 
00873     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - index of first map table pointer to allocate <span class="keywordflow">for</span>
00874 
00875     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> - index of last map table pointer to allocate <span class="keywordflow">for</span>
00876 
00877 Return Value:
00878 
00879     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00880 
00881     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - insufficient memory
00882 
00883 --*/
00884 {
00885     ULONG   i;
00886     PVOID   <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00887 
00888     <span class="keywordflow">for</span> (i = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>; i &lt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>; i++) {
00889         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[i] == NULL);
00890         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = (PVOID)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>));
00891         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00892             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00893         }
00894         RtlZeroMemory(t, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00895         Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[i] = (<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>)<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00896     }
00897     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00898 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="hive.h::HvpBuildMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvpBuildMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Image</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00536">536</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00258">CMS_HIVE</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00187">HBIN_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00751">HvpCleanMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">HvpEnlistBinInMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00304">HvpInitMap()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00192">_HBIN::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.
<p>
<pre class="fragment"><div>00543                    :
00544 
00545     Creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> storage of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive, and inits
00546     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">volatile</span> storage.
00547 
00548     Following fields in hive must already be filled in:
00549 
00550          Allocate, Free
00551 
00552     Will initialize Storage structure of <a class="code" href="../../d7/d7/struct__HHIVE.html">HHIVE</a>.
00553 
00554 Arguments:
00555 
00556     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure to build map <span class="keywordflow">for</span>.
00557 
00558     Image - pointer to in memory image of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00559 
00560 Return Value:
00561 
00562     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00563     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - either hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> corrupt or no memory <span class="keywordflow">for</span> map
00564 
00565 --*/
00566 {
00567     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00568     ULONG           <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00569     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00570     ULONG           Length;
00571 
00572 
00573     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_HIVE) {
00574         KdPrint((<span class="stringliteral">"HvpBuildMap:\n"</span>));
00575         KdPrint((<span class="stringliteral">"\tHive=%08lx"</span>,Hive));
00576     }
00577 
00578     <span class="comment">//</span>
00579     <span class="comment">// Init the map</span>
00580     <span class="comment">//</span>
00581     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/hivemap_8c.html#a7">HvpInitMap</a>(Hive);
00582 
00583     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00584         <span class="comment">//</span>
00585         <span class="comment">// just return failure; HvpInitMap took care of cleanup</span>
00586         <span class="comment">//</span>
00587         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00588     }
00589 
00590     <span class="comment">//</span>
00591     <span class="comment">// Fill in the map</span>
00592     <span class="comment">//</span>
00593     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
00594     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Image;
00595     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length;
00596 
00597     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> &lt; (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((PUCHAR)(Image) + Length)) {
00598 
00599         <span class="comment">//</span>
00600         <span class="comment">// Check the validity of the bin header</span>
00601         <span class="comment">//</span>
00602         <span class="keywordflow">if</span> ( (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> &gt; Length)                       ||
00603              (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> &lt; <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>)                  ||
00604              (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>)         ||
00605              (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> != <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>)) {
00606             <span class="comment">//</span>
00607             <span class="comment">// Bin is bogus</span>
00608             <span class="comment">//</span>
00609             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00610             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Hive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00611             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 0xA001;
00612             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = Length;
00613             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00614             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00615             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00616         }
00617 
00618         <span class="comment">//</span>
00619         <span class="comment">// enlist this bin</span>
00620         <span class="comment">//</span>
00621         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/hivemap_8c.html#a8">HvpEnlistBinInMap</a>(Hive, Length, Bin, Offset, TailDisplay);
00622 
00623         <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00624             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00625         }
00626 
00627         <span class="comment">//</span>
00628         <span class="comment">// the next bin</span>
00629         <span class="comment">//</span>
00630         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00631 
00632         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
00633     }
00634 
00635     <span class="keywordflow">return</span> STATUS_SUCCESS;
00636 
00637 
00638 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
00639     <span class="comment">//</span>
00640     <span class="comment">// Clean up the directory table</span>
00641     <span class="comment">//</span>
00642     <a class="code" href="../../d7/d1/hivemap_8c.html#a11">HvpCleanMap</a>( Hive );
00643 
00644     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00645 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="hive.h::HvpBuildMapAndCopy" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvpBuildMapAndCopy           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Image</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">47</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00258">CMS_HIVE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00609">_HHIVE::DirtyAlloc</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00187">HBIN_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00413">HMAP_NEWALLOC</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00132">HTABLE_SLOTS</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00853">HvpAllocateMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00649">HvpEnlistFreeCells()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00807">HvpFreeMap()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00344">_HBASE_BLOCK::Length</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00200">_HBIN::MemAlloc</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00219">RtlInitializeBitMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00192">_HBIN::Signature</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d0/genmips_8c-source.html#l00109">t()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.
<p>
<pre class="fragment"><div>00054                    :
00055 
00056     Creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> storage of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive, and inits
00057     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">volatile</span> storage.
00058 
00059     Following fields in hive must already be filled in:
00060 
00061          Allocate, Free
00062 
00063     Will initialize Storage structure of <a class="code" href="../../d7/d7/struct__HHIVE.html">HHIVE</a>.
00064 
00065     The difference between <span class="keyword">this</span> routine and <a class="code" href="../../d6/d0/hive_8h.html#a22">HvpBuildMapAndCopy</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that
00066     <span class="keyword">this</span> routine will create a <span class="stringliteral">"sparse"</span> map.  As <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SourceImage
00067     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly allocated memory <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will avoid
00068     allocating space <span class="keywordflow">for</span> HBINs that contain nothing but free space.  The
00069     HBLOCKs in these HBINs will be marked as discarded, and <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>
00070     will allocate memory <span class="keywordflow">for</span> them <span class="keywordflow">if</span> necessary.
00071 
00072 Arguments:
00073 
00074     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure to build map <span class="keywordflow">for</span>.
00075 
00076     Image - pointer to flat memory image of original hive.
00077 
00078 Return Value:
00079 
00080     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00081     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - either hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> corrupt or no memory <span class="keywordflow">for</span> map
00082 
00083 --*/
00084 {
00085     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
00086     ULONG           Length;
00087     ULONG           MapSlots;
00088     ULONG           Tables;
00089     <a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>     <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00090     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> d = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00091     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00092     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           NewBins;
00093     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           CurrentBin;
00094     ULONG           <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00095     ULONG_PTR        Address;
00096     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00097     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00098     PULONG          Vector;
00099     ULONG           <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00100 
00101 
00102     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_HIVE) {
00103         KdPrint((<span class="stringliteral">"HvpBuildMap:\n"</span>));
00104         KdPrint((<span class="stringliteral">"\tHive=%08lx"</span>,Hive));
00105     }
00106 
00107 
00108     <span class="comment">//</span>
00109     <span class="comment">// Compute size of data region to be mapped</span>
00110     <span class="comment">//</span>
00111     BaseBlock = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>;
00112     Length = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>;
00113     <span class="keywordflow">if</span> ((Length % <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) != 0 ) {
00114         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00115         <span class="keywordflow">goto</span> ErrorExit1;
00116     }
00117     MapSlots = Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00118     <span class="keywordflow">if</span>( MapSlots &gt; 0 ) {
00119         Tables = (MapSlots-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00120     } <span class="keywordflow">else</span> {
00121         Tables = 0;
00122     }
00123 
00124     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length = Length;
00125 
00126     <span class="comment">//</span>
00127     <span class="comment">// allocate dirty vector if one is not already present (from HvpRecoverData)</span>
00128     <span class="comment">//</span>
00129 
00130     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00131         Vector = (PULONG)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Length/HSECTOR_SIZE/8,<span class="keyword">sizeof</span>(ULONG)), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00132         <span class="keywordflow">if</span> (Vector == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00133             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00134             <span class="keywordflow">goto</span> ErrorExit1;
00135         }
00136         RtlZeroMemory(Vector, Length / HSECTOR_SIZE / 8);
00137         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>, Vector, Length / HSECTOR_SIZE);
00138         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a> = (Length/<a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>/8);
00139     }
00140 
00141     <span class="comment">//</span>
00142     <span class="comment">// allocate and build structure for map</span>
00143     <span class="comment">//</span>
00144     <span class="keywordflow">if</span> (Tables == 0) {
00145 
00146         <span class="comment">//</span>
00147         <span class="comment">// Just 1 table, no need for directory</span>
00148         <span class="comment">//</span>
00149         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00150         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00151             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00152             <span class="keywordflow">goto</span> ErrorExit1;
00153         }
00154         RtlZeroMemory(t, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00155         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map =
00156             (<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>)&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir);
00157         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00158 
00159     } <span class="keywordflow">else</span> {
00160 
00161         <span class="comment">//</span>
00162         <span class="comment">// Need directory and multiple tables</span>
00163         <span class="comment">//</span>
00164         d = (<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00165         <span class="keywordflow">if</span> (d == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00166             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00167             <span class="keywordflow">goto</span> ErrorExit1;
00168         }
00169         RtlZeroMemory(d, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00170 
00171         <span class="comment">//</span>
00172         <span class="comment">// Allocate tables and fill in dir</span>
00173         <span class="comment">//</span>
00174         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/hivemap_8c.html#a13">HvpAllocateMap</a>(Hive, d, 0, Tables) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00175             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00176             <span class="keywordflow">goto</span> ErrorExit2;
00177         }
00178         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map = d;
00179         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = 0;
00180     }
00181 
00182     <span class="comment">//</span>
00183     <span class="comment">// Now we have to allocate the memory for the HBINs and fill in</span>
00184     <span class="comment">// the map appropriately.  We are careful never to allocate less</span>
00185     <span class="comment">// than a page to avoid fragmenting pool.  As long as the page</span>
00186     <span class="comment">// size is a multiple of HBLOCK_SIZE (a fairly good assumption as</span>
00187     <span class="comment">// long as HBLOCK_SIZE is 4k) this strategy will prevent pool</span>
00188     <span class="comment">// fragmentation.</span>
00189     <span class="comment">//</span>
00190     <span class="comment">// If we come across an HBIN that is entirely composed of a freed</span>
00191     <span class="comment">// HCELL, then we do not allocate memory, but mark its HBLOCKs in</span>
00192     <span class="comment">// the map as not present.  HvAllocateCell will allocate memory for</span>
00193     <span class="comment">// the bin when it is needed.</span>
00194     <span class="comment">//</span>
00195     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
00196     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
00197     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Image;
00198 
00199     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> &lt; (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((PUCHAR)(Image) + Length)) {
00200 
00201         <span class="keywordflow">if</span> ( (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> &gt; (Length-<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>))               ||
00202              (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>)         ||
00203              (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> != (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>+<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>))
00204            )
00205         {
00206             <span class="comment">//</span>
00207             <span class="comment">// Bin is bogus</span>
00208             <span class="comment">//</span>
00209             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00210             <span class="keywordflow">goto</span> ErrorExit2;
00211         }
00212 
00213         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00214         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &amp;&amp;
00215             (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> + Length - <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
00216 
00217             <span class="comment">//</span>
00218             <span class="comment">// We haven't accumulated enough bins to fill up a page</span>
00219             <span class="comment">// yet, and there are still bins left, so group this one</span>
00220             <span class="comment">// in with the next one.</span>
00221             <span class="comment">//</span>
00222             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
00223 
00224             <span class="keywordflow">continue</span>;
00225 
00226         }
00227 
00228         <span class="comment">//</span>
00229         <span class="comment">// We now have a series of HBINs to group together in one</span>
00230         <span class="comment">// chunk of memory.</span>
00231         <span class="comment">//</span>
00232         NewBins = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00233         <span class="keywordflow">if</span> (NewBins==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00234             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00235             <span class="keywordflow">goto</span> ErrorExit2;        <span class="comment">//fixfix</span>
00236         }
00237         RtlCopyMemory(NewBins,
00238                       (PUCHAR)Image+Offset,
00239                       Size);
00240         NewBins-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00241 
00242         <span class="comment">//</span>
00243         <span class="comment">// create map entries for each block/page in bin</span>
00244         <span class="comment">//</span>
00245         Address = (ULONG_PTR)NewBins;
00246         <span class="keywordflow">do</span> {
00247             CurrentBin = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Address;
00248             <span class="keywordflow">do</span> {
00249                 Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Offset);
00250                 <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Offset);
00251                 Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> = Address;
00252                 Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> = (ULONG_PTR)CurrentBin;
00253 
00254                 <span class="keywordflow">if</span> (CurrentBin == NewBins) {
00255                     Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> |= <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>;
00256                 } <span class="keywordflow">else</span> {
00257                     CurrentBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> = 0;
00258                 }
00259                 Address += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00260                 <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00261             } <span class="keywordflow">while</span> ( Address &lt; ((ULONG_PTR)CurrentBin + CurrentBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> ));
00262 
00263             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00264 
00265                 <span class="comment">//</span>
00266                 <span class="comment">// add free cells in the bin to the appropriate free lists</span>
00267                 <span class="comment">//</span>
00268                 <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d1/hivemap_8c.html#a10">HvpEnlistFreeCells</a>(Hive,
00269                                           CurrentBin,
00270                                           CurrentBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>,
00271                                           TailDisplay
00272                                           )) {
00273                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00274                     <span class="keywordflow">goto</span> ErrorExit2;
00275                 }
00276 
00277             }
00278 
00279         } <span class="keywordflow">while</span> ( Address &lt; (ULONG_PTR)NewBins + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> );
00280 
00281         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
00282         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
00283     }
00284 
00285     <span class="keywordflow">return</span> STATUS_SUCCESS;
00286 
00287 
00288 ErrorExit2:
00289     <span class="keywordflow">if</span> (d != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00290 
00291         <span class="comment">//</span>
00292         <span class="comment">// directory was built and allocated, so clean it up</span>
00293         <span class="comment">//</span>
00294 
00295         <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(Hive, d, 0, Tables);
00296         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(d, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00297     }
00298 
00299 ErrorExit1:
00300     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00301 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="hive.h::HvpCleanMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpCleanMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00751">751</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00132">HTABLE_SLOTS</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00807">HvpFreeMap()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00100">HvLoadHive()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00536">HvpBuildMap()</a>, and <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00311">HvpReadFileImageAndBuildMap()</a>.
<p>
<pre class="fragment"><div>00756                    :
00757 
00758     Cleans all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map allocations <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stable storage
00759 
00760   Arguments:
00761 
00762     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure to build map <span class="keywordflow">for</span>.
00763 
00764 Return Value:
00765 
00766     None
00767 --*/
00768 {
00769     ULONG           Length;
00770     ULONG           MapSlots;
00771     ULONG           Tables;
00772     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> d = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00773 
00774     <span class="comment">//</span>
00775     <span class="comment">// Compute MapSlots and Tables based on the Length</span>
00776     <span class="comment">//</span>
00777     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length;
00778     MapSlots = Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00779     <span class="keywordflow">if</span>( MapSlots &gt; 0 ) {
00780         Tables = (MapSlots-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00781     } <span class="keywordflow">else</span> {
00782         Tables = 0;
00783     }
00784 
00785     <span class="keywordflow">if</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir == 0 ) {
00786         <span class="comment">//</span>
00787         <span class="comment">// directory was built and allocated, so clean it up</span>
00788         <span class="comment">//</span>
00789 
00790         d = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map;
00791         <span class="keywordflow">if</span>( d != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00792             <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(Hive, d, 0, Tables);
00793             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(d, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00794         }
00795     } <span class="keywordflow">else</span> {
00796         <span class="comment">//</span>
00797         <span class="comment">// no directory, just a smalldir</span>
00798         <span class="comment">//</span>
00799         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00800     }
00801     
00802     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00803     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00804 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="hive.h::HvpDelistFreeCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpDelistFreeCell           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d4/struct__HCELL.html">PHCELL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Pcell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01203">1203</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
<pre class="fragment"><div>01216                    :
01217 
01218     Removes a free cell from its list, and clears <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Summary
01219     bit <span class="keywordflow">for</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> need be.
01220 
01221 Arguments:
01222 
01223     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01224             hive of interest
01225 
01226     Pcell - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a> structure of interest
01227 
01228     Type - <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> vs. <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>
01229 
01230 Return Value:
01231 
01232     NONE.
01233 
01234 --*/
01235 {
01236     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
01237     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Prev = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01238     ULONG       <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01239 
01240     <a class="code" href="../../d8/d0/hivecell_8c.html#a2">HvpComputeIndex</a>(Index, Pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>);
01241     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeDisplay[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
01242 
01243     <span class="comment">//</span>
01244     <span class="comment">// Find previous cell on list</span>
01245     <span class="comment">//</span>
01246     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*List != HCELL_NIL);
01247     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive,*List) != Pcell) {
01248         Prev = *<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
01249         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = (<a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,*List);
01250         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*List != HCELL_NIL);
01251     }
01252 
01253     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(TailDisplay)) {
01254         <span class="comment">//</span>
01255         <span class="comment">// This should only happen once, at boot time; Then, we want to sort the list ascedending</span>
01256         <span class="comment">//</span>
01257         <span class="keywordflow">if</span>( *<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> == TailDisplay[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] ) {
01258             <span class="comment">//</span>
01259             <span class="comment">// this cell is also the last cell on list; so it should be reset</span>
01260             <span class="comment">//</span>
01261 
01262 <span class="preprocessor">#if DBG</span>
01263 <span class="preprocessor"></span>            <span class="comment">//</span>
01264             <span class="comment">// consistency checks</span>
01265             <span class="comment">//</span>
01266             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01267                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.Next == HCELL_NIL);
01268             } <span class="keywordflow">else</span> {
01269                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.Next == HCELL_NIL);
01270             }
01271 <span class="preprocessor">#endif</span>
01272 <span class="preprocessor"></span>
01273             TailDisplay[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = Prev;
01274         }
01275     }
01276 
01277     <span class="comment">//</span>
01278     <span class="comment">// Remove Pcell from list.</span>
01279     <span class="comment">//</span>
01280     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01281         *<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = Pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.Next;
01282     } <span class="keywordflow">else</span> {
01283         *<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = Pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.Next;
01284     }
01285 
01286     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeDisplay[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01287         <span class="comment">//</span>
01288         <span class="comment">// consistency check</span>
01289         <span class="comment">//</span>
01290         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Prev == HCELL_NIL);
01291 
        <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeSummary &amp;= ~(1 &lt;&lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="hive.h::HvpDoWriteHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvpDoWriteHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">775</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d9/d8/tbitmap_8c-source.html#l00028">BitMap</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00348">_HBASE_BLOCK::CheckSum</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00345">_HBASE_BLOCK::Cluster</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00227">CmpDoFileSetSize()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00480">CMP_OFFSET_ARRAY::DataBuffer</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00481">CMP_OFFSET_ARRAY::DataLength</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00603">_HHIVE::FileFlush</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00479">CMP_OFFSET_ARRAY::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00601">_HHIVE::FileWrite</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00342">_HBASE_BLOCK::Format</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00323">HBASE_BLOCK_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00329">HBASE_FORMAT_MEMORY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00058">HLOG_MINSIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00325">HSYS_MAJOR</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01233">HvpFindNextDirtyBlock()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d0/d1/hivesum_8c-source.html#l00031">HvpHeaderCheckSum()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00344">_HBASE_BLOCK::Length</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00619">_HHIVE::Log</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00624">_HHIVE::LogSize</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00339">_HBASE_BLOCK::Major</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00336">_HBASE_BLOCK::Sequence1</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00337">_HBASE_BLOCK::Sequence2</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00335">_HBASE_BLOCK::Signature</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00196">_HBIN::TimeStamp</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00338">_HBASE_BLOCK::TimeStamp</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00341">_HBASE_BLOCK::Type</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>.
<p>
<pre class="fragment"><div>00781                    :
00782 
00783     Write dirty parts of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> to either its primary or alternate
00784     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  Write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> header, flush, write all data, flush, update header,
00785     flush.  Assume either logging or primary/alternate pairs used.
00786 
00787     NOTE:   TimeStamp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not set, assumption <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that <a class="code" href="../../d0/d2/hivesync_8c.html#a2">HvpWriteLog</a> set
00788             that.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> used <span class="keywordflow">for</span> checking <span class="keywordflow">if</span> Logs correspond anyway.
00789 
00790 Arguments:
00791 
00792     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> <span class="keywordflow">for</span> which dirty data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be written.
00793 
00794     FileType - indicated whether primary or alternate <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> should be written.
00795 
00796 Return Value:
00797 
00798     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00799 
00800     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> failed
00801 
00802 --*/
00803 {
00804     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
00805     ULONG           <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00806     PUCHAR          Address;
00807     ULONG           Length;
00808     BOOLEAN         rc;
00809     ULONG           Current;
00810     PRTL_BITMAP     <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
00811     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00812     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00813     BOOLEAN         ShrinkHive;
00814     <a class="code" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a> offsetArray;
00815     <a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html">CMP_OFFSET_ARRAY</a> offsetElement;
00816     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00817     ULONG SetBitCount;
00818 
00819     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_IO) {
00820         KdPrint((<span class="stringliteral">"HvpDoWriteHive:\n\t"</span>));
00821         KdPrint((<span class="stringliteral">"Hive:%08lx FileType:%08lx\n"</span>, Hive, FileType));
00822     }
00823 
00824     <span class="comment">//</span>
00825     <span class="comment">// flush first, so that the filesystem structures get written to</span>
00826     <span class="comment">// disk if we have grown the file.</span>
00827     <span class="comment">//</span>
00828     <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileType)) {
00829         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00830     }
00831 
00832     BaseBlock = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>;
00833 
00834     <span class="keywordflow">if</span> (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> &gt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length) {
00835         ShrinkHive = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00836     } <span class="keywordflow">else</span> {
00837         ShrinkHive = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00838     }
00839 
00840     <span class="comment">//</span>
00841     <span class="comment">// --- Write out header first time, flush ---</span>
00842     <span class="comment">//</span>
00843     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> == HBASE_BLOCK_SIGNATURE);
00844     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> == HSYS_MAJOR);
00845     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a> == HBASE_FORMAT_MEMORY);
00846     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00847 
00848 
00849     <span class="keywordflow">if</span> (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a> != BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>) {
00850 
00851         <span class="comment">//</span>
00852         <span class="comment">// Some previous log attempt failed, or this hive needs to</span>
00853         <span class="comment">// be recovered, so punt.</span>
00854         <span class="comment">//</span>
00855         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00856     }
00857 
00858     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length;
00859 
00860     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a>++;
00861     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
00862     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o10">Cluster</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00863     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a> = <a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock);
00864 
00865     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
00866     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o0">FileOffset</a> = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00867     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o1">DataBuffer</a> = (PVOID) BaseBlock;
00868     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o2">DataLength</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00869     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
00870             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00871             FileType,
00872             &amp;offsetElement,
00873             1,
00874             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
00875             );
00876 
00877     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00878         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00879     }
00880     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileType)) {
00881         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00882     }
00883     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Offset, HBLOCK_SIZE);
00884 
00885     <span class="comment">//</span>
00886     <span class="comment">// --- Write out dirty data (only if there is any) ---</span>
00887     <span class="comment">//</span>
00888 
00889     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00890         <span class="comment">//</span>
00891         <span class="comment">// First sector of first bin will always be dirty, write it out</span>
00892         <span class="comment">// with the TimeStamp value overlaid on its Link field.</span>
00893         <span class="comment">//</span>
00894         <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00895 
00896         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RtlCheckBit(BitMap, 0) == 1);
00897         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RtlCheckBit(BitMap, (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> - 1)) == 1);
00898         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(LIST_ENTRY) &gt;= <span class="keyword">sizeof</span>(LARGE_INTEGER));
00899 
00900         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, 0);
00901         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,0);
00902         Address = (PUCHAR)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
00903         Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00904         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Address;
00905         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o4">TimeStamp</a> = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>;
00906 
00907         offsetElement.FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00908         offsetElement.DataBuffer = (PVOID) Address;
00909         offsetElement.DataLength = Length;
00910         rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
00911                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00912                 FileType,
00913                 &amp;offsetElement,
00914                 1,
00915                 &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
00916                 );
00917         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Offset % (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * HSECTOR_SIZE)) == 0);
00918         <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00919             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00920         }
00921 
00922 
00923         <span class="comment">//</span>
00924         <span class="comment">// Write out the rest of the dirty data</span>
00925         <span class="comment">//</span>
00926         Current = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;        <span class="comment">// don't rewrite 1st bin or header</span>
00927 
00928         SetBitCount = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(BitMap);
00929         offsetArray =
00930             (<a class="code" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a>)
00931             <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
00932                            <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html">CMP_OFFSET_ARRAY</a>) * SetBitCount);
00933         <span class="keywordflow">if</span> (offsetArray == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00934             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00935         }
00936         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00937 
00938         <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a3">HvpFindNextDirtyBlock</a>(
00939                     Hive,
00940                     BitMap,
00941                     &amp;Current,
00942                     &amp;Address,
00943                     &amp;Length,
00944                     &amp;Offset
00945                     ) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
00946         {
00947             <span class="comment">// Gather data into array.</span>
00948             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Count &lt; SetBitCount);
00949             offsetArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00950             offsetArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].DataBuffer = Address;
00951             offsetArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].DataLength = Length;
00952             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += Length;
00953             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++;
00954             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Offset % (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * HSECTOR_SIZE)) == 0);
00955         }
00956 
00957             rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
00958                     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00959                     FileType,
00960             offsetArray,
00961             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>,
00962             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>             <span class="comment">// Just an OUT parameter which returns the point</span>
00963                                 <span class="comment">// in the file after the last write.</span>
00964                     );
00965         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(offsetArray);
00966             <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00967                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00968         }
00969     }
00970 
00971     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileType)) {
00972         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00973     }
00974 
00975     <span class="comment">//</span>
00976     <span class="comment">// --- Write header again to report completion ---</span>
00977     <span class="comment">//</span>
00978     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>++;
00979     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a> = <a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock);
00980     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
00981 
00982     offsetElement.FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00983     offsetElement.DataBuffer = (PVOID) BaseBlock;
00984     offsetElement.DataLength = <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00985     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
00986             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00987             FileType,
00988             &amp;offsetElement,
00989             1,
00990             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
00991             );
00992     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00993         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00994     }
00995 
00996     <span class="keywordflow">if</span> (ShrinkHive) {
00997         <span class="comment">//</span>
00998         <span class="comment">// Hive has shrunk, give up the excess space.</span>
00999         <span class="comment">//</span>
01000         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a13">CmpDoFileSetSize</a>(Hive, FileType, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Stable].Length + HBLOCK_SIZE);
01001     }
01002 
01003     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileType)) {
01004         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01005     }
01006 
01007     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a>) &amp;&amp;
01008         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a4">HLOG_MINSIZE</a>(Hive))) {
01009         <span class="comment">//</span>
01010         <span class="comment">// Shrink log back down, reserve at least two clusters</span>
01011         <span class="comment">// worth of space so that if all the disk space is</span>
01012         <span class="comment">// consumed, there will still be enough space prereserved</span>
01013         <span class="comment">// to allow a minimum of registry operations so the user</span>
01014         <span class="comment">// can log on.</span>
01015         <span class="comment">//</span>
01016         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a13">CmpDoFileSetSize</a>(Hive, HFILE_TYPE_LOG, <a class="code" href="../../d0/d1/hivedata_8h.html#a4">HLOG_MINSIZE</a>(Hive));
01017         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a4">HLOG_MINSIZE</a>(Hive);
01018     }
01019 
01020     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01021 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="hive.h::HvpEnlistBinInMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvpEnlistBinInMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Bin</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Offset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">437</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00249">CML_BIN</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00269">CMS_BIN_MAP</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00258">CMS_HIVE</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00413">HMAP_NEWALLOC</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00649">HvpEnlistFreeCells()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00200">_HBIN::MemAlloc</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00536">HvpBuildMap()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00311">HvpReadFileImageAndBuildMap()</a>, and <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00847">HvpRecoverData()</a>.
<p>
<pre class="fragment"><div>00446                    :
00447 
00448     Creates map entries and enlist free cells <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified bin 
00449 
00450 Arguments:
00451 
00452     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target map
00453 
00454     Length - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive image
00455 
00456     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bin to be enlisted
00457 
00458     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00459 
00460     TailDisplay - array containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tail ends of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free cell lists - optional
00461 
00462 Return Value:
00463 
00464     STATUS_SUCCESS - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00465     STATUS_REGISTRY_CORRUPT - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bin <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> inconsistent
00466 
00467 --*/
00468 {
00469     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00470     ULONG           BinOffset;
00471     ULONG_PTR       Address;
00472     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00473 
00474     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_HIVE) {
00475         KdPrint((<span class="stringliteral">"HvpEnlistBinInMap:\n"</span>));
00476         KdPrint((<span class="stringliteral">"\tHive=%08lx\t Offset=%08lx"</span>,Hive,Offset));
00477     }
00478 
00479     <span class="comment">//</span>
00480     <span class="comment">// memory was allocated for this bin</span>
00481     <span class="comment">//</span>
00482     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00483     
00484     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BIN, CMS_BIN_MAP) {
00485         KdPrint((<span class="stringliteral">"HvpEnlistBinInMap: BinAddress = 0x%08lx\t Size = 0x%lx\n"</span>, Bin, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>));
00486     }
00487 
00488     <span class="comment">//</span>
00489     <span class="comment">// create map entries for each block/page in bin</span>
00490     <span class="comment">//</span>
00491     BinOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00492     <span class="keywordflow">for</span> (Address = (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00493          Address &lt; ((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
00494          Address += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>
00495         )
00496     {
00497         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Offset);
00498         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Offset);
00499         Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> = Address;
00500         Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> = (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00501         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> == BinOffset) {
00502             Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> |= <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>;
00503         }
00504         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00505     }
00506 
00507     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00508 
00509         <span class="comment">//</span>
00510         <span class="comment">// add free cells in the bin to the appropriate free lists</span>
00511         <span class="comment">//</span>
00512         <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d1/hivemap_8c.html#a10">HvpEnlistFreeCells</a>(Hive, Bin, BinOffset,TailDisplay)) {
00513             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Hive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00514             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 0xA002;
00515             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = Length;
00516             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = BinOffset;
00517             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00518             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00519             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00520         }
00521 
00522     }
00523 
00524     <span class="comment">//</span>
00525     <span class="comment">// logical consistency check</span>
00526     <span class="comment">//</span>
00527     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Offset == (BinOffset + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>));
00528 
00529     <span class="keywordflow">return</span> STATUS_SUCCESS;
00530 
00531 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
00532     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00533 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="hive.h::HvpEnlistFreeCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpEnlistFreeCell           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CoalesceForward</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00947">947</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, and <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00649">HvpEnlistFreeCells()</a>.
<p>
<pre class="fragment"><div>00962                    :
00963 
00964     Puts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly freed cell on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate list.
00965 
00966 Arguments:
00967 
00968     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00969             hive of interest
00970 
00971     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of cell to enlist
00972 
00973     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - size of cell
00974 
00975     Type - indicates whether <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> or <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a> storage <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> desired.
00976 
00977     CoalesceForward - indicates whether we can coalesce forward or not.
00978         For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> where we have not finished scanning <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive and
00979         enlisting free cells, we <span class="keywordflow">do</span> not want to coalesce forward.
00980 
00981 Return Value:
00982 
00983     NONE.
00984 
00985 --*/
00986 {
00987     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> Last;
00988     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> First;
00989     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Map;
00990     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a> pcell;
00991     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a> pcellLast;
00992     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a> FirstCell;
00993     ULONG   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00994     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>   <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00995     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> FreeCell;
00996     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a> FreeBin;
00997     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>   FirstBin;
00998     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>   LastBin;
00999 
01000     <a class="code" href="../../d8/d0/hivecell_8c.html#a2">HvpComputeIndex</a>(Index, Size);
01001 
01002     
01003     First = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeDisplay[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
01004     pcell = <a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive, Cell);
01005     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt; 0);
01006     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Size == (ULONG)pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>);
01007 
01008     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(TailDisplay)) {
01009         <span class="comment">//</span>
01010         <span class="comment">// This should only happen once, at boot time; Then, we want to sort the list ascedending</span>
01011         <span class="comment">//</span>
01012         Last = &amp;TailDisplay[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01013         <span class="keywordflow">if</span>( *Last != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> ) {
01014         <span class="comment">//</span>
01015         <span class="comment">// there is a last cell; insert current cell right after it.</span>
01016         <span class="comment">// and set the next cell pointer for the current cell to NIL</span>
01017         <span class="comment">//</span>
01018             pcellLast = <a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive,*Last);
01019             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pcellLast-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt; 0);
01020 
01021             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01022                 pcellLast-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.Next = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01023                 pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.Next = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01024             } <span class="keywordflow">else</span> {
01025                 pcellLast-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.Next = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01026                 pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.Next = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01027             }
01028         } <span class="keywordflow">else</span> {
01029         <span class="comment">//</span>
01030         <span class="comment">// No Last cell; Insert it at the begining and set the last cell pointing to it as well</span>
01031         <span class="comment">// Sanity check: First cell should be also NIL</span>
01032         <span class="comment">//</span>
01033             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( *First == HCELL_NIL );
01034 
01035             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01036                 pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.Next = *First;
01037             } <span class="keywordflow">else</span> {
01038                 pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.Next = *First;
01039             }
01040             *First = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01041         }
01042         <span class="comment">//</span>
01043         <span class="comment">// The current cell becomes the last cell</span>
01044         <span class="comment">//</span>
01045         *Last = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01046     } <span class="keywordflow">else</span> {
01047     <span class="comment">//</span>
01048     <span class="comment">// Normal case, insert the cell at the begining of the list (speed reasons).</span>
01049     <span class="comment">//</span>
01050         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01051             pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.Next = *First;
01052         } <span class="keywordflow">else</span> {
01053             pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.Next = *First;
01054         }
01055         *First = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01056     }
01057 
01058 
01059     <span class="comment">//</span>
01060     <span class="comment">// Check to see if this is the first cell in the bin and if the entire</span>
01061     <span class="comment">// bin consists just of this cell.</span>
01062     <span class="comment">//</span>
01063     Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Cell);
01064     <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,Cell);
01065     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; ~<a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>);
01066     <span class="keywordflow">if</span> ((pcell == (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + 1)) &amp;&amp;
01067         (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> == <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>-<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>))) {
01068 
01069         <span class="comment">//</span>
01070         <span class="comment">// We have a bin that is entirely free.  But we cannot do anything with it</span>
01071         <span class="comment">// unless the memalloc that contains the bin is entirely free.  Walk the</span>
01072         <span class="comment">// bins backwards until we find the first one in the alloc, then walk forwards</span>
01073         <span class="comment">// until we find the last one.  If any of the other bins in the memalloc</span>
01074         <span class="comment">// are not free, bail out.</span>
01075         <span class="comment">//</span>
01076         FirstBin = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
01077         <span class="keywordflow">while</span> (FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> == 0) {
01078             Map=<a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive,(FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> - HBLOCK_SIZE) +
01079                                    (Type * HCELL_TYPE_MASK));
01080             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,(FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> - HBLOCK_SIZE) +(Type * HCELL_TYPE_MASK));
01081             FirstBin = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01082             FirstCell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(FirstBin+1);
01083             <span class="keywordflow">if</span> ((ULONG)(FirstCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>) != FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>-<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>)) {
01084                 <span class="comment">//</span>
01085                 <span class="comment">// The first cell in the bin is either allocated, or not the only</span>
01086                 <span class="comment">// cell in the HBIN.  We cannot free any HBINs.</span>
01087                 <span class="comment">//</span>
01088                 <span class="keywordflow">goto</span> Done;
01089             }
01090         }
01091 
01092         <span class="comment">//</span>
01093         <span class="comment">// We can never discard the first bin of a hive as that always gets marked dirty</span>
01094         <span class="comment">// and written out.</span>
01095         <span class="comment">//</span>
01096         <span class="keywordflow">if</span> (FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> == 0) {
01097             <span class="keywordflow">goto</span> Done;
01098         }
01099 
01100         LastBin = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
01101         <span class="keywordflow">while</span> (LastBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>+LastBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> &lt; FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>+FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>) {
01102             <span class="keywordflow">if</span> (!CoalesceForward) {
01103                 <span class="comment">//</span>
01104                 <span class="comment">// We are at the end of what's been built up. Just return and this</span>
01105                 <span class="comment">// will get freed up when the next HBIN is added.</span>
01106                 <span class="comment">//</span>
01107                 <span class="keywordflow">goto</span> Done;
01108             }
01109             Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, (LastBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>+LastBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) +
01110                                       (Type * HCELL_TYPE_MASK));
01111             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,(LastBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>+LastBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) + (Type * HCELL_TYPE_MASK));
01112 
01113             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> != 0);
01114 
01115             LastBin = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01116             FirstCell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(LastBin + 1);
01117             <span class="keywordflow">if</span> ((ULONG)(FirstCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>) != LastBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>-<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>)) {
01118                 <span class="comment">//</span>
01119                 <span class="comment">// The first cell in the bin is either allocated, or not the only</span>
01120                 <span class="comment">// cell in the HBIN.  We cannot free any HBINs.</span>
01121                 <span class="comment">//</span>
01122                 <span class="keywordflow">goto</span> Done;
01123             }
01124         }
01125 
01126         <span class="comment">//</span>
01127         <span class="comment">// All the bins in this alloc are freed.  Coalesce all the bins into</span>
01128         <span class="comment">// one alloc-sized bin, then either discard the bin or mark it as</span>
01129         <span class="comment">// discardable.</span>
01130         <span class="comment">//</span>
01131         <span class="keywordflow">if</span> (FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> != FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>) {
01132             <span class="comment">//</span>
01133             <span class="comment">// Mark the first HBLOCK of the first HBIN dirty, since</span>
01134             <span class="comment">// we will need to update the on disk field for the bin size</span>
01135             <span class="comment">//</span>
01136             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(Hive,
01137                              FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + (Type * HCELL_TYPE_MASK),
01138                              <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>))) {
01139                 <span class="keywordflow">goto</span> Done;
01140             }
01141 
01142         }
01143 
01144 
01145         FreeBin = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01146         <span class="keywordflow">if</span> (FreeBin == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01147             <span class="keywordflow">goto</span> Done;
01148         }
01149 
01150         <span class="comment">//</span>
01151         <span class="comment">// Walk through the bins and delist each free cell</span>
01152         <span class="comment">//</span>
01153         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = FirstBin;
01154         <span class="keywordflow">do</span> {
01155             FirstCell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>+1);
01156             <a class="code" href="../../d8/d0/hivecell_8c.html#a19">HvpDelistFreeCell</a>(Hive, FirstCell, Type, TailDisplay);
01157             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>==LastBin) {
01158                 <span class="keywordflow">break</span>;
01159             }
01160             Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>+<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)+
01161                                       (Type * HCELL_TYPE_MASK));
01162             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>+<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)+(Type * HCELL_TYPE_MASK));
01163             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01164 
01165         } <span class="keywordflow">while</span> ( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01166 
01167         <span class="comment">//</span>
01168         <span class="comment">// Coalesce them all into one bin.</span>
01169         <span class="comment">//</span>
01170         FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> = FirstBin-&gt;MemAlloc;
01171 
01172         FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a> = FirstBin-&gt;Size;
01173         FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> = FirstBin-&gt;FileOffset;
01174         FirstCell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(FirstBin+1);
01175         FirstCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> = FirstBin-&gt;Size - <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>);
01176         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01177             FirstCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.Last = (ULONG)<a class="code" href="../../d0/d1/hivedata_8h.html#a25">HBIN_NIL</a>;
01178         }
01179 
01180         InsertHeadList(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeBins, &amp;FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>);
01181         <a class="code" href="../../d6/d0/hive_8h.html#a3">ASSERT_LISTENTRY</a>(&amp;FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>);
01182         <a class="code" href="../../d6/d0/hive_8h.html#a3">ASSERT_LISTENTRY</a>(FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>.Flink);
01183 
01184         FreeCell = FirstBin-&gt;FileOffset+(Type*<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a>);
01185         FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>;
01186         <span class="keywordflow">while</span> (FreeCell-FirstBin-&gt;FileOffset &lt; FirstBin-&gt;Size) {
01187             Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, FreeCell);
01188             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,FreeCell);
01189             <span class="keywordflow">if</span> (Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>) {
01190                 Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> = (ULONG_PTR)FirstBin | <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a> | <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>;
01191             } <span class="keywordflow">else</span> {
01192                 Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> = (ULONG_PTR)FirstBin | <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>;
01193             }
01194             Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> = (ULONG_PTR)FreeBin;
01195             FreeCell += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01196         }
01197     }
01198 

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="hive.h::HvpEnlistFreeCells" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvpEnlistFreeCells           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Bin</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BinOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00649">649</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00143">HCELL_PAD</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00947">HvpEnlistFreeCell()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00164">_HCELL::Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">HvpEnlistBinInMap()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00847">HvpRecoverData()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01584">HvRefreshHive()</a>.
<p>
<pre class="fragment"><div>00657                    :
00658 
00659     Scan through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cells in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bin, locating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free ones.
00660     Enlist them in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive's free list set.
00661 
00662     N.B.    <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> MUST already be mapped when <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00663 
00664 Arguments:
00665 
00666     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure map <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being built <span class="keywordflow">for</span>
00667 
00668     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> - pointer to bin to enlist cells from
00669 
00670     BinOffset - offset of <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> in image
00671 
00672 Return Value:
00673 
00674     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - registry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> corrupt
00675 
00676     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00677 
00678 --*/
00679 {
00680     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  p;
00681     ULONG   celloffset;
00682     ULONG   size;
00683     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> cellindex;
00684 
00685     <span class="comment">// PERFNOTE -- Keep this in mind as a possible optimization for NT6.</span>
00686     <span class="comment">// Since now the hive is loaded in chunks of bins, we can drop the </span>
00687     <span class="comment">// bins that are entirely free!!!!!!</span>
00688     <span class="comment">//</span>
00689 
00690     <span class="comment">//</span>
00691     <span class="comment">// Scan all the cells in the bin, total free and allocated, check</span>
00692     <span class="comment">// for impossible pointers.</span>
00693     <span class="comment">//</span>
00694     celloffset = <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>);
00695     p = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));
00696 
00697     <span class="keywordflow">while</span> (p &lt; (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)) {
00698 
00699         <span class="comment">//</span>
00700         <span class="comment">// if free cell, check it out, add it to free list for hive</span>
00701         <span class="comment">//</span>
00702         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt;= 0) {
00703 
00704             size = (ULONG)p-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00705 
00706             <span class="keywordflow">if</span> ( (size &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)               ||
00707                  ( (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(size + (PUCHAR)p) &gt;
00708                    (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) ) ||
00709                  ((size % <a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(Hive)) != 0) ||
00710                  (size == 0) )
00711             {
00712                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00713             }
00714 
00715 
00716             <span class="comment">//</span>
00717             <span class="comment">// cell is free, and is not obviously corrupt, add to free list</span>
00718             <span class="comment">//</span>
00719             celloffset = (ULONG)((PUCHAR)p - (PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>);
00720             cellindex = BinOffset + celloffset;
00721 
00722             <span class="comment">//</span>
00723             <span class="comment">// Enlist this free cell, but do not coalesce with the next free cell</span>
00724             <span class="comment">// as we haven't gotten that far yet.</span>
00725             <span class="comment">//</span>
00726             <a class="code" href="../../d8/d0/hivecell_8c.html#a18">HvpEnlistFreeCell</a>(Hive, cellindex, size, Stable, FALSE,TailDisplay);
00727 
00728         } <span class="keywordflow">else</span> {
00729 
00730             size = (ULONG)(p-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> * -1);
00731 
00732             <span class="keywordflow">if</span> ( (size &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)               ||
00733                  ( (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(size + (PUCHAR)p) &gt;
00734                    (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) ) ||
00735                  ((size % <a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(Hive)) != 0) ||
00736                  (size == 0) )
00737             {
00738                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00739             }
00740 
00741         }
00742 
00743         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(size &gt;= 0);
00744         p = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)p + size);
00745     }
00746 
00747     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00748 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="hive.h::HvpFreeAllocatedBins" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpFreeAllocatedBins           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00085">85</a> of file <a class="el" href="../../d6/d0/hiveinit_8c-source.html">hiveinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00413">HMAP_NEWALLOC</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00132">HTABLE_SLOTS</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00200">_HBIN::MemAlloc</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, and <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00439">_HMAP_TABLE::Table</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, and <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00100">HvLoadHive()</a>.
<p>
<pre class="fragment"><div>00090                    :
00091 
00092     Free all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bins allocated <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified hive.
00093     It applies <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to stable storage. Not all bins are allocated.
00094     Those that are not allocated have BinAddress set to 0
00095     
00096 Arguments:
00097 
00098     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive who's bin to free.
00099 
00100 Return Value:
00101 
00102     NONE.
00103 
00104 --*/
00105 {
00106     ULONG           Length;
00107     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00108     ULONG           MapSlots;
00109     ULONG           Tables;
00110     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00111     <a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>     Tab;
00112     ULONG           i;
00113     ULONG           j;
00114 
00115     <span class="comment">//</span>
00116     <span class="comment">// calculate the number of tables in the map</span>
00117     <span class="comment">//</span>
00118     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length;
00119     MapSlots = Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00120     <span class="keywordflow">if</span>( MapSlots &gt; 0 ) {
00121         Tables = (MapSlots-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00122     } <span class="keywordflow">else</span> {
00123         Tables = 0;
00124     }
00125 
00126     <span class="keywordflow">if</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map ) {
00127         <span class="comment">//</span>
00128         <span class="comment">// iterate through the directory </span>
00129         <span class="comment">//</span>
00130         <span class="keywordflow">for</span> (i = 0; i &lt;= Tables; i++) {
00131             Tab = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map-&gt;Directory[i];
00132 
00133             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Tab);
00134             
00135             <span class="comment">//</span>
00136             <span class="comment">// iterate through the slots in the directory</span>
00137             <span class="comment">//</span>
00138             <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;j++) {
00139                 Me = &amp;(Tab-&gt;<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html#o0">Table</a>[j]);
00140                 <span class="comment">//</span>
00141                 <span class="comment">// BinAddress non-zero means allocated bin</span>
00142                 <span class="comment">//</span>
00143                 <span class="keywordflow">if</span>( Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> ) {
00144                     <span class="keywordflow">if</span>( Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a> ) {
00145                         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00146                         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>);
00147                     }
00148                     
00149                     Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> = 0;
00150                 }
00151             }
00152         }
00153     }
00154    
00155 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="hive.h::HvpFreeMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpFreeMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Dir</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Start</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>End</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00807">807</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00447">_HMAP_DIRECTORY::Directory</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00050">End</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00133">HDIRECTORY_SLOTS</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00160">HvFreeHivePartial()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00751">HvpCleanMap()</a>, and <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00304">HvpInitMap()</a>.
<p>
<pre class="fragment"><div>00815                    :
00816 
00817     Sweeps through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory Dir points to and frees Tables.
00818     Will free <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>-th through <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>-th entries, INCLUSIVE.
00819 
00820 Arguments:
00821 
00822     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block of interest
00823 
00824     Dir - supplies address of an <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a> structure
00825 
00826     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - index of first map table pointer to clean up
00827 
00828     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> - index of last map table pointer to clean up
00829 
00830 Return Value:
00831 
00832     NONE.
00833 
00834 --*/
00835 {
00836     ULONG   i;
00837 
00838     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &gt;= <a class="code" href="../../d0/d1/hivedata_8h.html#a18">HDIRECTORY_SLOTS</a>) {
00839         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a18">HDIRECTORY_SLOTS</a> - 1;
00840     }
00841 
00842     <span class="keywordflow">for</span> (i = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>; i &lt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>; i++) {
00843         <span class="keywordflow">if</span> (Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00844             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[i], <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00845             Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00846         }
00847     }
00848     <span class="keywordflow">return</span>;
00849 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="hive.h::HvpGetCellFlat" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> struct <a class="el" href="../../d4/d9/struct__CELL__DATA.html">_CELL_DATA</a>* HvpGetCellFlat           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00221">221</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.
<p>
<pre class="fragment"><div>00232                    :
00233 
00234     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>.  Will never
00235     <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>, but may assert.  Use <a class="code" href="../../d6/d0/hive_8h.html#a49">HvIsCellAllocated</a> to check
00236     validity of <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>.
00237 
00238     This routine should never be called directly, always call <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00239     via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>() macro.
00240 
00241     This routine provides GetCell support for read only hives with
00242     single allocation flat images.  Such hives do not have cell
00243     maps ("page tables"), instead, we compute addresses by
00244     arithmetic against the base image address.
00245 
00246     Such hives cannot have volatile cells.
00247 
00248 Arguments:
00249 
00250     Hive - supplies a pointer to the hive control structure for the
00251             hive of interest
00252 
00253     Cell - supplies HCELL_INDEX of cell to return address for
00254 
00255 Return Value:
00256 
00257     Address of Cell in memory.  Assert or BugCheck if error.
00258 
00259 --*/
00260 {
00261     PUCHAR          base;
00262     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>          pcell;
00263 
00264     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_MAP) {
00265         KdPrint((<span class="stringliteral">"HvGetCellFlat:\n"</span>));
00266         KdPrint((<span class="stringliteral">"\tHive=%08lx Cell=%08lx\n"</span>,Hive,Cell));
00267     }
00268     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00269     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Cell != HCELL_NIL);
00270     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> == TRUE);
00271     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell) == Stable);
00272     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Cell &gt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));
00273     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Cell &lt; Hive-&gt;BaseBlock-&gt;Length);
00274     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Cell &amp; 0x7)==0);
00275 
00276     <span class="comment">//</span>
00277     <span class="comment">// Address is base of Hive image + Cell</span>
00278     <span class="comment">//</span>
00279     base = (PUCHAR)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>) + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00280     pcell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(base + <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00281     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
        <span class="keywordflow">return</span> (<span class="keyword">struct </span><a class="code" href="../../d4/d9/struct__CELL__DATA.html">_CELL_DATA</a> *)&amp;(pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.UserData);
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="hive.h::HvpGetCellMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> HvpGetCellMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">285</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00054">HvCheckHive()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00160">HvFreeHivePartial()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00200">HvIsBinDirty()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01453">HvIsCellAllocated()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00434">HvpCoalesceDiscardedBins()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01885">HvpDiscardBins()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">HvpEnlistBinInMap()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01233">HvpFindNextDirtyBlock()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00847">HvpRecoverData()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01946">HvpTruncateBins()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01584">HvRefreshHive()</a>.
<p>
<pre class="fragment"><div>00296                    :
00297 
00298     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">HMAP_ENTRY</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell.
00299 
00300 Arguments:
00301 
00302     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00303             hive of interest
00304 
00305     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of cell to <span class="keywordflow">return</span> map entry address <span class="keywordflow">for</span>
00306 
00307 Return Value:
00308 
00309     Address of MAP_ENTRY in memory.  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> no such cell or other error.
00310 
00311 --*/
00312 {
00313     ULONG           Type;
00314     ULONG           Table;
00315     ULONG           Block;
00316     <a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>     ptab;
00317 
00318     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_MAP) {
00319         KdPrint((<span class="stringliteral">"HvpGetCellMapPaged:\n"</span>));
00320         KdPrint((<span class="stringliteral">"\tHive=%08lx Cell=%08lx\n"</span>,Hive,Cell));
00321     }
00322     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00323     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> == FALSE);
00324     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Cell &amp; (<a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(Hive)-1))==0);
00325 
00326     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00327     Table = (<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a9">HCELL_TABLE_MASK</a>) &gt;&gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a10">HCELL_TABLE_SHIFT</a>;
00328     Block = (<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a11">HCELL_BLOCK_MASK</a>) &gt;&gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a12">HCELL_BLOCK_SHIFT</a>;
00329 
00330     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - (Type * <a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a>)) &gt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length) {
00331         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
    }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="hive.h::HvpGetCellPaged" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> struct <a class="el" href="../../d4/d9/struct__CELL__DATA.html">_CELL_DATA</a>* HvpGetCellPaged           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00146">146</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00345">ASSERT_CM_LOCK_OWNED</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00255">CMS_MAP</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00616">_HHIVE::Flat</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00117">HCELL_BLOCK_MASK</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00118">HCELL_BLOCK_SHIFT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00120">HCELL_OFFSET_MASK</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00143">HCELL_PAD</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00114">HCELL_TABLE_MASK</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00115">HCELL_TABLE_SHIFT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00111">HCELL_TYPE_MASK</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00414">HMAP_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d8/d4/struct__HCELL.html#o4">_HCELL::u</a>, and <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00161">USE_OLD_CELL</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.
<p>
<pre class="fragment"><div>00157                    :
00158 
00159     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>.  Will never
00160     <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>, but may assert.  Use <a class="code" href="../../d6/d0/hive_8h.html#a49">HvIsCellAllocated</a> to check
00161     validity of <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>.
00162 
00163     This routine should never be called directly, always call <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00164     via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>() macro.
00165 
00166     This routine provides GetCell support for hives with full maps.
00167     It is the normal version of the routine.
00168 
00169 Arguments:
00170 
00171     Hive - supplies a pointer to the hive control structure for the
00172             hive of interest
00173 
00174     Cell - supplies HCELL_INDEX of cell to return address for
00175 
00176 Return Value:
00177 
00178     Address of Cell in memory.  Assert or BugCheck if error.
00179 
00180 --*/
00181 {
00182     ULONG           Type;
00183     ULONG           Table;
00184     ULONG           Block;
00185     ULONG           <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00186     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>          pcell;
00187     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Map;
00188 
00189     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_MAP) {
00190         KdPrint((<span class="stringliteral">"HvGetCellPaged:\n"</span>));
00191         KdPrint((<span class="stringliteral">"\tHive=%08lx Cell=%08lx\n"</span>,Hive,Cell));
00192     }
00193     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00194     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Cell != HCELL_NIL);
00195     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> == FALSE);
00196     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Cell &amp; (<a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(Hive)-1))==0);
00197     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
00198 <span class="preprocessor">    #if DBG</span>
00199 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell) == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>) {
00200             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Cell &gt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));
00201         } <span class="keywordflow">else</span> {
00202             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Cell &gt;= (HCELL_TYPE_MASK + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>)));
00203         }
00204 <span class="preprocessor">    #endif</span>
00205 <span class="preprocessor"></span>
00206     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00207     Table = (<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a9">HCELL_TABLE_MASK</a>) &gt;&gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a10">HCELL_TABLE_SHIFT</a>;
00208     Block = (<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a11">HCELL_BLOCK_MASK</a>) &gt;&gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a12">HCELL_BLOCK_SHIFT</a>;
00209     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = (<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a13">HCELL_OFFSET_MASK</a>);
00210 
00211     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Cell - (Type * HCELL_TYPE_MASK)) &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length);
00212 
00213     Map = &amp;((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Map)-&gt;Directory[Table]-&gt;Table[Block]);
00214     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; HMAP_BASE) != 0);
00215     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; HMAP_DISCARDABLE) == 0);
00216     pcell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((ULONG_PTR)(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>) + <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>);
00217     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
        <span class="keywordflow">return</span> (<span class="keyword">struct </span><a class="code" href="../../d4/d9/struct__CELL__DATA.html">_CELL_DATA</a> *)&amp;(pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.UserData);
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="hive.h::HvpGrowLog1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvpGrowLog1           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Count</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00495">495</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00600">_HHIVE::FileSetSize</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00041">HLOG_GROW</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00619">_HHIVE::Log</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00624">_HHIVE::LogSize</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">HvMarkDirty()</a>.
<p>
<pre class="fragment"><div>00501                    :
00502 
00503     Adjust <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <span class="keywordflow">for</span> growth in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sectors of dirty
00504     data that are desired.
00505 
00506 Arguments:
00507 
00508     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00509             hive of interest
00510 
00511     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - number of additional logical sectors of log space needed
00512 
00513 Return Value:
00514 
00515     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00516 
00517     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - could not allocate log space, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>!
00518 
00519 --*/
00520 {
00521     ULONG   ClusterSize;
00522     ULONG   RequiredSize;
00523     ULONG   tmp;
00524 
00525     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_IO) {
00526         KdPrint((<span class="stringliteral">"HvpGrowLog1:\n\t"</span>));
00527         KdPrint((<span class="stringliteral">"Hive:%08lx Count:%08lx\n"</span>, Hive, Count));
00528     }
00529 
00530     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00531     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00532 
00533     <span class="comment">//</span>
00534     <span class="comment">// If logging is off, tell caller world is OK.</span>
00535     <span class="comment">//</span>
00536     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00537         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00538     }
00539 
00540     ClusterSize = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00541 
00542     tmp = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap / 8;   <span class="comment">// bytes</span>
00543     tmp += <span class="keyword">sizeof</span>(ULONG);                       <span class="comment">// signature</span>
00544 
00545     RequiredSize =
00546         ClusterSize  +                                  <span class="comment">// 1 cluster for header</span>
00547         <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(tmp, ClusterSize) +
00548         ((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> + <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>) * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>);
00549 
00550     RequiredSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(RequiredSize, HLOG_GROW);
00551 
00552     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00553 
00554     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>, RequiredSize)) {
00555         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00556     }
00557 
00558     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> = RequiredSize;
00559     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00560     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00561 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="hive.h::HvpGrowLog2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvpGrowLog2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00565">565</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00600">_HHIVE::FileSetSize</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00041">HLOG_GROW</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00619">_HHIVE::Log</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00624">_HHIVE::LogSize</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>.
<p>
<pre class="fragment"><div>00571                    :
00572 
00573     Adjust <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <span class="keywordflow">for</span> growth in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive, in particular,
00574     account <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> increased space needed <span class="keywordflow">for</span> a bigger dirty vector.
00575 
00576 Arguments:
00577 
00578     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00579             hive of interest
00580 
00581     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - proposed growth in size in bytes.
00582 
00583 Return Value:
00584 
00585     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00586 
00587     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - could not allocate log space, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>!
00588 
00589 --*/
00590 {
00591     ULONG   ClusterSize;
00592     ULONG   RequiredSize;
00593     ULONG   DirtyBytes;
00594 
00595     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_IO) {
00596         KdPrint((<span class="stringliteral">"HvpGrowLog2:\n\t"</span>));
00597         KdPrint((<span class="stringliteral">"Hive:%08lx Size:%08lx\n"</span>, Hive, Size));
00598     }
00599 
00600     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00601     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00602 
00603 
00604     <span class="comment">//</span>
00605     <span class="comment">// If logging is off, tell caller world is OK.</span>
00606     <span class="comment">//</span>
00607     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00608         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00609     }
00610 
00611     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (Size % HSECTOR_SIZE) == 0 );
00612 
00613     ClusterSize = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00614 
00615     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Stable].Length + Size) / HSECTOR_SIZE) % 8) == 0);
00616 
00617     DirtyBytes = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap / 8) +
00618                     ((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>) / 8) +
00619                     <span class="keyword">sizeof</span>(ULONG);                      <span class="comment">// signature</span>
00620     DirtyBytes = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(DirtyBytes, ClusterSize);
00621 
00622     RequiredSize =
00623         ClusterSize  +                                  <span class="comment">// 1 cluster for header</span>
00624         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>) +
00625         DirtyBytes;
00626 
00627     RequiredSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(RequiredSize, HLOG_GROW);
00628 
00629     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00630 
00631     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>, RequiredSize)) {
00632         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00633     }
00634 
00635     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> = RequiredSize;
00636     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00637     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00638 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="hive.h::HvpHeaderCheckSum" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG HvpHeaderCheckSum           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BaseBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/hivesum_8c-source.html#l00031">31</a> of file <a class="el" href="../../d0/d1/hivesum_8c-source.html">hivesum.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/hivehdr_8c-source.html#l00055">DoDump()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00592">HvpGetHiveHeader()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00758">HvpGetLogHeader()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01025">HvpWriteLog()</a>.
<p>
<pre class="fragment"><div>00036                    :
00037 
00038     Compute <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> checksum <span class="keywordflow">for</span> a hive disk header.
00039 
00040 Arguments:
00041 
00042     BaseBlock - supplies pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> header to checksum
00043 
00044 Return Value:
00045 
00046     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check sum.
00047 
00048 --*/
00049 {
00050     ULONG   sum;
00051     ULONG   i;
00052 
00053     sum = 0;
00054     <span class="keywordflow">for</span> (i = 0; i &lt; 127; i++) {
00055         sum ^= ((PULONG)BaseBlock)[i];
00056     }
00057     <span class="keywordflow">if</span> (sum == (ULONG)-1) {
00058         sum = (ULONG)-2;
00059     }
00060     <span class="keywordflow">if</span> (sum == 0) {
00061         sum = 1;
00062     }
00063     <span class="keywordflow">return</span> sum;
00064 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="hive.h::HvpInitMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvpInitMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00304">304</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00258">CMS_HIVE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00609">_HHIVE::DirtyAlloc</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00132">HTABLE_SLOTS</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00853">HvpAllocateMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00807">HvpFreeMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00344">_HBASE_BLOCK::Length</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00219">RtlInitializeBitMap()</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d0/genmips_8c-source.html#l00109">t()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00536">HvpBuildMap()</a>, and <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00311">HvpReadFileImageAndBuildMap()</a>.
<p>
<pre class="fragment"><div>00309                    :
00310 
00311     Initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a> storage of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.
00312 
00313     Following fields in hive must already be filled in:
00314 
00315          Allocate, Free
00316 
00317     Will initialize Storage structure of <a class="code" href="../../d7/d7/struct__HHIVE.html">HHIVE</a>.
00318 
00319 Arguments:
00320 
00321     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure to build map <span class="keywordflow">for</span>.
00322 
00323 Return Value:
00324 
00325     STATUS_SUCCESS - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00326     STATUS_xxx - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> errorneous status
00327 
00328 --*/
00329 {
00330     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
00331     ULONG           Length;
00332     ULONG           MapSlots;
00333     ULONG           Tables;
00334     <a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>     <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00335     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> d = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00336     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00337     PULONG          Vector;
00338 
00339     
00340     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_HIVE) {
00341         KdPrint((<span class="stringliteral">"HvpInitMap:\n"</span>));
00342         KdPrint((<span class="stringliteral">"\tHive=%08lx"</span>,Hive));
00343     }
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">// Compute size of data region to be mapped</span>
00347     <span class="comment">//</span>
00348     BaseBlock = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>;
00349     Length = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>;
00350     <span class="keywordflow">if</span> ((Length % <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) != 0) {
00351         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00352         <span class="keywordflow">goto</span> ErrorExit1;
00353     }
00354     MapSlots = Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00355     <span class="keywordflow">if</span>( MapSlots &gt; 0 ) {
00356         Tables = (MapSlots-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00357     } <span class="keywordflow">else</span> {
00358         Tables = 0;
00359     }
00360 
00361     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length = Length;
00362 
00363     <span class="comment">//</span>
00364     <span class="comment">// allocate dirty vector if one is not already present (from HvpRecoverData)</span>
00365     <span class="comment">//</span>
00366 
00367     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00368         Vector = (PULONG)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Length/HSECTOR_SIZE/8,<span class="keyword">sizeof</span>(ULONG)), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00369         <span class="keywordflow">if</span> (Vector == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00370             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00371             <span class="keywordflow">goto</span> ErrorExit1;
00372         }
00373         RtlZeroMemory(Vector, Length / HSECTOR_SIZE / 8);
00374         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>, Vector, Length / HSECTOR_SIZE);
00375         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a> = (Length/<a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>/8);
00376     }
00377 
00378     <span class="comment">//</span>
00379     <span class="comment">// allocate and build structure for map</span>
00380     <span class="comment">//</span>
00381     <span class="keywordflow">if</span> (Tables == 0) {
00382 
00383         <span class="comment">//</span>
00384         <span class="comment">// Just 1 table, no need for directory</span>
00385         <span class="comment">//</span>
00386         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00387         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00388             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00389             <span class="keywordflow">goto</span> ErrorExit1;
00390         }
00391         RtlZeroMemory(t, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00392         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map =
00393             (<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>)&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir);
00394         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00395 
00396     } <span class="keywordflow">else</span> {
00397 
00398         <span class="comment">//</span>
00399         <span class="comment">// Need directory and multiple tables</span>
00400         <span class="comment">//</span>
00401         d = (<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00402         <span class="keywordflow">if</span> (d == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00403             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00404             <span class="keywordflow">goto</span> ErrorExit1;
00405         }
00406         RtlZeroMemory(d, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00407 
00408         <span class="comment">//</span>
00409         <span class="comment">// Allocate tables and fill in dir</span>
00410         <span class="comment">//</span>
00411         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/hivemap_8c.html#a13">HvpAllocateMap</a>(Hive, d, 0, Tables) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00412             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00413             <span class="keywordflow">goto</span> ErrorExit2;
00414         }
00415         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map = d;
00416         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = 0;
00417     }
00418 
00419     <span class="keywordflow">return</span> STATUS_SUCCESS;
00420 
00421 ErrorExit2:
00422     <span class="keywordflow">if</span> (d != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00423 
00424         <span class="comment">//</span>
00425         <span class="comment">// directory was built and allocated, so clean it up</span>
00426         <span class="comment">//</span>
00427 
00428         <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(Hive, d, 0, Tables);
00429         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(d, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00430     }
00431 
00432 ErrorExit1:
00433     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00434 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="hive.h::HvReadInMemoryHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvReadInMemoryHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>HiveImage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="hive.h::HvReallocateCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> HvReallocateCell           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01295">1295</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01087">CmpAddToLeaf()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01150">CmpMergeKeyValues()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01472">CmpSplitLeaf()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>.
<p>
<pre class="fragment"><div>01307                    :
01308 
01309     Grows or shrinks a cell.
01310 
01311     NOTE:
01312 
01313         MUST NOT FAIL <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> smaller.  Can be
01314         a noop, but must work.
01315 
01316     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>:
01317 
01318         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> grown, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will get a NEW and DIFFERENT <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>!!!
01319 
01320 Arguments:
01321 
01322     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01323             hive of interest
01324 
01325     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of cell to grow or shrink
01326 
01327     NewSize - desired size of cell  (<span class="keyword">this</span> is an absolute size, not an
01328             increment or decrement.)
01329 
01330 Return Value:
01331 
01332     New HCELL_INDEX <span class="keywordflow">for</span> cell, or HCELL_NIL <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
01333 
01334     If <span class="keywordflow">return</span> is HCELL_NIL, either old cell did not exist, or it did exist
01335     and we could not make a <span class="keyword">new</span> one.  In either <span class="keywordflow">case</span>, nothing has changed.
01336 
01337     If <span class="keywordflow">return</span> is NOT HCELL_NIL, then it is the HCELL_INDEX <span class="keywordflow">for</span> the Cell,
01338     which very probably <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a100">moved</a>.
01339 
01340 --*/
01341 {
01342     PUCHAR      oldaddress;
01343     LONG        oldsize;
01344     ULONG       oldalloc;
01345     HCELL_INDEX NewCell;            <span class="comment">// return value</span>
01346     PUCHAR      newaddress;
01347     ULONG       Type;
01348 
01349     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_HIVE) {
01350         KdPrint((<span class="stringliteral">"HvReallocateCell:\n"</span>));
01351         KdPrint((<span class="stringliteral">"\tHive=%08lx  Cell=%08lx  NewSize=%08lx\n"</span>,Hive,Cell,NewSize));
01352     }
01353     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
01354     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
01355     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
01356 
01357     <span class="comment">//</span>
01358     <span class="comment">// Make room for overhead fields and round up to HCELL_PAD boundary</span>
01359     <span class="comment">//</span>
01360     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01361         NewSize += FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.OldCell.u.UserData);
01362     } <span class="keywordflow">else</span> {
01363         NewSize += FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.NewCell.u.UserData);
01364     }
01365     NewSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(NewSize, <a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(Hive));
01366 
01367     <span class="comment">// </span>
01368     <span class="comment">// Adjust the size (an easy fix for granularity)</span>
01369     <span class="comment">//</span>
01370     <a class="code" href="../../d8/d0/hivecell_8c.html#a4">HvpAdjustCellSize</a>(NewSize);
01371 
01372     <span class="comment">//</span>
01373     <span class="comment">// reject impossible/unreasonable values</span>
01374     <span class="comment">//</span>
01375     <span class="keywordflow">if</span> (NewSize &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a0">HSANE_CELL_MAX</a>) {
01376         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_HIVE) {
01377             KdPrint((<span class="stringliteral">"\tNewSize=%08lx\n"</span>, NewSize));
01378         }
01379         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01380     }
01381 
01382     <span class="comment">//</span>
01383     <span class="comment">// Get sizes and addresses</span>
01384     <span class="comment">//</span>
01385     oldaddress = (PUCHAR)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
01386     oldsize = <a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(Hive, oldaddress);
01387     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(oldsize &gt; 0);
01388     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01389         oldalloc = (ULONG)(oldsize + FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.OldCell.u.UserData));
01390     } <span class="keywordflow">else</span> {
01391         oldalloc = (ULONG)(oldsize + FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.NewCell.u.UserData));
01392     }
01393     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
01394 
01395     <a class="code" href="../../d6/d0/hive_8h.html#a0">DHvCheckHive</a>(Hive);
01396 
01397     <span class="keywordflow">if</span> (NewSize == oldalloc) {
01398 
01399         <span class="comment">//</span>
01400         <span class="comment">// This is a noop, return the same cell</span>
01401         <span class="comment">//</span>
01402         NewCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01403 
01404     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NewSize &lt; oldalloc) {
01405 
01406         <span class="comment">//</span>
01407         <span class="comment">// This is a shrink.</span>
01408         <span class="comment">//</span>
01409         <span class="comment">// PERFNOTE - IMPLEMENT THIS.  Do nothing for now.</span>
01410         <span class="comment">//</span>
01411         NewCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01412 
01413     } <span class="keywordflow">else</span> {
01414 
01415         <span class="comment">//</span>
01416         <span class="comment">// This is a grow.</span>
01417         <span class="comment">//</span>
01418 
01419         <span class="comment">//</span>
01420         <span class="comment">// PERFNOTE - Someday we want to detect that there is a free neighbor</span>
01421         <span class="comment">//          above us and grow into that neighbor if possible.</span>
01422         <span class="comment">//          For now, always do the allocate, copy, free gig.</span>
01423         <span class="comment">//</span>
01424 
01425         <span class="comment">//</span>
01426         <span class="comment">// Allocate a new block of memory to hold the cell</span>
01427         <span class="comment">//</span>
01428 
01429         <span class="keywordflow">if</span> ((NewCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a7">HvpDoAllocateCell</a>(Hive, NewSize, Type)) == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01430             <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01431         }
01432         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a>(Hive, NewCell));
01433         newaddress = (PUCHAR)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, NewCell);
01434 
01435         <span class="comment">//</span>
01436         <span class="comment">// oldaddress points to the old data block for the cell,</span>
01437         <span class="comment">// newaddress points to the new data block, copy the data</span>
01438         <span class="comment">//</span>
01439         RtlMoveMemory(newaddress, oldaddress, oldsize);
01440 
01441         <span class="comment">//</span>
01442         <span class="comment">// Free the old block of memory</span>
01443         <span class="comment">//</span>
01444         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, Cell);
    }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="hive.h::HvRefreshHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvRefreshHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01584">1584</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d9/d8/tbitmap_8c-source.html#l00028">BitMap</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00108">CmCheckRegistry()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00050">End</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00588">_FREE_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00602">_HHIVE::FileRead</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00600">_HHIVE::FileSetSize</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00589">_FREE_HBIN::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00583">FREE_HBIN_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00577">HHIVE_FREE_DISPLAY_SIZE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00204">HIVE_NOLAZYFLUSH</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00414">HMAP_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00413">HMAP_NEWALLOC</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00054">HvCheckHive()</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00160">HvFreeHivePartial()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00649">HvpEnlistFreeCells()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01233">HvpFindNextDirtyBlock()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00434">KEY_HIVE_ENTRY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00437">KEY_NO_DELETE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00344">_HBASE_BLOCK::Length</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00586">_FREE_HBIN::ListEntry</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00200">_HBIN::MemAlloc</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00626">_HHIVE::RefreshCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00266">RtlClearAllBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00587">_FREE_HBIN::Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>, <a class="el" href="../../d5/d0/genmips_8c-source.html#l00109">t()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
<pre class="fragment"><div>01589                    :
01590 
01591     Undo <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last sync.  We <span class="keywordflow">do</span> <span class="keyword">this</span> by reading back all data which
01592     has been marked dirty from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> into memory.  Update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01593     free list.  We will then clear <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dirty vector.
01594 
01595     Any growth since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last sync will be discarded, and in fact,
01596     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> will be set down.
01597 
01598     WARNNOTE:   Failure will cause a bugcheck, as we cannot
01599                 keep <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive consistent <span class="keywordflow">if</span> we fail part way through.
01600 
01601     All I/O <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done via <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>.
01602 
01603 Arguments:
01604 
01605     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01606             hive of interest.
01607 
01608 Return Value:
01609 
01610     NONE. Either works or BugChecks.
01611 
01612 --*/
01613 {
01614     ULONG       <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01615     ULONG       ReadLength;
01616     ULONG       checkstatus;
01617     PUCHAR      Address;
01618     ULONG       Current;
01619     PRTL_BITMAP <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
01620     BOOLEAN     rc;
01621     ULONG       <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
01622     ULONG       <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
01623     ULONG       BitLength;
01624     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> TailStart;
01625     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> p;
01626     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
01627     ULONG       i;
01628     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
01629     PLIST_ENTRY <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
01630     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>  FreeBin;
01631     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Map;
01632     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> RootCell;
01633     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> RootNode;
01634     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> LinkCell;
01635 
01636     <span class="comment">//</span>
01637     <span class="comment">// this array stores the last elements in each free cell list for the stable storage</span>
01638     <span class="comment">//</span>
01639     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     TailDisplay[<a class="code" href="../../d0/d1/hivedata_8h.html#a45">HHIVE_FREE_DISPLAY_SIZE</a>];
01640 
01641     <span class="comment">//</span>
01642     <span class="comment">// noop or assert on various uninteresting or bogus conditions</span>
01643     <span class="comment">//</span>
01644     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == 0) {
01645         <span class="keywordflow">return</span>;
01646     }
01647     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; HIVE_NOLAZYFLUSH);
01648     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Volatile].Length == 0);
01649 
01650     <span class="comment">//</span>
01651     <span class="comment">// be sure the hive is not already trash</span>
01652     <span class="comment">//</span>
01653     checkstatus = <a class="code" href="../../d9/d0/hivechek_8c.html#a9">HvCheckHive</a>(Hive, NULL);
01654     <span class="keywordflow">if</span> (checkstatus != 0) {
01655         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,7,0,(ULONG_PTR)Hive,checkstatus);
01656     }
01657 
01658     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o19">RefreshCount</a>++;
01659 
01660     <span class="comment">//</span>
01661     <span class="comment">// Capture the LinkCell backpointer in the hive's root cell. We need this in case</span>
01662     <span class="comment">// the first bin is overwritten with what was on disk.</span>
01663     <span class="comment">//</span>
01664     RootCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>;
01665     RootNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, RootCell);
01666     LinkCell = RootNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
01667 
01668     <span class="comment">//</span>
01669     <span class="comment">// Any bins that have been marked as discardable, but not yet flushed to</span>
01670     <span class="comment">// disk, are going to be overwritten with old data.  Bring them back into</span>
01671     <span class="comment">// memory and remove their FREE_HBIN marker from the list.</span>
01672     <span class="comment">//</span>
01673     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeBins.Flink;
01674     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> != &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeBins) {
01675 
01676         FreeBin = CONTAINING_RECORD(List, <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>, ListEntry);
01677         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Flink;
01678 
01679         <span class="keywordflow">if</span> (FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>) {
01680             <span class="keywordflow">for</span> (i=0; i&lt;FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>; i+=<a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
01681                 Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>+i);
01682                 <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>+i);
01683                 Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> = (Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>)+i;
01684                 Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp;= ~<a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>;
01685             }
01686             RemoveEntryList(&amp;FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>);
01687             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(FreeBin, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>));
01688         }
01689     }
01690 
01691     <span class="comment">//</span>
01692     <span class="comment">// OverRead base block.</span>
01693     <span class="comment">//</span>
01694     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
01695     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(
01696             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01697             <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
01698             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>,
01699             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>,
01700             <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>
01701             ) != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
01702     {
01703         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,7,1,0,0);
01704     }
01705     TailStart = (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>);
01706 
01707     <span class="comment">//</span>
01708     <span class="comment">// Free "tail" memory and maps for it, update hive size pointers</span>
01709     <span class="comment">//</span>
01710     <a class="code" href="../../d2/d1/hivefree_8c.html#a1">HvFreeHivePartial</a>(Hive, TailStart, Stable);
01711 
01712     <span class="comment">//</span>
01713     <span class="comment">// Clear dirty vector for data past Hive-&gt;BaseBlock-&gt;Length</span>
01714     <span class="comment">//</span>
01715     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01716     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap;
01717     BitLength = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> - <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
01718 
01719     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>), Start, BitLength);
01720 
01721     <span class="comment">//</span>
01722     <span class="comment">// Scan dirty blocks.  Read contiguous blocks off disk into hive.</span>
01723     <span class="comment">// Stop when we get to reduced length.</span>
01724     <span class="comment">//</span>
01725     <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
01726     Current = 0;
01727     <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a3">HvpFindNextDirtyBlock</a>(
01728                 Hive,
01729                 &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>,
01730                 &amp;Current, &amp;Address,
01731                 &amp;ReadLength,
01732                 &amp;Offset
01733                 ))
01734     {
01735         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Offset &lt; (Hive-&gt;BaseBlock-&gt;Length + <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>)));
01736         rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(
01737                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01738                 <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
01739                 &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>,
01740                 (PVOID)Address,
01741                 ReadLength
01742                 );
01743         <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01744             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,7,2,(ULONG_PTR)&amp;Offset,rc);
01745         }
01746     }
01747 
01748     <span class="comment">//</span>
01749     <span class="comment">// If we read the start of any HBINs into memory, it is likely</span>
01750     <span class="comment">// their MemAlloc fields are invalid.  Walk through the HBINs</span>
01751     <span class="comment">// and write valid MemAlloc values for any HBINs whose first</span>
01752     <span class="comment">// sector was reread.</span>
01753     <span class="comment">//</span>
01754     p=0;
01755     <span class="keywordflow">while</span> (p &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length) {
01756         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, p);
01757         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,t,Hive,p);
01758         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BlockAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01759 
01760         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>)==0) {
01761             <span class="keywordflow">if</span> (RtlCheckBit(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>, p / HSECTOR_SIZE)==1) {
01762                 <span class="comment">//</span>
01763                 <span class="comment">// The first sector in the HBIN is dirty.</span>
01764                 <span class="comment">//</span>
01765                 <span class="comment">// Reset the BinAddress to the Block address to cover</span>
01766                 <span class="comment">// the case where a few smaller bins have been coalesced</span>
01767                 <span class="comment">// into a larger bin. We want the smaller bins back now.</span>
01768                 <span class="comment">//</span>
01769                 <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress = (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress &amp; ~<a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>) | <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BlockAddress;
01770 
01771                 <span class="comment">// Check the map to see if this is the start</span>
01772                 <span class="comment">// of a memory allocation or not.</span>
01773                 <span class="comment">//</span>
01774 
01775                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>) {
01776                     <span class="comment">//</span>
01777                     <span class="comment">// Walk through the map to determine the length</span>
01778                     <span class="comment">// of the allocation.</span>
01779                     <span class="comment">//</span>
01780                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> = 0;
01781                     <span class="keywordflow">do</span> {
01782                         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, p+<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>+HBLOCK_SIZE);
01783                         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01784                         <span class="keywordflow">if</span> (p+<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> == <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length) {
01785                             <span class="comment">//</span>
01786                             <span class="comment">// Reached the end of the hive.</span>
01787                             <span class="comment">//</span>
01788                             <span class="keywordflow">break</span>;
01789                         }
01790                         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,t,Hive,p+<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>);
01791                     } <span class="keywordflow">while</span> ( (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>) == 0);
01792 
01793                 } <span class="keywordflow">else</span> {
01794                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> = 0;
01795                 }
01796             }
01797 
01798             p += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
01799 
01800         } <span class="keywordflow">else</span> {
01801             FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BlockAddress;
01802             p += FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
01803         }
01804     }
01805 
01806     <span class="comment">//</span>
01807     <span class="comment">// be sure we haven't filled memory with trash</span>
01808     <span class="comment">//</span>
01809     checkstatus = <a class="code" href="../../d9/d0/hivechek_8c.html#a9">HvCheckHive</a>(Hive, NULL);
01810     <span class="keywordflow">if</span> (checkstatus != 0) {
01811         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,7,3,(ULONG_PTR)Hive,checkstatus);
01812     }
01813 
01814     <span class="comment">//</span>
01815     <span class="comment">// reinit the free list</span>
01816     <span class="comment">//</span>
01817     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d1/hivedata_8h.html#a45">HHIVE_FREE_DISPLAY_SIZE</a>; i++) {
01818         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeDisplay[i] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01819         TailDisplay[i] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01820     }
01821     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeSummary = 0;
01822 
01823     <span class="comment">//</span>
01824     <span class="comment">// rebuild the free list</span>
01825     <span class="comment">//</span>
01826     p = 0;
01827     <span class="keywordflow">while</span> (p &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length) {
01828         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, p);
01829         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,t,Hive,p);
01830 
01831         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) == 0) {
01832             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress) &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01833 
01834             <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d1/hivemap_8c.html#a10">HvpEnlistFreeCells</a>(Hive, Bin, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>,TailDisplay)) {
01835                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,7,5,(ULONG_PTR)Bin,<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>);
01836             }
01837 
01838             p = (ULONG)p + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
01839         } <span class="keywordflow">else</span> {
01840             FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BlockAddress;
01841             p = (ULONG)p + FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
01842         }
01843     }
01844 
01845     <span class="comment">//</span>
01846     <span class="comment">// Finally we need to rewrite the parent field in the root hcell. This is</span>
01847     <span class="comment">// patched in at hive load time so the correct value could have just been</span>
01848     <span class="comment">// overwritten with whatever happened to be on disk.</span>
01849     <span class="comment">//</span>
01850     RootNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, RootCell);
01851     RootNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = LinkCell;
01852     RootNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a30">KEY_NO_DELETE</a>;
01853 
01854 
01855     <span class="comment">//</span>
01856     <span class="comment">// be sure the structure of the thing is OK after all this</span>
01857     <span class="comment">//</span>
01858     checkstatus = <a class="code" href="../../d1/d2/cmp_8h.html#a294">CmCheckRegistry</a>((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)Hive, FALSE);
01859     <span class="keywordflow">if</span> (checkstatus != 0) {
01860         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,7,6,(ULONG_PTR)Hive,checkstatus);
01861     }
01862 
01863     <span class="comment">//</span>
01864     <span class="comment">// Clear dirty vector.</span>
01865     <span class="comment">//</span>
01866     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
01867     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = 0;
01868 
01869 
01870     <span class="comment">//</span>
01871     <span class="comment">// Adjust the file size, if this fails, ignore it, since it just</span>
01872     <span class="comment">// means the file is too big.</span>
01873     <span class="comment">//</span>
01874     (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a>)(
01875         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01876         <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
01877         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>)
01878         );
01879 
01880     <span class="keywordflow">return</span>;
01881 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="hive.h::HvSyncHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvSyncHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">647</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00620">_HHIVE::Alternate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00052">DumpDirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00569">HFILE_TYPE_ALTERNATE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01885">HvpDiscardBins()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01946">HvpTruncateBins()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01025">HvpWriteLog()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00076">HvShutdownComplete</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10281">IoSetThreadHardErrorMode()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00619">_HHIVE::Log</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00266">RtlClearAllBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02195">CmpDoFlushAll()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00124">EhCloseHive()</a>, and <a class="el" href="../../d0/d4/edithive_8c-source.html#l00156">EhOpenHive()</a>.
<p>
<pre class="fragment"><div>00652                    :
00653 
00654     Force backing store to match <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory image of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>
00655     part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive's space.
00656 
00657     Logs, primary, and alternate data can be written.  Primary <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00658     always written.  Normally either a log or an alternate, but
00659     not both, will also be written.
00660 
00661     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> possible to write <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary.
00662 
00663     All dirty bits will be set clear.
00664 
00665 Arguments:
00666 
00667     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00668             hive of interest
00669 
00670 Return Value:
00671 
00672     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00673 
00674     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - some <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00675 
00676 --*/
00677 {
00678     BOOLEAN oldFlag;
00679 
00680     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_IO) {
00681         KdPrint((<span class="stringliteral">"HvSyncHive:\n\t"</span>));
00682         KdPrint((<span class="stringliteral">"Hive:%08lx\n"</span>, Hive));
00683     }
00684 
00685     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00686     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00687 
00688     <span class="comment">//</span>
00689     <span class="comment">// Punt if post shutdown</span>
00690     <span class="comment">//</span>
00691     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a13">HvShutdownComplete</a>) {
00692         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_IO) {
00693             KdPrint((<span class="stringliteral">"HvSyncHive:  Attempt to sync AFTER SHUTDOWN\n"</span>));
00694         }
00695         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00696     }
00697 
00698     <span class="comment">//</span>
00699     <span class="comment">// If nothing dirty, do nothing</span>
00700     <span class="comment">//</span>
00701     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == 0) {
00702         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00703     }
00704 
00705     <a class="code" href="../../d0/d2/hivesync_8c.html#a17">HvpTruncateBins</a>(Hive);
00706 
00707     <span class="comment">//</span>
00708     <span class="comment">// If hive is volatile, do nothing</span>
00709     <span class="comment">//</span>
00710     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) {
00711         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00712     }
00713 
00714     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_IO) {
00715         KdPrint((<span class="stringliteral">"\tDirtyCount:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a>));
00716         KdPrint((<span class="stringliteral">"\tDirtyVector:"</span>));
00717         <a class="code" href="../../d0/d2/hivesync_8c.html#a0">DumpDirtyVector</a>(Hive);
00718     }
00719 
00720     <span class="comment">//</span>
00721     <span class="comment">// disable hard error popups, to avoid self deadlock on bogus devices</span>
00722     <span class="comment">//</span>
00723     oldFlag = <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(FALSE);
00724 
00725     <span class="comment">//</span>
00726     <span class="comment">// Write a log.</span>
00727     <span class="comment">//</span>
00728     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00729         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a2">HvpWriteLog</a>(Hive) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00730             <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(oldFlag);
00731             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00732         }
00733     }
00734 
00735     <span class="comment">//</span>
00736     <span class="comment">// Write the primary</span>
00737     <span class="comment">//</span>
00738     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a14">HvpDoWriteHive</a>(Hive, HFILE_TYPE_PRIMARY) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00739         <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(oldFlag);
00740         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00741     }
00742 
00743     <span class="comment">//</span>
00744     <span class="comment">// Write an alternate</span>
00745     <span class="comment">//</span>
00746     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o16">Alternate</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00747         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a14">HvpDoWriteHive</a>(Hive, HFILE_TYPE_ALTERNATE) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00748             <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(oldFlag);
00749             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00750         }
00751     }
00752 
00753     <span class="comment">//</span>
00754     <span class="comment">// restore hard error popups mode</span>
00755     <span class="comment">//</span>
00756     <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(oldFlag);
00757     
00758     <span class="comment">//</span>
00759     <span class="comment">// Hive was successfully written out, discard any bins marked as</span>
00760     <span class="comment">// discardable.</span>
00761     <span class="comment">//</span>
00762     <a class="code" href="../../d0/d2/hivesync_8c.html#a16">HvpDiscardBins</a>(Hive);
00763 
00764     <span class="comment">//</span>
00765     <span class="comment">// Clear the dirty map</span>
00766     <span class="comment">//</span>
00767     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00768     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = 0;
00769 
00770     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00771 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="hive.h::HvWriteHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvWriteHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">1433</a> of file <a class="el" href="../../d1/d1/hivesync_8c-source.html">hivesync.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00227">CmpDoFileSetSize()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00265">CmpReleaseGlobalQuota()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00571">HFILE_TYPE_EXTERNAL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00076">HvShutdownComplete</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00305">RtlSetAllBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>.
<p>
<pre class="fragment"><div>01438                    :
01439 
01440     Write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.  Write <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Primary <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, neither
01441     logs nor alternates will be updated.  The hive will be written
01442     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a> handle.
01443 
01444     Intended <span class="keywordflow">for</span> use in applications like SaveKey.
01445 
01446     Only <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> storage will be written (as <span class="keywordflow">for</span> any hive.)
01447 
01448     Presumption is that layer above has set HFILE_TYPE_EXTERNAL
01449     handle to point to correct place.
01450 
01451     Applying <span class="keyword">this</span> call to an active hive will generally hose integrity
01452     measures.
01453 
01454     HOW IT WORKS:
01455 
01456         Make a <span class="keyword">new</span> DirtyVector.  Fill it with 1s (all dirty).
01457         Make hive point at <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  We now have what looks like
01458         a completely dirty hive.
01459 
01460         Call HvpWriteHive, which will write the whole thing to disk.
01461 
01462         Put back DirtyVector, and free the extra one we used.
01463 
01464         In failure <span class="keywordflow">case</span>, force Sequence numbers in Hive and BaseBlock
01465         to match.
01466 
01467 Arguments:
01468 
01469     Hive - supplies a pointer to the hive control structure <span class="keywordflow">for</span> the
01470             hive of interest.
01471 
01472 Return Value:
01473 
01474     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>.
01475 
01476 --*/
01477 {
01478     PULONG          SaveDirtyVector;
01479     ULONG           SaveDirtyVectorSize;
01480     PULONG          AltDirtyVector;
01481     ULONG           AltDirtyVectorSize;
01482     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    SaveBaseBlock;
01483     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    AltBaseBlock;
01484     ULONG           Alignment;
01485 
01486     NTSTATUS        status;
01487 
01488 
01489     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO) {
01490         KdPrint((<span class="stringliteral">"HvWriteHive: \n"</span>));
01491         KdPrint((<span class="stringliteral">"\tHive = %08lx\n"</span>));
01492     }
01493     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
01494     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
01495 
01496 
01497     <span class="comment">//</span>
01498     <span class="comment">// Punt if post shutdown</span>
01499     <span class="comment">//</span>
01500     if (HvShutdownComplete) {
01501         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_IO) {
01502             KdPrint((<span class="stringliteral">"HvWriteHive: Attempt to write hive AFTER SHUTDOWN\n"</span>));
01503         }
01504         <span class="keywordflow">return</span> STATUS_REGISTRY_IO_FAILED;
01505     }
01506 
01507     <span class="comment">//</span>
01508     <span class="comment">// Splice in a duplicate DirtyVector with all bits set.</span>
01509     <span class="comment">//</span>
01510     SaveDirtyVector = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer;
01511     SaveDirtyVectorSize = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap;
01512     SaveBaseBlock = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>;
01513 
01514     AltDirtyVectorSize = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Stable].Length / HSECTOR_SIZE) / 8;
01515     AltDirtyVector = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(AltDirtyVectorSize,<span class="keyword">sizeof</span>(ULONG)), FALSE);
01516     <span class="keywordflow">if</span> (AltDirtyVector == NULL) {
01517         status = STATUS_INSUFFICIENT_RESOURCES;
01518         <span class="keywordflow">goto</span> Exit1;
01519     }
01520     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer = AltDirtyVector;
01521     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap = AltDirtyVectorSize * 8;
01522     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a28">RtlSetAllBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
01523 
01524     <span class="comment">//</span>
01525     <span class="comment">// Splice in a duplicate BaseBlock</span>
01526     <span class="comment">//</span>
01527     AltBaseBlock = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>), TRUE);
01528     if (AltBaseBlock == NULL) {
01529         status = STATUS_INSUFFICIENT_RESOURCES;
01530         <span class="keywordflow">goto</span> Exit2;
01531     }
01532     <span class="comment">//</span>
01533     <span class="comment">// Make sure the buffer we got back is cluster-aligned. If not, try</span>
01534     <span class="comment">// harder to get an aligned buffer.</span>
01535     <span class="comment">//</span>
01536     Alignment = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * HSECTOR_SIZE - 1;
01537     if (((ULONG_PTR)AltBaseBlock &amp; Alignment) != 0) {
01538         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(AltBaseBlock, <span class="keyword">sizeof</span>(HBASE_BLOCK));
01539         AltBaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(PAGE_SIZE, TRUE));
01540         if (AltBaseBlock == NULL) {
01541             status = STATUS_INSUFFICIENT_RESOURCES;
01542             <span class="keywordflow">goto</span> Exit2;
01543         }
01544         <span class="comment">//</span>
01545         <span class="comment">// Return the quota for the extra allocation, as we are not really using</span>
01546         <span class="comment">// it and it will not be accounted for later when we free it.</span>
01547         <span class="comment">//</span>
01548         <a class="code" href="../../d1/d2/cmp_8h.html#a248">CmpReleaseGlobalQuota</a>(PAGE_SIZE - <span class="keyword">sizeof</span>(HBASE_BLOCK));
01549     }
01550 
01551     RtlMoveMemory(AltBaseBlock, SaveBaseBlock, HSECTOR_SIZE);
01552     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = AltBaseBlock;
01553 
01554     <span class="comment">//</span>
01555     <span class="comment">// Ensure the file can be made big enough, then do the deed</span>
01556     <span class="comment">//</span>
01557     status = <a class="code" href="../../d1/d2/cmp_8h.html#a219">CmpDoFileSetSize</a>(Hive,
01558                               HFILE_TYPE_EXTERNAL,
01559                               <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Stable].Length);
01560 
01561     if (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01562         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/hivesync_8c.html#a14">HvpDoWriteHive</a>(Hive, HFILE_TYPE_EXTERNAL)) {
01563             status = STATUS_REGISTRY_IO_FAILED;
01564         }
01565     }
01566 
01567     <span class="comment">//</span>
01568     <span class="comment">// Clean up, success or failure</span>
01569     <span class="comment">//</span>
01570     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(AltBaseBlock, <span class="keyword">sizeof</span>(HBASE_BLOCK));
01571 
01572 Exit2:
01573     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(AltDirtyVector, <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(AltDirtyVectorSize,<span class="keyword">sizeof</span>(ULONG)));
01574 
01575 Exit1:
01576     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer = SaveDirtyVector;
01577     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap = SaveDirtyVectorSize;
01578     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = SaveBaseBlock;
01579     <span class="keywordflow">return</span> status;
01580 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
