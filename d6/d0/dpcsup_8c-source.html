<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dpcsup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dpcsup.c</h1><a href="../../d5/d1/dpcsup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    dpcsup.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the support routines for the system DPC objects.</span>
00012 <span class="comment">    Functions are provided to process quantum end, the power notification</span>
00013 <span class="comment">    queue, and timer expiration.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    David N. Cutler (davec) 22-Apr-1989</span>
00018 <span class="comment"></span>
00019 <span class="comment">Environment:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Kernel mode only, IRQL DISPATCH_LEVEL.</span>
00022 <span class="comment"></span>
00023 <span class="comment">Revision History:</span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00028 
00029 <span class="comment">//</span>
00030 <span class="comment">// Define DPC entry structure and maximum DPC List size.</span>
00031 <span class="comment">//</span>
00032 
<a name="l00033"></a><a class="code" href="../../d5/d1/dpcsup_8c.html#a0">00033</a> <span class="preprocessor">#define MAXIMUM_DPC_LIST_SIZE 16</span>
00034 <span class="preprocessor"></span>
<a name="l00035"></a><a class="code" href="../../d6/d8/struct__DPC__ENTRY.html">00035</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d8/struct__DPC__ENTRY.html">_DPC_ENTRY</a> {
<a name="l00036"></a><a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o0">00036</a>     <a class="code" href="../../d1/d6/struct__KDPC.html">PRKDPC</a> <a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o0">Dpc</a>;
<a name="l00037"></a><a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o1">00037</a>     <a class="code" href="../../d0/d9/ntosdef_8h.html#a49">PKDEFERRED_ROUTINE</a> <a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o1">Routine</a>;
<a name="l00038"></a><a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o2">00038</a>     PVOID <a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o2">Context</a>;
00039 } <a class="code" href="../../d6/d8/struct__DPC__ENTRY.html">DPC_ENTRY</a>, *<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html">PDPC_ENTRY</a>;
00040 
00041 
00042 <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a>
<a name="l00043"></a><a class="code" href="../../d5/d1/dpcsup_8c.html#a3">00043</a> <a class="code" href="../../d5/d1/dpcsup_8c.html#a3">KiQuantumEnd</a> (
00044     VOID
00045     )
00046 
00047 <span class="comment">/*++</span>
00048 <span class="comment"></span>
00049 <span class="comment">Routine Description:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    This function is called when a quantum end event occurs on the current</span>
00052 <span class="comment">    processor. Its function is to determine whether the thread priority should</span>
00053 <span class="comment">    be decremented and whether a redispatch of the processor should occur.</span>
00054 <span class="comment"></span>
00055 <span class="comment">Arguments:</span>
00056 <span class="comment"></span>
00057 <span class="comment">    None.</span>
00058 <span class="comment"></span>
00059 <span class="comment">Return Value:</span>
00060 <span class="comment"></span>
00061 <span class="comment">    The next thread to be schedule on the current processor is returned as</span>
00062 <span class="comment">    the function value. If this value is not NULL, then the return is with</span>
00063 <span class="comment">    the dispatcher database locked. Otherwise, the dispatcher database is</span>
00064 <span class="comment">    unlocked.</span>
00065 <span class="comment"></span>
00066 <span class="comment">--*/</span>
00067 
00068 {
00069 
00070     KPRIORITY NewPriority;
00071     KIRQL OldIrql;
00072     PKPRCB Prcb;
00073     KPRIORITY Priority;
00074     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00075     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00076     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> NextThread;
00077 
00078     <span class="comment">//</span>
00079     <span class="comment">// Acquire the dispatcher database lock.</span>
00080     <span class="comment">//</span>
00081 
00082     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00083     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00084     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00085 
00086     <span class="comment">//</span>
00087     <span class="comment">// If the quantum has expired for the current thread, then update its</span>
00088     <span class="comment">// quantum and priority.</span>
00089     <span class="comment">//</span>
00090 
00091     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> &lt;= 0) {
00092 
00093         <span class="comment">//</span>
00094         <span class="comment">// If quantum runout is disabled for the thread's process and</span>
00095         <span class="comment">// the thread is running at a realtime priority, then set the</span>
00096         <span class="comment">// thread quantum to the highest value and do not round robin</span>
00097         <span class="comment">// at the thread's priority level. Otherwise, reset the thread</span>
00098         <span class="comment">// quantum and decay the thread's priority as appropriate.</span>
00099         <span class="comment">//</span>
00100 
00101         Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00102         <span class="keywordflow">if</span> ((Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o19">DisableQuantum</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00103             (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o13">Priority</a> &gt;= LOW_REALTIME_PRIORITY)) {
00104             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> = MAXCHAR;
00105 
00106         } <span class="keywordflow">else</span> {
00107             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a>;
00108 
00109             <span class="comment">//</span>
00110             <span class="comment">// Decrement the thread's current priority if the thread is not</span>
00111             <span class="comment">// running in a realtime priority class and check to determine</span>
00112             <span class="comment">// if the processor should be redispatched.</span>
00113             <span class="comment">//</span>
00114 
00115             Priority = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o13">Priority</a>;
00116             <span class="keywordflow">if</span> (Priority &lt; LOW_REALTIME_PRIORITY) {
00117                 NewPriority = Priority - Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o26">PriorityDecrement</a> - 1;
00118                 <span class="keywordflow">if</span> (NewPriority &lt; Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a>) {
00119                     NewPriority = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a>;
00120                 }
00121 
00122                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o26">PriorityDecrement</a> = 0;
00123 
00124             } <span class="keywordflow">else</span> {
00125                 NewPriority = Priority;
00126             }
00127 
00128             <span class="comment">//</span>
00129             <span class="comment">// If the new thread priority is different that the current thread</span>
00130             <span class="comment">// priority, then the thread does not run at a realtime level and</span>
00131             <span class="comment">// its priority should be set. Otherwise, attempt to round robin</span>
00132             <span class="comment">// at the current level.</span>
00133             <span class="comment">//</span>
00134 
00135             <span class="keywordflow">if</span> (Priority != NewPriority) {
00136                 <a class="code" href="../../d0/d2/thredsup_8c.html#a5">KiSetPriorityThread</a>(Thread, NewPriority);
00137 
00138             } <span class="keywordflow">else</span> {
00139                 <span class="keywordflow">if</span> (Prcb-&gt;NextThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00140                     NextThread = <a class="code" href="../../d0/d2/thredsup_8c.html#a2">KiFindReadyThread</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o45">NextProcessor</a>, Priority);
00141 
00142                     <span class="keywordflow">if</span> (NextThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00143                         NextThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a406a194">Standby</a>;
00144                         Prcb-&gt;NextThread = NextThread;
00145                     }
00146 
00147                 } <span class="keywordflow">else</span> {
00148                     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o42">Preempted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00149                 }
00150             }
00151         }
00152     }
00153 
00154     <span class="comment">//</span>
00155     <span class="comment">// If a thread was scheduled for execution on the current processor,</span>
00156     <span class="comment">// then return the address of the thread with the dispatcher database</span>
00157     <span class="comment">// locked. Otherwise, return NULL with the dispatcher data unlocked.</span>
00158     <span class="comment">//</span>
00159 
00160     NextThread = Prcb-&gt;NextThread;
00161     <span class="keywordflow">if</span> (NextThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00162         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00163     }
00164 
00165     <span class="keywordflow">return</span> NextThread;
00166 }
00167 
00168 <span class="preprocessor">#if DBG</span>
00169 <span class="preprocessor"></span>
00170 
00171 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00172 KiCheckTimerTable (
00173     IN ULARGE_INTEGER CurrentTime
00174     )
00175 
00176 {
00177 
00178     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00179     PLIST_ENTRY ListHead;
00180     PLIST_ENTRY NextEntry;
00181     KIRQL OldIrql;
00182     <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer;
00183 
00184     <span class="comment">//</span>
00185     <span class="comment">// Raise IRQL to highest level and scan timer table for timers that</span>
00186     <span class="comment">// have expired.</span>
00187     <span class="comment">//</span>
00188 
00189     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(HIGH_LEVEL, &amp;OldIrql);
00190     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00191     <span class="keywordflow">do</span> {
00192         ListHead = &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a3">KiTimerTableListHead</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00193         NextEntry = ListHead-&gt;Flink;
00194         <span class="keywordflow">while</span> (NextEntry != ListHead) {
00195             Timer = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>, TimerListEntry);
00196             NextEntry = NextEntry-&gt;Flink;
00197             <span class="keywordflow">if</span> (Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o1">DueTime</a>.QuadPart &lt;= CurrentTime.QuadPart) {
00198                 DbgBreakPoint();
00199             }
00200         }
00201 
00202         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00203     } <span class="keywordflow">while</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a>);
00204 
00205     <span class="comment">//</span>
00206     <span class="comment">// Lower IRQL to the previous level.</span>
00207     <span class="comment">//</span>
00208 
00209     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00210     <span class="keywordflow">return</span>;
00211 }
00212 
00213 <span class="preprocessor">#endif</span>
00214 <span class="preprocessor"></span>
00215 
00216 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00217"></a><a class="code" href="../../d0/d0/ki_8h.html#a140">00217</a> <a class="code" href="../../d0/d0/ki_8h.html#a140">KiTimerExpiration</a> (
00218     IN <a class="code" href="../../d1/d6/struct__KDPC.html">PKDPC</a> TimerDpc,
00219     IN PVOID DeferredContext,
00220     IN PVOID SystemArgument1,
00221     IN PVOID SystemArgument2
00222     )
00223 
00224 <span class="comment">/*++</span>
00225 <span class="comment"></span>
00226 <span class="comment">Routine Description:</span>
00227 <span class="comment"></span>
00228 <span class="comment">    This function is called when the clock interupt routine discovers that</span>
00229 <span class="comment">    a timer has expired.</span>
00230 <span class="comment"></span>
00231 <span class="comment">Arguments:</span>
00232 <span class="comment"></span>
00233 <span class="comment">    TimerDpc - Supplies a pointer to a control object of type DPC.</span>
00234 <span class="comment"></span>
00235 <span class="comment">    DeferredContext - Not used.</span>
00236 <span class="comment"></span>
00237 <span class="comment">    SystemArgument1 - Supplies the starting timer table index value to</span>
00238 <span class="comment">        use for the timer table scan.</span>
00239 <span class="comment"></span>
00240 <span class="comment">    SystemArgument2 - Not used.</span>
00241 <span class="comment"></span>
00242 <span class="comment">Return Value:</span>
00243 <span class="comment"></span>
00244 <span class="comment">    None.</span>
00245 <span class="comment"></span>
00246 <span class="comment">--*/</span>
00247 
00248 {
00249     ULARGE_INTEGER CurrentTime;
00250     LIST_ENTRY ExpiredListHead;
00251     LONG HandLimit;
00252     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00253     PLIST_ENTRY ListHead;
00254     PLIST_ENTRY NextEntry;
00255     KIRQL OldIrql;
00256     <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer;
00257 
00258     <span class="comment">//</span>
00259     <span class="comment">// Acquire the dispatcher database lock and read the current interrupt</span>
00260     <span class="comment">// time to determine which timers have expired.</span>
00261     <span class="comment">//</span>
00262 
00263     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00264     KiQueryInterruptTime((PLARGE_INTEGER)&amp;CurrentTime);
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">// If the timer table has not wrapped, then start with the specified</span>
00268     <span class="comment">// timer table index value, and scan for timer entries that have expired.</span>
00269     <span class="comment">// Otherwise, start with the first entry in the timer table and scan the</span>
00270     <span class="comment">// entire table for timer entries that have expired.</span>
00271     <span class="comment">//</span>
00272     <span class="comment">// N.B. This later condition exists when DPC processing is blocked for a</span>
00273     <span class="comment">//      period longer than one round trip throught the timer table.</span>
00274     <span class="comment">//</span>
00275 
00276     HandLimit = (LONG)KiQueryLowTickCount();
00277     <span class="keywordflow">if</span> (((ULONG)(HandLimit - PtrToLong(SystemArgument1))) &gt;= <a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a>) {
00278         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = - 1;
00279         HandLimit = <a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a> - 1;
00280 
00281     } <span class="keywordflow">else</span> {
00282         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (PtrToLong(SystemArgument1) - 1) &amp; (<a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a> - 1);
00283         HandLimit &amp;= (<a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a> - 1);
00284     }
00285 
00286     InitializeListHead(&amp;ExpiredListHead);
00287     <span class="keywordflow">do</span> {
00288         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1) &amp; (<a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a> - 1);
00289         ListHead = &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a3">KiTimerTableListHead</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00290         NextEntry = ListHead-&gt;Flink;
00291         <span class="keywordflow">while</span> (NextEntry != ListHead) {
00292             Timer = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>, TimerListEntry);
00293             <span class="keywordflow">if</span> (Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o1">DueTime</a>.QuadPart &lt;= CurrentTime.QuadPart) {
00294 
00295                 <span class="comment">//</span>
00296                 <span class="comment">// The next timer in the current timer list has expired.</span>
00297                 <span class="comment">// Remove the entry from the timer list and insert the</span>
00298                 <span class="comment">// timer in the expired list.</span>
00299                 <span class="comment">//</span>
00300 
00301                 RemoveEntryList(&amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o2">TimerListEntry</a>);
00302                 InsertTailList(&amp;ExpiredListHead, &amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o2">TimerListEntry</a>);
00303                 NextEntry = ListHead-&gt;Flink;
00304 
00305             } <span class="keywordflow">else</span> {
00306                 <span class="keywordflow">break</span>;
00307             }
00308         }
00309 
00310     } <span class="keywordflow">while</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> != HandLimit);
00311 
00312 <span class="preprocessor">#if DBG</span>
00313 <span class="preprocessor"></span>
00314     <span class="keywordflow">if</span> ((PtrToUlong(SystemArgument2) == 0) &amp;&amp; (<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a> == 1)) {
00315         KiCheckTimerTable(CurrentTime);
00316     }
00317 
00318 <span class="preprocessor">#endif</span>
00319 <span class="preprocessor"></span>
00320     <span class="comment">//</span>
00321     <span class="comment">// Process the expired timer list.</span>
00322     <span class="comment">//</span>
00323     <span class="comment">// N.B. The following function returns with the dispatcher database</span>
00324     <span class="comment">//      unlocked.</span>
00325     <span class="comment">//</span>
00326 
00327     <a class="code" href="../../d0/d0/ki_8h.html#a141">KiTimerListExpire</a>(&amp;ExpiredListHead, OldIrql);
00328     <span class="keywordflow">return</span>;
00329 }
00330 
00331 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00332 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00333"></a><a class="code" href="../../d0/d0/ki_8h.html#a141">00333</a> <a class="code" href="../../d0/d0/ki_8h.html#a141">KiTimerListExpire</a> (
00334     IN PLIST_ENTRY ExpiredListHead,
00335     IN KIRQL OldIrql
00336     )
00337 
00338 <span class="comment">/*++</span>
00339 <span class="comment"></span>
00340 <span class="comment">Routine Description:</span>
00341 <span class="comment"></span>
00342 <span class="comment">    This function is called to process a list of timers that have expired.</span>
00343 <span class="comment"></span>
00344 <span class="comment">    N.B. This function is called with the dispatcher database locked and</span>
00345 <span class="comment">        returns with the dispatcher database unlocked.</span>
00346 <span class="comment"></span>
00347 <span class="comment">Arguments:</span>
00348 <span class="comment"></span>
00349 <span class="comment">    ExpiredListHead - Supplies a pointer to a list of timers that have</span>
00350 <span class="comment">        expired.</span>
00351 <span class="comment"></span>
00352 <span class="comment">    OldIrql - Supplies the previous IRQL.</span>
00353 <span class="comment"></span>
00354 <span class="comment">Return Value:</span>
00355 <span class="comment"></span>
00356 <span class="comment">    None.</span>
00357 <span class="comment"></span>
00358 <span class="comment">--*/</span>
00359 
00360 {
00361 
00362     LONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00363     <a class="code" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc;
00364     <a class="code" href="../../d6/d8/struct__DPC__ENTRY.html">DPC_ENTRY</a> DpcList[<a class="code" href="../../d5/d1/dpcsup_8c.html#a0">MAXIMUM_DPC_LIST_SIZE</a>];
00365     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00366     LARGE_INTEGER Interval;
00367     KIRQL OldIrql1;
00368     LARGE_INTEGER SystemTime;
00369     <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer;
00370 
00371     <span class="comment">//</span>
00372     <span class="comment">// Capture the timer expiration time.</span>
00373     <span class="comment">//</span>
00374 
00375     KiQuerySystemTime(&amp;SystemTime);
00376 
00377     <span class="comment">//</span>
00378     <span class="comment">// Remove the next timer from the expired timer list, set the state of</span>
00379     <span class="comment">// the timer to signaled, reinsert the timer in the timer tree if it is</span>
00380     <span class="comment">// periodic, and optionally call the DPC routine if one is specified.</span>
00381     <span class="comment">//</span>
00382 
00383 RestartScan:
00384     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00385     <span class="keywordflow">while</span> (ExpiredListHead-&gt;Flink != ExpiredListHead) {
00386         Timer = CONTAINING_RECORD(ExpiredListHead-&gt;Flink, <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>, TimerListEntry);
00387         <a class="code" href="../../d0/d0/ki_8h.html#a22">KiRemoveTreeTimer</a>(Timer);
00388         Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> = 1;
00389         <span class="keywordflow">if</span> (IsListEmpty(&amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00390             <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(Timer, <a class="code" href="../../d0/d0/ki_8h.html#a3">TIMER_EXPIRE_INCREMENT</a>);
00391         }
00392 
00393         <span class="comment">//</span>
00394         <span class="comment">// If the timer is periodic, then compute the next interval time</span>
00395         <span class="comment">// and reinsert the timer in the timer tree.</span>
00396         <span class="comment">//</span>
00397         <span class="comment">// N.B. Even though the timer insertion is relative, it can still</span>
00398         <span class="comment">//      fail if the period of the timer elapses in between computing</span>
00399         <span class="comment">//      the time and inserting the timer in the table. If this happens,</span>
00400         <span class="comment">//      try again.</span>
00401         <span class="comment">//</span>
00402         <span class="keywordflow">if</span> (Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o4">Period</a> != 0) {
00403             Interval.QuadPart = Int32x32To64(Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o4">Period</a>, - 10 * 1000);
00404             <span class="keywordflow">while</span> (!<a class="code" href="../../d5/d2/timersup_8c.html#a1">KiInsertTreeTimer</a>(Timer, Interval)) {
00405                 ;
00406             }
00407         }
00408 
00409         <span class="keywordflow">if</span> (Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o3">Dpc</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00410             Dpc = Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o3">Dpc</a>;
00411 
00412             <span class="comment">//</span>
00413             <span class="comment">// If the DPC is explicitly targeted to another processor, then</span>
00414             <span class="comment">// queue the DPC to the target processor. Otherwise, capture the</span>
00415             <span class="comment">// DPC parameters for execution on the current processor.</span>
00416             <span class="comment">//</span>
00417 
00418 <span class="preprocessor">#if defined(NT_UP)</span>
00419 <span class="preprocessor"></span>
00420             DpcList[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o0">Dpc</a> = Dpc;
00421             DpcList[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o1">Routine</a> = Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o4">DeferredRoutine</a>;
00422             DpcList[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o2">Context</a> = Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o5">DeferredContext</a>;
00423             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
00424             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == <a class="code" href="../../d5/d1/dpcsup_8c.html#a0">MAXIMUM_DPC_LIST_SIZE</a>) {
00425                 <span class="keywordflow">break</span>;
00426             }
00427 
00428 <span class="preprocessor">#else</span>
00429 <span class="preprocessor"></span>
00430             <span class="keywordflow">if</span> ((Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o1">Number</a> &gt;= <a class="code" href="../../d9/d5/ndismain_8h.html#a183">MAXIMUM_PROCESSORS</a>) &amp;&amp;
00431                 (((ULONG)Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o1">Number</a> - <a class="code" href="../../d9/d5/ndismain_8h.html#a183">MAXIMUM_PROCESSORS</a>) != (ULONG)KeGetCurrentProcessorNumber())) {
00432                 <a class="code" href="../../d4/d1/dpcobj_8c.html#a2">KeInsertQueueDpc</a>(Dpc,
00433                                  ULongToPtr(SystemTime.LowPart),
00434                                  ULongToPtr(SystemTime.HighPart));
00435 
00436             } <span class="keywordflow">else</span> {
00437                 DpcList[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o0">Dpc</a> = Dpc;
00438                 DpcList[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o1">Routine</a> = Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o4">DeferredRoutine</a>;
00439                 DpcList[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o2">Context</a> = Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o5">DeferredContext</a>;
00440                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
00441                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == <a class="code" href="../../d5/d1/dpcsup_8c.html#a0">MAXIMUM_DPC_LIST_SIZE</a>) {
00442                     <span class="keywordflow">break</span>;
00443                 }
00444             }
00445 
00446 <span class="preprocessor">#endif</span>
00447 <span class="preprocessor"></span>
00448         }
00449     }
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">// Unlock the dispacher database and process DPC list entries.</span>
00453     <span class="comment">//</span>
00454 
00455     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != 0) {
00456         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00457         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00458         <span class="keywordflow">do</span> {
00459 
00460 <span class="preprocessor">#if DBG &amp;&amp; (defined(i386) || defined(ALPHA))</span>
00461 <span class="preprocessor"></span>
00462             <span class="comment">//</span>
00463             <span class="comment">// Reset the dpc tick count. If the tick count handler,</span>
00464             <span class="comment">// which increments this value, detects that it has crossed</span>
00465             <span class="comment">// a certain threshold, a breakpoint will be generated.</span>
00466             <span class="comment">//</span>
00467 
00468             <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;DebugDpcTime = 0;
00469 <span class="preprocessor">#endif</span>
00470 <span class="preprocessor"></span>
00471             (DpcList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o1">Routine</a>)(DpcList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o0">Dpc</a>,
00472                                      DpcList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o2">Context</a>,
00473                                      ULongToPtr(SystemTime.LowPart),
00474                                      ULongToPtr(SystemTime.HighPart));
00475 
00476 
00477             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00478         } <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00479 
00480         <span class="comment">//</span>
00481         <span class="comment">// If processing of the expired timer list was terminated because</span>
00482         <span class="comment">// the DPC List was full, then process any remaining entries.</span>
00483         <span class="comment">//</span>
00484 
00485         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == <a class="code" href="../../d5/d1/dpcsup_8c.html#a0">MAXIMUM_DPC_LIST_SIZE</a>) {
00486             <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql1);
00487             <span class="keywordflow">goto</span> RestartScan;
00488         }
00489 
00490         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00491 
00492     } <span class="keywordflow">else</span> {
00493         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00494     }
00495 
00496     <span class="keywordflow">return</span>;
00497 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:46 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
