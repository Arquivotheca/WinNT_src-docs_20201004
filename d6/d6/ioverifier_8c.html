<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ioverifier.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ioverifier.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>

<p>
<a href="../../d7/d5/ioverifier_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a0">IO_FREE_IRP_TYPE_INVALID</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a1">IO_FREE_IRP_NOT_ASSOCIATED_WITH_THREAD</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a2">IO_CALL_DRIVER_IRP_TYPE_INVALID</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a3">IO_CALL_DRIVER_INVALID_DEVICE_OBJECT</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a4">IO_CALL_DRIVER_IRQL_NOT_EQUAL</a>&nbsp;&nbsp;&nbsp;5</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a5">IO_COMPLETE_REQUEST_INVALID_STATUS</a>&nbsp;&nbsp;&nbsp;6</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a6">IO_COMPLETE_REQUEST_CANCEL_ROUTINE_SET</a>&nbsp;&nbsp;&nbsp;7</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a7">IO_BUILD_FSD_REQUEST_EXCEPTION</a>&nbsp;&nbsp;&nbsp;8</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a8">IO_BUILD_IOCTL_REQUEST_EXCEPTION</a>&nbsp;&nbsp;&nbsp;9</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a9">IO_REINITIALIZING_TIMER_OBJECT</a>&nbsp;&nbsp;&nbsp;10</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a10">IO_INVALID_HANDLE</a>&nbsp;&nbsp;&nbsp;11</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a11">IO_INVALID_STACK_IOSB</a>&nbsp;&nbsp;&nbsp;12</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a12">IO_INVALID_STACK_EVENT</a>&nbsp;&nbsp;&nbsp;13</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a13">IO_COMPLETE_REQUEST_INVALID_IRQL</a>&nbsp;&nbsp;&nbsp;14</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a14">IsKernelHandle</a>(H, M)&nbsp;&nbsp;&nbsp;(((LONG_PTR)(H) &lt; 0) &amp;&amp; ((M) == KernelMode) &amp;&amp; ((H) != NtCurrentThread()) &amp;&amp; ((H) != NtCurrentProcess()))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a15">ZeroAndDopeIrpStackLocation</a>(IrpSp)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a23">VerifierAllocatePoolWithQuotaTag</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN SIZE_T NumberOfBytes, IN ULONG Tag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a24">IovpValidateDeviceObject</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a25">IovFreeIrpPrivate</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a26">IoVerifierInit</a> (IN ULONG VerifierFlags, IN ULONG InitFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a27">IovFreeIrp</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a28">IovCallDriver</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a29">IovCompleteRequest</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN CCHAR <a class="el" href="../../d0/d6/iop_8h.html#a36">PriorityBoost</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a30">IovAllocateIrp</a> (IN CCHAR StackSize, IN BOOLEAN ChargeQuota)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a31">IovBuildAsynchronousFsdRequest</a> (IN ULONG MajorFunction, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN OUT PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a> OPTIONAL, IN ULONG Length OPTIONAL, IN PLARGE_INTEGER StartingOffset OPTIONAL, IN PIO_STATUS_BLOCK IoStatusBlock OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a32">IovBuildDeviceIoControlRequest</a> (IN ULONG IoControlCode, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PVOID InputBuffer OPTIONAL, IN ULONG InputBufferLength, OUT PVOID OutputBuffer OPTIONAL, IN ULONG OutputBufferLength, IN BOOLEAN InternalDeviceIoControl, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event, OUT PIO_STATUS_BLOCK IoStatusBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a33">IovInitializeTimer</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d5/io_8h.html#a283">PIO_TIMER_ROUTINE</a> TimerRoutine, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a34">IovpCompleteRequest</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a35">IovSpecialIrpCompleteRequest</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN CCHAR <a class="el" href="../../d0/d6/iop_8h.html#a36">PriorityBoost</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a36">IovSpecialIrpCallDriver</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a37">IovInitializeIrp</a> (<a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> PacketSize, CCHAR StackSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a38">IovAttachDeviceToDeviceStack</a> (<a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> SourceDevice, <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> TargetDevice)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a39">IovDeleteDevice</a> (<a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeleteDevice)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a40">IovDetachDevice</a> (<a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> TargetDevice)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a41">IovCancelIrp</a> (<a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, BOOLEAN *returnValue)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a16">IopVerifierOn</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a17">IovpEnforcementLevel</a> = (ULONG) -1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a18">IovpVerifierLevel</a> = (ULONG)0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a19">IoVerifierOnByDefault</a> = TRUE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a20">IovpInitCalled</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a21">IovpMaxSupportedVerifierLevel</a> = 3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/ioverifier_8c.html#a22">IovpVerifierFlags</a> = 0</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a7" doxytag="ioverifier.c::IO_BUILD_FSD_REQUEST_EXCEPTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_BUILD_FSD_REQUEST_EXCEPTION&nbsp;&nbsp;&nbsp;8          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00038">38</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00455">IovBuildAsynchronousFsdRequest()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ioverifier.c::IO_BUILD_IOCTL_REQUEST_EXCEPTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_BUILD_IOCTL_REQUEST_EXCEPTION&nbsp;&nbsp;&nbsp;9          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00039">39</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00486">IovBuildDeviceIoControlRequest()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ioverifier.c::IO_CALL_DRIVER_INVALID_DEVICE_OBJECT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_CALL_DRIVER_INVALID_DEVICE_OBJECT&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00034">34</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00248">IovCallDriver()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01159">IovSpecialIrpCallDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ioverifier.c::IO_CALL_DRIVER_IRP_TYPE_INVALID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_CALL_DRIVER_IRP_TYPE_INVALID&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00033">33</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00248">IovCallDriver()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01159">IovSpecialIrpCallDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ioverifier.c::IO_CALL_DRIVER_IRQL_NOT_EQUAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_CALL_DRIVER_IRQL_NOT_EQUAL&nbsp;&nbsp;&nbsp;5          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00035">35</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00248">IovCallDriver()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01159">IovSpecialIrpCallDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ioverifier.c::IO_COMPLETE_REQUEST_CANCEL_ROUTINE_SET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_COMPLETE_REQUEST_CANCEL_ROUTINE_SET&nbsp;&nbsp;&nbsp;7          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00037">37</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00297">IovCompleteRequest()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="ioverifier.c::IO_COMPLETE_REQUEST_INVALID_IRQL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_COMPLETE_REQUEST_INVALID_IRQL&nbsp;&nbsp;&nbsp;14          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00044">44</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00297">IovCompleteRequest()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ioverifier.c::IO_COMPLETE_REQUEST_INVALID_STATUS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_COMPLETE_REQUEST_INVALID_STATUS&nbsp;&nbsp;&nbsp;6          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00036">36</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00297">IovCompleteRequest()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ioverifier.c::IO_FREE_IRP_NOT_ASSOCIATED_WITH_THREAD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_FREE_IRP_NOT_ASSOCIATED_WITH_THREAD&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00032">32</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00206">IovFreeIrpPrivate()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="ioverifier.c::IO_FREE_IRP_TYPE_INVALID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_FREE_IRP_TYPE_INVALID&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00031">31</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00206">IovFreeIrpPrivate()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ioverifier.c::IO_INVALID_HANDLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_INVALID_HANDLE&nbsp;&nbsp;&nbsp;11          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00041">41</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="ioverifier.c::IO_INVALID_STACK_EVENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_INVALID_STACK_EVENT&nbsp;&nbsp;&nbsp;13          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00043">43</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00542">IovpCompleteRequest()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="ioverifier.c::IO_INVALID_STACK_IOSB" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_INVALID_STACK_IOSB&nbsp;&nbsp;&nbsp;12          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00042">42</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00542">IovpCompleteRequest()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ioverifier.c::IO_REINITIALIZING_TIMER_OBJECT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_REINITIALIZING_TIMER_OBJECT&nbsp;&nbsp;&nbsp;10          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00040">40</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00524">IovInitializeTimer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="ioverifier.c::IsKernelHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsKernelHandle          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">H,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>M&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(((LONG_PTR)(H) &lt; 0) &amp;&amp; ((M) == KernelMode) &amp;&amp; ((H) != NtCurrentThread()) &amp;&amp; ((H) != NtCurrentProcess()))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00057">57</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00545">NtSetInformationObject()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">NtWaitForMultipleObjects()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="ioverifier.c::ZeroAndDopeIrpStackLocation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ZeroAndDopeIrpStackLocation          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IrpSp&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{  \
    (IrpSp)-&gt;MinorFunction = 0;                 \
    (IrpSp)-&gt;Flags = 0;                         \
    (IrpSp)-&gt;Control = <a class="code" href="../../d9/d4/trackirp_8h.html#a60">SL_NOTCOPIED</a>;            \
    (IrpSp)-&gt;Parameters.Others.Argument1 = 0;   \
    (IrpSp)-&gt;Parameters.Others.Argument2 = 0;   \
    (IrpSp)-&gt;Parameters.Others.Argument3 = 0;   \
    (IrpSp)-&gt;Parameters.Others.Argument4 = 0;   \
    (IrpSp)-&gt;FileObject = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; }
</div></pre>
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00586">IovSpecialIrpCompleteRequest()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a30" doxytag="ioverifier.c::IovAllocateIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> IovAllocateIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN CCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>StackSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ChargeQuota</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00353">353</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01680">_IRP::AllocationFlags</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00993">ExAllocatePoolWithTagPriority()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d5/d8/ex_8h.html#a330a195">HighPoolPrioritySpecialPoolOverrun</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00662">IopAllocateIrpPrivate()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00930">IopInitializeIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04269">IoSizeOfIrp</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00088">IovpVerifierFlags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01575">IRP_ALLOCATED_MUST_SUCCEED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01574">IRP_QUOTA_CHARGED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00644">SPECIALIRP_IO_ALLOCATE_IRP_1</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00653">SPECIALIRP_IO_ALLOCATE_IRP_2</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>.
<p>
<pre class="fragment"><div>00357 {
00358     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> allocateSize;
00359     UCHAR fixedSize;
00360     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00361     UCHAR mustSucceed;
00362     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> packetSize;
00363 
00364 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
00365 <span class="preprocessor"></span>    <span class="comment">//</span>
00366     <span class="comment">// Should we override normal lookaside caching so that we may catch</span>
00367     <span class="comment">// more bugs?</span>
00368     <span class="comment">//</span>
00369     <a class="code" href="../../d9/d4/trackirp_8h.html#a80">SPECIALIRP_IO_ALLOCATE_IRP_1</a>(StackSize, ChargeQuota, &amp;irp) ;
00370 
00371     <span class="keywordflow">if</span> (irp) {
00372        <span class="keywordflow">return</span> irp ;
00373     }
00374 <span class="preprocessor">#endif</span>
00375 <span class="preprocessor"></span>
00376     <span class="comment">//</span>
00377     <span class="comment">// If special pool is not turned on lets just call the standard</span>
00378     <span class="comment">// irp allocator.</span>
00379     <span class="comment">//</span>
00380 
00381     <span class="keywordflow">if</span> (!(<a class="code" href="../../d6/d6/ioverifier_8c.html#a22">IovpVerifierFlags</a> &amp; DRIVER_VERIFIER_SPECIAL_POOLING )) {
00382         irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a18">IopAllocateIrpPrivate</a>(StackSize, ChargeQuota);
00383         <span class="keywordflow">return</span> irp;
00384     }
00385 
00386 
00387     irp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00388     fixedSize = 0;
00389     mustSucceed = 0;
00390     packetSize = <a class="code" href="../../d0/d5/io_8h.html#a245">IoSizeOfIrp</a>(StackSize);
00391     allocateSize = packetSize;
00392 
00393     <span class="comment">//</span>
00394     <span class="comment">// There are no free packets on the lookaside list, or the packet is</span>
00395     <span class="comment">// too large to be allocated from one of the lists, so it must be</span>
00396     <span class="comment">// allocated from nonpaged pool. If quota is to be charged, charge it</span>
00397     <span class="comment">// against the current process. Otherwise, allocate the pool normally.</span>
00398     <span class="comment">//</span>
00399 
00400     <span class="keywordflow">if</span> (ChargeQuota) {
00401         <span class="keywordflow">try</span> {
00402             irp = <a class="code" href="../../d5/d8/ex_8h.html#a222">ExAllocatePoolWithTagPriority</a>(
00403                     NonPagedPool,
00404                     allocateSize,
00405                     ' prI',
00406                     HighPoolPrioritySpecialPoolOverrun);
00407         } except(EXCEPTION_EXECUTE_HANDLER) {
00408             NOTHING;
00409         }
00410 
00411     } <span class="keywordflow">else</span> {
00412 
00413         <span class="comment">//</span>
00414         <span class="comment">// Attempt to allocate the pool from non-paged pool.  If this</span>
00415         <span class="comment">// fails, and the caller's previous mode was kernel then allocate</span>
00416         <span class="comment">// the pool as must succeed.</span>
00417         <span class="comment">//</span>
00418 
00419         irp = <a class="code" href="../../d5/d8/ex_8h.html#a222">ExAllocatePoolWithTagPriority</a>(
00420                 NonPagedPool,
00421                 allocateSize,
00422                 ' prI',
00423                 HighPoolPrioritySpecialPoolOverrun);
00424         <span class="keywordflow">if</span> (!irp) {
00425             mustSucceed = <a class="code" href="../../d0/d5/io_8h.html#a191">IRP_ALLOCATED_MUST_SUCCEED</a>;
00426             <span class="keywordflow">if</span> (KeGetPreviousMode() == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
00427                 irp = <a class="code" href="../../d5/d8/ex_8h.html#a222">ExAllocatePoolWithTagPriority</a>(
00428                         NonPagedPoolMustSucceed,
00429                         allocateSize,
00430                         ' prI',
00431                         HighPoolPrioritySpecialPoolOverrun);
00432             }
00433         }
00434     }
00435 
00436     <span class="keywordflow">if</span> (!irp) {
00437         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00438     }
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// Initialize the packet.</span>
00442     <span class="comment">//</span>
00443 
00444     <a class="code" href="../../d0/d6/iop_8h.html#a20">IopInitializeIrp</a>(irp, packetSize, StackSize);
00445     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> = mustSucceed;
00446     <span class="keywordflow">if</span> (ChargeQuota) {
00447         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a190">IRP_QUOTA_CHARGED</a>;
00448     }
00449 
00450     <a class="code" href="../../d9/d4/trackirp_8h.html#a81">SPECIALIRP_IO_ALLOCATE_IRP_2</a>(irp) ;
00451     <span class="keywordflow">return</span> irp;
00452 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="ioverifier.c::IovAttachDeviceToDeviceStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovAttachDeviceToDeviceStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceDevice</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetDevice</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01296">1296</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00113">IovpVerifierLevel</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00676">SPECIALIRP_IO_ATTACH_DEVICE_TO_DEVICE_STACK</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>01300 {
01301     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a57">IovpVerifierLevel</a> &lt; 2) {
01302         <span class="keywordflow">return</span>;
01303     }
01304 
01305     <a class="code" href="../../d9/d4/trackirp_8h.html#a84">SPECIALIRP_IO_ATTACH_DEVICE_TO_DEVICE_STACK</a>(SourceDevice, TargetDevice);
01306 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="ioverifier.c::IovBuildAsynchronousFsdRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> IovBuildAsynchronousFsdRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MajorFunction</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG Length&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER StartingOffset&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_STATUS_BLOCK IoStatusBlock&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00455">455</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00038">IO_BUILD_FSD_REQUEST_EXCEPTION</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01360">IoBuildAsynchronousFsdRequest()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, and <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>.
<p>
<pre class="fragment"><div>00463 {
00464     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>    <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00465 
00466     <span class="keywordflow">try</span> {
00467         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a24">IoBuildAsynchronousFsdRequest</a>(
00468             MajorFunction,
00469             DeviceObject,
00470             Buffer,
00471             Length,
00472             StartingOffset,
00473             IoStatusBlock
00474             );
00475     } except(EXCEPTION_EXECUTE_HANDLER) {
00476          <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00477                       IO_BUILD_FSD_REQUEST_EXCEPTION,
00478                       (ULONG_PTR)DeviceObject,
00479                       (ULONG_PTR)MajorFunction,
00480                       GetExceptionCode());
00481     }
00482     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>);
00483 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="ioverifier.c::IovBuildDeviceIoControlRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> IovBuildDeviceIoControlRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IoControlCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InputBuffer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>InputBufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID OutputBuffer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OutputBufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>InternalDeviceIoControl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Event</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00486">486</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00039">IO_BUILD_IOCTL_REQUEST_EXCEPTION</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, and <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>.
<p>
<pre class="fragment"><div>00497 {
00498     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>    <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00499 
00500     <span class="keywordflow">try</span> {
00501         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>(
00502             IoControlCode,
00503             DeviceObject,
00504             InputBuffer,
00505             InputBufferLength,
00506             OutputBuffer,
00507             OutputBufferLength,
00508             InternalDeviceIoControl,
00509             Event,
00510             IoStatusBlock
00511             );
00512     } except(EXCEPTION_EXECUTE_HANDLER) {
00513          <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00514                       IO_BUILD_IOCTL_REQUEST_EXCEPTION,
00515                       (ULONG_PTR)DeviceObject,
00516                       (ULONG_PTR)IoControlCode,
00517                       GetExceptionCode());
00518     }
00519 
00520     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>);
00521 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="ioverifier.c::IovCallDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FASTCALL IovCallDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00248">248</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00034">IO_CALL_DRIVER_INVALID_DEVICE_OBJECT</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00033">IO_CALL_DRIVER_IRP_TYPE_INVALID</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00035">IO_CALL_DRIVER_IRQL_NOT_EQUAL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00040">IO_TYPE_IRP</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02063">IopfCallDriver()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00548">IopVerifierOn</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00184">IovpValidateDeviceObject()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00113">IovpVerifierLevel</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01159">IovSpecialIrpCallDriver()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01584">_IRP::Type</a>.
<p>
<pre class="fragment"><div>00252 {
00253     KIRQL    saveIrql;
00254     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00255 
00256 
00257     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a132">IopVerifierOn</a>) {
00258         status = <a class="code" href="../../d4/d6/iosubs_8c.html#a28">IopfCallDriver</a>(DeviceObject, Irp);
00259         <span class="keywordflow">return</span> status;
00260     }
00261 
00262     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a57">IovpVerifierLevel</a> &gt; 1) {
00263         status = <a class="code" href="../../d7/d6/ioverifier_8h.html#a8">IovSpecialIrpCallDriver</a>(DeviceObject, Irp);
00264         <span class="keywordflow">return</span> status;
00265     }
00266     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o0">Type</a> != <a class="code" href="../../d0/d5/io_8h.html#a5">IO_TYPE_IRP</a>) {
00267         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00268                      IO_CALL_DRIVER_IRP_TYPE_INVALID,
00269                      (ULONG_PTR)Irp,
00270                      0,
00271                      0);
00272     }
00273     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/ioverifier_8c.html#a24">IovpValidateDeviceObject</a>(DeviceObject)) {
00274         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00275                      IO_CALL_DRIVER_INVALID_DEVICE_OBJECT,
00276                      (ULONG_PTR)DeviceObject,
00277                      0,
00278                      0);
00279     }
00280 
00281     saveIrql = KeGetCurrentIrql();
00282     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a28">IopfCallDriver</a>(DeviceObject, Irp);
00283     <span class="keywordflow">if</span> (saveIrql != KeGetCurrentIrql()) {
00284         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00285                      IO_CALL_DRIVER_IRQL_NOT_EQUAL,
00286                      (ULONG_PTR)DeviceObject,
00287                      saveIrql,
00288                      KeGetCurrentIrql());
00289 
00290     }
00291     <span class="keywordflow">return</span> status;
00292 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="ioverifier.c::IovCancelIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IovCancelIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN *&nbsp;</td>
          <td class="mdname" nowrap> <em>returnValue</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01332">1332</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00619">SPECIALIRP_IO_CANCEL_IRP</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01336 {
01337 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
01338 <span class="preprocessor"></span>    BOOLEAN cancelHandled ;
01339 
01340     <a class="code" href="../../d9/d4/trackirp_8h.html#a77">SPECIALIRP_IO_CANCEL_IRP</a>(Irp, &amp;cancelHandled, returnValue) ;
01341 
01342     <span class="keywordflow">if</span> (cancelHandled) {
01343 
01344        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
01345     }
01346 <span class="preprocessor">#endif</span>
01347 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01348 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="ioverifier.c::IovCompleteRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovCompleteRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>PriorityBoost</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00297">297</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01701">_IRP::CancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01655">_IRP::CurrentLocation</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00037">IO_COMPLETE_REQUEST_CANCEL_ROUTINE_SET</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00044">IO_COMPLETE_REQUEST_INVALID_IRQL</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00036">IO_COMPLETE_REQUEST_INVALID_STATUS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00040">IO_TYPE_IRP</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l03180">IopfCompleteRequest()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00548">IopVerifierOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00113">IovpVerifierLevel</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00586">IovSpecialIrpCompleteRequest()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00137">PriorityBoost</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01654">_IRP::StackCount</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01584">_IRP::Type</a>.
<p>
<pre class="fragment"><div>00301 {
00302 
00303     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a132">IopVerifierOn</a>) {
00304         <a class="code" href="../../d4/d6/iosubs_8c.html#a40">IopfCompleteRequest</a>(Irp, PriorityBoost);
00305         <span class="keywordflow">return</span>;
00306     }
00307 
00308     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a57">IovpVerifierLevel</a> &gt; 1) {
00309         <a class="code" href="../../d7/d6/ioverifier_8h.html#a9">IovSpecialIrpCompleteRequest</a>(Irp, PriorityBoost);
00310         <span class="keywordflow">return</span>;
00311     }
00312 
00313     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> &gt; (CCHAR) (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> + 1) ||
00314         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o0">Type</a> != <a class="code" href="../../d0/d5/io_8h.html#a5">IO_TYPE_IRP</a>) {
00315         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( MULTIPLE_IRP_COMPLETE_REQUESTS,
00316                       (ULONG_PTR) Irp,
00317                       __LINE__,
00318                       0,
00319                       0);
00320     }
00321 
00322     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a>) {
00323         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00324                      IO_COMPLETE_REQUEST_CANCEL_ROUTINE_SET,
00325                      (ULONG_PTR)<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a>,
00326                      (ULONG_PTR)Irp,
00327                      0);
00328     }
00329     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == STATUS_PENDING || <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == 0xffffffff) {
00330          <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00331                       IO_COMPLETE_REQUEST_INVALID_STATUS,
00332                       <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status,
00333                       (ULONG_PTR)Irp,
00334                       0);
00335     }
00336     <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
00337         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00338                      IO_COMPLETE_REQUEST_INVALID_IRQL,
00339                      KeGetCurrentIrql(),
00340                      (ULONG_PTR)Irp,
00341                      0);
00342 
00343     }
00344     <a class="code" href="../../d4/d6/iosubs_8c.html#a40">IopfCompleteRequest</a>(Irp, PriorityBoost);
00345 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="ioverifier.c::IovDeleteDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovDeleteDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeleteDevice</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01309">1309</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00113">IovpVerifierLevel</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00669">SPECIALIRP_IO_DELETE_DEVICE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>01312 {
01313     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a57">IovpVerifierLevel</a> &lt; 2) {
01314         <span class="keywordflow">return</span>;
01315     }
01316 
01317     <a class="code" href="../../d9/d4/trackirp_8h.html#a83">SPECIALIRP_IO_DELETE_DEVICE</a>(DeleteDevice);
01318 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="ioverifier.c::IovDetachDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovDetachDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TargetDevice</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01321">1321</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00113">IovpVerifierLevel</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00683">SPECIALIRP_IO_DETACH_DEVICE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>01324 {
01325     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a57">IovpVerifierLevel</a> &lt; 2) {
01326         <span class="keywordflow">return</span>;
01327     }
01328     <a class="code" href="../../d9/d4/trackirp_8h.html#a85">SPECIALIRP_IO_DETACH_DEVICE</a>(TargetDevice);
01329 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="ioverifier.c::IoVerifierInit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IoVerifierInit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>VerifierFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>InitFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">91</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00128">DIAG_IGNORE_DRIVER_LIST</a>, <a class="el" href="../../d2/d4/ioassert_8c-source.html#l00056">IopDcControlInitial</a>, <a class="el" href="../../d2/d4/ioassert_8c-source.html#l00055">IopDcControlLock</a>, <a class="el" href="../../d2/d4/ioassert_8c-source.html#l00057">IopDcControlOverride</a>, <a class="el" href="../../d2/d4/ioassert_8c-source.html#l00423">IopDriverCorrectnessTakeLock()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00548">IopVerifierOn</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00353">IovAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04696">IOVERIFIERINIT_PHASE0</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04700">IOVERIFIERINIT_VERIFIER_DRIVER_LIST</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00085">IoVerifierOnByDefault</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00206">IovFreeIrpPrivate()</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00049">IovpInitCalled</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00257">IovpInitIrpTracking()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00087">IovpMaxSupportedVerifierLevel</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00088">IovpVerifierFlags</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00113">IovpVerifierLevel</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01159">IovSpecialIrpCallDriver()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00586">IovSpecialIrpCompleteRequest()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00315">pIoAllocateIrp</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00313">pIofCallDriver</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00314">pIofCompleteRequest</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00316">pIoFreeIrp</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00404">IovpDoAssertIrps()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l03121">MiInitializeDriverVerifierList()</a>.
<p>
<pre class="fragment"><div>00095 {
00096     PVOID   sectionHeaderHandle;
00097     ULONG   verifierLevel;
00098 
00099     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ioverifier_8c.html#a19">IoVerifierOnByDefault</a>) {
00100         VerifierFlags |= DRIVER_VERIFIER_IO_CHECKING;
00101     }
00102 
00103     <span class="keywordflow">if</span> (!VerifierFlags) {
00104         <span class="keywordflow">return</span>;
00105     }
00106     <a class="code" href="../../d3/d5/iodata_8c.html#a57">pIoAllocateIrp</a> = <a class="code" href="../../d0/d5/io_8h.html#a590">IovAllocateIrp</a>;
00107 
00108 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
00109 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!(InitFlags &amp; <a class="code" href="../../d0/d5/io_8h.html#a260">IOVERIFIERINIT_PHASE0</a>)) {
00110 
00111         <span class="comment">//</span>
00112         <span class="comment">// Lock it down.</span>
00113         <span class="comment">//</span>
00114         sectionHeaderHandle = MmLockPagableCodeSection(IopDriverCorrectnessTakeLock);
00115 
00116         <span class="keywordflow">if</span> (!sectionHeaderHandle) {
00117 
00118             <span class="keywordflow">return</span>;
00119         }
00120     }
00121 
00122     <span class="comment">//</span>
00123     <span class="comment">// Various initialization</span>
00124     <span class="comment">//</span>
00125     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d5/ioassert_8c.html#a9">IopDcControlOverride</a> == (ULONG) -1) {
00126 
00127         <a class="code" href="../../d1/d5/ioassert_8c.html#a9">IopDcControlOverride</a> = 0;
00128     }
00129 
00130     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d5/ioassert_8c.html#a8">IopDcControlInitial</a> == (ULONG) -1) {
00131 
00132         <a class="code" href="../../d1/d5/ioassert_8c.html#a8">IopDcControlInitial</a> = 0;
00133         <span class="keywordflow">if</span> (!(InitFlags &amp; <a class="code" href="../../d0/d5/io_8h.html#a264">IOVERIFIERINIT_VERIFIER_DRIVER_LIST</a>)) {
00134 
00135             <a class="code" href="../../d1/d5/ioassert_8c.html#a8">IopDcControlInitial</a> |= <a class="code" href="../../d2/d5/ioassert_8h.html#a6">DIAG_IGNORE_DRIVER_LIST</a>;
00136         }
00137     }
00138 
00139     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;IopDcControlLock) ;
00140 
00141 <span class="preprocessor">#endif // NO_SPECIAL_IRP</span>
00142 <span class="preprocessor"></span>
00143     <span class="keywordflow">if</span> (!(VerifierFlags &amp; DRIVER_VERIFIER_IO_CHECKING)) {
00144 
00145         <span class="keywordflow">return</span>;
00146     }
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">// Determine the level of verification. Later we will modify the driver</span>
00150     <span class="comment">// verifier applet to pass in a level directly.</span>
00151     <span class="comment">//</span>
00152 
00153 <span class="preprocessor">#if !DBG</span>
00154 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a57">IovpVerifierLevel</a> &gt; <a class="code" href="../../d6/d6/ioverifier_8c.html#a21">IovpMaxSupportedVerifierLevel</a>) {
00155         <a class="code" href="../../d8/d0/cmdat3_8c.html#a57">IovpVerifierLevel</a>  = <a class="code" href="../../d6/d6/ioverifier_8c.html#a21">IovpMaxSupportedVerifierLevel</a>;
00156     }
00157 <span class="preprocessor">#endif</span>
00158 <span class="preprocessor"></span>
00159     verifierLevel = <a class="code" href="../../d8/d0/cmdat3_8c.html#a57">IovpVerifierLevel</a>;
00160 
00161     <span class="comment">//</span>
00162     <span class="comment">// Enable and hook in the verifier.</span>
00163     <span class="comment">//</span>
00164     <a class="code" href="../../d0/d6/iop_8h.html#a132">IopVerifierOn</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00165     <a class="code" href="../../d2/d5/ioassert_8h.html#a25">IovpInitCalled</a> = 1;
00166     <a class="code" href="../../d6/d6/ioverifier_8c.html#a22">IovpVerifierFlags</a> = VerifierFlags;
00167 
00168     <span class="keywordflow">if</span> (verifierLevel &gt; 1) {
00169         <span class="comment">//</span>
00170         <span class="comment">// Initialize the special IRP code as appropriate.</span>
00171         <span class="comment">//</span>
00172 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
00173 <span class="preprocessor"></span>        <a class="code" href="../../d9/d4/trackirp_8h.html#a107">IovpInitIrpTracking</a>(verifierLevel, InitFlags);
00174 <span class="preprocessor">#endif // NO_SPECIAL_IRP</span>
00175 <span class="preprocessor"></span>        InterlockedExchangePointer((PVOID *)&amp;pIofCallDriver, (PVOID) IovSpecialIrpCallDriver);
00176         InterlockedExchangePointer((PVOID *)&amp;pIofCompleteRequest, (PVOID) IovSpecialIrpCompleteRequest);
00177         InterlockedExchangePointer((PVOID *)&amp;pIoFreeIrp, (PVOID) IovFreeIrpPrivate);
00178     }
00179     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= APC_LEVEL);
00180 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="ioverifier.c::IovFreeIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovFreeIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Irp</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00198">198</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00206">IovFreeIrpPrivate()</a>, and <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>.
<p>
<pre class="fragment"><div>00201 {
00202     <a class="code" href="../../d6/d6/ioverifier_8c.html#a25">IovFreeIrpPrivate</a>(Irp);
00203 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="ioverifier.c::IovFreeIrpPrivate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovFreeIrpPrivate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Irp</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00206">206</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00032">IO_FREE_IRP_NOT_ASSOCIATED_WITH_THREAD</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00031">IO_FREE_IRP_TYPE_INVALID</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00040">IO_TYPE_IRP</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06641">IopFreeIrp()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00548">IopVerifierOn</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00635">SPECIALIRP_IO_FREE_IRP</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01584">_IRP::Type</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00198">IovFreeIrp()</a>.
<p>
<pre class="fragment"><div>00209 {
00210 
00211 
00212 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
00213 <span class="preprocessor"></span>    BOOLEAN freeHandled ;
00214 <span class="preprocessor">#endif</span>
00215 <span class="preprocessor"></span>
00216 
00217     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a132">IopVerifierOn</a>) {
00218         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o0">Type</a> != <a class="code" href="../../d0/d5/io_8h.html#a5">IO_TYPE_IRP</a>) {
00219             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00220                          IO_FREE_IRP_TYPE_INVALID,
00221                          (ULONG_PTR)Irp,
00222                          0,
00223                          0);
00224         }
00225         <span class="keywordflow">if</span> (!IsListEmpty(&amp;(Irp)-&gt;ThreadListEntry)) {
00226             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00227                          IO_FREE_IRP_NOT_ASSOCIATED_WITH_THREAD,
00228                          (ULONG_PTR)Irp,
00229                          0,
00230                          0);
00231         }
00232     }
00233 
00234 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
00235 <span class="preprocessor"></span>    <a class="code" href="../../d9/d4/trackirp_8h.html#a79">SPECIALIRP_IO_FREE_IRP</a>(Irp, &amp;freeHandled) ;
00236 
00237     <span class="keywordflow">if</span> (freeHandled) {
00238 
00239        <span class="keywordflow">return</span> ;
00240     }
00241 <span class="preprocessor">#endif</span>
00242 <span class="preprocessor"></span>
00243     <a class="code" href="../../d4/d6/iosubs_8c.html#a64">IopFreeIrp</a>(Irp);
00244 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="ioverifier.c::IovInitializeIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovInitializeIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PacketSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>CCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>StackSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01279">1279</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00113">IovpVerifierLevel</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00660">SPECIALIRP_IO_INITIALIZE_IRP</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>01284 {
01285     BOOLEAN initializeHandled ;
01286 
01287     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a57">IovpVerifierLevel</a> &lt; 2) {
01288         <span class="keywordflow">return</span>;
01289     }
01290 
01291     <a class="code" href="../../d9/d4/trackirp_8h.html#a82">SPECIALIRP_IO_INITIALIZE_IRP</a>(Irp, PacketSize, StackSize, &amp;initializeHandled) ;
01292 
01293 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="ioverifier.c::IovInitializeTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IovInitializeTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a283">PIO_TIMER_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00524">524</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00040">IO_REINITIALIZING_TIMER_OBJECT</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07543">IoInitializeTimer()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, and <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>.
<p>
<pre class="fragment"><div>00529 {
00530     <span class="keywordflow">if</span> (DeviceObject-&gt;Timer) {
00531         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00532                      IO_REINITIALIZING_TIMER_OBJECT,
00533                      (ULONG_PTR)DeviceObject,
00534                      0,
00535                      0);
00536    }
00537    <span class="keywordflow">return</span> (<a class="code" href="../../d4/d6/iosubs_8c.html#a82">IoInitializeTimer</a>(DeviceObject, TimerRoutine, Context));
00538 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="ioverifier.c::IovpCompleteRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovpCompleteRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00542">542</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00043">IO_INVALID_STACK_EVENT</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00042">IO_INVALID_STACK_IOSB</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>00547 {
00548     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>    irp;
00549     PUCHAR addr;
00550     ULONG   BestStackOffset;
00551 
00552     irp = CONTAINING_RECORD( Apc, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, Tail.Apc );
00553 
00554 <span class="preprocessor">#if defined(_X86_)</span>
00555 <span class="preprocessor"></span>
00556 
00557     addr = (PUCHAR)irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>;
00558     <span class="keywordflow">if</span> ((addr &gt; (PUCHAR)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;StackLimit) &amp;&amp;
00559         (addr &lt;= (PUCHAR)&amp;BestStackOffset)) {
00560         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00561                      IO_INVALID_STACK_IOSB,
00562                      (ULONG_PTR)addr,
00563                      0,
00564                      0);
00565 
00566     }
00567 
00568     addr = (PUCHAR)irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a>;
00569     <span class="keywordflow">if</span> ((addr &gt; (PUCHAR)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;StackLimit) &amp;&amp;
00570         (addr &lt;= (PUCHAR)&amp;BestStackOffset)) {
00571         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00572                      IO_INVALID_STACK_EVENT,
00573                      (ULONG_PTR)addr,
00574                      0,
00575                      0);
00576 
00577     }
00578 <span class="preprocessor">#endif</span>
00579 <span class="preprocessor"></span>}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="ioverifier.c::IovpValidateDeviceObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IovpValidateDeviceObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00184">184</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00037">IO_TYPE_DEVICE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00248">IovCallDriver()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01159">IovSpecialIrpCallDriver()</a>.
<p>
<pre class="fragment"><div>00187 {
00188     <span class="keywordflow">if</span> ((DeviceObject-&gt;Type != <a class="code" href="../../d0/d5/io_8h.html#a2">IO_TYPE_DEVICE</a>) ||
00189         (DeviceObject-&gt;DriverObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00190         (DeviceObject-&gt;ReferenceCount &lt; 0 )) {
00191         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00192     } <span class="keywordflow">else</span> {
00193         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00194     }
00195 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="ioverifier.c::IovSpecialIrpCallDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FASTCALL IovSpecialIrpCallDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01159">1159</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01655">_IRP::CurrentLocation</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00034">FASTCALL</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00034">IO_CALL_DRIVER_INVALID_DEVICE_OBJECT</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00033">IO_CALL_DRIVER_IRP_TYPE_INVALID</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00035">IO_CALL_DRIVER_IRQL_NOT_EQUAL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00040">IO_TYPE_IRP</a>, <a class="el" href="../../d9/d4/trackirp_8h.html#a95">IOFCALLDRIVER_STACKDATA</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02063">IopfCallDriver()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00548">IopVerifierOn</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00184">IovpValidateDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01414">_DRIVER_OBJECT::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00558">PDRIVER_DISPATCH</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02168">PERFINFO_DRIVER_MAJORFUNCTION_CALL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02169">PERFINFO_DRIVER_MAJORFUNCTION_RETURN</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00564">SPECIALIRP_IOF_CALL_1</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00575">SPECIALIRP_IOF_CALL_2</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01584">_IRP::Type</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00248">IovCallDriver()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>.
<p>
<pre class="fragment"><div>01165                    :
01166 
01167     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to pass an I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) to another
01168     driver at its dispatch routine. This routine is called only for <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> tracking
01169     It duplicates the code in iosubs.c.
01170 
01171 Arguments:
01172 
01173     DeviceObject - Pointer to device object to which the <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> should be passed.
01174 
01175     Irp - Pointer to <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> for request.
01176 
01177 Return Value:
01178 
01179     Return status from driver's dispatch routine.
01180 
01181 --*/
01182 
01183 {
01184     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
01185     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
01186     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01187     KIRQL saveIrql;
01188     <a class="code" href="../../d0/d5/io_8h.html#a287">PDRIVER_DISPATCH</a> dispatchRoutine;
01189     <a class="code" href="../../d3/d0/struct__IOFCALLDRIVER__STACKDATA.html">IOFCALLDRIVER_STACKDATA</a> iofCallDriverStackData ;
01190 
01191     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a132">IopVerifierOn</a>) {
01192         status = <a class="code" href="../../d4/d6/iosubs_8c.html#a28">IopfCallDriver</a>(DeviceObject, Irp);
01193         <span class="keywordflow">return</span> status;
01194     }
01195 
01196     <span class="comment">//</span>
01197     <span class="comment">// Ensure that this is really an I/O Request Packet.</span>
01198     <span class="comment">//</span>
01199 
01200     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o0">Type</a> != <a class="code" href="../../d0/d5/io_8h.html#a5">IO_TYPE_IRP</a>) {
01201 
01202         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o0">Type</a> == IO_TYPE_IRP);
01203         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
01204                      IO_CALL_DRIVER_IRP_TYPE_INVALID,
01205                      (ULONG_PTR)Irp,
01206                      0,
01207                      0);
01208     }
01209 
01210     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/ioverifier_8c.html#a24">IovpValidateDeviceObject</a>(DeviceObject)) {
01211         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
01212                      IO_CALL_DRIVER_INVALID_DEVICE_OBJECT,
01213                      (ULONG_PTR)DeviceObject,
01214                      0,
01215                      0);
01216     }
01217 
01218     <a class="code" href="../../d9/d4/trackirp_8h.html#a70">SPECIALIRP_IOF_CALL_1</a>(&amp;Irp, DeviceObject, &amp;iofCallDriverStackData) ;
01219 
01220     <span class="comment">//</span>
01221     <span class="comment">// Update the IRP stack to point to the next location.</span>
01222     <span class="comment">//</span>
01223     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>--;
01224 
01225     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> &lt;= 0) {
01226         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( NO_MORE_IRP_STACK_LOCATIONS, (ULONG_PTR) Irp, 0, 0, 0 );
01227     }
01228 
01229     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( Irp );
01230     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.CurrentStackLocation = irpSp;
01231 
01232     <span class="comment">//</span>
01233     <span class="comment">// Save a pointer to the device object for this request so that it can</span>
01234     <span class="comment">// be used later in completion.</span>
01235     <span class="comment">//</span>
01236 
01237     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a> = DeviceObject;
01238 
01239     <span class="comment">//</span>
01240     <span class="comment">// Invoke the driver at its dispatch routine entry point.</span>
01241     <span class="comment">//</span>
01242 
01243     driverObject = DeviceObject-&gt;DriverObject;
01244 
01245     dispatchRoutine = driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o14">MajorFunction</a>[irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a>] ;
01246 
01247     saveIrql = KeGetCurrentIrql();
01248 
01249     <a class="code" href="../../d2/d1/mm_8h.html#a47">PERFINFO_DRIVER_MAJORFUNCTION_CALL</a>(Irp, irpSp, driverObject);
01250 
01251     status = dispatchRoutine( DeviceObject, Irp );
01252 
01253     <a class="code" href="../../d2/d1/mm_8h.html#a48">PERFINFO_DRIVER_MAJORFUNCTION_RETURN</a>(Irp, irpSp, driverObject);
01254 
01255     <span class="keywordflow">if</span> (saveIrql != KeGetCurrentIrql()) {
01256 
01257         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IO: IoCallDriver( Driver object: %p  Device object: %p  Irp: %p )\n"</span>,
01258                   driverObject,
01259                   DeviceObject,
01260                   Irp
01261                 );
01262         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"    Irql before: %x  != After: %x\n"</span>, saveIrql, KeGetCurrentIrql() );
01263 
01264         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(saveIrql == KeGetCurrentIrql());
01265 
01266         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
01267                      IO_CALL_DRIVER_IRQL_NOT_EQUAL,
01268                      saveIrql,
01269                      KeGetCurrentIrql(),
01270                      0);
01271     }
01272 
01273     <a class="code" href="../../d9/d4/trackirp_8h.html#a71">SPECIALIRP_IOF_CALL_2</a>(Irp, DeviceObject, dispatchRoutine, &amp;status, &amp;iofCallDriverStackData) ;
01274 
01275     <span class="keywordflow">return</span> status;
01276 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="ioverifier.c::IovSpecialIrpCompleteRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovSpecialIrpCompleteRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>PriorityBoost</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00586">586</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00034">FASTCALL</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00113">SL_NOTCOPIED</a>, and <a class="el" href="../../d6/d6/ioverifier_8c.html#a15">ZeroAndDopeIrpStackLocation</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00297">IovCompleteRequest()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>.
<p>
<pre class="fragment"><div>00592                    :
00593 
00594     The following code <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> when doing <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> tracking. It duplicates code
00595     in iosubs.c.
00596     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to complete an I/O request.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00597     driver in its DPC routine to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.  The
00598     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> performed by <span class="keyword">this</span> routine are as follows.
00599 
00600         1.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to determine whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet's stack locations
00601             have been exhausted.  If not, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack location pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set
00602             to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next location and <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a routine to be invoked, then
00603             <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will be invoked.  This continues until there are either no more
00604             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> which are interested or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet runs <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of stack.
00605 
00606             If a routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet <span class="keywordflow">for</span> a specific driver
00607             which needs to perform work a lot of work or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work needs to be
00608             performed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of another process, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine will
00609             <span class="keywordflow">return</span> an alternate success code of STATUS_MORE_PROCESSING_REQUIRED.
00610             This indicates that <span class="keyword">this</span> completion routine should simply <span class="keywordflow">return</span> to
00611             its caller because <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation will be <span class="stringliteral">"completed"</span> by <span class="keyword">this</span> routine
00612             again sometime in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> future.
00613 
00614         2.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to determine whether <span class="keyword">this</span> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an associated <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
00615             If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> count on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> decremented.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00616             count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master becomes zero, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> will be
00617             completed according to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> steps below taken <span class="keywordflow">for</span> a normal <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> being
00618             completed.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> still non-zero, then <span class="keyword">this</span> <a class="code" href="../../d0/d5/io_8h.html#a355">IRP</a> (the one
00619             being completed) will simply be deallocated.
00620 
00621         3.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> paging I/O or a close operation, then simply write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00622             I/O status block and set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> signaled state, and
00623             dereference <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> paging I/O, deallocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d5/io_8h.html#a355">IRP</a>
00624             as well.
00625 
00626         4.  <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages, <span class="keywordflow">if</span> any, specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> by calling
00627             <a class="code" href="../../d2/d1/mm_8h.html#a274">MmUnlockPages</a>.
00628 
00629         5.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to determine whether or not completion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00630             request can be deferred until later.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be, then <span class="keyword">this</span>
00631             routine simply exits and leaves <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> originator of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00632             request to fully complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d5/io_8h.html#a355">IRP</a>.  By not initializing and queueing
00633             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> special kernel APC to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling thread (which is the current
00634             thread by definition), a lot of interrupt and queueing processing
00635             can be avoided.
00636 
00637 
00638         6.  The <span class="keyword">final</span> rundown routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to queue <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request packet to
00639             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target (requesting) thread as a special kernel mode APC.
00640 
00641 Arguments:
00642 
00643     Irp - Pointer to the I/O Request Packet to complete.
00644 
00645     PriorityBoost - Supplies the amount of priority boost that is to be given
00646         to the target thread when the special kernel APC is queued.
00647 
00648 Return Value:
00649 
00650     None.
00651 
00652 --*/
00653 
00654 #define ZeroAndDopeIrpStackLocation( IrpSp ) {  \
00655     (IrpSp)-&gt;MinorFunction = 0;                 \
00656     (IrpSp)-&gt;Flags = 0;                         \
00657     (IrpSp)-&gt;Control = <a class="code" href="../../d9/d4/trackirp_8h.html#a60">SL_NOTCOPIED</a>;            \
00658     (IrpSp)-&gt;Parameters.Others.Argument1 = 0;   \
00659     (IrpSp)-&gt;Parameters.Others.Argument2 = 0;   \
00660     (IrpSp)-&gt;Parameters.Others.Argument3 = 0;   \
00661     (IrpSp)-&gt;Parameters.Others.Argument4 = 0;   \
00662     (IrpSp)-&gt;FileObject = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; }
00663 
00664 {
00665     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> masterIrp;
00666     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00667     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> stackPointer;
00668     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl;
00669     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> thread;
00670     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00671     KIRQL irql;
00672     PVOID saveAuxiliaryPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00673 
00674 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
00675 <span class="preprocessor"></span>    PVOID routine ;
00676     <a class="code" href="../../d4/d0/struct__IOFCOMPLETEREQUEST__STACKDATA.html">IOFCOMPLETEREQUEST_STACKDATA</a> completionPacket;
00677 <span class="preprocessor">#endif</span>
00678 <span class="preprocessor"></span>
00679     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a132">IopVerifierOn</a>) {
00680         <a class="code" href="../../d4/d6/iosubs_8c.html#a40">IopfCompleteRequest</a>(Irp, PriorityBoost);
00681         <span class="keywordflow">return</span>;
00682     }
00683 
00684 <span class="preprocessor">#if DBG</span>
00685 <span class="preprocessor"></span>
00686     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> &lt;= (CCHAR) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a>) {
00687 
00688         stackPointer = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>(Irp);
00689         <span class="keywordflow">if</span> (stackPointer-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a>) {
00690             <a class="code" href="../../d1/d2/po_8h.html#a0">PoPowerTrace</a>(
00691                 POWERTRACE_COMPLETE,
00692                 <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>(Irp)-&gt;DeviceObject,
00693                 Irp,
00694                 <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>(Irp)
00695                 );
00696         }
00697     }
00698 
00699 <span class="preprocessor">#endif</span>
00700 <span class="preprocessor"></span>
00701     <a class="code" href="../../d9/d4/trackirp_8h.html#a72">SPECIALIRP_IOF_COMPLETE_1</a>(Irp, PriorityBoost, &amp;completionPacket);
00702 
00703     <span class="comment">//</span>
00704     <span class="comment">// Begin by ensuring that this packet has not already been completed</span>
00705     <span class="comment">// by someone.</span>
00706     <span class="comment">//</span>
00707 
00708     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> &gt; (CCHAR) (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> + 1) ||
00709         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o0">Type</a> != <a class="code" href="../../d0/d5/io_8h.html#a5">IO_TYPE_IRP</a>) {
00710         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( MULTIPLE_IRP_COMPLETE_REQUESTS, (ULONG_PTR) Irp, __LINE__, 0, 0 );
00711     }
00712 
00713     <span class="comment">//</span>
00714     <span class="comment">// Ensure that the packet being completed really is still an IRP.</span>
00715     <span class="comment">//</span>
00716 
00717     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o0">Type</a> != <a class="code" href="../../d0/d5/io_8h.html#a5">IO_TYPE_IRP</a>) {
00718 
00719         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00720                      IO_CALL_DRIVER_IRP_TYPE_INVALID,
00721                      (ULONG_PTR)Irp,
00722                      0,
00723                      0);
00724     }
00725 
00726     <span class="comment">//</span>
00727     <span class="comment">// Ensure that no one believes that this request is still in a cancellable</span>
00728     <span class="comment">// state.</span>
00729     <span class="comment">//</span>
00730 
00731     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a>) {
00732 
00733         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a> == NULL);
00734 
00735         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00736                      IO_COMPLETE_REQUEST_CANCEL_ROUTINE_SET,
00737                      (ULONG_PTR)<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a>,
00738                      (ULONG_PTR)Irp,
00739                      0);
00740     }
00741 
00742     <span class="comment">//</span>
00743     <span class="comment">// Ensure that the packet is not being completed with a thoroughly</span>
00744     <span class="comment">// confusing status code.  Actually completing a packet with a pending</span>
00745     <span class="comment">// status probably means that someone forgot to set the real status in</span>
00746     <span class="comment">// the packet.</span>
00747 
00748     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == STATUS_PENDING) {
00749 
00750 
00751          <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00752                       IO_COMPLETE_REQUEST_INVALID_STATUS,
00753                       <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status,
00754                       (ULONG_PTR)Irp,
00755                       0);
00756     }
00757 
00758     <span class="comment">//</span>
00759     <span class="comment">// Ensure that the packet is not being completed with a minus one.  This is</span>
00760     <span class="comment">// apparently a common problem in some drivers, and has no meaning as a</span>
00761     <span class="comment">// status code.</span>
00762     <span class="comment">//</span>
00763 
00764     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == 0xffffffff) {
00765 
00766 
00767          <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(DRIVER_VERIFIER_IOMANAGER_VIOLATION,
00768                       IO_COMPLETE_REQUEST_INVALID_STATUS,
00769                       <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status,
00770                       (ULONG_PTR)Irp,
00771                       0);
00772     }
00773 
00774     <span class="comment">//</span>
00775     <span class="comment">// Ensure that if this is a paging I/O operation, and it failed, that the</span>
00776     <span class="comment">// reason for the failure isn't because quota was exceeded.</span>
00777     <span class="comment">//</span>
00778 
00779     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; IRP_PAGING_IO &amp;&amp; <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == STATUS_QUOTA_EXCEEDED ) );
00780 
00781 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
00782 <span class="preprocessor"></span>
00783     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>) {
00784 
00785         <a class="code" href="../../d4/d6/iosubs_8c.html#a40">IopfCompleteRequest</a>(Irp, PriorityBoost);
00786         <span class="keywordflow">return</span>;
00787     }
00788 
00789     <span class="comment">//</span>
00790     <span class="comment">// Now check to see whether this is the last driver that needs to be</span>
00791     <span class="comment">// invoked for this packet.  If not, then bump the stack and check to</span>
00792     <span class="comment">// see whether the driver wishes to see the completion.  As each stack</span>
00793     <span class="comment">// location is examined, invoke any routine which needs to be invoked.</span>
00794     <span class="comment">// If the routine returns STATUS_MORE_PROCESSING_REQUIRED, then stop the</span>
00795     <span class="comment">// processing of this packet.</span>
00796     <span class="comment">//</span>
00797 
00798     <span class="keywordflow">for</span> (stackPointer = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp ),
00799          <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>++,
00800          <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.CurrentStackLocation++;
00801          <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> &lt;= (CCHAR) (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> + 1);
00802          stackPointer++,
00803          <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>++,
00804          <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.CurrentStackLocation++) {
00805 
00806         <span class="comment">//</span>
00807         <span class="comment">// A stack location was located.  Check to see whether or not it</span>
00808         <span class="comment">// has a completion routine and if so, whether or not it should be</span>
00809         <span class="comment">// invoked.</span>
00810         <span class="comment">//</span>
00811         <span class="comment">// Begin by saving the pending returned flag in the current stack</span>
00812         <span class="comment">// location in the fixed part of the IRP.</span>
00813         <span class="comment">//</span>
00814 
00815         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> = stackPointer-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a194">SL_PENDING_RETURNED</a>;
00816 
00817         <a class="code" href="../../d9/d4/trackirp_8h.html#a73">SPECIALIRP_IOF_COMPLETE_2</a>(Irp, &amp;completionPacket);
00818 
00819         <span class="keywordflow">if</span> ( (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status ) &amp;&amp;
00820              stackPointer-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a196">SL_INVOKE_ON_SUCCESS</a>) ||
00821              (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status ) &amp;&amp;
00822              stackPointer-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a197">SL_INVOKE_ON_ERROR</a>) ||
00823              (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a> &amp;&amp;
00824              stackPointer-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a195">SL_INVOKE_ON_CANCEL</a>)
00825            ) {
00826 
00827             <span class="comment">//</span>
00828             <span class="comment">// This driver has specified a completion routine.  Invoke the</span>
00829             <span class="comment">// routine passing it a pointer to its device object and the</span>
00830             <span class="comment">// IRP that is being completed.</span>
00831             <span class="comment">//</span>
00832 
00833             <a class="code" href="../../d6/d6/ioverifier_8c.html#a15">ZeroAndDopeIrpStackLocation</a>( stackPointer );
00834 
00835 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
00836 <span class="preprocessor"></span>            routine = stackPointer-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a> ;
00837             <a class="code" href="../../d9/d4/trackirp_8h.html#a74">SPECIALIRP_IOF_COMPLETE_3</a>(Irp, routine, &amp;completionPacket);
00838 <span class="preprocessor">#endif</span>
00839 <span class="preprocessor"></span>
00840             <a class="code" href="../../d2/d1/mm_8h.html#a43">PERFINFO_DRIVER_COMPLETIONROUTINE_CALL</a>(Irp, stackPointer);
00841 
00842             status = stackPointer-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a>( (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> == (CCHAR) (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> + 1) ?
00843                                                       (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) NULL :
00844                                                       <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp )-&gt;DeviceObject),
00845                                                       Irp,
00846                                                       stackPointer-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o117">Context</a> );
00847 
00848             <a class="code" href="../../d2/d1/mm_8h.html#a44">PERFINFO_DRIVER_COMPLETIONROUTINE_RETURN</a>(Irp, stackPointer);
00849 
00850             <a class="code" href="../../d9/d4/trackirp_8h.html#a75">SPECIALIRP_IOF_COMPLETE_4</a>(Irp, status, &amp;completionPacket);
00851 
00852             <span class="keywordflow">if</span> (status == STATUS_MORE_PROCESSING_REQUIRED) {
00853 
00854                 <span class="comment">//</span>
00855                 <span class="comment">// Note:  Notice that if the driver has returned the above</span>
00856                 <span class="comment">//        status value, it may have already DEALLOCATED the</span>
00857                 <span class="comment">//        packet!  Therefore, do NOT touch any part of the</span>
00858                 <span class="comment">//        IRP in the following code.</span>
00859                 <span class="comment">//</span>
00860 
00861                 <a class="code" href="../../d9/d4/trackirp_8h.html#a76">SPECIALIRP_IOF_COMPLETE_5</a>(Irp, &amp;completionPacket);
00862                 <span class="keywordflow">return</span>;
00863             }
00864 
00865         } <span class="keywordflow">else</span> {
00866             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> &amp;&amp; <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> &lt;= <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a>) {
00867                 <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( Irp );
00868             }
00869             <a class="code" href="../../d6/d6/ioverifier_8c.html#a15">ZeroAndDopeIrpStackLocation</a>( stackPointer );
00870         }
00871 
00872         <a class="code" href="../../d9/d4/trackirp_8h.html#a76">SPECIALIRP_IOF_COMPLETE_5</a>(Irp, &amp;completionPacket);
00873     }
00874 
00875     <span class="comment">//</span>
00876     <span class="comment">// Check to see whether this is an associated IRP.  If so, then decrement</span>
00877     <span class="comment">// the count in the master IRP.  If the count is decremented to zero,</span>
00878     <span class="comment">// then complete the master packet as well.</span>
00879     <span class="comment">//</span>
00880 
00881     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a177">IRP_ASSOCIATED_IRP</a>) {
00882         ULONG count;
00883         masterIrp = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.MasterIrp;
00884         count = <a class="code" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong</a>( (PULONG) &amp;masterIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.IrpCount,
00885                                        0xffffffff,
00886                                        &amp;IopDatabaseLock );
00887 
00888         <span class="comment">//</span>
00889         <span class="comment">// Deallocate this packet and any MDLs that are associated with it</span>
00890         <span class="comment">// by either doing direct deallocations if they were allocated from</span>
00891         <span class="comment">// a zone or by queueing the packet to a thread to perform the</span>
00892         <span class="comment">// deallocation.</span>
00893         <span class="comment">//</span>
00894         <span class="comment">// Also, check the count of the master IRP to determine whether or not</span>
00895         <span class="comment">// the count has gone to zero.  If not, then simply get out of here.</span>
00896         <span class="comment">// Otherwise, complete the master packet.</span>
00897         <span class="comment">//</span>
00898 
00899         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = masterIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread;
00900         <a class="code" href="../../d0/d6/iop_8h.html#a172">IopFreeIrpAndMdls</a>( Irp );
00901         <span class="keywordflow">if</span> (count == 1) {
00902             <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( masterIrp, PriorityBoost );
00903         }
00904         <span class="keywordflow">return</span>;
00905     }
00906 
00907     <span class="comment">//</span>
00908     <span class="comment">// Check to see if we have a name junction. If so set the stage to</span>
00909     <span class="comment">// transmogrify the reparse point data in IopCompleteRequest.</span>
00910     <span class="comment">//</span>
00911 
00912     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == STATUS_REPARSE )  &amp;&amp;
00913         (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information &gt; IO_REPARSE_TAG_RESERVED_RANGE)) {
00914 
00915         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information == IO_REPARSE_TAG_MOUNT_POINT) {
00916 
00917             <span class="comment">//</span>
00918             <span class="comment">// For name junctions, we save the pointer to the auxiliary</span>
00919             <span class="comment">// buffer and use it below.</span>
00920             <span class="comment">//</span>
00921 
00922             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer != NULL );
00923 
00924             saveAuxiliaryPointer = (PVOID) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer;
00925 
00926             <span class="comment">//</span>
00927             <span class="comment">// We NULL the entry to avoid its de-allocation at this time.</span>
00928             <span class="comment">// This buffer get deallocated in IopDoNameTransmogrify</span>
00929             <span class="comment">//</span>
00930 
00931             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00932         } <span class="keywordflow">else</span> {
00933 
00934             <span class="comment">//</span>
00935             <span class="comment">// Fail the request. A driver needed to act on this IRP prior</span>
00936             <span class="comment">// to getting to this point.</span>
00937             <span class="comment">//</span>
00938 
00939             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_IO_REPARSE_TAG_NOT_HANDLED;
00940         }
00941     }
00942 
00943     <span class="comment">//</span>
00944     <span class="comment">// Check the auxiliary buffer pointer in the packet and if a buffer was</span>
00945     <span class="comment">// allocated, deallocate it now.  Note that this buffer must be freed</span>
00946     <span class="comment">// here since the pointer is overlayed with the APC that will be used</span>
00947     <span class="comment">// to get to the requesting thread's context.</span>
00948     <span class="comment">//</span>
00949 
00950     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer) {
00951         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer );
00952         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00953     }
00954 
00955     <span class="comment">//</span>
00956     <span class="comment">// Check to see if this is paging I/O or a close operation.  If either,</span>
00957     <span class="comment">// then special processing must be performed.  The reasons that special</span>
00958     <span class="comment">// processing must be performed is different based on the type of</span>
00959     <span class="comment">// operation being performed.  The biggest reasons for special processing</span>
00960     <span class="comment">// on paging operations are that using a special kernel APC for an in-</span>
00961     <span class="comment">// page operation cannot work since the special kernel APC can incur</span>
00962     <span class="comment">// another pagefault.  Likewise, all paging I/O uses MDLs that belong</span>
00963     <span class="comment">// to the memory manager, not the I/O system.</span>
00964     <span class="comment">//</span>
00965     <span class="comment">// Close operations are special because the close may have been invoked</span>
00966     <span class="comment">// because of a special kernel APC (some IRP was completed which caused</span>
00967     <span class="comment">// the reference count on the object to become zero while in the I/O</span>
00968     <span class="comment">// system's special kernel APC routine).  Therefore, a special kernel APC</span>
00969     <span class="comment">// cannot be used since it cannot execute until the close APC finishes.</span>
00970     <span class="comment">//</span>
00971     <span class="comment">// The special steps are as follows for a synchronous paging operation</span>
00972     <span class="comment">// and close are:</span>
00973     <span class="comment">//</span>
00974     <span class="comment">//     1.  Copy the I/O status block (it is in SVAS, nonpaged).</span>
00975     <span class="comment">//     2.  Signal the event</span>
00976     <span class="comment">//     3.  If paging I/O, deallocate the IRP</span>
00977     <span class="comment">//</span>
00978     <span class="comment">// The special steps taken for asynchronous paging operations (out-pages)</span>
00979     <span class="comment">// are as follows:</span>
00980     <span class="comment">//</span>
00981     <span class="comment">//     1.  Initialize a special kernel APC just for page writes.</span>
00982     <span class="comment">//     1.  Queue the special kernel APC.</span>
00983     <span class="comment">//</span>
00984     <span class="comment">// It should also be noted that the logic for completing a Mount request</span>
00985     <span class="comment">// operation is exactly the same as a Page Read.  No assumptions should be</span>
00986     <span class="comment">// made here about this being a Page Read operation w/o carefully checking</span>
00987     <span class="comment">// to ensure that they are also true for a Mount.  That is:</span>
00988     <span class="comment">//</span>
00989     <span class="comment">//     IRP_PAGING_IO  and  IRP_MOUNT_COMPLETION</span>
00990     <span class="comment">//</span>
00991     <span class="comment">// are the same flag in the IRP.</span>
00992     <span class="comment">//</span>
00993     <span class="comment">// Also note that the last time the IRP is touched for a close operation</span>
00994     <span class="comment">// must be just before the event is set to the signaled state.  Once this</span>
00995     <span class="comment">// occurs, the IRP can be deallocated by the thread waiting for the event.</span>
00996     <span class="comment">//</span>
00997 
00998     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; (<a class="code" href="../../d0/d5/io_8h.html#a174">IRP_PAGING_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a185">IRP_CLOSE_OPERATION</a>)) {
00999         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; (<a class="code" href="../../d0/d5/io_8h.html#a181">IRP_SYNCHRONOUS_PAGING_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a185">IRP_CLOSE_OPERATION</a>)) {
01000             ULONG flags;
01001 
01002             flags = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a181">IRP_SYNCHRONOUS_PAGING_IO</a>;
01003             *<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>;
01004             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a>, PriorityBoost, FALSE );
01005             <span class="keywordflow">if</span> (flags) {
01006                 <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( Irp );
01007             }
01008         } <span class="keywordflow">else</span> {
01009             thread = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread;
01010             <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
01011                              &amp;thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
01012                              <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o16">ApcEnvironment</a>,
01013                              IopCompletePageWrite,
01014                              (PKRUNDOWN_ROUTINE) NULL,
01015                              (PKNORMAL_ROUTINE) NULL,
01016                              KernelMode,
01017                              (PVOID) NULL );
01018             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
01019                                      (PVOID) NULL,
01020                                      (PVOID) NULL,
01021                                      PriorityBoost );
01022         }
01023         <span class="keywordflow">return</span>;
01024     }
01025 
01026     <span class="comment">//</span>
01027     <span class="comment">// Check to see whether any pages need to be unlocked.</span>
01028     <span class="comment">//</span>
01029 
01030     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01031 
01032         <span class="comment">//</span>
01033         <span class="comment">// Unlock any pages that may be described by MDLs.</span>
01034         <span class="comment">//</span>
01035 
01036         mdl = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>;
01037         <span class="keywordflow">while</span> (mdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01038             <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a>( mdl );
01039             mdl = mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a>;
01040         }
01041     }
01042 
01043     <span class="comment">//</span>
01044     <span class="comment">// Make a final check here to determine whether or not this is a</span>
01045     <span class="comment">// synchronous I/O operation that is being completed in the context</span>
01046     <span class="comment">// of the original requestor.  If so, then an optimal path through</span>
01047     <span class="comment">// I/O completion can be taken.</span>
01048     <span class="comment">//</span>
01049 
01050     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a186">IRP_DEFER_IO_COMPLETION</a> &amp;&amp; !<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a>) {
01051 
01052         <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == STATUS_REPARSE )  &amp;&amp;
01053             (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information == IO_REPARSE_TAG_MOUNT_POINT)) {
01054 
01055             <span class="comment">//</span>
01056             <span class="comment">// For name junctions we reinstate the address of the appropriate</span>
01057             <span class="comment">// buffer. It is freed in parse.c</span>
01058             <span class="comment">//</span>
01059 
01060             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer = saveAuxiliaryPointer;
01061         }
01062 
01063         <span class="keywordflow">return</span>;
01064     }
01065 
01066     <span class="comment">//</span>
01067     <span class="comment">// Finally, initialize the IRP as an APC structure and queue the special</span>
01068     <span class="comment">// kernel APC to the target thread.</span>
01069     <span class="comment">//</span>
01070 
01071     thread = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread;
01072     fileObject = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject;
01073 
01074     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
01075 
01076         <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
01077                          &amp;thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
01078                          <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o16">ApcEnvironment</a>,
01079                          IopCompleteRequest,
01080                          IopAbortRequest,
01081                          (PKNORMAL_ROUTINE) NULL,
01082                          KernelMode,
01083                          (PVOID) NULL );
01084 
01085         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
01086                                  fileObject,
01087                                  (PVOID) saveAuxiliaryPointer,
01088                                  PriorityBoost );
01089     } <span class="keywordflow">else</span> {
01090 
01091         <span class="comment">//</span>
01092         <span class="comment">// This request has been cancelled.  Ensure that access to the thread</span>
01093         <span class="comment">// is synchronized, otherwise it may go away while attempting to get</span>
01094         <span class="comment">// through the remainder of completion for this request.  This happens</span>
01095         <span class="comment">// when the thread times out waiting for the request to be completed</span>
01096         <span class="comment">// once it has been cancelled.</span>
01097         <span class="comment">//</span>
01098         <span class="comment">// Note that it is safe to capture the thread pointer above, w/o having</span>
01099         <span class="comment">// the lock because the cancel flag was not set at that point, and</span>
01100         <span class="comment">// the code that disassociates IRPs must set the flag before looking to</span>
01101         <span class="comment">// see whether or not the packet has been completed, and this packet</span>
01102         <span class="comment">// will appear to be completed because it no longer belongs to a driver.</span>
01103         <span class="comment">//</span>
01104 
01105         ExAcquireSpinLock( &amp;IopCompletionLock, &amp;irql );
01106 
01107         thread = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread;
01108 
01109         <span class="keywordflow">if</span> (thread) {
01110 
01111             <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
01112                              &amp;thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
01113                              <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o16">ApcEnvironment</a>,
01114                              IopCompleteRequest,
01115                              IopAbortRequest,
01116                              (PKNORMAL_ROUTINE) NULL,
01117                              KernelMode,
01118                              (PVOID) NULL );
01119 
01120             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
01121                                      fileObject,
01122                                      (PVOID) saveAuxiliaryPointer,
01123                                      PriorityBoost );
01124 
01125             ExReleaseSpinLock( &amp;IopCompletionLock, irql );
01126 
01127         } <span class="keywordflow">else</span> {
01128 
01129             <span class="comment">//</span>
01130             <span class="comment">// This request has been aborted from completing in the caller's</span>
01131             <span class="comment">// thread.  This can only occur if the packet was cancelled, and</span>
01132             <span class="comment">// the driver did not complete the request, so it was timed out.</span>
01133             <span class="comment">// Attempt to drop things on the floor, since the originating thread</span>
01134             <span class="comment">// has probably exited at this point.</span>
01135             <span class="comment">//</span>
01136 
01137             ExReleaseSpinLock( &amp;IopCompletionLock, irql );
01138 
01139             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a> );
01140 
01141             <span class="comment">//</span>
01142             <span class="comment">// Drop the IRP on the floor.</span>
01143             <span class="comment">//</span>
01144 
01145             <a class="code" href="../../d0/d6/iop_8h.html#a168">IopDropIrp</a>( Irp, fileObject );
01146 
01147         }
01148     }
01149 <span class="preprocessor">#else</span>
01150 <span class="preprocessor"></span>
01151     <a class="code" href="../../d4/d6/iosubs_8c.html#a40">IopfCompleteRequest</a>(Irp, PriorityBoost);
01152     <span class="keywordflow">return</span>;
01153 
01154 <span class="preprocessor">#endif</span>
01155 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="ioverifier.c::VerifierAllocatePoolWithQuotaTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> THUNKED_API PVOID VerifierAllocatePoolWithQuotaTag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/verifier_8c-source.html#l01059">1059</a> of file <a class="el" href="../../d0/d5/verifier_8c-source.html">verifier.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00265">ExAllocatePoolWithQuotaTag</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04111">_MI_VERIFIER_DRIVER_ENTRY::Flags</a>, <a class="el" href="../../d5/d8/ex_8h.html#a330a194">HighPoolPriority</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00987">KernelVerifier</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00060">POOL_DRIVER_MASK</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00143">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a58">VeAllocatePoolWithTagPriority()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04108">VI_VERIFYING_DIRECTLY</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l03396">ViLocateVerifierEntry()</a>.
<p>
<pre class="fragment"><div>01064 {
01065     PVOID Va;
01066     LOGICAL RaiseOnQuotaFailure;
01067     PVOID CallingAddress;
01068     PVOID CallersCaller;
01069     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
01070 
01071 <span class="preprocessor">#if defined (_X86_)</span>
01072 <span class="preprocessor"></span>    <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
01073 <span class="preprocessor">#else</span>
01074 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
01075 <span class="preprocessor">#endif</span>
01076 <span class="preprocessor"></span>
01077     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01078         Verifier = <a class="code" href="../../d9/d5/verifier_8c.html#a105">ViLocateVerifierEntry</a> (CallingAddress);
01079 
01080         <span class="keywordflow">if</span> ((Verifier == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01081             ((Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o6">Flags</a> &amp; <a class="code" href="../../d4/d8/mi_8h.html#a252">VI_VERIFYING_DIRECTLY</a>) == 0)) {
01082 
01083             <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a> (PoolType | POOL_DRIVER_MASK,
01084                                                NumberOfBytes,
01085                                                Tag);
01086         }
01087         PoolType |= <a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>;
01088     }
01089 
01090     <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d5/d8/ex_8h.html#a2">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>) {
01091         RaiseOnQuotaFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01092         PoolType &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a2">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>;
01093     }
01094     <span class="keywordflow">else</span> {
01095         RaiseOnQuotaFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01096     }
01097 
01098     Va = <a class="code" href="../../d9/d5/verifier_8c.html#a58">VeAllocatePoolWithTagPriority</a> (PoolType,
01099                                         NumberOfBytes,
01100                                         Tag,
01101                                         HighPoolPriority,
01102                                         CallingAddress);
01103 
01104     <span class="keywordflow">if</span> (Va == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01105         <span class="keywordflow">if</span> (RaiseOnQuotaFailure == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01106             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
01107         }
01108     }
01109 
01110     <span class="keywordflow">return</span> Va;
01111 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a16" doxytag="ioverifier.c::IopVerifierOn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d6/d6/ioverifier_8c.html#a16">IopVerifierOn</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00082">82</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02149">IoCancelIrp()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00248">IovCallDriver()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00297">IovCompleteRequest()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00206">IovFreeIrpPrivate()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01159">IovSpecialIrpCallDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="ioverifier.c::IoVerifierOnByDefault" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d6/d6/ioverifier_8c.html#a19">IoVerifierOnByDefault</a> = TRUE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00085">85</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="ioverifier.c::IovpEnforcementLevel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d6/ioverifier_8c.html#a17">IovpEnforcementLevel</a> = (ULONG) -1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00083">83</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="ioverifier.c::IovpInitCalled" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG <a class="el" href="../../d6/d6/ioverifier_8c.html#a20">IovpInitCalled</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00086">86</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d4/ioassert_8c-source.html#l00423">IopDriverCorrectnessTakeLock()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="ioverifier.c::IovpMaxSupportedVerifierLevel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d6/ioverifier_8c.html#a21">IovpMaxSupportedVerifierLevel</a> = 3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00087">87</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="ioverifier.c::IovpVerifierFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d6/ioverifier_8c.html#a22">IovpVerifierFlags</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00088">88</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00353">IovAllocateIrp()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="ioverifier.c::IovpVerifierLevel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d6/ioverifier_8c.html#a18">IovpVerifierLevel</a> = (ULONG)0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00084">84</a> of file <a class="el" href="../../d7/d5/ioverifier_8c-source.html">ioverifier.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:23 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
