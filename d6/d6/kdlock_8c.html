<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kdlock.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdlock.c File Reference</h1><code>#include "<a class="el" href="../../d1/d6/kdp_8h-source.html">kdp.h</a>"</code><br>

<p>
<a href="../../d7/d5/kdlock_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/kdlock_8c.html#a0">KdpPortLock</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/kdlock_8c.html#a1">KdpPortUnlock</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/kdlock_8c.html#a2">KdPollBreakIn</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/kdlock_8c.html#a3">KdpPollBreakInWithPortLock</a> (VOID)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="kdlock.c::KdPollBreakIn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdPollBreakIn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/kdlock_8c-source.html#l00093">93</a> of file <a class="el" href="../../d7/d5/kdlock_8c-source.html">kdlock.c</a>.
<p>
References <a class="el" href="../../d8/d2/kd_8h-source.html#l00030">CP_GET_SUCCESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00091">HIGH_LEVEL</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00134">KdDebuggerEnabled</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00260">KdpControlCPending</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00261">KdpControlCPressed</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00056">KdpDebuggerLock</a>, <a class="el" href="../../d2/d7/hal_8h.html#a201">KdPortPollByte()</a>, <a class="el" href="../../d7/d5/kdlock_8c-source.html#l00060">KdpPortUnlock()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a107">KiRestoreInterrupts()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a155">KiTryToAcquireSpinLock()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00099                    :
00100 
00101     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> raises IRQL to high_level, seizes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d5/editreg_8c.html#a51">Debug</a> port
00102     spinlock, and checks to see <span class="keywordflow">if</span> a breakin packet <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> pending.
00103     If a packet <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present, <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <span class="keywordflow">else</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00104 
00105     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> packet <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present <span class="keywordflow">if</span>:
00106 
00107     There <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a valid character which matches BREAK_CHAR.
00108 
00109     N.B.    Interrupts must be OFF around <span class="keyword">this</span> call
00110 
00111 Return Value:
00112 
00113     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> breakin sequence present, caller should execute <span class="keywordtype">int</span>-3.
00114     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> no breakin seen.
00115 
00116 --*/
00117 
00118 {
00119     BOOLEAN BreakIn;
00120     BOOLEAN Enable;
00121     UCHAR   Input;
00122     KIRQL   OldIrql;
00123     ULONG   <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00124 
00125     <span class="comment">//</span>
00126     <span class="comment">// If the debugger is enabled, see if a breakin by the kernel</span>
00127     <span class="comment">// debugger is pending.</span>
00128     <span class="comment">//</span>
00129 
00130     BreakIn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00131     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00132         Enable = <a class="code" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts</a>();
00133 <span class="preprocessor">#ifndef _X86_</span>
00134 <span class="preprocessor"></span>        <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(HIGH_LEVEL, &amp;OldIrql);
00135 <span class="preprocessor">#endif</span>
00136 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00137             <a class="code" href="../../d8/d5/kddata_8c.html#a90">KdpControlCPressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00138             BreakIn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00139             <a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00140 
00141         } <span class="keywordflow">else</span> {
00142             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/ki_8h.html#a155">KiTryToAcquireSpinLock</a>(&amp;KdpDebuggerLock) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00143                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/hal_8h.html#a201">KdPortPollByte</a>(&amp;Input);
00144                 <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a>) &amp;&amp;
00145                     (Input == BREAKIN_PACKET_BYTE)) {
00146                     BreakIn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00147                     <a class="code" href="../../d8/d5/kddata_8c.html#a90">KdpControlCPressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00148                 }
00149 
00150                 <a class="code" href="../../d1/d7/4_2kdp_8h.html#a146">KdpPortUnlock</a>();
00151             }
00152         }
00153 
00154 <span class="preprocessor">#ifndef _X86_</span>
00155 <span class="preprocessor"></span>        <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00156 <span class="preprocessor">#endif</span>
00157 <span class="preprocessor"></span>        <a class="code" href="../../d0/d0/ki_8h.html#a107">KiRestoreInterrupts</a>(Enable);
00158     }
00159 
00160     <span class="keywordflow">return</span> BreakIn;
00161 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="kdlock.c::KdpPollBreakInWithPortLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdpPollBreakInWithPortLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/kdlock_8c-source.html#l00165">165</a> of file <a class="el" href="../../d7/d5/kdlock_8c-source.html">kdlock.c</a>.
<p>
<pre class="fragment"><div>00171                    :
00172 
00173     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> same as <a class="code" href="../../d7/d3/kd_8h.html#a19">KdPollBreakIn</a>, but assumes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00174     already holds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> port lock.  Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> a breakin packet
00175     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> pending.
00176 
00177     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> packet <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present <span class="keywordflow">if</span>:
00178 
00179     There <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a valid character which matches BREAK_CHAR.
00180 
00181     N.B.    Interrupts must be OFF around <span class="keyword">this</span> call
00182 
00183 Return Value:
00184 
00185     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> breakin sequence present, caller should execute <span class="keywordtype">int</span>-3.
00186     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> no breakin seen.
00187 
00188 --*/
00189 
00190 {
00191 
00192     BOOLEAN BreakIn;
00193     BOOLEAN Enable;
00194     UCHAR Input;
00195     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00196 
00197     <span class="comment">//</span>
00198     <span class="comment">// If the debugger is enabled, see if a breakin by the kernel</span>
00199     <span class="comment">// debugger is pending.</span>
00200     <span class="comment">//</span>
00201 
00202     BreakIn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00203     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00204         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00205             BreakIn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00206             <a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00207 
00208         } <span class="keywordflow">else</span> {
00209             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/hal_8h.html#a201">KdPortPollByte</a>(&amp;Input);
00210             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a>) &amp;&amp;
00211                 (Input == BREAKIN_PACKET_BYTE)) {
00212                 BreakIn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00213             }
00214         }
00215     }
00216 
00217     <span class="keywordflow">return</span> BreakIn;
00218 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="kdlock.c::KdpPortLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpPortLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/kdlock_8c-source.html#l00026">26</a> of file <a class="el" href="../../d7/d5/kdlock_8c-source.html">kdlock.c</a>.
<p>
<pre class="fragment"><div>00032                    :
00033 
00034     Acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> spinlock <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debug port.
00035 
00036     Note that user must call <span class="keyword">this</span> explicitly, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> get/put <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>
00037     <span class="keywordflow">do</span> NOT make any use of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock.
00038 
00039     CALLER MUST HAVE <a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a> PROPER IRQL BEFORE CALLING US.
00040 
00041     We use KiAcquireSpinLock and NOT Ke... because our IRQL may
00042     be above <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>.
00043 
00044 Arguments:
00045 
00046     None.
00047 
00048 Return value:
00049 
00050     None.
00051 
00052 --*/
00053 
00054 {
00055     KiAcquireSpinLock(&amp;KdpDebuggerLock);
00056 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="kdlock.c::KdpPortUnlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpPortUnlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/kdlock_8c-source.html#l00060">60</a> of file <a class="el" href="../../d7/d5/kdlock_8c-source.html">kdlock.c</a>.
<p>
<pre class="fragment"><div>00066                    :
00067 
00068     Release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> spinlock <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debug port.
00069 
00070     Note that user must call <span class="keyword">this</span> explicitly, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> get/put <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>
00071     <span class="keywordflow">do</span> NOT make any use of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock.
00072 
00073     CALLER MUST HAVE <a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a> PROPER IRQL BEFORE CALLING US.
00074 
00075     We use KiReleaseSpinLock and NOT Ke... because our IRQL may
00076     be above <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>.
00077 
00078 Arguments:
00079 
00080     None.
00081 
00082 Return value:
00083 
00084     None.
00085 
00086 --*/
00087 
00088 {
00089     KiReleaseSpinLock(&amp;KdpDebuggerLock);
00090 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
