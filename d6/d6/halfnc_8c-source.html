<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: halfnc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>halfnc.c</h1><a href="../../d5/d7/halfnc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    hanfnc.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    default handlers for hal functions which don't get handlers</span>
00012 <span class="comment">    installed by the hal</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Ken Reneris (kenr) 19-July-1994</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>"</span>
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d7/haldisp_8h.html">haldisp.h</a>"</span>
00024 
<a name="l00025"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a0">00025</a> <a class="code" href="../../d5/d0/structHAL__DISPATCH.html">HAL_DISPATCH</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a0">HalDispatchTable</a> = {
00026     <a class="code" href="../../d2/d7/hal_8h.html#a18">HAL_DISPATCH_VERSION</a>,
00027     <a class="code" href="../../d4/d7/haldisp_8h.html#a3">xHalQuerySystemInformation</a>,
00028     <a class="code" href="../../d4/d7/haldisp_8h.html#a4">xHalSetSystemInformation</a>,
00029     <a class="code" href="../../d4/d7/haldisp_8h.html#a5">xHalQueryBusSlots</a>,
00030     0,
00031     <a class="code" href="../../d7/d2/drivesup_8c.html#a29">xHalExamineMBR</a>,
00032     <a class="code" href="../../d7/d2/drivesup_8c.html#a30">xHalIoAssignDriveLetters</a>,
00033     <a class="code" href="../../d7/d2/drivesup_8c.html#a31">xHalIoReadPartitionTable</a>,
00034     <a class="code" href="../../d7/d2/drivesup_8c.html#a32">xHalIoSetPartitionInformation</a>,
00035     <a class="code" href="../../d7/d2/drivesup_8c.html#a33">xHalIoWritePartitionTable</a>,
00036     <a class="code" href="../../d4/d7/haldisp_8h.html#a10">xHalHandlerForBus</a>,                  <span class="comment">// HalReferenceHandlerByBus</span>
00037     <a class="code" href="../../d4/d7/haldisp_8h.html#a16">xHalReferenceHandler</a>,               <span class="comment">// HalReferenceBusHandler</span>
00038     <a class="code" href="../../d4/d7/haldisp_8h.html#a16">xHalReferenceHandler</a>,               <span class="comment">// HalDereferenceBusHandler</span>
00039     <a class="code" href="../../d4/d7/haldisp_8h.html#a17">xHalInitPnpDriver</a>,
00040     <a class="code" href="../../d4/d7/haldisp_8h.html#a18">xHalInitPowerManagement</a>,
00041     0,
00042     <a class="code" href="../../d4/d7/haldisp_8h.html#a33">xHalGetInterruptTranslator</a>
00043     };
00044 
00045 
<a name="l00046"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a1">00046</a> <a class="code" href="../../d6/d0/structHAL__PRIVATE__DISPATCH.html">HAL_PRIVATE_DISPATCH</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a1">HalPrivateDispatchTable</a> = {
00047     <a class="code" href="../../d2/d7/hal_8h.html#a36">HAL_PRIVATE_DISPATCH_VERSION</a>,
00048     <a class="code" href="../../d4/d7/haldisp_8h.html#a10">xHalHandlerForBus</a>,
00049     <a class="code" href="../../d4/d7/haldisp_8h.html#a10">xHalHandlerForBus</a>,
00050     <a class="code" href="../../d4/d7/haldisp_8h.html#a8">xHalLocateHiberRanges</a>,
00051     <a class="code" href="../../d4/d7/haldisp_8h.html#a9">xHalRegisterBusHandler</a>,
00052     <a class="code" href="../../d4/d7/haldisp_8h.html#a6">xHalSetWakeEnable</a>,
00053     <a class="code" href="../../d4/d7/haldisp_8h.html#a7">xHalSetWakeAlarm</a>,
00054     <a class="code" href="../../d4/d7/haldisp_8h.html#a34">xHalTranslateBusAddress</a>,
00055     <a class="code" href="../../d4/d7/haldisp_8h.html#a35">xHalAssignSlotResources</a>,
00056     <a class="code" href="../../d4/d7/haldisp_8h.html#a36">xHalHaltSystem</a>,
00057     (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>),                             <span class="comment">// HalFindBusAddressTranslation</span>
00058     (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)                              <span class="comment">// HalResetDisplay</span>
00059     };
00060 
00061 <span class="preprocessor">#if 0</span>
00062 <span class="preprocessor"></span><a class="code" href="../../d8/d7/struct__DMA__OPERATIONS.html">DMA_OPERATIONS</a> HalPrivateDmaOperations = {
00063     <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__DMA__OPERATIONS.html">DMA_OPERATIONS</a>),
00064     <a class="code" href="../../d4/d7/haldisp_8h.html#a20">xHalPutDmaAdapter</a>,
00065     <a class="code" href="../../d4/d7/haldisp_8h.html#a21">xHalAllocateCommonBuffer</a>,
00066     <a class="code" href="../../d4/d7/haldisp_8h.html#a22">xHalFreeCommonBuffer</a>,
00067     <a class="code" href="../../d4/d7/haldisp_8h.html#a23">xHalAllocateAdapterChannel</a>,
00068     <a class="code" href="../../d4/d7/haldisp_8h.html#a24">xHalFlushAdapterBuffers</a>,
00069     <a class="code" href="../../d4/d7/haldisp_8h.html#a25">xHalFreeAdapterChannel</a>,
00070     <a class="code" href="../../d4/d7/haldisp_8h.html#a26">xHalFreeMapRegisters</a>,
00071     <a class="code" href="../../d4/d7/haldisp_8h.html#a27">xHalMapTransfer</a>,
00072     <a class="code" href="../../d4/d7/haldisp_8h.html#a28">xHalGetDmaAlignment</a>,
00073     <a class="code" href="../../d4/d7/haldisp_8h.html#a29">xHalReadDmaCounter</a>,
00074     <a class="code" href="../../d4/d7/haldisp_8h.html#a30">xHalGetScatterGatherList</a>,
00075     <a class="code" href="../../d4/d7/haldisp_8h.html#a31">xHalPutScatterGatherList</a>
00076     };
00077 <span class="preprocessor">#endif</span>
00078 <span class="preprocessor"></span>
00079 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,   xHalLocateHiberRanges)</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,   xHalQuerySystemInformation)</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,   xHalSetSystemInformation)</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,   xHalQueryBusSlots)</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,   xHalRegisterBusHandler)</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, xHalSetWakeEnable)</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, xHalSetWakeAlarm)</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00088 <span class="preprocessor"></span>
00089 
00090 <span class="comment">//</span>
00091 <span class="comment">// Global dispatch table for HAL apis</span>
00092 <span class="comment">//</span>
00093 
00094 
00095 <span class="comment">//</span>
00096 <span class="comment">// Stub handlers for hals which don't provide the above functions</span>
00097 <span class="comment">//</span>
00098 
00099 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00100"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a2">00100</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a2">xHalQuerySystemInformation</a>(
00101     IN HAL_QUERY_INFORMATION_CLASS InformationClass,
00102     IN ULONG     BufferSize,
00103     OUT PVOID    Buffer,
00104     OUT PULONG   ReturnedLength
00105     )
00106 {
00107     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
00108     <span class="keywordflow">return</span> STATUS_INVALID_LEVEL;
00109 }
00110 
00111 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00112"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a3">00112</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a3">xHalSetSystemInformation</a>(
00113     IN HAL_SET_INFORMATION_CLASS InformationClass,
00114     IN ULONG     BufferSize,
00115     OUT PVOID    Buffer
00116     )
00117 {
00118     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
00119     <span class="keywordflow">return</span> STATUS_INVALID_LEVEL;
00120 }
00121 
00122 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00123"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a4">00123</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a4">xHalQueryBusSlots</a>(
00124     IN <a class="code" href="../../d6/d5/struct__BUS__HANDLER.html">PBUS_HANDLER</a>         BusHandler,
00125     IN ULONG                BufferSize,
00126     OUT PULONG              SlotNumbers,
00127     OUT PULONG              ReturnedLength
00128     )
00129 {
00130     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
00131     <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00132 }
00133 
00134 
00135 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00136"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a5">00136</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a5">xHalRegisterBusHandler</a>(
00137     IN INTERFACE_TYPE          InterfaceType,
00138     IN BUS_DATA_TYPE           ConfigurationSpace,
00139     IN ULONG                   BusNumber,
00140     IN INTERFACE_TYPE          ParentBusType,
00141     IN ULONG                   ParentBusNumber,
00142     IN ULONG                   SizeofBusExtensionData,
00143     IN PINSTALL_BUS_HANDLER    InstallBusHandler,
00144     OUT <a class="code" href="../../d6/d5/struct__BUS__HANDLER.html">PBUS_HANDLER</a>           *BusHandler
00145     )
00146 {
00147     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
00148     <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00149 }
00150 
00151 
00152 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00153"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a6">00153</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a6">xHalSetWakeEnable</a>(
00154     IN BOOLEAN              Enable
00155     )
00156 {
00157 }
00158 
00159 
00160 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00161"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a7">00161</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a7">xHalSetWakeAlarm</a>(
00162     IN ULONGLONG        WakeTime,
00163     IN PTIME_FIELDS     WakeTimeFields
00164     )
00165 {
00166 }
00167 
00168 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00169"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a8">00169</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a8">xHalLocateHiberRanges</a> (
00170     IN PVOID MemoryMap
00171     )
00172 {
00173 }
00174 
00175 <a class="code" href="../../d6/d5/struct__BUS__HANDLER.html">PBUS_HANDLER</a>
00176 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00177"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a9">00177</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a9">xHalHandlerForBus</a> (
00178     IN INTERFACE_TYPE InterfaceType,
00179     IN ULONG          BusNumber
00180     )
00181 {
00182     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00183 }
00184 
00185 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00186 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00187"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a10">00187</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a10">xHalReferenceHandler</a> (
00188     IN <a class="code" href="../../d6/d5/struct__BUS__HANDLER.html">PBUS_HANDLER</a>     Handler
00189     )
00190 {
00191 }
00192 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00193"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a11">00193</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a11">xHalInitPnpDriver</a>(
00194     VOID
00195     )
00196 {
00197     <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00198 }
00199 
00200 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00201"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a12">00201</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a12">xHalInitPowerManagement</a>(
00202     IN <a class="code" href="../../d0/d6/struct__PM__DISPATCH__TABLE.html">PPM_DISPATCH_TABLE</a>  PmDriverDispatchTable,
00203     IN OUT <a class="code" href="../../d0/d6/struct__PM__DISPATCH__TABLE.html">PPM_DISPATCH_TABLE</a> *PmHalDispatchTable
00204     )
00205 {
00206     <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00207 }
00208 
00209 <span class="preprocessor">#if 0</span>
00210 <span class="preprocessor"></span><a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a>
00211 <a class="code" href="../../d4/d7/haldisp_8h.html#a19">xHalGetDmaAdapter</a> (
00212     IN PVOID Context,
00213     IN <span class="keyword">struct</span> <a class="code" href="../../d7/d3/struct__DEVICE__DESCRIPTION.html">_DEVICE_DESCRIPTION</a> *DeviceDescriptor,
00214     OUT PULONG NumberOfMapRegisters
00215     )
00216 {
00217     <a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html">PADAPTER_OBJECT</a> AdapterObject;
00218 
00219     AdapterObject = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool,
00220                                            <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html">ADAPTER_OBJECT</a> ),
00221                                            ' laH');
00222 
00223     <span class="keywordflow">if</span> (AdapterObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00224         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00225     }
00226 
00227     AdapterObject-&gt;<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html#o0">DmaAdapter</a>.<a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html#o1">Size</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html">ADAPTER_OBJECT</a> );
00228     AdapterObject-&gt;<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html#o0">DmaAdapter</a>.<a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html#o0">Version</a> = 1;
00229     AdapterObject-&gt;<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html#o0">DmaAdapter</a>.<a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html#o2">DmaOperations</a> = &amp;HalPrivateDmaOperations;
00230     AdapterObject-&gt;<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html#o1">RealAdapterObject</a> = <a class="code" href="../../d2/d7/hal_8h.html#a188">HalGetAdapter</a>( DeviceDescriptor,
00231                                                       NumberOfMapRegisters );
00232 
00233     <span class="keywordflow">if</span> (AdapterObject-&gt;<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html#o1">RealAdapterObject</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00234 
00235         <span class="comment">//</span>
00236         <span class="comment">// No adapter object was returned.  Just return NULL to the caller.</span>
00237         <span class="comment">//</span>
00238 
00239         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AdapterObject );
00240         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00241     }
00242 
00243     <span class="keywordflow">return</span> &amp;AdapterObject-&gt;<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html#o0">DmaAdapter</a>;
00244 }
00245 
00246 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00247 <a class="code" href="../../d4/d7/haldisp_8h.html#a20">xHalPutDmaAdapter</a> (
00248     <a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a> DmaAdapter
00249     )
00250 {
00251     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DmaAdapter );
00252 }
00253 
00254 PVOID
00255 <a class="code" href="../../d4/d7/haldisp_8h.html#a21">xHalAllocateCommonBuffer</a> (
00256     IN <a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a> DmaAdapter,
00257     IN ULONG Length,
00258     OUT PPHYSICAL_ADDRESS LogicalAddress,
00259     IN BOOLEAN CacheEnabled
00260     )
00261 {
00262     <span class="keywordflow">return</span> <a class="code" href="../../d2/d7/hal_8h.html#a227">HalAllocateCommonBuffer</a>( ((<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html">PADAPTER_OBJECT</a>) DmaAdapter)-&gt;RealAdapterObject,
00263                                     Length,
00264                                     LogicalAddress,
00265                                     CacheEnabled );
00266 
00267 }
00268 
00269 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00270 <a class="code" href="../../d4/d7/haldisp_8h.html#a22">xHalFreeCommonBuffer</a> (
00271     IN <a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a> DmaAdapter,
00272     IN ULONG Length,
00273     IN PHYSICAL_ADDRESS LogicalAddress,
00274     IN PVOID VirtualAddress,
00275     IN BOOLEAN CacheEnabled
00276     )
00277 {
00278     <a class="code" href="../../d2/d7/hal_8h.html#a228">HalFreeCommonBuffer</a>( ((<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html">PADAPTER_OBJECT</a>) DmaAdapter)-&gt;RealAdapterObject,
00279                          Length,
00280                          LogicalAddress,
00281                          VirtualAddress,
00282                          CacheEnabled );
00283 
00284 }
00285 
00286 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00287 <a class="code" href="../../d4/d7/haldisp_8h.html#a23">xHalAllocateAdapterChannel</a> (
00288     IN <a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a> DmaAdapter,
00289     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00290     IN ULONG NumberOfMapRegisters,
00291     IN PDRIVER_CONTROL ExecutionRoutine,
00292     IN PVOID Context
00293     )
00294 {
00295     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/iosubs_8c.html#a11">IoAllocateAdapterChannel</a>( ((<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html">PADAPTER_OBJECT</a>) DmaAdapter)-&gt;RealAdapterObject,
00296                                      DeviceObject,
00297                                      NumberOfMapRegisters,
00298                                      ExecutionRoutine,
00299                                      Context );
00300 
00301 }
00302 
00303 BOOLEAN
00304 <a class="code" href="../../d4/d7/haldisp_8h.html#a24">xHalFlushAdapterBuffers</a> (
00305     IN <a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a> DmaAdapter,
00306     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
00307     IN PVOID MapRegisterBase,
00308     IN PVOID CurrentVa,
00309     IN ULONG Length,
00310     IN BOOLEAN WriteToDevice
00311     )
00312 {
00313     <span class="keywordflow">return</span> <a class="code" href="../../d2/d7/hal_8h.html#a230">IoFlushAdapterBuffers</a>( ((<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html">PADAPTER_OBJECT</a>) DmaAdapter)-&gt;RealAdapterObject,
00314                                   Mdl,
00315                                   MapRegisterBase,
00316                                   CurrentVa,
00317                                   Length,
00318                                   WriteToDevice );
00319 
00320 }
00321 
00322 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00323 <a class="code" href="../../d4/d7/haldisp_8h.html#a25">xHalFreeAdapterChannel</a> (
00324     IN <a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a> DmaAdapter
00325     )
00326 {
00327     <a class="code" href="../../d2/d7/hal_8h.html#a231">IoFreeAdapterChannel</a>( ((<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html">PADAPTER_OBJECT</a>) DmaAdapter)-&gt;RealAdapterObject );
00328 }
00329 
00330 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00331 <a class="code" href="../../d4/d7/haldisp_8h.html#a26">xHalFreeMapRegisters</a> (
00332     IN <a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a> DmaAdapter,
00333     PVOID MapRegisterBase,
00334     ULONG NumberOfMapRegisters
00335     )
00336 
00337 {
00338     <a class="code" href="../../d2/d7/hal_8h.html#a232">IoFreeMapRegisters</a>( ((<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html">PADAPTER_OBJECT</a>) DmaAdapter)-&gt;RealAdapterObject,
00339                         MapRegisterBase,
00340                         NumberOfMapRegisters );
00341 }
00342 
00343 PHYSICAL_ADDRESS
00344 <a class="code" href="../../d4/d7/haldisp_8h.html#a27">xHalMapTransfer</a> (
00345     IN <a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a> DmaAdapter,
00346     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
00347     IN PVOID MapRegisterBase,
00348     IN PVOID CurrentVa,
00349     IN OUT PULONG Length,
00350     IN BOOLEAN WriteToDevice
00351     )
00352 {
00353     <span class="keywordflow">return</span> <a class="code" href="../../d2/d7/hal_8h.html#a233">IoMapTransfer</a>( ((<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html">PADAPTER_OBJECT</a>) DmaAdapter)-&gt;RealAdapterObject,
00354                            Mdl,
00355                            MapRegisterBase,
00356                            CurrentVa,
00357                            Length,
00358                            WriteToDevice );
00359 }
00360 
00361 ULONG
00362 <a class="code" href="../../d4/d7/haldisp_8h.html#a28">xHalGetDmaAlignment</a> (
00363     IN <a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a> DmaAdapter
00364     )
00365 {
00366     <span class="keywordflow">return</span> HalGetDmaAlignmentRequirement();
00367 }
00368 
00369 ULONG
00370 <a class="code" href="../../d4/d7/haldisp_8h.html#a29">xHalReadDmaCounter</a> (
00371     IN <a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a> DmaAdapter
00372     )
00373 {
00374     <span class="keywordflow">return</span> <a class="code" href="../../d2/d7/hal_8h.html#a229">HalReadDmaCounter</a>( ((<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html">PADAPTER_OBJECT</a>) DmaAdapter)-&gt;RealAdapterObject );
00375 }
00376 
00377 
00378 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00379 <a class="code" href="../../d4/d7/haldisp_8h.html#a30">xHalGetScatterGatherList</a> (
00380     IN <a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a> DmaAdapter,
00381     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00382     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
00383     IN PVOID CurrentVa,
00384     IN ULONG Length,
00385     IN PDRIVER_LIST_CONTROL ExecutionRoutine,
00386     IN PVOID Context,
00387     IN BOOLEAN WriteToDevice
00388     )
00389 <span class="comment">/*++</span>
00390 <span class="comment"></span>
00391 <span class="comment">Routine Description:</span>
00392 <span class="comment"></span>
00393 <span class="comment">    This routine allocates the adapter channel specified by the adapter</span>
00394 <span class="comment">    object.  Next a scatter/gather list is built based on the MDL, the</span>
00395 <span class="comment">    CurrentVa and the requested Length.  Finally the driver?s execution</span>
00396 <span class="comment">    function is called with the scatter/gather list.  The adapter is</span>
00397 <span class="comment">    released when after the execution function returns.</span>
00398 <span class="comment"></span>
00399 <span class="comment">    The scatter/gather list is freed by calling PutScatterGatherList.</span>
00400 <span class="comment"></span>
00401 <span class="comment">Arguments:</span>
00402 <span class="comment"></span>
00403 <span class="comment">    DmaAdapter - Pointer to the adapter control object to allocate to the</span>
00404 <span class="comment">        driver.</span>
00405 <span class="comment"></span>
00406 <span class="comment">    DeviceObject - Pointer to the device object that is allocating the</span>
00407 <span class="comment">        adapter.</span>
00408 <span class="comment"></span>
00409 <span class="comment">    Mdl - Pointer to the MDL that describes the pages of memory that are being</span>
00410 <span class="comment">        read or written.</span>
00411 <span class="comment"></span>
00412 <span class="comment">    CurrentVa - Current virtual address in the buffer described by the MDL</span>
00413 <span class="comment">        that the transfer is being done to or from.</span>
00414 <span class="comment"></span>
00415 <span class="comment">    Length - Supplies the length of the transfer.</span>
00416 <span class="comment"></span>
00417 <span class="comment">    ExecutionRoutine - The address of the driver's execution routine that is</span>
00418 <span class="comment">        invoked once the adapter channel (and possibly map registers) have been</span>
00419 <span class="comment">        allocated.</span>
00420 <span class="comment"></span>
00421 <span class="comment">    Context - An untyped longword context parameter passed to the driver's</span>
00422 <span class="comment">        execution routine.</span>
00423 <span class="comment"></span>
00424 <span class="comment">    WriteToDevice - Supplies the value that indicates whether this is a</span>
00425 <span class="comment">        write to the device from memory (TRUE), or vice versa.</span>
00426 <span class="comment"></span>
00427 <span class="comment">Return Value:</span>
00428 <span class="comment"></span>
00429 <span class="comment">    Returns STATUS_SUCESS unless too many map registers are requested or</span>
00430 <span class="comment">    memory for the scatter/gather list could not be allocated.</span>
00431 <span class="comment"></span>
00432 <span class="comment">Notes:</span>
00433 <span class="comment"></span>
00434 <span class="comment">    Note that this routine MUST be invoked at DISPATCH_LEVEL or above.</span>
00435 <span class="comment"></span>
00436 <span class="comment">    The data in the buffer cannot be accessed until the put scatter/gather function has been called.</span>
00437 <span class="comment"></span>
00438 <span class="comment">--*/</span>
00439 
00440 {
00441     <a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html">PXHAL_WAIT_CONTEXT_BLOCK</a> WaitBlock;
00442     <a class="code" href="../../d8/d7/struct__WAIT__CONTEXT__BLOCK.html">PWAIT_CONTEXT_BLOCK</a> Wcb;
00443     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> TempMdl;
00444     ULONG NumberOfMapRegisters;
00445     ULONG ContextSize;
00446     ULONG TransferLength;
00447     ULONG MdlLength;
00448     ULONG MdlCount;
00449     PUCHAR MdlVa;
00450     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00451 
00452     MdlVa = <a class="code" href="../../d2/d1/mm_8h.html#a12">MmGetMdlVirtualAddress</a>(Mdl);
00453 
00454     <span class="comment">//</span>
00455     <span class="comment">// Calculate the number of required map registers.</span>
00456     <span class="comment">//</span>
00457 
00458     TempMdl = Mdl;
00459     TransferLength = TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> - (ULONG)((PUCHAR) CurrentVa - MdlVa);
00460     MdlLength = TransferLength;
00461 
00462     MdlVa = (PUCHAR) <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(CurrentVa);
00463     NumberOfMapRegisters = 0;
00464     MdlCount = 1;
00465 
00466     <span class="comment">//</span>
00467     <span class="comment">// Loop through the any chained MDLs accumulating the the required</span>
00468     <span class="comment">// number of map registers.</span>
00469     <span class="comment">//</span>
00470 
00471     <span class="keywordflow">while</span> (TransferLength &lt; Length &amp;&amp; TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00472 
00473         NumberOfMapRegisters += (ULONG)(((ULONG_PTR) MdlVa + MdlLength + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &gt;&gt;
00474                                     <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00475 
00476         TempMdl = TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a>;
00477         MdlVa = (PUCHAR) TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o7">ByteOffset</a>;
00478         MdlLength = TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>;
00479         TransferLength += MdlLength;
00480         MdlCount++;
00481     }
00482 
00483     <span class="keywordflow">if</span> (TransferLength + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> &lt; (ULONG_PTR)(Length + MdlVa) ) {
00484         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(TransferLength &gt;= Length);
00485         <span class="keywordflow">return</span>(STATUS_BUFFER_TOO_SMALL);
00486     }
00487 
00488     <span class="comment">//</span>
00489     <span class="comment">// Calculate the last number of map registers base on the requested</span>
00490     <span class="comment">// length not the length of the last MDL.</span>
00491     <span class="comment">//</span>
00492 
00493     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( TransferLength &lt;= MdlLength + Length );
00494 
00495     NumberOfMapRegisters += (ULONG)(((ULONG_PTR) MdlVa + Length + MdlLength - TransferLength +
00496                              <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00497 
00498     <span class="comment">//</span>
00499     <span class="comment">// Calculate how much memory is required for context structure.  This</span>
00500     <span class="comment">// this actually layed out as follows:</span>
00501     <span class="comment">//</span>
00502     <span class="comment">//   XHAL_WAIT_CONTEXT_BLOCK;</span>
00503     <span class="comment">//   MapRegisterBase[ MdlCount ];</span>
00504     <span class="comment">//   union {</span>
00505     <span class="comment">//      WAIT_CONTEXT_BLOCK[ MdlCount ];</span>
00506     <span class="comment">//      SCATTER_GATER_LIST [ NumberOfMapRegisters ];</span>
00507     <span class="comment">//   };</span>
00508     <span class="comment">//</span>
00509 
00510     ContextSize = NumberOfMapRegisters * <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d8/struct__SCATTER__GATHER__ELEMENT.html">SCATTER_GATHER_ELEMENT</a> ) +
00511                   <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d8/struct__SCATTER__GATHER__LIST.html">SCATTER_GATHER_LIST</a> );
00512 
00513     <span class="comment">//</span>
00514     <span class="comment">// For each Mdl a separate Wcb is required since a separate map</span>
00515     <span class="comment">// registers base must be allocated.</span>
00516     <span class="comment">//</span>
00517 
00518     <span class="keywordflow">if</span> (ContextSize &lt; <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d7/struct__WAIT__CONTEXT__BLOCK.html">WAIT_CONTEXT_BLOCK</a> ) * MdlCount) {
00519 
00520         ContextSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d7/struct__WAIT__CONTEXT__BLOCK.html">WAIT_CONTEXT_BLOCK</a> ) * MdlCount;
00521     }
00522 
00523     ContextSize += <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html">XHAL_WAIT_CONTEXT_BLOCK</a> ) +
00524                     MdlCount * <span class="keyword">sizeof</span>( PVOID );
00525     WaitBlock = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, ContextSize, ' laH' );
00526 
00527     <span class="keywordflow">if</span> (WaitBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00528         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00529     }
00530 
00531     <span class="comment">//</span>
00532     <span class="comment">// Store the wait context block at the end of our block.</span>
00533     <span class="comment">// All of the information in wait block can be over written</span>
00534     <span class="comment">// by the scatter/gather list.</span>
00535     <span class="comment">//</span>
00536 
00537     Wcb = (<a class="code" href="../../d8/d7/struct__WAIT__CONTEXT__BLOCK.html">PWAIT_CONTEXT_BLOCK</a>) ((PVOID *) (WaitBlock + 1) + MdlCount);
00538 
00539     <span class="comment">//</span>
00540     <span class="comment">// Save the interesting data in the wait block.</span>
00541     <span class="comment">//</span>
00542 
00543     WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o0">Mdl</a> = Mdl;
00544     WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o1">CurrentVa</a> = CurrentVa;
00545     WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o2">Length</a> = Length;
00546     WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o3">RealAdapterObject</a> = ((<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html">PADAPTER_OBJECT</a>) DmaAdapter)-&gt;<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html#o1">RealAdapterObject</a>;
00547     WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o4">DriverExecutionRoutine</a> = ExecutionRoutine;
00548     WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o5">DriverContext</a> = Context;
00549     WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o6">CurrentIrp</a> = DeviceObject-&gt;CurrentIrp;
00550     WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o7">MapRegisterLock</a> = MdlCount;
00551     WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o8">WriteToDevice</a> = WriteToDevice;
00552     WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o9">MdlCount</a> = (UCHAR) MdlCount;
00553 
00554     <span class="comment">//</span>
00555     <span class="comment">// Loop through each of the required MDL's calling</span>
00556     <span class="comment">// IoAllocateAdapterChannel.</span>
00557     <span class="comment">//</span>
00558 
00559     MdlCount = 0;
00560 
00561     TempMdl = Mdl;
00562     TransferLength = Length;
00563     MdlLength = TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> - (ULONG)((PUCHAR) CurrentVa - (PUCHAR) <a class="code" href="../../d2/d1/mm_8h.html#a12">MmGetMdlVirtualAddress</a>(Mdl));
00564 
00565     MdlVa = (PUCHAR) <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(CurrentVa);
00566     NumberOfMapRegisters = 0;
00567 
00568     <span class="comment">//</span>
00569     <span class="comment">// Loop through the any chained MDLs accumulating the the required</span>
00570     <span class="comment">// number of map registers.</span>
00571     <span class="comment">//</span>
00572 
00573     <span class="keywordflow">while</span> (TransferLength &gt; 0) {
00574 
00575         <span class="keywordflow">if</span> (MdlLength &gt; TransferLength) {
00576 
00577             MdlLength = TransferLength;
00578         }
00579 
00580         TransferLength -= MdlLength;
00581 
00582         NumberOfMapRegisters = (ULONG)(((ULONG_PTR) MdlVa + MdlLength + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &gt;&gt;
00583                                     <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00584 
00585         Wcb-&gt;<a class="code" href="../../d8/d7/struct__WAIT__CONTEXT__BLOCK.html#o2">DeviceContext</a> = WaitBlock;
00586         Wcb-&gt;<a class="code" href="../../d8/d7/struct__WAIT__CONTEXT__BLOCK.html#o4">DeviceObject</a> = DeviceObject;
00587 
00588         <span class="comment">//</span>
00589         <span class="comment">// Store the map register index in IRP pointer.</span>
00590         <span class="comment">//</span>
00591 
00592         Wcb-&gt;<a class="code" href="../../d8/d7/struct__WAIT__CONTEXT__BLOCK.html#o5">CurrentIrp</a> = (PVOID) MdlCount;
00593 
00594         <span class="comment">//</span>
00595         <span class="comment">// Call the HAL to allocate the adapter channel.</span>
00596         <span class="comment">// xHalpAllocateAdapterCallback will fill in the scatter/gather list.</span>
00597         <span class="comment">//</span>
00598 
00599         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/hal_8h.html#a226">HalAllocateAdapterChannel</a>( ((<a class="code" href="../../d7/d5/struct__ADAPTER__OBJECT.html">PADAPTER_OBJECT</a>) DmaAdapter)-&gt;RealAdapterObject,
00600                                             Wcb,
00601                                             NumberOfMapRegisters,
00602                                             xHalpAllocateAdapterCallback );
00603 
00604         <span class="keywordflow">if</span> (TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00605             <span class="keywordflow">break</span>;
00606         }
00607 
00608         <span class="comment">//</span>
00609         <span class="comment">// Advance to next MDL.</span>
00610         <span class="comment">//</span>
00611 
00612         TempMdl = TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a>;
00613         MdlVa = (PUCHAR) TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o7">ByteOffset</a>;
00614         MdlLength = TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>;
00615         MdlCount++;
00616         Wcb++;
00617     }
00618 
00619     <span class="comment">//</span>
00620     <span class="comment">// If HalAllocateAdapterChannel failed then free the wait block.</span>
00621     <span class="comment">//</span>
00622 
00623     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status)) {
00624         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( WaitBlock );
00625     }
00626 
00627     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00628 }
00629 
00630 
00631 
00632 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00633 <a class="code" href="../../d4/d7/haldisp_8h.html#a31">xHalPutScatterGatherList</a> (
00634     IN <a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a> DmaAdapter,
00635     IN <a class="code" href="../../d6/d8/struct__SCATTER__GATHER__LIST.html">PSCATTER_GATHER_LIST</a> ScatterGather,
00636     IN BOOLEAN WriteToDevice
00637     )
00638 {
00639     <a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html">PXHAL_WAIT_CONTEXT_BLOCK</a> WaitBlock = (PVOID) ScatterGather-&gt;Reserved;
00640     ULONG TransferLength;
00641     ULONG MdlLength;
00642     ULONG MdlCount = 0;
00643     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
00644     PUCHAR CurrentVa;
00645 
00646     <span class="comment">//</span>
00647     <span class="comment">// Setup for the first MDL.  We expect the MDL pointer to be pointing</span>
00648     <span class="comment">// at the first used mdl.</span>
00649     <span class="comment">//</span>
00650 
00651     Mdl = WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o0">Mdl</a>;
00652     CurrentVa = WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o1">CurrentVa</a>;
00653     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CurrentVa &gt;= (PUCHAR) <a class="code" href="../../d2/d1/mm_8h.html#a12">MmGetMdlVirtualAddress</a>(Mdl) &amp;&amp; CurrentVa &lt; (PUCHAR) MmGetMdlVirtualAddress(Mdl) + Mdl-&gt;ByteCount );
00654 
00655     MdlLength = Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> - (ULONG)(CurrentVa - (PUCHAR) <a class="code" href="../../d2/d1/mm_8h.html#a12">MmGetMdlVirtualAddress</a>(Mdl));
00656     TransferLength = WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o2">Length</a>;
00657 
00658     <span class="comment">//</span>
00659     <span class="comment">// Loop through the used MDLs call IoFlushAdapterBuffers.</span>
00660     <span class="comment">//</span>
00661 
00662     <span class="keywordflow">while</span> (TransferLength &gt;  0) {
00663 
00664         <span class="keywordflow">if</span> (MdlLength &gt; TransferLength) {
00665 
00666             MdlLength = TransferLength;
00667         }
00668 
00669         TransferLength -= MdlLength;
00670 
00671         <a class="code" href="../../d2/d7/hal_8h.html#a230">IoFlushAdapterBuffers</a>( WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o3">RealAdapterObject</a>,
00672                                 Mdl,
00673                                 WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o10">MapRegisterBase</a>[MdlCount],
00674                                 CurrentVa,
00675                                 MdlLength,
00676                                 WriteToDevice );
00677 
00678 
00679         <span class="keywordflow">if</span> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00680             <span class="keywordflow">break</span>;
00681         }
00682 
00683         <span class="comment">//</span>
00684         <span class="comment">// Advance to the next MDL.  Update the current VA and the MdlLength.</span>
00685         <span class="comment">//</span>
00686 
00687         Mdl = Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a>;
00688         CurrentVa = <a class="code" href="../../d2/d1/mm_8h.html#a12">MmGetMdlVirtualAddress</a>(Mdl);
00689         MdlLength = Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>;
00690         MdlCount++;
00691     }
00692 
00693     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( WaitBlock );
00694 
00695 }
00696 
00697 <a class="code" href="../../d0/d5/io_8h.html#a321">IO_ALLOCATION_ACTION</a>
00698 <a class="code" href="../../d4/d7/haldisp_8h.html#a32">xHalpAllocateAdapterCallback</a> (
00699     IN <span class="keyword">struct</span> <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">_DEVICE_OBJECT</a> *DeviceObject,
00700     IN <span class="keyword">struct</span> <a class="code" href="../../d0/d2/struct__IRP.html">_IRP</a> *Irp,
00701     IN PVOID MapRegisterBase,
00702     IN PVOID Context
00703     )
00704 <span class="comment">/*++</span>
00705 <span class="comment"></span>
00706 <span class="comment">Routine Description:</span>
00707 <span class="comment"></span>
00708 <span class="comment">    This routine is called when the adapter object and map registers are</span>
00709 <span class="comment">    available for the data transfer. This routines saves the map register</span>
00710 <span class="comment">    base away.  If all of the required bases have not been saved then it</span>
00711 <span class="comment">    returns. Otherwise it routine builds the entire scatter/gather</span>
00712 <span class="comment">    list by calling IoMapTransfer.  After the list is build it is passed to</span>
00713 <span class="comment">    the driver.</span>
00714 <span class="comment"></span>
00715 <span class="comment">Arguments:</span>
00716 <span class="comment"></span>
00717 <span class="comment">    DeviceObject - Pointer to the device object that is allocating the</span>
00718 <span class="comment">        adapter.</span>
00719 <span class="comment"></span>
00720 <span class="comment">    Irp - Supplies the map register offset assigned for this callback.</span>
00721 <span class="comment"></span>
00722 <span class="comment">    MapRegisterBase - Supplies the map register base for use by the adapter</span>
00723 <span class="comment">        routines.</span>
00724 <span class="comment"></span>
00725 <span class="comment">    Context - Supplies a pointer to the xhal wait contorl block.</span>
00726 <span class="comment"></span>
00727 <span class="comment">Return Value:</span>
00728 <span class="comment"></span>
00729 <span class="comment">    Returns DeallocateObjectKeepRegisters.</span>
00730 <span class="comment"></span>
00731 <span class="comment"></span>
00732 <span class="comment">--*/</span>
00733 {
00734     <a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html">PXHAL_WAIT_CONTEXT_BLOCK</a> WaitBlock = Context;
00735     PVOID *MapRegisterBasePtr;
00736     ULONG TransferLength;
00737     LONG MdlLength;
00738     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
00739     PUCHAR CurrentVa;
00740     <a class="code" href="../../d6/d8/struct__SCATTER__GATHER__LIST.html">PSCATTER_GATHER_LIST</a> ScatterGather;
00741     <a class="code" href="../../d5/d8/struct__SCATTER__GATHER__ELEMENT.html">PSCATTER_GATHER_ELEMENT</a> Element;
00742 
00743     <span class="comment">//</span>
00744     <span class="comment">// Save the map register base in the appropriate slot.</span>
00745     <span class="comment">//</span>
00746 
00747     WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o10">MapRegisterBase</a>[ (ULONG_PTR) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> ] = MapRegisterBase;
00748 
00749     <span class="comment">//</span>
00750     <span class="comment">// See if this is the last callback;</span>
00751     <span class="comment">//</span>
00752 
00753     <span class="keywordflow">if</span> (InterlockedDecrement( &amp;WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o7">MapRegisterLock</a> ) != 0) {
00754 
00755         <span class="comment">//</span>
00756         <span class="comment">// More to come, wait for the rest.</span>
00757         <span class="comment">//</span>
00758 
00759         <span class="keywordflow">return</span>( <a class="code" href="../../d0/d5/io_8h.html#a601a411">DeallocateObjectKeepRegisters</a> );
00760 
00761     }
00762 
00763     <span class="comment">//</span>
00764     <span class="comment">// Put the scatter gatther list after wait block. Add a back pointer to</span>
00765     <span class="comment">// the begining of the wait block.</span>
00766     <span class="comment">//</span>
00767 
00768     MapRegisterBasePtr = (PVOID *) (WaitBlock + 1);
00769     ScatterGather = (<a class="code" href="../../d6/d8/struct__SCATTER__GATHER__LIST.html">PSCATTER_GATHER_LIST</a>) (MapRegisterBasePtr +
00770                         WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o9">MdlCount</a>);
00771     ScatterGather-&gt;<a class="code" href="../../d6/d8/struct__SCATTER__GATHER__LIST.html#o1">Reserved</a> = (ULONG_PTR) WaitBlock;
00772     Element = ScatterGather-&gt;<a class="code" href="../../d6/d8/struct__SCATTER__GATHER__LIST.html#o2">Elements</a>;
00773 
00774     <span class="comment">//</span>
00775     <span class="comment">// Setup for the first MDL.  We expect the MDL pointer to be pointing</span>
00776     <span class="comment">// at the first used MDL.</span>
00777     <span class="comment">//</span>
00778 
00779     Mdl = WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o0">Mdl</a>;
00780     CurrentVa = WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o1">CurrentVa</a>;
00781     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CurrentVa &gt;= (PUCHAR) <a class="code" href="../../d2/d1/mm_8h.html#a12">MmGetMdlVirtualAddress</a>(Mdl) &amp;&amp; CurrentVa &lt; (PUCHAR) MmGetMdlVirtualAddress(Mdl) + Mdl-&gt;ByteCount );
00782 
00783     MdlLength = Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> - (ULONG)(CurrentVa - (PUCHAR) <a class="code" href="../../d2/d1/mm_8h.html#a12">MmGetMdlVirtualAddress</a>(Mdl));
00784     TransferLength = WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o2">Length</a>;
00785 
00786     <span class="comment">//</span>
00787     <span class="comment">// Loop build the list for each MDL.</span>
00788     <span class="comment">//</span>
00789 
00790     <span class="keywordflow">while</span> (TransferLength &gt;  0) {
00791 
00792         <span class="keywordflow">if</span> ((ULONG) MdlLength &gt; TransferLength) {
00793 
00794             MdlLength = TransferLength;
00795         }
00796 
00797         TransferLength -= MdlLength;
00798 
00799         <span class="comment">//</span>
00800         <span class="comment">// Loop building the list for the elments within and MDL.</span>
00801         <span class="comment">//</span>
00802 
00803         <span class="keywordflow">while</span> (MdlLength &gt; 0) {
00804 
00805             Element-&gt;<a class="code" href="../../d5/d8/struct__SCATTER__GATHER__ELEMENT.html#o1">Length</a> = MdlLength;
00806             Element-&gt;<a class="code" href="../../d5/d8/struct__SCATTER__GATHER__ELEMENT.html#o0">Address</a> = <a class="code" href="../../d2/d7/hal_8h.html#a233">IoMapTransfer</a>( WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o3">RealAdapterObject</a>,
00807                                             Mdl,
00808                                             *MapRegisterBasePtr,
00809                                             CurrentVa,
00810                                             &amp;Element-&gt;<a class="code" href="../../d5/d8/struct__SCATTER__GATHER__ELEMENT.html#o1">Length</a>,
00811                                             WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o8">WriteToDevice</a> );
00812 
00813             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ULONG) MdlLength &gt;= Element-&gt;<a class="code" href="../../d5/d8/struct__SCATTER__GATHER__ELEMENT.html#o1">Length</a> );
00814             MdlLength -= Element-&gt;<a class="code" href="../../d5/d8/struct__SCATTER__GATHER__ELEMENT.html#o1">Length</a>;
00815             CurrentVa += Element-&gt;<a class="code" href="../../d5/d8/struct__SCATTER__GATHER__ELEMENT.html#o1">Length</a>;
00816             Element++;
00817         }
00818 
00819         <span class="keywordflow">if</span> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00820 
00821             <span class="comment">//</span>
00822             <span class="comment">// There is a few cases where the buffer described by the MDL</span>
00823             <span class="comment">// is less than the transfer length.  This occurs when the</span>
00824             <span class="comment">// file system transfering the last page of file and MM defines</span>
00825             <span class="comment">// the MDL to be file size and the file system round the write</span>
00826             <span class="comment">// up to a sector.  This extra should never cross a page</span>
00827             <span class="comment">// bountry. Add this extra to the length of the last element.</span>
00828             <span class="comment">//</span>
00829 
00830             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((Element - 1)-&gt;Length &amp; (PAGE_SIZE - 1)) + TransferLength &lt;= PAGE_SIZE );
00831             (Element - 1)-&gt;Length += TransferLength;
00832 
00833             <span class="keywordflow">break</span>;
00834         }
00835 
00836         <span class="comment">//</span>
00837         <span class="comment">// Advance to the next MDL.  Update the current VA and the MdlLength.</span>
00838         <span class="comment">//</span>
00839 
00840         Mdl = Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a>;
00841         CurrentVa = <a class="code" href="../../d2/d1/mm_8h.html#a12">MmGetMdlVirtualAddress</a>(Mdl);
00842         MdlLength = Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>;
00843         MapRegisterBasePtr++;
00844 
00845     }
00846 
00847     <span class="comment">//</span>
00848     <span class="comment">// Set the number of elements actually used.</span>
00849     <span class="comment">//</span>
00850 
00851     ScatterGather-&gt;<a class="code" href="../../d6/d8/struct__SCATTER__GATHER__LIST.html#o0">NumberOfElements</a> = (ULONG)(Element - ScatterGather-&gt;<a class="code" href="../../d6/d8/struct__SCATTER__GATHER__LIST.html#o2">Elements</a>);
00852 
00853     <span class="comment">//</span>
00854     <span class="comment">// Call the driver with the scatter/gather list.</span>
00855     <span class="comment">//</span>
00856 
00857     WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o4">DriverExecutionRoutine</a>( DeviceObject,
00858                                        WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o6">CurrentIrp</a>,
00859                                        ScatterGather,
00860                                        WaitBlock-&gt;<a class="code" href="../../d9/d9/struct__XHAL__WAIT__CONTEXT__BLOCK.html#o5">DriverContext</a> );
00861 
00862     <span class="keywordflow">return</span>( <a class="code" href="../../d0/d5/io_8h.html#a601a411">DeallocateObjectKeepRegisters</a> );
00863 }
00864 <span class="preprocessor">#endif</span>
00865 <span class="preprocessor"></span>BOOLEAN
<a name="l00866"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a13">00866</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a13">xHalTranslateBusAddress</a>(
00867     IN INTERFACE_TYPE  InterfaceType,
00868     IN ULONG BusNumber,
00869     IN PHYSICAL_ADDRESS BusAddress,
00870     IN OUT PULONG AddressSpace,
00871     OUT PPHYSICAL_ADDRESS TranslatedAddress
00872     )
00873 {
00874     <span class="comment">//</span>
00875     <span class="comment">// If the HAL fails to override this function, then</span>
00876     <span class="comment">// the HAL has clearly failed to initialize.</span>
00877     <span class="comment">//</span>
00878 
00879     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(HAL_INITIALIZATION_FAILED, 0, 0, 0, 7);
00880     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00881 }
00882 
00883 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00884"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a14">00884</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a14">xHalAssignSlotResources</a> (
00885     IN PUNICODE_STRING RegistryPath,
00886     IN PUNICODE_STRING DriverClassName OPTIONAL,
00887     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00888     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL,
00889     IN INTERFACE_TYPE BusType,
00890     IN ULONG BusNumber,
00891     IN ULONG SlotNumber,
00892     IN OUT PCM_RESOURCE_LIST *AllocatedResources
00893     )
00894 {
00895     <span class="comment">//</span>
00896     <span class="comment">// If the HAL fails to override this function, then</span>
00897     <span class="comment">// the HAL has clearly failed to initialize.</span>
00898     <span class="comment">//</span>
00899 
00900     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(HAL_INITIALIZATION_FAILED, 0, 0, 0, 7);
00901     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00902 }
00903 
00904 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00905"></a><a class="code" href="../../d5/d7/halfnc_8c.html#a15">00905</a> <a class="code" href="../../d5/d7/halfnc_8c.html#a15">xHalHaltSystem</a>(
00906     VOID
00907     )
00908 {
00909     <span class="keywordflow">for</span> (;;) ;
00910 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:14 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
