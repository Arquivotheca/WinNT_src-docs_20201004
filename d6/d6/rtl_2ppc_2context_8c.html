<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rtl/ppc/context.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>context.c File Reference</h1><code>#include &lt;<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>&gt;</code><br>
<code>#include &lt;kxppc.h&gt;</code><br>

<p>
<a href="../../d7/d5/rtl_2ppc_2context_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/rtl_2ppc_2context_8c.html#a0">_KXPPC_C_HEADER_</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/rtl_2ppc_2context_8c.html#a1">RtlInitializeContext</a> (IN HANDLE Process, OUT PCONTEXT Context, IN PVOID Parameter OPTIONAL, IN PVOID InitialPc OPTIONAL, IN PVOID InitialSp OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/rtl_2ppc_2context_8c.html#a2">RtlRemoteCall</a> (HANDLE Process, HANDLE Thread, PVOID CallSite, ULONG ArgumentCount, PULONG Arguments, BOOLEAN PassContext, BOOLEAN AlreadySuspended)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="rtl/ppc/context.c::_KXPPC_C_HEADER_" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define _KXPPC_C_HEADER_          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/rtl_2ppc_2context_8c-source.html#l00027">27</a> of file <a class="el" href="../../d7/d5/rtl_2ppc_2context_8c-source.html">rtl/ppc/context.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="rtl/ppc/context.c::RtlInitializeContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlInitializeContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Parameter&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InitialPc&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InitialSp&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/rtl_2ppc_2context_8c-source.html#l00031">31</a> of file <a class="el" href="../../d7/d5/rtl_2ppc_2context_8c-source.html">rtl/ppc/context.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00239">CONTEXT_FULL</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, and <a class="el" href="../../d8/d9/psctxppc_8c-source.html#l00027">STK_MIN_FRAME</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l01241">RtlCreateUserThread()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00167">TestTokenInitialize()</a>.
<p>
<pre class="fragment"><div>00041                    :
00042 
00043     This function initializes a context structure so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be used in
00044     a subsequent call to <a class="code" href="../../d2/d8/ps_2create_8c.html#a10">NtCreateThread</a>.
00045 
00046 Arguments:
00047 
00048     Context - Supplies a pointer to a context record that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be initialized.
00049 
00050     InitialPc - Supplies an initial program counter value.
00051 
00052     InitialSp - Supplies an initial stack pointer value.
00053 
00054 Return Value:
00055 
00056     Raises STATUS_BAD_INITIAL_STACK <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of InitialSp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly
00057            aligned.
00058 
00059     Raises STATUS_BAD_INITIAL_PC <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of InitialPc <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly
00060            aligned.
00061 
00062 --*/
00063 
00064 {
00065 
00066     <span class="comment">//</span>
00067     <span class="comment">// Check for proper initial stack and PC alignment.</span>
00068     <span class="comment">//</span>
00069 
00070     <span class="keywordflow">if</span> (((ULONG)InitialSp &amp; 0x7) != 0) {
00071         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_BAD_INITIAL_STACK);
00072     }
00073     <span class="keywordflow">if</span> (((ULONG)InitialPc &amp; 0x3) != 0) {
00074         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_BAD_INITIAL_PC);
00075     }
00076 
00077     <span class="comment">//</span>
00078     <span class="comment">// Initialize the integer and floating registers to contain zeroes.</span>
00079     <span class="comment">//</span>
00080 
00081     RtlZeroMemory(Context, <span class="keyword">sizeof</span>(CONTEXT));
00082 
00083     <span class="comment">//</span>
00084     <span class="comment">// Initialize the control registers.</span>
00085     <span class="comment">//</span>
00086 
00087     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(InitialPc) ) {
00088         Context-&gt;Iar = (ULONG)InitialPc;
00089     }
00090     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(InitialSp) ) {
00091         Context-&gt;Gpr1 = (ULONG)InitialSp - <a class="code" href="../../d7/d0/psctxppc_8c.html#a0">STK_MIN_FRAME</a>;
00092     }
00093 
00094     Context-&gt;Msr =
00095         MASK_SPR(MSR_ILE,1)|
00096         MASK_SPR(MSR_FP,1) |
00097         MASK_SPR(MSR_FE0,1)|
00098         MASK_SPR(MSR_FE1,1)|
00099         MASK_SPR(MSR_ME,1) |
00100         MASK_SPR(MSR_IR,1) |
00101         MASK_SPR(MSR_DR,1) |
00102         MASK_SPR(MSR_PR,1) |
00103         MASK_SPR(MSR_LE,1);
00104     Context-&gt;ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00105 
00106     <span class="comment">//</span>
00107     <span class="comment">// Set the initial context of the thread in a machine specific way.</span>
00108     <span class="comment">//</span>
00109 
00110     Context-&gt;Gpr3 = (ULONG)Parameter;
00111 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="rtl/ppc/context.c::RtlRemoteCall" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlRemoteCall           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>CallSite</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ArgumentCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Arguments</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>PassContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AlreadySuspended</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/rtl_2ppc_2context_8c-source.html#l00114">114</a> of file <a class="el" href="../../d7/d5/rtl_2ppc_2context_8c-source.html">rtl/ppc/context.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00239">CONTEXT_FULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00151">NtGetContextThread()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00138">NtResumeThread()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00352">NtSetContextThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00033">NtSuspendThread()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00231">NtWriteVirtualMemory()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d8/d9/psctxppc_8c-source.html#l00027">STK_MIN_FRAME</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/w32_2ntuser_2server_2debug_8c-source.html#l00028">SrvActivateDebugger()</a>.
<p>
<pre class="fragment"><div>00126                    :
00127 
00128     This function calls a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> in another thread/process,  by <span class="keyword">using</span>
00129     NtGetContext and NtSetContext. Parameters are passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target
00130     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> nonvolatile registers (s0 - s7).
00131 
00132 Arguments:
00133 
00134     Process - Supplies an open handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process.
00135 
00136     Thread - Supplies an open handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target thread within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target
00137         process.
00138 
00139     CallSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> to call in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target
00140         process.
00141 
00142     ArgumentCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of 32 bit parameters to pass to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00143         target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>.
00144 
00145     Arguments - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> array of 32 bit parameters to pass.
00146 
00147     PassContext - Supplies a <span class="keywordtype">boolean</span> value that determines whether a parameter
00148         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be passed that points to a context record. This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00149         ignored on MIPS hosts.
00150 
00151     AlreadySuspended - Supplies a <span class="keywordtype">boolean</span> value that determines whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00152         target thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already in a suspended or waiting state.
00153 
00154 Return Value:
00155 
00156     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value
00157 
00158 --*/
00159 
00160 {
00161 
00162     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00163     CONTEXT Context;
00164     ULONG NewSp;
00165 
00166     <span class="keywordflow">if</span> (ArgumentCount &gt; 8) {
00167         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
00168     }
00169 
00170     <span class="comment">//</span>
00171     <span class="comment">// If necessary, suspend the target thread before getting the thread's</span>
00172     <span class="comment">// current state.</span>
00173     <span class="comment">//</span>
00174 
00175     <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00176         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/psspnd_8c.html#a0">NtSuspendThread</a>(Thread, NULL);
00177         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00178             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00179         }
00180     }
00181 
00182     <span class="comment">//</span>
00183     <span class="comment">// Get the current state of the target thread.</span>
00184     <span class="comment">//</span>
00185 
00186     Context.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00187     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a2">NtGetContextThread</a>(Thread, &amp;Context);
00188     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00189         <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00190             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, NULL);
00191         }
00192         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00193     }
00194 
00195     <span class="keywordflow">if</span> (AlreadySuspended ) {
00196 
00197         Context.Gpr3 = STATUS_ALERTED;
00198     }
00199 
00200     <span class="comment">//</span>
00201     <span class="comment">// Pass the parameters to the other thread via the non-volatile registers</span>
00202     <span class="comment">// s0 - s7. The context record is passed on the stack of the target thread.</span>
00203     <span class="comment">//</span>
00204 
00205     NewSp = Context.Gpr1 - <span class="keyword">sizeof</span>(CONTEXT) - <a class="code" href="../../d7/d0/psctxppc_8c.html#a0">STK_MIN_FRAME</a>;
00206     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a10">NtWriteVirtualMemory</a>(Process, (PVOID)(NewSp + STK_MIN_FRAME), &amp;Context,
00207                                   <span class="keyword">sizeof</span>(CONTEXT), NULL);
00208     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a10">NtWriteVirtualMemory</a>(Process, (PVOID)NewSp, &amp;Context.Gpr1,
00209                                   <span class="keyword">sizeof</span>(ULONG), NULL);
00210     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00211         <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00212             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, NULL);
00213         }
00214         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00215     }
00216 
00217     Context.Gpr1 = NewSp;
00218 
00219     <span class="keywordflow">if</span> (PassContext) {
00220         Context.Gpr14 = NewSp + <a class="code" href="../../d7/d0/psctxppc_8c.html#a0">STK_MIN_FRAME</a>;
00221         RtlMoveMemory(&amp;Context.Gpr15, Arguments, ArgumentCount * <span class="keyword">sizeof</span>(ULONG));
00222 
00223     } <span class="keywordflow">else</span> {
00224 
00225         RtlMoveMemory(&amp;Context.Gpr14, Arguments, ArgumentCount * <span class="keyword">sizeof</span>(ULONG));
00226     }
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">// Set the address of the target code into FIR and set the thread context</span>
00230     <span class="comment">// to cause the target procedure to be executed.</span>
00231     <span class="comment">//</span>
00232 
00233     Context.Iar = (ULONG)CallSite;      <span class="comment">// Set context will dereference the</span>
00234     Context.Gpr2 = 0;                   <span class="comment">// FNDESC in the remote threads context</span>
00235     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a3">NtSetContextThread</a>(Thread, &amp;Context);
00236     <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00237         <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, NULL);
00238     }
00239     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00240 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:16 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
