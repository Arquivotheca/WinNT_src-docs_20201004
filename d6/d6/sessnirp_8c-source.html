<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: sessnirp.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sessnirp.c</h1><a href="../../d5/d7/sessnirp_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00002 <span class="preprocessor">#include "srb.h"</span>
00003 
00004 <span class="comment">//</span>
00005 <span class="comment">// This entire file is only present if NO_SPECIAL_IRP isn't defined</span>
00006 <span class="comment">//</span>
00007 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
00008 <span class="preprocessor"></span>
00009 <span class="comment">//</span>
00010 <span class="comment">// When enabled, everything is locked down on demand...</span>
00011 <span class="comment">//</span>
00012 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00013 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY, IovpSessionDataCreate)</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY, IovpSessionDataAdvance)</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY, IovpSessionDataReference)</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY, IovpSessionDataDereference)</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY, IovpSessionDataClose)</span>
00018 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY, IovpSessionDataDeterminePolicy)</span>
00019 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY, IovpSessionDataAttachSurrogate)</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY, IovpSessionDataFinalizeSurrogate)</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00022 <span class="preprocessor"></span>
<a name="l00023"></a><a class="code" href="../../d5/d7/sessnirp_8c.html#a0">00023</a> <span class="preprocessor">#define POOL_TAG_SESSION_DATA       'sprI'</span>
00024 <span class="preprocessor"></span>
00025 <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a>
00026 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00027"></a><a class="code" href="../../d6/d7/sessnirp_8h.html#a0">00027</a> <a class="code" href="../../d6/d7/sessnirp_8h.html#a0">IovpSessionDataCreate</a>(
00028     IN      <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>       DeviceObject,
00029     IN OUT  <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>  *IovPacketPointer,
00030     OUT     PBOOLEAN             SurrogateSpawned
00031     )
00032 <span class="comment">/*++</span>
00033 <span class="comment"></span>
00034 <span class="comment">  Description:</span>
00035 <span class="comment"></span>
00036 <span class="comment">    This routine creates tracking data for a new IRP. It must be called on the</span>
00037 <span class="comment">    thread the IRP was originally sent down...</span>
00038 <span class="comment"></span>
00039 <span class="comment">  Arguments:</span>
00040 <span class="comment"></span>
00041 <span class="comment">    Irp                    - Irp to track.</span>
00042 <span class="comment"></span>
00043 <span class="comment">  Return Value:</span>
00044 <span class="comment"></span>
00045 <span class="comment">    iovPacket block, NULL if no memory.</span>
00046 <span class="comment"></span>
00047 <span class="comment">--*/</span>
00048 {
00049     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp, surrogateIrp;
00050     <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> iovSessionData;
00051     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> headPacket;
00052     ULONG sessionDataSize;
00053     BOOLEAN trackable, useSurrogateIrp;
00054 
00055     *SurrogateSpawned = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00056 
00057     headPacket = (*IovPacketPointer)-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a>;
00058     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(headPacket == (*IovPacketPointer));
00059     irp = headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o0">TrackedIrp</a>;
00060 
00061     <span class="comment">//</span>
00062     <span class="comment">// Check the IRP appropriately</span>
00063     <span class="comment">//</span>
00064     <a class="code" href="../../d6/d7/sessnirp_8h.html#a5">IovpSessionDataDeterminePolicy</a>(
00065         headPacket,
00066         DeviceObject,
00067         &amp;trackable,
00068         &amp;useSurrogateIrp
00069         );
00070 
00071     <span class="keywordflow">if</span> (!trackable) {
00072 
00073         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00074     }
00075 
00076     <span class="comment">//</span>
00077     <span class="comment">// One extra stack location is allocated as the "zero'th" is used to</span>
00078     <span class="comment">// simplify some logic...</span>
00079     <span class="comment">//</span>
00080     sessionDataSize =
00081         <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">IOV_SESSION_DATA</a>)+
00082         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a>*<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">IOV_STACK_LOCATION</a>);
00083 
00084     iovSessionData = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00085         <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00086         sessionDataSize,
00087         <a class="code" href="../../d5/d7/sessnirp_8c.html#a0">POOL_TAG_SESSION_DATA</a>
00088         );
00089 
00090     <span class="keywordflow">if</span> (iovSessionData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00091 
00092         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00093     }
00094 
00095     RtlZeroMemory(iovSessionData, sessionDataSize);
00096 
00097     iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a> = <a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>;
00098     iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o0">IovRequestPacket</a> = headPacket;
00099     InsertHeadList(&amp;headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o8">SessionHead</a>, &amp;iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o2">SessionLink</a>);
00100 
00101     <span class="keywordflow">if</span> ((iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a9">ASSERTFLAG_COMPLETEATPASSIVE</a>) ||
00102         (iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a10">ASSERTFLAG_DEFERCOMPLETION</a>)) {
00103 
00104         iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a7">ASSERTFLAG_FORCEPENDING</a>;
00105     }
00106 
00107     headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o21">pIovSessionData</a> = iovSessionData;
00108     headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o16">TopStackLocation</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>;
00109     headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a25">TRACKFLAG_ACTIVE</a>;
00110     headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> &amp;=~ (
00111                           <a class="code" href="../../d9/d4/trackirp_8h.html#a29">TRACKFLAG_QUEUED_INTERNALLY</a>|
00112                           <a class="code" href="../../d9/d4/trackirp_8h.html#a31">TRACKFLAG_RELEASED</a>|
00113                           <a class="code" href="../../d9/d4/trackirp_8h.html#a32">TRACKFLAG_SRB_MUNGED</a>|
00114                           <a class="code" href="../../d9/d4/trackirp_8h.html#a33">TRACKFLAG_SWAPPED_BACK</a>|
00115                           <a class="code" href="../../d9/d4/trackirp_8h.html#a37">TRACKFLAG_PASSED_FAILURE</a>
00116                          );
00117 
00118     iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o8">BestVisibleIrp</a> = irp;
00119     <span class="keywordflow">if</span> (useSurrogateIrp) {
00120 
00121         <span class="comment">//</span>
00122         <span class="comment">// We will track the IRP using a surrogate.</span>
00123         <span class="comment">//</span>
00124         *SurrogateSpawned = <a class="code" href="../../d6/d7/sessnirp_8h.html#a6">IovpSessionDataAttachSurrogate</a>(
00125             IovPacketPointer,
00126             iovSessionData
00127             );
00128     }
00129 
00130     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00131         <span class="stringliteral">"  SSN CREATE(%x)-&gt;%x\n"</span>,
00132         headPacket,
00133         iovSessionData
00134         ), 3) ;
00135     <span class="keywordflow">return</span> iovSessionData;
00136 }
00137 
00138 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00139 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00140"></a><a class="code" href="../../d6/d7/sessnirp_8h.html#a1">00140</a> <a class="code" href="../../d6/d7/sessnirp_8h.html#a1">IovpSessionDataAdvance</a>(
00141     IN      <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>       DeviceObject,
00142     IN      <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a>    IovSessionData,
00143     IN OUT  <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>  *IovPacketPointer,
00144     OUT     PBOOLEAN             SurrogateSpawned
00145     )
00146 {
00147     *SurrogateSpawned = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00148 }
00149 
00150 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00151 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00152"></a><a class="code" href="../../d6/d7/sessnirp_8h.html#a3">00152</a> <a class="code" href="../../d6/d7/sessnirp_8h.html#a3">IovpSessionDataDereference</a>(
00153     IN <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> IovSessionData
00154     )
00155 {
00156     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket, headPacket;
00157 
00158     iovPacket = IovSessionData-&gt;IovRequestPacket;
00159     headPacket = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a>;
00160 
00161     <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a>);
00162     <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a>);
00163     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IovSessionData-&gt;SessionRefCount &gt; 0);
00164     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a> &gt; 0);
00165     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a> &gt;= 0);
00166 
00167     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00168         <span class="stringliteral">"  SSN DEREF(%x) %x--\n"</span>,
00169         IovSessionData,
00170         IovSessionData-&gt;SessionRefCount
00171         ), 3) ;
00172 
00173     IovSessionData-&gt;SessionRefCount--;
00174     <span class="keywordflow">if</span> (!IovSessionData-&gt;SessionRefCount) {
00175 
00176         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o21">pIovSessionData</a> != IovSessionData);
00177         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a> &gt; iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o4">PointerCount</a>);
00178         <span class="comment">//ASSERT(IsListEmpty(&amp;IovSessionData-&gt;SessionLink));</span>
00179         RemoveEntryList(&amp;IovSessionData-&gt;SessionLink);
00180         InitializeListHead(&amp;IovSessionData-&gt;SessionLink);
00181 
00182         <a class="code" href="../../d9/d8/hashirp_8h.html#a14">IovpTrackingDataDereference</a>(iovPacket, <a class="code" href="../../d9/d8/hashirp_8h.html#a21a4">IOVREFTYPE_PACKET</a>);
00183 
00184         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IovSessionData);
00185     }
00186 }
00187 
00188 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00189 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00190"></a><a class="code" href="../../d6/d7/sessnirp_8h.html#a2">00190</a> <a class="code" href="../../d6/d7/sessnirp_8h.html#a2">IovpSessionDataReference</a>(
00191     IN <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> IovSessionData
00192     )
00193 {
00194     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket, headPacket;
00195 
00196     iovPacket = IovSessionData-&gt;IovRequestPacket;
00197     headPacket = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a>;
00198 
00199     <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a>);
00200     <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a>);
00201     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IovSessionData-&gt;SessionRefCount &gt;= 0);
00202     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a> &gt;= 0);
00203     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a> &gt;= 0);
00204 
00205     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00206         <span class="stringliteral">"  SSN REF(%x) %x++\n"</span>,
00207         IovSessionData,
00208         IovSessionData-&gt;SessionRefCount
00209         ), 3) ;
00210 
00211     <span class="keywordflow">if</span> (!IovSessionData-&gt;SessionRefCount) {
00212 
00213         <a class="code" href="../../d9/d8/hashirp_8h.html#a13">IovpTrackingDataReference</a>(iovPacket, <a class="code" href="../../d9/d8/hashirp_8h.html#a21a4">IOVREFTYPE_PACKET</a>);
00214     }
00215     IovSessionData-&gt;SessionRefCount++;
00216 }
00217 
00218 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00219 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00220"></a><a class="code" href="../../d6/d7/sessnirp_8h.html#a4">00220</a> <a class="code" href="../../d6/d7/sessnirp_8h.html#a4">IovpSessionDataClose</a>(
00221     IN <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> IovSessionData
00222     )
00223 {
00224    <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket = IovSessionData-&gt;IovRequestPacket;
00225 
00226    <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a>);
00227 
00228    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket == iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a>);
00229    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o21">pIovSessionData</a> == IovSessionData);
00230 
00231    <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00232        <span class="stringliteral">"  SSN CLOSE(%x)\n"</span>
00233        ), 3) ;
00234 
00235    iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> &amp;=~ TRACKFLAG_ACTIVE;
00236    iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o21">pIovSessionData</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00237 }
00238 
00239 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00240"></a><a class="code" href="../../d6/d7/sessnirp_8h.html#a5">00240</a> <a class="code" href="../../d6/d7/sessnirp_8h.html#a5">IovpSessionDataDeterminePolicy</a>(
00241     IN   <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> IovRequestPacket,
00242     IN   <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>      DeviceObject,
00243     OUT  PBOOLEAN            Trackable,
00244     OUT  PBOOLEAN            UseSurrogateIrp
00245     )
00246 <span class="comment">/*++</span>
00247 <span class="comment"></span>
00248 <span class="comment">  Description:</span>
00249 <span class="comment"></span>
00250 <span class="comment">    This routine is called by IovpCallDriver1 to determine which IRPs should</span>
00251 <span class="comment">    be tracked and how that tracking should be done.</span>
00252 <span class="comment"></span>
00253 <span class="comment">  Arguments:</span>
00254 <span class="comment"></span>
00255 <span class="comment">    ADRIAO BUGBUG 12/31/1998 - Fill this out.</span>
00256 <span class="comment"></span>
00257 <span class="comment">  Return Value:</span>
00258 <span class="comment"></span>
00259 <span class="comment">     None.</span>
00260 <span class="comment"></span>
00261 <span class="comment">--*/</span>
00262 {
00263     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00264     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00265 
00266     irp = IovRequestPacket-&gt;TrackedIrp;
00267 
00268     <span class="keywordflow">if</span> (!(<a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a0">ASSERTFLAG_TRACKIRPS</a>)) {
00269 
00270         <span class="comment">//</span>
00271         <span class="comment">// No IRPs are to be tracked. Exit now.</span>
00272         <span class="comment">//</span>
00273         *Trackable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00274         <span class="keywordflow">return</span>;
00275     }
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">// Determine whether we are to monitor this IRP. If we are going to test</span>
00279     <span class="comment">// any one driver in a stack, then we must unfortunately monitor the IRP's</span>
00280     <span class="comment">// progress through the *entire* stack. Thus our granularity here is stack</span>
00281     <span class="comment">// based, not device based! We will compensate for this somewhat in the</span>
00282     <span class="comment">// driver check code, which will attempt to ignore asserts from those</span>
00283     <span class="comment">// "non-targetted" drivers who happen to have screwed up in our stack...</span>
00284     <span class="comment">//</span>
00285     *Trackable = <a class="code" href="../../d9/d4/trackirp_8h.html#a141">IovpIsInterestingStack</a>(DeviceObject);
00286 
00287     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00288 
00289     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) {
00290 
00291         *UseSurrogateIrp = ((<a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a4">ASSERTFLAG_SURROGATE</a>)!=0) ;
00292         *UseSurrogateIrp &amp;= ((irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> != <a class="code" href="../../d0/d5/io_8h.html#a43">IRP_MJ_SCSI</a>) ||
00293                         ((<a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a5">ASSERTFLAG_SMASH_SRBS</a>)!=0)) ;
00294 
00295 <span class="preprocessor">#ifdef HACKHACKS_ENABLED</span>
00296 <span class="preprocessor"></span>
00297         <span class="comment">//</span>
00298         <span class="comment">// ADRIAO HACKHACK #05 05/30/98 -</span>
00299         <span class="comment">// We don't surrogate creates right now because MUP touches IRPs</span>
00300         <span class="comment">// after they are completed.</span>
00301         <span class="comment">//</span>
00302         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/trackirp_8c.html#a8">IovpHackFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a15">HACKFLAG_FOR_MUP</a>) {
00303             *UseSurrogateIrp &amp;= (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> != <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>) ;
00304         }
00305 <span class="preprocessor">#endif</span>
00306 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00307 
00308         *UseSurrogateIrp = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00309     }
00310 }
00311 
00312 BOOLEAN
00313 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00314"></a><a class="code" href="../../d6/d7/sessnirp_8h.html#a6">00314</a> <a class="code" href="../../d6/d7/sessnirp_8h.html#a6">IovpSessionDataAttachSurrogate</a>(
00315     IN OUT  <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>  *IovPacketPointer,
00316     IN      <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a>    IovSessionData
00317     )
00318 <span class="comment">/*++</span>
00319 <span class="comment"></span>
00320 <span class="comment">  Description:</span>
00321 <span class="comment"></span>
00322 <span class="comment">    This routine creates tracking data for a new IRP. It must be called on the</span>
00323 <span class="comment">    thread the IRP was originally sent down...</span>
00324 <span class="comment"></span>
00325 <span class="comment">  Arguments:</span>
00326 <span class="comment"></span>
00327 <span class="comment">    IovPacketPointer       - Pointer to IRP packet to attach surrogate to. If</span>
00328 <span class="comment">                             a surrogate can be attached the packet will be</span>
00329 <span class="comment">                             updated to track the surrogate.</span>
00330 <span class="comment"></span>
00331 <span class="comment">    SurrogateIrp           - Prepared surrogate IRP to attach.</span>
00332 <span class="comment"></span>
00333 <span class="comment">  Return Value:</span>
00334 <span class="comment"></span>
00335 <span class="comment">    iovPacket block, NULL if no memory.</span>
00336 <span class="comment"></span>
00337 <span class="comment">--*/</span>
00338 {
00339 
00340     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovSurrogatePacket, iovPacket, headPacket;
00341     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> surrogateIrp, irp;
00342     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00343     PSCSI_REQUEST_BLOCK srb;
00344     PVOID restoreHandle;
00345     CCHAR activeSize;
00346 
00347     iovPacket = *IovPacketPointer;
00348     <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a>);
00349     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(CONTAINING_RECORD(
00350         iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o7">SurrogateLink</a>.Flink,
00351         <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">IOV_REQUEST_PACKET</a>,
00352         SurrogateLink)-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a26">TRACKFLAG_SURROGATE</a>
00353         ));
00354 
00355     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> &amp; <a class="code" href="../../d9/d4/trackirp_8h.html#a25">TRACKFLAG_ACTIVE</a>);
00356 
00357     irp = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o0">TrackedIrp</a>;
00358     activeSize = (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>-1);
00359     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(activeSize);
00360 
00361     <span class="comment">//</span>
00362     <span class="comment">// We now try to make a copy of this new IRP which we will track. We</span>
00363     <span class="comment">// do this so that we may free *every* tracked IRP immediately upon</span>
00364     <span class="comment">// completion.</span>
00365     <span class="comment">// Technically speaking, we only need to allocate what's left of the</span>
00366     <span class="comment">// stack, not the entire thing. But using the entire stack makes our</span>
00367     <span class="comment">// work much much easier. Specifically the session stack array may depend</span>
00368     <span class="comment">// on this.</span>
00369     <span class="comment">//</span>
00370     <span class="comment">// ADRIAO BUGBUG 03/04/1999 - Make this work only copying a portion of the</span>
00371     <span class="comment">// IRP.</span>
00372     <span class="comment">//</span>
00373     surrogateIrp = <a class="code" href="../../d9/d8/hashirp_8h.html#a20">IovpProtectedIrpAllocate</a>(
00374         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a>, <span class="comment">// activeSize</span>
00375         (BOOLEAN) ((irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a>&amp;<a class="code" href="../../d0/d5/io_8h.html#a190">IRP_QUOTA_CHARGED</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>),
00376         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00377         );
00378 
00379     <span class="keywordflow">if</span> (surrogateIrp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00380 
00381         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00382     }
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">// Now set up the new IRP - we do this here so IovpTrackingDataCreateAndLock</span>
00386     <span class="comment">// can peek at it's fields. Start with the IRP header.</span>
00387     <span class="comment">//</span>
00388     RtlCopyMemory(surrogateIrp, irp, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>));
00389 
00390     <span class="comment">//</span>
00391     <span class="comment">// Adjust StackCount and CurrentLocation</span>
00392     <span class="comment">//</span>
00393     surrogateIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a>; <span class="comment">// activeSize</span>
00394     surrogateIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.CurrentStackLocation =
00395         ((<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>) (surrogateIrp+1))+activeSize;
00396 
00397     <span class="comment">//</span>
00398     <span class="comment">// Our new IRP "floats", and is not attached to any thread.</span>
00399     <span class="comment">// Note that all cancels due to thread death will come through the</span>
00400     <span class="comment">// original IRP.</span>
00401     <span class="comment">//</span>
00402     InitializeListHead(&amp;surrogateIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o8">ThreadListEntry</a>);
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// Our new IRP also is not connected to user mode.</span>
00406     <span class="comment">//</span>
00407     surrogateIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00408     surrogateIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">// Now copy over only the active portions of IRP. Be very careful to not</span>
00412     <span class="comment">// assume that the last stack location is right after the end of the IRP,</span>
00413     <span class="comment">// as we may change this someday!</span>
00414     <span class="comment">//</span>
00415     irpSp = (<a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>(irp)-activeSize);
00416     RtlCopyMemory(surrogateIrp+1, irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>)*activeSize);
00417 
00418     <span class="comment">//</span>
00419     <span class="comment">// Zero the portion of the new IRP we won't be using (this should</span>
00420     <span class="comment">// eventually go away).</span>
00421     <span class="comment">//</span>
00422     RtlZeroMemory(
00423         ((<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>) (surrogateIrp+1))+activeSize,
00424         <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/io_8h.html#a373">IO_STACK_LOCATION</a>)*(surrogateIrp-&gt;StackCount - activeSize)
00425         );
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">// Now create a surrogate packet to track the new IRP.</span>
00429     <span class="comment">//</span>
00430     iovSurrogatePacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a8">IovpTrackingDataCreateAndLock</a>(surrogateIrp);
00431     <span class="keywordflow">if</span> (iovSurrogatePacket == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00432 
00433         <span class="comment">//</span>
00434         <span class="comment">// ADRIAO BUGBUG 02/11/1999 - Need to free IRP</span>
00435         <span class="comment">//</span>
00436         restoreHandle = <a class="code" href="../../d9/d8/hashirp_8h.html#a17">IovpProtectedIrpMakeUntouchable</a>(surrogateIrp, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00437         <a class="code" href="../../d9/d8/hashirp_8h.html#a19">IovpProtectedIrpFree</a>(surrogateIrp, restoreHandle);
00438         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00439     }
00440 
00441     headPacket = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a>;
00442 
00443     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o2">CallerIrql</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00444     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>(irp);
00445 
00446     <span class="comment">//</span>
00447     <span class="comment">// We will flag this bug later.</span>
00448     <span class="comment">//</span>
00449     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">// Let's take advantage of the original IRP not being the thing partied on</span>
00453     <span class="comment">// now; store a pointer to our tracking data in the information field. We</span>
00454     <span class="comment">// don't use this, but it's nice when debugging...</span>
00455     <span class="comment">//</span>
00456     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = (ULONG_PTR) iovPacket;
00457 
00458     <span class="comment">//</span>
00459     <span class="comment">// ADRIAO BUGBUG #28 06/10/98 - This is absolutely *gross*, and not</span>
00460     <span class="comment">//                              deterministic enough for my tastes.</span>
00461     <span class="comment">//</span>
00462     <span class="comment">// For IRP_MJ_SCSI (ie, IRP_MJ_INTERNAL_DEVICE_CONTROL), look and see</span>
00463     <span class="comment">// if we have an SRB coming through. If so, fake out the OriginalRequest</span>
00464     <span class="comment">// IRP pointer as appropriate.</span>
00465     <span class="comment">//</span>
00466     <span class="keywordflow">if</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a43">IRP_MJ_SCSI</a>) {
00467         srb = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Others.Argument1 ;
00468         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d5/ioassert_8h.html#a113">IopIsMemoryRangeReadable</a>(srb, SCSI_REQUEST_BLOCK_SIZE)) {
00469             <span class="keywordflow">if</span> ((srb-&gt;Length == SCSI_REQUEST_BLOCK_SIZE)&amp;&amp;(srb-&gt;OriginalRequest == irp)) {
00470                 srb-&gt;OriginalRequest = surrogateIrp ;
00471                 headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a32">TRACKFLAG_SRB_MUNGED</a> ;
00472             }
00473         }
00474     }
00475 
00476     <span class="comment">//</span>
00477     <span class="comment">// Since the replacement will never make it back to user mode (the real</span>
00478     <span class="comment">// IRP shall of course), we will steal a field or two for debugging info.</span>
00479     <span class="comment">//</span>
00480     surrogateIrp-&gt;UserIosb = (PIO_STATUS_BLOCK) iovPacket ;
00481 
00482     <span class="comment">//</span>
00483     <span class="comment">// Now that everything is built correctly, attach the surrogate. The</span>
00484     <span class="comment">// surrogate holds down the packet we are attaching to. When the surrogate</span>
00485     <span class="comment">// dies we will remove this reference.</span>
00486     <span class="comment">//</span>
00487     <a class="code" href="../../d9/d8/hashirp_8h.html#a13">IovpTrackingDataReference</a>(iovPacket, <a class="code" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>);
00488 
00489     <span class="comment">//</span>
00490     <span class="comment">// Stamp IRPs appropriately.</span>
00491     <span class="comment">//</span>
00492     surrogateIrp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a24">IRP_DIAG_IS_SURROGATE</a>;
00493     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a23">IRP_DIAG_HAS_SURROGATE</a>;
00494 
00495     <span class="comment">//</span>
00496     <span class="comment">// Mark packet as surrogate and inherit appropriate fields from iovPacket.</span>
00497     <span class="comment">//</span>
00498     iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a26">TRACKFLAG_SURROGATE</a> | <a class="code" href="../../d9/d4/trackirp_8h.html#a25">TRACKFLAG_ACTIVE</a>;
00499     iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o21">pIovSessionData</a> = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o21">pIovSessionData</a>;
00500     iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a> = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>;
00501     iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a> = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a>;
00502     iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o18">LastLocation</a> = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o18">LastLocation</a>;
00503     iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o16">TopStackLocation</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>;
00504 
00505     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a27">TRACKFLAG_HAS_SURROGATE</a>;
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// Fix up IRQL's so spinlocks are released in the right order. Link'm.</span>
00509     <span class="comment">//</span>
00510     iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o2">CallerIrql</a> = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o2">CallerIrql</a>;
00511     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o2">CallerIrql</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>;
00512     InsertTailList(
00513         &amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a>-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o7">SurrogateLink</a>,
00514         &amp;iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o7">SurrogateLink</a>
00515         );
00516 
00517     *IovPacketPointer = iovSurrogatePacket;
00518     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00519 }
00520 
00521 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00522 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00523"></a><a class="code" href="../../d6/d7/sessnirp_8h.html#a7">00523</a> <a class="code" href="../../d6/d7/sessnirp_8h.html#a7">IovpSessionDataFinalizeSurrogate</a>(
00524     IN      <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a>    IovSessionData,
00525     IN OUT  <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>  IovPacket,
00526     IN      <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>                 SurrogateIrp
00527     )
00528 <span class="comment">/*++</span>
00529 <span class="comment"></span>
00530 <span class="comment">  Description:</span>
00531 <span class="comment"></span>
00532 <span class="comment">    This routine removes the flags from both the real and</span>
00533 <span class="comment">    surrogate IRP and records the final IRP settings. Finally,</span>
00534 <span class="comment">    the surrogate IRP is made "untouchable" (decommitted).</span>
00535 <span class="comment"></span>
00536 <span class="comment">  Arguments:</span>
00537 <span class="comment"></span>
00538 <span class="comment">    iovPacket              - Pointer to the IRP tracking data.</span>
00539 <span class="comment"></span>
00540 <span class="comment">  Return Value:</span>
00541 <span class="comment"></span>
00542 <span class="comment">     None.</span>
00543 <span class="comment">--*/</span>
00544 {
00545     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPrevPacket;
00546     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status, lockedStatus;
00547     ULONG nonInterestingFlags;
00548     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00549     PVOID restoreHandle;
00550     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00551 
00552     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IovPacket-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a26">TRACKFLAG_SURROGATE</a>);
00553 
00554     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d8/hashirp_8h.html#a16">IovpTrackingDataGetCurrentSessionData</a>(IovPacket) == IovSessionData);
00555 
00556     <span class="comment">//</span>
00557     <span class="comment">// It's a surrogate, do as appropriate.</span>
00558     <span class="comment">//</span>
00559     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IovPacket-&gt;TopStackLocation == SurrogateIrp-&gt;CurrentLocation+1) ;
00560 
00561     iovPrevPacket = CONTAINING_RECORD(
00562         IovPacket-&gt;SurrogateLink.Blink,
00563         <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">IOV_REQUEST_PACKET</a>,
00564         SurrogateLink
00565         );
00566 
00567     irp = iovPrevPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o0">TrackedIrp</a>;
00568 
00569     <span class="comment">//</span>
00570     <span class="comment">// Carry the pending bit over.</span>
00571     <span class="comment">//</span>
00572     <span class="keywordflow">if</span> (SurrogateIrp-&gt;PendingReturned) {
00573         <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>(irp);
00574     }
00575 
00576     nonInterestingFlags = (
00577         <a class="code" href="../../d9/d4/trackirp_8h.html#a19">IRPFLAG_EXAMINE_MASK</a> |
00578         <a class="code" href="../../d9/d4/trackirp_8h.html#a24">IRP_DIAG_IS_SURROGATE</a>|
00579         <a class="code" href="../../d9/d4/trackirp_8h.html#a23">IRP_DIAG_HAS_SURROGATE</a>
00580         );
00581 
00582     <span class="comment">//</span>
00583     <span class="comment">// Wipe the flags nice and clean</span>
00584     <span class="comment">//</span>
00585     SurrogateIrp-&gt;Flags &amp;=~ IRP_DIAG_IS_SURROGATE;
00586     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>          &amp;=~ IRP_DIAG_HAS_SURROGATE;
00587 
00588     <span class="comment">//</span>
00589     <span class="comment">// ASSERT portions of the IRP header have not changed.</span>
00590     <span class="comment">//</span>
00591     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> == SurrogateIrp-&gt;StackCount); <span class="comment">// Later to be removed</span>
00592 
00593     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o0">Type</a> == SurrogateIrp-&gt;Type);
00594     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> == SurrogateIrp-&gt;RequestorMode);
00595     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o16">ApcEnvironment</a> == SurrogateIrp-&gt;ApcEnvironment);
00596     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> == SurrogateIrp-&gt;AllocationFlags);
00597     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> == SurrogateIrp-&gt;UserBuffer);
00598     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread == SurrogateIrp-&gt;Tail.Overlay.Thread);
00599 
00600     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(
00601         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine ==
00602         SurrogateIrp-&gt;Overlay.AsynchronousParameters.UserApcRoutine
00603         );
00604 
00605     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(
00606         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcContext ==
00607         SurrogateIrp-&gt;Overlay.AsynchronousParameters.UserApcContext
00608         );
00609 
00610     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(
00611         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject ==
00612         SurrogateIrp-&gt;Tail.Overlay.OriginalFileObject
00613         );
00614 
00615     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(
00616         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer ==
00617         SurrogateIrp-&gt;Tail.Overlay.AuxiliaryBuffer
00618         );
00619 
00620 <span class="comment">/*</span>
00621 <span class="comment">    ASSERT(</span>
00622 <span class="comment">        irp-&gt;AssociatedIrp.SystemBuffer ==</span>
00623 <span class="comment">        SurrogateIrp-&gt;AssociatedIrp.SystemBuffer</span>
00624 <span class="comment">        );</span>
00625 <span class="comment"></span>
00626 <span class="comment">    ASSERT(</span>
00627 <span class="comment">        (irp-&gt;Flags          &amp; ~nonInterestingFlags) ==</span>
00628 <span class="comment">        (SurrogateIrp-&gt;Flags &amp; ~nonInterestingFlags)</span>
00629 <span class="comment">        );</span>
00630 <span class="comment"></span>
00631 <span class="comment">    ASSERT(irp-&gt;MdlAddress == SurrogateIrp-&gt;MdlAddress);</span>
00632 <span class="comment">*/</span>
00633     <span class="comment">//</span>
00634     <span class="comment">// ADRIAO BUGBUG 02/28/1999 -</span>
00635     <span class="comment">//     How do these change as an IRP progresses?</span>
00636     <span class="comment">//</span>
00637     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= SurrogateIrp-&gt;Flags;
00638     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = SurrogateIrp-&gt;MdlAddress;
00639     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = SurrogateIrp-&gt;AssociatedIrp.SystemBuffer;
00640 
00641     <span class="keywordflow">if</span> ((irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>&amp;<a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>)&amp;&amp;
00642         (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00643 
00644         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp;=~ IRP_DEALLOCATE_BUFFER;
00645     }
00646 
00647     <span class="comment">//</span>
00648     <span class="comment">// Copy the salient fields back. We only need to touch certain areas of the</span>
00649     <span class="comment">// header.</span>
00650     <span class="comment">//</span>
00651     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a> = SurrogateIrp-&gt;IoStatus;
00652     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> = SurrogateIrp-&gt;PendingReturned;
00653     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a> = SurrogateIrp-&gt;Cancel;
00654 
00655     iovPrevPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> &amp;=~ TRACKFLAG_HAS_SURROGATE;
00656 
00657     <span class="comment">//</span>
00658     <span class="comment">// Record data from it and make the system fault if the IRP is touched</span>
00659     <span class="comment">// after this completion routine.</span>
00660     <span class="comment">//</span>
00661     IovSessionData-&gt;BestVisibleIrp = irp;
00662 
00663     <a class="code" href="../../d9/d8/hashirp_8h.html#a14">IovpTrackingDataDereference</a>(iovPrevPacket, <a class="code" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>);
00664 
00665     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IovPacket-&gt;PointerCount == 0);
00666 
00667     restoreHandle = <a class="code" href="../../d9/d8/hashirp_8h.html#a17">IovpProtectedIrpMakeUntouchable</a>(SurrogateIrp, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00668     <a class="code" href="../../d9/d8/hashirp_8h.html#a19">IovpProtectedIrpFree</a>(SurrogateIrp, &amp;restoreHandle);
00669 }
00670 <span class="preprocessor">#endif // NO_SPECIAL_IRP</span>
00671 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
