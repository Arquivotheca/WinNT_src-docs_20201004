<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: devprop.cpp Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>devprop.cpp</h1><a href="../../d5/d7/devprop_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/******************************************************************************</span>
00002 <span class="comment"></span>
00003 <span class="comment">  Source File:  Device Profile Management .CPP</span>
00004 <span class="comment"></span>
00005 <span class="comment">  Change History:</span>
00006 <span class="comment"></span>
00007 <span class="comment"></span>
00008 <span class="comment">  Implements the class which provides the various device profile management UI</span>
00009 <span class="comment"></span>
00010 <span class="comment">  Copyright (c) 1996 by Microsoft Corporation</span>
00011 <span class="comment"></span>
00012 <span class="comment">  A Pretty Penny Enterprises, Inc. Production</span>
00013 <span class="comment">  11-27-96  a-RobKj@microsoft.com coded it</span>
00014 <span class="comment"></span>
00015 <span class="comment">******************************************************************************/</span>
00016 
00017 <span class="preprocessor">#include    "ICMUI.H"</span>
00018 
00019 <span class="comment">//</span>
00020 <span class="comment">// This function is obtained from the April 1998 Knowledge Base</span>
00021 <span class="comment">// Its purpose is to determine if the current user is an</span>
00022 <span class="comment">// Administrator and therefore priveledged to change profile</span>
00023 <span class="comment">// settings.</span>
00024 <span class="comment">//</span>
00025 <span class="comment">// BOOL IsAdmin(void)</span>
00026 <span class="comment">//</span>
00027 <span class="comment">//      returns TRUE if user is an admin</span>
00028 <span class="comment">//              FALSE if user is not an admin</span>
00029 <span class="comment">//</span>
00030 
00031 <span class="preprocessor">#if defined(_WIN95_)</span>
00032 <span class="preprocessor"></span>
00033 <span class="comment">//</span>
00034 <span class="comment">// Always administrator on Windows 9x platform.</span>
00035 <span class="comment">//</span>
00036 
00037 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d7/devprop_8cpp.html#a5">IsAdmin</a>(<span class="keywordtype">void</span>) {
00038 
00039     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00040 }
00041 
00042 <span class="preprocessor">#else</span>
00043 <span class="preprocessor"></span>
<a name="l00044"></a><a class="code" href="../../d5/d7/devprop_8cpp.html#a5">00044</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d7/devprop_8cpp.html#a5">IsAdmin</a>(<span class="keywordtype">void</span>)
00045 {
00046     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   fReturn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00047     PSID   psidAdmin;
00048     
00049     SID_IDENTIFIER_AUTHORITY SystemSidAuthority= SECURITY_NT_AUTHORITY;
00050     
00051     <span class="keywordflow">if</span> ( AllocateAndInitializeSid ( &amp;SystemSidAuthority, 2, 
00052             SECURITY_BUILTIN_DOMAIN_RID, 
00053             DOMAIN_ALIAS_RID_ADMINS,
00054             0, 0, 0, 0, 0, 0, &amp;psidAdmin) )
00055     {
00056         <span class="keywordflow">if</span>(!CheckTokenMembership( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, psidAdmin, &amp;fReturn )) {
00057 
00058           <span class="comment">//</span>
00059           <span class="comment">// explicitly disallow Admin Access if CheckTokenMembership fails.</span>
00060           <span class="comment">// </span>
00061 
00062           fReturn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00063         }
00064         FreeSid ( psidAdmin);
00065     }
00066     
00067     <span class="keywordflow">return</span> ( fReturn );
00068 }
00069 
00070 <span class="preprocessor">#endif // _WIN95_</span>
00071 <span class="preprocessor"></span>
00072 <span class="comment">/******************************************************************************</span>
00073 <span class="comment"></span>
00074 <span class="comment">  List Managment functions</span>
00075 <span class="comment"></span>
00076 <span class="comment">  The method used here is simlar to that used in the profile Managment sheets</span>
00077 <span class="comment">  for managing device associations.</span>
00078 <span class="comment"></span>
00079 <span class="comment">  We (not royal, I mean the OS and I) manage two "to-do" lists and use these</span>
00080 <span class="comment">  to show the user the anticipated result of these lists being applied.  The</span>
00081 <span class="comment">  first list is a list of existing associations that are to be broken.  The</span>
00082 <span class="comment">  second is one of new associations to be made.  This is coupled with a list</span>
00083 <span class="comment">  of the current associations.</span>
00084 <span class="comment"></span>
00085 <span class="comment">  The "Removals" list is the indices of existing associations which will be</span>
00086 <span class="comment">  borken.  The "Adds" list is a list of new profiles to be associated.  The</span>
00087 <span class="comment">  "Profiles" list is the list of existing associations.</span>
00088 <span class="comment"></span>
00089 <span class="comment">  Adding and removing profiles could mean removing an item from one of the work</span>
00090 <span class="comment">  lists (undoing a previous selection), or adding one.  Each time such a change</span>
00091 <span class="comment">  is made, the profile list box is emptied and refilled.  This lets us avoid</span>
00092 <span class="comment">  mapping removals and additions more directly.</span>
00093 <span class="comment"></span>
00094 <span class="comment">  When changes are commited, either with Apply or OK, we make or break</span>
00095 <span class="comment">  associations as specified, then empty all of the lists, and rebuild the list</span>
00096 <span class="comment">  of current associations.</span>
00097 <span class="comment"></span>
00098 <span class="comment">  We use the ITEMDATA of the UI list box to handle the associations.  This lets</span>
00099 <span class="comment">  the list remain sorted.</span>
00100 <span class="comment"></span>
00101 <span class="comment">  All of the list management functions can be overriden, if needed.</span>
00102 <span class="comment"></span>
00103 <span class="comment">******************************************************************************/</span>
00104 
<a name="l00105"></a><a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b0">00105</a> <span class="keywordtype">void</span>    <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b0">CDeviceProfileManagement::InitList</a>() {
00106 
00107     <span class="comment">//  Make sure the lists are empty.</span>
00108 
00109     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p0">m_cuaRemovals</a>.<a class="code" href="../../d3/d7/classCUintArray.html#a6">Empty</a>();
00110     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p1">m_cpaAdds</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a6">Empty</a>();
00111 
00112     <span class="comment">//  Determine the associations for the target device.</span>
00113 
00114     ENUMTYPE    et = {<span class="keyword">sizeof</span> et, ENUM_TYPE_VERSION, ET_DEVICENAME, <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p3">m_csDevice</a>};
00115 
00116     CProfile::Enumerate(et, <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p2">m_cpaProfile</a>);
00117 }
00118 
00119 <span class="comment">//  Fill the UI list of profiles</span>
00120 
<a name="l00121"></a><a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b1">00121</a> <span class="keywordtype">void</span>    <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b1">CDeviceProfileManagement::FillList</a>(DWORD <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>) {
00122 
00123     <span class="comment">//  Before reset list box, get current selection to restore later.</span>
00124 
00125     <a class="code" href="../../d1/d7/classCString.html">CString</a> csSelect;
00126 
00127     csSelect.<a class="code" href="../../d1/d7/classCString.html#a6">Empty</a>();
00128 
00129     LRESULT idSelect = LB_ERR;
00130 
00131     <span class="keywordflow">if</span> ( !(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d6/d7/devprop_8h.html#a3">DEVLIST_NOSELECT</a>)) {
00132 
00133         <span class="comment">//  Get current selected position.</span>
00134 
00135         idSelect = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p4">m_hwndList</a>, LB_GETCURSEL, 0, 0);
00136 
00137         <span class="comment">//  Get text length where currently selected, than allocate buffer for that.</span>
00138 
00139         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwLen = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p4">m_hwndList</a>, LB_GETTEXTLEN, idSelect, 0);
00140         TCHAR  *pszSelect = <span class="keyword">new</span> TCHAR[dwLen + 1];
00141 
00142         <span class="comment">//  Get text itself.</span>
00143     
00144         <span class="keywordflow">if</span> (pszSelect != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00145 
00146             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p4">m_hwndList</a>, LB_GETTEXT, idSelect, (LPARAM) pszSelect) != LB_ERR) {
00147                 csSelect = pszSelect;
00148             }
00149 
00150             <span class="keyword">delete</span> pszSelect;
00151         }
00152     }
00153 
00154     <span class="comment">//  reset list box</span>
00155 
00156     <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p4">m_hwndList</a>, LB_RESETCONTENT, 0, 0);
00157 
00158     <span class="comment">//  Fill the profile list box from the list of profiles</span>
00159 
00160     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> u = 0; u &lt; <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p2">m_cpaProfile</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>(); u++) {
00161 
00162         <span class="comment">//  Don't list profiles tentatively disassociated...</span>
00163 
00164         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> uOut = 0; uOut &lt; <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p0">m_cuaRemovals</a>.<a class="code" href="../../d3/d7/classCUintArray.html#a2">Count</a>(); uOut++)
00165             <span class="keywordflow">if</span>  (<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p0">m_cuaRemovals</a>[uOut] == u)
00166                 <span class="keywordflow">break</span>;
00167 
00168         <span class="keywordflow">if</span>  (uOut &lt; <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p0">m_cuaRemovals</a>.<a class="code" href="../../d3/d7/classCUintArray.html#a2">Count</a>())
00169             <span class="keywordflow">continue</span>;   <span class="comment">//  Don't add this to list, it's been zapped!</span>
00170 
00171         LRESULT <span class="keywordtype">id</span> = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p4">m_hwndList</a>, LB_ADDSTRING, 0,
00172             (LPARAM) (LPCTSTR) <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p2">m_cpaProfile</a>[u] -&gt; GetName());
00173 
00174         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p4">m_hwndList</a>, LB_SETITEMDATA, <span class="keywordtype">id</span>, u);
00175     }
00176 
00177     <span class="comment">//  Add the profiles that have been tentatively added...</span>
00178 
00179     <span class="keywordflow">for</span> (u = 0; u &lt; <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p1">m_cpaAdds</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>(); u ++) {
00180         LRESULT <span class="keywordtype">id</span> = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p4">m_hwndList</a>, LB_ADDSTRING, 0,
00181             (LPARAM) (LPCTSTR) <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p1">m_cpaAdds</a>[u] -&gt; GetName());
00182         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p4">m_hwndList</a>, LB_SETITEMDATA, <span class="keywordtype">id</span>, u + <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p2">m_cpaProfile</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>());
00183     }
00184 
00185     <span class="comment">//  If we have any profiles, select the first one</span>
00186     <span class="comment">//  Otherwise, disable the "Remove" button, as there's nothing to remove</span>
00187 
00188     <span class="keywordtype">unsigned</span> itemCount = (<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p2">m_cpaProfile</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() + <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p1">m_cpaAdds</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() - <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p0">m_cuaRemovals</a>.<a class="code" href="../../d3/d7/classCUintArray.html#a2">Count</a>());
00189 
00190     <span class="keywordflow">if</span>  (itemCount) {
00191 
00192         <span class="comment">// The Remove button must remain disabled</span>
00193         <span class="comment">// unless the user is Administrator.</span>
00194         <span class="comment">// This code is specific to the Monitor Profile</span>
00195         <span class="comment">// Property sheet.</span>
00196 
00197         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p6">m_bReadOnly</a>) {
00198             <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a58">RemoveButton</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00199         }
00200 
00201         <span class="keywordflow">if</span> ( !(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d6/d7/devprop_8h.html#a3">DEVLIST_NOSELECT</a>)) {
00202 
00203             <span class="comment">// Find out the string selected previously.</span>
00204 
00205             idSelect = LB_ERR;
00206 
00207             <span class="keywordflow">if</span> (!csSelect.<a class="code" href="../../d1/d7/classCString.html#a5">IsEmpty</a>()) {
00208                 idSelect = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p4">m_hwndList</a>, LB_FINDSTRINGEXACT,
00209                                        (WPARAM) -1, (LPARAM) (LPCTSTR) csSelect);
00210             }
00211 
00212             <span class="comment">// if could not find, just select first item.</span>
00213 
00214             <span class="keywordflow">if</span> (idSelect == LB_ERR) {
00215                 idSelect = 0;
00216             }
00217 
00218             <span class="comment">// Select it.</span>
00219 
00220             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p4">m_hwndList</a>, LB_SETCURSEL, idSelect, 0);
00221         }
00222 
00223     } <span class="keywordflow">else</span> {
00224 
00225         HWND hwndRemove = <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a58">RemoveButton</a>);
00226 
00227         <span class="comment">// If focus is on Remove, move it to Add button.</span>
00228 
00229         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/winmgrc_8c.html#a11">GetFocus</a>() == hwndRemove) {
00230 
00231             HWND hwndAdd = <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a57">AddButton</a>);
00232 
00233             <a class="code" href="../../d3/d0/user32_8def.html#a43">SetFocus</a>(hwndAdd);
00234             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndRemove, BM_SETSTYLE, BS_PUSHBUTTON, MAKELPARAM(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, 0));
00235             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndAdd, BM_SETSTYLE, BS_DEFPUSHBUTTON, MAKELPARAM(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, 0));
00236         }
00237 
00238         <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(hwndRemove, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00239     }
00240 
00241     <span class="comment">// Apply button needs to remain disabled unless the</span>
00242     <span class="comment">// user has permision to make changes - ie. user</span>
00243     <span class="comment">// is Administrator.</span>
00244 
00245     <span class="keywordflow">if</span>  ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d6/d7/devprop_8h.html#a2">DEVLIST_CHANGED</a>) &amp;&amp; !(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p6">m_bReadOnly</a>)) {
00246         <a class="code" href="../../d2/d6/classCPropertyPage.html#a3">EnableApplyButton</a>();
00247         <a class="code" href="../../d2/d6/classCPropertyPage.html#a5">SettingChanged</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00248     }
00249 }
00250 
<a name="l00251"></a><a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b2">00251</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b2">CDeviceProfileManagement::GetDeviceTypeString</a>(DWORD dwType,<a class="code" href="../../d1/d7/classCString.html">CString</a>&amp; csDeviceName) {
00252 
00253     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <span class="keywordtype">id</span>;
00254 
00255     <span class="keywordflow">switch</span> (dwType) {
00256 
00257     <span class="keywordflow">case</span> CLASS_MONITOR :
00258         <span class="keywordtype">id</span> = <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a16">ClassMonitorString</a>;
00259         <span class="keywordflow">break</span>;
00260     <span class="keywordflow">case</span> CLASS_PRINTER :
00261         <span class="keywordtype">id</span> = <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a17">ClassPrinterString</a>;
00262         <span class="keywordflow">break</span>;
00263     <span class="keywordflow">case</span> CLASS_SCANNER :
00264         <span class="keywordtype">id</span> = <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a18">ClassScannerString</a>;
00265         <span class="keywordflow">break</span>;
00266     <span class="keywordflow">case</span> CLASS_LINK :
00267         <span class="keywordtype">id</span> = <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a19">ClassLinkString</a>;
00268         <span class="keywordflow">break</span>;
00269     <span class="keywordflow">case</span> CLASS_ABSTRACT :
00270         <span class="keywordtype">id</span> = <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a20">ClassAbstractString</a>;
00271         <span class="keywordflow">break</span>;
00272     <span class="keywordflow">case</span> CLASS_NAMED :
00273         <span class="keywordtype">id</span> = <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a22">ClassNamedString</a>;
00274         <span class="keywordflow">break</span>;
00275     <span class="keywordflow">case</span> CLASS_COLORSPACE :
00276     <span class="keywordflow">default</span> :
00277         <span class="keywordtype">id</span> = <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a21">ClassColorSpaceString</a>;
00278         <span class="keywordflow">break</span>;
00279     }
00280 
00281     <span class="comment">// Load string.</span>
00282 
00283     csDeviceName.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(<span class="keywordtype">id</span>);
00284 }
00285 
00286 <span class="comment">//  Constructor</span>
00287 
<a name="l00288"></a><a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#a0">00288</a> <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#a0">CDeviceProfileManagement::CDeviceProfileManagement</a>(LPCTSTR lpstrDevice,
00289                                                    HINSTANCE hiWhere,
00290                                                    <span class="keywordtype">int</span> idPage, DWORD dwType) {
00291         <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p3">m_csDevice</a> = lpstrDevice;
00292     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#r0">m_dwType</a> = dwType;
00293     m_psp.hInstance = hiWhere;
00294     m_psp.pszTemplate = MAKEINTRESOURCE(idPage);
00295 
00296     <span class="comment">//  Setting m_bReadOnly to false enables functionality</span>
00297 
00298     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p6">m_bReadOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;        <span class="comment">// default setting is false</span>
00299 
00300 <span class="preprocessor">#if defined(_WIN95_)</span>
00301 <span class="preprocessor"></span>
00302     <span class="comment">//</span>
00303     <span class="comment">// There is no way to detect printer supports CMYK or not on Win 9x.</span>
00304 
00305     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p5">m_bCMYK</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00306 
00307 <span class="preprocessor">#else</span>
00308 <span class="preprocessor"></span>
00309     <span class="comment">//  we need to check the device capabilities</span>
00310     <span class="comment">//  and determine if we're trying to associate</span>
00311     <span class="comment">//  a cmyk printer profile to a printer that</span>
00312     <span class="comment">//  doesn't support it.</span>
00313 
00314     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p5">m_bCMYK</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;            <span class="comment">// default setting - don't support cmyk</span>
00315 
00316     <span class="comment">//  if the device is a printer</span>
00317 
00318     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#r0">m_dwType</a> == CLASS_PRINTER) {
00319 
00320         HDC hdcThis = CGlobals::GetPrinterHDC(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p3">m_csDevice</a>);
00321 
00322         <span class="comment">//  if the printer supports CMYK</span>
00323 
00324         <span class="keywordflow">if</span> (hdcThis) {
00325             <span class="keywordflow">if</span> (GetDeviceCaps(hdcThis, COLORMGMTCAPS) &amp; CM_CMYK_COLOR) {
00326                 <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p5">m_bCMYK</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00327             }
00328             DeleteDC(hdcThis);
00329         }
00330     }
00331 
00332 <span class="preprocessor">#endif // defined(_WIN95_)</span>
00333 <span class="preprocessor"></span>}
00334 
00335 <span class="comment">//  UI initialization</span>
00336 
<a name="l00337"></a><a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#a2">00337</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#a2">CDeviceProfileManagement::OnInit</a>() {
00338 
00339     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b0">InitList</a>();
00340 
00341     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p4">m_hwndList</a> = <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a64">ProfileListControl</a>);
00342 
00343     <span class="comment">//  Fill the profile list box</span>
00344 
00345     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b1">FillList</a>(<a class="code" href="../../d6/d7/devprop_8h.html#a1">DEVLIST_ONINIT</a>);
00346 
00347     <span class="comment">//  Disable apply button as default.</span>
00348 
00349     <a class="code" href="../../d2/d6/classCPropertyPage.html#a4">DisableApplyButton</a>();
00350 
00351     <span class="comment">//  Nothing changed, yet.</span>
00352 
00353     <a class="code" href="../../d2/d6/classCPropertyPage.html#a5">SettingChanged</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00354 
00355     <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00356 }
00357 
00358 <span class="comment">//  Command processing</span>
00359 
<a name="l00360"></a><a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#a3">00360</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#a3">CDeviceProfileManagement::OnCommand</a>(WORD wNotifyCode, WORD wid,
00361                                              HWND hwndCtl) {
00362 
00363     <span class="keywordflow">switch</span>  (wNotifyCode) {
00364 
00365         <span class="keywordflow">case</span>    BN_CLICKED:
00366 
00367             <span class="keywordflow">switch</span>  (wid) {
00368 
00369                 <span class="keywordflow">case</span>    <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a57">AddButton</a>: {
00370 
00371                     <span class="keywordtype">unsigned</span> i = 0, u = 0;
00372 
00373                     <span class="comment">//  Time to do the old OpenFile dialog stuff...</span>
00374 
00375                     <a class="code" href="../../d5/d1/classCAddProfileDialog.html">CAddProfileDialog</a> capd(m_hwnd, m_psp.hInstance);
00376 
00377                     <span class="comment">//  See if a profile was selected</span>
00378 
00379                     <span class="keywordflow">while</span>(i &lt; capd.<a class="code" href="../../d5/d1/classCAddProfileDialog.html#a2">ProfileCount</a>()) {
00380 
00381                         <span class="comment">//  Check profile validity and device type</span>
00382 
00383                         <a class="code" href="../../d7/d5/classCProfile.html">CProfile</a> cpTemp(capd.<a class="code" href="../../d5/d1/classCAddProfileDialog.html#a3">ProfileName</a>(i));
00384 
00385                         <span class="comment">//  CLASS_COLORSPACE and CLASS_MONITOR can be associated to</span>
00386                         <span class="comment">//  any device. Other (CLASS_SCANNER, CLASS_PRINTER) only</span>
00387                         <span class="comment">//  can be associated to much device.</span>
00388 
00389                         <span class="keywordflow">if</span> (    !cpTemp.<a class="code" href="../../d7/d5/classCProfile.html#a7">IsValid</a>() <span class="comment">// Wrong profile type or invalid?</span>
00390                              || (   cpTemp.<a class="code" href="../../d7/d5/classCProfile.html#a3">GetType</a>() != <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#r0">m_dwType</a>
00391                                  &amp;&amp; cpTemp.<a class="code" href="../../d7/d5/classCProfile.html#a3">GetType</a>() != CLASS_COLORSPACE
00392 <span class="preprocessor">                        #if 1 // ALLOW_MONITOR_PROFILE_TO_ANY_DEVICE</span>
00393 <span class="preprocessor"></span>                                 &amp;&amp; cpTemp.<a class="code" href="../../d7/d5/classCProfile.html#a3">GetType</a>() != CLASS_MONITOR
00394 <span class="preprocessor">                        #endif</span>
00395 <span class="preprocessor"></span>                                )
00396                            ) {
00397 
00398                             <span class="comment">//  Throw up a message box to inform the user of this</span>
00399 
00400                             <span class="keywordflow">if</span> (cpTemp.<a class="code" href="../../d7/d5/classCProfile.html#a7">IsValid</a>())
00401                             {
00402                                 <a class="code" href="../../d1/d7/classCString.html">CString</a> csDeviceType;  <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b2">GetDeviceTypeString</a>(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#r0">m_dwType</a>,csDeviceType);
00403                                 <a class="code" href="../../d1/d7/classCString.html">CString</a> csProfileType; <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b2">GetDeviceTypeString</a>(cpTemp.<a class="code" href="../../d7/d5/classCProfile.html#a3">GetType</a>(),csProfileType);
00404 
00405                                 CGlobals::ReportEx(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a29">MismatchDeviceType</a>, m_hwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00406                                                MB_OK|MB_ICONEXCLAMATION, 3,
00407                                                (LPTSTR)capd.<a class="code" href="../../d5/d1/classCAddProfileDialog.html#a4">ProfileNameAndExtension</a>(i),
00408                                                (LPTSTR)csProfileType,
00409                                                (LPTSTR)csDeviceType);
00410                             }
00411                             <span class="keywordflow">else</span>
00412                             {
00413                                 CGlobals::ReportEx(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a30">InstFailedWithName</a>, m_hwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00414                                                MB_OK|MB_ICONEXCLAMATION, 1,
00415                                                (LPTSTR)capd.<a class="code" href="../../d5/d1/classCAddProfileDialog.html#a4">ProfileNameAndExtension</a>(i));
00416                             }
00417 
00418                             <span class="keywordflow">goto</span> SkipToNext;
00419                         }
00420 
00421                         <span class="comment">//  See if the profile has already been listed for addition</span>
00422 
00423                         <span class="keywordflow">for</span> (u = 0; u &lt; <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p1">m_cpaAdds</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>(); u++) {
00424                             <span class="keywordflow">if</span>  (!lstrcmpi(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p1">m_cpaAdds</a>[u] -&gt; GetName(), cpTemp.<a class="code" href="../../d7/d5/classCProfile.html#a2">GetName</a>())) {
00425                                 <span class="keywordflow">goto</span> SkipToNext; <span class="comment">//  This profile is already added</span>
00426                             }
00427                         }
00428 
00429                         <span class="comment">//  If this profile is on the existing list, either ignore</span>
00430                         <span class="comment">//  or zap it from the removal list, as the case may be</span>
00431 
00432                         <span class="keywordflow">for</span> (u = 0; u &lt; <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p2">m_cpaProfile</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>(); u++) {
00433                             <span class="keywordflow">if</span>  (!lstrcmpi(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p2">m_cpaProfile</a>[u] -&gt; GetName(),
00434                                     cpTemp.<a class="code" href="../../d7/d5/classCProfile.html#a2">GetName</a>())) {
00435                                 <span class="comment">//  Is this one on the removal list?</span>
00436                                 <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> uOut = 0;
00437                                      uOut &lt; <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p0">m_cuaRemovals</a>.<a class="code" href="../../d3/d7/classCUintArray.html#a2">Count</a>();
00438                                      uOut++) {
00439                                     <span class="keywordflow">if</span>  (<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p0">m_cuaRemovals</a>[uOut] == u) {
00440                                         <span class="comment">//  Was to be removed- undo that...</span>
00441                                         <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p0">m_cuaRemovals</a>.<a class="code" href="../../d3/d7/classCUintArray.html#a5">Remove</a>(uOut);
00442                                         <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b1">FillList</a>(<a class="code" href="../../d6/d7/devprop_8h.html#a2">DEVLIST_CHANGED</a>);
00443                                         <span class="keywordflow">break</span>;
00444                                     }
00445                                 }
00446                                 <span class="keywordflow">goto</span> SkipToNext;
00447                             }   <span class="comment">//  End of name in existing list</span>
00448                         }
00449 
00450                         <span class="comment">//  We need to check the device capabilities</span>
00451                         <span class="comment">//  and determine if we're trying to associate</span>
00452                         <span class="comment">//  a cmyk printer profile to a printer that</span>
00453                         <span class="comment">//  doesn't support it.</span>
00454 
00455                         <span class="keywordflow">if</span>  ((!<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p5">m_bCMYK</a>) &amp;&amp; (cpTemp.<a class="code" href="../../d7/d5/classCProfile.html#a5">GetColorSpace</a>() == SPACE_CMYK)) {
00456                             CGlobals::ReportEx(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a37">UnsupportedProfile</a>, m_hwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00457                                                 MB_OK|MB_ICONEXCLAMATION, 2,
00458                                                 (LPTSTR)<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p3">m_csDevice</a>,
00459                                                 (LPTSTR)capd.<a class="code" href="../../d5/d1/classCAddProfileDialog.html#a4">ProfileNameAndExtension</a>(i));
00460                             <span class="keywordflow">goto</span> SkipToNext;
00461                         }
00462 
00463                         <span class="comment">//  Add this profile to the list, item (max orig + index)</span>
00464 
00465                         <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p1">m_cpaAdds</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a3">Add</a>(capd.<a class="code" href="../../d5/d1/classCAddProfileDialog.html#a3">ProfileName</a>(i));
00466 
00467                         <span class="comment">//  Change has been made, update the list</span>
00468 
00469                         <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b1">FillList</a>(<a class="code" href="../../d6/d7/devprop_8h.html#a2">DEVLIST_CHANGED</a>);
00470 SkipToNext:
00471                         i++;
00472                     }
00473 
00474                     <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00475                 }
00476 
00477                 <span class="keywordflow">case</span>    <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a58">RemoveButton</a>: {
00478 
00479                     <span class="comment">//  Remove the selected profile</span>
00480 
00481                     LRESULT <span class="keywordtype">id</span> = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p4">m_hwndList</a>, LB_GETCURSEL, 0, 0);
00482                     <span class="keywordtype">unsigned</span> u = (<span class="keywordtype">unsigned</span>) <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p4">m_hwndList</a>,
00483                         LB_GETITEMDATA, <span class="keywordtype">id</span>, 0);
00484 
00485                     <span class="comment">//  If this is a tentative add, just drop it, otherwise</span>
00486                     <span class="comment">//  note that it's been removed...</span>
00487 
00488                     <span class="keywordflow">if</span>  (u &gt;= <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p2">m_cpaProfile</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>())
00489                         <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p1">m_cpaAdds</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a5">Remove</a>(u - <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p2">m_cpaProfile</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>());
00490                     <span class="keywordflow">else</span>
00491                         <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p0">m_cuaRemovals</a>.<a class="code" href="../../d3/d7/classCUintArray.html#a3">Add</a>(u);
00492 
00493                     <span class="comment">//  That's it- just update the display, now...</span>
00494 
00495                     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b1">FillList</a>(<a class="code" href="../../d6/d7/devprop_8h.html#a2">DEVLIST_CHANGED</a>);
00496 
00497                     <span class="comment">// explicitly set the position of the current selection</span>
00498                     <span class="comment">// after the list has been recomputed.</span>
00499 
00500                     <span class="keywordtype">int</span> listsize = <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p2">m_cpaProfile</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>()+<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p1">m_cpaAdds</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>()-<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p0">m_cuaRemovals</a>.<a class="code" href="../../d3/d7/classCUintArray.html#a2">Count</a>();
00501                     <span class="keywordflow">if</span> (<span class="keywordtype">id</span> &gt;= listsize) <span class="keywordtype">id</span> = listsize-1;
00502                     <span class="keywordflow">if</span> (<span class="keywordtype">id</span> &lt; 0)         <span class="keywordtype">id</span> = 0;
00503                     <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p4">m_hwndList</a>, LB_SETCURSEL, <span class="keywordtype">id</span>, 0);
00504 
00505                     <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00506                 }
00507             }
00508             <span class="keywordflow">break</span>;
00509 
00510         <span class="keywordflow">case</span>    LBN_SELCHANGE: {
00511 
00512             LRESULT <span class="keywordtype">id</span> = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p4">m_hwndList</a>, LB_GETCURSEL, 0, 0);
00513                         
00514             <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == -1) {
00515                 <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a58">RemoveButton</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00516             } <span class="keywordflow">else</span> {
00517 
00518                 <span class="comment">// The Remove button must remain disabled on a monitor</span>
00519                 <span class="comment">// profile property page if the user isn't the</span>
00520                 <span class="comment">// Administrator, otherwise enable remove button.</span>
00521 
00522                 <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a58">RemoveButton</a>), !<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p6">m_bReadOnly</a>);
00523             }
00524 
00525             <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00526         }
00527     }
00528 
00529     <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00530 }
00531 
00532 <span class="comment">//  Property Sheet notification processing</span>
00533 
<a name="l00534"></a><a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#a4">00534</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#a4">CDeviceProfileManagement::OnNotify</a>(<span class="keywordtype">int</span> idCtrl, LPNMHDR pnmh) {
00535 
00536     <span class="keywordflow">switch</span>  (pnmh -&gt; code) {
00537 
00538         <span class="keywordflow">case</span>    PSN_APPLY:
00539 
00540             <a class="code" href="../../d2/d6/classCPropertyPage.html#a4">DisableApplyButton</a>();
00541 
00542             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/classCPropertyPage.html#a5">SettingChanged</a>()) {
00543 
00544                 <span class="comment">//  Apply the changes the user has made...</span>
00545 
00546                 <a class="code" href="../../d2/d6/classCPropertyPage.html#a5">SettingChanged</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00547 
00548                 <span class="keywordflow">while</span>   (<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p1">m_cpaAdds</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>()) {
00549                     <span class="keywordflow">if</span>  (!<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p1">m_cpaAdds</a>[0] -&gt; IsInstalled()) {
00550                         <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p1">m_cpaAdds</a>[0] -&gt; Install();
00551                     }
00552                     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p1">m_cpaAdds</a>[0] -&gt; Associate(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p3">m_csDevice</a>);
00553                     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p1">m_cpaAdds</a>.<a class="code" href="../../d8/d5/classCProfileArray.html#a5">Remove</a>(0);
00554                 }
00555 
00556                 <span class="comment">//  Now do the removals (actually just dissociations)</span>
00557 
00558                 <span class="keywordflow">while</span>   (<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p0">m_cuaRemovals</a>.<a class="code" href="../../d3/d7/classCUintArray.html#a2">Count</a>()) {
00559                     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p2">m_cpaProfile</a>[<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p0">m_cuaRemovals</a>[0]] -&gt; Dissociate(<a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#p3">m_csDevice</a>);
00560                     m_cuaRemovals.Remove(0);
00561                 }
00562 
00563                 <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b0">InitList</a>();
00564                 <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b1">FillList</a>();
00565 
00566                 <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(m_hwnd, DWLP_MSGRESULT, PSNRET_NOERROR);
00567             }
00568 
00569             <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00570     }
00571 
00572     <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00573 }
00574 
00575 <span class="comment">//  This hook procedure both forces the use of the old-style common dialog</span>
00576 <span class="comment">//  and changes the OK button to an Add button.  The actual button text is</span>
00577 <span class="comment">//  a string resource, and hence localizable.</span>
00578 
<a name="l00579"></a><a class="code" href="../../d5/d1/classCAddProfileDialog.html#h0">00579</a> UINT_PTR <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d5/d1/classCAddProfileDialog.html#h0">CAddProfileDialog::OpenFileHookProc</a>(HWND hDlg, <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uMessage,
00580                                                   WPARAM wp, LPARAM lp) {
00581     <span class="keywordflow">switch</span>  (uMessage) {
00582 
00583         <span class="keywordflow">case</span>    WM_INITDIALOG: {
00584 
00585             <a class="code" href="../../d1/d7/classCString.html">CString</a> csAddButton;
00586 
00587             OPENFILENAME    *pofn = (OPENFILENAME *) lp;
00588 
00589             csAddButton.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a10">AddButtonText</a>);
00590 
00591             <a class="code" href="../../d5/d9/cltxt_8h.html#a20">SetDlgItemText</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a13">GetParent</a>(hDlg), IDOK, csAddButton);
00592             <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00593         }
00594     }
00595 
00596     <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00597 }
00598 
00599 <span class="comment">//  Once again, a constructor that actually does most of the work!</span>
00600 
<a name="l00601"></a><a class="code" href="../../d5/d7/devprop_8cpp.html#a0">00601</a> TCHAR <a class="code" href="../../d5/d7/devprop_8cpp.html#a0">gacColorDir</a>[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>] = _TEXT(<span class="stringliteral">"\0"</span>);
<a name="l00602"></a><a class="code" href="../../d5/d7/devprop_8cpp.html#a1">00602</a> TCHAR <a class="code" href="../../d5/d7/devprop_8cpp.html#a1">gacFilter</a>[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>]   = _TEXT(<span class="stringliteral">"\0"</span>);
00603 
<a name="l00604"></a><a class="code" href="../../d5/d1/classCAddProfileDialog.html#a0">00604</a> <a class="code" href="../../d5/d1/classCAddProfileDialog.html#a0">CAddProfileDialog::CAddProfileDialog</a>(HWND hwndOwner, HINSTANCE hi) {
00605 
00606     TCHAR tempBuffer[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>*10];
00607 
00608     <span class="comment">// Empty the profile list.</span>
00609 
00610     <a class="code" href="../../d5/d1/classCAddProfileDialog.html#r0">csa_Files</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a6">Empty</a>();
00611 
00612     <span class="comment">// Prepare file filter (if not yet).</span>
00613 
00614     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d7/devprop_8cpp.html#a1">gacFilter</a>[0] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00615 
00616         ULONG offset; <span class="comment">/* 32bits is enough even for sundown */</span>
00617         <a class="code" href="../../d1/d7/classCString.html">CString</a> csIccFilter; <a class="code" href="../../d1/d7/classCString.html">CString</a> csAllFilter;
00618 
00619         <span class="comment">// If the filter is not built yet, build it here.</span>
00620 
00621         csIccFilter.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a34">IccProfileFilterString</a>);
00622         csAllFilter.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a35">AllProfileFilterString</a>);
00623         offset = 0;
00624         lstrcpy(<a class="code" href="../../d5/d7/devprop_8cpp.html#a1">gacFilter</a>+offset, csIccFilter);
00625         offset += lstrlen(csIccFilter)+1;
00626         lstrcpy(<a class="code" href="../../d5/d7/devprop_8cpp.html#a1">gacFilter</a>+offset, TEXT(<span class="stringliteral">"*.icm;*.icc"</span>));
00627         offset += lstrlen(TEXT(<span class="stringliteral">"*.icm;*.icc"</span>))+1;
00628         lstrcpy(<a class="code" href="../../d5/d7/devprop_8cpp.html#a1">gacFilter</a>+offset, csAllFilter);
00629         offset += lstrlen(csAllFilter)+1;
00630         lstrcpy(<a class="code" href="../../d5/d7/devprop_8cpp.html#a1">gacFilter</a>+offset, TEXT(<span class="stringliteral">"*.*"</span>));
00631         offset += lstrlen(TEXT(<span class="stringliteral">"*.*"</span>))+1;
00632         *(<a class="code" href="../../d5/d7/devprop_8cpp.html#a1">gacFilter</a>+offset) = TEXT(<span class="charliteral">'\0'</span>);
00633     }
00634 
00635     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d7/devprop_8cpp.html#a0">gacColorDir</a>[0] == _TEXT(<span class="charliteral">'\0'</span>))  {
00636         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwcbDir = <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>;
00637         GetColorDirectory(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d5/d7/devprop_8cpp.html#a0">gacColorDir</a>, &amp;dwcbDir);
00638     }
00639 
00640     <span class="comment">//  Time to do the old OpenFile dialog stuff...</span>
00641     <a class="code" href="../../d1/d7/classCString.html">CString</a> csTitle; csTitle.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a9">AddProfileAssociation</a>);
00642 
00643     <span class="comment">//  Set initial filename as null.</span>
00644     memset(tempBuffer, 0, <span class="keyword">sizeof</span> tempBuffer);
00645 
00646     OPENFILENAME ofn = {
00647         <span class="keyword">sizeof</span> ofn, hwndOwner, hi,
00648         <a class="code" href="../../d5/d7/devprop_8cpp.html#a1">gacFilter</a>,
00649         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 1,
00650         tempBuffer, <span class="keyword">sizeof</span> tempBuffer / <span class="keyword">sizeof</span> tempBuffer[0],
00651         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
00652         <a class="code" href="../../d5/d7/devprop_8cpp.html#a0">gacColorDir</a>,
00653         csTitle,
00654         OFN_ALLOWMULTISELECT | OFN_EXPLORER | OFN_HIDEREADONLY |
00655         OFN_FILEMUSTEXIST | OFN_PATHMUSTEXIST | OFN_ENABLEHOOK,
00656         0, 0,
00657         _TEXT(<span class="stringliteral">"icm"</span>),
00658         (LPARAM) <span class="keyword">this</span>, <a class="code" href="../../d5/d1/classCAddProfileDialog.html#h0">OpenFileHookProc</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>};
00659 
00660     <span class="keywordflow">if</span>  (!GetOpenFileName(&amp;ofn)) {
00661         <span class="keywordflow">if</span> (CommDlgExtendedError() == <a class="code" href="../../d6/d5/aug98_2test_2cderr_8h.html#a30">FNERR_BUFFERTOOSMALL</a>) {
00662             CGlobals::Report(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a36">TooManyFileSelected</a>);
00663         }
00664     } <span class="keywordflow">else</span> {
00665         <span class="keywordflow">if</span> (tempBuffer[0] != TEXT(<span class="charliteral">'\0'</span>)) {
00666 
00667             TCHAR *pPath = tempBuffer;
00668             TCHAR *pFile = tempBuffer + lstrlen(tempBuffer) + 1;
00669 
00670             <span class="comment">// remember the last access-ed directory.</span>
00671 
00672             memset(<a class="code" href="../../d5/d7/devprop_8cpp.html#a0">gacColorDir</a>, 0, <span class="keyword">sizeof</span> pPath);
00673             memcpy(<a class="code" href="../../d5/d7/devprop_8cpp.html#a0">gacColorDir</a>, pPath, ofn.nFileOffset*<span class="keyword">sizeof</span>(TCHAR));
00674 
00675             <span class="keywordflow">if</span> (*pFile) {
00676                 TCHAR workBuffer[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00677 
00678                 <span class="comment">// This is multiple-selection</span>
00679                 <span class="comment">// Work through the buufer to build profile file list.</span>
00680 
00681                 <span class="keywordflow">while</span> (*pFile) {
00682 
00683                     lstrcpy(workBuffer,pPath);
00684                     lstrcat(workBuffer,TEXT(<span class="stringliteral">"\\"</span>));
00685                     lstrcat(workBuffer,pFile);
00686 
00687                     <span class="comment">// Insert built profile pathname</span>
00688                     <a class="code" href="../../d5/d1/classCAddProfileDialog.html#a5">AddProfile</a>(workBuffer);
00689 
00690                     <span class="comment">// Move on to next.</span>
00691                     pFile = pFile + lstrlen(pFile) + 1;
00692                 }
00693             }
00694             <span class="keywordflow">else</span> {
00695                 <span class="comment">// Single selection case.</span>
00696                 <a class="code" href="../../d5/d1/classCAddProfileDialog.html#a5">AddProfile</a>(pPath);
00697 
00698 <span class="preprocessor">                #if HIDEYUKN_DBG</span>
00699 <span class="preprocessor"></span>                MessageBox(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,pPath,TEXT(<span class="stringliteral">""</span>),MB_OK);
00700 <span class="preprocessor">                #endif</span>
00701 <span class="preprocessor"></span>            }
00702         }
00703     }
00704 
00705     <span class="keywordflow">return</span>;
00706 }
00707 
00708 <span class="comment">//  Printer Profile Management</span>
00709 
<a name="l00710"></a><a class="code" href="../../d5/d7/devprop_8cpp.html#a2">00710</a> CONST <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d7/devprop_8cpp.html#a2">PrinterUIHelpIds</a>[] = {
00711     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a57">AddButton</a>,              <a class="code" href="../../d3/d9/icmuihlp_8h.html#a7">IDH_PRINTERUI_ADD</a>,
00712     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a58">RemoveButton</a>,           <a class="code" href="../../d3/d9/icmuihlp_8h.html#a9">IDH_PRINTERUI_REMOVE</a>,
00713     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a64">ProfileListControl</a>,     <a class="code" href="../../d3/d9/icmuihlp_8h.html#a11">IDH_PRINTERUI_LIST</a>,
00714 
00715 <span class="preprocessor">#if !defined(_WIN95_)</span>
00716 <span class="preprocessor"></span>    <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a65">ProfileListControlText</a>, <a class="code" href="../../d3/d9/icmuihlp_8h.html#a11">IDH_PRINTERUI_LIST</a>,
00717     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a67">PrinterUIIcon</a>,          <a class="code" href="../../d3/d9/icmuihlp_8h.html#a1">IDH_DISABLED</a>,
00718     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a66">DescriptionText</a>,        <a class="code" href="../../d3/d9/icmuihlp_8h.html#a1">IDH_DISABLED</a>,
00719     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a59">DefaultButton</a>,          <a class="code" href="../../d3/d9/icmuihlp_8h.html#a15">IDH_PRINTERUI_DEFAULTBTN</a>,
00720     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a60">AutoSelButton</a>,          <a class="code" href="../../d3/d9/icmuihlp_8h.html#a12">IDH_PRINTERUI_AUTOMATIC</a>,
00721     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a68">AutoSelText</a>,            <a class="code" href="../../d3/d9/icmuihlp_8h.html#a12">IDH_PRINTERUI_AUTOMATIC</a>,
00722     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a61">ManualSelButton</a>,        <a class="code" href="../../d3/d9/icmuihlp_8h.html#a13">IDH_PRINTERUI_MANUAL</a>,
00723     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a69">ManualSelText</a>,          <a class="code" href="../../d3/d9/icmuihlp_8h.html#a13">IDH_PRINTERUI_MANUAL</a>,
00724     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a73">DefaultProfileText</a>,     <a class="code" href="../../d3/d9/icmuihlp_8h.html#a14">IDH_PRINTERUI_DEFAULTTEXT</a>,
00725     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a72">DefaultProfile</a>,         <a class="code" href="../../d3/d9/icmuihlp_8h.html#a14">IDH_PRINTERUI_DEFAULTTEXT</a>,
00726 <span class="preprocessor">#endif</span>
00727 <span class="preprocessor"></span>    0, 0
00728 };
00729 
00730 <span class="comment">//  Initialize lists override- call the base class, then set the default</span>
00731 
<a name="l00732"></a><a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#b0">00732</a> <span class="keywordtype">void</span>    <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#b0">CPrinterProfileManagement::InitList</a>() {
00733 
00734     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b0">CDeviceProfileManagement::InitList</a>();
00735 
00736     <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> = m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() ? 0 : (<span class="keywordtype">unsigned</span>) -1;
00737 }
00738 
00739 <span class="comment">//  Fill list override- write the correct default and call the base function</span>
00740 
<a name="l00741"></a><a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#b1">00741</a> <span class="keywordtype">void</span>    <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#b1">CPrinterProfileManagement::FillList</a>(DWORD <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>) {
00742 
00743     <span class="comment">//  If we are initializing list box, we want to put focus on</span>
00744     <span class="comment">//  "default" profile. here we won't below FillList set focus</span>
00745     <span class="comment">//  to first one.</span>
00746 
00747     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d6/d7/devprop_8h.html#a1">DEVLIST_ONINIT</a>) {
00748         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= <a class="code" href="../../d6/d7/devprop_8h.html#a3">DEVLIST_NOSELECT</a>;
00749     }
00750 
00751     CDeviceProfileManagement::FillList(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00752 
00753     <span class="comment">//  There is either no default profile, an existing profile is the</span>
00754     <span class="comment">//  default, or a newly selected one is.  Some people just like the</span>
00755     <span class="comment">//  selection operator.</span>
00756 
00757     <span class="comment">//  if there is only 1 profile in list box, we treat it as default profile.</span>
00758         
00759     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList,LB_GETCOUNT,0,0) == 1) {
00760         <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> = (<span class="keywordtype">unsigned</span>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETITEMDATA, 0, 0);
00761     }
00762 
00763     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> == -1) {
00764 
00765         <span class="comment">// There is no profile associated for this device.</span>
00766 
00767         <a class="code" href="../../d1/d7/classCString.html">CString</a> csNoProfile;
00768         csNoProfile.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a24">NoProfileString</a>);
00769         <a class="code" href="../../d5/d9/cltxt_8h.html#a20">SetDlgItemText</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a72">DefaultProfile</a>, csNoProfile);            
00770 
00771     } <span class="keywordflow">else</span> {
00772 
00773         <span class="comment">// If the default has been deleted, set default as last in list.</span>
00774 
00775         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> &gt;= (m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() + m_cpaAdds.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>())) {
00776 
00777             <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> = (m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() + m_cpaAdds.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>()) - 1;
00778         }
00779 
00780         <span class="comment">// Put default profile name in UI.</span>
00781 
00782         <a class="code" href="../../d7/d5/classCProfile.html">CProfile</a> *pcpDefault = (<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> &lt; m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>()) ? \
00783                                            m_cpaProfile[<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a>] : \
00784                                            m_cpaAdds[<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> - m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>()];
00785 
00786         <a class="code" href="../../d5/d9/cltxt_8h.html#a20">SetDlgItemText</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a72">DefaultProfile</a>, pcpDefault -&gt; GetName());
00787 
00788         LRESULT idSelect = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_FINDSTRINGEXACT,
00789                                    (WPARAM) -1, (LPARAM) (LPCTSTR) pcpDefault -&gt; GetName());
00790 
00791         <span class="comment">// if could not find, just select first item.</span>
00792 
00793         <span class="keywordflow">if</span> (idSelect == LB_ERR) {
00794             idSelect = 0;
00795         }
00796 
00797         <span class="comment">// Select it.</span>
00798 
00799         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_SETCURSEL, idSelect, 0);
00800     }
00801 
00802     <span class="comment">//  03-08-1997  Bob_Kjelgaard@Prodigy.Net   Memphis RAID 18420</span>
00803     <span class="comment">//  Disable the Default button if there aren't any profiles</span>
00804 
00805     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p1">m_bManualMode</a> &amp;&amp; <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p2">m_bAdminAccess</a>) {
00806         <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a59">DefaultButton</a>),
00807                      m_cpaAdds.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() + m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() - m_cuaRemovals.<a class="code" href="../../d3/d7/classCUintArray.html#a2">Count</a>());
00808     }
00809 }
00810 
00811 <span class="comment">//  Printer Profile Management class constructor- doesn't need any individual</span>
00812 <span class="comment">//  code at the moment.</span>
00813 
<a name="l00814"></a><a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#a0">00814</a> <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#a0">CPrinterProfileManagement::CPrinterProfileManagement</a>(LPCTSTR lpstrName,
00815                                                      HINSTANCE hiWhere) :
00816     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html">CDeviceProfileManagement</a>(lpstrName, hiWhere, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a46">PrinterUI</a>, CLASS_PRINTER) {
00817 }
00818 
00819 <span class="comment">//  This class overrides OnInit so it can disable the UI if the user lacks</span>
00820 <span class="comment">//  authority to make changes.</span>
00821 
<a name="l00822"></a><a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#a2">00822</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#a2">CPrinterProfileManagement::OnInit</a>() {
00823 
00824     <span class="comment">//  Call the base class routine first, as it does most of the work...</span>
00825 
00826     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#a2">CDeviceProfileManagement::OnInit</a>();
00827 
00828     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00829 
00830     <span class="comment">//  Query current mode.</span>
00831 
00832     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d7/profman_8c.html#a97">InternalGetDeviceConfig</a>((LPCTSTR)m_csDevice, CLASS_PRINTER,
00833                                  MSCMS_PROFILE_ENUM_MODE, &amp;<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p1">m_bManualMode</a>, &amp;dwSize)) {
00834 
00835         <span class="comment">//  Auto selection mode as default.</span>
00836 
00837         <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p1">m_bManualMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00838     }
00839 
00840     <span class="comment">//  Now, see if we have sufficient authority to administer the printer</span>
00841 
00842     HANDLE  hPrinter;
00843     PRINTER_DEFAULTS    <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a> = {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, PRINTER_ACCESS_ADMINISTER};
00844 
00845     <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p2">m_bAdminAccess</a>  = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00846     <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p3">m_bLocalPrinter</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00847 
00848     <span class="keywordflow">if</span>  (OpenPrinter(const_cast&lt;LPTSTR&gt; ((LPCTSTR) m_csDevice), &amp;hPrinter, &amp;<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>)) {
00849 
00850         <span class="comment">//  We can administer the printer- proceed in the normal way.</span>
00851 
00852 <span class="preprocessor">#if !defined(_WIN95_)</span>
00853 <span class="preprocessor"></span>
00854         <span class="comment">//  If the printer is "Network Printer", we don't allow user to install</span>
00855         <span class="comment">//  or uninstall color profile.</span>
00856 
00857         <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  StackPrinterData[<span class="keyword">sizeof</span>(PRINTER_INFO_4)+<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>*2];
00858         <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pPrinterData = StackPrinterData;
00859         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  bSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00860         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwReturned;
00861 
00862         <span class="keywordflow">if</span> (!GetPrinter(hPrinter, 4, pPrinterData, <span class="keyword">sizeof</span>(StackPrinterData), &amp;dwReturned)) {
00863 
00864             <span class="keywordflow">if</span> ((GetLastError() == ERROR_INSUFFICIENT_BUFFER) &amp;&amp;
00865                 (pPrinterData = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>) LocalAlloc(LPTR, dwReturned))) {
00866 
00867                 <span class="keywordflow">if</span> (GetPrinter(hPrinter, 4, pPrinterData, dwReturned, &amp;dwReturned)) {
00868 
00869                     bSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00870 
00871                 }
00872             }
00873 
00874         } <span class="keywordflow">else</span> {
00875 
00876             bSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00877         }
00878        
00879         <span class="keywordflow">if</span> (bSuccess)
00880         {
00881             <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p3">m_bLocalPrinter</a> = ((PRINTER_INFO_4 *)pPrinterData)-&gt;pServerName ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00882         }
00883         <span class="keywordflow">else</span>
00884         {
00885             <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p2">m_bAdminAccess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00886         }
00887 
00888         <span class="keywordflow">if</span> (pPrinterData &amp;&amp; (pPrinterData != StackPrinterData))
00889         {
00890             LocalFree(pPrinterData);
00891         }
00892 
00893 <span class="preprocessor">#endif // !defined(_WIN95_)</span>
00894 <span class="preprocessor"></span>
00895         ClosePrinter(hPrinter);
00896 
00897     } <span class="keywordflow">else</span> {
00898 
00899         <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p2">m_bAdminAccess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00900     }
00901 
00902     <span class="comment">// How many profile in listbox ?</span>
00903 
00904     LRESULT itemCount = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETCOUNT, 0, 0);
00905     <span class="keywordflow">if</span> (itemCount == LB_ERR) itemCount = 0;
00906 
00907     <span class="comment">//  make sure the ancestor list code behaves correctly.</span>
00908     <span class="comment">//  You need Admin Access and a Local Printer to be able to add/remove profiles</span>
00909 
00910     m_bReadOnly = !(<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p2">m_bAdminAccess</a> &amp;&amp; <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p3">m_bLocalPrinter</a>);
00911 
00912     <span class="comment">//  Enable/Disable the controls (if needed)</span>
00913 
00914     <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a15">CheckDlgButton</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a60">AutoSelButton</a>, <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p1">m_bManualMode</a> ? BST_UNCHECKED : BST_CHECKED);
00915     <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a15">CheckDlgButton</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a61">ManualSelButton</a>, <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p1">m_bManualMode</a> ? BST_CHECKED : BST_UNCHECKED);
00916 
00917     <span class="comment">//  Only administrator can change 'auto','manual' configuration.</span>
00918 
00919     <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a60">AutoSelButton</a>), <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p2">m_bAdminAccess</a> &amp;&amp; <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p3">m_bLocalPrinter</a>);
00920     <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a61">ManualSelButton</a>), <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p2">m_bAdminAccess</a> &amp;&amp; m_bLocalPrinter);
00921 
00922     <span class="comment">//  Only administrator and printer is at local, can install/uninstall color profile.</span>
00923 
00924     <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a57">AddButton</a>), <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p2">m_bAdminAccess</a> &amp;&amp; m_bLocalPrinter);
00925     <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a58">RemoveButton</a>), <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p2">m_bAdminAccess</a> &amp;&amp; m_bLocalPrinter &amp;&amp; itemCount);
00926 
00927     <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(m_hwndList, <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p2">m_bAdminAccess</a>);
00928     <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a73">DefaultProfileText</a>), <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p2">m_bAdminAccess</a>);
00929     <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a72">DefaultProfile</a>), <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p2">m_bAdminAccess</a>);
00930 
00931     <span class="comment">//  Only with manual mode, these controls are enabled.</span>
00932 
00933     <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a59">DefaultButton</a>), <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p2">m_bAdminAccess</a> &amp;&amp; <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p1">m_bManualMode</a>
00934                                                          &amp;&amp; m_bLocalPrinter &amp;&amp; itemCount);
00935 
00936     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p2">m_bAdminAccess</a>) {
00937 
00938         <span class="comment">//  Set the focus to the OK button</span>
00939 
00940         <a class="code" href="../../d3/d0/user32_8def.html#a43">SetFocus</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwndSheet, IDOK));
00941         <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;  <span class="comment">//  Because we moved the focus!</span>
00942     }
00943 
00944     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00945 }
00946 
00947 <span class="comment">//  Command processing- we never let them click into the edit control, to</span>
00948 <span class="comment">//  prevent them from editing it.</span>
00949 
<a name="l00950"></a><a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#a3">00950</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#a3">CPrinterProfileManagement::OnCommand</a>(WORD wNotifyCode, WORD wid,
00951                                              HWND hwndCtl) {
00952 
00953     <span class="keywordflow">switch</span>  (wNotifyCode) {
00954 
00955         <span class="keywordflow">case</span>    LBN_DBLCLK: {
00956 
00957             <span class="comment">//  Retrieve the ID of the new default profile                      </span>
00958             <span class="comment">//  only accept dblclk changes if the dialog</span>
00959             <span class="comment">//  is not read only - i.e. user is admin</span>
00960 
00961             <span class="keywordflow">if</span>  (<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p1">m_bManualMode</a>) {
00962 
00963                 <span class="keywordtype">int</span> <span class="keywordtype">id</span> = (<span class="keywordtype">int</span>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETCURSEL, 0, 0);
00964                 <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> = (<span class="keywordtype">unsigned</span>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETITEMDATA, <span class="keywordtype">id</span>, 0);
00965 
00966                 <span class="comment">//  Change has been made, update the list</span>
00967 
00968                 <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#b1">FillList</a>(<a class="code" href="../../d6/d7/devprop_8h.html#a2">DEVLIST_CHANGED</a>);
00969             }
00970 
00971             <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00972         }
00973 
00974         <span class="keywordflow">case</span>    BN_CLICKED:
00975 
00976             <span class="keywordflow">switch</span>  (wid) {
00977 
00978                 <span class="keywordflow">case</span>    <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a60">AutoSelButton</a>:
00979                 <span class="keywordflow">case</span>    <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a61">ManualSelButton</a>: {
00980 
00981                     <span class="comment">// How many profile in listbox ?</span>
00982 
00983                     LRESULT itemCount = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETCOUNT, 0, 0);
00984                     <span class="keywordflow">if</span> (itemCount == LB_ERR) itemCount = 0;
00985 
00986                     <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p1">m_bManualMode</a> = (wid == <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a61">ManualSelButton</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00987 
00988                     <span class="comment">//  Only with manual mode, these controls are enabled.</span>
00989 
00990                     <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a59">DefaultButton</a>), <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p1">m_bManualMode</a> &amp;&amp; itemCount);
00991 
00992                     <span class="comment">//  Configuarion has been changed, enable apply button.</span>
00993 
00994                     <a class="code" href="../../d2/d6/classCPropertyPage.html#a3">EnableApplyButton</a>();
00995                     <a class="code" href="../../d2/d6/classCPropertyPage.html#a5">SettingChanged</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00996 
00997                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00998                 }
00999 
01000                 <span class="keywordflow">case</span>    <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a58">RemoveButton</a>: {
01001 
01002                     <span class="comment">//  Make sure we've tracked the default profile correctly</span>
01003                     <span class="comment">//  when a profile is removed.</span>
01004                     <span class="comment">//  All cases break, because we then want the base class to</span>
01005                     <span class="comment">//  process this message.</span>
01006 
01007                     LRESULT <span class="keywordtype">id</span> = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETCURSEL, 0, 0);
01008 
01009                     <span class="keywordtype">unsigned</span> uTarget = (<span class="keywordtype">unsigned</span>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETITEMDATA,
01010                         <span class="keywordtype">id</span>, 0);
01011 
01012                     <span class="keywordflow">if</span>  (uTarget &gt; <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> || <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> == (<span class="keywordtype">unsigned</span>) -1)
01013                         <span class="keywordflow">break</span>;  <span class="comment">//  Nothing here to worry about</span>
01014 
01015                     <span class="keywordflow">if</span>  (<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> == uTarget) {
01016 
01017                         <span class="keywordflow">if</span> (CGlobals::ReportEx(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a43">AskRemoveDefault</a>, m_hwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01018                                                MB_YESNO|MB_ICONEXCLAMATION,0) == IDYES) {
01019 
01020                             <span class="comment">//  The default has been deleted- the profile</span>
01021                             <span class="comment">//  at the top of monitor profile list will be</span>
01022                             <span class="comment">//  made the default profile, if we have</span>
01023 
01024                             LRESULT itemCount = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETCOUNT, 0, 0);
01025 
01026                             <span class="keywordflow">if</span> ((itemCount != LB_ERR) &amp;&amp; (itemCount &gt; 1)) {
01027                                 <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> = (<span class="keywordtype">unsigned</span>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETITEMDATA, 0, 0);
01028                                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> == uTarget) {
01029                                     <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> = (<span class="keywordtype">unsigned</span>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETITEMDATA, 1, 0);
01030                                 }
01031                             } <span class="keywordflow">else</span> {
01032                                 <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> = -1;
01033                             }
01034 
01035                             <span class="keywordflow">break</span>;
01036                         } <span class="keywordflow">else</span> {
01037                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; <span class="comment">// opration cancelled.</span>
01038                         }
01039                     }
01040 
01041                     <span class="keywordflow">if</span>  (uTarget &lt; m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>())
01042                         <span class="keywordflow">break</span>;  <span class="comment">// We're fine</span>
01043 
01044                     <span class="comment">//  Must be an added profile below us in the list was</span>
01045                     <span class="comment">//  zapped- we need to decrement ourselves.</span>
01046 
01047                     <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a>--;
01048                     <span class="keywordflow">break</span>;
01049                 }
01050 
01051                 <span class="keywordflow">case</span>    <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a59">DefaultButton</a>: {
01052 
01053                     LRESULT <span class="keywordtype">id</span> = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETCURSEL, 0, 0);
01054 
01055                     <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> = (<span class="keywordtype">unsigned</span>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETITEMDATA, <span class="keywordtype">id</span>, 0);
01056 
01057                     <span class="comment">//  Change has been made, update the list</span>
01058 
01059                     <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#b1">FillList</a>(<a class="code" href="../../d6/d7/devprop_8h.html#a2">DEVLIST_CHANGED</a>);
01060 
01061                     <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01062                 }
01063             }
01064 
01065         <span class="comment">//  Deliberate fall-through (use a break if you add a case here)</span>
01066     }
01067 
01068     <span class="comment">//  Use common command handling if not handled above</span>
01069 
01070     <span class="keywordflow">return</span>  CDeviceProfileManagement::OnCommand(wNotifyCode, wid, hwndCtl);
01071 }
01072 
01073 <span class="comment">//  Property Sheet notification processing</span>
01074 
<a name="l01075"></a><a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#a4">01075</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#a4">CPrinterProfileManagement::OnNotify</a>(<span class="keywordtype">int</span> idCtrl, LPNMHDR pnmh) {
01076 
01077     <span class="keywordflow">switch</span>  (pnmh -&gt; code) {
01078 
01079         <span class="keywordflow">case</span>    PSN_APPLY: {
01080 
01081             <a class="code" href="../../d2/d6/classCPropertyPage.html#a4">DisableApplyButton</a>();
01082 
01083             <span class="comment">//  If nothing changed, nothing need to do.</span>
01084 
01085             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d6/classCPropertyPage.html#a5">SettingChanged</a>())
01086                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01087 
01088             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p1">m_bManualMode</a>) {
01089 
01090                 <span class="comment">//  If the user hasn't selected a default, and we have</span>
01091                 <span class="comment">//  associated profiles, then we can't allow this.</span>
01092 
01093                 <span class="comment">//  03-08-1997  A-RobKj Fix for Memphis RAID 18416- if there's</span>
01094                 <span class="comment">//  only one profile left, then it must be the default.</span>
01095 
01096                 <span class="keywordflow">if</span>  (<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> == (<span class="keywordtype">unsigned</span>) -1 &amp;&amp; (m_cpaAdds.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() +
01097                      m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() - m_cuaRemovals.<a class="code" href="../../d3/d7/classCUintArray.html#a2">Count</a>()) &gt; 1) {
01098 
01099                     CGlobals::Report(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a23">NoDefaultProfile</a>, m_hwndSheet);
01100                     <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(m_hwnd, DWLP_MSGRESULT, PSNRET_INVALID_NOCHANGEPAGE);
01101                     <span class="keywordflow">break</span>;
01102                 }
01103 
01104                 <span class="comment">//  !!! This behavior is hardly depend on EnumColorProfiles() API !!!</span>
01105 
01106                 <span class="comment">//  OK, if the default profile has changed, we have to delete default</span>
01107                 <span class="comment">//  profile associations, and do the association for default profile</span>
01108                 <span class="comment">//  in "last".</span>
01109 
01110                 <span class="comment">//  Let the base class handle the cases where the default hasn't</span>
01111                 <span class="comment">//  changed, or we started with no profiles and still have none.</span>
01112                 <span class="comment">//</span>
01113                 <span class="comment">//  03-08-1997  Sleazy code note.  The case where no default is</span>
01114                 <span class="comment">//  selected but only one is assigned will now fall here.  Since the</span>
01115                 <span class="comment">//  default happens to be the "last", and there only is one, letting</span>
01116                 <span class="comment">//  the base class handle it is not a problem.  The list filling</span>
01117                 <span class="comment">//  code will take care of the rest for us.</span>
01118 
01119                 <span class="keywordflow">if</span>  (<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> == (<span class="keywordtype">unsigned</span>) -1) <span class="keywordflow">break</span>;
01120 
01121                 <span class="comment">//  Remove default first (if default is associated), then associate later.</span>
01122 
01123                 <span class="keywordflow">if</span>  (<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> &lt; m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>())
01124                     m_cpaProfile[<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a>] -&gt; Dissociate(m_csDevice);
01125 
01126                 <span class="comment">//  Now do the other removals (actually just dissociations)</span>
01127 
01128                 <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> u = 0; u &lt; m_cuaRemovals.<a class="code" href="../../d3/d7/classCUintArray.html#a2">Count</a>(); u++) {
01129                     m_cpaProfile[m_cuaRemovals[u]] -&gt; Dissociate(m_csDevice);
01130                 }
01131 
01132                 <span class="comment">//  Add in the new ones</span>
01133 
01134                 <span class="keywordflow">for</span> (u = 0; u &lt; m_cpaAdds.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>(); u++) {
01135                     <span class="keywordflow">if</span>  (<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> &gt;= m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>())
01136                         <span class="keywordflow">if</span>  (u == (<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> - m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>()))
01137                             <span class="keywordflow">continue</span>;   <span class="comment">// this is default, will be done later</span>
01138 
01139                     <span class="comment">//  OK, add it back in...</span>
01140                     m_cpaAdds[u] -&gt; Associate(m_csDevice);
01141                 }
01142 
01143                 <span class="comment">//  Finally, associate back default profile.</span>
01144 
01145                 <span class="keywordflow">if</span>  (<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> &lt; m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>())
01146                     m_cpaProfile[<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a>] -&gt; Associate(m_csDevice);
01147                 <span class="keywordflow">else</span>
01148                     m_cpaAdds[<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p0">m_uDefault</a> - m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>()] -&gt; Associate(m_csDevice);
01149 
01150                 <span class="comment">//  Update the various working structures...</span>
01151 
01152                 <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#b0">InitList</a>();
01153                 <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#b1">FillList</a>();
01154 
01155                 <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(m_hwnd, DWLP_MSGRESULT, PSNRET_NOERROR);
01156 
01157                 <span class="comment">//  Now, we have updated settings.</span>
01158 
01159                 <a class="code" href="../../d2/d6/classCPropertyPage.html#a5">SettingChanged</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01160             }
01161 
01162             <span class="comment">// Update "auto/manual" status.</span>
01163 
01164             <a class="code" href="../../d9/d7/profman_8c.html#a98">InternalSetDeviceConfig</a>((LPCTSTR)m_csDevice, CLASS_PRINTER,
01165                                     MSCMS_PROFILE_ENUM_MODE, &amp;<a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#p1">m_bManualMode</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
01166         }
01167     }
01168 
01169     <span class="comment">//  Let the base class handle everything else</span>
01170 
01171     <span class="keywordflow">return</span>  CDeviceProfileManagement::OnNotify(idCtrl, pnmh);
01172 }
01173 
01174 <span class="comment">//  Context-sensitive help handler</span>
01175 
<a name="l01176"></a><a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#a5">01176</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#a5">CPrinterProfileManagement::OnHelp</a>(LPHELPINFO pHelp) {
01177 
01178     <span class="keywordflow">if</span> (pHelp-&gt;iContextType == HELPINFO_WINDOW) {
01179         WinHelp((HWND) pHelp-&gt;hItemHandle, <a class="code" href="../../d3/d9/icmuihlp_8h.html#a0">WINDOWS_HELP_FILE</a>,
01180                 HELP_WM_HELP, (ULONG_PTR) (LPSTR) <a class="code" href="../../d5/d7/devprop_8cpp.html#a2">PrinterUIHelpIds</a>);
01181     }
01182 
01183     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01184 }
01185 
<a name="l01186"></a><a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#a6">01186</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html#a6">CPrinterProfileManagement::OnContextMenu</a>(HWND hwnd) {
01187 
01188     WinHelp(hwnd, <a class="code" href="../../d3/d9/icmuihlp_8h.html#a0">WINDOWS_HELP_FILE</a>,
01189             HELP_CONTEXTMENU, (ULONG_PTR) (LPSTR) <a class="code" href="../../d5/d7/devprop_8cpp.html#a2">PrinterUIHelpIds</a>);
01190 
01191     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01192 }
01193 
01194 <span class="comment">//  Scanner Profile Management</span>
01195 <span class="comment">//  Scanner Profile Management class constructor- doesn't need any individual</span>
01196 <span class="comment">//  code at the moment.</span>
01197 
01198 <span class="comment">//  Scanner Profile Management</span>
01199 
<a name="l01200"></a><a class="code" href="../../d5/d7/devprop_8cpp.html#a3">01200</a> CONST <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d7/devprop_8cpp.html#a3">ScannerUIHelpIds</a>[] = {
01201 <span class="preprocessor">#if !defined(_WIN95_)</span>
01202 <span class="preprocessor"></span>    <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a57">AddButton</a>,          <a class="code" href="../../d3/d9/icmuihlp_8h.html#a53">IDH_SCANNERUI_ADD</a>,
01203     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a58">RemoveButton</a>,       <a class="code" href="../../d3/d9/icmuihlp_8h.html#a54">IDH_SCANNERUI_REMOVE</a>,
01204     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a64">ProfileListControl</a>, <a class="code" href="../../d3/d9/icmuihlp_8h.html#a52">IDH_SCANNERUI_LIST</a>,
01205     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a65">ProfileListControlText</a>, <a class="code" href="../../d3/d9/icmuihlp_8h.html#a52">IDH_SCANNERUI_LIST</a>,
01206 <span class="preprocessor">#endif</span>
01207 <span class="preprocessor"></span>    0, 0
01208 };
01209 
<a name="l01210"></a><a class="code" href="../../d8/d6/classCScannerProfileManagement.html#a0">01210</a> <a class="code" href="../../d8/d6/classCScannerProfileManagement.html#a0">CScannerProfileManagement::CScannerProfileManagement</a>(LPCTSTR lpstrName,
01211                                                      HINSTANCE hiWhere) :
01212 
01213     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html">CDeviceProfileManagement</a>(lpstrName, hiWhere, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a48">ScannerUI</a>, CLASS_SCANNER) {
01214     m_bReadOnly = !<a class="code" href="../../d5/d7/devprop_8cpp.html#a5">IsAdmin</a>();
01215 }
01216 
01217 <span class="comment">//  This class overrides OnInit so it can disable the UI if the user lacks</span>
01218 <span class="comment">//  authority to make changes.</span>
01219 
<a name="l01220"></a><a class="code" href="../../d8/d6/classCScannerProfileManagement.html#a2">01220</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d8/d6/classCScannerProfileManagement.html#a2">CScannerProfileManagement::OnInit</a>() {
01221 
01222     <span class="comment">//  Call the base class routine first, as it does most of the work...</span>
01223 
01224     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#a2">CDeviceProfileManagement::OnInit</a>();
01225 
01226     <span class="comment">//  Now, see if we have sufficient authority to administer the scanner</span>
01227     <span class="comment">//</span>
01228     <span class="keywordflow">if</span> (m_bReadOnly) {    
01229         <span class="comment">// User is not Admin, Disable all of the controls</span>
01230 
01231         <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a57">AddButton</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01232         <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a58">RemoveButton</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01233 
01234         <span class="comment">//  Set the focus to the OK button</span>
01235         <a class="code" href="../../d3/d0/user32_8def.html#a43">SetFocus</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwndSheet, IDOK));
01236         <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;  <span class="comment">//  Because we moved the focus!</span>
01237     }
01238 
01239     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01240 }
01241 
01242 <span class="comment">//  Context-sensitive help handler</span>
01243 
<a name="l01244"></a><a class="code" href="../../d8/d6/classCScannerProfileManagement.html#a3">01244</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d8/d6/classCScannerProfileManagement.html#a3">CScannerProfileManagement::OnHelp</a>(LPHELPINFO pHelp) {
01245 
01246     <span class="keywordflow">if</span> (pHelp-&gt;iContextType == HELPINFO_WINDOW) {
01247         WinHelp((HWND) pHelp-&gt;hItemHandle, <a class="code" href="../../d3/d9/icmuihlp_8h.html#a0">WINDOWS_HELP_FILE</a>,
01248                 HELP_WM_HELP, (ULONG_PTR) (LPSTR) <a class="code" href="../../d5/d7/devprop_8cpp.html#a3">ScannerUIHelpIds</a>);
01249     }
01250 
01251     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01252 }
01253 
<a name="l01254"></a><a class="code" href="../../d8/d6/classCScannerProfileManagement.html#a4">01254</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d8/d6/classCScannerProfileManagement.html#a4">CScannerProfileManagement::OnContextMenu</a>(HWND hwnd) {
01255 
01256     WinHelp(hwnd, <a class="code" href="../../d3/d9/icmuihlp_8h.html#a0">WINDOWS_HELP_FILE</a>,
01257             HELP_CONTEXTMENU, (ULONG_PTR) (LPSTR) <a class="code" href="../../d5/d7/devprop_8cpp.html#a3">ScannerUIHelpIds</a>);
01258 
01259     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01260 }
01261 
01262 
01263 
01264 <span class="comment">//  Monitor Profile Management class- since the mechanism for default</span>
01265 <span class="comment">//  profile manipulation is a bit sleazy, so is some of this code.</span>
01266 
<a name="l01267"></a><a class="code" href="../../d5/d7/devprop_8cpp.html#a4">01267</a> CONST <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d7/devprop_8cpp.html#a4">MonitorUIHelpIds</a>[] = {
01268     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a57">AddButton</a>,              <a class="code" href="../../d3/d9/icmuihlp_8h.html#a17">IDH_MONITORUI_ADD</a>,
01269     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a58">RemoveButton</a>,           <a class="code" href="../../d3/d9/icmuihlp_8h.html#a19">IDH_MONITORUI_REMOVE</a>,
01270     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a59">DefaultButton</a>,          <a class="code" href="../../d3/d9/icmuihlp_8h.html#a21">IDH_MONITORUI_DEFAULT</a>,
01271     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a64">ProfileListControl</a>,     <a class="code" href="../../d3/d9/icmuihlp_8h.html#a23">IDH_MONITORUI_LIST</a>,
01272 <span class="preprocessor">#if !defined(_WIN95_)</span>
01273 <span class="preprocessor"></span>    <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a65">ProfileListControlText</a>, <a class="code" href="../../d3/d9/icmuihlp_8h.html#a23">IDH_MONITORUI_LIST</a>,
01274     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a70">MonitorName</a>,            <a class="code" href="../../d3/d9/icmuihlp_8h.html#a25">IDH_MONITORUI_DISPLAY</a>,
01275     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a71">MonitorNameText</a>,        <a class="code" href="../../d3/d9/icmuihlp_8h.html#a25">IDH_MONITORUI_DISPLAY</a>,
01276     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a72">DefaultProfile</a>,         <a class="code" href="../../d3/d9/icmuihlp_8h.html#a27">IDH_MONITORUI_PROFILE</a>,
01277     <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a73">DefaultProfileText</a>,     <a class="code" href="../../d3/d9/icmuihlp_8h.html#a27">IDH_MONITORUI_PROFILE</a>,
01278 <span class="preprocessor">#endif</span>
01279 <span class="preprocessor"></span>    0, 0
01280 };
01281 
01282 <span class="comment">//  Initialize lists override- call the base class, then set the default</span>
01283 
<a name="l01284"></a><a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#b0">01284</a> <span class="keywordtype">void</span>    <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#b0">CMonitorProfileManagement::InitList</a>() {
01285 
01286     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#b0">CDeviceProfileManagement::InitList</a>();
01287 
01288     <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> = m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() ? 0 : (<span class="keywordtype">unsigned</span>) -1;
01289 }
01290 
01291 <span class="comment">//  Fill list override- write the correct default and call the base function</span>
01292 
<a name="l01293"></a><a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#b1">01293</a> <span class="keywordtype">void</span>    <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#b1">CMonitorProfileManagement::FillList</a>(DWORD <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>) {
01294 
01295     <span class="comment">//  If we are initializing list box, we want to put focus on</span>
01296     <span class="comment">//  "default" profile. here we won't below FillList set focus</span>
01297     <span class="comment">//  to first one.</span>
01298 
01299     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d6/d7/devprop_8h.html#a1">DEVLIST_ONINIT</a>) {
01300         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= <a class="code" href="../../d6/d7/devprop_8h.html#a3">DEVLIST_NOSELECT</a>;
01301     }
01302 
01303     CDeviceProfileManagement::FillList(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
01304 
01305     <span class="comment">//  There is either no default profile, an existing profile is the</span>
01306     <span class="comment">//  default, or a newly selected one is.  Some people just like the</span>
01307     <span class="comment">//  selection operator.</span>
01308 
01309     <span class="comment">//  if there is only 1 profile in list box, we treat it as default profile.</span>
01310         
01311     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList,LB_GETCOUNT,0,0) == 1) {
01312         <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> = (<span class="keywordtype">unsigned</span>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETITEMDATA, 0, 0);
01313     }
01314 
01315     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> == -1) {
01316 
01317         <span class="comment">// There is no profile associated for this device.</span>
01318 
01319         <a class="code" href="../../d1/d7/classCString.html">CString</a> csNoProfile;
01320         csNoProfile.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a24">NoProfileString</a>);
01321         <a class="code" href="../../d5/d9/cltxt_8h.html#a20">SetDlgItemText</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a72">DefaultProfile</a>, csNoProfile);            
01322 
01323     } <span class="keywordflow">else</span> {
01324 
01325         <span class="comment">// If the default has been deleted, set default as last in list.</span>
01326 
01327         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> &gt;= (m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() + m_cpaAdds.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>())) {
01328 
01329             <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> = (m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() + m_cpaAdds.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>()) - 1;
01330         }
01331 
01332         <span class="comment">// Put default profile name in UI.</span>
01333 
01334         <a class="code" href="../../d7/d5/classCProfile.html">CProfile</a> *pcpDefault = (<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> &lt; m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>()) ? \
01335                                            m_cpaProfile[<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a>] : \
01336                                            m_cpaAdds[<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> - m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>()];
01337 
01338         <a class="code" href="../../d5/d9/cltxt_8h.html#a20">SetDlgItemText</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a72">DefaultProfile</a>, pcpDefault -&gt; GetName());
01339 
01340         <span class="comment">// If we are initialing list box, put focus on default profile.</span>
01341 
01342         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d6/d7/devprop_8h.html#a1">DEVLIST_ONINIT</a>) {
01343 
01344             LRESULT idSelect = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_FINDSTRINGEXACT,
01345                                    (WPARAM) -1, (LPARAM) (LPCTSTR) pcpDefault -&gt; GetName());
01346 
01347             <span class="comment">// if could not find, just select first item.</span>
01348 
01349             <span class="keywordflow">if</span> (idSelect == LB_ERR) {
01350                 idSelect = 0;
01351             }
01352 
01353             <span class="comment">// Select it.</span>
01354 
01355             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_SETCURSEL, idSelect, 0);
01356         }
01357     }
01358 
01359     <span class="comment">//  03-08-1997  Bob_Kjelgaard@Prodigy.Net   Memphis RAID 18420</span>
01360     <span class="comment">//  Disable the Default button if there aren't any profiles</span>
01361 
01362     <span class="comment">// We do it here, because this gets called any time the list changes.       </span>
01363     <span class="comment">// only allow Default button to be enabled if</span>
01364     <span class="comment">// the dialog isn't read only.</span>
01365     <span class="comment">// the remove button should remain dissabled</span>
01366     <span class="comment">// under all conditions while the user is not</span>
01367     <span class="comment">// administrator.</span>
01368 
01369     <span class="keywordflow">if</span> (m_bReadOnly) {
01370         <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a58">RemoveButton</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01371     } <span class="keywordflow">else</span> {
01372         <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a59">DefaultButton</a>),
01373                      m_cpaAdds.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() + m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() - m_cuaRemovals.<a class="code" href="../../d3/d7/classCUintArray.html#a2">Count</a>());
01374     }
01375 }
01376 
01377 <span class="comment">//  Constructor</span>
01378 
<a name="l01379"></a><a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#a0">01379</a> <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#a0">CMonitorProfileManagement::CMonitorProfileManagement</a>(LPCTSTR lpstrName,
01380                                                      LPCTSTR lpstrFriendlyName,
01381                                                      HINSTANCE hiWhere) :
01382   <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html">CDeviceProfileManagement</a>(lpstrName, hiWhere, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a47">MonitorUI</a>, CLASS_MONITOR) {
01383 
01384 
01385    <span class="comment">// if the user is not the administrator,</span>
01386    <span class="comment">// make this property sheet read only.</span>
01387 
01388    m_bReadOnly = !<a class="code" href="../../d5/d7/devprop_8cpp.html#a5">IsAdmin</a>();
01389 
01390    <span class="comment">// Keep friendly name in MonitorProfileManagement class.</span>
01391 
01392    <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p1">m_csDeviceFriendlyName</a> = lpstrFriendlyName;
01393 }
01394 
01395 <span class="comment">//  UI Initialization</span>
01396 
<a name="l01397"></a><a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#a2">01397</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#a2">CMonitorProfileManagement::OnInit</a>() {
01398 
01399     <span class="comment">//  Do common initializations</span>
01400 
01401     <a class="code" href="../../d2/d2/classCDeviceProfileManagement.html#a2">CDeviceProfileManagement::OnInit</a>();
01402 
01403     <span class="comment">//  Mark the device name in the space provided</span>
01404 
01405     <a class="code" href="../../d5/d9/cltxt_8h.html#a20">SetDlgItemText</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a70">MonitorName</a>, <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p1">m_csDeviceFriendlyName</a>);
01406         
01407     <span class="comment">//  Now, see if we have sufficient authority to administer the monitor</span>
01408 
01409     <span class="keywordflow">if</span>(m_bReadOnly) {
01410 
01411         <span class="comment">//  User is not Admin, Disable all of the controls</span>
01412 
01413         <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a57">AddButton</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01414         <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a58">RemoveButton</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01415         <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a59">DefaultButton</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01416 
01417         <span class="comment">//  EnableWindow(m_hwndList, FALSE);</span>
01418 
01419         <span class="comment">//  Set the focus to the OK button</span>
01420 
01421         <a class="code" href="../../d3/d0/user32_8def.html#a43">SetFocus</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(m_hwndSheet, IDOK));
01422         <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;  <span class="comment">//  Because we moved the focus!</span>
01423     }
01424 
01425     <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01426 }
01427 
01428 <span class="comment">//  Command processing- we never let them click into the edit control, to</span>
01429 <span class="comment">//  prevent them from editing it.</span>
01430 
<a name="l01431"></a><a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#a3">01431</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#a3">CMonitorProfileManagement::OnCommand</a>(WORD wNotifyCode, WORD wid,
01432                                              HWND hwndCtl) {
01433 
01434     <span class="keywordflow">switch</span>  (wNotifyCode) {
01435 
01436         <span class="keywordflow">case</span>    LBN_DBLCLK: {
01437 
01438             <span class="comment">//  Retrieve the ID of the new default profile                      </span>
01439             <span class="comment">//  only accept dblclk changes if the dialog</span>
01440             <span class="comment">//  is not read only - i.e. user is admin</span>
01441 
01442             <span class="keywordflow">if</span>  (!m_bReadOnly) {
01443 
01444                 <span class="keywordtype">int</span> <span class="keywordtype">id</span> = (<span class="keywordtype">int</span>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETCURSEL, 0, 0);
01445                 <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> = (<span class="keywordtype">unsigned</span>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETITEMDATA, <span class="keywordtype">id</span>, 0);
01446 
01447                 <span class="comment">//  Change has been made, update the list</span>
01448 
01449                 <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#b1">FillList</a>(<a class="code" href="../../d6/d7/devprop_8h.html#a2">DEVLIST_CHANGED</a>);
01450             }
01451 
01452             <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01453         }
01454 
01455         <span class="keywordflow">case</span>    BN_CLICKED:
01456 
01457             <span class="keywordflow">switch</span>  (wid) {
01458 
01459                 <span class="keywordflow">case</span>    <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a58">RemoveButton</a>: {
01460 
01461                     <span class="comment">//  Make sure we've tracked the default profile correctly</span>
01462                     <span class="comment">//  when a profile is removed.</span>
01463                     <span class="comment">//  All cases break, because we then want the base class to</span>
01464                     <span class="comment">//  process this message.</span>
01465 
01466                     LRESULT <span class="keywordtype">id</span> = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETCURSEL, 0, 0);
01467 
01468                     <span class="keywordtype">unsigned</span> uTarget = (<span class="keywordtype">unsigned</span>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETITEMDATA,
01469                         <span class="keywordtype">id</span>, 0);
01470 
01471                     <span class="keywordflow">if</span>  (uTarget &gt; <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> || <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> == (<span class="keywordtype">unsigned</span>) -1)
01472                         <span class="keywordflow">break</span>;  <span class="comment">//  Nothing here to worry about</span>
01473 
01474                     <span class="keywordflow">if</span>  (<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> == uTarget) {
01475 
01476                         <span class="keywordflow">if</span> (CGlobals::ReportEx(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a43">AskRemoveDefault</a>, m_hwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01477                                                MB_YESNO|MB_ICONEXCLAMATION,0) == IDYES) {
01478 
01479                             <span class="comment">//  The default has been deleted- the profile</span>
01480                             <span class="comment">//  at the top of monitor profile list will be</span>
01481                             <span class="comment">//  made the default profile, if we have</span>
01482 
01483                             LRESULT itemCount = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETCOUNT, 0, 0);
01484 
01485                             <span class="keywordflow">if</span> ((itemCount != LB_ERR) &amp;&amp; (itemCount &gt; 1)) {
01486                                 <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> = (<span class="keywordtype">unsigned</span>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETITEMDATA, 0, 0);
01487                                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> == uTarget) {
01488                                     <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> = (<span class="keywordtype">unsigned</span>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETITEMDATA, 1, 0);
01489                                 }
01490                             } <span class="keywordflow">else</span> {
01491                                 <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> = -1;
01492                             }
01493 
01494                             <span class="keywordflow">break</span>;
01495                         } <span class="keywordflow">else</span> {
01496                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; <span class="comment">// operation cancelled.</span>
01497                         }
01498                     }
01499 
01500                     <span class="keywordflow">if</span>  (uTarget &lt; m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>())
01501                         <span class="keywordflow">break</span>;  <span class="comment">// We're fine</span>
01502 
01503                     <span class="comment">//  Must be an added profile below us in the list was</span>
01504                     <span class="comment">//  zapped- we need to decrement ourselves.</span>
01505 
01506                     <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a>--;
01507                     <span class="keywordflow">break</span>;
01508                 }
01509 
01510                 <span class="keywordflow">case</span>    <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a59">DefaultButton</a>: {
01511 
01512                     LRESULT <span class="keywordtype">id</span> = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETCURSEL, 0, 0);
01513 
01514                     <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> = (<span class="keywordtype">unsigned</span>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(m_hwndList, LB_GETITEMDATA, <span class="keywordtype">id</span>, 0);
01515 
01516                     <span class="comment">//  Change has been made, update the list</span>
01517 
01518                     <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#b1">FillList</a>(<a class="code" href="../../d6/d7/devprop_8h.html#a2">DEVLIST_CHANGED</a>);
01519 
01520                     <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01521                 }
01522             }
01523 
01524         <span class="comment">//  Deliberate fall-through (use a break if you add a case here)</span>
01525     }
01526 
01527     <span class="comment">//  Use common command handling if not handled above</span>
01528     <span class="keywordflow">return</span>  CDeviceProfileManagement::OnCommand(wNotifyCode, wid, hwndCtl);
01529 }
01530 
01531 <span class="comment">//  Property Sheet notification processing</span>
01532 
<a name="l01533"></a><a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#a4">01533</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#a4">CMonitorProfileManagement::OnNotify</a>(<span class="keywordtype">int</span> idCtrl, LPNMHDR pnmh) {
01534 
01535     <span class="keywordflow">switch</span>  (pnmh -&gt; code) {
01536 
01537         <span class="keywordflow">case</span>    PSN_APPLY: {
01538 
01539             <a class="code" href="../../d2/d6/classCPropertyPage.html#a4">DisableApplyButton</a>();
01540 
01541             <span class="comment">//  If nothing changed, nothing need to do.</span>
01542 
01543             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d6/classCPropertyPage.html#a5">SettingChanged</a>())
01544                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01545 
01546             <span class="comment">//  If the user hasn't selected a default, and we have</span>
01547             <span class="comment">//  associated profiles, then we can't allow this.</span>
01548 
01549             <span class="comment">//  03-08-1997  A-RobKj Fix for Memphis RAID 18416- if there's</span>
01550             <span class="comment">//  only one profile left, then it must be the default.</span>
01551 
01552             <span class="keywordflow">if</span>  (<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> == (<span class="keywordtype">unsigned</span>) -1 &amp;&amp; (m_cpaAdds.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() +
01553                  m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>() - m_cuaRemovals.<a class="code" href="../../d3/d7/classCUintArray.html#a2">Count</a>()) &gt; 1) {
01554 
01555                 CGlobals::Report(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a23">NoDefaultProfile</a>, m_hwndSheet);
01556                 <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(m_hwnd, DWLP_MSGRESULT, PSNRET_INVALID_NOCHANGEPAGE);
01557                 <span class="keywordflow">break</span>;
01558             }
01559 
01560             <span class="comment">//  !!! This behavior is hardly depend on EnumColorProfiles() API !!!</span>
01561 
01562             <span class="comment">//  OK, if the default profile has changed, we have to delete default</span>
01563             <span class="comment">//  profile associations, and do the association for default profile</span>
01564             <span class="comment">//  in "last".</span>
01565 
01566             <span class="comment">//  Let the base class handle the cases where the default hasn't</span>
01567             <span class="comment">//  changed, or we started with no profiles and still have none.</span>
01568             <span class="comment">//</span>
01569             <span class="comment">//  03-08-1997  Sleazy code note.  The case where no default is</span>
01570             <span class="comment">//  selected but only one is assigned will now fall here.  Since the</span>
01571             <span class="comment">//  default happens to be the "last", and there only is one, letting</span>
01572             <span class="comment">//  the base class handle it is not a problem.  The list filling</span>
01573             <span class="comment">//  code will take care of the rest for us.</span>
01574 
01575             <span class="keywordflow">if</span>  (<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> == (<span class="keywordtype">unsigned</span>) -1) <span class="keywordflow">break</span>;
01576 
01577             <span class="comment">//  Remove default first (if default is associated), then associate later.</span>
01578 
01579             <span class="keywordflow">if</span>  (<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> &lt; m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>())
01580                 m_cpaProfile[<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a>] -&gt; Dissociate(m_csDevice);
01581 
01582             <span class="comment">//  Now do the other removals (actually just dissociations)</span>
01583 
01584             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> u = 0; u &lt; m_cuaRemovals.<a class="code" href="../../d3/d7/classCUintArray.html#a2">Count</a>(); u++) {
01585                 m_cpaProfile[m_cuaRemovals[u]] -&gt; Dissociate(m_csDevice);
01586             }
01587 
01588             <span class="comment">//  Add in the new ones</span>
01589 
01590             <span class="keywordflow">for</span> (u = 0; u &lt; m_cpaAdds.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>(); u++) {
01591                 <span class="keywordflow">if</span>  (<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> &gt;= m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>())
01592                     <span class="keywordflow">if</span>  (u == (<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> - m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>()))
01593                         <span class="keywordflow">continue</span>;   <span class="comment">// this is default, will be done later</span>
01594 
01595                 <span class="comment">//  OK, add it back in...</span>
01596                 m_cpaAdds[u] -&gt; Associate(m_csDevice);
01597             }
01598 
01599             <span class="comment">//  Finally, associate default profile.</span>
01600 
01601             <span class="keywordflow">if</span>  (<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> &lt; m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>())
01602                 m_cpaProfile[<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a>] -&gt; Associate(m_csDevice);
01603             <span class="keywordflow">else</span>
01604                 m_cpaAdds[<a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#p0">m_uDefault</a> - m_cpaProfile.<a class="code" href="../../d8/d5/classCProfileArray.html#a2">Count</a>()] -&gt; Associate(m_csDevice);
01605 
01606             <span class="comment">//  Update the various working structures...</span>
01607 
01608             <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#b0">InitList</a>();
01609             <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#b1">FillList</a>();
01610 
01611             <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(m_hwnd, DWLP_MSGRESULT, PSNRET_NOERROR);
01612 
01613             <span class="comment">//  Now, we have updated settings.</span>
01614 
01615             <a class="code" href="../../d2/d6/classCPropertyPage.html#a5">SettingChanged</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01616         }
01617     }
01618 
01619     <span class="comment">//  Let the base class handle everything else</span>
01620 
01621     <span class="keywordflow">return</span>  CDeviceProfileManagement::OnNotify(idCtrl, pnmh);
01622 }
01623 
01624 <span class="comment">//  Context-sensitive help handler</span>
01625 
<a name="l01626"></a><a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#a5">01626</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#a5">CMonitorProfileManagement::OnHelp</a>(LPHELPINFO pHelp) {
01627 
01628     <span class="keywordflow">if</span> (pHelp-&gt;iContextType == HELPINFO_WINDOW) {
01629         WinHelp((HWND) pHelp-&gt;hItemHandle, <a class="code" href="../../d3/d9/icmuihlp_8h.html#a0">WINDOWS_HELP_FILE</a>,
01630             HELP_WM_HELP, (ULONG_PTR) (LPSTR) <a class="code" href="../../d5/d7/devprop_8cpp.html#a4">MonitorUIHelpIds</a>);
01631     }
01632 
01633     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01634 }
01635 
<a name="l01636"></a><a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#a6">01636</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html#a6">CMonitorProfileManagement::OnContextMenu</a>(HWND hwnd) {
01637 
01638     WinHelp(hwnd, <a class="code" href="../../d3/d9/icmuihlp_8h.html#a0">WINDOWS_HELP_FILE</a>,
01639             HELP_CONTEXTMENU, (ULONG_PTR) (LPSTR) <a class="code" href="../../d5/d7/devprop_8cpp.html#a4">MonitorUIHelpIds</a>);
01640 
01641     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01642 }
01643 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:41 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
