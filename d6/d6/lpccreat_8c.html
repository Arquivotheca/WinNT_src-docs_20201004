<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lpccreat.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lpccreat.c File Reference</h1><code>#include "<a class="el" href="../../d1/d6/lpcp_8h-source.html">lpcp.h</a>"</code><br>

<p>
<a href="../../d7/d5/lpccreat_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/lpccreat_8c.html#a0">LpcpCreatePort</a> (OUT PHANDLE <a class="el" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, IN ULONG MaxConnectionInfoLength, IN ULONG MaxMessageLength, IN ULONG MaxPoolUsage, IN BOOLEAN Waitable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/lpccreat_8c.html#a1">NtCreatePort</a> (OUT PHANDLE <a class="el" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, IN ULONG MaxConnectionInfoLength, IN ULONG MaxMessageLength, IN ULONG MaxPoolUsage)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/lpccreat_8c.html#a2">NtCreateWaitablePort</a> (OUT PHANDLE <a class="el" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, IN ULONG MaxConnectionInfoLength, IN ULONG MaxMessageLength, IN ULONG MaxPoolUsage)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="lpccreat.c::LpcpCreatePort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LpcpCreatePort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>PortHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaxConnectionInfoLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaxMessageLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaxPoolUsage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Waitable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00136">136</a> of file <a class="el" href="../../d7/d5/lpccreat_8c-source.html">lpccreat.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02047">_ZONE_HEADER::BlockSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d6/lpc_8h.html#a21">LPCP_PORT_OBJECT</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00037">LpcpInitializePortQueue()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00091">LpcPortObjectType</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00319">LpcpPrint</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00320">LpcpTrace</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00065">LpcpZone</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00092">LpcWaitablePortObjectType</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00135">PORT_WAITABLE</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00027">PortHandle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01431">ProbeAndReadStructure</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l01221">Request()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00131">SERVER_CONNECTION_PORT</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00132">UNCONNECTED_COMMUNICATION_PORT</a>, and <a class="el" href="../../d3/d5/lpc_8h-source.html#l00097">_LPCP_PORT_ZONE::Zone</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00045">NtCreatePort()</a>, and <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00087">NtCreateWaitablePort()</a>.
<p>
<pre class="fragment"><div>00147                    :
00148 
00149     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> server process can create a named connection port with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d6/lpccreat_8c.html#a1">NtCreatePort</a>
00150     service.
00151 
00152     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> connection port <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name and SECURITY_DESCRIPTOR
00153     specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> structure.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection
00154     port object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> location pointed to by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>
00155     parameter.  The returned handle can then be used to listen <span class="keywordflow">for</span> connection
00156     requests to that port name, <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d6/lpclistn_8c.html#a0">NtListenPort</a> service.
00157 
00158     The standard object architecture defined desired access parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00159     necessary since <span class="keyword">this</span> service can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> create a <span class="keyword">new</span> port, not access an
00160     existing port.
00161 
00162     Connection ports cannot be used to send and receive messages.  They are
00163     <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> valid as a parameter to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d6/lpclistn_8c.html#a0">NtListenPort</a> service.
00164 
00165 Arguments:
00166 
00167     <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection port
00168         object handle value.
00169 
00170     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a structure that specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00171         object, an access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> list (SECURITY_DESCRIPTOR) to be applied to
00172         the object, and a set of object attribute flags.
00173 
00174         PUNICODE_STRING ObjectName - An optional pointer to a null terminated
00175             port name string.  The form of the name is
00176             [\name...\name]\port_name.  If no name is specified then an
00177             unconnected communication port is created rather than a connection
00178             port.  This is useful for sending and receiving messages between
00179             threads of a single process.
00180 
00181         ULONG Attributes - A set of flags that control the port object
00182             attributes.
00183 
00184             None of the standard values are relevant for this call.
00185             Connection ports cannot be inherited, are always placed in the
00186             system handle table and are exclusive to the creating process.
00187             This field must be zero.  Future implementations might support
00188             specifying the OBJ_PERMANENT attribute.
00189 
00190     MaxMessageLength - Specifies the maximum length of messages sent or
00191         received on communication ports created from this connection
00192         port.  The value of this parameter cannot exceed
00193         MAX_PORTMSG_LENGTH bytes.
00194 
00195     MaxPoolUsage - Specifies the maximum amount of NonPaged pool used for
00196         message storage.
00197 
00198     Waitable - Specifies if the event used by the port can be use to wait
00199         for LPC messages to arrive asynchronously.
00200 
00201 Return Value:
00202 
00203     NTSTATUS - An appropriate status value
00204 
00205 --*/
00206 
00207 {
00208     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> ConnectionPort;
00209     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00210     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00211     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00212     PUNICODE_STRING NamePtr;
00213     UNICODE_STRING CapturedObjectName;
00214 
00215     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00216 
00217     <span class="comment">//</span>
00218     <span class="comment">//  Get previous processor mode and probe output arguments if necessary.</span>
00219     <span class="comment">//</span>
00220 
00221     PreviousMode = KeGetPreviousMode();
00222     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CapturedObjectName, NULL );
00223 
00224     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00225 
00226         <span class="keywordflow">try</span> {
00227 
00228             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>( PortHandle );
00229 
00230             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( ObjectAttributes,
00231                           <span class="keyword">sizeof</span>( OBJECT_ATTRIBUTES ),
00232                           <span class="keyword">sizeof</span>( ULONG ));
00233 
00234             NamePtr = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName;
00235 
00236             <span class="keywordflow">if</span> (NamePtr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00237 
00238                 CapturedObjectName = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>( NamePtr,
00239                                                             UNICODE_STRING );
00240             }
00241 
00242         } except( EXCEPTION_EXECUTE_HANDLER ) {
00243 
00244             <span class="keywordflow">return</span>( GetExceptionCode() );
00245         }
00246 
00247     } <span class="keywordflow">else</span> {
00248 
00249         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00250 
00251             CapturedObjectName = *(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName);
00252         }
00253     }
00254 
00255     <span class="comment">//</span>
00256     <span class="comment">//  Make the null buffer indicate an unspecified port name</span>
00257     <span class="comment">//</span>
00258 
00259     <span class="keywordflow">if</span> (CapturedObjectName.Length == 0) {
00260 
00261         CapturedObjectName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00262     }
00263 
00264     <span class="comment">//</span>
00265     <span class="comment">//  Allocate and initialize a port object.  If an object name was</span>
00266     <span class="comment">//  specified, then this is a connection port.  Otherwise this is an</span>
00267     <span class="comment">//  unconnected communication port that a process can use to communicate</span>
00268     <span class="comment">//  between threads.</span>
00269     <span class="comment">//</span>
00270 
00271     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>( PreviousMode,
00272                              (Waitable ? LpcWaitablePortObjectType
00273                                        : LpcPortObjectType),
00274                              ObjectAttributes,
00275                              PreviousMode,
00276                              NULL,
00277                              (ULONG)<span class="keyword">sizeof</span>( <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">LPCP_PORT_OBJECT</a> ),
00278                              0,
00279                              0,
00280                              (PVOID *)&amp;ConnectionPort );
00281 
00282     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00283 
00284         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00285     }
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">//  Zero out the connection port object and then initialize its fields</span>
00289     <span class="comment">//</span>
00290 
00291     RtlZeroMemory( ConnectionPort, (ULONG)<span class="keyword">sizeof</span>( LPCP_PORT_OBJECT ));
00292 
00293     ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o0">Length</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/lpc_8h.html#a21">LPCP_PORT_OBJECT</a> );
00294     ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a> = ConnectionPort;
00295     ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o5">Creator</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid;
00296 
00297     InitializeListHead( &amp;ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o14">LpcReplyChainHead</a> );
00298 
00299     InitializeListHead( &amp;ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o15">LpcDataInfoChainHead</a> );
00300 
00301     <span class="comment">//</span>
00302     <span class="comment">//  Named ports get a connection message queue.</span>
00303     <span class="comment">//</span>
00304 
00305     <span class="keywordflow">if</span> (CapturedObjectName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00306 
00307         ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> = <a class="code" href="../../d2/d6/lpc_8h.html#a5">UNCONNECTED_COMMUNICATION_PORT</a>;
00308         ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a> = ConnectionPort;
00309         ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o16">ServerProcess</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00310 
00311     } <span class="keywordflow">else</span> {
00312 
00313         ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> = <a class="code" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a>;
00314 
00315         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() );
00316         ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o16">ServerProcess</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00317     }
00318     
00319     <span class="keywordflow">if</span> ( Waitable ) {
00320 
00321         ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> |= <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a>;
00322     }
00323     
00324     <span class="comment">//</span>
00325     <span class="comment">//  All ports get a request message queue.</span>
00326     <span class="comment">//</span>
00327 
00328     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/lpcqueue_8c.html#a0">LpcpInitializePortQueue</a>( ConnectionPort );
00329 
00330     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00331 
00332         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectionPort );
00333 
00334         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00335     }
00336 
00337     <span class="comment">//</span>
00338     <span class="comment">//  For a waitable port, create the KEVENT that will</span>
00339     <span class="comment">//  be used to signal clients</span>
00340     <span class="comment">//</span>
00341 
00342     <span class="keywordflow">if</span> (ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a>) {
00343 
00344         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o18">WaitEvent</a>,
00345                            NotificationEvent,
00346                            FALSE );
00347     }
00348 
00349     <span class="comment">//</span>
00350     <span class="comment">//  Set the maximum message length and connection info length based on the</span>
00351     <span class="comment">//  zone block size less the structs overhead.</span>
00352     <span class="comment">//</span>
00353 
00354     ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a> = <a class="code" href="../../d0/d7/lpcp_8h.html#a17">LpcpZone</a>.<a class="code" href="../../d1/d5/struct__LPCP__PORT__ZONE.html#o3">Zone</a>.<a class="code" href="../../d0/d0/struct__ZONE__HEADER.html#o2">BlockSize</a> -
00355                                         FIELD_OFFSET( <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">LPCP_MESSAGE</a>, Request );
00356 
00357     ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o10">MaxConnectionInfoLength</a> = ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a> -
00358                                                 <span class="keyword">sizeof</span>( PORT_MESSAGE ) -
00359                                                 <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">LPCP_CONNECTION_MESSAGE</a> );
00360 
00361 <span class="preprocessor">#if DBG</span>
00362 <span class="preprocessor"></span>    <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"Created port %ws (%x) - MaxMsgLen == %x  MaxConnectInfoLen == %x\n"</span>,
00363                 CapturedObjectName.Buffer == NULL ? L<span class="stringliteral">"** UnNamed **"</span> : <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName-&gt;Buffer,
00364                 ConnectionPort,
00365                 ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a>,
00366                 ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o10">MaxConnectionInfoLength</a> ));
00367 <span class="preprocessor">#endif</span>
00368 <span class="preprocessor"></span>
00369     <span class="comment">//</span>
00370     <span class="comment">//  Sanity check that the max message length being asked for is not</span>
00371     <span class="comment">//  greater than the max message length possible in the system</span>
00372     <span class="comment">//</span>
00373 
00374     <span class="keywordflow">if</span> (ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a> &lt; MaxMessageLength) {
00375 
00376 <span class="preprocessor">#if DBG</span>
00377 <span class="preprocessor"></span>        <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"MaxMessageLength granted is %x but requested %x\n"</span>,
00378                     ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a>,
00379                     MaxMessageLength ));
00380         DbgBreakPoint();
00381 <span class="preprocessor">#endif</span>
00382 <span class="preprocessor"></span>
00383         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectionPort );
00384 
00385         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_4;
00386     }
00387     
00388     <span class="comment">//</span>
00389     <span class="comment">//  Save the MaxMessageLength to the connection port</span>
00390     <span class="comment">//</span>
00391 
00392     ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a> = MaxMessageLength;
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">//  Sanity check that the max connection info length being asked for is</span>
00396     <span class="comment">//  not greater than the maximum possible in the system</span>
00397     <span class="comment">//</span>
00398 
00399     <span class="keywordflow">if</span> (ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o10">MaxConnectionInfoLength</a> &lt; MaxConnectionInfoLength) {
00400 
00401 <span class="preprocessor">#if DBG</span>
00402 <span class="preprocessor"></span>        <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"MaxConnectionInfoLength granted is %x but requested %x\n"</span>,
00403                     ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o10">MaxConnectionInfoLength</a>,
00404                     MaxConnectionInfoLength ));
00405         DbgBreakPoint();
00406 <span class="preprocessor">#endif</span>
00407 <span class="preprocessor"></span>
00408         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectionPort );
00409 
00410         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_3;
00411     }
00412 
00413     <span class="comment">//</span>
00414     <span class="comment">//  Insert connection port object in specified object table.  Set port</span>
00415     <span class="comment">//  handle value if successful.  If not successful, then the port will</span>
00416     <span class="comment">//  have been dereferenced, which will cause it to be freed, after our</span>
00417     <span class="comment">//  delete procedure is called.  The delete procedure will undo the work</span>
00418     <span class="comment">//  done to initialize the port.  Finally, return the system server status.</span>
00419     <span class="comment">//</span>
00420 
00421     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( ConnectionPort,
00422                              NULL,
00423                              PORT_ALL_ACCESS,
00424                              0,
00425                              (PVOID *)NULL,
00426                              &amp;Handle );
00427 
00428     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00429 
00430         <span class="comment">//</span>
00431         <span class="comment">//  Set the output variable protected against access faults</span>
00432         <span class="comment">//</span>
00433 
00434         <span class="keywordflow">try</span> {
00435 
00436             *<a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00437 
00438         } except( EXCEPTION_EXECUTE_HANDLER ) {
00439 
00440             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( Handle );
00441 
00442             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00443         }
00444     }
00445 
00446     <span class="comment">//</span>
00447     <span class="comment">//  And return to our caller</span>
00448     <span class="comment">//</span>
00449 
00450     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00451 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="lpccreat.c::NtCreatePort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtCreatePort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>PortHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaxConnectionInfoLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaxMessageLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaxPoolUsage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00045">45</a> of file <a class="el" href="../../d7/d5/lpccreat_8c-source.html">lpccreat.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00136">LpcpCreatePort()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00027">PortHandle</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00453">main()</a>.
<p>
<pre class="fragment"><div>00055                    :
00056 
00057     See <a class="code" href="../../d6/d6/lpccreat_8c.html#a0">LpcpCreatePort</a>.
00058 
00059 Arguments:
00060 
00061     See <a class="code" href="../../d6/d6/lpccreat_8c.html#a0">LpcpCreatePort</a>.
00062 
00063 Return Value:
00064 
00065     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - An appropriate status value
00066 
00067 --*/
00068 
00069 {
00070     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00071 
00072     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00073 
00074     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/lpccreat_8c.html#a0">LpcpCreatePort</a>( PortHandle,
00075                              ObjectAttributes,
00076                              MaxConnectionInfoLength,
00077                              MaxMessageLength,
00078                              MaxPoolUsage,
00079                              FALSE );
00080 
00081     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00082 
00083 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="lpccreat.c::NtCreateWaitablePort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtCreateWaitablePort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>PortHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaxConnectionInfoLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaxMessageLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaxPoolUsage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00087">87</a> of file <a class="el" href="../../d7/d5/lpccreat_8c-source.html">lpccreat.c</a>.
<p>
References <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00136">LpcpCreatePort()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00027">PortHandle</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00463">RtlCreateLpcServer()</a>.
<p>
<pre class="fragment"><div>00097                    :
00098 
00099     Same as <a class="code" href="../../d6/d6/lpccreat_8c.html#a1">NtCreatePort</a>.
00100 
00101     The <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> difference between <span class="keyword">this</span> call and <a class="code" href="../../d6/d6/lpccreat_8c.html#a1">NtCreatePort</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00102     working <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> that can be used to wait <span class="keywordflow">for</span> LPC messages to arrive
00103     asynchronously.
00104 
00105 Arguments:
00106 
00107     See <a class="code" href="../../d6/d6/lpccreat_8c.html#a0">LpcpCreatePort</a>.
00108 
00109 Return Value:
00110 
00111     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - An appropriate status value
00112 
00113 --*/
00114 
00115 {
00116     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00117 
00118     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00119 
00120     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/lpccreat_8c.html#a0">LpcpCreatePort</a>( PortHandle,
00121                              ObjectAttributes,
00122                              MaxConnectionInfoLength,
00123                              MaxMessageLength,
00124                              MaxPoolUsage,
00125                              TRUE );
00126 
00127     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00128 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
