<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: vmcbsup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>vmcbsup.c File Reference</h1><code>#include "UdfProcs.h"</code><br>

<p>
<a href="../../d7/d5/vmcbsup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/vmcbsup_8c.html#a0">BugCheckFileId</a>&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_VMCBSUP)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/vmcbsup_8c.html#a1">Dbg</a>&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_VMCBSUP)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/vmcbsup_8c.html#a2">VMCB_WRITE_SUPPORT</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>(V, L)&nbsp;&nbsp;&nbsp;((((L)+((PAGE_SIZE/(V)-&gt;SectorSize)-1))/(PAGE_SIZE/(V)-&gt;SectorSize))*(PAGE_SIZE/(V)-&gt;SectorSize))</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/vmcbsup_8c.html#a4">UdfVmcbLookupMcbEntry</a> (IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a> Mcb, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> Vbn, OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a51">PLBN</a> Lbn, OUT PULONG SectorCount OPTIONAL, OUT PULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/vmcbsup_8c.html#a5">UdfInitializeVmcb</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN ULONG MaximumLbn, IN ULONG SectorSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/vmcbsup_8c.html#a6">UdfUninitializeVmcb</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/vmcbsup_8c.html#a7">UdfResetVmcb</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/vmcbsup_8c.html#a8">UdfSetMaximumLbnVmcb</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb, IN ULONG MaximumLbn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/vmcbsup_8c.html#a9">UdfVmcbVbnToLbn</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> Vbn, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a51">PLBN</a> Lbn, OUT PULONG SectorCount OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/vmcbsup_8c.html#a10">UdfVmcbLbnToVbn</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> Lbn, OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a53">PVBN</a> Vbn, OUT PULONG SectorCount OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/vmcbsup_8c.html#a11">UdfAddVmcbMapping</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> Lbn, IN ULONG SectorCount, IN BOOLEAN ExactEnd, OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a53">PVBN</a> Vbn, OUT PULONG AlignedSectorCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/vmcbsup_8c.html#a12">UdfRemoveVmcbMapping</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> Vbn, IN ULONG SectorCount)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="vmcbsup.c::BugCheckFileId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BugCheckFileId&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_VMCBSUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00103">103</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="vmcbsup.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_VMCBSUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00109">109</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="vmcbsup.c::PageAlign" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PageAlign          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((((L)+((PAGE_SIZE/(V)-&gt;SectorSize)-1))/(PAGE_SIZE/(V)-&gt;SectorSize))*(PAGE_SIZE/(V)-&gt;SectorSize))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00127">127</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00637">UdfAddVmcbMapping()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="vmcbsup.c::VMCB_WRITE_SUPPORT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define VMCB_WRITE_SUPPORT&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00115">115</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a11" doxytag="vmcbsup.c::UdfAddVmcbMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfAddVmcbMapping           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vmcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ExactEnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a53">PVBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AlignedSectorCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00637">637</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00375">FsRtlAddMcbEntry()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00455">FsRtlLookupLastMcbEntry()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00392">FsRtlRemoveMcbEntry()</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00310">KeReleaseMutex()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00029">LBN</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00127">PageAlign</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00867">UdfRemoveVmcbMapping()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00964">UdfVmcbLookupMcbEntry()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00032">VBN</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>.
<p>
<pre class="fragment"><div>00648                    :
00649 
00650     This routine adds a <span class="keyword">new</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> to <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> mapping to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure.  When
00651     a <span class="keyword">new</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> on page aligned
00652     boundaries.
00653 
00654     If <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not available to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information <span class="keyword">this</span> routine will
00655     raise a status value indicating insufficient resources.
00656 
00657 Arguments:
00658 
00659     Vmcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> being updated.
00660 
00661     Lbn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> to add to <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a>.
00662 
00663     SectorCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of Sectors in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> run
00664     
00665     ExactEnd - Indicates that instead of aligning to map sectors beyond
00666         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request, use a hole.  Implies trying to look at 
00667         these sectors could be undesireable.
00668 
00669     Vbn - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> assigned <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a>
00670     
00671     AlignedSectorCount - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual sector count created in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00672         Vmcb <span class="keywordflow">for</span> page alignment purposes. Vbn+AlignedSectorCount-1 == LastVbn.
00673 
00674 Return Value:
00675 
00676     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">new</span> mapping and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping
00677         <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> already exists.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> already exists then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00678         sector count <span class="keywordflow">for</span> <span class="keyword">this</span> <span class="keyword">new</span> addition must already be in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00679         <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure
00680 
00681 --*/
00682 
00683 {
00684 
00685     BOOLEAN Result;
00686 
00687     BOOLEAN VbnMcbAdded;
00688     BOOLEAN LbnMcbAdded;
00689 
00690     <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> LocalLbn;
00691     <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> LocalVbn;
00692     ULONG LocalCount;
00693 
00694     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00695 
00696     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfAddVmcbMapping, Lbn = %08x\n"</span>, Lbn ));
00697     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">" SectorCount = %08x\n"</span>, SectorCount ));
00698 
00699     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SectorCount != 0 );
00700 
00701     VbnMcbAdded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00702     LbnMcbAdded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00703 
00704     <span class="comment">//</span>
00705     <span class="comment">//  Now grab the mutex for the vmcb</span>
00706     <span class="comment">//</span>
00707 
00708     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Vmcb-&gt;Mutex,
00709                                  Executive,
00710                                  KernelMode,
00711                                  FALSE,
00712                                  (PLARGE_INTEGER) NULL );
00713 
00714     <span class="keywordflow">try</span> {
00715 
00716         <span class="comment">//</span>
00717         <span class="comment">//  Check if the Lbn is already mapped, which means we find an entry</span>
00718         <span class="comment">//  with a non zero mapping Vbn value.</span>
00719         <span class="comment">//</span>
00720 
00721         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/vmcbsup_8c.html#a4">UdfVmcbLookupMcbEntry</a>( &amp;Vmcb-&gt;LbnIndexed,
00722                                    Lbn,
00723                                    Vbn,
00724                                    &amp;LocalCount,
00725                                    NULL )) {
00726 
00727             <span class="comment">//</span>
00728             <span class="comment">//  It is already mapped so now the sector count must not exceed</span>
00729             <span class="comment">//  the count already in the run</span>
00730             <span class="comment">//</span>
00731 
00732             <span class="keywordflow">if</span> (SectorCount &lt;= LocalCount) {
00733 
00734                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Result = FALSE );
00735             }
00736         }
00737 
00738         <span class="comment">//</span>
00739         <span class="comment">//  At this point, we did not find a full existing mapping for the</span>
00740         <span class="comment">//  Lbn and count.  But there might be some overlapping runs that we'll</span>
00741         <span class="comment">//  need to now remove from the vmcb structure.  So for each Lbn in</span>
00742         <span class="comment">//  the range we're after, check to see if it is mapped and remove the</span>
00743         <span class="comment">//  mapping.  We only need to do this test if the sector count is less</span>
00744         <span class="comment">//  than or equal to a page size.  Because those are the only</span>
00745         <span class="comment">//  structures that we know we'll try an remove/overwrite.</span>
00746         <span class="comment">//</span>
00747 
00748         <span class="keywordflow">if</span> (SectorCount &lt;= <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>(Vmcb, 1)) {
00749 
00750             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/vmcbsup_8c.html#a4">UdfVmcbLookupMcbEntry</a>( &amp;Vmcb-&gt;LbnIndexed,
00751                                        Lbn,
00752                                        Vbn,
00753                                        &amp;LocalCount,
00754                                        NULL )) {
00755 
00756                 <a class="code" href="../../d6/d6/vmcbsup_8c.html#a12">UdfRemoveVmcbMapping</a>( Vmcb, *Vbn, <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>(Vmcb, 1) );
00757             }
00758         }
00759 
00760         <span class="comment">//</span>
00761         <span class="comment">//  We need to add this new run at the end of the Vbns.  To do this we</span>
00762         <span class="comment">//  need to look up the last mcb entry or use a vbn for the second</span>
00763         <span class="comment">//  page, if the mcb is empty.  We'll also special case the situation</span>
00764         <span class="comment">//  where the last lbn of the mapping and the mapping we're adding</span>
00765         <span class="comment">//  simply flow into each other in which case we'll not bother bumping</span>
00766         <span class="comment">//  the vbn to a page alignment</span>
00767         <span class="comment">//</span>
00768 
00769         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a157">FsRtlLookupLastMcbEntry</a>( &amp;Vmcb-&gt;VbnIndexed, &amp;LocalVbn, &amp;LocalLbn )) {
00770 
00771             <span class="keywordflow">if</span> (LocalLbn + 1 == Lbn) {
00772 
00773                 LocalVbn = LocalVbn + 1;
00774                 LocalLbn = LocalLbn + 1;
00775 
00776             } <span class="keywordflow">else</span> {
00777 
00778                 <span class="comment">//</span>
00779                 <span class="comment">//  Get the next available Vbn Page, and calculate the</span>
00780                 <span class="comment">//  Lbn for the page containing the Lbn</span>
00781                 <span class="comment">//</span>
00782 
00783                 LocalVbn = <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>( Vmcb, LocalVbn + 1 );
00784                 LocalLbn = <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>( Vmcb, Lbn + 1 ) - <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>( Vmcb, 1 );
00785             }
00786 
00787         } <span class="keywordflow">else</span> {
00788 
00789             <span class="comment">//</span>
00790             <span class="comment">//  Get the first available Vbn page, and calculate the</span>
00791             <span class="comment">//  Lbn for the page containing the Lbn.</span>
00792             <span class="comment">//</span>
00793 
00794 
00795             LocalVbn = 0;
00796             LocalLbn = <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>( Vmcb, Lbn + 1 ) - <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>( Vmcb, 1 );
00797         }
00798 
00799         <span class="comment">//</span>
00800         <span class="comment">//  Calculate the number of sectors that we need to map to keep</span>
00801         <span class="comment">//  everything on a page granularity.</span>
00802         <span class="comment">//</span>
00803 
00804         LocalCount = <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>( Vmcb, SectorCount + (Lbn - LocalLbn) );
00805 
00806         <span class="comment">//</span>
00807         <span class="comment">//  See if we should use a hole to map the alignment at the end of the request.</span>
00808         <span class="comment">//</span>
00809         
00810         <span class="keywordflow">if</span> (ExactEnd &amp;&amp; Lbn + SectorCount &lt; LocalLbn + LocalCount) {
00811 
00812             LocalCount = SectorCount + (Lbn - LocalLbn);
00813         }
00814         
00815         <span class="comment">//</span>
00816         <span class="comment">//  Add the double mapping</span>
00817         <span class="comment">//</span>
00818 
00819         <a class="code" href="../../d1/d8/fsrtl_8h.html#a154">FsRtlAddMcbEntry</a>( &amp;Vmcb-&gt;VbnIndexed,
00820                           LocalVbn,
00821                           LocalLbn,
00822                           LocalCount );
00823 
00824         VbnMcbAdded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00825 
00826         <a class="code" href="../../d1/d8/fsrtl_8h.html#a154">FsRtlAddMcbEntry</a>( &amp;Vmcb-&gt;LbnIndexed,
00827                           LocalLbn,
00828                           LocalVbn,
00829                           LocalCount );
00830 
00831         LbnMcbAdded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00832 
00833         *Vbn = LocalVbn + (Lbn - LocalLbn);
00834         *AlignedSectorCount = LocalCount - (Lbn - LocalLbn);
00835 
00836         <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Result = TRUE );
00837 
00838     } finally {
00839 
00840         <span class="comment">//</span>
00841         <span class="comment">//  If this is an abnormal termination then clean up any mcb's that we</span>
00842         <span class="comment">//  might have modified.</span>
00843         <span class="comment">//</span>
00844 
00845         <span class="keywordflow">if</span> (AbnormalTermination()) {
00846 
00847             <span class="keywordflow">if</span> (VbnMcbAdded) { <a class="code" href="../../d1/d8/fsrtl_8h.html#a155">FsRtlRemoveMcbEntry</a>( &amp;Vmcb-&gt;VbnIndexed, LocalVbn, LocalCount ); }
00848             <span class="keywordflow">if</span> (LbnMcbAdded) { <a class="code" href="../../d1/d8/fsrtl_8h.html#a155">FsRtlRemoveMcbEntry</a>( &amp;Vmcb-&gt;LbnIndexed, LocalLbn, LocalCount ); }
00849         }
00850 
00851         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;Vmcb-&gt;Mutex, FALSE );
00852 
00853         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>(<span class="stringliteral">"UdfAddVmcbMapping"</span>);
00854         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">" LocalVbn   = %08x\n"</span>, LocalVbn ));
00855         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">" LocalLbn   = %08x\n"</span>, LocalLbn ));
00856         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">" LocalCount = %08x\n"</span>, LocalCount ));
00857         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">" *Vbn                = %08x\n"</span>, *Vbn ));
00858         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">" *AlignedSectorCount = %08x\n"</span>, *AlignedSectorCount ));
00859         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>((-1, Dbg, <span class="stringliteral">"UdfAddVmcbMapping -&gt; %08x\n"</span>, Result ));
00860     }
00861 
00862     <span class="keywordflow">return</span> Result;
00863 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="vmcbsup.c::UdfInitializeVmcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfInitializeVmcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vmcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaximumLbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00219">219</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00334">FsRtlInitializeMcb()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00348">FsRtlUninitializeMcb()</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00099">KeInitializeMutex()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d0/gentable_8c-source.html#l00213">RtlInitializeGenericTable()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00230">SectorSize</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.
<p>
<pre class="fragment"><div>00228                    :
00229 
00230     This routine initializes a <span class="keyword">new</span> Vmcb Structure.  The caller must
00231     supply <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure.  This must precede all other calls
00232     that set/query <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> mapping.
00233 
00234     If <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not available <span class="keyword">this</span> routine will raise a status value
00235     indicating insufficient resources.
00236 
00237 Arguments:
00238 
00239     Vmcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> structure to initialize.
00240 
00241     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> to use when allocating additional
00242         internal structures.
00243 
00244     MaximumLbn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum Lbn value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid <span class="keywordflow">for</span> <span class="keyword">this</span>
00245         volume.
00246 
00247     LbSize - <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of a sector on <span class="keyword">this</span> volume
00248 
00249 Return Value:
00250 
00251     None
00252 
00253 --*/
00254 
00255 {
00256     BOOLEAN VbnInitialized;
00257     BOOLEAN LbnInitialized;
00258 
00259     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00260 
00261     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfInitializeVmcb, Vmcb = %08x\n"</span>, Vmcb ));
00262 
00263     VbnInitialized = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00264     LbnInitialized = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00265 
00266     <span class="keywordflow">try</span> {
00267 
00268         <span class="comment">//</span>
00269         <span class="comment">//  Initialize the fields in the vmcb structure</span>
00270         <span class="comment">//</span>
00271 
00272         <a class="code" href="../../d3/d5/mutntobj_8c.html#a2">KeInitializeMutex</a>( &amp;Vmcb-&gt;Mutex, 0 );
00273 
00274         <a class="code" href="../../d1/d8/fsrtl_8h.html#a151">FsRtlInitializeMcb</a>( &amp;Vmcb-&gt;VbnIndexed, PoolType );
00275         VbnInitialized = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00276 
00277         <a class="code" href="../../d1/d8/fsrtl_8h.html#a151">FsRtlInitializeMcb</a>( &amp;Vmcb-&gt;LbnIndexed, PoolType );
00278         LbnInitialized = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00279 
00280         Vmcb-&gt;MaximumLbn = MaximumLbn;
00281 
00282         Vmcb-&gt;SectorSize = <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>;
00283 
00284 <span class="preprocessor">#if VMCB_WRITE_SUPPORT</span>
00285 <span class="preprocessor"></span>
00286         <span class="comment">//</span>
00287         <span class="comment">//  For the dirty table we store in the table context field the pool</span>
00288         <span class="comment">//  type to use for allocating additional structures</span>
00289         <span class="comment">//</span>
00290 
00291         <a class="code" href="../../d6/d1/gentable_8c.html#a3">RtlInitializeGenericTable</a>( &amp;Vmcb-&gt;DirtyTable,
00292                                    PbCompareDirtyVmcb,
00293                                    PbAllocateDirtyVmcb,
00294                                    PbDeallocateDirtyVmcb,
00295                                    (PVOID)PoolType );
00296 
00297 <span class="preprocessor">#endif // VMCB_WRITE_SUPPORT</span>
00298 <span class="preprocessor"></span>
00299     } finally {
00300 
00301         <span class="comment">//</span>
00302         <span class="comment">//  If this is an abnormal termination then check if we need to</span>
00303         <span class="comment">//  uninitialize the mcb structures</span>
00304         <span class="comment">//</span>
00305 
00306         <span class="keywordflow">if</span> (AbnormalTermination()) {
00307 
00308             <span class="keywordflow">if</span> (VbnInitialized) { <a class="code" href="../../d1/d8/fsrtl_8h.html#a152">FsRtlUninitializeMcb</a>( &amp;Vmcb-&gt;VbnIndexed ); }
00309             <span class="keywordflow">if</span> (LbnInitialized) { <a class="code" href="../../d1/d8/fsrtl_8h.html#a152">FsRtlUninitializeMcb</a>( &amp;Vmcb-&gt;LbnIndexed ); }
00310         }
00311 
00312         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>(<span class="stringliteral">"UdfInitializeVmcb"</span>);
00313         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfInitializeVmcb -&gt; VOID\n"</span> ));
00314     }
00315 
00316     <span class="comment">//</span>
00317     <span class="comment">//  And return to our caller</span>
00318     <span class="comment">//</span>
00319 
00320     <span class="keywordflow">return</span>;
00321 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="vmcbsup.c::UdfRemoveVmcbMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfRemoveVmcbMapping           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vmcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00867">867</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00392">FsRtlRemoveMcbEntry()</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00310">KeReleaseMutex()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00029">LBN</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00149">UdfBugCheck</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00964">UdfVmcbLookupMcbEntry()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00637">UdfAddVmcbMapping()</a>, and <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>.
<p>
<pre class="fragment"><div>00875                    :
00876 
00877     This routine removes a Vmcb mapping.
00878 
00879     If <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not available to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information <span class="keyword">this</span> routine will
00880     raise a status value indicating insufficient resources.
00881 
00882 Arguments:
00883 
00884     Vmcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vmcb being updated.
00885 
00886     Vbn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> to remove
00887 
00888     SectorCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sectors to remove.
00889 
00890 Return Value:
00891 
00892     None.
00893 
00894 --*/
00895 
00896 {
00897     <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> Lbn;
00898     ULONG LocalCount;
00899     ULONG i;
00900 
00901     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00902 
00903     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>((+1, Dbg, <span class="stringliteral">"UdfRemoveVmcbMapping, Vbn = %08x\n"</span>, Vbn ));
00904     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">" SectorCount = %08x\n"</span>, SectorCount ));
00905 
00906     <span class="comment">//</span>
00907     <span class="comment">//  Now grab the mutex for the vmcb</span>
00908     <span class="comment">//</span>
00909 
00910     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Vmcb-&gt;Mutex,
00911                                  Executive,
00912                                  KernelMode,
00913                                  FALSE,
00914                                  (PLARGE_INTEGER) NULL );
00915 
00916     <span class="keywordflow">try</span> {
00917 
00918         <span class="keywordflow">for</span> (i = 0; i &lt; SectorCount; i += 1) {
00919 
00920             <span class="comment">//</span>
00921             <span class="comment">//  Lookup the Vbn so we can get its current Lbn mapping</span>
00922             <span class="comment">//</span>
00923 
00924             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/vmcbsup_8c.html#a4">UdfVmcbLookupMcbEntry</a>( &amp;Vmcb-&gt;VbnIndexed,
00925                                         Vbn + i,
00926                                         &amp;Lbn,
00927                                         &amp;LocalCount,
00928                                         NULL )) {
00929 
00930                 <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a66">UdfBugCheck</a>( 0, 0, 0 );
00931             }
00932 
00933             <a class="code" href="../../d1/d8/fsrtl_8h.html#a155">FsRtlRemoveMcbEntry</a>( &amp;Vmcb-&gt;VbnIndexed,
00934                                  Vbn + i,
00935                                  1 );
00936 
00937             <a class="code" href="../../d1/d8/fsrtl_8h.html#a155">FsRtlRemoveMcbEntry</a>( &amp;Vmcb-&gt;LbnIndexed,
00938                                  Lbn,
00939                                  1 );
00940         }
00941 
00942         {
00943             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"VbnIndex:\n"</span>, 0 ));
00944             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"LbnIndex:\n"</span>, 0 ));
00945         }
00946 
00947     } finally {
00948 
00949         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;Vmcb-&gt;Mutex, FALSE );
00950 
00951         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <span class="stringliteral">"UdfRemoveVmcbMapping"</span> );
00952         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfRemoveVmcbMapping -&gt; VOID\n"</span> ));
00953     }
00954 
00955     <span class="keywordflow">return</span>;
00956 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="vmcbsup.c::UdfResetVmcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfResetVmcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Vmcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00370">370</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00922">FsRtlResetLargeMcb()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01140">PLARGE_MCB</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.
<p>
<pre class="fragment"><div>00376                    :
00377 
00378     This routine resets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mappings in an existing <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure.
00379 
00380 Arguments:
00381 
00382     Vmcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure to reset.
00383 
00384 Return Value:
00385 
00386     None.
00387 
00388 --*/
00389 
00390 {
00391     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00392 
00393     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfResetVmcb, Vmcb = %08x\n"</span>, Vmcb ));
00394 
00395     <span class="comment">//</span>
00396     <span class="comment">//  Unitialize the fields in the Vmcb structure</span>
00397     <span class="comment">//</span>
00398 
00399     <a class="code" href="../../d1/d8/fsrtl_8h.html#a141">FsRtlResetLargeMcb</a>( (<a class="code" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>) &amp;Vmcb-&gt;VbnIndexed, TRUE );
00400     <a class="code" href="../../d1/d8/fsrtl_8h.html#a141">FsRtlResetLargeMcb</a>( (<a class="code" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>) &amp;Vmcb-&gt;LbnIndexed, TRUE );
00401 
00402     <span class="comment">//</span>
00403     <span class="comment">//  And return to our caller</span>
00404     <span class="comment">//</span>
00405 
00406     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfResetVmcb -&gt; VOID\n"</span> ));
00407 
00408     <span class="keywordflow">return</span>;
00409 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="vmcbsup.c::UdfSetMaximumLbnVmcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfSetMaximumLbnVmcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vmcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaximumLbn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00413">413</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00420                    :
00421 
00422     This routine sets/resets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum allowed <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00423     Vmcb structure.  The Vmcb structure must already have been initialized
00424     by calling <a class="code" href="../../d3/d8/udfprocs_8h.html#a236">UdfInitializeVmcb</a>.
00425 
00426 Arguments:
00427 
00428     Vmcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> structure to initialize.
00429 
00430     MaximumLbn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum Lbn value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid <span class="keywordflow">for</span> <span class="keyword">this</span>
00431         volume.
00432 
00433 Return Value:
00434 
00435     None
00436 
00437 --*/
00438 
00439 {
00440     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00441 
00442     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfSetMaximumLbnVmcb, Vmcb = %08x\n"</span>, Vmcb ));
00443 
00444     <span class="comment">//</span>
00445     <span class="comment">//  Set the field</span>
00446     <span class="comment">//</span>
00447 
00448     Vmcb-&gt;MaximumLbn = MaximumLbn;
00449 
00450     <span class="comment">//</span>
00451     <span class="comment">//  And return to our caller</span>
00452     <span class="comment">//</span>
00453 
00454     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfSetMaximumLbnVmcb -&gt; VOID\n"</span> ));
00455 
00456     <span class="keywordflow">return</span>;
00457 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="vmcbsup.c::UdfUninitializeVmcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfUninitializeVmcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Vmcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00325">325</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00348">FsRtlUninitializeMcb()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02178">UdfDeleteFcb()</a>.
<p>
<pre class="fragment"><div>00331                    :
00332 
00333     This routine uninitializes an existing <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure.  After calling
00334     <span class="keyword">this</span> routine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure must be re-initialized before
00335     being used again.
00336 
00337 Arguments:
00338 
00339     Vmcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure to uninitialize.
00340 
00341 Return Value:
00342 
00343     None.
00344 
00345 --*/
00346 
00347 {
00348     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00349 
00350     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfUninitializeVmcb, Vmcb = %08x\n"</span>, Vmcb ));
00351 
00352     <span class="comment">//</span>
00353     <span class="comment">//  Unitialize the fields in the Vmcb structure</span>
00354     <span class="comment">//</span>
00355 
00356     <a class="code" href="../../d1/d8/fsrtl_8h.html#a152">FsRtlUninitializeMcb</a>( &amp;Vmcb-&gt;VbnIndexed );
00357     <a class="code" href="../../d1/d8/fsrtl_8h.html#a152">FsRtlUninitializeMcb</a>( &amp;Vmcb-&gt;LbnIndexed );
00358 
00359     <span class="comment">//</span>
00360     <span class="comment">//  And return to our caller</span>
00361     <span class="comment">//</span>
00362 
00363     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfUninitializeVmcb -&gt; VOID\n"</span> ));
00364 
00365     <span class="keywordflow">return</span>;
00366 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="vmcbsup.c::UdfVmcbLbnToVbn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfVmcbLbnToVbn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vmcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a53">PVBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG SectorCount&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00553">553</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00310">KeReleaseMutex()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00964">UdfVmcbLookupMcbEntry()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>.
<p>
<pre class="fragment"><div>00562                    :
00563 
00564     This routine translates an <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> to a <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a>.
00565 
00566 Arguments:
00567 
00568     Vmcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure being queried.
00569 
00570     Lbn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> to translate from.
00571 
00572     Vbn - Recieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>.  This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00573         <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> valid <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function result <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
00574 
00575     SectorCount - Optionally receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sectors corresponding
00576         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> run.
00577 
00578 Return Value:
00579 
00580     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00581 
00582 --*/
00583 
00584 {
00585     BOOLEAN Result;
00586 
00587     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00588 
00589     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfVmcbLbnToVbn, Lbn = %08x\n"</span>, Lbn ));
00590 
00591     <span class="comment">//</span>
00592     <span class="comment">//  If the requested Lbn is greater than the maximum allowed Lbn</span>
00593     <span class="comment">//  then the result is FALSE</span>
00594     <span class="comment">//</span>
00595 
00596     <span class="keywordflow">if</span> (Lbn &gt; Vmcb-&gt;MaximumLbn) {
00597 
00598         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"Lbn too large, UdfVmcbLbnToVbn -&gt; FALSE\n"</span> ));
00599 
00600         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00601     }
00602 
00603     <span class="comment">//</span>
00604     <span class="comment">//  Now grab the mutex for the vmcb</span>
00605     <span class="comment">//</span>
00606 
00607     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Vmcb-&gt;Mutex,
00608                                  Executive,
00609                                  KernelMode,
00610                                  FALSE,
00611                                  (PLARGE_INTEGER) NULL );
00612 
00613     <span class="keywordflow">try</span> {
00614 
00615         Result = <a class="code" href="../../d6/d6/vmcbsup_8c.html#a4">UdfVmcbLookupMcbEntry</a>( &amp;Vmcb-&gt;LbnIndexed,
00616                                         Lbn,
00617                                         Vbn,
00618                                         SectorCount,
00619                                         NULL );
00620 
00621         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"*Vbn = %08x\n"</span>, *Vbn ));
00622 
00623     } finally {
00624 
00625         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;Vmcb-&gt;Mutex, FALSE );
00626 
00627 
00628         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>(<span class="stringliteral">"UdfVmcbLbnToVbn"</span>);
00629         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfVmcbLbnToVbn -&gt; Result = %08x\n"</span>, Result ));
00630     }
00631 
00632     <span class="keywordflow">return</span> Result;
00633 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="vmcbsup.c::UdfVmcbLookupMcbEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfVmcbLookupMcbEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a51">PLBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG SectorCount&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00964">964</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00637">UdfAddVmcbMapping()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00867">UdfRemoveVmcbMapping()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00553">UdfVmcbLbnToVbn()</a>, and <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00461">UdfVmcbVbnToLbn()</a>.
<p>
<pre class="fragment"><div>00974                    :
00975 
00976     This routine retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping of a Vbn to an Lbn from an Mcb.
00977     It indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping exists and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> run.
00978     
00979     The <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> difference betweent <span class="keyword">this</span> and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> regular <a class="code" href="../../d1/d1/largemcb_8c.html#a33">FsRtlLookupMcbEntry</a>
00980     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that we undo <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> behavior of returning <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> in holes in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation.
00981     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> because we don'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> want to avoid mapping at Lbn 0, which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> how <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00982     emulated behavior of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> small Mcb <span class="keyword">package </span>tells callers that there is no
00983     mapping at that location in a hole.  We have holes all over our Vbn space
00984     in the VbnIndexed map.
00985     
00986     The small Mcb package was able to get away with this because Lbn 0 was the
00987     boot sector (or similar magic location) on the disc.  In our metadata stream,
00988     we wish to use Vbn 0 (remember this is a double map).
00989 
00990 Arguments:
00991 
00992     Mcb - Supplies the Mcb being examined.
00993 
00994     Vbn - Supplies the Vbn to lookup.
00995 
00996     Lbn - Receives the Lbn corresponding to the Vbn.  A value of -1 is
00997         returned if the Vbn does not have a corresponding Lbn.
00998 
00999     SectorCount - Receives the number of sectors that map from the Vbn to
01000         contiguous Lbn values beginning with the input Vbn.
01001 
01002     Index - Receives the index of the run found.
01003 
01004 Return Value:
01005 
01006     BOOLEAN - TRUE if the Vbn is within the range of VBNs mapped by the
01007         MCB (not if it corresponds to a hole in the mapping), and FALSE
01008         if the Vbn is beyond the range of the MCB's mapping.
01009 
01010         For example, if an MCB has a mapping for VBNs 5 and 7 but not for
01011         6, then a lookup on Vbn 5 or 7 will yield a non zero Lbn and a sector
01012         count of 1.  A lookup for Vbn 6 will return FALSE with an Lbn value of
01013         0, and lookup for Vbn 8 or above will return FALSE.
01014 
01015 --*/
01016 
01017 {
01018     BOOLEAN Results;
01019     LONGLONG LiLbn;
01020     LONGLONG LiSectorCount;
01021 
01022     Results = <a class="code" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry</a>( (<a class="code" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>)Mcb,
01023                                         (LONGLONG)(Vbn),
01024                                         &amp;LiLbn,
01025                                         ARGUMENT_PRESENT(SectorCount) ? &amp;LiSectorCount : NULL,
01026                                         NULL,
01027                                         NULL,
01028                                         Index );
01029 
01030     <span class="keywordflow">if</span> ((ULONG)LiLbn == -1) {
01031 
01032         *Lbn = 0;
01033         Results = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01034     
01035     } <span class="keywordflow">else</span> {
01036 
01037         *Lbn = (ULONG)LiLbn;
01038     }
01039 
01040     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SectorCount)) { *SectorCount = ((ULONG)LiSectorCount); }
01041 
01042     <span class="keywordflow">return</span> Results;
01043 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="vmcbsup.c::UdfVmcbVbnToLbn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfVmcbVbnToLbn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vmcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a51">PLBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG SectorCount&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00461">461</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00310">KeReleaseMutex()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00964">UdfVmcbLookupMcbEntry()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00069">UdfLookupAllocation()</a>.
<p>
<pre class="fragment"><div>00470                    :
00471 
00472     This routine translates a <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> to an <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>.
00473 
00474 Arguments:
00475 
00476     Vmcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure being queried.
00477 
00478     Vbn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> to translate from.
00479 
00480     Lbn - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input Vbn.  This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> valid
00481         <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function result <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
00482 
00483     SectorCount - Optionally receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sectors corresponding
00484         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> run.
00485 
00486 Return Value:
00487 
00488     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> he Vbn has a valid mapping and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00489 
00490 --*/
00491 
00492 {
00493     BOOLEAN Result;
00494 
00495     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfVmcbVbnToLbn, Vbn = %08x\n"</span>, Vbn ));
00496 
00497     <span class="comment">//</span>
00498     <span class="comment">//  Now grab the mutex for the vmcb</span>
00499     <span class="comment">//</span>
00500 
00501     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Vmcb-&gt;Mutex,
00502                                  Executive,
00503                                  KernelMode,
00504                                  FALSE,
00505                                  (PLARGE_INTEGER) NULL );
00506 
00507     <span class="keywordflow">try</span> {
00508 
00509         Result = <a class="code" href="../../d6/d6/vmcbsup_8c.html#a4">UdfVmcbLookupMcbEntry</a>( &amp;Vmcb-&gt;VbnIndexed,
00510                                         Vbn,
00511                                         Lbn,
00512                                         SectorCount,
00513                                         NULL );
00514 
00515         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"*Lbn = %08x\n"</span>, *Lbn ));
00516 
00517         <span class="comment">//</span>
00518         <span class="comment">//  If the returned Lbn is greater than the maximum allowed Lbn</span>
00519         <span class="comment">//  then return FALSE</span>
00520         <span class="comment">//</span>
00521 
00522         <span class="keywordflow">if</span> (Result &amp;&amp; (*Lbn &gt; Vmcb-&gt;MaximumLbn)) {
00523 
00524             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Result = FALSE );
00525         }
00526 
00527         <span class="comment">//</span>
00528         <span class="comment">//  If the last returned Lbn is greater than the maximum allowed Lbn</span>
00529         <span class="comment">//  then bring in the sector count</span>
00530         <span class="comment">//</span>
00531 
00532         <span class="keywordflow">if</span> (Result &amp;&amp;
00533             ARGUMENT_PRESENT(SectorCount) &amp;&amp;
00534             (*Lbn+*SectorCount-1 &gt; Vmcb-&gt;MaximumLbn)) {
00535 
00536             *SectorCount = (Vmcb-&gt;MaximumLbn - *Lbn + 1);
00537         }
00538 
00539     } finally {
00540 
00541         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;Vmcb-&gt;Mutex, FALSE );
00542 
00543         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>(<span class="stringliteral">"UdfVmcbVbnToLbn"</span>);
00544         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfVmcbVbnToLbn -&gt; Result = %08x\n"</span>, Result ));
00545     }
00546 
00547 
00548     <span class="keywordflow">return</span> Result;
00549 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:08 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
