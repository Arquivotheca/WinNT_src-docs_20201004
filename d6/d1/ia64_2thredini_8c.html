<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ia64/thredini.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>thredini.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d7/d0/ia64_2thredini_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/ia64_2thredini_8c.html#a0">ASSERT_PROCESS</a>(E)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/ia64_2thredini_8c.html#a1">ASSERT_THREAD</a>(E)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/ia64_2thredini_8c.html#a2">KeContextToKframesSpecial</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread, IN OUT PKTRAP_FRAME TrapFrame, IN OUT PKEXCEPTION_FRAME ExceptionFrame, IN PCONTEXT ContextFrame, IN ULONG ContextFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/ia64_2thredini_8c.html#a3">KiInitializeContextThread</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread, IN <a class="el" href="../../d4/d9/ke_8h.html#a67">PKSYSTEM_ROUTINE</a> SystemRoutine, IN <a class="el" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a> StartRoutine OPTIONAL, IN PVOID StartContext OPTIONAL, IN PCONTEXT ContextRecord OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/ia64_2thredini_8c.html#a4">KeSetAutoAlignmentProcess</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a> Process, IN BOOLEAN Enable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/ia64_2thredini_8c.html#a5">KeSetAutoAlignmentThread</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread, IN BOOLEAN Enable)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="ia64/thredini.c::ASSERT_PROCESS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_PROCESS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">E&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                    \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((E)-&gt;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>.Type == ProcessObject); \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d7/d0/ia64_2thredini_8c-source.html#l00044">44</a> of file <a class="el" href="../../d7/d0/ia64_2thredini_8c-source.html">ia64/thredini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ia64/thredini.c::ASSERT_THREAD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_THREAD          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">E&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                    \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((E)-&gt;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>.Type == ThreadObject); \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d7/d0/ia64_2thredini_8c-source.html#l00048">48</a> of file <a class="el" href="../../d7/d0/ia64_2thredini_8c-source.html">ia64/thredini.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="ia64/thredini.c::KeContextToKframesSpecial" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeContextToKframesSpecial           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00766">766</a> of file <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html">ke/ia64/context.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00240">CONTEXT_CONTROL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00242">CONTEXT_INTEGER</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00043">EXTRACT_NATS</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00099">KiSetDebugContext()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/ia64_2thredini_8c-source.html#l00055">KiInitializeContextThread()</a>.
<p>
<pre class="fragment"><div>00776                    :
00777 
00778     This routine moves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> selected contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context frame into
00779     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified trap and exception frames according to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context
00780     flags.
00781 
00782 Arguments:
00783 
00784     TrapFrame - Supplies a pointer to a trap frame that receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">volatile</span>
00785         context from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record.
00786 
00787     ExceptionFrame - Supplies a pointer to an exception frame that receives
00788         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> nonvolatile context from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record.
00789 
00790     ContextFrame - Supplies a pointer to a context frame that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00791         context that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be copied into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap and exception frames.
00792 
00793     ContextFlags - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set of flags that specify which parts of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00794         context frame are to be copied into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap and exception frames.
00795 
00796     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap and exception
00797         frames are being built.
00798 
00799 Return Value:
00800 
00801     None.
00802 
00803 --*/
00804 
00805 {
00806     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> R1Offset, R4Offset;
00807     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> RNatSaveIndex; 
00808     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> BsFrameSize;
00809     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> TempFrameSize;
00810 
00811     <span class="comment">//</span>
00812     <span class="comment">// Set control information if specified.</span>
00813     <span class="comment">//</span>
00814 
00815     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00816 
00817         TrapFrame-&gt;IntGp = ContextFrame-&gt;IntGp;
00818         TrapFrame-&gt;IntSp = ContextFrame-&gt;IntSp;
00819         TrapFrame-&gt;ApUNAT = ContextFrame-&gt;ApUNAT;
00820         TrapFrame-&gt;BrRp = ContextFrame-&gt;BrRp;
00821         TrapFrame-&gt;ApCCV = ContextFrame-&gt;ApCCV;
00822         TrapFrame-&gt;ApDCR = SANITIZE_DCR(ContextFrame-&gt;ApDCR, UserMode);
00823 
00824         <span class="comment">//</span>
00825         <span class="comment">// Set preserved applicaton registers in exception frame.</span>
00826         <span class="comment">//</span>
00827 
00828         ExceptionFrame-&gt;ApLC = ContextFrame-&gt;ApLC;
00829         ExceptionFrame-&gt;ApEC &amp;= ~(PFS_EC_MASK &lt;&lt; PFS_EC_MASK);
00830         ExceptionFrame-&gt;ApEC |= ((ContextFrame-&gt;ApEC &amp; PFS_EC_MASK) &lt;&lt; PFS_EC_SHIFT);
00831 
00832         <span class="comment">//</span>
00833         <span class="comment">// Set RSE control states in the trap frame.</span>
00834         <span class="comment">//</span>
00835 
00836         TrapFrame-&gt;RsPFS = ContextFrame-&gt;RsPFS;
00837 
00838         BsFrameSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ContextFrame-&gt;StIFS &amp; PFS_SIZE_MASK);
00839         RNatSaveIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ContextFrame-&gt;RsBSP &gt;&gt; 3) &amp; NAT_BITS_PER_RNAT_REG);
00840 
00841         TempFrameSize = RNatSaveIndex + BsFrameSize - NAT_BITS_PER_RNAT_REG;
00842         <span class="keywordflow">while</span> (TempFrameSize &gt;= 0) {
00843             BsFrameSize++;
00844             TempFrameSize -= NAT_BITS_PER_RNAT_REG;
00845         }
00846 
00847         TrapFrame-&gt;RsBSPSTORE = ContextFrame-&gt;RsBSPSTORE + BsFrameSize * 8;
00848         TrapFrame-&gt;RsBSP = TrapFrame-&gt;RsBSPSTORE;
00849         TrapFrame-&gt;RsRSC = ContextFrame-&gt;RsRSC;
00850         TrapFrame-&gt;RsRNAT = ContextFrame-&gt;RsRNAT;
00851 
00852 <span class="preprocessor">#if DEBUG</span>
00853 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeContextToKFrames: RsRNAT = 0x%I64x\n"</span>, TrapFrame-&gt;RsRNAT);
00854 <span class="preprocessor">#endif // DEBUG</span>
00855 <span class="preprocessor"></span>
00856         <span class="comment">//</span>
00857         <span class="comment">// Set FPSR, IPSR, IIP, and IFS in the trap frame.</span>
00858         <span class="comment">//</span>
00859 
00860         TrapFrame-&gt;StFPSR = SANITIZE_FSR(ContextFrame-&gt;StFPSR, UserMode);
00861         TrapFrame-&gt;StIPSR = SANITIZE_PSR(ContextFrame-&gt;StIPSR, UserMode);
00862         <span class="keywordflow">if</span> (((TrapFrame-&gt;StIPSR &gt;&gt; PSR_RI) &amp; 3) == 3) {
00863             TrapFrame-&gt;StIPSR &amp;= ~(3i64 &lt;&lt; PSR_RI);
00864         }
00865         TrapFrame-&gt;StIFS  = SANITIZE_IFS(ContextFrame-&gt;StIFS, UserMode);
00866         TrapFrame-&gt;StIIP  = ContextFrame-&gt;StIIP;
00867 
00868         <span class="comment">//</span>
00869         <span class="comment">// DebugActive controls h/w debug registers. Set if new psr.db = 1</span>
00870         <span class="comment">//</span>
00871 
00872         <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;DebugActive = ((TrapFrame-&gt;StIPSR &amp; (1I64 &lt;&lt; PSR_DB)) != 0);
00873 
00874         <span class="comment">//</span>
00875         <span class="comment">// Set application registers directly</span>
00876         <span class="comment">//</span>
00877 
00878         <span class="keywordflow">if</span> (Thread == <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()) {
00879             __setReg(CV_IA64_AR21, ContextFrame-&gt;StFCR);
00880             __setReg(CV_IA64_AR24, ContextFrame-&gt;Eflag);
00881             __setReg(CV_IA64_AR25, ContextFrame-&gt;SegCSD);
00882             __setReg(CV_IA64_AR26, ContextFrame-&gt;SegSSD);
00883             __setReg(CV_IA64_AR27, ContextFrame-&gt;Cflag);
00884             __setReg(CV_IA64_AR28, ContextFrame-&gt;StFSR);
00885             __setReg(CV_IA64_AR29, ContextFrame-&gt;StFIR);
00886             __setReg(CV_IA64_AR30, ContextFrame-&gt;StFDR);
00887         } <span class="keywordflow">else</span> {
00888             PKAPPLICATION_REGISTERS AppRegs;
00889 
00890             AppRegs = GET_APPLICATION_REGISTER_SAVEAREA(Thread-&gt;StackBase);
00891             AppRegs-&gt;Ar21 = ContextFrame-&gt;StFCR;
00892             AppRegs-&gt;Ar24 = ContextFrame-&gt;Eflag;
00893             AppRegs-&gt;Ar25 = ContextFrame-&gt;SegCSD;
00894             AppRegs-&gt;Ar26 = ContextFrame-&gt;SegSSD;
00895             AppRegs-&gt;Ar27 = ContextFrame-&gt;Cflag;
00896             AppRegs-&gt;Ar28 = ContextFrame-&gt;StFSR;
00897             AppRegs-&gt;Ar29 = ContextFrame-&gt;StFIR;
00898             AppRegs-&gt;Ar30 = ContextFrame-&gt;StFDR;
00899         }
00900     }
00901 
00902     <span class="comment">//</span>
00903     <span class="comment">// Set integer registers contents if specified.</span>
00904     <span class="comment">//</span>
00905 
00906     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00907 
00908         TrapFrame-&gt;IntT0 = ContextFrame-&gt;IntT0;
00909         TrapFrame-&gt;IntT1 = ContextFrame-&gt;IntT1;
00910         TrapFrame-&gt;IntT2 = ContextFrame-&gt;IntT2;
00911         TrapFrame-&gt;IntT3 = ContextFrame-&gt;IntT3;
00912         TrapFrame-&gt;IntT4 = ContextFrame-&gt;IntT4;
00913         TrapFrame-&gt;IntV0 = ContextFrame-&gt;IntV0;
00914         TrapFrame-&gt;IntTeb = ContextFrame-&gt;IntTeb;
00915         TrapFrame-&gt;Preds = ContextFrame-&gt;Preds;
00916 
00917         <span class="comment">//</span>
00918         <span class="comment">// t5 - t22</span>
00919         <span class="comment">//</span>
00920 
00921         memcpy(&amp;TrapFrame-&gt;IntT5, &amp;ContextFrame-&gt;IntT5, 18*<span class="keyword">sizeof</span>(ULONGLONG));
00922 
00923         <span class="comment">//</span>
00924         <span class="comment">// Set integer registers s0 - s3 in exception frame.</span>
00925         <span class="comment">//</span>
00926 
00927         ExceptionFrame-&gt;IntS0 = ContextFrame-&gt;IntS0;
00928         ExceptionFrame-&gt;IntS1 = ContextFrame-&gt;IntS1;
00929         ExceptionFrame-&gt;IntS2 = ContextFrame-&gt;IntS2;
00930         ExceptionFrame-&gt;IntS3 = ContextFrame-&gt;IntS3;
00931 
00932         <span class="comment">//</span>
00933         <span class="comment">// Set the integer nats field in the trap &amp; exception frames</span>
00934         <span class="comment">//</span>
00935 
00936         R1Offset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)(&amp;TrapFrame-&gt;IntGp) &gt;&gt; 3) &amp; 0x3f;
00937         R4Offset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)(&amp;ExceptionFrame-&gt;IntS0) &gt;&gt; 3) &amp; 0x3f;
00938 
00939         <a class="code" href="../../d1/d6/ke_2ia64_2context_8c.html#a1">EXTRACT_NATS</a>(TrapFrame-&gt;IntNats, ContextFrame-&gt;IntNats,
00940                      1, R1Offset, 0xFFFFFF0E);
00941         <a class="code" href="../../d1/d6/ke_2ia64_2context_8c.html#a1">EXTRACT_NATS</a>(ExceptionFrame-&gt;IntNats, ContextFrame-&gt;IntNats,
00942                      4, R4Offset, 0xF0);
00943 
00944 <span class="preprocessor">#if DEBUG</span>
00945 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeContextToKFrames: TF-&gt;IntNats = 0x%I64x, ContestFrame-&gt;IntNats = 0x%I64x, R1OffSet = 0x%x\n"</span>,
00946                  TrapFrame-&gt;IntNats, ContextFrame-&gt;IntNats, R1Offset);
00947         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeContextToKFrames: EF-&gt;IntNats = 0x%I64x, R4OffSet = 0x%x\n"</span>,
00948                  ExceptionFrame-&gt;IntNats, R4Offset);
00949 <span class="preprocessor">#endif // DEBUG</span>
00950 <span class="preprocessor"></span>
00951         <span class="comment">//</span>
00952         <span class="comment">// Set other branch registers in trap and exception frames</span>
00953         <span class="comment">//</span>
00954 
00955         TrapFrame-&gt;BrT0 = ContextFrame-&gt;BrT0;
00956         TrapFrame-&gt;BrT1 = ContextFrame-&gt;BrT1;
00957 
00958         memcpy(&amp;ExceptionFrame-&gt;BrS0, &amp;ContextFrame-&gt;BrS0, 5*<span class="keyword">sizeof</span>(ULONGLONG));
00959 
00960     }
00961 
00962     <span class="comment">//</span>
00963     <span class="comment">// Set lower floating register contents if specified.</span>
00964     <span class="comment">//</span>
00965 
00966     <span class="keywordflow">if</span> ((ContextFlags &amp; CONTEXT_LOWER_FLOATING_POINT) == CONTEXT_LOWER_FLOATING_POINT) {
00967 
00968         TrapFrame-&gt;StFPSR = SANITIZE_FSR(ContextFrame-&gt;StFPSR, UserMode);
00969 
00970         <span class="comment">//</span>
00971         <span class="comment">// Set floating registers fs0 - fs19 in exception frame.</span>
00972         <span class="comment">//</span>
00973 
00974         RtlCopyIa64FloatRegisterContext(&amp;ExceptionFrame-&gt;FltS0, 
00975                                         &amp;ContextFrame-&gt;FltS0,
00976                                         <span class="keyword">sizeof</span>(FLOAT128) * (4));
00977 
00978         RtlCopyIa64FloatRegisterContext(&amp;ExceptionFrame-&gt;FltS4, 
00979                                         &amp;ContextFrame-&gt;FltS4,
00980                                         16*<span class="keyword">sizeof</span>(FLOAT128));
00981 
00982         <span class="comment">//</span>
00983         <span class="comment">// Set floating registers ft0 - ft9 in trap frame.</span>
00984         <span class="comment">//</span>
00985 
00986         RtlCopyIa64FloatRegisterContext(&amp;TrapFrame-&gt;FltT0, 
00987                                         &amp;ContextFrame-&gt;FltT0,
00988                                         <span class="keyword">sizeof</span>(FLOAT128) * (10));
00989 
00990     }
00991 
00992     <span class="comment">//</span>
00993     <span class="comment">// Set higher floating register contents if specified.</span>
00994     <span class="comment">//</span>
00995 
00996     <span class="keywordflow">if</span> ((ContextFlags &amp; CONTEXT_HIGHER_FLOATING_POINT) == CONTEXT_HIGHER_FLOATING_POINT) {
00997 
00998         TrapFrame-&gt;StFPSR = SANITIZE_FSR(ContextFrame-&gt;StFPSR, UserMode);
00999 
01000         <span class="comment">//</span>
01001         <span class="comment">// Update the higher floating point save area (f32-f127) and </span>
01002         <span class="comment">// set the corresponding modified bit in the PSR to 1.</span>
01003         <span class="comment">//</span>
01004 
01005         RtlCopyIa64FloatRegisterContext(
01006             (PFLOAT128)GET_HIGH_FLOATING_POINT_REGISTER_SAVEAREA(),
01007             &amp;ContextFrame-&gt;FltF32,
01008             96*<span class="keyword">sizeof</span>(FLOAT128)
01009             );
01010 
01011         TrapFrame-&gt;StIPSR |= (1i64 &lt;&lt; PSR_DFH);
01012 
01013     }
01014 
01015     <span class="comment">//</span>
01016     <span class="comment">// Set debug registers.</span>
01017     <span class="comment">//</span>
01018 
01019     <span class="keywordflow">if</span> ((ContextFlags &amp; CONTEXT_DEBUG) == CONTEXT_DEBUG) {
01020         <a class="code" href="../../d5/d0/psctxi64_8c.html#a3">KiSetDebugContext</a> (TrapFrame, ContextFrame, UserMode);
01021     }
01022 
01023     <span class="keywordflow">return</span>;
01024 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ia64/thredini.c::KeSetAutoAlignmentProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeSetAutoAlignmentProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Enable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/ia64_2thredini_8c-source.html#l00224">224</a> of file <a class="el" href="../../d7/d0/ia64_2thredini_8c-source.html">ia64/thredini.c</a>.
<p>
References <a class="el" href="../../d5/d0/alpha_2thredini_8c-source.html#l00048">ASSERT_PROCESS</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, and <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>.
<p>
<pre class="fragment"><div>00231                    :
00232 
00233     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data alignment handling mode <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00234     process and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous data alignment handling mode.
00235 
00236 Arguments:
00237 
00238     Process  - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> process.
00239 
00240     Enable - Supplies a <span class="keywordtype">boolean</span> value that determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handling of data
00241         alignment exceptions <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> causes all
00242         data alignment exceptions to be automatically handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel.
00243         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> causes all data alignment exceptions to be actually
00244         raised as exceptions.
00245 
00246 Return Value:
00247 
00248     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> data alignment exceptions were
00249     previously automatically handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel. Otherwise, a value
00250     of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00251 
00252 --*/
00253 
00254 {
00255 
00256     KIRQL OldIrql;
00257     BOOLEAN Previous;
00258 
00259     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00260 
00261     <span class="comment">//</span>
00262     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00263     <span class="comment">//</span>
00264 
00265     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00266 
00267     <span class="comment">//</span>
00268     <span class="comment">// Capture the previous data alignment handling mode and set the</span>
00269     <span class="comment">// specified data alignment mode.</span>
00270     <span class="comment">//</span>
00271 
00272     Previous = Process-&gt;AutoAlignment;
00273     Process-&gt;AutoAlignment = Enable;
00274 
00275     <span class="comment">//</span>
00276     <span class="comment">// Unlock dispatcher database, lower IRQL to its previous value, and</span>
00277     <span class="comment">// return the previous data alignment mode.</span>
00278     <span class="comment">//</span>
00279 
00280     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00281     <span class="keywordflow">return</span> Previous;
00282 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ia64/thredini.c::KeSetAutoAlignmentThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeSetAutoAlignmentThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Enable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/ia64_2thredini_8c-source.html#l00285">285</a> of file <a class="el" href="../../d7/d0/ia64_2thredini_8c-source.html">ia64/thredini.c</a>.
<p>
References <a class="el" href="../../d5/d0/alpha_2thredini_8c-source.html#l00052">ASSERT_THREAD</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, and <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>.
<p>
<pre class="fragment"><div>00292                    :
00293 
00294     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data alignment handling mode <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00295     thread and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous data alignment handling mode.
00296 
00297 Arguments:
00298 
00299     Thread  - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> thread.
00300 
00301     Enable - Supplies a <span class="keywordtype">boolean</span> value that determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handling of data
00302         alignment exceptions <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> causes all
00303         data alignment exceptions to be automatically handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel.
00304         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> causes all data alignment exceptions to be actually
00305         raised as exceptions.
00306 
00307 Return Value:
00308 
00309     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> data alignment exceptions were
00310     previously automatically handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel. Otherwise, a value
00311     of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00312 
00313 --*/
00314 
00315 {
00316 
00317     KIRQL OldIrql;
00318     BOOLEAN Previous;
00319 
00320     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
00321 
00322     <span class="comment">//</span>
00323     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00324     <span class="comment">//</span>
00325 
00326     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00327 
00328     <span class="comment">//</span>
00329     <span class="comment">// Capture the previous data alignment handling mode and set the</span>
00330     <span class="comment">// specified data alignment mode.</span>
00331     <span class="comment">//</span>
00332 
00333     Previous = Thread-&gt;AutoAlignment;
00334     Thread-&gt;AutoAlignment = Enable;
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">// Unlock dispatcher database, lower IRQL to its previous value, and</span>
00338     <span class="comment">// return the previous data alignment mode.</span>
00339     <span class="comment">//</span>
00340 
00341     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00342     <span class="keywordflow">return</span> Previous;
00343 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ia64/thredini.c::KiInitializeContextThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiInitializeContextThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a67">PKSYSTEM_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a> StartRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID StartContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT ContextRecord&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/ia64_2thredini_8c-source.html#l00055">55</a> of file <a class="el" href="../../d7/d0/ia64_2thredini_8c-source.html">ia64/thredini.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00240">CONTEXT_CONTROL</a>, <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00766">KeContextToKframesSpecial()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d0/ki_8h.html#a139">KiThreadStartup()</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
<pre class="fragment"><div>00065                    :
00066 
00067     This function initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> machine dependent context of a thread object.
00068 
00069     Actually, what <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to lay <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread so that
00070     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> contains a stack frame that will be picked up by SwapContext and
00071     returned thru, resulting in a transfer of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> to <a class="code" href="../../d0/d0/ki_8h.html#a139">KiThreadStartup</a>.
00072     In otherwords, we lay <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> a stack with a stack frame that looks as <span class="keywordflow">if</span>
00073     SwapContext had been called just before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first instruction in
00074     <a class="code" href="../../d0/d0/ki_8h.html#a139">KiThreadStartup</a>.
00075 
00076     N.B. This function does not check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> accessibility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record.
00077          It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller of <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> either prepared to
00078          handle access violations or has probed and copied <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record
00079          as appropriate.
00080 
00081     N.B. Arguments to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> thread are passed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Swap Frame preserved registers
00082          s0 - s3 which are restored by Swap Context when thread execution begins.
00083 
00084 Arguments:
00085 
00086     Thread - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> thread.
00087 
00088     SystemRoutine - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system function that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
00089         called when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> first scheduled <span class="keywordflow">for</span> execution.
00090 
00091         N.B. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine entry point, not a function pointer (plabel pointer).
00092 
00093     StartRoutine - Supplies an optional pointer to a function that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
00094         called after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has finished initializing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread. This
00095         parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a system thread and will
00096         execute totally in kernel mode.
00097 
00098         N.B. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine function pointer (plabel pointer).
00099 
00100     StartContext - Supplies an optional pointer to an arbitrary data structure
00101         which will be passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> StartRoutine as a parameter. This
00102         parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a system thread and will
00103         execute totally in kernel mode.
00104 
00105     ContextRecord - Supplies an optional pointer a context frame which contains
00106         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial user mode state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread. This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified
00107         <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a user thread and will execute in user mode. If <span class="keyword">this</span>
00108         parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Teb parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.
00109 
00110 Return Value:
00111 
00112     None.
00113 
00114 --*/
00115 
00116 {
00117 
00118     PKSWITCH_FRAME SwFrame;
00119     PKEXCEPTION_FRAME ExFrame;
00120     ULONG_PTR InitialStack;
00121     PKTRAP_FRAME TrFrame;
00122 
00123     <span class="comment">//</span>
00124     <span class="comment">// Set up the thread backing store pointers from the initial stack pointers.</span>
00125     <span class="comment">//</span>
00126 
00127     InitialStack = (ULONG_PTR)Thread-&gt;InitialStack;
00128     Thread-&gt;InitialBStore = (PVOID)InitialStack;
00129     Thread-&gt;BStoreLimit = (PVOID)(InitialStack + KERNEL_BSTORE_SIZE);
00130 
00131     <span class="comment">//</span>
00132     <span class="comment">// If a context frame is specified, then initialize a trap frame and</span>
00133     <span class="comment">// and an exception frame with the specified user mode context. Also</span>
00134     <span class="comment">// allocate the switch frame.</span>
00135     <span class="comment">//</span>
00136 
00137     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ContextRecord)) {
00138 
00139         TrFrame = (PKTRAP_FRAME)((InitialStack) 
00140                       - KTHREAD_STATE_SAVEAREA_LENGTH
00141                       - KTRAP_FRAME_LENGTH);
00142 
00143         ExFrame = (PKEXCEPTION_FRAME)(((ULONG_PTR)TrFrame + 
00144                       STACK_SCRATCH_AREA - 
00145                       <span class="keyword">sizeof</span>(KEXCEPTION_FRAME)) &amp; ~((ULONG_PTR)15));
00146 
00147         SwFrame = (PKSWITCH_FRAME)(((ULONG_PTR)ExFrame -
00148                       <span class="keyword">sizeof</span>(KSWITCH_FRAME)) &amp; ~((ULONG_PTR)15));
00149 
00150         <a class="code" href="../../d6/d1/ia64_2thredini_8c.html#a2">KeContextToKframesSpecial</a>(Thread, TrFrame, ExFrame,
00151                            ContextRecord,
00152                            ContextRecord-&gt;ContextFlags | CONTEXT_CONTROL);
00153 
00154         <span class="comment">//</span>
00155         <span class="comment">// Set the saved previous processor mode in the trap frame and the</span>
00156         <span class="comment">// previous processor mode in the thread object to user mode.</span>
00157         <span class="comment">//</span>
00158 
00159         TrFrame-&gt;PreviousMode = <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>;
00160         Thread-&gt;PreviousMode = <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>;
00161 
00162         <span class="comment">//</span>
00163         <span class="comment">// Initialize the FPSR for user mode</span>
00164         <span class="comment">//</span>
00165 
00166         TrFrame-&gt;StFPSR = USER_FPSR_INITIAL;
00167 
00168         <span class="comment">//</span>
00169         <span class="comment">// Initialize the user TEB pointer in the trap frame</span>
00170         <span class="comment">//</span>
00171 
00172         TrFrame-&gt;IntTeb = (ULONGLONG)Thread-&gt;Teb;
00173 
00174     } <span class="keywordflow">else</span> {
00175 
00176         SwFrame = (PKSWITCH_FRAME)((InitialStack) - <span class="keyword">sizeof</span>(KSWITCH_FRAME));
00177 
00178         <span class="comment">//</span>
00179         <span class="comment">// Set the previous mode in thread object to kernel.</span>
00180         <span class="comment">//</span>
00181 
00182         Thread-&gt;PreviousMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00183     }
00184 
00185     <span class="comment">//</span>
00186     <span class="comment">// Initialize context switch frame and set thread start up parameters.</span>
00187     <span class="comment">// The Swap return pointer and SystemRoutine are entry points, not function pointers.</span>
00188     <span class="comment">//</span>
00189 
00190     RtlZeroMemory((PVOID)SwFrame, <span class="keyword">sizeof</span>(KSWITCH_FRAME));   <span class="comment">// init all to 0</span>
00191 
00192     SwFrame-&gt;SwitchRp = ((PPLABEL_DESCRIPTOR)<a class="code" href="../../d0/d0/ki_8h.html#a139">KiThreadStartup</a>)-&gt;EntryPoint;
00193     SwFrame-&gt;SwitchExceptionFrame.IntS0 = (ULONGLONG)ContextRecord;
00194     SwFrame-&gt;SwitchExceptionFrame.IntS1 = (ULONGLONG)StartContext;
00195     SwFrame-&gt;SwitchExceptionFrame.IntS2 = (ULONGLONG)StartRoutine;
00196     SwFrame-&gt;SwitchExceptionFrame.IntS3 = 
00197         ((PPLABEL_DESCRIPTOR)SystemRoutine)-&gt;EntryPoint;
00198     SwFrame-&gt;SwitchFPSR = FPSR_FOR_KERNEL;
00199     SwFrame-&gt;SwitchBsp = (ULONGLONG)Thread-&gt;InitialBStore;
00200 
00201     Thread-&gt;KernelBStore = Thread-&gt;InitialBStore;
00202     Thread-&gt;KernelStack = (PVOID)((ULONG_PTR)SwFrame-STACK_SCRATCH_AREA);
00203 
00204     <span class="keywordflow">if</span> (Thread-&gt;Teb) {
00205         PKAPPLICATION_REGISTERS AppRegs;
00206 
00207         AppRegs = GET_APPLICATION_REGISTER_SAVEAREA(Thread-&gt;StackBase);
00208 
00209         AppRegs-&gt;Ar21 = 0; <span class="comment">// ContextRecord-&gt;StFCR;</span>
00210         AppRegs-&gt;Ar24 = SANITIZE_FLAGS((ULONG) ContextRecord-&gt;Eflag, UserMode);
00211         AppRegs-&gt;Ar25 = USER_CODE_DESCRIPTOR;
00212         AppRegs-&gt;Ar26 = USER_DATA_DESCRIPTOR;
00213         AppRegs-&gt;Ar27 = (ULONGLONG)((CR4_VME &lt;&lt; 32) | CR0_PE | CFLG_II);
00214         AppRegs-&gt;Ar28 = ContextRecord-&gt;StFSR;
00215         AppRegs-&gt;Ar29 = ContextRecord-&gt;StFIR;
00216         AppRegs-&gt;Ar30 = ContextRecord-&gt;StFDR;
00217         
00218     }
00219 
00220     <span class="keywordflow">return</span>;
00221 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:45 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
