<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hungapp.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hungapp.c</h1><a href="../../d5/d2/hungapp_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: hungapp.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">*</span>
00007 <span class="comment">* History:</span>
00008 <span class="comment">* 03-10-92 DavidPe      Created.</span>
00009 <span class="comment">\***************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00012 <span class="preprocessor">#pragma hdrstop</span>
00013 <span class="preprocessor"></span>
00014 
00015 <span class="comment">/***************************************************************************\</span>
00016 <span class="comment">* SetHungFlag</span>
00017 <span class="comment">*</span>
00018 <span class="comment">* Sets the specified redraw-if-hung flag in the window and adds the</span>
00019 <span class="comment">* window to the list of windows to redraw if hung.</span>
00020 <span class="comment">* Windows that are not top-level get the bit set, but aren't added to the list</span>
00021 <span class="comment">*</span>
00022 <span class="comment">* 08-23-93  JimA        Created.</span>
00023 <span class="comment">\***************************************************************************/</span>
<a name="l00024"></a><a class="code" href="../../d5/d2/hungapp_8c.html#a0">00024</a> <span class="preprocessor">#define CHRLINCR 10</span>
00025 <span class="preprocessor"></span>
<a name="l00026"></a><a class="code" href="../../d4/d1/userk_8h.html#a1125">00026</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1125">SetHungFlag</a>(
00027     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00028     WORD wFlag)
00029 {
00030     <span class="comment">/*</span>
00031 <span class="comment">     * If the window has no hung redraw bits set and it's a top-level</span>
00032 <span class="comment">     * window, add it to the redraw list.</span>
00033 <span class="comment">     */</span>
00034     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a580">WFANYHUNGREDRAW</a>) &amp;&amp; pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00035         <span class="comment">/*</span>
00036 <span class="comment">         * Add pwnd to the Hung Redraw Volatile Window Pointer List.</span>
00037 <span class="comment">         */</span>
00038         <a class="code" href="../../d4/d1/userk_8h.html#a1870">VWPLAdd</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a182">gpvwplHungRedraw</a>, pwnd, <a class="code" href="../../d5/d2/hungapp_8c.html#a0">CHRLINCR</a>);
00039     }
00040 
00041     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, wFlag);
00042 }
00043 
00044 
00045 <span class="comment">/***************************************************************************\</span>
00046 <span class="comment">* ClearHungFlag</span>
00047 <span class="comment">*</span>
00048 <span class="comment">* Clears the specified redraw-if-hung flag in the window and if no other</span>
00049 <span class="comment">* redraw-if-hung flags remain, remove the window from list of windows</span>
00050 <span class="comment">* to be redrawn if hung.</span>
00051 <span class="comment">* Many windows have WFREDRAW* bits set, but aren't in the list (only those</span>
00052 <span class="comment">* that were top-level were added).</span>
00053 <span class="comment">*</span>
00054 <span class="comment">* 08-23-93  JimA        Created.</span>
00055 <span class="comment">\***************************************************************************/</span>
00056 
<a name="l00057"></a><a class="code" href="../../d4/d1/userk_8h.html#a1126">00057</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1126">ClearHungFlag</a>(
00058     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00059     WORD wFlag)
00060 {
00061     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fInRedrawList = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a580">WFANYHUNGREDRAW</a>);
00062 
00063     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, wFlag);
00064     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a580">WFANYHUNGREDRAW</a>) &amp;&amp; fInRedrawList) {
00065         <span class="comment">/*</span>
00066 <span class="comment">         * Remove the window from the redraw list and possibly compact it.</span>
00067 <span class="comment">         */</span>
00068         <a class="code" href="../../d4/d1/userk_8h.html#a1871">VWPLRemove</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a182">gpvwplHungRedraw</a>, pwnd);
00069     }
00070 }
00071 
00072 
00073 <span class="comment">/***************************************************************************\</span>
00074 <span class="comment">* FHungApp</span>
00075 <span class="comment">*</span>
00076 <span class="comment">*</span>
00077 <span class="comment">* 02-28-92  DavidPe     Created.</span>
00078 <span class="comment">\***************************************************************************/</span>
00079 
<a name="l00080"></a><a class="code" href="../../d4/d1/userk_8h.html#a1650">00080</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(
00081     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
00082     DWORD dwTimeFromLastRead)
00083 {
00084 
00085     <span class="comment">/*</span>
00086 <span class="comment">     * An app is considered hung if it isn't waiting for input, isn't in</span>
00087 <span class="comment">     * startup processing, and hasn't called PeekMessage() within the</span>
00088 <span class="comment">     * specified timeout.</span>
00089 <span class="comment">     */</span>
00090     <span class="keywordflow">if</span> (((<a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() - <a class="code" href="../../d4/d1/userk_8h.html#a258">GET_TIME_LAST_READ</a>(pti)) &gt; dwTimeFromLastRead) &amp;&amp;
00091             !((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o4">fsWakeMask</a> &amp; QS_INPUT) &amp;&amp; (pti-&gt;pEThread-&gt;Tcb.FreezeCount == 0)) &amp;&amp;
00092             !(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags &amp; W32PF_APPSTARTING)) {
00093         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00094     }
00095 
00096     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00097 }
00098 
00099 
00100 <span class="comment">/***************************************************************************\</span>
00101 <span class="comment">* xxxRedrawHungWindowFrame</span>
00102 <span class="comment">*</span>
00103 <span class="comment">*</span>
00104 <span class="comment">* 02-28-92  DavidPe     Created.</span>
00105 <span class="comment">\***************************************************************************/</span>
00106 
<a name="l00107"></a><a class="code" href="../../d4/d1/userk_8h.html#a1652">00107</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1652">xxxRedrawHungWindowFrame</a>(
00108     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00109     BOOL fActive)
00110 {
00111     HDC hdc;
00112     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wFlags = DC_NC | DC_NOSENDMSG;
00113 
00114     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00115 
00116     <span class="keywordflow">if</span> (fActive)
00117         wFlags |= DC_ACTIVE;
00118 
00119     hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_USESTYLE | DCX_WINDOW);
00120     <a class="code" href="../../d4/d1/userk_8h.html#a1438">xxxDrawCaptionBar</a>(pwnd, hdc, wFlags);
00121     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00122 }
00123 
00124 
00125 <span class="comment">/***************************************************************************\</span>
00126 <span class="comment">* xxxRedrawHungWindow</span>
00127 <span class="comment">*</span>
00128 <span class="comment">* If the hrgnFullDrag is NULL, redraw the hung window's entire update region,</span>
00129 <span class="comment">* otherwise, only redraw the intersection of the window's update region</span>
00130 <span class="comment">* with the FullDrag region.</span>
00131 <span class="comment">*</span>
00132 <span class="comment">* 02-28-92  DavidPe     Created.</span>
00133 <span class="comment">\***************************************************************************/</span>
00134 
<a name="l00135"></a><a class="code" href="../../d4/d1/userk_8h.html#a1651">00135</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1651">xxxRedrawHungWindow</a>(
00136     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00137     HRGN hrgnFullDrag)
00138 {
00139     HDC     hdc;
00140     HBRUSH  hbr;
00141     HRGN    hrgnUpdate;
00142     RECT    rc;
00143     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd; <span class="comment">// should remove (IanJa)</span>
00144     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    flags;
00145     W32PID  sid;
00146     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwColor;
00147     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndDesk;
00148     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>      tlpwndDesk;
00149 
00150     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00151     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00152 
00153     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00154         <span class="keywordflow">return</span>;
00155     }
00156 
00157 <span class="preprocessor">#ifdef HUNGAPP_GHOSTING</span>
00158 <span class="preprocessor"></span>
00159     <span class="comment">/*</span>
00160 <span class="comment">     * Don't bother doing anything here when the window isn't even visible.</span>
00161 <span class="comment">     */</span>
00162     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
00163         <span class="keywordflow">return</span>;
00164     }
00165 
00166     <span class="comment">/*</span>
00167 <span class="comment">     * This function can be called from the full-drag code to quick redraw</span>
00168 <span class="comment">     * windows that aren't hung. In that case check if that thread is hung.</span>
00169 <span class="comment">     */</span>
00170     <span class="keywordflow">if</span> ((hrgnFullDrag == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (hrgnFullDrag != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00171             <a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a912">CMSHUNGAPPTIMEOUT</a>))) {
00172         SignalGhost(pwnd);
00173     }
00174 
00175 <span class="preprocessor">#endif // HUNGAPP_GHOSTING</span>
00176 <span class="preprocessor"></span>
00177     <span class="comment">/*</span>
00178 <span class="comment">     * First calculate hrgnUpdate.</span>
00179 <span class="comment">     */</span>
00180     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00181         hrgnUpdate = <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>();
00182         <span class="keywordflow">if</span> (hrgnUpdate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00183             hrgnUpdate = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00184 
00185         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(hrgnUpdate, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>) == ERROR) {
00186             GreDeleteObject(hrgnUpdate);
00187             hrgnUpdate = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00188         }
00189 
00190     } <span class="keywordflow">else</span> {
00191 
00192         <span class="comment">/*</span>
00193 <span class="comment">         * For our purposes, we need a real hrgnUpdate, so try and</span>
00194 <span class="comment">         * create one if even if the entire window needs updating.</span>
00195 <span class="comment">         */</span>
00196         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
00197         hrgnUpdate = GreCreateRectRgnIndirect(&amp;rc);
00198         <span class="keywordflow">if</span> (hrgnUpdate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00199             hrgnUpdate = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00200         }
00201     }
00202 
00203     <span class="comment">/*</span>
00204 <span class="comment">     * If we're redrawing because we're full dragging and if the window's</span>
00205 <span class="comment">     * update region does not intersect with the Full drag</span>
00206 <span class="comment">     * update region, don't erase the hung window again. This is to prevent</span>
00207 <span class="comment">     * flickering when a window has been invalidated by another window doing</span>
00208 <span class="comment">     * full drag and hasn't received the paint message yet.</span>
00209 <span class="comment">     * This way, only if there is a new region that has been invalidated will</span>
00210 <span class="comment">     * we redraw the hung window.</span>
00211 <span class="comment">     */</span>
00212     <span class="keywordflow">if</span> (hrgnFullDrag &amp;&amp; hrgnUpdate != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a> &amp;&amp;
00213             <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(hrgnUpdate, hrgnUpdate, hrgnFullDrag) == NULLREGION) {
00214         GreDeleteObject(hrgnUpdate);
00215         <span class="keywordflow">return</span>;
00216     }
00217 
00218     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd); <span class="comment">// should remove (IanJa)</span>
00219 
00220     hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd, hrgnUpdate, DCX_USESTYLE | DCX_WINDOW |
00221             DCX_INTERSECTRGN | DCX_NODELETERGN | DCX_LOCKWINDOWUPDATE);
00222     <a class="code" href="../../d4/d1/userk_8h.html#a1443">xxxDrawWindowFrame</a>(pwnd, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a743">TestwndFrameOn</a>(pwnd));
00223     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00224 
00225     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
00226     <a class="code" href="../../d4/d1/userk_8h.html#a1531">xxxCalcClientRect</a>(pwnd, &amp;rc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00227     <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, &amp;rc);
00228 
00229     <span class="keywordflow">if</span> (hrgnUpdate &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00230         <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(hrgnUpdate, hrgnUpdate, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>)) {
00231 
00232         <span class="keywordflow">case</span> ERROR:
00233             GreDeleteObject(hrgnUpdate);
00234             hrgnUpdate = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00235             <span class="keywordflow">break</span>;
00236 
00237         <span class="keywordflow">case</span> NULLREGION:
00238             <span class="comment">/*</span>
00239 <span class="comment">             * There is nothing in the client area to repaint.</span>
00240 <span class="comment">             * Blow the region away, and decrement the paint count</span>
00241 <span class="comment">             * if possible.</span>
00242 <span class="comment">             */</span>
00243             GreDeleteObject(hrgnUpdate);
00244             hrgnUpdate = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00245             <span class="keywordflow">break</span>;
00246         }
00247     }
00248 
00249     <span class="comment">/*</span>
00250 <span class="comment">     * Erase the rest of the window.</span>
00251 <span class="comment">     * When pwnd isn't WFCLIPCHILDREN, make sure valid children bits</span>
00252 <span class="comment">     * don't get overwritten if the child is in the middle of BeginPaint</span>
00253 <span class="comment">     * or just completed it's painting and it's hrgnUpdate is NULL.</span>
00254 <span class="comment">     */</span>
00255     <span class="keywordflow">if</span> (hrgnUpdate != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>)) {
00256         RECT rcT;
00257         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00258 
00259         <span class="keywordflow">if</span> (hrgnUpdate == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00260             rc = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
00261         } <span class="keywordflow">else</span> {
00262             GreGetRgnBox(hrgnUpdate, &amp;rc);
00263         }
00264 
00265         <span class="keywordflow">for</span> (pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>; pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00266                 pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
00267 
00268             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>) &amp;&amp;
00269                     (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a586">WFSTARTPAINT</a>) || pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00270                     <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcT, &amp;rc, &amp;pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>)) {
00271 
00272                 <span class="comment">/*</span>
00273 <span class="comment">                 * This invalidate call won't leave the critial section. In</span>
00274 <span class="comment">                 * reality the entire xxxRedrawHungWindow must not leave</span>
00275 <span class="comment">                 * the critical section.</span>
00276 <span class="comment">                 */</span>
00277                 <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00278                 <a class="code" href="../../d4/d1/userk_8h.html#a1681">xxxInternalInvalidate</a>(pwndT, hrgnUpdate, RDW_INVALIDATE |
00279                         RDW_FRAME | RDW_ERASE | RDW_ALLCHILDREN);
00280                 <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
00281             }
00282         }
00283     }
00284 
00285     <span class="comment">/*</span>
00286 <span class="comment">     * Get a window dc so that the menu and scroll bar areas are erased</span>
00287 <span class="comment">     * appropriately. But make sure it is clipped so that the children</span>
00288 <span class="comment">     * get clipped out correctly! If we don't do this, this we could erase</span>
00289 <span class="comment">     * children that aren't invalid.</span>
00290 <span class="comment">     *</span>
00291 <span class="comment">     * Note: DCX_WINDOW and DCX_USESTYLE will never clip out children.</span>
00292 <span class="comment">     * Need to pass the clipping styles in directly, instead of passing</span>
00293 <span class="comment">     * DCX_USESTYLE.</span>
00294 <span class="comment">     */</span>
00295     flags = DCX_INTERSECTRGN | DCX_WINDOW | DCX_CACHE;
00296     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>))
00297         flags |= DCX_CLIPSIBLINGS;
00298     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>))
00299         flags |= DCX_CLIPCHILDREN;
00300 
00301     hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd, hrgnUpdate, flags);
00302 
00303     <span class="keywordflow">if</span> (pwnd == pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;pDeskInfo-&gt;spwndBkGnd) {
00304         pwndDesk = <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd);
00305         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndDesk, &amp;tlpwndDesk);
00306         <a class="code" href="../../d4/d1/userk_8h.html#a1444">xxxInternalPaintDesktop</a>(<a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd), hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00307         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndDesk);
00308 
00309     } <span class="keywordflow">else</span> {
00310 
00311          rc = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
00312 
00313          <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rc, -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left, -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top);
00314 
00315          <span class="comment">/*</span>
00316 <span class="comment">          * Erase the rest of the window using the window' class background</span>
00317 <span class="comment">          * brush.</span>
00318 <span class="comment">          */</span>
00319          <span class="keywordflow">if</span> ((hbr = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;hbrBackground) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00320              <span class="keywordflow">if</span> (hbr &lt;= (HBRUSH)COLOR_ENDCOLORS + 1)
00321                  hbr = <a class="code" href="../../d1/d0/inc_2user_8h.html#a15">SYSHBRUSH</a>((ULONG_PTR)hbr - 1);
00322          } <span class="keywordflow">else</span> {
00323              <span class="comment">/*</span>
00324 <span class="comment">              * Use the window brush for windows and 3.x dialogs,</span>
00325 <span class="comment">              * Use the COLOR3D brush for 4.x dialogs.</span>
00326 <span class="comment">              */</span>
00327              <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a567">WFDIALOGWINDOW</a>) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>))
00328                  hbr = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(3DFACE);
00329              <span class="keywordflow">else</span>
00330                  hbr = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a273">WINDOW</a>);
00331          }
00332 
00333         <span class="comment">/*</span>
00334 <span class="comment">         * If the window's class background brush is public, use it.</span>
00335 <span class="comment">         */</span>
00336         sid = (W32PID)GreGetObjectOwner((HOBJ)hbr, BRUSH_TYPE);
00337         <span class="keywordflow">if</span> (sid == (W32PID)(ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a19">GetCurrentProcessId</a>() || sid == OBJECT_OWNER_PUBLIC) {
00338 
00339             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, &amp;rc, hbr);
00340 
00341         } <span class="keywordflow">else</span> {
00342 
00343             <span class="comment">/*</span>
00344 <span class="comment">             * The window's class background brush is not public.</span>
00345 <span class="comment">             * We get its color and set the color of our own public brush and use</span>
00346 <span class="comment">             * that for the background brush.</span>
00347 <span class="comment">             */</span>
00348 
00349             <span class="comment">/*</span>
00350 <span class="comment">             * If the window is a console window, get the console background brush.</span>
00351 <span class="comment">             * This brush will be different than the console class brush if the user</span>
00352 <span class="comment">             * changed the console background color.</span>
00353 <span class="comment">             */</span>
00354             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a281">gatomConsoleClass</a> == pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a>) {
00355 
00356                 dwColor = <a class="code" href="../../d4/d1/userk_8h.html#a589">_GetWindowLong</a>(pwnd, GWL_CONSOLE_BKCOLOR);
00357 
00358             } <span class="keywordflow">else</span> {
00359 
00360                 <span class="keywordflow">if</span> ((dwColor = GreGetBrushColor(hbr)) == -1)
00361                     dwColor = GreGetBrushColor(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a273">WINDOW</a>));
00362             }
00363 
00364             GreSetSolidBrush(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a129">ghbrHungApp</a>, dwColor);
00365 
00366             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, &amp;rc, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a129">ghbrHungApp</a>);
00367         }
00368     }
00369     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00370 
00371     <span class="comment">/*</span>
00372 <span class="comment">     * The window has been erased and framed. It only did this because the</span>
00373 <span class="comment">     * app hasn't done it yet:</span>
00374 <span class="comment">     *</span>
00375 <span class="comment">     * - the app hasn't erased and frame yet.</span>
00376 <span class="comment">     * - the app is in the middle of erasing and framing.</span>
00377 <span class="comment">     *</span>
00378 <span class="comment">     * The app could not of completed erasing and framing, because the</span>
00379 <span class="comment">     * WFREDRAWIFHUNG bit is cleared when this successfully completes.</span>
00380 <span class="comment">     *</span>
00381 <span class="comment">     * Given that the app may be in the middle of erasing and framing, we</span>
00382 <span class="comment">     * need to set both the erase and frame bits *again* so it erasing and</span>
00383 <span class="comment">     * frames over again (if we don't, it never will). If the app hasn't</span>
00384 <span class="comment">     * done any erasing/framing yet, this is a nop.</span>
00385 <span class="comment">     */</span>
00386     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>);
00387     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>);
00388 
00389     <span class="comment">/*</span>
00390 <span class="comment">     * Always set WFUPDATEDIRTY: we don't want the app to draw, then stop</span>
00391 <span class="comment">     * and have the hung app thread draw, and then allow the app to validate</span>
00392 <span class="comment">     * itself: Mark the update region dirty - cannot be validated until the</span>
00393 <span class="comment">     * app calls a painting function and acknowledges the update region.</span>
00394 <span class="comment">     */</span>
00395     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a564">WFUPDATEDIRTY</a>);
00396 
00397 <span class="preprocessor">#ifdef WIN95DOESTHIS</span>
00398 <span class="preprocessor"></span>    <span class="comment">/*</span>
00399 <span class="comment">     * Go through all the children and redraw hung ones too.</span>
00400 <span class="comment">     */</span>
00401     <span class="keywordflow">if</span> (hrgnFullDrag != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00402         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndT;
00403         <a class="code" href="../../d5/d1/struct__TL.html">TL</a>      tlpwndT;
00404 
00405         pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
00406         <a class="code" href="../../d4/d1/userk_8h.html#a115">ThreadLockNever</a>(&amp;tlpwndT);
00407         <span class="keywordflow">while</span> (pwndT) {
00408 
00409             <span class="keywordflow">if</span> (    <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a578">WFREDRAWIFHUNG</a>) &amp;&amp;
00410                     <a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a912">CMSHUNGAPPTIMEOUT</a>)) {
00411 
00412                 <a class="code" href="../../d4/d1/userk_8h.html#a1126">ClearHungFlag</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a578">WFREDRAWIFHUNG</a>);
00413                 <a class="code" href="../../d4/d1/userk_8h.html#a983">ThreadLockExchangeAlways</a>(pwndT, &amp;tlpwndT);
00414                 <a class="code" href="../../d4/d1/userk_8h.html#a1651">xxxRedrawHungWindow</a>(pwndT, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00415             }
00416 
00417             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>)) {
00418                 <span class="keywordflow">break</span>;
00419             }
00420 
00421             pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
00422         }
00423 
00424         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00425     }
00426 <span class="preprocessor">#endif</span>
00427 <span class="preprocessor"></span>
00428     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd); <span class="comment">// should remove (IanJa)</span>
00429 }
00430 
00431 
00432 <span class="comment">/***************************************************************************\</span>
00433 <span class="comment">* xxxHungAppDemon</span>
00434 <span class="comment">*</span>
00435 <span class="comment">* NOTE: RIT timers (like this one) get called while inside an EnterCrit block.</span>
00436 <span class="comment">*</span>
00437 <span class="comment">* We keep a list of redraw-if-hung windows in a list that remains in a</span>
00438 <span class="comment">* single page to avoid touching the windows themselves each time through</span>
00439 <span class="comment">* this routine.  Touching the windows causes a bunch of unnecessary paging</span>
00440 <span class="comment">* and in effect keeps all of the pages that contain top-level windows</span>
00441 <span class="comment">* resident at all times; this is very wasteful.</span>
00442 <span class="comment">*</span>
00443 <span class="comment">* 02-28-92  DavidPe     Created.</span>
00444 <span class="comment">\***************************************************************************/</span>
00445 
<a name="l00446"></a><a class="code" href="../../d4/d1/userk_8h.html#a1656">00446</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1656">xxxHungAppDemon</a>(
00447     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00448     UINT message,
00449     UINT_PTR nID,
00450     LPARAM lParam)
00451 {
00452     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>      tlpwnd;
00453 <span class="preprocessor">#if DBG</span>
00454 <span class="preprocessor"></span>    <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndT;
00455 <span class="preprocessor">#endif</span>
00456 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> nPwndHungRedraw;
00457     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndHungRedraw;
00458 
00459 
00460 
00461     UNREFERENCED_PARAMETER(message);
00462     UNREFERENCED_PARAMETER(nID);
00463 
00464     UNREFERENCED_PARAMETER(lParam);
00465     UNREFERENCED_PARAMETER(pwnd);
00466     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00467 
00468     <span class="comment">/*</span>
00469 <span class="comment">     * See if we should start the screen saver.</span>
00470 <span class="comment">     */</span>
00471     <a class="code" href="../../d4/d1/userk_8h.html#a1635">IdleTimerProc</a>();
00472 
00473     <span class="comment">/*</span>
00474 <span class="comment">     * If it is time to hide the app starting cursor, do it.</span>
00475 <span class="comment">     */</span>
00476     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() &gt;= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a74">gtimeStartCursorHide</a>) {
00477         <span class="comment">/*</span>
00478 <span class="comment">         * No need to DeferWinEventNotify()</span>
00479 <span class="comment">         */</span>
00480         <a class="code" href="../../d4/d1/userk_8h.html#a1490">zzzCalcStartCursorHide</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00481     }
00482 
00483     <span class="comment">/*</span>
00484 <span class="comment">     * Now check to see if there are any top-level</span>
00485 <span class="comment">     * windows that need redrawing.</span>
00486 <span class="comment">     */</span>
00487     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00488         <span class="keywordflow">return</span>;
00489 
00490     <span class="comment">/*</span>
00491 <span class="comment">     * Walk down the list of redraw-if-hung windows.  Loop</span>
00492 <span class="comment">     * until we hit the end of the array or find a NULL.</span>
00493 <span class="comment">     */</span>
00494     nPwndHungRedraw = 0;
00495     pwndHungRedraw = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00496     <span class="keywordflow">while</span> (pwndHungRedraw = <a class="code" href="../../d4/d1/userk_8h.html#a1872">VWPLNext</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a182">gpvwplHungRedraw</a>, pwndHungRedraw, &amp;nPwndHungRedraw)) {
00497         <span class="comment">/*</span>
00498 <span class="comment">         * See if the app is hung.  If so, do the appropriate</span>
00499 <span class="comment">         * redrawing.</span>
00500 <span class="comment">         */</span>
00501         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndHungRedraw), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a912">CMSHUNGAPPTIMEOUT</a>)) {
00502             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndHungRedraw, &amp;tlpwnd);
00503             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndHungRedraw, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a579">WFREDRAWFRAMEIFHUNG</a>)) {
00504 
00505                 <span class="comment">/*</span>
00506 <span class="comment">                 * WFREDRAWFRAMEIFHUNG will be cleared in the process</span>
00507 <span class="comment">                 * of drawing the frame, no need to clear it here.</span>
00508 <span class="comment">                 */</span>
00509                 <a class="code" href="../../d4/d1/userk_8h.html#a1652">xxxRedrawHungWindowFrame</a>(pwndHungRedraw, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a743">TestwndFrameOn</a>(pwndHungRedraw));
00510             }
00511 
00512             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndHungRedraw, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a578">WFREDRAWIFHUNG</a>)) {
00513                 <a class="code" href="../../d4/d1/userk_8h.html#a1126">ClearHungFlag</a>(pwndHungRedraw, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a578">WFREDRAWIFHUNG</a>);
00514                 <a class="code" href="../../d4/d1/userk_8h.html#a1651">xxxRedrawHungWindow</a>(pwndHungRedraw, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00515             }
00516 <span class="preprocessor">            #if DBG</span>
00517 <span class="preprocessor"></span>                pwndT =
00518 <span class="preprocessor">            #endif</span>
00519 <span class="preprocessor"></span>
00520             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00521         }
00522     }
00523 
00524     <span class="keywordflow">return</span>;
00525 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:18 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
