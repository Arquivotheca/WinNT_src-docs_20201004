<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: initia64.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>initia64.c</h1><a href="../../d5/d2/config_2ia64_2initia64_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990, 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    init386.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module is responsible to build any x86 specific entries in</span>
00013 <span class="comment">    the hardware tree of registry.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Ken Reneris (kenr) 04-Aug-1992</span>
00018 <span class="comment"></span>
00019 <span class="comment"></span>
00020 <span class="comment">Environment:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    Kernel mode.</span>
00023 <span class="comment"></span>
00024 <span class="comment">Revision History:</span>
00025 <span class="comment"></span>
00026 <span class="comment">    shielint - add BIOS date and version detection.</span>
00027 <span class="comment"></span>
00028 <span class="comment">--*/</span>
00029 
00030 <span class="preprocessor">#include "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00031 <span class="preprocessor">#include "stdio.h"</span>
00032 
00033 <span class="comment">//</span>
00034 <span class="comment">// Title Index is set to 0.</span>
00035 <span class="comment">// (from ..\cmconfig.c)</span>
00036 <span class="comment">//</span>
00037 
<a name="l00038"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a0">00038</a> <span class="preprocessor">#define TITLE_INDEX_VALUE 0</span>
00039 <span class="preprocessor"></span>
<a name="l00040"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a12">00040</a> <span class="keyword">extern</span> PCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a16">SearchStrings</a>[];
<a name="l00041"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a13">00041</a> <span class="keyword">extern</span> PCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a17">BiosBegin</a>;
<a name="l00042"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">00042</a> <span class="keyword">extern</span> PCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
<a name="l00043"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a15">00043</a> <span class="keyword">extern</span> PCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
<a name="l00044"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a16">00044</a> <span class="keyword">extern</span> UCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a20">CmpID1</a>[];
<a name="l00045"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a17">00045</a> <span class="keyword">extern</span> UCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a21">CmpID2</a>[];
<a name="l00046"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a18">00046</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a22">CmpVendorID</a>[];
<a name="l00047"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a19">00047</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a23">CmpProcessorNameString</a>[];
<a name="l00048"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a20">00048</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a24">CmpFeatureBits</a>[];
<a name="l00049"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a21">00049</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a25">CmpMHz</a>[];
<a name="l00050"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a22">00050</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a26">CmpUpdateSignature</a>[];
<a name="l00051"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a23">00051</a> <span class="keyword">extern</span> UCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a28">CmpCyrixID</a>[];
<a name="l00052"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a24">00052</a> <span class="keyword">extern</span> UCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a29">CmpIntelID</a>[];
<a name="l00053"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a25">00053</a> <span class="keyword">extern</span> UCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a30">CmpAmdID</a>[];
00054 
00055 <span class="comment">//</span>
00056 <span class="comment">// Bios date and version definitions</span>
00057 <span class="comment">//</span>
00058 
<a name="l00059"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a1">00059</a> <span class="preprocessor">#define BIOS_DATE_LENGTH 9</span>
<a name="l00060"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a2">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define MAXIMUM_BIOS_VERSION_LENGTH 128</span>
<a name="l00061"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a3">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define SYSTEM_BIOS_START 0xF0000</span>
<a name="l00062"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a4">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define SYSTEM_BIOS_LENGTH 0x10000</span>
<a name="l00063"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a5">00063</a> <span class="preprocessor"></span><span class="preprocessor">#define INT10_VECTOR 0x10</span>
<a name="l00064"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a6">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define VIDEO_BIOS_START 0xC0000</span>
<a name="l00065"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a7">00065</a> <span class="preprocessor"></span><span class="preprocessor">#define VIDEO_BIOS_LENGTH 0x8000</span>
<a name="l00066"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a8">00066</a> <span class="preprocessor"></span><span class="preprocessor">#define VERSION_DATA_LENGTH PAGE_SIZE</span>
00067 <span class="preprocessor"></span>
00068 <span class="comment">//</span>
00069 <span class="comment">// Extended CPUID function definitions</span>
00070 <span class="comment">//</span>
00071 
<a name="l00072"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a9">00072</a> <span class="preprocessor">#define CPUID_PROCESSOR_NAME_STRING_SZ  48</span>
<a name="l00073"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a10">00073</a> <span class="preprocessor"></span><span class="preprocessor">#define CPUID_EXTFN_BASE                0x80000000</span>
<a name="l00074"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a11">00074</a> <span class="preprocessor"></span><span class="preprocessor">#define CPUID_EXTFN_PROCESSOR_NAME      0x80000002</span>
00075 <span class="preprocessor"></span>
00076 
<a name="l00077"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a26">00077</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a9">CmpConfigurationAreaSize</a>;
<a name="l00078"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a27">00078</a> <span class="keyword">extern</span> PCM_FULL_RESOURCE_DESCRIPTOR <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>;
00079 
00080 
00081 BOOLEAN
00082 <a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a28">CmpGetBiosVersion</a> (
00083     PCHAR SearchArea,
00084     ULONG SearchLength,
00085     PCHAR VersionString
00086     );
00087 
00088 BOOLEAN
00089 <a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a29">CmpGetBiosDate</a> (
00090     PCHAR SearchArea,
00091     ULONG SearchLength,
00092     PCHAR DateString
00093     );
00094 
00095 ULONG
00096 <a class="code" href="../../d9/d1/cyrix_8c.html#a24">Ke386CyrixId</a> (
00097     VOID
00098     );
00099 
00100 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00101 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpGetBiosDate)</span>
00102 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpGetBiosVersion)</span>
00103 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpInitializeMachineDependentConfiguration)</span>
00104 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00105 <span class="preprocessor"></span>
00106 
00107 BOOLEAN
<a name="l00108"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a29">00108</a> <a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a29">CmpGetBiosDate</a> (
00109     PCHAR SearchArea,
00110     ULONG SearchLength,
00111     PCHAR DateString
00112     )
00113 
00114 <span class="comment">/*++</span>
00115 <span class="comment"></span>
00116 <span class="comment">Routine Description:</span>
00117 <span class="comment"></span>
00118 <span class="comment">    This routine finds the most recent date in the computer/video</span>
00119 <span class="comment">    card's ROM.  When GetRomDate encounters a datae, it checks the</span>
00120 <span class="comment">    previously found date to see if the new date is more recent.</span>
00121 <span class="comment"></span>
00122 <span class="comment">Arguments:</span>
00123 <span class="comment"></span>
00124 <span class="comment">    SearchArea - the area to search for a date.</span>
00125 <span class="comment"></span>
00126 <span class="comment">    SearchLength - Length of search.</span>
00127 <span class="comment"></span>
00128 <span class="comment">    DateString - Supplies a pointer to a fixed length memory to receive</span>
00129 <span class="comment">                 the date string.</span>
00130 <span class="comment"></span>
00131 <span class="comment">Return Value:</span>
00132 <span class="comment"></span>
00133 <span class="comment">    NT_SUCCESS if a date is found.</span>
00134 <span class="comment"></span>
00135 <span class="comment">--*/</span>
00136 
00137 {
00138     BOOLEAN FoundFlag = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;        <span class="comment">// Set to TRUE if the item was found</span>
00139     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> PrevDate[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a1">BIOS_DATE_LENGTH</a>]; <span class="comment">// Date currently being examined</span>
00140     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> CurrDate[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a1">BIOS_DATE_LENGTH</a>]; <span class="comment">// Date currently being examined</span>
00141     PCHAR <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
00142     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i;                        <span class="comment">// Looping variable</span>
00143     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Length;                   <span class="comment">// Number of characters to move</span>
00144     PCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = SearchArea + 2;
00145     PCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = SearchArea + SearchLength - 5;
00146 
00147     <span class="comment">//</span>
00148     <span class="comment">// Clear out the previous date</span>
00149     <span class="comment">//</span>
00150 
00151     RtlZeroMemory(PrevDate, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a1">BIOS_DATE_LENGTH</a>);
00152 
00153     <span class="keywordflow">while</span> (FoundFlag) {
00154 
00155         <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00156 
00157         <span class="comment">//</span>
00158         <span class="comment">// Search for '/' with a digit on either side and another</span>
00159         <span class="comment">// '/' 3 character away.</span>
00160         <span class="comment">//</span>
00161 
00162         <span class="keywordflow">while</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) {
00163             <span class="keywordflow">if</span> (*<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> == <span class="charliteral">'/'</span> &amp;&amp; *(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>+3) == <span class="charliteral">'/'</span> &amp;&amp;
00164                 (*(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>+1) &lt;= <span class="charliteral">'9'</span> &amp;&amp; *(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>+1) &gt;= <span class="charliteral">'0'</span>) &amp;&amp;
00165                 (*(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>-1) &lt;= <span class="charliteral">'9'</span> &amp;&amp; *(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>-1) &gt;= <span class="charliteral">'0'</span>) &amp;&amp;
00166                 (*(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>+5) &lt;= <span class="charliteral">'9'</span> &amp;&amp; *(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>+5) &gt;= <span class="charliteral">'0'</span>) &amp;&amp;
00167                 (*(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>+4) &lt;= <span class="charliteral">'9'</span> &amp;&amp; *(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>+4) &gt;= <span class="charliteral">'0'</span>) &amp;&amp;
00168                 (*(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>+2) &lt;= <span class="charliteral">'9'</span> &amp;&amp; *(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>+2) &gt;= <span class="charliteral">'0'</span>)) {
00169 
00170                 <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00171                 <span class="keywordflow">break</span>;
00172             } <span class="keywordflow">else</span> {
00173                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>++;
00174             }
00175         }
00176 
00177         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>) {
00178             <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> + 3;
00179             <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> -= 2;                 <span class="comment">// Move String to the beginning of</span>
00180                                          <span class="comment">//   date.</span>
00181             <span class="comment">//</span>
00182             <span class="comment">// Copy the year into CurrDate</span>
00183             <span class="comment">//</span>
00184 
00185             CurrDate[0] = <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>[6];
00186             CurrDate[1] = <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>[7];
00187             CurrDate[2] = <span class="charliteral">'/'</span>;           <span class="comment">// The 1st "/" for YY/MM/DD</span>
00188 
00189             <span class="comment">//</span>
00190             <span class="comment">// Copy the month &amp; day into CurrDate</span>
00191             <span class="comment">//   (Process properly if this is a one digit month)</span>
00192             <span class="comment">//</span>
00193 
00194             <span class="keywordflow">if</span> (*<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> &gt; <span class="charliteral">'9'</span> || *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> &lt; <span class="charliteral">'0'</span>) {
00195                 CurrDate[3] = <span class="charliteral">'0'</span>;
00196                 <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>++;
00197                 i = 4;
00198                 Length = 4;
00199             } <span class="keywordflow">else</span> {
00200                 i = 3;
00201                 Length = 5;
00202             }
00203 
00204             RtlMoveMemory(&amp;CurrDate[i], <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>, Length);
00205 
00206             <span class="comment">//</span>
00207             <span class="comment">// Compare the dates, to see which is more recent</span>
00208             <span class="comment">//</span>
00209 
00210             <span class="keywordflow">if</span> (memcmp (PrevDate, CurrDate, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a1">BIOS_DATE_LENGTH</a> - 1) &lt; 0) {
00211                 RtlMoveMemory(PrevDate, CurrDate, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a1">BIOS_DATE_LENGTH</a> - 1);
00212             }
00213         } <span class="keywordflow">else</span> {
00214             FoundFlag = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00215         }
00216     }
00217 
00218     <span class="comment">//</span>
00219     <span class="comment">// If we did not find a date</span>
00220     <span class="comment">//</span>
00221 
00222     <span class="keywordflow">if</span> (PrevDate[0] == <span class="charliteral">'\0'</span>) {
00223         DateString[0] = <span class="charliteral">'\0'</span>;
00224         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00225     }
00226 
00227     <span class="comment">//</span>
00228     <span class="comment">// Put the date from chPrevDate's YY/MM/DD format</span>
00229     <span class="comment">//   into pchDateString's MM/DD/YY format</span>
00230 
00231     DateString[5] = <span class="charliteral">'/'</span>;
00232     DateString[6] = PrevDate[0];
00233     DateString[7] = PrevDate[1];
00234     RtlMoveMemory(DateString, &amp;PrevDate[3], 5);
00235     DateString[8] = <span class="charliteral">'\0'</span>;
00236 
00237     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00238 }
00239 
00240 BOOLEAN
00241 <a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a28">CmpGetBiosVersion</a> (
00242     PCHAR SearchArea,
00243     ULONG SearchLength,
00244     PCHAR VersionString
00245     )
00246 
00247 <span class="comment">/*++</span>
00248 <span class="comment"></span>
00249 <span class="comment">Routine Description:</span>
00250 <span class="comment"></span>
00251 <span class="comment">    This routine finds the version number stored in ROM, if any.</span>
00252 <span class="comment"></span>
00253 <span class="comment">Arguments:</span>
00254 <span class="comment"></span>
00255 <span class="comment">    SearchArea - the area to search for the version.</span>
00256 <span class="comment"></span>
00257 <span class="comment">    SearchLength - Length of search</span>
00258 <span class="comment"></span>
00259 <span class="comment">    VersionString - Supplies a pointer to a fixed length memory to receive</span>
00260 <span class="comment">                 the version string.</span>
00261 <span class="comment"></span>
00262 <span class="comment">Return Value:</span>
00263 <span class="comment"></span>
00264 <span class="comment">    TRUE if a version number is found.  Else a value of FALSE is returned.</span>
00265 <span class="comment"></span>
00266 <span class="comment">--*/</span>
00267 {
00268     PCHAR <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
00269     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Length;
00270     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i;
00271     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a>];
00272     PCHAR BufferPointer;
00273 
00274         <span class="keywordflow">if</span> (SearchArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00275 
00276         <span class="comment">//</span>
00277         <span class="comment">// If caller does not specify the search area, we will search</span>
00278         <span class="comment">// the area left from previous search.</span>
00279         <span class="comment">//</span>
00280 
00281         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a17">BiosBegin</a> = SearchArea;
00282         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = SearchArea + 1;
00283         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = SearchArea + SearchLength - 2;
00284     }
00285 
00286     <span class="keywordflow">while</span> (1) {
00287 
00288          <span class="comment">//</span>
00289          <span class="comment">// Search for a period with a digit on either side</span>
00290          <span class="comment">//</span>
00291 
00292          <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00293          <span class="keywordflow">while</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &lt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) {
00294              <span class="keywordflow">if</span> (*<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> == <span class="charliteral">'.'</span> &amp;&amp; *(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>+1) &gt;= <span class="charliteral">'0'</span> &amp;&amp; *(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>+1) &lt;= <span class="charliteral">'9'</span> &amp;&amp;
00295                  *(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>-1) &gt;= <span class="charliteral">'0'</span> &amp;&amp; *(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>-1) &lt;= <span class="charliteral">'9'</span>) {
00296                  <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00297                  <span class="keywordflow">break</span>;
00298              } <span class="keywordflow">else</span> {
00299                  <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>++;
00300              }
00301          }
00302 
00303          <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &gt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) {
00304              <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00305          } <span class="keywordflow">else</span> {
00306              <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> += 2;
00307          }
00308 
00309          Length = 0;
00310          <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a> - 1] = <span class="charliteral">'\0'</span>;
00311          BufferPointer = &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a> - 1];
00312 
00313          <span class="comment">//</span>
00314          <span class="comment">// Search for the beginning of the string</span>
00315          <span class="comment">//</span>
00316 
00317          <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>--;
00318          <span class="keywordflow">while</span> (Length &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a> - 8 &amp;&amp;
00319                 <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> &gt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a17">BiosBegin</a> &amp;&amp;
00320                 *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> &gt;= <span class="charliteral">' '</span> &amp;&amp; *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> &lt;= 127 &amp;&amp;
00321                 *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> != <span class="charliteral">'$'</span>) {
00322              --BufferPointer;
00323              *BufferPointer = *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
00324              --<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>, ++Length;
00325          }
00326          ++<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
00327 
00328          <span class="comment">//</span>
00329          <span class="comment">// Can one of the search strings be found</span>
00330          <span class="comment">//</span>
00331 
00332          <span class="keywordflow">for</span> (i = 0; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a16">SearchStrings</a>[i]; i++) {
00333              <span class="keywordflow">if</span> (strstr(BufferPointer, SearchStrings[i])) {
00334                  <span class="keywordflow">goto</span> Found;
00335              }
00336          }
00337     }
00338 
00339 Found:
00340 
00341     <span class="comment">//</span>
00342     <span class="comment">// Skip leading white space</span>
00343     <span class="comment">//</span>
00344 
00345     <span class="keywordflow">for</span> (; *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> == <span class="charliteral">' '</span>; ++<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>)
00346       ;
00347 
00348     <span class="comment">//</span>
00349     <span class="comment">// Copy the string to user supplied buffer</span>
00350     <span class="comment">//</span>
00351 
00352     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a> - 1 &amp;&amp;
00353          <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> &lt;= (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> + 1) &amp;&amp;
00354          *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> &gt;= <span class="charliteral">' '</span> &amp;&amp; *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> &lt;= 127 &amp;&amp; *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> != <span class="charliteral">'$'</span>;
00355          ++i, ++<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>) {
00356          VersionString[i] = *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
00357     }
00358     VersionString[i] = <span class="charliteral">'\0'</span>;
00359     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00360 }
00361 
00362 
00363 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00364"></a><a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a31">00364</a> <a class="code" href="../../d6/d1/config_2ppc_2init_8c.html#a0">CmpInitializeMachineDependentConfiguration</a>(
00365     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00366     )
00367 <span class="comment">/*++</span>
00368 <span class="comment"></span>
00369 <span class="comment">Routine Description:</span>
00370 <span class="comment"></span>
00371 <span class="comment">    This routine creates x86 specific entries in the registry.</span>
00372 <span class="comment"></span>
00373 <span class="comment">Arguments:</span>
00374 <span class="comment"></span>
00375 <span class="comment">    LoaderBlock - supplies a pointer to the LoaderBlock passed in from the</span>
00376 <span class="comment">                  OS Loader.</span>
00377 <span class="comment"></span>
00378 <span class="comment">Returns:</span>
00379 <span class="comment"></span>
00380 <span class="comment">    NTSTATUS code for sucess or reason of failure.</span>
00381 <span class="comment"></span>
00382 <span class="comment">--*/</span>
00383 {
00384     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00385     ULONG VideoBiosStart;
00386     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00387     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00388     UNICODE_STRING ValueData;
00389     ANSI_STRING AnsiString;
00390     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00391     ULONG Disposition;
00392     HANDLE ParentHandle;
00393     HANDLE BaseHandle, NpxHandle;
00394     HANDLE CurrentControlSet;
00395     <a class="code" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html">CONFIGURATION_COMPONENT_DATA</a> CurrentEntry;
00396     PUCHAR VendorID;
00397     UCHAR  <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a>];
00398     PKPRCB Prcb;
00399     ULONG  i, Junk;
00400     ULONG VersionsLength = 0, Length;
00401     PCHAR VersionStrings, VersionPointer;
00402     UNICODE_STRING SectionName;
00403     ULONG ViewSize;
00404     LARGE_INTEGER ViewBase;
00405     PVOID BaseAddress;
00406     HANDLE SectionHandle;
00407     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> DeviceIndexTable[<a class="code" href="../../d1/d2/cmp_8h.html#a68">NUMBER_TYPES</a>];
00408     ULONG CpuIdFunction;
00409     ULONG MaxExtFn;
00410     PULONG NameString = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00411     <span class="keyword">struct </span>{
00412         <span class="keyword">union </span>{
00413             UCHAR   Bytes[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a9">CPUID_PROCESSOR_NAME_STRING_SZ</a>];
00414             ULONG   DWords[1];
00415         } u;
00416     } ProcessorNameString;
00417 
00418     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d1/d2/cmp_8h.html#a68">NUMBER_TYPES</a>; i++) {
00419         DeviceIndexTable[i] = 0;
00420     }
00421 
00422     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00423                                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a17">CmRegistryMachineHardwareDescriptionSystemName</a>,
00424                                 OBJ_CASE_INSENSITIVE,
00425                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00426                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00427                               );
00428 
00429     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;ParentHandle,
00430                         KEY_READ,
00431                         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00432                       );
00433 
00434     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00435         <span class="comment">// Something is really wrong...</span>
00436         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00437     }
00438 
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// On an ARC machine the processor(s) are included in the hardware</span>
00442     <span class="comment">// configuration passed in from bootup.  Since there's no standard</span>
00443     <span class="comment">// way to get all the ARC information for each processor in an MP</span>
00444     <span class="comment">// machine via pc-ROMs the information will be added here (if it's</span>
00445     <span class="comment">// not already present).</span>
00446     <span class="comment">//</span>
00447 
00448     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00449                           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CentralProcessor"</span>
00450                         );
00451 
00452     InitializeObjectAttributes(
00453         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00454         &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00455         0,
00456         ParentHandle,
00457         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00458         );
00459 
00460     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00461 
00462     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
00463                 &amp;BaseHandle,
00464                 KEY_READ | KEY_WRITE,
00465                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00466                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00467                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a1">CmClassName</a>[<a class="code" href="../../d1/d9/arc_8h.html#a314a180">ProcessorClass</a>],
00468                 0,
00469                 &amp;Disposition
00470                 );
00471 
00472     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (BaseHandle);
00473 
00474     <span class="keywordflow">if</span> (Disposition == REG_CREATED_NEW_KEY) {
00475 
00476         <span class="comment">//</span>
00477         <span class="comment">// The ARC rom didn't add the processor(s) into the registry.</span>
00478         <span class="comment">// Do it now.</span>
00479         <span class="comment">//</span>
00480 
00481         <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a> = (PCM_FULL_RESOURCE_DESCRIPTOR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00482                                             <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00483                                             <a class="code" href="../../d4/d0/cmconfig_8c.html#a9">CmpConfigurationAreaSize</a>
00484                                             );
00485 
00486         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00487             <span class="comment">// bail out</span>
00488             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (ParentHandle);
00489             <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00490         }
00491 
00492         <span class="keywordflow">for</span> (i=0; i &lt; (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>; i++) {
00493             Prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[i];
00494 
00495             RtlZeroMemory (&amp;CurrentEntry, <span class="keyword">sizeof</span> CurrentEntry);
00496             CurrentEntry.ComponentEntry.Class = <a class="code" href="../../d1/d9/arc_8h.html#a314a180">ProcessorClass</a>;
00497             CurrentEntry.ComponentEntry.Type = <a class="code" href="../../d1/d9/arc_8h.html#a315a188">CentralProcessor</a>;
00498             CurrentEntry.ComponentEntry.Key = i;
00499             CurrentEntry.ComponentEntry.AffinityMask = 1 &lt;&lt; i;
00500 
00501             CurrentEntry.ComponentEntry.Identifier = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00502 <span class="preprocessor">#ifndef _IA64_</span>
00503 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Prcb-&gt;CpuID == 0) {
00504 
00505                 <span class="comment">//</span>
00506                 <span class="comment">// Old style stepping format</span>
00507                 <span class="comment">//</span>
00508 
00509                 <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a20">CmpID1</a>,
00510                     Prcb-&gt;CpuType,
00511                     (Prcb-&gt;CpuStep &gt;&gt; 8) + <span class="charliteral">'A'</span>,
00512                     Prcb-&gt;CpuStep &amp; 0xff
00513                     );
00514 
00515             } <span class="keywordflow">else</span> {
00516 
00517                 <span class="comment">//</span>
00518                 <span class="comment">// New style stepping format</span>
00519                 <span class="comment">//</span>
00520 
00521                 <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a21">CmpID2</a>,
00522                     Prcb-&gt;CpuType,
00523                     (Prcb-&gt;CpuStep &gt;&gt; 8),
00524                     Prcb-&gt;CpuStep &amp; 0xff
00525                     );
00526             }
00527 <span class="preprocessor">#endif _IA64_</span>
00528 <span class="preprocessor"></span>
00529             CurrentEntry.ComponentEntry.IdentifierLength =
00530                 <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) + 1;
00531 
00532             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a274">CmpInitializeRegistryNode</a>(
00533                 &amp;CurrentEntry,
00534                 ParentHandle,
00535                 &amp;BaseHandle,
00536                 -1,
00537                 (ULONG)-1,
00538                 DeviceIndexTable
00539                 );
00540 
00541             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00542                 <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00543             }
00544 
00545 
00546 <span class="preprocessor">#ifndef _IA64_</span>
00547 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a>) {
00548                 RtlZeroMemory (&amp;CurrentEntry, <span class="keyword">sizeof</span> CurrentEntry);
00549                 CurrentEntry.ComponentEntry.Class = <a class="code" href="../../d1/d9/arc_8h.html#a314a180">ProcessorClass</a>;
00550                 CurrentEntry.ComponentEntry.Type = <a class="code" href="../../d1/d9/arc_8h.html#a315a189">FloatingPointProcessor</a>;
00551                 CurrentEntry.ComponentEntry.Key = i;
00552                 CurrentEntry.ComponentEntry.AffinityMask = 1 &lt;&lt; i;
00553 
00554                 CurrentEntry.ComponentEntry.Identifier = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00555 
00556                 <span class="keywordflow">if</span> (Prcb-&gt;CpuType == 3) {
00557 
00558                     <span class="comment">//</span>
00559                     <span class="comment">// 386 processors have 387's installed, else</span>
00560                     <span class="comment">// use processor identifier as the NPX identifier</span>
00561                     <span class="comment">//</span>
00562 
00563                     strcpy (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <span class="stringliteral">"80387"</span>);
00564                 }
00565 
00566                 CurrentEntry.ComponentEntry.IdentifierLength =
00567                     <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) + 1;
00568 
00569                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a274">CmpInitializeRegistryNode</a>(
00570                     &amp;CurrentEntry,
00571                     ParentHandle,
00572                     &amp;NpxHandle,
00573                     -1,
00574                     (ULONG)-1,
00575                     DeviceIndexTable
00576                     );
00577 
00578                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00579                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(BaseHandle);
00580                     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00581                 }
00582 
00583                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(NpxHandle);
00584             }
00585 
00586             <span class="comment">//</span>
00587             <span class="comment">// If processor supports Cpu Indentification then</span>
00588             <span class="comment">// go obtain that information for the registry</span>
00589             <span class="comment">//</span>
00590 
00591             VendorID = Prcb-&gt;CpuID ? Prcb-&gt;VendorString : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00592 
00593             <span class="comment">//</span>
00594             <span class="comment">// Move to target processor and get other related</span>
00595             <span class="comment">// processor information for the registery</span>
00596             <span class="comment">//</span>
00597 
00598             <a class="code" href="../../d9/d1/thredobj_8c.html#a19">KeSetSystemAffinityThread</a>(Prcb-&gt;SetMember);
00599 
00600             <span class="keywordflow">if</span> (!Prcb-&gt;CpuID) {
00601 
00602                 <span class="comment">//</span>
00603                 <span class="comment">// Test for Cyrix processor</span>
00604                 <span class="comment">//</span>
00605 
00606                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/cyrix_8c.html#a24">Ke386CyrixId</a> ()) {
00607                     VendorID = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a28">CmpCyrixID</a>;
00608                 }
00609             } <span class="keywordflow">else</span> {
00610 
00611                 <span class="comment">//</span>
00612                 <span class="comment">// If this processor has extended CPUID functions, get</span>
00613                 <span class="comment">// the ProcessorNameString.  This is currently only</span>
00614                 <span class="comment">// true for AMD processors.  Intel should be adding</span>
00615                 <span class="comment">// this support shortly.  On AMD processors that don't</span>
00616                 <span class="comment">// support extended functions, the CPUID instruction</span>
00617                 <span class="comment">// returns 0 for function 0x80000000.</span>
00618                 <span class="comment">//</span>
00619 
00620                 <span class="keywordflow">if</span> (strcmp(VendorID, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a30">CmpAmdID</a>) == 0) {
00621 
00622                     <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a>(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a10">CPUID_EXTFN_BASE</a>, &amp;MaxExtFn, &amp;Junk, &amp;Junk, &amp;Junk);
00623 
00624                     <span class="keywordflow">if</span> (MaxExtFn &gt;= (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a11">CPUID_EXTFN_PROCESSOR_NAME</a> + 2)) {
00625 
00626                         <span class="comment">//</span>
00627                         <span class="comment">// This processor supports extended CPUID functions</span>
00628                         <span class="comment">// up to and (at least) including processor name string.</span>
00629                         <span class="comment">//</span>
00630                         <span class="comment">// Each CPUID call for the processor name string will</span>
00631                         <span class="comment">// return 16 bytes, 48 bytes in all, zero terminated.</span>
00632                         <span class="comment">//</span>
00633 
00634                         NameString = &amp;ProcessorNameString.u.DWords[0];
00635 
00636                         <span class="keywordflow">for</span> (CpuIdFunction = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a11">CPUID_EXTFN_PROCESSOR_NAME</a>;
00637                              CpuIdFunction &lt;= (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a11">CPUID_EXTFN_PROCESSOR_NAME</a>+2);
00638                              CpuIdFunction++) {
00639 
00640                             <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a>(CpuIdFunction,
00641                                   NameString,
00642                                   NameString + 1,
00643                                   NameString + 2,
00644                                   NameString + 3);
00645                             NameString += 4;
00646                         }
00647 
00648                         <span class="comment">//</span>
00649                         <span class="comment">// Enforce 0 byte terminator.</span>
00650                         <span class="comment">//</span>
00651 
00652                         ProcessorNameString.u.Bytes[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a9">CPUID_PROCESSOR_NAME_STRING_SZ</a>-1] = 0;
00653                     }
00654                 }
00655             }
00656 
00657             <span class="comment">//</span>
00658             <span class="comment">// Restore thread's affinity to all processors</span>
00659             <span class="comment">//</span>
00660 
00661             <a class="code" href="../../d9/d1/thredobj_8c.html#a16">KeRevertToUserAffinityThread</a>();
00662 
00663             <span class="keywordflow">if</span> (NameString) {
00664 
00665                 <span class="comment">//</span>
00666                 <span class="comment">// Add Processor Name String to the registery</span>
00667                 <span class="comment">//</span>
00668 
00669                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00670                     &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00671                     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a23">CmpProcessorNameString</a>
00672                     );
00673 
00674                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
00675                     &amp;AnsiString,
00676                     ProcessorNameString.u.Bytes
00677                     );
00678 
00679                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00680                     &amp;ValueData,
00681                     &amp;AnsiString,
00682                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00683                     );
00684 
00685                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00686                             BaseHandle,
00687                             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00688                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00689                             REG_SZ,
00690                             ValueData.Buffer,
00691                             ValueData.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
00692                             );
00693 
00694                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
00695             }
00696 
00697             <span class="keywordflow">if</span> (VendorID) {
00698 
00699                 <span class="comment">//</span>
00700                 <span class="comment">// Add Vendor Indentifier to the registery</span>
00701                 <span class="comment">//</span>
00702 
00703                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00704                     &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00705                     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a22">CmpVendorID</a>
00706                     );
00707 
00708                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
00709                     &amp;AnsiString,
00710                     VendorID
00711                     );
00712 
00713                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00714                     &amp;ValueData,
00715                     &amp;AnsiString,
00716                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00717                     );
00718 
00719                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00720                             BaseHandle,
00721                             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00722                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00723                             REG_SZ,
00724                             ValueData.Buffer,
00725                             ValueData.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
00726                             );
00727 
00728                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
00729             }
00730 
00731             <span class="keywordflow">if</span> (Prcb-&gt;FeatureBits) {
00732                 <span class="comment">//</span>
00733                 <span class="comment">// Add processor feature bits to the registery</span>
00734                 <span class="comment">//</span>
00735 
00736                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00737                     &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00738                     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a24">CmpFeatureBits</a>
00739                     );
00740 
00741                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00742                             BaseHandle,
00743                             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00744                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00745                             REG_DWORD,
00746                             &amp;Prcb-&gt;FeatureBits,
00747                             sizeof (Prcb-&gt;FeatureBits)
00748                             );
00749             }
00750 
00751             <span class="keywordflow">if</span> (Prcb-&gt;MHz) {
00752                 <span class="comment">//</span>
00753                 <span class="comment">// Add processor MHz to the registery</span>
00754                 <span class="comment">//</span>
00755 
00756                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00757                     &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00758                     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a25">CmpMHz</a>
00759                     );
00760 
00761                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00762                             BaseHandle,
00763                             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00764                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00765                             REG_DWORD,
00766                             &amp;Prcb-&gt;MHz,
00767                             sizeof (Prcb-&gt;MHz)
00768                             );
00769             }
00770 
00771             <span class="keywordflow">if</span> (Prcb-&gt;UpdateSignature.QuadPart) {
00772                 <span class="comment">//</span>
00773                 <span class="comment">// Add processor MHz to the registery</span>
00774                 <span class="comment">//</span>
00775 
00776                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00777                     &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00778                     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a26">CmpUpdateSignature</a>
00779                     );
00780 
00781                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00782                             BaseHandle,
00783                             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00784                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00785                             REG_BINARY,
00786                             &amp;Prcb-&gt;UpdateSignature,
00787                             sizeof (Prcb-&gt;UpdateSignature)
00788                             );
00789             }
00790 
00791             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(BaseHandle);
00792 <span class="preprocessor">#endif _IA64_</span>
00793 <span class="preprocessor"></span>        }
00794 
00795         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)<a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>);
00796     }
00797 
00798 <span class="preprocessor">#ifndef _IA64_</span>
00799 <span class="preprocessor"></span>    <span class="comment">//</span>
00800     <span class="comment">// Next we try to collect System BIOS date and version strings.</span>
00801     <span class="comment">// BUGBUG This code should be moved to ntdetect.com after product 1.</span>
00802     <span class="comment">//</span>
00803 
00804     <span class="comment">//</span>
00805     <span class="comment">// Open a physical memory section to map in physical memory.</span>
00806     <span class="comment">//</span>
00807 
00808     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00809         &amp;SectionName,
00810         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Device\\PhysicalMemory"</span>
00811         );
00812 
00813     InitializeObjectAttributes(
00814         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00815         &amp;SectionName,
00816         OBJ_CASE_INSENSITIVE,
00817         (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00818         (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00819         );
00820 
00821     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenSection(
00822         &amp;SectionHandle,
00823         SECTION_ALL_ACCESS,
00824         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00825         );
00826 
00827     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00828 
00829         <span class="comment">//</span>
00830         <span class="comment">// If fail, forget the bios data and version</span>
00831         <span class="comment">//</span>
00832 
00833         <span class="keywordflow">goto</span> AllDone;
00834     }
00835 
00836     <span class="comment">//</span>
00837     <span class="comment">// Examine the first page of physical memory for int 10 segment</span>
00838     <span class="comment">// address.</span>
00839     <span class="comment">//</span>
00840 
00841     BaseAddress = 0;
00842     ViewSize = 0x1000;
00843     ViewBase.LowPart = 0;
00844     ViewBase.HighPart = 0;
00845 
00846     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =ZwMapViewOfSection(
00847         SectionHandle,
00848         NtCurrentProcess(),
00849         &amp;BaseAddress,
00850         0,
00851         ViewSize,
00852         &amp;ViewBase,
00853         &amp;ViewSize,
00854         ViewUnmap,
00855         MEM_DOS_LIM,
00856         PAGE_READWRITE
00857         );
00858 
00859     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00860         VideoBiosStart = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a6">VIDEO_BIOS_START</a>;
00861     } <span class="keywordflow">else</span> {
00862         VideoBiosStart = (*((PULONG)BaseAddress + <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a5">INT10_VECTOR</a>) &amp; 0xFFFF0000) &gt;&gt; 12;
00863         VideoBiosStart += (*((PULONG)BaseAddress + <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a5">INT10_VECTOR</a>) &amp; 0x0000FFFF);
00864         VideoBiosStart &amp;= 0xffff8000;
00865         <span class="keywordflow">if</span> (VideoBiosStart &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a6">VIDEO_BIOS_START</a>) {
00866             VideoBiosStart = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a6">VIDEO_BIOS_START</a>;
00867         }
00868         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwUnmapViewOfSection(
00869             NtCurrentProcess(),
00870             BaseAddress
00871             );
00872     }
00873 
00874     VersionStrings = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a8">VERSION_DATA_LENGTH</a>);
00875     BaseAddress = 0;
00876     ViewSize = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a4">SYSTEM_BIOS_LENGTH</a>;
00877     ViewBase.LowPart = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a3">SYSTEM_BIOS_START</a>;
00878     ViewBase.HighPart = 0;
00879 
00880     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =ZwMapViewOfSection(
00881         SectionHandle,
00882         NtCurrentProcess(),
00883         &amp;BaseAddress,
00884         0,
00885         ViewSize,
00886         &amp;ViewBase,
00887         &amp;ViewSize,
00888         ViewUnmap,
00889         MEM_DOS_LIM,
00890         PAGE_READWRITE
00891         );
00892 
00893     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00894         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a29">CmpGetBiosDate</a>(BaseAddress, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a4">SYSTEM_BIOS_LENGTH</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)) {
00895 
00896             <span class="comment">//</span>
00897             <span class="comment">// Convert ascii date string to unicode string and</span>
00898             <span class="comment">// store it in registry.</span>
00899             <span class="comment">//</span>
00900 
00901             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00902                 &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00903                 <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SystemBiosDate"</span>
00904                 );
00905 
00906             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
00907                 &amp;AnsiString,
00908                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>
00909                 );
00910 
00911             <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00912                 &amp;ValueData,
00913                 &amp;AnsiString,
00914                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00915                 );
00916 
00917             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00918                         ParentHandle,
00919                         &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00920                         <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00921                         REG_SZ,
00922                         ValueData.Buffer,
00923                         ValueData.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
00924                         );
00925 
00926             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
00927         }
00928 
00929         <span class="keywordflow">if</span> (VersionStrings &amp;&amp; <a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a28">CmpGetBiosVersion</a>(BaseAddress, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a4">SYSTEM_BIOS_LENGTH</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)) {
00930             VersionPointer = VersionStrings;
00931             <span class="keywordflow">do</span> {
00932 
00933                 <span class="comment">//</span>
00934                 <span class="comment">// Try to detect ALL the possible BIOS version strings.</span>
00935                 <span class="comment">// Convert them to unicode strings and copy them to our</span>
00936                 <span class="comment">// VersionStrings buffer.</span>
00937                 <span class="comment">//</span>
00938 
00939                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
00940                     &amp;AnsiString,
00941                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>
00942                     );
00943 
00944                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00945                     &amp;ValueData,
00946                     &amp;AnsiString,
00947                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00948                     );
00949 
00950                 Length = ValueData.Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00951                 RtlMoveMemory(VersionPointer,
00952                               ValueData.Buffer,
00953                               Length
00954                               );
00955                 VersionsLength += Length;
00956                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
00957                 <span class="keywordflow">if</span> (VersionsLength + (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a> +
00958                     <span class="keyword">sizeof</span>(UNICODE_NULL)) * 2 &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
00959                     <span class="keywordflow">break</span>;
00960                 }
00961                 VersionPointer += Length;
00962             } <span class="keywordflow">while</span> (<a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a28">CmpGetBiosVersion</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>));
00963 
00964             <span class="keywordflow">if</span> (VersionsLength != 0) {
00965 
00966                 <span class="comment">//</span>
00967                 <span class="comment">// Append a UNICODE_NULL to the end of VersionStrings</span>
00968                 <span class="comment">//</span>
00969 
00970                 *(PWSTR)VersionPointer = UNICODE_NULL;
00971                 VersionsLength += <span class="keyword">sizeof</span>(UNICODE_NULL);
00972 
00973                 <span class="comment">//</span>
00974                 <span class="comment">// If any version string is found, we set up a ValueName and</span>
00975                 <span class="comment">// initialize its value to the string(s) we found.</span>
00976                 <span class="comment">//</span>
00977 
00978                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00979                     &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00980                     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SystemBiosVersion"</span>
00981                     );
00982 
00983                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00984                             ParentHandle,
00985                             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00986                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00987                             REG_MULTI_SZ,
00988                             VersionStrings,
00989                             VersionsLength
00990                             );
00991             }
00992         }
00993         ZwUnmapViewOfSection(NtCurrentProcess(), BaseAddress);
00994     }
00995 
00996     <span class="comment">//</span>
00997     <span class="comment">// Next we try to collect Video BIOS date and version strings.</span>
00998     <span class="comment">//</span>
00999 
01000     BaseAddress = 0;
01001     ViewSize = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a7">VIDEO_BIOS_LENGTH</a>;
01002     ViewBase.LowPart = VideoBiosStart;
01003     ViewBase.HighPart = 0;
01004 
01005     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =ZwMapViewOfSection(
01006         SectionHandle,
01007         NtCurrentProcess(),
01008         &amp;BaseAddress,
01009         0,
01010         ViewSize,
01011         &amp;ViewBase,
01012         &amp;ViewSize,
01013         ViewUnmap,
01014         MEM_DOS_LIM,
01015         PAGE_READWRITE
01016         );
01017 
01018     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01019         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a29">CmpGetBiosDate</a>(BaseAddress, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a7">VIDEO_BIOS_LENGTH</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)) {
01020 
01021             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01022                 &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01023                 <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"VideoBiosDate"</span>
01024                 );
01025 
01026             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
01027                 &amp;AnsiString,
01028                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>
01029                 );
01030 
01031             <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
01032                 &amp;ValueData,
01033                 &amp;AnsiString,
01034                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01035                 );
01036 
01037             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01038                         ParentHandle,
01039                         &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01040                         <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01041                         REG_SZ,
01042                         ValueData.Buffer,
01043                         ValueData.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01044                         );
01045 
01046             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
01047         }
01048 
01049         <span class="keywordflow">if</span> (VersionStrings &amp;&amp; <a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a28">CmpGetBiosVersion</a>(BaseAddress, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a7">VIDEO_BIOS_LENGTH</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)) {
01050             VersionPointer = VersionStrings;
01051             <span class="keywordflow">do</span> {
01052 
01053                 <span class="comment">//</span>
01054                 <span class="comment">// Try to detect ALL the possible BIOS version strings.</span>
01055                 <span class="comment">// Convert them to unicode strings and copy them to our</span>
01056                 <span class="comment">// VersionStrings buffer.</span>
01057                 <span class="comment">//</span>
01058 
01059                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
01060                     &amp;AnsiString,
01061                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>
01062                     );
01063 
01064                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
01065                     &amp;ValueData,
01066                     &amp;AnsiString,
01067                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01068                     );
01069 
01070                 Length = ValueData.Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
01071                 RtlMoveMemory(VersionPointer,
01072                               ValueData.Buffer,
01073                               Length
01074                               );
01075                 VersionsLength += Length;
01076                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
01077                 <span class="keywordflow">if</span> (VersionsLength + (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a2">MAXIMUM_BIOS_VERSION_LENGTH</a> +
01078                     <span class="keyword">sizeof</span>(UNICODE_NULL)) * 2 &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
01079                     <span class="keywordflow">break</span>;
01080                 }
01081                 VersionPointer += Length;
01082             } <span class="keywordflow">while</span> (<a class="code" href="../../d5/d2/config_2ia64_2initia64_8c.html#a28">CmpGetBiosVersion</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>));
01083 
01084             <span class="keywordflow">if</span> (VersionsLength != 0) {
01085 
01086                 <span class="comment">//</span>
01087                 <span class="comment">// Append a UNICODE_NULL to the end of VersionStrings</span>
01088                 <span class="comment">//</span>
01089 
01090                 *(PWSTR)VersionPointer = UNICODE_NULL;
01091                 VersionsLength += <span class="keyword">sizeof</span>(UNICODE_NULL);
01092 
01093                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01094                     &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01095                     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"VideoBiosVersion"</span>
01096                     );
01097 
01098                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01099                             ParentHandle,
01100                             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01101                             <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01102                             REG_MULTI_SZ,
01103                             VersionStrings,
01104                             VersionsLength
01105                             );
01106             }
01107         }
01108         ZwUnmapViewOfSection(NtCurrentProcess(), BaseAddress);
01109     }
01110     ZwClose(SectionHandle);
01111     <span class="keywordflow">if</span> (VersionStrings) {
01112         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)VersionStrings);
01113     }
01114 
01115 AllDone:
01116 
01117 <span class="preprocessor">#endif _IA64_</span>
01118 <span class="preprocessor"></span>
01119     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (ParentHandle);
01120 
01121     <span class="comment">//</span>
01122     <span class="comment">// Add any other x86 specific code here...</span>
01123     <span class="comment">//</span>
01124 
01125     <span class="keywordflow">return</span> STATUS_SUCCESS;
01126 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:22 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
