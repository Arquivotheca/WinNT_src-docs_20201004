<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obquery.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obquery.c File Reference</h1><code>#include "<a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>"</code><br>

<p>
<a href="../../d7/d0/obquery_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d4/struct____OBP__SET__HANDLE__ATTRIBUTES.html">__OBP_SET_HANDLE_ATTRIBUTES</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/obquery_8c.html#a0">OBP_MISSING_NAME_LITERAL</a>&nbsp;&nbsp;&nbsp;L"..."</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/obquery_8c.html#a1">OBP_MISSING_NAME_LITERAL_SIZE</a>&nbsp;&nbsp;&nbsp;(sizeof( OBP_MISSING_NAME_LITERAL ) - sizeof( UNICODE_NULL ))</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d4/struct____OBP__SET__HANDLE__ATTRIBUTES.html">__OBP_SET_HANDLE_ATTRIBUTES</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/obquery_8c.html#a2">OBP_SET_HANDLE_ATTRIBUTES</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d4/struct____OBP__SET__HANDLE__ATTRIBUTES.html">__OBP_SET_HANDLE_ATTRIBUTES</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/obquery_8c.html#a3">POBP_SET_HANDLE_ATTRIBUTES</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/obquery_8c.html#a4">ObpSetHandleAttributes</a> (IN OUT PVOID TableEntry, IN ULONG_PTR Parameter)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/obquery_8c.html#a5">NtQueryObject</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN OBJECT_INFORMATION_CLASS ObjectInformationClass, OUT PVOID ObjectInformation, IN ULONG ObjectInformationLength, OUT PULONG ReturnLength OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/obquery_8c.html#a6">NtSetInformationObject</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN OBJECT_INFORMATION_CLASS ObjectInformationClass, IN PVOID ObjectInformation, IN ULONG ObjectInformationLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a> (IN PVOID Object, OUT POBJECT_NAME_INFORMATION ObjectNameInfo, IN ULONG Length, OUT PULONG ReturnLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/obquery_8c.html#a8">ObQueryTypeName</a> (IN PVOID Object, PUNICODE_STRING ObjectTypeName, IN ULONG Length, OUT PULONG ReturnLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/obquery_8c.html#a9">ObQueryTypeInfo</a> (IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType, OUT POBJECT_TYPE_INFORMATION ObjectTypeInfo, IN ULONG Length, OUT PULONG ReturnLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/obquery_8c.html#a10">ObQueryObjectAuditingByHandle</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, OUT PBOOLEAN GenerateOnClose)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/obquery_8c.html#a11">ObpSetHandleAttributes</a> (IN OUT <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ObjectTableEntry, IN ULONG_PTR Parameter)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="obquery.c::OBP_MISSING_NAME_LITERAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OBP_MISSING_NAME_LITERAL&nbsp;&nbsp;&nbsp;L"..."          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/obquery_8c-source.html#l00709">709</a> of file <a class="el" href="../../d7/d0/obquery_8c-source.html">obquery.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">ObQueryNameString()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="obquery.c::OBP_MISSING_NAME_LITERAL_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OBP_MISSING_NAME_LITERAL_SIZE&nbsp;&nbsp;&nbsp;(sizeof( OBP_MISSING_NAME_LITERAL ) - sizeof( UNICODE_NULL ))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/obquery_8c-source.html#l00710">710</a> of file <a class="el" href="../../d7/d0/obquery_8c-source.html">obquery.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">ObQueryNameString()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a2" doxytag="obquery.c::OBP_SET_HANDLE_ATTRIBUTES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d4/struct____OBP__SET__HANDLE__ATTRIBUTES.html">__OBP_SET_HANDLE_ATTRIBUTES</a>  <a class="el" href="../../d1/d4/struct____OBP__SET__HANDLE__ATTRIBUTES.html">OBP_SET_HANDLE_ATTRIBUTES</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="obquery.c::POBP_SET_HANDLE_ATTRIBUTES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d4/struct____OBP__SET__HANDLE__ATTRIBUTES.html">__OBP_SET_HANDLE_ATTRIBUTES</a> * <a class="el" href="../../d1/d4/struct____OBP__SET__HANDLE__ATTRIBUTES.html">POBP_SET_HANDLE_ATTRIBUTES</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d0/obquery_8c-source.html#l01469">ObpSetHandleAttributes()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a5" doxytag="obquery.c::NtQueryObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OBJECT_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ReturnLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">58</a> of file <a class="el" href="../../d7/d0/obquery_8c-source.html">obquery.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00126">ALIGN_UP</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00331">_OBJECT_HEADER_NAME_INFO::Directory</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00057">_OBJECT_HANDLE_INFORMATION::GrantedAccess</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00056">_OBJECT_HANDLE_INFORMATION::HandleAttributes</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00299">_OBJECT_HEADER::HandleCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00189">_OBJECT_TYPE::Name</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00332">_OBJECT_HEADER_NAME_INFO::Name</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00318">_OBJECT_HEADER_QUOTA_INFO::NonPagedPoolCharge</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00350">OB_FLAG_EXCLUSIVE_OBJECT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00351">OB_FLAG_PERMANENT_OBJECT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00261">OBJ_PROTECT_CLOSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00362">OBJECT_HEADER_TO_QUOTA_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00228">OBP_MAX_DEFINED_OBJECT_TYPES</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00914">ObpAcquireDescriptorCacheReadLock()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00189">ObpEnterRootDirectoryMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00202">ObpLeaveRootDirectoryMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00229">ObpObjectTypes</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00942">ObpReleaseDescriptorCacheLock()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00368">ObpSymbolicLinkObjectType</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">ObQueryNameString()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l01216">ObQueryTypeInfo()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00317">_OBJECT_HEADER_QUOTA_INFO::PagedPoolCharge</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00297">_OBJECT_HEADER::PointerCount</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02165">RtlLengthSecurityDescriptor()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00312">_OBJECT_HEADER::SecurityDescriptor</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">InitializeRestrictedStuff()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01163">IsInterestingPath()</a>, <a class="el" href="../../d8/d8/uob_8c-source.html#l00232">TestParent()</a>, and <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00329">xProtectHandle()</a>.
<p>
<pre class="fragment"><div>00068                    :
00069 
00070     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to query information about a given object
00071 
00072 Arguments:
00073 
00074     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being queried.  This value
00075         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information <span class="keyword">class </span><a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> for <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
00076         information.
00077 
00078     ObjectInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information to return
00079 
00080     ObjectInformation - Supplies an output buffer for <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information being
00081         returned
00082 
00083     ObjectInformationLength - Specifies, in bytes, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00084         preceding object information buffer
00085 
00086     ReturnLength - Optionally receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, used to store
00087         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object information
00088 
00089 Return Value:
00090 
00091     An appropriate status value
00092 
00093 --*/
00094 
00095 {
00096     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00097     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00098     PVOID Object;
00099     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00100     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
00101     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
00102     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00103     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectDirectoryHeader;
00104     <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> ObjectDirectory;
00105     ACCESS_MASK GrantedAccess;
00106     POBJECT_HANDLE_FLAG_INFORMATION HandleFlags;
00107     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInformation;
00108     ULONG NameInfoSize;
00109     ULONG SecurityDescriptorSize;
00110     ULONG TempReturnLength;
00111     OBJECT_BASIC_INFORMATION ObjectBasicInfo;
00112     POBJECT_TYPES_INFORMATION TypesInformation;
00113     POBJECT_TYPE_INFORMATION TypeInfo;
00114     ULONG i;
00115 
00116     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00117 
00118     <span class="comment">//</span>
00119     <span class="comment">//  Initialize our local variables</span>
00120     <span class="comment">//</span>
00121 
00122     TempReturnLength = 0;
00123 
00124     <span class="comment">//</span>
00125     <span class="comment">//  Get previous processor mode and probe output argument if necessary.</span>
00126     <span class="comment">//</span>
00127 
00128     PreviousMode = KeGetPreviousMode();
00129 
00130     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00131 
00132         <span class="keywordflow">try</span> {
00133 
00134             <span class="keywordflow">if</span> (ObjectInformationClass != ObjectHandleFlagInformation) {
00135 
00136                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( ObjectInformation,
00137                                ObjectInformationLength,
00138                                <span class="keyword">sizeof</span>( ULONG ));
00139 
00140             } <span class="keywordflow">else</span> {
00141 
00142                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( ObjectInformation,
00143                                ObjectInformationLength,
00144                                1 );
00145             }
00146 
00147             <span class="comment">//</span>
00148             <span class="comment">//  We'll use a local temp return length variable to pass</span>
00149             <span class="comment">//  through to the later ob query calls which will increment</span>
00150             <span class="comment">//  its value.  We can't pass the users return length directly</span>
00151             <span class="comment">//  because the user might also be altering its value behind</span>
00152             <span class="comment">//  our back.</span>
00153             <span class="comment">//</span>
00154 
00155             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
00156 
00157                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>( ReturnLength );
00158             }
00159 
00160         } except( EXCEPTION_EXECUTE_HANDLER ) {
00161 
00162             <span class="keywordflow">return</span>( GetExceptionCode() );
00163         }
00164     }
00165 
00166     <span class="comment">//</span>
00167     <span class="comment">//  If the query is not for types information then we</span>
00168     <span class="comment">//  will have to get the object in question. Otherwise</span>
00169     <span class="comment">//  for types information there really isn't an object</span>
00170     <span class="comment">//  to grab.</span>
00171     <span class="comment">//</span>
00172 
00173     <span class="keywordflow">if</span> (ObjectInformationClass != ObjectTypesInformation) {
00174 
00175         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( Handle,
00176                                             0,
00177                                             NULL,
00178                                             PreviousMode,
00179                                             &amp;Object,
00180                                             &amp;HandleInformation );
00181 
00182         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00183 
00184             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00185         }
00186 
00187         GrantedAccess = HandleInformation.GrantedAccess;
00188 
00189         ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00190         ObjectType = ObjectHeader-&gt;Type;
00191 
00192     } <span class="keywordflow">else</span> {
00193 
00194         GrantedAccess = 0;
00195         Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00196         ObjectHeader = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00197         ObjectType = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00198     }
00199 
00200     <span class="comment">//</span>
00201     <span class="comment">//  Now process the particular information class being</span>
00202     <span class="comment">//  requested</span>
00203     <span class="comment">//</span>
00204 
00205     <span class="keywordflow">switch</span>( ObjectInformationClass ) {
00206 
00207     <span class="keywordflow">case</span> ObjectBasicInformation:
00208 
00209         <span class="comment">//</span>
00210         <span class="comment">//  Make sure the output buffer is long enough and then</span>
00211         <span class="comment">//  fill in the appropriate fields into our local copy</span>
00212         <span class="comment">//  of basic information.</span>
00213         <span class="comment">//</span>
00214 
00215         <span class="keywordflow">if</span> (ObjectInformationLength != <span class="keyword">sizeof</span>( OBJECT_BASIC_INFORMATION )) {
00216 
00217             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00218 
00219             <span class="keywordflow">return</span>( STATUS_INFO_LENGTH_MISMATCH );
00220         }
00221 
00222         ObjectBasicInfo.Attributes = HandleInformation.HandleAttributes;
00223 
00224         <span class="keywordflow">if</span> (ObjectHeader-&gt;Flags &amp; <a class="code" href="../../d4/d0/ob_8h.html#a5">OB_FLAG_PERMANENT_OBJECT</a>) {
00225 
00226             ObjectBasicInfo.Attributes |= OBJ_PERMANENT;
00227         }
00228 
00229         <span class="keywordflow">if</span> (ObjectHeader-&gt;Flags &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>) {
00230 
00231             ObjectBasicInfo.Attributes |= OBJ_EXCLUSIVE;
00232         }
00233 
00234         ObjectBasicInfo.GrantedAccess = GrantedAccess;
00235         ObjectBasicInfo.HandleCount = ObjectHeader-&gt;HandleCount;
00236         ObjectBasicInfo.PointerCount = ObjectHeader-&gt;PointerCount;
00237 
00238         QuotaInfo = <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>( ObjectHeader );
00239 
00240         <span class="keywordflow">if</span> (QuotaInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00241 
00242             ObjectBasicInfo.PagedPoolCharge = QuotaInfo-&gt;PagedPoolCharge;
00243             ObjectBasicInfo.NonPagedPoolCharge = QuotaInfo-&gt;NonPagedPoolCharge;
00244 
00245         } <span class="keywordflow">else</span> {
00246 
00247             ObjectBasicInfo.PagedPoolCharge = 0;
00248             ObjectBasicInfo.NonPagedPoolCharge = 0;
00249         }
00250 
00251         <span class="keywordflow">if</span> (ObjectType == <a class="code" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a>) {
00252 
00253             ObjectBasicInfo.CreationTime = ((<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a>)Object)-&gt;CreationTime;
00254 
00255         } <span class="keywordflow">else</span> {
00256 
00257             RtlZeroMemory( &amp;ObjectBasicInfo.CreationTime,
00258                            <span class="keyword">sizeof</span>( ObjectBasicInfo.CreationTime ));
00259         }
00260 
00261         <span class="comment">//</span>
00262         <span class="comment">//  Compute the size of the object name string by taking its name plus</span>
00263         <span class="comment">//  seperators and traversing up to the root adding each directories</span>
00264         <span class="comment">//  name length plus seperators</span>
00265         <span class="comment">//</span>
00266 
00267         NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
00268 
00269         <span class="keywordflow">if</span> ((NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (NameInfo-&gt;Directory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00270         
00271             <a class="code" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>();
00272 
00273             ObjectDirectory = NameInfo-&gt;Directory;
00274 
00275             <span class="comment">//</span>
00276             <span class="comment">//  **** this "IF" is probably not needed because of the preceding</span>
00277             <span class="comment">//  "IF"</span>
00278             <span class="comment">//</span>
00279 
00280             <span class="keywordflow">if</span> (ObjectDirectory) {
00281 
00282                 NameInfoSize = <span class="keyword">sizeof</span>( OBJ_NAME_PATH_SEPARATOR ) + NameInfo-&gt;Name.Length;
00283 
00284                 <span class="keywordflow">while</span> (ObjectDirectory) {
00285 
00286                     ObjectDirectoryHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( ObjectDirectory );
00287                     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectDirectoryHeader );
00288 
00289                     <span class="keywordflow">if</span> ((NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (NameInfo-&gt;Directory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00290 
00291                         NameInfoSize += <span class="keyword">sizeof</span>( OBJ_NAME_PATH_SEPARATOR ) + NameInfo-&gt;Name.Length;
00292                         ObjectDirectory = NameInfo-&gt;Directory;
00293 
00294                     } <span class="keywordflow">else</span> {
00295 
00296                         <span class="keywordflow">break</span>;
00297                     }
00298                 }
00299 
00300                 NameInfoSize += <span class="keyword">sizeof</span>( OBJECT_NAME_INFORMATION ) + <span class="keyword">sizeof</span>( UNICODE_NULL );
00301             }
00302             
00303             <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
00304 
00305         } <span class="keywordflow">else</span> {
00306 
00307             NameInfoSize = 0;
00308         }
00309 
00310         ObjectBasicInfo.NameInfoSize = NameInfoSize;
00311         ObjectBasicInfo.TypeInfoSize = ObjectType-&gt;Name.Length + <span class="keyword">sizeof</span>( UNICODE_NULL ) +
00312                                         <span class="keyword">sizeof</span>( OBJECT_TYPE_INFORMATION );
00313 
00314         <a class="code" href="../../d8/d1/obsdata_8c.html#a24">ObpAcquireDescriptorCacheReadLock</a>();
00315         
00316         <span class="keywordflow">if</span> ((GrantedAccess &amp; READ_CONTROL) &amp;&amp;
00317             ARGUMENT_PRESENT( ObjectHeader-&gt;SecurityDescriptor )) {
00318 
00319             SecurityDescriptorSize = <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>(
00320                                          ObjectHeader-&gt;SecurityDescriptor);
00321 
00322         } <span class="keywordflow">else</span> {
00323 
00324             SecurityDescriptorSize = 0;
00325         }
00326 
00327         <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
00328 
00329         ObjectBasicInfo.SecurityDescriptorSize = SecurityDescriptorSize;
00330 
00331         <span class="comment">//</span>
00332         <span class="comment">//  Now that we've packaged up our local copy of basic info we need</span>
00333         <span class="comment">//  to copy it into the output buffer and set the return</span>
00334         <span class="comment">//  length</span>
00335         <span class="comment">//</span>
00336 
00337         <span class="keywordflow">try</span> {
00338 
00339             *(POBJECT_BASIC_INFORMATION) ObjectInformation = ObjectBasicInfo;
00340 
00341             TempReturnLength = ObjectInformationLength;
00342 
00343         } except( EXCEPTION_EXECUTE_HANDLER ) {
00344 
00345             <span class="comment">//</span>
00346             <span class="comment">// Fall through, since we cannot undo what we have done.</span>
00347             <span class="comment">//</span>
00348         }
00349 
00350         <span class="keywordflow">break</span>;
00351 
00352     <span class="keywordflow">case</span> ObjectNameInformation:
00353 
00354         <span class="comment">//</span>
00355         <span class="comment">//  Call a local worker routine</span>
00356         <span class="comment">//</span>
00357 
00358         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>( Object,
00359                                     (POBJECT_NAME_INFORMATION)ObjectInformation,
00360                                     ObjectInformationLength,
00361                                     &amp;TempReturnLength );
00362         <span class="keywordflow">break</span>;
00363 
00364     <span class="keywordflow">case</span> ObjectTypeInformation:
00365 
00366         <span class="comment">//</span>
00367         <span class="comment">//  Call a local worker routine</span>
00368         <span class="comment">//</span>
00369 
00370         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a9">ObQueryTypeInfo</a>( ObjectType,
00371                                   (POBJECT_TYPE_INFORMATION)ObjectInformation,
00372                                   ObjectInformationLength,
00373                                   &amp;TempReturnLength );
00374         <span class="keywordflow">break</span>;
00375 
00376     <span class="keywordflow">case</span> ObjectTypesInformation:
00377 
00378         <span class="keywordflow">try</span> {
00379 
00380             <span class="comment">//</span>
00381             <span class="comment">//  The first thing we do is set the return length to cover the</span>
00382             <span class="comment">//  types info record.  Later in each call to query type info</span>
00383             <span class="comment">//  this value will be updated as necessary</span>
00384             <span class="comment">//</span>
00385 
00386             TempReturnLength = <span class="keyword">sizeof</span>( OBJECT_TYPES_INFORMATION );
00387 
00388             <span class="comment">//</span>
00389             <span class="comment">//  Make sure there is enough room to hold the types info record</span>
00390             <span class="comment">//  and if so then compute the number of defined types there are</span>
00391             <span class="comment">//</span>
00392 
00393             TypesInformation = (POBJECT_TYPES_INFORMATION)ObjectInformation;
00394 
00395             <span class="keywordflow">if</span> (ObjectInformationLength &lt; <span class="keyword">sizeof</span>( OBJECT_TYPES_INFORMATION ) ) {
00396 
00397                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
00398 
00399             } <span class="keywordflow">else</span> {
00400 
00401                 TypesInformation-&gt;NumberOfTypes = 0;
00402 
00403                 <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d5/d1/obp_8h.html#a14">OBP_MAX_DEFINED_OBJECT_TYPES</a>; i++) {
00404 
00405                     ObjectType = <a class="code" href="../../d5/d1/obp_8h.html#a38">ObpObjectTypes</a>[ i ];
00406 
00407                     <span class="keywordflow">if</span> (ObjectType == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00408 
00409                         <span class="keywordflow">break</span>;
00410                     }
00411 
00412                     TypesInformation-&gt;NumberOfTypes += 1;
00413                 }
00414             }
00415 
00416             <span class="comment">//</span>
00417             <span class="comment">//  For each defined type we will query the type info for the</span>
00418             <span class="comment">//  object type and adjust the TypeInfo pointer to the next</span>
00419             <span class="comment">//  free spot</span>
00420             <span class="comment">//</span>
00421 
00422             TypeInfo = (POBJECT_TYPE_INFORMATION)(TypesInformation + 1);
00423 
00424             <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d5/d1/obp_8h.html#a14">OBP_MAX_DEFINED_OBJECT_TYPES</a>; i++) {
00425 
00426                 ObjectType = <a class="code" href="../../d5/d1/obp_8h.html#a38">ObpObjectTypes</a>[ i ];
00427 
00428                 <span class="keywordflow">if</span> (ObjectType == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00429 
00430                     <span class="keywordflow">break</span>;
00431                 }
00432 
00433                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a9">ObQueryTypeInfo</a>( ObjectType,
00434                                           TypeInfo,
00435                                           ObjectInformationLength,
00436                                           &amp;TempReturnLength );
00437 
00438                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00439 
00440                     TypeInfo = (POBJECT_TYPE_INFORMATION)
00441                         ((PCHAR)(TypeInfo+1) + <a class="code" href="../../d0/d9/ntosdef_8h.html#a4">ALIGN_UP</a>( TypeInfo-&gt;TypeName.MaximumLength, ULONG ));
00442                 }
00443             }
00444 
00445         } except( EXCEPTION_EXECUTE_HANDLER ) {
00446 
00447             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00448         }
00449 
00450         <span class="keywordflow">break</span>;
00451 
00452     <span class="keywordflow">case</span> ObjectHandleFlagInformation:
00453 
00454         <span class="keywordflow">try</span> {
00455 
00456             <span class="comment">//</span>
00457             <span class="comment">//  Set the amount of data we are going to return</span>
00458             <span class="comment">//</span>
00459 
00460             TempReturnLength = <span class="keyword">sizeof</span>(OBJECT_HANDLE_FLAG_INFORMATION);
00461 
00462             HandleFlags = (POBJECT_HANDLE_FLAG_INFORMATION)ObjectInformation;
00463 
00464             <span class="comment">//</span>
00465             <span class="comment">//  Make sure we have enough room for the query, and if so we'll</span>
00466             <span class="comment">//  set the output based on the flags stored in the handle</span>
00467             <span class="comment">//</span>
00468 
00469             <span class="keywordflow">if</span> (ObjectInformationLength &lt; <span class="keyword">sizeof</span>( OBJECT_HANDLE_FLAG_INFORMATION)) {
00470 
00471                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
00472 
00473             } <span class="keywordflow">else</span> {
00474 
00475                 HandleFlags-&gt;Inherit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00476 
00477                 <span class="keywordflow">if</span> (HandleInformation.HandleAttributes &amp; OBJ_INHERIT) {
00478 
00479                     HandleFlags-&gt;Inherit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00480                 }
00481 
00482                 HandleFlags-&gt;ProtectFromClose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00483 
00484                 <span class="keywordflow">if</span> (HandleInformation.HandleAttributes &amp; <a class="code" href="../../d5/d1/obp_8h.html#a15">OBJ_PROTECT_CLOSE</a>) {
00485 
00486                     HandleFlags-&gt;ProtectFromClose = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00487                 }
00488             }
00489 
00490         } except( EXCEPTION_EXECUTE_HANDLER ) {
00491 
00492             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00493         }
00494 
00495         <span class="keywordflow">break</span>;
00496 
00497     <span class="keywordflow">default</span>:
00498 
00499         <span class="comment">//</span>
00500         <span class="comment">//  To get to this point we must have had an object and the</span>
00501         <span class="comment">//  information class is not defined, so we should dereference the</span>
00502         <span class="comment">//  object and return to our user the bad status</span>
00503         <span class="comment">//</span>
00504 
00505         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00506 
00507         <span class="keywordflow">return</span>( STATUS_INVALID_INFO_CLASS );
00508     }
00509 
00510     <span class="comment">//</span>
00511     <span class="comment">//  Now if the caller asked for a return length we'll set it from</span>
00512     <span class="comment">//  our local copy</span>
00513     <span class="comment">//</span>
00514 
00515     <span class="keywordflow">try</span> {
00516 
00517         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength ) ) {
00518 
00519             *ReturnLength = TempReturnLength;
00520         }
00521 
00522     } except( EXCEPTION_EXECUTE_HANDLER ) {
00523 
00524         <span class="comment">//</span>
00525         <span class="comment">//  Fall through, since we cannot undo what we have done.</span>
00526         <span class="comment">//</span>
00527     }
00528 
00529     <span class="comment">//</span>
00530     <span class="comment">//  In the end we can free the object if there was one and return</span>
00531     <span class="comment">//  to our caller</span>
00532     <span class="comment">//</span>
00533 
00534     <span class="keywordflow">if</span> (Object != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00535 
00536         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00537     }
00538 
00539     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00540 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="obquery.c::NtSetInformationObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NTAPI NtSetInformationObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OBJECT_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectInformationLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/obquery_8c-source.html#l00545">545</a> of file <a class="el" href="../../d7/d0/obquery_8c-source.html">obquery.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00418">DecodeKernelHandle</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01315">ExChangeHandle()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00057">IsKernelHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00324">KeStackAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00512">KeUnstackDetachProcess()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00035">__OBP_SET_HANDLE_ATTRIBUTES::ObjectInformation</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00213">ObpGetObjectTable</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00399">ObpKernelHandleTable</a>, <a class="el" href="../../d6/d1/obquery_8c.html#a4">ObpSetHandleAttributes()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00037">__OBP_SET_HANDLE_ATTRIBUTES::PreviousMode</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00329">xProtectHandle()</a>.
<p>
<pre class="fragment"><div>00554                    :
00555 
00556     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to set handle information about a specified
00557     handle
00558 
00559 Arguments:
00560 
00561     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle being modified
00562 
00563     ObjectInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">class </span>of information being
00564         modified.  The <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> accepted value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ObjectHandleFlagInformation
00565 
00566     ObjectInformation - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle
00567         flag information structure
00568 
00569     ObjectInformationLength - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00570         object information buffer
00571 
00572 Return Value:
00573 
00574     An appropriate status value
00575 
00576 --*/
00577 
00578 {
00579     <a class="code" href="../../d1/d4/struct____OBP__SET__HANDLE__ATTRIBUTES.html">OBP_SET_HANDLE_ATTRIBUTES</a> CapturedInformation;
00580     HANDLE ObjectHandle;
00581     PVOID ObjectTable;
00582     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00583     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00584     BOOLEAN AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00585     <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">KAPC_STATE</a> ApcState;
00586 
00587     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00588 
00589     <span class="comment">//</span>
00590     <span class="comment">//  Check if the information class and information length are correct.</span>
00591     <span class="comment">//</span>
00592 
00593     <span class="keywordflow">if</span> (ObjectInformationClass != ObjectHandleFlagInformation) {
00594 
00595         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00596     }
00597 
00598     <span class="keywordflow">if</span> (ObjectInformationLength != <span class="keyword">sizeof</span>(OBJECT_HANDLE_FLAG_INFORMATION)) {
00599 
00600         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00601     }
00602 
00603     <span class="comment">//</span>
00604     <span class="comment">//  Get previous processor mode and probe and capture the input</span>
00605     <span class="comment">//  buffer</span>
00606     <span class="comment">//</span>
00607 
00608     CapturedInformation.PreviousMode = KeGetPreviousMode();
00609 
00610     <span class="keywordflow">try</span> {
00611 
00612         <span class="keywordflow">if</span> (CapturedInformation.PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00613 
00614             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ObjectInformation, ObjectInformationLength, 1);
00615         }
00616 
00617         CapturedInformation.ObjectInformation = *(POBJECT_HANDLE_FLAG_INFORMATION)ObjectInformation;
00618 
00619     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00620 
00621         <span class="keywordflow">return</span> GetExceptionCode();
00622     }
00623 
00624 <span class="preprocessor">#if 0</span>
00625 <span class="preprocessor"></span>
00626     <span class="comment">//</span>
00627     <span class="comment">//  On checked builds, check that if the Kernel handle bit is set,</span>
00628     <span class="comment">//  then we're coming from Kernel mode. We should probably fail the</span>
00629     <span class="comment">//  call if bit set &amp;&amp; !Kmode</span>
00630     <span class="comment">//</span>
00631 
00632     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != NtCurrentThread()) &amp;&amp; (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != NtCurrentProcess())) {
00633 
00634         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Handle &lt; 0 ) ? (PreviousMode == KernelMode) : TRUE);
00635     }
00636 
00637 <span class="preprocessor">#endif</span>
00638 <span class="preprocessor"></span>
00639     <span class="comment">//</span>
00640     <span class="comment">//  Get the address of the object table for the current process.  Or</span>
00641     <span class="comment">//  get the system handle table if this is a kernel handle and we are</span>
00642     <span class="comment">//  in kernel mode</span>
00643     <span class="comment">//</span>
00644 
00645     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ioverifier_8c.html#a14">IsKernelHandle</a>( Handle, CapturedInformation.PreviousMode )) {
00646 
00647         <span class="comment">//</span>
00648         <span class="comment">//  Make the handle look like a regular handle</span>
00649         <span class="comment">//</span>
00650 
00651         ObjectHandle = <a class="code" href="../../d5/d1/obp_8h.html#a27">DecodeKernelHandle</a>( Handle );
00652 
00653         <span class="comment">//</span>
00654         <span class="comment">//  The global kernel handle table</span>
00655         <span class="comment">//</span>
00656 
00657         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a>;
00658 
00659         <span class="comment">//</span>
00660         <span class="comment">//  Go to the system process</span>
00661         <span class="comment">//</span>
00662 
00663         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>) {
00664             <a class="code" href="../../d3/d5/procobj_8c.html#a6">KeStackAttachProcess</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>, &amp;ApcState);
00665             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00666         }
00667 
00668     } <span class="keywordflow">else</span> {
00669 
00670         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>();
00671         ObjectHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00672     }
00673 
00674     <span class="comment">//</span>
00675     <span class="comment">//  Make the change to the handle table entry.  The callback</span>
00676     <span class="comment">//  routine will do the actual change</span>
00677     <span class="comment">//</span>
00678 
00679     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a298">ExChangeHandle</a>( ObjectTable,
00680                         ObjectHandle,
00681                         ObpSetHandleAttributes,
00682                         (ULONG_PTR)&amp;CapturedInformation) ) {
00683 
00684         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00685 
00686     } <span class="keywordflow">else</span> {
00687 
00688         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00689     }
00690 
00691     <span class="comment">//</span>
00692     <span class="comment">//  If we are attached to the system process then return</span>
00693     <span class="comment">//  back to our caller</span>
00694     <span class="comment">//</span>
00695 
00696     <span class="keywordflow">if</span> (AttachedToProcess) {
00697         <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
00698         AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00699     }
00700 
00701     <span class="comment">//</span>
00702     <span class="comment">//  And return to our caller</span>
00703     <span class="comment">//</span>
00704 
00705     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00706 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="obquery.c::ObpSetHandleAttributes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObpSetHandleAttributes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTableEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/obquery_8c-source.html#l01469">1469</a> of file <a class="el" href="../../d7/d0/obquery_8c-source.html">obquery.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00167">_OBJECT_TYPE_INITIALIZER::InvalidAttributes</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00348">OB_FLAG_KERNEL_OBJECT</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00289">OBJ_HANDLE_ATTRIBUTES</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00261">OBJ_PROTECT_CLOSE</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00035">__OBP_SET_HANDLE_ATTRIBUTES::ObjectInformation</a>, <a class="el" href="../../d6/d1/obquery_8c.html#a3">POBP_SET_HANDLE_ATTRIBUTES</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00037">__OBP_SET_HANDLE_ATTRIBUTES::PreviousMode</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
<pre class="fragment"><div>01476                    :
01477 
01478     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call back routine <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d8/ex_2handle_8c.html#a24">ExChangeHandle</a> from
01479     <a class="code" href="../../d6/d1/obquery_8c.html#a6">NtSetInformationObject</a>
01480 
01481 Arguments:
01482 
01483     ObjectTableEntry - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object table entry being
01484         modified
01485 
01486     Parameter - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OBJECT_HANDLE_FLAG_INFORMATION
01487         structure to set into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table entry
01488 
01489 Return Value:
01490 
01491     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful otherwise <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01492 
01493 --*/
01494 
01495 {
01496     <a class="code" href="../../d1/d4/struct____OBP__SET__HANDLE__ATTRIBUTES.html">POBP_SET_HANDLE_ATTRIBUTES</a> ObjectInformation;
01497     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01498 
01499     ObjectInformation = (<a class="code" href="../../d1/d4/struct____OBP__SET__HANDLE__ATTRIBUTES.html">POBP_SET_HANDLE_ATTRIBUTES</a>)Parameter;
01500 
01501     <span class="comment">//</span>
01502     <span class="comment">//  Get a pointer to the object type via the object header and if the</span>
01503     <span class="comment">//  caller has asked for inherit but the object type says that inherit</span>
01504     <span class="comment">//  is an invalid flag then return false</span>
01505     <span class="comment">//</span>
01506 
01507     ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(((ULONG_PTR)(ObjectTableEntry-&gt;Object)) &amp; ~<a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
01508 
01509     <span class="keywordflow">if</span> ((ObjectInformation-&gt;<a class="code" href="../../d1/d4/struct____OBP__SET__HANDLE__ATTRIBUTES.html#o0">ObjectInformation</a>.Inherit) &amp;&amp;
01510         ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> &amp; OBJ_INHERIT) != 0)) {
01511 
01512         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01513     }
01514 
01515     <span class="comment">//</span>
01516     <span class="comment">//  User mode cannot set the object attributes for kernel objects</span>
01517     <span class="comment">//</span>
01518 
01519     <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a2">OB_FLAG_KERNEL_OBJECT</a>) &amp;&amp;
01520         (ObjectInformation-&gt;<a class="code" href="../../d1/d4/struct____OBP__SET__HANDLE__ATTRIBUTES.html#o1">PreviousMode</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
01521 
01522         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01523     }
01524 
01525     <span class="comment">//</span>
01526     <span class="comment">//  For each piece of information (inheriit and protect from close) that</span>
01527     <span class="comment">//  is in the object information buffer we'll set or clear the bits in</span>
01528     <span class="comment">//  the object table entry.  The bits modified are the low order bits of</span>
01529     <span class="comment">//  used to store the pointer to the object header.</span>
01530     <span class="comment">//</span>
01531 
01532     <span class="keywordflow">if</span> (ObjectInformation-&gt;<a class="code" href="../../d1/d4/struct____OBP__SET__HANDLE__ATTRIBUTES.html#o0">ObjectInformation</a>.Inherit) {
01533 
01534         ObjectTableEntry-&gt;ObAttributes |= OBJ_INHERIT;
01535 
01536     } <span class="keywordflow">else</span> {
01537 
01538         ObjectTableEntry-&gt;ObAttributes &amp;= ~OBJ_INHERIT;
01539     }
01540 
01541     <span class="keywordflow">if</span> (ObjectInformation-&gt;<a class="code" href="../../d1/d4/struct____OBP__SET__HANDLE__ATTRIBUTES.html#o0">ObjectInformation</a>.ProtectFromClose) {
01542 
01543         ObjectTableEntry-&gt;ObAttributes |= <a class="code" href="../../d5/d1/obp_8h.html#a15">OBJ_PROTECT_CLOSE</a>;
01544 
01545     } <span class="keywordflow">else</span> {
01546 
01547         ObjectTableEntry-&gt;ObAttributes &amp;= ~<a class="code" href="../../d5/d1/obp_8h.html#a15">OBJ_PROTECT_CLOSE</a>;
01548     }
01549 
01550     <span class="comment">//</span>
01551     <span class="comment">//  And return to our caller</span>
01552     <span class="comment">//</span>
01553 
01554     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01555 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="obquery.c::ObpSetHandleAttributes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObpSetHandleAttributes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>TableEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d0/obquery_8c-source.html#l00545">NtSetInformationObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="obquery.c::ObQueryNameString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObQueryNameString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT POBJECT_NAME_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectNameInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">713</a> of file <a class="el" href="../../d7/d0/obquery_8c-source.html">obquery.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00331">_OBJECT_HEADER_NAME_INFO::Directory</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00332">_OBJECT_HEADER_NAME_INFO::Name</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00709">OBP_MISSING_NAME_LITERAL</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00710">OBP_MISSING_NAME_LITERAL_SIZE</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">ObpBeginTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">ObpEndTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00189">ObpEnterRootDirectoryMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00202">ObpLeaveRootDirectoryMutex</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00046">ObpRootDirectoryObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00182">_OBJECT_TYPE_INITIALIZER::QueryNameProcedure</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cachesub_8c-source.html#l03880">CcWriteBehind()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00373">IoGetDeviceProperty()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02034">IopBuildCmResourceList()</a>, <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00386">IopCaptureObjectName()</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00088">IopErrorLogThread()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l01811">IopQueryName()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05617">IopRaiseHardError()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01721">MmGetFileNameForSection()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00061">NtQueryVirtualMemory()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00800">ObGetObjectInformation()</a>, and <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02324">SepQueryNameString()</a>.
<p>
<pre class="fragment"><div>00722                    :
00723 
00724     This routine processes a query of an object's name information
00725 
00726 Arguments:
00727 
00728     Object - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being queried
00729 
00730     ObjectNameInfo - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name string
00731         information
00732 
00733     Length - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original object
00734         name info buffer.
00735 
00736     ReturnLength - Contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes already used up
00737         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object name info. On <span class="keywordflow">return</span> <span class="keyword">this</span> receives an updated
00738         byte count.
00739 
00740         (Length minus ReturnLength) <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> really now many bytes are left
00741         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output buffer.  The buffer supplied to <span class="keyword">this</span> call may
00742         actually be offset within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original users buffer
00743 
00744 Return Value:
00745 
00746     An appropriate status value
00747 
00748 --*/
00749 
00750 {
00751     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00752     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00753     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
00754     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectDirectoryHeader;
00755     <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> ObjectDirectory;
00756     ULONG NameInfoSize;
00757     PUNICODE_STRING <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
00758     PWCH StringBuffer;
00759     ULONG NameSize;
00760 
00761     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00762 
00763     <span class="comment">//</span>
00764     <span class="comment">//  Get the object header and name info record if it exists</span>
00765     <span class="comment">//</span>
00766 
00767     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00768     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
00769 
00770     <span class="comment">//</span>
00771     <span class="comment">//  If the object type has a query name callback routine then</span>
00772     <span class="comment">//  that is how we get the name</span>
00773     <span class="comment">//</span>
00774 
00775     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o18">QueryNameProcedure</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00776 
00777         <span class="keywordflow">try</span> {
00778 
00779             KIRQL SaveIrql;
00780 
00781             <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
00782             <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Query"</span>, ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>, Object );
00783 
00784             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (*ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o18">QueryNameProcedure</a>)( Object,
00785                                                                          (BOOLEAN)((NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length != 0)),
00786                                                                          ObjectNameInfo,
00787                                                                          Length,
00788                                                                          ReturnLength );
00789 
00790         } except( EXCEPTION_EXECUTE_HANDLER ) {
00791 
00792             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00793         }
00794 
00795         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00796     }
00797 
00798     <span class="comment">//</span>
00799     <span class="comment">//  Otherwise, the object type does not specify a query name</span>
00800     <span class="comment">//  procedure so we get to do the work.  The first thing</span>
00801     <span class="comment">//  to check is if the object doesn't even have a name.  If</span>
00802     <span class="comment">//  object doesn't have a name then we'll return an empty name</span>
00803     <span class="comment">//  info structure.</span>
00804     <span class="comment">//</span>
00805 
00806     <span class="keywordflow">if</span> ((NameInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00807 
00808         <span class="comment">//</span>
00809         <span class="comment">//  Compute the length of our return buffer, set the output</span>
00810         <span class="comment">//  if necessary and make sure the supplied buffer is large</span>
00811         <span class="comment">//  enough</span>
00812         <span class="comment">//</span>
00813 
00814         NameInfoSize = <span class="keyword">sizeof</span>( OBJECT_NAME_INFORMATION );
00815 
00816         <span class="keywordflow">try</span> {
00817 
00818             *ReturnLength = NameInfoSize;
00819 
00820         } except( EXCEPTION_EXECUTE_HANDLER ) {
00821 
00822             <span class="keywordflow">return</span>( GetExceptionCode() );
00823         }
00824 
00825         <span class="keywordflow">if</span> (Length &lt; NameInfoSize) {
00826 
00827             <span class="keywordflow">return</span>( STATUS_INFO_LENGTH_MISMATCH );
00828         }
00829 
00830         <span class="comment">//</span>
00831         <span class="comment">//  Initialize the output buffer to be an empty string</span>
00832         <span class="comment">//  and then return to our caller</span>
00833         <span class="comment">//</span>
00834 
00835         <span class="keywordflow">try</span> {
00836 
00837             ObjectNameInfo-&gt;Name.Length = 0;
00838             ObjectNameInfo-&gt;Name.MaximumLength = 0;
00839             ObjectNameInfo-&gt;Name.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00840 
00841         } except( EXCEPTION_EXECUTE_HANDLER ) {
00842 
00843             <span class="comment">//</span>
00844             <span class="comment">//  Fall through, since we cannot undo what we have done.</span>
00845             <span class="comment">//</span>
00846             <span class="comment">//  **** This should probably get the exception code and return</span>
00847             <span class="comment">//  that value</span>
00848             <span class="comment">//</span>
00849         }
00850 
00851         <span class="keywordflow">return</span>( STATUS_SUCCESS );
00852     }
00853 
00854     <span class="comment">//</span>
00855     <span class="comment">//  First lock the directory mutex to stop before we chase stuff down</span>
00856     <span class="comment">//</span>
00857 
00858     <a class="code" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>();
00859 
00860     <span class="keywordflow">try</span> {
00861 
00862         <span class="comment">//</span>
00863         <span class="comment">//  The object does have a name but now see if this is</span>
00864         <span class="comment">//  just the root directory object in which case the name size</span>
00865         <span class="comment">//  is only the "\" character</span>
00866         <span class="comment">//</span>
00867 
00868         <span class="keywordflow">if</span> (Object == <a class="code" href="../../d8/d5/kddata_8c.html#a9">ObpRootDirectoryObject</a>) {
00869 
00870             NameSize = <span class="keyword">sizeof</span>( OBJ_NAME_PATH_SEPARATOR );
00871 
00872         } <span class="keywordflow">else</span> {
00873 
00874             <span class="comment">//</span>
00875             <span class="comment">//  The named object is not the root so for every directory</span>
00876             <span class="comment">//  working out way up we'll add its size to the name keeping</span>
00877             <span class="comment">//  track of "\" characters inbetween each component.  We first</span>
00878             <span class="comment">//  start with the object name itself and then move on to</span>
00879             <span class="comment">//  the directories</span>
00880             <span class="comment">//</span>
00881 
00882             ObjectDirectory = NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>;
00883             NameSize = <span class="keyword">sizeof</span>( OBJ_NAME_PATH_SEPARATOR ) + NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length;
00884 
00885             <span class="comment">//</span>
00886             <span class="comment">//  While we are not at the root we'll keep moving up</span>
00887             <span class="comment">//</span>
00888 
00889             <span class="keywordflow">while</span> ((ObjectDirectory != <a class="code" href="../../d8/d5/kddata_8c.html#a9">ObpRootDirectoryObject</a>) &amp;&amp; (ObjectDirectory)) {
00890 
00891                 <span class="comment">//</span>
00892                 <span class="comment">//  Get the name information for this directory</span>
00893                 <span class="comment">//</span>
00894 
00895                 ObjectDirectoryHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( ObjectDirectory );
00896                 NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectDirectoryHeader );
00897 
00898                 <span class="keywordflow">if</span> ((NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00899 
00900                     <span class="comment">//</span>
00901                     <span class="comment">//  This directory has a name so add it to the accomulated</span>
00902                     <span class="comment">//  size and move up the tree</span>
00903                     <span class="comment">//</span>
00904 
00905                     NameSize += <span class="keyword">sizeof</span>( OBJ_NAME_PATH_SEPARATOR ) + NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length;
00906                     ObjectDirectory = NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>;
00907 
00908                 } <span class="keywordflow">else</span> {
00909 
00910                     <span class="comment">//</span>
00911                     <span class="comment">//  This directory does not have a name so we'll give it</span>
00912                     <span class="comment">//  the "..." name and stop the loop</span>
00913                     <span class="comment">//</span>
00914 
00915                     NameSize += <span class="keyword">sizeof</span>( OBJ_NAME_PATH_SEPARATOR ) + <a class="code" href="../../d6/d1/obquery_8c.html#a1">OBP_MISSING_NAME_LITERAL_SIZE</a>;
00916                     <span class="keywordflow">break</span>;
00917                 }
00918             }
00919         }
00920 
00921         <span class="comment">//</span>
00922         <span class="comment">//  At this point NameSize is the number of bytes we need to store the</span>
00923         <span class="comment">//  name of the object from the root down.  The total buffer size we are</span>
00924         <span class="comment">//  going to need will include this size, plus object name information</span>
00925         <span class="comment">//  structure, plus an ending null character</span>
00926         <span class="comment">//</span>
00927 
00928         NameInfoSize = NameSize + <span class="keyword">sizeof</span>( OBJECT_NAME_INFORMATION ) + <span class="keyword">sizeof</span>( UNICODE_NULL );
00929 
00930         <span class="comment">//</span>
00931         <span class="comment">//  Set the output size and make sure the supplied buffer is large enough</span>
00932         <span class="comment">//  to hold the information</span>
00933         <span class="comment">//</span>
00934 
00935         <span class="keywordflow">try</span> {
00936 
00937             *ReturnLength = NameInfoSize;
00938 
00939         } except( EXCEPTION_EXECUTE_HANDLER ) {
00940 
00941             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00942             leave;
00943         }
00944 
00945         <span class="keywordflow">if</span> (Length &lt; NameInfoSize) {
00946 
00947             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
00948             leave;
00949         }
00950 
00951         <span class="comment">//</span>
00952         <span class="comment">//  **** the following IF isn't necessary because name info size is</span>
00953         <span class="comment">//  already guaranteed to be nonzero from about 23 lines above</span>
00954         <span class="comment">//</span>
00955 
00956         <span class="keywordflow">if</span> (NameInfoSize != 0) {
00957 
00958             <span class="comment">//</span>
00959             <span class="comment">//  Set the String buffer to point to the byte right after the</span>
00960             <span class="comment">//  last byte in the output string.  This following logic actually</span>
00961             <span class="comment">//  fills in the buffer backwards working from the name back to the</span>
00962             <span class="comment">//  root</span>
00963             <span class="comment">//</span>
00964 
00965             StringBuffer = (PWCH)ObjectNameInfo;
00966             StringBuffer = (PWCH)((PCH)StringBuffer + NameInfoSize);
00967 
00968             NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
00969 
00970             <span class="keywordflow">try</span> {
00971 
00972                 <span class="comment">//</span>
00973                 <span class="comment">//  Terminate the string with a null and backup one unicode</span>
00974                 <span class="comment">//  character</span>
00975                 <span class="comment">//</span>
00976 
00977                 *--StringBuffer = UNICODE_NULL;
00978 
00979                 <span class="comment">//</span>
00980                 <span class="comment">//  If the object in question is not the root directory</span>
00981                 <span class="comment">//  then we are going to put its name in the string buffer</span>
00982                 <span class="comment">//  When we finally reach the root directory we'll append on</span>
00983                 <span class="comment">//  the final "\"</span>
00984                 <span class="comment">//</span>
00985 
00986                 <span class="keywordflow">if</span> (Object != <a class="code" href="../../d8/d5/kddata_8c.html#a9">ObpRootDirectoryObject</a>) {
00987 
00988                     <span class="comment">//</span>
00989                     <span class="comment">//  Add in the objects name</span>
00990                     <span class="comment">//</span>
00991 
00992                     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = &amp;NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>;
00993                     StringBuffer = (PWCH)((PCH)StringBuffer - <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length);
00994                     RtlMoveMemory( StringBuffer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length );
00995 
00996                     <span class="comment">//</span>
00997                     <span class="comment">//  While we are not at the root directory we'll keep</span>
00998                     <span class="comment">//  moving up</span>
00999                     <span class="comment">//</span>
01000 
01001                     ObjectDirectory = NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>;
01002 
01003                     <span class="keywordflow">while</span> ((ObjectDirectory != <a class="code" href="../../d8/d5/kddata_8c.html#a9">ObpRootDirectoryObject</a>) &amp;&amp; (ObjectDirectory)) {
01004 
01005                         <span class="comment">//</span>
01006                         <span class="comment">//  Get the name information for this directory</span>
01007                         <span class="comment">//</span>
01008 
01009                         ObjectDirectoryHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( ObjectDirectory );
01010                         NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectDirectoryHeader );
01011 
01012                         <span class="comment">//</span>
01013                         <span class="comment">//  Tack on the "\" between the last name we added and</span>
01014                         <span class="comment">//  this new name</span>
01015                         <span class="comment">//</span>
01016 
01017                         *--StringBuffer = OBJ_NAME_PATH_SEPARATOR;
01018 
01019                         <span class="comment">//</span>
01020                         <span class="comment">//  Preappend the directory name, if it has one, and</span>
01021                         <span class="comment">//  move up to the next directory.</span>
01022                         <span class="comment">//</span>
01023 
01024                         <span class="keywordflow">if</span> ((NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01025 
01026                             <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = &amp;NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>;
01027                             StringBuffer = (PWCH)((PCH)StringBuffer - <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length);
01028                             RtlMoveMemory( StringBuffer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length );
01029                             ObjectDirectory = NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>;
01030 
01031                         } <span class="keywordflow">else</span> {
01032 
01033                             <span class="comment">//</span>
01034                             <span class="comment">//  The directory is nameless so use the "..." for</span>
01035                             <span class="comment">//  its name and break out of the loop</span>
01036                             <span class="comment">//</span>
01037 
01038                             StringBuffer = (PWCH)((PCH)StringBuffer - <a class="code" href="../../d6/d1/obquery_8c.html#a1">OBP_MISSING_NAME_LITERAL_SIZE</a>);
01039                             RtlMoveMemory( StringBuffer,
01040                                            OBP_MISSING_NAME_LITERAL,
01041                                            OBP_MISSING_NAME_LITERAL_SIZE );
01042                             <span class="keywordflow">break</span>;
01043                         }
01044                     }
01045                 }
01046 
01047                 <span class="comment">//</span>
01048                 <span class="comment">//  Tack on the "\" for the root directory and then set the</span>
01049                 <span class="comment">//  output unicode string variable to have the right size</span>
01050                 <span class="comment">//  and point to the right spot.</span>
01051                 <span class="comment">//</span>
01052 
01053                 *--StringBuffer = OBJ_NAME_PATH_SEPARATOR;
01054 
01055                 ObjectNameInfo-&gt;Name.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NameSize;
01056                 ObjectNameInfo-&gt;Name.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(NameSize+<span class="keyword">sizeof</span>( UNICODE_NULL ));
01057                 ObjectNameInfo-&gt;Name.Buffer = StringBuffer;
01058 
01059             } except( EXCEPTION_EXECUTE_HANDLER ) {
01060 
01061                 <span class="comment">//</span>
01062                 <span class="comment">// Fall through, since we cannot undo what we have done.</span>
01063                 <span class="comment">//</span>
01064                 <span class="comment">//  **** This should probably get the exception code and return</span>
01065                 <span class="comment">//  that value</span>
01066                 <span class="comment">//</span>
01067             }
01068         }
01069 
01070         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01071 
01072     } finally {
01073 
01074         <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
01075     }
01076 
01077     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01078 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="obquery.c::ObQueryObjectAuditingByHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObQueryObjectAuditingByHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateOnClose</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/obquery_8c-source.html#l01319">1319</a> of file <a class="el" href="../../d7/d0/obquery_8c-source.html">obquery.c</a>.
<p>
References <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01403">ExMapHandleToPointer()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00336">ExUnlockHandleTableEntry()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02674">_HANDLE_TABLE_ENTRY::ObAttributes</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00408">OBJ_AUDIT_OBJECT_CLOSE</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00213">ObpGetObjectTable</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01326                    :
01327 
01328     This routine tells <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated handle will
01329     generate an audit <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> closed
01330 
01331 Arguments:
01332 
01333     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle being queried
01334 
01335     GenerateOnClose - Receives <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle will generate
01336         an audit <span class="keywordflow">if</span> closed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
01337 
01338 Return Value:
01339 
01340     An appropriate status value
01341 
01342 --*/
01343 
01344 {
01345     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> ObjectTable;
01346     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ObjectTableEntry;
01347     PVOID Object;
01348     ULONG CapturedGrantedAccess;
01349     ULONG CapturedAttributes;
01350     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01351 
01352     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01353 
01354     <span class="comment">//</span>
01355     <span class="comment">//  Protect ourselves from being interrupted while we hold a handle table</span>
01356     <span class="comment">//  entry lock</span>
01357     <span class="comment">//</span>
01358 
01359     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01360 
01361     <span class="keywordflow">try</span> {
01362 
01363         <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObQueryObjectAuditingByHandle"</span> );
01364 
01365 
01366         <span class="comment">//</span>
01367         <span class="comment">//  For the current process we'll grab its object table and</span>
01368         <span class="comment">//  then get the object table entry</span>
01369         <span class="comment">//</span>
01370 
01371         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>();
01372 
01373         ObjectTableEntry = <a class="code" href="../../d5/d8/ex_8h.html#a299">ExMapHandleToPointer</a>( ObjectTable,
01374                                                   Handle );
01375 
01376         <span class="comment">//</span>
01377         <span class="comment">//  If we were given a valid handle we'll look at the attributes</span>
01378         <span class="comment">//  stored in the object table entry to decide if we generate</span>
01379         <span class="comment">//  an audit on close</span>
01380         <span class="comment">//</span>
01381 
01382         <span class="keywordflow">if</span> (ObjectTableEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01383 
01384             CapturedAttributes = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a>;
01385 
01386             <span class="keywordflow">if</span> (CapturedAttributes &amp; <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>) {
01387 
01388                 *GenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01389 
01390             } <span class="keywordflow">else</span> {
01391 
01392                 *GenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01393             }
01394 
01395             <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( ObjectTable, ObjectTableEntry );
01396 
01397             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01398 
01399         } <span class="keywordflow">else</span> {
01400 
01401             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
01402         }
01403 
01404     } finally {
01405 
01406         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01407     }
01408 
01409     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01410 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="obquery.c::ObQueryTypeInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObQueryTypeInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT POBJECT_TYPE_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/obquery_8c-source.html#l01216">1216</a> of file <a class="el" href="../../d7/d0/obquery_8c-source.html">obquery.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00126">ALIGN_UP</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>.
<p>
<pre class="fragment"><div>01225                    :
01226 
01227     This routine processes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query <span class="keywordflow">for</span> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> information
01228 
01229 Arguments:
01230 
01231     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> being queried
01232 
01233     ObjectTypeInfo - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> information
01234 
01235     Length - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
01236         information buffer
01237 
01238     ReturnLength - Contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes already used up
01239         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> information buffer. On <span class="keywordflow">return</span> <span class="keyword">this</span> receives
01240         an updated byte count
01241 
01242         (Length minus ReturnLength) <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> really now many bytes are left
01243         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output buffer.  The buffer supplied to <span class="keyword">this</span> call may
01244         actually be offset within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original users buffer
01245 
01246 Return Value:
01247 
01248     An appropriate status value
01249 
01250 --*/
01251 
01252 {
01253     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01254 
01255     <span class="keywordflow">try</span> {
01256 
01257         <span class="comment">//</span>
01258         <span class="comment">//  The total number of bytes needed for this query includes the</span>
01259         <span class="comment">//  object type information structure plus the name of the type</span>
01260         <span class="comment">//  rounded up to a ulong boundary</span>
01261         <span class="comment">//</span>
01262 
01263         *ReturnLength += <span class="keyword">sizeof</span>( *ObjectTypeInfo ) + <a class="code" href="../../d0/d9/ntosdef_8h.html#a4">ALIGN_UP</a>( ObjectType-&gt;Name.MaximumLength, ULONG );
01264 
01265         <span class="comment">//</span>
01266         <span class="comment">//  Make sure the buffer is large enough for this information and</span>
01267         <span class="comment">//  then fill in the record</span>
01268         <span class="comment">//</span>
01269 
01270         <span class="keywordflow">if</span> (Length &lt; *ReturnLength) {
01271 
01272             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
01273 
01274         } <span class="keywordflow">else</span> {
01275 
01276             ObjectTypeInfo-&gt;TotalNumberOfObjects = ObjectType-&gt;TotalNumberOfObjects;
01277             ObjectTypeInfo-&gt;TotalNumberOfHandles = ObjectType-&gt;TotalNumberOfHandles;
01278             ObjectTypeInfo-&gt;HighWaterNumberOfObjects = ObjectType-&gt;HighWaterNumberOfObjects;
01279             ObjectTypeInfo-&gt;HighWaterNumberOfHandles = ObjectType-&gt;HighWaterNumberOfHandles;
01280             ObjectTypeInfo-&gt;InvalidAttributes = ObjectType-&gt;TypeInfo.InvalidAttributes;
01281             ObjectTypeInfo-&gt;GenericMapping = ObjectType-&gt;TypeInfo.GenericMapping;
01282             ObjectTypeInfo-&gt;ValidAccessMask = ObjectType-&gt;TypeInfo.ValidAccessMask;
01283             ObjectTypeInfo-&gt;SecurityRequired = ObjectType-&gt;TypeInfo.SecurityRequired;
01284             ObjectTypeInfo-&gt;MaintainHandleCount = ObjectType-&gt;TypeInfo.MaintainHandleCount;
01285             ObjectTypeInfo-&gt;PoolType = ObjectType-&gt;TypeInfo.PoolType;
01286             ObjectTypeInfo-&gt;DefaultPagedPoolCharge = ObjectType-&gt;TypeInfo.DefaultPagedPoolCharge;
01287             ObjectTypeInfo-&gt;DefaultNonPagedPoolCharge = ObjectType-&gt;TypeInfo.DefaultNonPagedPoolCharge;
01288 
01289             <span class="comment">//</span>
01290             <span class="comment">//  The type name goes right after this structure.  We cannot use</span>
01291             <span class="comment">//  rtl routine like RtlCopyUnicodeString that might use the local</span>
01292             <span class="comment">//  memory to keep state, because this is the user buffer and it</span>
01293             <span class="comment">//  could be changing by user</span>
01294             <span class="comment">//</span>
01295 
01296             ObjectTypeInfo-&gt;TypeName.Buffer = (PWSTR)(ObjectTypeInfo+1);
01297             ObjectTypeInfo-&gt;TypeName.Length = ObjectType-&gt;Name.Length;
01298             ObjectTypeInfo-&gt;TypeName.MaximumLength = ObjectType-&gt;Name.MaximumLength;
01299 
01300             RtlMoveMemory( (PWSTR)(ObjectTypeInfo+1),
01301                            ObjectType-&gt;Name.Buffer,
01302                            ObjectType-&gt;Name.Length );
01303 
01304             ((PWSTR)(ObjectTypeInfo+1))[ ObjectType-&gt;Name.Length/<span class="keyword">sizeof</span>(WCHAR) ] = UNICODE_NULL;
01305 
01306             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01307         }
01308 
01309     } except( EXCEPTION_EXECUTE_HANDLER ) {
01310 
01311         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01312     }
01313 
01314     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01315 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="obquery.c::ObQueryTypeName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObQueryTypeName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/obquery_8c-source.html#l01082">1082</a> of file <a class="el" href="../../d7/d0/obquery_8c-source.html">obquery.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00189">_OBJECT_TYPE::Name</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/obtype_8c-source.html#l00800">ObGetObjectInformation()</a>, and <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02400">SepQueryTypeString()</a>.
<p>
<pre class="fragment"><div>01091                    :
01092 
01093     This routine processes a query of an object's <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> name
01094 
01095 Arguments:
01096 
01097     Object - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being queried
01098 
01099     ObjectTypeName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> name
01100         string information
01101 
01102     Length - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
01103         name buffer
01104 
01105     ReturnLength - Contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes already used up
01106         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> name buffer. On <span class="keywordflow">return</span> <span class="keyword">this</span> receives
01107         an updated byte count
01108 
01109         (Length minus ReturnLength) <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> really now many bytes are left
01110         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output buffer.  The buffer supplied to <span class="keyword">this</span> call may
01111         actually be offset within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original users buffer
01112 
01113 Return Value:
01114 
01115     An appropriate status value
01116 
01117 --*/
01118 
01119 {
01120     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
01121     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01122     ULONG TypeNameSize;
01123     PUNICODE_STRING <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
01124     PWCH StringBuffer;
01125     ULONG NameSize;
01126 
01127     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01128 
01129     <span class="comment">//</span>
01130     <span class="comment">//  From the object get its object type and from that get the size of</span>
01131     <span class="comment">//  the object type name.  The total size for we need for the output</span>
01132     <span class="comment">//  buffer must fit the name, a terminating null, and a preceding</span>
01133     <span class="comment">//  unicode string structure</span>
01134     <span class="comment">//</span>
01135 
01136     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01137     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
01138 
01139     NameSize = ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o2">Name</a>.Length;
01140     TypeNameSize = NameSize + <span class="keyword">sizeof</span>( UNICODE_NULL ) + <span class="keyword">sizeof</span>( UNICODE_STRING );
01141 
01142     <span class="comment">//</span>
01143     <span class="comment">//  Update the number of bytes we need and make sure the output buffer is</span>
01144     <span class="comment">//  large enough</span>
01145     <span class="comment">//</span>
01146     <span class="comment">//  **** to be consistent with all our callers and other routines in</span>
01147     <span class="comment">//  this module this should probably be a "+=" and not just "="</span>
01148     <span class="comment">//</span>
01149 
01150     <span class="keywordflow">try</span> {
01151 
01152         *ReturnLength = TypeNameSize;
01153 
01154     } except( EXCEPTION_EXECUTE_HANDLER ) {
01155 
01156         <span class="keywordflow">return</span>( GetExceptionCode() );
01157     }
01158 
01159     <span class="keywordflow">if</span> (Length &lt; TypeNameSize) {
01160 
01161         <span class="keywordflow">return</span>( STATUS_INFO_LENGTH_MISMATCH );
01162     }
01163 
01164     <span class="comment">//</span>
01165     <span class="comment">//  **** this IF is probably not needed because of the earlier computation</span>
01166     <span class="comment">//  of type name size</span>
01167     <span class="comment">//</span>
01168 
01169     <span class="keywordflow">if</span> (TypeNameSize != 0) {
01170 
01171         <span class="comment">//</span>
01172         <span class="comment">//  Set string buffer to point to the one byte beyond the</span>
01173         <span class="comment">//  buffer that we're going to fill in</span>
01174         <span class="comment">//</span>
01175 
01176         StringBuffer = (PWCH)ObjectTypeName;
01177         StringBuffer = (PWCH)((PCH)StringBuffer + TypeNameSize);
01178 
01179         <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o2">Name</a>;
01180 
01181         <span class="keywordflow">try</span> {
01182 
01183             <span class="comment">//</span>
01184             <span class="comment">//  Tack on the terminating null character and copy over</span>
01185             <span class="comment">//  the type name</span>
01186             <span class="comment">//</span>
01187 
01188             *--StringBuffer = UNICODE_NULL;
01189 
01190             StringBuffer = (PWCH)((PCH)StringBuffer - <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length);
01191 
01192             RtlMoveMemory( StringBuffer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length );
01193 
01194             <span class="comment">//</span>
01195             <span class="comment">//  Now set the preceding unicode string to have the right</span>
01196             <span class="comment">//  lengths and to point to this buffer</span>
01197             <span class="comment">//</span>
01198 
01199             ObjectTypeName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NameSize;
01200             ObjectTypeName-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(NameSize+<span class="keyword">sizeof</span>( UNICODE_NULL ));
01201             ObjectTypeName-&gt;Buffer = StringBuffer;
01202 
01203         } except( EXCEPTION_EXECUTE_HANDLER ) {
01204 
01205             <span class="comment">//</span>
01206             <span class="comment">// Fall through, since we cannot undo what we have done.</span>
01207             <span class="comment">//</span>
01208         }
01209     }
01210 
01211     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01212 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:59 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
