<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: oplock.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>oplock.c</h1><a href="../../d5/d2/oplock_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment"></span>
00004 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    Oplock.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    The OPLOCK routines provide support to filesystems which implement</span>
00013 <span class="comment">    opporuntistics locks.  The specific actions needed are based on</span>
00014 <span class="comment">    the current oplocked state of the file (maintained in the OPLOCK</span>
00015 <span class="comment">    structure) and the Irp the Io system provides to the file systems.</span>
00016 <span class="comment">    Rather than define separate entry points for each oplock operation</span>
00017 <span class="comment">    a single generic entry point is defined.</span>
00018 <span class="comment"></span>
00019 <span class="comment">    The file systems will maintain a variable of type OPLOCK for</span>
00020 <span class="comment">    each open file in the system.  This variable is initialized</span>
00021 <span class="comment">    when an unopened file is opened.  It is uninitialized when the</span>
00022 <span class="comment">    last reference to the file is cleared when the Io system calls</span>
00023 <span class="comment">    the file system with a close call.</span>
00024 <span class="comment"></span>
00025 <span class="comment">    The following routines are provided by this package:</span>
00026 <span class="comment"></span>
00027 <span class="comment">      o  FsRtlInitializeOplock - Initialize a new OPLOCK structure.  There</span>
00028 <span class="comment">         should be one OPLOCK for every opened file.  Each OPLOCK structure</span>
00029 <span class="comment">         must be initialized before it can be used by the system.</span>
00030 <span class="comment"></span>
00031 <span class="comment">      o  FsRtlUninitializeOplock - Uninitialize an OPLOCK structure.  This</span>
00032 <span class="comment">         call is used to cleanup any anciallary structures allocated and</span>
00033 <span class="comment">         maintained by the OPLOCK.  After being uninitialized the OPLOCK</span>
00034 <span class="comment">         must again be initialized before it can be used by the system.</span>
00035 <span class="comment"></span>
00036 <span class="comment">Author:</span>
00037 <span class="comment"></span>
00038 <span class="comment">    Brian Andrew    [BrianAn]   10-Dec-1990</span>
00039 <span class="comment"></span>
00040 <span class="comment">Revision History:</span>
00041 <span class="comment"></span>
00042 <span class="comment">--*/</span>
00043 
00044 <span class="preprocessor">#include "FsRtlP.h"</span>
00045 
00046 <span class="comment">//</span>
00047 <span class="comment">//  Trace level for the module</span>
00048 <span class="comment">//</span>
00049 
<a name="l00050"></a><a class="code" href="../../d5/d2/oplock_8c.html#a0">00050</a> <span class="preprocessor">#define Dbg                              (0x08000000)</span>
00051 <span class="preprocessor"></span>
00052 <span class="comment">//</span>
00053 <span class="comment">//  Define the compatible filter oplock desired access flags.  We won't break</span>
00054 <span class="comment">//  a filter oplock when these flags are the only flags specified.</span>
00055 <span class="comment">//</span>
00056 
<a name="l00057"></a><a class="code" href="../../d5/d2/oplock_8c.html#a1">00057</a> <span class="preprocessor">#define FILTER_OPLOCK_VALID_FLAGS (     \</span>
00058 <span class="preprocessor">    FILE_READ_ATTRIBUTES            |   \</span>
00059 <span class="preprocessor">    FILE_WRITE_ATTRIBUTES           |   \</span>
00060 <span class="preprocessor">    FILE_READ_DATA                  |   \</span>
00061 <span class="preprocessor">    FILE_READ_EA                    |   \</span>
00062 <span class="preprocessor">    FILE_EXECUTE                    |   \</span>
00063 <span class="preprocessor">    SYNCHRONIZE                     |   \</span>
00064 <span class="preprocessor">    READ_CONTROL                        \</span>
00065 <span class="preprocessor">)</span>
00066 <span class="preprocessor"></span>
00067 
00068 <span class="comment">//</span>
00069 <span class="comment">//  We encode the different bits so we can test without having to enumerate</span>
00070 <span class="comment">//  all of the possible states.</span>
00071 <span class="comment">//</span>
00072 <span class="comment">//  NOTE - The LEVEL_1, BATCH_OPLOCK and FILTER_OPLOCK must be in this order.</span>
00073 <span class="comment">//  We assume later on that they are in this order.</span>
00074 <span class="comment">//</span>
00075 
<a name="l00076"></a><a class="code" href="../../d5/d2/oplock_8c.html#a2">00076</a> <span class="preprocessor">#define NO_OPLOCK               (0x00000001)</span>
<a name="l00077"></a><a class="code" href="../../d5/d2/oplock_8c.html#a3">00077</a> <span class="preprocessor"></span><span class="preprocessor">#define LEVEL_I_OPLOCK          (0x00000002)</span>
<a name="l00078"></a><a class="code" href="../../d5/d2/oplock_8c.html#a4">00078</a> <span class="preprocessor"></span><span class="preprocessor">#define BATCH_OPLOCK            (0x00000004)</span>
<a name="l00079"></a><a class="code" href="../../d5/d2/oplock_8c.html#a5">00079</a> <span class="preprocessor"></span><span class="preprocessor">#define FILTER_OPLOCK           (0x00000008)</span>
<a name="l00080"></a><a class="code" href="../../d5/d2/oplock_8c.html#a6">00080</a> <span class="preprocessor"></span><span class="preprocessor">#define LEVEL_II_OPLOCK         (0x00000010)</span>
00081 <span class="preprocessor"></span>
<a name="l00082"></a><a class="code" href="../../d5/d2/oplock_8c.html#a7">00082</a> <span class="preprocessor">#define OPLOCK_TYPE_MASK        (0x0000001f)</span>
00083 <span class="preprocessor"></span>
<a name="l00084"></a><a class="code" href="../../d5/d2/oplock_8c.html#a8">00084</a> <span class="preprocessor">#define EXCLUSIVE               (0x00000040)</span>
<a name="l00085"></a><a class="code" href="../../d5/d2/oplock_8c.html#a9">00085</a> <span class="preprocessor"></span><span class="preprocessor">#define PENDING                 (0x00000080)</span>
00086 <span class="preprocessor"></span>
<a name="l00087"></a><a class="code" href="../../d5/d2/oplock_8c.html#a10">00087</a> <span class="preprocessor">#define OPLOCK_HELD_MASK        (0x000000c0)</span>
00088 <span class="preprocessor"></span>
<a name="l00089"></a><a class="code" href="../../d5/d2/oplock_8c.html#a11">00089</a> <span class="preprocessor">#define BREAK_TO_II             (0x00000100)</span>
<a name="l00090"></a><a class="code" href="../../d5/d2/oplock_8c.html#a12">00090</a> <span class="preprocessor"></span><span class="preprocessor">#define BREAK_TO_NONE           (0x00000200)</span>
<a name="l00091"></a><a class="code" href="../../d5/d2/oplock_8c.html#a13">00091</a> <span class="preprocessor"></span><span class="preprocessor">#define BREAK_TO_II_TO_NONE     (0x00000400)</span>
<a name="l00092"></a><a class="code" href="../../d5/d2/oplock_8c.html#a14">00092</a> <span class="preprocessor"></span><span class="preprocessor">#define CLOSE_PENDING           (0x00000800)</span>
00093 <span class="preprocessor"></span>
<a name="l00094"></a><a class="code" href="../../d5/d2/oplock_8c.html#a15">00094</a> <span class="preprocessor">#define OPLOCK_BREAK_MASK       (0x00000f00)</span>
00095 <span class="preprocessor"></span>
00096 <span class="comment">//</span>
00097 <span class="comment">//  The oplock types consist of the appropriate flags.</span>
00098 <span class="comment">//</span>
00099 
<a name="l00100"></a><a class="code" href="../../d5/d2/oplock_8c.html#a16">00100</a> <span class="preprocessor">#define NoOplocksHeld           (NO_OPLOCK)</span>
00101 <span class="preprocessor"></span>
<a name="l00102"></a><a class="code" href="../../d5/d2/oplock_8c.html#a17">00102</a> <span class="preprocessor">#define OplockIGranted          (LEVEL_I_OPLOCK | EXCLUSIVE)</span>
<a name="l00103"></a><a class="code" href="../../d5/d2/oplock_8c.html#a18">00103</a> <span class="preprocessor"></span><span class="preprocessor">#define OpBatchGranted          (BATCH_OPLOCK   | EXCLUSIVE)</span>
<a name="l00104"></a><a class="code" href="../../d5/d2/oplock_8c.html#a19">00104</a> <span class="preprocessor"></span><span class="preprocessor">#define OpFilterGranted         (FILTER_OPLOCK  | EXCLUSIVE)</span>
<a name="l00105"></a><a class="code" href="../../d5/d2/oplock_8c.html#a20">00105</a> <span class="preprocessor"></span><span class="preprocessor">#define OpFilterReqPending      (FILTER_OPLOCK  | EXCLUSIVE | PENDING )</span>
00106 <span class="preprocessor"></span>
<a name="l00107"></a><a class="code" href="../../d5/d2/oplock_8c.html#a21">00107</a> <span class="preprocessor">#define OplockBreakItoII        (LEVEL_I_OPLOCK | EXCLUSIVE | BREAK_TO_II)</span>
<a name="l00108"></a><a class="code" href="../../d5/d2/oplock_8c.html#a22">00108</a> <span class="preprocessor"></span><span class="preprocessor">#define OpBatchBreaktoII        (BATCH_OPLOCK   | EXCLUSIVE | BREAK_TO_II)</span>
<a name="l00109"></a><a class="code" href="../../d5/d2/oplock_8c.html#a23">00109</a> <span class="preprocessor"></span><span class="preprocessor">#define OpFilterBreaktoII       (FILTER_OPLOCK  | EXCLUSIVE | BREAK_TO_II)</span>
00110 <span class="preprocessor"></span>
<a name="l00111"></a><a class="code" href="../../d5/d2/oplock_8c.html#a24">00111</a> <span class="preprocessor">#define OplockBreakItoNone      (LEVEL_I_OPLOCK | EXCLUSIVE | BREAK_TO_NONE)</span>
<a name="l00112"></a><a class="code" href="../../d5/d2/oplock_8c.html#a25">00112</a> <span class="preprocessor"></span><span class="preprocessor">#define OpBatchBreaktoNone      (BATCH_OPLOCK   | EXCLUSIVE | BREAK_TO_NONE)</span>
<a name="l00113"></a><a class="code" href="../../d5/d2/oplock_8c.html#a26">00113</a> <span class="preprocessor"></span><span class="preprocessor">#define OpFilterBreaktoNone     (FILTER_OPLOCK  | EXCLUSIVE | BREAK_TO_NONE)</span>
00114 <span class="preprocessor"></span>
<a name="l00115"></a><a class="code" href="../../d5/d2/oplock_8c.html#a27">00115</a> <span class="preprocessor">#define OplockBreakItoIItoNone  (LEVEL_I_OPLOCK | EXCLUSIVE | BREAK_TO_II_NONE)</span>
<a name="l00116"></a><a class="code" href="../../d5/d2/oplock_8c.html#a28">00116</a> <span class="preprocessor"></span><span class="preprocessor">#define OpBatchBreaktoIItoNone  (BATCH_OPLOCK   | EXCLUSIVE | BREAK_TO_II_NONE)</span>
<a name="l00117"></a><a class="code" href="../../d5/d2/oplock_8c.html#a29">00117</a> <span class="preprocessor"></span><span class="preprocessor">#define OpFilterBreaktoIItoNone (FILTER_OPLOCK  | EXCLUSIVE | BREAK_TO_II_NONE)</span>
00118 <span class="preprocessor"></span>
<a name="l00119"></a><a class="code" href="../../d5/d2/oplock_8c.html#a30">00119</a> <span class="preprocessor">#define OpBatchClosePending     (BATCH_OPLOCK   | EXCLUSIVE | CLOSE_PENDING)</span>
<a name="l00120"></a><a class="code" href="../../d5/d2/oplock_8c.html#a31">00120</a> <span class="preprocessor"></span><span class="preprocessor">#define OpFilterClosePending    (FILTER_OPLOCK  | EXCLUSIVE | CLOSE_PENDING)</span>
00121 <span class="preprocessor"></span>
<a name="l00122"></a><a class="code" href="../../d5/d2/oplock_8c.html#a32">00122</a> <span class="preprocessor">#define OplockIIGranted         (LEVEL_II_OPLOCK)</span>
00123 <span class="preprocessor"></span>
00124 <span class="comment">//</span>
00125 <span class="comment">//  The oplock state is now just a ULONG.</span>
00126 <span class="comment">//</span>
00127 
<a name="l00128"></a><a class="code" href="../../d5/d2/oplock_8c.html#a34">00128</a> <span class="keyword">typedef</span> ULONG <a class="code" href="../../d5/d2/oplock_8c.html#a34">OPLOCK_STATE</a>;
00129 
00130 <span class="comment">//</span>
00131 <span class="comment">//  The non-opaque definition of an OPLOCK is a pointer to a privately</span>
00132 <span class="comment">//  defined structure.</span>
00133 <span class="comment">//</span>
00134 
<a name="l00135"></a><a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">00135</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">_NONOPAQUE_OPLOCK</a> {
00136 
00137     <span class="comment">//</span>
00138     <span class="comment">//  This is the Irp used to successfully request a level I oplock or</span>
00139     <span class="comment">//  batch oplock.  It is completed to initiate the Oplock I break</span>
00140     <span class="comment">//  procedure.</span>
00141     <span class="comment">//</span>
00142 
00143     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a>;
00144 
00145     <span class="comment">//</span>
00146     <span class="comment">//  This is a pointer to the original file object used when granting</span>
00147     <span class="comment">//  an Oplock I or batch oplock.</span>
00148     <span class="comment">//</span>
00149 
00150     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a>;
00151 
00152     <span class="comment">//</span>
00153     <span class="comment">//  The start of a linked list of Irps used to successfully request</span>
00154     <span class="comment">//  a level II oplock.</span>
00155     <span class="comment">//</span>
00156 
00157     LIST_ENTRY <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>;
00158 
00159     <span class="comment">//</span>
00160     <span class="comment">//  The following links the Irps waiting to be completed on a queue</span>
00161     <span class="comment">//  of Irps.</span>
00162     <span class="comment">//</span>
00163 
00164     LIST_ENTRY <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a>;
00165 
00166     <span class="comment">//</span>
00167     <span class="comment">//  Oplock state.  This indicates the current oplock state.</span>
00168     <span class="comment">//</span>
00169 
00170     <a class="code" href="../../d5/d2/oplock_8c.html#a34">OPLOCK_STATE</a> <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a>;
00171 
00172     <span class="comment">//</span>
00173     <span class="comment">//  This FastMutex is used to control access to this structure.</span>
00174     <span class="comment">//</span>
00175 
00176     <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a>;
00177 
00178 } <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">NONOPAQUE_OPLOCK</a>, *<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>;
00179 
00180 <span class="comment">//</span>
00181 <span class="comment">//  Each Waiting Irp record corresponds to an Irp that is waiting for an</span>
00182 <span class="comment">//  oplock break to be acknowledged and is maintained in a queue off of the</span>
00183 <span class="comment">//  Oplock's WaitingIrps list.</span>
00184 <span class="comment">//</span>
00185 
<a name="l00186"></a><a class="code" href="../../d0/d8/struct__WAITING__IRP.html">00186</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d8/struct__WAITING__IRP.html">_WAITING_IRP</a> {
00187 
00188     <span class="comment">//</span>
00189     <span class="comment">//  The link structures for the list of waiting irps.</span>
00190     <span class="comment">//</span>
00191 
00192     LIST_ENTRY <a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o0">Links</a>;
00193 
00194     <span class="comment">//</span>
00195     <span class="comment">//  This is the Irp attached to this structure.</span>
00196     <span class="comment">//</span>
00197 
00198     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o1">Irp</a>;
00199 
00200     <span class="comment">//</span>
00201     <span class="comment">//  This is the routine to call when we are done with an Irp we</span>
00202     <span class="comment">//  held on a waiting queue.  (We originally returned STATUS_PENDING).</span>
00203     <span class="comment">//</span>
00204 
00205     <a class="code" href="../../d1/d8/fsrtl_8h.html#a79">POPLOCK_WAIT_COMPLETE_ROUTINE</a> <a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o2">CompletionRoutine</a>;
00206 
00207     <span class="comment">//</span>
00208     <span class="comment">//  The context field to use when we are done with the Irp.</span>
00209     <span class="comment">//</span>
00210 
00211     PVOID <a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o3">Context</a>;
00212 
00213     <span class="comment">//</span>
00214     <span class="comment">//  This points to an event object used when we do not want to</span>
00215     <span class="comment">//  give up this thread.</span>
00216     <span class="comment">//</span>
00217 
00218     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o4">Event</a>;
00219 
00220     <span class="comment">//</span>
00221     <span class="comment">//  This field contains a copy of the Irp Iosb.Information field.</span>
00222     <span class="comment">//  We copy it here so that we can store the Oplock address in the</span>
00223     <span class="comment">//  Irp.</span>
00224     <span class="comment">//</span>
00225 
00226     ULONG <a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o5">Information</a>;
00227 
00228 } <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>, *<a class="code" href="../../d0/d8/struct__WAITING__IRP.html">PWAITING_IRP</a>;
00229 
00230 <span class="comment">//</span>
00231 <span class="comment">//  Define a tag for general pool allocations from this module</span>
00232 <span class="comment">//</span>
00233 
00234 <span class="preprocessor">#undef MODULE_POOL_TAG</span>
<a name="l00235"></a><a class="code" href="../../d5/d2/oplock_8c.html#a33">00235</a> <span class="preprocessor"></span><span class="preprocessor">#define MODULE_POOL_TAG                  ('orSF')</span>
00236 <span class="preprocessor"></span>
00237 
00238 <span class="comment">//</span>
00239 <span class="comment">//  Local support routines</span>
00240 <span class="comment">//</span>
00241 
00242 <a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>
00243 <a class="code" href="../../d5/d2/oplock_8c.html#a39">FsRtlAllocateOplock</a> (
00244     );
00245 
00246 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00247 <a class="code" href="../../d5/d2/oplock_8c.html#a40">FsRtlRequestExclusiveOplock</a> (
00248     IN OUT PNONOPAQUE_OPLOCK *Oplock,
00249     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00250     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp OPTIONAL,
00251     IN OPLOCK_STATE NextOplockState
00252     );
00253 
00254 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00255 <a class="code" href="../../d5/d2/oplock_8c.html#a41">FsRtlRequestOplockII</a> (
00256     IN OUT PNONOPAQUE_OPLOCK *Oplock,
00257     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00258     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00259     );
00260 
00261 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00262 <a class="code" href="../../d5/d2/oplock_8c.html#a42">FsRtlAcknowledgeOplockBreak</a> (
00263     IN OUT PNONOPAQUE_OPLOCK Oplock,
00264     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00265     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00266     IN BOOLEAN GrantLevelII
00267     );
00268 
00269 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00270 <a class="code" href="../../d5/d2/oplock_8c.html#a43">FsRtlOpBatchBreakClosePending</a> (
00271     IN OUT PNONOPAQUE_OPLOCK Oplock,
00272     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00273     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00274     );
00275 
00276 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00277 <a class="code" href="../../d5/d2/oplock_8c.html#a44">FsRtlOplockBreakNotify</a> (
00278     IN OUT PNONOPAQUE_OPLOCK Oplock,
00279     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00280     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00281     );
00282 
00283 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00284 <a class="code" href="../../d5/d2/oplock_8c.html#a45">FsRtlOplockCleanup</a> (
00285     IN OUT PNONOPAQUE_OPLOCK Oplock,
00286     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp
00287     );
00288 
00289 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00290 <a class="code" href="../../d5/d2/oplock_8c.html#a46">FsRtlOplockBreakToII</a> (
00291     IN OUT PNONOPAQUE_OPLOCK Oplock,
00292     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00293     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00294     IN PVOID Context,
00295     IN POPLOCK_WAIT_COMPLETE_ROUTINE CompletionRoutine OPTIONAL,
00296     IN POPLOCK_FS_PREPOST_IRP PostIrpRoutine OPTIONAL
00297     );
00298 
00299 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00300 <a class="code" href="../../d5/d2/oplock_8c.html#a47">FsRtlOplockBreakToNone</a> (
00301     IN OUT PNONOPAQUE_OPLOCK Oplock,
00302     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00303     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00304     IN PVOID Context,
00305     IN POPLOCK_WAIT_COMPLETE_ROUTINE CompletionRoutine OPTIONAL,
00306     IN POPLOCK_FS_PREPOST_IRP PostIrpRoutine OPTIONAL
00307     );
00308 
00309 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00310 <a class="code" href="../../d5/d2/oplock_8c.html#a48">FsRtlRemoveAndCompleteIrp</a> (
00311     IN PLIST_ENTRY Link
00312     );
00313 
00314 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00315 <a class="code" href="../../d5/d2/oplock_8c.html#a49">FsRtlWaitOnIrp</a> (
00316     IN OUT PNONOPAQUE_OPLOCK Oplock,
00317     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00318     IN PVOID Context,
00319     IN POPLOCK_WAIT_COMPLETE_ROUTINE CompletionRoutine OPTIONAL,
00320     IN POPLOCK_FS_PREPOST_IRP PostIrpRoutine OPTIONAL,
00321     IN <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event
00322     );
00323 
00324 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00325 <a class="code" href="../../d5/d2/oplock_8c.html#a50">FsRtlCompletionRoutinePriv</a> (
00326     IN PVOID Context,
00327     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00328     );
00329 
00330 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00331 <a class="code" href="../../d5/d2/oplock_8c.html#a51">FsRtlCancelWaitIrp</a> (
00332     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00333     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00334     );
00335 
00336 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00337 <a class="code" href="../../d5/d2/oplock_8c.html#a52">FsRtlCancelOplockIIIrp</a> (
00338     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00339     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00340     );
00341 
00342 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00343 <a class="code" href="../../d5/d2/oplock_8c.html#a53">FsRtlCancelExclusiveIrp</a> (
00344     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00345     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00346     );
00347 
00348 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00349 <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a> (
00350     IN PWAITING_IRP WaitingIrp
00351     );
00352 
00353 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00354 <a class="code" href="../../d5/d2/oplock_8c.html#a55">FsRtlNotifyCompletion</a> (
00355     IN PVOID Context,
00356     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00357     );
00358 
00359 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00360 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlAllocateOplock)</span>
00361 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlCompletionRoutinePriv)</span>
00362 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlCurrentBatchOplock)</span>
00363 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlInitializeOplock)</span>
00364 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlNotifyCompletion)</span>
00365 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlOpBatchBreakClosePending)</span>
00366 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlOplockBreakNotify)</span>
00367 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlOplockFsctrl)</span>
00368 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlOplockIsFastIoPossible)</span>
00369 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00370 <span class="preprocessor"></span>
00371 
00372 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00373"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a162">00373</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a162">FsRtlInitializeOplock</a> (
00374     IN OUT POPLOCK Oplock
00375     )
00376 
00377 <span class="comment">/*++</span>
00378 <span class="comment"></span>
00379 <span class="comment">Routine Description:</span>
00380 <span class="comment"></span>
00381 <span class="comment">    This routine initializes a new OPLOCK structure.  This call must</span>
00382 <span class="comment">    precede any other call to this entry point with this OPLOCK</span>
00383 <span class="comment">    structure.  In addition, this routine will have exclusive access</span>
00384 <span class="comment">    to the Oplock structure.</span>
00385 <span class="comment"></span>
00386 <span class="comment">Arguments:</span>
00387 <span class="comment"></span>
00388 <span class="comment">    Oplock - Supplies the address of an opaque OPLOCK structure.</span>
00389 <span class="comment"></span>
00390 <span class="comment">Return Value:</span>
00391 <span class="comment"></span>
00392 <span class="comment">    None.</span>
00393 <span class="comment"></span>
00394 <span class="comment">--*/</span>
00395 
00396 {
00397     UNREFERENCED_PARAMETER( Oplock );
00398 
00399     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00400 
00401     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlInitializeOplock:  Oplock -&gt; %08lx\n"</span>, *Oplock );
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">//  No action is taken at this time.</span>
00405     <span class="comment">//</span>
00406 
00407     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlInitializeOplock:  Exit\n"</span>, 0);
00408     <span class="keywordflow">return</span>;
00409 }
00410 
00411 
00412 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00413"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a163">00413</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a163">FsRtlUninitializeOplock</a> (
00414     IN OUT POPLOCK Oplock
00415     )
00416 
00417 <span class="comment">/*++</span>
00418 <span class="comment"></span>
00419 <span class="comment">Routine Description:</span>
00420 <span class="comment"></span>
00421 <span class="comment">    This routine uninitializes an OPLOCK structure.  After calling this</span>
00422 <span class="comment">    routine, the OPLOCK structure must be reinitialized before being</span>
00423 <span class="comment">    used again.</span>
00424 <span class="comment"></span>
00425 <span class="comment">Arguments:</span>
00426 <span class="comment"></span>
00427 <span class="comment">    Oplock - Supplies the address of an opaque OPLOCK structure.</span>
00428 <span class="comment"></span>
00429 <span class="comment">Return Value:</span>
00430 <span class="comment"></span>
00431 <span class="comment">    None.</span>
00432 <span class="comment"></span>
00433 <span class="comment">--*/</span>
00434 
00435 
00436 {
00437     <a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a> ThisOplock;
00438 
00439     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlUninitializeOplock:  Oplock -&gt; %08lx\n"</span>, *Oplock );
00440 
00441     <span class="comment">//</span>
00442     <span class="comment">//  If the Oplock structure has not been allocated, there is no action</span>
00443     <span class="comment">//  to take.</span>
00444     <span class="comment">//</span>
00445 
00446     <span class="keywordflow">if</span> (*Oplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00447 
00448         <span class="comment">//</span>
00449         <span class="comment">//  Remove this from the user's structure.</span>
00450         <span class="comment">//</span>
00451 
00452         ThisOplock = (<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>) *Oplock;
00453 
00454         *Oplock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00455 
00456         <span class="comment">//</span>
00457         <span class="comment">//  Grab the waiting lock queue mutex to exclude anyone from messing</span>
00458         <span class="comment">//  with the queue while we're using it</span>
00459         <span class="comment">//</span>
00460 
00461         <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
00462 
00463         <span class="keywordflow">try</span> {
00464 
00465             <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00466 
00467             <span class="comment">//</span>
00468             <span class="comment">//  Release any waiting Irps held.</span>
00469             <span class="comment">//</span>
00470 
00471             <span class="keywordflow">while</span> (!IsListEmpty( &amp;ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a> )) {
00472 
00473                 <a class="code" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a> WaitingIrp;
00474                 <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> ThisIrp;
00475 
00476                 WaitingIrp = CONTAINING_RECORD( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a>.Flink,
00477                                                 <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>,
00478                                                 Links );
00479 
00480                 RemoveHeadList( &amp;ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a> );
00481 
00482                 ThisIrp = WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o1">Irp</a>;
00483 
00484                 <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;ThisIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00485 
00486                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( ThisIrp, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00487                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( ThisIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00488 
00489                 ThisIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
00490 
00491                 <span class="comment">//</span>
00492                 <span class="comment">//  Call the completion routine in the Waiting Irp.</span>
00493                 <span class="comment">//</span>
00494 
00495                 WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o2">CompletionRoutine</a>( WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o3">Context</a>,
00496                                                WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o1">Irp</a> );
00497 
00498                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( WaitingIrp );
00499             }
00500 
00501             <span class="comment">//</span>
00502             <span class="comment">//  Release any oplock II irps held.</span>
00503             <span class="comment">//</span>
00504 
00505             <span class="keywordflow">while</span> (!IsListEmpty( &amp;ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a> )) {
00506 
00507                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = CONTAINING_RECORD( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>.Flink,
00508                                          <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>,
00509                                          Tail.Overlay.ListEntry );
00510 
00511                 RemoveHeadList( &amp;ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a> );
00512 
00513                 <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00514 
00515                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00516                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00517 
00518                 <span class="comment">//</span>
00519                 <span class="comment">//  Complete the oplock II Irp.</span>
00520                 <span class="comment">//</span>
00521 
00522                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> )-&gt;FileObject );
00523 
00524                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
00525                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_SUCCESS );
00526             }
00527 
00528             <span class="comment">//</span>
00529             <span class="comment">//  Release any exclusive oplock held.</span>
00530             <span class="comment">//</span>
00531 
00532             <span class="keywordflow">if</span> (ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00533 
00534                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a>;
00535 
00536                 <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00537 
00538                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00539                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00540 
00541                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
00542                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_SUCCESS );
00543 
00544                 ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00545 
00546                 <span class="keywordflow">if</span> (ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00547 
00548                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a> );
00549                 }
00550             }
00551 
00552         } finally {
00553 
00554             <span class="comment">//</span>
00555             <span class="comment">//  No matter how we complete the preceding statements we will</span>
00556             <span class="comment">//  now release the waiting lock queue mutex</span>
00557             <span class="comment">//</span>
00558 
00559             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
00560         }
00561 
00562         <span class="comment">//</span>
00563         <span class="comment">//  Deallocate the mutex.</span>
00564         <span class="comment">//</span>
00565 
00566         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
00567 
00568         <span class="comment">//</span>
00569         <span class="comment">//  Deallocate the Oplock structure.</span>
00570         <span class="comment">//</span>
00571 
00572         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ThisOplock );
00573     }
00574 
00575     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlUninitializeOplock:  Exit\n"</span>, 0 );
00576     <span class="keywordflow">return</span>;
00577 }
00578 
00579 
00580 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00581"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a164">00581</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a164">FsRtlOplockFsctrl</a> (
00582     IN POPLOCK Oplock,
00583     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00584     IN ULONG OpenCount
00585     )
00586 
00587 <span class="comment">/*++</span>
00588 <span class="comment"></span>
00589 <span class="comment">Routine Description:</span>
00590 <span class="comment"></span>
00591 <span class="comment">    This is the interface with the filesystems for Fsctl calls, it handles</span>
00592 <span class="comment">    oplock requests, break acknowledgement and break notify.</span>
00593 <span class="comment"></span>
00594 <span class="comment">Arguments:</span>
00595 <span class="comment"></span>
00596 <span class="comment">    Oplock - Supplies the address of the opaque OPLOCK structure.</span>
00597 <span class="comment"></span>
00598 <span class="comment">    Irp - Supplies a pointer to the Irp which declares the requested</span>
00599 <span class="comment">          operation.</span>
00600 <span class="comment"></span>
00601 <span class="comment">    OpenCount - This is the number of user handles on the file if we are requsting</span>
00602 <span class="comment">        an exclusive oplock.  A non-zero value for a level II request indicates</span>
00603 <span class="comment">        that there are locks on the file.</span>
00604 <span class="comment"></span>
00605 <span class="comment">Return Value:</span>
00606 <span class="comment"></span>
00607 <span class="comment">    NTSTATUS - Returns the result of this operation.  If this is an Oplock</span>
00608 <span class="comment">               request which is granted, then STATUS_PENDING is returned.</span>
00609 <span class="comment">               If the Oplock isn't granted then STATUS_OPLOCK_NOT_GRANTED</span>
00610 <span class="comment">               is returned.  If this is an Oplock I break to no oplock,</span>
00611 <span class="comment">               then STATUS_SUCCESS.  If this is an Oplock I break to</span>
00612 <span class="comment">               Oplock II then STATUS_PENDING is returned.  Other</span>
00613 <span class="comment">               error codes returned depend on the nature of the error.</span>
00614 <span class="comment"></span>
00615 <span class="comment">               STATUS_CANCELLED is returned if the Irp is cancelled during</span>
00616 <span class="comment">               this operation.</span>
00617 <span class="comment"></span>
00618 <span class="comment">               STATUS_SUCCESS is returned if this is a create asking for</span>
00619 <span class="comment">               a filter oplock.</span>
00620 <span class="comment"></span>
00621 <span class="comment">--*/</span>
00622 
00623 {
00624     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00625     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00626     <a class="code" href="../../d5/d2/oplock_8c.html#a34">OPLOCK_STATE</a> OplockState;
00627 
00628     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00629 
00630     <span class="comment">//</span>
00631     <span class="comment">//  Get the current IRP stack location</span>
00632     <span class="comment">//</span>
00633 
00634     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00635 
00636     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlOplockFsctrl:  Entered\n"</span>, 0);
00637     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlOplockFsctrl:  Oplock      -&gt; %08lx\n"</span>, *Oplock );
00638     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlOplockFsctrl:  Irp         -&gt; %08lx\n"</span>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00639 
00640     <span class="comment">//</span>
00641     <span class="comment">//  Check if this is the create case where the user is requesting a pending</span>
00642     <span class="comment">//  filter oplock.</span>
00643     <span class="comment">//</span>
00644 
00645     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>) {
00646 
00647         <span class="comment">//</span>
00648         <span class="comment">//  Check that all the conditions hold to grant this oplock.</span>
00649         <span class="comment">//  The conditions that must hold are:</span>
00650         <span class="comment">//</span>
00651         <span class="comment">//      - This is the only opener of the file.</span>
00652         <span class="comment">//      - Desired Access must be exactly FILE_READ_ATTRIBUTES.</span>
00653         <span class="comment">//          This will insure an asynch open since the SYNCHRONIZE</span>
00654         <span class="comment">//          flag can't be set.</span>
00655         <span class="comment">//      - Share access is precisely</span>
00656         <span class="comment">//          (FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE)</span>
00657         <span class="comment">//</span>
00658 
00659         <span class="keywordflow">if</span> ((OpenCount != 1) ||
00660             (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.SecurityContext-&gt;DesiredAccess,
00661                      ~(FILE_READ_ATTRIBUTES))) ||
00662             ((IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.ShareAccess &amp;
00663               (FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE)) !=
00664              (FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE))) {
00665 
00666             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OPLOCK_NOT_GRANTED;
00667 
00668         } <span class="keywordflow">else</span> {
00669 
00670             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a40">FsRtlRequestExclusiveOplock</a>( (<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a> *) Oplock,
00671                                                   IrpSp,
00672                                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00673                                                   <a class="code" href="../../d5/d2/oplock_8c.html#a20">OpFilterReqPending</a> );
00674         }
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">//  Case on the FsControlFile code control code.</span>
00678     <span class="comment">//</span>
00679 
00680     } <span class="keywordflow">else</span> {
00681 
00682         <span class="comment">//</span>
00683         <span class="comment">//  Assume this is an OplockLevel I.</span>
00684         <span class="comment">//</span>
00685         <span class="comment">//  NOTE - This code depends on the defined bits for these oplock types.</span>
00686         <span class="comment">//      FILTER_OPLOCK = 4 * LEVEL_I_OPLOCK</span>
00687         <span class="comment">//      BATCH_OPLOCK = 2 * LEVEL_I_OPLOCK</span>
00688         <span class="comment">//</span>
00689 
00690         OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a3">LEVEL_I_OPLOCK</a>;
00691 
00692         <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.FileSystemControl.FsControlCode) {
00693 
00694         <span class="keywordflow">case</span> FSCTL_REQUEST_FILTER_OPLOCK :
00695 
00696             OplockState *= 2;
00697 
00698         <span class="keywordflow">case</span> FSCTL_REQUEST_BATCH_OPLOCK :
00699 
00700             OplockState *= 2;
00701 
00702         <span class="keywordflow">case</span> FSCTL_REQUEST_OPLOCK_LEVEL_1 :
00703 
00704             <span class="comment">//</span>
00705             <span class="comment">//  Set the other flags for an exclusive oplock.</span>
00706             <span class="comment">//</span>
00707 
00708             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a8">EXCLUSIVE</a> );
00709 
00710             <span class="comment">//</span>
00711             <span class="comment">//  We short circuit the request if this request is treated</span>
00712             <span class="comment">//  synchronously or the open count is not 1.  Otherwise the Io system</span>
00713             <span class="comment">//  will hold the return code until the Irp is completed.</span>
00714             <span class="comment">//</span>
00715             <span class="comment">//  Also fail this if the flag is set which indicates that</span>
00716             <span class="comment">//  the IO system should copy data back to a user's buffer.</span>
00717             <span class="comment">//</span>
00718             <span class="comment">//  If cleanup has occurrred on this file, then we refuse</span>
00719             <span class="comment">//  the oplock request.</span>
00720             <span class="comment">//</span>
00721 
00722             <span class="keywordflow">if</span> ((OpenCount != 1) ||
00723                 <a class="code" href="../../d4/d6/iosubs_8c.html#a83">IoIsOperationSynchronous</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> ) ||
00724                 <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a> ) ||
00725                 <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a164">FO_CLEANUP_COMPLETE</a> )) {
00726 
00727                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_OPLOCK_NOT_GRANTED );
00728                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OPLOCK_NOT_GRANTED;
00729 
00730             } <span class="keywordflow">else</span> {
00731 
00732                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a40">FsRtlRequestExclusiveOplock</a>( (<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a> *) Oplock,
00733                                                       IrpSp,
00734                                                       <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
00735                                                       OplockState );
00736             }
00737 
00738             <span class="keywordflow">break</span>;
00739 
00740         <span class="keywordflow">case</span> FSCTL_REQUEST_OPLOCK_LEVEL_2 :
00741 
00742             <span class="comment">//</span>
00743             <span class="comment">//  We short circuit the request if this request is treated</span>
00744             <span class="comment">//  synchronously.  Otherwise the Io system will hold the return</span>
00745             <span class="comment">//  code until the Irp is completed.</span>
00746             <span class="comment">//</span>
00747             <span class="comment">//  If cleanup has occurrred on this file, then we refuse</span>
00748             <span class="comment">//  the oplock request.</span>
00749             <span class="comment">//</span>
00750             <span class="comment">//  Also fail this if the flag is set which indicates that</span>
00751             <span class="comment">//  the IO system should copy data back to a user's buffer.</span>
00752             <span class="comment">//</span>
00753             <span class="comment">//  A non-zero open count in this case indicates that there are</span>
00754             <span class="comment">//  file locks on the file.  We will also fail the request in</span>
00755             <span class="comment">//  this case.</span>
00756             <span class="comment">//</span>
00757 
00758             <span class="keywordflow">if</span> ((OpenCount != 0) ||
00759                 <a class="code" href="../../d4/d6/iosubs_8c.html#a83">IoIsOperationSynchronous</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> ) ||
00760                 <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a> ) ||
00761                 <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a164">FO_CLEANUP_COMPLETE</a> )) {
00762 
00763                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_OPLOCK_NOT_GRANTED );
00764                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OPLOCK_NOT_GRANTED;
00765 
00766             } <span class="keywordflow">else</span> {
00767 
00768                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a41">FsRtlRequestOplockII</a>( (<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a> *) Oplock,
00769                                                IrpSp,
00770                                                <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00771             }
00772 
00773             <span class="keywordflow">break</span>;
00774 
00775         <span class="keywordflow">case</span> FSCTL_OPLOCK_BREAK_ACKNOWLEDGE :
00776 
00777             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a42">FsRtlAcknowledgeOplockBreak</a>( (<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>) *Oplock,
00778                                                   IrpSp,
00779                                                   <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
00780                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00781             <span class="keywordflow">break</span>;
00782 
00783         <span class="keywordflow">case</span> FSCTL_OPLOCK_BREAK_ACK_NO_2 :
00784 
00785             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a42">FsRtlAcknowledgeOplockBreak</a>( (<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>) *Oplock,
00786                                                   IrpSp,
00787                                                   <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
00788                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00789             <span class="keywordflow">break</span>;
00790 
00791         <span class="keywordflow">case</span> FSCTL_OPBATCH_ACK_CLOSE_PENDING :
00792 
00793             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a43">FsRtlOpBatchBreakClosePending</a>( (<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>) *Oplock,
00794                                                     IrpSp,
00795                                                     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00796             <span class="keywordflow">break</span>;
00797 
00798         <span class="keywordflow">case</span> FSCTL_OPLOCK_BREAK_NOTIFY :
00799 
00800             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a44">FsRtlOplockBreakNotify</a>( (<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>) *Oplock,
00801                                              IrpSp,
00802                                              <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00803             <span class="keywordflow">break</span>;
00804 
00805         <span class="keywordflow">default</span> :
00806 
00807             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0,
00808                         <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00809                         <span class="stringliteral">"Invalid Control Code\n"</span>,
00810                         0);
00811 
00812             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_INVALID_PARAMETER );
00813             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00814         }
00815     }
00816 
00817     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlOplockFsctrl:  Exit -&gt; %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00818     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00819 }
00820 
00821 
00822 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00823"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a165">00823</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a165">FsRtlCheckOplock</a> (
00824     IN POPLOCK Oplock,
00825     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00826     IN PVOID Context,
00827     IN POPLOCK_WAIT_COMPLETE_ROUTINE CompletionRoutine OPTIONAL,
00828     IN POPLOCK_FS_PREPOST_IRP PostIrpRoutine OPTIONAL
00829     )
00830 
00831 <span class="comment">/*++</span>
00832 <span class="comment"></span>
00833 <span class="comment">Routine Description:</span>
00834 <span class="comment"></span>
00835 <span class="comment">    This routine is called as a support routine from a file system.</span>
00836 <span class="comment">    It is used to synchronize I/O requests with the current Oplock</span>
00837 <span class="comment">    state of a file.  If the I/O operation will cause the Oplock to</span>
00838 <span class="comment">    break, that action is initiated.  If the operation cannot continue</span>
00839 <span class="comment">    until the Oplock break is complete, STATUS_PENDING is returned and</span>
00840 <span class="comment">    the caller supplied routine is called.</span>
00841 <span class="comment"></span>
00842 <span class="comment">Arguments:</span>
00843 <span class="comment"></span>
00844 <span class="comment">    Oplock - Supplies a pointer to the non-opaque oplock structure for</span>
00845 <span class="comment">             this file.</span>
00846 <span class="comment"></span>
00847 <span class="comment">    Irp - Supplies a pointer to the Irp which declares the requested</span>
00848 <span class="comment">          operation.</span>
00849 <span class="comment"></span>
00850 <span class="comment">    Context - This value is passed as a parameter to the completion routine.</span>
00851 <span class="comment"></span>
00852 <span class="comment">    CompletionRoutine - This is the routine which is called if this</span>
00853 <span class="comment">                        Irp must wait for an Oplock to break.  This</span>
00854 <span class="comment">                        is a synchronous operation if not specified</span>
00855 <span class="comment">                        and we block in this thread waiting on</span>
00856 <span class="comment">                        an event.</span>
00857 <span class="comment"></span>
00858 <span class="comment">    PostIrpRoutine - This is the routine to call before we put anything</span>
00859 <span class="comment">                     on our waiting Irp queue.</span>
00860 <span class="comment"></span>
00861 <span class="comment">Return Value:</span>
00862 <span class="comment"></span>
00863 <span class="comment">    STATUS_SUCCESS if we can complete the operation on exiting this thread.</span>
00864 <span class="comment">    STATUS_PENDING if we return here but hold the Irp.</span>
00865 <span class="comment">    STATUS_CANCELLED if the Irp is cancelled before we return.</span>
00866 <span class="comment"></span>
00867 <span class="comment">--*/</span>
00868 
00869 {
00870     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00871     <a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a> ThisOplock = *Oplock;
00872 
00873     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00874 
00875     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCheckOplock:  Entered\n"</span>, 0 );
00876     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
00877     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Irp       -&gt; %08lx\n"</span>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00878 
00879     <span class="comment">//</span>
00880     <span class="comment">//  If there is no oplock structure or this is system I/O, we allow</span>
00881     <span class="comment">//  the operation to continue.  Otherwise we check the major function code.</span>
00882     <span class="comment">//</span>
00883 
00884     <span class="keywordflow">if</span> ((ThisOplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00885         !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a174">IRP_PAGING_IO</a> )) {
00886 
00887         <a class="code" href="../../d5/d2/oplock_8c.html#a34">OPLOCK_STATE</a> OplockState;
00888         <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> OplockFileObject;
00889 
00890         BOOLEAN BreakToII;
00891         BOOLEAN BreakToNone;
00892 
00893         ULONG CreateDisposition;
00894 
00895         <span class="comment">//</span>
00896         <span class="comment">//  Capture the file object first and then the oplock state to perform</span>
00897         <span class="comment">//  the unsafe checks below.  We capture the file object first in case</span>
00898         <span class="comment">//  there is an exclusive oplock break in progress.  Otherwise the oplock</span>
00899         <span class="comment">//  state may indicate break in progress but it could complete by</span>
00900         <span class="comment">//  the time we snap the file object.</span>
00901         <span class="comment">//</span>
00902 
00903         OplockFileObject = ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a>;
00904         OplockState = ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a>;
00905 
00906         <span class="comment">//</span>
00907         <span class="comment">//  Examine the Irp for the appropriate action provided there are</span>
00908         <span class="comment">//  current oplocks on the file.</span>
00909         <span class="comment">//</span>
00910 
00911         <span class="keywordflow">if</span> (OplockState != <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>) {
00912 
00913             BreakToII = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00914             BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00915 
00916             IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00917 
00918             <span class="comment">//</span>
00919             <span class="comment">//  Determine whether we are going to BreakToII or BreakToNone.</span>
00920             <span class="comment">//</span>
00921 
00922             <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a>) {
00923 
00924             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a> :
00925 
00926                 <span class="comment">//</span>
00927                 <span class="comment">//  If we are opening for attribute access only, we</span>
00928                 <span class="comment">//  return status success.  Always break the oplock if this caller</span>
00929                 <span class="comment">//  wants a filter oplock.</span>
00930                 <span class="comment">//</span>
00931 
00932                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.SecurityContext-&gt;DesiredAccess,
00933                              ~(FILE_READ_ATTRIBUTES | FILE_WRITE_ATTRIBUTES | SYNCHRONIZE) ) &amp;&amp;
00934                     !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_RESERVE_OPFILTER )) {
00935 
00936                     <span class="keywordflow">break</span>;
00937                 }
00938 
00939                 <span class="comment">//</span>
00940                 <span class="comment">//  If there is a filter oplock granted and this create iS reading</span>
00941                 <span class="comment">//  the file then don't break the oplock as long as we share</span>
00942                 <span class="comment">//  for reads.</span>
00943                 <span class="comment">//</span>
00944 
00945                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a5">FILTER_OPLOCK</a> ) &amp;&amp;
00946                     !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.SecurityContext-&gt;DesiredAccess,
00947                              ~<a class="code" href="../../d5/d2/oplock_8c.html#a1">FILTER_OPLOCK_VALID_FLAGS</a> ) &amp;&amp;
00948                     <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.ShareAccess, FILE_SHARE_READ )) {
00949 
00950                     <span class="keywordflow">break</span>;
00951                 }
00952 
00953                 <span class="comment">//</span>
00954                 <span class="comment">//  We we are superseding or overwriting, then break to none.</span>
00955                 <span class="comment">//</span>
00956 
00957                 CreateDisposition = (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options &gt;&gt; 24) &amp; 0x000000ff;
00958 
00959                 <span class="keywordflow">if</span> ((CreateDisposition == FILE_SUPERSEDE) ||
00960                     (CreateDisposition == FILE_OVERWRITE) ||
00961                     (CreateDisposition == FILE_OVERWRITE_IF) ||
00962                     <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_RESERVE_OPFILTER )) {
00963 
00964                     BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00965 
00966                 } <span class="keywordflow">else</span> {
00967 
00968                     BreakToII = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00969                 }
00970 
00971                 <span class="keywordflow">break</span>;
00972 
00973             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a> :
00974 
00975                 <span class="comment">//</span>
00976                 <span class="comment">//  If a filter oplock has been granted then do nothing.</span>
00977                 <span class="comment">//  We will assume the oplock will have been broken</span>
00978                 <span class="comment">//  if this create needed to do that.</span>
00979                 <span class="comment">//</span>
00980 
00981                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a5">FILTER_OPLOCK</a> )) {
00982 
00983                     BreakToII = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00984                 }
00985 
00986                 <span class="keywordflow">break</span>;
00987 
00988             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a22">IRP_MJ_FLUSH_BUFFERS</a> :
00989 
00990                 BreakToII = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00991                 <span class="keywordflow">break</span>;
00992 
00993             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a31">IRP_MJ_CLEANUP</a> :
00994 
00995                 <a class="code" href="../../d5/d2/oplock_8c.html#a45">FsRtlOplockCleanup</a>( (<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>) *Oplock,
00996                                     IrpSp );
00997 
00998                 <span class="keywordflow">break</span>;
00999 
01000             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a30">IRP_MJ_LOCK_CONTROL</a> :
01001 
01002                 <span class="comment">//</span>
01003                 <span class="comment">//  If a filter oplock has been granted then do nothing.</span>
01004                 <span class="comment">//  We will assume the oplock will have been broken</span>
01005                 <span class="comment">//  if this create needed to do that.</span>
01006                 <span class="comment">//</span>
01007 
01008                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a5">FILTER_OPLOCK</a> )) {
01009 
01010                     <span class="keywordflow">break</span>;
01011                 }
01012 
01013             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a17">IRP_MJ_WRITE</a> :
01014 
01015                 BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01016                 <span class="keywordflow">break</span>;
01017 
01018             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a19">IRP_MJ_SET_INFORMATION</a> :
01019 
01020                 <span class="comment">//</span>
01021                 <span class="comment">//  We are only interested in calls that shrink the file size</span>
01022                 <span class="comment">//  or breaking batch oplocks for the rename case.</span>
01023                 <span class="comment">//</span>
01024 
01025                 <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.FileInformationClass) {
01026 
01027                 <span class="keywordflow">case</span> FileEndOfFileInformation :
01028 
01029                     <span class="comment">//</span>
01030                     <span class="comment">//  Break immediately if this is the lazy writer callback.</span>
01031                     <span class="comment">//</span>
01032 
01033                     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.AdvanceOnly) {
01034 
01035                         <span class="keywordflow">break</span>;
01036                     }
01037 
01038                 <span class="keywordflow">case</span> FileAllocationInformation :
01039 
01040                     BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01041                     <span class="keywordflow">break</span>;
01042 
01043                 <span class="keywordflow">case</span> FileRenameInformation :
01044                 <span class="keywordflow">case</span> FileLinkInformation :
01045 
01046                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a4">BATCH_OPLOCK</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a5">FILTER_OPLOCK</a> )) {
01047 
01048                         BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01049                     }
01050 
01051                     <span class="keywordflow">break</span>;
01052                 }
01053 
01054             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a> :
01055 
01056                 <span class="comment">//</span>
01057                 <span class="comment">//  We need to break to none if this is a zeroing operation.</span>
01058                 <span class="comment">//</span>
01059 
01060                 <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.FileSystemControl.FsControlCode == FSCTL_SET_ZERO_DATA) {
01061 
01062                     BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01063                 }
01064             }
01065 
01066             <span class="keywordflow">if</span> (BreakToII) {
01067 
01068                 <span class="comment">//</span>
01069                 <span class="comment">//  If there are no outstanding oplocks or level II oplocks are held,</span>
01070                 <span class="comment">//  we can return immediately.  If the first two tests fail then there</span>
01071                 <span class="comment">//  is an exclusive oplock.  If the file objects match we allow the</span>
01072                 <span class="comment">//  operation to continue.</span>
01073                 <span class="comment">//</span>
01074 
01075                 <span class="keywordflow">if</span> ((OplockState != <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>) &amp;&amp;
01076                     (OplockFileObject != IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>)) {
01077 
01078                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a46">FsRtlOplockBreakToII</a>( (<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>) *Oplock,
01079                                                     IrpSp,
01080                                                     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
01081                                                     Context,
01082                                                     CompletionRoutine,
01083                                                     PostIrpRoutine );
01084                 }
01085 
01086             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (BreakToNone) {
01087 
01088                 <span class="comment">//</span>
01089                 <span class="comment">//  If there are no oplocks, we can return immediately.</span>
01090                 <span class="comment">//  Otherwise if there is no level 2 oplock and this file</span>
01091                 <span class="comment">//  object matches the owning file object then this write is</span>
01092                 <span class="comment">//  on behalf of the owner of the oplock.</span>
01093                 <span class="comment">//</span>
01094 
01095                 <span class="keywordflow">if</span> ((OplockState == <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>) ||
01096                     (OplockFileObject != IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>)) {
01097 
01098                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a47">FsRtlOplockBreakToNone</a>( (<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>) *Oplock,
01099                                                       IrpSp,
01100                                                       <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
01101                                                       Context,
01102                                                       CompletionRoutine,
01103                                                       PostIrpRoutine );
01104                 }
01105             }
01106         }
01107     }
01108 
01109     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCheckOplock:  Exit -&gt; %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01110 
01111     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01112 }
01113 
01114 
01115 BOOLEAN
<a name="l01116"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a166">01116</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a166">FsRtlOplockIsFastIoPossible</a> (
01117     IN POPLOCK Oplock
01118     )
01119 
01120 <span class="comment">/*++</span>
01121 <span class="comment"></span>
01122 <span class="comment">Routine Description:</span>
01123 <span class="comment"></span>
01124 <span class="comment">    This routine indicates to the caller where there are any outstanding</span>
01125 <span class="comment">    oplocks which prevent fast Io from happening.</span>
01126 <span class="comment"></span>
01127 <span class="comment">Arguments:</span>
01128 <span class="comment"></span>
01129 <span class="comment">    OpLock - Supplies the oplock being queried</span>
01130 <span class="comment"></span>
01131 <span class="comment">Return Value:</span>
01132 <span class="comment"></span>
01133 <span class="comment">    BOOLEAN - TRUE if there are outstanding oplocks and FALSE otherwise</span>
01134 <span class="comment"></span>
01135 <span class="comment">--*/</span>
01136 
01137 {
01138     BOOLEAN FastIoPossible = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01139 
01140     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01141 
01142     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlOplockIsFastIoPossible: Oplock -&gt; %08lx\n"</span>, *Oplock);
01143 
01144     <span class="comment">//</span>
01145     <span class="comment">//  There are not any current oplocks if the variable is null or</span>
01146     <span class="comment">//  the state is no oplocks held.  If an exclusive oplock was granted</span>
01147     <span class="comment">//  but no break is in progress then allow the Fast IO.</span>
01148     <span class="comment">//</span>
01149 
01150     <span class="keywordflow">if</span> (*Oplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01151 
01152         <a class="code" href="../../d5/d2/oplock_8c.html#a34">OPLOCK_STATE</a> OplockState;
01153 
01154         OplockState = ((<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>) *Oplock)-&gt;OplockState;
01155 
01156         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a6">LEVEL_II_OPLOCK</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a15">OPLOCK_BREAK_MASK</a> )) {
01157 
01158             FastIoPossible = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01159         }
01160     }
01161 
01162     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlOplockIsFastIoPossible: Exit -&gt; %08lx\n"</span>, FastIoPossible);
01163 
01164     <span class="keywordflow">return</span> FastIoPossible;
01165 }
01166 
01167 
01168 BOOLEAN
<a name="l01169"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a167">01169</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a167">FsRtlCurrentBatchOplock</a> (
01170     IN POPLOCK Oplock
01171     )
01172 
01173 <span class="comment">/*++</span>
01174 <span class="comment"></span>
01175 <span class="comment">Routine Description:</span>
01176 <span class="comment"></span>
01177 <span class="comment">    This routines indicates whether there are current outstanding</span>
01178 <span class="comment">    batch oplocks.</span>
01179 <span class="comment"></span>
01180 <span class="comment">Arguments:</span>
01181 <span class="comment"></span>
01182 <span class="comment">    OpLock - Supplies the oplock being queried</span>
01183 <span class="comment"></span>
01184 <span class="comment">Return Value:</span>
01185 <span class="comment"></span>
01186 <span class="comment">    BOOLEAN - TRUE if there are outstanding batch oplocks and FALSE otherwise</span>
01187 <span class="comment"></span>
01188 <span class="comment">--*/</span>
01189 
01190 {
01191     BOOLEAN BatchOplocks = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01192 
01193     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01194 
01195     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCurrentBatchOplock: Oplock -&gt; %08lx\n"</span>, *Oplock);
01196 
01197     <span class="comment">//</span>
01198     <span class="comment">//  There are not any current oplocks if the variable is null or</span>
01199     <span class="comment">//  the state is no oplocks held.  We check whether there are batch</span>
01200     <span class="comment">//  oplocks or filter oplocks which have not been broken.</span>
01201     <span class="comment">//</span>
01202 
01203     <span class="keywordflow">if</span> ((*Oplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01204         <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ((<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>) *Oplock)-&gt;OplockState,
01205                 <a class="code" href="../../d5/d2/oplock_8c.html#a4">BATCH_OPLOCK</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a5">FILTER_OPLOCK</a> )) {
01206 
01207         BatchOplocks = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01208     }
01209 
01210     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCurrentBatchOplock: Exit -&gt; %08lx\n"</span>, BatchOplocks);
01211 
01212     <span class="keywordflow">return</span> BatchOplocks;
01213 }
01214 
01215 
01216 <span class="comment">//</span>
01217 <span class="comment">//  Local support routine.</span>
01218 <span class="comment">//</span>
01219 
01220 <a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>
<a name="l01221"></a><a class="code" href="../../d5/d2/oplock_8c.html#a39">01221</a> <a class="code" href="../../d5/d2/oplock_8c.html#a39">FsRtlAllocateOplock</a> (
01222     )
01223 
01224 <span class="comment">/*++</span>
01225 <span class="comment"></span>
01226 <span class="comment">Routine Description:</span>
01227 <span class="comment"></span>
01228 <span class="comment">    This routine is called to initialize and allocate an opaque oplock</span>
01229 <span class="comment">    structure.  After allocation, the two events are set to the signalled</span>
01230 <span class="comment">    state.  The oplock state is set to NoOplocksHeld and the other</span>
01231 <span class="comment">    fields are filled with zeroes.</span>
01232 <span class="comment"></span>
01233 <span class="comment">    If the allocation fails, the appropriate status is raised.</span>
01234 <span class="comment"></span>
01235 <span class="comment">Arguments:</span>
01236 <span class="comment"></span>
01237 <span class="comment">    None.</span>
01238 <span class="comment"></span>
01239 <span class="comment">Return Value:</span>
01240 <span class="comment"></span>
01241 <span class="comment">    PNONOPAQUE_OPLOCK - A pointer to the allocated structure.</span>
01242 <span class="comment"></span>
01243 <span class="comment">--*/</span>
01244 
01245 {
01246     <a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a> NewOplock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01247 
01248     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01249 
01250     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlAllocateOplock:  Entered\n"</span>, 0);
01251 
01252     <span class="comment">//</span>
01253     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01254     <span class="comment">//</span>
01255 
01256     <span class="keywordflow">try</span> {
01257 
01258         <span class="comment">//</span>
01259         <span class="comment">//  Raise an error status if the allocation is unsuccessful.</span>
01260         <span class="comment">//  The structure is allocated out of non-paged pool.</span>
01261         <span class="comment">//</span>
01262 
01263         NewOplock = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">NONOPAQUE_OPLOCK</a> ));
01264 
01265         RtlZeroMemory( NewOplock, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d2/oplock_8c.html#a35">NONOPAQUE_OPLOCK</a> ));
01266 
01267         NewOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> ));
01268 
01269         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( NewOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
01270 
01271         InitializeListHead( &amp;NewOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a> );
01272         InitializeListHead( &amp;NewOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a> );
01273 
01274         NewOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
01275 
01276     } finally {
01277 
01278         <span class="comment">//</span>
01279         <span class="comment">//  Cleanup the oplock if abnormal termination.</span>
01280         <span class="comment">//</span>
01281 
01282         <span class="keywordflow">if</span> (AbnormalTermination() &amp;&amp; NewOplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01283 
01284             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewOplock );
01285         }
01286 
01287         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"GetOplockStructure:  Exit -&gt; %08lx\n"</span>, NewOplock);
01288     }
01289 
01290     <span class="keywordflow">return</span> NewOplock;
01291 }
01292 
01293 
01294 <span class="comment">//</span>
01295 <span class="comment">//  Local support routine.</span>
01296 <span class="comment">//</span>
01297 
01298 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01299"></a><a class="code" href="../../d5/d2/oplock_8c.html#a40">01299</a> <a class="code" href="../../d5/d2/oplock_8c.html#a40">FsRtlRequestExclusiveOplock</a> (
01300     IN OUT PNONOPAQUE_OPLOCK *Oplock,
01301     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
01302     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp OPTIONAL,
01303     IN OPLOCK_STATE NextOplockState
01304     )
01305 
01306 <span class="comment">/*++</span>
01307 <span class="comment"></span>
01308 <span class="comment">Routine Description:</span>
01309 <span class="comment"></span>
01310 <span class="comment">    This routine is called whenever a user is requesting either a batch/filter</span>
01311 <span class="comment">    oplock or a level I oplock.  The request is granted if there are currently</span>
01312 <span class="comment">    no oplocks on the file or we are completing the filter oplock request.</span>
01313 <span class="comment"></span>
01314 <span class="comment">    NOTE - We already know that the open count on this file is exactly one.</span>
01315 <span class="comment">        If the caller is requesting a PendingFilter Oplock then the state</span>
01316 <span class="comment">        must be NoOplockHeld.</span>
01317 <span class="comment"></span>
01318 <span class="comment">Arguments:</span>
01319 <span class="comment"></span>
01320 <span class="comment">    Oplock - Supplies a pointer to the non-opaque oplock structure for</span>
01321 <span class="comment">             this file.</span>
01322 <span class="comment"></span>
01323 <span class="comment">    IrpSp - This is the Irp stack location for the current Irp.</span>
01324 <span class="comment"></span>
01325 <span class="comment">    Irp - Supplies a pointer to the Irp which declares the requested</span>
01326 <span class="comment">          operation.  This is not specified if we are granting a pending</span>
01327 <span class="comment">          filter oplock (during a create).</span>
01328 <span class="comment"></span>
01329 <span class="comment">    NextOplockState - Indicates the type of oplock being requested.</span>
01330 <span class="comment"></span>
01331 <span class="comment">Return Value:</span>
01332 <span class="comment"></span>
01333 <span class="comment">    STATUS_PENDING if the oplock is granted (although it may be immediately cancelled).</span>
01334 <span class="comment">    STATUS_SUCCESS if a pending filter oplock is requested and tentatively granted.</span>
01335 <span class="comment">    STATUS_OPLOCK_NOT_GRANTED if the request is denied.</span>
01336 <span class="comment"></span>
01337 <span class="comment">--*/</span>
01338 
01339 {
01340     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01341 
01342     <a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a> ThisOplock;
01343 
01344     BOOLEAN AcquiredMutex;
01345     BOOLEAN BreakOpFilter = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01346 
01347     PLIST_ENTRY Link;
01348 
01349     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlRequestExclusiveOplock:  Entered\n"</span>, 0 );
01350     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Oplock        -&gt; %08lx\n"</span>, Oplock );
01351     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"IrpSp         -&gt; %08lx\n"</span>, IrpSp );
01352     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Irp           -&gt; %08lx\n"</span>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
01353     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"BatchOplock   -&gt; %01x\n"</span>,  BatchOplock );
01354 
01355     <span class="comment">//</span>
01356     <span class="comment">//  We can grant the oplock if no one else owns a level I or level II</span>
01357     <span class="comment">//  oplock on this file.  If the oplock pointer is NULL then there</span>
01358     <span class="comment">//  are no oplocks on the file.  Otherwise we need to check the</span>
01359     <span class="comment">//  oplock state in an existing oplock structure.</span>
01360     <span class="comment">//</span>
01361 
01362     <span class="keywordflow">if</span> (*Oplock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01363 
01364         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0,
01365                     <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
01366                     <span class="stringliteral">"Oplock currently not allocated\n"</span>,
01367                     0);
01368 
01369         ThisOplock = <a class="code" href="../../d5/d2/oplock_8c.html#a39">FsRtlAllocateOplock</a>();
01370         *Oplock = ThisOplock;
01371 
01372     } <span class="keywordflow">else</span> {
01373 
01374         ThisOplock = *Oplock;
01375     }
01376 
01377     <span class="comment">//</span>
01378     <span class="comment">//  Grab the synchronization object for the oplock.</span>
01379     <span class="comment">//</span>
01380 
01381     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
01382 
01383     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01384 
01385     <span class="comment">//</span>
01386     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01387     <span class="comment">//</span>
01388 
01389     <span class="keywordflow">try</span> {
01390 
01391         <span class="comment">//</span>
01392         <span class="comment">//  If we are requesting a PendingFilter Oplock then it must be</span>
01393         <span class="comment">//  safe to grant.  There is only one open handle and we are in</span>
01394         <span class="comment">//  the process of opening it.</span>
01395         <span class="comment">//</span>
01396 
01397         <span class="keywordflow">if</span> (NextOplockState == <a class="code" href="../../d5/d2/oplock_8c.html#a20">OpFilterReqPending</a>) {
01398 
01399             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a>, <a class="code" href="../../d5/d2/oplock_8c.html#a2">NO_OPLOCK</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a9">PENDING</a> ));
01400 
01401             ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
01402             ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a> = IrpSp-&gt;FileObject;
01403 
01404             ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a20">OpFilterReqPending</a>;
01405             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01406 
01407         <span class="comment">//</span>
01408         <span class="comment">//  If the current oplock state is no oplocks held then we</span>
01409         <span class="comment">//  will grant the oplock to this requestor.  If the state is</span>
01410         <span class="comment">//  either of the OpFilter states then also grant the request.</span>
01411         <span class="comment">//  We won't check for a matching file object because there can</span>
01412         <span class="comment">//  only be one file object.  Grant the request anyway.</span>
01413         <span class="comment">//</span>
01414         <span class="comment">//  If the current state is OplockII granted then it must</span>
01415         <span class="comment">//  be owned by this request.  Break the oplock II and grant</span>
01416         <span class="comment">//  the exclusive lock.</span>
01417         <span class="comment">//</span>
01418 
01419         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a>,
01420                            <a class="code" href="../../d5/d2/oplock_8c.html#a6">LEVEL_II_OPLOCK</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a2">NO_OPLOCK</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a9">PENDING</a> )) {
01421 
01422             <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> OplockFastMutex;
01423 
01424             <span class="keywordflow">if</span> (ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a> == <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>) {
01425 
01426                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>.Flink == ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>.Blink );
01427 
01428                 <a class="code" href="../../d5/d2/oplock_8c.html#a48">FsRtlRemoveAndCompleteIrp</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>.Flink );
01429             }
01430 
01431             <span class="comment">//</span>
01432             <span class="comment">//  Put the address of the fast mutex on the stack.</span>
01433             <span class="comment">//</span>
01434 
01435             OplockFastMutex = ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a>;
01436 
01437             <span class="comment">//</span>
01438             <span class="comment">//  We store this Irp in the Oplocks structure.</span>
01439             <span class="comment">//  We set the oplock state to the correct exclusive oplock.</span>
01440             <span class="comment">//</span>
01441 
01442             ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
01443             ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a> = IrpSp-&gt;FileObject;
01444             ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a> = NextOplockState;
01445 
01446             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
01447 
01448             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( IrpSp-&gt;FileObject );
01449 
01450             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = (ULONG_PTR) ThisOplock;
01451 
01452             <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01453 
01454             <span class="comment">//</span>
01455             <span class="comment">//  Now if the irp is cancelled then we'll call the cancel</span>
01456             <span class="comment">//  routine right now to do away with the irp, otherwise</span>
01457             <span class="comment">//  we set the cancel routine</span>
01458             <span class="comment">//</span>
01459 
01460             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
01461 
01462                 AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01463 
01464                 <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( OplockFastMutex );
01465 
01466                 <a class="code" href="../../d5/d2/oplock_8c.html#a53">FsRtlCancelExclusiveIrp</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
01467 
01468             } <span class="keywordflow">else</span> {
01469 
01470                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d5/d2/oplock_8c.html#a53">FsRtlCancelExclusiveIrp</a> );
01471                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01472             }
01473 
01474             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PENDING;
01475 
01476         } <span class="keywordflow">else</span> {
01477 
01478             <span class="comment">//</span>
01479             <span class="comment">//  We'll complete the Irp with the Oplock not granted message</span>
01480             <span class="comment">//  and return that value as a status.</span>
01481             <span class="comment">//</span>
01482 
01483             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> )) {
01484 
01485                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_OPLOCK_NOT_GRANTED );
01486             }
01487 
01488             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OPLOCK_NOT_GRANTED;
01489         }
01490 
01491     } finally {
01492 
01493         <span class="comment">//</span>
01494         <span class="comment">//  Give up the oplock synchronization object.</span>
01495         <span class="comment">//</span>
01496 
01497         <span class="keywordflow">if</span> (AcquiredMutex) {
01498 
01499             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
01500         }
01501 
01502         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlRequestExclusiveOplock:  Exit\n"</span>, 0 );
01503     }
01504 
01505     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01506 }
01507 
01508 
01509 <span class="comment">//</span>
01510 <span class="comment">//  Local support routine.</span>
01511 <span class="comment">//</span>
01512 
01513 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01514"></a><a class="code" href="../../d5/d2/oplock_8c.html#a41">01514</a> <a class="code" href="../../d5/d2/oplock_8c.html#a41">FsRtlRequestOplockII</a> (
01515     IN OUT PNONOPAQUE_OPLOCK *Oplock,
01516     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
01517     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
01518     )
01519 
01520 <span class="comment">/*++</span>
01521 <span class="comment"></span>
01522 <span class="comment">Routine Description:</span>
01523 <span class="comment"></span>
01524 <span class="comment">    This routine is called when a user is requesting an Oplock II on an</span>
01525 <span class="comment">    open file.  The request is granted if there are currently no</span>
01526 <span class="comment">    level 1 oplocks on the file and an oplock break is not in progress.</span>
01527 <span class="comment"></span>
01528 <span class="comment">Arguments:</span>
01529 <span class="comment"></span>
01530 <span class="comment">    Oplock - Supplies a pointer to the non-opaque oplock structure for</span>
01531 <span class="comment">             this file.</span>
01532 <span class="comment"></span>
01533 <span class="comment">    IrpSp - This is the Irp stack location for the current Irp.</span>
01534 <span class="comment"></span>
01535 <span class="comment">    Irp - Supplies a pointer to the Irp which declares the requested</span>
01536 <span class="comment">          operation.</span>
01537 <span class="comment"></span>
01538 <span class="comment">Return Value:</span>
01539 <span class="comment"></span>
01540 <span class="comment">    STATUS_PENDING if the oplock is granted.</span>
01541 <span class="comment">    STATUS_OPLOCK_NOT_GRANTED if the request is denied.</span>
01542 <span class="comment"></span>
01543 <span class="comment">--*/</span>
01544 
01545 {
01546     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01547 
01548     <a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a> ThisOplock;
01549 
01550     BOOLEAN AcquiredMutex;
01551 
01552     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlRequestOplockII:  Entered\n"</span>, 0 );
01553     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
01554     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"IrpSp     -&gt; %08lx\n"</span>, IrpSp );
01555     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Irp       -&gt; %08lx\n"</span>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
01556 
01557     <span class="comment">//</span>
01558     <span class="comment">//  We can grant the oplock if no one else owns a level I</span>
01559     <span class="comment">//  oplock on this file.  If the oplock pointer is NULL then there</span>
01560     <span class="comment">//  are no oplocks on the file.  Otherwise we need to check the</span>
01561     <span class="comment">//  oplock state in an existing oplock structure.</span>
01562     <span class="comment">//</span>
01563 
01564     <span class="keywordflow">if</span> (*Oplock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01565 
01566         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0,
01567                     <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
01568                     <span class="stringliteral">"Oplock currently not allocated\n"</span>,
01569                     0);
01570 
01571         ThisOplock = <a class="code" href="../../d5/d2/oplock_8c.html#a39">FsRtlAllocateOplock</a>();
01572         *Oplock = ThisOplock;
01573 
01574     } <span class="keywordflow">else</span> {
01575 
01576         ThisOplock = *Oplock;
01577     }
01578 
01579     <span class="comment">//</span>
01580     <span class="comment">//  Grab the synchronization object for the oplock.</span>
01581     <span class="comment">//</span>
01582 
01583     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
01584 
01585     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01586 
01587     <span class="comment">//</span>
01588     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01589     <span class="comment">//</span>
01590 
01591     <span class="keywordflow">try</span> {
01592 
01593         <span class="comment">//</span>
01594         <span class="comment">//  If the current oplock state is no oplocks held or OplockIIGranted</span>
01595         <span class="comment">//  then we will grant the oplock to this requestor.</span>
01596         <span class="comment">//</span>
01597 
01598         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a>, <a class="code" href="../../d5/d2/oplock_8c.html#a2">NO_OPLOCK</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a6">LEVEL_II_OPLOCK</a> )) {
01599 
01600             <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> OplockFastMutex = ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a>;
01601 
01602             <span class="comment">//</span>
01603             <span class="comment">//  We store this Irp in the Oplocks structure.</span>
01604             <span class="comment">//  We set the oplock state to 'OplockIIGranted'.</span>
01605             <span class="comment">//</span>
01606 
01607             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
01608 
01609             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_SUCCESS;
01610 
01611             InsertHeadList( &amp;ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>,
01612                             &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.ListEntry );
01613 
01614             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = (ULONG_PTR) ThisOplock;
01615 
01616             ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>;
01617 
01618             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( IrpSp-&gt;FileObject );
01619 
01620             <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01621 
01622             <span class="comment">//</span>
01623             <span class="comment">//  Now if the irp is cancelled then we'll call the cancel</span>
01624             <span class="comment">//  routine right now to do away with the irp, otherwise</span>
01625             <span class="comment">//  we set the cancel routine</span>
01626             <span class="comment">//</span>
01627 
01628             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
01629 
01630                 AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01631 
01632                 <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( OplockFastMutex );
01633 
01634                 <a class="code" href="../../d5/d2/oplock_8c.html#a52">FsRtlCancelOplockIIIrp</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
01635 
01636             } <span class="keywordflow">else</span> {
01637 
01638                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d5/d2/oplock_8c.html#a52">FsRtlCancelOplockIIIrp</a> );
01639                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01640             }
01641 
01642             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PENDING;
01643 
01644         } <span class="keywordflow">else</span> {
01645 
01646             <span class="comment">//</span>
01647             <span class="comment">//  We'll complete the Irp with the Oplock not granted message</span>
01648             <span class="comment">//  and return that value as a status.</span>
01649             <span class="comment">//</span>
01650 
01651             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_OPLOCK_NOT_GRANTED );
01652             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OPLOCK_NOT_GRANTED;
01653         }
01654 
01655     } finally {
01656 
01657         <span class="comment">//</span>
01658         <span class="comment">//  Give up the oplock synchronization object.</span>
01659         <span class="comment">//</span>
01660 
01661         <span class="keywordflow">if</span> (AcquiredMutex) {
01662 
01663             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
01664         }
01665 
01666         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlRequestOplockII:  Exit\n"</span>, 0 );
01667     }
01668 
01669     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01670 }
01671 
01672 
01673 <span class="comment">//</span>
01674 <span class="comment">//  Local support routine.</span>
01675 <span class="comment">//</span>
01676 
01677 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01678"></a><a class="code" href="../../d5/d2/oplock_8c.html#a42">01678</a> <a class="code" href="../../d5/d2/oplock_8c.html#a42">FsRtlAcknowledgeOplockBreak</a> (
01679     IN OUT PNONOPAQUE_OPLOCK Oplock,
01680     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
01681     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
01682     IN BOOLEAN GrantLevelII
01683     )
01684 
01685 <span class="comment">/*++</span>
01686 <span class="comment"></span>
01687 <span class="comment">Routine Description:</span>
01688 <span class="comment"></span>
01689 <span class="comment">    This routine is called when a user is acknowledging an Oplock I</span>
01690 <span class="comment">    break.  If the level 1 oplock was being broken to level 2, then</span>
01691 <span class="comment">    a check is made to insure that the level 2 has not been broken</span>
01692 <span class="comment">    in the meantime.</span>
01693 <span class="comment"></span>
01694 <span class="comment">    If an oplock 1 break is not in progress then this will be treated</span>
01695 <span class="comment">    as an asynchronous break request.  If this is an asynchronous break</span>
01696 <span class="comment">    request and the file object owns an outstanding level 1 oplock, then</span>
01697 <span class="comment">    the oplock will be broken at this point.</span>
01698 <span class="comment"></span>
01699 <span class="comment">    A spurious break request via a file object which does not (or did not)</span>
01700 <span class="comment">    own the level 1 oplock will generate a warning but will not affect</span>
01701 <span class="comment">    the oplock state.</span>
01702 <span class="comment"></span>
01703 <span class="comment">    At the end of an Oplock I break, all of the waiting irps are completed.</span>
01704 <span class="comment"></span>
01705 <span class="comment">Arguments:</span>
01706 <span class="comment"></span>
01707 <span class="comment">    Oplock - Supplies a pointer to the non-opaque oplock structure for</span>
01708 <span class="comment">             this file.</span>
01709 <span class="comment"></span>
01710 <span class="comment">    IrpSp - This is the Irp stack location for the current Irp.</span>
01711 <span class="comment"></span>
01712 <span class="comment">    Irp - Supplies a pointer to the Irp which declares the requested</span>
01713 <span class="comment">          operation.</span>
01714 <span class="comment"></span>
01715 <span class="comment">    GrantLevelII - Indicates that this caller wants a level II oplock left</span>
01716 <span class="comment">        on the file.</span>
01717 <span class="comment"></span>
01718 <span class="comment">Return Value:</span>
01719 <span class="comment"></span>
01720 <span class="comment">    STATUS_SUCCESS if we can complete the operation on exiting this thread.</span>
01721 <span class="comment">    STATUS_CANCELLED if the Irp is cancelled before we return.</span>
01722 <span class="comment"></span>
01723 <span class="comment">--*/</span>
01724 
01725 {
01726     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01727 
01728     BOOLEAN AcquiredMutex;
01729 
01730     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlAcknowledgeOplockBreak:  Entered\n"</span>, 0 );
01731     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
01732     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"IrpSp     -&gt; %08lx\n"</span>, IrpSp );
01733     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Irp       -&gt; %08lx\n"</span>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
01734 
01735     <span class="comment">//</span>
01736     <span class="comment">//  If there is no oplock structure, we complete this with invalid</span>
01737     <span class="comment">//  oplock protocol.</span>
01738     <span class="comment">//</span>
01739 
01740     <span class="keywordflow">if</span> (Oplock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01741 
01742         <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_INVALID_OPLOCK_PROTOCOL );
01743         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlAcknowledgeOplockBreak:  Exit -&gt; %08lx\n"</span>, STATUS_INVALID_OPLOCK_PROTOCOL );
01744         <span class="keywordflow">return</span> STATUS_INVALID_OPLOCK_PROTOCOL;
01745     }
01746 
01747     <span class="comment">//</span>
01748     <span class="comment">//  Grab the synchronization object for the oplock.</span>
01749     <span class="comment">//</span>
01750 
01751     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
01752     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01753 
01754     <span class="comment">//</span>
01755     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01756     <span class="comment">//</span>
01757 
01758     <span class="keywordflow">try</span> {
01759 
01760         BOOLEAN DereferenceFileObject = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01761 
01762         <span class="comment">//</span>
01763         <span class="comment">//  If a break is underway but this is not the owner of the</span>
01764         <span class="comment">//  level 1 oplock, we complete the request and return a</span>
01765         <span class="comment">//  warning.</span>
01766         <span class="comment">//</span>
01767 
01768         <span class="keywordflow">if</span> (Oplock-&gt;FileObject != IrpSp-&gt;FileObject) {
01769 
01770             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OPLOCK_PROTOCOL;
01771             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
01772                        <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
01773                        <span class="stringliteral">"Not oplock owner -&gt; %08lx\n"</span>,
01774                        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01775 
01776             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01777             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01778         }
01779 
01780         <span class="comment">//</span>
01781         <span class="comment">//  If the user would like a level II and we are breaking to level II</span>
01782         <span class="comment">//  then grant the oplock.</span>
01783         <span class="comment">//</span>
01784 
01785         <span class="keywordflow">if</span> (GrantLevelII &amp;&amp;
01786             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a11">BREAK_TO_II</a> )) {
01787 
01788             <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> OplockFastMutex = Oplock-&gt;FastMutex;
01789 
01790             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"OplockItoII\n"</span>, 0);
01791 
01792             <span class="comment">//</span>
01793             <span class="comment">//  The acknowledgement should never be synchronous.</span>
01794             <span class="comment">//</span>
01795 
01796             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !<a class="code" href="../../d4/d6/iosubs_8c.html#a83">IoIsOperationSynchronous</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> ));
01797 
01798             <span class="comment">//</span>
01799             <span class="comment">//  We need to add this Irp to the oplock II queue, change</span>
01800             <span class="comment">//  the oplock state to Oplock II granted and set the</span>
01801             <span class="comment">//  return value to STATUS_PENDING.</span>
01802             <span class="comment">//</span>
01803 
01804 
01805             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
01806 
01807             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_SUCCESS;
01808 
01809             InsertHeadList( &amp;Oplock-&gt;IrpOplocksII,
01810                             &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.ListEntry );
01811 
01812             DereferenceFileObject = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01813 
01814             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>;
01815 
01816             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = (ULONG_PTR) Oplock;
01817 
01818             <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01819 
01820             <span class="comment">//</span>
01821             <span class="comment">//  Now if the irp is cancelled then we'll call the cancel</span>
01822             <span class="comment">//  routine right now to do away with the irp, otherwise</span>
01823             <span class="comment">//  we set the cancel routine</span>
01824             <span class="comment">//</span>
01825 
01826             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
01827 
01828                 AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01829 
01830                 <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( OplockFastMutex );
01831 
01832                 <a class="code" href="../../d5/d2/oplock_8c.html#a52">FsRtlCancelOplockIIIrp</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
01833 
01834             } <span class="keywordflow">else</span> {
01835 
01836                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d5/d2/oplock_8c.html#a52">FsRtlCancelOplockIIIrp</a> );
01837                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01838             }
01839 
01840             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PENDING;
01841 
01842         <span class="comment">//</span>
01843         <span class="comment">//  We will break to none since this is the expected case for these</span>
01844         <span class="comment">//  cases.</span>
01845         <span class="comment">//</span>
01846 
01847         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a11">BREAK_TO_II</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a12">BREAK_TO_NONE</a> )) {
01848 
01849             <span class="comment">//</span>
01850             <span class="comment">//  We need to complete this Irp and return STATUS_SUCCESS.</span>
01851             <span class="comment">//  We also set the oplock state to no oplocks held.</span>
01852             <span class="comment">//</span>
01853 
01854             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"OplockItoNone\n"</span>, 0);
01855 
01856             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01857             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01858             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
01859 
01860         <span class="comment">//</span>
01861         <span class="comment">//  In this case the user expects to be at level II.  He is</span>
01862         <span class="comment">//  expecting this Irp to be completed when the LevelII Oplock</span>
01863         <span class="comment">//  is broken.</span>
01864         <span class="comment">//</span>
01865 
01866         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a13">BREAK_TO_II_TO_NONE</a> )) {
01867 
01868             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"AcknowledgeOplockBreak:  OplockItoIItoNone\n"</span>, 0);
01869 
01870             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01871             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
01872             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01873             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
01874 
01875         } <span class="keywordflow">else</span> {
01876 
01877             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OPLOCK_PROTOCOL;
01878             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
01879                        <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
01880                        <span class="stringliteral">"No break underway -&gt; %08lx\n"</span>,
01881                        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01882 
01883             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01884             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01885         }
01886 
01887         <span class="comment">//</span>
01888         <span class="comment">//  Complete the waiting Irps and cleanup the oplock structure.</span>
01889         <span class="comment">//</span>
01890 
01891         <span class="keywordflow">while</span> (!IsListEmpty( &amp;Oplock-&gt;WaitingIrps )) {
01892 
01893             <a class="code" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a> WaitingIrp;
01894 
01895             <span class="comment">//</span>
01896             <span class="comment">//  Remove the entry found and complete the Irp.</span>
01897             <span class="comment">//</span>
01898 
01899             WaitingIrp = CONTAINING_RECORD( Oplock-&gt;WaitingIrps.Flink,
01900                                             <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>,
01901                                             Links );
01902 
01903             <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a>( WaitingIrp );
01904         }
01905 
01906         <span class="keywordflow">if</span> (DereferenceFileObject) {
01907 
01908             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Oplock-&gt;FileObject );
01909         }
01910 
01911         Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01912 
01913     try_exit:  NOTHING;
01914     } finally {
01915 
01916         <span class="comment">//</span>
01917         <span class="comment">//  Give up the oplock synchronization object.</span>
01918         <span class="comment">//</span>
01919 
01920         <span class="keywordflow">if</span> (AcquiredMutex) {
01921 
01922             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
01923         }
01924 
01925         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlAcknowledgeOplockBreak:  Exit -&gt; %08x\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01926     }
01927 
01928     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01929 }
01930 
01931 
01932 <span class="comment">//</span>
01933 <span class="comment">//  Local support routine.</span>
01934 <span class="comment">//</span>
01935 
01936 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01937"></a><a class="code" href="../../d5/d2/oplock_8c.html#a43">01937</a> <a class="code" href="../../d5/d2/oplock_8c.html#a43">FsRtlOpBatchBreakClosePending</a> (
01938     IN OUT PNONOPAQUE_OPLOCK Oplock,
01939     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
01940     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
01941     )
01942 
01943 <span class="comment">/*++</span>
01944 <span class="comment"></span>
01945 <span class="comment">Routine Description:</span>
01946 <span class="comment"></span>
01947 <span class="comment">    This routine is called when a user is acknowledging a batch oplock</span>
01948 <span class="comment">    break or Level I oplock break.  In this case the user is planning</span>
01949 <span class="comment">    to close the file as well and doesn't need a level II oplock.</span>
01950 <span class="comment"></span>
01951 <span class="comment">Arguments:</span>
01952 <span class="comment"></span>
01953 <span class="comment">    Oplock - Supplies a pointer to the non-opaque oplock structure for</span>
01954 <span class="comment">             this file.</span>
01955 <span class="comment"></span>
01956 <span class="comment">    IrpSp - This is the Irp stack location for the current Irp.</span>
01957 <span class="comment"></span>
01958 <span class="comment">    Irp - Supplies a pointer to the Irp which declares the requested</span>
01959 <span class="comment">          operation.</span>
01960 <span class="comment"></span>
01961 <span class="comment">Return Value:</span>
01962 <span class="comment"></span>
01963 <span class="comment">    STATUS_SUCCESS if we can complete the operation on exiting this thread.</span>
01964 <span class="comment">    STATUS_CANCELLED if the Irp is cancelled before we return.</span>
01965 <span class="comment"></span>
01966 <span class="comment">--*/</span>
01967 
01968 {
01969     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01970 
01971     BOOLEAN AcquiredMutex;
01972 
01973     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01974 
01975     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlOpBatchBreakClosePending:  Entered\n"</span>, 0 );
01976     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
01977     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"IrpSp     -&gt; %08lx\n"</span>, IrpSp );
01978     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Irp       -&gt; %08lx\n"</span>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
01979 
01980     <span class="comment">//</span>
01981     <span class="comment">//  If there is no oplock structure, we complete this with invalid</span>
01982     <span class="comment">//  oplock protocol.</span>
01983     <span class="comment">//</span>
01984 
01985     <span class="keywordflow">if</span> (Oplock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01986 
01987         <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_INVALID_OPLOCK_PROTOCOL );
01988         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlOpBatchClosePending:  Exit -&gt; %08lx\n"</span>, STATUS_INVALID_OPLOCK_PROTOCOL );
01989         <span class="keywordflow">return</span> STATUS_INVALID_OPLOCK_PROTOCOL;
01990     }
01991 
01992     <span class="comment">//</span>
01993     <span class="comment">//  Grab the synchronization object for the oplock.</span>
01994     <span class="comment">//</span>
01995 
01996     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
01997     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01998 
01999     <span class="comment">//</span>
02000     <span class="comment">//  Use a try_finally to facilitate cleanup.</span>
02001     <span class="comment">//</span>
02002 
02003     <span class="keywordflow">try</span> {
02004 
02005         <span class="comment">//</span>
02006         <span class="comment">//  If a break is underway but this is not the owner of the</span>
02007         <span class="comment">//  level 1 oplock, we complete the request and return a</span>
02008         <span class="comment">//  warning.</span>
02009         <span class="comment">//</span>
02010 
02011         <span class="keywordflow">if</span> (Oplock-&gt;FileObject != IrpSp-&gt;FileObject) {
02012 
02013             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OPLOCK_PROTOCOL;
02014             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02015                        <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02016                        <span class="stringliteral">"Not oplock owner -&gt; %08lx\n"</span>,
02017                        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02018 
02019         } <span class="keywordflow">else</span> {
02020 
02021             <span class="comment">//</span>
02022             <span class="comment">//  If this is an opbatch operation we want to note that a</span>
02023             <span class="comment">//  close is pending.  For an exclusive oplock we set the state to</span>
02024             <span class="comment">//  no oplocsk held.  There must be a break in progress to</span>
02025             <span class="comment">//  process however.</span>
02026             <span class="comment">//</span>
02027 
02028             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState,
02029                         <a class="code" href="../../d5/d2/oplock_8c.html#a11">BREAK_TO_II</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a12">BREAK_TO_NONE</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a13">BREAK_TO_II_TO_NONE</a> )) {
02030 
02031                 <span class="comment">//</span>
02032                 <span class="comment">//  Break all oplocks for an exclusive oplock.</span>
02033                 <span class="comment">//</span>
02034 
02035                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a3">LEVEL_I_OPLOCK</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a9">PENDING</a> )) {
02036 
02037                     <span class="comment">//</span>
02038                     <span class="comment">//  Clean up the oplock structure and complete all waiting Irps.</span>
02039                     <span class="comment">//</span>
02040 
02041                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a3">LEVEL_I_OPLOCK</a> )) {
02042 
02043                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Oplock-&gt;FileObject );
02044                     }
02045 
02046                     Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02047                     Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02048 
02049                     <span class="keywordflow">while</span> (!IsListEmpty( &amp;Oplock-&gt;WaitingIrps )) {
02050 
02051                         <a class="code" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a> WaitingIrp;
02052 
02053                         <span class="comment">//</span>
02054                         <span class="comment">//  Remove the entry found and complete the Irp.</span>
02055                         <span class="comment">//</span>
02056 
02057                         WaitingIrp = CONTAINING_RECORD( Oplock-&gt;WaitingIrps.Flink,
02058                                                         <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>,
02059                                                         Links );
02060 
02061                         <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a>( WaitingIrp );
02062                     }
02063 
02064                 <span class="comment">//</span>
02065                 <span class="comment">//  Set the state to close pending for batch and filter</span>
02066                 <span class="comment">//  oplocks.</span>
02067                 <span class="comment">//</span>
02068 
02069                 } <span class="keywordflow">else</span> {
02070 
02071                     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a15">OPLOCK_BREAK_MASK</a> );
02072                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a14">CLOSE_PENDING</a> );
02073                 }
02074 
02075             } <span class="keywordflow">else</span> {
02076 
02077                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OPLOCK_PROTOCOL;
02078                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02079                            <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02080                            <span class="stringliteral">"No break underway -&gt; %08lx\n"</span>,
02081                            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02082             }
02083         }
02084 
02085         <span class="comment">//</span>
02086         <span class="comment">//  We simply complete this request.</span>
02087         <span class="comment">//</span>
02088 
02089         <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02090 
02091     } finally {
02092 
02093         <span class="comment">//</span>
02094         <span class="comment">//  Release the synchronization object.</span>
02095         <span class="comment">//</span>
02096 
02097         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02098 
02099         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlOpBatchBreakClosePending:  Exit -&gt; %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02100     }
02101 
02102     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02103 }
02104 
02105 
02106 <span class="comment">//</span>
02107 <span class="comment">//  Local support routine</span>
02108 <span class="comment">//</span>
02109 
02110 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02111"></a><a class="code" href="../../d5/d2/oplock_8c.html#a44">02111</a> <a class="code" href="../../d5/d2/oplock_8c.html#a44">FsRtlOplockBreakNotify</a> (
02112     IN OUT PNONOPAQUE_OPLOCK Oplock,
02113     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
02114     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
02115     )
02116 
02117 <span class="comment">/*++</span>
02118 <span class="comment"></span>
02119 <span class="comment">Routine Description:</span>
02120 <span class="comment"></span>
02121 <span class="comment">    This routine is called when the Irp refers the user request to</span>
02122 <span class="comment">    be notified when there is no level 1 oplock break in progress.</span>
02123 <span class="comment">    Under any other condition this routine completes immediately with</span>
02124 <span class="comment">    STATUS_SUCCESS.  Otherwise we simply add this Irp to the list</span>
02125 <span class="comment">    of Irp's waiting for the break to complete.</span>
02126 <span class="comment"></span>
02127 <span class="comment">Arguments:</span>
02128 <span class="comment"></span>
02129 <span class="comment">    Oplock - Supplies a pointer to the non-opaque oplock structure for</span>
02130 <span class="comment">             this file.</span>
02131 <span class="comment"></span>
02132 <span class="comment">    IrpSp - This is the Irp stack location for the current Irp.</span>
02133 <span class="comment"></span>
02134 <span class="comment">    Irp - Supplies a pointer to the Irp which declares the requested</span>
02135 <span class="comment">          operation.</span>
02136 <span class="comment"></span>
02137 <span class="comment">Return Value:</span>
02138 <span class="comment"></span>
02139 <span class="comment">    STATUS_SUCCESS if we can complete the operation on exiting this thread.</span>
02140 <span class="comment">    STATUS_PENDING if we return here but hold the Irp.</span>
02141 <span class="comment">    STATUS_CANCELLED if the Irp is cancelled before we return.</span>
02142 <span class="comment"></span>
02143 <span class="comment">--*/</span>
02144 
02145 {
02146     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02147 
02148     BOOLEAN AcquiredMutex;
02149 
02150     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02151 
02152     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlOplockBreakNotify:  Entered\n"</span>, 0 );
02153     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
02154     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"IrpSp     -&gt; %08lx\n"</span>, IrpSp );
02155     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Irp       -&gt; %08lx\n"</span>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
02156 
02157     <span class="comment">//</span>
02158     <span class="comment">//  If there is no oplock structure, we complete this with status success.</span>
02159     <span class="comment">//</span>
02160 
02161     <span class="keywordflow">if</span> (Oplock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02162 
02163         <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_SUCCESS );
02164         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlOpBatchClosePending:  Exit -&gt; %08lx\n"</span>, STATUS_SUCCESS );
02165         <span class="keywordflow">return</span> STATUS_SUCCESS;
02166     }
02167 
02168     <span class="comment">//</span>
02169     <span class="comment">//  Grap the synchronization object.</span>
02170     <span class="comment">//</span>
02171 
02172     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02173     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02174 
02175     <span class="comment">//</span>
02176     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
02177     <span class="comment">//</span>
02178 
02179     <span class="keywordflow">try</span> {
02180 
02181         <span class="comment">//</span>
02182         <span class="comment">//  If there are no outstanding level 1 oplocks breaks underway</span>
02183         <span class="comment">//  or batch oplock breaks underway we complete immediately.</span>
02184         <span class="comment">//</span>
02185 
02186         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a15">OPLOCK_BREAK_MASK</a> )) {
02187 
02188             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02189                        <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02190                        <span class="stringliteral">"No exclusive oplock break underway\n"</span>,
02191                        0);
02192 
02193             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_SUCCESS );
02194             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS );
02195 
02196         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a9">PENDING</a> )) {
02197 
02198             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02199             Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02200 
02201             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_SUCCESS );
02202             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS );
02203         }
02204 
02205         <span class="comment">//</span>
02206         <span class="comment">//  Otherwise we need to add this Irp to the list of Irp's waiting</span>
02207         <span class="comment">//  for the oplock break to complete.</span>
02208         <span class="comment">//</span>
02209 
02210         AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02211 
02212         <span class="comment">//</span>
02213         <span class="comment">//  Initialize the return value to status success.</span>
02214         <span class="comment">//</span>
02215 
02216         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_SUCCESS;
02217 
02218         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a49">FsRtlWaitOnIrp</a>( Oplock,
02219                                  <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
02220                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02221                                  <a class="code" href="../../d5/d2/oplock_8c.html#a55">FsRtlNotifyCompletion</a>,
02222                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02223                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02224 
02225     try_exit:  NOTHING;
02226     } finally {
02227 
02228         <span class="comment">//</span>
02229         <span class="comment">//  Give up the synchronization event if we haven't done so.</span>
02230         <span class="comment">//</span>
02231 
02232         <span class="keywordflow">if</span> (AcquiredMutex) {
02233 
02234             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02235         }
02236 
02237         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlOplockBreakNotify:  Exit -&gt; %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02238     }
02239 
02240     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02241 }
02242 
02243 
02244 <span class="comment">//</span>
02245 <span class="comment">//  Local support routine</span>
02246 <span class="comment">//</span>
02247 
02248 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02249"></a><a class="code" href="../../d5/d2/oplock_8c.html#a45">02249</a> <a class="code" href="../../d5/d2/oplock_8c.html#a45">FsRtlOplockCleanup</a> (
02250     IN OUT PNONOPAQUE_OPLOCK Oplock,
02251     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp
02252     )
02253 
02254 <span class="comment">/*++</span>
02255 <span class="comment"></span>
02256 <span class="comment">Routine Description:</span>
02257 <span class="comment"></span>
02258 <span class="comment">    This routine is called to coordinate a cleanup operation with the</span>
02259 <span class="comment">    oplock state for a file.  If there is no level 1 oplock for the</span>
02260 <span class="comment">    file, then there is no action to take.  If the file object in this</span>
02261 <span class="comment">    Irp matches the file object used in granting the level 1 oplock,</span>
02262 <span class="comment">    then the close operation will terminate the oplock.  If this</span>
02263 <span class="comment">    cleanup refers to a file object which has a level II oplock, then</span>
02264 <span class="comment">    that Irp is completed and removed from the list of level II</span>
02265 <span class="comment">    oplocked Irps.</span>
02266 <span class="comment"></span>
02267 <span class="comment"></span>
02268 <span class="comment">Arguments:</span>
02269 <span class="comment"></span>
02270 <span class="comment">    Oplock - Supplies a pointer to the non-opaque oplock structure for</span>
02271 <span class="comment">             this file.</span>
02272 <span class="comment"></span>
02273 <span class="comment">    IrpSp - This is the Irp stack location for the current Irp.</span>
02274 <span class="comment"></span>
02275 <span class="comment">Return Value:</span>
02276 <span class="comment"></span>
02277 <span class="comment">    None.</span>
02278 <span class="comment"></span>
02279 <span class="comment">--*/</span>
02280 
02281 {
02282     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlOplockCleanup:  Entered\n"</span>, 0 );
02283     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
02284     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"IrpSp     -&gt; %08lx\n"</span>, IrpSp );
02285 
02286     <span class="comment">//</span>
02287     <span class="comment">//  Grab the synchronization object for the oplock.</span>
02288     <span class="comment">//</span>
02289 
02290     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02291 
02292     <span class="comment">//</span>
02293     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
02294     <span class="comment">//</span>
02295 
02296     <span class="keywordflow">try</span> {
02297 
02298         <span class="comment">//</span>
02299         <span class="comment">//  If the oplock has no oplock held we return immediately.</span>
02300         <span class="comment">//</span>
02301 
02302         <span class="keywordflow">if</span> (Oplock-&gt;OplockState == <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>) {
02303 
02304             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02305                        <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02306                        <span class="stringliteral">"No oplocks on file\n"</span>,
02307                        0);
02308 
02309             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
02310         }
02311 
02312         <span class="comment">//</span>
02313         <span class="comment">//  If level II oplocks are held, check if this matches any of them.</span>
02314         <span class="comment">//</span>
02315 
02316         <span class="keywordflow">if</span> (Oplock-&gt;OplockState == <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>) {
02317 
02318             PLIST_ENTRY Link;
02319             <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
02320             <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> NextIrpSp;
02321 
02322             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02323                        <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02324                        <span class="stringliteral">"File has level 2 oplocks\n"</span>,
02325                        0);
02326 
02327             <span class="keywordflow">for</span> (Link = Oplock-&gt;IrpOplocksII.Flink;
02328                  Link != &amp;Oplock-&gt;IrpOplocksII;
02329                  Link = Link-&gt;Flink) {
02330 
02331                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = CONTAINING_RECORD( Link, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, Tail.Overlay.ListEntry );
02332 
02333                 NextIrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
02334 
02335                 <span class="comment">//</span>
02336                 <span class="comment">//  If the file objects match, then emove the entry found and complete the Irp.</span>
02337                 <span class="comment">//</span>
02338 
02339                 <span class="keywordflow">if</span> (IrpSp-&gt;FileObject == NextIrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>) {
02340 
02341                     <span class="comment">//</span>
02342                     <span class="comment">//  Back up to remember this link.</span>
02343                     <span class="comment">//</span>
02344 
02345                     Link = Link-&gt;Blink;
02346 
02347                     <span class="comment">//</span>
02348                     <span class="comment">//</span>
02349 
02350                     <a class="code" href="../../d5/d2/oplock_8c.html#a48">FsRtlRemoveAndCompleteIrp</a>( Link-&gt;Flink );
02351                 }
02352             }
02353 
02354             <span class="comment">//</span>
02355             <span class="comment">//  If all the level II oplocks are gone, then the state is</span>
02356             <span class="comment">//  no oplocks held.</span>
02357             <span class="comment">//</span>
02358 
02359             <span class="keywordflow">if</span> (IsListEmpty( &amp;Oplock-&gt;IrpOplocksII )) {
02360 
02361                 Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02362             }
02363 
02364             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
02365         }
02366 
02367         <span class="comment">//</span>
02368         <span class="comment">//  If this file object matches that used to request an exclusive</span>
02369         <span class="comment">//  oplock, we completely close the oplock break.</span>
02370         <span class="comment">//</span>
02371 
02372         <span class="keywordflow">if</span> (IrpSp-&gt;FileObject == Oplock-&gt;FileObject) {
02373 
02374             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02375                        <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02376                        <span class="stringliteral">"Handle owns level 1 oplock\n"</span>,
02377                        0);
02378 
02379             <span class="comment">//</span>
02380             <span class="comment">//  If an oplock break is not in progress, we initiate one and</span>
02381             <span class="comment">//  complete the exclusive Irp immediately.</span>
02382             <span class="comment">//</span>
02383 
02384             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a15">OPLOCK_BREAK_MASK</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a9">PENDING</a> )) {
02385 
02386                 <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> ExclusiveIrp = Oplock-&gt;IrpExclusiveOplock;
02387 
02388                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02389                            <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02390                            <span class="stringliteral">"Initiate oplock break\n"</span>,
02391                            0);
02392 
02393                 <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;ExclusiveIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
02394 
02395                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( ExclusiveIrp, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02396                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( ExclusiveIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
02397 
02398                 ExclusiveIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
02399 
02400                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Oplock-&gt;IrpExclusiveOplock, STATUS_SUCCESS );
02401 
02402                 Oplock-&gt;IrpExclusiveOplock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02403             }
02404 
02405             <span class="comment">//</span>
02406             <span class="comment">//  Clean up the oplock structure and complete all waiting Irps.</span>
02407             <span class="comment">//  Don't do this if this is a pending opfilter request.</span>
02408             <span class="comment">//</span>
02409 
02410             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a9">PENDING</a> )) {
02411 
02412                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( IrpSp-&gt;FileObject );
02413             }
02414 
02415             Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02416             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02417 
02418             <span class="keywordflow">while</span> (!IsListEmpty( &amp;Oplock-&gt;WaitingIrps )) {
02419 
02420                 <a class="code" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a> WaitingIrp;
02421 
02422                 <span class="comment">//</span>
02423                 <span class="comment">//  Remove the entry found and complete the Irp.</span>
02424                 <span class="comment">//</span>
02425 
02426                 WaitingIrp = CONTAINING_RECORD( Oplock-&gt;WaitingIrps.Flink,
02427                                                 <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>,
02428                                                 Links );
02429 
02430                 <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a>( WaitingIrp );
02431             }
02432         }
02433 
02434     try_exit:  NOTHING;
02435     } finally {
02436 
02437         <span class="comment">//</span>
02438         <span class="comment">//  Give up the oplock synchronization object.</span>
02439         <span class="comment">//</span>
02440 
02441         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02442         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlOplockCleanup:  Exit\n"</span>, 0 );
02443     }
02444 
02445     <span class="keywordflow">return</span>;
02446 }
02447 
02448 
02449 <span class="comment">//</span>
02450 <span class="comment">//  Local support routine</span>
02451 <span class="comment">//</span>
02452 
02453 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02454"></a><a class="code" href="../../d5/d2/oplock_8c.html#a46">02454</a> <a class="code" href="../../d5/d2/oplock_8c.html#a46">FsRtlOplockBreakToII</a> (
02455     IN OUT PNONOPAQUE_OPLOCK Oplock,
02456     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
02457     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
02458     IN PVOID Context,
02459     IN POPLOCK_WAIT_COMPLETE_ROUTINE CompletionRoutine OPTIONAL,
02460     IN POPLOCK_FS_PREPOST_IRP PostIrpRoutine
02461     )
02462 
02463 <span class="comment">/*++</span>
02464 <span class="comment"></span>
02465 <span class="comment">Routine Description:</span>
02466 <span class="comment"></span>
02467 <span class="comment">    This routine is a generic worker routine which is called when an</span>
02468 <span class="comment">    operation will cause all oplocks to be broken to level II before the</span>
02469 <span class="comment">    operation can proceed.</span>
02470 <span class="comment"></span>
02471 <span class="comment">Arguments:</span>
02472 <span class="comment"></span>
02473 <span class="comment">    Oplock - Supplies a pointer to the non-opaque oplock structure for</span>
02474 <span class="comment">             this file.</span>
02475 <span class="comment"></span>
02476 <span class="comment">    IrpSp - This is the Irp stack location for the current Irp.</span>
02477 <span class="comment"></span>
02478 <span class="comment">    Irp - Supplies a pointer to the Irp which declares the requested</span>
02479 <span class="comment">          operation.</span>
02480 <span class="comment"></span>
02481 <span class="comment">    Context - This value is passed as a parameter to the completion routine.</span>
02482 <span class="comment"></span>
02483 <span class="comment">    CompletionRoutine - This is the routine which is called if this</span>
02484 <span class="comment">                        Irp must wait for an Oplock to break.  This</span>
02485 <span class="comment">                        is a synchronous operation if not specified</span>
02486 <span class="comment">                        and we block in this thread waiting on</span>
02487 <span class="comment">                        an event.</span>
02488 <span class="comment"></span>
02489 <span class="comment">    PostIrpRoutine - This is the routine to call before we put anything</span>
02490 <span class="comment">                     on our waiting Irp queue.</span>
02491 <span class="comment"></span>
02492 <span class="comment">Return Value:</span>
02493 <span class="comment"></span>
02494 <span class="comment">    STATUS_SUCCESS if we can complete the operation on exiting this thread.</span>
02495 <span class="comment">    STATUS_PENDING if we return here but hold the Irp.</span>
02496 <span class="comment">    STATUS_CANCELLED if the Irp is cancelled before we return.</span>
02497 <span class="comment"></span>
02498 <span class="comment">--*/</span>
02499 
02500 {
02501     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
02502     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02503 
02504     BOOLEAN AcquiredMutex;
02505 
02506     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"CheckOplockBreakToII:  Entered\n"</span>, 0 );
02507     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
02508     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"IrpSp     -&gt; %08lx\n"</span>, IrpSp );
02509     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Irp       -&gt; %08lx\n"</span>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
02510 
02511     <span class="comment">//</span>
02512     <span class="comment">//  Grap the synchronization object.</span>
02513     <span class="comment">//</span>
02514 
02515     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02516     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02517 
02518     <span class="comment">//</span>
02519     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
02520     <span class="comment">//</span>
02521 
02522     <span class="keywordflow">try</span> {
02523 
02524         <span class="comment">//</span>
02525         <span class="comment">//  If there are no outstanding oplocks or level II oplocks are held,</span>
02526         <span class="comment">//  we can return immediately.</span>
02527         <span class="comment">//</span>
02528 
02529         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a8">EXCLUSIVE</a> )) {
02530 
02531             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02532                        <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02533                        <span class="stringliteral">"No oplocks or level II oplocks on file\n"</span>,
02534                        0);
02535 
02536             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS );
02537         }
02538 
02539         <span class="comment">//</span>
02540         <span class="comment">//  At this point there is an exclusive oplock break in progress.</span>
02541         <span class="comment">//  If this file object owns that oplock, we allow the operation</span>
02542         <span class="comment">//  to continue.</span>
02543         <span class="comment">//</span>
02544 
02545         <span class="keywordflow">if</span> (Oplock-&gt;FileObject == IrpSp-&gt;FileObject) {
02546 
02547             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02548                        <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02549                        <span class="stringliteral">"Handle owns level 1 oplock\n"</span>,
02550                        0);
02551 
02552             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS );
02553         }
02554 
02555         <span class="comment">//</span>
02556         <span class="comment">//  If there is currently an exclusive oplock held then complete</span>
02557         <span class="comment">//  the exclusive irp.</span>
02558         <span class="comment">//</span>
02559 
02560         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a9">PENDING</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a15">OPLOCK_BREAK_MASK</a> )) {
02561 
02562             <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> IrpExclusive = Oplock-&gt;IrpExclusiveOplock;
02563 
02564             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02565                        <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02566                        <span class="stringliteral">"Breaking exclusive oplock\n"</span>,
02567                        0);
02568 
02569             <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
02570             <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( IrpExclusive, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02571             <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
02572 
02573             <span class="comment">//</span>
02574             <span class="comment">//  If the Irp has been cancelled, we complete the Irp with</span>
02575             <span class="comment">//  status cancelled and break the oplock completely.</span>
02576             <span class="comment">//</span>
02577 
02578             <span class="keywordflow">if</span> (IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
02579 
02580                 IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
02581                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( IrpExclusive, STATUS_CANCELLED );
02582                 Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02583                 Oplock-&gt;IrpExclusiveOplock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02584 
02585                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Oplock-&gt;FileObject );
02586                 Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02587 
02588                 <span class="comment">//</span>
02589                 <span class="comment">//  Release any waiting irps.</span>
02590                 <span class="comment">//</span>
02591 
02592                 <span class="keywordflow">while</span> (!IsListEmpty( &amp;Oplock-&gt;WaitingIrps )) {
02593 
02594                     <a class="code" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a> WaitingIrp;
02595 
02596                     WaitingIrp = CONTAINING_RECORD( Oplock-&gt;WaitingIrps.Flink,
02597                                                     <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>,
02598                                                     Links );
02599 
02600                     <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a>( WaitingIrp );
02601                 }
02602 
02603                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS );
02604 
02605             } <span class="keywordflow">else</span> {
02606 
02607                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> CompletionStatus;
02608 
02609                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a3">LEVEL_I_OPLOCK</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a4">BATCH_OPLOCK</a> )) {
02610 
02611                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a11">BREAK_TO_II</a> );
02612                     CompletionStatus = FILE_OPLOCK_BROKEN_TO_LEVEL_2;
02613 
02614                 } <span class="keywordflow">else</span> {
02615 
02616                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a12">BREAK_TO_NONE</a> );
02617                     CompletionStatus = FILE_OPLOCK_BROKEN_TO_NONE;
02618                 }
02619 
02620                 Oplock-&gt;IrpExclusiveOplock-&gt;IoStatus.Information = CompletionStatus;
02621                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Oplock-&gt;IrpExclusiveOplock, STATUS_SUCCESS );
02622                 Oplock-&gt;IrpExclusiveOplock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02623             }
02624 
02625         <span class="comment">//</span>
02626         <span class="comment">//  If there is a pending opfilter request then clear the request.</span>
02627         <span class="comment">//</span>
02628 
02629         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a9">PENDING</a> )) {
02630 
02631             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02632             Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02633 
02634             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS );
02635         }
02636 
02637         <span class="comment">//</span>
02638         <span class="comment">//  If this is an open operation and the user doesn't want to</span>
02639         <span class="comment">//  block, we will complete the operation now.</span>
02640         <span class="comment">//</span>
02641 
02642         <span class="keywordflow">if</span> ((IrpSp-&gt;MajorFunction == <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>) &amp;&amp;
02643             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;Parameters.Create.Options, FILE_COMPLETE_IF_OPLOCKED )) {
02644 
02645             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Don't block open\n"</span>, 0 );
02646 
02647             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OPLOCK_BREAK_IN_PROGRESS );
02648         }
02649 
02650         <span class="comment">//</span>
02651         <span class="comment">//  If we get here that means that this operation can't continue</span>
02652         <span class="comment">//  until the oplock break is complete.</span>
02653         <span class="comment">//</span>
02654         <span class="comment">//  FsRtlWaitOnIrp will release the mutex.</span>
02655         <span class="comment">//</span>
02656 
02657         AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02658 
02659         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a49">FsRtlWaitOnIrp</a>( Oplock,
02660                                  <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
02661                                  Context,
02662                                  CompletionRoutine,
02663                                  PostIrpRoutine,
02664                                  &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> );
02665 
02666     try_exit:  NOTHING;
02667     } finally {
02668 
02669         <span class="comment">//</span>
02670         <span class="comment">//  Give up the synchronization event if we haven't done so.</span>
02671         <span class="comment">//</span>
02672 
02673         <span class="keywordflow">if</span> (AcquiredMutex) {
02674 
02675             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02676         }
02677 
02678         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlOplockBreakToII:  Exit -&gt; %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02679     }
02680 
02681     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02682 }
02683 
02684 
02685 <span class="comment">//</span>
02686 <span class="comment">//  Local support routine.</span>
02687 <span class="comment">//</span>
02688 
02689 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02690"></a><a class="code" href="../../d5/d2/oplock_8c.html#a47">02690</a> <a class="code" href="../../d5/d2/oplock_8c.html#a47">FsRtlOplockBreakToNone</a> (
02691     IN OUT PNONOPAQUE_OPLOCK Oplock,
02692     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
02693     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
02694     IN PVOID Context,
02695     IN POPLOCK_WAIT_COMPLETE_ROUTINE CompletionRoutine OPTIONAL,
02696     IN POPLOCK_FS_PREPOST_IRP PostIrpRoutine OPTIONAL
02697     )
02698 
02699 <span class="comment">/*++</span>
02700 <span class="comment"></span>
02701 <span class="comment">Routine Description:</span>
02702 <span class="comment"></span>
02703 <span class="comment">    This routine is a generic worker routine which is called when an</span>
02704 <span class="comment">    operation will cause all oplocks to be broken before the operation can</span>
02705 <span class="comment">    proceed.</span>
02706 <span class="comment"></span>
02707 <span class="comment">Arguments:</span>
02708 <span class="comment"></span>
02709 <span class="comment">    Oplock - Supplies a pointer to the non-opaque oplock structure for</span>
02710 <span class="comment">             this file.</span>
02711 <span class="comment"></span>
02712 <span class="comment">    IrpSp - This is the Irp stack location for the current Irp.</span>
02713 <span class="comment"></span>
02714 <span class="comment">    Irp - Supplies a pointer to the Irp which declares the requested</span>
02715 <span class="comment">          operation.</span>
02716 <span class="comment"></span>
02717 <span class="comment">    Context - This value is passed as a parameter to the completion routine.</span>
02718 <span class="comment"></span>
02719 <span class="comment">    CompletionRoutine - This is the routine which is called if this</span>
02720 <span class="comment">                        Irp must wait for an Oplock to break.  This</span>
02721 <span class="comment">                        is a synchronous operation if not specified</span>
02722 <span class="comment">                        and we block in this thread waiting on</span>
02723 <span class="comment">                        an event.</span>
02724 <span class="comment"></span>
02725 <span class="comment">    PostIrpRoutine - This is the routine to call before we put anything</span>
02726 <span class="comment">                     on our waiting Irp queue.</span>
02727 <span class="comment"></span>
02728 <span class="comment">Return Value:</span>
02729 <span class="comment"></span>
02730 <span class="comment">    STATUS_SUCCESS if we can complete the operation on exiting this thread.</span>
02731 <span class="comment">    STATUS_PENDING if we return here but hold the Irp.</span>
02732 <span class="comment">    STATUS_CANCELLED if the Irp is cancelled before we return.</span>
02733 <span class="comment"></span>
02734 <span class="comment">--*/</span>
02735 
02736 {
02737     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
02738     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02739 
02740     BOOLEAN AcquiredMutex;
02741 
02742     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"CheckOplockBreakToNone:  Entered\n"</span>, 0 );
02743     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
02744     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"IrpSp     -&gt; %08lx\n"</span>, IrpSp );
02745     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Irp       -&gt; %08lx\n"</span>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
02746 
02747     <span class="comment">//</span>
02748     <span class="comment">//  Grap the synchronization object.</span>
02749     <span class="comment">//</span>
02750 
02751     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02752     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02753 
02754     <span class="comment">//</span>
02755     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
02756     <span class="comment">//</span>
02757 
02758     <span class="keywordflow">try</span> {
02759 
02760         <span class="comment">//</span>
02761         <span class="comment">//  If there are no outstanding oplocks, we can return immediately.</span>
02762         <span class="comment">//</span>
02763 
02764         <span class="keywordflow">if</span> (Oplock-&gt;OplockState == <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>) {
02765 
02766             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02767                        <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02768                        <span class="stringliteral">"No oplocks on file\n"</span>,
02769                        0);
02770 
02771             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS );
02772         }
02773 
02774         <span class="comment">//</span>
02775         <span class="comment">//  If there is an exclusive oplock held, we begin the break to none.</span>
02776         <span class="comment">//</span>
02777 
02778         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState,
02779                      <a class="code" href="../../d5/d2/oplock_8c.html#a6">LEVEL_II_OPLOCK</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a9">PENDING</a> | <a class="code" href="../../d5/d2/oplock_8c.html#a15">OPLOCK_BREAK_MASK</a> )) {
02780 
02781             <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> IrpExclusive = Oplock-&gt;IrpExclusiveOplock;
02782 
02783             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02784                        <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02785                        <span class="stringliteral">"Breaking exclusive oplock\n"</span>,
02786                        0);
02787 
02788             <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
02789             <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( IrpExclusive, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02790             <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
02791 
02792             <span class="comment">//</span>
02793             <span class="comment">//  If the Irp has been cancelled, we complete the Irp with</span>
02794             <span class="comment">//  status cancelled and break the oplock completely.</span>
02795             <span class="comment">//</span>
02796 
02797             <span class="keywordflow">if</span> (IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
02798 
02799                 IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
02800                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( IrpExclusive, STATUS_CANCELLED );
02801                 Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02802                 Oplock-&gt;IrpExclusiveOplock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02803 
02804                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Oplock-&gt;FileObject );
02805                 Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02806 
02807                 <span class="comment">//</span>
02808                 <span class="comment">//  Release any waiting irps.</span>
02809                 <span class="comment">//</span>
02810 
02811                 <span class="keywordflow">while</span> (!IsListEmpty( &amp;Oplock-&gt;WaitingIrps )) {
02812 
02813                     <a class="code" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a> WaitingIrp;
02814 
02815                     WaitingIrp = CONTAINING_RECORD( Oplock-&gt;WaitingIrps.Flink,
02816                                                     <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>,
02817                                                     Links );
02818 
02819                     <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a>( WaitingIrp );
02820                 }
02821 
02822                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS );
02823 
02824             } <span class="keywordflow">else</span> {
02825 
02826                 Oplock-&gt;IrpExclusiveOplock-&gt;IoStatus.Information = FILE_OPLOCK_BROKEN_TO_NONE;
02827                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Oplock-&gt;IrpExclusiveOplock, STATUS_SUCCESS );
02828                 Oplock-&gt;IrpExclusiveOplock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02829 
02830                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a12">BREAK_TO_NONE</a> );
02831             }
02832 
02833         <span class="comment">//</span>
02834         <span class="comment">//  If there are level II oplocks, this will break all of them.</span>
02835         <span class="comment">//</span>
02836 
02837         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Oplock-&gt;OplockState == <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>) {
02838 
02839             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02840                        <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02841                        <span class="stringliteral">"Breaking all level 2 oplocks\n"</span>,
02842                        0);
02843 
02844             <span class="keywordflow">while</span> (!IsListEmpty( &amp;Oplock-&gt;IrpOplocksII )) {
02845 
02846                 <span class="comment">//</span>
02847                 <span class="comment">//  Remove and complete this Irp with STATUS_SUCCESS.</span>
02848                 <span class="comment">//</span>
02849 
02850                 <a class="code" href="../../d5/d2/oplock_8c.html#a48">FsRtlRemoveAndCompleteIrp</a>( Oplock-&gt;IrpOplocksII.Flink );
02851             }
02852 
02853             <span class="comment">//</span>
02854             <span class="comment">//  Set the oplock state to no oplocks held.</span>
02855             <span class="comment">//</span>
02856 
02857             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02858 
02859             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS );
02860 
02861         <span class="comment">//</span>
02862         <span class="comment">//  If we are currently breaking to level II then change that</span>
02863         <span class="comment">//  to BreakToIIToNone.</span>
02864         <span class="comment">//</span>
02865 
02866         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a11">BREAK_TO_II</a> )) {
02867 
02868             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a11">BREAK_TO_II</a> );
02869             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a13">BREAK_TO_II_TO_NONE</a> );
02870 
02871         <span class="comment">//</span>
02872         <span class="comment">//  If there is a pending opfilter request then clear that request.</span>
02873         <span class="comment">//</span>
02874 
02875         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, <a class="code" href="../../d5/d2/oplock_8c.html#a9">PENDING</a> )) {
02876 
02877             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02878             Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02879 
02880             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS );
02881         }
02882 
02883         <span class="comment">//</span>
02884         <span class="comment">//  At this point there is already an exclusive oplock break in progress.</span>
02885         <span class="comment">//  If this file object owns that oplock, we allow the operation</span>
02886         <span class="comment">//  to continue.</span>
02887         <span class="comment">//</span>
02888 
02889         <span class="keywordflow">if</span> (Oplock-&gt;FileObject == IrpSp-&gt;FileObject) {
02890 
02891             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02892                        <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02893                        <span class="stringliteral">"Handle owns level 1 oplock\n"</span>,
02894                        0);
02895 
02896             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS );
02897         }
02898 
02899         <span class="comment">//</span>
02900         <span class="comment">//  If this is an open operation and the user doesn't want to</span>
02901         <span class="comment">//  block, we will complete the operation now.</span>
02902         <span class="comment">//</span>
02903 
02904         <span class="keywordflow">if</span> ((IrpSp-&gt;MajorFunction == <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>) &amp;&amp;
02905             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;Parameters.Create.Options, FILE_COMPLETE_IF_OPLOCKED )) {
02906 
02907             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Don't block open\n"</span>, 0 );
02908 
02909             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OPLOCK_BREAK_IN_PROGRESS );
02910         }
02911 
02912         <span class="comment">//</span>
02913         <span class="comment">//  If we get here that means that this operation can't continue</span>
02914         <span class="comment">//  until the oplock break is complete.</span>
02915         <span class="comment">//</span>
02916         <span class="comment">//  FsRtlWaitOnIrp will release the mutex.</span>
02917         <span class="comment">//</span>
02918 
02919         AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02920 
02921         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a49">FsRtlWaitOnIrp</a>( Oplock,
02922                                  <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
02923                                  Context,
02924                                  CompletionRoutine,
02925                                  PostIrpRoutine,
02926                                  &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> );
02927 
02928     try_exit:  NOTHING;
02929     } finally {
02930 
02931         <span class="comment">//</span>
02932         <span class="comment">//  Give up the synchronization event if we haven't done so.</span>
02933         <span class="comment">//</span>
02934 
02935         <span class="keywordflow">if</span> (AcquiredMutex) {
02936 
02937             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02938         }
02939 
02940         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"CheckOplockBreakToNone:  Exit -&gt; %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02941     }
02942 
02943     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02944 }
02945 
02946 
02947 <span class="comment">//</span>
02948 <span class="comment">//  Local support routine.</span>
02949 <span class="comment">//</span>
02950 
02951 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02952"></a><a class="code" href="../../d5/d2/oplock_8c.html#a48">02952</a> <a class="code" href="../../d5/d2/oplock_8c.html#a48">FsRtlRemoveAndCompleteIrp</a> (
02953     IN PLIST_ENTRY Link
02954     )
02955 
02956 <span class="comment">/*++</span>
02957 <span class="comment"></span>
02958 <span class="comment">Routine Description:</span>
02959 <span class="comment"></span>
02960 <span class="comment">    This routine is called to remove an Irp from a list of Irps linked</span>
02961 <span class="comment">    with the Tail.ListEntry field and complete them with STATUS_CANCELLED</span>
02962 <span class="comment">    if the Irp has been cancelled, STATUS_SUCCESS otherwise.</span>
02963 <span class="comment"></span>
02964 <span class="comment">Arguments:</span>
02965 <span class="comment"></span>
02966 <span class="comment">    Link - Supplies the entry to remove from the list.</span>
02967 <span class="comment"></span>
02968 <span class="comment">Return Value:</span>
02969 <span class="comment"></span>
02970 <span class="comment">    None.</span>
02971 <span class="comment"></span>
02972 <span class="comment">--*/</span>
02973 
02974 {
02975     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
02976     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> OplockIIIrpSp;
02977 
02978     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlRemoveAndCompleteIrp:  Entered\n"</span>, 0 );
02979 
02980     <span class="comment">//</span>
02981     <span class="comment">//  Reference the Irp.</span>
02982     <span class="comment">//</span>
02983 
02984     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = CONTAINING_RECORD( Link, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, Tail.Overlay.ListEntry );
02985 
02986     <span class="comment">//</span>
02987     <span class="comment">//  Get the stack location and dereference the file object.</span>
02988     <span class="comment">//</span>
02989 
02990     OplockIIIrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
02991     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( OplockIIIrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> );
02992 
02993     <span class="comment">//</span>
02994     <span class="comment">//  Clear the cancel routine in the irp.</span>
02995     <span class="comment">//</span>
02996 
02997     <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
02998 
02999     <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03000     <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03001 
03002     <span class="comment">//</span>
03003     <span class="comment">// Remove this from the list.</span>
03004     <span class="comment">//</span>
03005 
03006     RemoveEntryList( Link );
03007 
03008     <span class="comment">//</span>
03009     <span class="comment">//  Complete the oplock Irp.</span>
03010     <span class="comment">//</span>
03011 
03012     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
03013 
03014     <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a> ? STATUS_CANCELLED : STATUS_SUCCESS );
03015 
03016     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlRemoveAndCompleteIrp:  Exit\n"</span>, 0 );
03017 }
03018 
03019 
03020 <span class="comment">//</span>
03021 <span class="comment">//  Local support routine.</span>
03022 <span class="comment">//</span>
03023 
03024 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03025"></a><a class="code" href="../../d5/d2/oplock_8c.html#a49">03025</a> <a class="code" href="../../d5/d2/oplock_8c.html#a49">FsRtlWaitOnIrp</a> (
03026     IN OUT PNONOPAQUE_OPLOCK Oplock,
03027     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
03028     IN PVOID Context,
03029     IN POPLOCK_WAIT_COMPLETE_ROUTINE CompletionRoutine OPTIONAL,
03030     IN POPLOCK_FS_PREPOST_IRP PostIrpRoutine OPTIONAL,
03031     IN <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event
03032     )
03033 
03034 <span class="comment">/*++</span>
03035 <span class="comment"></span>
03036 <span class="comment">Routine Description:</span>
03037 <span class="comment"></span>
03038 <span class="comment">    This routine is called to create a Wait Irp structure and attach it</span>
03039 <span class="comment">    to the current Irp.  The Irp is then added to the list of Irps waiting</span>
03040 <span class="comment">    for an oplock break.  We check if the Irp has been cancelled and if</span>
03041 <span class="comment">    so we call our cancel routine to perform the work.</span>
03042 <span class="comment"></span>
03043 <span class="comment">    This routine is holding the Mutex for the oplock on entry and</span>
03044 <span class="comment">    must give it up on exit.</span>
03045 <span class="comment"></span>
03046 <span class="comment">Arguments:</span>
03047 <span class="comment"></span>
03048 <span class="comment">    Oplock - Supplies a pointer to the non-opaque oplock structure for</span>
03049 <span class="comment">             this file.</span>
03050 <span class="comment"></span>
03051 <span class="comment">    Irp - Supplies a pointer to the Irp which declares the requested</span>
03052 <span class="comment">          operation.</span>
03053 <span class="comment"></span>
03054 <span class="comment">    Context - This value is passed as a parameter to the completion routine.</span>
03055 <span class="comment"></span>
03056 <span class="comment">    CompletionRoutine - This is the routine which is called if this</span>
03057 <span class="comment">                        Irp must wait for an Oplock to break.  This</span>
03058 <span class="comment">                        is a synchronous operation if not specified</span>
03059 <span class="comment">                        and we block in this thread waiting on</span>
03060 <span class="comment">                        an event.</span>
03061 <span class="comment"></span>
03062 <span class="comment">    PostIrpRoutine - This is the routine to call before we put anything</span>
03063 <span class="comment">                     on our waiting Irp queue.</span>
03064 <span class="comment"></span>
03065 <span class="comment">    Event - If there is no user completion routine, this thread will</span>
03066 <span class="comment">            block using this event.</span>
03067 <span class="comment"></span>
03068 <span class="comment">Return Value:</span>
03069 <span class="comment"></span>
03070 <span class="comment">    STATUS_SUCCESS if we can complete the operation on exiting this thread.</span>
03071 <span class="comment">    STATUS_PENDING if we return here but hold the Irp.</span>
03072 <span class="comment">    STATUS_CANCELLED if the Irp is cancelled before we return.</span>
03073 <span class="comment"></span>
03074 <span class="comment">--*/</span>
03075 
03076 {
03077     BOOLEAN AcquiredMutex;
03078     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03079 
03080     <a class="code" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a> WaitingIrp;
03081 
03082     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlWaitOnIrp:   Entered\n"</span>, 0 );
03083 
03084     <span class="comment">//</span>
03085     <span class="comment">//  Remember that we have the mutex.</span>
03086     <span class="comment">//</span>
03087 
03088     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03089 
03090     <span class="comment">//</span>
03091     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
03092     <span class="comment">//</span>
03093 
03094     <span class="keywordflow">try</span> {
03095 
03096         <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> OplockFastMutex = Oplock-&gt;FastMutex;
03097 
03098         <span class="comment">//</span>
03099         <span class="comment">//  Allocate and initialize the Wait Irp structure.</span>
03100         <span class="comment">//</span>
03101 
03102         WaitingIrp = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a> ));
03103 
03104         WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o1">Irp</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
03105 
03106         WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o3">Context</a> = Context;
03107         WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o5">Information</a> = (ULONG) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
03108 
03109         <span class="comment">//</span>
03110         <span class="comment">//  Take appropriate action if depending on the value of the</span>
03111         <span class="comment">//  completion routine.</span>
03112         <span class="comment">//</span>
03113 
03114         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( CompletionRoutine )) {
03115 
03116             WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o2">CompletionRoutine</a> = CompletionRoutine;
03117             WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o3">Context</a> = Context;
03118 
03119         } <span class="keywordflow">else</span> {
03120 
03121             WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o2">CompletionRoutine</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a50">FsRtlCompletionRoutinePriv</a>;
03122             WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o3">Context</a> = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
03123 
03124             <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03125         }
03126 
03127         <span class="comment">//</span>
03128         <span class="comment">//  Call the file system's post Irp code.</span>
03129         <span class="comment">//</span>
03130 
03131         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( PostIrpRoutine )) {
03132 
03133             PostIrpRoutine( Context, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
03134         }
03135 
03136         <span class="comment">//</span>
03137         <span class="comment">//  Initialize the return value to status success.</span>
03138         <span class="comment">//</span>
03139 
03140         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_SUCCESS;
03141 
03142         <span class="comment">//</span>
03143         <span class="comment">//  We put this into the Waiting Irp queue.</span>
03144         <span class="comment">//</span>
03145 
03146         InsertTailList( &amp;Oplock-&gt;WaitingIrps, &amp;WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o0">Links</a> );
03147 
03148         <span class="comment">//</span>
03149         <span class="comment">//  We grab the cancel spinlock and store the address of the oplock.</span>
03150         <span class="comment">//</span>
03151 
03152         <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03153         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = (ULONG_PTR) Oplock;
03154 
03155         <span class="comment">//</span>
03156         <span class="comment">//  If the Irp is cancelled then we'll call the cancel routine</span>
03157         <span class="comment">//  right now to do away with the Waiting Irp structure.</span>
03158         <span class="comment">//</span>
03159 
03160         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
03161 
03162             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( OplockFastMutex );
03163             AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03164 
03165             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( CompletionRoutine )) {
03166 
03167                 <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
03168                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PENDING;
03169 
03170             } <span class="keywordflow">else</span> {
03171 
03172                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CANCELLED;
03173             }
03174 
03175             <a class="code" href="../../d5/d2/oplock_8c.html#a51">FsRtlCancelWaitIrp</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
03176 
03177         <span class="comment">//</span>
03178         <span class="comment">//  Otherwise, we set the cancel routine and decide whether we</span>
03179         <span class="comment">//  are going to wait on our local event.</span>
03180         <span class="comment">//</span>
03181 
03182         } <span class="keywordflow">else</span> {
03183 
03184             <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d5/d2/oplock_8c.html#a51">FsRtlCancelWaitIrp</a> );
03185             <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03186 
03187             <span class="comment">//</span>
03188             <span class="comment">//  If we wait on the event, we pull the return code out of</span>
03189             <span class="comment">//  the Irp.</span>
03190             <span class="comment">//</span>
03191 
03192             <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( CompletionRoutine )) {
03193 
03194                 AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03195 
03196                 <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
03197 
03198                 <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
03199                                        <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
03200                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03201                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03202                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03203 
03204                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
03205 
03206             <span class="comment">//</span>
03207             <span class="comment">//  Otherwise, we return STATUS_PENDING.</span>
03208             <span class="comment">//</span>
03209 
03210             } <span class="keywordflow">else</span> {
03211 
03212                 <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
03213 
03214                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PENDING;
03215             }
03216         }
03217 
03218     } finally {
03219 
03220         <span class="comment">//</span>
03221         <span class="comment">//  Release the Mutex if we have not done so.</span>
03222         <span class="comment">//</span>
03223 
03224         <span class="keywordflow">if</span> (AcquiredMutex) {
03225 
03226             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
03227         }
03228 
03229         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlWaitOnIrp:   Exit\n"</span>, 0 );
03230     }
03231 
03232     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03233 }
03234 
03235 
03236 <span class="comment">//</span>
03237 <span class="comment">//  Local support routine.</span>
03238 <span class="comment">//</span>
03239 
03240 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03241"></a><a class="code" href="../../d5/d2/oplock_8c.html#a50">03241</a> <a class="code" href="../../d5/d2/oplock_8c.html#a50">FsRtlCompletionRoutinePriv</a> (
03242     IN PVOID Context,
03243     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
03244     )
03245 
03246 <span class="comment">/*++</span>
03247 <span class="comment"></span>
03248 <span class="comment">Routine Description:</span>
03249 <span class="comment"></span>
03250 <span class="comment">    This routine is called when an operation must be synchronous with</span>
03251 <span class="comment">    respect to the oplock package.  This routine will simply set the</span>
03252 <span class="comment">    event in the Signalled state, allowing some other thread to resume</span>
03253 <span class="comment">    execution.</span>
03254 <span class="comment"></span>
03255 <span class="comment">Arguments:</span>
03256 <span class="comment"></span>
03257 <span class="comment">    Context - This is the event to signal.</span>
03258 <span class="comment"></span>
03259 <span class="comment">    Irp - Supplies a pointer to the Irp which declares the requested</span>
03260 <span class="comment">          operation.</span>
03261 <span class="comment"></span>
03262 <span class="comment">Return Value:</span>
03263 <span class="comment"></span>
03264 <span class="comment">    None.</span>
03265 <span class="comment"></span>
03266 <span class="comment">--*/</span>
03267 
03268 {
03269     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03270 
03271     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCompletionRoutinePriv:  Entered\n"</span>, 0 );
03272 
03273     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)Context, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03274 
03275     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCompletionRoutinePriv:  Exit\n"</span>, 0 );
03276 
03277     <span class="keywordflow">return</span>;
03278 
03279     UNREFERENCED_PARAMETER( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
03280 }
03281 
03282 
03283 <span class="comment">//</span>
03284 <span class="comment">//  Local support routine.</span>
03285 <span class="comment">//</span>
03286 
03287 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03288"></a><a class="code" href="../../d5/d2/oplock_8c.html#a51">03288</a> <a class="code" href="../../d5/d2/oplock_8c.html#a51">FsRtlCancelWaitIrp</a> (
03289     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
03290     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
03291     )
03292 
03293 <span class="comment">/*++</span>
03294 <span class="comment"></span>
03295 <span class="comment">Routine Description:</span>
03296 <span class="comment"></span>
03297 <span class="comment">    This routine is called for an Irp that is placed on the waiting</span>
03298 <span class="comment">    Irp queue.  We remove the Cancel routine from the specified Irp and</span>
03299 <span class="comment">    then call the completion routines for all the cancelled Irps on the</span>
03300 <span class="comment">    queue.</span>
03301 <span class="comment"></span>
03302 <span class="comment">Arguments:</span>
03303 <span class="comment"></span>
03304 <span class="comment">    DeviceObject - Ignored.</span>
03305 <span class="comment"></span>
03306 <span class="comment">    Irp - Supplies the Irp being cancelled.  A pointer to the</span>
03307 <span class="comment">          Oplock structure for the Irp is stored in the information</span>
03308 <span class="comment">          field of the Irp's Iosb.</span>
03309 <span class="comment"></span>
03310 <span class="comment">Return Value:</span>
03311 <span class="comment"></span>
03312 <span class="comment">    None.</span>
03313 <span class="comment"></span>
03314 <span class="comment">--*/</span>
03315 
03316 {
03317     <a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a> Oplock;
03318 
03319     PLIST_ENTRY Links;
03320 
03321     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCancelWaitIrp:  Entered\n"</span>, 0 );
03322 
03323     Oplock = (<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
03324 
03325     <span class="comment">//</span>
03326     <span class="comment">//  We now need to void the cancel routine and release the spinlock</span>
03327     <span class="comment">//</span>
03328 
03329     <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03330     <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03331 
03332     <span class="comment">//</span>
03333     <span class="comment">//  Iterate through all of the waiting locks looking for a canceled one</span>
03334     <span class="comment">//  We do this under the protection of the oplock mutex.</span>
03335     <span class="comment">//</span>
03336 
03337     ExAcquireFastMutex( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
03338 
03339     <span class="keywordflow">try</span> {
03340 
03341         <span class="keywordflow">for</span> (Links = Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a>.Flink;
03342              Links != &amp;Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a>;
03343              Links = Links-&gt;Flink ) {
03344 
03345             <a class="code" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a> WaitingIrp;
03346 
03347             <span class="comment">//</span>
03348             <span class="comment">//  Get a pointer to the waiting Irp record</span>
03349             <span class="comment">//</span>
03350 
03351             WaitingIrp = CONTAINING_RECORD( Links, <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>, Links );
03352 
03353             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCancelWaitIrp, Loop top, WaitingIrp = %08lx\n"</span>, WaitingIrp);
03354 
03355             <span class="comment">//</span>
03356             <span class="comment">//  Check if the irp has been cancelled</span>
03357             <span class="comment">//</span>
03358 
03359             <span class="keywordflow">if</span> (WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o1">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
03360 
03361                 <span class="comment">//</span>
03362                 <span class="comment">//  Now we need to remove this waiter and call the</span>
03363                 <span class="comment">//  completion routine.  But we must not mess up our link</span>
03364                 <span class="comment">//  iteration so we need to back up link one step and</span>
03365                 <span class="comment">//  then the next iteration will go to our current flink.</span>
03366                 <span class="comment">//</span>
03367 
03368                 Links = Links-&gt;Blink;
03369 
03370                 <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a>( WaitingIrp );
03371             }
03372         }
03373 
03374     } finally {
03375 
03376         <span class="comment">//</span>
03377         <span class="comment">//  No matter how we exit we release the mutex</span>
03378         <span class="comment">//</span>
03379 
03380         ExReleaseFastMutex( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
03381 
03382         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCancelWaitIrp:  Exit\n"</span>, 0 );
03383     }
03384 
03385     <span class="keywordflow">return</span>;
03386 
03387     UNREFERENCED_PARAMETER( DeviceObject );
03388 }
03389 
03390 
03391 <span class="comment">//</span>
03392 <span class="comment">//  Local support routine.</span>
03393 <span class="comment">//</span>
03394 
03395 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03396"></a><a class="code" href="../../d5/d2/oplock_8c.html#a52">03396</a> <a class="code" href="../../d5/d2/oplock_8c.html#a52">FsRtlCancelOplockIIIrp</a> (
03397     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
03398     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
03399     )
03400 
03401 <span class="comment">/*++</span>
03402 <span class="comment"></span>
03403 <span class="comment">Routine Description:</span>
03404 <span class="comment"></span>
03405 <span class="comment">    This routine is called for an Irp that is placed in the Oplock II</span>
03406 <span class="comment">    Irp queue.  We remove the Cancel routine from the specified Irp and</span>
03407 <span class="comment">    then call the completion routines for all the cancelled Irps on the</span>
03408 <span class="comment">    queue.</span>
03409 <span class="comment"></span>
03410 <span class="comment">Arguments:</span>
03411 <span class="comment"></span>
03412 <span class="comment">    DeviceObject - Ignored.</span>
03413 <span class="comment"></span>
03414 <span class="comment">    Irp - Supplies the Irp being cancelled.  A pointer to the</span>
03415 <span class="comment">          Oplock structure for the Irp is stored in the information</span>
03416 <span class="comment">          field of the Irp's Iosb.</span>
03417 <span class="comment"></span>
03418 <span class="comment">Return Value:</span>
03419 <span class="comment"></span>
03420 <span class="comment">    None.</span>
03421 <span class="comment"></span>
03422 <span class="comment">--*/</span>
03423 
03424 {
03425     <a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a> Oplock;
03426     BOOLEAN LevelIIIrps;
03427 
03428     PLIST_ENTRY Links;
03429 
03430     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCancelOplockIIIrp:  Entered\n"</span>, 0 );
03431 
03432     Oplock = (<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
03433 
03434     <span class="comment">//</span>
03435     <span class="comment">//  We now need to void the cancel routine and release the spinlock</span>
03436     <span class="comment">//</span>
03437 
03438     <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03439     <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03440 
03441     LevelIIIrps = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03442 
03443     <span class="comment">//</span>
03444     <span class="comment">//  Iterate through all of the level II oplocks looking for a canceled one</span>
03445     <span class="comment">//  We do this under the protection of the oplock mutex.</span>
03446     <span class="comment">//</span>
03447 
03448     ExAcquireFastMutex( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
03449 
03450     <span class="keywordflow">try</span> {
03451 
03452         <span class="keywordflow">for</span> (Links = Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>.Flink;
03453              Links != &amp;Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>;
03454              Links = Links-&gt;Flink ) {
03455 
03456             <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> OplockIIIrp;
03457 
03458             <span class="comment">//</span>
03459             <span class="comment">//  Get a pointer to the Irp record</span>
03460             <span class="comment">//</span>
03461 
03462             OplockIIIrp = CONTAINING_RECORD( Links, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, Tail.Overlay.ListEntry );
03463 
03464             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCancelOplockIIIrp, Loop top, Irp = %08lx\n"</span>, OplockIIIrp);
03465 
03466             <span class="comment">//</span>
03467             <span class="comment">//  Check if the irp has been cancelled</span>
03468             <span class="comment">//</span>
03469 
03470             <span class="keywordflow">if</span> (OplockIIIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
03471 
03472                 <span class="comment">//</span>
03473                 <span class="comment">//  Now we need to remove this waiter and call the</span>
03474                 <span class="comment">//  completion routine.  But we must not mess up our link</span>
03475                 <span class="comment">//  iteration so we need to back up link one step and</span>
03476                 <span class="comment">//  then the next iteration will go to our current flink.</span>
03477                 <span class="comment">//</span>
03478 
03479                 Links = Links-&gt;Blink;
03480 
03481                 <a class="code" href="../../d5/d2/oplock_8c.html#a48">FsRtlRemoveAndCompleteIrp</a>( Links-&gt;Flink );
03482 
03483                 LevelIIIrps = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03484             }
03485         }
03486 
03487         <span class="comment">//</span>
03488         <span class="comment">//  If the list is now empty, change the oplock status to</span>
03489         <span class="comment">//  no oplocks held.</span>
03490         <span class="comment">//</span>
03491 
03492         <span class="keywordflow">if</span> (LevelIIIrps &amp;&amp; IsListEmpty( &amp;Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a> )) {
03493 
03494             Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
03495         }
03496 
03497     } finally {
03498 
03499         <span class="comment">//</span>
03500         <span class="comment">//  No matter how we exit we release the mutex</span>
03501         <span class="comment">//</span>
03502 
03503         ExReleaseFastMutex( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
03504 
03505         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCancelOplockIIIrp:  Exit\n"</span>, 0 );
03506     }
03507 
03508     <span class="keywordflow">return</span>;
03509 
03510     UNREFERENCED_PARAMETER( DeviceObject );
03511 }
03512 
03513 
03514 <span class="comment">//</span>
03515 <span class="comment">//  Local support routine.</span>
03516 <span class="comment">//</span>
03517 
03518 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03519"></a><a class="code" href="../../d5/d2/oplock_8c.html#a53">03519</a> <a class="code" href="../../d5/d2/oplock_8c.html#a53">FsRtlCancelExclusiveIrp</a> (
03520     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
03521     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
03522     )
03523 
03524 <span class="comment">/*++</span>
03525 <span class="comment"></span>
03526 <span class="comment">Routine Description:</span>
03527 <span class="comment"></span>
03528 <span class="comment">    This routine is called for either an exclusive or oplock I Irp.</span>
03529 <span class="comment"></span>
03530 <span class="comment">Arguments:</span>
03531 <span class="comment"></span>
03532 <span class="comment">    DeviceObject - Ignored.</span>
03533 <span class="comment"></span>
03534 <span class="comment">    Irp - Supplies the Irp being cancelled.  A pointer to the</span>
03535 <span class="comment">          Oplock structure for the Irp is stored in the information</span>
03536 <span class="comment">          field of the Irp's Iosb.</span>
03537 <span class="comment"></span>
03538 <span class="comment">Return Value:</span>
03539 <span class="comment"></span>
03540 <span class="comment">    None.</span>
03541 <span class="comment"></span>
03542 <span class="comment">--*/</span>
03543 
03544 {
03545     <a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a> Oplock;
03546 
03547     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCancelExclusiveIrp:  Entered\n"</span>, 0 );
03548 
03549     Oplock = (<a class="code" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
03550 
03551     <span class="comment">//</span>
03552     <span class="comment">//  We now need to void the cancel routine and release the spinlock</span>
03553     <span class="comment">//</span>
03554 
03555     <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03556     <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03557 
03558     <span class="comment">//</span>
03559     <span class="comment">//  Grab the synchronization object for this oplock.</span>
03560     <span class="comment">//</span>
03561 
03562     ExAcquireFastMutex( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
03563 
03564     <span class="keywordflow">try</span> {
03565 
03566         <span class="comment">//</span>
03567         <span class="comment">//  We look for the exclusive Irp, if present and cancelled</span>
03568         <span class="comment">//  we complete it.</span>
03569         <span class="comment">//</span>
03570 
03571         <span class="keywordflow">if</span> ((Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03572             (Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>)) {
03573 
03574             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a>, STATUS_CANCELLED );
03575             Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03576 
03577             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a> );
03578             Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03579             Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
03580 
03581             <span class="comment">//</span>
03582             <span class="comment">//  Complete the waiting Irps.</span>
03583             <span class="comment">//</span>
03584 
03585             <span class="keywordflow">while</span> (!IsListEmpty( &amp;Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a> )) {
03586 
03587                 <a class="code" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a> WaitingIrp;
03588 
03589                 <span class="comment">//</span>
03590                 <span class="comment">//  Remove the entry found and complete the Irp.</span>
03591                 <span class="comment">//</span>
03592 
03593                 WaitingIrp = CONTAINING_RECORD( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a>.Flink,
03594                                                 <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>,
03595                                                 Links );
03596 
03597                 <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a>( WaitingIrp );
03598             }
03599         }
03600 
03601     } finally {
03602 
03603         <span class="comment">//</span>
03604         <span class="comment">//  No matter how we exit we release the mutex</span>
03605         <span class="comment">//</span>
03606 
03607         ExReleaseFastMutex( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
03608 
03609         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCancelExclusiveIrp:  Exit\n"</span>, 0 );
03610     }
03611 
03612     <span class="keywordflow">return</span>;
03613 
03614     UNREFERENCED_PARAMETER( DeviceObject );
03615 }
03616 
03617 
03618 <span class="comment">//</span>
03619 <span class="comment">//  Local support routine.</span>
03620 <span class="comment">//</span>
03621 
03622 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03623"></a><a class="code" href="../../d5/d2/oplock_8c.html#a54">03623</a> <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a> (
03624     IN PWAITING_IRP WaitingIrp
03625     )
03626 
03627 <span class="comment">/*++</span>
03628 <span class="comment"></span>
03629 <span class="comment">Routine Description:</span>
03630 <span class="comment"></span>
03631 <span class="comment">    This routine is called to remove and perform any neccessary cleanup</span>
03632 <span class="comment">    for an Irp stored on the waiting Irp list in an oplock structure.</span>
03633 <span class="comment"></span>
03634 <span class="comment">Arguments:</span>
03635 <span class="comment"></span>
03636 <span class="comment">    WaitingIrp - This is the auxilary structure attached to the Irp</span>
03637 <span class="comment">                 being completed.</span>
03638 <span class="comment"></span>
03639 <span class="comment">Return Value:</span>
03640 <span class="comment"></span>
03641 <span class="comment">    None.</span>
03642 <span class="comment"></span>
03643 <span class="comment">--*/</span>
03644 
03645 {
03646     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
03647 
03648     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03649 
03650     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlRemoveAndCompleteWaitIrp:  Entered\n"</span>, 0 );
03651 
03652     <span class="comment">//</span>
03653     <span class="comment">//  Remove the Irp from the queue.</span>
03654     <span class="comment">//</span>
03655 
03656     RemoveEntryList( &amp;WaitingIrp-&gt;Links );
03657 
03658     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = WaitingIrp-&gt;Irp;
03659 
03660     <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03661 
03662     <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03663     <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03664 
03665     <span class="comment">//</span>
03666     <span class="comment">//  Restore the information field.</span>
03667     <span class="comment">//</span>
03668 
03669     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = WaitingIrp-&gt;Information;
03670 
03671     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>
03672                             ? STATUS_CANCELLED
03673                             : STATUS_SUCCESS);
03674 
03675     <span class="comment">//</span>
03676     <span class="comment">//  Call the completion routine in the Waiting Irp.</span>
03677     <span class="comment">//</span>
03678 
03679     WaitingIrp-&gt;CompletionRoutine( WaitingIrp-&gt;Context, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
03680 
03681     <span class="comment">//</span>
03682     <span class="comment">//  And free up pool</span>
03683     <span class="comment">//</span>
03684 
03685     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( WaitingIrp );
03686 
03687     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlRemoveAndCompleteWaitIrp:  Exit\n"</span>, 0 );
03688 
03689     <span class="keywordflow">return</span>;
03690 }
03691 
03692 
03693 <span class="comment">//</span>
03694 <span class="comment">//  Local support routine.</span>
03695 <span class="comment">//</span>
03696 
03697 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03698"></a><a class="code" href="../../d5/d2/oplock_8c.html#a55">03698</a> <a class="code" href="../../d5/d2/oplock_8c.html#a55">FsRtlNotifyCompletion</a> (
03699     IN PVOID Context,
03700     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
03701     )
03702 
03703 <span class="comment">/*++</span>
03704 <span class="comment"></span>
03705 <span class="comment">Routine Description:</span>
03706 <span class="comment"></span>
03707 <span class="comment">    This is the completion routine called when a break notify Irp is to</span>
03708 <span class="comment">    be completed.  We simply call FsRtlComplete request to dispose of the</span>
03709 <span class="comment">    Irp.</span>
03710 <span class="comment"></span>
03711 <span class="comment">Arguments:</span>
03712 <span class="comment"></span>
03713 <span class="comment">    Context - Ignored.</span>
03714 <span class="comment"></span>
03715 <span class="comment">    Irp - Irp used to request break notify.</span>
03716 <span class="comment"></span>
03717 <span class="comment">Return Value:</span>
03718 <span class="comment"></span>
03719 <span class="comment">    None.</span>
03720 <span class="comment"></span>
03721 <span class="comment">--*/</span>
03722 
03723 {
03724     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03725 
03726     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyCompletion:  Entered\n"</span>, 0 );
03727 
03728     <span class="comment">//</span>
03729     <span class="comment">//  Call FsRtlCompleteRequest using the value in the Irp.</span>
03730     <span class="comment">//</span>
03731 
03732     <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status );
03733 
03734     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyCompletion:  Exit\n"</span>, 0 );
03735 
03736     <span class="keywordflow">return</span>;
03737 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:06 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
