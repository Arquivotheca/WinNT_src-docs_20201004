<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hiveload.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hiveload.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d7/d0/hiveload_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/hiveload_8c.html#a0">IO_BUFFER_SIZE</a>&nbsp;&nbsp;&nbsp;0x10000</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d6/d1/hiveload_8c.html#a20">_RESULT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a></td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/hiveload_8c.html#a20">_RESULT</a> { <br>
&nbsp;&nbsp;<a class="el" href="../../d6/d1/hiveload_8c.html#a20a8">NotHive</a>, 
<a class="el" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>, 
<a class="el" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>, 
<a class="el" href="../../d6/d1/hiveload_8c.html#a20a11">HiveSuccess</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>, 
<a class="el" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>
<br>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/hiveload_8c.html#a14">HvpGetHiveHeader</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a> *BaseBlock, PLARGE_INTEGER TimeStamp)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/hiveload_8c.html#a15">HvpGetLogHeader</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a> *BaseBlock, PLARGE_INTEGER TimeStamp)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/hiveload_8c.html#a16">HvpRecoverData</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, BOOLEAN ReadOnly, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/hiveload_8c.html#a17">HvpReadFileImageAndBuildMap</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG Length, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/hiveload_8c.html#a18">HvpDelistBinFreeCells</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="el" href="../../d9/d0/hivechek_8c.html#a6">Bin</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/hiveload_8c.html#a19">HvLoadHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap>struct {</td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d6/d1/hiveload_8c.html#a2">Hive</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;<a class="el" href="../../d6/d1/hiveload_8c.html#a3">Status</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;<a class="el" href="../../d6/d1/hiveload_8c.html#a4">Space</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d6/d1/hiveload_8c.html#a5">MapPoint</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d6/d1/hiveload_8c.html#a6">BinPoint</a></td></tr>

<tr><td class="memItemLeft" nowrap valign=top>}&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/hiveload_8c.html#a7">HvCheckHiveDebug</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="hiveload.c::IO_BUFFER_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_BUFFER_SIZE&nbsp;&nbsp;&nbsp;0x10000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00034">34</a> of file <a class="el" href="../../d7/d0/hiveload_8c-source.html">hiveload.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00311">HvpReadFileImageAndBuildMap()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a1" doxytag="hiveload.c::RESULT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d6/d1/hiveload_8c.html#a20">_RESULT</a>  <a class="el" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a20" doxytag="hiveload.c::_RESULT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d6/d1/hiveload_8c.html#a20">_RESULT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a20a8" doxytag="NotHive" ></a>NotHive</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a20a9" doxytag="Fail" ></a>Fail</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a20a10" doxytag="NoMemory" ></a>NoMemory</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a20a11" doxytag="HiveSuccess" ></a>HiveSuccess</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a20a12" doxytag="RecoverHeader" ></a>RecoverHeader</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a20a13" doxytag="RecoverData" ></a>RecoverData</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00036">36</a> of file <a class="el" href="../../d7/d0/hiveload_8c-source.html">hiveload.c</a>.
<p>
<pre class="fragment"><div>00036                      {
00037     <a class="code" href="../../d6/d1/hiveload_8c.html#a20a8">NotHive</a>,
00038     <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>,
00039     <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>,
00040     <a class="code" href="../../d6/d1/hiveload_8c.html#a20a11">HiveSuccess</a>,
00041     <a class="code" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>,
00042     <a class="code" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>
00043 } <a class="code" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a19" doxytag="hiveload.c::HvLoadHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvLoadHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00100">100</a> of file <a class="el" href="../../d7/d0/hiveload_8c-source.html">hiveload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00751">HvpCleanMap()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00085">HvpFreeAllocatedBins()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00592">HvpGetHiveHeader()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00758">HvpGetLogHeader()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00311">HvpReadFileImageAndBuildMap()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00847">HvpRecoverData()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00344">_HBASE_BLOCK::Length</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00619">_HHIVE::Log</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00340">_HBASE_BLOCK::Minor</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a8">NotHive</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00336">_HBASE_BLOCK::Sequence1</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00337">_HBASE_BLOCK::Sequence2</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00341">_HBASE_BLOCK::Type</a>, and <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00633">_HHIVE::Version</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.
<p>
<pre class="fragment"><div>00106                    :
00107 
00108     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> must be fully initialized, in particular, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> handles
00109     must be set up.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not intended <span class="keywordflow">for</span> loading hives
00110     from images already in memory.
00111 
00112     This routine will apply whatever fixes are available <span class="keywordflow">for</span> errors
00113     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive image.  In particular, <span class="keywordflow">if</span> a log exists, and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> applicable,
00114     <span class="keyword">this</span> routine will automatically apply <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00115 
00116     ALGORITHM:
00117 
00118         call <a class="code" href="../../d6/d1/hiveload_8c.html#a14">HvpGetHiveHeader</a>()
00119 
00120         if (NoMemory or NoHive)
00121             return failure
00122 
00123         if (RecoverData or RecoverHeader) and (no log)
00124             return falure
00125 
00126         if (RecoverHeader)
00127             call HvpGetLogHeader
00128             if (fail)
00129                 return failure
00130             fix up baseblock
00131 
00132         Read Data
00133 
00134         if (RecoverData or RecoverHeader)
00135             HvpRecoverData
00136             return STATUS_REGISTRY_RECOVERED
00137 
00138         clean up sequence numbers
00139 
00140         return success OR STATUS_REGISTRY_RECOVERED
00141 
00142     If STATUS_REGISTRY_RECOVERED is returned, then
00143 
00144         If (Log) was used, DirtyVector and DirtyCount are set,
00145             caller is expected to flush the changes (using a
00146             NEW log file)
00147 
00148 Arguments:
00149 
00150     Hive - supplies a pointer to the hive control structure for the
00151             hive of interest
00152 
00153     TailDisplay - array containing the tail ends of the free cell lists - optional
00154 
00155 Return Value:
00156 
00157     STATUS:
00158 
00159         STATUS_INSUFFICIENT_RESOURCES   - memory alloc failure, etc
00160         STATUS_NOT_REGISTRY_FILE        - bad signatures and the like
00161         STATUS_REGISTRY_CORRUPT         - bad signatures in the log,
00162                                           bad stuff in both in alternate,
00163                                           inconsistent log
00164 
00165         STATUS_REGISTRY_IO_FAILED       - data read failed
00166 
00167         STATUS_RECOVERED                - successfully recovered the hive,
00168                                           a semi-flush of logged data
00169                                           is necessary.
00170 
00171         STATUS_SUCCESS                  - it worked, no recovery needed
00172 
00173 --*/
00174 {
00175     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
00176     ULONG           result1;
00177     ULONG           result2;
00178     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status;
00179     LARGE_INTEGER   TimeStamp;
00180     ULONG           FileOffset;
00181     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           pbin;
00182     BOOLEAN         ReadOnlyFlagCopy;
00183 
00184     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00185 
00186     BaseBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00187     result1 = <a class="code" href="../../d6/d1/hiveload_8c.html#a14">HvpGetHiveHeader</a>(Hive, &amp;BaseBlock, &amp;TimeStamp);
00188 
00189     <span class="comment">//</span>
00190     <span class="comment">// bomb out for total errors</span>
00191     <span class="comment">//</span>
00192     <span class="keywordflow">if</span> (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>) {
00193         status = STATUS_INSUFFICIENT_RESOURCES;
00194         <span class="keywordflow">goto</span> Exit1;
00195     }
00196     <span class="keywordflow">if</span> (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a8">NotHive</a>) {
00197         status = STATUS_NOT_REGISTRY_FILE;
00198         <span class="keywordflow">goto</span> Exit1;
00199     }
00200 
00201     
00202     ReadOnlyFlagCopy = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a>;
00203     <span class="comment">//</span>
00204     <span class="comment">// if recovery needed, and no log, bomb out</span>
00205     <span class="comment">//</span>
00206     <span class="keywordflow">if</span> ( ((result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>) ||
00207           (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>)) )
00208     {
00209         <span class="comment">//</span>
00210         <span class="comment">// recovery needed</span>
00211         <span class="comment">//</span>
00212         <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
00213         {
00214             <span class="comment">//</span>
00215             <span class="comment">// no log ==&gt; bomb out</span>
00216             <span class="comment">//</span>
00217             status = STATUS_REGISTRY_CORRUPT;
00218             <span class="keywordflow">goto</span> Exit1;
00219         } <span class="keywordflow">else</span> {
00220             <span class="comment">//</span>
00221             <span class="comment">// TRICK: simulate hive as read-only; Free cells will not </span>
00222             <span class="comment">// be enlisted in HvpReadFileImageAndBuildMap; Instead, they</span>
00223             <span class="comment">// will be enlisted in HvpRecoverData, when we are sure we have </span>
00224             <span class="comment">// the right info loaded up into memory</span>
00225             <span class="comment">//</span>
00226             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00227         }
00228     }
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">// need to recover header using log, so try to get it from log</span>
00232     <span class="comment">//</span>
00233     <span class="keywordflow">if</span> (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>) {
00234         result2 = <a class="code" href="../../d6/d1/hiveload_8c.html#a15">HvpGetLogHeader</a>(Hive, &amp;BaseBlock, &amp;TimeStamp);
00235         <span class="keywordflow">if</span> (result2 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>) {
00236             status =  STATUS_INSUFFICIENT_RESOURCES;
00237             <span class="keywordflow">goto</span> Exit1;
00238         }
00239         <span class="keywordflow">if</span> (result2 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>) {
00240             status = STATUS_REGISTRY_CORRUPT;
00241             <span class="keywordflow">goto</span> Exit1;
00242         }
00243         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
00244     }
00245     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = BaseBlock;
00246     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a>;
00247 
00248     <span class="comment">//</span>
00249     <span class="comment">// at this point, we have a sane baseblock.  we may or may not still</span>
00250     <span class="comment">// need to apply data recovery</span>
00251     <span class="comment">//</span>
00252     status = <a class="code" href="../../d6/d1/hiveload_8c.html#a17">HvpReadFileImageAndBuildMap</a>(Hive,BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>,TailDisplay);
00253     
00254     
00255     <span class="comment">//</span>
00256     <span class="comment">// if STATUS_REGISTRY_CORRUPT and RecoverData don't bail out, keep recovering</span>
00257     <span class="comment">//</span>
00258     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; ((status != STATUS_REGISTRY_CORRUPT) || (result1 != <a class="code" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>)) ) {
00259         <span class="keywordflow">goto</span> Exit2;
00260     }
00261     
00262     <span class="comment">//</span>
00263     <span class="comment">// apply data recovery if we need it</span>
00264     <span class="comment">//</span>
00265     status = STATUS_SUCCESS;
00266     <span class="keywordflow">if</span> ( (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>) ||      <span class="comment">// -&gt; implies recover data</span>
00267          (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>) )
00268     {
00269         <span class="comment">//</span>
00270         <span class="comment">// recover data will enllist the free cells as well and </span>
00271         <span class="comment">// will restore the original read-only state of the hive</span>
00272         <span class="comment">//</span>
00273         result2 = <a class="code" href="../../d6/d1/hiveload_8c.html#a16">HvpRecoverData</a>(Hive,ReadOnlyFlagCopy,TailDisplay);
00274         <span class="keywordflow">if</span> (result2 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>) {
00275             status = STATUS_INSUFFICIENT_RESOURCES;
00276             <span class="keywordflow">goto</span> Exit2;
00277         }
00278         <span class="keywordflow">if</span> (result2 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>) {
00279             status = STATUS_REGISTRY_CORRUPT;
00280             <span class="keywordflow">goto</span> Exit2;
00281         }
00282         status = STATUS_REGISTRY_RECOVERED;
00283     }
00284 
00285     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a> = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a>;
00286     <span class="keywordflow">return</span> status;
00287 
00288 
00289 Exit2:
00290     <span class="comment">//</span>
00291     <span class="comment">// Clean up the bins already allocated </span>
00292     <span class="comment">//</span>
00293     <a class="code" href="../../d5/d1/hiveinit_8c.html#a2">HvpFreeAllocatedBins</a>( Hive );
00294 
00295     <span class="comment">//</span>
00296     <span class="comment">// Clean up the directory table</span>
00297     <span class="comment">//</span>
00298     <a class="code" href="../../d7/d1/hivemap_8c.html#a11">HvpCleanMap</a>( Hive );
00299 
00300 Exit1:
00301     <span class="keywordflow">if</span> (BaseBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00302         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(BaseBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00303     }
00304 
00305     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00306     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = 0;
00307     <span class="keywordflow">return</span> status;
00308 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="hiveload.c::HvpDelistBinFreeCells" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpDelistBinFreeCells           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Bin</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="hiveload.c::HvpGetHiveHeader" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a> HvpGetHiveHeader           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>TimeStamp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00592">592</a> of file <a class="el" href="../../d7/d0/hiveload_8c-source.html">hiveload.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00602">_HHIVE::FileRead</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00323">HBASE_BLOCK_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00329">HBASE_FORMAT_MEMORY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00187">HBIN_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a11">HiveSuccess</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00325">HSYS_MAJOR</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00326">HSYS_MINOR</a>, <a class="el" href="../../d0/d1/hivesum_8c-source.html#l00031">HvpHeaderCheckSum()</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a8">NotHive</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00338">_HBASE_BLOCK::TimeStamp</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00100">HvLoadHive()</a>.
<p>
<pre class="fragment"><div>00599                    :
00600 
00601     Examine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base block sector and possibly <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first sector of
00602     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first bin, and decide what (<span class="keywordflow">if</span> any) recovery needs to be applied
00603     based on what we find there.
00604 
00605     ALGORITHM:
00606 
00607         read BaseBlock from offset 0
00608         <span class="keywordflow">if</span> ( (I/O error)    OR
00609              (checksum wrong) )
00610         {
00611             read bin block from offset <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a> (4k)
00612             if (2nd I/O error)
00613                 return NotHive
00614             }
00615             check bin sign., offset.
00616             if (OK)
00617                 return RecoverHeader, TimeStamp=from Link field
00618             } else {
00619                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a8">NotHive</a>
00620             }
00621         }
00622 
00623         <span class="keywordflow">if</span> (wrong <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> or signature or version or <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>)
00624             <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a8">NotHive</a>
00625         }
00626 
00627         <span class="keywordflow">if</span> (seq1 != seq2) {
00628             <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>, TimeStamp=BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>, valid BaseBlock
00629         }
00630 
00631         <span class="keywordflow">return</span> ReadData, valid BaseBlock
00632 
00633 Arguments:
00634 
00635     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00636             hive of interest
00637 
00638     FileType - <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a> or <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a> - which copy
00639             of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive to read from.
00640 
00641     BaseBlock - supplies pointer to variable to receive pointer to
00642             <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>, <span class="keywordflow">if</span> we can successfully read one.
00643 
00644     TimeStamp - pointer to variable to receive time stamp (serial number)
00645             of hive, be <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> baseblock or from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Link field
00646             of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first bin.
00647 
00648 Return Value:
00649 
00650     <a class="code" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a> code
00651 
00652 --*/
00653 {
00654     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    buffer;
00655     BOOLEAN         rc;
00656     ULONG           FileOffset;
00657     ULONG           Alignment;
00658 
00659     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(HBASE_BLOCK) &gt;= (HSECTOR_SIZE * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>));
00660 
00661     <span class="comment">//</span>
00662     <span class="comment">// allocate buffer to hold base block</span>
00663     <span class="comment">//</span>
00664     *BaseBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00665     buffer = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00666     <span class="keywordflow">if</span> (buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00667         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>;
00668     }
00669     <span class="comment">//</span>
00670     <span class="comment">// Make sure the buffer we got back is cluster-aligned. If not, try</span>
00671     <span class="comment">// harder to get an aligned buffer.</span>
00672     <span class="comment">//</span>
00673     Alignment = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> - 1;
00674     <span class="keywordflow">if</span> (((ULONG_PTR)buffer &amp; Alignment) != 0) {
00675         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(buffer, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>));
00676         buffer = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00677         <span class="keywordflow">if</span> (buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00678             <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>;
00679         }
00680     }
00681     RtlZeroMemory((PVOID)buffer, <span class="keyword">sizeof</span>(HBASE_BLOCK));
00682 
00683     <span class="comment">//</span>
00684     <span class="comment">// attempt to read base block</span>
00685     <span class="comment">//</span>
00686     FileOffset = 0;
00687     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00688                           <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
00689                           &amp;FileOffset,
00690                           (PVOID)buffer,
00691                           <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>);
00692 
00693     <span class="keywordflow">if</span> ( (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)  ||
00694          (<a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(buffer) != buffer-&gt;CheckSum)) {
00695         <span class="comment">//</span>
00696         <span class="comment">// base block is toast, try the first block in the first bin</span>
00697         <span class="comment">//</span>
00698         FileOffset = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00699         rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00700                               <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
00701                               &amp;FileOffset,
00702                               (PVOID)buffer,
00703                               <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>);
00704 
00705         <span class="keywordflow">if</span> ( (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00706              ( ((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)buffer)-&gt;Signature != <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>)           ||
00707              ( ((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)buffer)-&gt;FileOffset != 0)
00708            )
00709         {
00710             <span class="comment">//</span>
00711             <span class="comment">// the bin is toast too, punt</span>
00712             <span class="comment">//</span>
00713             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(buffer, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>));
00714             <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a8">NotHive</a>;
00715         }
00716 
00717         <span class="comment">//</span>
00718         <span class="comment">// base block is bogus, but bin is OK, so tell caller</span>
00719         <span class="comment">// to look for a log file and apply recovery</span>
00720         <span class="comment">//</span>
00721         *TimeStamp = ((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)buffer)-&gt;TimeStamp;
00722         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(buffer, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>));
00723         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>;
00724     }
00725 
00726     <span class="comment">//</span>
00727     <span class="comment">// base block read OK, but is it valid?</span>
00728     <span class="comment">//</span>
00729     <span class="keywordflow">if</span> ( (buffer-&gt;Signature != <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>)   ||
00730          (buffer-&gt;Type != <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>)           ||
00731          (buffer-&gt;Major != <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>)                  ||
00732          (buffer-&gt;Minor &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>)                   ||
00733          ((buffer-&gt;Major == 1) &amp;&amp; (buffer-&gt;Minor == 0)) ||
00734          (buffer-&gt;Format != <a class="code" href="../../d0/d1/hivedata_8h.html#a29">HBASE_FORMAT_MEMORY</a>)
00735        )
00736     {
00737         <span class="comment">//</span>
00738         <span class="comment">// file is simply not a valid hive</span>
00739         <span class="comment">//</span>
00740         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(buffer, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>));
00741         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a8">NotHive</a>;
00742     }
00743 
00744     <span class="comment">//</span>
00745     <span class="comment">// see if recovery is necessary</span>
00746     <span class="comment">//</span>
00747     *BaseBlock = buffer;
00748     *TimeStamp = buffer-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>;
00749     <span class="keywordflow">if</span> ( (buffer-&gt;Sequence1 != buffer-&gt;Sequence2) ) {
00750         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>;
00751     }
00752 
00753     <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a11">HiveSuccess</a>;
00754 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="hiveload.c::HvpGetLogHeader" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a> HvpGetLogHeader           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>TimeStamp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00758">758</a> of file <a class="el" href="../../d7/d0/hiveload_8c-source.html">hiveload.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00602">_HHIVE::FileRead</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00323">HBASE_BLOCK_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a11">HiveSuccess</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d0/d1/hivesum_8c-source.html#l00031">HvpHeaderCheckSum()</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00100">HvLoadHive()</a>.
<p>
<pre class="fragment"><div>00765                    :
00766 
00767     Read and validate log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> header.  Return <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>'s valid.
00768 
00769     ALGORITHM:
00770 
00771         read header
00772         <span class="keywordflow">if</span> ( (I/O error) or
00773            (wrong signature,
00774             wrong <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>,
00775             seq mismatch
00776             wrong checksum,
00777             wrong timestamp
00778            )
00779             <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>
00780         }
00781         <span class="keywordflow">return</span> baseblock, OK
00782 
00783 Arguments:
00784 
00785     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00786             hive of interest
00787 
00788     BaseBlock - supplies pointer to variable to receive pointer to
00789             <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>, <span class="keywordflow">if</span> we can successfully read one.
00790 
00791     TimeStamp - pointer to variable holding TimeStamp, which must
00792             match <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00793 
00794 Return Value:
00795 
00796     <a class="code" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a>
00797 
00798 --*/
00799 {
00800     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    buffer;
00801     BOOLEAN         rc;
00802     ULONG           FileOffset;
00803 
00804     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(HBASE_BLOCK) == HBLOCK_SIZE);
00805     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(HBASE_BLOCK) &gt;= (HSECTOR_SIZE * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>));
00806 
00807     <span class="comment">//</span>
00808     <span class="comment">// allocate buffer to hold base block</span>
00809     <span class="comment">//</span>
00810     *BaseBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00811     buffer = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00812     <span class="keywordflow">if</span> (buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00813         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>;
00814     }
00815     RtlZeroMemory((PVOID)buffer, HSECTOR_SIZE);
00816 
00817     <span class="comment">//</span>
00818     <span class="comment">// attempt to read base block</span>
00819     <span class="comment">//</span>
00820     FileOffset = 0;
00821     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00822                           <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
00823                           &amp;FileOffset,
00824                           (PVOID)buffer,
00825                           <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>);
00826 
00827     <span class="keywordflow">if</span> ( (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)                                              ||
00828          (buffer-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>)               ||
00829          (buffer-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>)                           ||
00830          (buffer-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a> != buffer-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>)                   ||
00831          (<a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(buffer) != buffer-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a>)            ||
00832          (TimeStamp-&gt;LowPart != buffer-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>.LowPart)          ||
00833          (TimeStamp-&gt;HighPart != buffer-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>.HighPart)) {
00834         <span class="comment">//</span>
00835         <span class="comment">// Log is unreadable, invalid, or doesn't apply the right hive</span>
00836         <span class="comment">//</span>
00837         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(buffer, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>));
00838         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>;
00839     }
00840 
00841     *BaseBlock = buffer;
00842     <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a11">HiveSuccess</a>;
00843 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="hiveload.c::HvpReadFileImageAndBuildMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvpReadFileImageAndBuildMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00311">311</a> of file <a class="el" href="../../d7/d0/hiveload_8c-source.html">hiveload.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00602">_HHIVE::FileRead</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00187">HBIN_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00751">HvpCleanMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">HvpEnlistBinInMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00304">HvpInitMap()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00034">IO_BUFFER_SIZE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00192">_HBIN::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00100">HvLoadHive()</a>.
<p>
<pre class="fragment"><div>00319                    :
00320 
00321     Read <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> and allocate storage <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00322     image in chunks of HBINs. Build <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive map <span class="stringliteral">"on the fly"</span>.
00323         Optimized to read chunks of 64K from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00324 
00325 Arguments:
00326 
00327     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00328             hive of interest
00329 
00330     Length - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive, in bytes
00331 
00332     TailDisplay - array containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tail ends of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free cell lists - optional
00333 
00334 Return Value:
00335 
00336     STATUS:
00337 
00338         STATUS_INSUFFICIENT_RESOURCES   - memory alloc <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>, etc
00339 
00340         STATUS_REGISTRY_IO_FAILED       - data read failed
00341 
00342         STATUS_REGISTRY_CORRUPT         - base block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> corrupt
00343 
00344         STATUS_SUCCESS                  - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00345 
00346 --*/
00347 {
00348     ULONG           FileOffset;
00349     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00350     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;                        <span class="comment">// current bin</span>
00351     ULONG           BinSize;            <span class="comment">// size of the current bin</span>
00352     ULONG           BinOffset;          <span class="comment">// current offset inside current bin</span>
00353     ULONG           BinFileOffset;  <span class="comment">// physical offset of the bin in the file (used for consistency checking)</span>
00354     ULONG           BinDataInBuffer;<span class="comment">// the amount of data needed to be copied in the current bin available in the buffer</span>
00355     ULONG           BinDataNeeded;  <span class="comment">// </span>
00356     PUCHAR                      IOBuffer;
00357     ULONG           IOBufferSize;       <span class="comment">// valid data in IOBuffer (only at the end of the file this is different than IO_BUFFER_SIZE)</span>
00358     ULONG           IOBufferOffset;     <span class="comment">// current offset inside IOBuffer</span>
00359 
00360     <span class="comment">//</span>
00361     <span class="comment">// Init the map</span>
00362     <span class="comment">//</span>
00363     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/hivemap_8c.html#a7">HvpInitMap</a>(Hive);
00364 
00365     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00366         <span class="comment">//</span>
00367         <span class="comment">// return failure </span>
00368         <span class="comment">//</span>
00369         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00370     }
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">// Allocate a IO_BUFFER_SIZE for I/O operations from paged pool. </span>
00374         <span class="comment">// It will be freed at the end of the function.</span>
00375     <span class="comment">//</span>
00376     IOBuffer = (PUCHAR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, IO_BUFFER_SIZE);
00377     <span class="keywordflow">if</span> (IOBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00378         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00379         <a class="code" href="../../d7/d1/hivemap_8c.html#a11">HvpCleanMap</a>( Hive );
00380         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00381     }
00382 
00383     <span class="comment">//</span>
00384     <span class="comment">// Start right after the hive header</span>
00385     <span class="comment">//</span>
00386     FileOffset = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00387     BinFileOffset = FileOffset;
00388     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00389 
00390     <span class="comment">//</span>
00391         <span class="comment">// outer loop : reads IO_BUFFER_SIZE chunks from the file</span>
00392         <span class="comment">//</span>
00393         <span class="keywordflow">while</span>( FileOffset &lt; (Length + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) ) {
00394                 <span class="comment">//</span>
00395                 <span class="comment">// we are at the begining of the IO buffer</span>
00396         <span class="comment">//</span>
00397         IOBufferOffset = 0;
00398 
00399         <span class="comment">//</span>
00400         <span class="comment">// the buffer size will be either IO_BufferSize, or the amount </span>
00401         <span class="comment">// uread from the file (when this is smaller than IO_BUFFER_SIZE)</span>
00402         <span class="comment">//</span>
00403         IOBufferSize = Length + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a> - FileOffset;
00404         IOBufferSize = ( IOBufferSize &gt; <a class="code" href="../../d6/d1/hiveload_8c.html#a0">IO_BUFFER_SIZE</a> ) ? <a class="code" href="../../d6/d1/hiveload_8c.html#a0">IO_BUFFER_SIZE</a> : IOBufferSize;
00405         
00406         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (IOBufferSize % HBLOCK_SIZE) == 0 );
00407         
00408         <span class="comment">//</span>
00409         <span class="comment">// read data from the file</span>
00410         <span class="comment">//</span>
00411         <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(
00412                         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00413                         <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
00414                         &amp;FileOffset,
00415                         (PVOID)IOBuffer,
00416                         IOBufferSize
00417                         )
00418            )
00419         {
00420             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_IO_FAILED;
00421             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00422         }
00423         
00424         <span class="comment">//</span>
00425         <span class="comment">// inner loop: breaks the buffer into bins</span>
00426         <span class="comment">//</span>
00427         <span class="keywordflow">while</span>( IOBufferOffset &lt; IOBufferSize ) {
00428 
00429             <span class="keywordflow">if</span>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00430                 <span class="comment">//</span>
00431                 <span class="comment">// this is the beginning of a new bin</span>
00432                 <span class="comment">// perform bin validation and allocate the bin</span>
00433                 <span class="comment">//</span>
00434                 <span class="comment">// temporary bin points to the current location inside the buffer</span>
00435                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(IOBuffer + IOBufferOffset);
00436                 <span class="comment">//</span>
00437                 <span class="comment">// Check the validity of the bin header</span>
00438                 <span class="comment">//</span>
00439                 BinSize = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00440                 <span class="keywordflow">if</span> ( (BinSize &gt; Length)                         ||
00441                      (BinSize &lt; <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>)                    ||
00442                      (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>)         ||
00443                      (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> != (BinFileOffset - <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) )) {
00444                     <span class="comment">//</span>
00445                     <span class="comment">// Bin is bogus</span>
00446                     <span class="comment">//</span>
00447                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00448                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00449                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00450                         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00451                     }
00452                     <span class="comment">//</span>
00453                     <span class="comment">// copy the data already read in the first HBLOCK of the bin</span>
00454                     <span class="comment">//</span>
00455                     RtlCopyMemory(Bin,(IOBuffer + IOBufferOffset), HBLOCK_SIZE);
00456                     
00457                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00458                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Hive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00459                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 0xA001;
00460                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = Length;
00461                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = BinFileOffset;
00462                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00463             
00464                     <span class="comment">//goto ErrorExit;</span>
00465                     <span class="comment">//</span>
00466                     <span class="comment">// DO NOT EXIT; Fix this bin header and go on. RecoverData should fix it.</span>
00467                     <span class="comment">// If not, CmCheckRegistry called later will prevent loading of an invalid hive</span>
00468                     <span class="comment">//</span>
00469                     <span class="comment">// NOTE: Still, mess the signature, to make sure that if this particular bin doesn't get recovered, </span>
00470                     <span class="comment">//       we'll fail the hive loading request.</span>
00471                     <span class="comment">//</span>
00472                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> = 0; <span class="comment">//TRICK!!!!</span>
00473                     BinSize = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00474                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> = BinFileOffset - <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00475 
00476                     <span class="comment">//</span>
00477                     <span class="comment">// simulate as the entire bin is a used cell</span>
00478                     <span class="comment">//</span>
00479                     ((<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>)))-&gt;Size = <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>) - BinSize; <span class="comment">//TRICK!!!!</span>
00480                     <span class="comment">//</span>
00481                     <span class="comment">// Now that we have the entire bin in memory, Enlist It!</span>
00482                     <span class="comment">//</span>
00483                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/hivemap_8c.html#a8">HvpEnlistBinInMap</a>(Hive, Length, Bin, BinFileOffset - HBLOCK_SIZE, TailDisplay);
00484 
00485                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00486                         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00487                     }
00488                     
00489                     <span class="comment">//</span>
00490                     <span class="comment">// Adjust the offsets</span>
00491                     <span class="comment">//</span>
00492                     BinFileOffset += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00493                     IOBufferOffset += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00494                     
00495                     <span class="comment">//</span>
00496                     <span class="comment">// another bin is on his way </span>
00497                     <span class="comment">//</span>
00498                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00499                 } <span class="keywordflow">else</span> {
00500                     <span class="comment">//</span>
00501                     <span class="comment">// bin is valid; allocate a pool chunk of the right size</span>
00502                     <span class="comment">//</span>
00503                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(BinSize, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00504                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00505                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00506                         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00507                     }
00508             
00509                     <span class="comment">//</span>
00510                     <span class="comment">// the chunk is allocated; set the offset inside the bin and continue</span>
00511                     <span class="comment">// the next iteration of the inner loop will start by copying data in this bin</span>
00512                     <span class="comment">//</span>
00513                     BinOffset = 0;
00514                 }
00515             } <span class="keywordflow">else</span> {
00516                 <span class="comment">//</span>
00517                 <span class="comment">// if we are here, the bin is allocated, the BinSize and BinOffset are set</span>
00518                 <span class="comment">// We have to calculate how much for this bin is available in the buffer,</span>
00519                 <span class="comment">// and copy it. If we finished with this bin, enlist it and mark the begining of a new one</span>
00520                 <span class="comment">//</span>
00521                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Bin != NULL );
00522                 BinDataInBuffer = (IOBufferSize - IOBufferOffset);
00523                 BinDataNeeded = (BinSize - BinOffset);
00524                 
00525                 <span class="keywordflow">if</span>( BinDataInBuffer &gt;= BinDataNeeded ) {
00526                     <span class="comment">//</span>
00527                     <span class="comment">// we have available more than what we need; Finish the bin</span>
00528                     <span class="comment">//</span>
00529                     RtlCopyMemory(((PUCHAR)Bin + BinOffset),(IOBuffer + IOBufferOffset), BinDataNeeded);
00530                     <span class="comment">//</span>
00531                     <span class="comment">// enlist it</span>
00532                     <span class="comment">//</span>
00533                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/hivemap_8c.html#a8">HvpEnlistBinInMap</a>(Hive, Length, Bin, BinFileOffset - HBLOCK_SIZE, TailDisplay);
00534 
00535                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00536                         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00537                     }
00538                     <span class="comment">//</span>
00539                     <span class="comment">// Adjust the offsets</span>
00540                     <span class="comment">//</span>
00541                     BinFileOffset += BinSize;
00542                     IOBufferOffset += BinDataNeeded;
00543                     <span class="comment">//</span>
00544                     <span class="comment">// mark the begining of a new bin</span>
00545                     <span class="comment">//</span>
00546                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00547                 } <span class="keywordflow">else</span> {
00548                     <span class="comment">//</span>
00549                     <span class="comment">// we do not have all bin data in the buffer</span>
00550                     <span class="comment">// copy what we can </span>
00551                     <span class="comment">//</span>
00552                     RtlCopyMemory(((PUCHAR)Bin + BinOffset),(IOBuffer + IOBufferOffset), BinDataInBuffer);
00553                     
00554                     <span class="comment">//</span>
00555                     <span class="comment">// adjust the offsets; this should be the last iteration of the inner loop</span>
00556                     <span class="comment">//</span>
00557                     BinOffset += BinDataInBuffer;
00558                     IOBufferOffset += BinDataInBuffer;
00559 
00560                     <span class="comment">// </span>
00561                     <span class="comment">// if we are here, the buffer must have beed exausted  </span>
00562                     <span class="comment">//</span>
00563                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IOBufferOffset == IOBufferSize );
00564                 }
00565             }
00566         }
00567         }
00568 
00569     <span class="comment">//</span>
00570     <span class="comment">// if we got here, we shouldn't have a bin under construction</span>
00571     <span class="comment">//</span>
00572     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Bin == NULL );
00573 
00574         <span class="comment">//</span>
00575         <span class="comment">// Free the buffer used for I/O operations</span>
00576         <span class="comment">//</span>
00577         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IOBuffer);
00578 
00579     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00580 
00581 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
00582     <span class="comment">//</span>
00583     <span class="comment">// Free the buffer used for I/O operations</span>
00584     <span class="comment">//</span>
00585     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IOBuffer);
00586 
00587     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00588 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="hiveload.c::HvpRecoverData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a> HvpRecoverData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReadOnly</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00847">847</a> of file <a class="el" href="../../d7/d0/hiveload_8c-source.html">hiveload.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d9/d8/tbitmap_8c-source.html#l00028">BitMap</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00609">_HHIVE::DirtyAlloc</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00050">End</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00602">_HHIVE::FileRead</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00187">HBIN_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a11">HiveSuccess</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00354">HLOG_DV_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00413">HMAP_NEWALLOC</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">HvMarkDirty()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">HvpEnlistBinInMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00649">HvpEnlistFreeCells()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00344">_HBASE_BLOCK::Length</a>, <a class="el" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00219">RtlInitializeBitMap()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00192">_HBIN::Signature</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00100">HvLoadHive()</a>.
<p>
<pre class="fragment"><div>00854                    :
00855 
00856     Apply <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corrections in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive memory image.
00857 
00858     ALGORITHM:
00859 
00860         compute size of dirty vector
00861         read in dirty vector
00862         <span class="keywordflow">if</span> (i/o error)
00863             <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>
00864 
00865         skip first cluster of data (already processed as log)
00866         sweep vector, looking <span class="keywordflow">for</span> runs of bits
00867             address of first bit <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to compute memory offset
00868             length of run <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> length of block to read
00869             assert always a cluster multiple
00870             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset kept by running counter
00871             read
00872             <span class="keywordflow">if</span> (i/o error)
00873                 <span class="keywordflow">return</span> fail
00874 
00875         <span class="keywordflow">return</span> success
00876 
00877     NOTE:   It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> has been
00878             read into a single contiguous block, at Image.
00879 
00880 Arguments:
00881 
00882     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00883             hive of interest
00884 
00885     ReadOnly - by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time <span class="keyword">this</span> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> forced to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00886             ready-<a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> state. At <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end, <span class="keywordflow">if</span> recovery goes OK, we restore <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 
00887             hive at <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>'s original state, and enlist all free cells.
00888 
00889     TailDisplay - array containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tail ends of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free cell lists - optional
00890 
00891 Return Value:
00892 
00893     <a class="code" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a>
00894 
00895 --*/
00896 {
00897     ULONG       Cluster;
00898     ULONG       ClusterSize;
00899     ULONG       VectorSize;
00900     PULONG      Vector;
00901     ULONG       FileOffset;
00902     BOOLEAN     rc;
00903     ULONG       Current;
00904     ULONG       <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00905     ULONG       <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00906     ULONG       Address;
00907     PUCHAR      MemoryBlock;
00908     RTL_BITMAP  <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
00909     ULONG       Length;
00910     ULONG       DirtyVectorSignature = 0;
00911     ULONG       i;
00912     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Me;
00913     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00914     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       NewBin;
00915     PUCHAR      SectorImage;
00916     PUCHAR      Source;
00917     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       SourceBin;
00918     ULONG       SectorOffsetInBin;
00919     ULONG       SectorOffsetInBlock;
00920     ULONG       BlockOffsetInBin;
00921     ULONG       NumberOfSectors;
00922 
00923     <span class="comment">//</span>
00924     <span class="comment">// compute size of dirty vector, read and check signature, read vector</span>
00925     <span class="comment">//</span>
00926     Cluster = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00927     ClusterSize = Cluster * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00928     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>;
00929     VectorSize = (Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>) / 8;       <span class="comment">// VectorSize == Bytes</span>
00930     FileOffset = ClusterSize;
00931 
00932     <span class="comment">//</span>
00933     <span class="comment">// get and check signature</span>
00934     <span class="comment">//</span>
00935     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(
00936             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00937             <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
00938             &amp;FileOffset,
00939             (PVOID)&amp;DirtyVectorSignature,
00940             <span class="keyword">sizeof</span>(DirtyVectorSignature)
00941             );
00942     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00943         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>;
00944     }
00945 
00946     <span class="keywordflow">if</span> (DirtyVectorSignature != <a class="code" href="../../d0/d1/hivedata_8h.html#a32">HLOG_DV_SIGNATURE</a>) {
00947         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>;
00948     }
00949 
00950     <span class="comment">//</span>
00951     <span class="comment">// get the actual vector</span>
00952     <span class="comment">//</span>
00953     Vector = (PULONG)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(VectorSize,<span class="keyword">sizeof</span>(ULONG)), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00954     <span class="keywordflow">if</span> (Vector == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00955         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>;
00956     }
00957     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(
00958             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00959             <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
00960             &amp;FileOffset,            <span class="comment">// dirty vector right after header</span>
00961             (PVOID)Vector,
00962             VectorSize
00963             );
00964     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00965         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(Vector, VectorSize);
00966         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>;
00967     }
00968     FileOffset = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(FileOffset, ClusterSize);
00969 
00970 
00971     <span class="comment">//</span>
00972     <span class="comment">// step through the diry map, reading in the corresponding file bytes</span>
00973     <span class="comment">//</span>
00974     Current = 0;
00975     VectorSize = VectorSize * 8;        <span class="comment">// VectorSize == bits</span>
00976 
00977     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(&amp;BitMap, Vector, VectorSize);
00978 
00979     <span class="keywordflow">while</span> (Current &lt; VectorSize) {
00980 
00981         <span class="comment">//</span>
00982         <span class="comment">// find next contiguous block of entries to read in</span>
00983         <span class="comment">//</span>
00984         <span class="keywordflow">for</span> (i = Current; i &lt; VectorSize; i++) {
00985             <span class="keywordflow">if</span> (RtlCheckBit(&amp;BitMap, i) == 1) {
00986                 <span class="keywordflow">break</span>;
00987             }
00988         }
00989         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = i;
00990 
00991         <span class="keywordflow">for</span> ( ; i &lt; VectorSize; i++) {
00992             <span class="keywordflow">if</span> (RtlCheckBit(&amp;BitMap, i) == 0) {
00993                 <span class="keywordflow">break</span>;
00994             }
00995         }
00996         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = i;
00997         Current = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00998 
00999         <span class="comment">//</span>
01000         <span class="comment">// Start == number of 1st sector, End == number of Last sector + 1</span>
01001         <span class="comment">//</span>
01002         Length = (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> - <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>) * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01003 
01004         <span class="keywordflow">if</span>( 0 == Length ) {
01005             <span class="comment">// no more dirty blocks.</span>
01006             <span class="keywordflow">break</span>;
01007         }
01008         <span class="comment">//</span>
01009         <span class="comment">// allocate a buffer to read the whole run from the file; This is a temporary</span>
01010         <span class="comment">// block that'll be freed immediately, so don't charge quota for it.</span>
01011         <span class="comment">//</span>
01012         MemoryBlock = (PUCHAR)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool, Length, CM_POOL_TAG);
01013         <span class="keywordflow">if</span>( MemoryBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {        
01014             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01015         }
01016 
01017         rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(
01018                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01019                 <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
01020                 &amp;FileOffset,
01021                 (PVOID)MemoryBlock,
01022                 Length
01023                 );
01024 
01025         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((FileOffset % ClusterSize) == 0);
01026         <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01027             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(MemoryBlock);
01028             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01029         }
01030         
01031         Source = MemoryBlock;
01032         <span class="comment">//</span>
01033         <span class="comment">// copy recovered data in the right locations inside the in-memory bins</span>
01034         <span class="comment">//</span>
01035         <span class="keywordflow">while</span>( <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> ) {
01036             Address = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01037         
01038             Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Address);
01039             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Address);
01040     
01041             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01042             <span class="comment">//</span>
01043             <span class="comment">// compute the memory address where data should be copied</span>
01044             <span class="comment">//</span>
01045             SectorOffsetInBin = Address - <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>;
01046             
01047             <span class="keywordflow">if</span>( ( SectorOffsetInBin == 0 ) &amp;&amp; ( ((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Source)-&gt;Size &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> ) ){
01048                 <span class="comment">//</span>
01049                 <span class="comment">// Bin in the log file is bigger than the one in memory;</span>
01050                 <span class="comment">// two or more bins must have been coalesced</span>
01051                 <span class="comment">//</span>
01052                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; HMAP_NEWALLOC );
01053                 
01054                 SourceBin = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Source;
01055 
01056                 <span class="comment">//</span>
01057                 <span class="comment">// new bin must have the right offset</span>
01058                 <span class="comment">//</span>
01059                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Address == SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> );
01060                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> == HBIN_SIGNATURE );
01061                 <span class="comment">//</span>
01062                 <span class="comment">// entire bin should be dirty</span>
01063                 <span class="comment">//</span>
01064                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) &lt;= End * HSECTOR_SIZE );
01065 
01066                 <span class="comment">//</span>
01067                 <span class="comment">// Allocate the right size for the new bin</span>
01068                 <span class="comment">//</span>
01069                 NewBin = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01070                 <span class="keywordflow">if</span> (NewBin == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01071                     <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01072                 }
01073                 
01074                 <span class="comment">//</span>
01075                 <span class="comment">// Copy the old data into the new bin and free old bins</span>
01076                 <span class="comment">//</span>
01077                 <span class="keywordflow">while</span>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> &lt; (Address + SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)) {
01078                     
01079                     RtlCopyMemory((PUCHAR)NewBin + (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> - Address),Bin, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
01080 
01081                     <span class="comment">//</span>
01082                     <span class="comment">// Do not delist as we didn't enlisted  (when hive needs recovery)</span>
01083                     <span class="comment">//</span>
01084                     <span class="comment">//HvpDelistBinFreeCells(Hive,Bin,Stable,TailDisplay);</span>
01085 
01086                     <span class="comment">//</span>
01087                     <span class="comment">// Advance to the new bin</span>
01088                     <span class="comment">//</span>
01089                     <span class="keywordflow">if</span>( (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> ) {
01090                         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
01091                         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
01092 
01093                         <span class="comment">//</span>
01094                         <span class="comment">// Free the old bin</span>
01095                         <span class="comment">//</span>
01096                         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
01097             
01098                         <span class="comment">//</span>
01099                         <span class="comment">// the new address must be the begining of a new allocation</span>
01100                         <span class="comment">//</span>
01101                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; HMAP_NEWALLOC );
01102                     
01103                         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01104                     } <span class="keywordflow">else</span> {
01105                         <span class="comment">//</span>
01106                         <span class="comment">// we are at the end of the hive here; just break out of the loop</span>
01107                         <span class="comment">//</span>
01108                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (Address + SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) == <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> );
01109                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) == <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> );
01110                         
01111                         <span class="comment">//</span>
01112                         <span class="comment">// Free the old bin</span>
01113                         <span class="comment">//</span>
01114                         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
01115                         
01116                         <span class="comment">//</span>
01117                         <span class="comment">// debug purposes only</span>
01118                         <span class="comment">//</span>
01119                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (Bin = NULL) == NULL );
01120 
01121                         <span class="comment">// bail out of while loop</span>
01122                         <span class="keywordflow">break</span>;
01123                     }
01124     
01125                 }
01126 
01127 <span class="preprocessor">#if DBG</span>
01128 <span class="preprocessor"></span>                <span class="comment">//</span>
01129                 <span class="comment">// validation: bin size increase must come from coalescing of former bins</span>
01130                 <span class="comment">// (i.e. bins are never split!!!)</span>
01131                 <span class="comment">//</span>
01132                 <span class="keywordflow">if</span>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01133                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> == (Address + SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>));
01134                 } 
01135 <span class="preprocessor">#endif</span>
01136 <span class="preprocessor"></span>
01137                 <span class="comment">//</span>
01138                 <span class="comment">// Now overwrite the modified data !</span>
01139                 <span class="comment">//</span>
01140                 
01141                 <span class="keywordflow">while</span>( (Address &lt; (SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)) &amp;&amp; (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) ) {
01142                     RtlCopyMemory((PUCHAR)NewBin + (Address - SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>),Source, HSECTOR_SIZE);
01143                     
01144                     <span class="comment">// </span>
01145                     <span class="comment">// skip to the next sector</span>
01146                     <span class="comment">//</span>
01147                     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>++;
01148                     Source += <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01149                     Address += <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01150                 }
01151 
01152                 <span class="comment">//</span>
01153                 <span class="comment">// first sector of the new bin is always restaured from the log file!</span>
01154                 <span class="comment">//</span>
01155                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NewBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> == SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>);
01156                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NewBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> == SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
01157 
01158             } <span class="keywordflow">else</span> {
01159                 <span class="comment">//</span>
01160                 <span class="comment">// Normal case: sector recovery somewhere in the middle of the bin</span>
01161                 <span class="comment">//</span>
01162 
01163                 
01164                 <span class="comment">//</span>
01165                 <span class="comment">// Do not delist as we didn't enlisted  (when hive needs recovery)</span>
01166                 <span class="comment">//</span>
01167                 <span class="comment">//HvpDelistBinFreeCells(Hive,Bin,Stable,TailDisplay);</span>
01168                 
01169                 <span class="comment">//</span>
01170                 <span class="comment">// Offset should fall within bin memory layout</span>
01171                 <span class="comment">//</span>
01172                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SectorOffsetInBin &lt; Bin-&gt;Size );
01173             
01174                 BlockOffsetInBin = (ULONG)((PUCHAR)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> - (PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>);
01175                 SectorOffsetInBlock = SectorOffsetInBin - BlockOffsetInBin;
01176             
01177                 <span class="comment">//</span>
01178                 <span class="comment">// sanity check; address should  be the same relative to eigther begining of the bin or begining of the block</span>
01179                 <span class="comment">//</span>
01180                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((PUCHAR)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> + SectorOffsetInBlock) == ((PUCHAR)Bin + SectorOffsetInBin));
01181 
01182                 SectorImage = (PUCHAR)((PUCHAR)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> + SectorOffsetInBlock);
01183 
01184                 <span class="comment">//</span>
01185                 <span class="comment">// both source and destination should be valid at this point</span>
01186                 <span class="comment">//</span>
01187                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SectorImage &lt; ((PUCHAR)Bin + Bin-&gt;Size) );
01188                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Source &lt; (MemoryBlock + Length) );
01189 
01190                 NumberOfSectors = 0;
01191                 <span class="keywordflow">while</span>( ( (SectorImage + (NumberOfSectors * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>)) &lt; (PUCHAR)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) ) &amp;&amp;
01192                         ( (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> + NumberOfSectors ) &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> )    ) {
01193                     <span class="comment">//</span>
01194                     <span class="comment">// we are still inside the same bin;</span>
01195                     <span class="comment">// deal with all sectors inside the same bin at once</span>
01196                     <span class="comment">//</span>
01197                     NumberOfSectors++;
01198                 }
01199 
01200                 <span class="comment">//</span>
01201                 <span class="comment">// finally, copy the memory</span>
01202                 <span class="comment">//</span>
01203                 RtlCopyMemory(SectorImage,Source, NumberOfSectors * HSECTOR_SIZE);
01204 
01205                 NewBin = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
01206 
01207                 <span class="comment">//</span>
01208                 <span class="comment">// skip to the next sector</span>
01209                 <span class="comment">//</span>
01210                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> += NumberOfSectors;
01211                 Source += NumberOfSectors * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01212 
01213             }
01214 
01215             <span class="comment">//</span>
01216             <span class="comment">// rebuild the map anyway</span>
01217             <span class="comment">//</span>
01218             <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/hivemap_8c.html#a8">HvpEnlistBinInMap</a>(Hive, Length, NewBin, NewBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>, TailDisplay)) ) {
01219                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01220             }
01221         }
01222     
01223         <span class="comment">//</span>
01224         <span class="comment">// get rid of the temporary pool</span>
01225         <span class="comment">//</span>
01226         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(MemoryBlock);
01227     }
01228 
01229     <span class="comment">//</span>
01230     <span class="comment">// now, after we have successfully recovered, enlist all free cells</span>
01231     <span class="comment">// and restore the hive to it's original state</span>
01232     <span class="comment">//</span>
01233     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> = ReadOnly;
01234 
01235     <span class="keywordflow">if</span>( ReadOnly == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
01236         <span class="comment">//</span>
01237         <span class="comment">// no point going through this loop if the hive is read-only</span>
01238         <span class="comment">//</span>
01239         Address = 0;
01240         <span class="keywordflow">while</span>( Address &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> ) {
01241             Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Address);
01242             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Address);
01243             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01244 
01245             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> == Address );
01246             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> == HBIN_SIGNATURE );
01247 
01248             <span class="comment">//</span>
01249             <span class="comment">// add free cells in the bin to the appropriate free lists</span>
01250             <span class="comment">//</span>
01251             <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d1/hivemap_8c.html#a10">HvpEnlistFreeCells</a>(Hive, Bin, Address,TailDisplay)) {
01252                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Hive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01253                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 0xA004;
01254                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
01255                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = Address;
01256                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
01257                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01258             }
01259         
01260             Address += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
01261         }
01262     }
01263 
01264     <span class="comment">//</span>
01265     <span class="comment">// put correct dirty vector in Hive so that recovered data</span>
01266     <span class="comment">// can be correctly flushed</span>
01267     <span class="comment">//</span>
01268     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>), Vector, VectorSize);
01269     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
01270     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a> = VectorSize * 8;
01271     <a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(Hive, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));  <span class="comment">// force header of 1st bin dirty</span>
01272     <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a11">HiveSuccess</a>;
01273 
01274 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
01275     <span class="comment">//</span>
01276     <span class="comment">// free the dirty vector and return failure</span>
01277     <span class="comment">//</span>
01278     (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(Vector, VectorSize);
01279     <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>;
01280 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a6" doxytag="hiveload.c::BinPoint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a4">BinPoint</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00095">95</a> of file <a class="el" href="../../d7/d0/hiveload_8c-source.html">hiveload.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="hiveload.c::Hive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00091">91</a> of file <a class="el" href="../../d7/d0/hiveload_8c-source.html">hiveload.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="hiveload.c::HvCheckHiveDebug" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> struct { ... }   <a class="el" href="../../d7/d1/hivemap_8c.html#a5">HvCheckHiveDebug</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="hiveload.c::MapPoint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a3">MapPoint</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00094">94</a> of file <a class="el" href="../../d7/d0/hiveload_8c-source.html">hiveload.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="hiveload.c::Space" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d9/ps2_8c.html#a136">Space</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00093">93</a> of file <a class="el" href="../../d7/d0/hiveload_8c-source.html">hiveload.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="hiveload.c::Status" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00092">92</a> of file <a class="el" href="../../d7/d0/hiveload_8c-source.html">hiveload.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
