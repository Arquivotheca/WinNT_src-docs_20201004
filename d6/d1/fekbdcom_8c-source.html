<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fekbdcom.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fekbdcom.c</h1><a href="../../d5/d2/fekbdcom_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/***************************************************************************\</span>
00002 <span class="comment">* Module Name: fekbdcom.c</span>
00003 <span class="comment">* Common FE routines for stub keyboard layout DLLs</span>
00004 <span class="comment">*</span>
00005 <span class="comment">* Copyright (c) 1985-92, Microsoft Corporation</span>
00006 <span class="comment">*</span>
00007 <span class="comment">* History: Created Aug 1997 by Hiro Yamamoto</span>
00008 <span class="comment">\***************************************************************************/</span>
00009 
00010 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00011 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00012 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00013 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00014 <span class="preprocessor">#include &lt;kbd.h&gt;</span>
00015 
00016 <span class="comment">/***************************************************************************\</span>
00017 <span class="comment"> * KbdLayerRealDllFile() returns the name of the real keyboard Dll</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> * Get Dll name from the registry</span>
00020 <span class="comment"> * PATH:"\Registry\Machine\System\CurrentControlSet\Services\i8042prt\Parameters"</span>
00021 <span class="comment"> * VALUE:"LayerDriver" (REG_SZ)</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> * kbdjpn.dll for Japanese and kbdkor.dll for Korean</span>
00024 <span class="comment">\***************************************************************************/</span>
00025 
00026 <span class="preprocessor">#if 0   // FYI: old explanation</span>
00027 <span class="preprocessor"></span><span class="comment">/***************************************************************************\</span>
00028 <span class="comment"> * KbdLayerRealDriverFile() returns the name of the real keyboard driver</span>
00029 <span class="comment"> *</span>
00030 <span class="comment"> * 1) Get Path to the name of safe real driver</span>
00031 <span class="comment"> * KEY: "\Registry\Machine\Hardware\DeviceMap\KeyboardPort"</span>
00032 <span class="comment"> * VALUE: "\Device\KeyboardPort0" (REG_SZ) keeps path in the registry</span>
00033 <span class="comment"> *   e.g. "\REGISTRY\Machine\System\ControlSet001\Services\i8042prt"</span>
00034 <span class="comment"> *                                               ~~~~~~~~~~~~~~~~~~</span>
00035 <span class="comment"> * 2) Create path from the results</span>
00036 <span class="comment"> * "\Registry\Machine\System\CurrentControlSet" + "\Services\i8042prt"  + "\Parameters"</span>
00037 <span class="comment"> *</span>
00038 <span class="comment"> * 3) Get value</span>
00039 <span class="comment"> * PATH: "\Registry\Machine\System\CurrentControlSet\Services\i8042prt\Parameters"</span>
00040 <span class="comment"> * VALUE: "Parameters" (REG_SZ)</span>
00041 <span class="comment"> *</span>
00042 <span class="comment"> * NOTE: default value:</span>
00043 <span class="comment"> *      "KBD101.DLL" for Japanese</span>
00044 <span class="comment"> *      "KBD101A.DLL" for Korean</span>
00045 <span class="comment"> *</span>
00046 <span class="comment"> * kbdjpn.dll and kbdkor.dll</span>
00047 <span class="comment">\***************************************************************************/</span>
00048 <span class="preprocessor">#endif</span>
00049 <span class="preprocessor"></span>
00050 
00051 <span class="preprocessor">#if defined(HIRO_DBG)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#define TRACE(x)    DbgPrint x</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00054"></a><a class="code" href="../../d5/d2/fekbdcom_8c.html#a0">00054</a> <span class="preprocessor"></span><span class="preprocessor">#define TRACE(x)</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00056 <span class="preprocessor"></span>
00057 <span class="comment">/*</span>
00058 <span class="comment"> * Maximum character count</span>
00059 <span class="comment"> */</span>
<a name="l00060"></a><a class="code" href="../../d5/d2/fekbdcom_8c.html#a1">00060</a> <span class="preprocessor">#define MAXBUF_CSIZE    (256)</span>
00061 <span class="preprocessor"></span>
00062 <span class="comment">/*</span>
00063 <span class="comment"> * Null-terminates the wchar string in pKey.</span>
00064 <span class="comment"> * returns pointer to WCHAR string.</span>
00065 <span class="comment"> *</span>
00066 <span class="comment"> * limit: maximum BYTE SIZE</span>
00067 <span class="comment"> */</span>
<a name="l00068"></a><a class="code" href="../../d5/d2/fekbdcom_8c.html#a2">00068</a> __inline LPWSTR <a class="code" href="../../d5/d2/fekbdcom_8c.html#a2">MakeString</a>(PKEY_VALUE_FULL_INFORMATION pKey, size_t limit)
00069 {
00070     LPWSTR pwszHead = (LPWSTR)((LPBYTE)pKey + pKey-&gt;DataOffset);
00071     LPWSTR pwszTail = (LPWSTR)((LPBYTE)pwszHead + pKey-&gt;DataLength);
00072 
00073     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((LPBYTE)pwszTail - (LPBYTE)pKey &lt; (<span class="keywordtype">int</span>)limit );
00074     *pwszTail = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00075 
00076     UNREFERENCED_PARAMETER(limit);  <span class="comment">// just in case</span>
00077 
00078     <span class="keywordflow">return</span> pwszHead;
00079 }
00080 
00081 <span class="preprocessor">#if 0   // not needed any more</span>
00082 <span class="preprocessor"></span><span class="comment">/*</span>
00083 <span class="comment"> * Find L"\services" in the given str.</span>
00084 <span class="comment"> * Case insensitive search.</span>
00085 <span class="comment"> * To avoid the binary size increase,</span>
00086 <span class="comment"> * and since we know the string we're searching only contains</span>
00087 <span class="comment"> * alphabet and backslash,</span>
00088 <span class="comment"> * it's safe here not to use ideal functions (tolower/toupper).</span>
00089 <span class="comment"> */</span>
00090 WCHAR* FindServices(WCHAR* str)
00091 {
00092     CONST WCHAR wszServices[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\services"</span>;
00093 
00094     <span class="keywordflow">while</span> (*str) {
00095         CONST WCHAR* p1;
00096         CONST WCHAR* p2;
00097         <span class="keywordflow">for</span> (p1 = str, p2 = wszServices; *p1 &amp;&amp; *p2; ++p1, ++p2) {
00098             <span class="comment">// we know p2 only contains alphabet and backslash</span>
00099             <span class="keywordflow">if</span> (*p2 != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
00100                 <span class="keywordflow">if</span> ((*p1 != *p2) &amp;&amp; (*p1 + (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'a'</span> - <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span>) != *p2)) {
00101                     <span class="keywordflow">break</span>;
00102                 }
00103             }
00104             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*p1 != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
00105                 <span class="keywordflow">break</span>;
00106             }
00107         }
00108         <span class="keywordflow">if</span> (*p2 == 0) {
00109             <span class="comment">// we found a match !</span>
00110             <span class="keywordflow">return</span> str;
00111         }
00112         ++str;
00113     }
00114     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00115 }
00116 <span class="preprocessor">#endif</span>
00117 <span class="preprocessor"></span>
<a name="l00118"></a><a class="code" href="../../d5/d2/fekbdcom_8c.html#a3">00118</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d2/fekbdcom_8c.html#a3">GetRealDllFileNameWorker</a>(CONST WCHAR* pwszKeyName, WCHAR* RealDllName)
00119 {
00120     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00121     HANDLE              handleService;
00122     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>                fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00123     UNICODE_STRING      servicePath;
00124     OBJECT_ATTRIBUTES   servicePathObjectAttributes;
00125     WCHAR               serviceRegistryPath[<a class="code" href="../../d5/d2/fekbdcom_8c.html#a1">MAXBUF_CSIZE</a>];
00126 
00127     servicePath.Buffer = serviceRegistryPath;
00128     servicePath.Length = 0;
00129     servicePath.MaximumLength = <span class="keyword">sizeof</span> serviceRegistryPath; <span class="comment">// byte count !</span>
00130 
00131     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;servicePath,
00132                              <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\i8042prt\\Parameters"</span>);
00133 
00134     InitializeObjectAttributes(&amp;servicePathObjectAttributes,
00135                                &amp;servicePath,
00136                                OBJ_CASE_INSENSITIVE,
00137                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00138                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00139 
00140     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"Open -&gt; '%ws'\n"</span>,servicePath.Buffer));
00141 
00142     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;handleService, KEY_READ, &amp;servicePathObjectAttributes);
00143 
00144     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00145 
00146         UNICODE_STRING layerName;
00147         WCHAR LayerDllName[<a class="code" href="../../d5/d2/fekbdcom_8c.html#a1">MAXBUF_CSIZE</a>];
00148         ULONG cbStringSize;
00149 
00150         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;layerName, pwszKeyName);
00151         <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"Entry name -&gt; '%ws'\n"</span>, layerName.Buffer));
00152 
00153         <span class="comment">/*</span>
00154 <span class="comment">         * Get the name of the DLL based on the device name.</span>
00155 <span class="comment">         */</span>
00156         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(handleService,
00157                                  &amp;layerName,
00158                                  KeyValueFullInformation,
00159                                  LayerDllName,
00160                                  <span class="keyword">sizeof</span> LayerDllName - <span class="keyword">sizeof</span>(WCHAR),    <span class="comment">// reserves room for L'\0'</span>
00161                                  &amp;cbStringSize);
00162 
00163         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00164             LPWSTR pwszStr = <a class="code" href="../../d5/d2/fekbdcom_8c.html#a2">MakeString</a>((PKEY_VALUE_FULL_INFORMATION)LayerDllName,
00165                                         <span class="keyword">sizeof</span> LayerDllName);
00166 
00167             wcscpy(RealDllName, pwszStr);
00168 
00169             <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"Real Dll name -&gt; '%ws'\n"</span>, RealDllName));
00170 
00171             <span class="comment">//</span>
00172             <span class="comment">// everything went fine.</span>
00173             <span class="comment">//</span>
00174             fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00175         }
00176         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handleService);
00177     }
00178 
00179     <span class="keywordflow">return</span> fRet;
00180 }
00181 
00183 <span class="comment">// This entry is used for backward compatibility.</span>
00184 <span class="comment">// Exported as ordinal 3.</span>
00186 <span class="comment"></span>
<a name="l00187"></a><a class="code" href="../../d5/d2/fekbdcom_8c.html#a4">00187</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d2/fekbdcom_8c.html#a4">KbdLayerRealDllFileNT4</a>(WCHAR *RealDllName)
00188 {
00189     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"KbdLayerRealDllFile():\n"</span>));
00190     <span class="keywordflow">return</span> <a class="code" href="../../d5/d2/fekbdcom_8c.html#a3">GetRealDllFileNameWorker</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"LayerDriver"</span>, RealDllName);
00191 }
00192 
00194 <span class="comment">// This entry is used for remote client of Hydra server.</span>
00195 <span class="comment">//</span>
00196 <span class="comment">// Created: 1988 kazum</span>
00198 <span class="comment"></span>
<a name="l00199"></a><a class="code" href="../../d5/d2/fekbdcom_8c.html#a5">00199</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d2/fekbdcom_8c.html#a5">KbdLayerRealDllFileForWBT</a>(HKL hkl, WCHAR *realDllName, PCLIENTKEYBOARDTYPE pClientKbdType, LPVOID reserve)
00200 {
00201     HANDLE hkRegistry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00202     UNICODE_STRING    deviceMapPath;
00203     OBJECT_ATTRIBUTES deviceMapObjectAttributes;
00204     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00205     HANDLE            handleMap;
00206     HANDLE            handleService;
00207     ULONG             cbStringSize;
00208     PWCHAR            pwszReg;
00209 
00210     UNREFERENCED_PARAMETER(reserve);
00211 
00212     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pClientKbdType != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00213     <span class="comment">/*</span>
00214 <span class="comment">     * Set default keyboard layout for error cases.</span>
00215 <span class="comment">     */</span>
00216     <span class="keywordflow">if</span> (PRIMARYLANGID(LOWORD(hkl)) == LANG_JAPANESE) {
00217         wcscpy(realDllName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"kbd101.dll"</span>);
00218         pwszReg = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Terminal Server\\KeyboardType Mapping\\JPN"</span>;
00219     }
00220     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PRIMARYLANGID(LOWORD(hkl)) == LANG_KOREAN) {
00221         wcscpy(realDllName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"kbd101a.dll"</span>);
00222         pwszReg = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Terminal Server\\KeyboardType Mapping\\KOR"</span>;
00223     }
00224     <span class="keywordflow">else</span> {
00225         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00226     }
00227 
00228 
00229     <span class="comment">/*</span>
00230 <span class="comment">     * Start by opening the registry for keyboard type mapping table.</span>
00231 <span class="comment">     */</span>
00232     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;deviceMapPath, pwszReg);
00233 
00234     InitializeObjectAttributes(&amp;deviceMapObjectAttributes,
00235                                &amp;deviceMapPath,
00236                                OBJ_CASE_INSENSITIVE,
00237                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00238                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00239 
00240     <span class="comment">// DbgPrint("Open -&gt; %ws\n",deviceMapPath.Buffer);</span>
00241 
00242     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;handleMap, KEY_READ, &amp;deviceMapObjectAttributes);
00243 
00244     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00245         WCHAR SubKbdBuffer[16];
00246         WCHAR FuncKeyBuffer[16];
00247         WCHAR SubKbdAndFuncKeyBuffer[32];
00248         UNICODE_STRING SubKbd = {
00249             0, <span class="keyword">sizeof</span> SubKbdBuffer, SubKbdBuffer,
00250         };
00251         UNICODE_STRING FuncKbd = {
00252             0, <span class="keyword">sizeof</span> FuncKeyBuffer, FuncKeyBuffer,
00253         };
00254         UNICODE_STRING SubKbdAndFuncKey = {
00255             0, <span class="keyword">sizeof</span> SubKbdAndFuncKeyBuffer, SubKbdAndFuncKeyBuffer,
00256         };
00257         UCHAR AnsiBuffer[16];
00258         ANSI_STRING AnsiString;
00259         WCHAR LayerDriverName[256];
00260 
00261         <span class="comment">/*</span>
00262 <span class="comment">         * Convert the sub keyboard type to the Ansi string buffer.</span>
00263 <span class="comment">         */</span>
00264         RtlZeroMemory(AnsiBuffer, <span class="keyword">sizeof</span>(AnsiBuffer));
00265         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/cnvint_8c.html#a2">RtlIntegerToChar</a>(pClientKbdType-&gt;SubType, 16<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00266                                   -8, <span class="comment">// length of buffer, but negative means 0 padding</span>
00267                                   AnsiBuffer);
00268         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00269             <span class="comment">/*</span>
00270 <span class="comment">             * Convert the Ansi string buffer to Unicode string buffer.</span>
00271 <span class="comment">             */</span>
00272             AnsiString.Buffer = AnsiBuffer;
00273             AnsiString.MaximumLength = <span class="keyword">sizeof</span> AnsiBuffer;
00274             AnsiString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(AnsiBuffer);
00275             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;SubKbd, &amp;AnsiString, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00276         }
00277         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));     <span class="comment">// Make sure the number is not bad</span>
00278 
00279         <span class="comment">/*</span>
00280 <span class="comment">         * Convert the number of function key to the Ansi string buffer.</span>
00281 <span class="comment">         */</span>
00282         RtlZeroMemory(AnsiBuffer, <span class="keyword">sizeof</span>(AnsiBuffer));
00283         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/cnvint_8c.html#a2">RtlIntegerToChar</a>(pClientKbdType-&gt;FunctionKey, 10<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00284                                   -4, <span class="comment">// length of buffer, but negative means 0 padding</span>
00285                                   AnsiBuffer);
00286         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00287             <span class="comment">/*</span>
00288 <span class="comment">             * Convert the Ansi string buffer to Unicode string buffer.</span>
00289 <span class="comment">             */</span>
00290             AnsiString.Buffer = AnsiBuffer;
00291             AnsiString.MaximumLength = <span class="keyword">sizeof</span> AnsiBuffer;
00292             AnsiString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(AnsiBuffer);
00293             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;FuncKbd, &amp;AnsiString, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00294         }
00295         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));  <span class="comment">// Make sure the number is not bad</span>
00296 
00297 
00298         <span class="comment">/*</span>
00299 <span class="comment">         * Get the sub kbd + function key layout name</span>
00300 <span class="comment">         */</span>
00301         <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;SubKbdAndFuncKey, &amp;SubKbd);
00302         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;SubKbdAndFuncKey, &amp;FuncKbd);
00303         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(handleMap,
00304                                  &amp;SubKbdAndFuncKey,
00305                                  KeyValueFullInformation,
00306                                  LayerDriverName,
00307                                  <span class="keyword">sizeof</span>(LayerDriverName),
00308                                  &amp;cbStringSize);
00309 
00310         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00311 
00312             LayerDriverName[cbStringSize / <span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00313 
00314             wcscpy(realDllName,
00315                    (LPWSTR)((PUCHAR)LayerDriverName +
00316                             ((PKEY_VALUE_FULL_INFORMATION)LayerDriverName)-&gt;DataOffset));
00317 
00318             <span class="comment">// DbgPrint("Real driver name -&gt; %ws\n",realDllName);</span>
00319         }
00320         <span class="keywordflow">else</span> {
00321             <span class="comment">/*</span>
00322 <span class="comment">             * Get the sub kbd layout name</span>
00323 <span class="comment">             */</span>
00324             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(handleMap,
00325                                      &amp;SubKbd,
00326                                      KeyValueFullInformation,
00327                                      LayerDriverName,
00328                                      <span class="keyword">sizeof</span>(LayerDriverName),
00329                                      &amp;cbStringSize);
00330 
00331             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00332 
00333                 LayerDriverName[cbStringSize / <span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00334 
00335                 wcscpy(realDllName,
00336                        (LPWSTR)((PUCHAR)LayerDriverName +
00337                                 ((PKEY_VALUE_FULL_INFORMATION)LayerDriverName)-&gt;DataOffset));
00338 
00339                 <span class="comment">// DbgPrint("Real driver name -&gt; %ws\n",realDllName);</span>
00340             }
00341         }
00342 
00343         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handleMap);
00344     }
00345 
00346     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00347 }
00348 
00349 
<a name="l00350"></a><a class="code" href="../../d5/d2/fekbdcom_8c.html#a6">00350</a> __inline WCHAR* <a class="code" href="../../d5/d2/fekbdcom_8c.html#a6">wszcpy</a>(WCHAR* target, CONST WCHAR* src)
00351 {
00352     <span class="keywordflow">while</span> (*target++ = *src++);
00353     <span class="keywordflow">return</span> target - 1;
00354 }
00355 
00356 
00358 <span class="comment">// KbdLayerRealDllFile</span>
00359 <span class="comment">//</span>
00360 <span class="comment">// Enhanced version of KbdLayerRealDllFile:</span>
00361 <span class="comment">// Distinguishes KOR and JPN.</span>
00363 <span class="comment"></span>
<a name="l00364"></a><a class="code" href="../../d5/d2/fekbdcom_8c.html#a7">00364</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d2/fekbdcom_8c.html#a7">KbdLayerRealDllFile</a>(HKL hkl, WCHAR *realDllName, PCLIENTKEYBOARDTYPE pClientKbdType, LPVOID reserve)
00365 {
00366     WCHAR pwszBuff[32];
00367     WCHAR* pwszTail;
00368     LPCWSTR pwsz;
00369 
00370     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PRIMARYLANGID(LOWORD(hkl)) == LANG_JAPANESE ||
00371            PRIMARYLANGID(LOWORD(hkl)) == LANG_KOREAN);
00372 
00373     <span class="keywordflow">if</span> (pClientKbdType != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00374         <span class="comment">//</span>
00375         <span class="comment">// HYDRA case</span>
00376         <span class="comment">//</span>
00377         <span class="keywordflow">return</span> <a class="code" href="../../d5/d2/fekbdcom_8c.html#a5">KbdLayerRealDllFileForWBT</a>(hkl, realDllName, pClientKbdType, reserve);
00378     }
00379 
00380     <span class="keywordflow">if</span> (PRIMARYLANGID(LOWORD(hkl)) == LANG_JAPANESE) {
00381         pwsz = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">" JPN"</span>;
00382     }
00383     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PRIMARYLANGID(LOWORD(hkl)) == LANG_KOREAN) {
00384         pwsz = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">" KOR"</span>;
00385     }
00386     <span class="keywordflow">else</span> {
00387         pwsz = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
00388     }
00389 
00390     pwszTail = <a class="code" href="../../d5/d2/fekbdcom_8c.html#a6">wszcpy</a>(pwszBuff, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"LayerDriver"</span>);
00391     <span class="keywordflow">if</span> (*pwsz) {
00392         <a class="code" href="../../d5/d2/fekbdcom_8c.html#a6">wszcpy</a>(pwszTail, pwsz);
00393     }
00394 
00395     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"KbdLayerRealDllFileEx: fetching '%S'\n"</span>, pwszBuff));
00396 
00397     <span class="keywordflow">return</span> <a class="code" href="../../d5/d2/fekbdcom_8c.html#a3">GetRealDllFileNameWorker</a>(pwszBuff, realDllName);
00398 }
00399 
00400 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:00 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
