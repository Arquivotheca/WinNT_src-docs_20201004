<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mmquota.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mmquota.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d7/d0/mmquota_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a0">MM_MAXIMUM_QUOTA_OVERCHARGE</a>&nbsp;&nbsp;&nbsp;9</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a1">MM_DONT_EXTEND_SIZE</a>&nbsp;&nbsp;&nbsp;512</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a2">MM_COMMIT_POPUP_MAX</a>&nbsp;&nbsp;&nbsp;((512*1024)/PAGE_SIZE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a3">MM_EXTEND_COMMIT</a>&nbsp;&nbsp;&nbsp;((1024*1024)/PAGE_SIZE)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a14">MiCauseOverCommitPopup</a> (IN SIZE_T NumberOfPages, IN ULONG Extension)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a15">MiChargePageFileQuota</a> (IN SIZE_T QuotaCharge, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a16">MiReturnPageFileQuota</a> (IN SIZE_T QuotaCharge, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (IN SIZE_T QuotaCharge, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (IN SIZE_T QuotaCharge, IN ULONG MustSucceed)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (IN SIZE_T QuotaCharge)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a20">MiCalculatePageCommitment</a> (IN PVOID StartingAddress, IN PVOID EndingAddress, IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a21">MiReturnPageTablePageCommitment</a> (IN PVOID StartingAddress, IN PVOID EndingAddress, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess, IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> PreviousVad, IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NextVad)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a22">MiCauseOverCommitPopup</a> (SIZE_T NumberOfPages, IN ULONG Extension)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a23">MmRaisePoolQuota</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN SIZE_T OldQuotaLimit, OUT PSIZE_T NewQuotaLimit)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a24">MmReturnPoolQuota</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN SIZE_T ReturnedQuota)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a4">MmPeakCommitment</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a5">MmExtendedCommit</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a6">MmExtendedCommitLimit</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a7">MiCommitExtensionActive</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG_PTR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a8">MmAllocatedPagedPool</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a10">MiOverCommitCallCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">EPROCESS_QUOTA_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a12">MmTotalPagedPoolQuota</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/mmquota_8c.html#a13">MmTotalNonPagedPoolQuota</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="mmquota.c::MM_COMMIT_POPUP_MAX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_COMMIT_POPUP_MAX&nbsp;&nbsp;&nbsp;((512*1024)/PAGE_SIZE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00029">29</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01001">MiCauseOverCommitPopup()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="mmquota.c::MM_DONT_EXTEND_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_DONT_EXTEND_SIZE&nbsp;&nbsp;&nbsp;512          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00027">27</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">MiChargeCommitmentCantExpand()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="mmquota.c::MM_EXTEND_COMMIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_EXTEND_COMMIT&nbsp;&nbsp;&nbsp;((1024*1024)/PAGE_SIZE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00031">31</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="mmquota.c::MM_MAXIMUM_QUOTA_OVERCHARGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_MAXIMUM_QUOTA_OVERCHARGE&nbsp;&nbsp;&nbsp;9          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00025">25</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a20" doxytag="mmquota.c::MiCalculatePageCommitment" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T MiCalculatePageCommitment           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>EndingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vad</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00519">519</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00437">MiDoesPdeExistAndMakeValid()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01980">MiDoesPpeExistAndMakeValid</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00042">MiIsPteDecommittedPage()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, and <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00528                    :
00529 
00530     This routine examines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range of pages from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting address
00531     up to and including <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ending address and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> commit charge
00532     <span class="keywordflow">for</span>  <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
00533 
00534 Arguments:
00535 
00536     StartingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
00537 
00538     EndingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ending address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
00539 
00540     Vad - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address descriptor which describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
00541 
00542     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
00543 
00544 Return Value:
00545 
00546     Commitment charge <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
00547 
00548 Environment:
00549 
00550     Kernel mode, APCs disabled, WorkingSetLock and AddressCreation mutexes
00551     held.
00552 
00553 --*/
00554 
00555 {
00556     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00557     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00558     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00559     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00560     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> TempEnd;
00561     SIZE_T NumberOfCommittedPages;
00562     ULONG Waited;
00563 
00564     NumberOfCommittedPages = 0;
00565 
00566     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
00567     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
00568     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
00569 
00570     <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.MemCommit == 1) {
00571 
00572         TempEnd = EndingAddress;
00573 
00574         <span class="comment">//</span>
00575         <span class="comment">// All the pages are committed within this range.</span>
00576         <span class="comment">//</span>
00577 
00578         NumberOfCommittedPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> ((PCHAR)TempEnd -
00579                                                        (PCHAR)StartingAddress);
00580 
00581 
00582         <span class="comment">//</span>
00583         <span class="comment">// Examine the PTEs to determine how many pages are committed.</span>
00584         <span class="comment">//</span>
00585 
00586         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (TempEnd);
00587 
00588         <span class="keywordflow">do</span> {
00589 
00590             <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00591                                                 Process,
00592                                                 FALSE,
00593                                                 &amp;Waited)) {
00594     
00595                 <span class="comment">//</span>
00596                 <span class="comment">// No PPE exists for the starting address, therefore the page</span>
00597                 <span class="comment">// is not committed.</span>
00598                 <span class="comment">//</span>
00599     
00600                 PointerPpe += 1;
00601                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00602                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00603                 <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
00604                     <span class="keywordflow">goto</span> DoneCommit;
00605                 }
00606             }
00607 
00608             Waited = 0;
00609 
00610             <span class="keywordflow">while</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00611                                                 Process,
00612                                                 FALSE,
00613                                                 &amp;Waited)) {
00614     
00615                 <span class="comment">//</span>
00616                 <span class="comment">// No PDE exists for the starting address, therefore the page</span>
00617                 <span class="comment">// is not committed.</span>
00618                 <span class="comment">//</span>
00619     
00620                 PointerPde += 1;
00621                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00622                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00623                 <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
00624                     <span class="keywordflow">goto</span> DoneCommit;
00625                 }
00626 <span class="preprocessor">#if defined (_WIN64)</span>
00627 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
00628                     Waited = 1;
00629                     <span class="keywordflow">break</span>;
00630                 }
00631 <span class="preprocessor">#endif</span>
00632 <span class="preprocessor"></span>            }
00633 
00634         } <span class="keywordflow">while</span> (Waited != 0);
00635 
00636 restart:
00637 
00638         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00639 
00640             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
00641 
00642                 <span class="comment">//</span>
00643                 <span class="comment">// This is a PDE boundary, check to see if the entire</span>
00644                 <span class="comment">// PPE/PDE pages exist.</span>
00645                 <span class="comment">//</span>
00646 
00647                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00648                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00649 
00650                 <span class="keywordflow">do</span> {
00651 
00652                     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00653                                                      Process,
00654                                                      FALSE,
00655                                                      &amp;Waited)) {
00656     
00657                         <span class="comment">//</span>
00658                         <span class="comment">// No PDE exists for the starting address, check the VAD</span>
00659                         <span class="comment">// to see if the pages are not committed.</span>
00660                         <span class="comment">//</span>
00661     
00662                         PointerPpe += 1;
00663                         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00664                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00665     
00666                         <span class="comment">//</span>
00667                         <span class="comment">// Check next page.</span>
00668                         <span class="comment">//</span>
00669     
00670                         <span class="keywordflow">goto</span> restart;
00671                     }
00672     
00673                     Waited = 0;
00674     
00675                     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00676                                                      Process,
00677                                                      FALSE,
00678                                                      &amp;Waited)) {
00679     
00680                         <span class="comment">//</span>
00681                         <span class="comment">// No PDE exists for the starting address, check the VAD</span>
00682                         <span class="comment">// to see if the pages are not committed.</span>
00683                         <span class="comment">//</span>
00684     
00685                         PointerPde += 1;
00686                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00687                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00688     
00689                         <span class="comment">//</span>
00690                         <span class="comment">// Check next page.</span>
00691                         <span class="comment">//</span>
00692     
00693                         <span class="keywordflow">goto</span> restart;
00694                     }
00695                 } <span class="keywordflow">while</span> (Waited != 0);
00696             }
00697 
00698             <span class="comment">//</span>
00699             <span class="comment">// The PDE exists, examine the PTE.</span>
00700             <span class="comment">//</span>
00701 
00702             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
00703 
00704                 <span class="comment">//</span>
00705                 <span class="comment">// Has this page been explicitly decommitted?</span>
00706                 <span class="comment">//</span>
00707 
00708                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a3">MiIsPteDecommittedPage</a> (PointerPte)) {
00709 
00710                     <span class="comment">//</span>
00711                     <span class="comment">// This page is decommitted, remove it from the count.</span>
00712                     <span class="comment">//</span>
00713 
00714                     NumberOfCommittedPages -= 1;
00715 
00716                 }
00717             }
00718 
00719             PointerPte += 1;
00720         }
00721 
00722 DoneCommit:
00723 
00724         <span class="keywordflow">if</span> (TempEnd == EndingAddress) {
00725             <span class="keywordflow">return</span> NumberOfCommittedPages;
00726         }
00727 
00728     }
00729 
00730     <span class="comment">//</span>
00731     <span class="comment">// Examine non committed range.</span>
00732     <span class="comment">//</span>
00733 
00734     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
00735 
00736     <span class="keywordflow">do</span> {
00737 
00738         <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00739                                             Process,
00740                                             FALSE,
00741                                             &amp;Waited)) {
00742     
00743     
00744             <span class="comment">//</span>
00745             <span class="comment">// No PDE exists for the starting address, therefore the page</span>
00746             <span class="comment">// is not committed.</span>
00747             <span class="comment">//</span>
00748     
00749             PointerPpe += 1;
00750             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00751             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00752             <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
00753                <span class="keywordflow">return</span> NumberOfCommittedPages;
00754             }
00755         }
00756 
00757         Waited = 0;
00758 
00759         <span class="keywordflow">while</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00760                                             Process,
00761                                             FALSE,
00762                                             &amp;Waited)) {
00763     
00764             <span class="comment">//</span>
00765             <span class="comment">// No PDE exists for the starting address, therefore the page</span>
00766             <span class="comment">// is not committed.</span>
00767             <span class="comment">//</span>
00768     
00769             PointerPde += 1;
00770             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00771             <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
00772                <span class="keywordflow">return</span> NumberOfCommittedPages;
00773             }
00774 <span class="preprocessor">#if defined (_WIN64)</span>
00775 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
00776                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00777                 Waited = 1;
00778                 <span class="keywordflow">break</span>;
00779             }
00780 <span class="preprocessor">#endif</span>
00781 <span class="preprocessor"></span>        }
00782 
00783     } <span class="keywordflow">while</span> (Waited != 0);
00784 
00785 restart2:
00786 
00787     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00788 
00789         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
00790 
00791             <span class="comment">//</span>
00792             <span class="comment">// This is a PDE boundary, check to see if the entire</span>
00793             <span class="comment">// PPE/PDE pages exist.</span>
00794             <span class="comment">//</span>
00795 
00796             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00797             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00798 
00799             <span class="keywordflow">do</span> {
00800 
00801                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00802                                                  Process,
00803                                                  FALSE,
00804                                                  &amp;Waited)) {
00805     
00806                     <span class="comment">//</span>
00807                     <span class="comment">// No PPE exists for the starting address, check the VAD</span>
00808                     <span class="comment">// to see if the pages are not committed.</span>
00809                     <span class="comment">//</span>
00810     
00811                     PointerPpe += 1;
00812                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00813                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00814     
00815                     <span class="comment">//</span>
00816                     <span class="comment">// Check next page.</span>
00817                     <span class="comment">//</span>
00818     
00819                     <span class="keywordflow">goto</span> restart2;
00820                 }
00821     
00822                 Waited = 0;
00823     
00824                 <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00825                                                  Process,
00826                                                  FALSE,
00827                                                  &amp;Waited)) {
00828     
00829                     <span class="comment">//</span>
00830                     <span class="comment">// No PDE exists for the starting address, check the VAD</span>
00831                     <span class="comment">// to see if the pages are not committed.</span>
00832                     <span class="comment">//</span>
00833     
00834                     PointerPde += 1;
00835                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00836                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00837     
00838                     <span class="comment">//</span>
00839                     <span class="comment">// Check next page.</span>
00840                     <span class="comment">//</span>
00841     
00842                     <span class="keywordflow">goto</span> restart2;
00843                 }
00844 
00845             } <span class="keywordflow">while</span> (Waited != 0);
00846         }
00847 
00848         <span class="comment">//</span>
00849         <span class="comment">// The PDE exists, examine the PTE.</span>
00850         <span class="comment">//</span>
00851 
00852         <span class="keywordflow">if</span> ((PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) &amp;&amp;
00853              (!<a class="code" href="../../d0/d2/mmsup_8c.html#a3">MiIsPteDecommittedPage</a> (PointerPte))) {
00854 
00855             <span class="comment">//</span>
00856             <span class="comment">// This page is committed, count it.</span>
00857             <span class="comment">//</span>
00858 
00859             NumberOfCommittedPages += 1;
00860         }
00861 
00862         PointerPte += 1;
00863     }
00864 
00865     <span class="keywordflow">return</span> NumberOfCommittedPages;
00866 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="mmquota.c::MiCauseOverCommitPopup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiCauseOverCommitPopup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPages</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Extension</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01001">1001</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08909">IoRaiseInformationalHardError()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00039">MiCommitExtensionActive</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05162">MiOverCommitCallCount</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00029">MM_COMMIT_POPUP_MAX</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00078">MmExtendedCommit</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00037">MmExtendedCommitLimit</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00043">MmPageFileFullExtendPages</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00042">MmPeakCommitment</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00100">MmTotalCommitLimitMaximum</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00040">MmTotalCommittedPages</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01008                    :
01009 
01010     This function causes an over commit popup to occur.  If a popup <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> pending
01011     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.  Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> queues a popup to a noncritical worker
01012     thread.
01013 
01014 Arguments:
01015 
01016     NumberOfPages - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of pages of commit requested.
01017 
01018     Extension - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> to grant.
01019 
01020 Return Value:
01021 
01022     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - An overcommit popup was queued.
01023 
01024     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - An overcommit popup <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> still pending and will not be queued.
01025 
01026 --*/
01027 
01028 {
01029     KIRQL OldIrql;
01030     BOOLEAN RaisedPopup;
01031     ULONG PopupNumber;
01032 
01033     <span class="keywordflow">if</span> (NumberOfPages &gt; <a class="code" href="../../d6/d1/mmquota_8c.html#a2">MM_COMMIT_POPUP_MAX</a> ||
01034         <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + NumberOfPages &gt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a>) {
01035             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01036     }
01037 
01038     <span class="comment">//</span>
01039     <span class="comment">// Give the user a meaningful message - either to increase the minimum,</span>
01040     <span class="comment">// maximum, or both.</span>
01041     <span class="comment">//</span>
01042 
01043     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &gt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> - 100) {
01044         PopupNumber = STATUS_COMMITMENT_LIMIT;
01045     }
01046     <span class="keywordflow">else</span> {
01047         PopupNumber = STATUS_COMMITMENT_MINIMUM;
01048     }
01049 
01050     RaisedPopup = <a class="code" href="../../d4/d6/iosubs_8c.html#a94">IoRaiseInformationalHardError</a> (PopupNumber, NULL, NULL);
01051 
01052     ExAcquireFastLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
01053 
01054     <span class="keywordflow">if</span> ((RaisedPopup == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (<a class="code" href="../../d4/d8/mi_8h.html#a744">MiOverCommitCallCount</a> &gt; 0)) {
01055 
01056         <span class="comment">//</span>
01057         <span class="comment">// There is already a popup outstanding and we have not</span>
01058         <span class="comment">// returned any of the quota.</span>
01059         <span class="comment">//</span>
01060 
01061         ExReleaseFastLock (&amp;MmChargeCommitmentLock, OldIrql);
01062         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01063     }
01064 
01065     <span class="comment">//</span>
01066     <span class="comment">// Now that the commitment lock is held, ensure the commit is not being</span>
01067     <span class="comment">// raised past the absolute maximum.</span>
01068     <span class="comment">//</span>
01069 
01070     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + NumberOfPages &gt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a>) {
01071         ExReleaseFastLock (&amp;MmChargeCommitmentLock, OldIrql);
01072         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01073     }
01074 
01075     <span class="comment">//</span>
01076     <span class="comment">// Don't automatically grant increases forever as this can allow the</span>
01077     <span class="comment">// system to run out of available pages.</span>
01078     <span class="comment">//</span>
01079 
01080     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a35">MmExtendedCommit</a> &gt; 1024) {
01081         ExReleaseFastLock (&amp;MmChargeCommitmentLock, OldIrql);
01082         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01083     }
01084 
01085     <a class="code" href="../../d4/d8/mi_8h.html#a744">MiOverCommitCallCount</a> += 1;
01086 
01087     <a class="code" href="../../d6/d1/mmquota_8c.html#a7">MiCommitExtensionActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01088 
01089     <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> += Extension;
01090     <a class="code" href="../../d6/d1/mmquota_8c.html#a6">MmExtendedCommitLimit</a> += Extension;
01091 
01092     <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> += NumberOfPages;
01093 
01094     <span class="comment">//</span>
01095     <span class="comment">// The caller will not release this commit, so we must earmark it now</span>
01096     <span class="comment">// for later release.</span>
01097     <span class="comment">//</span>
01098 
01099     <span class="keywordflow">if</span> (Extension == 0) {
01100         <a class="code" href="../../d8/d5/kddata_8c.html#a35">MmExtendedCommit</a> += NumberOfPages;
01101     }
01102 
01103     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a5">MmPeakCommitment</a>) &amp;&amp;
01104         (<a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a> == 0)) {
01105         <a class="code" href="../../d6/d8/sysinfo_8c.html#a5">MmPeakCommitment</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>;
01106     }
01107 
01108     ExReleaseFastLock (&amp;MmChargeCommitmentLock, OldIrql);
01109 
01110     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01111 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="mmquota.c::MiCauseOverCommitPopup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiCauseOverCommitPopup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPages</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Extension</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="mmquota.c::MiChargeCommitment" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL FASTCALL MiChargeCommitment           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>QuotaCharge</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">191</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02213">_MMPAGE_FILE_EXPANSION::ActualExpansion</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02214">_MMPAGE_FILE_EXPANSION::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01039">LOCK_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01120">LOCK_WS_REGARDLESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01044">LOCK_WS_UNSAFE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02219">MI_EXTEND_ANY_PAGEFILE</a>, <a class="el" href="../../d6/d3/modwrite_8c.html#a38">MiCauseOverCommitPopup()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">MiChargeCommitmentCantExpand()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04911">MiIssuePageExtendRequest()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00031">MM_EXTEND_COMMIT</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00025">MM_MAXIMUM_QUOTA_OVERCHARGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00043">MmPageFileFullExtendPages</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00042">MmPeakCommitment</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00040">MmTotalCommittedPages</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02216">_MMPAGE_FILE_EXPANSION::PageFileNumber</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02212">_MMPAGE_FILE_EXPANSION::RequestedExpansionSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02210">_MMPAGE_FILE_EXPANSION::Segment</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01109">UNLOCK_WS_REGARDLESS</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04018">MiCreatePagingFileMap()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04222">MiInitializeSessionPool()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00030">MiInsertVad()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02256">MiMapViewOfDataSection()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02144">MiSessionCommitImagePages()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02318">MiSessionCommitPageTables()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01881">MiSessionInitializeWorkingSetList()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">MiShareSessionImage()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02450">MmCreateKernelStack()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00190">MmCreateProcessAddressSpace()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, and <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>.
<p>
<pre class="fragment"><div>00198                    :
00199 
00200     This routine checks to ensure <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has sufficient page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00201     space remaining.
00202 
00203 Arguments:
00204 
00205     QuotaCharge - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota amount to charge.
00206 
00207     Process - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process <a class="code" href="../../d2/d0/aw_8h.html#a1">IF</a> AND ONLY <a class="code" href="../../d2/d0/aw_8h.html#a1">IF</a>
00208               <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00209               <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being extended, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> released <span class="keywordflow">if</span>
00210               <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> non-null.
00211 
00212 Return Value:
00213 
00214     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> sufficient space, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
00215 
00216 Environment:
00217 
00218     Kernel mode, APCs disabled, WorkingSetLock and AddressCreation mutexes
00219     held.
00220 
00221 --*/
00222 
00223 {
00224     KIRQL OldIrql;
00225     SIZE_T NewCommitValue;
00226     <a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">MMPAGE_FILE_EXPANSION</a> PageExtend;
00227     LOGICAL WsHeldSafe;
00228 
00229 <span class="preprocessor">#if !defined (_WIN64)</span>
00230 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (QuotaCharge &lt; 0x100000);
00231 <span class="preprocessor">#endif</span>
00232 <span class="preprocessor"></span>
00233     ExAcquireFastLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
00234 
00235     NewCommitValue = <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + QuotaCharge;
00236 
00237     <span class="keywordflow">while</span> (NewCommitValue &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>) {
00238 
00239         ExReleaseFastLock (&amp;MmChargeCommitmentLock, OldIrql);
00240 
00241         <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00242 
00243             <span class="comment">//</span>
00244             <span class="comment">// The working set lock may have been acquired safely or unsafely</span>
00245             <span class="comment">// by our caller.  Handle both cases here and below.</span>
00246             <span class="comment">//</span>
00247 
00248             <a class="code" href="../../d4/d8/mi_8h.html#a164">UNLOCK_WS_REGARDLESS</a>(Process, WsHeldSafe);
00249         }
00250 
00251         <span class="comment">//</span>
00252         <span class="comment">// Queue a message to the segment dereferencing / pagefile extending</span>
00253         <span class="comment">// thread to see if the page file can be extended.  This is done</span>
00254         <span class="comment">// in the context of a system thread due to mutexes which may</span>
00255         <span class="comment">// currently be held.</span>
00256         <span class="comment">//</span>
00257 
00258         PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o2">RequestedExpansionSize</a> = QuotaCharge;
00259         PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o0">Segment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00260         PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o6">PageFileNumber</a> = <a class="code" href="../../d4/d8/mi_8h.html#a221">MI_EXTEND_ANY_PAGEFILE</a>;
00261         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o4">Event</a>, NotificationEvent, FALSE);
00262 
00263         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a58">MiIssuePageExtendRequest</a> (&amp;PageExtend) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00264 
00265             <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00266                 <a class="code" href="../../d4/d8/mi_8h.html#a165">LOCK_WS_REGARDLESS</a>(Process, WsHeldSafe);
00267             }
00268 
00269             <span class="comment">//</span>
00270             <span class="comment">// If the quota is small enough, commit it anyway.  Otherwise</span>
00271             <span class="comment">// return an error.</span>
00272             <span class="comment">//</span>
00273 
00274             <span class="keywordflow">if</span> (QuotaCharge &lt; <a class="code" href="../../d6/d1/mmquota_8c.html#a0">MM_MAXIMUM_QUOTA_OVERCHARGE</a>) {
00275 
00276                 <span class="comment">//</span>
00277                 <span class="comment">// Try the can't expand routine.</span>
00278                 <span class="comment">//</span>
00279 
00280                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (QuotaCharge, FALSE) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00281                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00282                 }
00283             } <span class="keywordflow">else</span> {
00284 
00285                 <span class="comment">//</span>
00286                 <span class="comment">// Put up a popup and grant an extension if possible.</span>
00287                 <span class="comment">//</span>
00288 
00289                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a38">MiCauseOverCommitPopup</a> (QuotaCharge, MM_EXTEND_COMMIT) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00290                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00291                 }
00292             }
00293             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00294         }
00295 
00296         <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00297             <span class="keywordflow">if</span> (WsHeldSafe == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00298                 <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (Process);
00299             }
00300             <span class="keywordflow">else</span> {
00301                 <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
00302             }
00303         }
00304 
00305         <span class="keywordflow">if</span> (PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o3">ActualExpansion</a> == 0) {
00306             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a38">MiCauseOverCommitPopup</a> (QuotaCharge, MM_EXTEND_COMMIT) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00307                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00308             }
00309             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00310         }
00311 
00312         ExAcquireFastLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
00313         NewCommitValue = <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + QuotaCharge;
00314     }
00315 
00316     <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> = NewCommitValue;
00317     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a5">MmPeakCommitment</a>) &amp;&amp;
00318         (<a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a> == 0)) {
00319         <a class="code" href="../../d6/d8/sysinfo_8c.html#a5">MmPeakCommitment</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>;
00320     }
00321 
00322     ExReleaseFastLock (&amp;MmChargeCommitmentLock, OldIrql);
00323 
00324     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00325 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="mmquota.c::MiChargeCommitmentCantExpand" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL FASTCALL MiChargeCommitmentCantExpand           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>QuotaCharge</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MustSucceed</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">329</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02211">_MMPAGE_FILE_EXPANSION::DereferenceList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02215">_MMPAGE_FILE_EXPANSION::InProgress</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02197">_MMDEREFERENCE_SEGMENT_HEADER::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02195">_MMDEREFERENCE_SEGMENT_HEADER::Lock</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00027">MM_DONT_EXTEND_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05073">MmAttemptForCantExtend</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04944">MmDereferenceSegmentHeader</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00100">MmTotalCommitLimitMaximum</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00040">MmTotalCommittedPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02212">_MMPAGE_FILE_EXPANSION::RequestedExpansionSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02196">_MMDEREFERENCE_SEGMENT_HEADER::Semaphore</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l02824">MiAddWorkingSetPage()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03179">MiAddWsleHash()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">MiAllocatePoolPages()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03472">MiAllocateSpecialPool()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03484">MiFillSystemPageDirectory()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04709">MiPageFileFull()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03942">MmAllocateIndependentPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05581">MmAllocateNonCachedMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, and <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.
<p>
<pre class="fragment"><div>00336                    :
00337 
00338     This routine charges <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified commitment without attempting
00339     to expand paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> and waiting <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> expansion.  The routine
00340     determines <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> exhausted, and <span class="keywordflow">if</span> so,
00341     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> attempts to ascertain <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> space could be expanded.
00342 
00343 Arguments:
00344 
00345     QuotaCharge - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota amount to charge.
00346 
00347     MustSucceed - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> charge must succeed.
00348 
00349 Return Value:
00350 
00351     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> commitment was permitted, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
00352 
00353 Environment:
00354 
00355     Kernel mode, APCs disabled.
00356 
00357 --*/
00358 
00359 {
00360     KIRQL OldIrql;
00361     SIZE_T NewCommitValue;
00362     SIZE_T ExtendAmount;
00363 
00364     ExAcquireFastLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
00365 
00366     <span class="comment">//</span>
00367     <span class="comment">// If the overcommitment is bigger than 512 pages, don't extend.</span>
00368     <span class="comment">//</span>
00369 
00370     NewCommitValue = <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + QuotaCharge;
00371 
00372     <span class="keywordflow">if</span> (!MustSucceed) {
00373 
00374         <span class="keywordflow">if</span> (NewCommitValue &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>) {
00375 
00376             <span class="keywordflow">if</span> ((NewCommitValue - <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> &gt; <a class="code" href="../../d6/d1/mmquota_8c.html#a1">MM_DONT_EXTEND_SIZE</a>) ||
00377                 (NewCommitValue &lt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>) ||
00378                 (NewCommitValue &gt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a>)) {
00379 
00380                     ExReleaseFastLock (&amp;MmChargeCommitmentLock, OldIrql);
00381                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00382             }
00383         }
00384         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NewCommitValue &gt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a>) {
00385             ExReleaseFastLock (&amp;MmChargeCommitmentLock, OldIrql);
00386             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00387         }
00388     }
00389 
00390     ExtendAmount = NewCommitValue - <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>;
00391     <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> = NewCommitValue;
00392 
00393     <span class="keywordflow">if</span> (NewCommitValue &gt; (<a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> + 20)) {
00394 
00395         <span class="comment">//</span>
00396         <span class="comment">// Attempt to expand the paging file, but don't wait</span>
00397         <span class="comment">// to see if it succeeds.</span>
00398         <span class="comment">//</span>
00399 
00400         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o5">InProgress</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00401 
00402             <span class="comment">//</span>
00403             <span class="comment">// An expansion request is already in progress, assume</span>
00404             <span class="comment">// this will succeed.</span>
00405             <span class="comment">//</span>
00406 
00407             ExReleaseFastLock (&amp;MmChargeCommitmentLock, OldIrql);
00408             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00409         }
00410 
00411         <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o5">InProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00412         ExReleaseFastLock (&amp;MmChargeCommitmentLock, OldIrql);
00413 
00414         <span class="comment">//</span>
00415         <span class="comment">// Queue a message to the segment dereferencing / pagefile extending</span>
00416         <span class="comment">// thread to see if the page file can be extended.  This is done</span>
00417         <span class="comment">// in the context of a system thread due to mutexes which may</span>
00418         <span class="comment">// currently be held.</span>
00419         <span class="comment">//</span>
00420 
00421         <span class="keywordflow">if</span> (QuotaCharge &gt; ExtendAmount) {
00422             ExtendAmount = QuotaCharge;
00423         }
00424 
00425         <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o2">RequestedExpansionSize</a> = ExtendAmount;
00426         ExAcquireFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, &amp;OldIrql);
00427         InsertTailList ( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>,
00428                          &amp;<a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o1">DereferenceList</a>);
00429         ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
00430 
00431         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o1">Semaphore</a>, 0L, 1L, FALSE);
00432     }
00433     <span class="keywordflow">else</span> {
00434         ExReleaseFastLock (&amp;MmChargeCommitmentLock, OldIrql);
00435     }
00436 
00437     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00438 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="mmquota.c::MiChargePageFileQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG FASTCALL MiChargePageFileQuota           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>QuotaCharge</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentProcess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00058">58</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
References <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00114">_EPROCESS_QUOTA_BLOCK::PagefileLimit</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00113">_EPROCESS_QUOTA_BLOCK::PagefileUsage</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00112">_EPROCESS_QUOTA_BLOCK::PeakPagefileUsage</a>, <a class="el" href="../../d1/d9/ps_8h.html#a34">PEPROCESS_QUOTA_BLOCK</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00046">PspDefaultQuotaBlock</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00107">_EPROCESS_QUOTA_BLOCK::QuotaLock</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00030">MiInsertVad()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>, and <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00065                    :
00066 
00067     This routine checks to ensure <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user has sufficient page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00068     quota remaining and, <span class="keywordflow">if</span> so, charges <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota.  If not an exception
00069     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised.
00070 
00071 Arguments:
00072 
00073     QuotaCharge - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota amount to charge.
00074 
00075     CurrentProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
00076 
00077 Return Value:
00078 
00079     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota was successfully charged, raises an exception
00080     otherwise.
00081 
00082 Environment:
00083 
00084     Kernel mode, APCs disabled, WorkingSetLock and AddressCreation mutexes
00085     held.
00086 
00087 --*/
00088 
00089 {
00090     SIZE_T NewPagefileValue;
00091     <a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">PEPROCESS_QUOTA_BLOCK</a> QuotaBlock;
00092     KIRQL OldIrql;
00093 
00094     QuotaBlock = CurrentProcess-&gt;QuotaBlock;
00095 
00096 retry_charge:
00097     <span class="keywordflow">if</span> ( QuotaBlock != &amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>) {
00098         ExAcquireFastLock (&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,&amp;OldIrql);
00099 do_charge:
00100         NewPagefileValue = QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o6">PagefileUsage</a> + QuotaCharge;
00101 
00102         <span class="keywordflow">if</span> (NewPagefileValue &gt; QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o7">PagefileLimit</a>) {
00103             ExReleaseFastLock (&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql);
00104             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_PAGEFILE_QUOTA_EXCEEDED);
00105         }
00106 
00107         QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o6">PagefileUsage</a> = NewPagefileValue;
00108 
00109         <span class="keywordflow">if</span> (NewPagefileValue &gt; QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o5">PeakPagefileUsage</a>) {
00110             QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o5">PeakPagefileUsage</a> = NewPagefileValue;
00111         }
00112 
00113         NewPagefileValue = CurrentProcess-&gt;PagefileUsage + QuotaCharge;
00114         CurrentProcess-&gt;PagefileUsage = NewPagefileValue;
00115 
00116         <span class="keywordflow">if</span> (NewPagefileValue &gt; CurrentProcess-&gt;PeakPagefileUsage) {
00117             CurrentProcess-&gt;PeakPagefileUsage = NewPagefileValue;
00118         }
00119         ExReleaseFastLock (&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql);
00120     } <span class="keywordflow">else</span> {
00121         ExAcquireFastLock (&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,&amp;OldIrql);
00122 
00123         <span class="keywordflow">if</span> ( (QuotaBlock = CurrentProcess-&gt;QuotaBlock) != &amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>) {
00124             ExReleaseFastLock(&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql);
00125             <span class="keywordflow">goto</span> retry_charge;
00126         }
00127         <span class="keywordflow">goto</span> do_charge;
00128     }
00129     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00130 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="mmquota.c::MiReturnCommitment" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL MiReturnCommitment           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>QuotaCharge</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">442</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00039">MiCommitExtensionActive</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00078">MmExtendedCommit</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00037">MmExtendedCommitLimit</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00043">MmPageFileFullExtendPages</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00040">MmTotalCommittedPages</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04018">MiCreatePagingFileMap()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l01544">MiDereferenceSession()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00708">MiFreeNonPagedPool()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l01778">MiFreePoolPages()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04222">MiInitializeSessionPool()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02256">MiMapViewOfDataSection()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04709">MiPageFileFull()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00256">MiRemoveVad()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00869">MiReturnPageTablePageCommitment()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00191">MiSegmentDelete()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02144">MiSessionCommitImagePages()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02318">MiSessionCommitPageTables()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01881">MiSessionInitializeWorkingSetList()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">MiShareSessionImage()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05581">MmAllocateNonCachedMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02450">MmCreateKernelStack()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00190">MmCreateProcessAddressSpace()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02723">MmDeleteKernelStack()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l01398">MmDeleteProcessAddressSpace()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02106">MmFreeDriverInitialization()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05721">MmFreeNonCachedMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05051">MmFreePagesFromMdl()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03742">MmFreeSpecialPool()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>, and <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00448                    :
00449 
00450     This routine releases page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> quota.
00451 
00452 Arguments:
00453 
00454     QuotaCharge - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota amount to charge.
00455 
00456     CurrentProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
00457 
00458 Return Value:
00459 
00460     none.
00461 
00462 Environment:
00463 
00464     Kernel mode, APCs disabled, WorkingSetLock and AddressCreation mutexes
00465     held.
00466 
00467 --*/
00468 
00469 {
00470     KIRQL OldIrql;
00471 
00472     ExAcquireFastLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
00473 
00474     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTotalCommittedPages &gt;= QuotaCharge);
00475 
00476     <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> -= QuotaCharge;
00477 
00478     <span class="comment">//</span>
00479     <span class="comment">// If commit allotments have been temporarily blocked then open the</span>
00480     <span class="comment">// floodgates provided either enough commit has been freed or the pagefile</span>
00481     <span class="comment">// extension has succeeded.</span>
00482     <span class="comment">//</span>
00483 
00484     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>) {
00485         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTotalCommittedPages &gt;= MmPageFileFullExtendPages);
00486         <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> -= <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>;
00487         <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a> = 0;
00488     }
00489 
00490     <span class="comment">//</span>
00491     <span class="comment">// If the system automatically granted an increase that can be returned</span>
00492     <span class="comment">// now, do it.</span>
00493     <span class="comment">//</span>
00494 
00495     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a7">MiCommitExtensionActive</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00496 
00497         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d1/mmquota_8c.html#a6">MmExtendedCommitLimit</a> != 0) &amp;&amp;
00498             (<a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>) &amp;&amp;
00499             (<a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> - <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &gt; <a class="code" href="../../d6/d1/mmquota_8c.html#a6">MmExtendedCommitLimit</a>)) {
00500                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> -= <a class="code" href="../../d6/d1/mmquota_8c.html#a6">MmExtendedCommitLimit</a>;
00501                 <a class="code" href="../../d6/d1/mmquota_8c.html#a6">MmExtendedCommitLimit</a> = 0;
00502         }
00503 
00504         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a35">MmExtendedCommit</a> != 0) {
00505             <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> -= <a class="code" href="../../d8/d5/kddata_8c.html#a35">MmExtendedCommit</a>;
00506             <a class="code" href="../../d8/d5/kddata_8c.html#a35">MmExtendedCommit</a> = 0;
00507         }
00508 
00509         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d1/mmquota_8c.html#a6">MmExtendedCommitLimit</a> == 0) &amp;&amp; (<a class="code" href="../../d8/d5/kddata_8c.html#a35">MmExtendedCommit</a> == 0)) {
00510             <a class="code" href="../../d6/d1/mmquota_8c.html#a7">MiCommitExtensionActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00511         }
00512     }
00513 
00514     ExReleaseFastLock (&amp;MmChargeCommitmentLock, OldIrql);
00515     <span class="keywordflow">return</span>;
00516 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="mmquota.c::MiReturnPageFileQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiReturnPageFileQuota           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>QuotaCharge</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentProcess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00133">133</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00113">_EPROCESS_QUOTA_BLOCK::PagefileUsage</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00046">PspDefaultQuotaBlock</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00107">_EPROCESS_QUOTA_BLOCK::QuotaLock</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00030">MiInsertVad()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00256">MiRemoveVad()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00869">MiReturnPageTablePageCommitment()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>, and <a class="el" href="../../d1/d1/psquota_8c-source.html#l00494">PspDereferenceQuota()</a>.
<p>
<pre class="fragment"><div>00140                    :
00141 
00142     This routine releases page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> quota.
00143 
00144 Arguments:
00145 
00146     QuotaCharge - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota amount to charge.
00147 
00148     CurrentProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
00149 
00150 Return Value:
00151 
00152     none.
00153 
00154 Environment:
00155 
00156     Kernel mode, APCs disabled, WorkingSetLock and AddressCreation mutexes
00157     held.
00158 
00159 --*/
00160 
00161 {
00162 
00163     <a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">PEPROCESS_QUOTA_BLOCK</a> QuotaBlock;
00164     KIRQL OldIrql;
00165 
00166     QuotaBlock = CurrentProcess-&gt;QuotaBlock;
00167 
00168 retry_return:
00169     <span class="keywordflow">if</span> ( QuotaBlock != &amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>) {
00170         ExAcquireFastLock (&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>, &amp;OldIrql);
00171 do_return:
00172         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentProcess-&gt;PagefileUsage &gt;= QuotaCharge);
00173         CurrentProcess-&gt;PagefileUsage -= QuotaCharge;
00174 
00175         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o6">PagefileUsage</a> &gt;= QuotaCharge);
00176         QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o6">PagefileUsage</a> -= QuotaCharge;
00177         ExReleaseFastLock(&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql);
00178     } <span class="keywordflow">else</span> {
00179         ExAcquireFastLock (&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>, &amp;OldIrql);
00180         <span class="keywordflow">if</span> ( (QuotaBlock = CurrentProcess-&gt;QuotaBlock) != &amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a> ) {
00181             ExReleaseFastLock(&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql);
00182             <span class="keywordflow">goto</span> retry_return;
00183         }
00184         <span class="keywordflow">goto</span> do_return;
00185     }
00186     <span class="keywordflow">return</span>;
00187 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="mmquota.c::MiReturnPageTablePageCommitment" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiReturnPageTablePageCommitment           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>EndingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousVad</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NextVad</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00869">869</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01626">_MMWSL::CommittedPageTables</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01157">MI_CHECK_BIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01215">MI_CLEAR_BIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00763">MI_VPN_TO_VA</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01746">MiGetPpePdeOffset</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00133">MiReturnPageFileQuota()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04291">MM_DBG_COMMIT_RETURN_PAGETABLES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01604">_MMWSL::NumberOfCommittedPageTables</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00318">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>, and <a class="el" href="../../d2/d0/psjob_8c-source.html#l02823">PsChangeJobMemoryUsage()</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/umapview_8c-source.html#l00090">MmUnmapViewOfSection()</a>, and <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00879                    :
00880 
00881     This routine returns commitment <span class="keywordflow">for</span> COMPLETE page table pages which
00882     span <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address range.  For example (assuming 4k pages),
00883     <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> StartingAddress =  64k and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> EndingAddress = 5mb, no
00884     page table charges would be freed as a complete page table page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00885     not covered by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.  However, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> StartingAddress was 4mb
00886     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> EndingAddress was 9mb, 1 page table page would be freed.
00887 
00888 Arguments:
00889 
00890     StartingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
00891 
00892     EndingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ending address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
00893 
00894     CurrentProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
00895 
00896     PreviousVad - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous VAD, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> none.
00897 
00898     NextVad - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next VAD, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> none.
00899 
00900 Return Value:
00901 
00902     None.
00903 
00904 Environment:
00905 
00906     Kernel mode, APCs disabled, WorkingSetLock and AddressCreation mutexes
00907     held.
00908 
00909 --*/
00910 
00911 {
00912 <span class="preprocessor">#ifdef _WIN64</span>
00913 <span class="preprocessor"></span>    DBG_UNREFERENCED_PARAMETER (StartingAddress);
00914     DBG_UNREFERENCED_PARAMETER (EndingAddress);
00915     DBG_UNREFERENCED_PARAMETER (CurrentProcess);
00916     DBG_UNREFERENCED_PARAMETER (PreviousVad);
00917     DBG_UNREFERENCED_PARAMETER (NextVad);
00918 <span class="preprocessor">#else</span>
00919 <span class="preprocessor"></span>    ULONG NumberToClear;
00920     LONG FirstPage;
00921     LONG LastPage;
00922     LONG PreviousPage;
00923     LONG NextPage;
00924 
00925     <span class="comment">//</span>
00926     <span class="comment">// Check to see if any page table pages would be freed.</span>
00927     <span class="comment">//</span>
00928 
00929     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartingAddress != EndingAddress);
00930 
00931     <span class="keywordflow">if</span> (PreviousVad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00932         PreviousPage = -1;
00933     } <span class="keywordflow">else</span> {
00934         PreviousPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a> (MI_VPN_TO_VA (PreviousVad-&gt;EndingVpn));
00935     }
00936 
00937     <span class="keywordflow">if</span> (NextVad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00938         NextPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a> (MM_HIGHEST_USER_ADDRESS) + 1;
00939     } <span class="keywordflow">else</span> {
00940         NextPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a> (MI_VPN_TO_VA (NextVad-&gt;StartingVpn));
00941     }
00942 
00943     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PreviousPage &lt;= NextPage);
00944 
00945     FirstPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a>  (StartingAddress);
00946 
00947     LastPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a> (EndingAddress);
00948 
00949     <span class="keywordflow">if</span> (PreviousPage == FirstPage) {
00950 
00951         <span class="comment">//</span>
00952         <span class="comment">// A VAD is within the starting page table page.</span>
00953         <span class="comment">//</span>
00954 
00955         FirstPage += 1;
00956     }
00957 
00958     <span class="keywordflow">if</span> (NextPage == LastPage) {
00959 
00960         <span class="comment">//</span>
00961         <span class="comment">// A VAD is within the ending page table page.</span>
00962         <span class="comment">//</span>
00963 
00964         LastPage -= 1;
00965     }
00966 
00967     <span class="comment">//</span>
00968     <span class="comment">// Indicate that the page table page is not in use.</span>
00969     <span class="comment">//</span>
00970 
00971     <span class="keywordflow">if</span> (FirstPage &gt; LastPage) {
00972         <span class="keywordflow">return</span>;
00973     }
00974 
00975     NumberToClear = 1 + LastPage - FirstPage;
00976 
00977     <span class="keywordflow">while</span> (FirstPage &lt;= LastPage) {
00978         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_CHECK_BIT (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o17">CommittedPageTables</a>,
00979                               FirstPage));
00980 
00981         <a class="code" href="../../d4/d8/mi_8h.html#a169">MI_CLEAR_BIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o17">CommittedPageTables</a>, FirstPage);
00982         FirstPage += 1;
00983     }
00984 
00985     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o6">NumberOfCommittedPageTables</a> -= NumberToClear;
00986     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (NumberToClear);
00987     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_PAGETABLES, NumberToClear);
00988     <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (NumberToClear, CurrentProcess);
00989 
00990     <span class="keywordflow">if</span> (CurrentProcess-&gt;JobStatus &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
00991         <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(-(SSIZE_T)NumberToClear);
00992     }
00993     CurrentProcess-&gt;CommitCharge -= NumberToClear;
00994 
00995     <span class="keywordflow">return</span>;
00996 <span class="preprocessor">#endif</span>
00997 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="mmquota.c::MmRaisePoolQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmRaisePoolQuota           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>OldQuotaLimit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NewQuotaLimit</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01118">1118</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l04726">_MM_PAGED_POOL_INFO::AllocatedPagedPool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00098">MmAllocatedNonPagedPool</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00062">MmMaximumNonPagedPoolInBytes</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02010">MMNONPAGED_QUOTA_INCREASE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02016">MMPAGED_QUOTA_CHECK</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02012">MMPAGED_QUOTA_INCREASE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00069">MmPagedPoolInfo</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00074">MmSizeOfPagedPoolInBytes</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01115">MmTotalNonPagedPoolQuota</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01114">MmTotalPagedPoolQuota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00024">PsChargeSharedPoolQuota()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l01211">PspSetQuotaLimits()</a>.
<p>
<pre class="fragment"><div>01126                    :
01127 
01128     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called (with a spinlock) whenever PS detects a quota
01129     limit has been exceeded. The purpose of <span class="keyword">this</span> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to attempt to
01130     increase <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified quota.
01131 
01132 Arguments:
01133 
01134     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota to be raised
01135 
01136     OldQuotaLimit - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current quota limit <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
01137 
01138     NewQuotaLimit - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> limit
01139 
01140 Return Value:
01141 
01142     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The API succeeded and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota limit was raised.
01143 
01144     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - We were unable to raise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota limit.
01145 
01146 Environment:
01147 
01148     Kernel mode, QUOTA SPIN <a class="code" href="../../d4/d2/struct__LOCK.html">LOCK</a> HELD!!
01149 
01150 --*/
01151 
01152 {
01153     SIZE_T Limit;
01154     <a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html">PMM_PAGED_POOL_INFO</a> PagedPoolInfo;
01155 
01156     <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
01157 
01158         <span class="comment">//</span>
01159         <span class="comment">// Check commit limit and make sure at least 1mb is available.</span>
01160         <span class="comment">// Check to make sure 4mb of paged pool still exists.</span>
01161         <span class="comment">//</span>
01162 
01163         PagedPoolInfo = &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>;
01164 
01165         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) &lt;
01166             (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o8">AllocatedPagedPool</a> + ((<a class="code" href="../../d2/d1/mm_8h.html#a31">MMPAGED_QUOTA_CHECK</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>))) {
01167 
01168             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01169         }
01170 
01171         <a class="code" href="../../d6/d1/mmquota_8c.html#a12">MmTotalPagedPoolQuota</a> += (<a class="code" href="../../d2/d1/mm_8h.html#a29">MMPAGED_QUOTA_INCREASE</a>);
01172         *NewQuotaLimit = OldQuotaLimit + (<a class="code" href="../../d2/d1/mm_8h.html#a29">MMPAGED_QUOTA_INCREASE</a>);
01173         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01174 
01175     } <span class="keywordflow">else</span> {
01176 
01177         <span class="keywordflow">if</span> ( (ULONG_PTR)(<a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a> + ((1*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) &lt; (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01178             <span class="keywordflow">goto</span> aok;
01179             }
01180 
01181         <span class="comment">//</span>
01182         <span class="comment">// Make sure 200 pages and 5mb of nonpaged pool expansion</span>
01183         <span class="comment">// available.  Raise quota by 64k.</span>
01184         <span class="comment">//</span>
01185 
01186         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 200) ||
01187             (MmResidentAvailablePages &lt; ((MMNONPAGED_QUOTA_CHECK) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>))) {
01188 
01189             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01190         }
01191 
01192         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; ((4*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01193             Limit = (1*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01194         } <span class="keywordflow">else</span> {
01195             Limit = (4*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01196         }
01197 
01198         <span class="keywordflow">if</span> ((ULONG_PTR)((<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) &lt;
01199             (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a> + Limit)) {
01200 
01201             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01202         }
01203 aok:
01204         <a class="code" href="../../d6/d1/mmquota_8c.html#a13">MmTotalNonPagedPoolQuota</a> += (<a class="code" href="../../d2/d1/mm_8h.html#a28">MMNONPAGED_QUOTA_INCREASE</a>);
01205         *NewQuotaLimit = OldQuotaLimit + (<a class="code" href="../../d2/d1/mm_8h.html#a28">MMNONPAGED_QUOTA_INCREASE</a>);
01206         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01207     }
01208 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="mmquota.c::MmReturnPoolQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmReturnPoolQuota           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedQuota</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01212">1212</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
References <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01115">MmTotalNonPagedPoolQuota</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01114">MmTotalPagedPoolQuota</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>.
<p>
<pre class="fragment"><div>01219                    :
01220 
01221     Returns <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> quota.
01222 
01223 Arguments:
01224 
01225     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota to be returned.
01226 
01227     ReturnedQuota - Number of bytes returned.
01228 
01229 Return Value:
01230 
01231     NONE.
01232 
01233 Environment:
01234 
01235     Kernel mode, QUOTA SPIN <a class="code" href="../../d4/d2/struct__LOCK.html">LOCK</a> HELD!!
01236 
01237 --*/
01238 
01239 {
01240 
01241     <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
01242         <a class="code" href="../../d6/d1/mmquota_8c.html#a12">MmTotalPagedPoolQuota</a> -= ReturnedQuota;
01243     } <span class="keywordflow">else</span> {
01244         <a class="code" href="../../d6/d1/mmquota_8c.html#a13">MmTotalNonPagedPoolQuota</a> -= ReturnedQuota;
01245     }
01246 
01247     <span class="keywordflow">return</span>;
01248 }
}
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a7" doxytag="mmquota.c::MiCommitExtensionActive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL <a class="el" href="../../d6/d1/mmquota_8c.html#a7">MiCommitExtensionActive</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00039">39</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01001">MiCauseOverCommitPopup()</a>, and <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="mmquota.c::MiOverCommitCallCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d1/mmquota_8c.html#a10">MiOverCommitCallCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00045">45</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01001">MiCauseOverCommitPopup()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="mmquota.c::MmAllocatedPagedPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG_PTR <a class="el" href="../../d6/d1/mmquota_8c.html#a8">MmAllocatedPagedPool</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00041">41</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="mmquota.c::MmExtendedCommit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T <a class="el" href="../../d6/d1/mmquota_8c.html#a5">MmExtendedCommit</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00035">35</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="mmquota.c::MmExtendedCommitLimit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T <a class="el" href="../../d6/d1/mmquota_8c.html#a6">MmExtendedCommitLimit</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00037">37</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01001">MiCauseOverCommitPopup()</a>, and <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="mmquota.c::MmPageFileFullExtendPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T <a class="el" href="../../d6/d3/modwrite_8c.html#a19">MmPageFileFullExtendPages</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00043">43</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01001">MiCauseOverCommitPopup()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01681">MiExtendPagingFiles()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04709">MiPageFileFull()</a>, and <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="mmquota.c::MmPeakCommitment" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T <a class="el" href="../../d6/d1/mmquota_8c.html#a4">MmPeakCommitment</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00033">33</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="mmquota.c::MmTotalNonPagedPoolQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T <a class="el" href="../../d6/d1/mmquota_8c.html#a13">MmTotalNonPagedPoolQuota</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01115">1115</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01118">MmRaisePoolQuota()</a>, and <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01212">MmReturnPoolQuota()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="mmquota.c::MmTotalPagedPoolQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T <a class="el" href="../../d6/d1/mmquota_8c.html#a12">MmTotalPagedPoolQuota</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01114">1114</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01118">MmRaisePoolQuota()</a>, and <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01212">MmReturnPoolQuota()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="mmquota.c::PspDefaultQuotaBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">EPROCESS_QUOTA_BLOCK</a> <a class="el" href="../../d8/d1/psp_8h.html#a37">PspDefaultQuotaBlock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00046">46</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00058">MiChargePageFileQuota()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00133">MiReturnPageFileQuota()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00024">PsChargeSharedPoolQuota()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00466">PspInheritQuota()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00209">PspQueryQuotaLimits()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01211">PspSetQuotaLimits()</a>, and <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:47 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
