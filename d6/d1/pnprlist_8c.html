<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnprlist.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnprlist.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>

<p>
<a href="../../d7/d0/pnprlist_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>&nbsp;&nbsp;&nbsp;0x00000003</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>&nbsp;&nbsp;&nbsp;0x00000001</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a2">RELATION_FLAG_DESCENDANT</a>&nbsp;&nbsp;&nbsp;0x00000002</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a3">IopAddRelationToList</a> (IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN BOOLEAN DirectDescendant, IN BOOLEAN Tagged)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a4">IopAllocateRelationList</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a5">IopCompressRelationList</a> (IN OUT <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> *List)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a6">IopEnumerateRelations</a> (IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List, IN OUT PULONG Marker, OUT <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *DeviceObject, OUT BOOLEAN *DirectDescendant, OPTIONAL OUT BOOLEAN *Tagged, OPTIONAL IN BOOLEAN Reverse)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a7">IopFreeRelationList</a> (IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a8">IopGetRelationsCount</a> (<a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a9">IopGetRelationsTaggedCount</a> (<a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a10">IopIsRelationInList</a> (<a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List, <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a11">IopMergeRelationLists</a> (IN OUT <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> TargetList, IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> SourceList, IN BOOLEAN Tagged)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a12">IopRemoveIndirectRelationsFromList</a> (IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a13">IopRemoveRelationFromList</a> (<a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List, <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a14">IopSetAllRelationsTags</a> (<a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List, BOOLEAN Tagged)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/pnprlist_8c.html#a15">IopSetRelationsTag</a> (IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN BOOLEAN Tagged)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="pnprlist.c::RELATION_FLAG_DESCENDANT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RELATION_FLAG_DESCENDANT&nbsp;&nbsp;&nbsp;0x00000002          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00052">52</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00055">IopAddRelationToList()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00441">IopEnumerateRelations()</a>, and <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l01013">IopRemoveIndirectRelationsFromList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="pnprlist.c::RELATION_FLAG_TAGGED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RELATION_FLAG_TAGGED&nbsp;&nbsp;&nbsp;0x00000001          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00051">51</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00055">IopAddRelationToList()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00441">IopEnumerateRelations()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l01013">IopRemoveIndirectRelationsFromList()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l01090">IopRemoveRelationFromList()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l01166">IopSetAllRelationsTags()</a>, and <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l01232">IopSetRelationsTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="pnprlist.c::RELATION_FLAGS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RELATION_FLAGS&nbsp;&nbsp;&nbsp;0x00000003          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00049">49</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00055">IopAddRelationToList()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00441">IopEnumerateRelations()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00709">IopFreeRelationList()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00823">IopIsRelationInList()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00900">IopMergeRelationLists()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l01013">IopRemoveIndirectRelationsFromList()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l01090">IopRemoveRelationFromList()</a>, and <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l01232">IopSetRelationsTag()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="pnprlist.c::IopAddRelationToList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAddRelationToList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>List</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectDescendant</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Tagged</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00055">55</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00036">_RELATION_LIST_ENTRY::Count</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00038">_RELATION_LIST_ENTRY::Devices</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00098">IopNumberDeviceNodes</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00117">_DEVICE_NODE::Level</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00037">_RELATION_LIST_ENTRY::MaxCount</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d1/pnprlist_8h.html#a1">PRELATION_LIST_ENTRY</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00052">RELATION_FLAG_DESCENDANT</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00051">RELATION_FLAG_TAGGED</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00049">RELATION_FLAGS</a>, and <a class="el" href="../../d7/d1/pnprlist_8h.html#a0">RELATION_LIST_ENTRY</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01250">IopInvalidateRelationsInList()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00900">IopMergeRelationLists()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00917">IopProcessRelation()</a>.
<p>
<pre class="fragment"><div>00064                    :
00065 
00066     Adds an element to a relation list.
00067 
00068     If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first DeviceObject of a particular level then a <span class="keyword">new</span>
00069     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">RELATION_LIST_ENTRY</a> will be allocated.
00070 
00071     This routine should <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be called on an uncompressed relation list,
00072     otherwise <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> likely that STATUS_INVALID_PARAMETER will be returned.
00073 
00074 Arguments:
00075 
00076     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>                Relation list to which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceObject <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> added.
00077 
00078     DeviceObject        DeviceObject to be added to <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>.  It must be a
00079                         PhysicalDeviceObject (PDO).
00080 
00081     DirectDescendant    Indicates whether DeviceObject <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a direct descendant of
00082                         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original target device of <span class="keyword">this</span> remove.
00083 
00084     Tagged              Indicates whether DeviceObject should be tagged in <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>.
00085 
00086 Return Value:
00087 
00088     STATUS_SUCCESS
00089 
00090         The DeviceObject was added successfully.
00091 
00092     STATUS_OBJECT_NAME_COLLISION
00093 
00094         The DeviceObject already exists in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relation list.
00095 
00096     STATUS_INSUFFICIENT_RESOURCES
00097 
00098         There isn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> enough <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a> available to allocate a <span class="keyword">new</span>
00099         <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">RELATION_LIST_ENTRY</a>.
00100 
00101     STATUS_INVALID_PARAMETER
00102 
00103         The level of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a> associated with DeviceObject <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> less than
00104         FirstLevel or greater than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MaxLevel.
00105 
00106     STATUS_NO_SUCH_DEVICE
00107 
00108         DeviceObject <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a PhysicalDeviceObject (PDO), <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> doesn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> have a
00109         <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a> associated with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00110 
00111 --*/
00112 
00113 {
00114     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>            deviceNode;
00115     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
00116     ULONG                   level;
00117     ULONG                   index;
00118     ULONG                   flags;
00119 
00120     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00121 
00122     flags = 0;
00123 
00124     <span class="keywordflow">if</span> (Tagged) {
00125         Tagged = 1;
00126         flags |= <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>;
00127     }
00128 
00129     <span class="keywordflow">if</span> (DirectDescendant) {
00130         flags |= <a class="code" href="../../d6/d1/pnprlist_8c.html#a2">RELATION_FLAG_DESCENDANT</a>;
00131     }
00132 
00133     <span class="keywordflow">if</span> ((deviceNode = DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00134         level = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o4">Level</a>;
00135 
00136         <span class="comment">//</span>
00137         <span class="comment">// Since this routine is called with the DeviceNode Tree locked and</span>
00138         <span class="comment">// List is initially allocated with enough entries to hold the deepest</span>
00139         <span class="comment">// DEVICE_NODE this ASSERT should never fire.  If it does then either</span>
00140         <span class="comment">// the tree is changing or we were given a compressed list.</span>
00141         <span class="comment">//</span>
00142         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel &lt;= level &amp;&amp; level &lt;= List-&gt;MaxLevel);
00143 
00144         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel &lt;= level &amp;&amp; level &lt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel) {
00145 
00146             <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ]) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00147 
00148                 <span class="comment">//</span>
00149                 <span class="comment">// This is the first DeviceObject of its level, allocate a new</span>
00150                 <span class="comment">// RELATION_LIST_ENTRY.</span>
00151                 <span class="comment">//</span>
00152                 entry = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool,
00153                                         <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">RELATION_LIST_ENTRY</a>) +
00154                                         IopNumberDeviceNodes * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>));
00155 
00156                 <span class="keywordflow">if</span> (entry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00157                     <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00158                 }
00159 
00160                 <span class="comment">//</span>
00161                 <span class="comment">// We always allocate enough Devices to hold the whole tree as</span>
00162                 <span class="comment">// a simplification.  Since each entry is a PDEVICE_OBJECT and</span>
00163                 <span class="comment">// there is generally under 50 devices on a machine this means</span>
00164                 <span class="comment">// under 1K for each entry.  The excess space will be freed when</span>
00165                 <span class="comment">// the list is compressed.</span>
00166                 <span class="comment">//</span>
00167                 entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> = 0;
00168                 entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o1">MaxCount</a> = <a class="code" href="../../d1/d0/pnpdata_8c.html#a12">IopNumberDeviceNodes</a>;
00169 
00170                 <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ] = entry;
00171             }
00172 
00173             <span class="comment">//</span>
00174             <span class="comment">// There should always be room for a DeviceObject since the Entry is</span>
00175             <span class="comment">// initially dimensioned large enough to hold all the DEVICE_NODES</span>
00176             <span class="comment">// in the system.</span>
00177             <span class="comment">//</span>
00178             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o1">MaxCount</a>);
00179 
00180             <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o1">MaxCount</a>) {
00181                 <span class="comment">//</span>
00182                 <span class="comment">// Search the list to see if DeviceObject has already been</span>
00183                 <span class="comment">// added.</span>
00184                 <span class="comment">//</span>
00185                 <span class="keywordflow">for</span> (index = 0; index &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>; index++) {
00186                     <span class="keywordflow">if</span> (((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>) == (ULONG_PTR)DeviceObject) {
00187 
00188                         <span class="comment">//</span>
00189                         <span class="comment">// DeviceObject already exists in the list.  However</span>
00190                         <span class="comment">// the Direct Descendant flag may differ.  We will</span>
00191                         <span class="comment">// override it if DirectDescendant is TRUE.  This could</span>
00192                         <span class="comment">// happen if we merged two relation lists.</span>
00193 
00194                         <span class="keywordflow">if</span> (DirectDescendant) {
00195                             entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] | <a class="code" href="../../d6/d1/pnprlist_8c.html#a2">RELATION_FLAG_DESCENDANT</a>);
00196                         }
00197 
00198                         <span class="keywordflow">return</span> STATUS_OBJECT_NAME_COLLISION;
00199                     }
00200                 }
00201             } <span class="keywordflow">else</span> {
00202                 <span class="comment">//</span>
00203                 <span class="comment">// There isn't room in the Entry for another DEVICE_OBJECT, the</span>
00204                 <span class="comment">// list has probably already been compressed.</span>
00205                 <span class="comment">//</span>
00206                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00207             }
00208 
00209             <span class="comment">//</span>
00210             <span class="comment">// Take out a reference on DeviceObject, we will release it when we</span>
00211             <span class="comment">// free the list or remove the DeviceObject from the list.</span>
00212             <span class="comment">//</span>
00213             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( DeviceObject );
00214 
00215             entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)DeviceObject | flags);
00216             entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>++;
00217 
00218             <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count++;
00219             <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;TagCount += Tagged;
00220 
00221             <span class="keywordflow">return</span> STATUS_SUCCESS;
00222         } <span class="keywordflow">else</span> {
00223             <span class="comment">//</span>
00224             <span class="comment">// There isn't an Entry available for the level of this</span>
00225             <span class="comment">// DEVICE_OBJECT, the list has probably already been compressed.</span>
00226             <span class="comment">//</span>
00227 
00228             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00229         }
00230     } <span class="keywordflow">else</span> {
00231         <span class="comment">//</span>
00232         <span class="comment">// DeviceObject is not a PhysicalDeviceObject (PDO).</span>
00233         <span class="comment">//</span>
00234         <span class="keywordflow">return</span> STATUS_NO_SUCH_DEVICE;
00235     }
00236 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="pnprlist.c::IopAllocateRelationList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> IopAllocateRelationList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00239">239</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00178">IopMaxDeviceNodeLevel</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00063">_RELATION_LIST::MaxLevel</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d7/d1/pnprlist_8h.html#a2">RELATION_LIST</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01250">IopInvalidateRelationsInList()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00725">IopLockDeviceRemovalRelations()</a>.
<p>
<pre class="fragment"><div>00245                    :
00246 
00247     Allocate a <span class="keyword">new</span> Relations <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>.  The list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initially sized large enough to
00248     hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> deepest <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a> encountered since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system started.
00249 
00250 Arguments:
00251 
00252     NONE
00253 
00254 Return Value:
00255 
00256     Newly allocated list <span class="keywordflow">if</span> enough <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available, otherwise <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
00257 
00258 --*/
00259 
00260 {
00261     <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>  list;
00262     ULONG           maxLevel;
00263     ULONG           listSize;
00264 
00265     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00266 
00267     <span class="comment">//</span>
00268     <span class="comment">// Level number of the deepest DEVICE_NODE allocated since the system</span>
00269     <span class="comment">// started.</span>
00270     <span class="comment">//</span>
00271     maxLevel = <a class="code" href="../../d1/d0/pnpdata_8c.html#a25">IopMaxDeviceNodeLevel</a>;
00272     listSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d3/struct__RELATION__LIST.html">RELATION_LIST</a>) + maxLevel * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>);
00273 
00274     <span class="keywordflow">if</span> ((list = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, listSize )) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00275         RtlZeroMemory(list, listSize);
00276         <span class="comment">// list-&gt;FirstLevel = 0;</span>
00277         <span class="comment">// list-&gt;Count = 0;</span>
00278         <span class="comment">// list-&gt;Tagged = 0;</span>
00279         list-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o3">MaxLevel</a> = maxLevel;
00280     }
00281 
00282     <span class="keywordflow">return</span> list;
00283 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="pnprlist.c::IopCompressRelationList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCompressRelationList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>List</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00286">286</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00036">_RELATION_LIST_ENTRY::Count</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00060">_RELATION_LIST::Count</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00038">_RELATION_LIST_ENTRY::Devices</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00064">_RELATION_LIST::Entries</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00062">_RELATION_LIST::FirstLevel</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00037">_RELATION_LIST_ENTRY::MaxCount</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00063">_RELATION_LIST::MaxLevel</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01213">PDEVICE_OBJECT</a>, <a class="el" href="../../d7/d1/pnprlist_8h.html#a1">PRELATION_LIST_ENTRY</a>, and <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00061">_RELATION_LIST::TagCount</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00725">IopLockDeviceRemovalRelations()</a>.
<p>
<pre class="fragment"><div>00292                    :
00293 
00294     Compresses <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relation list by reallocating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list and all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entries so
00295     that they a just large enough to hold their current contents.
00296 
00297     Once a list has been compressed <a class="code" href="../../d6/d1/pnprlist_8c.html#a3">IopAddRelationToList</a> and
00298     <a class="code" href="../../d6/d1/pnprlist_8c.html#a11">IopMergeRelationLists</a> targetting <span class="keyword">this</span> list are both likely to fail.
00299 
00300 Arguments:
00301 
00302     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>    Relation <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> to compress.
00303 
00304 Return Value:
00305 
00306     STATUS_SUCCESS
00307 
00308         The list was compressed.  Although <span class="keyword">this</span> routine does allocate memory and
00309         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation can fail, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine itself will never fail.  Since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00310         memory we are allocating <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always smaller then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00311         replacing we just keep <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old memory <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation fails.
00312 
00313 --*/
00314 
00315 {
00316     <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>          oldList, newList;
00317     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    oldEntry, newEntry;
00318     ULONG                   lowestLevel;
00319     ULONG                   highestLevel;
00320     ULONG                   index;
00321 
00322     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00323 
00324     oldList = *<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00325 
00326     <span class="comment">//</span>
00327     <span class="comment">// Initialize lowestLevel and highestLevel with illegal values chosen so</span>
00328     <span class="comment">// that the first real entry will override them.</span>
00329     <span class="comment">//</span>
00330     lowestLevel = oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o3">MaxLevel</a>;
00331     highestLevel = oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o2">FirstLevel</a>;
00332 
00333     <span class="comment">//</span>
00334     <span class="comment">// Loop through the list looking for allocated entries.</span>
00335     <span class="comment">//</span>
00336     <span class="keywordflow">for</span> (index = 0; index &lt;= (oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o3">MaxLevel</a> - oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o2">FirstLevel</a>); index++) {
00337 
00338         <span class="keywordflow">if</span> ((oldEntry = oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o4">Entries</a>[ index ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00339             <span class="comment">//</span>
00340             <span class="comment">// This entry is allocated, update lowestLevel and highestLevel if</span>
00341             <span class="comment">// necessary.</span>
00342             <span class="comment">//</span>
00343             <span class="keywordflow">if</span> (lowestLevel &gt; index) {
00344                 lowestLevel = index;
00345             }
00346 
00347             <span class="keywordflow">if</span> (highestLevel &lt; index) {
00348                 highestLevel = index;
00349             }
00350 
00351             <span class="keywordflow">if</span> (oldEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> &lt; oldEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o1">MaxCount</a>) {
00352 
00353                 <span class="comment">//</span>
00354                 <span class="comment">// This entry is only partially full.  Allocate a new entry</span>
00355                 <span class="comment">// which is just the right size to hold the current number of</span>
00356                 <span class="comment">// PDEVICE_OBJECTs.</span>
00357                 <span class="comment">//</span>
00358                 newEntry = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool,
00359                                            <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">RELATION_LIST_ENTRY</a>) +
00360                                            (oldEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>));
00361 
00362                 <span class="keywordflow">if</span> (newEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00363 
00364                     <span class="comment">//</span>
00365                     <span class="comment">// Initialize Count and MaxCount to the number of</span>
00366                     <span class="comment">// PDEVICE_OBJECTs in the old entry.</span>
00367                     <span class="comment">//</span>
00368                     newEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> = oldEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>;
00369                     newEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o1">MaxCount</a> = oldEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>;
00370 
00371                     <span class="comment">//</span>
00372                     <span class="comment">// Copy the PDEVICE_OBJECTs from the old entry to the new</span>
00373                     <span class="comment">// one.</span>
00374                     <span class="comment">//</span>
00375                     RtlCopyMemory( newEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>,
00376                                    oldEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>,
00377                                    oldEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>));
00378 
00379                     <span class="comment">//</span>
00380                     <span class="comment">// Free the old entry and store the new entry in the list.</span>
00381                     <span class="comment">//</span>
00382                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( oldEntry );
00383 
00384                     oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o4">Entries</a>[ index ] = newEntry;
00385                 }
00386             }
00387         }
00388     }
00389 
00390     <span class="comment">//</span>
00391     <span class="comment">// Assert that the old list isn't empty.</span>
00392     <span class="comment">//</span>
00393     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(lowestLevel &lt;= highestLevel);
00394 
00395     <span class="keywordflow">if</span> (lowestLevel &gt; highestLevel) {
00396         <span class="comment">//</span>
00397         <span class="comment">// The list is empty - we shouldn't get asked to compress an empty list</span>
00398         <span class="comment">// but lets do it anyways.</span>
00399         <span class="comment">//</span>
00400         lowestLevel = 0;
00401         highestLevel = 0;
00402     }
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// Check if the old list had unused entries at the beginning or the end of</span>
00406     <span class="comment">// the Entries array.</span>
00407     <span class="comment">//</span>
00408     <span class="keywordflow">if</span> (lowestLevel != oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o2">FirstLevel</a> || highestLevel != oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o3">MaxLevel</a>) {
00409 
00410         <span class="comment">//</span>
00411         <span class="comment">// Allocate a new List with just enough Entries to hold those between</span>
00412         <span class="comment">// FirstLevel and MaxLevel inclusive.</span>
00413         <span class="comment">//</span>
00414         newList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool,
00415                                   <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d3/struct__RELATION__LIST.html">RELATION_LIST</a>) +
00416                                   (highestLevel - lowestLevel) * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>));
00417 
00418         <span class="keywordflow">if</span> (newList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00419             <span class="comment">//</span>
00420             <span class="comment">// Copy the old list to the new list and return it to the caller.</span>
00421             <span class="comment">//</span>
00422             newList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o0">Count</a> = oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o0">Count</a>;
00423             newList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o1">TagCount</a> = oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o1">TagCount</a>;
00424             newList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o2">FirstLevel</a> = lowestLevel;
00425             newList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o3">MaxLevel</a> = highestLevel;
00426 
00427             RtlCopyMemory( newList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o4">Entries</a>,
00428                            &amp;oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o4">Entries</a>[ lowestLevel ],
00429                            (highestLevel - lowestLevel + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>));
00430 
00431             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( oldList );
00432 
00433             *<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = newList;
00434         }
00435     }
00436 
00437     <span class="keywordflow">return</span> STATUS_SUCCESS;
00438 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="pnprlist.c::IopEnumerateRelations" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopEnumerateRelations           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>List</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Marker</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT BOOLEAN *&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectDescendant</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OPTIONAL OUT BOOLEAN *&nbsp;</td>
          <td class="mdname" nowrap> <em>Tagged</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OPTIONAL IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Reverse</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00441">441</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00036">_RELATION_LIST_ENTRY::Count</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00038">_RELATION_LIST_ENTRY::Devices</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00052">RELATION_FLAG_DESCENDANT</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00051">RELATION_FLAG_TAGGED</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00049">RELATION_FLAGS</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00452                    :
00453 
00454     Enumerates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relations in a list.
00455 
00456 Arguments:
00457 
00458     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>                Relation list to be enumerated.
00459 
00460     Marker              Cookie used to maintain current place in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.  It
00461                         must be initialized to 0 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first time
00462                         <a class="code" href="../../d6/d1/pnprlist_8c.html#a6">IopEnumerateRelations</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00463 
00464     DeviceObject        Returned Relation.
00465 
00466     DirectDescendant    If specified then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a direct
00467                         descendant of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original target device of <span class="keyword">this</span> remove.
00468 
00469     Tagged              If specified then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> tagged
00470                         otherwise <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cleared.
00471 
00472     Reverse             Direction of traversal, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> means from deepest to
00473                         closest to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> means from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root down.
00474 
00475                         If Reverse changes on a subsequent call then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00476                         previously enumerated relation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> skipped.  For example,
00477                         given <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sequence <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>, B, C, <a class="code" href="../../d2/d0/imemenu_8c.html#a0">D</a>, E.  If
00478                         <a class="code" href="../../d6/d1/pnprlist_8c.html#a6">IopEnumerateRelations</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called thrice with Reverse set
00479                         to <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> and then called repeatedly with Reverse set to
00480                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> until <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sequence would be: <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>,
00481                         B, C, B, <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>.
00482 
00483                         Once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end has been reached <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not possible to
00484                         change directions.
00485 
00486 
00487 Return Value:
00488 
00489     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00490 
00491         DeviceObject and optionally Tagged have been set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next relation.
00492 
00493     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00494 
00495         There are no more relations.
00496 
00497 --*/
00498 
00499 {
00500     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
00501     LONG                    levelIndex;
00502     ULONG                   entryIndex;
00503 
00504     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00505 
00506     <span class="comment">//</span>
00507     <span class="comment">// The basic assumptions of our use of Marker is that there will never be</span>
00508     <span class="comment">// more than 16M DeviceNodes at any one level and that the tree will never</span>
00509     <span class="comment">// be more than 127 deep.</span>
00510     <span class="comment">//</span>
00511     <span class="comment">// The format of Marker is</span>
00512     <span class="comment">//      Bit 31      = Valid (used to distinguish the initial call</span>
00513     <span class="comment">//      Bit 30-24   = Current index into entries</span>
00514     <span class="comment">//      Bit 23-0    = Current index into devices, 0xFFFFFF means last</span>
00515     <span class="comment">//</span>
00516     <span class="keywordflow">if</span> (*Marker == ~0U) {
00517         <span class="comment">//</span>
00518         <span class="comment">// We've reached the end.</span>
00519         <span class="comment">//</span>
00520         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00521     }
00522 
00523     <span class="keywordflow">if</span> (*Marker == 0) {
00524         <span class="comment">//</span>
00525         <span class="comment">// This is the initial call to IopEnumerateRelations</span>
00526         <span class="comment">//</span>
00527         <span class="keywordflow">if</span> (Reverse) {
00528             <span class="comment">//</span>
00529             <span class="comment">// Initialize levelIndex to the last element of Entries</span>
00530             <span class="comment">//</span>
00531             levelIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel;
00532         } <span class="keywordflow">else</span> {
00533             <span class="comment">//</span>
00534             <span class="comment">// Initialize levelIndex to the first element of Entries</span>
00535             <span class="comment">//</span>
00536             levelIndex = 0;
00537         }
00538         <span class="comment">//</span>
00539         <span class="comment">// Initialize entryIndex to unknown element of Devices.  If we are going</span>
00540         <span class="comment">// in reverse then this will appear to be beyond the last element and</span>
00541         <span class="comment">// we'll adjust it the last one.  If we are going forward then this will</span>
00542         <span class="comment">// appear to be just prior to the first element so when we increment it,</span>
00543         <span class="comment">// it will become zero.</span>
00544         <span class="comment">//</span>
00545         entryIndex = ~0U;
00546     } <span class="keywordflow">else</span> {
00547         <span class="comment">//</span>
00548         <span class="comment">// Bit 31 is our valid bit, used to distinguish level 0, device 0 from</span>
00549         <span class="comment">// the first time call.</span>
00550         <span class="comment">//</span>
00551         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*Marker &amp; ((ULONG)1 &lt;&lt; 31));
00552         <span class="comment">//</span>
00553         <span class="comment">// Current level stored in bits 30-24.</span>
00554         <span class="comment">//</span>
00555         levelIndex = (*Marker &gt;&gt; 24) &amp; 0x7F;
00556         <span class="comment">//</span>
00557         <span class="comment">// Current device stored in bits 23-0.</span>
00558         <span class="comment">//</span>
00559         entryIndex = *Marker &amp; 0x00FFFFFF;
00560     }
00561 
00562     <span class="keywordflow">if</span> (Reverse) {
00563         <span class="comment">//</span>
00564         <span class="comment">// We are traversing the list bottom up, from the deepest device towards</span>
00565         <span class="comment">// the root.</span>
00566         <span class="comment">//</span>
00567         <span class="keywordflow">for</span> ( ; levelIndex &gt;= 0; levelIndex--) {
00568 
00569             <span class="comment">//</span>
00570             <span class="comment">// Since the Entries array can be sparse find the next allocated</span>
00571             <span class="comment">// Entry.</span>
00572             <span class="comment">//</span>
00573             <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ levelIndex ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00574 
00575                 <span class="keywordflow">if</span> (entryIndex &gt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>) {
00576                     <span class="comment">//</span>
00577                     <span class="comment">// entryIndex (the current one) is greater than Count, this</span>
00578                     <span class="comment">// will be the case where it is 0xFFFFFF, in other words</span>
00579                     <span class="comment">// unspecified.  Adjust it so that it is one past the last</span>
00580                     <span class="comment">// one in this Entry.</span>
00581                     <span class="comment">//</span>
00582                     entryIndex = entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>;
00583                 }
00584 
00585                 <span class="keywordflow">if</span> (entryIndex &gt; 0) {
00586 
00587                     <span class="comment">//</span>
00588                     <span class="comment">// The current entry is beyond the first entry so the next</span>
00589                     <span class="comment">// entry (which is the one we are looking for is immediately</span>
00590                     <span class="comment">// prior, adjust entryIndex.</span>
00591                     <span class="comment">//</span>
00592                     entryIndex--;
00593 
00594                     <span class="comment">//</span>
00595                     <span class="comment">// Get the device object and remove the tag.</span>
00596                     <span class="comment">//</span>
00597                     *DeviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>);
00598 
00599                     <span class="keywordflow">if</span> (Tagged != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00600                         <span class="comment">//</span>
00601                         <span class="comment">// The caller is interested in the tag value.</span>
00602                         <span class="comment">//</span>
00603                         *Tagged = (BOOLEAN)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>);
00604                     }
00605 
00606                     <span class="keywordflow">if</span> (DirectDescendant != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00607                         <span class="comment">//</span>
00608                         <span class="comment">// The caller is interested in the DirectDescendant value.</span>
00609                         <span class="comment">//</span>
00610                         *DirectDescendant = (BOOLEAN)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a2">RELATION_FLAG_DESCENDANT</a>);
00611                     }
00612 
00613                     <span class="comment">//</span>
00614                     <span class="comment">// Update the marker (info for current device)</span>
00615                     <span class="comment">//</span>
00616                     *Marker = ((ULONG)1 &lt;&lt; 31) | (levelIndex &lt;&lt; 24) | (entryIndex &amp; 0x00FFFFFF);
00617 
00618                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00619                 }
00620             }
00621 
00622             <span class="comment">//</span>
00623             <span class="comment">// The current device object has been deleted or the current</span>
00624             <span class="comment">// device object is the first one in this Entry.</span>
00625             <span class="comment">// We need to continue to search backwards through the other</span>
00626             <span class="comment">// Entries.</span>
00627             <span class="comment">//</span>
00628             entryIndex = ~0U;
00629         }
00630     } <span class="keywordflow">else</span> {
00631         <span class="keywordflow">for</span> ( ; levelIndex &lt;= (LONG)(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel); levelIndex++) {
00632 
00633             <span class="comment">//</span>
00634             <span class="comment">// Since the Entries array can be sparse find the next allocated</span>
00635             <span class="comment">// Entry.</span>
00636             <span class="comment">//</span>
00637             <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ levelIndex ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00638 
00639                 <span class="comment">//</span>
00640                 <span class="comment">// entryIndex is the index of the current device or 0xFFFFFFFF</span>
00641                 <span class="comment">// if this is the first time we have been called or the current</span>
00642                 <span class="comment">// current device is the last one in its Entry.  Increment the</span>
00643                 <span class="comment">// index to point to the next device.</span>
00644                 <span class="comment">//</span>
00645                 entryIndex++;
00646 
00647                 <span class="keywordflow">if</span> (entryIndex &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>) {
00648 
00649                     <span class="comment">//</span>
00650                     <span class="comment">// The next device is within this entry.</span>
00651                     <span class="comment">//</span>
00652                     <span class="comment">//</span>
00653                     <span class="comment">// Get the device object and remove the tag.</span>
00654                     <span class="comment">//</span>
00655                     *DeviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>);
00656 
00657                     <span class="keywordflow">if</span> (Tagged != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00658                         <span class="comment">//</span>
00659                         <span class="comment">// The caller is interested in the tag value.</span>
00660                         <span class="comment">//</span>
00661                         *Tagged = (BOOLEAN)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>);
00662                     }
00663 
00664                     <span class="keywordflow">if</span> (DirectDescendant != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00665                         <span class="comment">//</span>
00666                         <span class="comment">// The caller is interested in the DirectDescendant value.</span>
00667                         <span class="comment">//</span>
00668                         *DirectDescendant = (BOOLEAN)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a2">RELATION_FLAG_DESCENDANT</a>);
00669                     }
00670 
00671                     <span class="comment">//</span>
00672                     <span class="comment">// Update the marker (info for current device)</span>
00673                     <span class="comment">//</span>
00674                     *Marker = ((ULONG)1 &lt;&lt; 31) | (levelIndex &lt;&lt; 24) | (entryIndex &amp; 0x00FFFFFF);
00675 
00676                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00677                 }
00678             }
00679 
00680             <span class="comment">//</span>
00681             <span class="comment">// The current device has been removed or we have processed the</span>
00682             <span class="comment">// last device in the current entry.</span>
00683             <span class="comment">// Set entryIndex so that it is just before the first device in</span>
00684             <span class="comment">// the next entry.  Continue the search looking for the next</span>
00685             <span class="comment">// allocated Entry.</span>
00686             <span class="comment">//</span>
00687             entryIndex = ~0U;
00688         }
00689     }
00690 
00691     <span class="comment">//</span>
00692     <span class="comment">// We are at the end of the list</span>
00693     <span class="comment">//</span>
00694     *Marker = ~0U;
00695     *DeviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00696 
00697     <span class="keywordflow">if</span> (Tagged != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00698         *Tagged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00699     }
00700 
00701     <span class="keywordflow">if</span> (DirectDescendant != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00702         *DirectDescendant = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00703     }
00704 
00705     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00706 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="pnprlist.c::IopFreeRelationList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopFreeRelationList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>List</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00709">709</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
References <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00036">_RELATION_LIST_ENTRY::Count</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00038">_RELATION_LIST_ENTRY::Devices</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00049">RELATION_FLAGS</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00187">IopDelayedRemoveWorker()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01250">IopInvalidateRelationsInList()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00725">IopLockDeviceRemovalRelations()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01417">IopProcessCompletedEject()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00917">IopProcessRelation()</a>.
<p>
<pre class="fragment"><div>00715                    :
00716 
00717     Free a relation list allocated by <a class="code" href="../../d7/d1/pnprlist_8h.html#a6">IopAllocateRelationList</a>.
00718 
00719 Arguments:
00720 
00721     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>    The list to be freed.
00722 
00723 Return Value:
00724 
00725     NONE.
00726 
00727 --*/
00728 
00729 {
00730     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
00731     ULONG                   levelIndex;
00732     ULONG                   entryIndex;
00733 
00734     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00735 
00736     <span class="comment">//</span>
00737     <span class="comment">// Search the list looking for allocated Entries.</span>
00738     <span class="comment">//</span>
00739     <span class="keywordflow">for</span> (levelIndex = 0; levelIndex &lt;= (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel); levelIndex++) {
00740 
00741         <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ levelIndex ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00742             <span class="comment">//</span>
00743             <span class="comment">// This entry has been allocated.</span>
00744             <span class="comment">//</span>
00745             <span class="keywordflow">for</span> (entryIndex = 0; entryIndex &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>; entryIndex++) {
00746                 <span class="comment">//</span>
00747                 <span class="comment">// Dereference all the Devices in the entry.</span>
00748                 <span class="comment">//</span>
00749                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; ~RELATION_FLAGS));
00750             }
00751             <span class="comment">//</span>
00752             <span class="comment">// Free the Entry.</span>
00753             <span class="comment">//</span>
00754             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( entry );
00755         }
00756     }
00757 
00758     <span class="comment">//</span>
00759     <span class="comment">// Free the list.  It isn't necessary to dereference the DeviceObject that</span>
00760     <span class="comment">// was the original target that caused the list to be created.  This</span>
00761     <span class="comment">// DeviceObject is also in one of the Entries and its reference is taken</span>
00762     <span class="comment">// and released there.</span>
00763     <span class="comment">//</span>
00764     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( List );
00765 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="pnprlist.c::IopGetRelationsCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG IopGetRelationsCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>List</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00768">768</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00774                    :
00775 
00776     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> total number of relations (Device Objects) in all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entries.
00777 
00778 Arguments:
00779 
00780     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>    Relation <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>.
00781 
00782 Return Value:
00783 
00784     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of relations (Device Objects).
00785 
00786 --*/
00787 
00788 {
00789     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00790 
00791     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count;
00792 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="pnprlist.c::IopGetRelationsTaggedCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG IopGetRelationsTaggedCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>List</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00795">795</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00801                    :
00802 
00803     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> total number of relations (Device Objects) in all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entries
00804     which are tagged.
00805 
00806 Arguments:
00807 
00808     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>    Relation <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>.
00809 
00810 Return Value:
00811 
00812     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of tagged relations (Device Objects).
00813 
00814 --*/
00815 
00816 {
00817     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00818 
00819     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;TagCount;
00820 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="pnprlist.c::IopIsRelationInList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsRelationInList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>List</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00823">823</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
References <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00036">_RELATION_LIST_ENTRY::Count</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00038">_RELATION_LIST_ENTRY::Devices</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00117">_DEVICE_NODE::Level</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00049">RELATION_FLAGS</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00830                    :
00831 
00832     Checks <span class="keywordflow">if</span> a relation (Device Object) exists in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified relation list.
00833 
00834 Arguments:
00835 
00836     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>            Relation list to check.
00837 
00838     DeviceObject    Relation to be checked.
00839 
00840 
00841 Return Value:
00842 
00843     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00844 
00845         Relation exists.
00846 
00847     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00848 
00849         Relation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
00850 
00851 --*/
00852 
00853 {
00854     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>            deviceNode;
00855     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
00856     ULONG                   level;
00857     ULONG                   index;
00858 
00859     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00860 
00861     <span class="keywordflow">if</span> ((deviceNode = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00862         <span class="comment">//</span>
00863         <span class="comment">// The device object is a PDO.</span>
00864         <span class="comment">//</span>
00865         level = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o4">Level</a>;
00866 
00867         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel &lt;= level &amp;&amp; level &lt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel) {
00868             <span class="comment">//</span>
00869             <span class="comment">// The level is within the range of levels stored in this list.</span>
00870             <span class="comment">//</span>
00871             <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00872                 <span class="comment">//</span>
00873                 <span class="comment">// There is an Entry for this level.</span>
00874                 <span class="comment">//</span>
00875                 <span class="keywordflow">for</span> (index = 0; index &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>; index++) {
00876                     <span class="comment">//</span>
00877                     <span class="comment">// For each Device in the entry, compare it to the given</span>
00878                     <span class="comment">// DeviceObject</span>
00879                     <span class="keywordflow">if</span> (((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>) == (ULONG_PTR)DeviceObject) {
00880                         <span class="comment">//</span>
00881                         <span class="comment">// It matches</span>
00882                         <span class="comment">//</span>
00883                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00884                     }
00885                 }
00886             }
00887         }
00888     }
00889 
00890     <span class="comment">//</span>
00891     <span class="comment">// It wasn't a PDO</span>
00892     <span class="comment">//      or the level wasn't in the range of levels in this list</span>
00893     <span class="comment">//      or there are no DeviceObjects at the same level in this list</span>
00894     <span class="comment">//      or the DeviceObject isn't in the Entry for its level in this list</span>
00895     <span class="comment">//</span>
00896     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00897 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="pnprlist.c::IopMergeRelationLists" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopMergeRelationLists           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Tagged</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00900">900</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00036">_RELATION_LIST_ENTRY::Count</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00038">_RELATION_LIST_ENTRY::Devices</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00055">IopAddRelationToList()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00049">RELATION_FLAGS</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00917">IopProcessRelation()</a>.
<p>
<pre class="fragment"><div>00908                    :
00909 
00910     Merges two relation lists by copying all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relations from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source list
00911     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target list.  Source list remains unchanged.
00912 
00913 Arguments:
00914 
00915     TargetList  <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> to which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relations from Sourcelist are added.
00916 
00917     SourceList  <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> of relations to be added to TargetList.
00918 
00919     Tagged      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> relations from SourceList should be tagged when added to
00920                 TargetList.  If <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> then relations added from SourceList are
00921                 untagged.
00922 
00923 Return Value:
00924 
00925     STATUS_SUCCESS
00926 
00927         All <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relations in SourceList were added to TargetList successfully.
00928 
00929     STATUS_OBJECT_NAME_COLLISION
00930 
00931         One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relations in SourceList already exists in TargetList.  This
00932         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a fatal error and TargetList may already have some of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relations
00933         from SourceList added.  This could be dealt with more gracefully <span class="keywordflow">if</span>
00934         necessary but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current callers of <a class="code" href="../../d6/d1/pnprlist_8c.html#a11">IopMergeRelationLists</a> avoid <span class="keyword">this</span>
00935         situation.
00936 
00937     STATUS_INSUFFICIENT_RESOURCES
00938 
00939         There isn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> enough <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a> available to allocate a <span class="keyword">new</span>
00940         <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">RELATION_LIST_ENTRY</a>.
00941 
00942     STATUS_INVALID_PARAMETER
00943 
00944         The level of one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relations in SourceList <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> less than FirstLevel
00945         or greater than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MaxLevel.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a fatal error and TargetList may
00946         already have some of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relations from SourceList added.  The <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> way
00947         <span class="keyword">this</span> could happen <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree lock isn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> held or <span class="keywordflow">if</span> TargetList has
00948         been compressed by <a class="code" href="../../d6/d1/pnprlist_8c.html#a5">IopCompressRelationList</a>.  Both situations would be
00949         bugs in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
00950 
00951     STATUS_NO_SUCH_DEVICE
00952 
00953         One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relations in SourceList <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a PhysicalDeviceObject (PDO),
00954         <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> doesn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> have a <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a> associated with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a fatal error
00955         and TargetList may already have some of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relations from SourceList
00956         added.  This should never happen since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was a PDO when <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was added to
00957         SourceList.
00958 
00959 
00960 --*/
00961 
00962 {
00963     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
00964     ULONG                   levelIndex;
00965     ULONG                   entryIndex;
00966     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                status = STATUS_SUCCESS;
00967 
00968     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00969 
00970     <span class="comment">//</span>
00971     <span class="comment">// For each level entry in SourceList</span>
00972     <span class="comment">//</span>
00973     <span class="keywordflow">for</span> (levelIndex = 0;
00974          levelIndex &lt;= (SourceList-&gt;MaxLevel - SourceList-&gt;FirstLevel);
00975          levelIndex++) {
00976 
00977         <span class="keywordflow">if</span> ((entry = SourceList-&gt;Entries[ levelIndex ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00978             <span class="comment">//</span>
00979             <span class="comment">// The Entry has Devices</span>
00980             <span class="comment">//</span>
00981             <span class="keywordflow">for</span> (entryIndex = 0; entryIndex &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>; entryIndex++) {
00982                 <span class="comment">//</span>
00983                 <span class="comment">// For each Device in the Entry, add it to the target List.</span>
00984                 <span class="comment">//</span>
00985                 status = <a class="code" href="../../d7/d1/pnprlist_8h.html#a7">IopAddRelationToList</a>( TargetList,
00986                                                (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; ~RELATION_FLAGS),
00987                                                FALSE,
00988                                                Tagged);
00989 
00990                 <span class="comment">//</span>
00991                 <span class="comment">// BUGBUG - Need to handle STATUS_INSUFFICIENT_RESOURCES more</span>
00992                 <span class="comment">// gracefully.  Currently the only way this can happen is</span>
00993                 <span class="comment">// during Eject and that code isn't enabled yet.</span>
00994                 <span class="comment">//</span>
00995                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
00996 
00997                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00998                     <span class="comment">//</span>
00999                     <span class="comment">// BUGBUG - We should undo the damage we've done to</span>
01000                     <span class="comment">// TargetList by removing those relations we've added from</span>
01001                     <span class="comment">// SourceList.</span>
01002                     <span class="comment">//</span>
01003                     <span class="keywordflow">break</span>;
01004                 }
01005             }
01006         }
01007     }
01008 
01009     <span class="keywordflow">return</span> status;
01010 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="pnprlist.c::IopRemoveIndirectRelationsFromList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRemoveIndirectRelationsFromList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>List</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l01013">1013</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
References <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00036">_RELATION_LIST_ENTRY::Count</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00038">_RELATION_LIST_ENTRY::Devices</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00052">RELATION_FLAG_DESCENDANT</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00051">RELATION_FLAG_TAGGED</a>, and <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00049">RELATION_FLAGS</a>.
<p>
<pre class="fragment"><div>01019                    :
01020 
01021     Removes all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relations without <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DirectDescendant flag from a relation
01022     list.
01023 
01024 Arguments:
01025 
01026     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> from which to remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relations.
01027 
01028 
01029 Return Value:
01030 
01031     STATUS_SUCCESS
01032 
01033         The relations were removed successfully.
01034 
01035 --*/
01036 
01037 {
01038     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>          deviceObject;
01039     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
01040     ULONG                   level;
01041     LONG                    index;
01042 
01043     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01044 
01045     <span class="comment">//</span>
01046     <span class="comment">// For each Entry in the list.</span>
01047     <span class="comment">//</span>
01048     <span class="keywordflow">for</span> (level = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel; level &lt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel; level++) {
01049 
01050         <span class="comment">//</span>
01051         <span class="comment">// If the entry is allocated.</span>
01052         <span class="comment">//</span>
01053         <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01054 
01055             <span class="comment">//</span>
01056             <span class="comment">// For each Device in the list.</span>
01057             <span class="comment">//</span>
01058             <span class="keywordflow">for</span> (index = entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - 1; index &gt;= 0; index--) {
01059                 <span class="keywordflow">if</span> (!((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a2">RELATION_FLAG_DESCENDANT</a>)) {
01060 
01061                     deviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>);
01062 
01063                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( deviceObject );
01064 
01065                     <span class="keywordflow">if</span> ((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>) {
01066                         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;TagCount--;
01067                     }
01068 
01069                     <span class="keywordflow">if</span> (index &lt; ((LONG)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - 1)) {
01070 
01071                         RtlMoveMemory( &amp;entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ],
01072                                         &amp;entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index + 1 ],
01073                                         (entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - index - 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>));
01074                     }
01075 
01076                     <span class="keywordflow">if</span> (--entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> == 0) {
01077                         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01078                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry);
01079                     }
01080 
01081                     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count--;
01082                 }
01083             }
01084         }
01085     }
01086     <span class="keywordflow">return</span> STATUS_SUCCESS;
01087 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="pnprlist.c::IopRemoveRelationFromList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRemoveRelationFromList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>List</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l01090">1090</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00036">_RELATION_LIST_ENTRY::Count</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00038">_RELATION_LIST_ENTRY::Devices</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00117">_DEVICE_NODE::Level</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00051">RELATION_FLAG_TAGGED</a>, and <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00049">RELATION_FLAGS</a>.
<p>
<pre class="fragment"><div>01097                    :
01098 
01099     Removes a relation from a relation list.
01100 
01101 Arguments:
01102 
01103     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> from which to remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relation.
01104 
01105     DeviceObject    Relation to remove.
01106 
01107 Return Value:
01108 
01109     STATUS_SUCCESS
01110 
01111         The relation was removed successfully.
01112 
01113     STATUS_NO_SUCH_DEVICE
01114 
01115         The relation doesn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> exist in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
01116 
01117 --*/
01118 
01119 {
01120     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>            deviceNode;
01121     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
01122     ULONG                   level;
01123     LONG                    index;
01124 
01125     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01126 
01127     <span class="keywordflow">if</span> ((deviceNode = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01128         level = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o4">Level</a>;
01129 
01130         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel &lt;= level &amp;&amp; level &lt;= List-&gt;MaxLevel);
01131 
01132         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel &lt;= level &amp;&amp; level &lt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel) {
01133             <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01134                 <span class="keywordflow">for</span> (index = entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - 1; index &gt;= 0; index--) {
01135                     <span class="keywordflow">if</span> (((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>) == (ULONG_PTR)DeviceObject) {
01136 
01137                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DeviceObject );
01138 
01139                         <span class="keywordflow">if</span> (((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>) != 0) {
01140                             <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;TagCount--;
01141                         }
01142                         <span class="keywordflow">if</span> (index &lt; ((LONG)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - 1)) {
01143 
01144                             RtlMoveMemory( &amp;entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ],
01145                                            &amp;entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index + 1 ],
01146                                            (entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - index - 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>));
01147                         }
01148 
01149                         <span class="keywordflow">if</span> (--entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> == 0) {
01150                             <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01151                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry);
01152                         }
01153 
01154                         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count--;
01155 
01156                         <span class="keywordflow">return</span> STATUS_SUCCESS;
01157                     }
01158                 }
01159             }
01160         }
01161     }
01162     <span class="keywordflow">return</span> STATUS_NO_SUCH_DEVICE;
01163 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="pnprlist.c::IopSetAllRelationsTags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopSetAllRelationsTags           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>List</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Tagged</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l01166">1166</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
References <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00036">_RELATION_LIST_ENTRY::Count</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00038">_RELATION_LIST_ENTRY::Devices</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00051">RELATION_FLAG_TAGGED</a>.
<p>
<pre class="fragment"><div>01173                    :
01174 
01175     Tags or untags all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relations in a relations list.
01176 
01177 Arguments:
01178 
01179     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>    Relation list containing relations to be tagged or untagged.
01180 
01181     Tagged  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relations should be tagged, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> they are to be
01182             untagged.
01183 
01184 Return Value:
01185 
01186     NONE
01187 
01188 --*/
01189 
01190 {
01191     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
01192     ULONG                   level;
01193     ULONG                   index;
01194 
01195     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01196 
01197     <span class="comment">//</span>
01198     <span class="comment">// For each Entry in the list.</span>
01199     <span class="comment">//</span>
01200     <span class="keywordflow">for</span> (level = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel; level &lt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel; level++) {
01201 
01202         <span class="comment">//</span>
01203         <span class="comment">// If the entry is allocated.</span>
01204         <span class="comment">//</span>
01205         <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01206 
01207             <span class="comment">//</span>
01208             <span class="comment">// For each Device in the list.</span>
01209             <span class="comment">//</span>
01210             <span class="keywordflow">for</span> (index = 0; index &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>; index++) {
01211 
01212                 <span class="comment">//</span>
01213                 <span class="comment">// Set or clear the tag based on the argument Tagged.</span>
01214                 <span class="comment">//</span>
01215                 <span class="keywordflow">if</span> (Tagged) {
01216                     entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] | <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>);
01217                 } <span class="keywordflow">else</span> {
01218                     entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>);
01219                 }
01220             }
01221         }
01222     }
01223 
01224     <span class="comment">//</span>
01225     <span class="comment">// If we are setting the tags then update the TagCount to the number of</span>
01226     <span class="comment">// relations in the list.  Otherwise reset it to zero.</span>
01227     <span class="comment">//</span>
01228     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;TagCount = Tagged ? <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count : 0;
01229 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="pnprlist.c::IopSetRelationsTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSetRelationsTag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>List</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Tagged</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l01232">1232</a> of file <a class="el" href="../../d7/d0/pnprlist_8c-source.html">pnprlist.c</a>.
<p>
References <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00036">_RELATION_LIST_ENTRY::Count</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00038">_RELATION_LIST_ENTRY::Devices</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00117">_DEVICE_NODE::Level</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00051">RELATION_FLAG_TAGGED</a>, and <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00049">RELATION_FLAGS</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00084">IopChainDereferenceComplete()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01250">IopInvalidateRelationsInList()</a>.
<p>
<pre class="fragment"><div>01240                    :
01241 
01242     Sets or clears a tag on a specified relation in a relations list.  This
01243     routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> also used by some callers to determine <span class="keywordflow">if</span> a relation exists in
01244     a list and <span class="keywordflow">if</span> so to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag.
01245 
01246 Arguments:
01247 
01248     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> containing relation to be tagged or untagged.
01249 
01250     DeviceObject    Relation to be tagged or untagged.
01251 
01252     Tagged          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> relation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be tagged, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
01253                     untagged.
01254 
01255 Return Value:
01256 
01257     STATUS_SUCCESS
01258 
01259         The relation was tagged successfully.
01260 
01261     STATUS_NO_SUCH_DEVICE
01262 
01263         The relation doesn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> exist in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
01264 
01265 --*/
01266 
01267 {
01268     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>            deviceNode;
01269     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
01270     ULONG                   level;
01271     LONG                    index;
01272 
01273     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01274 
01275     <span class="keywordflow">if</span> ((deviceNode = DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01276         <span class="comment">//</span>
01277         <span class="comment">// DeviceObject is a PhysicalDeviceObject (PDO), get its level.</span>
01278         <span class="comment">//</span>
01279         level = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o4">Level</a>;
01280 
01281         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel &lt;= level &amp;&amp; level &lt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel) {
01282             <span class="comment">//</span>
01283             <span class="comment">// The level is within the range of levels in this List.</span>
01284             <span class="comment">//</span>
01285             <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01286                 <span class="comment">//</span>
01287                 <span class="comment">// The Entry for this level is allocated.  Search each device</span>
01288                 <span class="comment">// in the Entry looking for a match.</span>
01289                 <span class="comment">//</span>
01290                 <span class="keywordflow">for</span> (index = entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - 1; index &gt;= 0; index--) {
01291 
01292                     <span class="keywordflow">if</span> (((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>) == (ULONG_PTR)DeviceObject) {
01293 
01294                         <span class="comment">//</span>
01295                         <span class="comment">// We found a match</span>
01296                         <span class="comment">//</span>
01297                         <span class="keywordflow">if</span> ((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>) {
01298                             <span class="comment">//</span>
01299                             <span class="comment">// The relation is already tagged so to simplify the</span>
01300                             <span class="comment">// logic below decrement the TagCount.  We'll</span>
01301                             <span class="comment">// increment it later if the caller still wants it</span>
01302                             <span class="comment">// to be tagged.</span>
01303                             <span class="comment">//</span>
01304                             <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;TagCount--;
01305                         }
01306 
01307                         <span class="keywordflow">if</span> (Tagged) {
01308                             <span class="comment">//</span>
01309                             <span class="comment">// Set the tag and increment the number of tagged</span>
01310                             <span class="comment">// relations.</span>
01311                             <span class="comment">//</span>
01312                             entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] | <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>);
01313                             <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;TagCount++;
01314                         } <span class="keywordflow">else</span> {
01315                             <span class="comment">//</span>
01316                             <span class="comment">// Clear the tag.</span>
01317                             <span class="comment">//</span>
01318                             entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>);
01319                         }
01320 
01321                         <span class="keywordflow">return</span> STATUS_SUCCESS;
01322                     }
01323                 }
01324             }
01325         }
01326     }
01327 
01328     <span class="comment">//</span>
01329     <span class="comment">// It wasn't a PDO</span>
01330     <span class="comment">//      or the level wasn't in the range of levels in this list</span>
01331     <span class="comment">//      or there are no DeviceObjects at the same level in this list</span>
01332     <span class="comment">//      or the DeviceObject isn't in the Entry for its level in this list</span>
01333     <span class="comment">//</span>
01334     <span class="keywordflow">return</span> STATUS_NO_SUCH_DEVICE;
01335 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:15 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
