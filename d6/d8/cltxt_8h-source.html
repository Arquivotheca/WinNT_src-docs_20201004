<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cltxt.h Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cltxt.h</h1><a href="../../d5/d9/cltxt_8h.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: cltxt.h</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Neutral Client/Server call related routines involving text.</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* Created: 04-Dec-90</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* History:</span>
00011 <span class="comment">*   04-Dec-90 created by SMeans</span>
00012 <span class="comment">*</span>
00013 <span class="comment">\**************************************************************************/</span>
00014 
00015 <span class="preprocessor">#ifdef UNICODE</span>
00016 <span class="preprocessor"></span><span class="preprocessor">  #define IS_ANSI FALSE</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00018"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a0">00018</a> <span class="preprocessor"></span><span class="preprocessor">  #define IS_ANSI TRUE</span>
00019 <span class="preprocessor"></span><span class="preprocessor">  #if IS_ANSI != CW_FLAGS_ANSI</span>
00020 <span class="preprocessor"></span><span class="preprocessor">  # error("IS_ANSI != CW_FLAGS_ANSI)</span>
00021 <span class="preprocessor"></span><span class="preprocessor">  #endif</span>
00022 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d7/d9/ntsend_8h.html">ntsend.h</a>"</span>
00024 <span class="preprocessor">#include "powrprof.h"</span>
00025 
00026 <span class="comment">/***************************************************************************\</span>
00027 <span class="comment">* CreateWindowEx (API)</span>
00028 <span class="comment">*</span>
00029 <span class="comment">* A complete Thank cannot be generated for CreateWindowEx because its last</span>
00030 <span class="comment">* parameter (lpParam) is polymorphic depending on the window's class.  If</span>
00031 <span class="comment">* the window class is "MDIClient" then lpParam points to a CLIENTCREATESTRUCT.</span>
00032 <span class="comment">*</span>
00033 <span class="comment">* History:</span>
00034 <span class="comment">* 04-23-91 DarrinM      Created.</span>
00035 <span class="comment">* 04-Feb-92 IanJa       Unicode/ANSI neutral</span>
00036 <span class="comment">\***************************************************************************/</span>
00037 
<a name="l00038"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a10">00038</a> HWND WINAPI <a class="code" href="../../d5/d9/cltxt_8h.html#a10">CreateWindowEx</a>(
00039     DWORD dwExStyle,
00040     LPCTSTR lpClassName,
00041     LPCTSTR lpWindowName,
00042     DWORD dwStyle,
00043     <span class="keywordtype">int</span> X,
00044     <span class="keywordtype">int</span> Y,
00045     <span class="keywordtype">int</span> nWidth,
00046     <span class="keywordtype">int</span> nHeight,
00047     HWND hWndParent,
00048     HMENU hMenu,
00049     HINSTANCE hModule,
00050     LPVOID lpParam)
00051 {
00052 
00053 <span class="preprocessor">#if 0</span>
00054 <span class="preprocessor"></span>    <span class="comment">/*</span>
00055 <span class="comment">     * We use some of the undocumented bits in dwExStyle to mark a window</span>
00056 <span class="comment">     * with certain attributes.  Make sure this bits aren't turned on by</span>
00057 <span class="comment">     * the app</span>
00058 <span class="comment">     */</span>
00059     dwExStyle &amp;= ~(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a187">WS_EX_MDICHILD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a188">WS_EX_ANSICREATOR</a>);
00060 <span class="preprocessor">#endif</span>
00061 <span class="preprocessor"></span>
00062     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a624">_CreateWindowEx</a>(dwExStyle, lpClassName, lpWindowName,
00063                 dwStyle, X, Y, nWidth, nHeight, hWndParent, hMenu,
00064                 hModule, lpParam, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00065 }
00066 
00067 <span class="comment">/***************************************************************************\</span>
00068 <span class="comment">* fnHkINLPCWPSTRUCT</span>
00069 <span class="comment">*</span>
00070 <span class="comment">* This gets thunked through the message thunks, so it has the format</span>
00071 <span class="comment">* of a c/s message thunk call.</span>
00072 <span class="comment">*</span>
00073 <span class="comment">* 05-09-91 ScottLu      Created.</span>
00074 <span class="comment">* 04-Feb-92 IanJa       Unicode/ANSI neutral</span>
00075 <span class="comment">\***************************************************************************/</span>
00076 
<a name="l00077"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a1">00077</a> LRESULT <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a36">TEXT_FN</a>(fnHkINLPCWPSTRUCT)(
00078     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00079     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> message,
00080     WPARAM wParam,
00081     LPARAM lParam,
00082     ULONG_PTR xParam)
00083 {
00084     CWPSTRUCT cwp;
00085 
00086     cwp.hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
00087     cwp.message = message;
00088     cwp.wParam = wParam;
00089     cwp.lParam = lParam;
00090 
00091     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a36">TEXT_FN</a>(<a class="code" href="../../d5/d9/cltxt_8h.html#a3">DispatchHook</a>)(MAKELONG(HC_ACTION, WH_CALLWNDPROC),
00092             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;CI_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a116">CI_INTERTHREAD_HOOK</a>) != 0,
00093             (LPARAM)&amp;cwp, (HOOKPROC)xParam);
00094 }
00095 
<a name="l00096"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a2">00096</a> LRESULT <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a36">TEXT_FN</a>(fnHkINLPCWPRETSTRUCT)(
00097     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00098     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> message,
00099     WPARAM wParam,
00100     LPARAM lParam,
00101     ULONG_PTR xParam)
00102 {
00103     CWPRETSTRUCT cwp;
00104     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
00105 
00106     cwp.hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
00107     cwp.message = message;
00108     cwp.wParam = wParam;
00109     cwp.lParam = lParam;
00110     cwp.lResult = KERNEL_LRESULT_TO_LRESULT(pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o14">dwHookData</a>);
00111 
00112     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a36">TEXT_FN</a>(<a class="code" href="../../d5/d9/cltxt_8h.html#a3">DispatchHook</a>)(MAKELONG(HC_ACTION, WH_CALLWNDPROCRET),
00113             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;CI_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a116">CI_INTERTHREAD_HOOK</a>) != 0,
00114             (LPARAM)&amp;cwp, (HOOKPROC)xParam);
00115 }
00116 
00117 <span class="comment">/***************************************************************************\</span>
00118 <span class="comment">* DispatchHook</span>
00119 <span class="comment">*</span>
00120 <span class="comment">* This routine exists simply to remember the hook type in the CTI structure</span>
00121 <span class="comment">* so that later inside of CallNextHookEx we know how to thunk the hook</span>
00122 <span class="comment">* call.</span>
00123 <span class="comment">*</span>
00124 <span class="comment">* 05-09-91 ScottLu      Created.</span>
00125 <span class="comment">* 04-Feb-92 IanJa       Unicode/ANSI neutral</span>
00126 <span class="comment">\***************************************************************************/</span>
00127 
<a name="l00128"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a3">00128</a> LRESULT <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a36">TEXT_FN</a>(DispatchHook)(
00129     <span class="keywordtype">int</span> dw,
00130     WPARAM wParam,
00131     LPARAM lParam,
00132     HOOKPROC pfn)
00133 {
00134     <span class="keywordtype">int</span> dwHookSave;
00135     LRESULT nRet;
00136     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
00137 <span class="preprocessor">#ifdef WX86</span>
00138 <span class="preprocessor"></span>    HOOKPROC pfnHook;
00139 <span class="preprocessor">#endif</span>
00140 <span class="preprocessor"></span><span class="preprocessor">#if IS_ANSI</span>
00141 <span class="preprocessor"></span>    WPARAM wParamSave;
00142 <span class="preprocessor">#endif</span>
00143 <span class="preprocessor"></span>    <span class="comment">/* -FE-</span>
00144 <span class="comment">     * * THIS VARIABLE SHOULD BE THREAD AWARE *</span>
00145 <span class="comment">     */</span>
00146     <span class="keyword">static</span> EVENTMSG CachedEvent = {0,0,0,(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,(HWND)0};
00147 
00148     <span class="comment">/*</span>
00149 <span class="comment">     * First save the current hook stored in the CTI structure in case we're</span>
00150 <span class="comment">     * being recursed into. dw contains MAKELONG(nCode, nFilterType).</span>
00151 <span class="comment">     */</span>
00152     pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
00153     dwHookSave = pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o10">dwHookCurrent</a>;
00154     pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o10">dwHookCurrent</a> = (dw &amp; 0xFFFF0000) | <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>;
00155 
00156 <span class="preprocessor">#ifdef WX86</span>
00157 <span class="preprocessor"></span>
00158     <span class="comment">//</span>
00159     <span class="comment">// If this is an x86 hook proc, fetch a risc thunk to call</span>
00160     <span class="comment">//</span>
00161 
00162     pfnHook = (PVOID)((ULONG_PTR)pfn &amp; ~0x80000000);
00163     <span class="keywordflow">if</span> (pfn != pfnHook) {
00164         <span class="keywordflow">if</span> (pfnWx86HookCallBack) {
00165             pfn = pfnWx86HookCallBack(HIWORD(dw),    <span class="comment">// filter type</span>
00166                                       pfnHook        <span class="comment">// hook proc</span>
00167                                       );
00168             }
00169     }
00170 
00171 <span class="preprocessor">#endif</span>
00172 <span class="preprocessor"></span>
00173 <span class="preprocessor">#if IS_ANSI       // TEXT_FN(DispatchHook)()</span>
00174 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>()) {
00175         PMSG pMsg;
00176         PEVENTMSG pEMsg;
00177         <span class="keywordflow">switch</span> (HIWORD(dw)) {
00178         <span class="keywordflow">case</span> WH_JOURNALPLAYBACK:
00179             <span class="keywordflow">switch</span> (LOWORD(dw)) {
00180             <span class="keywordflow">case</span> HC_SKIP:
00181                 CachedEvent.message = 0;
00182                 <span class="keywordflow">break</span>;
00183             <span class="keywordflow">case</span> HC_GETNEXT:
00184             <span class="keywordflow">case</span> HC_NOREMOVE:
00185                 pEMsg = (PEVENTMSG)lParam;
00186                 <span class="keywordflow">if</span> (CachedEvent.message != 0 &amp;&amp; pEMsg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00187                     RtlCopyMemory((PEVENTMSG)lParam,&amp;CachedEvent,<span class="keyword">sizeof</span>(EVENTMSG));
00188                     <span class="keywordflow">return</span> 0;
00189                 }
00190                 <span class="keywordflow">break</span>;
00191             }
00192             <span class="keywordflow">break</span>;
00193         <span class="keywordflow">case</span> WH_MSGFILTER:
00194         <span class="keywordflow">case</span> WH_SYSMSGFILTER:
00195         <span class="keywordflow">case</span> WH_GETMESSAGE:
00196             pMsg = (PMSG)lParam;
00197             <span class="keywordflow">if</span> (pMsg) {
00198                 <span class="comment">/*</span>
00199 <span class="comment">                 * Save original message.</span>
00200 <span class="comment">                 */</span>
00201                 wParamSave = pMsg-&gt;wParam;
00202                 <span class="keywordflow">switch</span> (pMsg-&gt;message) {
00203                 <span class="keywordflow">case</span> WM_CHAR:
00204                 <span class="keywordflow">case</span> EM_SETPASSWORDCHAR:
00205                     <span class="comment">/*</span>
00206 <span class="comment">                     * Here... pMsg-&gt;wParam contains..</span>
00207 <span class="comment">                     *</span>
00208 <span class="comment">                     * HIWORD(wParam)         = Information for DBCS messgaing.</span>
00209 <span class="comment">                     * HIBYTE(LOWORD(wParam)) = Dbcs LeadingByte Byte.</span>
00210 <span class="comment">                     * LOBYTE(LOWORD(wParam)) = Dbcs TrailingByte or Sbcs character.</span>
00211 <span class="comment">                     *</span>
00212 <span class="comment">                     */</span>
00213                     <span class="keywordflow">if</span> (pMsg-&gt;wParam &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a119">WMCR_IR_DBCSCHAR</a>) {
00214                         <span class="comment">/*</span>
00215 <span class="comment">                         * Mask off DBCS messaging infomation area.</span>
00216 <span class="comment">                         * (Look up only DBCS character code data).</span>
00217 <span class="comment">                         */</span>
00218                         pMsg-&gt;wParam &amp;= 0x0000FFFF;
00219                     } <span class="keywordflow">else</span> {
00220                         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a120">IS_DBCS_MESSAGE</a>(LOWORD(pMsg-&gt;wParam))) {
00221                             PKERNEL_MSG pDbcsMsg = <a class="code" href="../../d6/d0/usercli_8h.html#a292">GetCallBackDbcsInfo</a>();
00222                             <span class="comment">/*</span>
00223 <span class="comment">                             * Copy this message to CLIENTINFO for next GetMessage</span>
00224 <span class="comment">                             * or PeekMesssage() call.</span>
00225 <span class="comment">                             */</span>
00226                             COPY_MSG_TO_KERNELMSG(pDbcsMsg,pMsg);
00227                             <span class="comment">/*</span>
00228 <span class="comment">                             * Only Dbcs Trailingbyte is nessesary for pushed message. we'll</span>
00229 <span class="comment">                             * pass this message when GetMessage/PeekMessage is called at next.</span>
00230 <span class="comment">                             */</span>
00231                             pDbcsMsg-&gt;wParam = (WPARAM)((pMsg-&gt;wParam &amp; 0x0000FF00) &gt;&gt; 8);
00232                             <span class="comment">/*</span>
00233 <span class="comment">                             * Return DbcsLeading byte to Apps.</span>
00234 <span class="comment">                             */</span>
00235                             pMsg-&gt;wParam = (WPARAM)(pMsg-&gt;wParam &amp; 0x000000FF);
00236                         } <span class="keywordflow">else</span> {
00237                             <span class="comment">/*</span>
00238 <span class="comment">                             * This is SBCS char, make sure it.</span>
00239 <span class="comment">                             */</span>
00240                             pMsg-&gt;wParam &amp;= 0x000000FF;
00241                         }
00242                     }
00243                 }
00244             } <span class="comment">/* if (pMsg) */</span>
00245         } <span class="comment">/* switch (HIWORD(dw)) */</span>
00246 GetNextHookData:
00247         ;
00248     }
00249 <span class="preprocessor">#endif // IS_ANSI</span>
00250 <span class="preprocessor"></span>
00251     <span class="comment">/*</span>
00252 <span class="comment">     * Call the hook. dw contains MAKELONG(nCode, nFilterType).</span>
00253 <span class="comment">     */</span>
00254     nRet = pfn(LOWORD(dw), wParam, lParam);
00255 
00256 <span class="preprocessor">#if IS_ANSI   // TEXT_FN(DispatchHook)()</span>
00257 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>()) {
00258         PMSG pMsg;
00259         PEVENTMSG pEMsg;
00260         <span class="keywordflow">switch</span> (HIWORD(dw)) {
00261         <span class="keywordflow">case</span> WH_JOURNALPLAYBACK:
00262             <span class="keywordflow">switch</span> (LOWORD(dw)) {
00263             <span class="keywordflow">case</span> HC_GETNEXT:
00264             <span class="keywordflow">case</span> HC_NOREMOVE:
00265                 pEMsg = (PEVENTMSG)lParam;
00266                 <span class="keywordflow">if</span> ((nRet == 0) &amp;&amp; pEMsg) {
00267                     WPARAM dwAnsi = LOWORD(pEMsg-&gt;paramL);
00268                     <span class="keywordflow">switch</span>(pEMsg-&gt;message) {
00269                     <span class="keywordflow">case</span> WM_CHAR:
00270                     <span class="keywordflow">case</span> EM_SETPASSWORDCHAR:
00271                         <span class="comment">/*</span>
00272 <span class="comment">                         * Chech wParam is DBCS character or not.</span>
00273 <span class="comment">                         */</span>
00274                         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a120">IS_DBCS_MESSAGE</a>((dwAnsi))) {
00275                             <span class="comment">/*</span>
00276 <span class="comment">                             * DO NOT NEED TO MARK FOR IR_DBCSCHAR</span>
00277 <span class="comment">                             */</span>
00278                         } <span class="keywordflow">else</span> {
00279                             <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pchDbcsCF = <a class="code" href="../../d6/d0/usercli_8h.html#a290">GetDispatchDbcsInfo</a>();
00280                             <span class="comment">/*</span>
00281 <span class="comment">                             * If we have cached Dbcs LeadingByte character, build A Dbcs character</span>
00282 <span class="comment">                             * with the TrailingByte in wParam...</span>
00283 <span class="comment">                             */</span>
00284                             <span class="keywordflow">if</span> (*pchDbcsCF) {
00285                                 WORD DbcsLeadChar = (WORD)(*pchDbcsCF);
00286                                 <span class="comment">/*</span>
00287 <span class="comment">                                 * HIBYTE(LOWORD(dwAnsi)) = Dbcs LeadingByte.</span>
00288 <span class="comment">                                 * LOBYTE(LOWORD(dwAnsi)) = Dbcs TrailingByte.</span>
00289 <span class="comment">                                 */</span>
00290                                 dwAnsi |= (DbcsLeadChar &lt;&lt; 8);
00291                                 <span class="comment">/*</span>
00292 <span class="comment">                                 * Invalidate cached data..</span>
00293 <span class="comment">                                 */</span>
00294                                 *pchDbcsCF = 0;
00295                             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsDBCSLeadByteEx(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a118">THREAD_CODEPAGE</a>(),<a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(dwAnsi))) {
00296                                 <span class="comment">/*</span>
00297 <span class="comment">                                 * if this is Dbcs LeadByte character, we should wait Dbcs TrailingByte</span>
00298 <span class="comment">                                 * to convert this to Unicode. then we cached it here...</span>
00299 <span class="comment">                                 */</span>
00300                                 *pchDbcsCF = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(dwAnsi);
00301                                 <span class="comment">/*</span>
00302 <span class="comment">                                 * Get DBCS TrailByte...</span>
00303 <span class="comment">                                 */</span>
00304                                 pfn(HC_SKIP,0,0);
00305                                 <span class="keywordflow">goto</span> GetNextHookData;
00306                             }
00307                         }
00308                         <span class="comment">/*</span>
00309 <span class="comment">                         * Convert to Unicode...</span>
00310 <span class="comment">                         */</span>
00311                         <a class="code" href="../../d5/d6/chartran_8c.html#a5">RtlMBMessageWParamCharToWCS</a>(pEMsg-&gt;message, &amp;dwAnsi);
00312                         <span class="comment">/*</span>
00313 <span class="comment">                         * Restore converted Unicode to EVENTMSG..</span>
00314 <span class="comment">                         */</span>
00315                         pEMsg-&gt;paramL = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)dwAnsi;
00316                         <span class="comment">/*</span>
00317 <span class="comment">                         * Keep this EVENTMSG to local buffer...</span>
00318 <span class="comment">                         */</span>
00319                         RtlCopyMemory(&amp;CachedEvent,pEMsg,<span class="keyword">sizeof</span>(EVENTMSG));
00320                     } <span class="comment">/* switch(pEMsg-&gt;message) */</span>
00321                 } <span class="comment">/* if (pEMsg) */</span>
00322             }
00323             <span class="keywordflow">break</span>;
00324         <span class="keywordflow">case</span> WH_MSGFILTER:
00325         <span class="keywordflow">case</span> WH_SYSMSGFILTER:
00326         <span class="keywordflow">case</span> WH_GETMESSAGE:
00327             pMsg = (PMSG)lParam;
00328             <span class="keywordflow">if</span> (pMsg) {
00329                 <span class="keywordflow">switch</span> (pMsg-&gt;message) {
00330                 <span class="keywordflow">case</span> WM_CHAR:
00331                 <span class="keywordflow">case</span> EM_SETPASSWORDCHAR:
00332                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a292">GetCallBackDbcsInfo</a>()-&gt;wParam) {
00333                         PKERNEL_MSG pmsgDbcs = <a class="code" href="../../d6/d0/usercli_8h.html#a292">GetCallBackDbcsInfo</a>();
00334                         <span class="comment">/*</span>
00335 <span class="comment">                         * Get pushed message.</span>
00336 <span class="comment">                         *</span>
00337 <span class="comment">                         * Backup current message. this backupped message will be used</span>
00338 <span class="comment">                         * when Apps peek (or get) message from thier WndProc.</span>
00339 <span class="comment">                         * (see GetMessageA(), PeekMessageA()...)</span>
00340 <span class="comment">                         *</span>
00341 <span class="comment">                         * pmsg-&gt;hwnd    = pmsgDbcs-&gt;hwnd;</span>
00342 <span class="comment">                         * pmsg-&gt;message = pmsgDbcs-&gt;message;</span>
00343 <span class="comment">                         * pmsg-&gt;wParam  = pmsgDbcs-&gt;wParam;</span>
00344 <span class="comment">                         * pmsg-&gt;lParam  = pmsgDbcs-&gt;lParam;</span>
00345 <span class="comment">                         * pmsg-&gt;time    = pmsgDbcs-&gt;time;</span>
00346 <span class="comment">                         * pmsg-&gt;pt      = pmsgDbcs-&gt;pt;</span>
00347 <span class="comment">                         */</span>
00348                         COPY_KERNELMSG_TO_MSG(pMsg,pmsgDbcs);
00349                         <span class="comment">/*</span>
00350 <span class="comment">                         * Invalidate pushed message in CLIENTINFO.</span>
00351 <span class="comment">                         */</span>
00352                         pmsgDbcs-&gt;wParam = 0;
00353                         <span class="comment">/*</span>
00354 <span class="comment">                         * Call the hook with DBCS TrailByte..</span>
00355 <span class="comment">                         */</span>
00356                         nRet = pfn(LOWORD(dw), wParam, lParam);
00357                     }
00358                     <span class="comment">/*</span>
00359 <span class="comment">                     * Restore original message..</span>
00360 <span class="comment">                     * #96571 [hiroyama]</span>
00361 <span class="comment">                     * Other messages than WM_CHAR and EM_SETPASSWORDCHAR can be</span>
00362 <span class="comment">                     * modifed by a hooker.</span>
00363 <span class="comment">                     * Wparam for WM_CHAR and EM_SETPASSWORDCHAR must be restored.</span>
00364 <span class="comment">                     * *by design*</span>
00365 <span class="comment">                     */</span>
00366                     pMsg-&gt;wParam = wParamSave;
00367                 }
00368             } <span class="comment">/* if (pMsg) */</span>
00369         } <span class="comment">/* switch (HIWORD(dw)) */</span>
00370     }
00371 <span class="preprocessor">#endif // IS_ANSI</span>
00372 <span class="preprocessor"></span>
00373     <span class="comment">/*</span>
00374 <span class="comment">     * Restore the hook number and return the return code.</span>
00375 <span class="comment">     */</span>
00376     pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o10">dwHookCurrent</a> = dwHookSave;
00377     <span class="keywordflow">return</span> nRet;
00378 }
00379 
00380 
00381 <span class="comment">/***************************************************************************\</span>
00382 <span class="comment">* GetWindowLong, SetWindowLong, GetClassLong</span>
00383 <span class="comment">*</span>
00384 <span class="comment">* History:</span>
00385 <span class="comment">* 02-Feb-92 IanJa       Neutral version.</span>
00386 <span class="comment">\***************************************************************************/</span>
00387 
<a name="l00388"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a11">00388</a> LONG_PTR <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(HWND hwnd, <span class="keywordtype">int</span> nIndex)
00389 {
00390     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00391 
00392     pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
00393 
00394     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00395         <span class="keywordflow">return</span> 0;
00396 
00397     <span class="keywordflow">try</span> {
00398         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a165">_GetWindowLongPtr</a>(pwnd, nIndex, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00399     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00400         RIPERR1(ERROR_INVALID_WINDOW_HANDLE,
00401                 RIP_WARNING,
00402                 <span class="stringliteral">"Window %x no longer valid"</span>,
00403                 hwnd);
00404         <span class="keywordflow">return</span> 0;
00405     }
00406 }
00407 
<a name="l00408"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a12">00408</a> LONG_PTR <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(HWND hWnd, <span class="keywordtype">int</span> nIndex, LONG_PTR dwNewLong)
00409 {
00410     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a209">_SetWindowLongPtr</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, nIndex, dwNewLong, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00411 }
00412 
00413 <span class="preprocessor">#ifdef _WIN64</span>
00414 <span class="preprocessor"></span>LONG  <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> GetWindowLong(HWND hwnd, <span class="keywordtype">int</span> nIndex)
00415 {
00416     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00417 
00418     pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
00419 
00420     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00421         <span class="keywordflow">return</span> 0;
00422 
00423     <span class="keywordflow">try</span> {
00424         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a589">_GetWindowLong</a>(pwnd, nIndex, IS_ANSI);
00425     } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
00426         RIPERR1(ERROR_INVALID_WINDOW_HANDLE,
00427                 RIP_WARNING,
00428                 <span class="stringliteral">"Window %x no longer valid"</span>,
00429                 hwnd);
00430         <span class="keywordflow">return</span> 0;
00431     }
00432 }
00433 
00434 LONG  <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> SetWindowLong(HWND hWnd, <span class="keywordtype">int</span> nIndex, LONG dwNewLong)
00435 {
00436     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a620">_SetWindowLong</a>(hWnd, nIndex, dwNewLong, IS_ANSI);
00437 }
00438 <span class="preprocessor">#endif</span>
00439 <span class="preprocessor"></span>
<a name="l00440"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a13">00440</a> ULONG_PTR <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a13">GetClassLongPtr</a>(HWND hWnd, <span class="keywordtype">int</span> nIndex)
00441 {
00442     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00443 
00444     pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00445 
00446     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00447         <span class="keywordflow">return</span> 0;
00448 
00449     <span class="keywordflow">try</span> {
00450         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a210">_GetClassLongPtr</a>(pwnd, nIndex, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00451     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00452         RIPERR1(ERROR_INVALID_WINDOW_HANDLE,
00453                 RIP_WARNING,
00454                 <span class="stringliteral">"Window %x no longer valid"</span>,
00455                 <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00456         <span class="keywordflow">return</span> 0;
00457     }
00458 }
00459 
00460 <span class="preprocessor">#ifdef _WIN64</span>
00461 <span class="preprocessor"></span><a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> GetClassLong(HWND hWnd, <span class="keywordtype">int</span> nIndex)
00462 {
00463     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00464 
00465     pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hWnd);
00466 
00467     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00468         <span class="keywordflow">return</span> 0;
00469 
00470     <span class="keywordflow">try</span> {
00471         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a632">_GetClassLong</a>(pwnd, nIndex, IS_ANSI);
00472     } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
00473         RIPERR1(ERROR_INVALID_WINDOW_HANDLE,
00474                 RIP_WARNING,
00475                 <span class="stringliteral">"Window %x no longer valid"</span>,
00476                 hWnd);
00477         <span class="keywordflow">return</span> 0;
00478     }
00479 }
00480 <span class="preprocessor">#endif</span>
00481 <span class="preprocessor"></span>
00482 
<a name="l00483"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a14">00483</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a14">PeekMessage</a>(
00484     LPMSG lpMsg,
00485     HWND hWnd,
00486     UINT wMsgFilterMin,
00487     UINT wMsgFilterMax,
00488     UINT wRemoveMsg)
00489 {
00490     <a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html">PCLIENTTHREADINFO</a> pcti;
00491     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
00492     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fsWakeMaskFilter;
00493     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fsWakeMask;
00494     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cSpinLimit;
00495 
00496     pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
00497 
00498     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00499         <span class="keywordflow">goto</span> lbCallServer;
00500     }
00501 
00502 <span class="preprocessor">#if IS_ANSI</span>
00503 <span class="preprocessor"></span>    <span class="comment">/*</span>
00504 <span class="comment">     * If we have a DBCS TrailingByte that should be returned to App,</span>
00505 <span class="comment">     * we should pass it, never can fail....</span>
00506 <span class="comment">     */</span>
00507     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>() || <a class="code" href="../../d6/d0/usercli_8h.html#a292">GetCallBackDbcsInfo</a>()-&gt;wParam == 0);
00508     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a292">GetCallBackDbcsInfo</a>()-&gt;wParam) {    <span class="comment">// accesses fs:xxx, but no speed penalty</span>
00509         <span class="comment">/*</span>
00510 <span class="comment">         * Check message filter... WM_CHAR should be in the Range...</span>
00511 <span class="comment">         */</span>
00512         <span class="keywordflow">if</span> ((!wMsgFilterMin &amp;&amp; !wMsgFilterMax) ||
00513             (wMsgFilterMin &lt;= WM_CHAR &amp;&amp; wMsgFilterMax &gt;=WM_CHAR))
00514         {
00515             <span class="keywordflow">goto</span> lbCallServer;
00516         }
00517     }
00518 <span class="preprocessor">#endif</span>
00519 <span class="preprocessor"></span>
00520     <span class="keywordflow">if</span> (   (pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)
00521         &amp;&amp; !(wRemoveMsg &amp; PM_NOYIELD)
00522         &amp;&amp; ((<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;nEvents != 0) || (pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a807">TIF_FIRSTIDLE</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a813">TIF_DELAYEDEVENT</a>)))) {
00523 
00524         <span class="keywordflow">goto</span> lbCallServer;
00525     }
00526 
00527     <span class="comment">/*</span>
00528 <span class="comment">     * If we can't see the client thread info, we need to go to the kernel.</span>
00529 <span class="comment">     */</span>
00530     <span class="keywordflow">if</span> ((pcti = pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o13">pClientThreadInfo</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00531         <span class="keywordflow">goto</span> lbCallServer;
00532     }
00533 
00534     fsWakeMaskFilter = HIWORD(wRemoveMsg);
00535 <span class="preprocessor">#if DBG</span>
00536 <span class="preprocessor"></span>    <span class="comment">/*</span>
00537 <span class="comment">     * New for NT5: HIWORD(wRemoveMsg) contains a QS_ mask. This is</span>
00538 <span class="comment">     *  validated for real in the kernel side.</span>
00539 <span class="comment">     */</span>
00540     <span class="keywordflow">if</span> (fsWakeMaskFilter &amp; ~QS_VALID) {
00541         RIPMSG1(RIP_WARNING, <span class="stringliteral">"PeekMessage: Invalid QS_ bits:%#lx"</span>, fsWakeMaskFilter);
00542     }
00543 <span class="preprocessor">#endif</span>
00544 <span class="preprocessor"></span>    <span class="comment">/*</span>
00545 <span class="comment">     * If any appropriate input is available, we need to go to the kernel.</span>
00546 <span class="comment">     */</span>
00547     <span class="keywordflow">if</span> (wMsgFilterMax == 0 &amp;&amp; fsWakeMaskFilter == 0) {
00548         fsWakeMask = (QS_ALLINPUT | QS_EVENT | QS_ALLPOSTMESSAGE);
00549     } <span class="keywordflow">else</span> {
00550         fsWakeMask = <a class="code" href="../../d7/d3/ntuser_2rtl_2input_8c.html#a1">CalcWakeMask</a>(wMsgFilterMin, wMsgFilterMax, fsWakeMaskFilter);
00551     }
00552     <span class="keywordflow">if</span> ((pcti-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> | pcti-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a>) &amp; fsWakeMask) {
00553         <span class="keywordflow">goto</span> lbCallServer;
00554     }
00555 
00556     <span class="comment">/*</span>
00557 <span class="comment">     * If this thread has the queue locked, we have to go to the kernel</span>
00558 <span class="comment">     * or other threads on the same queue may be prevented from getting</span>
00559 <span class="comment">     * input messages.</span>
00560 <span class="comment">     */</span>
00561     <span class="keywordflow">if</span> (pcti-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o0">CTIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a822">CTIF_SYSQUEUELOCKED</a>) {
00562         <span class="keywordflow">goto</span> lbCallServer;
00563     }
00564 
00565     <span class="comment">/*</span>
00566 <span class="comment">     * This is the peek message count (not going idle count). If it gets</span>
00567 <span class="comment">     * to be 100 or greater, call the server. This'll cause this app to be</span>
00568 <span class="comment">     * put at background priority until it sleeps. This is really important</span>
00569 <span class="comment">     * for compatibility because win3.1 peek/getmessage usually takes a trip</span>
00570 <span class="comment">     * through the win3.1 scheduler and runs the next task.</span>
00571 <span class="comment">     */</span>
00572     pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o1">cSpins</a>++;
00573 
00574     <span class="keywordflow">if</span> ((pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o1">cSpins</a> &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a767">CSPINBACKGROUND</a>) &amp;&amp; !(pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a804">TIF_SPINNING</a>)) {
00575         <span class="keywordflow">goto</span> lbCallServer;
00576     }
00577 
00578     <span class="comment">/*</span>
00579 <span class="comment">     * We have to go to the server if someone is waiting on this event.</span>
00580 <span class="comment">     * We used to just wait until the spin cound got large but for some</span>
00581 <span class="comment">     * apps like terminal.  They always just call PeekMessage and after</span>
00582 <span class="comment">     * just a few calls they would blink their caret which bonks the spincount</span>
00583 <span class="comment">     */</span>
00584     <span class="keywordflow">if</span> (pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a808">TIF_WAITFORINPUTIDLE</a>){
00585         <span class="keywordflow">goto</span> lbCallServer;
00586     }
00587 
00588     <span class="comment">/*</span>
00589 <span class="comment">     * Make sure we go to the kernel at least once a second so that</span>
00590 <span class="comment">     * hung app painting won't occur.</span>
00591 <span class="comment">     */</span>
00592     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() - pcti-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o5">timeLastRead</a>) &gt; 1000) {
00593         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStatePeekMessage);
00594     }
00595 
00596     <span class="comment">/*</span>
00597 <span class="comment">     * Determine the maximum number of spins before we yield. Yields</span>
00598 <span class="comment">     * are performed more frequently for 16 bit apps.</span>
00599 <span class="comment">     */</span>
00600     <span class="keywordflow">if</span> ((pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) &amp;&amp; !(wRemoveMsg &amp; PM_NOYIELD)) {
00601         cSpinLimit = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a767">CSPINBACKGROUND</a> / 10;
00602     } <span class="keywordflow">else</span> {
00603         cSpinLimit = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a767">CSPINBACKGROUND</a>;
00604     }
00605 
00606     <span class="comment">/*</span>
00607 <span class="comment">     * If the PeekMessage() is just spinning, then we should sleep</span>
00608 <span class="comment">     * just enough so that we allow other processes to gain CPU time.</span>
00609 <span class="comment">     * A problem was found when an OLE app tries to communicate to a</span>
00610 <span class="comment">     * background app (via SendMessage) running at the same priority as a</span>
00611 <span class="comment">     * background/spinning process.  This will starve the CPU from those</span>
00612 <span class="comment">     * processes.  Sleep on every re-cycle of the spin-count.  This will</span>
00613 <span class="comment">     * assure that apps doing peeks are degraded.</span>
00614 <span class="comment">     *</span>
00615 <span class="comment">     */</span>
00616     <span class="keywordflow">if</span> ((pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a804">TIF_SPINNING</a>) &amp;&amp; (pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o1">cSpins</a> &gt;= cSpinLimit)) {
00617         pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o1">cSpins</a> = 0;
00618         <a class="code" href="../../d6/d1/yield_8c.html#a0">NtYieldExecution</a>();
00619     }
00620 
00621     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00622 
00623 lbCallServer:
00624 
00625     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a621">_PeekMessage</a>(lpMsg, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, wMsgFilterMin, wMsgFilterMax,
00626             wRemoveMsg, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00627 }
00628 
<a name="l00629"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a15">00629</a> LRESULT <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>(HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam)
00630 {
00631     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00632 
00633     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00634         <span class="keywordflow">switch</span> (message) {
00635         <span class="keywordflow">case</span> WM_CTLCOLORBTN:
00636         <span class="keywordflow">case</span> WM_CTLCOLORSTATIC:
00637         <span class="keywordflow">case</span> WM_CTLCOLORDLG:
00638         <span class="keywordflow">case</span> WM_CTLCOLORMSGBOX:
00639 
00640             <span class="comment">/*</span>
00641 <span class="comment">             * Draw default colors</span>
00642 <span class="comment">             */</span>
00643             <span class="keywordflow">break</span>;
00644         <span class="keywordflow">default</span>:
00645             <span class="keywordflow">return</span> 0;
00646         }
00647     }
00648 
00649     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00650 }
00651 
<a name="l00652"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a16">00652</a> LRESULT <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam)
00653 {
00654     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00655 
00656     <span class="comment">/*</span>
00657 <span class="comment">     * Prevent apps from setting hi 16 bits so we can use them internally.</span>
00658 <span class="comment">     */</span>
00659     <span class="keywordflow">if</span> (message &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a8">RESERVED_MSG_BITS</a>) {
00660         RIPERR1(ERROR_INVALID_PARAMETER,
00661                 RIP_WARNING,
00662                 <span class="stringliteral">"Invalid parameter \"message\" (%ld) to SendMessage"</span>,
00663                 message);
00664 
00665         <span class="keywordflow">return</span> 0;
00666     }
00667 
00668     <span class="comment">/*</span>
00669 <span class="comment">     * Thunk through a special sendmessage for -1 hwnd's so that the general</span>
00670 <span class="comment">     * purpose thunks don't allow -1 hwnd's.</span>
00671 <span class="comment">     */</span>
00672     <span class="keywordflow">if</span> (hwnd == (HWND)-1 || hwnd == (HWND)0x0000FFFF) {
00673         <span class="comment">/*</span>
00674 <span class="comment">         * Get a real hwnd so the thunks will validation ok. Note that since</span>
00675 <span class="comment">         * -1 hwnd is really rare, calling GetDesktopWindow() here is not a</span>
00676 <span class="comment">         * big deal.</span>
00677 <span class="comment">         */</span>
00678         hwnd = <a class="code" href="../../d3/d9/client_2wow_8c.html#a4">GetDesktopWindow</a>();
00679 
00680         <span class="comment">/*</span>
00681 <span class="comment">         * Always send broadcast requests straight to the server.</span>
00682 <span class="comment">         * Note: if the xParam needs to be used, must update</span>
00683 <span class="comment">         * SendMsgTimeout, FNID_SENDMESSAGEFF uses it to id who</span>
00684 <span class="comment">         * it is from...</span>
00685 <span class="comment">         */</span>
00686         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00687                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a217">FNID_SENDMESSAGEFF</a>, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00688     }
00689 
00690     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00691         <span class="keywordflow">return</span> 0;
00692 
00693     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00694 }
00695 
00696 
<a name="l00697"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a17">00697</a> LRESULT <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a17">SendMessageTimeout</a>(HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam,
00698         UINT fuFlags, UINT uTimeout, PULONG_PTR lpdwResult)
00699 
00700 {
00701     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a601">SendMessageTimeoutWorker</a>(hwnd, message, wParam, lParam,
00702             fuFlags, uTimeout, lpdwResult, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00703 }
00704 
00705 
00706 <span class="comment">/***************************************************************************\</span>
00707 <span class="comment">* SendDlgItemMessage</span>
00708 <span class="comment">*</span>
00709 <span class="comment">* Translates the message, calls SendDlgItemMessage on server side. The</span>
00710 <span class="comment">* dialog item's ID is passed as the xParam. On the server side, a stub</span>
00711 <span class="comment">* rearranges the parameters to put the ID where it belongs and calls</span>
00712 <span class="comment">* xxxSendDlgItemMessage.</span>
00713 <span class="comment">*</span>
00714 <span class="comment">* 04-17-91 DarrinM Created.</span>
00715 <span class="comment">\***************************************************************************/</span>
00716 
<a name="l00717"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a18">00717</a> LRESULT WINAPI <a class="code" href="../../d5/d9/cltxt_8h.html#a18">SendDlgItemMessage</a>(
00718     HWND hwnd,
00719     <span class="keywordtype">int</span> <span class="keywordtype">id</span>,
00720     UINT message,
00721     WPARAM wParam,
00722     LPARAM lParam)
00723 {
00724     <span class="keywordflow">if</span> (hwnd == (HWND)-1 || hwnd == (HWND)0x0000FFFF)
00725         <span class="keywordflow">return</span> 0;
00726 
00727     <span class="keywordflow">if</span> (hwnd = <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(hwnd, <span class="keywordtype">id</span>))
00728         <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwnd, message, wParam, lParam);
00729 
00730     <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00731 }
00732 
00733 <span class="comment">/***************************************************************************\</span>
00734 <span class="comment">* GetDlgItemText</span>
00735 <span class="comment">*</span>
00736 <span class="comment">* History:</span>
00737 <span class="comment">*    04 Feb 1992 GregoryW  Neutral ANSI/Unicode version</span>
00738 <span class="comment">\***************************************************************************/</span>
00739 
<a name="l00740"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a19">00740</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a19">GetDlgItemText</a>(
00741     HWND hwnd,
00742     <span class="keywordtype">int</span> <span class="keywordtype">id</span>,
00743     LPTSTR lpch,
00744     <span class="keywordtype">int</span> cchMax)
00745 {
00746     <span class="keywordflow">if</span> ((hwnd = <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(hwnd, <span class="keywordtype">id</span>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00747         <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/cltxt_8h.html#a21">GetWindowText</a>(hwnd, lpch, cchMax);
00748     }
00749 
00750     <span class="comment">/*</span>
00751 <span class="comment">     * If we couldn't find the window, just null terminate lpch so that the</span>
00752 <span class="comment">     * app doesn't gp fault if it tries to run through the text.</span>
00753 <span class="comment">     */</span>
00754     <span class="keywordflow">if</span> (cchMax)
00755         *lpch = (TCHAR)0;
00756 
00757     <span class="keywordflow">return</span> 0;
00758 }
00759 
00760 
00761 <span class="comment">/***************************************************************************\</span>
00762 <span class="comment">* SetDlgItemText</span>
00763 <span class="comment">*</span>
00764 <span class="comment">* History:</span>
00765 <span class="comment">*    04 Feb 1992 GregoryW  Neutral ANSI/Unicode version</span>
00766 <span class="comment">\***************************************************************************/</span>
00767 
<a name="l00768"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a20">00768</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a20">SetDlgItemText</a>(
00769     HWND hwnd,
00770     <span class="keywordtype">int</span> <span class="keywordtype">id</span>,
00771     LPCTSTR lpch)
00772 {
00773     <span class="keywordflow">if</span> ((hwnd = <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(hwnd, <span class="keywordtype">id</span>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00774         <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/cltxt_8h.html#a23">SetWindowText</a>(hwnd, lpch);
00775     }
00776 
00777     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00778 }
00779 
00780 
<a name="l00781"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a21">00781</a> <span class="keywordtype">int</span> WINAPI <a class="code" href="../../d5/d9/cltxt_8h.html#a21">GetWindowText</a>(
00782     HWND hwnd,
00783     LPTSTR lpName,
00784     <span class="keywordtype">int</span> nMaxCount)
00785 {
00786     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00787 
00788     <span class="comment">/*</span>
00789 <span class="comment">     * Don't try to fill a non-existent buffer</span>
00790 <span class="comment">     */</span>
00791     <span class="keywordflow">if</span> (lpName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || nMaxCount == 0) {
00792         <span class="keywordflow">return</span> 0;
00793     }
00794 
00795     <span class="keywordflow">try</span> {
00796         <span class="comment">/*</span>
00797 <span class="comment">         * Initialize string empty, in case SendMessage aborts validation</span>
00798 <span class="comment">         */</span>
00799         *lpName = TEXT(<span class="charliteral">'\0'</span>);
00800 
00801         <span class="comment">/*</span>
00802 <span class="comment">         * Make sure we have a valid window.</span>
00803 <span class="comment">         */</span>
00804         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00805             <span class="keywordflow">return</span> 0;
00806         }
00807 
00808         <span class="comment">/*</span>
00809 <span class="comment">         * This process comparison is bogus, but it is what win3.1 does.</span>
00810 <span class="comment">         */</span>
00811         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a16">TestWindowProcess</a>(pwnd)) {
00812             <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwnd, WM_GETTEXT, nMaxCount, (LPARAM)lpName, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00813         } <span class="keywordflow">else</span> {
00814             <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, WM_GETTEXT, nMaxCount, (LPARAM)lpName, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00815         }
00816     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00817         RIPERR1(ERROR_INVALID_WINDOW_HANDLE,
00818                 RIP_WARNING,
00819                 <span class="stringliteral">"Window %x no longer valid"</span>,
00820                 hwnd);
00821         <span class="keywordflow">return</span> 0;
00822     }
00823 }
00824 
<a name="l00825"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a22">00825</a> <span class="keywordtype">int</span> WINAPI <a class="code" href="../../d5/d9/cltxt_8h.html#a22">GetWindowTextLength</a>(
00826     HWND hwnd)
00827 {
00828     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00829 
00830     <span class="comment">/*</span>
00831 <span class="comment">     * Make sure we have a valid window.</span>
00832 <span class="comment">     */</span>
00833     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00834         <span class="keywordflow">return</span> 0;
00835     }
00836 
00837     <span class="comment">/*</span>
00838 <span class="comment">     * This process comparison is bogus, but it is what win3.1 does.</span>
00839 <span class="comment">     */</span>
00840     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a16">TestWindowProcess</a>(pwnd)) {
00841         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwnd, WM_GETTEXTLENGTH, 0, 0, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00842     } <span class="keywordflow">else</span> {
00843         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, WM_GETTEXTLENGTH, 0, 0, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00844     }
00845 }
00846 
00847 
<a name="l00848"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a23">00848</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d5/d9/cltxt_8h.html#a23">SetWindowText</a>(
00849     HWND hwnd,
00850     LPCTSTR pString)
00851 {
00852     LRESULT lReturn;
00853     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00854 
00855     <span class="comment">/*</span>
00856 <span class="comment">     * Make sure we have a valid window.</span>
00857 <span class="comment">     */</span>
00858     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00859         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00860     }
00861 
00862     <span class="comment">/*</span>
00863 <span class="comment">     * This process comparison is bogus, but it is what win3.1 does.</span>
00864 <span class="comment">     */</span>
00865     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a16">TestWindowProcess</a>(pwnd)) {
00866         lReturn = <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwnd, WM_SETTEXT, 0, (LPARAM)pString, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00867     } <span class="keywordflow">else</span> {
00868         lReturn = <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, WM_SETTEXT, 0, (LPARAM)pString, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00869     }
00870     <span class="keywordflow">return</span> (lReturn &gt;= 0);
00871 }
00872 
00873 
<a name="l00874"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a24">00874</a> LRESULT <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a24">DispatchMessage</a>(CONST MSG *lpMsg)
00875 {
00876     <span class="keyword">extern</span> LRESULT <a class="code" href="../../d0/d9/clmsg_8c.html#a28">DispatchMessageWorker</a>(CONST MSG *lpMsg, <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAnsi);
00877 
00878     <span class="keywordflow">return</span> <a class="code" href="../../d0/d9/clmsg_8c.html#a28">DispatchMessageWorker</a>(lpMsg, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00879 }
00880 
00881 <span class="preprocessor">#if IS_ANSI</span>
00882 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a637">CopyLogFontAtoW</a>(
00883     PLOGFONTW pdest,
00884     PLOGFONTA psrc)
00885 {
00886     LPSTR lpstrFont = (LPSTR)(&amp;psrc-&gt;lfFaceName);
00887     LPWSTR lpstrFontW = (LPWSTR)(&amp;pdest-&gt;lfFaceName);
00888 
00889     memcpy((LPBYTE)pdest, psrc, <span class="keyword">sizeof</span>(LOGFONTA) - LF_FACESIZE);
00890     memset(pdest-&gt;lfFaceName, 0, LF_FACESIZE * <span class="keyword">sizeof</span>(WCHAR));
00891     MBToWCS(lpstrFont, -1, &amp;lpstrFontW, LF_FACESIZE, FALSE);
00892 }
00893 
00894 <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a638">CopyLogFontWtoA</a>(
00895     PLOGFONTA pdest,
00896     PLOGFONTW psrc)
00897 {
00898     LPSTR lpstrFont = (LPSTR)(&amp;pdest-&gt;lfFaceName);
00899 
00900     memcpy((LPBYTE)pdest, (LPBYTE)psrc, <span class="keyword">sizeof</span>(LOGFONTA) - LF_FACESIZE);
00901     memset(pdest-&gt;lfFaceName, 0, LF_FACESIZE);
00902     WCSToMB(psrc-&gt;lfFaceName, -1, &amp;lpstrFont, LF_FACESIZE, FALSE);
00903 }
00904 <span class="preprocessor">#else</span>
00905 <span class="preprocessor"></span>
00906 <span class="comment">/**************************************************************************\</span>
00907 <span class="comment">* SetVideoTimeout</span>
00908 <span class="comment">*</span>
00909 <span class="comment">* Updates the video timeout values in the current power profile.</span>
00910 <span class="comment">*</span>
00911 <span class="comment">* 15-Apr-1999 JerrySh   Created.</span>
00912 <span class="comment">\**************************************************************************/</span>
00913 
<a name="l00914"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a4">00914</a> <span class="keyword">typedef</span> BOOLEAN (*<a class="code" href="../../d5/d9/cltxt_8h.html#a4">PFNGETACTIVEPWRSCHEME</a>)(<a class="code" href="../../d9/d5/ndismain_8h.html#a266">PUINT</a>);
<a name="l00915"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a5">00915</a> <span class="keyword">typedef</span> BOOLEAN (*<a class="code" href="../../d5/d9/cltxt_8h.html#a5">PFNSETACTIVEPWRSCHEME</a>)(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, PGLOBAL_POWER_POLICY, PPOWER_POLICY);
<a name="l00916"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a6">00916</a> <span class="keyword">typedef</span> BOOLEAN (*<a class="code" href="../../d5/d9/cltxt_8h.html#a6">PFNREADPWRSCHEME</a>)(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, PPOWER_POLICY);
00917 
<a name="l00918"></a><a class="code" href="../../d6/d0/usercli_8h.html#a553">00918</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a553">SetVideoTimeout</a>(
00919     DWORD dwVideoTimeout)
00920 {
00921     POWER_POLICY pp;
00922     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uiID;
00923     HINSTANCE hInstDLL;
00924     <a class="code" href="../../d5/d9/cltxt_8h.html#a4">PFNGETACTIVEPWRSCHEME</a> pfnGetActivePwrScheme;
00925     <a class="code" href="../../d5/d9/cltxt_8h.html#a5">PFNSETACTIVEPWRSCHEME</a> pfnSetActivePwrScheme;
00926     <a class="code" href="../../d5/d9/cltxt_8h.html#a6">PFNREADPWRSCHEME</a> pfnReadPwrScheme;
00927     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00928 
00929     <span class="keywordflow">if</span> ((hInstDLL = LoadLibrary(TEXT(<span class="stringliteral">"powrprof.dll"</span>))) ==  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00930         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00931     }
00932 
00933     pfnGetActivePwrScheme = (<a class="code" href="../../d5/d9/cltxt_8h.html#a4">PFNGETACTIVEPWRSCHEME</a>)GetProcAddress(hInstDLL, <span class="stringliteral">"GetActivePwrScheme"</span>);
00934     pfnSetActivePwrScheme = (<a class="code" href="../../d5/d9/cltxt_8h.html#a5">PFNSETACTIVEPWRSCHEME</a>)GetProcAddress(hInstDLL, <span class="stringliteral">"SetActivePwrScheme"</span>);
00935     pfnReadPwrScheme = (<a class="code" href="../../d5/d9/cltxt_8h.html#a6">PFNREADPWRSCHEME</a>)GetProcAddress(hInstDLL, <span class="stringliteral">"ReadPwrScheme"</span>);
00936 
00937     <span class="keywordflow">if</span> (pfnGetActivePwrScheme(&amp;uiID)) {
00938 
00939         <span class="keywordflow">if</span> (pfnReadPwrScheme(uiID, &amp;pp)) {
00940 
00941             pp.user.VideoTimeoutDc = dwVideoTimeout;
00942             pp.user.VideoTimeoutAc = dwVideoTimeout;
00943 
00944             fRet = pfnSetActivePwrScheme(uiID, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;pp);
00945         }
00946     }
00947     FreeLibrary (hInstDLL);
00948 
00949     <span class="keywordflow">return</span> fRet;
00950 }
00951 <span class="preprocessor">#endif  // IS_ANSI</span>
00952 <span class="preprocessor"></span>
00953 <span class="comment">/***************************************************************************\</span>
00954 <span class="comment">* SystemParametersInfo</span>
00955 <span class="comment">*</span>
00956 <span class="comment">*</span>
00957 <span class="comment">\***************************************************************************/</span>
00958 
<a name="l00959"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a26">00959</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a26">SystemParametersInfo</a>(
00960     UINT  wFlag,
00961     UINT  wParam,
00962     PVOID lParam,
00963     UINT  flags)
00964 {
00965 <span class="preprocessor">#if IS_ANSI</span>
00966 <span class="preprocessor"></span>    NONCLIENTMETRICSW ClientMetricsW;
00967     ICONMETRICSW      IconMetricsW;
00968     LOGFONTW          LogFontW;
00969     <span class="comment">/*</span>
00970 <span class="comment">     * Bug 257718 - joejo</span>
00971 <span class="comment">     * Add SPI_GETDESKWALLPAPER to SystemParametersInfo</span>
00972 <span class="comment">     */</span>
00973     WCHAR             szTemp[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00974     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>              oldwParam = wParam;
00975 <span class="preprocessor">#endif</span>
00976 <span class="preprocessor"></span>    <a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html">INTERNALSETHIGHCONTRAST</a> ihc;
00977     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a>         strlParam;
00978     PVOID             oldlParam = lParam;
00979 
00980     <span class="comment">/*</span>
00981 <span class="comment">     * Make sure cleanup will work successfully</span>
00982 <span class="comment">     */</span>
00983     strlParam.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00984 
00985     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>();
00986 
00987     <span class="keywordflow">switch</span> (wFlag) {
00988     <span class="keywordflow">case</span> SPI_SETSCREENSAVERRUNNING:     <span class="comment">// same as SPI_SCREENSAVERRUNNING</span>
00989         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
00990 
00991     <span class="keywordflow">case</span> SPI_SETDESKPATTERN:
00992 
00993         <span class="keywordflow">if</span> (wParam == 0x0000FFFF)
00994             wParam = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1;
00995 
00996         <span class="comment">/*</span>
00997 <span class="comment">         * lParam not a string (and already copied)</span>
00998 <span class="comment">         */</span>
00999         <span class="keywordflow">if</span> (wParam == (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1)
01000             <span class="keywordflow">break</span>;
01001 
01002         <span class="comment">/*</span>
01003 <span class="comment">         * lParam is possibly 0 or -1 (filled in already) or a string</span>
01004 <span class="comment">         */</span>
01005         <span class="keywordflow">if</span> ((lParam != (PVOID)0) &amp;&amp; (lParam != (PVOID)-1)) {
01006             <a class="code" href="../../d7/d9/ntsend_8h.html#a45">COPYLPTSTR</a>(&amp;strlParam, (LPTSTR)lParam);
01007             lParam = strlParam.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>;
01008         }
01009         <span class="keywordflow">break</span>;
01010 
01011     <span class="keywordflow">case</span> SPI_SETDESKWALLPAPER: {
01012 
01013             <span class="comment">/*</span>
01014 <span class="comment">             * lParam is possibly 0, -1 or -2 (filled in already) or a string.</span>
01015 <span class="comment">             * Get a pointer to the string so we can use it later.  We're</span>
01016 <span class="comment">             * going to a bit of normalizing here for consistency.</span>
01017 <span class="comment">             *</span>
01018 <span class="comment">             * If the caller passes in 0, -1 or -2, we're going to set</span>
01019 <span class="comment">             * the wParam to -1, and use the lParam to pass the string</span>
01020 <span class="comment">             * representation of the wallpaper.</span>
01021 <span class="comment">             */</span>
01022             <span class="keywordflow">if</span> ((lParam != (PVOID) 0) &amp;&amp;
01023                 (lParam != (PVOID)-1) &amp;&amp;
01024                 (lParam != (PVOID)-2)) {
01025 
01026                 <a class="code" href="../../d7/d9/ntsend_8h.html#a45">COPYLPTSTR</a>(&amp;strlParam, (LPTSTR)lParam);
01027                 lParam = strlParam.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>;
01028                 wParam = 0;
01029 
01030             } <span class="keywordflow">else</span> {
01031                 wParam = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1;
01032             }
01033         }
01034         <span class="keywordflow">break</span>;
01035 
01036     <span class="comment">/*</span>
01037 <span class="comment">     * Bug 257718 - joejo</span>
01038 <span class="comment">     * Add SPI_GETDESKWALLPAPER to SystemParametersInfo</span>
01039 <span class="comment">     */</span>
01040     <span class="keywordflow">case</span> SPI_GETDESKWALLPAPER:
01041         <span class="keywordflow">if</span> ((lParam == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (wParam == 0))
01042             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01043 <span class="preprocessor">#if IS_ANSI</span>
01044 <span class="preprocessor"></span>        lParam = szTemp;
01045         wParam = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(szTemp);
01046 <span class="preprocessor">#else</span>
01047 <span class="preprocessor"></span>        <span class="comment">/*</span>
01048 <span class="comment">         * Bug 283318 - joejo</span>
01049 <span class="comment">         * Leave space for a null termination</span>
01050 <span class="comment">         */</span>
01051         wParam--;
01052 <span class="preprocessor">#endif</span>
01053 <span class="preprocessor"></span>
01054         <span class="keywordflow">break</span>;
01055 
01056 
01057     <span class="keywordflow">case</span> SPI_GETANIMATION:
01058         <span class="keywordflow">if</span> ((lParam == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (*((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(lParam)) != <span class="keyword">sizeof</span>(ANIMATIONINFO)))
01059                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01060         <span class="keywordflow">break</span>;
01061 
01062     <span class="keywordflow">case</span> SPI_GETNONCLIENTMETRICS:
01063 <span class="preprocessor">#if IS_ANSI</span>
01064 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((lParam == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (*((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(lParam)) != <span class="keyword">sizeof</span>(NONCLIENTMETRICSA)))
01065             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01066         lParam = &amp;ClientMetricsW;
01067 <span class="preprocessor">#else</span>
01068 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((lParam == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (*((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(lParam)) != <span class="keyword">sizeof</span>(NONCLIENTMETRICSW)))
01069             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01070 <span class="preprocessor">#endif</span>
01071 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
01072 
01073     <span class="keywordflow">case</span> SPI_GETMINIMIZEDMETRICS:
01074         <span class="keywordflow">if</span> ((lParam == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (*((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(lParam)) != <span class="keyword">sizeof</span>(MINIMIZEDMETRICS)))
01075             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01076         <span class="keywordflow">break</span>;
01077 
01078     <span class="keywordflow">case</span> SPI_GETICONMETRICS:
01079 <span class="preprocessor">#if IS_ANSI</span>
01080 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((lParam == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (*((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(lParam)) != <span class="keyword">sizeof</span>(ICONMETRICSA)))
01081             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01082         lParam = &amp;IconMetricsW;
01083 <span class="preprocessor">#else</span>
01084 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((lParam == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (*((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(lParam)) != <span class="keyword">sizeof</span>(ICONMETRICSW)))
01085             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01086 <span class="preprocessor">#endif</span>
01087 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
01088 
01089     <span class="keywordflow">case</span> SPI_GETHIGHCONTRAST:
01090 <span class="preprocessor">#if IS_ANSI</span>
01091 <span class="preprocessor"></span>        {
01092             LPHIGHCONTRASTA pHC = (HIGHCONTRASTA *)lParam;
01093             <span class="keywordflow">if</span> (!pHC || (pHC-&gt;cbSize != <span class="keyword">sizeof</span>(HIGHCONTRASTA))) {
01094                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01095             }
01096             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8/clglobal_8c.html#a17">pcHighContrastScheme</a>) {
01097                 <a class="code" href="../../d1/d8/clglobal_8c.html#a17">pcHighContrastScheme</a> = LocalAlloc(LPTR, MAX_SCHEME_NAME_SIZE * <span class="keyword">sizeof</span>(WCHAR));
01098                 <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8/clglobal_8c.html#a17">pcHighContrastScheme</a>)
01099                     <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01100             }
01101             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8/clglobal_8c.html#a16">pwcHighContrastScheme</a>) {
01102                 <a class="code" href="../../d1/d8/clglobal_8c.html#a16">pwcHighContrastScheme</a> = LocalAlloc(LPTR, MAX_SCHEME_NAME_SIZE * <span class="keyword">sizeof</span>(WCHAR));
01103                 <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8/clglobal_8c.html#a16">pwcHighContrastScheme</a>)
01104                     <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01105             }
01106             ((LPHIGHCONTRASTW)(lParam))-&gt;lpszDefaultScheme = <a class="code" href="../../d1/d8/clglobal_8c.html#a16">pwcHighContrastScheme</a>;
01107         }
01108 <span class="preprocessor">#else</span>
01109 <span class="preprocessor"></span>        {
01110             LPHIGHCONTRASTW pHC = (HIGHCONTRASTW *)lParam;
01111             <span class="keywordflow">if</span> (!pHC || (pHC-&gt;cbSize != <span class="keyword">sizeof</span>(HIGHCONTRASTW)))
01112                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01113             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8/clglobal_8c.html#a16">pwcHighContrastScheme</a>) {
01114                 <a class="code" href="../../d1/d8/clglobal_8c.html#a16">pwcHighContrastScheme</a> = LocalAlloc(LPTR, MAX_SCHEME_NAME_SIZE * <span class="keyword">sizeof</span>(WCHAR));
01115                 <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8/clglobal_8c.html#a16">pwcHighContrastScheme</a>)
01116                     <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01117             }
01118             pHC-&gt;lpszDefaultScheme = <a class="code" href="../../d1/d8/clglobal_8c.html#a16">pwcHighContrastScheme</a>;
01119         }
01120 <span class="preprocessor">#endif</span>
01121 <span class="preprocessor"></span>
01122         <span class="keywordflow">break</span>;
01123 
01124 <span class="preprocessor">#if IS_ANSI</span>
01125 <span class="preprocessor"></span>    <span class="keywordflow">case</span> SPI_GETICONTITLELOGFONT:
01126         lParam = &amp;LogFontW;
01127         <span class="keywordflow">break</span>;
01128 <span class="preprocessor">#endif</span>
01129 <span class="preprocessor"></span>
01130     <span class="keywordflow">case</span> SPI_SETANIMATION:
01131         {
01132             <span class="keywordflow">if</span> ((lParam == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (*((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(lParam)) != <span class="keyword">sizeof</span>(ANIMATIONINFO)))
01133                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01134         }
01135         <span class="keywordflow">break</span>;
01136 
01137     <span class="keywordflow">case</span> SPI_SETHIGHCONTRAST:
01138         ihc.<a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html#o0">cbSize</a> = <span class="keyword">sizeof</span> (HIGHCONTRASTW);
01139         {
01140             LPHIGHCONTRAST pHC = (HIGHCONTRAST *)lParam;
01141             <span class="keywordflow">if</span> ((lParam == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pHC-&gt;cbSize != <span class="keyword">sizeof</span>(HIGHCONTRAST)))
01142                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01143 
01144             lParam = &amp;ihc;
01145             ihc.<a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html#o1">dwFlags</a> = pHC-&gt;dwFlags;
01146             <a class="code" href="../../d7/d9/ntsend_8h.html#a45">COPYLPTSTR</a>(&amp;strlParam, pHC-&gt;lpszDefaultScheme);
01147             ihc.usDefaultScheme = *strlParam.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>;
01148         }
01149         <span class="keywordflow">break</span>;
01150 
01151     <span class="keywordflow">case</span> SPI_SETNONCLIENTMETRICS:
01152 <span class="preprocessor">#if IS_ANSI</span>
01153 <span class="preprocessor"></span>        {
01154             PNONCLIENTMETRICSA psrc = (PNONCLIENTMETRICSA)lParam;
01155 
01156             <span class="keywordflow">if</span> ((lParam == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (*((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(lParam)) != <span class="keyword">sizeof</span>(NONCLIENTMETRICSA)))
01157                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01158 
01159             <span class="keywordflow">if</span>( psrc-&gt;iCaptionWidth &gt; 256 )
01160                 psrc-&gt;iCaptionWidth = 256;
01161 
01162             <span class="keywordflow">if</span>( psrc-&gt;iCaptionHeight &gt; 256 )
01163                 psrc-&gt;iCaptionHeight = 256;
01164 
01165             ClientMetricsW.cbSize           = psrc-&gt;cbSize;
01166             ClientMetricsW.iBorderWidth     = psrc-&gt;iBorderWidth;
01167             ClientMetricsW.iScrollWidth     = psrc-&gt;iScrollWidth;
01168             ClientMetricsW.iScrollHeight    = psrc-&gt;iScrollHeight;
01169             ClientMetricsW.iCaptionWidth    = psrc-&gt;iCaptionWidth;
01170             ClientMetricsW.iCaptionHeight   = psrc-&gt;iCaptionHeight;
01171             ClientMetricsW.iSmCaptionWidth  = psrc-&gt;iSmCaptionWidth;
01172             ClientMetricsW.iSmCaptionHeight = psrc-&gt;iSmCaptionHeight;
01173             ClientMetricsW.iMenuWidth       = psrc-&gt;iMenuWidth;
01174             ClientMetricsW.iMenuHeight      = psrc-&gt;iMenuHeight;
01175 
01176             <a class="code" href="../../d6/d0/usercli_8h.html#a637">CopyLogFontAtoW</a>(&amp;(ClientMetricsW.lfCaptionFont), &amp;(psrc-&gt;lfCaptionFont));
01177             <a class="code" href="../../d6/d0/usercli_8h.html#a637">CopyLogFontAtoW</a>(&amp;(ClientMetricsW.lfSmCaptionFont), &amp;(psrc-&gt;lfSmCaptionFont));
01178             <a class="code" href="../../d6/d0/usercli_8h.html#a637">CopyLogFontAtoW</a>(&amp;(ClientMetricsW.lfMenuFont), &amp;(psrc-&gt;lfMenuFont));
01179             <a class="code" href="../../d6/d0/usercli_8h.html#a637">CopyLogFontAtoW</a>(&amp;(ClientMetricsW.lfStatusFont), &amp;(psrc-&gt;lfStatusFont));
01180             <a class="code" href="../../d6/d0/usercli_8h.html#a637">CopyLogFontAtoW</a>(&amp;(ClientMetricsW.lfMessageFont), &amp;(psrc-&gt;lfMessageFont));
01181 
01182             lParam = &amp;ClientMetricsW;
01183         }
01184 <span class="preprocessor">#else</span>
01185 <span class="preprocessor"></span>        {
01186             PNONCLIENTMETRICSA psrc;
01187 
01188             <span class="keywordflow">if</span> ((lParam == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (*((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(lParam)) != <span class="keyword">sizeof</span>(NONCLIENTMETRICSW)))
01189                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01190 
01191             psrc = (PNONCLIENTMETRICSA)lParam;
01192 
01193             <span class="keywordflow">if</span>( psrc-&gt;iCaptionWidth &gt; 256 )
01194                 psrc-&gt;iCaptionWidth = 256;
01195 
01196             <span class="keywordflow">if</span>( psrc-&gt;iCaptionHeight &gt; 256 )
01197                 psrc-&gt;iCaptionHeight = 256;
01198         }
01199 <span class="preprocessor">#endif</span>
01200 <span class="preprocessor"></span>        wParam = <span class="keyword">sizeof</span>(NONCLIENTMETRICSW);
01201         <span class="keywordflow">break</span>;
01202 
01203     <span class="keywordflow">case</span> SPI_SETMINIMIZEDMETRICS:
01204         <span class="keywordflow">if</span> ((lParam == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (*((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(lParam)) != <span class="keyword">sizeof</span>(MINIMIZEDMETRICS)))
01205             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01206         wParam = <span class="keyword">sizeof</span>(MINIMIZEDMETRICS);
01207         <span class="keywordflow">break</span>;
01208 
01209     <span class="keywordflow">case</span> SPI_SETICONMETRICS:
01210 <span class="preprocessor">#if IS_ANSI</span>
01211 <span class="preprocessor"></span>        {
01212             PICONMETRICSA psrc = (PICONMETRICSA)lParam;
01213 
01214             <span class="keywordflow">if</span> ((lParam == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (*((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(lParam)) != <span class="keyword">sizeof</span>(ICONMETRICSA)))
01215                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01216 
01217             memcpy(&amp;IconMetricsW, psrc, <span class="keyword">sizeof</span>(ICONMETRICSA) - <span class="keyword">sizeof</span>(LOGFONTA));
01218 
01219             <a class="code" href="../../d6/d0/usercli_8h.html#a637">CopyLogFontAtoW</a>(&amp;(IconMetricsW.lfFont), &amp;(psrc-&gt;lfFont));
01220             lParam = &amp;IconMetricsW;
01221         }
01222 <span class="preprocessor">#else</span>
01223 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((lParam == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (*((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(lParam)) != <span class="keyword">sizeof</span>(ICONMETRICSW)))
01224             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01225 <span class="preprocessor">#endif</span>
01226 <span class="preprocessor"></span>        wParam = <span class="keyword">sizeof</span>(ICONMETRICSW);
01227         <span class="keywordflow">break</span>;
01228 
01229     <span class="keywordflow">case</span> SPI_SETICONTITLELOGFONT:
01230 <span class="preprocessor">#if IS_ANSI</span>
01231 <span class="preprocessor"></span>        <a class="code" href="../../d6/d0/usercli_8h.html#a637">CopyLogFontAtoW</a>(&amp;LogFontW, lParam);
01232         lParam = &amp;LogFontW;
01233 <span class="preprocessor">#endif</span>
01234 <span class="preprocessor"></span>        wParam = <span class="keyword">sizeof</span>(LOGFONTW);
01235         <span class="keywordflow">break</span>;
01236 
01237     <span class="keywordflow">case</span> SPI_GETFILTERKEYS:
01238         {
01239             <span class="keywordflow">if</span> ((((LPFILTERKEYS)lParam)-&gt;cbSize == 0) ||
01240                     (((LPFILTERKEYS)lParam)-&gt;cbSize) &gt; <span class="keyword">sizeof</span>(FILTERKEYS)) {
01241                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01242             }
01243         }
01244         <span class="keywordflow">break</span>;
01245 
01246     <span class="keywordflow">case</span> SPI_GETSTICKYKEYS:
01247         {
01248             <span class="keywordflow">if</span> ((((LPSTICKYKEYS)lParam)-&gt;cbSize == 0) ||
01249                     (((LPSTICKYKEYS)lParam)-&gt;cbSize) &gt; <span class="keyword">sizeof</span>(STICKYKEYS)) {
01250                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01251             }
01252         }
01253         <span class="keywordflow">break</span>;
01254 
01255     <span class="keywordflow">case</span> SPI_GETTOGGLEKEYS:
01256         {
01257             <span class="keywordflow">if</span> ((((LPTOGGLEKEYS)lParam)-&gt;cbSize == 0) ||
01258                     (((LPTOGGLEKEYS)lParam)-&gt;cbSize) &gt; <span class="keyword">sizeof</span>(TOGGLEKEYS)) {
01259                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01260             }
01261         }
01262         <span class="keywordflow">break</span>;
01263 
01264     <span class="keywordflow">case</span> SPI_GETMOUSEKEYS:
01265         {
01266             <span class="keywordflow">if</span> ((((LPMOUSEKEYS)lParam)-&gt;cbSize == 0) ||
01267                     (((LPMOUSEKEYS)lParam)-&gt;cbSize) &gt; <span class="keyword">sizeof</span>(MOUSEKEYS)) {
01268                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01269             }
01270         }
01271         <span class="keywordflow">break</span>;
01272 
01273     <span class="keywordflow">case</span> SPI_GETACCESSTIMEOUT:
01274         {
01275             <span class="keywordflow">if</span> ((((LPACCESSTIMEOUT)lParam)-&gt;cbSize == 0) ||
01276                     (((LPACCESSTIMEOUT)lParam)-&gt;cbSize) &gt; <span class="keyword">sizeof</span>(ACCESSTIMEOUT)) {
01277                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01278             }
01279         }
01280         <span class="keywordflow">break</span>;
01281 
01282     <span class="keywordflow">case</span> SPI_GETSOUNDSENTRY:
01283         <span class="comment">/*</span>
01284 <span class="comment">         * Note: Currently we don't support the windows effect dll</span>
01285 <span class="comment">         * option for sound sentry.  Therefore, we don't have to</span>
01286 <span class="comment">         * deal with the lpszWindowsEffectDLL field (which can be</span>
01287 <span class="comment">         * ANSI or Unicode).</span>
01288 <span class="comment">         */</span>
01289         {
01290             <span class="keywordflow">if</span> ((((LPSOUNDSENTRY)lParam)-&gt;cbSize == 0) ||
01291                     (((LPSOUNDSENTRY)lParam)-&gt;cbSize) &gt; <span class="keyword">sizeof</span>(SOUNDSENTRY)) {
01292                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01293             }
01294         }
01295         <span class="keywordflow">break</span>;
01296     }
01297 
01298     retval = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a118">NtUserSystemParametersInfo</a>(wFlag, wParam, lParam, flags);
01299 
01300     <span class="keywordflow">switch</span> (wFlag) {
01301 <span class="preprocessor">#if IS_ANSI</span>
01302 <span class="preprocessor"></span>    <span class="keywordflow">case</span> SPI_GETNONCLIENTMETRICS:
01303         {
01304             PNONCLIENTMETRICSA pdst = (PNONCLIENTMETRICSA)oldlParam;
01305 
01306             pdst-&gt;cbSize           = <span class="keyword">sizeof</span>(NONCLIENTMETRICSA);
01307             pdst-&gt;iBorderWidth     = ClientMetricsW.iBorderWidth;
01308             pdst-&gt;iScrollWidth     = ClientMetricsW.iScrollWidth;
01309             pdst-&gt;iScrollHeight    = ClientMetricsW.iScrollHeight;
01310             pdst-&gt;iCaptionWidth    = ClientMetricsW.iCaptionWidth;
01311             pdst-&gt;iCaptionHeight   = ClientMetricsW.iCaptionHeight;
01312             pdst-&gt;iSmCaptionWidth  = ClientMetricsW.iSmCaptionWidth;
01313             pdst-&gt;iSmCaptionHeight = ClientMetricsW.iSmCaptionHeight;
01314             pdst-&gt;iMenuWidth       = ClientMetricsW.iMenuWidth;
01315             pdst-&gt;iMenuHeight      = ClientMetricsW.iMenuHeight;
01316 
01317             <a class="code" href="../../d6/d0/usercli_8h.html#a638">CopyLogFontWtoA</a>(&amp;(pdst-&gt;lfCaptionFont), &amp;(ClientMetricsW.lfCaptionFont));
01318             <a class="code" href="../../d6/d0/usercli_8h.html#a638">CopyLogFontWtoA</a>(&amp;(pdst-&gt;lfSmCaptionFont), &amp;(ClientMetricsW.lfSmCaptionFont));
01319             <a class="code" href="../../d6/d0/usercli_8h.html#a638">CopyLogFontWtoA</a>(&amp;(pdst-&gt;lfMenuFont), &amp;(ClientMetricsW.lfMenuFont));
01320             <a class="code" href="../../d6/d0/usercli_8h.html#a638">CopyLogFontWtoA</a>(&amp;(pdst-&gt;lfStatusFont), &amp;(ClientMetricsW.lfStatusFont));
01321             <a class="code" href="../../d6/d0/usercli_8h.html#a638">CopyLogFontWtoA</a>(&amp;(pdst-&gt;lfMessageFont), &amp;(ClientMetricsW.lfMessageFont));
01322         }
01323         <span class="keywordflow">break</span>;
01324 
01325     <span class="keywordflow">case</span> SPI_GETICONMETRICS:
01326         {
01327             PICONMETRICSA pdst = (PICONMETRICSA)oldlParam;
01328 
01329             memcpy(pdst, &amp;IconMetricsW, <span class="keyword">sizeof</span>(ICONMETRICSA) - <span class="keyword">sizeof</span>(LOGFONTA));
01330             pdst-&gt;cbSize = <span class="keyword">sizeof</span>(ICONMETRICSA);
01331 
01332             <a class="code" href="../../d6/d0/usercli_8h.html#a638">CopyLogFontWtoA</a>(&amp;(pdst-&gt;lfFont), &amp;(IconMetricsW.lfFont));
01333         }
01334         <span class="keywordflow">break</span>;
01335 
01336     <span class="keywordflow">case</span> SPI_GETICONTITLELOGFONT:
01337         {
01338             <a class="code" href="../../d6/d0/usercli_8h.html#a638">CopyLogFontWtoA</a>((PLOGFONTA)oldlParam, &amp;LogFontW);
01339         }
01340         <span class="keywordflow">break</span>;
01341 
01342     <span class="keywordflow">case</span> SPI_GETHIGHCONTRAST:
01343         WCSToMB(<a class="code" href="../../d1/d8/clglobal_8c.html#a16">pwcHighContrastScheme</a>, -1, &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a17">pcHighContrastScheme</a>, MAX_SCHEME_NAME_SIZE, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01344         ((LPHIGHCONTRASTA)(lParam))-&gt;lpszDefaultScheme = <a class="code" href="../../d1/d8/clglobal_8c.html#a17">pcHighContrastScheme</a>;
01345         <span class="keywordflow">break</span>;
01346 
01347 <span class="preprocessor">#endif  // IS_ANSI</span>
01348 <span class="preprocessor"></span>
01349     <span class="comment">/*</span>
01350 <span class="comment">     * Bug 257718 - joejo</span>
01351 <span class="comment">     * Add SPI_GETDESKWALLPAPER to SystemParametersInfo</span>
01352 <span class="comment">     */</span>
01353     <span class="keywordflow">case</span> SPI_GETDESKWALLPAPER:
01354         {
01355         <span class="comment">/*</span>
01356 <span class="comment">         * Bug 283318 - joejo</span>
01357 <span class="comment">         * Make sure strings are null terminated.</span>
01358 <span class="comment">         */</span>
01359 <span class="preprocessor">#if IS_ANSI</span>
01360 <span class="preprocessor"></span>            <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> cchAnsiCopy = WCSToMB(lParam,
01361                                         -1,
01362                                         (LPSTR*)&amp;oldlParam,
01363                                         oldwParam - 1,
01364                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01365 
01366             cchAnsiCopy = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(cchAnsiCopy, (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)(oldwParam - 1));
01367             ((LPSTR)oldlParam)[cchAnsiCopy] = 0;
01368 <span class="preprocessor">#else   //UNICODE</span>
01369 <span class="preprocessor"></span>            ((LPWSTR)oldlParam)[wParam] = (WCHAR)0;
01370 <span class="preprocessor">#endif  //IS_ANSI</span>
01371 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
01372         }
01373     <span class="keywordflow">case</span> SPI_SETLOWPOWERTIMEOUT:
01374     <span class="keywordflow">case</span> SPI_SETPOWEROFFTIMEOUT:
01375         <span class="keywordflow">if</span> (retval &amp;&amp; (flags &amp; SPIF_UPDATEINIFILE)) {
01376             retval = <a class="code" href="../../d6/d0/usercli_8h.html#a553">SetVideoTimeout</a>(wParam);
01377         }
01378         <span class="keywordflow">break</span>;
01379     }
01380 
01381     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01382     <a class="code" href="../../d7/d9/ntsend_8h.html#a55">CLEANUPLPTSTR</a>(strlParam);
01383     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
01384 }
01385 
01386 
<a name="l01387"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a27">01387</a> HANDLE <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a27">GetProp</a>(HWND hwnd, LPCTSTR pString) {
01388     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01389     <span class="keywordtype">int</span> iString;
01390 
01391     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pString)) {
01392         iString = (<span class="keywordtype">int</span>)GlobalFindAtom(pString);
01393         <span class="keywordflow">if</span> (iString == 0)
01394             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01395     } <span class="keywordflow">else</span>
01396         iString = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(pString);
01397 
01398     pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
01399 
01400     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01401         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01402 
01403     <span class="keywordflow">return</span> <a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, (LPWSTR)UIntToPtr( iString ), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01404 }
01405 
01406 
01407 <span class="comment">/***************************************************************************\</span>
01408 <span class="comment">* RegisterClassW(API)</span>
01409 <span class="comment">*</span>
01410 <span class="comment">* History:</span>
01411 <span class="comment">* 28-Jul-1992 ChandanC Created.</span>
01412 <span class="comment">\***************************************************************************/</span>
01413 ATOM
01414 WINAPI
<a name="l01415"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a7">01415</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a36">TEXT_FN</a>(RegisterClass)(
01416     CONST WNDCLASS *lpWndClass )
01417 {
01418     WNDCLASSEX wc;
01419 
01420     <span class="comment">/*</span>
01421 <span class="comment">     * On 64-bit plaforms we'll have 32-bits of padding between style and</span>
01422 <span class="comment">     * lpfnWndProc in WNDCLASS, so start the copy from the first 64-bit</span>
01423 <span class="comment">     * aligned field and hand copy the rest.</span>
01424 <span class="comment">     */</span>
01425     RtlCopyMemory(&amp;(wc.lpfnWndProc), &amp;(lpWndClass-&gt;lpfnWndProc), <span class="keyword">sizeof</span>(WNDCLASS) - FIELD_OFFSET(WNDCLASS, lpfnWndProc));
01426     wc.style = lpWndClass-&gt;style;
01427     wc.hIconSm = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01428     wc.cbSize = <span class="keyword">sizeof</span>(WNDCLASSEX);
01429 
01430     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a36">TEXT_FN</a>(<a class="code" href="../../d0/d8/ntcftxt_8h.html#a7">RegisterClassExWOW</a>)(&amp;wc, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
01431 }
01432 
01433 <span class="comment">/***************************************************************************\</span>
01434 <span class="comment">* RegisterClassExW(API)</span>
01435 <span class="comment">*</span>
01436 <span class="comment">* History:</span>
01437 <span class="comment">* 28-Jul-1992 ChandanC Created.</span>
01438 <span class="comment">\***************************************************************************/</span>
01439 ATOM
01440 WINAPI
<a name="l01441"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a8">01441</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a36">TEXT_FN</a>(RegisterClassEx)(
01442     CONST WNDCLASSEX *lpWndClass)
01443 {
01444     <span class="keywordflow">if</span> (lpWndClass-&gt;cbSize != <span class="keyword">sizeof</span>(WNDCLASSEX)) {
01445         RIPERR1(ERROR_INVALID_PARAMETER,
01446                 RIP_WARNING,
01447                 <span class="stringliteral">"RegisterClassEx: cbsize is wrong %lX"</span>,
01448                 lpWndClass-&gt;cbSize);
01449 
01450         <span class="keywordflow">return</span> 0;
01451     } <span class="keywordflow">else</span> {
01452         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a36">TEXT_FN</a>(<a class="code" href="../../d0/d8/ntcftxt_8h.html#a7">RegisterClassExWOW</a>)((LPWNDCLASSEX)lpWndClass,
01453                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
01454     }
01455 }
01456 
01457 <span class="comment">/***************************************************************************\</span>
01458 <span class="comment">* GetMenuItemInfoInternal</span>
01459 <span class="comment">*</span>
01460 <span class="comment">* History:</span>
01461 <span class="comment">*  07-22-96 GerardoB - Added header and Fixed up for 5.0</span>
01462 <span class="comment">\***************************************************************************/</span>
<a name="l01463"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a9">01463</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a36">TEXT_FN</a>(GetMenuItemInfoInternal) (HMENU hMenu, <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uID, <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fByPosition,
01464     LPMENUITEMINFOW lpInfo)
01465 {
01466      VALIDATIONFNNAME(<a class="code" href="../../d5/d9/cltxt_8h.html#a9">GetMenuItemInfoInternal</a>)
01467 
01468      <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
01469      <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu;
01470      <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenuT;
01471 
01472      pMenu = <a class="code" href="../../d6/d0/usercli_8h.html#a22">VALIDATEHMENU</a>(hMenu);
01473      <span class="keywordflow">if</span> (pMenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01474         VALIDATIONFAIL(hMenu);
01475      }
01476 
01477      pMenuT = pMenu;         <span class="comment">// need to check the ORIGINAL menu if popup</span>
01478 
01479      pItem = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a10">MNLookUpItem</a>(pMenu, uID, fByPosition, &amp;pMenu);
01480     <span class="keywordflow">if</span> (pItem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01481         <span class="comment">/*</span>
01482 <span class="comment">         * Don't display a warning. The explorer makes a lot of calls</span>
01483 <span class="comment">         *  that fail here.</span>
01484 <span class="comment">         * VALIDATIONFAIL(uID);</span>
01485 <span class="comment">         */</span>
01486         SetLastError(ERROR_MENU_ITEM_NOT_FOUND);
01487         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01488 
01489     }
01490 
01491     <span class="keywordflow">if</span> (lpInfo-&gt;fMask &amp; MIIM_STATE) {
01492         lpInfo-&gt;fState = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> &amp; MFS_MASK;
01493     }
01494 
01495     <span class="keywordflow">if</span> (lpInfo-&gt;fMask &amp; MIIM_ID) {
01496         lpInfo-&gt;wID = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o2">wID</a>;
01497     }
01498 
01499     <span class="keywordflow">if</span> ((lpInfo-&gt;fMask &amp; MIIM_SUBMENU) &amp;&amp; (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01500         lpInfo-&gt;hSubMenu = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a25">REBASEPTR</a>(pMenu, pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>));
01501     } <span class="keywordflow">else</span> {
01502         lpInfo-&gt;hSubMenu = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01503     }
01504 
01505     <span class="keywordflow">if</span> (lpInfo-&gt;fMask &amp; MIIM_CHECKMARKS) {
01506         lpInfo-&gt;hbmpChecked  = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o4">hbmpChecked</a>;
01507         lpInfo-&gt;hbmpUnchecked= pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o5">hbmpUnchecked</a>;
01508     }
01509 
01510     <span class="keywordflow">if</span> (lpInfo-&gt;fMask &amp; MIIM_DATA) {
01511        lpInfo-&gt;dwItemData = KERNEL_ULONG_PTR_TO_ULONG_PTR(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o8">dwItemData</a>);
01512     }
01513 
01514     <span class="keywordflow">if</span> (lpInfo-&gt;fMask &amp; MIIM_FTYPE) {
01515         lpInfo-&gt;fType = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o0">fType</a> &amp; MFT_MASK;
01516         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenuT,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a147">MFRTL</a>))
01517             lpInfo-&gt;fType |= MFT_RIGHTORDER;
01518     }
01519 
01520     <span class="keywordflow">if</span> ( lpInfo-&gt;fMask &amp; MIIM_BITMAP) {
01521         lpInfo-&gt;hbmpItem = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a>;
01522     }
01523 
01524     <span class="keywordflow">if</span> (lpInfo-&gt;fMask &amp; MIIM_STRING) {
01525         <span class="keywordflow">if</span> ((lpInfo-&gt;cch == 0)
01526             || (lpInfo-&gt;dwTypeData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01527 
01528             <span class="comment">/*</span>
01529 <span class="comment">             * If this is an old caller (MIIM_TYPE set), and this item</span>
01530 <span class="comment">             *  has a bitmap or it's ownerdraw, then don't attempt to</span>
01531 <span class="comment">             *  copy a string since they probably didn't pass a pointer</span>
01532 <span class="comment">            */</span>
01533 
01534             || ((lpInfo-&gt;fMask &amp; MIIM_TYPE)
01535                     &amp;&amp; ((lpInfo-&gt;fType &amp; MFT_OWNERDRAW)
01536                             <span class="comment">/*</span>
01537 <span class="comment">                             * Bug 278750 - jojoe</span>
01538 <span class="comment">                             *</span>
01539 <span class="comment">                             * Soemone forgot to check for separator in the list</span>
01540 <span class="comment">                             * of menuitems that do NOT return string data!</span>
01541 <span class="comment">                             */</span>
01542                             || (lpInfo-&gt;fType &amp; MFT_SEPARATOR)
01543                             || ((pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  &amp;&amp; ((pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> &lt; HBMMENU_POPUPFIRST) || (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> &gt; HBMMENU_POPUPLAST)))))) {
01544 
01545 
01546 
01547             <span class="comment">/*</span>
01548 <span class="comment">             * When DBCS is enabled, one UNICODE character may occupy two bytes.</span>
01549 <span class="comment">             * GetMenuItemInfoA should return the byte count, rather than the character count.</span>
01550 <span class="comment">             * On NT5, pItem-&gt;lpstr is guaranteed to be a valid string, if it is not NULL.</span>
01551 <span class="comment">             */</span>
01552             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>() &amp;&amp; pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01553                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01554                 ULONG cch;
01555 
01556                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a36">RtlUnicodeToMultiByteSize</a>(&amp;cch, <a class="code" href="../../d6/d0/usercli_8h.html#a25">REBASEPTR</a>(pMenu, pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a>), pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o7">cch</a> * <span class="keyword">sizeof</span>(WCHAR));
01557                 UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)); <span class="comment">// RtlUnicodeToMultiByteSize is not expected to fail</span>
01558                 lpInfo-&gt;cch = cch;
01559             } <span class="keywordflow">else</span> {
01560                 lpInfo-&gt;cch = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o7">cch</a>;
01561             }
01562             lpInfo-&gt;dwTypeData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01563 
01564 
01565         } <span class="keywordflow">else</span> {
01566             <span class="keywordtype">int</span> cch = 0;
01567 
01568             <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01569 
01570                 <span class="comment">// originally:</span>
01571                 <span class="comment">// cch = min(lpInfo-&gt;cch - 1, (pItem-&gt;cch * sizeof(WORD)));</span>
01572                 cch = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o7">cch</a>;
01573                 UserAssert(cch &gt;= 0);
01574                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>()) {
01575                     <span class="comment">/* pItem-&gt;cch contains Unicode character counts,</span>
01576 <span class="comment">                     * we guess max DBCS string size for the Unicode string.</span>
01577 <span class="comment">                     */</span>
01578                     cch *= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a123">DBCS_CHARSIZE</a>;
01579                 }
01580                 cch = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(lpInfo-&gt;cch - 1, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)cch);
01581 
01582 <span class="preprocessor">#if IS_ANSI</span>
01583 <span class="preprocessor"></span>                cch = WCSToMB(<a class="code" href="../../d6/d0/usercli_8h.html#a25">REBASEPTR</a>(pMenu, pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a>), pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o7">cch</a>,
01584                         (LPSTR *)&amp;(lpInfo-&gt;dwTypeData), cch, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01585 <span class="preprocessor">#else</span>
01586 <span class="preprocessor"></span>                wcsncpy(lpInfo-&gt;dwTypeData, (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a25">REBASEPTR</a>(pMenu, pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a>),
01587     cch);
01588 <span class="preprocessor">#endif</span>
01589 <span class="preprocessor"></span>            }
01590 
01591 <span class="preprocessor">#if IS_ANSI</span>
01592 <span class="preprocessor"></span>            *((LPSTR)lpInfo-&gt;dwTypeData + cch) = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)0;
01593 <span class="preprocessor">#else</span>
01594 <span class="preprocessor"></span>            *(lpInfo-&gt;dwTypeData + cch) = (WCHAR)0;
01595 <span class="preprocessor">#endif</span>
01596 <span class="preprocessor"></span>            lpInfo-&gt;cch = cch;
01597         }
01598      }
01599 
01600      <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01601 
01602      VALIDATIONERROR(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01603 
01604 }
01605 <span class="comment">/***************************************************************************\</span>
01606 <span class="comment">* GetMenuString()</span>
01607 <span class="comment">*</span>
01608 <span class="comment">* History:</span>
01609 <span class="comment">*  07-22-96 GerardoB - Added header and Fixed up for 5.0</span>
01610 <span class="comment">\***************************************************************************/</span>
<a name="l01611"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a28">01611</a> <span class="keywordtype">int</span> <a class="code" href="../../d5/d9/cltxt_8h.html#a28">GetMenuString</a>(HMENU hMenu, UINT wID, LPTSTR lpsz, <span class="keywordtype">int</span> cchMax, UINT flags)
01612 {
01613     MENUITEMINFOW    miiLocal;
01614 
01615     miiLocal.fMask      = MIIM_STRING;
01616     miiLocal.dwTypeData = (LPWSTR)lpsz;
01617     miiLocal.cch        = cchMax;
01618 
01619     <span class="keywordflow">if</span> (cchMax != 0) {
01620         *lpsz = (TCHAR)0;
01621     }
01622 
01623     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a36">TEXT_FN</a>(<a class="code" href="../../d5/d9/cltxt_8h.html#a9">GetMenuItemInfoInternal</a>)(hMenu, wID, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(flags &amp; MF_BYPOSITION), &amp;miiLocal)) {
01624         <span class="keywordflow">return</span> miiLocal.cch;
01625     } <span class="keywordflow">else</span> {
01626         <span class="keywordflow">return</span> 0;
01627     }
01628 }
01629 
01630 <span class="comment">/***************************************************************************\</span>
01631 <span class="comment">* GetMenuItemInfo</span>
01632 <span class="comment">*</span>
01633 <span class="comment">*  1) converts a MENUITEMINFO95 or a new-MENUITEMINFO-with-old-flags to a new</span>
01634 <span class="comment">*     MENUITEMINFO -- this way all internal code can assume one look for the</span>
01635 <span class="comment">*     structure</span>
01636 <span class="comment">*  2) calls the internal GetMenuItemInfo which performs validation and work</span>
01637 <span class="comment">*  3) converts the new MENUITEMINFO back to the original MENUITEMINFO</span>
01638 <span class="comment">*</span>
01639 <span class="comment">* History:</span>
01640 <span class="comment">*  07-22-96 GerardoB - Fixed up for 5.0</span>
01641 <span class="comment">\***************************************************************************/</span>
01642 
<a name="l01643"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a29">01643</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a29">GetMenuItemInfo</a>(HMENU hMenu, UINT wID, BOOL fByPos, LPMENUITEMINFO lpmii)
01644 {
01645     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cbCallercbSize = lpmii-&gt;cbSize;
01646     MENUITEMINFOW miiLocal;
01647 
01648 
01649     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a769">ValidateMENUITEMINFO</a>((LPMENUITEMINFOW)lpmii, &amp;miiLocal, <a class="code" href="../../d6/d0/usercli_8h.html#a255">MENUAPI_GET</a>)) {
01650         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01651     }
01652 
01653     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a36">TEXT_FN</a>(<a class="code" href="../../d5/d9/cltxt_8h.html#a9">GetMenuItemInfoInternal</a>)(hMenu, wID, fByPos, &amp;miiLocal)) {
01654         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01655     }
01656 
01657     <span class="comment">/*</span>
01658 <span class="comment">     * Copy the structure and map old flags back. Only requested fields were</span>
01659 <span class="comment">     *   modified, so it's OK  to copy all fields back.</span>
01660 <span class="comment">     */</span>
01661     RtlCopyMemory(lpmii, &amp;miiLocal, SIZEOFMENUITEMINFO95);
01662     lpmii-&gt;cbSize = cbCallercbSize;
01663     <span class="keywordflow">if</span> (cbCallercbSize &gt; SIZEOFMENUITEMINFO95) {
01664         lpmii-&gt;hbmpItem = miiLocal.hbmpItem;
01665     }
01666 
01667     <span class="keywordflow">if</span> (lpmii-&gt;fMask &amp; MIIM_TYPE) {
01668         <span class="keywordflow">if</span> ((miiLocal.hbmpItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (miiLocal.dwTypeData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01669             lpmii-&gt;fType |= MFT_BITMAP;
01670             lpmii-&gt;dwTypeData = (LPTSTR)miiLocal.hbmpItem;
01671         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (miiLocal.cch == 0) {
01672             lpmii-&gt;dwTypeData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01673         }
01674         lpmii-&gt;fMask &amp;= ~(MIIM_FTYPE | MIIM_BITMAP | MIIM_STRING);
01675     }
01676 
01677     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01678 }
01679 <span class="comment">/***************************************************************************\</span>
01680 <span class="comment">* SetMenuItemInfo</span>
01681 <span class="comment">*</span>
01682 <span class="comment">* History:</span>
01683 <span class="comment">*  07-22-96 GerardoB - Added header and Fixed up for 5.0</span>
01684 <span class="comment">\***************************************************************************/</span>
<a name="l01685"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a30">01685</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a30">SetMenuItemInfo</a>(HMENU hMenu, UINT uID, BOOL fByPosition, LPCMENUITEMINFO lpmii)
01686 {
01687 
01688     MENUITEMINFOW miiLocal;
01689 
01690     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a769">ValidateMENUITEMINFO</a>((LPMENUITEMINFOW)lpmii, &amp;miiLocal, <a class="code" href="../../d6/d0/usercli_8h.html#a256">MENUAPI_SET</a>)) {
01691         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01692     }
01693 
01694     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a771">ThunkedMenuItemInfo</a>(hMenu, uID, fByPosition, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;miiLocal, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>));
01695 }
01696 <span class="comment">/***************************************************************************\</span>
01697 <span class="comment">* InsertMenuItem</span>
01698 <span class="comment">*</span>
01699 <span class="comment">* History:</span>
01700 <span class="comment">*  07-22-96 GerardoB - Added header and Fixed up for 5.0</span>
01701 <span class="comment">\***************************************************************************/</span>
<a name="l01702"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a31">01702</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a31">InsertMenuItem</a> (HMENU hMenu, UINT uID, BOOL fByPosition, LPCMENUITEMINFO lpmii)
01703 {
01704 
01705     MENUITEMINFOW miiLocal;
01706 
01707     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a769">ValidateMENUITEMINFO</a>((LPMENUITEMINFOW)lpmii, &amp;miiLocal, <a class="code" href="../../d6/d0/usercli_8h.html#a256">MENUAPI_SET</a>)) {
01708         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01709     }
01710 
01711     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a771">ThunkedMenuItemInfo</a>(hMenu, uID, fByPosition, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;miiLocal, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>));
01712 }
01713 
01714 <span class="comment">/***************************************************************************\</span>
01715 <span class="comment">* InsertMenu</span>
01716 <span class="comment">*</span>
01717 <span class="comment">* History:</span>
01718 <span class="comment">*  07-22-96 GerardoB - Added header and Fixed up for 5.0</span>
01719 <span class="comment">\***************************************************************************/</span>
<a name="l01720"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a32">01720</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a32">InsertMenu</a>(HMENU hMenu, UINT uPosition, UINT uFlags, UINT_PTR uIDNewItem, LPCTSTR lpNewItem)
01721 {
01722     MENUITEMINFOW miiLocal;
01723 
01724     <a class="code" href="../../d6/d0/usercli_8h.html#a772">SetMenuItemInfoStruct</a>(hMenu, uFlags, uIDNewItem, (LPWSTR)lpNewItem, &amp;miiLocal);
01725     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a771">ThunkedMenuItemInfo</a>(hMenu, uPosition, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>) (uFlags &amp; MF_BYPOSITION), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (LPMENUITEMINFOW)&amp;miiLocal, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
01726 }
01727 
01728 <span class="comment">/***************************************************************************\</span>
01729 <span class="comment">* AppendMenu</span>
01730 <span class="comment">*</span>
01731 <span class="comment">* History:</span>
01732 <span class="comment">*  07-22-96 GerardoB - Added header and Fixed up for 5.0</span>
01733 <span class="comment">\***************************************************************************/</span>
<a name="l01734"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a33">01734</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a33">AppendMenu</a>(HMENU hMenu, UINT uFlags, UINT_PTR uIDNewItem, LPCTSTR lpNewItem)
01735 {
01736     MENUITEMINFOW miiLocal;
01737 
01738     <a class="code" href="../../d6/d0/usercli_8h.html#a772">SetMenuItemInfoStruct</a>(hMenu, uFlags, uIDNewItem, (LPWSTR)lpNewItem, &amp;miiLocal);
01739     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a771">ThunkedMenuItemInfo</a>(hMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>, MF_BYPOSITION, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (LPMENUITEMINFOW)&amp;miiLocal, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
01740 }
01741 <span class="comment">/***************************************************************************\</span>
01742 <span class="comment">* ModifyMenu</span>
01743 <span class="comment">*</span>
01744 <span class="comment">* History:</span>
01745 <span class="comment">*  07-22-96 GerardoB - Added header and Fixed up for 5.0</span>
01746 <span class="comment">\***************************************************************************/</span>
<a name="l01747"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a34">01747</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a34">ModifyMenu</a>(HMENU hMenu, UINT uPosition, UINT uFlags, UINT_PTR uIDNewItem, LPCTSTR lpNewItem) {
01748     MENUITEMINFOW miiLocal;
01749 
01750     <a class="code" href="../../d6/d0/usercli_8h.html#a772">SetMenuItemInfoStruct</a>(hMenu, uFlags, uIDNewItem, (LPWSTR)lpNewItem, &amp;miiLocal);
01751     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a771">ThunkedMenuItemInfo</a>(hMenu, uPosition, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>) (uFlags &amp; MF_BYPOSITION), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (LPMENUITEMINFOW)&amp;miiLocal, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
01752 }
01753 
01754 <span class="comment">/***************************************************************************\</span>
01755 <span class="comment">* BroadcastSystemMessage</span>
01756 <span class="comment">*</span>
01757 <span class="comment">* History:</span>
01758 <span class="comment">*  07-22-96 GerardoB - Added header</span>
01759 <span class="comment">\***************************************************************************/</span>
<a name="l01760"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a35">01760</a> WINUSERAPI LONG <a class="code" href="../../d5/d9/cltxt_8h.html#a35">BroadcastSystemMessage</a>(DWORD dwFlags, LPDWORD lpdwRecipients,
01761     UINT uiMessage, WPARAM wParam, LPARAM lParam)
01762 {
01763     <span class="keyword">extern</span> LONG <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a44">BroadcastSystemMessageWorker</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, LPDWORD lpdwRecipients,
01764     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uiMessage, WPARAM wParam, LPARAM lParam, <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAnsi);
01765 
01766     <span class="keywordflow">return</span> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a44">BroadcastSystemMessageWorker</a>(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, lpdwRecipients,
01767         uiMessage, wParam, lParam, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
01768 }
01769 
01770 WINUSERAPI <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> WINAPI
<a name="l01771"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a36">01771</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a36">GetWindowModuleFileName</a>(HWND hwnd, LPTSTR pszFileName, UINT cchFileNameMax)
01772 {
01773     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01774 
01775     pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
01776 
01777     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01778         <span class="keywordflow">return</span> 0;
01779     }
01780 
01781     <span class="keywordflow">return</span> GetModuleFileName(pwnd-&gt;hModule, pszFileName, cchFileNameMax);
01782 }
01783 
01784 <span class="comment">/***************************************************************************\</span>
01785 <span class="comment">* RegisterDeviceNotification</span>
01786 <span class="comment">*</span>
01787 <span class="comment">* History:</span>
01788 <span class="comment">*  01-23-97 PaulaT - Added header</span>
01789 <span class="comment">\***************************************************************************/</span>
01790 
01791 WINUSERAPI HDEVNOTIFY WINAPI
<a name="l01792"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a37">01792</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a37">RegisterDeviceNotification</a>(
01793     IN HANDLE hRecipient,
01794     IN LPVOID NotificationFilter,
01795     IN DWORD Flags
01796     )
01797 {
01798     <span class="keyword">extern</span> HDEVNOTIFY <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a45">RegisterDeviceNotificationWorker</a>(IN HANDLE hRecipient,
01799                                                        IN <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> NotificationFilter,
01800                                                        IN <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Flags,
01801                                                        IN <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> IsAnsi
01802                                                        );
01803 
01804     <span class="comment">// translate strings in NotificationFilter (if any)</span>
01805 
01806     <span class="keywordflow">return</span> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a45">RegisterDeviceNotificationWorker</a>(hRecipient,
01807                                             NotificationFilter,
01808                                             Flags,
01809                                             <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>
01810                                             );
01811 }
01812 
01813 
01814 
01815 <span class="comment">/***************************************************************************\</span>
01816 <span class="comment">* GetMonitorInfo</span>
01817 <span class="comment">*</span>
01818 <span class="comment">* History:</span>
01819 <span class="comment">* 31-Mar-1997 adams     Doesn't call into kernel.</span>
01820 <span class="comment">* 06-Jul-1998 MCostea   Has to call into kernel #190510</span>
01821 <span class="comment">\***************************************************************************/</span>
01822 
01823 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINUSERAPI
<a name="l01824"></a><a class="code" href="../../d5/d9/cltxt_8h.html#a38">01824</a> <a class="code" href="../../d5/d9/cltxt_8h.html#a38">GetMonitorInfo</a>(HMONITOR hMonitor, LPMONITORINFO lpmi)
01825 {
01826     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor;
01827     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        bRetVal;
01828     <span class="keywordtype">int</span>         cbSize;
01829 
01830     pMonitor = <a class="code" href="../../d6/d0/usercli_8h.html#a23">VALIDATEHMONITOR</a>(hMonitor);
01831     <span class="keywordflow">if</span> (!pMonitor) {
01832         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01833     }
01834 
01835     cbSize = lpmi-&gt;cbSize;
01836     <span class="keywordflow">if</span> (cbSize == <span class="keyword">sizeof</span>(MONITORINFO)) {
01837         <span class="comment">/*</span>
01838 <span class="comment">         * Check for this first, since it is the most</span>
01839 <span class="comment">         * common size. All the work for filling in</span>
01840 <span class="comment">         * MONITORINFO fields is done after the else-if</span>
01841 <span class="comment">         * statements.</span>
01842 <span class="comment">         */</span>
01843 
01844     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cbSize == <span class="keyword">sizeof</span>(MONITORINFOEX)) {
01845         <span class="comment">/*</span>
01846 <span class="comment">         * The ANSI version has to translate the szDevice field</span>
01847 <span class="comment">         */</span>
01848         ULONG_PTR pName;
01849 <span class="preprocessor">#if IS_ANSI</span>
01850 <span class="preprocessor"></span>        WCHAR szDevice[CCHDEVICENAME];
01851         pName = (ULONG_PTR)szDevice;
01852 <span class="preprocessor">#else</span>
01853 <span class="preprocessor"></span>        pName = (ULONG_PTR)(((LPMONITORINFOEX)lpmi)-&gt;szDevice);
01854 <span class="preprocessor">#endif</span>
01855 <span class="preprocessor"></span>        bRetVal = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a180">NtUserCallTwoParam</a>((ULONG_PTR)(hMonitor),
01856                            pName,
01857                            SFI_GETHDEVNAME);
01858         <span class="keywordflow">if</span> (!bRetVal) {
01859             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01860         }
01861 <span class="preprocessor">#if IS_ANSI</span>
01862 <span class="preprocessor"></span>        WideCharToMultiByte(
01863             CP_ACP, 0,                                  <span class="comment">// ANSI -&gt; Unicode</span>
01864             (LPWSTR)pName, -1,                          <span class="comment">// source &amp; length</span>
01865             (LPSTR)((LPMONITORINFOEX)lpmi)-&gt;szDevice,   <span class="comment">// destination &amp; length</span>
01866             <span class="keyword">sizeof</span>(WCHAR)*CCHDEVICENAME,
01867             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01868 
01869 <span class="preprocessor">#endif</span>
01870 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
01871         RIPERR1(ERROR_INVALID_PARAMETER,
01872                 RIP_WARNING,
01873                 <span class="stringliteral">"Invalid lpmi-&gt;cbSize, %d"</span>, lpmi-&gt;cbSize);
01874 
01875         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01876     }
01877 
01878     lpmi-&gt;dwFlags = (pMonitor == <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>()) ? MONITORINFOF_PRIMARY : 0;
01879     lpmi-&gt;rcMonitor = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>;
01880     lpmi-&gt;rcWork = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>;
01881 
01882     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01883 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
