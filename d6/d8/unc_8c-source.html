<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: unc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>unc.c</h1><a href="../../d5/d9/unc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    unc.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This file contains functions to support multiple UNC providers</span>
00012 <span class="comment">    on a single NT machine.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Manny Weiser     [MannyW]    20-Dec-1991</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Isaac Heizer     [IsaacHe]   16-Nov-1994  Defer loading the MUP</span>
00021 <span class="comment">                                              Rewrite</span>
00022 <span class="comment"></span>
00023 <span class="comment">    Milan Shah       [MilanS]    7-Mar-1996   Check for Dfs client status</span>
00024 <span class="comment">                                              before loading the MUP</span>
00025 <span class="comment"></span>
00026 <span class="comment">--*/</span>
00027 
00028 <span class="preprocessor">#include "<a class="code" href="../../d3/d8/fsrtlp_8h.html">fsrtlp.h</a>"</span>
00029 <span class="preprocessor">#include &lt;zwapi.h&gt;</span>
00030 <span class="preprocessor">#include &lt;ntddmup.h&gt;</span>
00031 <span class="preprocessor">#include &lt;ntddnull.h&gt;</span>
00032 
<a name="l00033"></a><a class="code" href="../../d5/d9/unc_8c.html#a2">00033</a> <span class="keyword">static</span> WCHAR <a class="code" href="../../d5/d9/unc_8c.html#a2">MupRegKey</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\Mup"</span>;
<a name="l00034"></a><a class="code" href="../../d5/d9/unc_8c.html#a3">00034</a> <span class="keyword">static</span> WCHAR <a class="code" href="../../d5/d9/unc_8c.html#a3">UNCSymbolicLink</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\DosDevices\\UNC"</span>;
<a name="l00035"></a><a class="code" href="../../d5/d9/unc_8c.html#a4">00035</a> <span class="keyword">static</span> WCHAR <a class="code" href="../../d5/d9/unc_8c.html#a4">DevNull</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Device\\Null"</span>;
<a name="l00036"></a><a class="code" href="../../d5/d9/unc_8c.html#a5">00036</a> <span class="keyword">static</span> WCHAR <a class="code" href="../../d5/d9/unc_8c.html#a5">DevMup</a>[] = DD_MUP_DEVICE_NAME;
00037 
00038 <span class="comment">//</span>
00039 <span class="comment">//  Define a tag for general pool allocations from this module</span>
00040 <span class="comment">//</span>
00041 
00042 <span class="preprocessor">#undef MODULE_POOL_TAG</span>
<a name="l00043"></a><a class="code" href="../../d5/d9/unc_8c.html#a0">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define MODULE_POOL_TAG                  ('nuSF')</span>
00044 <span class="preprocessor"></span>
00045 <span class="comment">//</span>
00046 <span class="comment">// Local prototypes</span>
00047 <span class="comment">//</span>
00048 
00049 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00050 <a class="code" href="../../d5/d9/unc_8c.html#a13">FsRtlpRegisterProviderWithMUP</a>
00051 (
00052     IN HANDLE mupHandle,
00053     IN PUNICODE_STRING <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>,
00054     IN BOOLEAN <a class="code" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a>
00055 );
00056 
00057 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00058 <a class="code" href="../../d5/d9/unc_8c.html#a14">FsRtlpOpenDev</a>(
00059     IN OUT PHANDLE Handle,
00060     IN LPWSTR DevNameStr
00061 );
00062 
00063 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00064 <a class="code" href="../../d5/d9/unc_8c.html#a15">FsRtlpSetSymbolicLink</a>(
00065     IN PUNICODE_STRING DevName OPTIONAL
00066 );
00067 
00068 BOOLEAN
00069 <a class="code" href="../../d5/d9/unc_8c.html#a16">FsRtlpIsDfsEnabled</a>();
00070 
00071 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlpRegisterProviderWithMUP)</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlpOpenDev)</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlpSetSymbolicLink)</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlDeregisterUncProvider)</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlRegisterUncProvider)</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00078 <span class="preprocessor"></span>
00079 <span class="comment">//</span>
00080 <span class="comment">// We defer calling the MUP with the registration data until</span>
00081 <span class="comment">//   the second redir loads and Dfs is disabled.  This structure holds the</span>
00082 <span class="comment">//   data necessary to make that call.</span>
00083 <span class="comment">//</span>
00084 <span class="keyword">struct </span>{
<a name="l00085"></a><a class="code" href="../../d5/d9/unc_8c.html#a6">00085</a>     HANDLE <a class="code" href="../../d5/d9/unc_8c.html#a6">MupHandle</a>;
<a name="l00086"></a><a class="code" href="../../d5/d9/unc_8c.html#a7">00086</a>     HANDLE <a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>;
<a name="l00087"></a><a class="code" href="../../d5/d9/unc_8c.html#a8">00087</a>     UNICODE_STRING <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>;
<a name="l00088"></a><a class="code" href="../../d5/d9/unc_8c.html#a9">00088</a>     BOOLEAN <a class="code" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a>;
00089 } <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a> = {0};
00090 
00091 <span class="comment">//</span>
00092 <span class="comment">// Resource protection</span>
00093 <span class="comment">//</span>
<a name="l00094"></a><a class="code" href="../../d5/d9/unc_8c.html#a11">00094</a> <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a> <a class="code" href="../../d5/d9/unc_8c.html#a11">FsRtlpUncSemaphore</a>;
00095 
00096 <span class="comment">//</span>
00097 <span class="comment">// Number of times we've loaded redirs.</span>
00098 <span class="comment">//</span>
<a name="l00099"></a><a class="code" href="../../d5/d9/unc_8c.html#a12">00099</a> ULONG <a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> = 0;
00100 
00101 
00102 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00103 <a class="code" href="../../d5/d9/unc_8c.html#a13">FsRtlpRegisterProviderWithMUP</a>
<a name="l00104"></a><a class="code" href="../../d5/d9/unc_8c.html#a13">00104</a> (
00105     IN HANDLE mupHandle,
00106     IN PUNICODE_STRING <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>,
00107     IN BOOLEAN <a class="code" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a>
00108 )
00109 <span class="comment">/*++</span>
00110 <span class="comment"></span>
00111 <span class="comment">Routine Description:</span>
00112 <span class="comment"></span>
00113 <span class="comment">    This private routine does the FSCTL to the MUP to tell it about</span>
00114 <span class="comment">        a new redir</span>
00115 <span class="comment"></span>
00116 <span class="comment">Arguments:</span>
00117 <span class="comment"></span>
00118 <span class="comment">    mupHandle - Handle to the MUP</span>
00119 <span class="comment"></span>
00120 <span class="comment">    RedirDevName - The device name of the redir.</span>
00121 <span class="comment"></span>
00122 <span class="comment">    MailslotsSupported - If TRUE, this redir supports mailslots.</span>
00123 <span class="comment"></span>
00124 <span class="comment">Return Value:</span>
00125 <span class="comment"></span>
00126 <span class="comment">    NTSTATUS - The status of the operation.</span>
00127 <span class="comment"></span>
00128 <span class="comment">--*/</span>
00129 {
00130     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00131     IO_STATUS_BLOCK ioStatusBlock;
00132     ULONG paramLength;
00133     PREDIRECTOR_REGISTRATION params;
00134 
00135     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00136 
00137     paramLength = <span class="keyword">sizeof</span>( REDIRECTOR_REGISTRATION ) +
00138                       <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;Length;
00139 
00140     params = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, paramLength, <a class="code" href="../../d1/d3/dbcsname_8c.html#a2">MODULE_POOL_TAG</a> );
00141     <span class="keywordflow">if</span>( params == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
00142         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00143 
00144     params-&gt;DeviceNameOffset = <span class="keyword">sizeof</span>( REDIRECTOR_REGISTRATION );
00145     params-&gt;DeviceNameLength = <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;Length;
00146     params-&gt;MailslotsSupported = <a class="code" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a>;
00147 
00148     RtlMoveMemory(
00149         (PCHAR)params + params-&gt;DeviceNameOffset,
00150         <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;Buffer,
00151         <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;Length
00152         );
00153 
00154     status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
00155                  mupHandle,
00156                  0,
00157                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00158                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00159                  &amp;ioStatusBlock,
00160                  FSCTL_MUP_REGISTER_UNC_PROVIDER,
00161                  params,
00162                  paramLength,
00163                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00164                  0
00165                  );
00166 
00167     <span class="keywordflow">if</span> ( status == STATUS_PENDING ) {
00168         status = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>( mupHandle, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00169     }
00170 
00171     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
00172         status = ioStatusBlock.Status;
00173     }
00174 
00175     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00176 
00177     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( params );
00178 
00179     <span class="keywordflow">return</span> status;
00180 }
00181 
00182 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00183"></a><a class="code" href="../../d5/d9/unc_8c.html#a14">00183</a> <a class="code" href="../../d5/d9/unc_8c.html#a14">FsRtlpOpenDev</a>(
00184     IN OUT PHANDLE Handle,
00185     IN LPWSTR DevNameStr
00186 )
00187 {
00188     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00189     UNICODE_STRING DevName;
00190     OBJECT_ATTRIBUTES objectAttributes;
00191     IO_STATUS_BLOCK ioStatusBlock;
00192 
00193     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00194 
00195     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;DevName, DevNameStr );
00196 
00197     InitializeObjectAttributes(
00198         &amp;objectAttributes,
00199         &amp;DevName,
00200         0,
00201         0,
00202         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00203         );
00204 
00205     status = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>(
00206                  <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00207                  GENERIC_WRITE,
00208                  &amp;objectAttributes,
00209                  &amp;ioStatusBlock,
00210                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00211                  FILE_ATTRIBUTE_NORMAL,
00212                  FILE_SHARE_READ | FILE_SHARE_WRITE,
00213                  FILE_OPEN,
00214                  0,
00215                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00216                  0
00217                  );
00218 
00219     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
00220         status = ioStatusBlock.Status;
00221     }
00222 
00223     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
00224         *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE)-1;
00225     }
00226 
00227     <span class="keywordflow">return</span> status;
00228 }
00229 
00230 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00231"></a><a class="code" href="../../d5/d9/unc_8c.html#a15">00231</a> <a class="code" href="../../d5/d9/unc_8c.html#a15">FsRtlpSetSymbolicLink</a>( IN PUNICODE_STRING DevName OPTIONAL )
00232 {
00233     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00234     UNICODE_STRING UncSymbolicName;
00235 
00236     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00237 
00238     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;UncSymbolicName, <a class="code" href="../../d5/d9/unc_8c.html#a3">UNCSymbolicLink</a> );
00239     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d4/d6/iosubs_8c.html#a57">IoDeleteSymbolicLink</a>( &amp;UncSymbolicName );
00240     <span class="keywordflow">if</span>( ARGUMENT_PRESENT( DevName ) ) {
00241         status = <a class="code" href="../../d4/d6/iosubs_8c.html#a50">IoCreateSymbolicLink</a>( &amp;UncSymbolicName, DevName );
00242         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00243     }
00244 }
00245 
00246 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00247"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a182">00247</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a182">FsRtlRegisterUncProvider</a>(
00248     IN OUT PHANDLE MupHandle,
00249     IN PUNICODE_STRING RedirDevName,
00250     IN BOOLEAN MailslotsSupported
00251     )
00252 <span class="comment">/*++</span>
00253 <span class="comment"></span>
00254 <span class="comment">Routine Description:</span>
00255 <span class="comment"></span>
00256 <span class="comment">    This routine registers a redir as a UNC provider.</span>
00257 <span class="comment"></span>
00258 <span class="comment">Arguments:</span>
00259 <span class="comment"></span>
00260 <span class="comment">    Handle - Pointer to a handle.  The handle is returned by the routine</span>
00261 <span class="comment">        to be used when calling FsRtlDeregisterUncProvider.</span>
00262 <span class="comment">        It is valid only if the routines returns STATUS_SUCCESS.</span>
00263 <span class="comment"></span>
00264 <span class="comment">    RedirDevName - The device name of the redir.</span>
00265 <span class="comment"></span>
00266 <span class="comment">    MailslotsSupported - If TRUE, this redir supports mailslots.</span>
00267 <span class="comment"></span>
00268 <span class="comment">Return Value:</span>
00269 <span class="comment"></span>
00270 <span class="comment">    NTSTATUS - The status of the operation.</span>
00271 <span class="comment"></span>
00272 <span class="comment">--*/</span>
00273 {
00274     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00275     HANDLE mupHandle = (HANDLE)-1;
00276     UNICODE_STRING mupDriverName;
00277     BOOLEAN dfsEnabled;
00278 
00279     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00280 
00281     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;<a class="code" href="../../d5/d9/unc_8c.html#a11">FsRtlpUncSemaphore</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00282 
00283     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> == 0) {
00284 
00285         dfsEnabled = <a class="code" href="../../d5/d9/unc_8c.html#a16">FsRtlpIsDfsEnabled</a>();
00286 
00287         <span class="keywordflow">if</span> (dfsEnabled) {
00288             <a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> = 1;
00289             RtlZeroMemory((PVOID) &amp;<a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>));
00290         }
00291 
00292     }
00293 
00294     <span class="keywordflow">switch</span>( <a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> ) {
00295     <span class="keywordflow">case</span> 0:
00296         <span class="comment">//</span>
00297         <span class="comment">// Ok, the MUP isn't there and we don't need to use the</span>
00298         <span class="comment">//   MUP for the first redir.</span>
00299         <span class="comment">//</span>
00300         <span class="comment">// We need to return a handle, but we're not really using the MUP yet.</span>
00301         <span class="comment">//   And we may never use it (if there's only 1 redir).  Return</span>
00302         <span class="comment">//   a handle to the NULL device object, since we're committed to returning</span>
00303         <span class="comment">//   a handle to our caller.  Our caller isn't supposed to do anything with</span>
00304         <span class="comment">//   the handle except to call FsRtlDeregisterUncProvider() with it.</span>
00305         <span class="comment">//</span>
00306         status = <a class="code" href="../../d5/d9/unc_8c.html#a14">FsRtlpOpenDev</a>( &amp;mupHandle, <a class="code" href="../../d5/d9/unc_8c.html#a4">DevNull</a> );
00307 
00308         <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) )
00309             <span class="keywordflow">break</span>;
00310 
00311         <span class="comment">//</span>
00312         <span class="comment">// Save up enough state to allow us to call the MUP later with</span>
00313         <span class="comment">// this registration info if necessary.</span>
00314         <span class="comment">//</span>
00315         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, 
00316                                                                <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;MaximumLength, 
00317                                                                <a class="code" href="../../d1/d3/dbcsname_8c.html#a2">MODULE_POOL_TAG</a> );
00318 
00319         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00320             status =  STATUS_INSUFFICIENT_RESOURCES;
00321             <span class="keywordflow">break</span>;
00322         }
00323 
00324         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Length = <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;Length;
00325         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.MaximumLength = <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;MaximumLength;
00326 
00327         RtlMoveMemory(
00328                 (PCHAR)<a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer,
00329                 <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;Buffer,
00330                 <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;MaximumLength
00331         );
00332 
00333         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MailslotsSupported = <a class="code" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a>;
00334         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.ReturnedHandle = mupHandle;
00335         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MupHandle = (HANDLE)-1;
00336 
00337         <span class="comment">//</span>
00338         <span class="comment">// Set the UNC symbolic link to point to the redir we just loaded</span>
00339         <span class="comment">//</span>
00340         <a class="code" href="../../d5/d9/unc_8c.html#a15">FsRtlpSetSymbolicLink</a>( <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a> );
00341 
00342         <span class="keywordflow">break</span>;
00343 
00344     <span class="keywordflow">default</span>:
00345         <span class="comment">//</span>
00346         <span class="comment">// This is the second or later redir load -- MUST use the MUP</span>
00347         <span class="comment">//</span>
00348         status = <a class="code" href="../../d5/d9/unc_8c.html#a14">FsRtlpOpenDev</a>( &amp;mupHandle, <a class="code" href="../../d5/d9/unc_8c.html#a5">DevMup</a> );
00349 
00350         <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
00351 
00352             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;mupDriverName, <a class="code" href="../../d5/d9/unc_8c.html#a2">MupRegKey</a> );
00353 
00354             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d7/d7/fs__rec_8h.html#a37">ZwLoadDriver</a>( &amp;mupDriverName );
00355 
00356             status = <a class="code" href="../../d5/d9/unc_8c.html#a14">FsRtlpOpenDev</a>( &amp;mupHandle, <a class="code" href="../../d5/d9/unc_8c.html#a5">DevMup</a> );
00357             <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) )
00358                 <span class="keywordflow">break</span>;
00359         }
00360 
00361         <span class="comment">//</span>
00362         <span class="comment">// See if we need to tell the MUP about the first redir that registered</span>
00363         <span class="comment">//</span>
00364         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer ) {
00365 
00366             status = <a class="code" href="../../d5/d9/unc_8c.html#a13">FsRtlpRegisterProviderWithMUP</a>( mupHandle,
00367                     &amp;<a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName,
00368                     <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MailslotsSupported );
00369 
00370             <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) )
00371                 <span class="keywordflow">break</span>;
00372 
00373             <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MupHandle = mupHandle;
00374 
00375             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer );
00376             <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00377 
00378             <span class="comment">//</span>
00379             <span class="comment">// Set the UNC symbolic link to point to the MUP</span>
00380             <span class="comment">//</span>
00381             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(  &amp;mupDriverName, <a class="code" href="../../d5/d9/unc_8c.html#a5">DevMup</a> );
00382             <a class="code" href="../../d5/d9/unc_8c.html#a15">FsRtlpSetSymbolicLink</a>( &amp;mupDriverName );
00383 
00384             status = <a class="code" href="../../d5/d9/unc_8c.html#a14">FsRtlpOpenDev</a>( &amp;mupHandle, <a class="code" href="../../d5/d9/unc_8c.html#a5">DevMup</a> );
00385 
00386             <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) )
00387                 <span class="keywordflow">break</span>;
00388         }
00389 
00390         <span class="comment">//</span>
00391         <span class="comment">//  Pass the request to the MUP for this redir</span>
00392         <span class="comment">//</span>
00393         status = <a class="code" href="../../d5/d9/unc_8c.html#a13">FsRtlpRegisterProviderWithMUP</a>( mupHandle,
00394                         <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>,
00395                         <a class="code" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a> );
00396         <span class="keywordflow">break</span>;
00397 
00398     }
00399 
00400     <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
00401         <a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a>++;
00402         *<a class="code" href="../../d5/d9/unc_8c.html#a6">MupHandle</a> = mupHandle;
00403 
00404     } <span class="keywordflow">else</span> {
00405         <span class="keywordflow">if</span>( mupHandle != (HANDLE)-1 &amp;&amp; mupHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00406             ZwClose( mupHandle );
00407         }
00408 
00409         *<a class="code" href="../../d5/d9/unc_8c.html#a6">MupHandle</a> = (HANDLE)-1;
00410     }
00411 
00412     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;<a class="code" href="../../d5/d9/unc_8c.html#a11">FsRtlpUncSemaphore</a>, 0, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00413     <span class="keywordflow">return</span> status;
00414 }
00415 
00416 
00417 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00418"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a183">00418</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a183">FsRtlDeregisterUncProvider</a>(
00419     IN HANDLE Handle
00420     )
00421 
00422 <span class="comment">/*++</span>
00423 <span class="comment"></span>
00424 <span class="comment">Routine Description:</span>
00425 <span class="comment"></span>
00426 <span class="comment">    This routine deregisters a redir as a UNC provider.</span>
00427 <span class="comment"></span>
00428 <span class="comment">Arguments:</span>
00429 <span class="comment"></span>
00430 <span class="comment">    Handle - A handle to the Multiple UNC router, returned by the</span>
00431 <span class="comment">        registration call.</span>
00432 <span class="comment"></span>
00433 <span class="comment">Return Value:</span>
00434 <span class="comment"></span>
00435 <span class="comment">    None.</span>
00436 <span class="comment"></span>
00437 <span class="comment">--*/</span>
00438 
00439 {
00440     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00441 
00442     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00443 
00444     <span class="keywordflow">if</span>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == (HANDLE)-1 || <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
00445         <span class="keywordflow">return</span>;
00446 
00447     status = ZwClose( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
00448 
00449     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
00450         <span class="keywordflow">return</span>;
00451     }
00452 
00453     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;<a class="code" href="../../d5/d9/unc_8c.html#a11">FsRtlpUncSemaphore</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00454 
00455     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> &gt; 0 );
00456 
00457     <span class="keywordflow">if</span>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.ReturnedHandle ) {
00458 
00459         <span class="comment">//</span>
00460         <span class="comment">// The first redir in the system is closing.  Release the state we saved</span>
00461         <span class="comment">//  for it, and pass the close on to the MUP if necessary</span>
00462         <span class="comment">//</span>
00463 
00464         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00465             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer );
00466             <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00467         }
00468 
00469         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MupHandle != (HANDLE)-1 ) {
00470             ZwClose( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MupHandle );
00471             <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MupHandle = (HANDLE)-1;
00472         }
00473 
00474         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.ReturnedHandle = (HANDLE)-1;
00475 
00476     }
00477 
00478     <span class="keywordflow">if</span>( --<a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> == 0 ) {
00479         <a class="code" href="../../d5/d9/unc_8c.html#a15">FsRtlpSetSymbolicLink</a>( (PUNICODE_STRING)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00480     }
00481 
00482     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;<a class="code" href="../../d5/d9/unc_8c.html#a11">FsRtlpUncSemaphore</a>, 0, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00483 }
00484 
00485 
00486 BOOLEAN
<a name="l00487"></a><a class="code" href="../../d5/d9/unc_8c.html#a16">00487</a> <a class="code" href="../../d5/d9/unc_8c.html#a16">FsRtlpIsDfsEnabled</a>()
00488 
00489 <span class="comment">/*++</span>
00490 <span class="comment"></span>
00491 <span class="comment">Routine Description:</span>
00492 <span class="comment"></span>
00493 <span class="comment">    This routine checks a registry key to see if the Dfs client is enabled.</span>
00494 <span class="comment">    The client is assumed to be enabled by default, and disabled only if there</span>
00495 <span class="comment">    is a registry value indicating that it should be disabled.</span>
00496 <span class="comment"></span>
00497 <span class="comment">Arguments:</span>
00498 <span class="comment"></span>
00499 <span class="comment">    None</span>
00500 <span class="comment"></span>
00501 <span class="comment">Return Value:</span>
00502 <span class="comment"></span>
00503 <span class="comment">    TRUE if Dfs client is enabled, FALSE otherwise.</span>
00504 <span class="comment"></span>
00505 <span class="comment">--*/</span>
00506 
00507 {
00508     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00509     HANDLE mupRegHandle;
00510     OBJECT_ATTRIBUTES objectAttributes;
00511     ULONG valueSize;
00512     BOOLEAN dfsEnabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00513 
00514     UNICODE_STRING mupRegKey = {
00515         <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/unc_8c.html#a2">MupRegKey</a>) - <span class="keyword">sizeof</span>(WCHAR),
00516         <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/unc_8c.html#a2">MupRegKey</a>),
00517         <a class="code" href="../../d5/d9/unc_8c.html#a2">MupRegKey</a>};
00518 
00519 <span class="preprocessor">#define DISABLE_DFS_VALUE_NAME  L"DisableDfs"</span>
00520 <span class="preprocessor"></span>
00521     UNICODE_STRING disableDfs = {
00522         <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/unc_8c.html#a1">DISABLE_DFS_VALUE_NAME</a>) - <span class="keyword">sizeof</span>(WCHAR),
00523         <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/unc_8c.html#a1">DISABLE_DFS_VALUE_NAME</a>),
00524         <a class="code" href="../../d5/d9/unc_8c.html#a1">DISABLE_DFS_VALUE_NAME</a>};
00525 
00526     <span class="keyword">struct </span>{
00527         KEY_VALUE_PARTIAL_INFORMATION Info;
00528         ULONG <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00529     } disableDfsValue;
00530 
00531 
00532     InitializeObjectAttributes(
00533         &amp;objectAttributes,
00534         &amp;mupRegKey,
00535         OBJ_CASE_INSENSITIVE,
00536         0,
00537         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00538         );
00539 
00540     status = ZwOpenKey(&amp;mupRegHandle, KEY_READ, &amp;objectAttributes);
00541 
00542     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00543 
00544         status = ZwQueryValueKey(
00545                     mupRegHandle,
00546                     &amp;disableDfs,
00547                     KeyValuePartialInformation,
00548                     (PVOID) &amp;disableDfsValue,
00549                     <span class="keyword">sizeof</span>(disableDfsValue),
00550                     &amp;valueSize);
00551 
00552         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; disableDfsValue.Info.Type == REG_DWORD) {
00553 
00554             <span class="keywordflow">if</span> ( (*((PULONG) disableDfsValue.Info.Data)) == 1 )
00555                 dfsEnabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00556 
00557         }
00558 
00559         ZwClose( mupRegHandle );
00560 
00561     }
00562 
00563     <span class="keywordflow">return</span>( dfsEnabled );
00564 
00565 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:11 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
