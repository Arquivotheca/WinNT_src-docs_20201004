<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: snapshot.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>snapshot.c</h1><a href="../../d5/d9/snapshot_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: snapshot.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Screen/Window SnapShotting Routines</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 26-Nov-1991 DavidPe   Ported from Win 3.1 sources</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <span class="comment">/***************************************************************************\</span>
00016 <span class="comment">* xxxSnapWindow</span>
00017 <span class="comment">*</span>
00018 <span class="comment">* Effects: Snaps either the desktop hwnd or the active front most window. If</span>
00019 <span class="comment">* any other window is specified, we will snap it but it will be clipped.</span>
00020 <span class="comment">*</span>
00021 <span class="comment">\***************************************************************************/</span>
00022 
<a name="l00023"></a><a class="code" href="../../d4/d1/userk_8h.html#a1528">00023</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1528">xxxSnapWindow</a>(
00024     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00025 {
00026     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>    ptiCurrent;
00027     RECT           rc;
00028     HDC            hdcScr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00029     HDC            hdcMem = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00030     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>           fRet;
00031     HBITMAP        hbmOld;
00032     HBITMAP        hbm;
00033     HANDLE         hPal;
00034     LPLOGPALETTE   lppal;
00035     <span class="keywordtype">int</span>            palsize;
00036     <span class="keywordtype">int</span>            iFixedPaletteEntries;
00037     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>           fSuccess;
00038     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>           pwndT;
00039     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>             tlpwndT;
00040     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
00041     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>             tlpwinsta;
00042 
00043     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00044     UserAssert(pwnd);
00045 
00046     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00047 
00048     <span class="comment">/*</span>
00049 <span class="comment">     * If this is a thread of winlogon, don't do the snapshot.</span>
00050 <span class="comment">     */</span>
00051     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a19">GetCurrentProcessId</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>)
00052         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00053 
00054     <span class="comment">/*</span>
00055 <span class="comment">     * Get the affected windowstation</span>
00056 <span class="comment">     */</span>
00057     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d8/winsta_8c.html#a13">ReferenceWindowStation</a>(
00058             <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
00059             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00060             WINSTA_READSCREEN,
00061             &amp;pwinsta,
00062             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) ||
00063             pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) {
00064         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00065     }
00066 
00067     <span class="comment">/*</span>
00068 <span class="comment">     * If the window is on another windowstation, do nothing</span>
00069 <span class="comment">     */</span>
00070     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;rpwinstaParent != pwinsta)
00071         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00072 
00073     <span class="comment">/*</span>
00074 <span class="comment">     * Get the parent of any child windows.</span>
00075 <span class="comment">     */</span>
00076     <span class="keywordflow">while</span> ((pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>)) {
00077         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
00078     }
00079 
00080     <span class="comment">/*</span>
00081 <span class="comment">     * Lock the windowstation before we leave the critical section</span>
00082 <span class="comment">     */</span>
00083     <a class="code" href="../../d4/d1/userk_8h.html#a131">ThreadLockWinSta</a>(ptiCurrent, pwinsta, &amp;tlpwinsta);
00084 
00085     <span class="comment">/*</span>
00086 <span class="comment">     * Open the clipboard and empty it.</span>
00087 <span class="comment">     *</span>
00088 <span class="comment">     * pwndDesktop is made the owner of the clipboard, instead of the</span>
00089 <span class="comment">     * currently active window; -- SANKAR -- 20th July, 1989 --</span>
00090 <span class="comment">     */</span>
00091     pwndT = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
00092     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndT, &amp;tlpwndT);
00093     fSuccess = <a class="code" href="../../d4/d1/userk_8h.html#a1735">xxxOpenClipboard</a>(pwndT, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00094     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00095 
00096     <span class="keywordflow">if</span> (!fSuccess) {
00097         <a class="code" href="../../d4/d1/userk_8h.html#a135">ThreadUnlockWinSta</a>(ptiCurrent, &amp;tlpwinsta);
00098         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00099     }
00100 
00101     <a class="code" href="../../d4/d1/userk_8h.html#a1738">xxxEmptyClipboard</a>(pwinsta);
00102 
00103     <span class="comment">/*</span>
00104 <span class="comment">     * Use the whole window.</span>
00105 <span class="comment">     */</span>
00106     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
00107 
00108     <span class="comment">/*</span>
00109 <span class="comment">     * Only snap what is on the screen.</span>
00110 <span class="comment">     */</span>
00111     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rc, &amp;rc, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>)) {
00112         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00113         <span class="keywordflow">goto</span> SnapExit;
00114     }
00115 
00116     rc.right -= rc.left;
00117     rc.bottom -= rc.top;
00118 
00119     <span class="comment">/*</span>
00120 <span class="comment">     * Figure out how far offset from window origin visible part is</span>
00121 <span class="comment">     */</span>
00122     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00123         rc.left -= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00124         rc.top -= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00125     }
00126 
00127     <span class="comment">/*</span>
00128 <span class="comment">     * Get the entire window's DC.</span>
00129 <span class="comment">     */</span>
00130     hdcScr = <a class="code" href="../../d4/d1/userk_8h.html#a1696">_GetWindowDC</a>(pwnd);
00131     <span class="keywordflow">if</span> (!hdcScr)
00132         <span class="keywordflow">goto</span> MemoryError;
00133 
00134     <span class="comment">/*</span>
00135 <span class="comment">     * Create the memory DC.</span>
00136 <span class="comment">     */</span>
00137     hdcMem = GreCreateCompatibleDC(hdcScr);
00138     <span class="keywordflow">if</span> (!hdcMem)
00139         <span class="keywordflow">goto</span> MemoryError;
00140 
00141     <span class="comment">/*</span>
00142 <span class="comment">     * Create the destination bitmap.  If it fails, then attempt</span>
00143 <span class="comment">     * to create a monochrome bitmap.</span>
00144 <span class="comment">     * Did we have enough memory?</span>
00145 <span class="comment">     */</span>
00146 
00147     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(SAMEDISPLAYFORMAT)) {
00148         hbm = GreCreateCompatibleBitmap(hdcScr, rc.right, rc.bottom);
00149     } <span class="keywordflow">else</span> {
00150         hbm = GreCreateBitmap(rc.right, rc.bottom, 1, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o17">BitCountMax</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00151     }
00152 
00153     <span class="keywordflow">if</span> (!hbm) {
00154         hbm = GreCreateBitmap(rc.right, rc.bottom, 1, 1, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00155         <span class="keywordflow">if</span> (!hbm)
00156             <span class="keywordflow">goto</span> MemoryError;
00157     }
00158 
00159     <span class="comment">/*</span>
00160 <span class="comment">     * Select the bitmap into the memory DC.</span>
00161 <span class="comment">     */</span>
00162     hbmOld = GreSelectBitmap(hdcMem, hbm);
00163 
00164     <span class="comment">/*</span>
00165 <span class="comment">     * Snap!!!</span>
00166 <span class="comment">     * Check the return value because the process taking the snapshot</span>
00167 <span class="comment">     * may not have access to read the screen.</span>
00168 <span class="comment">     */</span>
00169     fRet = GreBitBlt(hdcMem, 0, 0, rc.right, rc.bottom, hdcScr, rc.left, rc.top, SRCCOPY | CAPTUREBLT, 0);
00170 
00171     <span class="comment">/*</span>
00172 <span class="comment">     * Restore the old bitmap into the memory DC.</span>
00173 <span class="comment">     */</span>
00174     GreSelectBitmap(hdcMem, hbmOld);
00175 
00176     <span class="comment">/*</span>
00177 <span class="comment">     * If the blt failed, leave now.</span>
00178 <span class="comment">     */</span>
00179     <span class="keywordflow">if</span> (!fRet)
00180         <span class="keywordflow">goto</span> SnapExit;
00181 
00182     <a class="code" href="../../d4/d1/userk_8h.html#a1895">_SetClipboardData</a>(CF_BITMAP, hbm, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00183 
00184     <span class="comment">/*</span>
00185 <span class="comment">     * If this is a palette device, let's throw the current system palette</span>
00186 <span class="comment">     * into the clipboard also.  Useful if the user just snapped a window</span>
00187 <span class="comment">     * containing palette colors...</span>
00188 <span class="comment">     */</span>
00189     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a368">TEST_PUSIF</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a364">PUSIF_PALETTEDISPLAY</a>)) {
00190 
00191         <span class="keywordtype">int</span> i;
00192         <span class="keywordtype">int</span> iPalSize;
00193 
00194         palsize = GreGetDeviceCaps(hdcScr, SIZEPALETTE);
00195 
00196         <span class="comment">/*</span>
00197 <span class="comment">         * Determine the number of system colors.</span>
00198 <span class="comment">         */</span>
00199         <span class="keywordflow">if</span> (GreGetSystemPaletteUse(hdcScr) == SYSPAL_STATIC)
00200             iFixedPaletteEntries = GreGetDeviceCaps(hdcScr, NUMRESERVED);
00201         <span class="keywordflow">else</span>
00202             iFixedPaletteEntries = 2;
00203 
00204         lppal = (LPLOGPALETTE)UserAllocPoolWithQuota(
00205                 (LONG)(<span class="keyword">sizeof</span>(LOGPALETTE) + <span class="keyword">sizeof</span>(PALETTEENTRY) * palsize),
00206                 TAG_CLIPBOARD);
00207 
00208         <span class="keywordflow">if</span> (lppal != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00209             lppal-&gt;palVersion = 0x300;
00210             lppal-&gt;palNumEntries = (WORD)palsize;
00211 
00212             <span class="keywordflow">if</span> (GreGetSystemPaletteEntries(hdcScr,
00213                                            0,
00214                                            palsize,
00215                                            lppal-&gt;palPalEntry)) {
00216 
00217                 iPalSize = palsize - iFixedPaletteEntries / 2;
00218 
00219                 <span class="keywordflow">for</span> (i = iFixedPaletteEntries / 2; i &lt; iPalSize; i++) {
00220 
00221                     <span class="comment">/*</span>
00222 <span class="comment">                     * Any non system palette enteries need to have the NOCOLLAPSE</span>
00223 <span class="comment">                     * flag set otherwise bitmaps containing different palette</span>
00224 <span class="comment">                     * indices but same colors get messed up.</span>
00225 <span class="comment">                     */</span>
00226                     lppal-&gt;palPalEntry[i].peFlags = PC_NOCOLLAPSE;
00227                 }
00228 
00229                 <span class="keywordflow">if</span> (hPal = GreCreatePalette(lppal))
00230                     <a class="code" href="../../d4/d1/userk_8h.html#a1895">_SetClipboardData</a>(CF_PALETTE, hPal, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00231             }
00232 
00233             UserFreePool(lppal);
00234         }
00235     }
00236     <a class="code" href="../../d4/d1/userk_8h.html#a1731">PlayEventSound</a>(USER_SOUND_SNAPSHOT);
00237 
00238     fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00239 
00240 SnapExit:
00241 
00242     <span class="comment">/*</span>
00243 <span class="comment">     * Release the window/client DC.</span>
00244 <span class="comment">     */</span>
00245      <span class="keywordflow">if</span> (hdcScr) {
00246          <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdcScr);
00247      }
00248 
00249     <a class="code" href="../../d4/d1/userk_8h.html#a1736">xxxCloseClipboard</a>(pwinsta);
00250     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a>);
00251 
00252     <span class="comment">/*</span>
00253 <span class="comment">     * Delete the memory DC.</span>
00254 <span class="comment">     */</span>
00255     <span class="keywordflow">if</span> (hdcMem) {
00256         GreDeleteDC(hdcMem);
00257     }
00258 
00259     <a class="code" href="../../d4/d1/userk_8h.html#a135">ThreadUnlockWinSta</a>(ptiCurrent, &amp;tlpwinsta);
00260 
00261     <span class="keywordflow">return</span> fRet;
00262 
00263 MemoryError:
00264     <span class="comment">/*</span>
00265 <span class="comment">     * Display an error message box.</span>
00266 <span class="comment">     */</span>
00267     <a class="code" href="../../d4/d1/userk_8h.html#a1926">ClientNoMemoryPopup</a>();
00268     fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00269     <span class="keywordflow">goto</span> SnapExit;
00270 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:50 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
