<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: exatom.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>exatom.c File Reference</h1><code>#include "<a class="el" href="../../d5/d9/exp_8h-source.html">exp.h</a>"</code><br>

<p>
<a href="../../d7/d7/exatom_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d8/exatom_8c.html#a1">ExpGetGlobalAtomTable</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSYSAPI NTSTATUS NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d8/exatom_8c.html#a2">NtAddAtom</a> (IN PWSTR AtomName, IN ULONG Length, OUT PRTL_ATOM Atom OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSYSAPI NTSTATUS NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d8/exatom_8c.html#a3">NtFindAtom</a> (IN PWSTR AtomName, IN ULONG Length, OUT PRTL_ATOM Atom OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSYSAPI NTSTATUS NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d8/exatom_8c.html#a4">NtDeleteAtom</a> (IN RTL_ATOM Atom)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSYSAPI NTSTATUS NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d8/exatom_8c.html#a5">NtQueryInformationAtom</a> (IN RTL_ATOM Atom, IN ATOM_INFORMATION_CLASS AtomInformationClass, OUT PVOID AtomInformation, IN ULONG AtomInformationLength, OUT PULONG ReturnLength OPTIONAL)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d8/ex_8h.html#a170">PKWIN32_GLOBALATOMTABLE_CALLOUT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d8/exatom_8c.html#a0">ExGlobalAtomTableCallout</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="exatom.c::ExpGetGlobalAtomTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID ExpGetGlobalAtomTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d7/exatom_8c-source.html#l00442">442</a> of file <a class="el" href="../../d7/d7/exatom_8c-source.html">exatom.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d7/exatom_8c-source.html#l00439">ExGlobalAtomTableCallout</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/exatom_8c-source.html#l00045">NtAddAtom()</a>, <a class="el" href="../../d7/d7/exatom_8c-source.html#l00260">NtDeleteAtom()</a>, <a class="el" href="../../d7/d7/exatom_8c-source.html#l00152">NtFindAtom()</a>, and <a class="el" href="../../d7/d7/exatom_8c-source.html#l00294">NtQueryInformationAtom()</a>.
<p>
<pre class="fragment"><div>00447                    :
00448 
00449 Arguments:
00450 
00451 Return Value:
00452 
00453 --*/
00454 
00455 {
00456     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/exatom_8c.html#a0">ExGlobalAtomTableCallout</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00457 
00458         <span class="keywordflow">return</span> ((*ExGlobalAtomTableCallout)());
00459 
00460     } <span class="keywordflow">else</span> {
00461 
00462 <span class="preprocessor">#if DBG</span>
00463 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"EX: ExpGetGlobalAtomTable is about to return NULL!\n"</span> );
00464         DbgBreakPoint();
00465 <span class="preprocessor">#endif</span>
00466 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00467     }
00468 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="exatom.c::NtAddAtom" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSYSAPI NTSTATUS NTAPI NtAddAtom           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>AtomName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PRTL_ATOM Atom&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d7/exatom_8c-source.html#l00045">45</a> of file <a class="el" href="../../d7/d7/exatom_8c-source.html">exatom.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d7/exatom_8c-source.html#l00442">ExpGetGlobalAtomTable()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01547">ProbeForWriteUshort</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00516">RtlAddAtomToAtomTable()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00053                    :
00054 
00055 Arguments:
00056 
00057 Return Value:
00058 
00059 --*/
00060 
00061 {
00062     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00063     RTL_ATOM ReturnAtom;
00064     PVOID AtomTable = <a class="code" href="../../d6/d8/exatom_8c.html#a1">ExpGetGlobalAtomTable</a>();
00065     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00066     PWSTR CapturedAtomNameBuffer;
00067     ULONG AllocLength;
00068 
00069     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00070 
00071     <span class="keywordflow">if</span> (AtomTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00072 
00073         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00074     }
00075 
00076     <span class="keywordflow">if</span> (Length &gt; (RTL_ATOM_MAXIMUM_NAME_LENGTH * <span class="keyword">sizeof</span>(WCHAR))) {
00077 
00078         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00079     }
00080 
00081     PreviousMode = KeGetPreviousMode();
00082     CapturedAtomNameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00083 
00084     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00085 
00086     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00087 
00088         <span class="keywordflow">try</span> {
00089 
00090             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( AtomName )) {
00091 
00092                 AllocLength = (Length + <span class="keyword">sizeof</span>( UNICODE_NULL ))&amp;~(<span class="keyword">sizeof</span> (WCHAR)-1);
00093                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( AtomName, Length, <span class="keyword">sizeof</span>( WCHAR ) );
00094                 CapturedAtomNameBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, AllocLength, 'motA' );
00095 
00096                 <span class="keywordflow">if</span> (CapturedAtomNameBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00097 
00098                     <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00099                 }
00100 
00101                 RtlMoveMemory( CapturedAtomNameBuffer, AtomName, Length );
00102                 CapturedAtomNameBuffer[Length / <span class="keyword">sizeof</span> (WCHAR)] = <span class="charliteral">'\0'</span>;
00103             }
00104 
00105             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Atom )) {
00106 
00107                 <a class="code" href="../../d5/d8/ex_8h.html#a34">ProbeForWriteUshort</a>( Atom );
00108             }
00109 
00110         } except (EXCEPTION_EXECUTE_HANDLER) {
00111 
00112             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00113         }
00114 
00115     } <span class="keywordflow">else</span> {
00116 
00117         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( AtomName )) {
00118 
00119             CapturedAtomNameBuffer = AtomName;
00120         }
00121     }
00122 
00123     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00124 
00125         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a18">RtlAddAtomToAtomTable</a>( AtomTable, CapturedAtomNameBuffer, &amp;ReturnAtom );
00126 
00127         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) &amp;&amp; ARGUMENT_PRESENT( Atom )) {
00128 
00129             <span class="keywordflow">try</span> {
00130 
00131                 *Atom = ReturnAtom;
00132 
00133             } except (EXCEPTION_EXECUTE_HANDLER) {
00134 
00135                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00136             }
00137         }
00138     }
00139 
00140     <span class="keywordflow">if</span> ((CapturedAtomNameBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (CapturedAtomNameBuffer != AtomName)) {
00141 
00142         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedAtomNameBuffer );
00143     }
00144 
00145     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00146 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="exatom.c::NtDeleteAtom" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSYSAPI NTSTATUS NTAPI NtDeleteAtom           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN RTL_ATOM&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Atom</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d7/exatom_8c-source.html#l00260">260</a> of file <a class="el" href="../../d7/d7/exatom_8c-source.html">exatom.c</a>.
<p>
References <a class="el" href="../../d7/d7/exatom_8c-source.html#l00442">ExpGetGlobalAtomTable()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00672">RtlDeleteAtomFromAtomTable()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00266                    :
00267 
00268 Arguments:
00269 
00270 Return Value:
00271 
00272 --*/
00273 
00274 {
00275     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00276     PVOID AtomTable = <a class="code" href="../../d6/d8/exatom_8c.html#a1">ExpGetGlobalAtomTable</a>();
00277 
00278     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00279 
00280     <span class="keywordflow">if</span> (AtomTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00281 
00282         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00283     }
00284 
00285     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a20">RtlDeleteAtomFromAtomTable</a>( AtomTable, Atom );
00286 
00287     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00288 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="exatom.c::NtFindAtom" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSYSAPI NTSTATUS NTAPI NtFindAtom           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>AtomName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PRTL_ATOM Atom&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d7/exatom_8c-source.html#l00152">152</a> of file <a class="el" href="../../d7/d7/exatom_8c-source.html">exatom.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d7/exatom_8c-source.html#l00442">ExpGetGlobalAtomTable()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01547">ProbeForWriteUshort</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00611">RtlLookupAtomInAtomTable()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00160                    :
00161 
00162 Arguments:
00163 
00164 Return Value:
00165 
00166 --*/
00167 
00168 {
00169     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00170     RTL_ATOM ReturnAtom;
00171     PVOID AtomTable = <a class="code" href="../../d6/d8/exatom_8c.html#a1">ExpGetGlobalAtomTable</a>();
00172     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00173     PWSTR CapturedAtomNameBuffer;
00174     ULONG AllocLength;
00175 
00176     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00177 
00178     <span class="keywordflow">if</span> (AtomTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00179 
00180         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00181     }
00182 
00183     <span class="keywordflow">if</span> (Length &gt; (RTL_ATOM_MAXIMUM_NAME_LENGTH * <span class="keyword">sizeof</span>(WCHAR))) {
00184 
00185         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00186     }
00187 
00188     PreviousMode = KeGetPreviousMode();
00189     CapturedAtomNameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00190 
00191     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00192 
00193     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00194 
00195         <span class="keywordflow">try</span> {
00196 
00197             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( AtomName )) {
00198 
00199                 AllocLength = (Length + <span class="keyword">sizeof</span>( UNICODE_NULL ))&amp;~(<span class="keyword">sizeof</span> (WCHAR)-1);
00200                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( AtomName, Length, <span class="keyword">sizeof</span>( WCHAR ) );
00201                 CapturedAtomNameBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, AllocLength, 'motA' );
00202 
00203                 <span class="keywordflow">if</span> (CapturedAtomNameBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00204 
00205                     <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00206                 }
00207 
00208                 RtlMoveMemory( CapturedAtomNameBuffer, AtomName, Length );
00209                 CapturedAtomNameBuffer[Length / <span class="keyword">sizeof</span> (WCHAR)] = <span class="charliteral">'\0'</span>;
00210 
00211             }
00212 
00213             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Atom )) {
00214 
00215                 <a class="code" href="../../d5/d8/ex_8h.html#a34">ProbeForWriteUshort</a>( Atom );
00216             }
00217 
00218         } except (EXCEPTION_EXECUTE_HANDLER) {
00219 
00220             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00221         }
00222 
00223     } <span class="keywordflow">else</span> {
00224 
00225         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( AtomName )) {
00226 
00227             CapturedAtomNameBuffer = AtomName;
00228         }
00229     }
00230 
00231     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00232 
00233         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a19">RtlLookupAtomInAtomTable</a>( AtomTable, CapturedAtomNameBuffer, &amp;ReturnAtom );
00234 
00235         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) &amp;&amp; ARGUMENT_PRESENT( Atom )) {
00236 
00237             <span class="keywordflow">try</span> {
00238 
00239                 *Atom = ReturnAtom;
00240 
00241             } except (EXCEPTION_EXECUTE_HANDLER) {
00242 
00243                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00244             }
00245         }
00246     }
00247 
00248     <span class="keywordflow">if</span> (CapturedAtomNameBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; CapturedAtomNameBuffer != AtomName) {
00249 
00250         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedAtomNameBuffer );
00251     }
00252 
00253     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00254 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="exatom.c::NtQueryInformationAtom" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSYSAPI NTSTATUS NTAPI NtQueryInformationAtom           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN RTL_ATOM&nbsp;</td>
          <td class="mdname" nowrap> <em>Atom</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ATOM_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>AtomInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>AtomInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AtomInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ReturnLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d7/exatom_8c-source.html#l00294">294</a> of file <a class="el" href="../../d7/d7/exatom_8c-source.html">exatom.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d7/exatom_8c-source.html#l00442">ExpGetGlobalAtomTable()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00760">RtlQueryAtomInAtomTable()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00874">RtlQueryAtomsInAtomTable()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00304                    :
00305 
00306 Arguments:
00307 
00308 Return Value:
00309 
00310 --*/
00311 
00312 {
00313     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00314     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00315     ULONG RequiredLength;
00316     ULONG UsageCount;
00317     ULONG NameLength;
00318     ULONG AtomFlags;
00319     PATOM_BASIC_INFORMATION BasicInfo;
00320     PATOM_TABLE_INFORMATION TableInfo;
00321     PVOID AtomTable = <a class="code" href="../../d6/d8/exatom_8c.html#a1">ExpGetGlobalAtomTable</a>();
00322 
00323     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00324 
00325     <span class="keywordflow">if</span> (AtomTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00326 
00327         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00328     }
00329 
00330     <span class="comment">//</span>
00331     <span class="comment">//  Assume successful completion.</span>
00332     <span class="comment">//</span>
00333 
00334     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00335 
00336     <span class="keywordflow">try</span> {
00337 
00338         <span class="comment">//</span>
00339         <span class="comment">//  Get previous processor mode and probe output argument if necessary.</span>
00340         <span class="comment">//</span>
00341 
00342         PreviousMode = KeGetPreviousMode();
00343 
00344         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00345 
00346             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( AtomInformation,
00347                            AtomInformationLength,
00348                            <span class="keyword">sizeof</span>( ULONG ));
00349 
00350             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
00351 
00352                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>( ReturnLength );
00353             }
00354         }
00355 
00356         RequiredLength = 0;
00357 
00358         <span class="keywordflow">switch</span> (AtomInformationClass) {
00359 
00360         <span class="keywordflow">case</span> AtomBasicInformation:
00361 
00362             RequiredLength = FIELD_OFFSET( ATOM_BASIC_INFORMATION, Name );
00363 
00364             <span class="keywordflow">if</span> (AtomInformationLength &lt; RequiredLength) {
00365 
00366                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00367             }
00368 
00369             BasicInfo = (PATOM_BASIC_INFORMATION)AtomInformation;
00370             UsageCount = 0;
00371             NameLength = AtomInformationLength - RequiredLength;
00372             BasicInfo-&gt;Name[ 0 ] = UNICODE_NULL;
00373 
00374             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a22">RtlQueryAtomInAtomTable</a>( AtomTable,
00375                                               Atom,
00376                                               &amp;UsageCount,
00377                                               &amp;AtomFlags,
00378                                               &amp;BasicInfo-&gt;Name[0],
00379                                               &amp;NameLength );
00380 
00381             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00382 
00383                 BasicInfo-&gt;UsageCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)UsageCount;
00384                 BasicInfo-&gt;Flags = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)AtomFlags;
00385                 BasicInfo-&gt;NameLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NameLength;
00386                 RequiredLength += NameLength + <span class="keyword">sizeof</span>( UNICODE_NULL );
00387             }
00388 
00389             <span class="keywordflow">break</span>;
00390 
00391         <span class="keywordflow">case</span> AtomTableInformation:
00392 
00393             RequiredLength = FIELD_OFFSET( ATOM_TABLE_INFORMATION, Atoms );
00394 
00395             <span class="keywordflow">if</span> (AtomInformationLength &lt; RequiredLength) {
00396 
00397                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00398             }
00399 
00400             TableInfo = (PATOM_TABLE_INFORMATION)AtomInformation;
00401 
00402             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a23">RtlQueryAtomsInAtomTable</a>( AtomTable,
00403                                                (AtomInformationLength - RequiredLength) / <span class="keyword">sizeof</span>( RTL_ATOM ),
00404                                                &amp;TableInfo-&gt;NumberOfAtoms,
00405                                                &amp;TableInfo-&gt;Atoms[0] );
00406 
00407             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00408 
00409                 RequiredLength += TableInfo-&gt;NumberOfAtoms * <span class="keyword">sizeof</span>( RTL_ATOM );
00410             }
00411 
00412             <span class="keywordflow">break</span>;
00413 
00414         <span class="keywordflow">default</span>:
00415 
00416             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_INFO_CLASS;
00417 
00418             <span class="keywordflow">break</span>;
00419         }
00420 
00421         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
00422 
00423             *ReturnLength = RequiredLength;
00424         }
00425 
00426     } except (EXCEPTION_EXECUTE_HANDLER) {
00427 
00428         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00429     }
00430 
00431     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00432 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="exatom.c::ExGlobalAtomTableCallout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d8/ex_8h.html#a170">PKWIN32_GLOBALATOMTABLE_CALLOUT</a> <a class="el" href="../../d5/d8/ex_8h.html#a171">ExGlobalAtomTableCallout</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d7/exatom_8c-source.html#l00439">439</a> of file <a class="el" href="../../d7/d7/exatom_8c-source.html">exatom.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/exatom_8c-source.html#l00442">ExpGetGlobalAtomTable()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l03855">PsEstablishWin32Callouts()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
