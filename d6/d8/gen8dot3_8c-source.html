<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: gen8dot3.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>gen8dot3.c</h1><a href="../../d5/d9/gen8dot3_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Gen8dot3.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements a routine to generate 8.3 names from long names.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Gary Kimura     [GaryKi]    26-Mar-1992</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Pure Utility Routines</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include "<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>"</span>
00026 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00027 
<a name="l00028"></a><a class="code" href="../../d5/d9/gen8dot3_8c.html#a1">00028</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>  <a class="code" href="../../d5/d9/gen8dot3_8c.html#a1">NlsUnicodeToMbOemData</a>;
<a name="l00029"></a><a class="code" href="../../d5/d9/gen8dot3_8c.html#a2">00029</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>  <a class="code" href="../../d5/d9/gen8dot3_8c.html#a2">NlsOemToUnicodeData</a>;
<a name="l00030"></a><a class="code" href="../../d5/d9/gen8dot3_8c.html#a3">00030</a> <span class="keyword">extern</span> PCH      <a class="code" href="../../d5/d9/gen8dot3_8c.html#a3">NlsUnicodeToOemData</a>;
<a name="l00031"></a><a class="code" href="../../d5/d9/gen8dot3_8c.html#a4">00031</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>  <a class="code" href="../../d5/d9/gen8dot3_8c.html#a4">NlsMbOemCodePageTables</a>;
<a name="l00032"></a><a class="code" href="../../d5/d9/gen8dot3_8c.html#a5">00032</a> <span class="keyword">extern</span> BOOLEAN  <a class="code" href="../../d5/d9/gen8dot3_8c.html#a5">NlsMbOemCodePageTag</a>;
<a name="l00033"></a><a class="code" href="../../d5/d9/gen8dot3_8c.html#a6">00033</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>  <a class="code" href="../../d5/d9/gen8dot3_8c.html#a6">NlsOemLeadByteInfo</a>;
<a name="l00034"></a><a class="code" href="../../d5/d9/gen8dot3_8c.html#a7">00034</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>   <a class="code" href="../../d5/d9/gen8dot3_8c.html#a7">OemDefaultChar</a>;
00035 
00036 <span class="comment">//</span>
00037 <span class="comment">//  A condensed table of legal fat character values</span>
00038 <span class="comment">//</span>
00039 
00040 <span class="keyword">const</span>
<a name="l00041"></a><a class="code" href="../../d5/d9/gen8dot3_8c.html#a8">00041</a> ULONG <a class="code" href="../../d5/d9/gen8dot3_8c.html#a8">RtlFatIllegalTable</a>[] = { 0xffffffff,
00042                                0xfc009c04,
00043                                0x38000000,
00044                                0x10000000 };
00045 
00046 WCHAR
00047 <a class="code" href="../../d5/d9/gen8dot3_8c.html#a9">GetNextWchar</a> (
00048     IN PUNICODE_STRING Name,
00049     IN PULONG CurrentIndex,
00050     IN BOOLEAN SkipDots,
00051     IN BOOLEAN AllowExtendedCharacters
00052     );
00053 
00054 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
00055 <a class="code" href="../../d5/d9/gen8dot3_8c.html#a10">RtlComputeLfnChecksum</a> (
00056     PUNICODE_STRING Name
00057     );
00058 
00059 <span class="comment">//</span>
00060 <span class="comment">//  BOOLEAN</span>
00061 <span class="comment">//  IsDbcsCharacter (</span>
00062 <span class="comment">//      IN WCHAR Wc</span>
00063 <span class="comment">//  );</span>
00064 <span class="comment">//</span>
00065 
<a name="l00066"></a><a class="code" href="../../d5/d9/gen8dot3_8c.html#a0">00066</a> <span class="preprocessor">#define IsDbcsCharacter(WC) (             \</span>
00067 <span class="preprocessor">    ((WC) &gt; 127) &amp;&amp;                       \</span>
00068 <span class="preprocessor">    (HIBYTE(NlsUnicodeToMbOemData[(WC)])) \</span>
00069 <span class="preprocessor">)</span>
00070 <span class="preprocessor"></span>
00071 <span class="preprocessor">#if defined(ALLOC_PRAGMA) &amp;&amp; defined(NTOS_KERNEL_RUNTIME)</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlGenerate8dot3Name)</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,GetNextWchar)</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlComputeLfnChecksum)</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlIsNameLegalDOS8Dot3)</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlIsValidOemCharacter)</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00078 <span class="preprocessor"></span>
00079 
00080 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00081"></a><a class="code" href="../../d5/d9/gen8dot3_8c.html#a11">00081</a> <a class="code" href="../../d5/d9/gen8dot3_8c.html#a11">RtlGenerate8dot3Name</a> (
00082     IN PUNICODE_STRING Name,
00083     IN BOOLEAN AllowExtendedCharacters,
00084     IN OUT PGENERATE_NAME_CONTEXT Context,
00085     OUT PUNICODE_STRING Name8dot3
00086     )
00087 
00088 <span class="comment">/*++</span>
00089 <span class="comment"></span>
00090 <span class="comment">Routine Description:</span>
00091 <span class="comment"></span>
00092 <span class="comment">    This routine is used to generate an 8.3 name from a long name.  It can</span>
00093 <span class="comment">    be called repeatedly to generate different 8.3 name variations for the</span>
00094 <span class="comment">    same long name.  This is necessary if the gernerated 8.3 name conflicts</span>
00095 <span class="comment">    with an existing 8.3 name.</span>
00096 <span class="comment"></span>
00097 <span class="comment">Arguments:</span>
00098 <span class="comment"></span>
00099 <span class="comment">    Name - Supplies the original long name that is being translated from.</span>
00100 <span class="comment"></span>
00101 <span class="comment">    AllowExtendedCharacters - If TRUE, then extended characters, including</span>
00102 <span class="comment">        DBCS characters, are allowed in the basis of the short name if they</span>
00103 <span class="comment">        map to an upcased Oem character.</span>
00104 <span class="comment"></span>
00105 <span class="comment">    Context - Supplies a context for the translation.  This is a private structure</span>
00106 <span class="comment">        needed by this routine to help enumerate the different long name</span>
00107 <span class="comment">        possibilities.  The caller is responsible with providing a "zeroed out"</span>
00108 <span class="comment">        context structure on the first call for each given input name.</span>
00109 <span class="comment"></span>
00110 <span class="comment">    Name8dot3 - Receives the new 8.3 name.  Pool for the buffer must be allocated</span>
00111 <span class="comment">        by the caller and should be 12 characters wide (i.e., 24 bytes).</span>
00112 <span class="comment"></span>
00113 <span class="comment">Return Value:</span>
00114 <span class="comment"></span>
00115 <span class="comment">    None.</span>
00116 <span class="comment"></span>
00117 <span class="comment">--*/</span>
00118 
00119 {
00120     BOOLEAN DbcsAware;
00121     BOOLEAN IndexAll9s = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00122     ULONG OemLength;
00123     ULONG IndexLength;
00124     WCHAR IndexBuffer[8];
00125     ULONG i;
00126 
00127 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
00128 <span class="preprocessor"></span>    <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d4/d8/fsrtlpc_8c.html#a11">FsRtlSafeExtensions</a>;
00129 <span class="preprocessor">#else</span>
00130 <span class="preprocessor"></span>    BOOLEAN <a class="code" href="../../d4/d8/fsrtlpc_8c.html#a11">FsRtlSafeExtensions</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00131 <span class="preprocessor">#endif</span>
00132 <span class="preprocessor"></span>
00133     DbcsAware = AllowExtendedCharacters &amp;&amp; <a class="code" href="../../d5/d9/gen8dot3_8c.html#a5">NlsMbOemCodePageTag</a>;
00134 
00135     <span class="comment">//</span>
00136     <span class="comment">//  Check if this is the first time we are being called, and if so then</span>
00137     <span class="comment">//  initialize the context fields.</span>
00138     <span class="comment">//</span>
00139 
00140     <span class="keywordflow">if</span> (Context-&gt;NameLength == 0) {
00141 
00142         ULONG LastDotIndex;
00143 
00144         ULONG CurrentIndex;
00145         BOOLEAN SkipDots;
00146         WCHAR wc;
00147 
00148         <span class="comment">//</span>
00149         <span class="comment">//  Skip down the name remembering the index of the last dot we</span>
00150         <span class="comment">//  will skip over the first dot provided the name starts with</span>
00151         <span class="comment">//  a dot.</span>
00152         <span class="comment">//</span>
00153 
00154         LastDotIndex = MAXULONG;
00155 
00156         CurrentIndex = 0;
00157         SkipDots = ((<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length &gt; 0) &amp;&amp; (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span>));
00158 
00159         <span class="keywordflow">while</span> ((wc = <a class="code" href="../../d5/d9/gen8dot3_8c.html#a9">GetNextWchar</a>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,
00160                                    &amp;CurrentIndex,
00161                                    SkipDots,
00162                                    AllowExtendedCharacters )) != 0) {
00163 
00164             SkipDots = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00165             <span class="keywordflow">if</span> (wc == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span>) { LastDotIndex = CurrentIndex; }
00166         }
00167 
00168         <span class="comment">//</span>
00169         <span class="comment">//  If the LastDotIndex is the last character in the name,</span>
00170         <span class="comment">//  then there really isn't an extension, so reset LastDotIndex.</span>
00171         <span class="comment">//</span>
00172 
00173         <span class="keywordflow">if</span> (LastDotIndex == <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length/<span class="keyword">sizeof</span>(WCHAR)) {
00174 
00175             LastDotIndex = MAXULONG;
00176         }
00177 
00178         <span class="comment">//</span>
00179         <span class="comment">//  Build up the name part. This can be at most 6 characters</span>
00180         <span class="comment">//  (because of the ~# appeneded on the end) and we skip over</span>
00181         <span class="comment">//  dots, except the last dot, which terminates the loop.</span>
00182         <span class="comment">//</span>
00183         <span class="comment">//  We exit the loop if:</span>
00184         <span class="comment">//</span>
00185         <span class="comment">//  - The input Name has been exhausted</span>
00186         <span class="comment">//  - We have consumed the input name up to the last dot</span>
00187         <span class="comment">//  - We have filled 6 characters of short name basis</span>
00188         <span class="comment">//</span>
00189 
00190         CurrentIndex = 0;
00191         OemLength = 0;
00192         Context-&gt;NameLength = 0;
00193 
00194         <span class="keywordflow">while</span> ((wc = <a class="code" href="../../d5/d9/gen8dot3_8c.html#a9">GetNextWchar</a>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, &amp;CurrentIndex, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, AllowExtendedCharacters)) &amp;&amp;
00195                (CurrentIndex &lt; LastDotIndex) &amp;&amp;
00196                (Context-&gt;NameLength &lt; 6)) {
00197 
00198             <span class="comment">//</span>
00199             <span class="comment">//  If we are on a multi-byte code page we have to be careful</span>
00200             <span class="comment">//  here because the short name (when converted to Oem) must</span>
00201             <span class="comment">//  be 8.3 compliant.  Note that if AllowExtendedCharacters</span>
00202             <span class="comment">//  is FALSE, then GetNextWchar will never return a DBCS</span>
00203             <span class="comment">//  character, so we don't care what kind of code page we</span>
00204             <span class="comment">//  are on.</span>
00205             <span class="comment">//</span>
00206 
00207             <span class="keywordflow">if</span> (DbcsAware) {
00208 
00209                 OemLength += <a class="code" href="../../d5/d9/gen8dot3_8c.html#a0">IsDbcsCharacter</a>(wc) ? 2 : 1;
00210 
00211                 <span class="keywordflow">if</span> (OemLength &gt; 6) { <span class="keywordflow">break</span>; }
00212             }
00213 
00214             <span class="comment">//</span>
00215             <span class="comment">//  Copy the UNICODE character into the name buffer</span>
00216             <span class="comment">//</span>
00217 
00218             Context-&gt;NameBuffer[Context-&gt;NameLength++] = wc;
00219         }
00220 
00221         <span class="comment">//</span>
00222         <span class="comment">//  Now if the name part of the basis is 2 or less bytes (when</span>
00223         <span class="comment">//  represented in Oem) then append a four character checksum</span>
00224         <span class="comment">//  to make the short name space less sparse.</span>
00225         <span class="comment">//</span>
00226 
00227         <span class="keywordflow">if</span> ((DbcsAware ? OemLength : Context-&gt;NameLength) &lt;= 2) {
00228 
00229             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Checksum;
00230             WCHAR Nibble;
00231 
00232             Checksum =
00233             Context-&gt;Checksum = <a class="code" href="../../d5/d9/gen8dot3_8c.html#a10">RtlComputeLfnChecksum</a>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> );
00234 
00235             <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++, Checksum &gt;&gt;= 4) {
00236 
00237                 Nibble = Checksum &amp; 0xf;
00238                 Nibble += Nibble &lt;= 9 ? <span class="charliteral">'0'</span> : <span class="charliteral">'A'</span> - 10;
00239 
00240                 Context-&gt;NameBuffer[ Context-&gt;NameLength + i ] = Nibble;
00241             }
00242 
00243             Context-&gt;NameLength += 4;
00244             Context-&gt;ChecksumInserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00245         }
00246 
00247         <span class="comment">//</span>
00248         <span class="comment">//  Now process the last extension (if there is one).</span>
00249         <span class="comment">//  If the last dot index is not MAXULONG then we</span>
00250         <span class="comment">//  have located the last dot in the name</span>
00251         <span class="comment">//</span>
00252 
00253         <span class="keywordflow">if</span> (LastDotIndex != MAXULONG) {
00254 
00255             <span class="comment">//</span>
00256             <span class="comment">//  Put in the "."</span>
00257             <span class="comment">//</span>
00258 
00259             Context-&gt;ExtensionBuffer[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span>;
00260 
00261             <span class="comment">//</span>
00262             <span class="comment">//  Process the extension similar to how we processed the name</span>
00263             <span class="comment">//</span>
00264             <span class="comment">//  We exit the loop if:</span>
00265             <span class="comment">//</span>
00266             <span class="comment">//  - The input Name has been exhausted</span>
00267             <span class="comment">//  - We have filled . + 3 characters of extension</span>
00268             <span class="comment">//</span>
00269 
00270             OemLength = 1;
00271             Context-&gt;ExtensionLength = 1;
00272 
00273             <span class="keywordflow">while</span> ((wc = <a class="code" href="../../d5/d9/gen8dot3_8c.html#a9">GetNextWchar</a>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, &amp;LastDotIndex, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, AllowExtendedCharacters)) &amp;&amp;
00274                    (Context-&gt;ExtensionLength &lt; 4)) {
00275 
00276                 <span class="keywordflow">if</span> (DbcsAware) {
00277 
00278                     OemLength += <a class="code" href="../../d5/d9/gen8dot3_8c.html#a0">IsDbcsCharacter</a>(wc) ? 2 : 1;
00279 
00280                     <span class="keywordflow">if</span> (OemLength &gt; 4) { <span class="keywordflow">break</span>; }
00281                 }
00282 
00283                 Context-&gt;ExtensionBuffer[Context-&gt;ExtensionLength++] = wc;
00284             }
00285 
00286             <span class="comment">//</span>
00287             <span class="comment">//  If we had to truncate the extension (i.e. input name was not</span>
00288             <span class="comment">//  exhausted), change the last char of the truncated extension</span>
00289             <span class="comment">//  to a ~ is user has selected safe extensions.</span>
00290             <span class="comment">//</span>
00291 
00292             <span class="keywordflow">if</span> (wc &amp;&amp; <a class="code" href="../../d4/d8/fsrtlpc_8c.html#a11">FsRtlSafeExtensions</a>) {
00293 
00294                 Context-&gt;ExtensionBuffer[Context-&gt;ExtensionLength - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'~'</span>;
00295             }
00296 
00297         } <span class="keywordflow">else</span> {
00298 
00299             Context-&gt;ExtensionLength = 0;
00300         }
00301     }
00302 
00303     <span class="comment">//</span>
00304     <span class="comment">//  In all cases we add one to the index value and this is the value</span>
00305     <span class="comment">//  of the index we are going to generate this time around</span>
00306     <span class="comment">//</span>
00307 
00308     Context-&gt;LastIndexValue += 1;
00309 
00310     <span class="comment">//</span>
00311     <span class="comment">//  Now if the new index value is greater than 4 then we've had too</span>
00312     <span class="comment">//  many collisions and we should alter our basis if possible</span>
00313     <span class="comment">//</span>
00314 
00315     <span class="keywordflow">if</span> ((Context-&gt;LastIndexValue &gt; 4) &amp;&amp; !Context-&gt;ChecksumInserted) {
00316 
00317         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Checksum;
00318         WCHAR Nibble;
00319 
00320         <span class="comment">//</span>
00321         <span class="comment">// 'XX' is represented A DBCS character.</span>
00322         <span class="comment">//</span>
00323         <span class="comment">// LongName       -&gt; ShortName  | DbcsBias  Oem  Unicode</span>
00324         <span class="comment">// -----------------------------+------------------------</span>
00325         <span class="comment">// XXXXThisisapen -&gt; XX1234     |    1       6      5</span>
00326         <span class="comment">// XXThisisapen   -&gt; XX1234     |    1       6      5</span>
00327         <span class="comment">// aXXThisisapen  -&gt; a1234      |    1       5      5</span>
00328         <span class="comment">// aaThisisapen   -&gt; aa1234     |    0       6      6</span>
00329         <span class="comment">//</span>
00330 
00331         ULONG DbcsBias;
00332 
00333         <span class="keywordflow">if</span> (DbcsAware) {
00334 
00335               DbcsBias = ((<a class="code" href="../../d5/d9/gen8dot3_8c.html#a0">IsDbcsCharacter</a>(Context-&gt;NameBuffer[0]) ? 1 : 0) |
00336                           (<a class="code" href="../../d5/d9/gen8dot3_8c.html#a0">IsDbcsCharacter</a>(Context-&gt;NameBuffer[1]) ? 1 : 0));
00337 
00338         } <span class="keywordflow">else</span> {
00339 
00340               DbcsBias = 0;
00341         }
00342 
00343         Checksum =
00344         Context-&gt;Checksum = <a class="code" href="../../d5/d9/gen8dot3_8c.html#a10">RtlComputeLfnChecksum</a>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> );
00345 
00346         <span class="keywordflow">for</span> (i = (2-DbcsBias); i &lt; (6-DbcsBias); i++, Checksum &gt;&gt;= 4) {
00347 
00348             Nibble = Checksum &amp; 0xf;
00349             Nibble += Nibble &lt;= 9 ? <span class="charliteral">'0'</span> : <span class="charliteral">'A'</span> - 10;
00350 
00351             Context-&gt;NameBuffer[ i ] = Nibble;
00352         }
00353 
00354         Context-&gt;NameLength = (UCHAR)(6-DbcsBias);
00355         Context-&gt;LastIndexValue = 1;
00356         Context-&gt;ChecksumInserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00357     }
00358 
00359     <span class="comment">//</span>
00360     <span class="comment">//  Now build the index buffer from high index to low index because we</span>
00361     <span class="comment">//  use a mod &amp; div operation to build the string from the index value.</span>
00362     <span class="comment">//</span>
00363     <span class="comment">//  We also want to remember is we are about to rollover in base 10.</span>
00364     <span class="comment">//</span>
00365 
00366     <span class="keywordflow">for</span> (IndexLength = 1, i = Context-&gt;LastIndexValue;
00367          (IndexLength &lt;= 7) &amp;&amp; (i &gt; 0);
00368          IndexLength += 1, i /= 10) {
00369 
00370         <span class="keywordflow">if</span> ((IndexBuffer[ 8 - IndexLength] = (WCHAR)(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span> + (i % 10))) != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'9'</span>) {
00371 
00372             IndexAll9s = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00373         }
00374     }
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">//  And tack on the preceding dash</span>
00378     <span class="comment">//</span>
00379 
00380     IndexBuffer[ 8 - IndexLength ] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'~'</span>;
00381 
00382     <span class="comment">//</span>
00383     <span class="comment">//  At this point everything is set up to copy to the output buffer.  First</span>
00384     <span class="comment">//  copy over the name and then only copy the index and extension if they exist</span>
00385     <span class="comment">//</span>
00386 
00387     <span class="keywordflow">if</span> (Context-&gt;NameLength != 0) {
00388 
00389         RtlCopyMemory( &amp;Name8dot3-&gt;Buffer[0],
00390                        &amp;Context-&gt;NameBuffer[0],
00391                        Context-&gt;NameLength * 2 );
00392 
00393         Name8dot3-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Context-&gt;NameLength * 2);
00394 
00395     } <span class="keywordflow">else</span> {
00396 
00397         Name8dot3-&gt;Length = 0;
00398     }
00399 
00400     <span class="comment">//</span>
00401     <span class="comment">//  Now do the index.</span>
00402     <span class="comment">//</span>
00403 
00404     RtlCopyMemory( &amp;Name8dot3-&gt;Buffer[ Name8dot3-&gt;Length/2 ],
00405                    &amp;IndexBuffer[ 8 - IndexLength ],
00406                    IndexLength * 2 );
00407 
00408     Name8dot3-&gt;Length += (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (IndexLength * 2);
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">//  Now conditionally do the extension</span>
00412     <span class="comment">//</span>
00413 
00414     <span class="keywordflow">if</span> (Context-&gt;ExtensionLength != 0) {
00415 
00416         RtlCopyMemory( &amp;Name8dot3-&gt;Buffer[ Name8dot3-&gt;Length/2 ],
00417                        &amp;Context-&gt;ExtensionBuffer[0],
00418                        Context-&gt;ExtensionLength * 2 );
00419 
00420         Name8dot3-&gt;Length += (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (Context-&gt;ExtensionLength * 2);
00421     }
00422 
00423     <span class="comment">//</span>
00424     <span class="comment">//  If current index value is all 9s, then the next value will cause the</span>
00425     <span class="comment">//  index string to grow from it's current size.  In this case recompute</span>
00426     <span class="comment">//  Context-&gt;NameLength so that is will be correct for next time.</span>
00427     <span class="comment">//</span>
00428 
00429     <span class="keywordflow">if</span> (IndexAll9s) {
00430 
00431         <span class="keywordflow">if</span> (DbcsAware) {
00432 
00433             <span class="keywordflow">for</span> (i = 0, OemLength = 0; i &lt; Context-&gt;NameLength; i++) {
00434 
00435                 OemLength += <a class="code" href="../../d5/d9/gen8dot3_8c.html#a0">IsDbcsCharacter</a>(Context-&gt;NameBuffer[i]) ? 2 : 1;
00436 
00437                 <span class="keywordflow">if</span> (OemLength &gt;= 8 - (IndexLength + 1)) {
00438                     <span class="keywordflow">break</span>;
00439                 }
00440             }
00441 
00442             Context-&gt;NameLength = (UCHAR)i;
00443 
00444         } <span class="keywordflow">else</span> {
00445 
00446             Context-&gt;NameLength -= 1;
00447         }
00448     }
00449 
00450     <span class="comment">//</span>
00451     <span class="comment">//  And return to our caller</span>
00452     <span class="comment">//</span>
00453 
00454     <span class="keywordflow">return</span>;
00455 }
00456 
00457 
00458 BOOLEAN
<a name="l00459"></a><a class="code" href="../../d5/d9/gen8dot3_8c.html#a12">00459</a> <a class="code" href="../../d5/d9/gen8dot3_8c.html#a12">RtlIsValidOemCharacter</a> (
00460     IN PWCHAR Char
00461 )
00462 
00463 <span class="comment">/*++</span>
00464 <span class="comment"></span>
00465 <span class="comment">Routine Description:</span>
00466 <span class="comment"></span>
00467 <span class="comment">    This routine determines if the best-fitted and upcased version of the</span>
00468 <span class="comment">    input unicode char is a valid Oem character.</span>
00469 <span class="comment"></span>
00470 <span class="comment">Arguments:</span>
00471 <span class="comment"></span>
00472 <span class="comment">    Char - Supplies the Unicode char and receives the best-fitted and</span>
00473 <span class="comment">        upcased version if it was indeed valid.</span>
00474 <span class="comment"></span>
00475 <span class="comment">Return Value:</span>
00476 <span class="comment"></span>
00477 <span class="comment">    TRUE if the character was valid.</span>
00478 <span class="comment"></span>
00479 <span class="comment">--*/</span>
00480 
00481 {
00482     WCHAR UniTmp;
00483     WCHAR OemChar;
00484 
00485     <span class="comment">//</span>
00486     <span class="comment">//  First try to make a round trip from Unicode-&gt;Oem-&gt;Unicode.</span>
00487     <span class="comment">//</span>
00488 
00489     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d9/gen8dot3_8c.html#a5">NlsMbOemCodePageTag</a>) {
00490 
00491         UniTmp = (WCHAR)<a class="code" href="../../d5/d9/ntrtlp_8h.html#a10">NLS_UPCASE</a>(<a class="code" href="../../d5/d9/gen8dot3_8c.html#a2">NlsOemToUnicodeData</a>[(UCHAR)<a class="code" href="../../d5/d9/gen8dot3_8c.html#a3">NlsUnicodeToOemData</a>[*Char]]);
00492         OemChar = <a class="code" href="../../d5/d9/gen8dot3_8c.html#a3">NlsUnicodeToOemData</a>[UniTmp];
00493 
00494     } <span class="keywordflow">else</span> {
00495 
00496         <span class="comment">//</span>
00497         <span class="comment">// Convert to OEM and back to Unicode before upper casing</span>
00498         <span class="comment">// to ensure the visual best fits are converted and</span>
00499         <span class="comment">// upper cased properly.</span>
00500         <span class="comment">//</span>
00501 
00502         OemChar = <a class="code" href="../../d5/d9/gen8dot3_8c.html#a1">NlsUnicodeToMbOemData</a>[ *Char ];
00503 
00504         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/gen8dot3_8c.html#a6">NlsOemLeadByteInfo</a>[<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(OemChar)]) {
00505 
00506             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Entry;
00507 
00508             <span class="comment">//</span>
00509             <span class="comment">// Lead byte - translate the trail byte using the table</span>
00510             <span class="comment">// that corresponds to this lead byte.</span>
00511             <span class="comment">//</span>
00512 
00513             Entry = <a class="code" href="../../d5/d9/gen8dot3_8c.html#a6">NlsOemLeadByteInfo</a>[<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(OemChar)];
00514             UniTmp = (WCHAR)<a class="code" href="../../d5/d9/gen8dot3_8c.html#a4">NlsMbOemCodePageTables</a>[ Entry + <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(OemChar) ];
00515 
00516         } <span class="keywordflow">else</span> {
00517 
00518             <span class="comment">//</span>
00519             <span class="comment">// Single byte character.</span>
00520             <span class="comment">//</span>
00521 
00522             UniTmp = <a class="code" href="../../d5/d9/gen8dot3_8c.html#a2">NlsOemToUnicodeData</a>[<a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(OemChar)];
00523         }
00524 
00525         <span class="comment">//</span>
00526         <span class="comment">//  Now upcase this UNICODE character, and convert it to Oem.</span>
00527         <span class="comment">//</span>
00528 
00529         UniTmp = (WCHAR)<a class="code" href="../../d5/d9/ntrtlp_8h.html#a10">NLS_UPCASE</a>(UniTmp);
00530         OemChar = <a class="code" href="../../d5/d9/gen8dot3_8c.html#a1">NlsUnicodeToMbOemData</a>[UniTmp];
00531     }
00532 
00533     <span class="comment">//</span>
00534     <span class="comment">//  Now if the final OemChar is the default one, then there was no</span>
00535     <span class="comment">//  mapping for this UNICODE character.</span>
00536     <span class="comment">//</span>
00537 
00538     <span class="keywordflow">if</span> (OemChar == <a class="code" href="../../d5/d9/gen8dot3_8c.html#a7">OemDefaultChar</a>) {
00539 
00540         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00541 
00542     } <span class="keywordflow">else</span> {
00543 
00544         *Char = UniTmp;
00545         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00546     }
00547 }
00548 
00549 
00550 <span class="comment">//</span>
00551 <span class="comment">//  Local support routine</span>
00552 <span class="comment">//</span>
00553 
00554 WCHAR
<a name="l00555"></a><a class="code" href="../../d5/d9/gen8dot3_8c.html#a9">00555</a> <a class="code" href="../../d5/d9/gen8dot3_8c.html#a9">GetNextWchar</a> (
00556     IN PUNICODE_STRING Name,
00557     IN PULONG CurrentIndex,
00558     IN BOOLEAN SkipDots,
00559     IN BOOLEAN AllowExtendedCharacters
00560     )
00561 
00562 <span class="comment">/*++</span>
00563 <span class="comment"></span>
00564 <span class="comment">Routine Description:</span>
00565 <span class="comment"></span>
00566 <span class="comment">    This routine scans the input name starting at the current index and</span>
00567 <span class="comment">    returns the next valid character for the long name to 8.3 generation</span>
00568 <span class="comment">    algorithm.  It also updates the current index to point to the</span>
00569 <span class="comment">    next character to examine.</span>
00570 <span class="comment"></span>
00571 <span class="comment">    The user can specify if dots are skipped over or passed back.  The</span>
00572 <span class="comment">    filtering done by the procedure is:</span>
00573 <span class="comment"></span>
00574 <span class="comment">    1. Skip characters less then blanks, and larger than 127 if</span>
00575 <span class="comment">       AllowExtendedCharacters is FALSE</span>
00576 <span class="comment">    2. Optionally skip over dots</span>
00577 <span class="comment">    3. translate the special 7 characters : + , ; = [ ] into underscores</span>
00578 <span class="comment"></span>
00579 <span class="comment">Arguments:</span>
00580 <span class="comment"></span>
00581 <span class="comment">    Name - Supplies the name being examined</span>
00582 <span class="comment"></span>
00583 <span class="comment">    CurrentIndex - Supplies the index to start our examination and also</span>
00584 <span class="comment">        receives the index of one beyond the character we return.</span>
00585 <span class="comment"></span>
00586 <span class="comment">    SkipDots - Indicates whether this routine will also skip over periods</span>
00587 <span class="comment"></span>
00588 <span class="comment">    AllowExtendedCharacters - Tell whether charaacters &gt;= 127 are valid.</span>
00589 <span class="comment"></span>
00590 <span class="comment">Return Value:</span>
00591 <span class="comment"></span>
00592 <span class="comment">    WCHAR - returns the next wchar in the name string</span>
00593 <span class="comment"></span>
00594 <span class="comment">--*/</span>
00595 
00596 {
00597     WCHAR wc;
00598 
00599     <span class="comment">//</span>
00600     <span class="comment">//  Until we find out otherwise the character we are going to return</span>
00601     <span class="comment">//  is 0</span>
00602     <span class="comment">//</span>
00603 
00604     wc = 0;
00605 
00606     <span class="comment">//</span>
00607     <span class="comment">//  Now loop through updating the current index until we either have a character to</span>
00608     <span class="comment">//  return or until we exhaust the name buffer</span>
00609     <span class="comment">//</span>
00610 
00611     <span class="keywordflow">while</span> (*CurrentIndex &lt; (ULONG)(<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length/2)) {
00612 
00613         <span class="comment">//</span>
00614         <span class="comment">//  Get the next character in the buffer</span>
00615         <span class="comment">//</span>
00616 
00617         wc = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[*CurrentIndex];
00618         *CurrentIndex += 1;
00619 
00620         <span class="comment">//</span>
00621         <span class="comment">//  If the character is to be skipped over then reset wc to 0</span>
00622         <span class="comment">//</span>
00623 
00624         <span class="keywordflow">if</span> ((wc &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>) ||
00625             ((wc &gt;= 127) &amp;&amp; (!AllowExtendedCharacters || !<a class="code" href="../../d5/d9/gen8dot3_8c.html#a12">RtlIsValidOemCharacter</a>(&amp;wc))) ||
00626             ((wc == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span>) &amp;&amp; SkipDots)) {
00627 
00628             wc = 0;
00629 
00630         } <span class="keywordflow">else</span> {
00631 
00632             <span class="comment">//</span>
00633             <span class="comment">//  We have a character to return, but first translate the character is necessary</span>
00634             <span class="comment">//</span>
00635 
00636             <span class="keywordflow">if</span> ((wc &lt; 0x80) &amp;&amp; (<a class="code" href="../../d5/d9/gen8dot3_8c.html#a8">RtlFatIllegalTable</a>[wc/32] &amp; (1 &lt;&lt; (wc%32)))) {
00637 
00638                 wc = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'_'</span>;
00639             }
00640 
00641             <span class="comment">//</span>
00642             <span class="comment">//  Do an a-z upcase.</span>
00643             <span class="comment">//</span>
00644 
00645             <span class="keywordflow">if</span> ((wc &gt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'a'</span>) &amp;&amp; (wc &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'z'</span>)) {
00646 
00647                 wc -= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'a'</span> - <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span>;
00648             }
00649 
00650             <span class="comment">//</span>
00651             <span class="comment">//  And break out of the loop to return to our caller</span>
00652             <span class="comment">//</span>
00653 
00654             <span class="keywordflow">break</span>;
00655         }
00656     }
00657 
00658     <span class="comment">//DebugTrace( 0, Dbg, "GetNextWchar -&gt; %08x\n", wc);</span>
00659 
00660     <span class="keywordflow">return</span> wc;
00661 }
00662 
00663 
00664 <span class="comment">//</span>
00665 <span class="comment">//  Internal support routine</span>
00666 <span class="comment">//</span>
00667 
00668 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
<a name="l00669"></a><a class="code" href="../../d5/d9/gen8dot3_8c.html#a10">00669</a> <a class="code" href="../../d5/d9/gen8dot3_8c.html#a10">RtlComputeLfnChecksum</a> (
00670     PUNICODE_STRING Name
00671     )
00672 
00673 <span class="comment">/*++</span>
00674 <span class="comment"></span>
00675 <span class="comment">Routine Description:</span>
00676 <span class="comment"></span>
00677 <span class="comment">    This routine computes the Chicago long file name checksum.</span>
00678 <span class="comment"></span>
00679 <span class="comment">Arguments:</span>
00680 <span class="comment"></span>
00681 <span class="comment">    Name - Supplies the name to compute the checksum on.  Note that one</span>
00682 <span class="comment">        character names don't have interesting checksums.</span>
00683 <span class="comment"></span>
00684 <span class="comment">Return Value:</span>
00685 <span class="comment"></span>
00686 <span class="comment">    The checksum.</span>
00687 <span class="comment"></span>
00688 <span class="comment">--*/</span>
00689 
00690 {
00691     ULONG i;
00692     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Checksum;
00693 
00694     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00695 
00696     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length == <span class="keyword">sizeof</span>(WCHAR)) {
00697 
00698         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[0];
00699     }
00700 
00701     Checksum = ((<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[0] &lt;&lt; 8) + <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[1]) &amp; 0xffff;
00702 
00703     <span class="comment">//</span>
00704     <span class="comment">//  This checksum is kinda strange because we want to still have</span>
00705     <span class="comment">//  a good range even if all the characters are &lt; 0x00ff.</span>
00706     <span class="comment">//</span>
00707 
00708     <span class="keywordflow">for</span> (i=2; i &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR); i+=2) {
00709 
00710         Checksum = (Checksum &amp; 1 ? 0x8000 : 0) +
00711                    (Checksum &gt;&gt; 1) +
00712                    (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[i] &lt;&lt; 8);
00713 
00714         <span class="comment">//</span>
00715         <span class="comment">//  Be carefull to not walk off the end of the string.</span>
00716         <span class="comment">//</span>
00717 
00718         <span class="keywordflow">if</span> (i+1 &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)) {
00719 
00720             Checksum += <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[i+1] &amp; 0xffff;
00721         }
00722     }
00723 
00724     <span class="keywordflow">return</span> Checksum;
00725 }
00726 
00727 
00728 BOOLEAN
<a name="l00729"></a><a class="code" href="../../d5/d9/gen8dot3_8c.html#a13">00729</a> <a class="code" href="../../d5/d9/gen8dot3_8c.html#a13">RtlIsNameLegalDOS8Dot3</a> (
00730     IN PUNICODE_STRING Name,
00731     IN OUT POEM_STRING OemName OPTIONAL,
00732     OUT PBOOLEAN NameContainsSpaces OPTIONAL
00733     )
00734 <span class="comment">/*++</span>
00735 <span class="comment"></span>
00736 <span class="comment">Routine Description:</span>
00737 <span class="comment"></span>
00738 <span class="comment">    This routine takes an input string and gives a definitive answer</span>
00739 <span class="comment">    on whether this name can successfully be used to create a file</span>
00740 <span class="comment">    on the FAT file system.</span>
00741 <span class="comment"></span>
00742 <span class="comment">    This routine can therefore also be used to determine if a name is</span>
00743 <span class="comment">    appropriate to be passed back to a Win31 or DOS app, i.e. whether</span>
00744 <span class="comment">    the downlevel APP will understand the name.</span>
00745 <span class="comment"></span>
00746 <span class="comment">    Note: an important part of this test is the mapping from UNICODE</span>
00747 <span class="comment">    to Oem, which is why it is important that the input parameter be</span>
00748 <span class="comment">    received in UNICODE.</span>
00749 <span class="comment"></span>
00750 <span class="comment">Arguments:</span>
00751 <span class="comment"></span>
00752 <span class="comment">    Name - The UNICODE name to test for conformance to 8.3 symantics.</span>
00753 <span class="comment"></span>
00754 <span class="comment">    OemName - If specified, will receive the Oem name corresponding</span>
00755 <span class="comment">        to the passed in Name.  Storage must be provided by the caller.</span>
00756 <span class="comment">        The name is undefined if the routine returns FALSE.</span>
00757 <span class="comment"></span>
00758 <span class="comment">    NameContainsSpaces - If the function returns TRUE, then this</span>
00759 <span class="comment">        parameter will indicate if the names contains spaces.  If</span>
00760 <span class="comment">        the function returns FALSE, this parameter is undefined. In</span>
00761 <span class="comment">        many instances, the alternate name is more appropriate to</span>
00762 <span class="comment">        use if spaces are present in the principle name, even if</span>
00763 <span class="comment">        it is 8.3 compliant.</span>
00764 <span class="comment"></span>
00765 <span class="comment">Return Value:</span>
00766 <span class="comment"></span>
00767 <span class="comment">    BOOLEAN - TRUE if the passed in UNICODE name forms a valid 8.3</span>
00768 <span class="comment">        FAT name when upcased to the current Oem code page.</span>
00769 <span class="comment"></span>
00770 <span class="comment">--*/</span>
00771 
00772 {
00773     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00774     BOOLEAN ExtensionPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00775     BOOLEAN SpacesPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00776     OEM_STRING LocalOemName;
00777     UCHAR Char;
00778     UCHAR OemBuffer[12];
00779 
00780     <span class="comment">//</span>
00781     <span class="comment">//  If the name is more than 12 chars, bail.</span>
00782     <span class="comment">//</span>
00783 
00784     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length &gt; 12*<span class="keyword">sizeof</span>(WCHAR)) {
00785         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00786     }
00787 
00788     <span class="comment">//</span>
00789     <span class="comment">//  Now upcase this name to Oem.  If anything goes wrong,</span>
00790     <span class="comment">//  return FALSE.</span>
00791     <span class="comment">//</span>
00792 
00793     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(OemName)) {
00794 
00795         OemName = &amp;LocalOemName;
00796 
00797         OemName-&gt;Buffer = &amp;OemBuffer[0];
00798         OemName-&gt;Length = 0;
00799         OemName-&gt;MaximumLength = 12;
00800     }
00801 
00802     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d6/nls_8c.html#a30">RtlUpcaseUnicodeStringToCountedOemString</a>(OemName, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))) {
00803         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00804     }
00805 
00806     <span class="comment">//</span>
00807     <span class="comment">//  Special case . and ..</span>
00808     <span class="comment">//</span>
00809 
00810     <span class="keywordflow">if</span> (((OemName-&gt;Length == 1) &amp;&amp; (OemName-&gt;Buffer[0] == <span class="charliteral">'.'</span>)) ||
00811         ((OemName-&gt;Length == 2) &amp;&amp; (OemName-&gt;Buffer[0] == <span class="charliteral">'.'</span>) &amp;&amp; (OemName-&gt;Buffer[1] == <span class="charliteral">'.'</span>))) {
00812 
00813         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NameContainsSpaces)) {
00814             *NameContainsSpaces = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00815         }
00816         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00817     }
00818 
00819     <span class="comment">//</span>
00820     <span class="comment">//  Now we are going to walk through the string looking for</span>
00821     <span class="comment">//  illegal characters and/or incorrect syntax.</span>
00822     <span class="comment">//</span>
00823 
00824     <span class="keywordflow">for</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; OemName-&gt;Length; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1 ) {
00825 
00826         Char = OemName-&gt;Buffer[ <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> ];
00827 
00828         <span class="comment">//</span>
00829         <span class="comment">//  Skip over and Dbcs chacters</span>
00830         <span class="comment">//</span>
00831 
00832         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/gen8dot3_8c.html#a5">NlsMbOemCodePageTag</a> &amp;&amp; <a class="code" href="../../d5/d9/gen8dot3_8c.html#a6">NlsOemLeadByteInfo</a>[Char]) {
00833 
00834             <span class="comment">//</span>
00835             <span class="comment">//  1) if we're looking at base part ( !ExtensionPresent ) and the 8th byte</span>
00836             <span class="comment">//     is in the dbcs leading byte range, it's error ( Index == 7 ). If the</span>
00837             <span class="comment">//     length of base part is more than 8 ( Index &gt; 7 ), it's definitely error.</span>
00838             <span class="comment">//</span>
00839             <span class="comment">//  2) if the last byte ( Index == DbcsName.Length - 1 ) is in the dbcs leading</span>
00840             <span class="comment">//     byte range, it's error</span>
00841             <span class="comment">//</span>
00842 
00843             <span class="keywordflow">if</span> ((!ExtensionPresent &amp;&amp; (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= 7)) ||
00844                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == (ULONG)(OemName-&gt;Length - 1))) {
00845                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00846             }
00847 
00848             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00849 
00850             <span class="keywordflow">continue</span>;
00851         }
00852 
00853         <span class="comment">//</span>
00854         <span class="comment">//  Make sure this character is legal.</span>
00855         <span class="comment">//</span>
00856 
00857         <span class="keywordflow">if</span> ((Char &lt; 0x80) &amp;&amp;
00858             (<a class="code" href="../../d5/d9/gen8dot3_8c.html#a8">RtlFatIllegalTable</a>[Char/32] &amp; (1 &lt;&lt; (Char%32)))) {
00859             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00860         }
00861 
00862         <span class="comment">//</span>
00863         <span class="comment">//  Remember if there was a space.</span>
00864         <span class="comment">//</span>
00865 
00866         <span class="keywordflow">if</span> (Char == <span class="charliteral">' '</span>) {
00867             SpacesPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00868         }
00869 
00870         <span class="keywordflow">if</span> (Char == <span class="charliteral">'.'</span>) {
00871 
00872             <span class="comment">//</span>
00873             <span class="comment">//  We stepped onto a period.  We require the following things:</span>
00874             <span class="comment">//</span>
00875             <span class="comment">//      - There can only be one</span>
00876             <span class="comment">//      - It can't be the first character</span>
00877             <span class="comment">//      - The previous character can't be a space.</span>
00878             <span class="comment">//      - There can't be more than 3 bytes following</span>
00879             <span class="comment">//</span>
00880 
00881             <span class="keywordflow">if</span> (ExtensionPresent ||
00882                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == 0) ||
00883                 (OemName-&gt;Buffer[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1] == <span class="charliteral">' '</span>) ||
00884                 (OemName-&gt;Length - (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1) &gt; 3)) {
00885 
00886                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00887             }
00888 
00889             ExtensionPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00890         }
00891 
00892         <span class="comment">//</span>
00893         <span class="comment">//  The base part of the name can't be more than 8 characters long.</span>
00894         <span class="comment">//</span>
00895 
00896         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= 8) &amp;&amp; !ExtensionPresent) { <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; }
00897     }
00898 
00899     <span class="comment">//</span>
00900     <span class="comment">//  The name cannot end in a space or a period.</span>
00901     <span class="comment">//</span>
00902 
00903     <span class="keywordflow">if</span> ((Char == <span class="charliteral">' '</span>) || (Char == <span class="charliteral">'.'</span>)) { <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; }
00904 
00905     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NameContainsSpaces)) {
00906         *NameContainsSpaces = SpacesPresent;
00907     }
00908     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00909 }
00910 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
