<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnp.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnp.c</h1><a href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: pnp.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module tracks device interface changes so we can keep track of know how many mice and</span>
00007 <span class="comment">* keyboards and mouse</span>
00008 <span class="comment">* and mouse reports.</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* History:</span>
00011 <span class="comment">* 97-10-16   IanJa   Interpreted from a dream that Ken Ray had.</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
<a name="l00017"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">00017</a> <a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html">DEVICE_TEMPLATE</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[<a class="code" href="../../d4/d1/userk_8h.html#a177">DEVICE_TYPE_MAX</a> + 1] = {
00018     <span class="comment">// DEVICE_TYPE_MOUSE</span>
00019     {
00020         <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/structtagGENERIC__DEVICE__INFO.html">GENERIC_DEVICE_INFO</a>)+<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d2/structtagMOUSE__DEVICE__INFO.html">MOUSE_DEVICE_INFO</a>),    <span class="comment">// cbDeviceInfo</span>
00021         &amp;GUID_CLASS_MOUSE,                                        <span class="comment">// pClassGUID</span>
00022         <a class="code" href="../../d4/d1/userk_8h.html#a732">PMAP_MOUCLASS_PARAMS</a>,                                     <span class="comment">// uiRegistrySection</span>
00023         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"mouclass"</span>,                                              <span class="comment">// pwszClassName</span>
00024         DD_MOUSE_DEVICE_NAME_U <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"0"</span>,                              <span class="comment">// pwszDefDevName</span>
00025         DD_MOUSE_DEVICE_NAME_U <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Legacy0"</span>,                        <span class="comment">// pwszLegacyDevName</span>
00026         IOCTL_MOUSE_QUERY_ATTRIBUTES,                             <span class="comment">// IOCTL_Attr</span>
00027         FIELD_OFFSET(<a class="code" href="../../d5/d3/structtagDEVICEINFO.html">DEVICEINFO</a>, mouse.Attr),                     <span class="comment">// offAttr</span>
00028         <span class="keyword">sizeof</span>((<a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)-&gt;mouse.Attr,                    <span class="comment">// cbAttr</span>
00029         FIELD_OFFSET(<a class="code" href="../../d5/d3/structtagDEVICEINFO.html">DEVICEINFO</a>, mouse.Data),                     <span class="comment">// offData</span>
00030         <span class="keyword">sizeof</span>((<a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)-&gt;mouse.Data,                    <span class="comment">// cbData</span>
00031         <a class="code" href="../../d6/d8/ntinput_8c.html#a49">ProcessMouseInput</a>,                                        <span class="comment">// Reader routine</span>
00032         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                                                      <span class="comment">// pkeHidChange</span>
00033     },
00034     <span class="comment">// DEVICE_TYPE_KEYBOARD</span>
00035     {
00036         <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/structtagGENERIC__DEVICE__INFO.html">GENERIC_DEVICE_INFO</a>)+<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/structtagKEYBOARD__DEVICE__INFO.html">KEYBOARD_DEVICE_INFO</a>), <span class="comment">// cbDeviceInfo</span>
00037         &amp;GUID_CLASS_KEYBOARD,                                     <span class="comment">// pClassGUID</span>
00038         <a class="code" href="../../d4/d1/userk_8h.html#a733">PMAP_KBDCLASS_PARAMS</a>,                                     <span class="comment">// uiRegistrySection</span>
00039         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"kbdclass"</span>,                                              <span class="comment">// pwszClassName</span>
00040         DD_KEYBOARD_DEVICE_NAME_U <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"0"</span>,                           <span class="comment">// pwszDefDevName</span>
00041         DD_KEYBOARD_DEVICE_NAME_U <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Legacy0"</span>,                     <span class="comment">// pwszLegacyDevName</span>
00042         IOCTL_KEYBOARD_QUERY_ATTRIBUTES,                          <span class="comment">// IOCTL_Attr</span>
00043         FIELD_OFFSET(<a class="code" href="../../d5/d3/structtagDEVICEINFO.html">DEVICEINFO</a>, keyboard.Attr),                  <span class="comment">// offAttr</span>
00044         <span class="keyword">sizeof</span>((<a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)-&gt;keyboard.Attr,                 <span class="comment">// cbAttr</span>
00045         FIELD_OFFSET(<a class="code" href="../../d5/d3/structtagDEVICEINFO.html">DEVICEINFO</a>, keyboard.Data),                  <span class="comment">// offData</span>
00046         <span class="keyword">sizeof</span>((<a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)-&gt;keyboard.Data,                 <span class="comment">// cbData</span>
00047         <a class="code" href="../../d6/d8/ntinput_8c.html#a57">ProcessKeyboardInput</a>,                                     <span class="comment">// Reader routine</span>
00048         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                                                      <span class="comment">// pkeHidChange</span>
00049     },
00050     <span class="comment">// Add new input device type template here</span>
00051 };
00052 
00053 <span class="preprocessor">#ifdef DIAGNOSE_IO</span>
<a name="l00054"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a3">00054</a> <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a3">gKbdIoctlLEDSStatus</a> = -1;   <span class="comment">// last IOCTL_KEYBOARD_QUERY_INDICATORS</span>
00055 <span class="preprocessor">#endif</span>
00056 <span class="preprocessor"></span>
<a name="l00057"></a><a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html">00057</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html">_CDROM_NOTIFY</a> {
<a name="l00058"></a><a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o0">00058</a>     LIST_ENTRY                   <a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o0">Entry</a>;
<a name="l00059"></a><a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o1">00059</a>     ULONG                        <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
<a name="l00060"></a><a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o2">00060</a>     PVOID                        <a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o2">RegistrationHandle</a>;
<a name="l00061"></a><a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o3">00061</a>     ULONG                        <a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o3">Event</a>;
00062     <span class="comment">// Must be last field</span>
<a name="l00063"></a><a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o4">00063</a>     MOUNTMGR_DRIVE_LETTER_TARGET <a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o4">DeviceName</a>;
00064 } <a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html">CDROM_NOTIFY</a>, *<a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html">PCDROM_NOTIFY</a>;
00065 
<a name="l00066"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a6">00066</a> LIST_ENTRY <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a6">gMediaChangeList</a>;
<a name="l00067"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a7">00067</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a7">gMediaChangeMutex</a>;
<a name="l00068"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a8">00068</a> HANDLE <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a8">gpEventMediaChange</a>     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00069"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a9">00069</a> UCHAR <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a9">DriveLetterChange</a>[26];
<a name="l00070"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a0">00070</a> <span class="preprocessor">#define EVENT_CDROM_MEDIA_ARRIVAL 1</span>
<a name="l00071"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a1">00071</a> <span class="preprocessor"></span><span class="preprocessor">#define EVENT_CDROM_MEDIA_REMOVAL 2</span>
00072 <span class="preprocessor"></span>
00073 <span class="comment">/***************************************************************************\</span>
00074 <span class="comment">* Win32kPnPDriverEntry</span>
00075 <span class="comment">*</span>
00076 <span class="comment">* This is the callback function when we call IoCreateDriver to create a</span>
00077 <span class="comment">* PnP Driver Object.  In this function, we need to remember the DriverObject.</span>
00078 <span class="comment">*</span>
00079 <span class="comment">* Parameters:</span>
00080 <span class="comment">*   DriverObject - Pointer to the driver object created by the system.</span>
00081 <span class="comment">*   RegistryPath - is NULL.</span>
00082 <span class="comment">*</span>
00083 <span class="comment">* Return Value: STATUS_SUCCESS</span>
00084 <span class="comment">*</span>
00085 <span class="comment">* History:</span>
00086 <span class="comment">* 10-20-97  IanJa   Taken from ntos\io\pnpinit.c</span>
00087 <span class="comment">\***************************************************************************/</span>
00088 
00089 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00090"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a10">00090</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a10">Win32kPnPDriverEntry</a>(
00091     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00092     IN PUNICODE_STRING pustrRegistryPath
00093     )
00094 
00095 {
00096     TAGMSG2(DBGTAG_PNP,
00097             <span class="stringliteral">"Win32kPnPDriverEntry(DriverObject = %lx, pustrRegistryPath = %#p)"</span>,
00098             DriverObject, pustrRegistryPath);
00099 
00100     <span class="comment">//</span>
00101     <span class="comment">// File the pointer to our driver object away</span>
00102     <span class="comment">//</span>
00103     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a207">gpWin32kDriverObject</a> = DriverObject;
00104     <span class="keywordflow">return</span> STATUS_SUCCESS;
00105 
00106     UNREFERENCED_PARAMETER(pustrRegistryPath);
00107 }
00108 
00109 
00110 <span class="comment">/***************************************************************************\</span>
00111 <span class="comment">* Initialize the global event used in notifying CSR that media has changed.</span>
00112 <span class="comment">*</span>
00113 <span class="comment">* Execution Context:</span>
00114 <span class="comment">*</span>
00115 <span class="comment">* History:</span>
00116 <span class="comment">\***************************************************************************/</span>
00117 
00118 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00119"></a><a class="code" href="../../d4/d1/userk_8h.html#a996">00119</a> <a class="code" href="../../d4/d1/userk_8h.html#a996">InitializeMediaChange</a>(HANDLE hMediaRequestEvent)
00120 {
00121     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
00122 
00123         InitializeListHead(&amp;<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a6">gMediaChangeList</a>);
00124 
00125         <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hMediaRequestEvent,
00126                                   EVENT_ALL_ACCESS,
00127                                   *<a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
00128                                   <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00129                                   &amp;<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a8">gpEventMediaChange</a>,
00130                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00131 
00132         <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a7">gMediaChangeMutex</a> = UserAllocPoolNonPaged(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>), TAG_PNP);
00133 
00134         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a7">gMediaChangeMutex</a>) {
00135             <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a7">gMediaChangeMutex</a>);
00136         }
00137     }
00138 
00139     <span class="keywordflow">return</span>;
00140 }
00141 
<a name="l00142"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a12">00142</a> __inline <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a12">EnterMediaCrit</a>() {
00143     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00144     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a7">gMediaChangeMutex</a>);
00145 }
00146 
<a name="l00147"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a13">00147</a> __inline <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a13">LeaveMediaCrit</a>() {
00148     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a7">gMediaChangeMutex</a>);
00149     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00150 }
00151 
00152 
00153 
00154 <span class="comment">/***************************************************************************\</span>
00155 <span class="comment">* Routines to support CDROM driver letters.</span>
00156 <span class="comment">*</span>
00157 <span class="comment">* Execution Context:</span>
00158 <span class="comment">*</span>
00159 <span class="comment">* History:</span>
00160 <span class="comment">\***************************************************************************/</span>
00161 
<a name="l00162"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a14">00162</a> ULONG <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a14">GetDeviceChangeInfo</a>()
00163 {
00164     UNICODE_STRING                      name;
00165     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>                        FileObject;
00166     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>                      DeviceObject;
00167     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>                              event;
00168     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>                                irp;
00169     MOUNTMGR_DRIVE_LETTER_INFORMATION   output;
00170     IO_STATUS_BLOCK                     ioStatus;
00171     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                            status;
00172     <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a5">PCDROM_NOTIFY</a>                       pContext = 0;
00173 
00174     ULONG retval = 0;
00175 
00176     <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>())) {
00177         <span class="keywordflow">return</span> 0;
00178     }
00179 
00180     <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a12">EnterMediaCrit</a>();
00181     <span class="keywordflow">if</span> (!IsListEmpty(&amp;<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a6">gMediaChangeList</a>)) {
00182         pContext = (<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a5">PCDROM_NOTIFY</a>) RemoveTailList(&amp;<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a6">gMediaChangeList</a>);
00183     }
00184     <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a13">LeaveMediaCrit</a>();
00185 
00186     <span class="keywordflow">if</span> (pContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00187         <span class="keywordflow">return</span> 0;
00188     }
00189 
00190     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;name, MOUNTMGR_DEVICE_NAME);
00191     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a71">IoGetDeviceObjectPointer</a>(&amp;name,
00192                                       FILE_READ_ATTRIBUTES,
00193                                       &amp;FileObject,
00194                                       &amp;DeviceObject);
00195 
00196     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00197 
00198         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;event, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00199         irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>(IOCTL_MOUNTMGR_NEXT_DRIVE_LETTER,
00200                                             DeviceObject,
00201                                             &amp;pContext-&gt;<a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o4">DeviceName</a>,
00202                                             <span class="keyword">sizeof</span>(MOUNTMGR_DRIVE_LETTER_TARGET) +
00203                                                 pContext-&gt;<a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o4">DeviceName</a>.DeviceNameLength,
00204                                             &amp;output,
00205                                             <span class="keyword">sizeof</span>(output),
00206                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00207                                             &amp;event,
00208                                             &amp;ioStatus);
00209         <span class="keywordflow">if</span> (irp) {
00210 
00211             status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>(DeviceObject, irp);
00212             <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00213                 <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;event, <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00214                 status = ioStatus.Status;
00215             }
00216             <span class="keywordflow">if</span> ((status == STATUS_SUCCESS) &amp;&amp;
00217                 (output.CurrentDriveLetter)) {
00218 
00219                 UserAssert((output.CurrentDriveLetter - <span class="charliteral">'A'</span>) &lt; 30);
00220 
00221                 retval = 1 &lt;&lt; (output.CurrentDriveLetter - <span class="charliteral">'A'</span>);
00222 
00223                 <span class="keywordflow">if</span> (pContext-&gt;<a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o3">Event</a> &amp; <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a0">EVENT_CDROM_MEDIA_ARRIVAL</a>) {
00224                     retval |= 0x80000000;
00225                 }
00226             }
00227         }
00228 
00229         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(FileObject);
00230     }
00231 
00232     <span class="comment">//</span>
00233     <span class="comment">// Allways free the request</span>
00234     <span class="comment">//</span>
00235 
00236     UserFreePool(pContext);
00237 
00238     <span class="keywordflow">return</span> retval;
00239 }
00240 
00241 <span class="comment">/***************************************************************************\</span>
00242 <span class="comment">* Handle device notifications such as MediaChanged</span>
00243 <span class="comment">*</span>
00244 <span class="comment">* Execution Context:</span>
00245 <span class="comment">*</span>
00246 <span class="comment">* History:</span>
00247 <span class="comment">\***************************************************************************/</span>
<a name="l00248"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a15">00248</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a15">DeviceCDROMNotify</a>(
00249     IN <a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">PTARGET_DEVICE_CUSTOM_NOTIFICATION</a> Notification,
00250     IN PCDROM_NOTIFY pContext)
00251 {
00252     <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a5">PCDROM_NOTIFY</a> pNew;
00253 
00254     <a class="code" href="../../d4/d1/userk_8h.html#a157">CheckCritOut</a>();
00255 
00256     UserAssert(!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>);
00257     UserAssert(pContext);
00258 
00259     <span class="keywordflow">if</span> (IsEqualGUID(&amp;Notification-&gt;Event, &amp;GUID_IO_MEDIA_ARRIVAL))
00260     {
00261         pContext-&gt;Event = <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a0">EVENT_CDROM_MEDIA_ARRIVAL</a>;
00262     }
00263     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsEqualGUID(&amp;Notification-&gt;Event, &amp;GUID_IO_MEDIA_REMOVAL))
00264     {
00265         pContext-&gt;Event = <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a1">EVENT_CDROM_MEDIA_REMOVAL</a>;
00266     }
00267     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsEqualGUID(&amp;Notification-&gt;Event, &amp;GUID_TARGET_DEVICE_REMOVE_COMPLETE))
00268     {
00269         <a class="code" href="../../d8/d0/pnpioapi_8c.html#a96">IoUnregisterPlugPlayNotification</a>(pContext-&gt;RegistrationHandle);
00270         UserFreePool(pContext);
00271         <span class="keywordflow">return</span> STATUS_SUCCESS;
00272     }
00273     <span class="keywordflow">else</span>
00274     {
00275         <span class="keywordflow">return</span> STATUS_SUCCESS;
00276     }
00277 
00278     <span class="comment">//</span>
00279     <span class="comment">// Process the arrival or removal</span>
00280     <span class="comment">//</span>
00281     <span class="comment">// We must queue this otherwise we end up bugchecking on Terminal Server</span>
00282     <span class="comment">// This is due to opening a handle from within the system process which</span>
00283     <span class="comment">// requires us to do an attach process.</span>
00284     <span class="comment">//</span>
00285 
00286     pNew = UserAllocPoolNonPaged(pContext-&gt;Size, TAG_PNP);
00287     <span class="keywordflow">if</span> (pNew)
00288     {
00289         RtlCopyMemory(pNew, pContext, pContext-&gt;<a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o1">Size</a>);
00290 
00291         <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a12">EnterMediaCrit</a>();
00292         InsertHeadList(&amp;<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a6">gMediaChangeList</a>, &amp;pNew-&gt;<a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o0">Entry</a>);
00293         <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a13">LeaveMediaCrit</a>();
00294 
00295         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a8">gpEventMediaChange</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00296     }
00297 
00298     <span class="keywordflow">return</span> STATUS_SUCCESS;
00299 }
00300 
00301 
00302 
00303 <span class="comment">/***************************************************************************\</span>
00304 <span class="comment">* DeviceClassCDROMNotify</span>
00305 <span class="comment">*</span>
00306 <span class="comment">* This gets called when CDROM appears or disappears</span>
00307 <span class="comment">*</span>
00308 <span class="comment">\***************************************************************************/</span>
00309 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00310"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a16">00310</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a16">DeviceClassCDROMNotify</a> (
00311     IN <a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html">PDEVICE_INTERFACE_CHANGE_NOTIFICATION</a> classChange,
00312     IN PVOID Unused
00313     )
00314 {
00315     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00316     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>   FileObject;
00317     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
00318     <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a5">PCDROM_NOTIFY</a>  pContext;
00319     ULONG          <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00320 
00321     UNREFERENCED_PARAMETER(Unused);
00322 
00323     <a class="code" href="../../d4/d1/userk_8h.html#a157">CheckCritOut</a>();
00324 
00325     <span class="comment">/*</span>
00326 <span class="comment">     * Sanity check the DeviceType, and that it matches the InterfaceClassGuid</span>
00327 <span class="comment">     */</span>
00328     UserAssert(IsEqualGUID(&amp;classChange-&gt;InterfaceClassGuid, &amp;CdRomClassGuid));
00329 
00330     <span class="keywordflow">if</span> (IsEqualGUID(&amp;classChange-&gt;Event, &amp;GUID_DEVICE_INTERFACE_ARRIVAL)) {
00331 
00332         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a71">IoGetDeviceObjectPointer</a>(classChange-&gt;SymbolicLinkName,
00333                                           FILE_READ_ATTRIBUTES,
00334                                           &amp;FileObject,
00335                                           &amp;DeviceObject);
00336 
00337         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00338 
00339             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html">CDROM_NOTIFY</a>) + classChange-&gt;SymbolicLinkName-&gt;Length;
00340 
00341             pContext = (<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a5">PCDROM_NOTIFY</a>) UserAllocPool(<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, TAG_PNP);
00342 
00343             <span class="comment">//</span>
00344             <span class="comment">// Register For MediaChangeNotifications on all the CDROMs.</span>
00345             <span class="comment">//</span>
00346 
00347             <span class="keywordflow">if</span> (pContext) {
00348 
00349                 pContext-&gt;<a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o1">Size</a> = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00350                 pContext-&gt;<a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o4">DeviceName</a>.DeviceNameLength = classChange-&gt;SymbolicLinkName-&gt;Length;
00351                 RtlCopyMemory(pContext-&gt;<a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o4">DeviceName</a>.DeviceName,
00352                               classChange-&gt;SymbolicLinkName-&gt;Buffer,
00353                               pContext-&gt;<a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o4">DeviceName</a>.DeviceNameLength);
00354 
00355                 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a106">IoRegisterPlugPlayNotification</a> (
00356                         <a class="code" href="../../d6/d9/pnp_8h.html#a172a114">EventCategoryTargetDeviceChange</a>,
00357                         0,
00358                         FileObject,
00359                         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a207">gpWin32kDriverObject</a>,
00360                         <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a15">DeviceCDROMNotify</a>,
00361                         pContext,
00362                         &amp;(pContext-&gt;<a class="code" href="../../d3/d9/struct__CDROM__NOTIFY.html#o2">RegistrationHandle</a>));
00363             }
00364 
00365             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(FileObject);
00366         }
00367 
00368     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsEqualGUID(&amp;classChange-&gt;Event, &amp;GUID_DEVICE_INTERFACE_REMOVAL)) {
00369 
00370         <span class="comment">//</span>
00371         <span class="comment">// Do nothing - we already remove the registration.</span>
00372         <span class="comment">//</span>
00373 
00374     } <span class="keywordflow">else</span> {
00375         RIPMSG0(RIP_ERROR, <span class="stringliteral">"unrecognized Event GUID"</span>);
00376     }
00377 
00378 
00379     <span class="keywordflow">return</span> STATUS_SUCCESS;
00380 }
00381 
00382 
00383 <span class="comment">/***************************************************************************\</span>
00384 <span class="comment">* CreateDeviceInfo</span>
00385 <span class="comment">*</span>
00386 <span class="comment">* This creates an instance of an input device for USER.  To do this it:</span>
00387 <span class="comment">*  - Allocates a DEVICEINFO struct</span>
00388 <span class="comment">*  - Adds it to USER's list of input devices</span>
00389 <span class="comment">*  - Initializes some of the fields</span>
00390 <span class="comment">*  - Signals the input servicing thread to open and read the new device.</span>
00391 <span class="comment">*</span>
00392 <span class="comment">* Type - the device type (DEVICE_TYPE_MOUSE, DEVICE_TYPE_KEYBOARD)</span>
00393 <span class="comment">* Name - the device name.</span>
00394 <span class="comment">*        When trying to open a HYDRA client's mouse, Name is NULL.</span>
00395 <span class="comment">* bFlags - some initial flags to set (eg: GDIF_NOTPNP)</span>
00396 <span class="comment">*</span>
00397 <span class="comment">* THIS FUNCTION IS CALLED IN THE CONTEXT OF THE KERNEL PROCESS</span>
00398 <span class="comment">* so we mustn't open the mouse here, else the handle we get will not belong</span>
00399 <span class="comment">* to the Win32k process.</span>
00400 <span class="comment">*</span>
00401 <span class="comment">* History:</span>
00402 <span class="comment">* 11-26-90 DavidPe      Created.</span>
00403 <span class="comment">* 01-07-98 IanJa        Plug &amp; Play</span>
00404 <span class="comment">\***************************************************************************/</span>
00405 
<a name="l00406"></a><a class="code" href="../../d4/d1/userk_8h.html#a1173">00406</a> <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> <a class="code" href="../../d4/d1/userk_8h.html#a1173">CreateDeviceInfo</a>(DWORD DeviceType, PUNICODE_STRING pustrName, BYTE bFlags)
00407 {
00408     <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00409 
00410     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00411     <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00412 
00413     UserAssert(pustrName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00414 
00415     TAGMSG3(DBGTAG_PNP, <span class="stringliteral">"CreateDeviceInfo(%d, %S, %x)"</span>, DeviceType, pustrName-&gt;Buffer, bFlags);
00416 
00417     <span class="keywordflow">if</span> (DeviceType &gt; <a class="code" href="../../d4/d1/userk_8h.html#a177">DEVICE_TYPE_MAX</a>) {
00418         RIPMSG1(RIP_ERROR, <span class="stringliteral">"Unknown DeviceType %lx"</span>, DeviceType);
00419     }
00420 
00421     pDeviceInfo = UserAllocPoolZInit(<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[DeviceType].cbDeviceInfo, TAG_PNP);
00422     <span class="keywordflow">if</span> (pDeviceInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00423         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateDeviceInfo() out of memory allocating DEVICEINFO"</span>);
00424         <a class="code" href="../../d4/d1/userk_8h.html#a167">EXITATOMICCHECK</a>();
00425         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00426     }
00427 
00428     <span class="keywordflow">if</span> (pustrName-&gt;Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00429         pDeviceInfo-&gt;ustrName.Buffer = UserAllocPool(pustrName-&gt;Length, TAG_PNP);
00430 
00431         <span class="keywordflow">if</span> (pDeviceInfo-&gt;ustrName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00432             RIPMSG1(RIP_WARNING, <span class="stringliteral">"CreateDeviceInfo: Can't duplicate string %ws"</span>,
00433                     pustrName-&gt;Buffer);
00434             <span class="keywordflow">goto</span> CreateFailed;
00435         }
00436 
00437         pDeviceInfo-&gt;ustrName.MaximumLength = pustrName-&gt;Length;
00438         <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;pDeviceInfo-&gt;ustrName, pustrName);
00439     }
00440 
00441     pDeviceInfo-&gt;type = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)DeviceType;
00442 
00443     <span class="comment">/*</span>
00444 <span class="comment">     * Create this device's HidChangeCompletion event. When the RIT completes</span>
00445 <span class="comment">     * a synchronous ProcessDeviceChanges() it signals the HidChangeCompletion</span>
00446 <span class="comment">     * event to wake the requesting RequestDeviceChange() which is blocking on</span>
00447 <span class="comment">     * the event.</span>
00448 <span class="comment">     * Each device has it's own HidChangeCompletion event,</span>
00449 <span class="comment">     * since multiple PnP notification may arrive  for several different</span>
00450 <span class="comment">     * devices simultaneously.  (see #331320 IanJa)</span>
00451 <span class="comment">     */</span>
00452     pDeviceInfo-&gt;pkeHidChangeCompleted = <a class="code" href="../../d4/d1/userk_8h.html#a965">CreateKernelEvent</a>(SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00453     <span class="keywordflow">if</span> (pDeviceInfo-&gt;pkeHidChangeCompleted == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00454         RIPMSG0(RIP_WARNING,
00455                 <span class="stringliteral">"CreateDeviceInfo: failed to create pkeHidChangeCompleted"</span>);
00456         <span class="keywordflow">goto</span> CreateFailed;
00457     }
00458 
00459     <span class="comment">/*</span>
00460 <span class="comment">     * Link it in</span>
00461 <span class="comment">     */</span>
00462     <a class="code" href="../../d4/d1/userk_8h.html#a2065">EnterDeviceInfoListCrit</a>();
00463     pDeviceInfo-&gt;pNext = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a>;
00464     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a> = pDeviceInfo;
00465     pDeviceInfo-&gt;bFlags |= bFlags;
00466 
00467     <span class="comment">/*</span>
00468 <span class="comment">     * Tell the RIT there is a new device so that it can open it and start</span>
00469 <span class="comment">     * reading from it.  This is non-blocking (no GDIAF_PNPWAITING bit set)</span>
00470 <span class="comment">     */</span>
00471     <a class="code" href="../../d4/d1/userk_8h.html#a992">RequestDeviceChange</a>(pDeviceInfo, <a class="code" href="../../d4/d1/userk_8h.html#a178">GDIAF_ARRIVED</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00472     <a class="code" href="../../d4/d1/userk_8h.html#a2066">LeaveDeviceInfoListCrit</a>();
00473 
00474     <a class="code" href="../../d4/d1/userk_8h.html#a167">EXITATOMICCHECK</a>();
00475     <span class="keywordflow">return</span> pDeviceInfo;
00476 
00477 CreateFailed:
00478 
00479     <span class="keywordflow">if</span> (pDeviceInfo) {
00480         <span class="keywordflow">if</span> (pDeviceInfo-&gt;ustrName.Buffer) {
00481             UserFreePool(pDeviceInfo-&gt;ustrName.Buffer);
00482         }
00483         UserFreePool(pDeviceInfo);
00484     }
00485 
00486     <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
00487     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00488 }
00489 
00490 
00491 <span class="comment">/***************************************************************************\</span>
00492 <span class="comment">* DeviceClassNotify</span>
00493 <span class="comment">*</span>
00494 <span class="comment">* This gets called when an input device is attached or detached.</span>
00495 <span class="comment">* If this happens during initialization (for mice already connected) we</span>
00496 <span class="comment">* come here by in the context of the RIT.  If hot-(un)plugging a mouse,</span>
00497 <span class="comment">* then we are called on a thread from the Kernel process.</span>
00498 <span class="comment">*</span>
00499 <span class="comment">* History:</span>
00500 <span class="comment">* 10-20-97  IanJa   Taken from some old code of KenRay's</span>
00501 <span class="comment">\***************************************************************************/</span>
00502 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00503"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a18">00503</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a18">DeviceClassNotify</a> (
00504     IN <a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html">PDEVICE_INTERFACE_CHANGE_NOTIFICATION</a> classChange,
00505     IN PVOID DeviceType <span class="comment">// (context)</span>
00506     )
00507 {
00508     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDeviceType;
00509 
00510     <a class="code" href="../../d4/d1/userk_8h.html#a157">CheckCritOut</a>();
00511     dwDeviceType = PtrToUlong( DeviceType );
00512     TAGMSG2(DBGTAG_PNP, <span class="stringliteral">"enter DeviceClassNotify(%lx, %lx)"</span>, classChange, dwDeviceType);
00513 
00514     <span class="comment">/*</span>
00515 <span class="comment">     * Sanity check the DeviceType, and that it matches the InterfaceClassGuid</span>
00516 <span class="comment">     */</span>
00517     UserAssert((dwDeviceType == <a class="code" href="../../d4/d1/userk_8h.html#a175">DEVICE_TYPE_MOUSE</a>) || (dwDeviceType == <a class="code" href="../../d4/d1/userk_8h.html#a176">DEVICE_TYPE_KEYBOARD</a>));
00518     UserAssert(IsEqualGUID(&amp;classChange-&gt;InterfaceClassGuid, <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[dwDeviceType].<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o1">pClassGUID</a>));
00519 
00520 
00521     TAGMSG3(DBGTAG_PNP | RIP_THERESMORE, <span class="stringliteral">" Event GUID %lx, %x, %x"</span>,
00522             classChange-&gt;Event.Data1,
00523             classChange-&gt;Event.Data2,
00524             classChange-&gt;Event.Data3);
00525     TAGMSG8(DBGTAG_PNP | RIP_THERESMORE, <span class="stringliteral">" %2x%2x%2x%2x%2x%2x%2x%2x"</span>,
00526             classChange-&gt;Event.Data4[0], classChange-&gt;Event.Data4[1],
00527             classChange-&gt;Event.Data4[2], classChange-&gt;Event.Data4[3],
00528             classChange-&gt;Event.Data4[4], classChange-&gt;Event.Data4[5],
00529             classChange-&gt;Event.Data4[6], classChange-&gt;Event.Data4[7]);
00530     TAGMSG4(DBGTAG_PNP | RIP_THERESMORE, <span class="stringliteral">" InterfaceClassGuid %lx, %lx, %lx, %lx"</span>,
00531             ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)&amp;(classChange-&gt;InterfaceClassGuid))[0],
00532             ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)&amp;(classChange-&gt;InterfaceClassGuid))[1],
00533             ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)&amp;(classChange-&gt;InterfaceClassGuid))[2],
00534             ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)&amp;(classChange-&gt;InterfaceClassGuid))[3]);
00535     TAGMSG1(DBGTAG_PNP | RIP_THERESMORE, <span class="stringliteral">" SymbolicLinkName %ws"</span>, classChange-&gt;SymbolicLinkName-&gt;Buffer);
00536 
00537     <span class="keywordflow">if</span> (IsEqualGUID(&amp;classChange-&gt;Event, &amp;GUID_DEVICE_INTERFACE_ARRIVAL)) {
00538 
00539         <span class="comment">// A new hid device class association has arrived</span>
00540         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00541         <a class="code" href="../../d4/d1/userk_8h.html#a1173">CreateDeviceInfo</a>(dwDeviceType, classChange-&gt;SymbolicLinkName, 0);
00542         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00543         TAGMSG0(DBGTAG_PNP, <span class="stringliteral">"=== CREATED ==="</span>);
00544     }
00545 
00546     <span class="keywordflow">return</span> STATUS_SUCCESS;
00547 }
00548 
00549 <span class="comment">/****************************************************************************\</span>
00550 <span class="comment">* If a device class "all-for-one" setting (ConnectMultiplePorts) is on,</span>
00551 <span class="comment">* then we just open the device the old (non-PnP) way and return TRUE.  (As a</span>
00552 <span class="comment">* safety feature we also do this if gpWin32kDriverObject is NULL, because this</span>
00553 <span class="comment">* driver object is needed to register for PnP device class notifications)</span>
00554 <span class="comment">* Otherwise, return FALSE so we can continue and register for Arrival/Departure</span>
00555 <span class="comment">* notifications.</span>
00556 <span class="comment">*</span>
00557 <span class="comment">* This code was originally intended to be temporary until ConnectMultiplePorts</span>
00558 <span class="comment">* was finally turned off.</span>
00559 <span class="comment">* But now I think we have to keep it for backward compatibility with</span>
00560 <span class="comment">* drivers that filter Pointer/KeyboardClass0 and/or those that replace</span>
00561 <span class="comment">* Pointer/KeyboardClass0 by putting a different name in the registry under</span>
00562 <span class="comment">* System\CurrentControlSet\Services\RIT\mouclass (or kbbclass)</span>
00563 <span class="comment">\****************************************************************************/</span>
00564 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00565"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a19">00565</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a19">OpenMultiplePortDevice</a>(DWORD DeviceType)
00566 {
00567     WCHAR awchDeviceName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00568     UNICODE_STRING DeviceName;
00569     <a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html">PDEVICE_TEMPLATE</a> pDevTpl;
00570     <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo;
00571     PWCHAR pwchNameIndex;
00572 
00573     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uiConnectMultiplePorts = 0;
00574 
00575     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00576 
00577     <span class="keywordflow">if</span> (DeviceType &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a177">DEVICE_TYPE_MAX</a>) {
00578         pDevTpl = &amp;<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[DeviceType];
00579     } <span class="keywordflow">else</span> {
00580         RIPMSG1(RIP_ERROR, <span class="stringliteral">"OpenMultiplePortDevice(%d) - unknown type"</span>, DeviceType);
00581         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00582     }
00583 
00584     <span class="comment">/*</span>
00585 <span class="comment">     * Note that we don't need to FastOpenUserProfileMapping() here since</span>
00586 <span class="comment">     * uiRegistrySection (PMAP_MOUCLASS_PARAMS/PMAP_KBDCLASS_PARAMS) is a</span>
00587 <span class="comment">     * machine setiing, not a user setting.</span>
00588 <span class="comment">     */</span>
00589     uiConnectMultiplePorts = <a class="code" href="../../d4/d1/userk_8h.html#a2006">FastGetProfileDwordW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00590             pDevTpl-&gt;<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o2">uiRegistrySection</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ConnectMultiplePorts"</span>, 0);
00591 
00592     <span class="comment">/*</span>
00593 <span class="comment">     * Open the device for read access.</span>
00594 <span class="comment">     */</span>
00595     <span class="keywordflow">if</span> (uiConnectMultiplePorts || (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a207">gpWin32kDriverObject</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00596         <span class="comment">/*</span>
00597 <span class="comment">         * Find out if there is a name substitution in the registry.</span>
00598 <span class="comment">         * Note that we don't need to FastOpenUserProfileMapping() here since</span>
00599 <span class="comment">         * PMAP_INPUT is a machine setting, not a user setting.</span>
00600 <span class="comment">         */</span>
00601         <a class="code" href="../../d4/d1/userk_8h.html#a2007">FastGetProfileStringW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00602                 <a class="code" href="../../d4/d1/userk_8h.html#a703">PMAP_INPUT</a>,
00603                 pDevTpl-&gt;<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o3">pwszClassName</a>,
00604                 pDevTpl-&gt;<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o4">pwszDefDevName</a>, <span class="comment">// if no substitution, use this default</span>
00605                 awchDeviceName,
00606                 <span class="keyword">sizeof</span>(awchDeviceName)/<span class="keyword">sizeof</span>(WCHAR));
00607 
00608         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;DeviceName, awchDeviceName);
00609 
00610         pDeviceInfo = <a class="code" href="../../d4/d1/userk_8h.html#a1173">CreateDeviceInfo</a>(DeviceType, &amp;DeviceName, <a class="code" href="../../d4/d1/userk_8h.html#a188">GDIF_NOTPNP</a>);
00611         <span class="keywordflow">if</span> (pDeviceInfo) {
00612             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00613         }
00614     } <span class="keywordflow">else</span> {
00615         DeviceName.Length = 0;
00616         DeviceName.MaximumLength = <span class="keyword">sizeof</span>(awchDeviceName);
00617         DeviceName.Buffer = awchDeviceName;
00618 
00619         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;DeviceName, pDevTpl-&gt;<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o5">pwszLegacyDevName</a>);
00620         pwchNameIndex = &amp;DeviceName.Buffer[(DeviceName.Length / <span class="keyword">sizeof</span>(WCHAR)) - 1];
00621         <span class="keywordflow">for</span> (*pwchNameIndex = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>; *pwchNameIndex &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'9'</span>; (*pwchNameIndex)++) {
00622             <a class="code" href="../../d4/d1/userk_8h.html#a1173">CreateDeviceInfo</a>(DeviceType, &amp;DeviceName, <a class="code" href="../../d4/d1/userk_8h.html#a188">GDIF_NOTPNP</a>);
00623         }
00624     }
00625 
00626     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00627 }
00628 
00629 
00630 <span class="comment">/***************************************************************************\</span>
00631 <span class="comment">* RegisterForDeviceClassNotifications</span>
00632 <span class="comment">*   Get ready to receive notifications that a mouse or keyboard is plugged in</span>
00633 <span class="comment">*   or removed, then request notifications by registering for them.</span>
00634 <span class="comment">*</span>
00635 <span class="comment">* History:</span>
00636 <span class="comment">* 10-20-97  IanJa   Taken from ntos\io\pnpinit.c</span>
00637 <span class="comment">\***************************************************************************/</span>
00638 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00639"></a><a class="code" href="../../d4/d1/userk_8h.html#a1167">00639</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a20">xxxRegisterForDeviceClassNotifications</a>()
00640 {
00641     <a class="code" href="../../d6/d9/pnp_8h.html#a49">IO_NOTIFICATION_EVENT_CATEGORY</a> eventCategory;
00642     ULONG                          eventFlags;
00643     PVOID                          RegistrationEntry;
00644     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00645     UNICODE_STRING                 ustrDriverName;
00646     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                          DeviceType;
00647 
00648 
00649 
00650     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00651 
00652     TAGMSG0(DBGTAG_PNP, <span class="stringliteral">"enter xxxRegisterForDeviceClassNotifications()"</span>);
00653 
00654     <span class="comment">/*</span>
00655 <span class="comment">     * Remote hydra session indicates CreateDeviceInfo in xxxRemoteReconnect</span>
00656 <span class="comment">     */</span>
00657     UserAssert(!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>);
00658 
00659     <span class="comment">/*</span>
00660 <span class="comment">     * This must be done before devices are registered for device notifications</span>
00661 <span class="comment">     * which will occur as a result of CreateDeviceInfo()...</span>
00662 <span class="comment">     */</span>
00663     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ustrDriverName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Driver\\Win32k"</span>);
00664     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a76">IoCreateDriver</a>(&amp;ustrDriverName, <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a10">Win32kPnPDriverEntry</a>);
00665 
00666     TAGMSG1(DBGTAG_PNP | RIP_THERESMORE, <span class="stringliteral">"IoCreateDriver returned status = %lx"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00667     TAGMSG1(DBGTAG_PNP, <span class="stringliteral">"gpWin32kDriverObject = %lx"</span>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a207">gpWin32kDriverObject</a>);
00668 
00669     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00670         RIPMSG1(RIP_ERROR, <span class="stringliteral">"IoCreateDriver failed, status %lx"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00671         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00672     }
00673 
00674     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a207">gpWin32kDriverObject</a>);
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">// We are only interested in DeviceClasses changing.</span>
00678     <span class="comment">//</span>
00679     eventCategory = <a class="code" href="../../d6/d9/pnp_8h.html#a172a113">EventCategoryDeviceInterfaceChange</a>;
00680 
00681     <span class="comment">//</span>
00682     <span class="comment">// We want to be notified for all devices that are in the system.</span>
00683     <span class="comment">// those that are know now, and those that will arive later.</span>
00684     <span class="comment">// This allows us to have one code path for adding devices, and eliminates</span>
00685     <span class="comment">// the nasty race condition.  If we were only interested in the devices</span>
00686     <span class="comment">// that exist at this one moment in time, and not future devices, we</span>
00687     <span class="comment">// would call IoGetDeviceClassAssociations.</span>
00688     <span class="comment">//</span>
00689     eventFlags = <a class="code" href="../../d6/d9/pnp_8h.html#a6">PNPNOTIFY_DEVICE_INTERFACE_INCLUDE_EXISTING_INTERFACES</a>;
00690 
00691     <span class="comment">/*</span>
00692 <span class="comment">     * For all input device types:</span>
00693 <span class="comment">     *  If they are Multiple Port Devices (ie: not PnP) just open them</span>
00694 <span class="comment">     *  Else Register them for PnP notifications (they will be opened when the</span>
00695 <span class="comment">     *       arrival notification arrives.</span>
00696 <span class="comment">     * If devices are already attached, we will received immediate notification</span>
00697 <span class="comment">     * during the call to IoRegisterPlugPlayNotification, so we must LeaveCrit</span>
00698 <span class="comment">     * because the callback routine DeviceClassNotify expects it.</span>
00699 <span class="comment">     */</span>
00700     <span class="keywordflow">for</span> (DeviceType = 0; DeviceType &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a177">DEVICE_TYPE_MAX</a>; DeviceType++) {
00701         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a19">OpenMultiplePortDevice</a>(DeviceType)) {
00702             <span class="comment">/*</span>
00703 <span class="comment">             * Make the registration</span>
00704 <span class="comment">             */</span>
00705 
00706             TAGMSG1(DBGTAG_PNP, <span class="stringliteral">"Registering device type %d"</span>, DeviceType);
00707             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>(); <span class="comment">// for DeviceClassNotify</span>
00708             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a106">IoRegisterPlugPlayNotification</a> (
00709                          eventCategory,
00710                          eventFlags,
00711                          (PVOID)<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[DeviceType].pClassGUID,
00712                          <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a207">gpWin32kDriverObject</a>,
00713                          (<a class="code" href="../../d6/d9/pnp_8h.html#a50">PDRIVER_NOTIFICATION_CALLBACK_ROUTINE</a>)<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a18">DeviceClassNotify</a>,
00714                          LongToPtr( DeviceType ),
00715                          &amp;RegistrationEntry);
00716             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00717             TAGMSG1(DBGTAG_PNP, <span class="stringliteral">"Registration returned status %lx"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00718             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00719                 RIPMSG2(RIP_ERROR, <span class="stringliteral">"IoRegisterPlugPlayNotification(%d) failed, status %lx"</span>,
00720                         DeviceType, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00721             }
00722         }
00723     }
00724 
00725     <span class="comment">// Now Register for CD_ROM notifications</span>
00726     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>(); <span class="comment">// for DeviceClassNotify</span>
00727 
00728     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a106">IoRegisterPlugPlayNotification</a> (
00729                  eventCategory,
00730                  eventFlags,
00731                  (PVOID) &amp;CdRomClassGuid,
00732                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a207">gpWin32kDriverObject</a>,
00733                  (<a class="code" href="../../d6/d9/pnp_8h.html#a50">PDRIVER_NOTIFICATION_CALLBACK_ROUTINE</a>)<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a16">DeviceClassCDROMNotify</a>,
00734                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00735                  &amp;RegistrationEntry);
00736     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00737 
00738 
00739 
00740     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00741 }
00742 
00743 
00744 
00745 <span class="comment">/***************************************************************************\</span>
00746 <span class="comment">* QueryDeviceInfo</span>
00747 <span class="comment">*</span>
00748 <span class="comment">* Query the device information.  This function is an async function,</span>
00749 <span class="comment">* so be sure any buffers it uses aren't allocated on the stack!</span>
00750 <span class="comment">*</span>
00751 <span class="comment">* If this is an asynchronous IOCTL, perhaps we should be waiting on</span>
00752 <span class="comment">* the file handle or on an event for it to succeed?</span>
00753 <span class="comment">*</span>
00754 <span class="comment">* This function must called by the RIT, not directly by PnP notification</span>
00755 <span class="comment">* (else the handle we issue the IOCTL on will be invalid)</span>
00756 <span class="comment">*</span>
00757 <span class="comment">* History:</span>
00758 <span class="comment">* 01-20-99 IanJa        Created.</span>
00759 <span class="comment">\***************************************************************************/</span>
00760 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00761"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a21">00761</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a21">QueryDeviceInfo</a>(
00762     <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo)
00763 {
00764     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00765     <a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html">PDEVICE_TEMPLATE</a> pDevTpl = &amp;<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[pDeviceInfo-&gt;type];
00766 
00767 <span class="preprocessor">#ifdef DIAGNOSE_IO</span>
00768 <span class="preprocessor"></span>    pDeviceInfo-&gt;AttrStatus =
00769 <span class="preprocessor">#endif</span>
00770 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeviceIoControlFile(pDeviceInfo-&gt;handle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00771                  &amp;pDeviceInfo-&gt;iosb,
00772                  pDevTpl-&gt;<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o6">IOCTL_Attr</a>,
00773                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
00774                  (PVOID)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pDeviceInfo + pDevTpl-&gt;<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o7">offAttr</a>),
00775                  pDevTpl-&gt;<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o8">cbAttr</a>);
00776 
00777     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00778         RIPMSG2(RIP_WARNING, <span class="stringliteral">"QueryDeviceInfo(%p): IOCTL failed - Status %lx"</span>,
00779                 pDeviceInfo, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00780     }
00781     TAGMSG1(DBGTAG_PNP, <span class="stringliteral">"IOCTL_*_QUERY_ATTRIBUTES returns Status %lx"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00782     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00783 }
00784 
00785 
00786 <span class="comment">/***************************************************************************\</span>
00787 <span class="comment">* OpenDevice</span>
00788 <span class="comment">*</span>
00789 <span class="comment">* This function opens an input device for USER, mouse or keyboard.</span>
00790 <span class="comment">*</span>
00791 <span class="comment">*</span>
00792 <span class="comment">* Return value</span>
00793 <span class="comment">*   BOOL did the operation succeed?</span>
00794 <span class="comment">*</span>
00795 <span class="comment">* When trying to open a HYDRA client's mouse (or kbd?), pDeviceInfo-&gt;ustrName</span>
00796 <span class="comment">* is NULL.</span>
00797 <span class="comment">*</span>
00798 <span class="comment">* This function must called by the RIT, not directly by PnP</span>
00799 <span class="comment">* notification (that way the handle we are about to create will be in the right</span>
00800 <span class="comment">* our process)</span>
00801 <span class="comment">*</span>
00802 <span class="comment">* History:</span>
00803 <span class="comment">* 11-26-90 DavidPe      Created.</span>
00804 <span class="comment">* 01-07-98 IanJa        Plug &amp; Play</span>
00805 <span class="comment">* 04-17-98 IanJa        Only open mice in RIT context.</span>
00806 <span class="comment">\***************************************************************************/</span>
<a name="l00807"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a22">00807</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a22">OpenDevice</a>(<a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo)
00808 {
00809     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00810     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00811 
00812     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00813     UserAssert((<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>) || (<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a239">gTermIO</a>.<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>));
00814 
00815     TAGMSG3(DBGTAG_PNP, <span class="stringliteral">"OpenDevice(): Opening type %d (%lx %ws)"</span>,
00816             pDeviceInfo-&gt;type, pDeviceInfo-&gt;handle, pDeviceInfo-&gt;ustrName.Buffer);
00817 
00818 <span class="preprocessor">#ifdef DIAGNOSE_IO</span>
00819 <span class="preprocessor"></span>    pDeviceInfo-&gt;OpenerProcess = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess;
00820 <span class="preprocessor">#endif</span>
00821 <span class="preprocessor"></span>
00822     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
00823 
00824         <span class="comment">/*</span>
00825 <span class="comment">         * For other than the console, the mouse handle is</span>
00826 <span class="comment">         * set before createwinstation.</span>
00827 <span class="comment">         */</span>
00828         UserAssert(pDeviceInfo-&gt;ustrName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00829 
00830         pDeviceInfo-&gt;bFlags |= <a class="code" href="../../d4/d1/userk_8h.html#a188">GDIF_NOTPNP</a>;
00831 
00832         <span class="keywordflow">switch</span> (pDeviceInfo-&gt;type) {
00833         <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a175">DEVICE_TYPE_MOUSE</a>:
00834             pDeviceInfo-&gt;handle = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a334">ghRemoteMouseChannel</a>;
00835             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a334">ghRemoteMouseChannel</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00836                <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00837             }
00838             <span class="keywordflow">break</span>;
00839         <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a176">DEVICE_TYPE_KEYBOARD</a>:
00840             pDeviceInfo-&gt;handle = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a337">ghRemoteKeyboardChannel</a>;
00841             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a337">ghRemoteKeyboardChannel</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00842                <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00843             }
00844             <span class="keywordflow">break</span>;
00845         <span class="keywordflow">default</span>:
00846             RIPMSG2(RIP_ERROR, <span class="stringliteral">"Unknown device type %d DeviceInfo %#p"</span>,
00847                     pDeviceInfo-&gt;type, pDeviceInfo);
00848             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00849         }
00850     } <span class="keywordflow">else</span> {
00851         InitializeObjectAttributes(&amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, &amp;(pDeviceInfo-&gt;ustrName), 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00852 
00853 <span class="preprocessor">#ifdef DIAGNOSE_IO</span>
00854 <span class="preprocessor"></span>        pDeviceInfo-&gt;OpenStatus =
00855 <span class="preprocessor">#endif</span>
00856 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>(&amp;pDeviceInfo-&gt;handle, FILE_READ_DATA | SYNCHRONIZE,
00857                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, &amp;pDeviceInfo-&gt;iosb, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, FILE_SHARE_WRITE, FILE_OPEN_IF, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00858 
00859         TAGMSG2(DBGTAG_PNP, <span class="stringliteral">"ZwCreateFile returns handle %lx, Status %lx"</span>,
00860                 pDeviceInfo-&gt;handle, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00861 
00862         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00863             <span class="keywordflow">if</span> ((pDeviceInfo-&gt;bFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a188">GDIF_NOTPNP</a>) == 0) {
00864                 <span class="comment">/*</span>
00865 <span class="comment">                 * Don't warn about PS/2 mice: the PointerClassLegacy0 -9 and</span>
00866 <span class="comment">                 * KeyboardClassLegacy0 - 9 will usually fail to be created</span>
00867 <span class="comment">                 */</span>
00868                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"OpenDevice: ZwCreateFile failed with Status %lx"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00869             }
00870             <span class="comment">/*</span>
00871 <span class="comment">             * Don't FreeDeviceInfo here because that alters gpDeviceInfoList</span>
00872 <span class="comment">             * which our caller, ProcessDeviceChanges, is traversing.</span>
00873 <span class="comment">             * Instead, let ProcessDeviceChanges do it.</span>
00874 <span class="comment">             */</span>
00875             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00876         }
00877     }
00878 
00879     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a21">QueryDeviceInfo</a>(pDeviceInfo);
00880 
00881 
00882     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00883 }
00884 
<a name="l00885"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a23">00885</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a23">CloseDevice</a>(<a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo)
00886 {
00887     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00888     IO_STATUS_BLOCK IoStatusBlock;
00889     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00890 
00891 
00892     TAGMSG3(DBGTAG_PNP, <span class="stringliteral">"CloseDevice(): closing type %d (%lx %ws)"</span>,
00893             pDeviceInfo-&gt;type, pDeviceInfo-&gt;handle, pDeviceInfo-&gt;ustrName.Buffer);
00894     <span class="keywordflow">if</span> (pDeviceInfo-&gt;handle) {
00895         UserAssert(pDeviceInfo-&gt;OpenerProcess == <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess);
00896         ZwCancelIoFile(pDeviceInfo-&gt;handle, &amp;IoStatusBlock);
00897         UserAssertMsg2(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatusBlock.Status), <span class="stringliteral">"NtCancelIoFile handle %x failed status %#x"</span>,
00898                  pDeviceInfo-&gt;handle, IoStatusBlock.Status);
00899         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwClose(pDeviceInfo-&gt;handle);
00900         UserAssertMsg2(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>), <span class="stringliteral">"ZwClose handle %x failed status %#x"</span>,
00901                 pDeviceInfo-&gt;handle, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00902         pDeviceInfo-&gt;handle = 0;
00903     } <span class="keywordflow">else</span> {
00904         <span class="comment">/*</span>
00905 <span class="comment">         * Assert the IO was cancelled or we tried to read the device</span>
00906 <span class="comment">         * after the first close (which set the handle to 0 - an invalid handle)</span>
00907 <span class="comment">         */</span>
00908         UserAssert((pDeviceInfo-&gt;iosb.Status == STATUS_CANCELLED) ||
00909                    (pDeviceInfo-&gt;ReadStatus == STATUS_INVALID_HANDLE));
00910     }
00911 }
00912 
00913 <span class="comment">/*****************************************************************************\</span>
00914 <span class="comment">* RegisterForDeviceChangeNotifications()</span>
00915 <span class="comment">*</span>
00916 <span class="comment">* Device Notifications such as QueryRemove, RemoveCancelled, RemoveComplete</span>
00917 <span class="comment">* tell us what is going on with the mouse.</span>
00918 <span class="comment">* To register for device notifications:</span>
00919 <span class="comment">* (1) Obtain a pointer to the device object (pFileObject)</span>
00920 <span class="comment">* (2) Register for target device change notifications, saving the</span>
00921 <span class="comment">*     notification handle (which we will need in order to deregister)</span>
00922 <span class="comment">*</span>
00923 <span class="comment">* It doesn't matter too much if this fails: we just won't be able to eject the</span>
00924 <span class="comment">* hardware via the UI very successfully. (We can still just yank it though).</span>
00925 <span class="comment">* This will also fail if the ConnectMultiplePorts was set for this device.</span>
00926 <span class="comment">*</span>
00927 <span class="comment">* 1998-10-05 IanJa    Created</span>
00928 <span class="comment">\*****************************************************************************/</span>
<a name="l00929"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a24">00929</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a24">RegisterForDeviceChangeNotifications</a>(<a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo)
00930 {
00931     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> pFileObject;
00932     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00933 
00934     <span class="comment">/*</span>
00935 <span class="comment">     * In or Out of User critical section:</span>
00936 <span class="comment">     * In when called from RIT ProcessDeviceChanges();</span>
00937 <span class="comment">     * Out when called from the DeviceNotify callback</span>
00938 <span class="comment">     */</span>
00939     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00940     UserAssert((<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>) || (<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a239">gTermIO</a>.<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>));
00941     UserAssert(pDeviceInfo-&gt;handle);
00942     UserAssert(pDeviceInfo-&gt;OpenerProcess == <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess);
00943 
00944     <span class="keywordflow">if</span> (pDeviceInfo-&gt;bFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a188">GDIF_NOTPNP</a>) {
00945         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00946     }
00947     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(pDeviceInfo-&gt;handle,
00948                                        0,
00949                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00950                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00951                                        (PVOID)&amp;pFileObject,
00952                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00953     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00954         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a106">IoRegisterPlugPlayNotification</a> (
00955                 <a class="code" href="../../d6/d9/pnp_8h.html#a172a114">EventCategoryTargetDeviceChange</a>,  <span class="comment">// EventCategory</span>
00956                 0,                                <span class="comment">// EventCategoryFlags</span>
00957                 (PVOID)pFileObject,               <span class="comment">// EventCategoryData</span>
00958                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a207">gpWin32kDriverObject</a>,             <span class="comment">// DriverObject</span>
00959                 <span class="comment">// (PDRIVER_NOTIFICATION_CALLBACK_ROUTINE)</span>
00960                 <a class="code" href="../../d6/d8/ntinput_8c.html#a41">DeviceNotify</a>,
00961                 (PVOID)pDeviceInfo,                       <span class="comment">// Context</span>
00962                 &amp;pDeviceInfo-&gt;NotificationEntry);
00963         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pFileObject);
00964         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00965             <span class="comment">// This is only OK if ConnectMultiplePorts is on (ie: not a PnP device)</span>
00966             RIPMSG3(RIP_ERROR,
00967                     <span class="stringliteral">"IoRegisterPlugPlayNotification failed on device %.*ws, status %lx, email DoronH : #333453"</span>,
00968                     pDeviceInfo-&gt;ustrName.Length / <span class="keyword">sizeof</span>(WCHAR),
00969                     pDeviceInfo-&gt;ustrName.Buffer, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00970         }
00971     } <span class="keywordflow">else</span> {
00972         <span class="comment">// non-catastrophic error (won't be able to remove device)</span>
00973         RIPMSG2(RIP_ERROR, <span class="stringliteral">"Can't get pFileObject from handle %lx, status %lx"</span>,
00974                 pDeviceInfo-&gt;handle, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00975     }
00976 
00977     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00978 }
00979 
00980 
<a name="l00981"></a><a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a25">00981</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a25">UnregisterForDeviceChangeNotifications</a>(<a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo)
00982 {
00983     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00984 
00985     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00986     UserAssert((<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>) || (<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a239">gTermIO</a>.<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>));
00987     UserAssert(pDeviceInfo-&gt;NotificationEntry);
00988     UserAssert(pDeviceInfo-&gt;OpenerProcess == <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess);
00989 
00990     <span class="keywordflow">if</span> (pDeviceInfo-&gt;NotificationEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00991         <span class="comment">/*</span>
00992 <span class="comment">         * This happens for non-PnP devices or if the earlier</span>
00993 <span class="comment">         * IoRegisterPlugPlayNotification() failed.  Return now since</span>
00994 <span class="comment">         * IoUnregisterPlugPlayNotification(NULL) will bluescreen.</span>
00995 <span class="comment">         */</span>
00996         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00997     }
00998 
00999     <span class="comment">// non-PnP devices should not have any NotificationEntry:</span>
01000     UserAssert((pDeviceInfo-&gt;bFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a188">GDIF_NOTPNP</a>) == 0);
01001 
01002     TAGMSG3(DBGTAG_PNP, <span class="stringliteral">"UnregisterForDeviceChangeNotifications(): type %d (%lx %ws)"</span>,
01003             pDeviceInfo-&gt;type, pDeviceInfo, pDeviceInfo-&gt;ustrName.Buffer);
01004     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a96">IoUnregisterPlugPlayNotification</a>(pDeviceInfo-&gt;NotificationEntry);
01005     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01006         RIPMSG2(RIP_ERROR,
01007                 <span class="stringliteral">"IoUnregisterPlugPlayNotification failed Status = %lx, DEVICEINFO %lx"</span>,
01008                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, pDeviceInfo);
01009         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01010     }
01011     pDeviceInfo-&gt;NotificationEntry = 0;
01012     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01013 }
01014 
01015 
01016 <span class="comment">/***************************************************************************\</span>
01017 <span class="comment">* Handle device notifications such as QueryRemove, CancelRemove etc.</span>
01018 <span class="comment">*</span>
01019 <span class="comment">* Execution Context:</span>
01020 <span class="comment">*    when yanked:  a non-WIN32 thread.</span>
01021 <span class="comment">*    via UI:       ??? (won't see this except from laptop being undocked?)</span>
01022 <span class="comment">*</span>
01023 <span class="comment">* History:</span>
01024 <span class="comment">\***************************************************************************/</span>
<a name="l01025"></a><a class="code" href="../../d4/d1/userk_8h.html#a1030">01025</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1030">DeviceNotify</a>(
01026     IN PPLUGPLAY_NOTIFY_HDR pNotification,
01027     IN <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo)  <span class="comment">// should the context be a kernel address?</span>
01028 {
01029     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> usAction;
01030 
01031 <span class="preprocessor">#if DBG</span>
01032 <span class="preprocessor"></span>    {
01033         <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfoDbg;
01034         <span class="keywordflow">for</span> (pDeviceInfoDbg = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a>; pDeviceInfoDbg; pDeviceInfoDbg = pDeviceInfoDbg-&gt;pNext) {
01035             <span class="keywordflow">if</span> (pDeviceInfoDbg == pDeviceInfo) {
01036                 <span class="keywordflow">break</span>;
01037             }
01038         }
01039         UserAssertMsg1(pDeviceInfoDbg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="stringliteral">"Notification for unlisted DEVICEINFO %lx"</span>, pDeviceInfo);
01040     }
01041 <span class="preprocessor">#endif</span>
01042 <span class="preprocessor"></span>
01043     <a class="code" href="../../d4/d1/userk_8h.html#a157">CheckCritOut</a>();
01044 
01045     UserAssert(!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>);
01046 
01047     TAGMSG1(DBGTAG_PNP | RIP_THERESMORE, <span class="stringliteral">"DeviceNotify &gt;&gt;&gt; %lx"</span>, pDeviceInfo);
01048 
01049     UserAssert(pDeviceInfo-&gt;OpenerProcess != <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess);
01050     UserAssert(pDeviceInfo-&gt;usActions == 0);
01051 
01052     <span class="keywordflow">if</span> (IsEqualGUID(&amp;pNotification-&gt;Event, &amp;GUID_TARGET_DEVICE_QUERY_REMOVE)) {
01053         TAGMSG0(DBGTAG_PNP | RIP_NONAME, <span class="stringliteral">"QueryRemove"</span>);
01054         usAction = <a class="code" href="../../d4/d1/userk_8h.html#a179">GDIAF_QUERYREMOVE</a>;
01055 
01056     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsEqualGUID(&amp;pNotification-&gt;Event, &amp;GUID_TARGET_DEVICE_REMOVE_CANCELLED)) {
01057         TAGMSG0(DBGTAG_PNP | RIP_NONAME, <span class="stringliteral">"RemoveCancelled"</span>);
01058         usAction = <a class="code" href="../../d4/d1/userk_8h.html#a180">GDIAF_REMOVECANCELLED</a>;
01059 
01060     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsEqualGUID(&amp;pNotification-&gt;Event, &amp;GUID_TARGET_DEVICE_REMOVE_COMPLETE)) {
01061         TAGMSG1(DBGTAG_PNP | RIP_NONAME, <span class="stringliteral">"RemoveComplete (process %#x)"</span>, <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess);
01062         usAction = <a class="code" href="../../d4/d1/userk_8h.html#a181">GDIAF_DEPARTED</a>;
01063 
01064     } <span class="keywordflow">else</span> {
01065         TAGMSG4(DBGTAG_PNP | RIP_NONAME, <span class="stringliteral">"GUID Unknown: %lx:%lx:%lx:%x..."</span>,
01066                 pNotification-&gt;Event.Data1, pNotification-&gt;Event.Data2,
01067                 pNotification-&gt;Event.Data3, pNotification-&gt;Event.Data4[0]);
01068         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01069     }
01070 
01071     <span class="comment">/*</span>
01072 <span class="comment">     * Signal the RIT to ProcessDeviceChanges()</span>
01073 <span class="comment">     * Wait for completion according to the GDIAF_PNPWAITING bit</span>
01074 <span class="comment">     */</span>
01075     <a class="code" href="../../d4/d1/userk_8h.html#a157">CheckCritOut</a>();
01076     <a class="code" href="../../d4/d1/userk_8h.html#a158">CheckDeviceInfoListCritOut</a>();
01077     <a class="code" href="../../d4/d1/userk_8h.html#a992">RequestDeviceChange</a>(pDeviceInfo, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(usAction | <a class="code" href="../../d4/d1/userk_8h.html#a185">GDIAF_PNPWAITING</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01078 
01079     <span class="keywordflow">return</span> STATUS_SUCCESS;
01080 }
01081 
01082 
01083 <span class="comment">/***************************************************************************\</span>
01084 <span class="comment">* StartDeviceRead</span>
01085 <span class="comment">*</span>
01086 <span class="comment">* This function makes an asynchronous read request to the input device driver,</span>
01087 <span class="comment">* unless the device has been marked for destruction (GDIAF_FREEME)</span>
01088 <span class="comment">*</span>
01089 <span class="comment">* Returns:</span>
01090 <span class="comment">*   The next DeviceInfo on the list if this device was freed: If the caller</span>
01091 <span class="comment">*   was not already in the DeviceInfoList critical section, the this must be</span>
01092 <span class="comment">*   ignored as it is not safe.</span>
01093 <span class="comment">*   NULL if the read succeeded.</span>
01094 <span class="comment">*</span>
01095 <span class="comment">* History:</span>
01096 <span class="comment">* 11-26-90 DavidPe      Created.</span>
01097 <span class="comment">* 10-20-98 IanJa        Generalized for PnP input devices</span>
01098 <span class="comment">\***************************************************************************/</span>
<a name="l01099"></a><a class="code" href="../../d4/d1/userk_8h.html#a1029">01099</a> <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> <a class="code" href="../../d4/d1/userk_8h.html#a1029">StartDeviceRead</a>(
01100     <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo)
01101 {
01102     <a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html">PDEVICE_TEMPLATE</a> pDevTpl;
01103 
01104     pDeviceInfo-&gt;bFlags |= <a class="code" href="../../d4/d1/userk_8h.html#a189">GDIF_READING</a>;
01105 
01106     <span class="comment">/*</span>
01107 <span class="comment">     * If this device needs freeing, abandon reading now and request the free.</span>
01108 <span class="comment">     */</span>
01109     <span class="keywordflow">if</span> (pDeviceInfo-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a184">GDIAF_FREEME</a>) {
01110         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fPreviouslyAcquired = <a class="code" href="../../d5/d8/ex_8h.html#a281">ExIsResourceAcquiredExclusiveLite</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a206">gpresDeviceInfoList</a>);
01111         <span class="keywordflow">if</span> (!fPreviouslyAcquired) {
01112             <a class="code" href="../../d4/d1/userk_8h.html#a2065">EnterDeviceInfoListCrit</a>();
01113         }
01114         pDeviceInfo-&gt;bFlags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a189">GDIF_READING</a>;
01115         pDeviceInfo = <a class="code" href="../../d4/d1/userk_8h.html#a1032">FreeDeviceInfo</a>(pDeviceInfo);
01116         <span class="keywordflow">if</span> (!fPreviouslyAcquired) {
01117             <a class="code" href="../../d4/d1/userk_8h.html#a2066">LeaveDeviceInfoListCrit</a>();
01118         }
01119         <span class="keywordflow">return</span> pDeviceInfo;
01120     }
01121 
01122     <span class="comment">/*</span>
01123 <span class="comment">     * Initialize in case read fails</span>
01124 <span class="comment">     */</span>
01125     pDeviceInfo-&gt;iosb.Status = STATUS_UNSUCCESSFUL; <span class="comment">// catch concurrent writes?</span>
01126     pDeviceInfo-&gt;iosb.Information = 0;
01127 
01128     pDevTpl = &amp;<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[pDeviceInfo-&gt;type];
01129 
01130     UserAssert(pDeviceInfo-&gt;OpenerProcess == <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess);
01131     <a class="code" href="../../d4/d1/userk_8h.html#a171">LOGTIME</a>(pDeviceInfo-&gt;timeStartRead);
01132 <span class="preprocessor">#ifdef DIAGNOSE_IO</span>
01133 <span class="preprocessor"></span>    pDeviceInfo-&gt;nReadsOutstanding++;
01134 <span class="preprocessor">#endif</span>
01135 <span class="preprocessor"></span>    pDeviceInfo-&gt;ReadStatus = ZwReadFile(
01136             pDeviceInfo-&gt;handle,
01137             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                <span class="comment">// hReadEvent</span>
01138             <a class="code" href="../../d6/d8/ntinput_8c.html#a48">InputApc</a>,            <span class="comment">// InputApc()</span>
01139             pDeviceInfo,         <span class="comment">// ApcContext</span>
01140             &amp;pDeviceInfo-&gt;iosb,
01141             (PVOID)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pDeviceInfo + pDevTpl-&gt;<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o9">offData</a>),
01142             pDevTpl-&gt;<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o10">cbData</a>,
01143             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a6">PZERO</a>(LARGE_INTEGER), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01144     <a class="code" href="../../d4/d1/userk_8h.html#a171">LOGTIME</a>(pDeviceInfo-&gt;timeEndRead);
01145 
01146 <span class="preprocessor">#if DBG</span>
01147 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (pDeviceInfo-&gt;bFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a192">GDIF_DBGREAD</a>) {
01148         TAGMSG2(DBGTAG_PNP, <span class="stringliteral">"ZwReadFile of Device handle %lx returned status %lx"</span>,
01149                 pDeviceInfo-&gt;handle, pDeviceInfo-&gt;ReadStatus);
01150     }
01151 <span class="preprocessor">#endif</span>
01152 <span class="preprocessor"></span>
01153     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(pDeviceInfo-&gt;ReadStatus)) {
01154         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fPreviouslyAcquired = <a class="code" href="../../d5/d8/ex_8h.html#a281">ExIsResourceAcquiredExclusiveLite</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a206">gpresDeviceInfoList</a>);
01155         <span class="keywordflow">if</span> (!fPreviouslyAcquired) {
01156             <a class="code" href="../../d4/d1/userk_8h.html#a2065">EnterDeviceInfoListCrit</a>();
01157         }
01158 
01159         <span class="comment">/*</span>
01160 <span class="comment">         * If insufficient resources, retry the read the next time the RIT</span>
01161 <span class="comment">         * wakes up for the ID_TIMER event by incrementing gnRetryReadInput</span>
01162 <span class="comment">         * (Cheaper than setting our own timer),</span>
01163 <span class="comment">         * Else just abandon reading.</span>
01164 <span class="comment">         */</span>
01165         <span class="keywordflow">if</span> (pDeviceInfo-&gt;ReadStatus == STATUS_INSUFFICIENT_RESOURCES) {
01166             <span class="keywordflow">if</span> (pDeviceInfo-&gt;nRetryRead++ &lt; <a class="code" href="../../d4/d1/userk_8h.html#a174">MAXIMUM_READ_RETRIES</a>) {
01167                 pDeviceInfo-&gt;usActions |= <a class="code" href="../../d4/d1/userk_8h.html#a186">GDIAF_RETRYREAD</a>;
01168                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a208">gnRetryReadInput</a>++;
01169             }
01170         } <span class="keywordflow">else</span> {
01171             pDeviceInfo-&gt;bFlags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a189">GDIF_READING</a>;
01172         }
01173 
01174 <span class="preprocessor">#ifdef DIAGNOSE_IO</span>
01175 <span class="preprocessor"></span>        pDeviceInfo-&gt;nReadsOutstanding--;
01176 <span class="preprocessor">#endif</span>
01177 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!fPreviouslyAcquired) {
01178             <a class="code" href="../../d4/d1/userk_8h.html#a2066">LeaveDeviceInfoListCrit</a>();
01179         }
01180     } <span class="keywordflow">else</span> {
01181         pDeviceInfo-&gt;nRetryRead = 0;
01182     }
01183 
01184     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>() &amp;&amp; !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(pDeviceInfo-&gt;ReadStatus))
01185         RIPMSG2(RIP_WARNING, <span class="stringliteral">"StartDeviceRead %#p failed Status %#x"</span>,
01186                 pDeviceInfo, pDeviceInfo-&gt;ReadStatus);
01187 
01188     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01189 }
01190 
<a name="l01191"></a><a class="code" href="../../d4/d1/userk_8h.html#a1172">01191</a>  <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1172">ProcessDeviceChanges</a>(DWORD DeviceType)
01192 {
01193     <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo;
01194     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> usOriginalActions;
01195 <span class="preprocessor">#if DBG</span>
01196 <span class="preprocessor"></span>    <span class="keywordtype">int</span> nChanges = 0;
01197     ULONG timeStartReadPrev;
01198 <span class="preprocessor">#endif</span>
01199 <span class="preprocessor"></span>
01200     <span class="comment">/*</span>
01201 <span class="comment">     * Reset summary information for all Mice and Keyboards</span>
01202 <span class="comment">     */</span>
01203     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> nMice = 0;
01204     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> nWheels = 0;
01205     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> nMaxButtons = 0;
01206     <span class="keywordtype">int</span>   nKeyboards = 0;
01207 
01208     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01209     <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
01210     UserAssert((<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>) || (<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a239">gTermIO</a>.<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>));
01211 
01212     <a class="code" href="../../d4/d1/userk_8h.html#a2065">EnterDeviceInfoListCrit</a>();
01213     <a class="code" href="../../d4/d1/userk_8h.html#a160">BEGINATOMICDEVICEINFOLISTCHECK</a>();
01214 
01215     <span class="comment">/*</span>
01216 <span class="comment">     * Look for devices to Create (those which have newly arrived)</span>
01217 <span class="comment">     * and for devices to Terminate (these which have just departed)</span>
01218 <span class="comment">     * and for device change notifications.</span>
01219 <span class="comment">     * Make sure the actions are processed in the right order in case we</span>
01220 <span class="comment">     * are being asked for more than one action per device: for example,</span>
01221 <span class="comment">     * we sometimes get QueryRemove followed quickly by RemoveCancelled</span>
01222 <span class="comment">     * and both actions arrive here together: we should do them in the</span>
01223 <span class="comment">     * correct order.</span>
01224 <span class="comment">     */</span>
01225     pDeviceInfo = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a>;
01226     <span class="keywordflow">while</span> (pDeviceInfo) {
01227         <span class="keywordflow">if</span> (pDeviceInfo-&gt;type != DeviceType) {
01228             pDeviceInfo = pDeviceInfo-&gt;pNext;
01229             <span class="keywordflow">continue</span>;
01230         }
01231 
01232         usOriginalActions = pDeviceInfo-&gt;usActions;
01233         UserAssert((usOriginalActions == 0) || (usOriginalActions &amp; ~<a class="code" href="../../d4/d1/userk_8h.html#a185">GDIAF_PNPWAITING</a>));
01234 
01235         <span class="comment">/*</span>
01236 <span class="comment">         * Refresh Mouse:</span>
01237 <span class="comment">         * We read a MOUSE_ATTRIBUTES_CHANGED flag when a PS/2 mouse</span>
01238 <span class="comment">         * is plugged back in. Find out the attributes of the device.</span>
01239 <span class="comment">         */</span>
01240         <span class="keywordflow">if</span> (pDeviceInfo-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a183">GDIAF_REFRESH_MOUSE</a>) {
01241             pDeviceInfo-&gt;usActions &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a183">GDIAF_REFRESH_MOUSE</a>;
01242 
01243             UserAssert(pDeviceInfo-&gt;type == <a class="code" href="../../d4/d1/userk_8h.html#a175">DEVICE_TYPE_MOUSE</a>);
01244 <span class="preprocessor">#if DBG</span>
01245 <span class="preprocessor"></span>            nChanges++;
01246 <span class="preprocessor">#endif</span>
01247 <span class="preprocessor"></span>            TAGMSG1(DBGTAG_PNP, <span class="stringliteral">"QueryDeviceInfo: %lx"</span>, pDeviceInfo);
01248             <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a21">QueryDeviceInfo</a>(pDeviceInfo);
01249         }
01250 
01251         <span class="comment">/*</span>
01252 <span class="comment">         * QueryRemove:</span>
01253 <span class="comment">         * Close the file object, but retain the DEVICEINFO struct and the</span>
01254 <span class="comment">         * registration in case we later get a RemoveCancelled.</span>
01255 <span class="comment">         */</span>
01256         <span class="keywordflow">if</span> (pDeviceInfo-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a179">GDIAF_QUERYREMOVE</a>) {
01257             pDeviceInfo-&gt;usActions &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a179">GDIAF_QUERYREMOVE</a>;
01258 <span class="preprocessor">#if DBG</span>
01259 <span class="preprocessor"></span>            nChanges++;
01260 <span class="preprocessor">#endif</span>
01261 <span class="preprocessor"></span>            TAGMSG1(DBGTAG_PNP, <span class="stringliteral">"QueryRemove: %lx"</span>, pDeviceInfo);
01262             <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a23">CloseDevice</a>(pDeviceInfo);
01263         }
01264 
01265         <span class="comment">/*</span>
01266 <span class="comment">         * New device arrived or RemoveCancelled:</span>
01267 <span class="comment">         * If new device, Open it, register for notifications and start reading</span>
01268 <span class="comment">         * If RemoveCancelled, unregister the old notfications first</span>
01269 <span class="comment">         */</span>
01270         <span class="keywordflow">if</span> (pDeviceInfo-&gt;usActions &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a178">GDIAF_ARRIVED</a> | <a class="code" href="../../d4/d1/userk_8h.html#a180">GDIAF_REMOVECANCELLED</a>)) {
01271             <span class="comment">// Reopen the file object, (this is a new file object, of course),</span>
01272             <span class="comment">// Unregister for the old file, register with this new one.</span>
01273             <span class="keywordflow">if</span> (pDeviceInfo-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a180">GDIAF_REMOVECANCELLED</a>) {
01274                 pDeviceInfo-&gt;usActions &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a180">GDIAF_REMOVECANCELLED</a>;
01275 <span class="preprocessor">#if DBG</span>
01276 <span class="preprocessor"></span>                nChanges++;
01277 <span class="preprocessor">#endif</span>
01278 <span class="preprocessor"></span>                TAGMSG1(DBGTAG_PNP, <span class="stringliteral">"RemoveCancelled: %lx"</span>, pDeviceInfo);
01279                 <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a25">UnregisterForDeviceChangeNotifications</a>(pDeviceInfo);
01280             }
01281 
01282 <span class="preprocessor">#if DBG</span>
01283 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (pDeviceInfo-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a178">GDIAF_ARRIVED</a>) {
01284                 nChanges++;
01285             }
01286 <span class="preprocessor">#endif</span>
01287 <span class="preprocessor"></span>
01288             pDeviceInfo-&gt;usActions &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a178">GDIAF_ARRIVED</a>;
01289             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a22">OpenDevice</a>(pDeviceInfo)) {
01290                 <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfoNext;
01291                 <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a24">RegisterForDeviceChangeNotifications</a>(pDeviceInfo);
01292                 
01293                 <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a> &amp;&amp; (pDeviceInfo-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a187">GDIAF_RECONNECT</a>))) {
01294                     
01295                     pDeviceInfoNext = <a class="code" href="../../d4/d1/userk_8h.html#a1029">StartDeviceRead</a>(pDeviceInfo);
01296                     <span class="keywordflow">if</span> (pDeviceInfoNext) {
01297                         <span class="comment">/*</span>
01298 <span class="comment">                         * pDeviceInfo wasa freed, move onto the next</span>
01299 <span class="comment">                         */</span>
01300                         pDeviceInfo = pDeviceInfoNext;
01301                         <span class="keywordflow">continue</span>;
01302                     }
01303                 }
01304                 pDeviceInfo-&gt;usActions &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a187">GDIAF_RECONNECT</a>;
01305                 
01306             } <span class="keywordflow">else</span> {
01307                 <span class="comment">/*</span>
01308 <span class="comment">                 * If the Open failed, we free the device here, and move on to</span>
01309 <span class="comment">                 * the next device.</span>
01310 <span class="comment">                 * Assert to catch re-open failure upon RemoveCancelled.</span>
01311 <span class="comment">                 */</span>
01312 <span class="preprocessor">#if DBG</span>
01313 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((usOriginalActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a178">GDIAF_ARRIVED</a>) == 0) {
01314                     RIPMSG2(RIP_WARNING, <span class="stringliteral">"Re-Open %#p failed status %x during RemoveCancelled"</span>,
01315                             pDeviceInfo, pDeviceInfo-&gt;OpenStatus);
01316                 }
01317 <span class="preprocessor">#endif</span>
01318 <span class="preprocessor"></span>                pDeviceInfo = <a class="code" href="../../d4/d1/userk_8h.html#a1032">FreeDeviceInfo</a>(pDeviceInfo);
01319                 <span class="keywordflow">continue</span>;
01320             }
01321         }
01322 
01323         <span class="comment">/*</span>
01324 <span class="comment">         * RemoveComplete:</span>
01325 <span class="comment">         * Close the file object, if you have not already done so, Unregister.</span>
01326 <span class="comment">         * FreeDeviceInfo here (which will actually request a free from the</span>
01327 <span class="comment">         * reader or the PnP requestor thread), and move on to the next device.</span>
01328 <span class="comment">         */</span>
01329         <span class="keywordflow">if</span> (pDeviceInfo-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a181">GDIAF_DEPARTED</a>) {
01330             pDeviceInfo-&gt;usActions &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a181">GDIAF_DEPARTED</a>;
01331 <span class="preprocessor">#if DBG</span>
01332 <span class="preprocessor"></span>            nChanges++;
01333 <span class="preprocessor">#endif</span>
01334 <span class="preprocessor"></span>            TAGMSG1(DBGTAG_PNP, <span class="stringliteral">"RemoveComplete: %lx (process %#x)"</span>, pDeviceInfo);
01335             <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a23">CloseDevice</a>(pDeviceInfo);
01336             <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a25">UnregisterForDeviceChangeNotifications</a>(pDeviceInfo);
01337             pDeviceInfo = <a class="code" href="../../d4/d1/userk_8h.html#a1032">FreeDeviceInfo</a>(pDeviceInfo);
01338             <span class="keywordflow">continue</span>;
01339         }
01340 
01341         <span class="keywordflow">if</span> (pDeviceInfo-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a182">GDIAF_IME_STATUS</a>) {
01342             pDeviceInfo-&gt;usActions &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a182">GDIAF_IME_STATUS</a>;
01343 <span class="preprocessor">#if DBG</span>
01344 <span class="preprocessor"></span>            nChanges++;
01345 <span class="preprocessor">#endif</span>
01346 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((pDeviceInfo-&gt;type == <a class="code" href="../../d4/d1/userk_8h.html#a176">DEVICE_TYPE_KEYBOARD</a>) &amp;&amp; (pDeviceInfo-&gt;handle)) {
01347                 <span class="keywordflow">if</span> (FUJITSU_KBD_CONSOLE(pDeviceInfo-&gt;<a class="code" href="../../d5/d3/structtagDEVICEINFO.html#o2">keyboard</a>.<a class="code" href="../../d3/d9/structtagKEYBOARD__DEVICE__INFO.html#o0">Attr</a>.KeyboardIdentifier) ||
01348                     (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a> &amp;&amp;
01349                      FUJITSU_KBD_REMOTE(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a339">gRemoteClientKeyboardType</a>))
01350                    ) {
01351                     <span class="comment">/*</span>
01352 <span class="comment">                     * Fill up the KEYBOARD_IME_STATUS structure.</span>
01353 <span class="comment">                     */</span>
01354                     ZwDeviceIoControlFile(pDeviceInfo-&gt;handle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01355                             &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a220">giosbKbdControl</a>, IOCTL_KEYBOARD_SET_IME_STATUS,
01356                             (PVOID)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a221">gKbdImeStatus</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a221">gKbdImeStatus</a>), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
01357                 }
01358             }
01359         }
01360 
01361         <span class="keywordflow">if</span> (pDeviceInfo-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a186">GDIAF_RETRYREAD</a>) {
01362             <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfoNext;
01363             pDeviceInfo-&gt;usActions &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a186">GDIAF_RETRYREAD</a>;
01364             UserAssert(pDeviceInfo-&gt;ReadStatus == STATUS_INSUFFICIENT_RESOURCES);
01365 <span class="preprocessor">#if DBG</span>
01366 <span class="preprocessor"></span>            timeStartReadPrev = pDeviceInfo-&gt;timeStartRead;
01367 <span class="preprocessor">#endif</span>
01368 <span class="preprocessor"></span>            TAGMSG2(DBGTAG_PNP, <span class="stringliteral">"Retry Read %#p after %lx ticks"</span>,
01369                     pDeviceInfo, pDeviceInfo-&gt;timeStartRead - timeStartReadPrev);
01370             pDeviceInfoNext = <a class="code" href="../../d4/d1/userk_8h.html#a1029">StartDeviceRead</a>(pDeviceInfo);
01371             <span class="keywordflow">if</span> (pDeviceInfoNext) {
01372                 <span class="comment">/*</span>
01373 <span class="comment">                 * pDeviceInfo wasa freed, move onto the next</span>
01374 <span class="comment">                 */</span>
01375                 pDeviceInfo = pDeviceInfoNext;
01376                 <span class="keywordflow">continue</span>;
01377             }
01378         }
01379 
01380         <span class="comment">/*</span>
01381 <span class="comment">         * Gather summary information on open devices</span>
01382 <span class="comment">         */</span>
01383         <span class="keywordflow">if</span> (pDeviceInfo-&gt;handle) {
01384             <span class="keywordflow">switch</span> (pDeviceInfo-&gt;type) {
01385             <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a175">DEVICE_TYPE_MOUSE</a>:
01386                 UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a239">gTermIO</a>.<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>);
01387                 <span class="keywordflow">if</span> (pDeviceInfo-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a183">GDIAF_REFRESH_MOUSE</a>) {
01388                     pDeviceInfo-&gt;usActions &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a183">GDIAF_REFRESH_MOUSE</a>;
01389 <span class="preprocessor">#if DBG</span>
01390 <span class="preprocessor"></span>                    nChanges++;
01391 <span class="preprocessor">#endif</span>
01392 <span class="preprocessor"></span>                }
01393                 nMice++;
01394                 nMaxButtons = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(nMaxButtons, pDeviceInfo-&gt;<a class="code" href="../../d5/d3/structtagDEVICEINFO.html#o1">mouse</a>.<a class="code" href="../../d4/d2/structtagMOUSE__DEVICE__INFO.html#o0">Attr</a>.NumberOfButtons);
01395                 <span class="keywordflow">switch</span>(pDeviceInfo-&gt;<a class="code" href="../../d5/d3/structtagDEVICEINFO.html#o1">mouse</a>.<a class="code" href="../../d4/d2/structtagMOUSE__DEVICE__INFO.html#o0">Attr</a>.MouseIdentifier) {
01396                 <span class="keywordflow">case</span> WHEELMOUSE_I8042_HARDWARE:
01397                 <span class="keywordflow">case</span> WHEELMOUSE_SERIAL_HARDWARE:
01398                 <span class="keywordflow">case</span> WHEELMOUSE_HID_HARDWARE:
01399                     nWheels++;
01400                 }
01401                 <span class="keywordflow">break</span>;
01402 
01403             <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a176">DEVICE_TYPE_KEYBOARD</a>:
01404                 UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>);
01405                 {
01406                     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01407                     <span class="comment">// BUG BUG: why query each keyboard for indicators? They should all</span>
01408                     <span class="comment">// be the same.</span>
01409 <span class="preprocessor">#ifdef DIAGNOSE_IO</span>
01410 <span class="preprocessor"></span>                    <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a3">gKbdIoctlLEDSStatus</a> =
01411 <span class="preprocessor">#endif</span>
01412 <span class="preprocessor"></span>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeviceIoControlFile(pDeviceInfo-&gt;handle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01413                             &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a220">giosbKbdControl</a>, IOCTL_KEYBOARD_QUERY_INDICATORS,
01414                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
01415                             (PVOID)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a217">gklpBootTime</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a217">gklpBootTime</a>));
01416                     UserAssertMsg2(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>),
01417                             <span class="stringliteral">"IOCTL_KEYBOARD_QUERY_INDICATORS failed: DeviceInfo %#x, Status %#x"</span>,
01418                              pDeviceInfo, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01419                     <span class="comment">// BUG BUG, Don't handle multiple keyboards properly: the last</span>
01420                     <span class="comment">// keyboard on the list is the one whose attributes we report!</span>
01421                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a214">gKeyboardInfo</a> = pDeviceInfo-&gt;<a class="code" href="../../d5/d3/structtagDEVICEINFO.html#o2">keyboard</a>.<a class="code" href="../../d3/d9/structtagKEYBOARD__DEVICE__INFO.html#o0">Attr</a>;
01422                 }
01423                 nKeyboards++;
01424                 <span class="keywordflow">break</span>;
01425 
01426             <span class="keywordflow">default</span>:
01427                 <span class="comment">// Add code for a new type of input device here</span>
01428                 RIPMSG2(RIP_ERROR, <span class="stringliteral">"pDeviceInfo %#p has strange type %d"</span>,
01429                         pDeviceInfo, pDeviceInfo-&gt;type);
01430                 <span class="keywordflow">break</span>;
01431             }
01432         }
01433 
01434         <span class="comment">/*</span>
01435 <span class="comment">         * Notify the PnP thread that a change has been completed</span>
01436 <span class="comment">         */</span>
01437         <span class="keywordflow">if</span> (usOriginalActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a185">GDIAF_PNPWAITING</a>) {
01438             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pDeviceInfo-&gt;pkeHidChangeCompleted, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01439         }
01440 
01441         pDeviceInfo = pDeviceInfo-&gt;pNext;
01442     }
01443 
01444     <a class="code" href="../../d4/d1/userk_8h.html#a164">ENDATOMICDEVICEINFOLISTCHECK</a>();
01445     <a class="code" href="../../d4/d1/userk_8h.html#a2066">LeaveDeviceInfoListCrit</a>();
01446 
01447 
01448     <span class="keywordflow">switch</span> (DeviceType) {
01449     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a175">DEVICE_TYPE_MOUSE</a>:
01450         <span class="comment">/*</span>
01451 <span class="comment">         * Apply summary information for Mice</span>
01452 <span class="comment">         */</span>
01453         <span class="keywordflow">if</span> (nMice) {
01454             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a213">gnMice</a> == 0) {
01455                 <span class="comment">/*</span>
01456 <span class="comment">                 * We had no mouse before but we have one now: add a cursor</span>
01457 <span class="comment">                 */</span>
01458                 <a class="code" href="../../d4/d1/userk_8h.html#a195">SET_GTERMF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a199">GTERMF_MOUSE</a>);
01459                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(MOUSEPRESENT) = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01460                 <a class="code" href="../../d9/d3/access_8h.html#a58">SetGlobalCursorLevel</a>(0);
01461                 UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>)-&gt;ptiList-&gt;iCursorLevel == 0);
01462                 UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>)-&gt;ptiList-&gt;pq-&gt;iCursorLevel == 0);
01463                 GreMovePointer(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.x, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.y);
01464             }
01465         } <span class="keywordflow">else</span> {
01466             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a213">gnMice</a> != 0) {
01467                 <span class="comment">/*</span>
01468 <span class="comment">                 * We had a mouse before but we don't now: remove the cursor</span>
01469 <span class="comment">                 */</span>
01470                 <a class="code" href="../../d4/d1/userk_8h.html#a196">CLEAR_GTERMF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a199">GTERMF_MOUSE</a>);
01471                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(MOUSEPRESENT) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01472                 <a class="code" href="../../d9/d3/access_8h.html#a58">SetGlobalCursorLevel</a>(-1);
01473                 <span class="comment">/*</span>
01474 <span class="comment">                 * Don't leave mouse buttons stuck down, clear the global button</span>
01475 <span class="comment">                 * state here, otherwise weird stuff might happen.</span>
01476 <span class="comment">                 * Also do this in Alt-Tab processing and zzzCancelJournalling.</span>
01477 <span class="comment">                 */</span>
01478 <span class="preprocessor">#if DBG</span>
01479 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a>)
01480                     RIPMSG1(RIP_WARNING,
01481                             <span class="stringliteral">"gwMouseOwnerButton=%x, being cleared forcibly\n"</span>,
01482                             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a>);
01483 <span class="preprocessor">#endif</span>
01484 <span class="preprocessor"></span>                <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a> = 0;
01485             }
01486         }
01487         <span class="comment">/*</span>
01488 <span class="comment">         * Mouse button count represents the number of buttons on the mouse with</span>
01489 <span class="comment">         * the most buttons.</span>
01490 <span class="comment">         */</span>
01491         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CMOUSEBUTTONS) = nMaxButtons;
01492         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(MOUSEWHEELPRESENT) = (nWheels &gt; 0);
01493         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a213">gnMice</a> = nMice;
01494         <span class="keywordflow">break</span>;
01495 
01496     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a176">DEVICE_TYPE_KEYBOARD</a>:
01497         <span class="comment">/*</span>
01498 <span class="comment">         * Apply summary information for Keyboards</span>
01499 <span class="comment">         */</span>
01500 
01501         <span class="keywordflow">if</span> (nKeyboards &gt; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a219">gnKeyboards</a>) {
01502             <span class="comment">/*</span>
01503 <span class="comment">             * We have more keyboards, let set their LEDs properly</span>
01504 <span class="comment">             */</span>
01505             <a class="code" href="../../d4/d1/userk_8h.html#a1180">UpdateKeyLights</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01506         }
01507 
01508         <span class="keywordflow">if</span> ((nKeyboards != 0) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a219">gnKeyboards</a> == 0)) {
01509             <span class="comment">/*</span>
01510 <span class="comment">             * We had no keyboard but we have one now: set the system hotkeys.</span>
01511 <span class="comment">             */</span>
01512             <a class="code" href="../../d3/d2/hotkeys_8c.html#a0">SetDebugHotKeys</a>();
01513         }
01514         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a219">gnKeyboards</a> = nKeyboards;
01515         <span class="keywordflow">break</span>;
01516 
01517     <span class="keywordflow">default</span>:
01518         <span class="keywordflow">break</span>;
01519     }
01520 
01521     <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
01522 }
01523 
01524 <span class="comment">/***************************************************************************\</span>
01525 <span class="comment">* RequestDeviceChange()</span>
01526 <span class="comment">*</span>
01527 <span class="comment">* Flag the Device for the specified actions, then set its pkeHidChange to</span>
01528 <span class="comment">* trigger the RIT to perform the actions.</span>
01529 <span class="comment">* The current thread may not be able to do this if it is a PnP notification</span>
01530 <span class="comment">* from another process.</span>
01531 <span class="comment">*</span>
01532 <span class="comment">* History:</span>
01533 <span class="comment">* 01-20-99 IanJa        Created.</span>
01534 <span class="comment">\***************************************************************************/</span>
<a name="l01535"></a><a class="code" href="../../d4/d1/userk_8h.html#a992">01535</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a992">RequestDeviceChange</a>(
01536     <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo,
01537     USHORT usAction,
01538     BOOL fInDeviceInfoListCrit)
01539 {
01540     <a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html">PDEVICE_TEMPLATE</a> pDevTpl = &amp;<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[pDeviceInfo-&gt;type];
01541     UserAssert(pDevTpl-&gt;<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o12">pkeHidChange</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01542     UserAssert((usAction &amp; <a class="code" href="../../d4/d1/userk_8h.html#a184">GDIAF_FREEME</a>) == 0);
01543     UserAssert((pDeviceInfo-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a185">GDIAF_PNPWAITING</a>) == 0);
01544 
01545 <span class="preprocessor">#if DBG</span>
01546 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (pDeviceInfo-&gt;usActions != 0) {
01547         TAGMSG3(DBGTAG_PNP, <span class="stringliteral">"RequestDeviceChange(%#p, %x), but action %x pending"</span>,
01548                 pDeviceInfo, usAction, pDeviceInfo-&gt;usActions);
01549     }
01550 
01551     <span class="comment">/*</span>
01552 <span class="comment">     * We can't ask for synchronized actions to be performed on the Device List</span>
01553 <span class="comment">     * if we are holding the Device List lock or the User Critical Section:</span>
01554 <span class="comment">     * ProcessDeviceChanges() requires both of these itself.</span>
01555 <span class="comment">     */</span>
01556     <span class="keywordflow">if</span> (usAction &amp; <a class="code" href="../../d4/d1/userk_8h.html#a185">GDIAF_PNPWAITING</a>) {
01557         <a class="code" href="../../d4/d1/userk_8h.html#a158">CheckDeviceInfoListCritOut</a>();
01558         <a class="code" href="../../d4/d1/userk_8h.html#a157">CheckCritOut</a>();
01559     }
01560 <span class="preprocessor">#endif</span>
01561 <span class="preprocessor"></span>
01562     TAGMSG2(DBGTAG_PNP, <span class="stringliteral">"RequestDeviceChange(%p, %x)"</span>, pDeviceInfo, usAction);
01563 
01564     <span class="comment">/*</span>
01565 <span class="comment">     * Grab the DeviceInfoList critical section if we don't already have it</span>
01566 <span class="comment">     */</span>
01567     UserAssert(!fInDeviceInfoListCrit == !<a class="code" href="../../d5/d8/ex_8h.html#a281">ExIsResourceAcquiredExclusiveLite</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a206">gpresDeviceInfoList</a>));
01568     <span class="keywordflow">if</span> (fInDeviceInfoListCrit) {
01569         <a class="code" href="../../d4/d1/userk_8h.html#a155">CheckDeviceInfoListCritIn</a>();
01570         pDeviceInfo-&gt;usActions |= usAction;
01571     } <span class="keywordflow">else</span> {
01572         <a class="code" href="../../d4/d1/userk_8h.html#a2065">EnterDeviceInfoListCrit</a>();
01573         pDeviceInfo-&gt;usActions |= usAction;
01574         <a class="code" href="../../d4/d1/userk_8h.html#a2066">LeaveDeviceInfoListCrit</a>();
01575     }
01576 
01577     <span class="keywordflow">if</span> (usAction &amp; <a class="code" href="../../d4/d1/userk_8h.html#a185">GDIAF_PNPWAITING</a>) {
01578         <a class="code" href="../../d4/d1/userk_8h.html#a158">CheckDeviceInfoListCritOut</a>();
01579         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pDevTpl-&gt;<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o12">pkeHidChange</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01580         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(pDeviceInfo-&gt;pkeHidChangeCompleted, <a class="code" href="../../d4/d9/ke_8h.html#a407a211">WrUserRequest</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01581 
01582         <a class="code" href="../../d4/d1/userk_8h.html#a2065">EnterDeviceInfoListCrit</a>();
01583         <span class="comment">/*</span>
01584 <span class="comment">         * Assert that nothing else cleared GDIAF_PNPWAITING - only do it here.</span>
01585 <span class="comment">         * Check that the action we were waiting for actually occurred.</span>
01586 <span class="comment">         */</span>
01587         UserAssert(pDeviceInfo-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a185">GDIAF_PNPWAITING</a>);
01588         pDeviceInfo-&gt;usActions &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a185">GDIAF_PNPWAITING</a>;
01589         UserAssert((pDeviceInfo-&gt;usActions &amp; usAction) == 0);
01590         <span class="keywordflow">if</span> (pDeviceInfo-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a184">GDIAF_FREEME</a>) {
01591             <a class="code" href="../../d4/d1/userk_8h.html#a1032">FreeDeviceInfo</a>(pDeviceInfo);
01592         }
01593         <a class="code" href="../../d4/d1/userk_8h.html#a2066">LeaveDeviceInfoListCrit</a>();
01594     } <span class="keywordflow">else</span> {
01595         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pDevTpl-&gt;<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o12">pkeHidChange</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01596     }
01597 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:15 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
