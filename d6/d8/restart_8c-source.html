<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: restart.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>restart.c</h1><a href="../../d5/d9/restart_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Restart.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the routines which access the client restart</span>
00012 <span class="comment">    areas.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Brian Andrew    [BrianAn]   20-June-1991</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/lfsprocs_8h.html">lfsprocs.h</a>"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">//  The debug trace level</span>
00026 <span class="comment">//</span>
00027 
<a name="l00028"></a><a class="code" href="../../d5/d9/restart_8c.html#a0">00028</a> <span class="preprocessor">#define Dbg                              (DEBUG_TRACE_RESTART)</span>
00029 <span class="preprocessor"></span>
00030 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00031 <a class="code" href="../../d5/d9/restart_8c.html#a1">LfsSetBaseLsnPriv</a> (
00032     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00033     IN <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord,
00034     IN LSN BaseLsn
00035     );
00036 
00037 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsReadRestartArea)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsSetBaseLsn)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsSetBaseLsnPriv)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsWriteRestartArea)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044 
00045 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00046"></a><a class="code" href="../../d5/d9/restart_8c.html#a2">00046</a> <a class="code" href="../../d5/d9/restart_8c.html#a2">LfsReadRestartArea</a> (
00047     IN LFS_LOG_HANDLE LogHandle,
00048     IN OUT PULONG BufferLength,
00049     IN PVOID Buffer,
00050     OUT PLSN Lsn
00051     )
00052 
00053 <span class="comment">/*++</span>
00054 <span class="comment"></span>
00055 <span class="comment">Routine Description:</span>
00056 <span class="comment"></span>
00057 <span class="comment">    This routine is called by the client when he wishes to read his restart</span>
00058 <span class="comment">    area in the log file.</span>
00059 <span class="comment"></span>
00060 <span class="comment">Arguments:</span>
00061 <span class="comment"></span>
00062 <span class="comment">    LogHandle - Pointer to private Lfs structure used to identify this</span>
00063 <span class="comment">                client.</span>
00064 <span class="comment"></span>
00065 <span class="comment">    BufferLength - On entry it is the length of the user buffer.  On exit</span>
00066 <span class="comment">                   it is the size of the data stored in the buffer.</span>
00067 <span class="comment"></span>
00068 <span class="comment">    Buffer - Pointer to the buffer where the client restart data is to be</span>
00069 <span class="comment">             copied.</span>
00070 <span class="comment"></span>
00071 <span class="comment">    Lsn - This is the Lsn for client restart area.</span>
00072 <span class="comment"></span>
00073 <span class="comment">Return Value:</span>
00074 <span class="comment"></span>
00075 <span class="comment">    None</span>
00076 <span class="comment"></span>
00077 <span class="comment">--*/</span>
00078 
00079 {
00080     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00081 
00082     BOOLEAN UsaError;
00083 
00084     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00085 
00086     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
00087 
00088     <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> RecordHeader;
00089     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> RecordHeaderBcb;
00090 
00091     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00092     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> RetStatus = STATUS_SUCCESS;
00093 
00094 
00095     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00096 
00097     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsReadRestartArea:  Entered\n"</span>, 0 );
00098     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Log Handle    -&gt; %08lx\n"</span>, LogHandle );
00099     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Buffer Length -&gt; %08lx\n"</span>, *BufferLength );
00100     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Buffer        -&gt; %08lx\n"</span>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00101 
00102     RecordHeaderBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00103 
00104     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00105 
00106     <span class="comment">//</span>
00107     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00108     <span class="comment">//</span>
00109 
00110     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00111 
00112     <span class="comment">//</span>
00113     <span class="comment">//  Use a try-except to catch errors.</span>
00114     <span class="comment">//</span>
00115 
00116     <span class="keywordflow">try</span> {
00117 
00118         <span class="comment">//</span>
00119         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00120         <span class="comment">//</span>
00121 
00122         <span class="keywordflow">try</span> {
00123 
00124             <span class="comment">//</span>
00125             <span class="comment">//  Acquire the log file control block for this log file.</span>
00126             <span class="comment">//</span>
00127 
00128             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00129             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00130 
00131             <span class="comment">//</span>
00132             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00133             <span class="comment">//</span>
00134 
00135             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00136 
00137                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00138             }
00139 
00140             <span class="comment">//</span>
00141             <span class="comment">//  Check that the client Id is valid.</span>
00142             <span class="comment">//</span>
00143 
00144             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00145 
00146             ClientRecord = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00147                                     Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o6">ClientArrayByteOffset</a>,
00148                                     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00149 
00150             <span class="comment">//</span>
00151             <span class="comment">//  If the client doesn't have a restart area, go ahead and exit</span>
00152             <span class="comment">//  now.</span>
00153             <span class="comment">//</span>
00154 
00155             <span class="keywordflow">if</span> ( ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a>.QuadPart == 0 ) {                                                      <span class="comment">//**** xxEqlZero( ClientRecord-&gt;ClientRestartLsn )</span>
00156 
00157                 <span class="comment">//</span>
00158                 <span class="comment">//  We show there is no restart area by returning a length</span>
00159                 <span class="comment">//  of zero.  We also set the Lsn value to zero so that</span>
00160                 <span class="comment">//  we can catch it if the user tries to use the Lsn.</span>
00161                 <span class="comment">//</span>
00162 
00163                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"No client restart area exists\n"</span>, 0 );
00164 
00165                 *BufferLength = 0;
00166                 *Lsn = <a class="code" href="../../d6/d3/lfs_8h.html#a12">LfsZeroLsn</a>;
00167 
00168                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00169             }
00170 
00171             <span class="comment">//</span>
00172             <span class="comment">//  Release the Lfcb as we won't be modifying any fields in it.</span>
00173             <span class="comment">//</span>
00174 
00175             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
00176 
00177             <span class="comment">//</span>
00178             <span class="comment">//  Pin the log record for this Lsn.</span>
00179             <span class="comment">//</span>
00180 
00181             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a49">LfsPinOrMapLogRecordHeader</a>( Lfcb,
00182                                         ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a>,
00183                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00184                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00185                                         &amp;UsaError,
00186                                         &amp;RecordHeader,
00187                                         &amp;RecordHeaderBcb );
00188 
00189             <span class="comment">//</span>
00190             <span class="comment">//  If the Lsn values don't match, then the disk is corrupt.</span>
00191             <span class="comment">//</span>
00192 
00193             <span class="keywordflow">if</span> ( ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a>.QuadPart != RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o0">ThisLsn</a>.QuadPart ) {                         <span class="comment">//**** xxNeq( ClientRecord-&gt;ClientRestartLsn, RecordHeader-&gt;ThisLsn )</span>
00194 
00195                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00196             }
00197 
00198 
00199             <span class="comment">//</span>
00200             <span class="comment">//  Check that the user's buffer is big enough to hold the restart</span>
00201             <span class="comment">//  data.  We raise an error status for this error.</span>
00202             <span class="comment">//</span>
00203 
00204             <span class="keywordflow">if</span> (RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o3">ClientDataLength</a> &gt; *BufferLength) {
00205 
00206                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Client buffer is too small\n"</span>, 0 );
00207                 *BufferLength = RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o3">ClientDataLength</a>;
00208                 *Lsn = <a class="code" href="../../d6/d3/lfs_8h.html#a12">LfsZeroLsn</a>;
00209                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( RetStatus = STATUS_BUFFER_TOO_SMALL );
00210             }
00211 
00212 
00213             <span class="comment">//</span>
00214             <span class="comment">//  Use the cache manager to copy the data into the user's buffer.</span>
00215             <span class="comment">//</span>
00216 
00217             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a50">LfsCopyReadLogRecord</a>( Lfcb,
00218                                   RecordHeader,
00219                                   <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00220 
00221             <span class="comment">//</span>
00222             <span class="comment">//  Pass the length and the Lsn of the restart area back to the</span>
00223             <span class="comment">//  caller.</span>
00224             <span class="comment">//</span>
00225 
00226             *BufferLength = RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o3">ClientDataLength</a>;
00227             *Lsn = RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o0">ThisLsn</a>;
00228 
00229         try_exit: NOTHING;
00230         } finally {
00231 
00232             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <a class="code" href="../../d6/d3/lfs_8h.html#a50">LfsReadRestartArea</a> );
00233 
00234             <span class="comment">//</span>
00235             <span class="comment">//  Release the log file control block if held.</span>
00236             <span class="comment">//</span>
00237 
00238             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00239 
00240             <span class="comment">//</span>
00241             <span class="comment">//  Unpin the log record header for the client restart if pinned.</span>
00242             <span class="comment">//</span>
00243 
00244             <span class="keywordflow">if</span> (RecordHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00245 
00246                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( RecordHeaderBcb );
00247             }
00248 
00249             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lsn (Low)     -&gt; %08lx\n"</span>, Lsn-&gt;LowPart );
00250             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lsn (High)    -&gt; %08lx\n"</span>, Lsn-&gt;HighPart );
00251             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Buffer Length -&gt; %08lx\n"</span>, *BufferLength );
00252             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsReadRestartArea:  Exit\n"</span>, 0 );
00253         }
00254 
00255     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00256 
00257         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00258     }
00259 
00260     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00261 
00262         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00263     }
00264 
00265     <span class="keywordflow">return</span> RetStatus;
00266 }
00267 
00268 
00269 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00270"></a><a class="code" href="../../d5/d9/restart_8c.html#a3">00270</a> <a class="code" href="../../d5/d9/restart_8c.html#a3">LfsWriteRestartArea</a> (
00271     IN LFS_LOG_HANDLE LogHandle,
00272     IN ULONG BufferLength,
00273     IN PVOID Buffer,
00274     OUT PLSN Lsn
00275     )
00276 
00277 <span class="comment">/*++</span>
00278 <span class="comment"></span>
00279 <span class="comment">Routine Description:</span>
00280 <span class="comment"></span>
00281 <span class="comment">    This routine is called by the client to write a restart area to the</span>
00282 <span class="comment">    disk.  This routine will not return to the caller until the client</span>
00283 <span class="comment">    restart area and all prior Lsn's have been flushed and the Lfs</span>
00284 <span class="comment">    restart area on the disk has been updated.</span>
00285 <span class="comment"></span>
00286 <span class="comment">    On return, all log records up to and including 'Lsn' have been flushed</span>
00287 <span class="comment">    to the disk.</span>
00288 <span class="comment"></span>
00289 <span class="comment">Arguments:</span>
00290 <span class="comment"></span>
00291 <span class="comment">    LogHandle - Pointer to private Lfs structure used to identify this</span>
00292 <span class="comment">                client.</span>
00293 <span class="comment"></span>
00294 <span class="comment">    BufferLength - On entry it is the length of the user buffer.</span>
00295 <span class="comment"></span>
00296 <span class="comment">    Buffer - Pointer to the buffer where the client restart data resides.</span>
00297 <span class="comment"></span>
00298 <span class="comment">    Lsn - This is the Lsn for this write operation.  On input, this will be the</span>
00299 <span class="comment">          new Base Lsn for this client.</span>
00300 <span class="comment"></span>
00301 <span class="comment">          ****  This was used to prevent adding an interface change to</span>
00302 <span class="comment">                the Beta release.</span>
00303 <span class="comment"></span>
00304 <span class="comment">Return Value:</span>
00305 <span class="comment"></span>
00306 <span class="comment">    None</span>
00307 <span class="comment"></span>
00308 <span class="comment">--*/</span>
00309 
00310 {
00311     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00312 
00313     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00314 
00315     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00316 
00317     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
00318 
00319     <a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">LFS_WRITE_ENTRY</a> WriteEntry;
00320 
00321     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00322 
00323     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsWriteRestartArea:  Entered\n"</span>, 0 );
00324     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Log Handle    -&gt; %08lx\n"</span>, LogHandle );
00325     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Buffer Length -&gt; %08lx\n"</span>, BufferLength );
00326     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Buffer        -&gt; %08lx\n"</span>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00327 
00328     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00329 
00330     <span class="comment">//</span>
00331     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00332     <span class="comment">//</span>
00333 
00334     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">//  Use a try-except to catch errors.</span>
00338     <span class="comment">//</span>
00339 
00340     <span class="keywordflow">try</span> {
00341 
00342         <span class="comment">//</span>
00343         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00344         <span class="comment">//</span>
00345 
00346         <span class="keywordflow">try</span> {
00347 
00348             <span class="comment">//</span>
00349             <span class="comment">//  Acquire the log file control block for this log file.</span>
00350             <span class="comment">//</span>
00351 
00352             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00353             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00354 
00355             <span class="comment">//</span>
00356             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00357             <span class="comment">//</span>
00358 
00359             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00360 
00361                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00362             }
00363 
00364             <span class="comment">//</span>
00365             <span class="comment">//  Check that the client Id is valid.</span>
00366             <span class="comment">//</span>
00367 
00368             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00369 
00370             ClientRecord = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00371                                     Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o6">ClientArrayByteOffset</a>,
00372                                     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00373 
00374             <span class="comment">//</span>
00375             <span class="comment">//  Go ahead and update the Base Lsn in the client area if the value</span>
00376             <span class="comment">//  given is not zero.</span>
00377             <span class="comment">//</span>
00378 
00379             <span class="keywordflow">if</span> ( Lsn-&gt;QuadPart != 0 ) {                                                                                <span class="comment">//**** xxNeqZero( *Lsn )</span>
00380 
00381                 <a class="code" href="../../d5/d9/restart_8c.html#a1">LfsSetBaseLsnPriv</a>( Lfcb,
00382                                    ClientRecord,
00383                                    *Lsn );
00384             }
00385 
00386             <span class="comment">//</span>
00387             <span class="comment">//  Write this restart area as a log record into a log page.</span>
00388             <span class="comment">//</span>
00389 
00390             WriteEntry.<a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html#o0">Buffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00391             WriteEntry.<a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html#o1">ByteLength</a> = BufferLength;
00392 
00393             <a class="code" href="../../d7/d5/logrcsup_8c.html#a3">LfsWriteLogRecordIntoLogPage</a>( Lfcb,
00394                                           Lch,
00395                                           1,
00396                                           &amp;WriteEntry,
00397                                           <a class="code" href="../../d6/d3/lfs_8h.html#a62a32">LfsClientRestart</a>,
00398                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00399                                           <a class="code" href="../../d6/d3/lfs_8h.html#a12">LfsZeroLsn</a>,
00400                                           <a class="code" href="../../d6/d3/lfs_8h.html#a12">LfsZeroLsn</a>,
00401                                           0,
00402                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00403                                           Lsn );
00404 
00405             <span class="comment">//</span>
00406             <span class="comment">//  Update the restart area for the client.</span>
00407             <span class="comment">//</span>
00408 
00409             ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a> = *Lsn;
00410 
00411             <span class="comment">//</span>
00412             <span class="comment">//  Write the restart area to the disk.</span>
00413             <span class="comment">//</span>
00414 
00415             <a class="code" href="../../d7/d0/rstrtsup_8c.html#a1">LfsWriteLfsRestart</a>( Lfcb, Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o34">RestartAreaSize</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00416 
00417         } finally {
00418 
00419             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <a class="code" href="../../d6/d3/lfs_8h.html#a51">LfsWriteRestartArea</a> );
00420 
00421             <span class="comment">//</span>
00422             <span class="comment">//  Release the log file control block if still held.</span>
00423             <span class="comment">//</span>
00424 
00425             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00426 
00427             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lsn (Low)     -&gt; %08lx\n"</span>, Lsn-&gt;LowPart );
00428             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Log (High)    -&gt; %08lx\n"</span>, Lsn-&gt;HighPart );
00429             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsWriteRestartArea:  Exit\n"</span>, 0 );
00430         }
00431 
00432     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00433 
00434         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00435     }
00436 
00437     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00438 
00439         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00440     }
00441 
00442     <span class="keywordflow">return</span>;
00443 }
00444 
00445 
00446 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00447"></a><a class="code" href="../../d5/d9/restart_8c.html#a4">00447</a> <a class="code" href="../../d5/d9/restart_8c.html#a4">LfsSetBaseLsn</a> (
00448     IN LFS_LOG_HANDLE LogHandle,
00449     IN LSN BaseLsn
00450     )
00451 
00452 <span class="comment">/*++</span>
00453 <span class="comment"></span>
00454 <span class="comment">Routine Description:</span>
00455 <span class="comment"></span>
00456 <span class="comment">    This routine is called by the client to notify the log service of the</span>
00457 <span class="comment">    oldest Lsn he expects to need during restart.  The Lfs is allowed to</span>
00458 <span class="comment">    reuse any part of the circular log file which logically precedes</span>
00459 <span class="comment">    this Lsn.  A client may only specify a Lsn which follows the previous</span>
00460 <span class="comment">    Lsn specified by this client.</span>
00461 <span class="comment"></span>
00462 <span class="comment">Arguments:</span>
00463 <span class="comment"></span>
00464 <span class="comment">    LogHandle - Pointer to private Lfs structure used to identify this</span>
00465 <span class="comment">                client.</span>
00466 <span class="comment"></span>
00467 <span class="comment">    BaseLsn - This is the oldest Lsn the client may require during a</span>
00468 <span class="comment">              restart.</span>
00469 <span class="comment"></span>
00470 <span class="comment">Return Value:</span>
00471 <span class="comment"></span>
00472 <span class="comment">    None</span>
00473 <span class="comment"></span>
00474 <span class="comment">--*/</span>
00475 
00476 {
00477     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00478 
00479     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00480 
00481     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00482 
00483     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
00484 
00485     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00486 
00487     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsSetBaseLsn:  Entered\n"</span>, 0 );
00488     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Log Handle        -&gt; %08lx\n"</span>, LogHandle );
00489     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Base Lsn (Low)    -&gt; %08lx\n"</span>, BaseLsn.LowPart );
00490     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Base Lsn (High)   -&gt; %08lx\n"</span>, BaseLsn.HighPart );
00491 
00492     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00493 
00494     <span class="comment">//</span>
00495     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00496     <span class="comment">//</span>
00497 
00498     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00499 
00500     <span class="comment">//</span>
00501     <span class="comment">//  Use a try-except to catch errors.</span>
00502     <span class="comment">//</span>
00503 
00504     <span class="keywordflow">try</span> {
00505 
00506         <span class="comment">//</span>
00507         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00508         <span class="comment">//</span>
00509 
00510         <span class="keywordflow">try</span> {
00511 
00512             <span class="comment">//</span>
00513             <span class="comment">//  Acquire the log file control block for this log file.</span>
00514             <span class="comment">//</span>
00515 
00516             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00517             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00518 
00519             <span class="comment">//</span>
00520             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00521             <span class="comment">//</span>
00522 
00523             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00524 
00525                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00526             }
00527 
00528             <span class="comment">//</span>
00529             <span class="comment">//  Check that the client Id is valid.</span>
00530             <span class="comment">//</span>
00531 
00532             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00533 
00534             ClientRecord = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00535                                     Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o6">ClientArrayByteOffset</a>,
00536                                     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00537 
00538             <span class="comment">//</span>
00539             <span class="comment">//  We simply call the worker routine to advance the base lsn.</span>
00540             <span class="comment">//  If we moved forward in the file, we will put our restart area in the</span>
00541             <span class="comment">//  queue.</span>
00542             <span class="comment">//</span>
00543 
00544             <a class="code" href="../../d5/d9/restart_8c.html#a1">LfsSetBaseLsnPriv</a>( Lfcb,
00545                                ClientRecord,
00546                                BaseLsn );
00547 
00548             <a class="code" href="../../d7/d0/rstrtsup_8c.html#a1">LfsWriteLfsRestart</a>( Lfcb, Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o34">RestartAreaSize</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00549 
00550         } finally {
00551 
00552             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <a class="code" href="../../d6/d3/lfs_8h.html#a52">LfsSetBaseLsn</a> );
00553 
00554             <span class="comment">//</span>
00555             <span class="comment">//  Release the log file control block if held.</span>
00556             <span class="comment">//</span>
00557 
00558             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00559 
00560             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsSetBaseLsn:  Exit\n"</span>, 0 );
00561         }
00562 
00563     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00564 
00565         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00566     }
00567 
00568     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00569 
00570         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00571     }
00572 
00573     <span class="keywordflow">return</span>;
00574 }
00575 
00576 
00577 <span class="comment">//</span>
00578 <span class="comment">//  Local support routine</span>
00579 <span class="comment">//</span>
00580 
00581 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00582"></a><a class="code" href="../../d5/d9/restart_8c.html#a1">00582</a> <a class="code" href="../../d5/d9/restart_8c.html#a1">LfsSetBaseLsnPriv</a> (
00583     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00584     IN <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord,
00585     IN LSN BaseLsn
00586     )
00587 
00588 <span class="comment">/*++</span>
00589 <span class="comment"></span>
00590 <span class="comment">Routine Description:</span>
00591 <span class="comment"></span>
00592 <span class="comment">    This worker routine is called internally by Lfs to modify the</span>
00593 <span class="comment">    oldest Lsn a client expects to need during restart.  The Lfs is allowed to</span>
00594 <span class="comment">    reuse any part of the circular log file which logically precedes</span>
00595 <span class="comment">    this Lsn.  A client may only specify a Lsn which follows the previous</span>
00596 <span class="comment">    Lsn specified by this client.</span>
00597 <span class="comment"></span>
00598 <span class="comment">Arguments:</span>
00599 <span class="comment"></span>
00600 <span class="comment">    Lfcb - Log context block for this file.</span>
00601 <span class="comment"></span>
00602 <span class="comment">    ClientRecord - For the client whose base Lsn is being modified.</span>
00603 <span class="comment"></span>
00604 <span class="comment">    BaseLsn - This is the oldest Lsn the client may require during a</span>
00605 <span class="comment">              restart.</span>
00606 <span class="comment"></span>
00607 <span class="comment">Return Value:</span>
00608 <span class="comment"></span>
00609 <span class="comment">    None.</span>
00610 <span class="comment"></span>
00611 <span class="comment">--*/</span>
00612 
00613 {
00614     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00615 
00616     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsSetBaseLsn:  Entered\n"</span>, 0 );
00617     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lfcb              -&gt; %08lx\n"</span>, Lfcb );
00618     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Base Lsn (Low)    -&gt; %08lx\n"</span>, BaseLsn.LowPart );
00619     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Base Lsn (High)   -&gt; %08lx\n"</span>, BaseLsn.HighPart );
00620 
00621     <span class="comment">//</span>
00622     <span class="comment">//  We only proceed if the client is moving forward in the file.</span>
00623     <span class="comment">//</span>
00624 
00625     <span class="keywordflow">if</span> ( BaseLsn.QuadPart &gt; Lfcb-&gt;OldestLsn.QuadPart ) {                                                               <span class="comment">//**** xxGtr( BaseLsn, Lfcb-&gt;OldestLsn )</span>
00626 
00627         <span class="keywordflow">if</span> ( BaseLsn.QuadPart &gt; ClientRecord-&gt;OldestLsn.QuadPart ) {                                                   <span class="comment">//**** xxGtr( BaseLsn, ClientRecord-&gt;OldestLsn )</span>
00628 
00629             ClientRecord-&gt;OldestLsn = BaseLsn;
00630         }
00631 
00632         Lfcb-&gt;OldestLsn = BaseLsn;
00633 
00634         <span class="comment">//</span>
00635         <span class="comment">//  We walk through all the active clients and find the new</span>
00636         <span class="comment">//  oldest Lsn for the log file.</span>
00637         <span class="comment">//</span>
00638 
00639         <a class="code" href="../../d7/d0/rstrtsup_8c.html#a2">LfsFindOldestClientLsn</a>( Lfcb-&gt;RestartArea,
00640                                 Lfcb-&gt;ClientArray,
00641                                 &amp;Lfcb-&gt;OldestLsn );
00642 
00643         Lfcb-&gt;OldestLsnOffset = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a12">LfsLsnToFileOffset</a>( Lfcb, Lfcb-&gt;OldestLsn );
00644         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a10">LFCB_NO_OLDEST_LSN</a> );
00645 
00646         <a class="code" href="../../d7/d5/lfs_2verfysup_8c.html#a2">LfsFindCurrentAvail</a>( Lfcb );
00647     }
00648 
00649     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsSetBaseLsnPriv:  Exit\n"</span>, 0 );
00650 
00651     <span class="keywordflow">return</span>;
00652 }
00653 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
