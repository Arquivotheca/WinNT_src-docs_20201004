<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: context.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>context.c</h1><a href="../../d5/d6/rtl_2mips_2context_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    context.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements user-mode callable context manipulation routines.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Mark Lucovsky (markl) 20-Jun-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    David N. Cutler (davec) 18-Apr-1990</span>
00020 <span class="comment"></span>
00021 <span class="comment">        Revise for MIPS environment.</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>&gt;</span>
00026 
00027 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00028"></a><a class="code" href="../../d5/d6/rtl_2mips_2context_8c.html#a0">00028</a> <a class="code" href="../../d6/d6/rtl_2ppc_2context_8c.html#a1">RtlInitializeContext</a>(
00029     IN HANDLE Process,
00030     OUT PCONTEXT Context,
00031     IN PVOID Parameter OPTIONAL,
00032     IN PVOID InitialPc OPTIONAL,
00033     IN PVOID InitialSp OPTIONAL
00034     )
00035 
00036 <span class="comment">/*++</span>
00037 <span class="comment"></span>
00038 <span class="comment">Routine Description:</span>
00039 <span class="comment"></span>
00040 <span class="comment">    This function initializes a context structure so that it can be used in</span>
00041 <span class="comment">    a subsequent call to NtCreateThread.</span>
00042 <span class="comment"></span>
00043 <span class="comment">Arguments:</span>
00044 <span class="comment"></span>
00045 <span class="comment">    Context - Supplies a pointer to a context record that is to be initialized.</span>
00046 <span class="comment"></span>
00047 <span class="comment">    InitialPc - Supplies an initial program counter value.</span>
00048 <span class="comment"></span>
00049 <span class="comment">    InitialSp - Supplies an initial stack pointer value.</span>
00050 <span class="comment"></span>
00051 <span class="comment">Return Value:</span>
00052 <span class="comment"></span>
00053 <span class="comment">    Raises STATUS_BAD_INITIAL_STACK if the value of InitialSp is not properly</span>
00054 <span class="comment">           aligned.</span>
00055 <span class="comment"></span>
00056 <span class="comment">    Raises STATUS_BAD_INITIAL_PC if the value of InitialPc is not properly</span>
00057 <span class="comment">           aligned.</span>
00058 <span class="comment"></span>
00059 <span class="comment">--*/</span>
00060 
00061 {
00062 
00063     <span class="comment">//</span>
00064     <span class="comment">// Check for proper initial stack and PC alignment.</span>
00065     <span class="comment">//</span>
00066 
00067     <span class="keywordflow">if</span> (((ULONG)InitialSp &amp; 0x7) != 0) {
00068         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_BAD_INITIAL_STACK);
00069     }
00070     <span class="keywordflow">if</span> (((ULONG)InitialPc &amp; 0x3) != 0) {
00071         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_BAD_INITIAL_PC);
00072     }
00073 
00074     <span class="comment">//</span>
00075     <span class="comment">// Initialize the integer registers to contain their register number.</span>
00076     <span class="comment">//</span>
00077 
00078     Context-&gt;XIntZero = 0;
00079     Context-&gt;XIntAt = 1;
00080     Context-&gt;XIntV0 = 2;
00081     Context-&gt;XIntV1 = 3;
00082     Context-&gt;XIntA0 = 4;
00083     Context-&gt;XIntA1 = 5;
00084     Context-&gt;XIntA2 = 6;
00085     Context-&gt;XIntA3 = 7;
00086     Context-&gt;XIntT0 = 8;
00087     Context-&gt;XIntT1 = 9;
00088     Context-&gt;XIntT2 = 10;
00089     Context-&gt;XIntT3 = 11;
00090     Context-&gt;XIntT4 = 12;
00091     Context-&gt;XIntT5 = 13;
00092     Context-&gt;XIntT6 = 14;
00093     Context-&gt;XIntT7 = 15;
00094     Context-&gt;XIntS0 = 16;
00095     Context-&gt;XIntS1 = 17;
00096     Context-&gt;XIntS2 = 18;
00097     Context-&gt;XIntS3 = 19;
00098     Context-&gt;XIntS4 = 20;
00099     Context-&gt;XIntS5 = 21;
00100     Context-&gt;XIntS6 = 22;
00101     Context-&gt;XIntS7 = 23;
00102     Context-&gt;XIntT8 = 24;
00103     Context-&gt;XIntT9 = 25;
00104     Context-&gt;XIntS8 = 30;
00105     Context-&gt;XIntLo = 0;
00106     Context-&gt;XIntHi = 0;
00107 
00108     <span class="comment">//</span>
00109     <span class="comment">// Initialize the floating point registers to contain zero in their upper</span>
00110     <span class="comment">// half and the integer value of their register number in the lower half.</span>
00111     <span class="comment">//</span>
00112 
00113     Context-&gt;FltF0 = 0;
00114     Context-&gt;FltF1 = 0;
00115     Context-&gt;FltF2 = 2;
00116     Context-&gt;FltF3 = 0;
00117     Context-&gt;FltF4 = 4;
00118     Context-&gt;FltF5 = 0;
00119     Context-&gt;FltF6 = 6;
00120     Context-&gt;FltF7 = 0;
00121     Context-&gt;FltF8 = 8;
00122     Context-&gt;FltF9 = 0;
00123     Context-&gt;FltF10 = 10;
00124     Context-&gt;FltF11 = 0;
00125     Context-&gt;FltF12 = 12;
00126     Context-&gt;FltF13 = 0;
00127     Context-&gt;FltF14 = 14;
00128     Context-&gt;FltF15 = 0;
00129     Context-&gt;FltF16 = 16;
00130     Context-&gt;FltF17 = 0;
00131     Context-&gt;FltF18 = 18;
00132     Context-&gt;FltF19 = 0;
00133     Context-&gt;FltF20 = 20;
00134     Context-&gt;FltF21 = 0;
00135     Context-&gt;FltF22 = 22;
00136     Context-&gt;FltF23 = 0;
00137     Context-&gt;FltF24 = 24;
00138     Context-&gt;FltF25 = 0;
00139     Context-&gt;FltF26 = 26;
00140     Context-&gt;FltF27 = 0;
00141     Context-&gt;FltF28 = 28;
00142     Context-&gt;FltF29 = 0;
00143     Context-&gt;FltF30 = 30;
00144     Context-&gt;FltF31 = 0;
00145     Context-&gt;Fsr = 0;
00146 
00147     <span class="comment">//</span>
00148     <span class="comment">// Initialize the control registers.</span>
00149     <span class="comment">//</span>
00150     <span class="comment">// N.B. The register gp is estabished at thread startup by the loader.</span>
00151     <span class="comment">//</span>
00152 
00153     Context-&gt;XIntGp = 0;
00154     Context-&gt;XIntSp = (LONG)InitialSp;
00155     Context-&gt;XIntRa = 1;
00156     Context-&gt;Fir = (ULONG)InitialPc;
00157     Context-&gt;Psr = 0;
00158     Context-&gt;ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00159 
00160     <span class="comment">//</span>
00161     <span class="comment">// Set the initial context of the thread in a machine specific way.</span>
00162     <span class="comment">//</span>
00163 
00164     Context-&gt;XIntA0 = (LONG)Parameter;
00165     Context-&gt;XIntSp -= KTRAP_FRAME_ARGUMENTS;
00166 }
00167 
00168 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00169"></a><a class="code" href="../../d5/d6/rtl_2mips_2context_8c.html#a1">00169</a> <a class="code" href="../../d6/d6/rtl_2ppc_2context_8c.html#a2">RtlRemoteCall</a>(
00170     HANDLE Process,
00171     HANDLE Thread,
00172     PVOID CallSite,
00173     ULONG ArgumentCount,
00174     PULONG Arguments,
00175     BOOLEAN PassContext,
00176     BOOLEAN AlreadySuspended
00177     )
00178 
00179 <span class="comment">/*++</span>
00180 <span class="comment"></span>
00181 <span class="comment">Routine Description:</span>
00182 <span class="comment"></span>
00183 <span class="comment">    This function calls a procedure in another thread/process,  by using</span>
00184 <span class="comment">    NtGetContext and NtSetContext. Parameters are passed to the target</span>
00185 <span class="comment">    procedure via the nonvolatile registers (s0 - s7).</span>
00186 <span class="comment"></span>
00187 <span class="comment">Arguments:</span>
00188 <span class="comment"></span>
00189 <span class="comment">    Process - Supplies an open handle to the target process.</span>
00190 <span class="comment"></span>
00191 <span class="comment">    Thread - Supplies an open handle to the target thread within the target</span>
00192 <span class="comment">        process.</span>
00193 <span class="comment"></span>
00194 <span class="comment">    CallSize - Supplies the address of the procedure to call in the target</span>
00195 <span class="comment">        process.</span>
00196 <span class="comment"></span>
00197 <span class="comment">    ArgumentCount - Supplies the number of 32 bit parameters to pass to the</span>
00198 <span class="comment">        target procedure.</span>
00199 <span class="comment"></span>
00200 <span class="comment">    Arguments - Supplies a pointer to the array of 32 bit parameters to pass.</span>
00201 <span class="comment"></span>
00202 <span class="comment">    PassContext - Supplies a boolean value that determines whether a parameter</span>
00203 <span class="comment">        is to be passed that points to a context record. This parameter is</span>
00204 <span class="comment">        ignored on MIPS hosts.</span>
00205 <span class="comment"></span>
00206 <span class="comment">    AlreadySuspended - Supplies a boolean value that determines whether the</span>
00207 <span class="comment">        target thread is already in a suspended or waiting state.</span>
00208 <span class="comment"></span>
00209 <span class="comment">Return Value:</span>
00210 <span class="comment"></span>
00211 <span class="comment">    Status - Status value</span>
00212 <span class="comment"></span>
00213 <span class="comment">--*/</span>
00214 
00215 {
00216 
00217     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00218     CONTEXT Context;
00219     ULONG NewSp;
00220 
00221     <span class="keywordflow">if</span> (ArgumentCount &gt; 8) {
00222         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
00223     }
00224 
00225     <span class="comment">//</span>
00226     <span class="comment">// If necessary, suspend the target thread before getting the thread's</span>
00227     <span class="comment">// current state.</span>
00228     <span class="comment">//</span>
00229 
00230     <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00231         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/psspnd_8c.html#a0">NtSuspendThread</a>(Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00232         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00233             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00234         }
00235     }
00236 
00237     <span class="comment">//</span>
00238     <span class="comment">// Get the cuurent state of the target thread.</span>
00239     <span class="comment">//</span>
00240 
00241     Context.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00242     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a2">NtGetContextThread</a>(Thread, &amp;Context);
00243     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00244         <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00245             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00246         }
00247 
00248         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00249     }
00250 
00251     <span class="keywordflow">if</span> (AlreadySuspended) {
00252         Context.XIntV0 = (LONG)STATUS_ALERTED;
00253     }
00254 
00255     <span class="comment">//</span>
00256     <span class="comment">// Pass the parameters to the other thread via the non-volatile registers</span>
00257     <span class="comment">// s0 - s7. The context record is passed on the stack of the target thread.</span>
00258     <span class="comment">//</span>
00259 
00260     NewSp = (ULONG)(Context.XIntSp - <span class="keyword">sizeof</span>(CONTEXT));
00261     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a10">NtWriteVirtualMemory</a>(Process,
00262                                   (PVOID)NewSp,
00263                                   &amp;Context,
00264                                   <span class="keyword">sizeof</span>(CONTEXT),
00265                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00266 
00267     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00268         <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00269             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00270         }
00271 
00272         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00273     }
00274 
00275     Context.XIntSp = (LONG)NewSp;
00276     <span class="keywordflow">if</span> (PassContext) {
00277         Context.XIntS0 = (LONG)NewSp;
00278         RtlMoveMemory(&amp;Context.XIntS1, Arguments, ArgumentCount * <span class="keyword">sizeof</span>(ULONG));
00279 
00280     } <span class="keywordflow">else</span> {
00281         RtlMoveMemory(&amp;Context.XIntS0, Arguments, ArgumentCount * <span class="keyword">sizeof</span>(ULONG));
00282     }
00283 
00284     <span class="comment">//</span>
00285     <span class="comment">// Set the address of the target code into FIR and set the thread context</span>
00286     <span class="comment">// to cause the target procedure to be executed.</span>
00287     <span class="comment">//</span>
00288 
00289     Context.Fir = (ULONG)CallSite;;
00290     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a3">NtSetContextThread</a>(Thread, &amp;Context);
00291     <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00292         <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00293     }
00294 
00295     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00296 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
