<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kdinit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdinit.c</h1><a href="../../d5/d6/4_2kdinit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990-1999  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    kdinit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the initialization for the portable kernel debgger.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    David N. Cutler 27-July-1990</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d1/d7/4_2kdp_8h.html">kdp.h</a>"</span>
00022 
00023 <span class="comment">//</span>
00024 <span class="comment">// Miscellaneous data from all over the kernel</span>
00025 <span class="comment">//</span>
00026 
<a name="l00027"></a><a class="code" href="../../d5/d6/4_2kdinit_8c.html#a0">00027</a> <span class="preprocessor">#define BAUD_OPTION "BAUDRATE"</span>
<a name="l00028"></a><a class="code" href="../../d5/d6/4_2kdinit_8c.html#a1">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define PORT_OPTION "DEBUGPORT"</span>
00029 <span class="preprocessor"></span>
00030 
00031 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdInitSystem)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdUpdateDataBlock)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00035 <span class="preprocessor"></span>
00036 
00037 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00038"></a><a class="code" href="../../d5/d6/4_2kdinit_8c.html#a2">00038</a> <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a2">KdUpdateDataBlock</a>(
00039     VOID
00040     )
00041 <span class="comment">/*++</span>
00042 <span class="comment"></span>
00043 <span class="comment">Routine Description:</span>
00044 <span class="comment"></span>
00045 <span class="comment">    We have to update this variable seperately since it is initialized at a</span>
00046 <span class="comment">    later time by PS.  PS will call us to update the data block.</span>
00047 <span class="comment"></span>
00048 <span class="comment">--*/</span>
00049 {
00050     <a class="code" href="../../d8/d5/kddata_8c.html#a50">KdDebuggerDataBlock</a>.KeUserCallbackDispatcher = (ULONG_PTR) <a class="code" href="../../d4/d9/ke_8h.html#a149">KeUserCallbackDispatcher</a>;
00051 }
00052 
00053 
00054 ULONG_PTR
<a name="l00055"></a><a class="code" href="../../d5/d6/4_2kdinit_8c.html#a3">00055</a> <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a3">KdGetDataBlock</a>(
00056     VOID
00057     )
00058 <span class="comment">/*++</span>
00059 <span class="comment"></span>
00060 <span class="comment">Routine Description:</span>
00061 <span class="comment"></span>
00062 <span class="comment">    We have to update this variable seperately since it is initialized at a</span>
00063 <span class="comment">    later time by PS.  PS will call us to update the data block.</span>
00064 <span class="comment"></span>
00065 <span class="comment">--*/</span>
00066 {
00067     <span class="keywordflow">return</span> (ULONG_PTR)(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a50">KdDebuggerDataBlock</a>);
00068 }
00069 
00070 
00071 BOOLEAN
<a name="l00072"></a><a class="code" href="../../d5/d6/4_2kdinit_8c.html#a4">00072</a> <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a4">KdInitSystem</a>(
00073     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock OPTIONAL,
00074     BOOLEAN StopInDebugger
00075     )
00076 
00077 <span class="comment">/*++</span>
00078 <span class="comment"></span>
00079 <span class="comment">Routine Description:</span>
00080 <span class="comment"></span>
00081 <span class="comment">    This routine initializes the portable kernel debugger.</span>
00082 <span class="comment"></span>
00083 <span class="comment">Arguments:</span>
00084 <span class="comment"></span>
00085 <span class="comment">    LoaderBlock - Supplies a pointer to the LOADER_PARAMETER_BLOCK passed</span>
00086 <span class="comment">        in from the OS Loader.</span>
00087 <span class="comment"></span>
00088 <span class="comment">    StopInDebugger - Supplies a boolean value that determines whether a</span>
00089 <span class="comment">        debug message and breakpoint are generated.</span>
00090 <span class="comment"></span>
00091 <span class="comment">Return Value:</span>
00092 <span class="comment"></span>
00093 <span class="comment">    None.</span>
00094 <span class="comment"></span>
00095 <span class="comment">--*/</span>
00096 
00097 {
00098 
00099     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00100     BOOLEAN Initialize;
00101     PCHAR Options;
00102     PCHAR BaudOption;
00103     PCHAR PortOption;
00104 
00105     <span class="comment">//</span>
00106     <span class="comment">// If kernel debugger is already initialized, then return.</span>
00107     <span class="comment">//</span>
00108 
00109     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00110         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00111     }
00112 
00113     <a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> = <a class="code" href="../../d7/d8/alpha_2kdtrap_8c.html#a2">KdpStub</a>;
00114 
00115     <span class="comment">//</span>
00116     <span class="comment">// Determine whether or not the debugger should be enabled.</span>
00117     <span class="comment">//</span>
00118     <span class="comment">// Note that if LoaderBlock == NULL, then KdInitSystem was called</span>
00119     <span class="comment">// from BugCheck code. For this case the debugger is always enabled</span>
00120     <span class="comment">// to report the bugcheck if possible.</span>
00121     <span class="comment">//</span>
00122 
00123     <span class="keywordflow">if</span> (LoaderBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00124 
00125         <a class="code" href="../../d8/d5/kddata_8c.html#a94">KdpNtosImageBase</a> =  CONTAINING_RECORD(
00126                                     (LoaderBlock-&gt;LoadOrderListHead.Flink),
00127                                     LDR_DATA_TABLE_ENTRY,
00128                                     InLoadOrderLinks)-&gt;DllBase;
00129 
00130         <span class="comment">//</span>
00131         <span class="comment">// Initialize the debugger data block list when called at startup time.</span>
00132         <span class="comment">//</span>
00133 
00134         InitializeListHead(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>);
00135 
00136         <span class="comment">//</span>
00137         <span class="comment">// Fill in and register the debugger's debugger data block.</span>
00138         <span class="comment">// Most fields are already initialized, some fields will not be</span>
00139         <span class="comment">// filled in until later.</span>
00140         <span class="comment">//</span>
00141 
00142         <a class="code" href="../../d8/d5/kddata_8c.html#a50">KdDebuggerDataBlock</a>.KernBase = (ULONG_PTR) <a class="code" href="../../d8/d5/kddata_8c.html#a94">KdpNtosImageBase</a>;
00143 
00144         <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a5">KdRegisterDebuggerDataBlock</a>(KDBG_TAG,
00145                                     &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a50">KdDebuggerDataBlock</a>.Header,
00146                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d5/kddata_8c.html#a50">KdDebuggerDataBlock</a>));
00147 
00148         <span class="keywordflow">if</span> (LoaderBlock-&gt;LoadOptions != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00149             Options = LoaderBlock-&gt;LoadOptions;
00150             _strupr(Options);
00151 
00152             <span class="comment">//</span>
00153             <span class="comment">// If any of the port option, baud option, or debug is specified,</span>
00154             <span class="comment">// then enable the debugger unless it is explictly disabled.</span>
00155             <span class="comment">//</span>
00156 
00157             Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00158             PortOption = strstr(Options, <a class="code" href="../../d4/d6/kdinit_8c.html#a1">PORT_OPTION</a>);
00159             BaudOption = strstr(Options, <a class="code" href="../../d4/d6/kdinit_8c.html#a0">BAUD_OPTION</a>);
00160             <span class="keywordflow">if</span> ((PortOption == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (BaudOption == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00161                 <span class="keywordflow">if</span> (strstr(Options, <span class="stringliteral">"DEBUG"</span>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00162                     Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00163                 }
00164 
00165             } <span class="keywordflow">else</span> {
00166                 <span class="keywordflow">if</span> (PortOption) {
00167                     PortOption = strstr(PortOption, <span class="stringliteral">"COM"</span>);
00168                     <span class="keywordflow">if</span> (PortOption) {
00169                         <a class="code" href="../../d7/d3/kd_8h.html#a14">KdDebugParameters</a>.<a class="code" href="../../d0/d2/struct__DEBUG__PARAMETERS.html#o0">CommunicationPort</a> =
00170                                                      atol(PortOption + 3);
00171                     }
00172                 }
00173 
00174                 <span class="keywordflow">if</span> (BaudOption) {
00175                     BaudOption += <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(<a class="code" href="../../d4/d6/kdinit_8c.html#a0">BAUD_OPTION</a>);
00176                     <span class="keywordflow">while</span> (*BaudOption == <span class="charliteral">' '</span>) {
00177                         BaudOption++;
00178                     }
00179 
00180                     <span class="keywordflow">if</span> (*BaudOption != <span class="charliteral">'\0'</span>) {
00181                         <a class="code" href="../../d7/d3/kd_8h.html#a14">KdDebugParameters</a>.<a class="code" href="../../d0/d2/struct__DEBUG__PARAMETERS.html#o1">BaudRate</a> = atol(BaudOption + 1);
00182                     }
00183                 }
00184             }
00185 
00186             <span class="comment">//</span>
00187             <span class="comment">// If the debugger is explicitly disabled, then set to NODEBUG.</span>
00188             <span class="comment">//</span>
00189 
00190             <span class="keywordflow">if</span> (strstr(Options, <span class="stringliteral">"NODEBUG"</span>)) {
00191                 Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00192                 <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00193             }
00194 
00195             <span class="keywordflow">if</span> (strstr(Options, <span class="stringliteral">"CRASHDEBUG"</span>)) {
00196                 Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00197                 <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00198             }
00199 
00200         } <span class="keywordflow">else</span> {
00201 
00202             <span class="comment">//</span>
00203             <span class="comment">// If the load options are not specified, then set to NODEBUG.</span>
00204             <span class="comment">//</span>
00205 
00206             <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00207             Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00208         }
00209 
00210     } <span class="keywordflow">else</span> {
00211         Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00212     }
00213 
00214     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d7/hal_8h.html#a199">KdPortInitialize</a>(&amp;<a class="code" href="../../d7/d3/kd_8h.html#a14">KdDebugParameters</a>, LoaderBlock, Initialize) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00215         (Initialize == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00216         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00217     }
00218 
00219     <span class="comment">//</span>
00220     <span class="comment">// Set address of kernel debugger trap routine.</span>
00221     <span class="comment">//</span>
00222 
00223     <a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> = <a class="code" href="../../d7/d8/alpha_2kdtrap_8c.html#a0">KdpTrap</a>;
00224 
00225     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d5/kddata_8c.html#a107">KdpDebuggerStructuresInitialized</a>) {
00226 
00227         <a class="code" href="../../d0/d7/kdp_8h.html#a25">KiDebugSwitchRoutine</a> = <a class="code" href="../../d8/d3/kdapi_8c.html#a30">KdpSwitchProcessor</a>;
00228         <a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a6">KDP_BREAKPOINT_VALUE</a>;
00229         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00230 
00231         <span class="comment">//</span>
00232         <span class="comment">// Initialize the breakpoint table.</span>
00233         <span class="comment">//</span>
00234 
00235         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00236             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = 0;
00237             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00238             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o1">DirectoryTableBase</a> = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00239         }
00240 
00241         <span class="comment">//</span>
00242         <span class="comment">// Initialize TimeSlip</span>
00243         <span class="comment">//</span>
00244         <a class="code" href="../../d4/d1/dpcobj_8c.html#a1">KeInitializeDpc</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a100">KdpTimeSlipDpc</a>, <a class="code" href="../../d8/d3/kdapi_8c.html#a19">KdpTimeSlipDpcRoutine</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00245         <a class="code" href="../../d3/d2/timerobj_8c.html#a1">KeInitializeTimer</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a102">KdpTimeSlipTimer</a>);
00246         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a101">KdpTimeSlipWorkItem</a>, <a class="code" href="../../d8/d3/kdapi_8c.html#a20">KdpTimeSlipWork</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00247 
00248         <a class="code" href="../../d8/d5/kddata_8c.html#a107">KdpDebuggerStructuresInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
00249     }
00250 
00251     <span class="comment">//</span>
00252     <span class="comment">//  Initialize timer facility - HACKHACK</span>
00253     <span class="comment">//</span>
00254 
00255     <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a55">KdPerformanceCounterRate</a>);
00256     <a class="code" href="../../d8/d5/kddata_8c.html#a56">KdTimerStart</a>.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00257     <a class="code" href="../../d8/d5/kddata_8c.html#a56">KdTimerStart</a>.LowPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00258 
00259     <span class="comment">//</span>
00260     <span class="comment">// Initialize ID for NEXT packet to send and Expect ID of next incoming</span>
00261     <span class="comment">// packet.</span>
00262     <span class="comment">//</span>
00263 
00264     <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> = INITIAL_PACKET_ID | SYNC_PACKET_ID;
00265     <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a> = INITIAL_PACKET_ID;
00266 
00267     <span class="comment">//</span>
00268     <span class="comment">// Mark debugger enabled.</span>
00269     <span class="comment">//</span>
00270     <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00271     <a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00272     SharedUserData-&gt;KdDebuggerEnabled = 0x00000001;
00273 
00274     <span class="comment">//</span>
00275     <span class="comment">// If requested, stop in the kernel debugger.</span>
00276     <span class="comment">//</span>
00277 
00278     <span class="keywordflow">if</span> (StopInDebugger) {
00279         DbgBreakPoint();
00280     }
00281 
00282     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00283 }
00284 
00285 
00286 BOOLEAN
<a name="l00287"></a><a class="code" href="../../d5/d6/4_2kdinit_8c.html#a5">00287</a> <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a5">KdRegisterDebuggerDataBlock</a>(
00288     IN ULONG Tag,
00289     IN PDBGKD_DEBUG_DATA_HEADER64 DataHeader,
00290     IN ULONG Size
00291     )
00292 <span class="comment">/*++</span>
00293 <span class="comment"></span>
00294 <span class="comment">Routine Description:</span>
00295 <span class="comment"></span>
00296 <span class="comment">    This routine is called by a component or driver to register a</span>
00297 <span class="comment">    debugger data block.  The data block is made accessible to the</span>
00298 <span class="comment">    kernel debugger, thus providing a reliable method of exposing</span>
00299 <span class="comment">    random data to debugger extensions.</span>
00300 <span class="comment"></span>
00301 <span class="comment">Arguments:</span>
00302 <span class="comment"></span>
00303 <span class="comment">    Tag - Supplies a unique 4 byte tag which is used to identify the</span>
00304 <span class="comment">            data block.</span>
00305 <span class="comment"></span>
00306 <span class="comment">    DataHeader - Supplies the address of the debugger data block header.</span>
00307 <span class="comment">            The OwnerTag field must contain a unique value, and the Size</span>
00308 <span class="comment">            field must contain the size of the data block, including the</span>
00309 <span class="comment">            header.  If this block is already present, or there is</span>
00310 <span class="comment">            already a block with the same value for OwnerTag, this one</span>
00311 <span class="comment">            will not be inserted.  If Size is incorrect, this code will</span>
00312 <span class="comment">            not notice, but the usermode side of the debugger might not</span>
00313 <span class="comment">            function correctly.</span>
00314 <span class="comment"></span>
00315 <span class="comment">    Size - Supplies the size of the data block, including the header.</span>
00316 <span class="comment"></span>
00317 <span class="comment">Return Value:</span>
00318 <span class="comment"></span>
00319 <span class="comment">    TRUE if the block was added to the list, FALSE if not.</span>
00320 <span class="comment"></span>
00321 <span class="comment">--*/</span>
00322 {
00323     KIRQL OldIrql;
00324     PLIST_ENTRY <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00325     <a class="code" href="../../d7/d3/kd_8h.html#a15">PDBGKD_DEBUG_DATA_HEADER64</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00326 
00327     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a96">KdpDataSpinLock</a>, &amp;OldIrql);
00328 
00329     <span class="comment">//</span>
00330     <span class="comment">// Look for a record with the same tag or address</span>
00331     <span class="comment">//</span>
00332 
00333     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>.Flink;
00334 
00335     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> != &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>) {
00336 
00337         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>, DBGKD_DEBUG_DATA_HEADER64, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
00338 
00339         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Flink;
00340 
00341         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> == DataHeader) || (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;OwnerTag == Tag)) {
00342             <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a96">KdpDataSpinLock</a>, OldIrql);
00343             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00344         }
00345     }
00346 
00347     <span class="comment">//</span>
00348     <span class="comment">// It wasn't already there, so add it.</span>
00349     <span class="comment">//</span>
00350 
00351     DataHeader-&gt;OwnerTag = Tag;
00352     DataHeader-&gt;Size = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00353 
00354     InsertTailList(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>, (PLIST_ENTRY)(&amp;DataHeader-&gt;List));
00355 
00356     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a96">KdpDataSpinLock</a>, OldIrql);
00357 
00358     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00359 }
00360 
00361 
00362 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00363"></a><a class="code" href="../../d5/d6/4_2kdinit_8c.html#a6">00363</a> <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a6">KdDeregisterDebuggerDataBlock</a>(
00364     IN PDBGKD_DEBUG_DATA_HEADER64 DataHeader
00365     )
00366 <span class="comment">/*++</span>
00367 <span class="comment"></span>
00368 <span class="comment">Routine Description:</span>
00369 <span class="comment"></span>
00370 <span class="comment">    This routine is called to deregister a data block previously</span>
00371 <span class="comment">    registered with KdRegisterDebuggerDataBlock.  If the block is</span>
00372 <span class="comment">    found in the list, it is removed.</span>
00373 <span class="comment"></span>
00374 <span class="comment">Arguments:</span>
00375 <span class="comment"></span>
00376 <span class="comment">    DataHeader - Supplies the address of the data block which is</span>
00377 <span class="comment">                to be removed from the list.</span>
00378 <span class="comment"></span>
00379 <span class="comment">Return Value:</span>
00380 <span class="comment"></span>
00381 <span class="comment">    None</span>
00382 <span class="comment"></span>
00383 <span class="comment">--*/</span>
00384 
00385 {
00386     KIRQL OldIrql;
00387     PLIST_ENTRY <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00388     <a class="code" href="../../d7/d3/kd_8h.html#a15">PDBGKD_DEBUG_DATA_HEADER64</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00389 
00390     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a96">KdpDataSpinLock</a>, &amp;OldIrql);
00391 
00392     <span class="comment">//</span>
00393     <span class="comment">// Make sure the data block is on our list before removing it.</span>
00394     <span class="comment">//</span>
00395 
00396     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>.Flink;
00397 
00398     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> != &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>) {
00399 
00400         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>, DBGKD_DEBUG_DATA_HEADER64, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
00401         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Flink;
00402 
00403         <span class="keywordflow">if</span> (DataHeader == <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>) {
00404             RemoveEntryList((PLIST_ENTRY)(&amp;DataHeader-&gt;List));
00405             <span class="keywordflow">break</span>;
00406         }
00407     }
00408 
00409     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a96">KdpDataSpinLock</a>, OldIrql);
00410 }
00411 
00412 
00413 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00414"></a><a class="code" href="../../d5/d6/4_2kdinit_8c.html#a7">00414</a> <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a7">KdLogDbgPrint</a>(
00415     IN PSTRING String
00416     )
00417 {
00418     KIRQL OldIrql;
00419     ULONG Length;
00420     ULONG LengthCopied;
00421 
00422     <span class="keywordflow">for</span> (; ;) {
00423         <span class="keywordflow">if</span> (KeTestSpinLock (&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a49">KdpPrintSpinLock</a>)) {
00424             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a57">HIGH_LEVEL</a>, &amp;OldIrql);
00425             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/ki_8h.html#a155">KiTryToAcquireSpinLock</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a49">KdpPrintSpinLock</a>)) {
00426                 <span class="keywordflow">break</span>;          <span class="comment">// got the lock</span>
00427             }
00428             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00429         }
00430     }
00431 
00432     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>) {
00433         Length = <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length;
00434         <span class="comment">//</span>
00435         <span class="comment">// truncate ridiculous strings</span>
00436         <span class="comment">//</span>
00437         <span class="keywordflow">if</span> (Length &gt; <a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a>) {
00438             Length = <a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a>;
00439         }
00440 
00441         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> + Length &lt;= <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>+<a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a>) {
00442             LengthCopied = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a>, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer, Length);
00443             <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> += LengthCopied;
00444             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> &gt;= <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>+<a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a>) {
00445                 <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>;
00446                 <a class="code" href="../../d8/d5/kddata_8c.html#a48">KdPrintRolloverCount</a>++;
00447             }
00448         } <span class="keywordflow">else</span> {
00449             ULONG First = (ULONG)(<a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a> + <a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a> - <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a>);
00450             LengthCopied = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a>,
00451                                          <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer,
00452                                          First);
00453             <span class="keywordflow">if</span> (LengthCopied == First) {
00454                 LengthCopied += <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>,
00455                                               <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer + First,
00456                                               Length - First);
00457             }
00458             <span class="keywordflow">if</span> (LengthCopied &gt; First) {
00459                 <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a> + LengthCopied - First;
00460                 <a class="code" href="../../d8/d5/kddata_8c.html#a48">KdPrintRolloverCount</a>++;
00461             } <span class="keywordflow">else</span> {
00462                 <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> += LengthCopied;
00463                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> &gt;= <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>+<a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a>) {
00464                     <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>;
00465                     <a class="code" href="../../d8/d5/kddata_8c.html#a48">KdPrintRolloverCount</a>++;
00466                 }
00467             }
00468         }
00469     }
00470 
00471     KiReleaseSpinLock(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a49">KdpPrintSpinLock</a>);
00472     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00473 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
