<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: logpgsup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>logpgsup.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>"</code><br>

<p>
<a href="../../d7/d4/logpgsup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/logpgsup_8c.html#a0">Dbg</a>&nbsp;&nbsp;&nbsp;(DEBUG_TRACE_LOG_PAGE_SUP)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/logpgsup_8c.html#a1">MODULE_POOL_TAG</a>&nbsp;&nbsp;&nbsp;('PsfL')</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/logpgsup_8c.html#a2">LfsNextLogPageOffset</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN LONGLONG CurrentLogPageOffset, OUT PLONGLONG NextLogPageOffset, OUT PBOOLEAN Wrapped)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/logpgsup_8c.html#a3">LfsAllocateSpanningBuffer</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/logpgsup_8c.html#a4">LfsFreeSpanningBuffer</a> (IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="logpgsup.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(DEBUG_TRACE_LOG_PAGE_SUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00027">27</a> of file <a class="el" href="../../d7/d4/logpgsup_8c-source.html">logpgsup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="logpgsup.c::MODULE_POOL_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MODULE_POOL_TAG&nbsp;&nbsp;&nbsp;('PsfL')          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00030">30</a> of file <a class="el" href="../../d7/d4/logpgsup_8c-source.html">logpgsup.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="logpgsup.c::LfsAllocateSpanningBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID LfsAllocateSpanningBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00113">113</a> of file <a class="el" href="../../d7/d4/logpgsup_8c-source.html">logpgsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00657">_LFS_DATA::Buffer1</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00658">_LFS_DATA::Buffer2</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00660">_LFS_DATA::BufferFlags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00659">_LFS_DATA::BufferOwner</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02455">ExGetCurrentResourceThread</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00670">LFS_BUFFER1_OWNED</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00671">LFS_BUFFER2_OWNED</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00673">LFS_BUFFER_SIZE</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00490">LfsAcquireBufferLock</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00509">LfsAcquireLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00046">LfsAllocatePoolNoRaise</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00506">LfsBlockBufferWaiters</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00033">LfsData</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00493">LfsReleaseBufferLock</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00496">LfsWaitForBufferNotification</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l00809">LfsFindLogRecord()</a>.
<p>
<pre class="fragment"><div>00120                    :
00121 
00122     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to allocate a spare buffer to read a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> record
00123     which spans a log page.  We will first <span class="keywordflow">try</span> to allocate one.  If that
00124     fails we will use one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> existing spare buffers.  If that fails then
00125     we will raise.
00126 
00127 Arguments:
00128 
00129     Lfcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00130 
00131     Length - Length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer required.
00132 
00133 Return Value:
00134 
00135     PVOID - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to use <span class="keywordflow">for</span> reading <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record.
00136         May be either from <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> or from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> auxilary buffer <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00137 
00138 --*/
00139 
00140 {
00141     PVOID NewBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00142     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> Thread;
00143     BOOLEAN Wait = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00144 
00145     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00146 
00147     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsAllocateSpanningBuffer:  Entered\n"</span>, 0 );
00148 
00149     <span class="comment">//</span>
00150     <span class="comment">//  Loop while we don't have a buffer.  First try to get our reserved buffer</span>
00151     <span class="comment">//  without waiting.  Then try to allocate a buffer.  Finally wait for the reserved</span>
00152     <span class="comment">//  buffer as the final alternative.</span>
00153     <span class="comment">//</span>
00154 
00155     <span class="keywordflow">do</span> {
00156 
00157         <span class="comment">//</span>
00158         <span class="comment">//  Skip the reserved buffer if the request is larger than we can read into it.</span>
00159         <span class="comment">//</span>
00160 
00161         <span class="keywordflow">if</span> (Length &lt;= <a class="code" href="../../d1/d4/lfsstruc_8h.html#a23">LFS_BUFFER_SIZE</a>) {
00162 
00163             <span class="comment">//</span>
00164             <span class="comment">//  If this thread already owns one buffer it can get the second directly.</span>
00165             <span class="comment">//</span>
00166 
00167             Thread = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
00168 
00169             <span class="keywordflow">if</span> (Thread == <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o7">BufferOwner</a>) {
00170 
00171                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER1_OWNED )) {
00172 
00173                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER1_OWNED );
00174                     NewBuffer = <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o5">Buffer1</a>;
00175                     <span class="keywordflow">break</span>;
00176 
00177                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER2_OWNED )) {
00178 
00179                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER2_OWNED );
00180                     NewBuffer = <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o6">Buffer2</a>;
00181                     <span class="keywordflow">break</span>;
00182 
00183                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Wait) {
00184 
00185                     <span class="comment">//</span>
00186                     <span class="comment">//  This shouldn't happen but handle anyway.</span>
00187                     <span class="comment">//</span>
00188 
00189                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsAllocateSpanningBuffer:  Exit\n"</span>, 0 );
00190                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00191                 }
00192 
00193             <span class="comment">//</span>
00194             <span class="comment">//  Otherwise acquire the buffer lock and check the state of the buffers.</span>
00195             <span class="comment">//</span>
00196 
00197             } <span class="keywordflow">else</span> {
00198 
00199                 BOOLEAN LfcbOwned = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00200 
00201                 <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00202 
00203                     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a23">LfsAcquireBufferLock</a>();
00204 
00205                     <span class="comment">//</span>
00206                     <span class="comment">//  Check to see if the buffers are available.  No</span>
00207                     <span class="comment">//  need to drop the Lfcb in the typical case.</span>
00208                     <span class="comment">//</span>
00209 
00210                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o7">BufferOwner</a> == (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00211 
00212                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER1_OWNED | LFS_BUFFER2_OWNED ));
00213                         NewBuffer = <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o5">Buffer1</a>;
00214                         <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o7">BufferOwner</a> = Thread;
00215                         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER1_OWNED );
00216                         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a27">LfsBlockBufferWaiters</a>();
00217                         
00218                         <span class="comment">//</span>
00219                         <span class="comment">//  Reacquire the Lfcb if needed.</span>
00220                         <span class="comment">//</span>
00221 
00222                         <span class="keywordflow">if</span> (!LfcbOwned) { 
00223 
00224                             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
00225                         }
00226 
00227                         <span class="comment">//</span>
00228                         <span class="comment">//  Break out.</span>
00229                         <span class="comment">//</span>
00230 
00231                         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a24">LfsReleaseBufferLock</a>();
00232                         <span class="keywordflow">break</span>;
00233                     }
00234 
00235                     <span class="comment">//</span>
00236                     <span class="comment">//  Release the Lfcb and wait on the notification for the buffers.</span>
00237                     <span class="comment">//</span>
00238 
00239                     <span class="keywordflow">if</span> (Wait) {
00240 
00241                         <span class="keywordflow">if</span> (LfcbOwned) { 
00242                             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
00243                             LfcbOwned = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00244                         }
00245 
00246                         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a24">LfsReleaseBufferLock</a>();
00247                         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a25">LfsWaitForBufferNotification</a>();
00248 
00249                     } <span class="keywordflow">else</span> {
00250 
00251                         <span class="comment">//</span>
00252                         <span class="comment">//  Go ahead and try to allocate a buffer from pool next.</span>
00253                         <span class="comment">//</span>
00254 
00255                         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a24">LfsReleaseBufferLock</a>();
00256                         <span class="keywordflow">break</span>;
00257                     }
00258                 }
00259             }
00260 
00261         <span class="comment">//</span>
00262         <span class="comment">//  Raise if we already tried the allocate path.</span>
00263         <span class="comment">//</span>
00264 
00265         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Wait) {
00266 
00267             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsAllocateSpanningBuffer:  Exit\n"</span>, 0 );
00268             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00269         }
00270 
00271         <span class="comment">//</span>
00272         <span class="comment">//  Try pool if we didn't get a buffer above.</span>
00273         <span class="comment">//</span>
00274 
00275         <span class="keywordflow">if</span> (NewBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00276 
00277             <span class="comment">//</span>
00278             <span class="comment">//  Try pool next but don't let this fail on pool allocation.</span>
00279             <span class="comment">//</span>
00280 
00281             NewBuffer = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a2">LfsAllocatePoolNoRaise</a>( PagedPool, Length );
00282         }
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">//  Wait on the next pass through the loop.</span>
00286         <span class="comment">//</span>
00287 
00288         Wait = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00289 
00290     } <span class="keywordflow">while</span> (NewBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00291 
00292     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsAllocateSpanningBuffer:  Exit\n"</span>, 0 );
00293     <span class="keywordflow">return</span> NewBuffer;
00294 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="logpgsup.c::LfsFreeSpanningBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsFreeSpanningBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Buffer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00297">297</a> of file <a class="el" href="../../d7/d4/logpgsup_8c-source.html">logpgsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00657">_LFS_DATA::Buffer1</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00660">_LFS_DATA::BufferFlags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00659">_LFS_DATA::BufferOwner</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02455">ExGetCurrentResourceThread</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00670">LFS_BUFFER1_OWNED</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00671">LFS_BUFFER2_OWNED</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00490">LfsAcquireBufferLock</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00033">LfsData</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00048">LfsFreePool</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00503">LfsNotifyBufferWaiters</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00493">LfsReleaseBufferLock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00518">LfsDeallocateLcb()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00809">LfsFindLogRecord()</a>, and <a class="el" href="../../d4/d2/querylog_8c-source.html#l00299">LfsReadNextLogRecord()</a>.
<p>
<pre class="fragment"><div>00303                    :
00304 
00305     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to free a buffer used to read a log record
00306     which spans pages.  We will check <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one of our special buffers
00307     and deal with synchronization in that <span class="keywordflow">case</span>.
00308 
00309 Arguments:
00310 
00311     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> to free.
00312 
00313 Return Value:
00314 
00315     None.
00316 
00317 --*/
00318 
00319 {
00320     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> Thread;
00321 
00322     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00323 
00324     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsFreeSpanningBuffer:  Entered\n"</span>, 0 );
00325 
00326     <span class="comment">//</span>
00327     <span class="comment">//  Do an unsafe test of the buffer flags.  If we own a buffer then they must be non-zero.</span>
00328     <span class="comment">//  Otherwise do the correct check of the resource thread.</span>
00329     <span class="comment">//</span>
00330 
00331     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER1_OWNED | LFS_BUFFER2_OWNED ) ||
00332         (<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o7">BufferOwner</a> != <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>())) {
00333 
00334         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a4">LfsFreePool</a>( Buffer );
00335 
00336     } <span class="keywordflow">else</span> {
00337 
00338         <span class="comment">//</span>
00339         <span class="comment">//  Acquire the lock for synchronization.</span>
00340         <span class="comment">//</span>
00341 
00342         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a23">LfsAcquireBufferLock</a>();
00343 
00344         <span class="comment">//</span>
00345         <span class="comment">//  Check which buffer it is.</span>
00346         <span class="comment">//</span>
00347 
00348         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> == <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o5">Buffer1</a>) {
00349 
00350             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER1_OWNED );
00351 
00352         } <span class="keywordflow">else</span> {
00353 
00354             <span class="comment">//</span>
00355             <span class="comment">//  It better be buffer2</span>
00356             <span class="comment">//</span>
00357 
00358             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER2_OWNED ));
00359             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER2_OWNED );
00360         }
00361 
00362         <span class="comment">//</span>
00363         <span class="comment">//  If no buffers owned then signal the waiters.</span>
00364         <span class="comment">//</span>
00365 
00366         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o8">BufferFlags</a>, LFS_BUFFER1_OWNED | LFS_BUFFER2_OWNED )) {
00367 
00368             <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o7">BufferOwner</a> = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00369             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a26">LfsNotifyBufferWaiters</a>();
00370         }
00371 
00372         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a24">LfsReleaseBufferLock</a>();
00373     }
00374 
00375     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsFreeSpanningBuffer:  Exit\n"</span>, 0 );
00376 
00377     <span class="keywordflow">return</span>;
00378 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="logpgsup.c::LfsNextLogPageOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsNextLogPageOffset           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentLogPageOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NextLogPageOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wrapped</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00040">40</a> of file <a class="el" href="../../d7/d4/logpgsup_8c-source.html">logpgsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00184">LfsTruncateOffsetToLogPage</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00339">LfsCopyReadLogRecord()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03193">LfsFindLastLsn()</a>, <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00148">LfsFindNextLsn()</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00311">LfsGetLbcb()</a>, <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00036">LfsLsnFinalOffset()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>.
<p>
<pre class="fragment"><div>00049                    :
00050 
00051     This routine will compute <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next log
00052     page.
00053 
00054 Arguments:
00055 
00056     Lfcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00057 
00058     CurrentLogPageOffset - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current log page.
00059 
00060     NextLogPageOffset - Address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next log page to use.
00061 
00062     Wrapped - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to a <span class="keywordtype">boolean</span> variable that, <span class="keywordflow">if</span> present,
00063               we use to indicate whether we wrapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00064 
00065 Return Value:
00066 
00067     None.
00068 
00069 --*/
00070 
00071 {
00072     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00073 
00074     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsNextLogPageOffset:  Entered\n"</span>, 0 );
00075     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb                          -&gt;  %08lx\n"</span>, Lfcb );
00076     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"CurrentLogPageOffset (Low)    -&gt;  %08lx\n"</span>, CurrentLogPageOffset.LowPart );
00077     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"CurrentLogPageOffset (High)   -&gt;  %08lx\n"</span>, CurrentLogPageOffset.HighPart );
00078     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Wrapped                       -&gt;  %08lx\n"</span>, Wrapped );
00079 
00080     <span class="comment">//</span>
00081     <span class="comment">//  We add the log page size to the current log offset.</span>
00082     <span class="comment">//</span>
00083 
00084     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a6">LfsTruncateOffsetToLogPage</a>( Lfcb, CurrentLogPageOffset, &amp;CurrentLogPageOffset );
00085     *NextLogPageOffset = CurrentLogPageOffset + Lfcb-&gt;LogPageSize;                                                     <span class="comment">//**** xxAdd( CurrentLogPageOffset, Lfcb-&gt;LogPageSize );</span>
00086 
00087     <span class="comment">//</span>
00088     <span class="comment">//  If the result is larger than the file, we use the first page offset</span>
00089     <span class="comment">//  in the file.</span>
00090     <span class="comment">//</span>
00091 
00092     <span class="keywordflow">if</span> ( *NextLogPageOffset &gt;= Lfcb-&gt;FileSize ) {                                                                      <span class="comment">//**** xxGeq( *NextLogPageOffset, Lfcb-&gt;FileSize )</span>
00093 
00094         *NextLogPageOffset = Lfcb-&gt;FirstLogPage;
00095 
00096         *Wrapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00097 
00098     } <span class="keywordflow">else</span> {
00099 
00100         *Wrapped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00101     }
00102 
00103     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"NextLogPageOffset (Low)    -&gt;  %08lx\n"</span>, NextLogPageOffset-&gt;LowPart );
00104     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"NextLogPageOffset (High)   -&gt;  %08lx\n"</span>, NextLogPageOffset-&gt;HighPart );
00105     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Wrapped                    -&gt;  %08x\n"</span>, *Wrapped );
00106     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsNextLogPageOffset:  Exit\n"</span>, 0 );
00107 
00108     <span class="keywordflow">return</span>;
00109 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
