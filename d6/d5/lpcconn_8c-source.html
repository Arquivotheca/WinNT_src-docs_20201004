<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lpcconn.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lpcconn.c</h1><a href="../../d5/d6/lpcconn_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    lpcconn.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Local Inter-Process Communication (LPC) connection system services.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 15-May-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d0/d7/lpcp_8h.html">lpcp.h</a>"</span>
00022 
00023 <span class="comment">//</span>
00024 <span class="comment">//  Local procedure prototypes</span>
00025 <span class="comment">//</span>
00026 
00027 PVOID
00028 <a class="code" href="../../d5/d6/lpcconn_8c.html#a0">LpcpFreeConMsg</a>(
00029     IN <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> *Msg,
00030     <a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a> *ConnectMsg,
00031     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread
00032     );
00033 
00034 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtConnectPort)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,LpcpFreeConMsg)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span>
00039 
00040 NTSYSAPI
00041 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00042 NTAPI
<a name="l00043"></a><a class="code" href="../../d5/d6/lpcconn_8c.html#a1">00043</a> <a class="code" href="../../d5/d6/lpcconn_8c.html#a1">NtConnectPort</a> (
00044     OUT PHANDLE PortHandle,
00045     IN PUNICODE_STRING PortName,
00046     IN PSECURITY_QUALITY_OF_SERVICE SecurityQos,
00047     IN OUT PPORT_VIEW ClientView OPTIONAL,
00048     IN OUT PREMOTE_PORT_VIEW ServerView OPTIONAL,
00049     OUT PULONG MaxMessageLength OPTIONAL,
00050     IN OUT PVOID ConnectionInformation OPTIONAL,
00051     IN OUT PULONG ConnectionInformationLength OPTIONAL
00052     )
00053 
00054 <span class="comment">/*++</span>
00055 <span class="comment"></span>
00056 <span class="comment">Routine Description:</span>
00057 <span class="comment"></span>
00058 <span class="comment">    See NtSecureConnectPort</span>
00059 <span class="comment"></span>
00060 <span class="comment">Arguments:</span>
00061 <span class="comment"></span>
00062 <span class="comment">    See NtSecureConnectPort</span>
00063 <span class="comment"></span>
00064 <span class="comment">Return Value:</span>
00065 <span class="comment"></span>
00066 <span class="comment">    NTSTATUS - An appropriate status value</span>
00067 <span class="comment"></span>
00068 <span class="comment">--*/</span>
00069 
00070 {
00071     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/lpcconn_8c.html#a2">NtSecureConnectPort</a>( <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>,
00072                                 <a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a>,
00073                                 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>,
00074                                 ClientView,
00075                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00076                                 ServerView,
00077                                 MaxMessageLength,
00078                                 ConnectionInformation,
00079                                 ConnectionInformationLength );
00080 }
00081 
00082 
00083 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00084"></a><a class="code" href="../../d5/d6/lpcconn_8c.html#a2">00084</a> <a class="code" href="../../d5/d6/lpcconn_8c.html#a2">NtSecureConnectPort</a> (
00085     OUT PHANDLE PortHandle,
00086     IN PUNICODE_STRING PortName,
00087     IN PSECURITY_QUALITY_OF_SERVICE SecurityQos,
00088     IN OUT PPORT_VIEW ClientView OPTIONAL,
00089     IN PSID RequiredServerSid,
00090     IN OUT PREMOTE_PORT_VIEW ServerView OPTIONAL,
00091     OUT PULONG MaxMessageLength OPTIONAL,
00092     IN OUT PVOID ConnectionInformation OPTIONAL,
00093     IN OUT PULONG ConnectionInformationLength OPTIONAL
00094     )
00095 
00096 <span class="comment">/*++</span>
00097 <span class="comment"></span>
00098 <span class="comment">Routine Description:</span>
00099 <span class="comment"></span>
00100 <span class="comment">    A client process can connect to a server process by name using the</span>
00101 <span class="comment">    NtConnectPort service.</span>
00102 <span class="comment"></span>
00103 <span class="comment">    The PortName parameter specifies the name of the server port to</span>
00104 <span class="comment">    connect to.  It must correspond to an object name specified on a</span>
00105 <span class="comment">    call to NtCreatePort.  The service sends a connection request to the</span>
00106 <span class="comment">    server thread that is listening for them with the NtListenPort</span>
00107 <span class="comment">    service.  The client thread then blocks until a server thread</span>
00108 <span class="comment">    receives the connection request and responds with a call to the</span>
00109 <span class="comment">    NtCompleteConnectPort service.  The server thread receives the ID of</span>
00110 <span class="comment">    the client thread, along with any information passed via the</span>
00111 <span class="comment">    ConnectionInformation parameter.  The server thread then decides to</span>
00112 <span class="comment">    either accept or reject the connection request.</span>
00113 <span class="comment"></span>
00114 <span class="comment">    The server communicates the acceptance or rejection with the</span>
00115 <span class="comment">    NtCompleteConnectPort service.  The server can pass back data to the</span>
00116 <span class="comment">    client about the acceptance or rejection via the</span>
00117 <span class="comment">    ConnectionInformation data block.</span>
00118 <span class="comment"></span>
00119 <span class="comment">    If the server accepts the connection request, then the client</span>
00120 <span class="comment">    receives a communication port object in the location pointed to by</span>
00121 <span class="comment">    the PortHandle parameter.  This object handle has no name associated</span>
00122 <span class="comment">    with it and is private to the client process (i.e.  it cannot be</span>
00123 <span class="comment">    inherited by a child process).  The client uses the handle to send</span>
00124 <span class="comment">    and receive messages to/from the server process using the</span>
00125 <span class="comment">    NtRequestWaitReplyPort service.</span>
00126 <span class="comment"></span>
00127 <span class="comment">    If the ClientView parameter was specified, then the section handle</span>
00128 <span class="comment">    is examined.  If it is a valid section handle, then the portion of</span>
00129 <span class="comment">    the section described by the SectionOffset and ViewSize fields will</span>
00130 <span class="comment">    be mapped into both the client and server process' address spaces.</span>
00131 <span class="comment">    The address in client address space will be returned in the ViewBase</span>
00132 <span class="comment">    field.  The address in the server address space will be returned in</span>
00133 <span class="comment">    the ViewRemoteBase field.  The actual offset and size used to map</span>
00134 <span class="comment">    the section will be returned in the SectionOffset and ViewSize</span>
00135 <span class="comment">    fields.</span>
00136 <span class="comment"></span>
00137 <span class="comment">    If the server rejects the connection request, then no communication</span>
00138 <span class="comment">    port object handle is returned, and the return status indicates an</span>
00139 <span class="comment">    error occurred.  The server may optionally return information in the</span>
00140 <span class="comment">    ConnectionInformation data block giving the reason the connection</span>
00141 <span class="comment">    requests was rejected.</span>
00142 <span class="comment"></span>
00143 <span class="comment">    If the PortName does not exist, or the client process does not have</span>
00144 <span class="comment">    sufficient access rights then the returned status will indicate that</span>
00145 <span class="comment">    the port was not found.</span>
00146 <span class="comment"></span>
00147 <span class="comment">Arguments:</span>
00148 <span class="comment"></span>
00149 <span class="comment">    PortHandle - A pointer to a variable that will receive the client</span>
00150 <span class="comment">        communication port object handle value.</span>
00151 <span class="comment"></span>
00152 <span class="comment">    PortName - A pointer to a port name string.  The form of the name</span>
00153 <span class="comment">        is [\name...\name]\port_name.</span>
00154 <span class="comment"></span>
00155 <span class="comment">    SecurityQos - A pointer to security quality of service information</span>
00156 <span class="comment">        to be applied to the server on the client's behalf.</span>
00157 <span class="comment"></span>
00158 <span class="comment">    ClientView - An optional pointer to a structure that specifies the</span>
00159 <span class="comment">        section that all client threads will use to send messages to the</span>
00160 <span class="comment">        server.</span>
00161 <span class="comment"></span>
00162 <span class="comment">    ClientView Structure</span>
00163 <span class="comment"></span>
00164 <span class="comment">        ULONG Length - Specifies the size of this data structure in</span>
00165 <span class="comment">            bytes.</span>
00166 <span class="comment"></span>
00167 <span class="comment">        HANDLE SectionHandle - Specifies an open handle to a section</span>
00168 <span class="comment">            object.</span>
00169 <span class="comment"></span>
00170 <span class="comment">        ULONG SectionOffset - Specifies a field that will receive the</span>
00171 <span class="comment">            actual offset, in bytes, from the start of the section.  The</span>
00172 <span class="comment">            initial value of this parameter specifies the byte offset</span>
00173 <span class="comment">            within the section that the client's view is based.  The</span>
00174 <span class="comment">            value is rounded down to the next host page size boundary.</span>
00175 <span class="comment"></span>
00176 <span class="comment">        ULONG ViewSize - Specifies a field that will receive the</span>
00177 <span class="comment">            actual size, in bytes, of the view.  If the value of this</span>
00178 <span class="comment">            parameter is zero, then the client's view of the section</span>
00179 <span class="comment">            will be mapped starting at the specified section offset and</span>
00180 <span class="comment">            continuing to the end of the section.  Otherwise, the</span>
00181 <span class="comment">            initial value of this parameter specifies the size, in</span>
00182 <span class="comment">            bytes, of the client's view and is rounded up to the next</span>
00183 <span class="comment">            host page size boundary.</span>
00184 <span class="comment"></span>
00185 <span class="comment">        PVOID ViewBase - Specifies a field that will receive the base</span>
00186 <span class="comment">            address of the section in the client's address space.</span>
00187 <span class="comment"></span>
00188 <span class="comment">        PVOID ViewRemoteBase - Specifies a field that will receive</span>
00189 <span class="comment">            the base address of the client's section in the server's</span>
00190 <span class="comment">            address space.  Used to generate pointers that are</span>
00191 <span class="comment">            meaningful to the server.</span>
00192 <span class="comment"></span>
00193 <span class="comment">    RequiredServerSid - Optionally specifies the SID that we expect the</span>
00194 <span class="comment">        server side of the port to possess.  If not specified then we'll</span>
00195 <span class="comment">        connect to any server SID.</span>
00196 <span class="comment"></span>
00197 <span class="comment">    ServerView - An optional pointer to a structure that will receive</span>
00198 <span class="comment">        information about the server process' view in the client's</span>
00199 <span class="comment">        address space.  The client process can use this information</span>
00200 <span class="comment">        to validate pointers it receives from the server process.</span>
00201 <span class="comment"></span>
00202 <span class="comment">        ServerView Structure</span>
00203 <span class="comment"></span>
00204 <span class="comment">        ULONG Length - Specifies the size of this data structure in</span>
00205 <span class="comment">            bytes.</span>
00206 <span class="comment"></span>
00207 <span class="comment">        PVOID ViewBase - Specifies a field that will receive the base</span>
00208 <span class="comment">            address of the server's section in the client's address</span>
00209 <span class="comment">            space.</span>
00210 <span class="comment"></span>
00211 <span class="comment">        ULONG ViewSize - Specifies a field that will receive the</span>
00212 <span class="comment">            size, in bytes, of the server's view in the client's address</span>
00213 <span class="comment">            space.  If this field is zero, then server has no view in</span>
00214 <span class="comment">            the client's address space.</span>
00215 <span class="comment"></span>
00216 <span class="comment">    MaxMessageLength - An optional pointer to a variable that will</span>
00217 <span class="comment">        receive maximum length of messages that can be sent to the</span>
00218 <span class="comment">        server.  The value of this parameter will not exceed</span>
00219 <span class="comment">        MAX_PORTMSG_LENGTH bytes.</span>
00220 <span class="comment"></span>
00221 <span class="comment">    ConnectionInformation - An optional pointer to uninterpreted data.</span>
00222 <span class="comment">        This data is intended for clients to pass package, version and</span>
00223 <span class="comment">        protocol identification information to the server to allow the</span>
00224 <span class="comment">        server to determine if it can satisify the client before</span>
00225 <span class="comment">        accepting the connection.  Upon return to the client, the</span>
00226 <span class="comment">        ConnectionInformation data block contains any information passed</span>
00227 <span class="comment">        back from the server by its call to the NtCompleteConnectPort</span>
00228 <span class="comment">        service.  The output data overwrites the input data.</span>
00229 <span class="comment"></span>
00230 <span class="comment">    ConnectionInformationLength - Pointer to the length of the</span>
00231 <span class="comment">        ConnectionInformation data block.  The output value is the</span>
00232 <span class="comment">        length of the data stored in the ConnectionInformation data</span>
00233 <span class="comment">        block by the server's call to the NtCompleteConnectPort</span>
00234 <span class="comment">        service.  This parameter is OPTIONAL only if the</span>
00235 <span class="comment">        ConnectionInformation parameter is null, otherwise it is</span>
00236 <span class="comment">        required.</span>
00237 <span class="comment"></span>
00238 <span class="comment">Return Value:</span>
00239 <span class="comment"></span>
00240 <span class="comment">    NTSTATUS - An appropriate status value.</span>
00241 <span class="comment"></span>
00242 <span class="comment">--*/</span>
00243 
00244 {
00245     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> ConnectionPort;
00246     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> ClientPort;
00247     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00248     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00249     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00250     ULONG ConnectionInfoLength;
00251     PVOID SectionToMap;
00252     <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> Msg;
00253     <a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a> ConnectMsg;
00254     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00255     LARGE_INTEGER SectionOffset;
00256     PORT_VIEW CapturedClientView;
00257     SECURITY_QUALITY_OF_SERVICE CapturedQos;
00258     PSID CapturedRequiredServerSid;
00259 
00260     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00261 
00262     <span class="comment">//</span>
00263     <span class="comment">//  Get previous processor mode and probe input and output arguments if</span>
00264     <span class="comment">//  necessary.</span>
00265     <span class="comment">//</span>
00266 
00267     PreviousMode = KeGetPreviousMode();
00268     ConnectionInfoLength = 0;
00269 
00270     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00271 
00272         <span class="keywordflow">try</span> {
00273 
00274             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>( <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> );
00275 
00276             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientView )) {
00277 
00278                 CapturedClientView = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>( ClientView, PORT_VIEW );
00279 
00280                 <span class="keywordflow">if</span> (CapturedClientView.Length != <span class="keyword">sizeof</span>( *ClientView )) {
00281 
00282                     <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00283                 }
00284 
00285                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( ClientView,
00286                                <span class="keyword">sizeof</span>( *ClientView ),
00287                                <span class="keyword">sizeof</span>( ULONG ));
00288             }
00289 
00290             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ServerView )) {
00291 
00292                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>( &amp;ServerView-&gt;Length ) != <span class="keyword">sizeof</span>( *ServerView )) {
00293 
00294                     <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00295                 }
00296 
00297                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( ServerView,
00298                                <span class="keyword">sizeof</span>( *ServerView ),
00299                                <span class="keyword">sizeof</span>( ULONG ));
00300             }
00301 
00302             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( MaxMessageLength )) {
00303 
00304                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>( MaxMessageLength );
00305             }
00306 
00307             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformationLength )) {
00308 
00309                 ConnectionInfoLength = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>( ConnectionInformationLength );
00310                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>( ConnectionInformationLength );
00311             }
00312 
00313             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformation )) {
00314 
00315                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( ConnectionInformation,
00316                                ConnectionInfoLength,
00317                                <span class="keyword">sizeof</span>( UCHAR ));
00318             }
00319 
00320             CapturedQos = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>, SECURITY_QUALITY_OF_SERVICE );
00321 
00322             CapturedRequiredServerSid = RequiredServerSid;
00323 
00324             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( RequiredServerSid )) {
00325 
00326                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a8">SeCaptureSid</a>( RequiredServerSid,
00327                                        PreviousMode,
00328                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00329                                        0,
00330                                        <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00331                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00332                                        &amp;CapturedRequiredServerSid );
00333 
00334                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00335 
00336                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00337                 }
00338             }
00339 
00340         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00341 
00342             <span class="keywordflow">return</span>( GetExceptionCode() );
00343         }
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">//  Otherwise this is a kernel mode operation</span>
00347     <span class="comment">//</span>
00348 
00349     } <span class="keywordflow">else</span> {
00350 
00351         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientView )) {
00352 
00353             <span class="keywordflow">if</span> (ClientView-&gt;Length != <span class="keyword">sizeof</span>( *ClientView )) {
00354 
00355                 <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00356             }
00357 
00358             CapturedClientView = *ClientView;
00359         }
00360 
00361         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ServerView )) {
00362 
00363             <span class="keywordflow">if</span> (ServerView-&gt;Length != <span class="keyword">sizeof</span>( *ServerView )) {
00364 
00365                 <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00366             }
00367         }
00368 
00369         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformationLength )) {
00370 
00371             ConnectionInfoLength = *ConnectionInformationLength;
00372         }
00373 
00374         CapturedQos = *<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>;
00375         CapturedRequiredServerSid = RequiredServerSid;
00376     }
00377 
00378     <span class="comment">//</span>
00379     <span class="comment">//  Reference the connection port object by name.  Return status if</span>
00380     <span class="comment">//  unsuccessful.</span>
00381     <span class="comment">//</span>
00382 
00383     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a5">ObReferenceObjectByName</a>( <a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a>,
00384                                       0,
00385                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00386                                       PORT_CONNECT,
00387                                       <a class="code" href="../../d9/d8/ntos_8h.html#a5">LpcPortObjectType</a>,
00388                                       PreviousMode,
00389                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00390                                       (PVOID *)&amp;ConnectionPort );
00391 
00392     <span class="comment">//</span>
00393     <span class="comment">//  If the port type object didn't work then try for a waitable port type</span>
00394     <span class="comment">//  object</span>
00395     <span class="comment">//</span>
00396 
00397     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_TYPE_MISMATCH ) {
00398 
00399         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a5">ObReferenceObjectByName</a>( <a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a>,
00400                                           0,
00401                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00402                                           PORT_CONNECT,
00403                                           <a class="code" href="../../d9/d8/ntos_8h.html#a6">LpcWaitablePortObjectType</a>,
00404                                           PreviousMode,
00405                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00406                                           (PVOID *)&amp;ConnectionPort );
00407     }
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">//  We can't locate the name so release the sid if we captured one and</span>
00411     <span class="comment">//  return error status back to our caller</span>
00412     <span class="comment">//</span>
00413 
00414     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00415 
00416         <span class="keywordflow">if</span> (CapturedRequiredServerSid != RequiredServerSid) {
00417 
00418             <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedRequiredServerSid, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00419         }
00420 
00421         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00422     }
00423 
00424     <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>((<span class="stringliteral">"Connecting to port %wZ\n"</span>, <a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a> ));
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">//  Error if user didn't give us a server communication port</span>
00428     <span class="comment">//</span>
00429 
00430     <span class="keywordflow">if</span> ((ConnectionPort-&gt;Flags &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a>) {
00431 
00432         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectionPort );
00433 
00434         <span class="keywordflow">if</span> (CapturedRequiredServerSid != RequiredServerSid) {
00435 
00436             <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedRequiredServerSid, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00437         }
00438 
00439         <span class="keywordflow">return</span> STATUS_INVALID_PORT_HANDLE;
00440     }
00441 
00442     <span class="comment">//</span>
00443     <span class="comment">//  If this is NtSecureConnectPort, validated the required SID against</span>
00444     <span class="comment">//  the SID of the server process.  Fail if not equal.</span>
00445     <span class="comment">//</span>
00446 
00447     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( RequiredServerSid )) {
00448 
00449         PTOKEN_USER TokenInfo;
00450 
00451         <span class="keywordflow">if</span> (ConnectionPort-&gt;ServerProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00452 
00453             PACCESS_TOKEN <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> ;
00454 
00455             <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>( ConnectionPort-&gt;ServerProcess );
00456 
00457     
00458             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a2">SeQueryInformationToken</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00459                                               TokenUser,
00460                                               &amp;TokenInfo );
00461             
00462             <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00463 
00464             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00465 
00466                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( CapturedRequiredServerSid, TokenInfo-&gt;User.Sid )) {
00467 
00468                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SERVER_SID_MISMATCH;
00469                 }
00470 
00471                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TokenInfo );
00472             }
00473 
00474         } <span class="keywordflow">else</span> {
00475 
00476             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SERVER_SID_MISMATCH;
00477         }
00478 
00479         <span class="comment">//</span>
00480         <span class="comment">//  We are all done with the required server sid if specified so</span>
00481         <span class="comment">//  now release one if we had to capture it</span>
00482         <span class="comment">//</span>
00483 
00484         <span class="keywordflow">if</span> (CapturedRequiredServerSid != RequiredServerSid) {
00485 
00486             <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedRequiredServerSid, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00487         }
00488 
00489         <span class="comment">//</span>
00490         <span class="comment">//  If the se information token query didn't work then return the</span>
00491         <span class="comment">//  error to our caller</span>
00492         <span class="comment">//</span>
00493 
00494         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00495 
00496             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectionPort );
00497 
00498             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00499         }
00500     }
00501 
00502     <span class="comment">//</span>
00503     <span class="comment">//  Allocate and initialize a client communication port object.  Give</span>
00504     <span class="comment">//  the port a request message queue for lost reply datagrams.  If</span>
00505     <span class="comment">//  unable to initialize the port, then deference the port object which</span>
00506     <span class="comment">//  will cause it to be deleted and return the system service status.</span>
00507     <span class="comment">//</span>
00508 
00509     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>( PreviousMode,
00510                              <a class="code" href="../../d9/d8/ntos_8h.html#a5">LpcPortObjectType</a>,
00511                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00512                              PreviousMode,
00513                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00514                              <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">LPCP_PORT_OBJECT</a> ),
00515                              0,
00516                              0,
00517                              (PVOID *)&amp;ClientPort );
00518 
00519     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00520 
00521         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectionPort );
00522 
00523         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00524     }
00525 
00526     <span class="comment">//</span>
00527     <span class="comment">//  Note, that from here on, none of the error paths dereference the</span>
00528     <span class="comment">//  connection port pointer, just the newly created client port pointer.</span>
00529     <span class="comment">//  The port delete routine will get called when the client port is</span>
00530     <span class="comment">//  deleted and it will dereference the connection port pointer stored</span>
00531     <span class="comment">//  in the client port object.</span>
00532     <span class="comment">//</span>
00533 
00534     <span class="comment">//</span>
00535     <span class="comment">//  Initialize the client port object to zeros and then fill in the</span>
00536     <span class="comment">//  fields.</span>
00537     <span class="comment">//</span>
00538 
00539     RtlZeroMemory( ClientPort, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/lpc_8h.html#a21">LPCP_PORT_OBJECT</a> ));
00540 
00541     ClientPort-&gt;Length = <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/lpc_8h.html#a21">LPCP_PORT_OBJECT</a> );
00542     ClientPort-&gt;Flags = <a class="code" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>;
00543     ClientPort-&gt;ConnectionPort = ConnectionPort;
00544     ClientPort-&gt;MaxMessageLength = ConnectionPort-&gt;MaxMessageLength;
00545     ClientPort-&gt;SecurityQos = CapturedQos;
00546 
00547     InitializeListHead( &amp;ClientPort-&gt;LpcReplyChainHead );
00548     InitializeListHead( &amp;ClientPort-&gt;LpcDataInfoChainHead );
00549 
00550     <span class="comment">//</span>
00551     <span class="comment">//  Set the security tracking mode, and initialize the client security</span>
00552     <span class="comment">//  context if it is static tracking.</span>
00553     <span class="comment">//</span>
00554 
00555     <span class="keywordflow">if</span> (CapturedQos.ContextTrackingMode == SECURITY_DYNAMIC_TRACKING) {
00556 
00557         ClientPort-&gt;Flags |= <a class="code" href="../../d2/d6/lpc_8h.html#a10">PORT_DYNAMIC_SECURITY</a>;
00558 
00559     } <span class="keywordflow">else</span> {
00560 
00561         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d5/seclient_8c.html#a1">SeCreateClientSecurity</a>( CurrentThread,
00562                                          &amp;CapturedQos,
00563                                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00564                                          &amp;ClientPort-&gt;StaticSecurity );
00565 
00566         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00567 
00568             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
00569 
00570             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00571         }
00572     }
00573 
00574     <span class="comment">//</span>
00575     <span class="comment">//  Client communication ports get a request message queue for lost</span>
00576     <span class="comment">//  replies.</span>
00577     <span class="comment">//</span>
00578 
00579     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/lpcqueue_8c.html#a0">LpcpInitializePortQueue</a>( ClientPort );
00580 
00581     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00582 
00583         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
00584 
00585         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00586     }
00587 
00588     <span class="comment">//</span>
00589     <span class="comment">//  If client has allocated a port memory section, then map a view of</span>
00590     <span class="comment">//  that section into the client's address space.  Also reference the</span>
00591     <span class="comment">//  section object so we can pass a pointer to the section object in</span>
00592     <span class="comment">//  connection request message.  If the server accepts the connection,</span>
00593     <span class="comment">//  then it will map a corresponding view of the section in the server's</span>
00594     <span class="comment">//  address space, using the referenced pointer passed in the connection</span>
00595     <span class="comment">//  request message.</span>
00596     <span class="comment">//</span>
00597 
00598     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientView )) {
00599 
00600         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( CapturedClientView.SectionHandle,
00601                                             SECTION_MAP_READ |
00602                                             SECTION_MAP_WRITE,
00603                                             <a class="code" href="../../d2/d1/mm_8h.html#a133">MmSectionObjectType</a>,
00604                                             PreviousMode,
00605                                             (PVOID *)&amp;SectionToMap,
00606                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00607 
00608         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00609 
00610             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
00611 
00612             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00613         }
00614 
00615         SectionOffset.LowPart = CapturedClientView.SectionOffset,
00616         SectionOffset.HighPart = 0;
00617 
00618         <span class="comment">//</span>
00619         <span class="comment">//  Now map a view of the section using the reference we just captured</span>
00620         <span class="comment">//  and not the section handle itself, because the handle may have changed</span>
00621         <span class="comment">//</span>
00622 
00623         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a>( SectionToMap,
00624                                      <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
00625                                      &amp;ClientPort-&gt;ClientSectionBase,
00626                                      0,
00627                                      0,
00628                                      &amp;SectionOffset,
00629                                      &amp;CapturedClientView.ViewSize,
00630                                      ViewUnmap,
00631                                      0,
00632                                      PAGE_READWRITE );
00633 
00634         CapturedClientView.SectionOffset = SectionOffset.LowPart;
00635 
00636         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00637 
00638             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SectionToMap );
00639             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
00640 
00641             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00642         }
00643 
00644         CapturedClientView.ViewBase = ClientPort-&gt;ClientSectionBase;
00645 
00646     } <span class="keywordflow">else</span> {
00647 
00648         SectionToMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00649     }
00650 
00651     <span class="comment">//</span>
00652     <span class="comment">//  Adjust the size of the connection info length that the client supplied</span>
00653     <span class="comment">//  to be the no longer than one the connection port will accept</span>
00654     <span class="comment">//</span>
00655 
00656     <span class="keywordflow">if</span> (ConnectionInfoLength &gt; ConnectionPort-&gt;MaxConnectionInfoLength) {
00657 
00658         ConnectionInfoLength = ConnectionPort-&gt;MaxConnectionInfoLength;
00659     }
00660 
00661     <span class="comment">//</span>
00662     <span class="comment">//  At this point the client port is all setup and now we have to</span>
00663     <span class="comment">//  allocate a request connection message for the server and send it off</span>
00664     <span class="comment">//</span>
00665     <span class="comment">//  Lock, allocate and then unlock the zone.  We are allocation a</span>
00666     <span class="comment">//  connection request message.  It holds the LPCP message, the LPCP</span>
00667     <span class="comment">//  connection message, and the user supplied connection information</span>
00668     <span class="comment">//</span>
00669 
00670     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00671 
00672     Msg = <a class="code" href="../../d3/d7/lpcqueue_8c.html#a4">LpcpAllocateFromPortZone</a>( <span class="keyword">sizeof</span>( *Msg ) +
00673                                     <span class="keyword">sizeof</span>( *ConnectMsg ) +
00674                                     ConnectionInfoLength );
00675 
00676     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00677 
00678     <span class="comment">//</span>
00679     <span class="comment">//  If we didn't get memory for the message then tell our caller we failed</span>
00680     <span class="comment">//</span>
00681 
00682     <span class="keywordflow">if</span> (Msg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00683 
00684         <span class="keywordflow">if</span> (SectionToMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00685 
00686             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SectionToMap );
00687         }
00688 
00689         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
00690 
00691         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00692     }
00693 
00694     <span class="comment">//</span>
00695     <span class="comment">//  Msg points to the LPCP message, followed by ConnectMsg which points to</span>
00696     <span class="comment">//  the LPCP connection message, followed by client specified information.</span>
00697     <span class="comment">//  We'll now fill it all in.</span>
00698     <span class="comment">//</span>
00699 
00700     ConnectMsg = (<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a>)(Msg + 1);
00701 
00702     <span class="comment">//</span>
00703     <span class="comment">//  This thread originated the message</span>
00704     <span class="comment">//</span>
00705 
00706     Msg-&gt;Request.ClientId = CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>;
00707 
00708     <span class="comment">//</span>
00709     <span class="comment">//  If we have a client view then copy over the client view information</span>
00710     <span class="comment">//  otherwise we'll zero out all of the view information</span>
00711     <span class="comment">//</span>
00712 
00713     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientView )) {
00714 
00715         Msg-&gt;Request.ClientViewSize = CapturedClientView.ViewSize;
00716 
00717         RtlMoveMemory( &amp;ConnectMsg-&gt;ClientView,
00718                        &amp;CapturedClientView,
00719                        <span class="keyword">sizeof</span>( CapturedClientView ));
00720 
00721         RtlZeroMemory( &amp;ConnectMsg-&gt;ServerView, <span class="keyword">sizeof</span>( ConnectMsg-&gt;ServerView ));
00722 
00723     } <span class="keywordflow">else</span> {
00724 
00725         Msg-&gt;Request.ClientViewSize = 0;
00726         RtlZeroMemory( ConnectMsg, <span class="keyword">sizeof</span>( *ConnectMsg ));
00727     }
00728 
00729     ConnectMsg-&gt;ClientPort = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;              <span class="comment">// Set below</span>
00730     ConnectMsg-&gt;SectionToMap = SectionToMap;
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">//  The data length is everything after the port message within the lpcp</span>
00734     <span class="comment">//  message.  In other words the connection message and the user supplied</span>
00735     <span class="comment">//  information</span>
00736     <span class="comment">//</span>
00737 
00738     Msg-&gt;Request.u1.s1.DataLength = (CSHORT)(<span class="keyword">sizeof</span>( *ConnectMsg ) +
00739                                              ConnectionInfoLength);
00740 
00741     <span class="comment">//</span>
00742     <span class="comment">//  The total length add on the LPCP message</span>
00743     <span class="comment">//</span>
00744     <span class="comment">//  **** should this just add on the size of a port message instead?</span>
00745     <span class="comment">//</span>
00746 
00747     Msg-&gt;Request.u1.s1.TotalLength = (CSHORT)(<span class="keyword">sizeof</span>( *Msg ) +
00748                                               Msg-&gt;Request.u1.s1.DataLength);
00749 
00750     <span class="comment">//</span>
00751     <span class="comment">//  This will be a connection request message</span>
00752     <span class="comment">//</span>
00753 
00754     Msg-&gt;Request.u2.s2.Type = LPC_CONNECTION_REQUEST;
00755 
00756     <span class="comment">//</span>
00757     <span class="comment">//  If the caller supplied some connection information then copy</span>
00758     <span class="comment">//  that into place right now</span>
00759     <span class="comment">//</span>
00760 
00761     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformation )) {
00762 
00763         <span class="keywordflow">try</span> {
00764 
00765             RtlMoveMemory( ConnectMsg + 1,
00766                            ConnectionInformation,
00767                            ConnectionInfoLength );
00768 
00769         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00770 
00771             <span class="comment">//</span>
00772             <span class="comment">//  If we fail then cleanup after ourselves and return the</span>
00773             <span class="comment">//  error to our caller</span>
00774             <span class="comment">//</span>
00775 
00776             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00777 
00778             <span class="keywordflow">if</span> (SectionToMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00779 
00780                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SectionToMap );
00781             }
00782 
00783             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
00784 
00785             <span class="keywordflow">return</span> GetExceptionCode();
00786         }
00787     }
00788 
00789     <span class="comment">//</span>
00790     <span class="comment">//  The message is mostly ready to go now put it on the servers queue.</span>
00791     <span class="comment">//</span>
00792     <span class="comment">//  Acquire the mutex that guards the LpcReplyMessage field of the</span>
00793     <span class="comment">//  thread.  Also acquire the semaphore that guards the connection</span>
00794     <span class="comment">//  request message queue.  Stamp the connection request message with</span>
00795     <span class="comment">//  a serial number, insert the message at the tail of the connection</span>
00796     <span class="comment">//  request message queue and remember the address of the message in</span>
00797     <span class="comment">//  the LpcReplyMessage field for the current thread.</span>
00798     <span class="comment">//</span>
00799 
00800     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00801 
00802     <span class="comment">//</span>
00803     <span class="comment">//  See if the port name has been deleted from under us.  If so, then</span>
00804     <span class="comment">//  don't queue the message and don't wait for a reply</span>
00805     <span class="comment">//</span>
00806 
00807     <span class="keywordflow">if</span> (ConnectionPort-&gt;Flags &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a9">PORT_NAME_DELETED</a>) {
00808 
00809         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
00810 
00811     } <span class="keywordflow">else</span> {
00812 
00813         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00814 
00815         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"Send Connect Msg %lx to Port %wZ (%lx)\n"</span>, Msg, <a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a>, ConnectionPort ));
00816 
00817         <span class="comment">//</span>
00818         <span class="comment">//  Stamp the request message with a serial number, insert the message</span>
00819         <span class="comment">//  at the tail of the request message queue</span>
00820         <span class="comment">//</span>
00821 
00822         Msg-&gt;RepliedToThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00823         Msg-&gt;Request.MessageId = <a class="code" href="../../d0/d7/lpcp_8h.html#a0">LpcpGenerateMessageId</a>();
00824 
00825         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = Msg-&gt;Request.MessageId;
00826 
00827         InsertTailList( &amp;ConnectionPort-&gt;MsgQueue.ReceiveHead, &amp;Msg-&gt;Entry );
00828         InsertTailList( &amp;ConnectionPort-&gt;LpcReplyChainHead, &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
00829 
00830         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = Msg;
00831 
00832         <span class="comment">//</span>
00833         <span class="comment">//  Reference the port we are passing in the connect msg so if we die</span>
00834         <span class="comment">//  it will still be valid for the server in NtAcceptConnectPort.  The</span>
00835         <span class="comment">//  reference will be release when the message is freed.</span>
00836         <span class="comment">//</span>
00837 
00838         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( ClientPort );
00839 
00840         ConnectMsg-&gt;ClientPort = ClientPort;
00841     }
00842 
00843     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00844 
00845     <span class="comment">//</span>
00846     <span class="comment">//  At this point the client's communcation port is all set up and the</span>
00847     <span class="comment">//  connection request message is in the server's queue.  So now we have</span>
00848     <span class="comment">//  to single the server and wait for a reply</span>
00849     <span class="comment">//</span>
00850 
00851     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00852 
00853         <span class="comment">//</span>
00854         <span class="comment">//  If this is a waitable port then set the event that they might be</span>
00855         <span class="comment">//  waiting on</span>
00856         <span class="comment">//</span>
00857 
00858         <span class="keywordflow">if</span> ( ConnectionPort-&gt;Flags &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a> ) {
00859 
00860             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;ConnectionPort-&gt;WaitEvent, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00861         }
00862 
00863         <span class="comment">//</span>
00864         <span class="comment">//  Increment the connection request message queue semaphore by one for</span>
00865         <span class="comment">//  the newly inserted connection request message.  Release the spin</span>
00866         <span class="comment">//  locks, while remaining at the dispatcher IRQL.  Then wait for the</span>
00867         <span class="comment">//  reply to this connection request by waiting on the LpcReplySemaphore</span>
00868         <span class="comment">//  for the current thread.</span>
00869         <span class="comment">//</span>
00870 
00871         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( ConnectionPort-&gt;MsgQueue.Semaphore,
00872                             1,
00873                             1,
00874                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00875 
00876         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>,
00877                                         <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00878                                         PreviousMode,
00879                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00880                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00881     }
00882 
00883     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_USER_APC) {
00884 
00885         <span class="comment">//</span>
00886         <span class="comment">//  if the semaphore is signaled, then clear it</span>
00887         <span class="comment">//</span>
00888 
00889         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/semphobj_8c.html#a2">KeReadStateSemaphore</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a> )) {
00890 
00891             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>,
00892                                    <a class="code" href="../../d6/d7/halmips_8h.html#a0">WrExecutive</a>,
00893                                    <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00894                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00895                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00896 
00897             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00898         }
00899     }
00900 
00901     <span class="comment">//</span>
00902     <span class="comment">//  A connection request is accepted if the ConnectedPort of the client's</span>
00903     <span class="comment">//  communication port has been filled in.</span>
00904     <span class="comment">//</span>
00905 
00906     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
00907 
00908         SectionToMap = <a class="code" href="../../d5/d6/lpcconn_8c.html#a0">LpcpFreeConMsg</a>( &amp;Msg, &amp;ConnectMsg, CurrentThread );
00909 
00910         <span class="comment">//</span>
00911         <span class="comment">//  Check that we got a reply message</span>
00912         <span class="comment">//</span>
00913 
00914         <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00915 
00916             <span class="comment">//</span>
00917             <span class="comment">//  Copy any connection information back to the caller, but first</span>
00918             <span class="comment">//  calculate the new connection data length for the reply and</span>
00919             <span class="comment">//  don't let it grow beyond what we probed originally</span>
00920             <span class="comment">//</span>
00921 
00922             <span class="keywordflow">if</span> ((Msg-&gt;Request.u1.s1.DataLength - <span class="keyword">sizeof</span>( *ConnectMsg )) &lt; ConnectionInfoLength) {
00923 
00924                 ConnectionInfoLength = Msg-&gt;Request.u1.s1.DataLength - <span class="keyword">sizeof</span>( *ConnectMsg );
00925             }
00926 
00927             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformation )) {
00928 
00929                 <span class="keywordflow">try</span> {
00930 
00931                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformationLength )) {
00932 
00933                         *ConnectionInformationLength = ConnectionInfoLength;
00934                     }
00935 
00936                     RtlMoveMemory( ConnectionInformation,
00937                                    ConnectMsg + 1,
00938                                    ConnectionInfoLength );
00939 
00940                 } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00941 
00942                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00943                 }
00944             }
00945 
00946             <span class="comment">//</span>
00947             <span class="comment">//  Insert client communication port object in specified object</span>
00948             <span class="comment">//  table.  Set port handle value if successful.  If not</span>
00949             <span class="comment">//  successful, then the port will have been dereferenced, which</span>
00950             <span class="comment">//  will cause it to be freed, after our delete procedure is</span>
00951             <span class="comment">//  called.  The delete procedure will undo the work done to</span>
00952             <span class="comment">//  initialize the port.</span>
00953             <span class="comment">//</span>
00954 
00955             <span class="keywordflow">if</span> (ClientPort-&gt;ConnectedPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00956 
00957                 ULONG CapturedMaxMessageLength;
00958 
00959                 <span class="comment">//</span>
00960                 <span class="comment">//  Before we do the object insert we need to get the max</span>
00961                 <span class="comment">//  message length because right after the call the object</span>
00962                 <span class="comment">//  could be dereferenced and gone away</span>
00963                 <span class="comment">//</span>
00964 
00965                 CapturedMaxMessageLength = ConnectionPort-&gt;MaxMessageLength;
00966 
00967                 <span class="comment">//</span>
00968                 <span class="comment">//  Now create a handle for the new client port object.</span>
00969                 <span class="comment">//</span>
00970 
00971                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( ClientPort,
00972                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00973                                          PORT_ALL_ACCESS,
00974                                          0,
00975                                          (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00976                                          &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
00977 
00978                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00979 
00980                     <span class="comment">//</span>
00981                     <span class="comment">//  This is the only successful path through this routine.</span>
00982                     <span class="comment">//  Set the output variables, later we'll free the msg</span>
00983                     <span class="comment">//  back to the port zone and return to our caller</span>
00984                     <span class="comment">//</span>
00985 
00986                     <span class="keywordflow">try</span> {
00987 
00988                         *<a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00989 
00990                         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( MaxMessageLength )) {
00991 
00992                             *MaxMessageLength = CapturedMaxMessageLength;
00993                         }
00994 
00995                         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientView )) {
00996 
00997                             RtlMoveMemory( ClientView,
00998                                            &amp;ConnectMsg-&gt;ClientView,
00999                                            <span class="keyword">sizeof</span>( *ClientView ));
01000                         }
01001 
01002                         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ServerView )) {
01003 
01004                             RtlMoveMemory( ServerView,
01005                                            &amp;ConnectMsg-&gt;ServerView,
01006                                            <span class="keyword">sizeof</span>( *ServerView ));
01007                         }
01008 
01009                     } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
01010 
01011                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01012                         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
01013                     }
01014                 }
01015 
01016             } <span class="keywordflow">else</span> {
01017 
01018                 <span class="comment">//</span>
01019                 <span class="comment">//  Otherwise we did not get a connect port from the server so</span>
01020                 <span class="comment">//  the connection was refused</span>
01021                 <span class="comment">//</span>
01022 
01023                 <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"Connection request refused.\n"</span> ));
01024 
01025                 <span class="keywordflow">if</span> ( SectionToMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01026 
01027                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SectionToMap );
01028                 }
01029 
01030                 <span class="keywordflow">if</span> (ConnectionPort-&gt;Flags &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a9">PORT_NAME_DELETED</a>) {
01031 
01032                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
01033 
01034                 } <span class="keywordflow">else</span> {
01035 
01036                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PORT_CONNECTION_REFUSED;
01037                 }
01038 
01039                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
01040             }
01041 
01042             <span class="comment">//</span>
01043             <span class="comment">//  Free the reply message back to the port zone</span>
01044             <span class="comment">//</span>
01045 
01046             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01047 
01048         } <span class="keywordflow">else</span> {
01049 
01050             <span class="comment">//</span>
01051             <span class="comment">//  We did not get a reply message so the connection must have</span>
01052             <span class="comment">//  been refused</span>
01053             <span class="comment">//</span>
01054 
01055             <span class="keywordflow">if</span> (SectionToMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01056 
01057                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SectionToMap );
01058             }
01059 
01060             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
01061 
01062             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PORT_CONNECTION_REFUSED;
01063         }
01064 
01065     } <span class="keywordflow">else</span> {
01066 
01067         <span class="comment">//</span>
01068         <span class="comment">//  Our wait was not successful</span>
01069         <span class="comment">//</span>
01070 
01071         <span class="comment">//</span>
01072         <span class="comment">//  Remove the connection request message from the received</span>
01073         <span class="comment">//  queue and free the message back to the connection</span>
01074         <span class="comment">//  port's zone.</span>
01075         <span class="comment">//</span>
01076 
01077         SectionToMap = <a class="code" href="../../d5/d6/lpcconn_8c.html#a0">LpcpFreeConMsg</a>( &amp;Msg, &amp;ConnectMsg, CurrentThread );
01078         
01079         <span class="comment">//</span>
01080         <span class="comment">//  The wait was not successful, but in the meantime the server could</span>
01081         <span class="comment">//  replied, so it signaled the lpc semaphore. We have to clear the</span>
01082         <span class="comment">//  semaphore state right now.</span>
01083         <span class="comment">//</span>
01084 
01085         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/semphobj_8c.html#a2">KeReadStateSemaphore</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a> )) {
01086 
01087             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>,
01088                                    <a class="code" href="../../d6/d7/halmips_8h.html#a0">WrExecutive</a>,
01089                                    <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01090                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01091                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01092         }
01093 
01094         <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01095 
01096             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01097         }
01098 
01099         <span class="comment">//</span>
01100         <span class="comment">//  If a client section was specified, then dereference the section</span>
01101         <span class="comment">//  object.</span>
01102         <span class="comment">//</span>
01103 
01104         <span class="keywordflow">if</span> ( SectionToMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01105 
01106             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SectionToMap );
01107         }
01108 
01109         <span class="comment">//</span>
01110         <span class="comment">//  If the connection was rejected or the wait failed, then</span>
01111         <span class="comment">//  dereference the client port object, which will cause it to</span>
01112         <span class="comment">//  be deleted.</span>
01113         <span class="comment">//</span>
01114 
01115         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
01116     }
01117 
01118     <span class="comment">//</span>
01119     <span class="comment">//  And return to our caller</span>
01120     <span class="comment">//</span>
01121 
01122     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01123 }
01124 
01125 
01126 <span class="comment">//</span>
01127 <span class="comment">//  Local support routine</span>
01128 <span class="comment">//</span>
01129 
01130 PVOID
<a name="l01131"></a><a class="code" href="../../d5/d6/lpcconn_8c.html#a0">01131</a> <a class="code" href="../../d5/d6/lpcconn_8c.html#a0">LpcpFreeConMsg</a> (
01132     IN <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> *Msg,
01133     <a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a> *ConnectMsg,
01134     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread
01135     )
01136 
01137 <span class="comment">/*++</span>
01138 <span class="comment"></span>
01139 <span class="comment">Routine Description:</span>
01140 <span class="comment"></span>
01141 <span class="comment">    This routine returns a connection reply message for the specified thread</span>
01142 <span class="comment"></span>
01143 <span class="comment">Arguments:</span>
01144 <span class="comment"></span>
01145 <span class="comment">    Msg - Receives a pointer to the LPCP message if there is a reply</span>
01146 <span class="comment"></span>
01147 <span class="comment">    ConnectMsg - Receives a pointer to the LPCP connection message if there</span>
01148 <span class="comment">        is a reply</span>
01149 <span class="comment"></span>
01150 <span class="comment">    CurrentThread - Specifies the thread we're to be examining</span>
01151 <span class="comment"></span>
01152 <span class="comment">Return Value:</span>
01153 <span class="comment"></span>
01154 <span class="comment">    PVOID - Returns a pointer to the section to map in the connection message</span>
01155 <span class="comment"></span>
01156 <span class="comment">--*/</span>
01157 
01158 {
01159     PVOID SectionToMap;
01160 
01161     <span class="comment">//</span>
01162     <span class="comment">//  Acquire the LPC mutex, remove the connection request message</span>
01163     <span class="comment">//  from the received queue and free the message back to the connection</span>
01164     <span class="comment">//  port's zone.</span>
01165     <span class="comment">//</span>
01166 
01167     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01168 
01169     <span class="comment">//</span>
01170     <span class="comment">//  Remove the thread from the reply rundown list in case we did not wakeup due to</span>
01171     <span class="comment">//  a reply</span>
01172     <span class="comment">//</span>
01173 
01174     <span class="keywordflow">if</span> (!IsListEmpty( &amp;CurrentThread-&gt;LpcReplyChain )) {
01175 
01176         RemoveEntryList( &amp;CurrentThread-&gt;LpcReplyChain );
01177 
01178         InitializeListHead( &amp;CurrentThread-&gt;LpcReplyChain );
01179     }
01180 
01181     <span class="comment">//</span>
01182     <span class="comment">//  Check if the thread has an LPC reply message waiting to be handled</span>
01183     <span class="comment">//</span>
01184 
01185     <span class="keywordflow">if</span> (CurrentThread-&gt;LpcReplyMessage != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01186 
01187         <span class="comment">//</span>
01188         <span class="comment">//  Take the message off the threads list</span>
01189         <span class="comment">//</span>
01190 
01191         *Msg = CurrentThread-&gt;LpcReplyMessage;
01192 
01193         CurrentThread-&gt;LpcReplyMessageId = 0;
01194         CurrentThread-&gt;LpcReplyMessage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01195 
01196         <span class="comment">//</span>
01197         <span class="comment">//  Set the connection message pointer, and copy over the section</span>
01198         <span class="comment">//  to map location before zeroing it out</span>
01199         <span class="comment">//</span>
01200 
01201         *ConnectMsg = (<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a>)(*Msg + 1);
01202 
01203         SectionToMap = (*ConnectMsg)-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o2">SectionToMap</a>;
01204         (*ConnectMsg)-&gt;SectionToMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01205 
01206     } <span class="keywordflow">else</span> {
01207 
01208         <span class="comment">//</span>
01209         <span class="comment">//  Otherwise there is no LPC message to be handle so we'll return</span>
01210         <span class="comment">//  null's to our caller</span>
01211         <span class="comment">//</span>
01212 
01213         *Msg = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01214         SectionToMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01215     }
01216 
01217     <span class="comment">//</span>
01218     <span class="comment">//  Release the global lock and return to our caller</span>
01219     <span class="comment">//</span>
01220 
01221     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01222 
01223     <span class="keywordflow">return</span> SectionToMap;
01224 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
