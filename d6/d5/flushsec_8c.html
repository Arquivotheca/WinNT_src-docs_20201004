<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: flushsec.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>flushsec.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d7/d4/flushsec_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/flushsec_8c.html#a1">MiGetSystemCacheSubsection</a> (IN PVOID BaseAddress, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, OUT <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> *ProtoPte)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/flushsec_8c.html#a2">MiFlushDirtyBitsToPfn</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN BOOLEAN SystemCache)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/flushsec_8c.html#a3">MiCheckProtoPtePageState</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="el" href="../../d6/d2/datappc_8c.html#a10">PrototypePte</a>, IN ULONG PfnLockHeld)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/flushsec_8c.html#a4">NtFlushVirtualMemory</a> (IN HANDLE ProcessHandle, IN OUT PVOID *BaseAddress, IN OUT PSIZE_T RegionSize, OUT PIO_STATUS_BLOCK IoStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/flushsec_8c.html#a5">MiFlushAcquire</a> (IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/flushsec_8c.html#a6">MiFlushRelease</a> (IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/flushsec_8c.html#a7">MmFlushVirtualMemory</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN OUT PVOID *BaseAddress, IN OUT PSIZE_T RegionSize, OUT PIO_STATUS_BLOCK IoStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/flushsec_8c.html#a8">MmFlushSection</a> (IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionObjectPointer, IN PLARGE_INTEGER <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, IN SIZE_T RegionSize, OUT PIO_STATUS_BLOCK IoStatus, IN ULONG AcquireFile)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONGLONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/flushsec_8c.html#a9">MiStartingOffset</a> (IN <a class="el" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PteAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LARGE_INTEGER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/flushsec_8c.html#a10">MiEndingOffset</a> (IN <a class="el" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/flushsec_8c.html#a11">MiFlushSectionInternal</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FinalPte, IN <a class="el" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> FirstSubsection, IN <a class="el" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> LastSubsection, IN ULONG Synchronize, IN LOGICAL WriteInProgressOk, OUT PIO_STATUS_BLOCK IoStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/flushsec_8c.html#a12">MmPurgeSection</a> (IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionObjectPointer, IN PLARGE_INTEGER <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, IN SIZE_T RegionSize, IN ULONG IgnoreCacheViews)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/flushsec_8c.html#a13">MmFlushImageSection</a> (IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionPointer, IN <a class="el" href="../../d2/d1/mm_8h.html#a153">MMFLUSH_TYPE</a> FlushType)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/flushsec_8c.html#a0">IoFileObjectType</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="flushsec.c::MiCheckProtoPtePageState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG FASTCALL MiCheckProtoPtePageState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PrototypePte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PfnLockHeld</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02427">2427</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03125">MiCheckPdeForPagedPool()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00996">MiMakeSystemAddressValidPfn()</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00075">PrototypePte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, and <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>.
<p>
<pre class="fragment"><div>02434                    :
02435 
02436     Checks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
02437     prototype PTE.
02438 
02439     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid or transition and has transition or valid prototype
02440     PTEs contained with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> valid
02441     (<span class="keywordflow">if</span> transition).  Otherwise <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicating no prototype
02442     PTEs within <span class="keyword">this</span> page are of interest.
02443 
02444 Arguments:
02445 
02446     <a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a> - Supplies a pointer to a prototype PTE within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page.
02447 
02448 Return Value:
02449 
02450     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proto PTE was <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> resident.
02451     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> otherwise.
02452 
02453 --*/
02454 
02455 {
02456     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02457     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
02458     PFN_NUMBER PageFrameIndex;
02459     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn;
02460 
02461 <span class="preprocessor">#if defined (_WIN64)</span>
02462 <span class="preprocessor"></span>    <span class="comment">//</span>
02463     <span class="comment">// First check whether the page directory page is present.  Since there</span>
02464     <span class="comment">// is no lazy loading of PPEs, the validity check alone is sufficient.</span>
02465     <span class="comment">//</span>
02466 
02467     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PrototypePte);
02468     PteContents = *PointerPte;
02469 
02470     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
02471         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02472     }
02473 <span class="preprocessor">#endif</span>
02474 <span class="preprocessor"></span>
02475     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PrototypePte);
02476 <span class="preprocessor">#if !defined (_WIN64)</span>
02477 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 0) {
02478         <a class="code" href="../../d8/d2/pagfault_8c.html#a20">MiCheckPdeForPagedPool</a> (PrototypePte);
02479     }
02480 <span class="preprocessor">#endif</span>
02481 <span class="preprocessor"></span>    PteContents = *PointerPte;
02482 
02483     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
02484         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PteContents);
02485         Pfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02486         <span class="keywordflow">if</span> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount != 1) {
02487             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02488         }
02489     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
02490                (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
02491 
02492         <span class="comment">//</span>
02493         <span class="comment">// Transition, if on standby or modified, return false.</span>
02494         <span class="comment">//</span>
02495 
02496         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents);
02497         Pfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02498         <span class="keywordflow">if</span> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>) {
02499             <span class="keywordflow">if</span> (PfnLockHeld) {
02500                 <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PrototypePte);
02501             }
02502             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02503         }
02504     }
02505 
02506     <span class="comment">//</span>
02507     <span class="comment">// Page is not resident or is on standby / modified list.</span>
02508     <span class="comment">//</span>
02509 
02510     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02511 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="flushsec.c::MiEndingOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LARGE_INTEGER MiEndingOffset           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Subsection</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00965">965</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02190">Mi4KStartFromSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00106">MM4K_SHIFT</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00109">MMSECTOR_SHIFT</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02614">MiCanFileBeTruncatedInternal()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">MiFlushSectionInternal()</a>, and <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01989">MiResolveMappedFileFault()</a>.
<p>
<pre class="fragment"><div>00971                    :
00972 
00973     This function calculates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last valid <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset in a given subsection.
00974     offset.  Note that images are stored in 512-byte units whereas data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00975     stored in 4K units.
00976 
00977     When <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> all debugged, <span class="keyword">this</span> should be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> into a macro.
00978 
00979 Arguments:
00980 
00981     Subsection - Supplies a subsection to reference <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> address.
00982 
00983     PteAddress - Supplies a PTE within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subsection
00984 
00985 Return Value:
00986 
00987     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset to obtain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> backing data from.
00988 
00989 --*/
00990 
00991 {
00992     LARGE_INTEGER FileByteOffset;
00993 
00994     <span class="keywordflow">if</span> (Subsection-&gt;ControlArea-&gt;u.Flags.Image == 1) {
00995         FileByteOffset.QuadPart =
00996             (Subsection-&gt;StartingSector + Subsection-&gt;NumberOfFullSectors) &lt;&lt;
00997                 <a class="code" href="../../d4/d8/mi_8h.html#a27">MMSECTOR_SHIFT</a>;
00998     }
00999     <span class="keywordflow">else</span> {
01000         <a class="code" href="../../d4/d8/mi_8h.html#a220">Mi4KStartFromSubsection</a> (&amp;FileByteOffset, Subsection);
01001 
01002         FileByteOffset.QuadPart += Subsection-&gt;NumberOfFullSectors;
01003 
01004         FileByteOffset.QuadPart = FileByteOffset.QuadPart &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>;
01005     }
01006 
01007     FileByteOffset.QuadPart += Subsection-&gt;u.SubsectionFlags.SectorEndOffset;
01008 
01009     <span class="keywordflow">return</span> FileByteOffset;
01010 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="flushsec.c::MiFlushAcquire" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiFlushAcquire           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ControlArea</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00223">223</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>, and <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00229                    :
00230 
00231     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a helper routine to reference count <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area <span class="keywordflow">if</span> needed
00232     during a flush section call to prevent <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object from being
00233     deleted <span class="keywordflow">while</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flush <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ongoing.
00234 
00235 Arguments:
00236 
00237     ControlArea - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area.
00238 
00239 Return Value:
00240 
00241     None.
00242 
00243 --*/
00244 
00245 {
00246     KIRQL OldIrql;
00247 
00248     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00249 
00250     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;NumberOfMappedViews &gt;= 1);
00251     ControlArea-&gt;NumberOfMappedViews += 1;
00252 
00253     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00254 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="flushsec.c::MiFlushDirtyBitsToPfn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiFlushDirtyBitsToPfn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LastPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemCache</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02281">2281</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00757">MI_IS_PTE_DIRTY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00733">MI_SET_PTE_CLEAN</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00437">MiDoesPdeExistAndMakeValid()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01980">MiDoesPpeExistAndMakeValid</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>.
<p>
<pre class="fragment"><div>02288 {
02289     KIRQL OldIrql;
02290     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
02291     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02292     PVOID Va;
02293     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
02294     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
02295     ULONG Waited;
02296 
02297     Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02298     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02299 
02300     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
02301 
02302         PteContents = *PointerPte;
02303 
02304         <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) &amp;&amp;
02305             (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a> (PteContents))) {
02306 
02307             <span class="comment">//</span>
02308             <span class="comment">// Flush the modify bit to the PFN database.</span>
02309             <span class="comment">//</span>
02310 
02311             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02312             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
02313 
02314             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a113">MI_SET_PTE_CLEAN</a> (PteContents);
02315 
02316             <span class="comment">//</span>
02317             <span class="comment">// No need to capture the PTE contents as we are going to</span>
02318             <span class="comment">// write the page anyway and the Modify bit will be cleared</span>
02319             <span class="comment">// before the write is done.</span>
02320             <span class="comment">//</span>
02321 
02322             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (Va,
02323                                    FALSE,
02324                                    SystemCache,
02325                                    (PHARDWARE_PTE)PointerPte,
02326                                    PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
02327         }
02328 
02329         Va = (PVOID)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02330         PointerPte += 1;
02331 
02332         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
02333 
02334             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
02335 
02336             <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
02337 
02338                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
02339 
02340                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
02341                                                  Process,
02342                                                  TRUE,
02343                                                  &amp;Waited)) {
02344 
02345                     <span class="comment">//</span>
02346                     <span class="comment">// No page directory page exists for this address.</span>
02347                     <span class="comment">//</span>
02348 
02349                     PointerPpe += 1;
02350 
02351                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
02352                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
02353                 }
02354                 <span class="keywordflow">else</span> {
02355 
02356                     Waited = 0;
02357 
02358                     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
02359                                                      Process,
02360                                                      TRUE,
02361                                                      &amp;Waited)) {
02362 
02363                         <span class="comment">//</span>
02364                         <span class="comment">// No page table page exists for this address.</span>
02365                         <span class="comment">//</span>
02366 
02367                         PointerPde += 1;
02368 
02369                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
02370                     }
02371                     <span class="keywordflow">else</span> {
02372 
02373                         <span class="comment">//</span>
02374                         <span class="comment">// If the PFN lock (and accordingly the WS mutex) was</span>
02375                         <span class="comment">// released and reacquired we must retry the operation.</span>
02376                         <span class="comment">//</span>
02377 
02378                         <span class="keywordflow">if</span> (Waited != 0) {
02379                             <span class="keywordflow">continue</span>;
02380                         }
02381 
02382                         <span class="comment">//</span>
02383                         <span class="comment">// The PFN lock has been held since we acquired the</span>
02384                         <span class="comment">// page directory parent, ie: this PTE we can operate on</span>
02385                         <span class="comment">// immediately.</span>
02386                         <span class="comment">//</span>
02387 
02388                         <span class="keywordflow">break</span>;
02389                     }
02390                 }
02391             }
02392 
02393             Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02394         }
02395     }
02396 
02397     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02398     <span class="keywordflow">return</span>;
02399 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="flushsec.c::MiFlushRelease" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiFlushRelease           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ControlArea</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00258">258</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>, and <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00264                    :
00265 
00266     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a helper routine to release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area reference needed
00267     during a flush section call.
00268 
00269 Arguments:
00270 
00271     ControlArea - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area.
00272 
00273 Return Value:
00274 
00275     None.
00276 
00277 --*/
00278 
00279 {
00280     KIRQL OldIrql;
00281 
00282     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00283 
00284     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;NumberOfMappedViews &gt;= 1);
00285     ControlArea-&gt;NumberOfMappedViews -= 1;
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">// Check to see if the control area should be deleted.  This</span>
00289     <span class="comment">// will release the PFN lock.</span>
00290     <span class="comment">//</span>
00291 
00292     <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
00293 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="flushsec.c::MiFlushSectionInternal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiFlushSectionInternal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FinalPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FirstSubsection</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LastSubsection</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Synchronize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LOGICAL&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteInProgressOk</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">1014</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00420">_MDL::ByteCount</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02070">_CONTROL_AREA::FilePointer</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02064">_CONTROL_AREA::FlushInProgressCount</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10957">IoSynchronousPageWrite()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00167">KePulseEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00418">_MDL::MappedSystemVa</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00416">_MDL::MdlFlags</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01417">MI_ADD_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01430">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02510">MI_INITIALIZE_ZERO_MDL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01470">MI_REMOVE_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d5/d5/sectsup_8c.html#a11">MiCheckProtoPtePageState()</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00965">MiEndingOffset()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00245">MiIoRetryLevel</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00996">MiMakeSystemAddressValidPfn()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00916">MiStartingOffset()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00217">Mm30Milliseconds</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00179">MM_DBG_FLUSH_SECTION</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00091">MM_MAXIMUM_DISK_IO_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05098">MmCollidedFlushEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00250">MmIsRetryIoStatus</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05126">MmModifiedWriteClusterSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00213">MmOneSecond</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02124">_SUBSECTION::NextSubsection</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02061">_CONTROL_AREA::NumberOfPfnReferences</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00415">_MDL::Size</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00419">_MDL::StartVa</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l03882">STATUS_MAPPED_WRITER_COLLISION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00910">UNLOCK_PFN_AND_THEN_WAIT</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a217">WrPageOut</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02748">MiRemoveUnusedSegments()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00668">MmFlushSection()</a>, and <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>.
<p>
<pre class="fragment"><div>01026                    :
01027 
01028     This function flushes to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> backing <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> any modified pages within
01029     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified range of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.  The parameters describe <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01030     section's prototype PTEs (start and end) and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subsections
01031     which correspond to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting and ending PTE.
01032 
01033     Each PTE in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subsection between <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified start and end
01034     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> examined and <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> either valid or transition AND
01035     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page has been modified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modify bit <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cleared in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN
01036     database and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> flushed to its backing <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01037 
01038 Arguments:
01039 
01040     StartingPte - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first prototype PTE to
01041                   be examined <span class="keywordflow">for</span> flushing.
01042 
01043     FinalPte - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last prototype PTE to be
01044                examined <span class="keywordflow">for</span> flushing.
01045 
01046     FirstSubsection - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subsection that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01047                       StartingPte.
01048 
01049     LastSubsection - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subsection that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01050                      FinalPte.
01051 
01052     Synchronize - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> synchronization with all threads
01053                   doing flush operations to <span class="keyword">this</span> section should occur.
01054 
01055     WriteInProgressOk - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller can tolerate a write
01056                         already in progress <span class="keywordflow">for</span> any dirty pages.
01057 
01058     IoStatus - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoStatus <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last attempted
01059                I/O operation.
01060 
01061 Return Value:
01062 
01063     Returns status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
01064 
01065 --*/
01066 
01067 {
01068     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
01069     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01070     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
01071     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastWritten;
01072     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
01073     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01074     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
01075     KIRQL OldIrql;
01076     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
01077     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> IoEvent;
01078     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
01079     PPFN_NUMBER Page;
01080     PFN_NUMBER PageFrameIndex;
01081     PPFN_NUMBER LastPage;
01082     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01083     UINT64 StartingOffset;
01084     UINT64 TempOffset;
01085     BOOLEAN WriteNow;
01086     LOGICAL Bail;
01087     PFN_NUMBER MdlHack[(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)/<span class="keyword">sizeof</span>(PFN_NUMBER)) + (<a class="code" href="../../d2/d1/mm_8h.html#a3">MM_MAXIMUM_DISK_IO_SIZE</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) + 1];
01088     ULONG ReflushCount;
01089 
01090     WriteNow = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01091     Bail = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01092 
01093     IoStatus-&gt;Status = STATUS_SUCCESS;
01094     IoStatus-&gt;Information = 0;
01095     Mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)&amp;MdlHack[0];
01096 
01097     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;IoEvent, NotificationEvent, FALSE);
01098 
01099     FinalPte += 1;  <span class="comment">// Point to 1 past the last one.</span>
01100 
01101     LastWritten = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01102     LastPage = 0;
01103     Subsection = FirstSubsection;
01104     PointerPte = StartingPte;
01105     ControlArea = FirstSubsection-&gt;ControlArea;
01106 
01107     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01108 
01109     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image == 0);
01110 
01111     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> == 0) {
01112 
01113         <span class="comment">//</span>
01114         <span class="comment">// No transition or valid prototype PTEs present, hence</span>
01115         <span class="comment">// no need to flush anything.</span>
01116         <span class="comment">//</span>
01117 
01118         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01119         <span class="keywordflow">return</span> STATUS_SUCCESS;
01120     }
01121 
01122     <span class="keywordflow">while</span> ((Synchronize) &amp;&amp; (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o6">FlushInProgressCount</a> != 0)) {
01123 
01124         <span class="comment">//</span>
01125         <span class="comment">// Another thread is currently performing a flush operation on</span>
01126         <span class="comment">// this file.  Wait for that flush to complete.</span>
01127         <span class="comment">//</span>
01128 
01129         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01130         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.CollidedFlush = 1;
01131         <a class="code" href="../../d4/d8/mi_8h.html#a132">UNLOCK_PFN_AND_THEN_WAIT</a>(OldIrql);
01132 
01133         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;MmCollidedFlushEvent,
01134                                WrPageOut,
01135                                KernelMode,
01136                                FALSE,
01137                                &amp;MmOneSecond);
01138         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01139         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01140     }
01141 
01142     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o6">FlushInProgressCount</a> += 1;
01143 
01144     <span class="keywordflow">for</span> (;;) {
01145 
01146         <span class="keywordflow">if</span> (LastSubsection != Subsection) {
01147 
01148             <span class="comment">//</span>
01149             <span class="comment">// Flush to the last PTE in this subsection.</span>
01150             <span class="comment">//</span>
01151 
01152             LastPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
01153         } <span class="keywordflow">else</span> {
01154 
01155             <span class="comment">//</span>
01156             <span class="comment">// Flush to the end of the range.</span>
01157             <span class="comment">//</span>
01158 
01159             LastPte = FinalPte;
01160         }
01161 
01162         <span class="comment">//</span>
01163         <span class="comment">// If the prototype PTEs are paged out or have a share count</span>
01164         <span class="comment">// of 1, they cannot contain any transition or valid PTEs.</span>
01165         <span class="comment">//</span>
01166 
01167         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/sectsup_8c.html#a11">MiCheckProtoPtePageState</a>(PointerPte, TRUE)) {
01168             PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(((ULONG_PTR)PointerPte | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) + 1);
01169         }
01170 
01171         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
01172 
01173             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) {
01174 
01175                 <span class="comment">//</span>
01176                 <span class="comment">// We are on a page boundary, make sure this PTE is resident.</span>
01177                 <span class="comment">//</span>
01178 
01179                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/sectsup_8c.html#a11">MiCheckProtoPtePageState</a>(PointerPte, TRUE)) {
01180                     PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)PointerPte + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01181 
01182                     <span class="comment">//</span>
01183                     <span class="comment">// If there are dirty pages to be written, write them</span>
01184                     <span class="comment">// now as we are skipping over PTEs.</span>
01185                     <span class="comment">//</span>
01186 
01187                     <span class="keywordflow">if</span> (LastWritten != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01188                         WriteNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01189                         <span class="keywordflow">goto</span> CheckForWrite;
01190                     }
01191                     <span class="keywordflow">continue</span>;
01192                 }
01193             }
01194 
01195             PteContents = *PointerPte;
01196 
01197             <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) ||
01198                    ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
01199                      (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1))) {
01200 
01201                 <span class="comment">//</span>
01202                 <span class="comment">// Prototype PTE in transition, there are 3 possible cases:</span>
01203                 <span class="comment">//  1. The page is part of an image which is sharable and</span>
01204                 <span class="comment">//     refers to the paging file - dereference page file</span>
01205                 <span class="comment">//     space and free the physical page.</span>
01206                 <span class="comment">//  2. The page refers to the segment but is not modified -</span>
01207                 <span class="comment">//     free the physical page.</span>
01208                 <span class="comment">//  3. The page refers to the segment and is modified -</span>
01209                 <span class="comment">//     write the page to the file and free the physical page.</span>
01210                 <span class="comment">//</span>
01211 
01212                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01213                     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PteContents);
01214                 } <span class="keywordflow">else</span> {
01215                     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents);
01216                 }
01217 
01218                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01219                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1);
01220                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
01221 
01222                 <span class="comment">//</span>
01223                 <span class="comment">// If the page is modified OR a write is in progress</span>
01224                 <span class="comment">// flush it.  The write in progress case catches problems</span>
01225                 <span class="comment">// where the modified page write continually writes a</span>
01226                 <span class="comment">// page and gets errors writing it, by writing pages</span>
01227                 <span class="comment">// in this state, the error will be propagated back to</span>
01228                 <span class="comment">// the caller.</span>
01229                 <span class="comment">//</span>
01230 
01231                 <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1) ||
01232                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress)) {
01233 
01234                     <span class="keywordflow">if</span> ((WriteInProgressOk == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
01235                         (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress)) {
01236 
01237                             PointerPte = LastPte;
01238                             Bail = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01239 
01240                             <span class="keywordflow">if</span> (LastWritten != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01241                                 WriteNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01242                             }
01243                             <span class="keywordflow">goto</span> CheckForWrite;
01244                     }
01245 
01246                     <span class="keywordflow">if</span> (LastWritten == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01247 
01248                         <span class="comment">//</span>
01249                         <span class="comment">// This is the first page of a cluster, initialize</span>
01250                         <span class="comment">// the MDL, etc.</span>
01251                         <span class="comment">//</span>
01252 
01253                         LastPage = (PPFN_NUMBER)(Mdl + 1);
01254 
01255                         <span class="comment">//</span>
01256                         <span class="comment">// Calculate the offset to read into the file.</span>
01257                         <span class="comment">//  offset = base + ((thispte - basepte) &lt;&lt; PAGE_SHIFT)</span>
01258                         <span class="comment">//</span>
01259 
01260                         StartingOffset = (UINT64) <a class="code" href="../../d4/d8/mi_8h.html#a952">MiStartingOffset</a> (
01261                                                              Subsection,
01262                                                              Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
01263 
01264                         <a class="code" href="../../d4/d8/mi_8h.html#a235">MI_INITIALIZE_ZERO_MDL</a> (Mdl);
01265 
01266                         Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
01267                         Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o5">StartVa</a> =
01268                                   (PVOID)ULongToPtr(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor &lt;&lt; PAGE_SHIFT);
01269                         Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o1">Size</a> = (CSHORT)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>) +
01270                                    (<span class="keyword">sizeof</span>(PFN_NUMBER) * <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>));
01271                     }
01272 
01273                     LastWritten = PointerPte;
01274                     Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01275                     <span class="keywordflow">if</span> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> == (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> * <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>)) {
01276                         WriteNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01277                     }
01278 
01279                     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01280 
01281                         <span class="comment">//</span>
01282                         <span class="comment">// The page is in transition.</span>
01283                         <span class="comment">//</span>
01284 
01285                         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
01286                         <a class="code" href="../../d4/d8/mi_8h.html#a187">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a>(Pfn1, 18);
01287                     }
01288                     <span class="keywordflow">else</span> {
01289                         <a class="code" href="../../d4/d8/mi_8h.html#a186">MI_ADD_LOCKED_PAGE_CHARGE</a>(Pfn1, 20);
01290                     }
01291 
01292                     <span class="comment">//</span>
01293                     <span class="comment">// Clear the modified bit for this page.</span>
01294                     <span class="comment">//</span>
01295 
01296                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 0;
01297 
01298                     <span class="comment">//</span>
01299                     <span class="comment">// Up the reference count for the physical page as there</span>
01300                     <span class="comment">// is I/O in progress.</span>
01301                     <span class="comment">//</span>
01302 
01303                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
01304 
01305                     *LastPage = PageFrameIndex;
01306                     LastPage += 1;
01307                 } <span class="keywordflow">else</span> {
01308 
01309                     <span class="comment">//</span>
01310                     <span class="comment">// This page was not modified and therefore ends the</span>
01311                     <span class="comment">// current write cluster if any.  Set WriteNow to TRUE</span>
01312                     <span class="comment">// if there is a cluster being built.</span>
01313                     <span class="comment">//</span>
01314 
01315                     <span class="keywordflow">if</span> (LastWritten != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01316                         WriteNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01317                     }
01318                 }
01319             } <span class="keywordflow">else</span> {
01320 
01321                 <span class="comment">//</span>
01322                 <span class="comment">// This page was not modified and therefore ends the</span>
01323                 <span class="comment">// current write cluster if any.  Set WriteNow to TRUE</span>
01324                 <span class="comment">// if there is a cluster being built.</span>
01325                 <span class="comment">//</span>
01326 
01327                 <span class="keywordflow">if</span> (LastWritten != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01328                     WriteNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01329                 }
01330             }
01331 
01332             PointerPte += 1;
01333 
01334 CheckForWrite:
01335 
01336             <span class="comment">//</span>
01337             <span class="comment">// Write the current cluster if it is complete,</span>
01338             <span class="comment">// full, or the loop is now complete.</span>
01339             <span class="comment">//</span>
01340 
01341             <span class="keywordflow">if</span> ((WriteNow) ||
01342                 ((PointerPte == LastPte) &amp;&amp; (LastWritten != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
01343 
01344                 LARGE_INTEGER EndOfFile;
01345 
01346                 <span class="comment">//</span>
01347                 <span class="comment">// Issue the write request.</span>
01348                 <span class="comment">//</span>
01349 
01350                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01351 
01352                 WriteNow = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01353 
01354                 <span class="comment">//</span>
01355                 <span class="comment">// Make sure the write does not go past the</span>
01356                 <span class="comment">// end of file. (segment size).</span>
01357                 <span class="comment">//</span>
01358 
01359                 EndOfFile = <a class="code" href="../../d4/d8/mi_8h.html#a953">MiEndingOffset</a>(Subsection);
01360                 TempOffset = (UINT64) EndOfFile.QuadPart;
01361 
01362                 <span class="keywordflow">if</span> (StartingOffset + Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> &gt; TempOffset) {
01363 
01364                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((ULONG_PTR)(TempOffset - StartingOffset) &gt;
01365                              (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> - PAGE_SIZE));
01366 
01367                     Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> = (ULONG)(TempOffset-
01368                                              StartingOffset);
01369                 }
01370 
01371                 ReflushCount = <a class="code" href="../../d4/d8/mi_8h.html#a428">MiIoRetryLevel</a>;
01372                 
01373                 <span class="keywordflow">while</span> ( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) {
01374 
01375                     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;IoEvent);
01376 
01377 <span class="preprocessor">#if DBG</span>
01378 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a71">MM_DBG_FLUSH_SECTION</a>) {
01379                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"flush page write begun %lx\n"</span>,
01380                                 Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>);
01381                     }
01382 <span class="preprocessor">#endif //DBG</span>
01383 <span class="preprocessor"></span>
01384                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a116">IoSynchronousPageWrite</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>,
01385                                                      Mdl,
01386                                                      (PLARGE_INTEGER)&amp;StartingOffset,
01387                                                      &amp;IoEvent,
01388                                                      IoStatus );
01389 
01390                     <span class="comment">//</span>
01391                     <span class="comment">// If success is returned, wait for the i/o event to be set.</span>
01392                     <span class="comment">//</span>
01393 
01394                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01395                         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;IoEvent,
01396                                                WrPageOut,
01397                                                KernelMode,
01398                                                FALSE,
01399                                                (PLARGE_INTEGER)NULL);
01400                     <span class="comment">//</span>
01401                     <span class="comment">//  Otherwise, copy the error to the IoStatus, for error</span>
01402                     <span class="comment">//  handling below.</span>
01403                     <span class="comment">//</span>
01404 
01405                     } <span class="keywordflow">else</span> {
01406                         IoStatus-&gt;Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01407                     }
01408 
01409                     <span class="keywordflow">if</span> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
01410                         <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>, Mdl);
01411                     }
01412 
01413                     Page = (PPFN_NUMBER)(Mdl + 1);
01414 
01415                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a85">MmIsRetryIoStatus</a>(IoStatus-&gt;Status)) {
01416                         
01417                         ReflushCount -= 1;
01418                         <span class="keywordflow">if</span> (ReflushCount != 0) {
01419                             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;Mm30Milliseconds);
01420                             <span class="keywordflow">continue</span>;
01421                         }
01422                     }
01423 
01424                     <span class="keywordflow">break</span>;
01425                 }
01426 
01427                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01428 
01429                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte) == 0) {
01430 
01431                     <span class="comment">//</span>
01432                     <span class="comment">// The next PTE is not in a different page, make</span>
01433                     <span class="comment">// sure this page did not leave memory when the</span>
01434                     <span class="comment">// I/O was in progress.</span>
01435                     <span class="comment">//</span>
01436 
01437                     <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerPte);
01438                 }
01439 
01440                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatus-&gt;Status)) {
01441 
01442                     <span class="comment">//</span>
01443                     <span class="comment">// The I/O completed successfully, unlock the pages.</span>
01444                     <span class="comment">//</span>
01445 
01446                     <span class="keywordflow">while</span> (Page &lt; LastPage) {
01447 
01448                         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
01449                         <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a>(Pfn2, 19);
01450                         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (*Page);
01451                         Page += 1;
01452                     }
01453                 } <span class="keywordflow">else</span> {
01454 
01455                     <span class="comment">//</span>
01456                     <span class="comment">//  Don't count on the file system to convey anything on errors</span>
01457                     <span class="comment">//  in the information field.</span>
01458                     <span class="comment">//</span>
01459 
01460                     IoStatus-&gt;Information = 0;
01461 
01462                     <span class="comment">//</span>
01463                     <span class="comment">// The I/O completed unsuccessfully, unlock the pages</span>
01464                     <span class="comment">// and return an error status.</span>
01465                     <span class="comment">//</span>
01466 
01467                     <span class="keywordflow">while</span> (Page &lt; LastPage) {
01468 
01469                         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
01470 
01471                         <span class="comment">//</span>
01472                         <span class="comment">// Mark the page dirty again so it can be rewritten.</span>
01473                         <span class="comment">//</span>
01474 
01475                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
01476 
01477                         <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a>(Pfn2, 21);
01478                         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (*Page);
01479                         Page += 1;
01480                     }
01481 
01482                     <span class="comment">//</span>
01483                     <span class="comment">// Calculate how much was written thus far</span>
01484                     <span class="comment">// and add that to the information field</span>
01485                     <span class="comment">// of the IOSB.</span>
01486                     <span class="comment">//</span>
01487 
01488                     IoStatus-&gt;Information +=
01489                         (((LastWritten - StartingPte) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) -
01490                                                         Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>);
01491 
01492                     <span class="keywordflow">goto</span> ErrorReturn;
01493                 }
01494 
01495                 <span class="comment">//</span>
01496                 <span class="comment">// As the PFN lock has been released and</span>
01497                 <span class="comment">// reacquired, do this loop again as the</span>
01498                 <span class="comment">// PTE may have changed state.</span>
01499                 <span class="comment">//</span>
01500 
01501                 LastWritten = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01502             }
01503 
01504         } <span class="comment">//end while</span>
01505 
01506         <span class="keywordflow">if</span> ((Bail == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) || (Subsection == LastSubsection)) {
01507 
01508             <span class="comment">//</span>
01509             <span class="comment">// The last range has been flushed or we have collided with the</span>
01510             <span class="comment">// mapped page writer.  Regardless, exit the top FOR loop</span>
01511             <span class="comment">// and return.</span>
01512             <span class="comment">//</span>
01513 
01514             <span class="keywordflow">break</span>;
01515         }
01516 
01517         Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
01518         PointerPte = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>;
01519 
01520     }  <span class="comment">//end for</span>
01521 
01522     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LastWritten == NULL);
01523 
01524 ErrorReturn:
01525 
01526     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o6">FlushInProgressCount</a> -= 1;
01527     <span class="keywordflow">if</span> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.CollidedFlush == 1) &amp;&amp;
01528         (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o6">FlushInProgressCount</a> == 0)) {
01529         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.CollidedFlush = 0;
01530         <a class="code" href="../../d2/d8/eventobj_8c.html#a5">KePulseEvent</a> (&amp;MmCollidedFlushEvent, 0, FALSE);
01531     }
01532     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01533 
01534     <span class="keywordflow">if</span> (Bail == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01535 
01536         <span class="comment">//</span>
01537         <span class="comment">// This routine collided with the mapped page writer and the caller</span>
01538         <span class="comment">// expects an error for this.  Give it to him.</span>
01539         <span class="comment">//</span>
01540 
01541         <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a247">STATUS_MAPPED_WRITER_COLLISION</a>;
01542     }
01543 
01544     <span class="keywordflow">return</span> IoStatus-&gt;Status;
01545 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="flushsec.c::MiGetSystemCacheSubsection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> MiGetSystemCacheSubsection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ProtoPte</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02402">2402</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01385">MiGetSubsectionAndProtoFromPte()</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>.
<p>
<pre class="fragment"><div>02408 {
02409     KIRQL OldIrql;
02410     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02411     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
02412 
02413     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02414 
02415     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
02416 
02417     Subsection = <a class="code" href="../../d0/d2/mmsup_8c.html#a16">MiGetSubsectionAndProtoFromPte</a> (PointerPte,
02418                                                  ProtoPte,
02419                                                  Process);
02420     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02421     <span class="keywordflow">return</span> Subsection;
02422 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="flushsec.c::MiStartingOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONGLONG MiStartingOffset           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Subsection</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PteAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00916">916</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02190">Mi4KStartFromSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00417">MI_STARTING_OFFSET</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00106">MM4K_SHIFT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">MiFlushSectionInternal()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01989">MiResolveMappedFileFault()</a>, and <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>.
<p>
<pre class="fragment"><div>00923                    :
00924 
00925     This function calculates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset given a subsection and a PTE
00926     offset.  Note that images are stored in 512-byte units whereas data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00927     stored in 4K units.
00928 
00929     When <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> all debugged, <span class="keyword">this</span> should be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> into a macro.
00930 
00931 Arguments:
00932 
00933     Subsection - Supplies a subsection to reference <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> address.
00934 
00935     PteAddress - Supplies a PTE within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subsection
00936 
00937 Return Value:
00938 
00939     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset to obtain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> backing data from.
00940 
00941 --*/
00942 
00943 {
00944     LONGLONG PteByteOffset;
00945     LARGE_INTEGER StartAddress;
00946 
00947     <span class="keywordflow">if</span> (Subsection-&gt;ControlArea-&gt;u.Flags.Image == 1) {
00948             <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a93">MI_STARTING_OFFSET</a> ( Subsection,
00949                                         PteAddress);
00950     }
00951 
00952     PteByteOffset = (LONGLONG)((PteAddress - Subsection-&gt;SubsectionBase))
00953                             &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00954 
00955     <a class="code" href="../../d4/d8/mi_8h.html#a220">Mi4KStartFromSubsection</a> (&amp;StartAddress, Subsection);
00956 
00957     StartAddress.QuadPart = StartAddress.QuadPart &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>;
00958 
00959     PteByteOffset += StartAddress.QuadPart;
00960 
00961     <span class="keywordflow">return</span> PteByteOffset;
00962 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="flushsec.c::MmFlushImageSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmFlushImageSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionPointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a153">MMFLUSH_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FlushType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02094">2094</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1002a766">CheckImageSection</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02149">MiCheckControlAreaStatus()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d2/d1/mm_8h.html#a153">MMFLUSH_TYPE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a346a179">MmFlushForDelete</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02081">_LARGE_CONTROL_AREA::NumberOfSectionReferences</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02065">_CONTROL_AREA::NumberOfUserReferences</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o10">_LARGE_CONTROL_AREA::u</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02614">MiCanFileBeTruncatedInternal()</a>, and <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>.
<p>
<pre class="fragment"><div>02101                    :
02102 
02103     This function determines <span class="keywordflow">if</span> any views of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified image section
02104     are mapped, and <span class="keywordflow">if</span> not, flushes valid pages (even modified ones)
02105     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section and returns any used pages to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free
02106     list.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accomplished by examining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prototype PTEs
02107     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified offset to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section, and <span class="keywordflow">if</span>
02108     any prototype PTEs are in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transition state, putting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02109     prototype PTE back into its original state and putting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02110     physical page on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free list.
02111 
02112 Arguments:
02113 
02114     SectionPointer - Supplies a pointer to a section object pointers
02115                      within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d9/struct__FCB.html">FCB</a>.
02116 
02117     FlushType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of flush to check <span class="keywordflow">for</span>.  One of
02118                 <a class="code" href="../../d2/d1/mm_8h.html#a346a179">MmFlushForDelete</a> or <a class="code" href="../../d2/d1/mm_8h.html#a346a180">MmFlushForWrite</a>.
02119 
02120 Return Value:
02121 
02122     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> either no section exists <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object or
02123     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not mapped and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> purge was done, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
02124 
02125 --*/
02126 
02127 {
02128     PLIST_ENTRY Next;
02129     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
02130     <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a> LargeControlArea;
02131     KIRQL OldIrql;
02132     BOOLEAN state;
02133     BOOLEAN FinalControlArea;
02134 
02135 
02136     <span class="keywordflow">if</span> (FlushType == <a class="code" href="../../d2/d1/mm_8h.html#a346a179">MmFlushForDelete</a>) {
02137 
02138         <span class="comment">//</span>
02139         <span class="comment">// Do a quick check to see if there are any mapped views for</span>
02140         <span class="comment">// the data section.  If so, just return FALSE.</span>
02141         <span class="comment">//</span>
02142 
02143         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02144         ControlArea = (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(SectionPointer-&gt;DataSectionObject);
02145         <span class="keywordflow">if</span> (ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02146             <span class="keywordflow">if</span> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> != 0) ||
02147                 (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated)) {
02148                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02149                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02150             }
02151         }
02152         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02153     }
02154 
02155     <span class="comment">//</span>
02156     <span class="comment">// Check the status of the control area.  If the control area is in use</span>
02157     <span class="comment">// or the control area is being deleted, this operation cannot continue.</span>
02158     <span class="comment">//</span>
02159 
02160     state = <a class="code" href="../../d5/d5/sectsup_8c.html#a26">MiCheckControlAreaStatus</a> (CheckImageSection,
02161                                       SectionPointer,
02162                                       FALSE,
02163                                       &amp;ControlArea,
02164                                       &amp;OldIrql);
02165 
02166     <span class="keywordflow">if</span> (ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02167         <span class="keywordflow">return</span> state;
02168     }
02169 
02170     <span class="comment">//</span>
02171     <span class="comment">// PFN LOCK IS NOW HELD!</span>
02172     <span class="comment">//</span>
02173 
02174     <span class="comment">//</span>
02175     <span class="comment">// Repeat until there are no more control areas - multiple control areas</span>
02176     <span class="comment">// for the same image section occur to support user global DLLs - these DLLs</span>
02177     <span class="comment">// require data that is shared within a session but not across sessions.</span>
02178     <span class="comment">// Note this can only happen for Hydra.</span>
02179     <span class="comment">//</span>
02180 
02181     <span class="keywordflow">do</span> {
02182 
02183         <span class="comment">//</span>
02184         <span class="comment">// Set the being deleted flag and up the number of mapped views</span>
02185         <span class="comment">// for the segment.  Upping the number of mapped views prevents</span>
02186         <span class="comment">// the segment from being deleted and passed to the deletion thread</span>
02187         <span class="comment">// while we are forcing a delete.</span>
02188         <span class="comment">//</span>
02189 
02190         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted = 1;
02191         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> = 1;
02192         FinalControlArea = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02193 
02194         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02195             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea ==
02196                     (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)SectionPointer-&gt;ImageSectionObject);
02197         }
02198 
02199         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0) {
02200         }
02201         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsListEmpty(&amp;((<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)ControlArea)-&gt;UserGlobalList)) {
02202             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea ==
02203                     (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)SectionPointer-&gt;ImageSectionObject);
02204         }
02205         <span class="keywordflow">else</span> {
02206 
02207             <span class="comment">//</span>
02208             <span class="comment">// Check if there's only one image section in this control area, so</span>
02209             <span class="comment">// we don't reference the section object pointers as the</span>
02210             <span class="comment">// MiCleanSection call may result in its deletion.</span>
02211             <span class="comment">//</span>
02212 
02213             FinalControlArea = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02214 
02215             <span class="comment">//</span>
02216             <span class="comment">// There are multiple control areas, bump the reference count</span>
02217             <span class="comment">// on one of them (doesn't matter which one) so that it can't</span>
02218             <span class="comment">// go away.  This ensures the section object pointers will stick</span>
02219             <span class="comment">// around even after the calls below so we can safely reloop to</span>
02220             <span class="comment">// flush any other remaining control areas.</span>
02221             <span class="comment">//</span>
02222 
02223             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 1);
02224 
02225             Next = ((<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)ControlArea)-&gt;UserGlobalList.Flink;
02226 
02227             LargeControlArea = CONTAINING_RECORD (Next,
02228                                                   <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">LARGE_CONTROL_AREA</a>,
02229                                                   UserGlobalList);
02230         
02231             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 1);
02232 
02233             LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> += 1;
02234         }
02235 
02236         <span class="comment">//</span>
02237         <span class="comment">// This is a page file backed or image segment.  The segment is being</span>
02238         <span class="comment">// deleted, remove all references to the paging file and physical</span>
02239         <span class="comment">// memory.</span>
02240         <span class="comment">//</span>
02241 
02242         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02243 
02244         <a class="code" href="../../d5/d5/sectsup_8c.html#a22">MiCleanSection</a> (ControlArea, TRUE);
02245 
02246         <span class="comment">//</span>
02247         <span class="comment">// Get the next Hydra control area.</span>
02248         <span class="comment">//</span>
02249 
02250         <span class="keywordflow">if</span> (FinalControlArea == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02251             state = <a class="code" href="../../d5/d5/sectsup_8c.html#a26">MiCheckControlAreaStatus</a> (CheckImageSection,
02252                                               SectionPointer,
02253                                               FALSE,
02254                                               &amp;ControlArea,
02255                                               &amp;OldIrql);
02256             <span class="keywordflow">if</span> (!ControlArea) {
02257                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02258                 LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> -= 1;
02259                 <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)LargeControlArea,
02260                                     NULL,
02261                                     OldIrql);
02262             }
02263             <span class="keywordflow">else</span> {
02264                 LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> -= 1;
02265                 <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)LargeControlArea,
02266                                     NULL,
02267                                     OldIrql);
02268                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02269             }
02270         } <span class="keywordflow">else</span> {
02271             state = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02272             <span class="keywordflow">break</span>;
02273         }
02274 
02275     } <span class="keywordflow">while</span> (ControlArea);
02276 
02277     <span class="keywordflow">return</span> state;
02278 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="flushsec.c::MmFlushSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmFlushSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionObjectPointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Offset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>RegionSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AcquireFile</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00668">668</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02070">_CONTROL_AREA::FilePointer</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00428">_ETHREAD::ForwardClusterOnly</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02402">FsRtlAcquireFileForCcFlush()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02483">FsRtlReleaseFileForCcFlush()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">MiFlushSectionInternal()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00215">MmShortTime</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02124">_SUBSECTION::NextSubsection</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02061">_CONTROL_AREA::NumberOfPfnReferences</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cachesub_8c-source.html#l04411">CcFlushCache()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l06024">CcMapAndCopy()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00838">CcMdlWriteComplete2()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02194">CcPurgeAndClearCacheSection()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l01821">CcSetFileSizes()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l05143">CcUnpinRepinnedBcb()</a>, and <a class="el" href="../../d1/d7/creasect_8c-source.html#l04999">MiFlushDataSection()</a>.
<p>
<pre class="fragment"><div>00678                    :
00679 
00680     This function flushes to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> backing <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> any modified pages within
00681     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified range of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.
00682 
00683 Arguments:
00684 
00685     SectionObjectPointer - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section objects.
00686 
00687     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section in which to begin
00688              flushing pages.  If <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not present, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00689              whole section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> flushed without regard to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region size
00690              argument.
00691 
00692     RegionSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size in bytes to flush.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded
00693                  to a page multiple.
00694 
00695     IoStatus - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoStatus <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last attempted
00696          I/O operation.
00697 
00698     AcquireFile - Nonzero <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback should be used to acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00699 
00700 Return Value:
00701 
00702     Returns status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00703 
00704 --*/
00705 
00706 {
00707     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00708     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00709     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00710     KIRQL OldIrql;
00711     ULONG PteOffset;
00712     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00713     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> LastSubsection;
00714     BOOLEAN DeleteSegment = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00715     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread;
00716     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00717     BOOLEAN OldClusterState;
00718     ULONG ConsecutiveFileLockFailures;
00719 
00720     <span class="comment">//</span>
00721     <span class="comment">// Initialize IoStatus for success, in case we take an early exit.</span>
00722     <span class="comment">//</span>
00723 
00724     IoStatus-&gt;Status = STATUS_SUCCESS;
00725     IoStatus-&gt;Information = RegionSize;
00726 
00727     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00728 
00729     ControlArea = ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(SectionObjectPointer-&gt;DataSectionObject));
00730 
00731     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((ControlArea == NULL) || (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image == 0));
00732 
00733     <span class="keywordflow">if</span> ((ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00734         (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted) ||
00735         (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated) ||
00736         (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> == 0)) {
00737 
00738         <span class="comment">//</span>
00739         <span class="comment">// This file no longer has an associated segment or is in the</span>
00740         <span class="comment">// process of coming or going.</span>
00741         <span class="comment">// If the number of PFN references is zero, then this control</span>
00742         <span class="comment">// area does not have any valid or transition pages that need</span>
00743         <span class="comment">// to be flushed.</span>
00744         <span class="comment">//</span>
00745 
00746         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00747         <span class="keywordflow">return</span> STATUS_SUCCESS;
00748     }
00749 
00750     <span class="comment">//</span>
00751     <span class="comment">// Locate the subsection.</span>
00752     <span class="comment">//</span>
00753 
00754     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0);
00755 
00756     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
00757 
00758     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT (Offset)) {
00759 
00760         <span class="comment">//</span>
00761         <span class="comment">// If the offset is not specified, flush the complete file ignoring</span>
00762         <span class="comment">// the region size.</span>
00763         <span class="comment">//</span>
00764 
00765         PointerPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[0];
00766         LastSubsection = Subsection;
00767         <span class="keywordflow">while</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00768             LastSubsection = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00769         }
00770         LastPte = &amp;LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>
00771                             [LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> - 1];
00772     } <span class="keywordflow">else</span> {
00773 
00774         PteOffset = (ULONG)(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00775 
00776         <span class="comment">//</span>
00777         <span class="comment">// Make sure the PTEs are not in the extended part of the</span>
00778         <span class="comment">// segment.</span>
00779         <span class="comment">//</span>
00780 
00781         <span class="keywordflow">while</span> (PteOffset &gt;= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>) {
00782             PteOffset -= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
00783             <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00784 
00785                 <span class="comment">//</span>
00786                 <span class="comment">// Past end of mapping, just return success.</span>
00787                 <span class="comment">//</span>
00788 
00789                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00790                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00791             }
00792             Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00793         }
00794 
00795         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteOffset &lt; Subsection-&gt;PtesInSubsection);
00796         PointerPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
00797 
00798         <span class="comment">//</span>
00799         <span class="comment">// Locate the address of the last prototype PTE to be flushed.</span>
00800         <span class="comment">//</span>
00801 
00802         PteOffset += (ULONG)(((RegionSize + <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>-&gt;LowPart)) - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00803 
00804         LastSubsection = Subsection;
00805 
00806         <span class="keywordflow">while</span> (PteOffset &gt;= LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>) {
00807             PteOffset -= LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
00808             <span class="keywordflow">if</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00809                 PteOffset = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> - 1;
00810                 <span class="keywordflow">break</span>;
00811             }
00812             LastSubsection = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00813         }
00814 
00815         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteOffset &lt; LastSubsection-&gt;PtesInSubsection);
00816         LastPte = &amp;LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
00817     }
00818 
00819     <span class="comment">//</span>
00820     <span class="comment">// Up the map view count so the control area cannot be deleted</span>
00821     <span class="comment">// out from under the call.</span>
00822     <span class="comment">//</span>
00823 
00824     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> += 1;
00825 
00826     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00827 
00828     CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00829 
00830     <span class="comment">//</span>
00831     <span class="comment">// Indicate that disk verify errors should be returned as exceptions.</span>
00832     <span class="comment">//</span>
00833 
00834     OldClusterState = CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o22">ForwardClusterOnly</a>;
00835     CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o22">ForwardClusterOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00836 
00837     <span class="comment">//</span>
00838     <span class="comment">// Preacquire the file if we are going to synchronize the flush.</span>
00839     <span class="comment">//</span>
00840 
00841     <span class="keywordflow">if</span> (AcquireFile == 0) {
00842 
00843         <span class="comment">//</span>
00844         <span class="comment">// Flush the PTEs from the specified section.</span>
00845         <span class="comment">//</span>
00846 
00847         status = <a class="code" href="../../d4/d8/mi_8h.html#a935">MiFlushSectionInternal</a> (PointerPte,
00848                                          LastPte,
00849                                          Subsection,
00850                                          LastSubsection,
00851                                          TRUE,
00852                                          TRUE,
00853                                          IoStatus);
00854     }
00855     <span class="keywordflow">else</span> {
00856 
00857         ConsecutiveFileLockFailures = 0;
00858 
00859         <span class="keywordflow">do</span> {
00860 
00861             <a class="code" href="../../d1/d8/fsrtl_8h.html#a105">FsRtlAcquireFileForCcFlush</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>);
00862 
00863             <span class="comment">//</span>
00864             <span class="comment">// Flush the PTEs from the specified section.</span>
00865             <span class="comment">//</span>
00866 
00867             status = <a class="code" href="../../d4/d8/mi_8h.html#a935">MiFlushSectionInternal</a> (PointerPte,
00868                                              LastPte,
00869                                              Subsection,
00870                                              LastSubsection,
00871                                              TRUE,
00872                                              TRUE,
00873                                              IoStatus);
00874 
00875             <span class="comment">//</span>
00876             <span class="comment">// Release the file we acquired.</span>
00877             <span class="comment">//</span>
00878 
00879             <a class="code" href="../../d1/d8/fsrtl_8h.html#a106">FsRtlReleaseFileForCcFlush</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>);
00880 
00881             <span class="comment">//</span>
00882             <span class="comment">// Only try the request more than once if the filesystem told us</span>
00883             <span class="comment">// it had a deadlock.</span>
00884             <span class="comment">//</span>
00885 
00886             <span class="keywordflow">if</span> (status != STATUS_FILE_LOCK_CONFLICT) {
00887                 <span class="keywordflow">break</span>;
00888             }
00889 
00890             ConsecutiveFileLockFailures += 1;
00891             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmShortTime);
00892 
00893         } <span class="keywordflow">while</span> (ConsecutiveFileLockFailures &lt; 5);
00894     }
00895 
00896     CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o22">ForwardClusterOnly</a> = OldClusterState;
00897 
00898     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00899 
00900     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> &gt;= 1);
00901     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
00902 
00903     <span class="comment">//</span>
00904     <span class="comment">// Check to see if the control area should be deleted.  This</span>
00905     <span class="comment">// will release the PFN lock.</span>
00906     <span class="comment">//</span>
00907 
00908     <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
00909 
00910     <span class="keywordflow">return</span> status;
00911 
00912 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="flushsec.c::MmFlushVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmFlushVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>RegionSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">297</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02393">_MMVAD::ControlArea</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02070">_CONTROL_AREA::FilePointer</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02402">FsRtlAcquireFileForCcFlush()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02483">FsRtlReleaseFileForCcFlush()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01039">LOCK_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05293">MI_IS_SESSION_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02717">MI_IS_SYSTEM_CACHE_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00765">MI_VPN_TO_VA_ENDING</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00437">MiDoesPdeExistAndMakeValid()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01980">MiDoesPpeExistAndMakeValid</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00223">MiFlushAcquire()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02281">MiFlushDirtyBitsToPfn()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00258">MiFlushRelease()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">MiFlushSectionInternal()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l03696">MiGetProtoPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02402">MiGetSystemCacheSubsection()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d9/d9/extsect_8c-source.html#l00783">MiLocateSubsection()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00215">MmShortTime</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02124">_SUBSECTION::NextSubsection</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01081">UNLOCK_WS</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00055">NtFlushVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00306                    :
00307 
00308     This function flushes a range of <span class="keyword">virtual</span> address which map
00309     a data <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> back into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">if</span> they have been modified.
00310 
00311     Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modification <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">this</span> process's view of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages,
00312     on certain implementations (like the Intel 386), <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modify
00313     bit <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> captured in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE and not forced to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database
00314     until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set.  This means
00315     that pages which have been modified by another process will
00316     not be flushed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00317 
00318 Arguments:
00319 
00320     Process - Supplies a pointer to a process object.
00321 
00322     BaseAddress - Supplies a pointer to a variable that will receive
00323          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flushed region.  The initial value
00324          of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00325          pages to flush.
00326 
00327     RegionSize - Supplies a pointer to a variable that will receive
00328          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flushed region of pages.
00329          The initial value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00330          next host-page-size boundary.
00331 
00332          If <span class="keyword">this</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as zero, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapped range from
00333          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> flushed.
00334 
00335     IoStatus - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoStatus <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last attempted
00336          I/O operation.
00337 
00338 Return Value:
00339 
00340     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT status
00341 
00342 --*/
00343 
00344 {
00345     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
00346     PVOID EndingAddress;
00347     PVOID Va;
00348     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00349     BOOLEAN SystemCache;
00350     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00351     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00352     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00353     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00354     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00355     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FinalPte;
00356     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00357     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> LastSubsection;
00358     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00359     ULONG ConsecutiveFileLockFailures;
00360     ULONG Waited;
00361     LOGICAL EntireRestOfVad;
00362     LOGICAL Attached;
00363 
00364     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00365 
00366     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00367 
00368     <span class="comment">//</span>
00369     <span class="comment">// Determine if the specified base address is within the system</span>
00370     <span class="comment">// cache and if so, don't attach, the working set mutex is still</span>
00371     <span class="comment">// required to "lock" paged pool pages (proto PTEs) into the</span>
00372     <span class="comment">// working set.</span>
00373     <span class="comment">//</span>
00374 
00375     EndingAddress = (PVOID)(((ULONG_PTR)*BaseAddress + *RegionSize - 1) |
00376                                                             (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
00377     *BaseAddress = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (*BaseAddress);
00378 
00379     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (*BaseAddress)) {
00380 
00381         <span class="comment">//</span>
00382         <span class="comment">// Nothing in session space needs flushing.</span>
00383         <span class="comment">//</span>
00384 
00385         <span class="keywordflow">return</span> STATUS_NOT_MAPPED_VIEW;
00386     }
00387 
00388     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00389 
00390     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a196">MI_IS_SYSTEM_CACHE_ADDRESS</a>(*BaseAddress)) {
00391 
00392         SystemCache = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00393 
00394         <span class="comment">//</span>
00395         <span class="comment">// Attach to the specified process.</span>
00396         <span class="comment">//</span>
00397 
00398         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
00399             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
00400             Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00401         }
00402 
00403         <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00404 
00405         <span class="comment">//</span>
00406         <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
00407         <span class="comment">//</span>
00408 
00409         <span class="keywordflow">if</span> (Process-&gt;AddressSpaceDeleted != 0) {
00410             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
00411             <span class="keywordflow">goto</span> ErrorReturn;
00412         }
00413 
00414         Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (*BaseAddress);
00415 
00416         <span class="keywordflow">if</span> (Vad == (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00417 
00418             <span class="comment">//</span>
00419             <span class="comment">// No Virtual Address Descriptor located for Base Address.</span>
00420             <span class="comment">//</span>
00421 
00422             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_MAPPED_VIEW;
00423             <span class="keywordflow">goto</span> ErrorReturn;
00424         }
00425 
00426         <span class="keywordflow">if</span> (*RegionSize == 0) {
00427             EndingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>);
00428             EntireRestOfVad = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00429         }
00430         <span class="keywordflow">else</span> {
00431             EntireRestOfVad = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00432         }
00433 
00434         <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 1) ||
00435             (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress) &gt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>)) {
00436 
00437             <span class="comment">//</span>
00438             <span class="comment">// This virtual address descriptor does not refer to a Segment</span>
00439             <span class="comment">// object.</span>
00440             <span class="comment">//</span>
00441 
00442             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_MAPPED_VIEW;
00443             <span class="keywordflow">goto</span> ErrorReturn;
00444         }
00445 
00446         <span class="comment">//</span>
00447         <span class="comment">// Make sure this VAD maps a data file (not an image file).</span>
00448         <span class="comment">//</span>
00449 
00450         ControlArea = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>;
00451 
00452         <span class="keywordflow">if</span> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00453              (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.ImageMap == 1)) {
00454 
00455             <span class="comment">//</span>
00456             <span class="comment">// This virtual address descriptor does not refer to a Segment</span>
00457             <span class="comment">// object.</span>
00458             <span class="comment">//</span>
00459 
00460             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_MAPPED_DATA;
00461             <span class="keywordflow">goto</span> ErrorReturn;
00462         }
00463 
00464     } <span class="keywordflow">else</span> {
00465 
00466         SystemCache = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00467         Process = CurrentProcess;
00468         <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (Process);
00469     }
00470 
00471     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (*BaseAddress);
00472     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (*BaseAddress);
00473     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (*BaseAddress);
00474     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
00475     *RegionSize = (PCHAR)EndingAddress - (PCHAR)*BaseAddress + 1;
00476 
00477 retry:
00478 
00479     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe, Process, FALSE, &amp;Waited)) {
00480 
00481         <span class="comment">//</span>
00482         <span class="comment">// This page directory parent entry is empty, go to the next one.</span>
00483         <span class="comment">//</span>
00484 
00485         PointerPpe += 1;
00486         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00487         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00488         Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00489 
00490         <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
00491             <span class="keywordflow">break</span>;
00492         }
00493     }
00494 
00495     Waited = 0;
00496 
00497     <span class="keywordflow">if</span> (PointerPte &lt;= LastPte) {
00498         <span class="keywordflow">while</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a>(PointerPde, Process, FALSE, &amp;Waited)) {
00499 
00500             <span class="comment">//</span>
00501             <span class="comment">// No page table page exists for this address.</span>
00502             <span class="comment">//</span>
00503 
00504             PointerPde += 1;
00505 
00506             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00507 
00508             <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
00509                 <span class="keywordflow">break</span>;
00510             }
00511 
00512 <span class="preprocessor">#if defined (_WIN64)</span>
00513 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
00514                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00515                 <span class="keywordflow">goto</span> retry;
00516             }
00517 <span class="preprocessor">#endif</span>
00518 <span class="preprocessor"></span>
00519             Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00520         }
00521 
00522         <span class="comment">//</span>
00523         <span class="comment">// If the PFN lock (and accordingly the WS mutex) was</span>
00524         <span class="comment">// released and reacquired we must retry the operation.</span>
00525         <span class="comment">//</span>
00526 
00527         <span class="keywordflow">if</span> (PointerPte &lt;= LastPte &amp;&amp; Waited != 0) {
00528             <span class="keywordflow">goto</span> retry;
00529         }
00530     }
00531 
00532     <a class="code" href="../../d6/d5/flushsec_8c.html#a2">MiFlushDirtyBitsToPfn</a> (PointerPte, LastPte, Process, SystemCache);
00533 
00534     <span class="keywordflow">if</span> (SystemCache) {
00535 
00536         <span class="comment">//</span>
00537         <span class="comment">// No VADs exist for the system cache.</span>
00538         <span class="comment">//</span>
00539 
00540         Subsection = <a class="code" href="../../d6/d5/flushsec_8c.html#a1">MiGetSystemCacheSubsection</a> (*BaseAddress,
00541                                                  Process,
00542                                                  &amp;PointerPte);
00543         LastSubsection = <a class="code" href="../../d6/d5/flushsec_8c.html#a1">MiGetSystemCacheSubsection</a> (EndingAddress,
00544                                                      Process,
00545                                                      &amp;FinalPte);
00546         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
00547 
00548         <span class="comment">//</span>
00549         <span class="comment">// Flush the PTEs from the specified section.</span>
00550         <span class="comment">//</span>
00551 
00552         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d8/mi_8h.html#a935">MiFlushSectionInternal</a> (PointerPte,
00553                                          FinalPte,
00554                                          Subsection,
00555                                          LastSubsection,
00556                                          FALSE,
00557                                          TRUE,
00558                                          IoStatus);
00559     }
00560     <span class="keywordflow">else</span> {
00561 
00562         <span class="comment">//</span>
00563         <span class="comment">// Protect against the section being prematurely deleted.</span>
00564         <span class="comment">//</span>
00565 
00566         <a class="code" href="../../d6/d5/flushsec_8c.html#a5">MiFlushAcquire</a> (ControlArea);
00567 
00568         PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (Vad, MI_VA_TO_VPN (*BaseAddress));
00569         Subsection = <a class="code" href="../../d4/d8/mi_8h.html#a909">MiLocateSubsection</a> (Vad, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(*BaseAddress));
00570         LastSubsection = <a class="code" href="../../d4/d8/mi_8h.html#a909">MiLocateSubsection</a> (Vad, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(EndingAddress));
00571 
00572         <span class="comment">//</span>
00573         <span class="comment">// The last subsection is NULL if the section is not fully </span>
00574         <span class="comment">// committed.  Only allow the flush if the caller said do the whole</span>
00575         <span class="comment">// thing, otherwise it's an error.</span>
00576         <span class="comment">//</span>
00577 
00578         <span class="keywordflow">if</span> (LastSubsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00579 
00580             <span class="keywordflow">if</span> (EntireRestOfVad == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00581 
00582                 <span class="comment">//</span>
00583                 <span class="comment">// Caller can only specify the range that is committed or zero</span>
00584                 <span class="comment">// to indicate the entire range.</span>
00585                 <span class="comment">//</span>
00586 
00587                 <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00588                 <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00589                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00590                 }
00591                 <a class="code" href="../../d6/d5/flushsec_8c.html#a6">MiFlushRelease</a> (ControlArea);
00592                 <span class="keywordflow">return</span> STATUS_NOT_MAPPED_VIEW;
00593             }
00594 
00595             LastSubsection = Subsection;
00596             <span class="keywordflow">while</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>) {
00597                 LastSubsection = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00598             }
00599             FinalPte = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a> + LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> - 1;
00600         }
00601         <span class="keywordflow">else</span> {
00602             FinalPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (Vad, MI_VA_TO_VPN (EndingAddress));
00603         }
00604 
00605         <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00606         <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00607             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00608         }
00609 
00610         <span class="comment">//</span>
00611         <span class="comment">// Preacquire the file to synchronize the flush.</span>
00612         <span class="comment">//</span>
00613 
00614         ConsecutiveFileLockFailures = 0;
00615 
00616         <span class="keywordflow">do</span> {
00617 
00618             <a class="code" href="../../d1/d8/fsrtl_8h.html#a105">FsRtlAcquireFileForCcFlush</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>);
00619 
00620             <span class="comment">//</span>
00621             <span class="comment">// Flush the PTEs from the specified section.</span>
00622             <span class="comment">//</span>
00623 
00624             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d8/mi_8h.html#a935">MiFlushSectionInternal</a> (PointerPte,
00625                                              FinalPte,
00626                                              Subsection,
00627                                              LastSubsection,
00628                                              TRUE,
00629                                              TRUE,
00630                                              IoStatus);
00631 
00632             <span class="comment">//</span>
00633             <span class="comment">// Release the file we acquired.</span>
00634             <span class="comment">//</span>
00635 
00636             <a class="code" href="../../d1/d8/fsrtl_8h.html#a106">FsRtlReleaseFileForCcFlush</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>);
00637 
00638             <span class="comment">//</span>
00639             <span class="comment">// Only try the request more than once if the filesystem told us</span>
00640             <span class="comment">// it had a deadlock.</span>
00641             <span class="comment">//</span>
00642 
00643             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_FILE_LOCK_CONFLICT) {
00644                 <span class="keywordflow">break</span>;
00645             }
00646 
00647             ConsecutiveFileLockFailures += 1;
00648             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmShortTime);
00649 
00650         } <span class="keywordflow">while</span> (ConsecutiveFileLockFailures &lt; 5);
00651 
00652         <a class="code" href="../../d6/d5/flushsec_8c.html#a6">MiFlushRelease</a> (ControlArea);
00653     }
00654 
00655     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00656 
00657 ErrorReturn:
00658     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SystemCache == FALSE);
00659     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00660     <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00661         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00662     }
00663     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00664 
00665 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="flushsec.c::MmPurgeSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmPurgeSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionObjectPointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Offset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>RegionSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreCacheViews</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01548">1548</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01534">_FILE_OBJECT::FileName</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02070">_CONTROL_AREA::FilePointer</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02579">MiCancelWriteOfMappedPfn()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02614">MiCanFileBeTruncatedInternal()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, <a class="el" href="../../d5/d5/sectsup_8c.html#a11">MiCheckProtoPtePageState()</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00996">MiMakeSystemAddressValidPfn()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00179">MM_DBG_FLUSH_SECTION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04610">MmMappedFileIoComplete</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02072">_CONTROL_AREA::ModifiedWriteCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02124">_SUBSECTION::NextSubsection</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02061">_CONTROL_AREA::NumberOfPfnReferences</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02073">_CONTROL_AREA::NumberOfSystemCacheViews</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00910">UNLOCK_PFN_AND_THEN_WAIT</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a217">WrPageOut</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l02331">CcPurgeCacheSection()</a>.
<p>
<pre class="fragment"><div>01557                    :
01558 
01559     This function determines <span class="keywordflow">if</span> any views of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section
01560     are mapped, and <span class="keywordflow">if</span> not, purges valid pages (even modified ones)
01561     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section and returns any used pages to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free
01562     list.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accomplished by examining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prototype PTEs
01563     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified offset to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section, and <span class="keywordflow">if</span>
01564     any prototype PTEs are in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transition state, putting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01565     prototype PTE back into its original state and putting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01566     physical page on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free list.
01567 
01568     NOTE:
01569 
01570     If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an I/O operation ongoing <span class="keywordflow">for</span> one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages,
01571     that page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> eliminated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> segment and allowed to <span class="stringliteral">"float"</span>
01572     until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> i/o <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete.  Once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> share count goes to zero
01573     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page will be added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free page list.
01574 
01575 Arguments:
01576 
01577     SectionObjectPointer - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section objects.
01578 
01579     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section in which to begin
01580              purging pages.  If <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not present, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01581              whole section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> purged without regard to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region size
01582              argument.
01583 
01584 
01585     RegionSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region to purge.  If <span class="keyword">this</span>
01586                  <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as zero and <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01587                  region from <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> purged.
01588 
01589                  Note: The largest value acceptable <span class="keywordflow">for</span> RegionSize <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01590                  0xFFFF0000;
01591 
01592     IgnoreCacheViews - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> mapped views in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system
01593                  cache should cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function to <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
01594                  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal <span class="keywordflow">case</span>.
01595                  Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> mapped views should be ignored
01596                  and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flush should occur.  NOTE THAT <a class="code" href="../../d2/d0/aw_8h.html#a1">IF</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01597                  IS SPECIFIED AND ANY DATA PURGED IS CURRENTLY MAPPED
01598                  AND VALID <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> BUGCHECK WILL OCCUR!!
01599 
01600 Return Value:
01601 
01602     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> either no section exists <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object or
01603     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not mapped and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> purge was done, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01604 
01605     Note that <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> purge operation, a page
01606     could not be purged due to a non-zero reference count.
01607 
01608 --*/
01609 
01610 {
01611     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
01612     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01613     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
01614     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FinalPte;
01615     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
01616     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01617     KIRQL OldIrql;
01618     ULONG PteOffset;
01619     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
01620     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> LastSubsection;
01621     LARGE_INTEGER LocalOffset;
01622     BOOLEAN DeleteSegment = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01623     BOOLEAN LockHeld;
01624     BOOLEAN ReturnValue;
01625     PFN_NUMBER PageFrameIndex;
01626 <span class="preprocessor">#if DBG</span>
01627 <span class="preprocessor"></span>    PFN_NUMBER LastLocked = 0;
01628 <span class="preprocessor">#endif //DBG</span>
01629 <span class="preprocessor"></span>
01630     <span class="comment">//</span>
01631     <span class="comment">// This is needed in case a page is on the mapped page writer list -</span>
01632     <span class="comment">// the PFN lock will need to be released and APCs disabled.</span>
01633     <span class="comment">//</span>
01634 
01635     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt; DISPATCH_LEVEL);
01636 
01637     <span class="comment">//</span>
01638     <span class="comment">//  Capture caller's file size, since we may modify it.</span>
01639     <span class="comment">//</span>
01640 
01641     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Offset)) {
01642 
01643         LocalOffset = *<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01644         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = &amp;LocalOffset;
01645     }
01646 
01647     <span class="comment">//</span>
01648     <span class="comment">//  See if we can truncate this file to where the caller wants</span>
01649     <span class="comment">//  us to.</span>
01650     <span class="comment">//</span>
01651 
01652     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/sectsup_8c.html#a31">MiCanFileBeTruncatedInternal</a>(SectionObjectPointer, Offset, TRUE, &amp;OldIrql)) {
01653         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01654     }
01655 
01656     <span class="comment">//</span>
01657     <span class="comment">// PFN LOCK IS NOW HELD!</span>
01658     <span class="comment">//</span>
01659 
01660     ControlArea = (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(SectionObjectPointer-&gt;DataSectionObject);
01661     <span class="keywordflow">if</span> (ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01662         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01663         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01664 
01665     <span class="comment">//</span>
01666     <span class="comment">//  Even though MiCanFileBeTruncatedInternal returned TRUE, there could</span>
01667     <span class="comment">//  still be a system cache mapped view.  We cannot truncate if</span>
01668     <span class="comment">//  the Cache Manager has a view mapped.</span>
01669     <span class="comment">//</span>
01670 
01671     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((IgnoreCacheViews == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
01672             (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o14">NumberOfSystemCacheViews</a> != 0)) {
01673         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01674         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01675     }
01676 
01677     <span class="comment">//</span>
01678     <span class="comment">// Prevent races when the control area is being deleted as the clean</span>
01679     <span class="comment">// path releases the PFN lock midway through.  File objects may still have</span>
01680     <span class="comment">// section object pointers and data section objects that point at this</span>
01681     <span class="comment">// control area, hence the purge can be issued.</span>
01682     <span class="comment">//</span>
01683     <span class="comment">// Check for this and fail the purge as the control area (and the section</span>
01684     <span class="comment">// object pointers/data section objects) will be going away momentarily.</span>
01685     <span class="comment">// Note that even though drivers have these data section objects, no one</span>
01686     <span class="comment">// currently has an open section for this control area and no one is</span>
01687     <span class="comment">// allowed to open one until the clean path finishes.</span>
01688     <span class="comment">//</span>
01689 
01690     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted == 1) {
01691         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01692         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01693     }
01694 
01695     <span class="comment">//</span>
01696     <span class="comment">// Purge the section - locate the subsection which</span>
01697     <span class="comment">// contains the PTEs.</span>
01698     <span class="comment">//</span>
01699 
01700     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0);
01701 
01702     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
01703 
01704     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT (Offset)) {
01705 
01706         <span class="comment">//</span>
01707         <span class="comment">// If the offset is not specified, flush the complete file ignoring</span>
01708         <span class="comment">// the region size.</span>
01709         <span class="comment">//</span>
01710 
01711         PointerPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[0];
01712         RegionSize = 0;
01713 
01714     } <span class="keywordflow">else</span> {
01715 
01716         PteOffset = (ULONG)(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01717 
01718         <span class="comment">//</span>
01719         <span class="comment">// Make sure the PTEs are not in the extended part of the</span>
01720         <span class="comment">// segment.</span>
01721         <span class="comment">//</span>
01722 
01723         <span class="keywordflow">while</span> (PteOffset &gt;= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>) {
01724             PteOffset -= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
01725             Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
01726             <span class="keywordflow">if</span> (Subsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01727 
01728                 <span class="comment">//</span>
01729                 <span class="comment">// The offset must be equal to the size of</span>
01730                 <span class="comment">// the section, don't purge anything just return.</span>
01731                 <span class="comment">//</span>
01732 
01733                 <span class="comment">//ASSERT (PteOffset == 0);</span>
01734                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01735                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01736             }
01737         }
01738 
01739         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteOffset &lt; Subsection-&gt;PtesInSubsection);
01740         PointerPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
01741     }
01742 
01743 
01744     <span class="comment">//</span>
01745     <span class="comment">// Locate the address of the last prototype PTE to be flushed.</span>
01746     <span class="comment">//</span>
01747 
01748     <span class="keywordflow">if</span> (RegionSize == 0) {
01749 
01750         <span class="comment">//</span>
01751         <span class="comment">// Flush to end of section.</span>
01752         <span class="comment">//</span>
01753 
01754         LastSubsection = Subsection;
01755         <span class="keywordflow">while</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01756             LastSubsection = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
01757         }
01758 
01759         <span class="comment">//</span>
01760         <span class="comment">// Set the final PTE to 1 beyond the last page.</span>
01761         <span class="comment">//</span>
01762 
01763         FinalPte = &amp;LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>
01764                             [LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
01765     } <span class="keywordflow">else</span> {
01766 
01767         <span class="comment">//</span>
01768         <span class="comment">// Calculate the end of the region.</span>
01769         <span class="comment">//</span>
01770 
01771         PteOffset +=
01772             (ULONG) (((RegionSize + <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>-&gt;LowPart)) - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01773 
01774         LastSubsection = Subsection;
01775 
01776         <span class="keywordflow">while</span> (PteOffset &gt;= LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>) {
01777             PteOffset -= LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
01778             <span class="keywordflow">if</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01779                 PteOffset = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> - 1;
01780                 <span class="keywordflow">break</span>;
01781             }
01782             LastSubsection = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
01783         }
01784 
01785         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteOffset &lt; LastSubsection-&gt;PtesInSubsection);
01786 
01787         <span class="comment">//</span>
01788         <span class="comment">// Point final PTE to 1 beyond the end.</span>
01789         <span class="comment">//</span>
01790 
01791         FinalPte = &amp;LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset + 1];
01792     }
01793 
01794     <span class="comment">//</span>
01795     <span class="comment">// Increment the number of mapped views to</span>
01796     <span class="comment">// prevent the section from being deleted while the purge is</span>
01797     <span class="comment">// in progress.</span>
01798     <span class="comment">//</span>
01799 
01800     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> += 1;
01801 
01802     <span class="comment">//</span>
01803     <span class="comment">// Set being purged so no one can map a view</span>
01804     <span class="comment">// while the purge is going on.</span>
01805     <span class="comment">//</span>
01806 
01807     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingPurged = 1;
01808     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.WasPurged = 1;
01809 
01810     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01811     LockHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01812     ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01813 
01814     <span class="keywordflow">for</span> (;;) {
01815 
01816         <span class="keywordflow">if</span> (LastSubsection != Subsection) {
01817 
01818             <span class="comment">//</span>
01819             <span class="comment">// Flush to the last PTE in this subsection.</span>
01820             <span class="comment">//</span>
01821 
01822             LastPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
01823         } <span class="keywordflow">else</span> {
01824 
01825             <span class="comment">//</span>
01826             <span class="comment">// Flush to the end of the range.</span>
01827             <span class="comment">//</span>
01828 
01829             LastPte = FinalPte;
01830         }
01831 
01832         <span class="comment">//</span>
01833         <span class="comment">// If the page table page containing the PTEs is not</span>
01834         <span class="comment">// resident, then no PTEs can be in the valid or transition</span>
01835         <span class="comment">// state!  Skip over the PTEs.</span>
01836         <span class="comment">//</span>
01837 
01838         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/sectsup_8c.html#a11">MiCheckProtoPtePageState</a>(PointerPte, LockHeld)) {
01839             PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(((ULONG_PTR)PointerPte | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) + 1);
01840         }
01841 
01842         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
01843 
01844             <span class="comment">//</span>
01845             <span class="comment">// If the page table page containing the PTEs is not</span>
01846             <span class="comment">// resident, then no PTEs can be in the valid or transition</span>
01847             <span class="comment">// state!  Skip over the PTEs.</span>
01848             <span class="comment">//</span>
01849 
01850             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) {
01851                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/sectsup_8c.html#a11">MiCheckProtoPtePageState</a>(PointerPte, LockHeld)) {
01852                     PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)PointerPte + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01853                     <span class="keywordflow">continue</span>;
01854                 }
01855             }
01856 
01857             PteContents = *PointerPte;
01858 
01859             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01860 
01861                 <span class="comment">//</span>
01862                 <span class="comment">// A valid PTE was found, it must be mapped in the</span>
01863                 <span class="comment">// system cache.  Just exit the loop and return FALSE</span>
01864                 <span class="comment">// and let the caller fix this.</span>
01865                 <span class="comment">//</span>
01866 
01867                 ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01868                 <span class="keywordflow">break</span>;
01869             }
01870 
01871             <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
01872                      (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
01873 
01874                 <span class="keywordflow">if</span> (!LockHeld) {
01875                     LockHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01876                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01877                     <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerPte);
01878                     <span class="keywordflow">continue</span>;
01879                 }
01880 
01881                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>(&amp;PteContents);
01882                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01883 
01884                 <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype != 1) ||
01885                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid != 0) ||
01886                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> != PointerPte)) {
01887 
01888                     <span class="comment">//</span>
01889                     <span class="comment">// The pool containing the prototype PTEs has been</span>
01890                     <span class="comment">// corrupted.  Pool corruption like this is fatal.</span>
01891                     <span class="comment">//</span>
01892 
01893                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (POOL_CORRUPTION_IN_FILE_AREA,
01894                                   0x2,
01895                                   (ULONG_PTR)PointerPte,
01896                                   (ULONG_PTR)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>,
01897                                   (ULONG_PTR)PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01898                 }
01899 
01900 <span class="preprocessor">#if DBG</span>
01901 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0) &amp;&amp;
01902                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
01903 
01904                     <span class="comment">//</span>
01905                     <span class="comment">// There must be an I/O in progress on this</span>
01906                     <span class="comment">// page.</span>
01907                     <span class="comment">//</span>
01908 
01909                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>(&amp;PteContents) != LastLocked) {
01910                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01911 
01912 <span class="preprocessor">#if DBG</span>
01913 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a71">MM_DBG_FLUSH_SECTION</a>) {
01914                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:PURGE - page %lx locked, file:%Z\n"</span>,
01915                                     PageFrameIndex,
01916                                     &amp;ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>
01917                                 );
01918                         }
01919 <span class="preprocessor">#endif</span>
01920 <span class="preprocessor"></span>                        LastLocked = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents);
01921                         <span class="comment">//DbgBreakPoint();</span>
01922                         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01923                         <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerPte);
01924                         <span class="keywordflow">continue</span>;
01925                     }
01926                 }
01927 <span class="preprocessor">#endif //DBG</span>
01928 <span class="preprocessor"></span>
01929                 <span class="comment">//</span>
01930                 <span class="comment">// If the modified page writer has page locked for I/O</span>
01931                 <span class="comment">// wait for the I/O's to be completed and the pages</span>
01932                 <span class="comment">// to be unlocked.  The eliminates a race condition</span>
01933                 <span class="comment">// when the modified page writer locks the pages, then</span>
01934                 <span class="comment">// a purge occurs and completes before the mapped</span>
01935                 <span class="comment">// writer thread runs.</span>
01936                 <span class="comment">//</span>
01937 
01938                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 1) {
01939 
01940                     <span class="comment">//</span>
01941                     <span class="comment">// A 3 or more thread deadlock can occur where:</span>
01942                     <span class="comment">//</span>
01943                     <span class="comment">// 1.  The mapped page writer thread has issued a write</span>
01944                     <span class="comment">//     and is in the filesystem code waiting for a resource.</span>
01945                     <span class="comment">//</span>
01946                     <span class="comment">// 2.  Thread 2 owns the resource above but is waiting for</span>
01947                     <span class="comment">//     the filesystem's quota mutex.</span>
01948                     <span class="comment">//</span>
01949                     <span class="comment">// 3.  Thread 3 owns the quota mutex and is right here</span>
01950                     <span class="comment">//     doing a purge from the cache manager when he notices</span>
01951                     <span class="comment">//     the page to be purged is either already being written</span>
01952                     <span class="comment">//     or is in the mapped page writer list.  If it is</span>
01953                     <span class="comment">//     already being written everything will unjam.  If it</span>
01954                     <span class="comment">//     is still on the mapped page writer list awaiting</span>
01955                     <span class="comment">//     processing, then it must be cancelled - otherwise</span>
01956                     <span class="comment">//     if this thread were to wait, deadlock can occur.</span>
01957                     <span class="comment">//</span>
01958                     <span class="comment">// The alternative to all this is for the filesystems to</span>
01959                     <span class="comment">// always release the quota mutex before purging but the</span>
01960                     <span class="comment">// filesystem overhead to do this is substantial.</span>
01961                     <span class="comment">//</span>
01962 
01963                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a50">MiCancelWriteOfMappedPfn</a> (PageFrameIndex) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01964 
01965                         <span class="comment">//</span>
01966                         <span class="comment">// Stopping any failed writes (even deliberately</span>
01967                         <span class="comment">// cancelled ones) automatically cause a delay.  A</span>
01968                         <span class="comment">// successful stop also results in the PFN lock</span>
01969                         <span class="comment">// being released and reacquired.  So loop back to</span>
01970                         <span class="comment">// the top now as the world may have changed.</span>
01971                         <span class="comment">//</span>
01972 
01973                         <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerPte);
01974                         <span class="keywordflow">continue</span>;
01975                     }
01976 
01977                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o13">ModifiedWriteCount</a> != 0);
01978                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0);
01979 
01980                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.SetMappedFileIoComplete = 1;
01981 
01982                     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01983                     <a class="code" href="../../d4/d8/mi_8h.html#a132">UNLOCK_PFN_AND_THEN_WAIT</a>(OldIrql);
01984 
01985                     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;MmMappedFileIoComplete,
01986                                           WrPageOut,
01987                                           KernelMode,
01988                                           FALSE,
01989                                           (PLARGE_INTEGER)NULL);
01990                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01991                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01992                     <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerPte);
01993                     <span class="keywordflow">continue</span>;
01994                 }
01995 
01996                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress == 1) {
01997 
01998                     <span class="comment">//</span>
01999                     <span class="comment">// The page currently is being read in from the</span>
02000                     <span class="comment">// disk.  Treat this just like a valid PTE and</span>
02001                     <span class="comment">// return false.</span>
02002                     <span class="comment">//</span>
02003 
02004                     ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02005                     <span class="keywordflow">break</span>;
02006                 }
02007 
02008                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
02009                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)));
02010 
02011                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
02012 
02013                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
02014 
02015                 ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> -= 1;
02016                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> &gt;= 0);
02017 
02018                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
02019 
02020                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
02021 
02022                 <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
02023 
02024                 <span class="comment">//</span>
02025                 <span class="comment">// If the reference count for the page is zero, insert</span>
02026                 <span class="comment">// it into the free page list, otherwise leave it alone</span>
02027                 <span class="comment">// and when the reference count is decremented to zero</span>
02028                 <span class="comment">// the page will go to the free list.</span>
02029                 <span class="comment">//</span>
02030 
02031                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
02032                     <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
02033                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
02034                                         MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE (&amp;PteContents));
02035                 }
02036             }
02037             PointerPte += 1;
02038 
02039             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) &amp;&amp; (LockHeld)) {
02040 
02041                 <span class="comment">//</span>
02042                 <span class="comment">// Unlock PFN so large requests will not block other</span>
02043                 <span class="comment">// threads on MP systems.</span>
02044                 <span class="comment">//</span>
02045 
02046                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02047                 LockHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02048             }
02049 
02050         } <span class="comment">//end while</span>
02051 
02052         <span class="keywordflow">if</span> (LockHeld) {
02053             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02054             LockHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02055         }
02056 
02057         <span class="keywordflow">if</span> ((LastSubsection != Subsection) &amp;&amp; (ReturnValue)) {
02058 
02059             <span class="comment">//</span>
02060             <span class="comment">// Get the next subsection in the list.</span>
02061             <span class="comment">//</span>
02062 
02063             Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
02064             PointerPte = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>;
02065 
02066         } <span class="keywordflow">else</span> {
02067 
02068             <span class="comment">//</span>
02069             <span class="comment">// The last range has been flushed, exit the top FOR loop</span>
02070             <span class="comment">// and return.</span>
02071             <span class="comment">//</span>
02072 
02073             <span class="keywordflow">break</span>;
02074         }
02075     }  <span class="comment">//end for</span>
02076 
02077     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02078 
02079     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> &gt;= 1);
02080     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
02081 
02082     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingPurged = 0;
02083 
02084     <span class="comment">//</span>
02085     <span class="comment">// Check to see if the control area should be deleted.  This</span>
02086     <span class="comment">// will release the PFN lock.</span>
02087     <span class="comment">//</span>
02088 
02089     <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
02090     <span class="keywordflow">return</span> ReturnValue;
02091 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="flushsec.c::NtFlushVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtFlushVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>RegionSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00055">55</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01498">ProbeForWriteIoStatus</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01598">ProbeForWritePointer</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01666">ProbeForWriteUlong_ptr</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00064                    :
00065 
00066     This function flushes a range of <span class="keyword">virtual</span> address which map
00067     a data <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> back into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">if</span> they have been modified.
00068 
00069 Arguments:
00070 
00071     ProcessHandle - Supplies an open handle to a process object.
00072 
00073     BaseAddress - Supplies a pointer to a variable that will receive
00074          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flushed region.  The initial value
00075          of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00076          pages to flush.
00077 
00078     RegionSize - Supplies a pointer to a variable that will receive
00079          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flushed region of pages.
00080          The initial value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00081          next host-page-size boundary.
00082 
00083          If <span class="keyword">this</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as zero, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapped range from
00084          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> flushed.
00085 
00086     IoStatus - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoStatus <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last attempted
00087          I/O operation.
00088 
00089 Return Value:
00090 
00091     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00092 
00093     TBS
00094 
00095 
00096 --*/
00097 
00098 {
00099     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00100     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00101     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00102     PVOID CapturedBase;
00103     SIZE_T CapturedRegionSize;
00104     IO_STATUS_BLOCK TemporaryIoStatus;
00105 
00106     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00107 
00108     PreviousMode = KeGetPreviousMode();
00109     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00110 
00111         <span class="comment">//</span>
00112         <span class="comment">// Establish an exception handler, probe the specified addresses</span>
00113         <span class="comment">// for write access and capture the initial values.</span>
00114         <span class="comment">//</span>
00115 
00116         <span class="keywordflow">try</span> {
00117 
00118             <a class="code" href="../../d5/d8/ex_8h.html#a37">ProbeForWritePointer</a> (BaseAddress);
00119             <a class="code" href="../../d5/d8/ex_8h.html#a41">ProbeForWriteUlong_ptr</a> (RegionSize);
00120             <a class="code" href="../../d5/d8/ex_8h.html#a31">ProbeForWriteIoStatus</a> (IoStatus);
00121 
00122             <span class="comment">//</span>
00123             <span class="comment">// Capture the base address.</span>
00124             <span class="comment">//</span>
00125 
00126             CapturedBase = *BaseAddress;
00127 
00128             <span class="comment">//</span>
00129             <span class="comment">// Capture the region size.</span>
00130             <span class="comment">//</span>
00131 
00132             CapturedRegionSize = *RegionSize;
00133 
00134         } except (EXCEPTION_EXECUTE_HANDLER) {
00135 
00136             <span class="comment">//</span>
00137             <span class="comment">// If an exception occurs during the probe or capture</span>
00138             <span class="comment">// of the initial values, then handle the exception and</span>
00139             <span class="comment">// return the exception code as the status value.</span>
00140             <span class="comment">//</span>
00141 
00142             <span class="keywordflow">return</span> GetExceptionCode();
00143         }
00144 
00145     } <span class="keywordflow">else</span> {
00146 
00147         <span class="comment">//</span>
00148         <span class="comment">// Capture the base address.</span>
00149         <span class="comment">//</span>
00150 
00151         CapturedBase = *BaseAddress;
00152 
00153         <span class="comment">//</span>
00154         <span class="comment">// Capture the region size.</span>
00155         <span class="comment">//</span>
00156 
00157         CapturedRegionSize = *RegionSize;
00158 
00159     }
00160 
00161     <span class="comment">//</span>
00162     <span class="comment">// Make sure the specified starting and ending addresses are</span>
00163     <span class="comment">// within the user part of the virtual address space.</span>
00164     <span class="comment">//</span>
00165 
00166     <span class="keywordflow">if</span> (CapturedBase &gt; MM_HIGHEST_USER_ADDRESS) {
00167 
00168         <span class="comment">//</span>
00169         <span class="comment">// Invalid base address.</span>
00170         <span class="comment">//</span>
00171 
00172         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
00173     }
00174 
00175     <span class="keywordflow">if</span> (((ULONG_PTR)MM_HIGHEST_USER_ADDRESS - (ULONG_PTR)CapturedBase) &lt;
00176                                                         CapturedRegionSize) {
00177 
00178         <span class="comment">//</span>
00179         <span class="comment">// Invalid region size;</span>
00180         <span class="comment">//</span>
00181 
00182         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
00183 
00184     }
00185 
00186     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( ProcessHandle,
00187                                          PROCESS_VM_OPERATION,
00188                                          PsProcessType,
00189                                          PreviousMode,
00190                                          (PVOID *)&amp;Process,
00191                                          NULL );
00192     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00193         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00194     }
00195 
00196     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/flushsec_8c.html#a7">MmFlushVirtualMemory</a> (Process,
00197                                    &amp;CapturedBase,
00198                                    &amp;CapturedRegionSize,
00199                                    &amp;TemporaryIoStatus);
00200 
00201     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00202 
00203     <span class="comment">//</span>
00204     <span class="comment">// Establish an exception handler and write the size and base</span>
00205     <span class="comment">// address.</span>
00206     <span class="comment">//</span>
00207 
00208     <span class="keywordflow">try</span> {
00209 
00210         *RegionSize = CapturedRegionSize;
00211         *BaseAddress = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (CapturedBase);
00212         *IoStatus = TemporaryIoStatus;
00213 
00214     } except (EXCEPTION_EXECUTE_HANDLER) {
00215     }
00216 
00217     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00218 
00219 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="flushsec.c::IoFileObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d3/d4/vdm_2vdm_8c.html#a2">IoFileObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00052">52</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:44 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
