<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pfndec.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pfndec.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d7/d4/pfndec_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (IN PFN_NUMBER PageFrameIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (IN PFN_NUMBER PageFrameIndex)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/pfndec_8c.html#a0">MmFrontOfList</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="pfndec.c::MiDecrementReferenceCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL MiDecrementReferenceCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFN_NUMBER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PageFrameIndex</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">167</a> of file <a class="el" href="../../d7/d4/pfndec_8c-source.html">pfndec.c</a>.
<p>
References <a class="el" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00934">MI_IS_PFN_DELETED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00388">MiInsertStandbyListAtFront()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01245">MiRestoreTransitionPte()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00030">MmFrontOfList</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, and <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00068">MiDispatchFault()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l02095">MiDownPfnReferenceCount()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">MiFlushSectionInternal()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00708">MiFreeNonPagedPool()</a>, <a class="el" href="../../d2/d1/mm_2i386_2init386_8c-source.html#l00058">MiInitMachineDependent()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04501">MiRemoveImageHeaderPage()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00868">MiResolveTransitionFault()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01123">MiUnlockPagedAddress()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04450">MiUpdateImageHeaderPage()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02234">MiWriteComplete()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05051">MmFreePagesFromMdl()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l08038">MmReturnMemoryForHibernate()</a>, <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02986">MmTrimAllSystemPagableMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07869">MmUnlockPagedPool()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">MmUnlockPages()</a>.
<p>
<pre class="fragment"><div>00173                    :
00174 
00175     This routine decrements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified page.
00176     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count becomes zero, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00177     appropriate list (free, modified, standby or bad).  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page
00178     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free or standby list, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of available
00179     pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incremented and <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> transitions from zero to one, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00180     available page event <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set.
00181 
00182 
00183 Arguments:
00184 
00185     PageFrameIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical page number of which to
00186                      decrement <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count.
00187 
00188 Return Value:
00189 
00190     none.
00191 
00192 Environment:
00193 
00194     Must be holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database mutex with APCs disabled.
00195 
00196 --*/
00197 
00198 {
00199     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00200 
00201     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00202 
00203     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageFrameIndex &lt;= MmHighestPhysicalPage);
00204 
00205     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00206     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0);
00207     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount -= 1;
00208 
00209 
00210     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0) {
00211 
00212         <span class="comment">//</span>
00213         <span class="comment">// The reference count is not zero, return.</span>
00214         <span class="comment">//</span>
00215 
00216         <span class="keywordflow">return</span>;
00217     }
00218 
00219     <span class="comment">//</span>
00220     <span class="comment">// The reference count is now zero, put the page on some</span>
00221     <span class="comment">// list.</span>
00222     <span class="comment">//</span>
00223 
00224 
00225     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount != 0) {
00226 
00227         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT,
00228                       7,
00229                       PageFrameIndex,
00230                       Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount,
00231                       0);
00232         <span class="keywordflow">return</span>;
00233     }
00234 
00235     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != ActiveAndValid);
00236 
00237     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a121">MI_IS_PFN_DELETED</a> (Pfn1)) {
00238 
00239         <span class="comment">//</span>
00240         <span class="comment">// There is no referenced PTE for this page, delete the page file</span>
00241         <span class="comment">// space (if any), and place the page on the free list.</span>
00242         <span class="comment">//</span>
00243 
00244         <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00245 
00246         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 1) {
00247             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[BadPageList],
00248                                 PageFrameIndex);
00249         }
00250         <span class="keywordflow">else</span> {
00251             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
00252                                 PageFrameIndex);
00253         }
00254 
00255         <span class="keywordflow">return</span>;
00256     }
00257 
00258     <span class="comment">//</span>
00259     <span class="comment">// Place the page on the modified or standby list depending</span>
00260     <span class="comment">// on the state of the modify bit in the PFN element.</span>
00261     <span class="comment">//</span>
00262 
00263     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1) {
00264         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[ModifiedPageList], PageFrameIndex);
00265     } <span class="keywordflow">else</span> {
00266 
00267         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 1) {
00268 
00269             <span class="comment">//</span>
00270             <span class="comment">// The page may still be marked as on the modified list if the</span>
00271             <span class="comment">// current thread is the modified writer completing the write.</span>
00272             <span class="comment">// Mark it as standby so restoration of the transition PTE</span>
00273             <span class="comment">// doesn't flag this as illegal.</span>
00274             <span class="comment">//</span>
00275 
00276             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
00277 
00278             <a class="code" href="../../d0/d2/mmsup_8c.html#a15">MiRestoreTransitionPte</a> (PageFrameIndex);
00279             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[BadPageList],
00280                                 PageFrameIndex);
00281             <span class="keywordflow">return</span>;
00282         }
00283 
00284         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d5/mapcache_8c.html#a1">MmFrontOfList</a>) {
00285             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[StandbyPageList],
00286                                 PageFrameIndex);
00287         } <span class="keywordflow">else</span> {
00288             <a class="code" href="../../d7/d5/pfnlist_8c.html#a9">MiInsertStandbyListAtFront</a> (PageFrameIndex);
00289         }
00290     }
00291 
00292     <span class="keywordflow">return</span>;
00293 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="pfndec.c::MiDecrementShareCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL MiDecrementShareCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFN_NUMBER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PageFrameIndex</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">30</a> of file <a class="el" href="../../d7/d4/pfndec_8c-source.html">pfndec.c</a>.
<p>
References <a class="el" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00535">MI_MAKE_VALID_PTE_TRANSITION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00767">MiGetByteOffset</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02161">PERFINFO_DECREFCNT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a178">TransitionPage</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, and <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d4/d9/wrtfault_8c-source.html#l00025">MiCopyOnWrite()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l01161">MiDecommitPages()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l01745">MiDecrementCloneBlockReference()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05142">MiDeleteValidAddress()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03974">MiEliminateWorkingSetEntry()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02944">MiEnablePagingOfDriverAtInit()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l02204">MiHandleForkTransitionPte()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00541">MiPurgeImageSection()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00579">MiRemoveMappedPtes()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01245">MiRestoreTransitionPte()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00191">MiSegmentDelete()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l04446">MiSessionCopyOnWrite()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02309">MiSetPagingOfDriver()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03742">MmFreeSpecialPool()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l03180">MmOutPageKernelStack()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l03590">MmOutSwapProcess()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01548">MmPurgeSection()</a>, and <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00381">MmUnmapViewInSystemCache()</a>.
<p>
<pre class="fragment"><div>00036                    :
00037 
00038     This routine decrements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> share count within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN element
00039     <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical page.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> share count becomes
00040     zero <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding PTE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> converted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transition state
00041     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> decremented and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ValidPte count
00042     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTEframe <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> decremented.
00043 
00044 Arguments:
00045 
00046     PageFrameIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical page number of which to decrement
00047                      <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> share count.
00048 
00049 Return Value:
00050 
00051     None.
00052 
00053 Environment:
00054 
00055     Must be holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database mutex with APCs disabled.
00056 
00057 --*/
00058 
00059 {
00060     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00061     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00062     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00063     KIRQL OldIrql;
00064 
00065     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PageFrameIndex &lt;= MmHighestPhysicalPage) &amp;&amp;
00066             (PageFrameIndex &gt; 0));
00067 
00068     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00069 
00070     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a> &amp;&amp;
00071         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
00072             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT,
00073                       0x99,
00074                       PageFrameIndex,
00075                       Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation,
00076                       0);
00077     }
00078 
00079 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00080 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage == 1) {
00081 
00082         <span class="comment">// Need to run the page and see if the number of transition &amp; valid</span>
00083         <span class="comment">// pages + 1 matches up to the share count.</span>
00084         <span class="comment">//</span>
00085         <span class="comment">// For the page being freed (share == 1), need to snap the caller here</span>
00086 
00087     }
00088 <span class="preprocessor">#endif</span>
00089 <span class="preprocessor"></span>
00090     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount -= 1;
00091 
00092     <a class="code" href="../../d2/d1/mm_8h.html#a40">PERFINFO_DECREFCNT</a>(Pfn1, PERFINFO_LOG_WSCHANGE, PERFINFO_LOG_TYPE_DECSHARCNT)
00093 
00094     ASSERT (Pfn1-&gt;u2.ShareCount &lt; 0xF000000);
00095 
00096     if (Pfn1-&gt;u2.ShareCount == 0) {
00097 
00098         <a class="code" href="../../d2/d1/mm_8h.html#a40">PERFINFO_DECREFCNT</a>(Pfn1, PERFINFO_LOG_EMPTYQ, PERFINFO_LOG_TYPE_ZEROSHARECOUNT)
00099 
00100         <span class="comment">//</span>
00101         <span class="comment">// The share count is now zero, decrement the reference count</span>
00102         <span class="comment">// for the PFN element and turn the referenced PTE into</span>
00103         <span class="comment">// the transition state if it refers to a prototype PTE.</span>
00104         <span class="comment">// PTEs which are not prototype PTEs do not need to be placed</span>
00105         <span class="comment">// into transition as they are placed in transition when</span>
00106         <span class="comment">// they are removed from the working set (working set free routine).</span>
00107         <span class="comment">//</span>
00108 
00109         <span class="comment">//</span>
00110         <span class="comment">// If the PTE referenced by this PFN element is actually</span>
00111         <span class="comment">// a prototype PTE, it must be mapped into hyperspace and</span>
00112         <span class="comment">// then operated on.</span>
00113         <span class="comment">//</span>
00114 
00115         if (Pfn1-&gt;u3.e1.PrototypePte == 1) {
00116 
00117             OldIrql = 99;
00118             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>)) {
00119                 PointerPte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
00120             } <span class="keywordflow">else</span> {
00121 
00122                 <span class="comment">//</span>
00123                 <span class="comment">// The address is not valid in this process, map it into</span>
00124                 <span class="comment">// hyperspace so it can be operated upon.</span>
00125                 <span class="comment">//</span>
00126 
00127                 PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>,
00128                                                            &amp;OldIrql);
00129                 PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)PointerPte +
00130                                         <a class="code" href="../../d4/d8/mi_8h.html#a110">MiGetByteOffset</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>));
00131             }
00132 
00133             TempPte = *PointerPte;
00134             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
00135                                           Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
00136             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
00137 
00138             <span class="keywordflow">if</span> (OldIrql != 99) {
00139                 <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
00140             }
00141 
00142             <span class="comment">//</span>
00143             <span class="comment">// There is no need to flush the translation buffer at this</span>
00144             <span class="comment">// time as we only invalidated a prototype PTE.</span>
00145             <span class="comment">//</span>
00146 
00147         }
00148 
00149         <span class="comment">//</span>
00150         <span class="comment">// Change the page location to inactive (from active and valid).</span>
00151         <span class="comment">//</span>
00152 
00153         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a178">TransitionPage</a>;
00154 
00155         <span class="comment">//</span>
00156         <span class="comment">// Decrement the reference count as the share count is now zero.</span>
00157         <span class="comment">//</span>
00158 
00159         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
00160     }
00161 
00162     <span class="keywordflow">return</span>;
00163 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="pfndec.c::MmFrontOfList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d5/pfndec_8c.html#a0">MmFrontOfList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00025">25</a> of file <a class="el" href="../../d7/d4/pfndec_8c-source.html">pfndec.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, and <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00381">MmUnmapViewInSystemCache()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
