<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: foncache.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>foncache.c</h1><a href="../../d5/d6/server_2foncache_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    foncache.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">        This file is EUDC font cache</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Kazuhiko  Matsubara  21-June-1994</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">Notes:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00024 <span class="preprocessor">#pragma hdrstop</span>
00025 <span class="preprocessor"></span>
00026 <span class="preprocessor">#if defined(FE_SB)</span>
00027 <span class="preprocessor"></span>
00028 
00029 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00030 RebaseFontImageList(
00031     IN <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a> NewFontImage,
00032     IN PBYTE OldFontImage
00033     )
00034 {
00035     PLIST_ENTRY ImageList;
00036     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> BaseImage = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)NewFontImage;
00037 
00038     <span class="keywordflow">do</span> {
00039         ImageList = &amp;NewFontImage-&gt;ImageList;
00040         <span class="keywordflow">if</span> (ImageList-&gt;Blink)
00041             ImageList-&gt;Blink = (PLIST_ENTRY)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ImageList-&gt;Blink - OldFontImage + BaseImage);
00042         <span class="keywordflow">if</span> (ImageList-&gt;Flink)
00043             ImageList-&gt;Flink = (PLIST_ENTRY)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ImageList-&gt;Flink - OldFontImage + BaseImage);
00044     } <span class="keywordflow">while</span> (NewFontImage = (<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>)ImageList-&gt;Flink);
00045 }
00046 
00047 
00048 
00049 
00050 
00051 ULONG
00052 <a class="code" href="../../d6/d6/foncache_8h.html#a23">CreateFontCache</a>(
00053     OUT <a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a> *FontCache
00054     )
00055 {
00056     <span class="comment">//</span>
00057     <span class="comment">// allocate font cache data</span>
00058     <span class="comment">//</span>
00059 
00060     *FontCache = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(HEAP_ZERO_MEMORY,<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">FONT_CACHE_INFORMATION</a>));
00061     <span class="keywordflow">if</span> (*FontCache == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00062         <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
00063     }
00064 
00065     <span class="keywordflow">return</span> (ULONG)(STATUS_SUCCESS);
00066 }
00067 
00068 
00069 ULONG
00070 <a class="code" href="../../d6/d6/foncache_8h.html#a24">DestroyFontCache</a>(
00071     IN <a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a> FontCache
00072     )
00073 {
00074     <span class="keywordflow">if</span> (FontCache != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00075     {
00076         <a class="code" href="../../d3/d9/struct__FONT__HIGHLOW__OFFSET.html">PFONT_HIGHLOW_OFFSET</a> FontOffsetHighLow;
00077         <a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html">PFONT_LOW_OFFSET</a>     FontOffsetLow;
00078         <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>          FontImage;
00079         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i, j, k;
00080 
00081         <span class="keywordflow">for</span> (i=0;
00082              i &lt; <span class="keyword">sizeof</span>(FontCache-&gt;FontTable.FontOffsetHighHigh)/<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/struct__FONT__HIGHLOW__OFFSET.html">PFONT_HIGHLOW_OFFSET</a>);
00083              i++)
00084         {
00085             <span class="keywordflow">if</span> (FontOffsetHighLow = FontCache-&gt;FontTable.FontOffsetHighHigh[i])
00086             {
00087                 <span class="keywordflow">for</span> (j=0;
00088                      j &lt; <span class="keyword">sizeof</span>(FontOffsetHighLow-&gt;<a class="code" href="../../d3/d9/struct__FONT__HIGHLOW__OFFSET.html#o0">FontOffsetHighLow</a>)/<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html">PFONT_LOW_OFFSET</a>);
00089                      j++)
00090                 {
00091                     <span class="keywordflow">if</span> (FontOffsetLow = FontOffsetHighLow-&gt;<a class="code" href="../../d3/d9/struct__FONT__HIGHLOW__OFFSET.html#o0">FontOffsetHighLow</a>[j])
00092                     {
00093                         <span class="keywordflow">for</span> (k=0;
00094                              k &lt; <span class="keyword">sizeof</span>(FontOffsetLow-&gt;<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html#o0">FontOffsetLow</a>)/<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>);
00095                              k++)
00096                         {
00097                             <span class="keywordflow">if</span> (FontImage = FontOffsetLow-&gt;<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html#o0">FontOffsetLow</a>[k])
00098                             {
00099                                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontImage);
00100                             }
00101                         }
00102                         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontOffsetLow);
00103                     }
00104                 }
00105                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontOffsetHighLow);
00106             }
00107         }
00108         <span class="keywordflow">if</span> (FontCache-&gt;BaseImageBits) {
00109             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontCache-&gt;BaseImageBits);
00110         }
00111         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontCache);
00112     }
00113     <span class="keywordflow">return</span> (ULONG)(STATUS_SUCCESS);
00114 }
00115 
00116 ULONG
00117 RebaseFontCache(
00118     IN <a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a> FontCache,
00119     IN PBYTE OldBaseImage
00120     )
00121 {
00122     <span class="keywordflow">if</span> (FontCache != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00123     {
00124         <a class="code" href="../../d3/d9/struct__FONT__HIGHLOW__OFFSET.html">PFONT_HIGHLOW_OFFSET</a> FontOffsetHighLow;
00125         <a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html">PFONT_LOW_OFFSET</a>     FontOffsetLow;
00126         <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>          FontImage;
00127         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i, j, k;
00128 
00129         <span class="keywordflow">for</span> (i=0;
00130              i &lt; <span class="keyword">sizeof</span>(FontCache-&gt;FontTable.FontOffsetHighHigh)/<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/struct__FONT__HIGHLOW__OFFSET.html">PFONT_HIGHLOW_OFFSET</a>);
00131              i++)
00132         {
00133             <span class="keywordflow">if</span> (FontOffsetHighLow = FontCache-&gt;FontTable.FontOffsetHighHigh[i])
00134             {
00135                 <span class="keywordflow">for</span> (j=0;
00136                      j &lt; <span class="keyword">sizeof</span>(FontOffsetHighLow-&gt;<a class="code" href="../../d3/d9/struct__FONT__HIGHLOW__OFFSET.html#o0">FontOffsetHighLow</a>)/<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html">PFONT_LOW_OFFSET</a>);
00137                      j++)
00138                 {
00139                     <span class="keywordflow">if</span> (FontOffsetLow = FontOffsetHighLow-&gt;<a class="code" href="../../d3/d9/struct__FONT__HIGHLOW__OFFSET.html#o0">FontOffsetHighLow</a>[j])
00140                     {
00141                         <span class="keywordflow">for</span> (k=0;
00142                              k &lt; <span class="keyword">sizeof</span>(FontOffsetLow-&gt;<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html#o0">FontOffsetLow</a>)/<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>);
00143                              k++)
00144                         {
00145                             <span class="keywordflow">if</span> (FontImage = FontOffsetLow-&gt;<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html#o0">FontOffsetLow</a>[k])
00146                             {
00147                                 LIST_ENTRY ImageList;
00148 
00149                                 <span class="keywordflow">do</span> {
00150                                     ImageList = FontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o0">ImageList</a>;
00151                                     <span class="keywordflow">if</span> (FontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o2">ImageBits</a>) {
00152                                         FontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o2">ImageBits</a> = FontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o2">ImageBits</a> - OldBaseImage
00153                                                                + FontCache-&gt;BaseImageBits;
00154                                     }
00155                                 } <span class="keywordflow">while</span> (FontImage = (<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>)ImageList.Flink);
00156                             }
00157                         }
00158                     }
00159                 }
00160             }
00161         }
00162     }
00163     <span class="keywordflow">return</span> (ULONG)(STATUS_SUCCESS);
00164 }
00165 
00166 
00167 
00168 <span class="preprocessor">#define CALC_BITMAP_BITS_FOR_X( FontSizeX, dwAlign ) \</span>
00169 <span class="preprocessor">    ( ( ( FontSizeX * BITMAP_BITS_PIXEL + (dwAlign-1) ) &amp; ~(dwAlign-1)) &gt;&gt; BITMAP_ARRAY_BYTE )</span>
00170 <span class="preprocessor"></span>
00171 
00172 
00173 
00174 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
00175 <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(
00176     IN COORD FontSize,
00177     IN DWORD dwAlign
00178     )
00179 {
00180     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> uiCount;
00181 
00182     uiCount = <a class="code" href="../../d4/d6/fullscr_2vga_2foncache_8c.html#a2">CALC_BITMAP_BITS_FOR_X</a>(FontSize.X,
00183                                      (dwAlign==BYTE_ALIGN ? BITMAP_BITS_BYTE_ALIGN : BITMAP_BITS_WORD_ALIGN));
00184     uiCount = uiCount * <a class="code" href="../../d6/d6/foncache_8h.html#a7">BITMAP_PLANES</a> * FontSize.Y;
00185     <span class="keywordflow">return</span> uiCount;
00186 }
00187 
00188 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00189 <a class="code" href="../../d7/d8/fsvga_8h.html#a56">AlignCopyMemory</a>(
00190     OUT PBYTE pDestBits,
00191     IN DWORD dwDestAlign,
00192     IN PBYTE pSrcBits,
00193     IN DWORD dwSrcAlign,
00194     IN COORD FontSize
00195     )
00196 {
00197     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDestBufferSize;
00198     COORD coord;
00199 
00200     <span class="keywordflow">if</span> (dwDestAlign == dwSrcAlign) {
00201         dwDestBufferSize = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FontSize, dwDestAlign);
00202         RtlCopyMemory(pDestBits, pSrcBits, dwDestBufferSize);
00203         <span class="keywordflow">return</span>;
00204     }
00205 
00206     <span class="keywordflow">switch</span> (dwDestAlign) {
00207         <span class="keywordflow">default</span>:
00208         <span class="keywordflow">case</span> <a class="code" href="../../d6/d6/foncache_8h.html#a10">WORD_ALIGN</a>:
00209             <span class="keywordflow">switch</span> (dwSrcAlign) {
00210                 <span class="keywordflow">default</span>:
00211                 <span class="comment">//</span>
00212                 <span class="comment">// pDest = WORD, pSrc = WORD</span>
00213                 <span class="comment">//</span>
00214                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d6/foncache_8h.html#a10">WORD_ALIGN</a>:
00215                     dwDestBufferSize = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FontSize, dwDestAlign);
00216                     RtlCopyMemory(pDestBits, pSrcBits, dwDestBufferSize);
00217                     <span class="keywordflow">break</span>;
00218                 <span class="comment">//</span>
00219                 <span class="comment">// pDest = WORD, pSrc = BYTE</span>
00220                 <span class="comment">//</span>
00221                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d6/foncache_8h.html#a9">BYTE_ALIGN</a>:
00222                     dwDestBufferSize = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FontSize, dwDestAlign);
00223                     <span class="keywordflow">if</span> (((FontSize.X % <a class="code" href="../../d6/d6/foncache_8h.html#a4">BITMAP_BITS_BYTE_ALIGN</a>) == 0) &amp;&amp;
00224                         ((FontSize.X % <a class="code" href="../../d6/d6/foncache_8h.html#a5">BITMAP_BITS_WORD_ALIGN</a>) == 0)   ) {
00225                         RtlCopyMemory(pDestBits, pSrcBits, dwDestBufferSize);
00226                     }
00227                     <span class="keywordflow">else</span> {
00228                         RtlZeroMemory(pDestBits, dwDestBufferSize);
00229                         <span class="keywordflow">for</span> (coord.Y=0; coord.Y &lt; FontSize.Y; coord.Y++) {
00230                             <span class="keywordflow">for</span> (coord.X=0;
00231                                  coord.X &lt; <a class="code" href="../../d4/d6/fullscr_2vga_2foncache_8c.html#a2">CALC_BITMAP_BITS_FOR_X</a>(FontSize.X, BITMAP_BITS_BYTE_ALIGN);
00232                                  coord.X++) {
00233                                 *pDestBits++ = *pSrcBits++;
00234                             }
00235                             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/fullscr_2vga_2foncache_8c.html#a2">CALC_BITMAP_BITS_FOR_X</a>(FontSize.X, BITMAP_BITS_BYTE_ALIGN) &amp; 1)
00236                                 pDestBits++;
00237                         }
00238                     }
00239                     <span class="keywordflow">break</span>;
00240             }
00241             <span class="keywordflow">break</span>;
00242         <span class="keywordflow">case</span> <a class="code" href="../../d6/d6/foncache_8h.html#a9">BYTE_ALIGN</a>:
00243             <span class="keywordflow">switch</span> (dwSrcAlign) {
00244                 <span class="comment">//</span>
00245                 <span class="comment">// pDest = BYTE, pSrc = BYTE</span>
00246                 <span class="comment">//</span>
00247                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d6/foncache_8h.html#a9">BYTE_ALIGN</a>:
00248                     dwDestBufferSize = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FontSize, dwDestAlign);
00249                     RtlCopyMemory(pDestBits, pSrcBits, dwDestBufferSize);
00250                     <span class="keywordflow">break</span>;
00251                 <span class="keywordflow">default</span>:
00252                 <span class="comment">//</span>
00253                 <span class="comment">// pDest = BYTE, pSrc = WORD</span>
00254                 <span class="comment">//</span>
00255                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d6/foncache_8h.html#a10">WORD_ALIGN</a>:
00256                     dwDestBufferSize = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FontSize, dwDestAlign);
00257                     <span class="keywordflow">if</span> (((FontSize.X % <a class="code" href="../../d6/d6/foncache_8h.html#a4">BITMAP_BITS_BYTE_ALIGN</a>) == 0) &amp;&amp;
00258                         ((FontSize.X % <a class="code" href="../../d6/d6/foncache_8h.html#a5">BITMAP_BITS_WORD_ALIGN</a>) == 0)   ) {
00259                         RtlCopyMemory(pDestBits, pSrcBits, dwDestBufferSize);
00260                     }
00261                     <span class="keywordflow">else</span> {
00262                         RtlZeroMemory(pDestBits, dwDestBufferSize);
00263                         <span class="keywordflow">for</span> (coord.Y=0; coord.Y &lt; FontSize.Y; coord.Y++) {
00264                             <span class="keywordflow">for</span> (coord.X=0;
00265                                  coord.X &lt; <a class="code" href="../../d4/d6/fullscr_2vga_2foncache_8c.html#a2">CALC_BITMAP_BITS_FOR_X</a>(FontSize.X, BITMAP_BITS_BYTE_ALIGN);
00266                                  coord.X++) {
00267                                 *pDestBits++ = *pSrcBits++;
00268                             }
00269                             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/fullscr_2vga_2foncache_8c.html#a2">CALC_BITMAP_BITS_FOR_X</a>(FontSize.X, BITMAP_BITS_BYTE_ALIGN) &amp; 1)
00270                                 pSrcBits++;
00271                         }
00272                     }
00273                     <span class="keywordflow">break</span>;
00274             }
00275             <span class="keywordflow">break</span>;
00276     }
00277 }
00278 
00279 
00280 
00281 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00282 GetStretchImage(
00283     IN COORD FontSize,
00284     IN <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a> FontImage,
00285     OUT <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a> *pFontImage
00286     )
00287 {
00288     <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a> NearFont;
00289     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Find;
00290     COORD FontDelta;
00291     HDC hDC;
00292     HDC hSrcMemDC, hDestMemDC;
00293     HBITMAP hSrcBmp, hDestBmp;
00294     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00295 
00296     Find = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
00297     NearFont = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00298     <span class="keywordflow">do</span> {
00299         FontDelta.X = <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(FontSize.X - FontImage-&gt;FontSize.X);
00300         FontDelta.Y = <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(FontSize.Y - FontImage-&gt;FontSize.Y);
00301         <span class="keywordflow">if</span> (Find &gt; (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(FontDelta.X + FontDelta.Y))
00302         {
00303             Find = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(FontDelta.X + FontDelta.Y);
00304             NearFont = FontImage;
00305         }
00306     }
00307     <span class="keywordflow">while</span> (FontImage = (<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>)FontImage-&gt;ImageList.Flink);
00308 
00309     <span class="keywordflow">if</span> (NearFont == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00310         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00311 
00312     hDC = CreateDC(TEXT(<span class="stringliteral">"DISPLAY"</span>),NULL,NULL,NULL);
00313 
00314     hSrcMemDC  = CreateCompatibleDC(hDC);
00315     hDestMemDC = CreateCompatibleDC(hDC);
00316 
00317     hSrcBmp  = CreateBitmap(NearFont-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o1">FontSize</a>.X,
00318                             NearFont-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o1">FontSize</a>.Y,
00319                             BITMAP_PLANES, BITMAP_BITS_PIXEL,
00320                             NearFont-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o2">ImageBits</a>);
00321     hDestBmp = CreateBitmap(FontSize.X,
00322                             FontSize.Y,
00323                             BITMAP_PLANES, BITMAP_BITS_PIXEL,
00324                             NULL);
00325 
00326     SelectObject(hSrcMemDC,  hSrcBmp);
00327     SelectObject(hDestMemDC, hDestBmp);
00328 
00329     <span class="keywordflow">if</span> (! StretchBlt(hDestMemDC, 0, 0, FontSize.X, FontSize.Y,
00330                      hSrcMemDC,  0, 0, NearFont-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o1">FontSize</a>.X, NearFont-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o1">FontSize</a>.Y,
00331                      SRCCOPY)) {
00332         <span class="keywordflow">return</span> GetLastError();
00333     }
00334 
00335     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FontSize, WORD_ALIGN);
00336     GetBitmapBits(hDestBmp, BufferSize, (*pFontImage)-&gt;ImageBits);
00337 
00338     DeleteDC(hSrcMemDC);
00339     DeleteDC(hDestMemDC);
00340     DeleteObject(hSrcBmp);
00341     DeleteObject(hDestBmp);
00342     DeleteDC(hDC);
00343 
00344     <span class="keywordflow">return</span> STATUS_SUCCESS;
00345 }
00346 
00347 
00348 
00349 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00350 GetFontImageInternal(
00351     IN <a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a> FontCache,
00352     IN WCHAR wChar,
00353     IN COORD FontSize,
00354     OUT <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a> *pFontImage,
00355     IN DWORD GetFlag
00356     )
00357 {
00358     <a class="code" href="../../d3/d9/struct__FONT__HIGHLOW__OFFSET.html">PFONT_HIGHLOW_OFFSET</a> FontOffsetHighLow;
00359     <a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html">PFONT_LOW_OFFSET</a>     FontOffsetLow;
00360     <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>          FontImage;
00361     WORD  HighHighIndex, HighLowIndex;
00362     WORD  LowIndex;
00363     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Flag;
00364 
00365     HighHighIndex = (<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(wChar)) &gt;&gt; 4;
00366     HighLowIndex  = (<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(wChar)) &amp; 0x0f;
00367     LowIndex      = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(wChar);
00368 
00369     FontOffsetHighLow = FontCache-&gt;FontTable.FontOffsetHighHigh[HighHighIndex];
00370     <span class="keywordflow">if</span> (FontOffsetHighLow == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00371         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00372 
00373     FontOffsetLow = FontOffsetHighLow-&gt;<a class="code" href="../../d3/d9/struct__FONT__HIGHLOW__OFFSET.html#o0">FontOffsetHighLow</a>[HighLowIndex];
00374     <span class="keywordflow">if</span> (FontOffsetLow == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00375         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00376 
00377     FontImage = FontOffsetLow-&gt;<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html#o0">FontOffsetLow</a>[LowIndex];
00378     <span class="keywordflow">if</span> (FontImage == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00379         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00380 
00381 
00382     Flag = <a class="code" href="../../d4/d6/fullscr_2vga_2foncache_8c.html#a0">ADD_IMAGE</a>;
00383     <span class="keywordflow">do</span> {
00384         <span class="keywordflow">if</span> (FontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o1">FontSize</a>.X == FontSize.X &amp;&amp;
00385             FontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o1">FontSize</a>.Y == FontSize.Y   ) {
00386             <span class="comment">//</span>
00387             <span class="comment">// Replace font image</span>
00388             <span class="comment">//</span>
00389             Flag = <a class="code" href="../../d4/d6/fullscr_2vga_2foncache_8c.html#a1">REPLACE_IMAGE</a>;
00390             <span class="keywordflow">break</span>;
00391         }
00392     }
00393     <span class="keywordflow">while</span> (FontImage = (<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>)FontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o0">ImageList</a>.Flink);
00394 
00395     <span class="keywordflow">switch</span> (GetFlag)
00396     {
00397         <span class="comment">//</span>
00398         <span class="comment">// Get matched size font.</span>
00399         <span class="comment">//</span>
00400         <span class="keywordflow">case</span> <a class="code" href="../../d6/d6/foncache_8h.html#a0">FONT_MATCHED</a>:
00401             <span class="keywordflow">if</span> (Flag != <a class="code" href="../../d4/d6/fullscr_2vga_2foncache_8c.html#a1">REPLACE_IMAGE</a>)
00402                 <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00403 
00404             *pFontImage = FontImage;
00405             <span class="keywordflow">break</span>;
00406 
00407         <span class="comment">//</span>
00408         <span class="comment">// Get stretched size font.</span>
00409         <span class="comment">//</span>
00410         <span class="keywordflow">case</span> <a class="code" href="../../d6/d6/foncache_8h.html#a1">FONT_STRETCHED</a>:
00411             <span class="keywordflow">if</span> (Flag == <a class="code" href="../../d4/d6/fullscr_2vga_2foncache_8c.html#a1">REPLACE_IMAGE</a> &amp;&amp;
00412                 FontImage-&gt;ImageBits != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00413 
00414                 *pFontImage = FontImage;
00415 
00416             }
00417             <span class="keywordflow">else</span> {
00418                 GetStretchImage(FontSize,
00419                                 FontOffsetLow-&gt;<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html#o0">FontOffsetLow</a>[LowIndex],
00420                                 pFontImage
00421                                );
00422             }
00423             <span class="keywordflow">break</span>;
00424     }
00425 
00426     <span class="keywordflow">return</span> STATUS_SUCCESS;
00427 }
00428 
00429 <span class="comment">//</span>
00430 <span class="comment">// See Raid #362907, stress failure</span>
00431 <span class="comment">//</span>
00432 
00433 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> UnlinkAndShrinkFontImagesByOne(
00434     <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>* ppFontImage,
00435     <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a> pFontImageRemove)
00436 {
00437     <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a> OldFontImage = *ppFontImage;
00438     SIZE_T OldFontSize = <a class="code" href="../../d8/d5/consrv_8h.html#a39">ConsoleHeapSize</a>(OldFontImage);
00439     <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a> NewFontImage;
00440 
00441     RIPMSG0(RIP_WARNING, <span class="stringliteral">"UnlinkAndShrinkFontImagesByOne entered."</span>);
00442 
00443     <span class="keywordflow">if</span> (OldFontImage== <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00444         RIPMSG0(RIP_ERROR, <span class="stringliteral">"UnlinkAndShrinkFontImagesByOne: *ppFontImage is NULL."</span>);
00445         <span class="comment">//</span>
00446         <span class="comment">// There's nothing to shrink.</span>
00447         <span class="comment">//</span>
00448         <span class="keywordflow">return</span>;
00449     }
00450 
00451     <span class="keywordflow">if</span> (OldFontImage == pFontImageRemove) {
00452         RIPMSG0(RIP_WARNING, <span class="stringliteral">"UnlinkAndShrinkFontImagesByOne: unshrinking just one element."</span>);
00453         <span class="comment">//</span>
00454         <span class="comment">// There's just one entry. Let's free it and set</span>
00455         <span class="comment">// ppFontImage as NULL, and bail out.</span>
00456         <span class="comment">//</span>
00457         UserAssert(OldFontSize &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">FONT_IMAGE</a>) * 2);
00458 
00459         *ppFontImage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00460         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(OldFontImage);
00461         <span class="keywordflow">return</span>;
00462     }
00463 
00464 <span class="preprocessor">#if DBG</span>
00465 <span class="preprocessor"></span>    <span class="comment">//</span>
00466     <span class="comment">// Double check the integrity of the linked list.</span>
00467     <span class="comment">//</span>
00468     {
00469         <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a> FontImageTmp;
00470 
00471         <span class="comment">//</span>
00472         <span class="comment">// Search the tail element</span>
00473         <span class="comment">//</span>
00474         <span class="keywordflow">for</span> (FontImageTmp = OldFontImage; FontImageTmp-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o0">ImageList</a>.Flink; FontImageTmp = (<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>)FontImageTmp-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o0">ImageList</a>.Flink)
00475             ;
00476 
00477         UserAssert(FontImageTmp == pFontImageRemove);
00478     }
00479 <span class="preprocessor">#endif</span>
00480 <span class="preprocessor"></span>
00481     <span class="comment">//</span>
00482     <span class="comment">// Remove the tail element</span>
00483     <span class="comment">//</span>
00484     pFontImageRemove-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o0">ImageList</a>.Blink-&gt;Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00485 
00486     <span class="comment">//</span>
00487     <span class="comment">// Shrink the contiguous memory chunk</span>
00488     <span class="comment">//</span>
00489     <span class="comment">// Note: this code assumes sizeof(FONT_IMAGE) is larger than</span>
00490     <span class="comment">// HEAP_GRANULARITY. If not, the heap block actually does not</span>
00491     <span class="comment">// shrink, and the assert below will hit.</span>
00492     <span class="comment">//</span>
00493     NewFontImage = <a class="code" href="../../d8/d5/consrv_8h.html#a37">ConsoleHeapReAlloc</a>(HEAP_ZERO_MEMORY,
00494                                OldFontImage,
00495                                OldFontSize - <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">FONT_IMAGE</a>));
00496     <span class="keywordflow">if</span> (NewFontImage == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00497         <span class="comment">//</span>
00498         <span class="comment">// Win32HeapRealloc firstly allocates a new memory and then</span>
00499         <span class="comment">// copies the content. If the allocation fails, it leaves the</span>
00500         <span class="comment">// original heap as is.</span>
00501         <span class="comment">//</span>
00502         <span class="comment">// Even though the realloc fails, the last element (pFontImageRemove) is</span>
00503         <span class="comment">// already removed from the linked list. The next time SetImageFontInternal</span>
00504         <span class="comment">// is called, a new FontImage might be added to this memory chunk, but the</span>
00505         <span class="comment">// the code always links the newly extended memory.</span>
00506         <span class="comment">// This leaves the sizeof(FONT_IMAGE) memory unused, but it's safe. Assuming</span>
00507         <span class="comment">// sizeof(FONT_IMAGE) is small, memory waste should be minimum.</span>
00508         <span class="comment">//</span>
00509         <span class="comment">// It's OK for us to just bail out here.</span>
00510         <span class="comment">//</span>
00511         RIPMSG0(RIP_WARNING, <span class="stringliteral">"UnlinkAndShrinkFontImagesByOne: failed to shrink ppFontImage."</span>);
00512         <span class="keywordflow">return</span>;
00513     }
00514     UserAssert(<a class="code" href="../../d8/d5/consrv_8h.html#a39">ConsoleHeapSize</a>(NewFontImage) != OldFontSize);
00515 
00516     <span class="keywordflow">if</span> (NewFontImage != OldFontImage) {
00517         <span class="comment">//</span>
00518         <span class="comment">// Rebase Font Image Linked List</span>
00519         <span class="comment">//</span>
00520         RebaseFontImageList(NewFontImage, (PBYTE)OldFontImage);
00521         *ppFontImage = NewFontImage;
00522     }
00523 }
00524 
00525 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00526 SetFontImageInternal(
00527     IN <a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a> FontCache,
00528     IN WCHAR wChar,
00529     IN COORD FontSize,
00530     IN DWORD dwAlign,
00531     IN CONST VOID *ImageBits
00532     )
00533 {
00534     <a class="code" href="../../d3/d9/struct__FONT__HIGHLOW__OFFSET.html">PFONT_HIGHLOW_OFFSET</a> FontOffsetHighLow;
00535     <a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html">PFONT_LOW_OFFSET</a>     FontOffsetLow;
00536     <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>          FontImage;
00537     <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>          FontImageTmp;
00538     WORD  HighHighIndex, HighLowIndex;
00539     WORD  LowIndex;
00540     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Flag;
00541     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00542 
00543     HighHighIndex = (<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(wChar)) &gt;&gt; 4;
00544     HighLowIndex  = (<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(wChar)) &amp; 0x0f;
00545     LowIndex      = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(wChar);
00546 
00547     <span class="comment">/*</span>
00548 <span class="comment">     * When Console is being destroyed, all font cache information</span>
00549 <span class="comment">     * will be freed (see DestroyFontCache), so no memory leak</span>
00550 <span class="comment">     * is expected on those, even if we cleanup everything on</span>
00551 <span class="comment">     * error return...</span>
00552 <span class="comment">     */</span>
00553 
00554     FontOffsetHighLow = FontCache-&gt;FontTable.FontOffsetHighHigh[HighHighIndex];
00555     <span class="keywordflow">if</span> (FontOffsetHighLow == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00556         FontOffsetHighLow = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( HEAP_ZERO_MEMORY, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/struct__FONT__HIGHLOW__OFFSET.html">FONT_HIGHLOW_OFFSET</a>));
00557         <span class="keywordflow">if</span> (FontOffsetHighLow == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00558             RIPMSG1(RIP_WARNING, <span class="stringliteral">"SetFontImageInternal: cannot allocate memory (%d bytes)"</span>,
00559                       <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/struct__FONT__HIGHLOW__OFFSET.html">FONT_HIGHLOW_OFFSET</a>));
00560             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00561         }
00562 
00563         FontCache-&gt;FontTable.FontOffsetHighHigh[HighHighIndex] = FontOffsetHighLow;
00564     }
00565 
00566     FontOffsetLow = FontOffsetHighLow-&gt;<a class="code" href="../../d3/d9/struct__FONT__HIGHLOW__OFFSET.html#o0">FontOffsetHighLow</a>[HighLowIndex];
00567     <span class="keywordflow">if</span> (FontOffsetLow == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00568         FontOffsetLow = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( HEAP_ZERO_MEMORY, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html">FONT_LOW_OFFSET</a>));
00569         <span class="keywordflow">if</span> (FontOffsetLow == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00570             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetFontImageInternal: failed to allocate FontOffsetLow."</span>);
00571             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00572         }
00573 
00574         FontOffsetHighLow-&gt;<a class="code" href="../../d3/d9/struct__FONT__HIGHLOW__OFFSET.html#o0">FontOffsetHighLow</a>[HighLowIndex] = FontOffsetLow;
00575     }
00576 
00577     FontImage = FontOffsetLow-&gt;<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html#o0">FontOffsetLow</a>[LowIndex];
00578     <span class="keywordflow">if</span> (FontImage == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00579         FontImage = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( HEAP_ZERO_MEMORY, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">FONT_IMAGE</a>));
00580         <span class="keywordflow">if</span> (FontImage == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00581             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetFontImageInternal: failed to allocate FontImage"</span>);
00582             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00583         }
00584     }
00585 
00586     <span class="keywordflow">if</span> (FontSize.X == 0 &amp;&amp;
00587         FontSize.Y == 0   ) {
00588         <span class="comment">//</span>
00589         <span class="comment">// Reset registered font</span>
00590         <span class="comment">//</span>
00591         <span class="keywordflow">if</span> (FontImage != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00592         {
00593             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontImage);
00594             FontOffsetLow-&gt;<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html#o0">FontOffsetLow</a>[LowIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00595         }
00596         <span class="keywordflow">return</span> STATUS_SUCCESS;
00597     }
00598 
00599     Flag = <a class="code" href="../../d4/d6/fullscr_2vga_2foncache_8c.html#a0">ADD_IMAGE</a>;
00600     FontImageTmp = FontImage;
00601     <span class="keywordflow">do</span> {
00602         <span class="keywordflow">if</span> (FontImageTmp-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o1">FontSize</a>.X == FontSize.X &amp;&amp;
00603             FontImageTmp-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o1">FontSize</a>.Y == FontSize.Y   ) {
00604             <span class="comment">//</span>
00605             <span class="comment">// Replace font image</span>
00606             <span class="comment">//</span>
00607             Flag = <a class="code" href="../../d4/d6/fullscr_2vga_2foncache_8c.html#a1">REPLACE_IMAGE</a>;
00608             FontImage = FontImageTmp;
00609             <span class="keywordflow">break</span>;
00610         }
00611     }
00612     <span class="keywordflow">while</span> (FontImageTmp = (<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>)FontImageTmp-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o0">ImageList</a>.Flink);
00613 
00614     <span class="keywordflow">switch</span> (Flag) {
00615         <span class="keywordflow">case</span> <a class="code" href="../../d4/d6/fullscr_2vga_2foncache_8c.html#a0">ADD_IMAGE</a>:
00616             <span class="keywordflow">if</span> (FontOffsetLow-&gt;<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html#o0">FontOffsetLow</a>[LowIndex] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00617             {
00618                 <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a> OldFontImage = FontOffsetLow-&gt;<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html#o0">FontOffsetLow</a>[LowIndex];
00619                 SIZE_T OldFontSize = <a class="code" href="../../d8/d5/consrv_8h.html#a39">ConsoleHeapSize</a>(OldFontImage);
00620                 <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a> NewFontImage;
00621 
00622                 NewFontImage = <a class="code" href="../../d8/d5/consrv_8h.html#a37">ConsoleHeapReAlloc</a>(HEAP_ZERO_MEMORY,
00623                                            OldFontImage,
00624                                            OldFontSize + <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">FONT_IMAGE</a>));
00625                 <span class="keywordflow">if</span> (NewFontImage == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00626                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetFontImageInternal: failed to allocate NewFontImage"</span>);
00627                     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00628                 }
00629 
00630                 FontOffsetLow-&gt;<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html#o0">FontOffsetLow</a>[LowIndex] = NewFontImage;
00631 
00632                 <span class="comment">// Rebase Font Image List</span>
00633                 RebaseFontImageList(NewFontImage, (PBYTE)OldFontImage);
00634 
00635                 NewFontImage = (<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)NewFontImage + OldFontSize);
00636 
00637                 NewFontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o1">FontSize</a> = FontSize;
00638 
00639                 <span class="comment">//</span>
00640                 <span class="comment">// Connect link list.</span>
00641                 <span class="comment">//</span>
00642                 (NewFontImage-1)-&gt;ImageList.Flink = (PLIST_ENTRY)NewFontImage;
00643                 NewFontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o0">ImageList</a>.Blink = (PLIST_ENTRY)(NewFontImage-1);
00644 
00645                 FontImage = NewFontImage;
00646             }
00647             <span class="keywordflow">else</span>
00648             {
00649                 FontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o1">FontSize</a> = FontSize;
00650                 FontOffsetLow-&gt;<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html#o0">FontOffsetLow</a>[LowIndex] = FontImage;
00651             }
00652 
00653             <span class="comment">//</span>
00654             <span class="comment">// Allocate Image Buffer</span>
00655             <span class="comment">//</span>
00656             <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FontSize,WORD_ALIGN);
00657 
00658             <span class="keywordflow">if</span> (FontCache-&gt;BaseImageBits == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00659             {
00660                 FontCache-&gt;BaseImageBits = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( HEAP_ZERO_MEMORY, BufferSize);
00661                 <span class="keywordflow">if</span> (FontCache-&gt;BaseImageBits == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00662                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetFontImageInternal: failed to allocate FontCache-&gt;BaseImageBits"</span>);
00663                     UnlinkAndShrinkFontImagesByOne(&amp;FontOffsetLow-&gt;<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html#o0">FontOffsetLow</a>[LowIndex], FontImage);
00664                     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00665                 }
00666 
00667                 FontImage-&gt;ImageBits = FontCache-&gt;BaseImageBits;
00668             }
00669             <span class="keywordflow">else</span>
00670             {
00671                 <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> OldBaseImage = FontCache-&gt;BaseImageBits;
00672                 SIZE_T OldImageSize = <a class="code" href="../../d8/d5/consrv_8h.html#a39">ConsoleHeapSize</a>(OldBaseImage);
00673                 FontCache-&gt;BaseImageBits = <a class="code" href="../../d8/d5/consrv_8h.html#a37">ConsoleHeapReAlloc</a>(HEAP_ZERO_MEMORY,
00674                                                        OldBaseImage,
00675                                                        OldImageSize + BufferSize);
00676                 <span class="keywordflow">if</span> (FontCache-&gt;BaseImageBits == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00677                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetFontImageInternal: failed to reallocate FontCache-&gt;BaseImageBits"</span>);
00678                     <span class="comment">//</span>
00679                     <span class="comment">// When reallocation fails, we preserve the old baseImageBits</span>
00680                     <span class="comment">// so that other FontImage-&gt;ImageBits can be still valid.</span>
00681                     <span class="comment">//</span>
00682                     FontCache-&gt;BaseImageBits = OldBaseImage;
00683                     <span class="comment">//</span>
00684                     <span class="comment">// Remove the tail element that we failed to add image.</span>
00685                     <span class="comment">//</span>
00686                     UnlinkAndShrinkFontImagesByOne(&amp;FontOffsetLow-&gt;<a class="code" href="../../d6/d9/struct__FONT__LOW__OFFSET.html#o0">FontOffsetLow</a>[LowIndex], FontImage);
00687                     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00688                 }
00689 
00690                 <span class="comment">// Rebase font image pointer</span>
00691                 RebaseFontCache(FontCache, OldBaseImage);
00692 
00693                 FontImage-&gt;ImageBits = FontCache-&gt;BaseImageBits + OldImageSize;
00694             }
00695 
00696             <a class="code" href="../../d7/d8/fsvga_8h.html#a56">AlignCopyMemory</a>(FontImage-&gt;ImageBits,<span class="comment">// pDestBits</span>
00697                             WORD_ALIGN,          <span class="comment">// dwDestAlign</span>
00698                             (PVOID)ImageBits,    <span class="comment">// pSrcBits</span>
00699                             dwAlign,             <span class="comment">// dwSrcAlign</span>
00700                             FontSize);
00701 
00702             <span class="keywordflow">break</span>;
00703 
00704         <span class="keywordflow">case</span> <a class="code" href="../../d4/d6/fullscr_2vga_2foncache_8c.html#a1">REPLACE_IMAGE</a>:
00705             <span class="keywordflow">if</span> (FontImage-&gt;ImageBits == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00706                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetFontImageInternal: FontImage-&gt;ImageBits is NULL."</span>);
00707                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00708             }
00709 
00710             <a class="code" href="../../d7/d8/fsvga_8h.html#a56">AlignCopyMemory</a>(FontImage-&gt;ImageBits,<span class="comment">// pDestBits</span>
00711                             WORD_ALIGN,          <span class="comment">// dwDestAlign</span>
00712                             (PVOID)ImageBits,    <span class="comment">// pSrcBits</span>
00713                             dwAlign,             <span class="comment">// dwSrcAlign</span>
00714                             FontSize);
00715 
00716             <span class="keywordflow">break</span>;
00717     }
00718 
00719     <span class="keywordflow">return</span> STATUS_SUCCESS;
00720 }
00721 
00722 
00723 
00724 
00725 
00726 ULONG
00727 <a class="code" href="../../d6/d6/foncache_8h.html#a25">GetFontImage</a>(
00728     IN <a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a> FontCache,
00729     IN WCHAR wChar,
00730     IN COORD FontSize,
00731     IN DWORD dwAlign,
00732     OUT VOID *ImageBits
00733     )
00734 {
00735     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00736     <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a> FontImage;
00737 
00738     <span class="keywordflow">if</span> (FontSize.X == 0 &amp;&amp;
00739         FontSize.Y == 0   ) {
00740         <span class="keywordflow">return</span> (ULONG)(STATUS_INVALID_PARAMETER);
00741     }
00742 
00743     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetFontImageInternal(FontCache,wChar,FontSize,&amp;FontImage,FONT_MATCHED);
00744     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) )
00745         <span class="keywordflow">return</span> (ULONG)<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00746 
00747     <span class="keywordflow">if</span> (FontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o2">ImageBits</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00748         ImageBits == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00749         <span class="keywordflow">return</span> STATUS_SUCCESS;
00750 
00751     <a class="code" href="../../d7/d8/fsvga_8h.html#a56">AlignCopyMemory</a>((PVOID)ImageBits,    <span class="comment">// pDestBits</span>
00752                     dwAlign,             <span class="comment">// dwDestAlign</span>
00753                     FontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o2">ImageBits</a>,<span class="comment">// pSrcBits</span>
00754                     WORD_ALIGN,          <span class="comment">// dwSrcAlign</span>
00755                     FontSize);
00756 
00757     <span class="keywordflow">return</span> STATUS_SUCCESS;
00758 }
00759 
00760 ULONG
00761 <a class="code" href="../../d6/d6/foncache_8h.html#a26">GetStretchedFontImage</a>(
00762     IN <a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a> FontCache,
00763     IN WCHAR wChar,
00764     IN COORD FontSize,
00765     IN DWORD dwAlign,
00766     OUT VOID *ImageBits
00767     )
00768 {
00769     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00770     <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a> FontImage;
00771     <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">FONT_IMAGE</a>  FontBuff;
00772     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00773 
00774     <span class="keywordflow">if</span> (FontSize.X == 0 &amp;&amp;
00775         FontSize.Y == 0   ) {
00776         <span class="keywordflow">return</span> (ULONG)(STATUS_INVALID_PARAMETER);
00777     }
00778 
00779     FontImage = &amp;FontBuff;
00780 
00781     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FontSize,WORD_ALIGN);
00782     FontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o2">ImageBits</a> = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( HEAP_ZERO_MEMORY, BufferSize);
00783     <span class="keywordflow">if</span> (FontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o2">ImageBits</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00784         RIPMSG0(RIP_WARNING, <span class="stringliteral">"GetStretchedFontImage: failed to allocate FontImage-&gt;ImageBits"</span>);
00785         <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
00786     }
00787 
00788     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetFontImageInternal(FontCache,wChar,FontSize,&amp;FontImage,FONT_STRETCHED);
00789     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) )
00790     {
00791         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontBuff.ImageBits);
00792         <span class="keywordflow">return</span> (ULONG)<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00793     }
00794 
00795     <span class="keywordflow">if</span> (FontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o2">ImageBits</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00796     {
00797         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontBuff.ImageBits);
00798         <span class="keywordflow">return</span> (ULONG)STATUS_SUCCESS;
00799     }
00800 
00801     <a class="code" href="../../d7/d8/fsvga_8h.html#a56">AlignCopyMemory</a>((PVOID)ImageBits,    <span class="comment">// pDestBits</span>
00802                     dwAlign,             <span class="comment">// dwDestAlign</span>
00803                     FontImage-&gt;<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html#o2">ImageBits</a>,<span class="comment">// pSrcBits</span>
00804                     WORD_ALIGN,          <span class="comment">// dwSrcAlign</span>
00805                     FontSize);
00806 
00807     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontBuff.ImageBits);
00808 
00809     <span class="keywordflow">return</span> (ULONG)STATUS_SUCCESS;
00810 }
00811 
00812 ULONG
00813 <a class="code" href="../../d6/d6/foncache_8h.html#a27">GetFontImagePointer</a>(
00814     IN <a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a> FontCache,
00815     IN WCHAR wChar,
00816     IN COORD FontSize,
00817     OUT <a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a> *FontImage
00818     )
00819 {
00820     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00821 
00822     <span class="keywordflow">if</span> (FontSize.X == 0 &amp;&amp;
00823         FontSize.Y == 0   ) {
00824         <span class="keywordflow">return</span> (ULONG)(STATUS_INVALID_PARAMETER);
00825     }
00826 
00827     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetFontImageInternal(FontCache,wChar,FontSize,(<a class="code" href="../../d4/d9/struct__FONT__IMAGE.html">PFONT_IMAGE</a>*)FontImage,FONT_MATCHED);
00828     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) )
00829         <span class="keywordflow">return</span> (ULONG)<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00830 
00831     <span class="keywordflow">if</span> ((*FontImage)-&gt;ImageBits == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00832         <span class="keywordflow">return</span> (ULONG)STATUS_ACCESS_DENIED;
00833 
00834     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00835 }
00836 
00837 ULONG
00838 <a class="code" href="../../d6/d6/foncache_8h.html#a28">SetFontImage</a>(
00839     IN <a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a> FontCache,
00840     IN WCHAR wChar,
00841     IN COORD FontSize,
00842     IN DWORD dwAlign,
00843     IN CONST VOID *ImageBits
00844     )
00845 {
00846     <span class="keywordflow">return</span> SetFontImageInternal(FontCache,wChar,FontSize,dwAlign,ImageBits);
00847 }
00848 
00849 
00850 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00851 GetExpandImage(
00852     COORD InputFontSize,
00853     PWORD InputFontImage,
00854     COORD OutputFontSize,
00855     PWORD OutputFontImage
00856     )
00857 {
00858     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00859     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> InputRow = <a class="code" href="../../d4/d6/fullscr_2vga_2foncache_8c.html#a2">CALC_BITMAP_BITS_FOR_X</a>(InputFontSize.X, BITMAP_BITS_WORD_ALIGN);
00860     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> OutputRow = <a class="code" href="../../d4/d6/fullscr_2vga_2foncache_8c.html#a2">CALC_BITMAP_BITS_FOR_X</a>(OutputFontSize.X, BITMAP_BITS_WORD_ALIGN);
00861     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> InputBufferSize = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(InputFontSize,WORD_ALIGN);
00862     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> OutputBufferSize = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(OutputFontSize,WORD_ALIGN);
00863 
00864     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00865 
00866     RtlZeroMemory(OutputFontImage,OutputBufferSize);
00867 
00868     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(InputRow==OutputRow);
00869 
00870     <span class="keywordflow">if</span> (InputFontSize.Y &lt; OutputFontSize.Y)
00871         RtlCopyMemory(OutputFontImage, InputFontImage, InputBufferSize);
00872     <span class="keywordflow">else</span>
00873         RtlCopyMemory(OutputFontImage, InputFontImage, OutputBufferSize);
00874 
00875     <span class="keywordflow">return</span> STATUS_SUCCESS;
00876 }
00877 
00878 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00879 <a class="code" href="../../d6/d6/foncache_8h.html#a30">GetExpandFontImage</a>(
00880     <a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a> FontCache,
00881     WCHAR wChar,
00882     COORD InputFontSize,
00883     COORD OutputFontSize,
00884     PWORD OutputFontImage
00885     )
00886 {
00887     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00888     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> InputBufferSize;
00889     PWORD InputFontImage;
00890 
00891     <span class="keywordflow">if</span> (InputFontSize.X == 0 &amp;&amp;
00892         InputFontSize.Y == 0   ) {
00893         <span class="keywordflow">return</span> (ULONG)(STATUS_INVALID_PARAMETER);
00894     }
00895 
00896     <span class="keywordflow">if</span> (OutputFontSize.X == 0 &amp;&amp;
00897         OutputFontSize.Y == 0   ) {
00898         <span class="keywordflow">return</span> (ULONG)(STATUS_INVALID_PARAMETER);
00899     }
00900 
00901     InputBufferSize = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(InputFontSize,WORD_ALIGN);
00902     InputFontImage = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( HEAP_ZERO_MEMORY, InputBufferSize);
00903     <span class="keywordflow">if</span> (InputFontImage==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00904         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00905 
00906 
00907     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a25">GetFontImage</a>(FontCache,
00908                           wChar,
00909                           InputFontSize,
00910                           WORD_ALIGN,
00911                           InputFontImage);
00912     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) )
00913     {
00914         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(InputFontImage);
00915         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00916     }
00917 
00918     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExpandImage(InputFontSize,
00919                             InputFontImage,
00920                             OutputFontSize,
00921                             OutputFontImage);
00922 
00923     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(InputFontImage);
00924 
00925     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00926 }
00927 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:03 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
