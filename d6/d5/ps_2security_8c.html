<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ps/security.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>security.c File Reference</h1><code>#include "<a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>"</code><br>

<p>
<a href="../../d7/d4/ps_2security_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PACCESS_TOKEN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PACCESS_TOKEN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a1">PsReferenceImpersonationToken</a> (IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread, OUT PBOOLEAN CopyOnOpen, OUT PBOOLEAN EffectiveOnly, OUT PSECURITY_IMPERSONATION_LEVEL ImpersonationLevel)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PACCESS_TOKEN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a2">PsReferenceEffectiveToken</a> (IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread, OUT PTOKEN_TYPE TokenType, OUT PBOOLEAN EffectiveOnly, OUT PSECURITY_IMPERSONATION_LEVEL ImpersonationLevel)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a3">PsOpenTokenOfThread</a> (IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>, IN BOOLEAN OpenAsSelf, OUT PACCESS_TOKEN *<a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, OUT PBOOLEAN CopyOnOpen, OUT PBOOLEAN EffectiveOnly, OUT PSECURITY_IMPERSONATION_LEVEL ImpersonationLevel)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a4">PsOpenTokenOfProcess</a> (IN HANDLE ProcessHandle, OUT PACCESS_TOKEN *<a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a5">PsOpenTokenOfJobObject</a> (IN HANDLE JobObject, OUT PACCESS_TOKEN *<a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a6">PsImpersonateClient</a> (IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread, IN PACCESS_TOKEN <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN BOOLEAN CopyOnOpen, IN BOOLEAN EffectiveOnly, IN SECURITY_IMPERSONATION_LEVEL ImpersonationLevel)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a7">PsDisableImpersonation</a> (IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread, IN PSE_IMPERSONATION_STATE ImpersonationState)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a8">PsRestoreImpersonation</a> (IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread, IN PSE_IMPERSONATION_STATE ImpersonationState)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a9">PsRevertToSelf</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a10">PspInitializeProcessSecurity</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Parent OPTIONAL, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Child)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a11">PspDeleteProcessSecurity</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a12">PspAssignPrimaryToken</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a> OPTIONAL, IN PACCESS_TOKEN TokenPointer OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a13">PspInitializeThreadSecurity</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a14">PspDeleteThreadSecurity</a> (IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/ps_2security_8c.html#a15">PsAssignImpersonationToken</a> (IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread, IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a15" doxytag="ps/security.c::PsAssignImpersonationToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PsAssignImpersonationToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01483">1483</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00075">Filter</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00639">IS_SYSTEM_THREAD</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00650">PsImpersonateClient()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01859">SeFastFilterToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00211">SeTokenImpersonationLevel()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00150">SeTokenIsAdmin()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00181">SeTokenIsRestricted()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01213">SeTokenObjectType</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00118">SeTokenType()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l03103">NtSetInformationThread()</a>.
<p>
<pre class="fragment"><div>01490                    :
01491 
01492     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security portions of establishing an
01493     impersonation token.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to be used <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> in
01494     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject has asked <span class="keywordflow">for</span> impersonation explicitly
01495     providing an impersonation token.  Other services are provided <span class="keywordflow">for</span>
01496     use by communication session layers that need to establish an
01497     impersonation on a server's behalf.
01498 
01499     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proper access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread object has already
01500     been established.
01501 
01502     The following rules apply:
01503 
01504          1) The caller must have TOKEN_IMPERSONATE access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token
01505             <span class="keywordflow">for</span> any action to be taken.
01506 
01507          2) If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token may NOT be used <span class="keywordflow">for</span> impersonation (e.g., not an
01508             impersonation token) no action <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> taken.
01509 
01510          3) Otherwise, any existing impersonation token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dereferenced and
01511             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> established as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation token.
01512 
01513 
01514 
01515 Arguments:
01516 
01517     Thread - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread whose impersonation token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
01518         set.
01519 
01520     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - The handle value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to be assigned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation
01521         token.  If <span class="keyword">this</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, then current impersonation (<span class="keywordflow">if</span> any)
01522         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> terminated and no <span class="keyword">new</span> impersonation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> established.
01523 
01524 
01525 Return Value:
01526 
01527     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token has been successfully
01528         replaced.
01529 
01530     STATUS_BAD_TOKEN_TYPE - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
01531         TokenImpersonation.
01532 
01533     Other status may be returned when attempting to reference <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token
01534     object.
01535 
01536 --*/
01537 
01538 {
01539     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01540         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01541 
01542     PACCESS_TOKEN
01543         NewToken, NewerToken ;
01544 
01545     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>
01546         PreviousMode;
01547 
01548     SECURITY_IMPERSONATION_LEVEL
01549         ImpersonationLevel;
01550 
01551     <a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html">PPS_JOB_TOKEN_FILTER</a> <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> ;
01552 
01553     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ThreadProcess;
01554     BOOLEAN  AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01555 
01556     PreviousMode = KeGetPreviousMode();
01557 
01558     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(Token)) {
01559 
01560         NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01561 
01562         <span class="comment">//</span>
01563         <span class="comment">// Don't care what value ImpersonationLevel has, it won't</span>
01564         <span class="comment">// be used.</span>
01565         <span class="comment">//</span>
01566 
01567     } <span class="keywordflow">else</span> {
01568 
01569         <span class="comment">//</span>
01570         <span class="comment">// Reference the specified token for TOKEN_IMPERSONATE access</span>
01571         <span class="comment">//</span>
01572 
01573         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
01574                     Token,
01575                     TOKEN_IMPERSONATE,
01576                     <a class="code" href="../../d0/d5/se_8h.html#a17">SeTokenObjectType</a>(),
01577                     PreviousMode,
01578                     (PVOID *)&amp;NewToken,
01579                     NULL
01580                     );
01581 
01582         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01583             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01584         }
01585 
01586         <span class="comment">//</span>
01587         <span class="comment">// Make sure the token is an impersonation token.</span>
01588         <span class="comment">//</span>
01589 
01590         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/token_8c.html#a3">SeTokenType</a>( NewToken ) != TokenImpersonation ) {
01591             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
01592             <span class="keywordflow">return</span> STATUS_BAD_TOKEN_TYPE;
01593         }
01594 
01595         <span class="keywordflow">if</span> ( Thread-&gt;ThreadsProcess-&gt;Job ) {
01596 
01597             <span class="keywordflow">if</span> ( ( Thread-&gt;ThreadsProcess-&gt;Job-&gt;SecurityLimitFlags &amp; JOB_OBJECT_SECURITY_NO_ADMIN ) &amp;&amp;
01598                  ( <a class="code" href="../../d4/d3/token_8c.html#a4">SeTokenIsAdmin</a>( NewToken ) ) ) {
01599 
01600                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
01601 
01602                 <span class="keywordflow">return</span> STATUS_ACCESS_DENIED ;
01603 
01604             }
01605 
01606             <span class="keywordflow">if</span> ( ( Thread-&gt;ThreadsProcess-&gt;Job-&gt;SecurityLimitFlags &amp; JOB_OBJECT_SECURITY_RESTRICTED_TOKEN ) &amp;&amp;
01607                  ( !<a class="code" href="../../d4/d3/token_8c.html#a5">SeTokenIsRestricted</a>( NewToken ) ) )
01608             {
01609                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
01610 
01611                 <span class="keywordflow">return</span> STATUS_ACCESS_DENIED ;
01612             }
01613 
01614             <span class="keywordflow">if</span> ( Thread-&gt;ThreadsProcess-&gt;Job-&gt;Filter )
01615             {
01616                 <span class="comment">//</span>
01617                 <span class="comment">// Filter installed.  Need to create a restricted token</span>
01618                 <span class="comment">// dynamically.</span>
01619                 <span class="comment">//</span>
01620                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> = Thread-&gt;ThreadsProcess-&gt;Job-&gt;Filter ;
01621 
01622                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a9">SeFastFilterToken</a>(
01623                                 NewToken,
01624                                 PreviousMode,
01625                                 0,
01626                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroupCount,
01627                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroups,
01628                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivilegeCount,
01629                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivileges,
01630                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSidCount,
01631                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSids,
01632                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSidsLength,
01633                                 &amp;NewerToken );
01634 
01635                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
01636 
01637                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) )
01638                 {
01639                     NewToken = NewerToken ;
01640                 }
01641                 <span class="keywordflow">else</span>
01642                 {
01643                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01644                 }
01645 
01646 
01647             }
01648         }
01649 
01650         ImpersonationLevel = <a class="code" href="../../d4/d3/token_8c.html#a6">SeTokenImpersonationLevel</a>( NewToken );
01651     }
01652 
01653     <span class="comment">//</span>
01654     <span class="comment">// The rest can be done by PsImpersonateClient.</span>
01655     <span class="comment">//</span>
01656     <span class="comment">// PsImpersonateClient will reference the passed token</span>
01657     <span class="comment">// on success.</span>
01658     <span class="comment">//</span>
01659 
01660     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a6">PsImpersonateClient</a>(
01661                  Thread,
01662                  NewToken,
01663                  FALSE,          <span class="comment">// CopyOnOpen</span>
01664                  FALSE,          <span class="comment">//EffectiveOnly</span>
01665                  ImpersonationLevel
01666                  );
01667 
01668 
01669     <span class="comment">//</span>
01670     <span class="comment">// dereference the passed token, if there is one.</span>
01671     <span class="comment">//</span>
01672     <span class="comment">// Note that if PsImpersonateClient failed, this will</span>
01673     <span class="comment">// be the final dereference of NewToken/NewerToken,</span>
01674     <span class="comment">// and it will be freed.</span>
01675     <span class="comment">//</span>
01676 
01677     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NewToken)) {
01678         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
01679     }
01680 
01681     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01682 
01683         <span class="comment">//</span>
01684         <span class="comment">//   Indicate that 'Thread' has started to do impersonation.</span>
01685         <span class="comment">//   This info is useful for GetUserDefaultLCID()</span>
01686         <span class="comment">//</span>
01687 
01688         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread)) {
01689 
01690             ThreadProcess = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread);
01691 
01692             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != ThreadProcess ) {
01693                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( &amp;ThreadProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a> );
01694                 AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01695             }
01696 
01697             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NewToken)) {
01698                 ((PTEB)(Thread-&gt;Tcb.Teb))-&gt;ImpersonationLocale = (LCID)-1;
01699                 ((PTEB)(Thread-&gt;Tcb.Teb))-&gt;IsImpersonating = 1;
01700             } <span class="keywordflow">else</span> {
01701                 ((PTEB)(Thread-&gt;Tcb.Teb))-&gt;ImpersonationLocale = (LCID) 0;
01702                 ((PTEB)(Thread-&gt;Tcb.Teb))-&gt;IsImpersonating = 0;
01703             }
01704 
01705             <span class="keywordflow">if</span> (AttachedToProcess) {
01706                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01707             }
01708         }
01709     }
01710 
01711     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01712 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ps/security.c::PsDisableImpersonation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN PsDisableImpersonation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSE_IMPERSONATION_STATE&nbsp;</td>
          <td class="mdname" nowrap> <em>ImpersonationState</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00888">888</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00093">_PS_IMPERSONATION_INFORMATION::CopyOnOpen</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00094">_PS_IMPERSONATION_INFORMATION::EffectiveOnly</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00095">_PS_IMPERSONATION_INFORMATION::ImpersonationLevel</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00661">PsFreeProcessSecurityFields</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00654">PsLockProcessSecurityFields</a>, <a class="el" href="../../d4/d9/ke_8h.html#a402a163">ThreadObject</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00092">_PS_IMPERSONATION_INFORMATION::Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00326">PsOpenTokenOfThread()</a>, and <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00294">SepOpenTokenOfThread()</a>.
<p>
<pre class="fragment"><div>00895                    :
00896 
00897     This routine temporarily disables <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation of a thread.
00898     The impersonation state <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> saved <span class="keywordflow">for</span> quick replacement later.  The
00899     impersonation token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> left referenced and a pointer to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held
00900     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IMPERSONATION_STATE data structure.
00901 
00902     <a class="code" href="../../d6/d5/ps_2security_8c.html#a8">PsRestoreImpersonation</a>() must be used after this routine is called.
00903 
00904 
00905 
00906 Arguments:
00907 
00908     Thread - points to the thread whose impersonation (if any) is to
00909         be temporarily disabled.
00910 
00911     ImpersonationState - receives the current impersonation information,
00912         including a pointer to the impersonation token.
00913 
00914 
00915 Return Value:
00916 
00917     TRUE - Indicates the impersonation state has been saved and the
00918         impersonation has been temporarily disabled.
00919 
00920     FALSE - Indicates the specified thread was not impersonating a client.
00921        No action has been taken.
00922 
00923 --*/
00924 
00925 {
00926 
00927 
00928     <a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html">PPS_IMPERSONATION_INFORMATION</a>
00929         OldClient;
00930 
00931     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Thread-&gt;Tcb.Header.Type == ThreadObject );
00932 
00933     <span class="comment">//</span>
00934     <span class="comment">//  Lock the process security fields</span>
00935     <span class="comment">//</span>
00936 
00937     <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
00938 
00939     <span class="comment">//</span>
00940     <span class="comment">//  Capture the impersonation information (if there is any).</span>
00941     <span class="comment">//</span>
00942 
00943     <span class="keywordflow">if</span> ( Thread-&gt;ActiveImpersonationInfo ) {
00944 
00945         OldClient = Thread-&gt;ImpersonationInfo;
00946         ImpersonationState-&gt;Level         = OldClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o3">ImpersonationLevel</a>;
00947         ImpersonationState-&gt;EffectiveOnly = OldClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o2">EffectiveOnly</a>;
00948         ImpersonationState-&gt;CopyOnOpen    = OldClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o1">CopyOnOpen</a>;
00949         ImpersonationState-&gt;Token         = OldClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o0">Token</a>;
00950     } <span class="keywordflow">else</span> {
00951 
00952         <span class="comment">//</span>
00953         <span class="comment">// Not impersonating.  Just make up some values.</span>
00954         <span class="comment">// The NULL for the token indicates we aren't impersonating.</span>
00955         <span class="comment">//</span>
00956 
00957         OldClient = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00958         ImpersonationState-&gt;Level         = SecurityAnonymous;
00959         ImpersonationState-&gt;EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00960         ImpersonationState-&gt;CopyOnOpen    = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00961         ImpersonationState-&gt;Token         = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00962     }
00963 
00964     <span class="comment">//</span>
00965     <span class="comment">// Clear the Client field to indicate the thread is not impersonating.</span>
00966     <span class="comment">//</span>
00967 
00968     Thread-&gt;ActiveImpersonationInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00969 
00970 
00971     <span class="comment">//</span>
00972     <span class="comment">//  Release the security fields</span>
00973     <span class="comment">//</span>
00974 
00975     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
00976 
00977 
00978     <span class="keywordflow">if</span> ( OldClient ) {
00979 
00980         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00981 
00982     } <span class="keywordflow">else</span> {
00983         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00984     }
00985 
00986 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ps/security.c::PsImpersonateClient" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PsImpersonateClient           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CopyOnOpen</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>EffectiveOnly</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECURITY_IMPERSONATION_LEVEL&nbsp;</td>
          <td class="mdname" nowrap> <em>ImpersonationLevel</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00650">650</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00093">_PS_IMPERSONATION_INFORMATION::CopyOnOpen</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00094">_PS_IMPERSONATION_INFORMATION::EffectiveOnly</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00075">Filter</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00095">_PS_IMPERSONATION_INFORMATION::ImpersonationLevel</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00840">PsDereferenceImpersonationToken</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00661">PsFreeProcessSecurityFields</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00654">PsLockProcessSecurityFields</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01859">SeFastFilterToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00150">SeTokenIsAdmin()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00181">SeTokenIsRestricted()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d9/ke_8h.html#a402a163">ThreadObject</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00092">_PS_IMPERSONATION_INFORMATION::Token</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/token_8c-source.html#l03038">NtImpersonateAnonymousToken()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01483">PsAssignImpersonationToken()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00990">PsRestoreImpersonation()</a>, and <a class="el" href="../../d5/d4/seclient_8c-source.html#l00636">SeImpersonateClientEx()</a>.
<p>
<pre class="fragment"><div>00660                    :
00661 
00662     This routine sets up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> impersonating
00663     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified client.  This will result in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00664     token representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client being incremented to reflect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
00665     reference.
00666 
00667     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently impersonating a client, that token will be
00668     dereferenced.
00669 
00670 
00671 
00672 Arguments:
00673 
00674     Thread - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> going to impersonate a client.
00675 
00676     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to be assigned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation token.
00677         This does NOT have to be a TokenImpersonation <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> token.  This
00678         allows direct reference of client process's primary tokens.
00679 
00680     CopyOnOpen - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> considered to be <span class="keyword">private</span>
00681         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> assigner and should be copied <span class="keywordflow">if</span> opened.  For example, a
00682         session layer may be <span class="keyword">using</span> a token to represent a client's context.
00683         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> trying to synchronize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client,
00684         then user mode code should not be given direct access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session
00685         layer's token.
00686 
00687         Basically, session layers should always specify <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">for</span> <span class="keyword">this</span>, <span class="keywordflow">while</span>
00688         tokens assigned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server itself (handle based) should specify
00689         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00690 
00691 
00692     EffectiveOnly - Is a <span class="keywordtype">boolean</span> value to be assigned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00693         Thread-&gt;ImpersonationInfo-&gt;EffectiveOnly field value <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00694         impersonation.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed
00695         to enable currently disabled groups and privileges.
00696 
00697     ImpersonationLevel - Is <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation level that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed
00698         to access <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token with.
00699 
00700 
00701 Return Value:
00702 
00703     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.
00704 
00705 
00706 --*/
00707 
00708 {
00709 
00710     <a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html">PPS_IMPERSONATION_INFORMATION</a>
00711         NewClient;
00712 
00713     PACCESS_TOKEN
00714         OldToken;
00715 
00716     PACCESS_TOKEN NewerToken ;
00717     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00718     <a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html">PPS_JOB_TOKEN_FILTER</a> <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> ;
00719     BOOLEAN DontRefToken = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
00720 
00721     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Thread-&gt;Tcb.Header.Type == ThreadObject );
00722 
00723 
00724     <span class="comment">//</span>
00725     <span class="comment">//  Lock the process security fields</span>
00726     <span class="comment">//</span>
00727 
00728     <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
00729 
00730 
00731     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(Token)) {
00732 
00733         <span class="comment">//</span>
00734         <span class="comment">// This is a request to revert to self.</span>
00735         <span class="comment">// Clean up any client information.</span>
00736         <span class="comment">//</span>
00737 
00738         <span class="keywordflow">if</span> ( Thread-&gt;ActiveImpersonationInfo ) {
00739 
00740             OldToken = Thread-&gt;ImpersonationInfo-&gt;Token;
00741             Thread-&gt;ActiveImpersonationInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00742         } <span class="keywordflow">else</span> {
00743             OldToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00744         }
00745 
00746     } <span class="keywordflow">else</span> {
00747 
00748         <span class="comment">//</span>
00749         <span class="comment">// Check if we're allowed to impersonate based on the job</span>
00750         <span class="comment">// restrictions:</span>
00751         <span class="comment">//</span>
00752 
00753         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS ;
00754 
00755         <span class="keywordflow">if</span> ( Thread-&gt;ThreadsProcess-&gt;Job ) {
00756 
00757             <span class="keywordflow">if</span> ( ( Thread-&gt;ThreadsProcess-&gt;Job-&gt;SecurityLimitFlags &amp; JOB_OBJECT_SECURITY_NO_ADMIN ) &amp;&amp;
00758                  ( <a class="code" href="../../d4/d3/token_8c.html#a4">SeTokenIsAdmin</a>( Token ) ) ) {
00759 
00760                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED ;
00761 
00762             }
00763 
00764             <span class="keywordflow">if</span> ( ( Thread-&gt;ThreadsProcess-&gt;Job-&gt;SecurityLimitFlags &amp; JOB_OBJECT_SECURITY_RESTRICTED_TOKEN ) &amp;&amp;
00765                  ( !<a class="code" href="../../d4/d3/token_8c.html#a5">SeTokenIsRestricted</a>( Token ) ) )
00766             {
00767                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED ;
00768             }
00769 
00770             <span class="keywordflow">if</span> ( Thread-&gt;ThreadsProcess-&gt;Job-&gt;Filter )
00771             {
00772                 <span class="comment">//</span>
00773                 <span class="comment">// Filter installed.  Need to create a restricted token</span>
00774                 <span class="comment">// dynamically.</span>
00775                 <span class="comment">//</span>
00776                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> = Thread-&gt;ThreadsProcess-&gt;Job-&gt;Filter ;
00777 
00778                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a9">SeFastFilterToken</a>(
00779                                 Token,
00780                                 KernelMode,
00781                                 0,
00782                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroupCount,
00783                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroups,
00784                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivilegeCount,
00785                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivileges,
00786                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSidCount,
00787                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSids,
00788                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSidsLength,
00789                                 &amp;NewerToken );
00790 
00791                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) )
00792                 {
00793                     DontRefToken = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
00794 
00795                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = NewerToken ;
00796                 }
00797 
00798             }
00799         }
00800 
00801         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) )
00802         {
00803             <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
00804 
00805             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00806         }
00807 
00808         <span class="comment">//</span>
00809         <span class="comment">// If we are already impersonating someone,</span>
00810         <span class="comment">// use the already allocated block.  This avoids</span>
00811         <span class="comment">// an alloc and a free.</span>
00812         <span class="comment">//</span>
00813 
00814         <span class="keywordflow">if</span> ( Thread-&gt;ActiveImpersonationInfo ) {
00815 
00816             <span class="comment">//</span>
00817             <span class="comment">// capture the old token pointer.</span>
00818             <span class="comment">// We'll dereference it after unlocking the security fields.</span>
00819             <span class="comment">//</span>
00820 
00821             OldToken = Thread-&gt;ImpersonationInfo-&gt;Token;
00822             NewClient = Thread-&gt;ImpersonationInfo;
00823 
00824         } <span class="keywordflow">else</span> {
00825 
00826             OldToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00827 
00828             <span class="keywordflow">if</span> ( Thread-&gt;ImpersonationInfo ) {
00829                 NewClient = Thread-&gt;ImpersonationInfo;
00830             } <span class="keywordflow">else</span> {
00831 
00832                 <span class="comment">//</span>
00833                 <span class="comment">// Allocate and set up the Client block</span>
00834                 <span class="comment">//</span>
00835 
00836                 NewClient = (<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html">PPS_IMPERSONATION_INFORMATION</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00837                                 PagedPool,
00838                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html">PS_IMPERSONATION_INFORMATION</a>),
00839                                 'mIsP');
00840 
00841                 <span class="keywordflow">if</span> (NewClient == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00842 
00843                     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
00844 
00845                     <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
00846 
00847                 }
00848 
00849                 Thread-&gt;ImpersonationInfo = NewClient;
00850             }
00851         }
00852 
00853         NewClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o3">ImpersonationLevel</a> = ImpersonationLevel;
00854         NewClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o2">EffectiveOnly</a> = EffectiveOnly;
00855         NewClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o1">CopyOnOpen</a> = CopyOnOpen;
00856         NewClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o0">Token</a> = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00857         Thread-&gt;ActiveImpersonationInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00858 
00859         <span class="keywordflow">if</span> ( !DontRefToken )
00860         {
00861             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(NewClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o0">Token</a>);
00862         }
00863     }
00864 
00865     <span class="comment">//</span>
00866     <span class="comment">//  Release the security fields</span>
00867     <span class="comment">//</span>
00868 
00869     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
00870 
00871 
00872     <span class="comment">//</span>
00873     <span class="comment">// Free the old client token, if necessary.</span>
00874     <span class="comment">//</span>
00875 
00876     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( OldToken )) {
00877 
00878         <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( OldToken );
00879     }
00880 
00881 
00882     <span class="keywordflow">return</span> STATUS_SUCCESS ;
00883 
00884 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ps/security.c::PsOpenTokenOfJobObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PsOpenTokenOfJobObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>JobObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_TOKEN *&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00586">586</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00090">PsJobType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00530">_EJOB::Token</a>.
<p>
<pre class="fragment"><div>00593                    :
00594 
00595     This function does <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ps/job specific work <span class="keywordflow">for</span> NtOpenJobObjectToken.
00596 
00597 
00598 Arguments:
00599 
00600     JobObject - Supplies a handle to a job object whose limit token
00601         token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be opened.
00602 
00603     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - If successful, receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process's token
00604         object.
00605 
00606 Return Value:
00607 
00608     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.
00609 
00610     STATUS_NO_TOKEN - indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> job object does  not have a token
00611 
00612 
00613 --*/
00614 {
00615     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00616     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job ;
00617     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode ;
00618 
00619     PreviousMode = KeGetPreviousMode();
00620 
00621     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00622                     JobObject,
00623                     JOB_OBJECT_QUERY,
00624                     PsJobType,
00625                     PreviousMode,
00626                     &amp;Job,
00627                     NULL );
00628 
00629     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) )
00630     {
00631         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o22">Token</a> )
00632         {
00633             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o22">Token</a> );
00634 
00635             *<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o22">Token</a> ;
00636 
00637         }
00638         <span class="keywordflow">else</span>
00639         {
00640             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_TOKEN ;
00641         }
00642 
00643     }
00644 
00645     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00646 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ps/security.c::PsOpenTokenOfProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PsOpenTokenOfProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_TOKEN *&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00492">492</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00028">PsReferencePrimaryToken()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00178">NtOpenProcessToken()</a>.
<p>
<pre class="fragment"><div>00499                    :
00500 
00501     This function does <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process specific processing of
00502     an <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>() service.
00503 
00504     The service validates that the handle has appropriate access
00505     to referenced process.  If so, it goes on to reference the
00506     primary token object to prevent it from going away while the
00507     rest of the NtOpenProcessToken() request is processed.
00508 
00509     NOTE: If this call completes successfully, the caller is responsible
00510           for decrementing the reference count of the target token.
00511           This must be done using the PsDereferencePrimaryToken() API.
00512 
00513 Arguments:
00514 
00515     ProcessHandle - Supplies a handle to a process object whose primary
00516         token is to be opened.
00517 
00518     Token - If successful, receives a pointer to the process's token
00519         object.
00520 
00521 Return Value:
00522 
00523     STATUS_SUCCESS - Indicates the call completed successfully.
00524 
00525     status may also be any value returned by an attemp the reference
00526     the process object for PROCESS_QUERY_INFORMATION access.
00527 
00528 --*/
00529 
00530 {
00531 
00532     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00533         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00534 
00535     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>
00536         Process;
00537 
00538     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>
00539         PreviousMode;
00540 
00541 
00542     PreviousMode = KeGetPreviousMode();
00543 
00544     <span class="comment">//</span>
00545     <span class="comment">//  Make sure the handle grants the appropriate access to the specified</span>
00546     <span class="comment">//  process.</span>
00547     <span class="comment">//</span>
00548 
00549     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00550                  ProcessHandle,
00551                  PROCESS_QUERY_INFORMATION,
00552                  PsProcessType,
00553                  PreviousMode,
00554                  (PVOID *)&amp;Process,
00555                  NULL
00556                  );
00557 
00558     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00559 
00560         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00561 
00562     }
00563 
00564     <span class="comment">//</span>
00565     <span class="comment">//  Reference the primary token</span>
00566     <span class="comment">//  (This takes care of gaining exlusive access to the process</span>
00567     <span class="comment">//   security fields for us)</span>
00568     <span class="comment">//</span>
00569 
00570     (*Token) = <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>( Process );
00571 
00572 
00573 
00574     <span class="comment">//</span>
00575     <span class="comment">// Done with the process object</span>
00576     <span class="comment">//</span>
00577 
00578     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Process );
00579 
00580     <span class="keywordflow">return</span> STATUS_SUCCESS;
00581 
00582 
00583 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ps/security.c::PsOpenTokenOfThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PsOpenTokenOfThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenAsSelf</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_TOKEN *&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CopyOnOpen</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>EffectiveOnly</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_IMPERSONATION_LEVEL&nbsp;</td>
          <td class="mdname" nowrap> <em>ImpersonationLevel</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00326">326</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00840">PsDereferenceImpersonationToken</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00888">PsDisableImpersonation()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00097">PsReferenceImpersonationToken()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00990">PsRestoreImpersonation()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
<pre class="fragment"><div>00337                    :
00338 
00339     This function does <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread specific processing of
00340     an <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>() service.
00341 
00342     The service validates that the handle has appropriate access
00343     to reference the thread.  If so, it goes on to increment
00344     the reference count of the token object to prevent it from
00345     going away while the rest of the NtOpenThreadToken() request
00346     is processed.
00347 
00348     NOTE: If this call completes successfully, the caller is responsible
00349           for decrementing the reference count of the target token.
00350           This must be done using PsDereferenceImpersonationToken().
00351 
00352 Arguments:
00353 
00354     ThreadHandle - Supplies a handle to a thread object.
00355 
00356     OpenAsSelf - Is a <span class="keywordtype">boolean</span> value indicating whether the access should
00357         be made using the calling thread's current security context, which
00358         may be that of a client (if impersonating), or using the caller's
00359         process-level security context.  A value of FALSE indicates the
00360         caller's current context should be used un-modified.  A value of
00361         TRUE indicates the request should be fulfilled using the process
00362         level security context.
00363 
00364     Token - If successful, receives a pointer to the thread's token
00365         object.
00366 
00367     CopyOnOpen - The current value of the Thread-&gt;Client-&gt;CopyOnOpen field.
00368 
00369     EffectiveOnly - The current value of the Thread-&gt;Client-&gt;EffectiveOnly field.
00370 
00371     ImpersonationLevel - The current value of the Thread-&gt;Client-&gt;ImpersonationLevel
00372         field.
00373 
00374 Return Value:
00375 
00376     STATUS_SUCCESS - Indicates the call completed successfully.
00377 
00378     STATUS_NO_TOKEN - Indicates the referenced thread is not currently
00379         impersonating a client.
00380 
00381     STATUS_CANT_OPEN_ANONYMOUS - Indicates the client requested anonymous
00382         impersonation level.  An anonymous token can not be openned.
00383 
00384     status may also be any value returned by an attemp the reference
00385     the thread object for THREAD_QUERY_INFORMATION access.
00386 
00387 --*/
00388 
00389 {
00390 
00391     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00392         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00393 
00394     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>
00395         Thread;
00396 
00397     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>
00398         PreviousMode;
00399 
00400     SE_IMPERSONATION_STATE
00401         DisabledImpersonationState;
00402 
00403     BOOLEAN
00404         RestoreImpersonationState = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00405 
00406     PreviousMode = KeGetPreviousMode();
00407 
00408 
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">// Disable impersonation if necessary</span>
00412     <span class="comment">//</span>
00413 
00414     <span class="keywordflow">if</span> (OpenAsSelf) {
00415          RestoreImpersonationState = <a class="code" href="../../d6/d5/ps_2security_8c.html#a7">PsDisableImpersonation</a>(
00416                                          <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
00417                                          &amp;DisabledImpersonationState
00418                                          );
00419     }
00420 
00421     <span class="comment">//</span>
00422     <span class="comment">//  Make sure the handle grants the appropriate access to the specified</span>
00423     <span class="comment">//  thread.</span>
00424     <span class="comment">//</span>
00425 
00426     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00427                  ThreadHandle,
00428                  THREAD_QUERY_INFORMATION,
00429                  PsThreadType,
00430                  PreviousMode,
00431                  (PVOID *)&amp;Thread,
00432                  NULL
00433                  );
00434 
00435 
00436 
00437 
00438     <span class="keywordflow">if</span> (RestoreImpersonationState) {
00439         <a class="code" href="../../d6/d5/ps_2security_8c.html#a8">PsRestoreImpersonation</a>(
00440             <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
00441             &amp;DisabledImpersonationState
00442             );
00443     }
00444 
00445     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00446         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00447     }
00448 
00449     <span class="comment">//</span>
00450     <span class="comment">//  Reference the impersonation token, if there is one</span>
00451     <span class="comment">//</span>
00452 
00453     (*Token) = <a class="code" href="../../d6/d5/ps_2security_8c.html#a1">PsReferenceImpersonationToken</a>( Thread,
00454                                               CopyOnOpen,
00455                                               EffectiveOnly,
00456                                               ImpersonationLevel
00457                                               );
00458 
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">//  dereference the target thread.</span>
00462     <span class="comment">//</span>
00463 
00464     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Thread );
00465 
00466     <span class="comment">//</span>
00467     <span class="comment">// Make sure there is a token</span>
00468     <span class="comment">//</span>
00469 
00470     <span class="keywordflow">if</span> ((*Token) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00471         <span class="keywordflow">return</span> STATUS_NO_TOKEN;
00472     }
00473 
00474     <span class="comment">//</span>
00475     <span class="comment">//  Make sure the ImpersonationLevel is high enough to allow</span>
00476     <span class="comment">//  the token to be openned.</span>
00477     <span class="comment">//</span>
00478 
00479     <span class="keywordflow">if</span> ((*ImpersonationLevel) &lt;= SecurityAnonymous) {
00480         <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( (*Token) );
00481         (*Token) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00482         <span class="keywordflow">return</span> STATUS_CANT_OPEN_ANONYMOUS;
00483     }
00484 
00485 
00486     <span class="keywordflow">return</span> STATUS_SUCCESS;
00487 
00488 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="ps/security.c::PspAssignPrimaryToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspAssignPrimaryToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACCESS_TOKEN TokenPointer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01256">1256</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00661">PsFreeProcessSecurityFields</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00654">PsLockProcessSecurityFields</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00346">SeExchangePrimaryToken()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01213">SeTokenObjectType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l00366">PspSetPrimaryToken()</a>.
<p>
<pre class="fragment"><div>01264                    :
01265 
01266     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security portions of primary token assignment.
01267     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proper access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process and thread objects,
01268     as well as necessary privilege, has already been established.
01269 
01270     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> primary token can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be replaced <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process has no threads, or
01271     has one thread.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> because <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread objects point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary
01272     token and must have those pointers updated when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01273     changed.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> expected to be necessary at logon time, when
01274     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in its infancy and either has zero threads or maybe one
01275     inactive thread.
01276 
01277     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> assignment <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dereferenced and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01278     <span class="keyword">new</span> one <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> referenced.
01279 
01280 
01281 
01282 Arguments:
01283 
01284     Process - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose primary token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
01285         replaced.
01286 
01287     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - The handle value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to be assigned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary
01288         token.
01289 
01290 
01291 Return Value:
01292 
01293     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token has been successfully
01294         replaced.
01295 
01296     STATUS_BAD_TOKEN_TYPE - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> TokenPrimary.
01297 
01298     STATUS_TOKEN_IN_USE - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already in use by
01299         another process.
01300 
01301     Other status may be returned when attempting to reference <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token
01302     object.
01303 
01304 --*/
01305 
01306 {
01307     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01308         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01309 
01310     PACCESS_TOKEN
01311         NewToken,
01312         OldToken;
01313 
01314     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>
01315         PreviousMode;
01316 
01317 
01318     <span class="keywordflow">if</span> ( TokenPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
01319     {
01320         PreviousMode = KeGetPreviousMode();
01321 
01322         <span class="comment">//</span>
01323         <span class="comment">// Reference the specified token, and make sure it can be assigned</span>
01324         <span class="comment">// as a primary token.</span>
01325         <span class="comment">//</span>
01326 
01327         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
01328                     Token,
01329                     TOKEN_ASSIGN_PRIMARY,
01330                     <a class="code" href="../../d0/d5/se_8h.html#a17">SeTokenObjectType</a>(),
01331                     PreviousMode,
01332                     (PVOID *)&amp;NewToken,
01333                     NULL
01334                     );
01335 
01336         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01337             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01338         }
01339     }
01340     <span class="keywordflow">else</span>
01341     {
01342         NewToken = TokenPointer ;
01343     }
01344 
01345 
01346     <span class="comment">//</span>
01347     <span class="comment">//  Lock the process security fields.</span>
01348     <span class="comment">//</span>
01349 
01350     <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
01351 
01352 
01353 
01354 
01355 
01356     <span class="comment">//</span>
01357     <span class="comment">// This routine makes sure the NewToken is suitable for assignment</span>
01358     <span class="comment">// as a primary token.</span>
01359     <span class="comment">//</span>
01360 
01361     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a9">SeExchangePrimaryToken</a>( Process, NewToken, &amp;OldToken );
01362 
01363 
01364     <span class="comment">//</span>
01365     <span class="comment">//  Release the process security fields</span>
01366     <span class="comment">//</span>
01367 
01368     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
01369 
01370     <span class="comment">//</span>
01371     <span class="comment">// Free the old token (we don't need it).</span>
01372     <span class="comment">// This can't be done while the security fields are locked.</span>
01373     <span class="comment">//</span>
01374 
01375     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01376 
01377         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( OldToken );
01378     }
01379 
01380     <span class="comment">//</span>
01381     <span class="comment">// Undo the handle reference</span>
01382     <span class="comment">//</span>
01383 
01384     <span class="keywordflow">if</span> ( TokenPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
01385     {
01386         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
01387     }
01388 
01389 
01390     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01391 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="ps/security.c::PspDeleteProcessSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspDeleteProcessSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01206">1206</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d2/token_8c-source.html#l00302">SeDeassignPrimaryToken()</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>.
<p>
<pre class="fragment"><div>01212                    :
01213 
01214     This function cleans up a process's security fields as part of process
01215     deletion.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed no other references to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process can occur
01216     during or after a call to <span class="keyword">this</span> routine.  This enables us to reference
01217     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process security fields without acquiring <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock protecting those
01218     fields.
01219 
01220     NOTE: It may be desirable to add auditing capability to <span class="keyword">this</span> routine
01221           at some point.
01222 
01223 
01224 Arguments:
01225 
01226     Process - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process being deleted.
01227 
01228 
01229 Return Value:
01230 
01231     None.
01232 
01233 --*/
01234 
01235 {
01236 
01237 
01238 
01239 
01240     <span class="comment">//</span>
01241     <span class="comment">// If we are deleting a process that didn't successfully complete</span>
01242     <span class="comment">// process initialization, then there may be no token associated</span>
01243     <span class="comment">// with it yet.</span>
01244     <span class="comment">//</span>
01245 
01246     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Process-&gt;Token)) {
01247         <a class="code" href="../../d4/d3/token_8c.html#a8">SeDeassignPrimaryToken</a>( Process );
01248         Process-&gt;Token = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01249     }
01250 
01251     <span class="keywordflow">return</span>;
01252 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="ps/security.c::PspDeleteThreadSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspDeleteThreadSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Thread</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01436">1436</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01438">PspThreadDelete()</a>.
<p>
<pre class="fragment"><div>01442                    :
01443 
01444     This function cleans up a thread's security fields as part of thread
01445     deletion.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed no other references to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread can occur
01446     during or after a call to <span class="keyword">this</span> routine, so no locking <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary
01447     to access <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread security fields.
01448 
01449 
01450 Arguments:
01451 
01452     Thread - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread being deleted.
01453 
01454 
01455 Return Value:
01456 
01457     None.
01458 
01459 --*/
01460 
01461 {
01462 
01463     <span class="comment">//</span>
01464     <span class="comment">// clean-up client information, if there is any.</span>
01465     <span class="comment">//</span>
01466 
01467     <span class="keywordflow">if</span> ( Thread-&gt;ActiveImpersonationInfo ) {
01468         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Thread-&gt;ImpersonationInfo-&gt;Token );
01469     }
01470 
01471     <span class="keywordflow">if</span> ( Thread-&gt;ImpersonationInfo ) {
01472         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Thread-&gt;ImpersonationInfo );
01473         Thread-&gt;ActiveImpersonationInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01474         Thread-&gt;ImpersonationInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01475     }
01476 
01477     <span class="keywordflow">return</span>;
01478 
01479 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ps/security.c::PspInitializeProcessSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspInitializeProcessSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Parent&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Child</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01117">1117</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00106">PspBootAccessToken</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00241">SeAssignPrimaryToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l01327">SeSubProcessToken()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>01124                    :
01125 
01126     This function initializes a <span class="keyword">new</span> process's security fields, including
01127     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> assignment of a <span class="keyword">new</span> primary token.
01128 
01129     The child process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to not yet have been inserted into
01130     an object table.
01131 
01132     NOTE: IT IS EXPECTED THAT THIS SERVICE WILL BE CALLED WITH <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01133           PARENT PROCESS POINTER EXACTLY ONCE - FOR THE INITIAL SYSTEM
01134           PROCESS.
01135 
01136 
01137 Arguments:
01138 
01139     Parent - An optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process being used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent
01140         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process.  If <span class="keyword">this</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01141         assumed to be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial system process, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01142         assigned rather than a duplicate of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent process's primary
01143         token.
01144 
01145     Child - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process being initialized.  This
01146         process does not yet require security field contention protection.
01147         In particular, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security fields may be accessed without first
01148         acquiring <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process security fields lock.
01149 
01150 
01151 
01152 Return Value:
01153 
01154 
01155 --*/
01156 
01157 {
01158     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01159         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01160 
01161 
01162     <span class="comment">//</span>
01163     <span class="comment">// Assign the primary token</span>
01164     <span class="comment">//</span>
01165 
01166     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Parent)) {
01167 
01168         <span class="comment">//</span>
01169         <span class="comment">// create the primary token</span>
01170         <span class="comment">// This is a duplicate of the parent's token.</span>
01171         <span class="comment">//</span>
01172 
01173         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a13">SeSubProcessToken</a>(
01174                      Parent,
01175                      &amp;Child-&gt;Token
01176                      );
01177 
01178         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01179             Child-&gt;Token = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;       <span class="comment">// Needed to ensure proper deletion</span>
01180         }
01181 
01182     } <span class="keywordflow">else</span> {
01183 
01184         <span class="comment">//</span>
01185         <span class="comment">//  Reference and assign the boot token</span>
01186         <span class="comment">//</span>
01187         <span class="comment">//  The use of a single boot access token assumes there is</span>
01188         <span class="comment">//  exactly one parentless process in the system - the initial</span>
01189         <span class="comment">//  process.  If this ever changes, this code will need to change</span>
01190         <span class="comment">//  to match the new condition (so that a token doesn't end up</span>
01191         <span class="comment">//  being shared by multiple processes.</span>
01192         <span class="comment">//</span>
01193 
01194         Child-&gt;Token = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01195         <a class="code" href="../../d4/d3/token_8c.html#a7">SeAssignPrimaryToken</a>( Child, PspBootAccessToken );
01196         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01197 
01198 
01199     }
01200 
01201     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01202 
01203 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="ps/security.c::PspInitializeThreadSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspInitializeThreadSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01395">1395</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>.
<p>
<pre class="fragment"><div>01402                    :
01403 
01404     This function initializes a <span class="keyword">new</span> thread's security fields.
01405 
01406 
01407 Arguments:
01408 
01409     Process - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread belongs to.
01410 
01411     Thread - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread object being initialized.
01412 
01413 
01414 Return Value:
01415 
01416     None.
01417 
01418 --*/
01419 
01420 {
01421 
01422 
01423     <span class="comment">//</span>
01424     <span class="comment">// Initially not impersonating anyone.</span>
01425     <span class="comment">//</span>
01426 
01427     Thread-&gt;ImpersonationInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01428     Thread-&gt;ActiveImpersonationInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01429 
01430     <span class="keywordflow">return</span>;
01431 
01432 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ps/security.c::PsReferenceEffectiveToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PACCESS_TOKEN PsReferenceEffectiveToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PTOKEN_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>EffectiveOnly</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_IMPERSONATION_LEVEL&nbsp;</td>
          <td class="mdname" nowrap> <em>ImpersonationLevel</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00208">208</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00661">PsFreeProcessSecurityFields</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00654">PsLockProcessSecurityFields</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, <a class="el" href="../../d4/d9/ke_8h.html#a402a163">ThreadObject</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/seclient_8c-source.html#l00209">SeCreateClientSecurity()</a>.
<p>
<pre class="fragment"><div>00217                    :
00218 
00219     This function returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> effective token of a thread.  The
00220     effective token of a thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's impersonation token <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> has
00221     one.  Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's process.
00222 
00223     The reference count of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> effective token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incremented to protect
00224     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer returned.
00225 
00226     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> impersonating a client, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation level
00227     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> also returned.
00228 
00229     Either <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>() (<span class="keywordflow">for</span> an impersonation token) or
00230     <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>() (<span class="keywordflow">for</span> a primary token) must be called to
00231     decrement <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token's reference count when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no longer
00232     needed.
00233 
00234 
00235 Arguments:
00236 
00237     Thread - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread whose effective token
00238         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be referenced.
00239 
00240     TokenType - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> effective token.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread
00241         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently impersonating a client, then <span class="keyword">this</span> will be
00242         TokenImpersonation.  Othwerwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will be TokenPrimary.
00243 
00244     EffectiveOnly - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> TokenImpersonation, then <span class="keyword">this</span>
00245         receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client thread's Thread-&gt;Client-&gt;EffectiveOnly field.
00246         Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00247 
00248     ImpersonationLevel - The current value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Thread-&gt;Client-&gt;ImpersonationLevel
00249         field <span class="keywordflow">for</span> an impersonation token and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not set <span class="keywordflow">for</span> a primary token.
00250 
00251 Return Value:
00252 
00253     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread's effective token.
00254 
00255 --*/
00256 
00257 {
00258     PACCESS_TOKEN
00259         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00260 
00261     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Thread-&gt;Tcb.Header.Type == ThreadObject );
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">//  Lock the process security fields.</span>
00265     <span class="comment">//</span>
00266 
00267     <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
00268 
00269     <span class="comment">//</span>
00270     <span class="comment">//  Grab the current impersonation token pointer value</span>
00271     <span class="comment">//</span>
00272 
00273 
00274     <span class="keywordflow">if</span> ( Thread-&gt;ActiveImpersonationInfo ) {
00275 
00276         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = Thread-&gt;ImpersonationInfo-&gt;Token;
00277 
00278         <span class="comment">//</span>
00279         <span class="comment">//  Return the thread's impersonation level, etc.</span>
00280         <span class="comment">//</span>
00281 
00282         (*TokenType) = TokenImpersonation;
00283         (*EffectiveOnly) = Thread-&gt;ImpersonationInfo-&gt;EffectiveOnly;
00284         (*ImpersonationLevel) = Thread-&gt;ImpersonationInfo-&gt;ImpersonationLevel;
00285 
00286 
00287 
00288     } <span class="keywordflow">else</span> {
00289 
00290         <span class="comment">//</span>
00291         <span class="comment">// Get the thread's primary token if it wasn't impersonating a client.</span>
00292         <span class="comment">//</span>
00293 
00294         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread)-&gt;Token;
00295 
00296 
00297         <span class="comment">//</span>
00298         <span class="comment">//  Only the TokenType and CopyOnOpen OUT parameters are</span>
00299         <span class="comment">//  returned for a primary token.</span>
00300         <span class="comment">//</span>
00301 
00302         (*TokenType) = TokenPrimary;
00303         (*EffectiveOnly) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00304 
00305     }
00306 
00307     <span class="comment">//</span>
00308     <span class="comment">//  Increment the reference count of the token to protect our</span>
00309     <span class="comment">//  pointer.</span>
00310     <span class="comment">//</span>
00311 
00312     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Token);
00313 
00314     <span class="comment">//</span>
00315     <span class="comment">//  Release the security fields.</span>
00316     <span class="comment">//</span>
00317 
00318     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
00319 
00320 
00321     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00322 
00323 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ps/security.c::PsReferenceImpersonationToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PACCESS_TOKEN PsReferenceImpersonationToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CopyOnOpen</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>EffectiveOnly</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_IMPERSONATION_LEVEL&nbsp;</td>
          <td class="mdname" nowrap> <em>ImpersonationLevel</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00097">97</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00661">PsFreeProcessSecurityFields</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00654">PsLockProcessSecurityFields</a>, <a class="el" href="../../d4/d9/ke_8h.html#a402a163">ThreadObject</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/ex_8c-source.html#l00050">GetProcessLuid()</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00095">IsRestricted()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00326">PsOpenTokenOfThread()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, and <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00294">SepOpenTokenOfThread()</a>.
<p>
<pre class="fragment"><div>00106                    :
00107 
00108     This function returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation token of a thread.
00109     The reference count of that impersonation token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incremented to protect
00110     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer returned.
00111 
00112     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not currently impersonating a client, then a null pointer
00113     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00114 
00115     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> impersonating a client, then information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00116     means of impersonation are also returned (ImpersonationLevel).
00117 
00118     If a non-null value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned, then <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>()
00119     must be called to decrement the token's reference count when the pointer
00120     is no longer needed.
00121 
00122 
00123 Arguments:
00124 
00125     Thread - Supplies the address of the thread whose impersonation token
00126         is to be referenced.
00127 
00128     CopyOnOpen - The current value of the Thread-&gt;ImpersonationInfo-&gt;CopyOnOpen field.
00129 
00130     EffectiveOnly - The current value of the Thread-&gt;ImpersonationInfo-&gt;EffectiveOnly field.
00131 
00132     ImpersonationLevel - The current value of the Thread-&gt;ImpersonationInfo-&gt;ImpersonationLevel
00133         field.
00134 
00135 Return Value:
00136 
00137     A pointer to the specified thread's impersonation token.
00138 
00139     If the thread is not currently impersonating a client, then NULL is
00140     returned.
00141 
00142 --*/
00143 
00144 {
00145     PACCESS_TOKEN
00146         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00147 
00148     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Thread-&gt;Tcb.Header.Type == ThreadObject );
00149     <span class="comment">//</span>
00150     <span class="comment">// before going through the lock overhead just look to see if it is</span>
00151     <span class="comment">// null. There is no race.  Grabbing the lock is not needed until</span>
00152     <span class="comment">// we decide to use the token at which point we re check to see it</span>
00153     <span class="comment">// it is null.</span>
00154     <span class="comment">// This check saves about 300 instructions.</span>
00155     <span class="comment">//</span>
00156 
00157     <span class="keywordflow">if</span> ( !Thread-&gt;ActiveImpersonationInfo ) {
00158         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00159     }
00160 
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">//  Lock the process security fields.</span>
00164     <span class="comment">//</span>
00165 
00166     <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
00167 
00168     <span class="comment">//</span>
00169     <span class="comment">//  Grab the current token pointer value</span>
00170     <span class="comment">//</span>
00171 
00172 
00173     <span class="keywordflow">if</span> ( Thread-&gt;ActiveImpersonationInfo ) {
00174 
00175         <span class="comment">//</span>
00176         <span class="comment">//  Return the thread's impersonation level, etc.</span>
00177         <span class="comment">//</span>
00178 
00179         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = Thread-&gt;ImpersonationInfo-&gt;Token;
00180         (*ImpersonationLevel) = Thread-&gt;ImpersonationInfo-&gt;ImpersonationLevel;
00181         (*CopyOnOpen) = Thread-&gt;ImpersonationInfo-&gt;CopyOnOpen;
00182         (*EffectiveOnly) = Thread-&gt;ImpersonationInfo-&gt;EffectiveOnly;
00183 
00184 
00185         <span class="comment">//</span>
00186         <span class="comment">//  Increment the reference count of the token to protect our</span>
00187         <span class="comment">//  pointer.</span>
00188         <span class="comment">//</span>
00189 
00190         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Token);
00191 
00192     } <span class="keywordflow">else</span> {
00193         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00194     }
00195 
00196 
00197     <span class="comment">//</span>
00198     <span class="comment">//  Release the security fields.</span>
00199     <span class="comment">//</span>
00200 
00201     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
00202 
00203     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00204 
00205 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="ps/security.c::PsReferencePrimaryToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PACCESS_TOKEN PsReferencePrimaryToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00028">28</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d4/d9/ke_8h.html#a402a160">ProcessObject</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00661">PsFreeProcessSecurityFields</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00654">PsLockProcessSecurityFields</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/queue_8c-source.html#l00222">CheckAllowForeground()</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00050">GetProcessLuid()</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00095">IsRestricted()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>, <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00492">PsOpenTokenOfProcess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00366">PspSetPrimaryToken()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02867">SeIsChildToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02960">SeIsChildTokenByPointer()</a>, and <a class="el" href="../../d5/d2/token_8c-source.html#l01327">SeSubProcessToken()</a>.
<p>
<pre class="fragment"><div>00034                    :
00035 
00036     This function returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token of a process.
00037     The reference count of that primary token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incremented to protect
00038     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer returned.
00039 
00040     When <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no longer needed, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> should be freed <span class="keyword">using</span>
00041     <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>().
00042 
00043 
00044 Arguments:
00045 
00046     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose primary token
00047         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be referenced.
00048 
00049 Return Value:
00050 
00051     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process's primary token.
00052 
00053 --*/
00054 
00055 {
00056     PACCESS_TOKEN
00057         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00058 
00059     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Process-&gt;Pcb.Header.Type == ProcessObject );
00060 
00061     <span class="comment">//</span>
00062     <span class="comment">//  For performance sake, we may want to change this to use</span>
00063     <span class="comment">//  an executive interlocked add routine in the future.</span>
00064     <span class="comment">//</span>
00065 
00066 
00067     <span class="comment">//</span>
00068     <span class="comment">//  Lock the process security fields.</span>
00069     <span class="comment">//</span>
00070 
00071     <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
00072 
00073     <span class="comment">//</span>
00074     <span class="comment">//  Grab the current token pointer value</span>
00075     <span class="comment">//</span>
00076 
00077     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = Process-&gt;Token;
00078 
00079     <span class="comment">//</span>
00080     <span class="comment">//  Increment the reference count of the primary token to protect our</span>
00081     <span class="comment">//  pointer.</span>
00082     <span class="comment">//</span>
00083 
00084     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Token);
00085 
00086     <span class="comment">//</span>
00087     <span class="comment">//  Release the process security fields</span>
00088     <span class="comment">//</span>
00089 
00090     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
00091 
00092     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00093 
00094 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ps/security.c::PsRestoreImpersonation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PsRestoreImpersonation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSE_IMPERSONATION_STATE&nbsp;</td>
          <td class="mdname" nowrap> <em>ImpersonationState</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00990">990</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, and <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00650">PsImpersonateClient()</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00326">PsOpenTokenOfThread()</a>, and <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00294">SepOpenTokenOfThread()</a>.
<p>
<pre class="fragment"><div>00997                    :
00998 
00999     This routine restores an impersonation that has been temporarily disabled
01000     <span class="keyword">using</span> <a class="code" href="../../d6/d5/ps_2security_8c.html#a7">PsDisableImpersonation</a>().
01001 
01002     Notice that <span class="keywordflow">if</span> <span class="keyword">this</span> routine finds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already impersonating
01003     (again), then restoring <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> temporarily disabled impersonation will cause
01004     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current impersonation to be abandoned.
01005 
01006 
01007 
01008 Arguments:
01009 
01010     Thread - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread whose impersonation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be restored.
01011 
01012     ImpersontionState - receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current impersontion information,
01013         including a pointer ot <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation token.
01014 
01015 
01016 Return Value:
01017 
01018     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation state has been saved and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01019         impersonation has been temporarily disabled.
01020 
01021     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread was not impersonating a client.
01022        No action has been taken.
01023 
01024 --*/
01025 
01026 {
01027 
01028 
01029     <span class="comment">//</span>
01030     <span class="comment">// The processing for restore is identical to that for Impersonation,</span>
01031     <span class="comment">// except that the token's reference count will be incremented (and</span>
01032     <span class="comment">// so we need to do one dereference).</span>
01033 
01034     <a class="code" href="../../d6/d5/ps_2security_8c.html#a6">PsImpersonateClient</a>(
01035         Thread,
01036         ImpersonationState-&gt;Token,
01037         ImpersonationState-&gt;CopyOnOpen,
01038         ImpersonationState-&gt;EffectiveOnly,
01039         ImpersonationState-&gt;Level
01040         );
01041 
01042 
01043     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ImpersonationState-&gt;Token );
01044 
01045     <span class="keywordflow">return</span>;
01046 
01047 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ps/security.c::PsRevertToSelf" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PsRevertToSelf           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01051">1051</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00450">_ETHREAD::ActiveImpersonationInfo</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00407">_ETHREAD::ImpersonationInfo</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00661">PsFreeProcessSecurityFields</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00654">PsLockProcessSecurityFields</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00092">_PS_IMPERSONATION_INFORMATION::Token</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.
<p>
<pre class="fragment"><div>01055                    :
01056 
01057     This routine causes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling thread to discontinue
01058     impersonating a client.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not currently
01059     impersonating a client, no action <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> taken.
01060 
01061 Arguments:
01062 
01063     None.
01064 
01065 Return Value:
01066 
01067     None.
01068 
01069 --*/
01070 
01071 {
01072     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>
01073         Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01074 
01075     PACCESS_TOKEN OldToken;
01076 
01077     <span class="comment">//</span>
01078     <span class="comment">//  Lock the process security fields</span>
01079     <span class="comment">//</span>
01080 
01081     <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
01082 
01083     <span class="comment">//</span>
01084     <span class="comment">//  See if the thread is impersonating a client</span>
01085     <span class="comment">//  and dereference that token if so.</span>
01086     <span class="comment">//</span>
01087 
01088     <span class="keywordflow">if</span> ( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o35">ActiveImpersonationInfo</a> ) {
01089 
01090         Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o35">ActiveImpersonationInfo</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01091         OldToken = Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o17">ImpersonationInfo</a>-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o0">Token</a>;
01092     } <span class="keywordflow">else</span> {
01093         OldToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01094     }
01095 
01096 
01097     <span class="comment">//</span>
01098     <span class="comment">//  Release the security fields</span>
01099     <span class="comment">//</span>
01100 
01101     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
01102 
01103 
01104     <span class="comment">//</span>
01105     <span class="comment">// Free the old client info...</span>
01106     <span class="comment">//</span>
01107 
01108     <span class="keywordflow">if</span> ( OldToken ) {
01109         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( OldToken );
01110     }
01111 
01112     <span class="keywordflow">return</span>;
01113 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
