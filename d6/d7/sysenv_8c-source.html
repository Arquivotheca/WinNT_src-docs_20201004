<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: sysenv.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sysenv.c</h1><a href="../../d5/d8/sysenv_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    sysenv.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the NT query and set system environment</span>
00012 <span class="comment">    variable services.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    David N. Cutler (davec) 10-Nov-1991</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00023 <span class="preprocessor">#pragma hdrstop</span>
00024 <span class="preprocessor"></span>
00025 <span class="preprocessor">#include "<a class="code" href="../../d2/d9/arccodes_8h.html">arccodes.h</a>"</span>
00026 
00027 <span class="preprocessor">#if defined(ALLOC_PRAGMA)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtQuerySystemEnvironmentValue)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtSetSystemEnvironmentValue)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00031 <span class="preprocessor"></span>
00032 <span class="comment">//</span>
00033 <span class="comment">// Define maximum size of environment value.</span>
00034 <span class="comment">//</span>
00035 
<a name="l00036"></a><a class="code" href="../../d5/d8/sysenv_8c.html#a0">00036</a> <span class="preprocessor">#define MAXIMUM_ENVIRONMENT_VALUE 1024</span>
00037 <span class="preprocessor"></span>
00038 <span class="comment">//</span>
00039 <span class="comment">// Define query/set environment variable synchronization fast mutex.</span>
00040 <span class="comment">//</span>
00041 
<a name="l00042"></a><a class="code" href="../../d5/d8/sysenv_8c.html#a1">00042</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d4/d0/exp_8h.html#a10">ExpEnvironmentLock</a>;
00043 
00044 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00045"></a><a class="code" href="../../d5/d8/sysenv_8c.html#a2">00045</a> <a class="code" href="../../d5/d8/sysenv_8c.html#a2">NtQuerySystemEnvironmentValue</a> (
00046     IN PUNICODE_STRING VariableName,
00047     OUT PWSTR VariableValue,
00048     IN USHORT ValueLength,
00049     OUT PUSHORT ReturnLength OPTIONAL
00050     )
00051 
00052 <span class="comment">/*++</span>
00053 <span class="comment"></span>
00054 <span class="comment">Routine Description:</span>
00055 <span class="comment"></span>
00056 <span class="comment">    This function locates the specified system environment variable and</span>
00057 <span class="comment">    return its value.</span>
00058 <span class="comment"></span>
00059 <span class="comment">    N.B. This service requires the system environment privilege.</span>
00060 <span class="comment"></span>
00061 <span class="comment">Arguments:</span>
00062 <span class="comment"></span>
00063 <span class="comment">    Variable - Supplies a pointer to a UNICODE descriptor for the specified</span>
00064 <span class="comment">        system environment variable.</span>
00065 <span class="comment"></span>
00066 <span class="comment">    Value - Supplies a pointer to a buffer that receives the value of the</span>
00067 <span class="comment">        specified system environment variable.</span>
00068 <span class="comment"></span>
00069 <span class="comment">    ValueLength - Supplies the length of the value buffer in bytes.</span>
00070 <span class="comment"></span>
00071 <span class="comment">    ReturnLength - Supplies an optional pointer to a variable that receives</span>
00072 <span class="comment">        the length of the system environment variable value.</span>
00073 <span class="comment"></span>
00074 <span class="comment">Return Value:</span>
00075 <span class="comment"></span>
00076 <span class="comment">    STATUS_SUCCESS is returned if the service is successfully executed.</span>
00077 <span class="comment"></span>
00078 <span class="comment">    STATUS_PRIVILEGE_NOT_HELD is returned if the caller does not have the</span>
00079 <span class="comment">        privilege to query a system environment variable.</span>
00080 <span class="comment"></span>
00081 <span class="comment">    STATUS_ACCESS_VIOLATION is returned if the output parameter for the</span>
00082 <span class="comment">        system environment value or the return length cannot be written,</span>
00083 <span class="comment">        or the descriptor or the name of the system environment variable</span>
00084 <span class="comment">        cannot be read.</span>
00085 <span class="comment"></span>
00086 <span class="comment">    STATUS_INSUFFICIENT_RESOURCES - Insufficient system resources exist</span>
00087 <span class="comment">        for this request to complete.</span>
00088 <span class="comment"></span>
00089 <span class="comment">    STATUS_UNSUCCESSFUL - The specified environment variable could not</span>
00090 <span class="comment">        be located.</span>
00091 <span class="comment"></span>
00092 <span class="comment">--*/</span>
00093 
00094 {
00095 
00096     ULONG AnsiLength;
00097     ANSI_STRING AnsiString;
00098     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> ArcStatus;
00099     BOOLEAN HasPrivilege;
00100     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NtStatus;
00101     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00102     UNICODE_STRING UnicodeString;
00103     PCHAR <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>;
00104 
00105     <span class="comment">//</span>
00106     <span class="comment">// Clear address of ANSI buffer.</span>
00107     <span class="comment">//</span>
00108 
00109     AnsiString.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00110 
00111     <span class="comment">//</span>
00112     <span class="comment">// Establish an exception handler and attempt to probe and read the</span>
00113     <span class="comment">// name of the specified system environment variable, and probe the</span>
00114     <span class="comment">// variable value buffer and return length. If the probe or read</span>
00115     <span class="comment">// attempt fails, then return the exception code as the service status.</span>
00116     <span class="comment">//</span>
00117 
00118     <span class="keywordflow">try</span> {
00119 
00120         <span class="comment">//</span>
00121         <span class="comment">// Get previous processor mode and probe arguments if necessary.</span>
00122         <span class="comment">//</span>
00123 
00124         PreviousMode = KeGetPreviousMode();
00125         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00126 
00127             <span class="comment">//</span>
00128             <span class="comment">// Probe and capture the string descriptor for the system</span>
00129             <span class="comment">// environment variable name.</span>
00130             <span class="comment">//</span>
00131 
00132             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>((PVOID)VariableName,
00133                          <span class="keyword">sizeof</span>(UNICODE_STRING),
00134                          <span class="keyword">sizeof</span>(ULONG));
00135 
00136             UnicodeString = *VariableName;
00137 
00138             <span class="comment">//</span>
00139             <span class="comment">// Probe the system environment variable name.</span>
00140             <span class="comment">//</span>
00141 
00142             <span class="keywordflow">if</span> (UnicodeString.Length == 0) {
00143                 <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00144             }
00145 
00146             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>((PVOID)UnicodeString.Buffer,
00147                          UnicodeString.Length,
00148                          <span class="keyword">sizeof</span>(WCHAR));
00149 
00150             <span class="comment">//</span>
00151             <span class="comment">// Probe the system environment value buffer.</span>
00152             <span class="comment">//</span>
00153 
00154             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)VariableValue, ValueLength, <span class="keyword">sizeof</span>(WCHAR));
00155 
00156             <span class="comment">//</span>
00157             <span class="comment">// If argument is present, probe the return length value.</span>
00158             <span class="comment">//</span>
00159 
00160             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00161                 <a class="code" href="../../d5/d8/ex_8h.html#a34">ProbeForWriteUshort</a>(ReturnLength);
00162             }
00163 
00164             <span class="comment">//</span>
00165             <span class="comment">// Check if the current thread has the privilege to query a system</span>
00166             <span class="comment">// environment variable.</span>
00167             <span class="comment">//</span>
00168 
00169             HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a99">SeSystemEnvironmentPrivilege</a>,
00170                                               PreviousMode);
00171 
00172             <span class="keywordflow">if</span> (HasPrivilege == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00173                 <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
00174             }
00175 
00176         } <span class="keywordflow">else</span> {
00177             UnicodeString = *VariableName;
00178         }
00179 
00180 
00181         <span class="comment">//</span>
00182         <span class="comment">// Compute the size of the ANSI variable name, allocate a nonpaged</span>
00183         <span class="comment">// buffer, and convert the specified UNICODE variable name to ANSI.</span>
00184         <span class="comment">//</span>
00185 
00186         AnsiLength = RtlUnicodeStringToAnsiSize(&amp;UnicodeString);
00187         AnsiString.Buffer = (PCHAR)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, AnsiLength, 'rvnE');
00188         <span class="keywordflow">if</span> (AnsiString.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00189             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00190         }
00191 
00192         AnsiString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)AnsiLength;
00193         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>(&amp;AnsiString,
00194                                                 &amp;UnicodeString,
00195                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00196 
00197         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00198             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)AnsiString.Buffer);
00199             <span class="keywordflow">return</span> NtStatus;
00200         }
00201 
00202     <span class="comment">//</span>
00203     <span class="comment">// If an exception occurs during the read of the variable descriptor,</span>
00204     <span class="comment">// the read of the variable name, the probe of the variable value, or</span>
00205     <span class="comment">// the probe of the return length, then always handle the exception,</span>
00206     <span class="comment">// free the ANSI string buffer if necessary, and return the exception</span>
00207     <span class="comment">// code as the status value.</span>
00208     <span class="comment">//</span>
00209 
00210     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00211         <span class="keywordflow">if</span> (AnsiString.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00212             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)AnsiString.Buffer);
00213         }
00214 
00215         <span class="keywordflow">return</span> GetExceptionCode();
00216     }
00217 
00218     <span class="comment">//</span>
00219     <span class="comment">// Allocate nonpaged pool to receive variable value.</span>
00220     <span class="comment">//</span>
00221 
00222     <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> = (PCHAR)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="code" href="../../d4/d9/arcinst_8h.html#a38">MAXIMUM_ENVIRONMENT_VALUE</a>, 'rvnE');
00223     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00224         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)AnsiString.Buffer);
00225         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00226     }
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">// Get the system environment variable value.</span>
00230     <span class="comment">//</span>
00231 
00232     ExAcquireFastMutex(&amp;<a class="code" href="../../d4/d0/exp_8h.html#a10">ExpEnvironmentLock</a>);
00233     ArcStatus = <a class="code" href="../../d2/d7/hal_8h.html#a167">HalGetEnvironmentVariable</a>(AnsiString.Buffer,
00234                                           <a class="code" href="../../d4/d9/arcinst_8h.html#a38">MAXIMUM_ENVIRONMENT_VALUE</a>,
00235                                           <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>);
00236 
00237     ExReleaseFastMutex(&amp;<a class="code" href="../../d4/d0/exp_8h.html#a10">ExpEnvironmentLock</a>);
00238 
00239     <span class="comment">//</span>
00240     <span class="comment">// Free the ANSI string buffer used to hold the variable name.</span>
00241     <span class="comment">//</span>
00242 
00243     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)AnsiString.Buffer);
00244 
00245     <span class="comment">//</span>
00246     <span class="comment">// If the specified environment variable was not found, then free</span>
00247     <span class="comment">// the value buffer and return an unsuccessful status.</span>
00248     <span class="comment">//</span>
00249 
00250     <span class="keywordflow">if</span> (ArcStatus != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00251         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>);
00252         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00253     }
00254 
00255     <span class="comment">//</span>
00256     <span class="comment">// Establish an exception handler and attempt to write the value of the</span>
00257     <span class="comment">// specified system environment variable. If the write attempt fails,</span>
00258     <span class="comment">// then return the exception code as the service status.</span>
00259     <span class="comment">//</span>
00260 
00261     <span class="keywordflow">try</span> {
00262 
00263         <span class="comment">//</span>
00264         <span class="comment">// Initialize an ANSI string descriptor, set the maximum length and</span>
00265         <span class="comment">// buffer address for a UNICODE string descriptor, and convert the</span>
00266         <span class="comment">// ANSI variable value to UNICODE.</span>
00267         <span class="comment">//</span>
00268 
00269         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>(&amp;AnsiString, <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>);
00270         UnicodeString.Buffer = (PWSTR)VariableValue;
00271         UnicodeString.MaximumLength = ValueLength;
00272         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;UnicodeString,
00273                                                 &amp;AnsiString,
00274                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00275 
00276         <span class="comment">//</span>
00277         <span class="comment">// If argument is present, then write the length of the UNICODE</span>
00278         <span class="comment">// variable value.</span>
00279         <span class="comment">//</span>
00280 
00281         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00282             *ReturnLength = UnicodeString.Length;
00283         }
00284 
00285         <span class="comment">//</span>
00286         <span class="comment">// Free the value buffer used to hold the variable value.</span>
00287         <span class="comment">//</span>
00288 
00289         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>);
00290         <span class="keywordflow">return</span> NtStatus;
00291 
00292     <span class="comment">//</span>
00293     <span class="comment">// If an exception occurs during the write of the variable value, or</span>
00294     <span class="comment">// the write of the return length, then always handle the exception</span>
00295     <span class="comment">// and return the exception code as the status value.</span>
00296     <span class="comment">//</span>
00297 
00298     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00299         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>);
00300         <span class="keywordflow">return</span> GetExceptionCode();
00301     }
00302 }
00303 
00304 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00305"></a><a class="code" href="../../d5/d8/sysenv_8c.html#a3">00305</a> <a class="code" href="../../d5/d8/sysenv_8c.html#a3">NtSetSystemEnvironmentValue</a> (
00306     IN PUNICODE_STRING VariableName,
00307     IN PUNICODE_STRING VariableValue
00308     )
00309 
00310 <span class="comment">/*++</span>
00311 <span class="comment"></span>
00312 <span class="comment">Routine Description:</span>
00313 <span class="comment"></span>
00314 <span class="comment">    This function sets the specified system environment variable to the</span>
00315 <span class="comment">    specified value.</span>
00316 <span class="comment"></span>
00317 <span class="comment">    N.B. This service requires the system environment privilege.</span>
00318 <span class="comment"></span>
00319 <span class="comment">Arguments:</span>
00320 <span class="comment"></span>
00321 <span class="comment">    Variable - Supplies a pointer to a UNICODE descriptor for the specified</span>
00322 <span class="comment">        system environment variable name.</span>
00323 <span class="comment"></span>
00324 <span class="comment">    Value - Supplies a pointer to a UNICODE descriptor for the specified</span>
00325 <span class="comment">        system environment variable value.</span>
00326 <span class="comment"></span>
00327 <span class="comment">Return Value:</span>
00328 <span class="comment"></span>
00329 <span class="comment">    STATUS_SUCCESS is returned if the service is successfully executed.</span>
00330 <span class="comment"></span>
00331 <span class="comment">    STATUS_PRIVILEGE_NOT_HELD is returned if the caller does not have the</span>
00332 <span class="comment">        privilege to set a system environment variable.</span>
00333 <span class="comment"></span>
00334 <span class="comment">    STATUS_ACCESS_VIOLATION is returned if the input parameter for the</span>
00335 <span class="comment">        system environment variable or value cannot be read.</span>
00336 <span class="comment"></span>
00337 <span class="comment">    STATUS_INSUFFICIENT_RESOURCES - Insufficient system resources exist</span>
00338 <span class="comment">        for this request to complete.</span>
00339 <span class="comment"></span>
00340 <span class="comment">--*/</span>
00341 
00342 {
00343 
00344     ULONG AnsiLength1;
00345     ULONG AnsiLength2;
00346     ANSI_STRING AnsiString1;
00347     ANSI_STRING AnsiString2;
00348     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> ArcStatus;
00349     BOOLEAN HasPrivilege;
00350     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00351     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NtStatus;
00352     UNICODE_STRING UnicodeString1;
00353     UNICODE_STRING UnicodeString2;
00354 
00355     <span class="comment">//</span>
00356     <span class="comment">// Clear address of ANSI buffers.</span>
00357     <span class="comment">//</span>
00358 
00359     AnsiString1.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00360     AnsiString2.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00361 
00362     <span class="comment">//</span>
00363     <span class="comment">// Establish an exception handler and attempt to set the value of the</span>
00364     <span class="comment">// specified system environment variable. If the read attempt for the</span>
00365     <span class="comment">// system environment variable or value fails, then return the exception</span>
00366     <span class="comment">// code as the service status. Otherwise, return either success or access</span>
00367     <span class="comment">// denied as the service status.</span>
00368     <span class="comment">//</span>
00369 
00370     <span class="keywordflow">try</span> {
00371 
00372         <span class="comment">//</span>
00373         <span class="comment">// Get previous processor mode and probe arguments if necessary.</span>
00374         <span class="comment">//</span>
00375 
00376         PreviousMode = KeGetPreviousMode();
00377         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00378 
00379             <span class="comment">//</span>
00380             <span class="comment">// Probe and capture the string descriptor for the system</span>
00381             <span class="comment">// environment variable name.</span>
00382             <span class="comment">//</span>
00383 
00384             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>((PVOID)VariableName,
00385                          <span class="keyword">sizeof</span>(UNICODE_STRING),
00386                          <span class="keyword">sizeof</span>(ULONG));
00387 
00388             UnicodeString1 = *VariableName;
00389 
00390             <span class="comment">//</span>
00391             <span class="comment">// Handle a zero length string explicitly since probing does not,</span>
00392             <span class="comment">// the error code is unusual, but it's what we would have done with</span>
00393             <span class="comment">// the HAL return code too.</span>
00394             <span class="comment">//</span>
00395 
00396             <span class="keywordflow">if</span> (UnicodeString1.Length == 0) {
00397                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00398             }
00399 
00400             <span class="comment">//</span>
00401             <span class="comment">// Probe the system environment variable name.</span>
00402             <span class="comment">//</span>
00403 
00404             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>((PVOID)UnicodeString1.Buffer,
00405                          UnicodeString1.Length,
00406                          <span class="keyword">sizeof</span>(WCHAR));
00407 
00408             <span class="comment">//</span>
00409             <span class="comment">// Probe and capture the string descriptor for the system</span>
00410             <span class="comment">// environment variable value.</span>
00411             <span class="comment">//</span>
00412 
00413             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>((PVOID)VariableValue,
00414                          <span class="keyword">sizeof</span>(UNICODE_STRING),
00415                          <span class="keyword">sizeof</span>(ULONG));
00416 
00417             UnicodeString2 = *VariableValue;
00418 
00419             <span class="comment">//</span>
00420             <span class="comment">// Handle a zero length string explicitly since probing does not</span>
00421             <span class="comment">// the error code is unusual, but it's what we would have done with</span>
00422             <span class="comment">// the HAL return code too.</span>
00423             <span class="comment">//</span>
00424 
00425             <span class="keywordflow">if</span> (UnicodeString2.Length == 0) {
00426                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00427             }
00428 
00429             <span class="comment">//</span>
00430             <span class="comment">// Probe the system environment variable value.</span>
00431             <span class="comment">//</span>
00432 
00433             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>((PVOID)UnicodeString2.Buffer,
00434                          UnicodeString2.Length,
00435                          <span class="keyword">sizeof</span>(WCHAR));
00436 
00437             <span class="comment">//</span>
00438             <span class="comment">// Check if the current thread has the privilege to query a system</span>
00439             <span class="comment">// environment variable.</span>
00440             <span class="comment">//</span>
00441 
00442             HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a99">SeSystemEnvironmentPrivilege</a>,
00443                                               PreviousMode);
00444 
00445             <span class="keywordflow">if</span> (HasPrivilege == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00446                 <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
00447             }
00448 
00449         } <span class="keywordflow">else</span> {
00450             UnicodeString1 = *VariableName;
00451             UnicodeString2 = *VariableValue;
00452         }
00453 
00454 
00455         <span class="comment">//</span>
00456         <span class="comment">// Compute the size of the ANSI variable name, allocate a nonpaged</span>
00457         <span class="comment">// buffer, and convert the specified UNICODE variable name to ANSI.</span>
00458         <span class="comment">//</span>
00459 
00460         AnsiLength1 = RtlUnicodeStringToAnsiSize(&amp;UnicodeString1);
00461         AnsiString1.Buffer = (PCHAR)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, AnsiLength1, 'rvnE');
00462         <span class="keywordflow">if</span> (AnsiString1.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00463             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00464         }
00465 
00466         AnsiString1.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)AnsiLength1;
00467         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>(&amp;AnsiString1,
00468                                                 &amp;UnicodeString1,
00469                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00470 
00471         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00472             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)AnsiString1.Buffer);
00473             <span class="keywordflow">return</span> NtStatus;
00474         }
00475 
00476         <span class="comment">//</span>
00477         <span class="comment">// Compute the size of the ANSI variable value, allocate a nonpaged</span>
00478         <span class="comment">// buffer, and convert the specified UNICODE variable value to ANSI.</span>
00479         <span class="comment">//</span>
00480 
00481         AnsiLength2 = RtlUnicodeStringToAnsiSize(&amp;UnicodeString2);
00482         AnsiString2.Buffer = (PCHAR)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, AnsiLength2, 'rvnE');
00483         <span class="keywordflow">if</span> (AnsiString2.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00484             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)AnsiString1.Buffer);
00485             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00486         }
00487 
00488         AnsiString2.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)AnsiLength2;
00489         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>(&amp;AnsiString2,
00490                                                 &amp;UnicodeString2,
00491                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00492 
00493         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00494             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)AnsiString1.Buffer);
00495             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)AnsiString2.Buffer);
00496             <span class="keywordflow">return</span> NtStatus;
00497         }
00498 
00499     <span class="comment">//</span>
00500     <span class="comment">// If an exception occurs during the read of the variable descriptor,</span>
00501     <span class="comment">// the read of the variable name, the read of the value descriptor, or</span>
00502     <span class="comment">// the read of the value, then always handle the exception, free the</span>
00503     <span class="comment">// ANSI string buffers if necessary, and return the exception code as</span>
00504     <span class="comment">// the status value.</span>
00505     <span class="comment">//</span>
00506 
00507     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00508         <span class="keywordflow">if</span> (AnsiString1.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00509             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)AnsiString1.Buffer);
00510         }
00511 
00512         <span class="keywordflow">if</span> (AnsiString2.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00513             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)AnsiString2.Buffer);
00514         }
00515 
00516         <span class="keywordflow">return</span> GetExceptionCode();
00517     }
00518 
00519     <span class="comment">//</span>
00520     <span class="comment">// Set the system environment variable value.</span>
00521     <span class="comment">//</span>
00522 
00523     ExAcquireFastMutex(&amp;<a class="code" href="../../d4/d0/exp_8h.html#a10">ExpEnvironmentLock</a>);
00524     ArcStatus = <a class="code" href="../../d2/d7/hal_8h.html#a168">HalSetEnvironmentVariable</a>(AnsiString1.Buffer,
00525                                           AnsiString2.Buffer);
00526 
00527     ExReleaseFastMutex(&amp;<a class="code" href="../../d4/d0/exp_8h.html#a10">ExpEnvironmentLock</a>);
00528 
00529     <span class="comment">//</span>
00530     <span class="comment">// Free the ANSI string buffers used to hold the variable name and value.</span>
00531     <span class="comment">//</span>
00532 
00533     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)AnsiString1.Buffer);
00534     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)AnsiString2.Buffer);
00535 
00536     <span class="comment">//</span>
00537     <span class="comment">// If the specified value of the specified environment variable was</span>
00538     <span class="comment">// successfully set, then return a success status. Otherwise, return</span>
00539     <span class="comment">// insufficient resources.</span>
00540     <span class="comment">//</span>
00541 
00542     <span class="keywordflow">if</span> (ArcStatus == <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00543         <span class="keywordflow">return</span> STATUS_SUCCESS;
00544 
00545     } <span class="keywordflow">else</span> {
00546         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00547     }
00548 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:55 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
