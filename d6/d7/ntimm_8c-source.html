<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ntimm.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ntimm.c</h1><a href="../../d5/d8/ntimm_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: ntimm.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains IMM functionality</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 21-Dec-1995 wkwok</span>
00010 <span class="comment">\**************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 
<a name="l00016"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a0">00016</a> <span class="keyword">static</span> CONST WCHAR <a class="code" href="../../d5/d8/ntimm_8c.html#a0">wszDefaultIme</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Default IME"</span>;
00017 
00018 <span class="preprocessor">#if DBG</span>
00019 <span class="preprocessor"></span><a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> CheckOwnerCirculate(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00020 {
00021     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
00022 
00023     <span class="keywordflow">while</span> (pwndT) {
00024         UserAssert(pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> != pwnd);
00025         pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
00026     }
00027     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00028 }
00029 <span class="preprocessor">#endif</span>
00030 <span class="preprocessor"></span>
00031 <span class="comment">/**************************************************************************\</span>
00032 <span class="comment">* CreateInputContext</span>
00033 <span class="comment">*</span>
00034 <span class="comment">* Create input context object.</span>
00035 <span class="comment">*</span>
00036 <span class="comment">* History:</span>
00037 <span class="comment">* 21-Dec-1995 wkwok       Created</span>
00038 <span class="comment">\**************************************************************************/</span>
00039 
<a name="l00040"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a1">00040</a> <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a> <a class="code" href="../../d4/d1/userk_8h.html#a2030">CreateInputContext</a>(
00041     ULONG_PTR dwClientImcData)
00042 {
00043     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>    ptiCurrent;
00044     <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a>           pImc;
00045     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>       pdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00046 
00047     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00048 
00049     <span class="comment">/*</span>
00050 <span class="comment">     * Only for thread that wants IME processing.</span>
00051 <span class="comment">     */</span>
00052     <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a817">TIF_DISABLEIME</a>) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00053         RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"CreateInputContext: TIF_DISABLEIME or !IME Enabled. pti=%#p"</span>, ptiCurrent);
00054         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00055     }
00056 
00057     <span class="comment">/*</span>
00058 <span class="comment">     * If pti-&gt;spDefaultImc is NULL (means this is the first instance)</span>
00059 <span class="comment">     * but dwClientImcData is not 0, some bogus application like NtCrash</span>
00060 <span class="comment">     * has tried to trick the kernel. Just bail out.</span>
00061 <span class="comment">     */</span>
00062     <span class="keywordflow">if</span> (dwClientImcData != 0 &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00063         RIPMSG2(RIP_WARNING, <span class="stringliteral">"CreateInputContext: bogus value(0x%08x) is passed. pti=%#p"</span>,
00064                 dwClientImcData, ptiCurrent);
00065         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00066     }
00067 
00068     <span class="comment">/*</span>
00069 <span class="comment">     * If the windowstation has been initialized, allocate from</span>
00070 <span class="comment">     * the current desktop.</span>
00071 <span class="comment">     */</span>
00072     pdesk = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;
00073 <span class="preprocessor">#ifdef LATER</span>
00074 <span class="preprocessor"></span>    <a class="code" href="../../d4/d1/userk_8h.html#a263">RETURN_IF_ACCESS_DENIED</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o48">amdesk</a>, DESKTOP_CREATEINPUTCONTEXT, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00075 <span class="preprocessor">#else</span>
00076 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00077         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00078     }
00079 <span class="preprocessor">#endif</span>
00080 <span class="preprocessor"></span>
00081     pImc = <a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(ptiCurrent, pdesk, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a253">TYPE_INPUTCONTEXT</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/structtagIMC.html">IMC</a>));
00082 
00083     <span class="keywordflow">if</span> (pImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00084         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateInputContext: out of memory"</span>);
00085         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00086     }
00087 
00088     <span class="keywordflow">if</span> (dwClientImcData == 0) {
00089         <span class="comment">/*</span>
00090 <span class="comment">         * We are creating default input context for current thread.</span>
00091 <span class="comment">         * Initialize the default input context as head of the</span>
00092 <span class="comment">         * per-thread IMC list.</span>
00093 <span class="comment">         */</span>
00094         UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00095         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a>, pImc);
00096         pImc-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o1">pImcNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00097     }
00098     <span class="keywordflow">else</span> {
00099         <span class="comment">/*</span>
00100 <span class="comment">         * Link it to the per-thread IMC list.</span>
00101 <span class="comment">         */</span>
00102         UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00103         pImc-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o1">pImcNext</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a>-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o1">pImcNext</a>;
00104         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a>-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o1">pImcNext</a> = pImc;
00105     }
00106 
00107     pImc-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o2">dwClientImcData</a> = dwClientImcData;
00108 
00109     <span class="keywordflow">return</span> pImc;
00110 }
00111 
00112 
00113 <span class="comment">/**************************************************************************\</span>
00114 <span class="comment">* DestroyInputContext</span>
00115 <span class="comment">*</span>
00116 <span class="comment">* Destroy the specified input context object.</span>
00117 <span class="comment">*</span>
00118 <span class="comment">* History:</span>
00119 <span class="comment">* 21-Dec-1995 wkwok       Created</span>
00120 <span class="comment">\**************************************************************************/</span>
00121 
<a name="l00122"></a><a class="code" href="../../d4/d1/userk_8h.html#a2031">00122</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2031">DestroyInputContext</a>(
00123     IN <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a> pImc)
00124 {
00125     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiImcOwner;
00126     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a>        pbwl;
00127     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwnd;
00128     HWND       *phwnd;
00129     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>         phe;
00130 
00131     ptiImcOwner = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pImc);
00132 
00133     <span class="comment">/*</span>
00134 <span class="comment">     * Cannot destroy input context from other thread.</span>
00135 <span class="comment">     */</span>
00136     <span class="keywordflow">if</span> (ptiImcOwner != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()) {
00137         RIPERR0(ERROR_ACCESS_DENIED, RIP_WARNING,
00138               <span class="stringliteral">"DestroyInputContext: pImc not of current pti"</span>);
00139         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00140     }
00141 
00142     <span class="comment">/*</span>
00143 <span class="comment">     * Cannot destroy default input context.</span>
00144 <span class="comment">     */</span>
00145     <span class="keywordflow">if</span> (pImc == ptiImcOwner-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a>) {
00146         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING,
00147               <span class="stringliteral">"DestroyInputContext: can't destroy default Imc"</span>);
00148         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00149     }
00150 
00151     <span class="comment">/*</span>
00152 <span class="comment">     * Cleanup destroyed input context from each associated window.</span>
00153 <span class="comment">     */</span>
00154     pbwl = <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(ptiImcOwner-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>,
00155                              <a class="code" href="../../d4/d1/userk_8h.html#a410">BWL_ENUMLIST</a>|<a class="code" href="../../d4/d1/userk_8h.html#a409">BWL_ENUMCHILDREN</a>, ptiImcOwner);
00156 
00157     <span class="keywordflow">if</span> (pbwl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00158 
00159         <span class="keywordflow">for</span> (phwnd = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>; *phwnd != (HWND)1; phwnd++) {
00160             <span class="comment">/*</span>
00161 <span class="comment">             * Make sure this hwnd is still around.</span>
00162 <span class="comment">             */</span>
00163             <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(*phwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00164                 <span class="keywordflow">continue</span>;
00165 
00166             <span class="comment">/*</span>
00167 <span class="comment">             * Cleanup by associating the default input context.</span>
00168 <span class="comment">             */</span>
00169             <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a> == (HIMC)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pImc))
00170                 <a class="code" href="../../d4/d1/userk_8h.html#a2033">AssociateInputContext</a>(pwnd, ptiImcOwner-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a>);
00171         }
00172 
00173         <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>(pbwl);
00174     }
00175 
00176     phe = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a446">HMPheFromObject</a>(pImc);
00177 
00178     <span class="comment">/*</span>
00179 <span class="comment">     * Make sure this object isn't already marked to be destroyed - we'll</span>
00180 <span class="comment">     * do no good if we try to destroy it now since it is locked.</span>
00181 <span class="comment">     */</span>
00182     <span class="keywordflow">if</span> (!(phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a>))
00183         <a class="code" href="../../d4/d1/userk_8h.html#a977">HMDestroyUnlockedObject</a>(phe);
00184 
00185     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00186 }
00187 
00188 
00189 <span class="comment">/**************************************************************************\</span>
00190 <span class="comment">* FreeInputContext</span>
00191 <span class="comment">*</span>
00192 <span class="comment">* Free up the specified input context object.</span>
00193 <span class="comment">*</span>
00194 <span class="comment">* History:</span>
00195 <span class="comment">* 21-Dec-1995 wkwok       Created</span>
00196 <span class="comment">\**************************************************************************/</span>
00197 
<a name="l00198"></a><a class="code" href="../../d4/d1/userk_8h.html#a2032">00198</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a2032">FreeInputContext</a>(
00199     IN <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a> pImc)
00200 {
00201     <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a> pImcT;
00202 
00203     <span class="comment">/*</span>
00204 <span class="comment">     * Mark it for destruction.  If it the object is locked it can't</span>
00205 <span class="comment">     * be freed right now.</span>
00206 <span class="comment">     */</span>
00207     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>((PVOID)pImc))
00208         <span class="keywordflow">return</span>;
00209 
00210     <span class="comment">/*</span>
00211 <span class="comment">     * Unlink it.</span>
00212 <span class="comment">     */</span>
00213     pImcT = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pImc)-&gt;spDefaultImc;
00214 
00215     <span class="keywordflow">while</span> (pImcT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pImcT-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o1">pImcNext</a> != pImc)
00216         pImcT = pImcT-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o1">pImcNext</a>;
00217 
00218     <span class="keywordflow">if</span> (pImcT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00219         pImcT-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o1">pImcNext</a> = pImc-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o1">pImcNext</a>;
00220 
00221     <span class="comment">/*</span>
00222 <span class="comment">     * We're really going to free the input context.</span>
00223 <span class="comment">     */</span>
00224     <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>((PVOID)pImc);
00225 
00226     <span class="keywordflow">return</span>;
00227 }
00228 
00229 
00230 <span class="comment">/**************************************************************************\</span>
00231 <span class="comment">* UpdateInputContext</span>
00232 <span class="comment">*</span>
00233 <span class="comment">* Update the specified input context object according to UpdateType.</span>
00234 <span class="comment">*</span>
00235 <span class="comment">* History:</span>
00236 <span class="comment">* 21-Dec-1995 wkwok       Created</span>
00237 <span class="comment">\**************************************************************************/</span>
00238 
<a name="l00239"></a><a class="code" href="../../d4/d1/userk_8h.html#a2035">00239</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2035">UpdateInputContext</a>(
00240     IN <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a> pImc,
00241     IN UPDATEINPUTCONTEXTCLASS UpdateType,
00242     IN ULONG_PTR UpdateValue)
00243 {
00244     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent, ptiImcOwner;
00245 
00246     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00247     ptiImcOwner = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pImc);
00248 
00249     <span class="comment">/*</span>
00250 <span class="comment">     * Cannot update input context from other process.</span>
00251 <span class="comment">     */</span>
00252     <span class="keywordflow">if</span> (ptiImcOwner-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>) {
00253         RIPERR0(ERROR_ACCESS_DENIED, RIP_WARNING, <span class="stringliteral">"UpdateInputContext: pImc not of current ppi"</span>);
00254         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00255     }
00256 
00257 
00258     <span class="keywordflow">switch</span> (UpdateType) {
00259 
00260     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a73a46">UpdateClientInputContext</a>:
00261         <span class="keywordflow">if</span> (pImc-&gt;dwClientImcData != 0) {
00262             RIPERR0(RIP_WARNING, RIP_WARNING, <span class="stringliteral">"UpdateInputContext: pImc-&gt;dwClientImcData != 0"</span>);
00263             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00264         }
00265         pImc-&gt;dwClientImcData = UpdateValue;
00266         <span class="keywordflow">break</span>;
00267 
00268     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a73a47">UpdateInUseImeWindow</a>:
00269         pImc-&gt;hImeWnd = (HWND)UpdateValue;
00270         <span class="keywordflow">break</span>;
00271 
00272     <span class="keywordflow">default</span>:
00273         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00274     }
00275 
00276     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00277 }
00278 
00279 
00280 <span class="comment">/**************************************************************************\</span>
00281 <span class="comment">* AssociateInputContext</span>
00282 <span class="comment">*</span>
00283 <span class="comment">* Associate input context object to the specified window.</span>
00284 <span class="comment">*</span>
00285 <span class="comment">* History:</span>
00286 <span class="comment">* 21-Dec-1995 wkwok       Created</span>
00287 <span class="comment">\**************************************************************************/</span>
00288 
<a name="l00289"></a><a class="code" href="../../d4/d1/userk_8h.html#a2033">00289</a> HIMC <a class="code" href="../../d4/d1/userk_8h.html#a2033">AssociateInputContext</a>(
00290     IN <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pWnd,
00291     IN <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a>  pImc)
00292 {
00293     HIMC hImcRet = pWnd-&gt;hImc;
00294     pWnd-&gt;hImc = (HIMC)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pImc);
00295 
00296     <span class="keywordflow">return</span> hImcRet;
00297 }
00298 
<a name="l00299"></a><a class="code" href="../../d4/d1/userk_8h.html#a2034">00299</a> <a class="code" href="../../d8/d0/immstruc_8h.html#a39">AIC_STATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a2034">AssociateInputContextEx</a>(
00300     IN <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pWnd,
00301     IN <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a>  pImc,
00302     IN DWORD dwFlag)
00303 {
00304     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiWnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pWnd);
00305     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pWndFocus = ptiWnd-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>;
00306     HIMC hImcFocus = pWndFocus-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a>;
00307     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fIgnoreNoContext = (dwFlag &amp; IACE_IGNORENOCONTEXT) == IACE_IGNORENOCONTEXT;
00308     <a class="code" href="../../d8/d0/immstruc_8h.html#a39">AIC_STATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/immstruc_8h.html#a72a43">AIC_SUCCESS</a>;
00309 
00310     <span class="keywordflow">if</span> (dwFlag &amp; IACE_DEFAULT) {
00311         <span class="comment">/*</span>
00312 <span class="comment">         * use default input context.</span>
00313 <span class="comment">         */</span>
00314         pImc = ptiWnd-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a>;
00315 
00316     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pImc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pImc) != ptiWnd) {
00317         <span class="comment">/*</span>
00318 <span class="comment">         * Cannot associate input context to window created</span>
00319 <span class="comment">         * by other thread.</span>
00320 <span class="comment">         */</span>
00321         RIPERR0(ERROR_ACCESS_DENIED, RIP_WARNING,
00322                 <span class="stringliteral">"AssociateInputContextEx: pwnd not of Imc pti"</span>);
00323         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a72a45">AIC_ERROR</a>;
00324     }
00325 
00326     <span class="comment">/*</span>
00327 <span class="comment">     * Cannot do association under different process context.</span>
00328 <span class="comment">     */</span>
00329     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pWnd)-&gt;ppi != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;ppi) {
00330         RIPERR0(ERROR_ACCESS_DENIED, RIP_WARNING,
00331                 <span class="stringliteral">"AssociateInputContextEx: pwnd not of current ppi"</span>);
00332         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a72a45">AIC_ERROR</a>;
00333     }
00334 
00335     <span class="comment">/*</span>
00336 <span class="comment">     * Finally, make sure they are on the same desktop.</span>
00337 <span class="comment">     */</span>
00338     <span class="keywordflow">if</span> (pImc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pImc-&gt;head.rpdesk != pWnd-&gt;head.rpdesk) {
00339         RIPERR0(ERROR_ACCESS_DENIED, RIP_WARNING,
00340                 <span class="stringliteral">"AssociateInputContextEx: no desktop access"</span>);
00341         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a72a45">AIC_ERROR</a>;
00342     }
00343 
00344     <span class="comment">/*</span>
00345 <span class="comment">     * If IACE_CHILDREN is specified, associate the input context</span>
00346 <span class="comment">     * to the child windows of pWnd as well.</span>
00347 <span class="comment">     */</span>
00348     <span class="keywordflow">if</span> ((dwFlag &amp; IACE_CHILDREN) &amp;&amp; pWnd-&gt;spwndChild != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00349         <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a>        pbwl;
00350         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndT;
00351         HWND       *phwndT;
00352 
00353         pbwl = <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(pWnd-&gt;spwndChild,
00354                    <a class="code" href="../../d4/d1/userk_8h.html#a410">BWL_ENUMLIST</a>|<a class="code" href="../../d4/d1/userk_8h.html#a409">BWL_ENUMCHILDREN</a>, ptiWnd);
00355 
00356         <span class="keywordflow">if</span> (pbwl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00357 
00358             <span class="keywordflow">for</span> (phwndT = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>; *phwndT != (HWND)1; phwndT++) {
00359                 <span class="comment">/*</span>
00360 <span class="comment">                 * Make sure this hwnd is still around.</span>
00361 <span class="comment">                 */</span>
00362                 <span class="keywordflow">if</span> ((pwndT = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(*phwndT)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00363                     <span class="keywordflow">continue</span>;
00364 
00365                 <span class="keywordflow">if</span> (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a> == (HIMC)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pImc))
00366                     <span class="keywordflow">continue</span>;
00367 
00368                 <span class="keywordflow">if</span> (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a> == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> &amp;&amp; fIgnoreNoContext)
00369                     <span class="keywordflow">continue</span>;
00370 
00371                 <a class="code" href="../../d4/d1/userk_8h.html#a2033">AssociateInputContext</a>(pwndT, pImc);
00372 
00373                 <span class="keywordflow">if</span> (pwndT == pWndFocus)
00374                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/immstruc_8h.html#a72a44">AIC_FOCUSCONTEXTCHANGED</a>;
00375             }
00376 
00377             <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>(pbwl);
00378         }
00379     }
00380 
00381     <span class="comment">/*</span>
00382 <span class="comment">     * Associate the input context to pWnd.</span>
00383 <span class="comment">     */</span>
00384     <span class="keywordflow">if</span> (pWnd-&gt;hImc != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> || !fIgnoreNoContext) {
00385         <span class="keywordflow">if</span> (pWnd-&gt;hImc != (HIMC)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pImc)) {
00386             <a class="code" href="../../d4/d1/userk_8h.html#a2033">AssociateInputContext</a>(pWnd, pImc);
00387             <span class="keywordflow">if</span> (pWnd == pWndFocus)
00388                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/immstruc_8h.html#a72a44">AIC_FOCUSCONTEXTCHANGED</a>;
00389         }
00390     }
00391 
00392     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00393 }
00394 
00395 
00396 <span class="comment">/**************************************************************************\</span>
00397 <span class="comment">* xxxFocusSetInputContext</span>
00398 <span class="comment">*</span>
00399 <span class="comment">* Set active input context upon focus change.</span>
00400 <span class="comment">*</span>
00401 <span class="comment">* History:</span>
00402 <span class="comment">* 21-Mar-1996 wkwok       Created</span>
00403 <span class="comment">\**************************************************************************/</span>
00404 
<a name="l00405"></a><a class="code" href="../../d4/d1/userk_8h.html#a2036">00405</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a2036">xxxFocusSetInputContext</a>(
00406     IN <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pWnd,
00407     IN BOOL fActivate,
00408     IN BOOL fQueueMsg)
00409 {
00410     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
00411     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndDefaultIme;
00412     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndDefaultIme;
00413 
00414     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pWnd);
00415 
00416     pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pWnd);
00417 
00418     <span class="comment">/*</span>
00419 <span class="comment">     * CS_IME class or "IME" class windows can not be SetActivated to hImc.</span>
00420 <span class="comment">     * WinWord 6.0 US Help calls ShowWindow with the default IME window.</span>
00421 <span class="comment">     * HELPMACROS get the default IME window by calling GetNextWindow().</span>
00422 <span class="comment">     */</span>
00423     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pWnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>) ||
00424             (pWnd-&gt;pcls-&gt;atomClassName == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>]))
00425         <span class="keywordflow">return</span>;
00426 
00427     <span class="comment">/*</span>
00428 <span class="comment">     * Do nothing if the thread does not have default IME window.</span>
00429 <span class="comment">     */</span>
00430     <span class="keywordflow">if</span> ((pwndDefaultIme = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00431         <span class="keywordflow">return</span>;
00432 
00433     <span class="comment">/*</span>
00434 <span class="comment">     * If the thread is going away or the default IME window is being vanished,</span>
00435 <span class="comment">     * then do nothing.</span>
00436 <span class="comment">     */</span>
00437     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>)
00438         <span class="keywordflow">return</span>;
00439 
00440     UserAssert(!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndDefaultIme, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>));
00441 
00442     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndDefaultIme, &amp;tlpwndDefaultIme);
00443 
00444     <span class="keywordflow">if</span> (fQueueMsg) {
00445         <a class="code" href="../../d4/d1/userk_8h.html#a1583">xxxSendMessageCallback</a>(pwndDefaultIme, WM_IME_SYSTEM,
00446                 fActivate ? IMS_ACTIVATECONTEXT : IMS_DEACTIVATECONTEXT,
00447                 (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pWnd), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 0);
00448     } <span class="keywordflow">else</span> {
00449         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndDefaultIme, WM_IME_SYSTEM,
00450                 fActivate ? IMS_ACTIVATECONTEXT : IMS_DEACTIVATECONTEXT,
00451                 (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pWnd));
00452     }
00453 
00454 <span class="preprocessor">#if _DBG</span>
00455 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a> != pwndDefaultIme) {
00456         RIPMSG1(RIP_WARNING, <span class="stringliteral">"pti(%#p)-&gt;spwndDefaultIme got freed during the callback."</span>, pti);
00457     }
00458 <span class="preprocessor">#endif</span>
00459 <span class="preprocessor"></span>
00460     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndDefaultIme);
00461 
00462     <span class="keywordflow">return</span>;
00463 }
00464 
00465 
00466 <span class="comment">/**************************************************************************\</span>
00467 <span class="comment">* BuildHimcList</span>
00468 <span class="comment">*</span>
00469 <span class="comment">* Retrieve the list of input context handles created by given thread.</span>
00470 <span class="comment">*</span>
00471 <span class="comment">* History:</span>
00472 <span class="comment">* 21-Feb-1995 wkwok       Created</span>
00473 <span class="comment">\**************************************************************************/</span>
00474 
<a name="l00475"></a><a class="code" href="../../d4/d1/userk_8h.html#a2037">00475</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d1/userk_8h.html#a2037">BuildHimcList</a>(
00476     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
00477     UINT cHimcMax,
00478     HIMC *ccxphimcFirst)
00479 {
00480     <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a> pImcT;
00481     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i = 0;
00482 
00483     <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00484         <span class="comment">/*</span>
00485 <span class="comment">         * Build the list which contains all IMCs created by calling process.</span>
00486 <span class="comment">         */</span>
00487         <span class="keywordflow">for</span> (pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;ppi-&gt;ptiList; pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pti = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>) {
00488             pImcT = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a>;
00489             <span class="keywordflow">while</span> (pImcT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00490                 <span class="keywordflow">if</span> (i &lt; cHimcMax) {
00491                     <span class="keywordflow">try</span> {
00492                         ccxphimcFirst[i] = (HIMC)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pImcT);
00493                     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00494                     }
00495                 }
00496                 i++;
00497                 pImcT = pImcT-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o1">pImcNext</a>;
00498             }
00499         }
00500     }
00501     <span class="keywordflow">else</span> {
00502         <span class="comment">/*</span>
00503 <span class="comment">         * Build the list which contains all IMCs created by specified thread.</span>
00504 <span class="comment">         */</span>
00505         pImcT = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a>;
00506         <span class="keywordflow">while</span> (pImcT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00507             <span class="keywordflow">if</span> (i &lt; cHimcMax) {
00508                 <span class="keywordflow">try</span> {
00509                     ccxphimcFirst[i] = (HIMC)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pImcT);
00510                 } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00511                 }
00512             }
00513             i++;
00514             pImcT = pImcT-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o1">pImcNext</a>;
00515         }
00516     }
00517 
00518     <span class="keywordflow">return</span> i;
00519 }
00520 
00521 
00522 <span class="comment">/**************************************************************************\</span>
00523 <span class="comment">* xxxCreateDefaultImeWindow</span>
00524 <span class="comment">*</span>
00525 <span class="comment">* Create per-thread based default IME window.</span>
00526 <span class="comment">*</span>
00527 <span class="comment">* History:</span>
00528 <span class="comment">* 21-Mar-1996 wkwok       Created</span>
00529 <span class="comment">\**************************************************************************/</span>
00530 
<a name="l00531"></a><a class="code" href="../../d4/d1/userk_8h.html#a2038">00531</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a2038">xxxCreateDefaultImeWindow</a>(
00532     IN <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00533     IN ATOM atomT,
00534     IN HANDLE hInst)
00535 {
00536     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> strWindowName;
00537     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDefaultIme;
00538     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00539     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui;
00540     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00541     LPWSTR pwszDefaultIme;
00542 
00543     UserAssert(ptiCurrent == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00544 
00545     <span class="comment">/*</span>
00546 <span class="comment">     * Those conditions should have been checked by WantImeWindow()</span>
00547 <span class="comment">     * before xxxCreateDefaultImeWindow gets called.</span>
00548 <span class="comment">     */</span>
00549     UserAssert(!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a817">TIF_DISABLEIME</a>));
00550     UserAssert(!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a569">WFSERVERSIDEPROC</a>));
00551 
00552     <span class="comment">/*</span>
00553 <span class="comment">     * The first Winlogon thread starts without default input context.</span>
00554 <span class="comment">     * Create it now.</span>
00555 <span class="comment">     */</span>
00556     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00557             ptiCurrent-&gt;pEThread-&gt;Cid.UniqueProcess == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>)
00558         <a class="code" href="../../d4/d1/userk_8h.html#a2030">CreateInputContext</a>(0);
00559 
00560     <span class="comment">/*</span>
00561 <span class="comment">     * No default IME window for thread that doesn't have</span>
00562 <span class="comment">     * default input context</span>
00563 <span class="comment">     */</span>
00564     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00565         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00566 
00567     <span class="comment">/*</span>
00568 <span class="comment">     * Avoid recursion</span>
00569 <span class="comment">     */</span>
00570     <span class="keywordflow">if</span> (atomT == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>] || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>))
00571         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00572 
00573     <span class="comment">/*</span>
00574 <span class="comment">     * B#12165-win95b</span>
00575 <span class="comment">     * Yet MFC does another nice. We need to avoid to give an IME window</span>
00576 <span class="comment">     * to the child of desktop window which is in different process.</span>
00577 <span class="comment">     */</span>
00578     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd-&gt;spwndParent)-&gt;ppi != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> &amp;&amp;
00579             !(pwnd-&gt;style &amp; WS_VISIBLE))
00580         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00581 
00582     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00583         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00584 
00585     <span class="comment">/*</span>
00586 <span class="comment">     * Allocate storage for L"Default IME" string from desktop heap</span>
00587 <span class="comment">     * so that it can be referenced from USER32.DLL in user mode.</span>
00588 <span class="comment">     */</span>
00589     pwszDefaultIme = (LPWSTR)<a class="code" href="../../d4/d1/userk_8h.html#a1020">DesktopAlloc</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>,
00590                                           <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/ntimm_8c.html#a0">wszDefaultIme</a>),
00591                                           <a class="code" href="../../d4/d1/userk_8h.html#a310">DTAG_IMETEXT</a>);
00592     <span class="keywordflow">if</span> (pwszDefaultIme == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00593         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00594 
00595     RtlCopyMemory(pwszDefaultIme, <a class="code" href="../../d5/d8/ntimm_8c.html#a0">wszDefaultIme</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/ntimm_8c.html#a0">wszDefaultIme</a>));
00596 
00597     <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>((<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>)&amp;strWindowName,
00598                               pwszDefaultIme,
00599                               (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
00600 
00601     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
00602 
00603     pwndDefaultIme = <a class="code" href="../../d4/d1/userk_8h.html#a1574">xxxCreateWindowEx</a>( (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
00604                              (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>],
00605                              (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)&amp;strWindowName,
00606                              WS_POPUP | WS_DISABLED,
00607                              0, 0, 0, 0,
00608                              pwnd, (<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00609                              <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a0">hInst</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>);
00610 
00611 
00612     <span class="keywordflow">if</span> (pwndDefaultIme != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00613         pimeui = ((<a class="code" href="../../d5/d8/structtagIMEWND.html">PIMEWND</a>)pwndDefaultIme)-&gt;pimeui;
00614         UserAssert(pimeui != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (LONG_PTR)pimeui != (LONG_PTR)-1);
00615         <span class="keywordflow">try</span> {
00616             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pimeui, <span class="keyword">sizeof</span> *pimeui, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
00617             pimeui-&gt;fDefault = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00618             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd-&gt;spwndParent) != ptiCurrent) {
00619                 pimeui-&gt;fChildThreadDef = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00620             }
00621         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00622         }
00623     }
00624 
00625     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00626 
00627     <a class="code" href="../../d4/d1/userk_8h.html#a313">DesktopFree</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>, pwszDefaultIme);
00628 
00629     <span class="keywordflow">return</span> pwndDefaultIme;
00630 }
00631 
00632 
00633 <span class="comment">/**************************************************************************\</span>
00634 <span class="comment">* xxxImmActivateThreadsLayout</span>
00635 <span class="comment">*</span>
00636 <span class="comment">* Activate keyboard layout for multiple threads.</span>
00637 <span class="comment">*</span>
00638 <span class="comment">* Return:</span>
00639 <span class="comment">*     TRUE if at least one thread has changed its active keyboard layout.</span>
00640 <span class="comment">*     FALSE otherwise</span>
00641 <span class="comment">*</span>
00642 <span class="comment">* History:</span>
00643 <span class="comment">* 11-Apr-1996 wkwok       Created</span>
00644 <span class="comment">\**************************************************************************/</span>
00645 
<a name="l00646"></a><a class="code" href="../../d4/d1/userk_8h.html#a2039">00646</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2039">xxxImmActivateThreadsLayout</a>(
00647     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
00648     <a class="code" href="../../d5/d8/structtagTLBLOCK.html">PTLBLOCK</a>    ptlBlockPrev,
00649     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a>         pkl)
00650 {
00651     <a class="code" href="../../d5/d8/structtagTLBLOCK.html">TLBLOCK</a>     tlBlock;
00652     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent, ptiT;
00653     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        cThreads = 0;
00654     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>         i;
00655 
00656     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pkl);
00657 
00658     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00659 
00660     <span class="comment">/*</span>
00661 <span class="comment">     * Build a list of threads that we need to update their active layouts.</span>
00662 <span class="comment">     * We can't just walk the ptiT list while we're doing the work, because</span>
00663 <span class="comment">     * for IME based keyboard layout, we will do callback to client side</span>
00664 <span class="comment">     * and the ptiT could get deleted out while we leave the critical section.</span>
00665 <span class="comment">     */</span>
00666     <span class="keywordflow">for</span> (ptiT = pti; ptiT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ptiT = ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>) {
00667         <span class="comment">/*</span>
00668 <span class="comment">         * Skip all the *do nothing* cases in xxxImmActivateLayout</span>
00669 <span class="comment">         * so as to minimize the # of TLBLOCK required.</span>
00670 <span class="comment">         */</span>
00671         <span class="keywordflow">if</span> (ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a> == pkl || (ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>))
00672             <span class="keywordflow">continue</span>;
00673 
00674         UserAssert(ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00675         UserAssert(ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> == <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()); <span class="comment">// can't access pClientInfo of other process</span>
00676 
00677         <span class="keywordflow">if</span> (ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00678             <span class="comment">/*</span>
00679 <span class="comment">             * Keyboard layout is being switched but there's no way to callback</span>
00680 <span class="comment">             * the client side to activate&amp;initialize input context now.</span>
00681 <span class="comment">             * Let's do hkl switching only in the kernel side for this thread</span>
00682 <span class="comment">             * but remember the input context needs to be re-initialized</span>
00683 <span class="comment">             * when this GUI thread recreates the default IME window later.</span>
00684 <span class="comment">             */</span>
00685             ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o41">hklPrev</a> = ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
00686             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>, pkl);
00687             <span class="keywordflow">if</span> (ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a>) {
00688                 ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> |= <a class="code" href="../../d1/d0/inc_2user_8h.html#a105">CI_INPUTCONTEXT_REINIT</a>;
00689                 RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"xxxImmActivateThreadsLayout: ptiT(%08p) will be re-initialized."</span>, ptiT);
00690             }
00691             UserAssert((ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>) == 0);
00692             ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o21">hKL</a> = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
00693             ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o20">CodePage</a> = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o8">CodePage</a>;
00694             <span class="keywordflow">continue</span>;
00695         }
00696 
00697         <a class="code" href="../../d4/d1/userk_8h.html#a134">ThreadLockPti</a>(ptiCurrent, ptiT, &amp;tlBlock.<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o4">list</a>[cThreads].tlpti);
00698         tlBlock.<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o4">list</a>[cThreads++].pti = ptiT;
00699 
00700         <span class="keywordflow">if</span> (cThreads == <a class="code" href="../../d4/d1/userk_8h.html#a275">THREADS_PER_TLBLOCK</a>)
00701             <span class="keywordflow">break</span>;
00702     }
00703 
00704     <span class="comment">/*</span>
00705 <span class="comment">     * Return FALSE if all the threads already had the pkl active.</span>
00706 <span class="comment">     */</span>
00707     <span class="keywordflow">if</span> (ptlBlockPrev == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ptiT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; cThreads == 0)
00708         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00709 
00710     <span class="comment">/*</span>
00711 <span class="comment">     * If we can't service all the threads in this run,</span>
00712 <span class="comment">     * call ImmActivateThreadsLayout() again for a new TLBLOCK.</span>
00713 <span class="comment">     */</span>
00714     <span class="keywordflow">if</span> (ptiT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ptiT-&gt;ptiSibling != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00715         tlBlock.<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o0">ptlBlockPrev</a> = ptlBlockPrev;
00716         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a2039">xxxImmActivateThreadsLayout</a>(ptiT-&gt;ptiSibling, &amp;tlBlock, pkl);
00717     }
00718 
00719     <span class="comment">/*</span>
00720 <span class="comment">     * Finally, we can do the actual keyboard layout activation</span>
00721 <span class="comment">     * starting from this run. Work on current TLBLOCK first.</span>
00722 <span class="comment">     * We walk the list backwards so that the pti unlocks will</span>
00723 <span class="comment">     * be done in the right order.</span>
00724 <span class="comment">     */</span>
00725 
00726     tlBlock.<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o0">ptlBlockPrev</a> = ptlBlockPrev;
00727     ptlBlockPrev = &amp;tlBlock;
00728 
00729     <span class="keywordflow">while</span> (ptlBlockPrev != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00730         <span class="keywordflow">for</span> (i = cThreads - 1; i &gt;= 0; --i) {
00731             <span class="keywordflow">if</span> ((ptlBlockPrev-&gt;<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o4">list</a>[i].pti-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>) == 0) {
00732                 ptiT = ptlBlockPrev-&gt;<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o4">list</a>[i].pti;
00733                 UserAssert(ptiT);
00734                 <a class="code" href="../../d4/d1/userk_8h.html#a2041">xxxImmActivateLayout</a>(ptiT, pkl);
00735                 <span class="keywordflow">if</span> ((ptiT-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>) == 0) {
00736                     ptiT-&gt;pClientInfo-&gt;hKL = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
00737                     ptiT-&gt;pClientInfo-&gt;CodePage = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o8">CodePage</a>;
00738                 }
00739             }
00740             <a class="code" href="../../d4/d1/userk_8h.html#a136">ThreadUnlockPti</a>(ptiCurrent, &amp;ptlBlockPrev-&gt;<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o4">list</a>[i].tlpti);
00741         }
00742         ptlBlockPrev = ptlBlockPrev-&gt;<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o0">ptlBlockPrev</a>;
00743         cThreads = <a class="code" href="../../d4/d1/userk_8h.html#a275">THREADS_PER_TLBLOCK</a>;
00744     }
00745 
00746     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00747 }
00748 
<a name="l00749"></a><a class="code" href="../../d4/d1/userk_8h.html#a2040">00749</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a2040">xxxImmActivateAndUnloadThreadsLayout</a>(
00750     IN <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> *ptiList,
00751     IN UINT         nEntries,
00752     IN <a class="code" href="../../d5/d8/structtagTLBLOCK.html">PTLBLOCK</a>     ptlBlockPrev,
00753     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a>             pklCurrent,
00754     DWORD           dwHklReplace)
00755 {
00756     <a class="code" href="../../d5/d8/structtagTLBLOCK.html">TLBLOCK</a>     tlBlock;
00757     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00758     <span class="keywordtype">int</span>         i, cThreads;
00759     <span class="keyword">enum</span> { RUN_ACTIVATE = 1, RUN_UNLOAD = 2, RUN_FLAGS_MASK = RUN_ACTIVATE | RUN_UNLOAD, RUN_INVALID = 0xffff0000 };
00760 
00761     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pklCurrent);
00762 
00763     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00764 
00765     tlBlock.<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o0">ptlBlockPrev</a> = ptlBlockPrev;
00766 
00767     <span class="comment">/*</span>
00768 <span class="comment">     * Build a list of threads that we need to unload their IME DLL(s).</span>
00769 <span class="comment">     * We can't just walk the ptiList while we're doing the work, because</span>
00770 <span class="comment">     * for IME based keyboard layout, we will do callback to client side</span>
00771 <span class="comment">     * and the pti could get deleted out while we leave the critical section.</span>
00772 <span class="comment">     */</span>
00773     <span class="keywordflow">for</span> (i = 0, cThreads = 0; i &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)nEntries; i++) {
00774         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = 0;
00775 
00776         <span class="comment">/*</span>
00777 <span class="comment">         * Skip all the *do nothing* cases in xxxImmActivateLayout</span>
00778 <span class="comment">         * so as to minimize the # of TLBLOCKs required.</span>
00779 <span class="comment">         */</span>
00780         <span class="keywordflow">if</span> (ptiList[i]-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>) {
00781             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = RUN_INVALID;
00782         }
00783         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ptiList[i]-&gt;spklActive != pklCurrent) {
00784             <span class="keywordflow">if</span> (ptiList[i]-&gt;spwndDefaultIme == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00785                 BOOLEAN fAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00786 
00787                 <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiList[i]-&gt;spklActive, pklCurrent);
00788                 <span class="keywordflow">if</span> (ptiList[i]-&gt;pClientInfo != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a> &amp;&amp;
00789                         ptiList[i]-&gt;ppi != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>) {
00790                     <span class="comment">/*</span>
00791 <span class="comment">                     * If the thread is in another process, attach</span>
00792 <span class="comment">                     * to that process so that we can access its ClientInfo.</span>
00793 <span class="comment">                     */</span>
00794                     <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;ptiList[i]-&gt;ppi-&gt;Process-&gt;Pcb);
00795                     fAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00796                 }
00797 
00798                 <span class="keywordflow">try</span> {
00799                     ptiList[i]-&gt;pClientInfo-&gt;CodePage = pklCurrent-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o8">CodePage</a>;
00800                     ptiList[i]-&gt;pClientInfo-&gt;hKL = pklCurrent-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
00801                 } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00802                       <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = RUN_INVALID;
00803                 }
00804                 <span class="keywordflow">if</span> (fAttached) {
00805                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00806                 }
00807             } <span class="keywordflow">else</span> {
00808                 <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = RUN_ACTIVATE;
00809             }
00810         }
00811 
00812         <span class="comment">/*</span>
00813 <span class="comment">         * Skip all the *do nothing* cases in xxxImmUnloadLayout()</span>
00814 <span class="comment">         * so as to minimize the # of TLBLOCK required.</span>
00815 <span class="comment">         * (#99321)</span>
00816 <span class="comment">         */</span>
00817         <span class="keywordflow">if</span> (ptiList[i]-&gt;spwndDefaultIme != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00818                 ptiList[i]-&gt;spklActive != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00819                 (dwHklReplace != <a class="code" href="../../d8/d0/immstruc_8h.html#a15">IFL_DEACTIVATEIME</a> || <a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(ptiList[i]-&gt;spklActive-&gt;hkl)) &amp;&amp;
00820                 <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> != RUN_INVALID) {
00821             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= RUN_UNLOAD;
00822         }
00823 
00824         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp;&amp; <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> != RUN_INVALID) {
00825             <a class="code" href="../../d4/d1/userk_8h.html#a134">ThreadLockPti</a>(ptiCurrent, ptiList[i], &amp;tlBlock.<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o4">list</a>[cThreads].tlpti);
00826 <span class="preprocessor">#if DBG</span>
00827 <span class="preprocessor"></span>            tlBlock.<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o4">list</a>[cThreads].dwUnlockedCount = 0;
00828 <span class="preprocessor">#endif</span>
00829 <span class="preprocessor"></span>            tlBlock.<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o4">list</a>[cThreads].pti = ptiList[i];
00830             tlBlock.<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o4">list</a>[cThreads++].dwFlags = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00831 
00832             <span class="keywordflow">if</span> (cThreads == <a class="code" href="../../d4/d1/userk_8h.html#a275">THREADS_PER_TLBLOCK</a>) {
00833                 i++;   <span class="comment">// 1 more before exit the loop.</span>
00834                 <span class="keywordflow">break</span>;
00835             }
00836         }
00837     }
00838 
00839     <span class="comment">/*</span>
00840 <span class="comment">     * If we can't service all the threads in this run,</span>
00841 <span class="comment">     * call xxxImmActivateAndUnloadThreadsLayout again for a new TLBLOCK.</span>
00842 <span class="comment">     */</span>
00843     <span class="keywordflow">if</span> (i &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)nEntries) {
00844         ptiList  += i;
00845         nEntries -= i;
00846         <a class="code" href="../../d4/d1/userk_8h.html#a2040">xxxImmActivateAndUnloadThreadsLayout</a>(ptiList, nEntries, &amp;tlBlock, pklCurrent, dwHklReplace);
00847         <span class="keywordflow">return</span>;
00848     }
00849 
00850     <span class="comment">/*</span>
00851 <span class="comment">     * Finally, we can do the actual keyboard layout activation</span>
00852 <span class="comment">     * starting from this run. Work on current TLBLOCK first.</span>
00853 <span class="comment">     * We walk the list backwards so that the pti unlocks will</span>
00854 <span class="comment">     * be done in the right order.</span>
00855 <span class="comment">     */</span>
00856     i = cThreads - 1;
00857     <span class="keywordflow">for</span> (ptlBlockPrev = &amp;tlBlock; ptlBlockPrev != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ptlBlockPrev = ptlBlockPrev-&gt;ptlBlockPrev) {
00858         <span class="keywordflow">for</span> ( ; i &gt;= 0; i--) {
00859             <span class="keywordflow">if</span> ((ptlBlockPrev-&gt;list[i].dwFlags &amp; RUN_ACTIVATE) &amp;&amp;
00860                     !(ptlBlockPrev-&gt;list[i].pti-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>)) {
00861                 <a class="code" href="../../d4/d1/userk_8h.html#a2041">xxxImmActivateLayout</a>(ptlBlockPrev-&gt;list[i].pti, pklCurrent);
00862             }
00863 
00864             <span class="comment">// unlock the thread if the thread is only locked for the first run</span>
00865             <span class="keywordflow">if</span> ((ptlBlockPrev-&gt;list[i].dwFlags &amp; RUN_FLAGS_MASK) == RUN_ACTIVATE) {
00866                 <a class="code" href="../../d4/d1/userk_8h.html#a136">ThreadUnlockPti</a>(ptiCurrent, &amp;ptlBlockPrev-&gt;list[i].tlpti);
00867 <span class="preprocessor">#if DBG</span>
00868 <span class="preprocessor"></span>                ptlBlockPrev-&gt;list[i].dwUnlockedCount++;
00869 <span class="preprocessor">#endif</span>
00870 <span class="preprocessor"></span>            }
00871         }
00872         i = <a class="code" href="../../d4/d1/userk_8h.html#a275">THREADS_PER_TLBLOCK</a> - 1;
00873     }
00874 
00875     i = cThreads - 1;
00876     <span class="keywordflow">for</span> (ptlBlockPrev = &amp;tlBlock; ptlBlockPrev != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ptlBlockPrev = ptlBlockPrev-&gt;ptlBlockPrev) {
00877         <span class="keywordflow">for</span> ( ; i &gt;= 0; --i) {
00878             <span class="keywordflow">if</span> (ptlBlockPrev-&gt;list[i].dwFlags &amp; RUN_UNLOAD) {
00879                 <span class="keywordflow">if</span> (!(ptlBlockPrev-&gt;list[i].pti-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>)) {
00880                     <a class="code" href="../../d4/d1/userk_8h.html#a2043">xxxImmUnloadLayout</a>(ptlBlockPrev-&gt;list[i].pti, dwHklReplace);
00881                 }
00882                 <span class="keywordflow">else</span> {
00883                     RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxImmActivateAndUnloadThreadsLayout: thread %#p is cleaned up."</span>,
00884                             ptlBlockPrev-&gt;list[i].pti);
00885                 }
00886                 <span class="comment">// unlock the thread</span>
00887                 UserAssert((ptlBlockPrev-&gt;list[i].dwFlags &amp; RUN_FLAGS_MASK) != RUN_ACTIVATE);
00888                 UserAssert(ptlBlockPrev-&gt;list[i].dwUnlockedCount == 0);
00889                 <a class="code" href="../../d4/d1/userk_8h.html#a136">ThreadUnlockPti</a>(ptiCurrent, &amp;ptlBlockPrev-&gt;list[i].tlpti);
00890 <span class="preprocessor">#if DBG</span>
00891 <span class="preprocessor"></span>                ptlBlockPrev-&gt;list[i].dwUnlockedCount++;
00892 <span class="preprocessor">#endif</span>
00893 <span class="preprocessor"></span>            }
00894         }
00895         i = <a class="code" href="../../d4/d1/userk_8h.html#a275">THREADS_PER_TLBLOCK</a> - 1;
00896     }
00897 
00898 <span class="preprocessor">#if DBG</span>
00899 <span class="preprocessor"></span>    <span class="comment">// Check if all the locked thread is properly unlocked</span>
00900     i = cThreads - 1;
00901     <span class="keywordflow">for</span> (ptlBlockPrev = &amp;tlBlock; ptlBlockPrev; ptlBlockPrev = ptlBlockPrev-&gt;ptlBlockPrev) {
00902         <span class="keywordflow">for</span> ( ; i &gt;= 0; --i) {
00903             UserAssert(ptlBlockPrev-&gt;list[i].dwUnlockedCount == 1);
00904         }
00905         i = <a class="code" href="../../d4/d1/userk_8h.html#a275">THREADS_PER_TLBLOCK</a> - 1;
00906     }
00907 <span class="preprocessor">#endif</span>
00908 <span class="preprocessor"></span>
00909     <span class="keywordflow">return</span>;
00910 }
00911 
00912 <span class="comment">/**************************************************************************\</span>
00913 <span class="comment">* xxxImmActivateLayout</span>
00914 <span class="comment">*</span>
00915 <span class="comment">* Activate IME based keyboard layout.</span>
00916 <span class="comment">*</span>
00917 <span class="comment">* History:</span>
00918 <span class="comment">* 21-Mar-1996 wkwok       Created</span>
00919 <span class="comment">\**************************************************************************/</span>
00920 
<a name="l00921"></a><a class="code" href="../../d4/d1/userk_8h.html#a2041">00921</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a2041">xxxImmActivateLayout</a>(
00922     IN <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
00923     IN <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl)
00924 {
00925     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndDefaultIme;
00926     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00927 
00928     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pkl);
00929 
00930     <span class="comment">/*</span>
00931 <span class="comment">     * Do nothing if it's already been the current active layout.</span>
00932 <span class="comment">     */</span>
00933     <span class="keywordflow">if</span> (pti-&gt;spklActive == pkl)
00934         <span class="keywordflow">return</span>;
00935 
00936     <span class="keywordflow">if</span> (pti-&gt;spwndDefaultIme == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00937         <span class="comment">/*</span>
00938 <span class="comment">         * Only activate kernel side keyboard layout if this pti</span>
00939 <span class="comment">         * doesn't have the default IME window.</span>
00940 <span class="comment">         */</span>
00941         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pti-&gt;spklActive, pkl);
00942         <span class="keywordflow">return</span>;
00943     }
00944 
00945     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00946 
00947     <span class="comment">/*</span>
00948 <span class="comment">     * Activate client side IME based keyboard layout.</span>
00949 <span class="comment">     */</span>
00950     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a>, &amp;tlpwndDefaultIme);
00951     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pti-&gt;spwndDefaultIme, WM_IME_SYSTEM,
00952                 (WPARAM)IMS_ACTIVATETHREADLAYOUT, (LPARAM)pkl-&gt;hkl);
00953     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndDefaultIme);
00954 
00955     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pti-&gt;spklActive, pkl);
00956 
00957     <span class="keywordflow">return</span>;
00958 }
00959 
00960 
<a name="l00961"></a><a class="code" href="../../d4/d1/userk_8h.html#a2042">00961</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a2042">xxxImmUnloadThreadsLayout</a>(
00962     IN <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> *ptiList,
00963     IN UINT         nEntries,
00964     IN <a class="code" href="../../d5/d8/structtagTLBLOCK.html">PTLBLOCK</a>     ptlBlockPrev,
00965     IN DWORD        dwFlag)
00966 {
00967     <a class="code" href="../../d5/d8/structtagTLBLOCK.html">TLBLOCK</a>     tlBlock;
00968     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00969     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>         i, cThreads;
00970     BOOLEAN     fPerformUnlock;
00971 
00972     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00973     tlBlock.<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o0">ptlBlockPrev</a> = ptlBlockPrev;
00974 
00975     <span class="comment">/*</span>
00976 <span class="comment">     * Build a list of threads that we need to unload their IME DLL(s).</span>
00977 <span class="comment">     * We can't just walk the ptiList while we're doing the work, because</span>
00978 <span class="comment">     * for IME based keyboard layout, we will do callback to client side</span>
00979 <span class="comment">     * and the pti could get deleted out while we leave the critical section.</span>
00980 <span class="comment">     */</span>
00981     <span class="keywordflow">for</span> (i = 0, cThreads = 0; i &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)nEntries; i++) {
00982         <span class="comment">/*</span>
00983 <span class="comment">         * Skip all the *do nothing* cases in xxxImmUnloadLayout()</span>
00984 <span class="comment">         * so as to minimize the # of TLBLOCK required.</span>
00985 <span class="comment">         */</span>
00986         <span class="keywordflow">if</span> ((ptiList[i]-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>) || ptiList[i]-&gt;spwndDefaultIme == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00987             <span class="keywordflow">continue</span>;
00988 
00989         <span class="keywordflow">if</span> (ptiList[i]-&gt;spklActive == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00990             <span class="keywordflow">continue</span>;
00991 
00992         <span class="keywordflow">if</span> (dwFlag == <a class="code" href="../../d8/d0/immstruc_8h.html#a15">IFL_DEACTIVATEIME</a> &amp;&amp;
00993                 !<a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(ptiList[i]-&gt;spklActive-&gt;hkl)) <span class="comment">// #99321</span>
00994             <span class="keywordflow">continue</span>;
00995 
00996 <span class="preprocessor">#if DBG</span>
00997 <span class="preprocessor"></span>        tlBlock.<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o4">list</a>[cThreads].dwUnlockedCount = 0;
00998 <span class="preprocessor">#endif</span>
00999 <span class="preprocessor"></span>        <a class="code" href="../../d4/d1/userk_8h.html#a134">ThreadLockPti</a>(ptiCurrent, ptiList[i], &amp;tlBlock.<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o4">list</a>[cThreads].tlpti);
01000         tlBlock.<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o4">list</a>[cThreads++].pti = ptiList[i];
01001         <span class="keywordflow">if</span> (cThreads == <a class="code" href="../../d4/d1/userk_8h.html#a275">THREADS_PER_TLBLOCK</a>) {
01002             i++;   <span class="comment">// 1 more before exit the loop.</span>
01003             <span class="keywordflow">break</span>;
01004         }
01005     }
01006 
01007     <span class="keywordflow">if</span> (i &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)nEntries) {
01008         ptiList  += i;
01009         nEntries -= i;
01010         <a class="code" href="../../d4/d1/userk_8h.html#a2042">xxxImmUnloadThreadsLayout</a>(ptiList, nEntries, &amp;tlBlock, dwFlag);
01011         <span class="keywordflow">return</span>;
01012     }
01013 
01014     UserAssert(dwFlag == <a class="code" href="../../d8/d0/immstruc_8h.html#a16">IFL_UNLOADIME</a> || dwFlag == <a class="code" href="../../d8/d0/immstruc_8h.html#a15">IFL_DEACTIVATEIME</a>);
01015     <span class="keywordflow">if</span> (dwFlag == <a class="code" href="../../d8/d0/immstruc_8h.html#a16">IFL_UNLOADIME</a>) {
01016         dwFlag = <a class="code" href="../../d8/d0/immstruc_8h.html#a15">IFL_DEACTIVATEIME</a>;
01017         fPerformUnlock = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01018     } <span class="keywordflow">else</span> {
01019         fPerformUnlock = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01020     }
01021 RepeatForUnload:
01022     <span class="comment">/*</span>
01023 <span class="comment">     * Finally, we can unload the IME based keyboard layout</span>
01024 <span class="comment">     * starting from this run. Work on current TLBLOCK first.</span>
01025 <span class="comment">     * We walk the list backwards so that the pti unlocks will</span>
01026 <span class="comment">     * be done in the right order.</span>
01027 <span class="comment">     */</span>
01028     i = cThreads - 1;
01029     <span class="keywordflow">for</span> (ptlBlockPrev = &amp;tlBlock; ptlBlockPrev; ptlBlockPrev = ptlBlockPrev-&gt;<a class="code" href="../../d5/d8/structtagTLBLOCK.html#o0">ptlBlockPrev</a>) {
01030         <span class="keywordflow">for</span> ( ; i &gt;= 0; --i) {
01031             <span class="keywordflow">if</span> (!(ptlBlockPrev-&gt;list[i].pti-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>)) {
01032                 <a class="code" href="../../d4/d1/userk_8h.html#a2043">xxxImmUnloadLayout</a>(ptlBlockPrev-&gt;list[i].pti, dwFlag);
01033             }
01034             <span class="keywordflow">else</span> {
01035                 RIPMSG2(RIP_WARNING, <span class="stringliteral">"Thread %#p is cleaned during the loop for %x!"</span>, ptlBlockPrev-&gt;list[i].pti, dwFlag);
01036             }
01037 
01038             <span class="keywordflow">if</span> (fPerformUnlock) {
01039 <span class="preprocessor">#if DBG</span>
01040 <span class="preprocessor"></span>                ptlBlockPrev-&gt;list[i].dwUnlockedCount++;
01041 <span class="preprocessor">#endif</span>
01042 <span class="preprocessor"></span>                <a class="code" href="../../d4/d1/userk_8h.html#a136">ThreadUnlockPti</a>(ptiCurrent, &amp;ptlBlockPrev-&gt;list[i].tlpti);
01043             }
01044         }
01045         i = <a class="code" href="../../d4/d1/userk_8h.html#a275">THREADS_PER_TLBLOCK</a> - 1;
01046     }
01047 
01048     <span class="keywordflow">if</span> (!fPerformUnlock) {
01049         fPerformUnlock = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01050         dwFlag = <a class="code" href="../../d8/d0/immstruc_8h.html#a16">IFL_UNLOADIME</a>;
01051         <span class="keywordflow">goto</span> RepeatForUnload;
01052     }
01053 
01054 <span class="preprocessor">#if DBG</span>
01055 <span class="preprocessor"></span>    <span class="comment">// Check if all the locked thread is properly unlocked</span>
01056     i = cThreads - 1;
01057     <span class="keywordflow">for</span> (ptlBlockPrev = &amp;tlBlock; ptlBlockPrev; ptlBlockPrev = ptlBlockPrev-&gt;ptlBlockPrev) {
01058         <span class="keywordflow">for</span> ( ; i &gt;= 0; --i) {
01059             UserAssert(ptlBlockPrev-&gt;list[i].dwUnlockedCount == 1);
01060         }
01061         i = <a class="code" href="../../d4/d1/userk_8h.html#a275">THREADS_PER_TLBLOCK</a> - 1;
01062     }
01063 <span class="preprocessor">#endif</span>
01064 <span class="preprocessor"></span>
01065     <span class="keywordflow">return</span>;
01066 }
01067 
01068 
01069 
<a name="l01070"></a><a class="code" href="../../d4/d1/userk_8h.html#a2043">01070</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a2043">xxxImmUnloadLayout</a>(
01071     IN <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
01072     IN DWORD dwFlag)
01073 {
01074     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndDefaultIme;
01075     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01076     ULONG_PTR dwResult;
01077     LRESULT r;
01078 
01079     <span class="comment">/*</span>
01080 <span class="comment">     * Do nothing if the thread does not have default IME window.</span>
01081 <span class="comment">     */</span>
01082     <span class="keywordflow">if</span> (pti-&gt;spwndDefaultIme == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01083         <span class="keywordflow">return</span>;
01084 
01085     <span class="keywordflow">if</span> (pti-&gt;spklActive == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01086         <span class="keywordflow">return</span>;
01087 
01088     <span class="keywordflow">if</span> (dwFlag == <a class="code" href="../../d8/d0/immstruc_8h.html#a15">IFL_DEACTIVATEIME</a> &amp;&amp;
01089             !<a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(pti-&gt;spklActive-&gt;hkl))
01090         <span class="keywordflow">return</span>;
01091 
01092     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
01093 
01094     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a>, &amp;tlpwndDefaultIme);
01095     r = <a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>(pti-&gt;spwndDefaultIme, WM_IME_SYSTEM,
01096                           IMS_UNLOADTHREADLAYOUT, (LONG)dwFlag,
01097                           SMTO_NOTIMEOUTIFNOTHUNG, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a912">CMSHUNGAPPTIMEOUT</a>, &amp;dwResult);
01098 
01099     <span class="keywordflow">if</span> (!r) {
01100         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Timeout in xxxImmUnloadLayout: perhaps this thread (0x%x) is not pumping messages."</span>,
01101                 pti-&gt;pEThread-&gt;Cid.UniqueThread);
01102     }
01103 
01104     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndDefaultIme);
01105 
01106     <span class="keywordflow">return</span>;
01107 }
01108 
01109 <span class="comment">/**************************************************************************\</span>
01110 <span class="comment">* xxxImmLoadLayout</span>
01111 <span class="comment">*</span>
01112 <span class="comment">* Retrieves extended IMEINFO for the given IME based keyboard layout.</span>
01113 <span class="comment">*</span>
01114 <span class="comment">* History:</span>
01115 <span class="comment">* 21-Mar-1996 wkwok       Created</span>
01116 <span class="comment">\**************************************************************************/</span>
01117 
<a name="l01118"></a><a class="code" href="../../d4/d1/userk_8h.html#a2044">01118</a> <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a> <a class="code" href="../../d4/d1/userk_8h.html#a2044">xxxImmLoadLayout</a>(
01119     IN HKL hKL)
01120 {
01121     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a>  piiex;
01122     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01123     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlPool;
01124 
01125     <span class="comment">/*</span>
01126 <span class="comment">     * No IMEINFOEX for non-IME based keyboard layout.</span>
01127 <span class="comment">     */</span>
01128     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(hKL))
01129         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01130 
01131     piiex = (<a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a>)UserAllocPool(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a>), TAG_IME);
01132 
01133     <span class="keywordflow">if</span> (piiex == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01134         RIPMSG1(RIP_WARNING,
01135               <span class="stringliteral">"xxxImmLoadLayout: failed to create piiex for hkl = %lx"</span>, hKL);
01136         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01137     }
01138 
01139     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01140 
01141     <span class="comment">/*</span>
01142 <span class="comment">     * Lock this allocations since we are going to the client side</span>
01143 <span class="comment">     */</span>
01144     <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(ptiCurrent, piiex, &amp;tlPool);
01145 
01146     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1929">ClientImmLoadLayout</a>(hKL, piiex)) {
01147         <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(ptiCurrent, &amp;tlPool);
01148         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01149     }
01150 
01151     <a class="code" href="../../d4/d1/userk_8h.html#a138">ThreadUnlockPool</a>(ptiCurrent, &amp;tlPool);
01152 
01153     <span class="keywordflow">return</span> piiex;
01154 }
01155 
01156 
01157 <span class="comment">/**************************************************************************\</span>
01158 <span class="comment">* GetImeInfoEx</span>
01159 <span class="comment">*</span>
01160 <span class="comment">* Query extended IMEINFO.</span>
01161 <span class="comment">*</span>
01162 <span class="comment">* History:</span>
01163 <span class="comment">* 21-Mar-1996 wkwok       Created</span>
01164 <span class="comment">\**************************************************************************/</span>
01165 
<a name="l01166"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a16">01166</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2045">GetImeInfoEx</a>(
01167     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta,
01168     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a> piiex,
01169     IMEINFOEXCLASS SearchType)
01170 {
01171     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl, pklFirst;
01172 
01173     <span class="comment">/*</span>
01174 <span class="comment">     * Note: this check was forced to insert due to winmm.dll who indirectly</span>
01175 <span class="comment">     * loads imm32.dll in CSRSS context. CSRSS is not always bound to</span>
01176 <span class="comment">     * specific window station, thus pwinsta could be NULL.</span>
01177 <span class="comment">     * This has been avoided by not loading imm32.dll.</span>
01178 <span class="comment">     * After winmm.dll gets removed from CSRSS, this if statement should be</span>
01179 <span class="comment">     * removed, or substituted as an assertion.</span>
01180 <span class="comment">     */</span>
01181     <span class="keywordflow">if</span> (pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01182         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01183     }
01184 
01185     <span class="comment">/*</span>
01186 <span class="comment">     * Keyboard layer has not been initialized.</span>
01187 <span class="comment">     */</span>
01188     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01189         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01190 
01191     pkl = pklFirst = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>;
01192 
01193     <span class="keywordflow">switch</span> (SearchType) {
01194     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>:
01195         <span class="keywordflow">do</span> {
01196             <span class="keywordflow">if</span> (pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a> == piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a>) {
01197 
01198                 <span class="keywordflow">if</span> (pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o10">piiex</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01199                     <span class="keywordflow">break</span>;
01200 
01201                 RtlCopyMemory(piiex, pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o10">piiex</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a>));
01202                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01203             }
01204             pkl = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>;
01205         } <span class="keywordflow">while</span> (pkl != pklFirst);
01206         <span class="keywordflow">break</span>;
01207 
01208     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a75a54">ImeInfoExImeFileName</a>:
01209         <span class="keywordflow">do</span> {
01210             <span class="keywordflow">if</span> (pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o10">piiex</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01211                 !_wcsnicmp(pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o10">piiex</a>-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>, piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>, <a class="code" href="../../d8/d0/immstruc_8h.html#a22">IM_FILE_SIZE</a>)) {
01212 
01213                 RtlCopyMemory(piiex, pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o10">piiex</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a>));
01214                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01215             }
01216             pkl = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>;
01217         } <span class="keywordflow">while</span> (pkl != pklFirst);
01218         <span class="keywordflow">break</span>;
01219 
01220     <span class="keywordflow">default</span>:
01221         <span class="keywordflow">break</span>;
01222     }
01223 
01224     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01225 }
01226 
01227 
01228 <span class="comment">/**************************************************************************\</span>
01229 <span class="comment">* SetImeInfoEx</span>
01230 <span class="comment">*</span>
01231 <span class="comment">* Set extended IMEINFO.</span>
01232 <span class="comment">*</span>
01233 <span class="comment">* History:</span>
01234 <span class="comment">* 21-Mar-1996 wkwok       Created</span>
01235 <span class="comment">\**************************************************************************/</span>
01236 
<a name="l01237"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a17">01237</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2046">SetImeInfoEx</a>(
01238     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta,
01239     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a> piiex)
01240 {
01241     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl, pklFirst;
01242 
01243     <span class="keywordflow">if</span> (pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01244         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01245     }
01246 
01247     UserAssert(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01248 
01249     pkl = pklFirst = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>;
01250 
01251     <span class="keywordflow">do</span> {
01252         <span class="keywordflow">if</span> (pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a> == piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a>) {
01253 
01254             <span class="comment">/*</span>
01255 <span class="comment">             * Error out for non-IME based keyboard layout.</span>
01256 <span class="comment">             */</span>
01257             <span class="keywordflow">if</span> (pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o10">piiex</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01258                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01259 
01260             <span class="comment">/*</span>
01261 <span class="comment">             * Update kernel side IMEINFOEX for this keyboard layout</span>
01262 <span class="comment">             * only if this is its first loading.</span>
01263 <span class="comment">             */</span>
01264             <span class="keywordflow">if</span> (pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o10">piiex</a>-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o5">fLoadFlag</a> == <a class="code" href="../../d8/d0/immstruc_8h.html#a18">IMEF_NONLOAD</a>) {
01265                 RtlCopyMemory(pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o10">piiex</a>, piiex, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a>));
01266             }
01267 
01268             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01269         }
01270         pkl = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>;
01271 
01272     } <span class="keywordflow">while</span> (pkl != pklFirst);
01273 
01274     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01275 }
01276 
01277 
01278 <span class="comment">/***************************************************************************\</span>
01279 <span class="comment">* xxxImmProcessKey</span>
01280 <span class="comment">*</span>
01281 <span class="comment">*</span>
01282 <span class="comment">* History:</span>
01283 <span class="comment">* 03-03-96 TakaoK             Created.</span>
01284 <span class="comment">\***************************************************************************/</span>
01285 
<a name="l01286"></a><a class="code" href="../../d4/d1/userk_8h.html#a2047">01286</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a2047">xxxImmProcessKey</a>(
01287     IN <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>   pq,
01288     IN <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
01289     IN UINT message,
01290     IN WPARAM wParam,
01291     IN LPARAM lParam)
01292 {
01293     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  uVKey;
01294     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a>   pkl;
01295     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwHotKeyID;
01296     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwReturn = 0;
01297     <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a>  pImc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01298     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fDBERoman = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01299     <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> pImeHotKeyObj;
01300     HKL hklTarget;
01301 
01302     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01303 
01304     <span class="comment">//</span>
01305     <span class="comment">// we're interested in only keyboard messages.</span>
01306     <span class="comment">//</span>
01307     <span class="keywordflow">if</span> ( message != WM_KEYDOWN    &amp;&amp;
01308          message != WM_SYSKEYDOWN &amp;&amp;
01309          message != WM_KEYUP      &amp;&amp;
01310          message != WM_SYSKEYUP ) {
01311 
01312         <span class="keywordflow">return</span> dwReturn;
01313     }
01314 
01315     <span class="comment">//</span>
01316     <span class="comment">// Check if it's IME hotkey. This must be done before checking</span>
01317     <span class="comment">// the keyboard layout because IME hotkey handler should be</span>
01318     <span class="comment">// called even if current keyboard layout is non-IME layout.</span>
01319     <span class="comment">//</span>
01320     pkl = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;spklActive;
01321     <span class="keywordflow">if</span> ( pkl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01322         <span class="keywordflow">return</span> dwReturn;
01323     }
01324 
01325     uVKey = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam &amp; 0xff;
01326 
01327     pImeHotKeyObj = <a class="code" href="../../d4/d1/userk_8h.html#a2050">CheckImeHotKey</a>(pq, uVKey, lParam);
01328     <span class="keywordflow">if</span> (pImeHotKeyObj) {
01329         dwHotKeyID = pImeHotKeyObj-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o0">dwHotKeyID</a>;
01330         hklTarget = pImeHotKeyObj-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o3">hKL</a>;
01331     }
01332     <span class="keywordflow">else</span> {
01333         dwHotKeyID = IME_INVALID_HOTKEY;
01334         hklTarget = (HKL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01335     }
01336 
01337     <span class="comment">//</span>
01338     <span class="comment">// Handle Direct KL switching here.</span>
01339     <span class="comment">//</span>
01340     <span class="keywordflow">if</span> (dwHotKeyID &gt;= IME_HOTKEY_DSWITCH_FIRST &amp;&amp; dwHotKeyID &lt;= IME_HOTKEY_DSWITCH_LAST) {
01341         UserAssert(hklTarget != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01342         <span class="keywordflow">if</span> (pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a> != hklTarget) {
01343             <span class="comment">//</span>
01344             <span class="comment">// Post the message only if the new Keyboard Layout is different from</span>
01345             <span class="comment">// the current Keyboard Layout.</span>
01346             <span class="comment">//</span>
01347             <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, WM_INPUTLANGCHANGEREQUEST,
01348                          (pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o6">dwFontSigs</a> &amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a64">gSystemFS</a>) ? INPUTLANGCHANGE_SYSCHARSET : 0,
01349                          (LPARAM)hklTarget);
01350         }
01351         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a36">GetAppImeCompatFlags</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)) &amp; IMECOMPAT_HYDRACLIENT) {
01352             <span class="keywordflow">return</span> 0;
01353         }
01354         <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/conimep_8h.html#a46">IPHK_HOTKEY</a>;
01355     }
01356 
01357     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
01358         <span class="comment">//</span>
01359         <span class="comment">// Since IMM is disabled, no need to process further.</span>
01360         <span class="comment">// Just bail out.</span>
01361         <span class="comment">//</span>
01362         <span class="keywordflow">return</span> 0;
01363     }
01364 
01365     <span class="keywordflow">if</span> ( dwHotKeyID != IME_INVALID_HOTKEY ) {
01366         <span class="comment">//</span>
01367         <span class="comment">// if it's a valid hotkey, go straight and call back</span>
01368         <span class="comment">// the IME in the client side.</span>
01369         <span class="comment">//</span>
01370         <span class="keywordflow">goto</span> ProcessKeyCallClient;
01371     }
01372 
01373     <span class="comment">//</span>
01374     <span class="comment">// if it's not a hotkey, we may want to check something</span>
01375     <span class="comment">// before calling back.</span>
01376     <span class="comment">//</span>
01377     <span class="keywordflow">if</span> ( pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o10">piiex</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01378         <span class="keywordflow">return</span> dwReturn;
01379     }
01380 
01381     <span class="comment">//</span>
01382     <span class="comment">// Check input context</span>
01383     <span class="comment">//</span>
01384     pImc = <a class="code" href="../../d4/d1/userk_8h.html#a102">HtoP</a>(pwnd-&gt;hImc);
01385     <span class="keywordflow">if</span> ( pImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01386         <span class="keywordflow">return</span> dwReturn;
01387     }
01388 
01389 <span class="preprocessor">#ifdef LATER</span>
01390 <span class="preprocessor"></span>    <span class="comment">//</span>
01391     <span class="comment">// If there is an easy way to check the input context open/close status</span>
01392     <span class="comment">// from the kernel side, IME_PROP_NO_KEYS_ON_CLOSE checking should be</span>
01393     <span class="comment">// done here in kernel side.  [ 3/10/96 takaok]</span>
01394     <span class="comment">//</span>
01395 
01396     <span class="comment">//</span>
01397     <span class="comment">// Check IME_PROP_NO_KEYS_ON_CLOSE bit</span>
01398     <span class="comment">//</span>
01399     <span class="comment">// if the current imc is not open and IME doesn't need</span>
01400     <span class="comment">// keys when being closed, we don't pass any keyboard</span>
01401     <span class="comment">// input to ime except hotkey and keys that change</span>
01402     <span class="comment">// the keyboard status.</span>
01403     <span class="comment">//</span>
01404     <span class="keywordflow">if</span> ( (piix-&gt;ImeInfo.fdwProperty &amp; IME_PROP_NO_KEYS_ON_CLOSE) &amp;&amp;
01405          (!pimc-&gt;fdwState &amp; IMC_OPEN)                            &amp;&amp;
01406          uVKey != VK_SHIFT                                       &amp;&amp;  <span class="comment">// 0x10</span>
01407          uVKey != VK_CONTROL                                     &amp;&amp;  <span class="comment">// 0x11</span>
01408          uVKey != VK_CAPITAL                                     &amp;&amp;  <span class="comment">// 0x14</span>
01409          uVKey != VK_KANA                                        &amp;&amp;  <span class="comment">// 0x15</span>
01410          uVKey != VK_NUMLOCK                                     &amp;&amp;  <span class="comment">// 0x90</span>
01411          uVKey != VK_SCROLL )                                        <span class="comment">// 0x91</span>
01412     {
01413       <span class="comment">// Check if Korea Hanja conversion mode</span>
01414       <span class="keywordflow">if</span>( !(pimc-&gt;fdwConvMode &amp; IME_CMODE_HANJACONVERT) ) {
01415           <span class="keywordflow">return</span> dwReturn;
01416       }
01417     }
01418 <span class="preprocessor">#endif</span>
01419 <span class="preprocessor"></span>
01420     <span class="comment">//</span>
01421     <span class="comment">// if the IME doesn't need key up messages, we don't call ime.</span>
01422     <span class="comment">//</span>
01423     <span class="keywordflow">if</span> ( lParam &amp; 0x80000000 &amp;&amp; <span class="comment">// set if key up, clear if key down</span>
01424          pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o10">piiex</a>-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o1">ImeInfo</a>.fdwProperty &amp; IME_PROP_IGNORE_UPKEYS )
01425     {
01426         <span class="keywordflow">return</span> dwReturn;
01427     }
01428 
01429     <span class="comment">//</span>
01430     <span class="comment">// we don't want to handle sys keys since many functions for</span>
01431     <span class="comment">// acceelerators won't work without this</span>
01432     <span class="comment">//</span>
01433     fDBERoman = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)( (uVKey == VK_DBE_ROMAN)            ||
01434                         (uVKey == VK_DBE_NOROMAN)          ||
01435                         (uVKey == VK_DBE_HIRAGANA)         ||
01436                         (uVKey == VK_DBE_KATAKANA)         ||
01437                         (uVKey == VK_DBE_CODEINPUT)        ||
01438                         (uVKey == VK_DBE_NOCODEINPUT)      ||
01439                         (uVKey == VK_DBE_IME_WORDREGISTER) ||
01440                         (uVKey == VK_DBE_IME_DIALOG) );
01441 
01442     <span class="keywordflow">if</span> (message == WM_SYSKEYDOWN || message == WM_SYSKEYUP ) {
01443         <span class="comment">//</span>
01444         <span class="comment">// IME may be waiting for VK_MENU, VK_F10 or VK_DBE_xxx</span>
01445         <span class="comment">//</span>
01446         <span class="keywordflow">if</span> ( uVKey != VK_MENU &amp;&amp; uVKey != VK_F10 &amp;&amp; !fDBERoman ) {
01447             <span class="keywordflow">return</span> dwReturn;
01448         }
01449     }
01450 
01451     <span class="comment">//</span>
01452     <span class="comment">// check if the IME doesn't need ALT key</span>
01453     <span class="comment">//</span>
01454     <span class="keywordflow">if</span> ( !(pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o10">piiex</a>-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o1">ImeInfo</a>.fdwProperty &amp; IME_PROP_NEED_ALTKEY) ) {
01455         <span class="comment">//</span>
01456         <span class="comment">// IME doesn't need ALT key</span>
01457         <span class="comment">//</span>
01458         <span class="comment">// we don't pass the ALT and ALT+xxx except VK_DBE_xxx keys.</span>
01459         <span class="comment">//</span>
01460         <span class="keywordflow">if</span> ( ! fDBERoman &amp;&amp;
01461              (uVKey == VK_MENU || (lParam &amp; 0x20000000))  <span class="comment">// KF_ALTDOWN</span>
01462            )
01463         {
01464             <span class="keywordflow">return</span> dwReturn;
01465         }
01466     }
01467 
01468     <span class="comment">//</span>
01469     <span class="comment">// finaly call back the client</span>
01470     <span class="comment">//</span>
01471 
01472 ProcessKeyCallClient:
01473 
01474     <span class="keywordflow">if</span> ((uVKey &amp; 0xff) == VK_PACKET) {
01475         <span class="comment">//</span>
01476         <span class="comment">// need to retrieve UNICODE character from pti</span>
01477         <span class="comment">//</span>
01478         uVKey = MAKELONG(wParam, <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;wchInjected);
01479     }
01480     dwReturn = <a class="code" href="../../d4/d1/userk_8h.html#a1930">ClientImmProcessKey</a>( <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwnd),
01481                                     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>,
01482                                     uVKey,
01483                                     lParam,
01484                                     dwHotKeyID);
01485 
01486     <span class="comment">//</span>
01487     <span class="comment">// Hydra server wants to see the IME hotkeys.</span>
01488     <span class="comment">//</span>
01489     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a36">GetAppImeCompatFlags</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)) &amp; IMECOMPAT_HYDRACLIENT) {
01490         dwReturn &amp;= ~<a class="code" href="../../d4/d5/conimep_8h.html#a46">IPHK_HOTKEY</a>;
01491     }
01492     <span class="keywordflow">return</span> dwReturn;
01493 }
01494 
01495 
01496 <span class="comment">/**************************************************************************\</span>
01497 <span class="comment">* ImeCanDestroyDefIME</span>
01498 <span class="comment">*</span>
01499 <span class="comment">* History:</span>
01500 <span class="comment">* 02-Apr-1996 wkwok       Ported from FE Win95 (imeclass.c)</span>
01501 <span class="comment">\**************************************************************************/</span>
01502 
<a name="l01503"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a19">01503</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2051">ImeCanDestroyDefIME</a>(
01504     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDefaultIme,
01505     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDestroy)
01506 {
01507     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd;
01508     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui;
01509 
01510     pimeui = ((<a class="code" href="../../d5/d8/structtagIMEWND.html">PIMEWND</a>)pwndDefaultIme)-&gt;pimeui;
01511 
01512     <span class="keywordflow">if</span> (pimeui == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || (LONG_PTR)pimeui == (LONG_PTR)-1)
01513         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01514 
01515     <span class="keywordflow">try</span> {
01516         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(pimeui, <a class="code" href="../../d4/d8/structtagIMEUI.html">IMEUI</a>).fDestroy) {
01517             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01518         }
01519     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
01520     }
01521 
01522     <span class="comment">/*</span>
01523 <span class="comment">     * If the pwndDestroy has no owner/ownee relationship with</span>
01524 <span class="comment">     * pwndDefaultIme, don't bother to change anything.</span>
01525 <span class="comment">     *</span>
01526 <span class="comment">     * If pwndDefaultIme-&gt;spwndOwner is NULL, this means we need</span>
01527 <span class="comment">     * to search for a new good owner window.</span>
01528 <span class="comment">     */</span>
01529     <span class="keywordflow">if</span> ( pwndDefaultIme-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01530         <span class="keywordflow">for</span> (pwnd = pwndDefaultIme-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
01531              pwnd != pwndDestroy &amp;&amp; pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>) ;
01532 
01533         <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01534             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01535     }
01536 
01537     <span class="comment">/*</span>
01538 <span class="comment">     * If the destroying window is IME or UI window, do nothing</span>
01539 <span class="comment">     */</span>
01540     pwnd = pwndDestroy;
01541 
01542     <span class="keywordflow">while</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01543         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>) ||
01544                 pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>])
01545             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01546 
01547         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
01548     }
01549 
01550     <a class="code" href="../../d4/d1/userk_8h.html#a2055">ImeSetFutureOwner</a>(pwndDefaultIme, pwndDestroy);
01551 
01552     <span class="comment">/*</span>
01553 <span class="comment">     * If new owner is lower z-order than IME class window,</span>
01554 <span class="comment">     * we need to check topmost to change z-order.</span>
01555 <span class="comment">     */</span>
01556     pwnd = pwndDefaultIme-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
01557     <span class="keywordflow">while</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pwnd != pwndDefaultIme)
01558         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01559 
01560     <span class="keywordflow">if</span> (pwnd == pwndDefaultIme)
01561         <a class="code" href="../../d4/d1/userk_8h.html#a2054">ImeCheckTopmost</a>(pwndDefaultIme);
01562 
01563 <span class="preprocessor">#if DBG</span>
01564 <span class="preprocessor"></span>    CheckOwnerCirculate(pwndDefaultIme);
01565 <span class="preprocessor">#endif</span>
01566 <span class="preprocessor"></span>
01567     <span class="comment">/*</span>
01568 <span class="comment">     * If ImeSetFutureOwner can not find the owner window any</span>
01569 <span class="comment">     * more, this IME window should be destroyed.</span>
01570 <span class="comment">     */</span>
01571     <span class="keywordflow">if</span> (pwndDefaultIme-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01572             pwndDestroy == pwndDefaultIme-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>) {
01573 
01574 <span class="comment">//        RIPMSG1(RIP_WARNING, "ImeCanDestroyDefIME: TRUE for pwnd=%#p", pwndDestroy);</span>
01575         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pwndDefaultIme-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>);
01576 
01577         <span class="comment">/*</span>
01578 <span class="comment">         * Return TRUE! Please destroy me.</span>
01579 <span class="comment">         */</span>
01580         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01581     }
01582 
01583     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01584 }
01585 
01586 
01587 <span class="comment">/**************************************************************************\</span>
01588 <span class="comment">* IsChildSameThread (IsChildSameQ)</span>
01589 <span class="comment">*</span>
01590 <span class="comment">* History:</span>
01591 <span class="comment">* 02-Apr-1996 wkwok       Ported from FE Win95 (imeclass.c)</span>
01592 <span class="comment">\**************************************************************************/</span>
01593 
<a name="l01594"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a20">01594</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2052">IsChildSameThread</a>(
01595     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent,
01596     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndChild)
01597 {
01598     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01599     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiChild = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndChild);
01600 
01601     <span class="keywordflow">for</span> (pwnd = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>; pwnd; pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
01602         <span class="comment">/*</span>
01603 <span class="comment">         * If pwnd is not child window, we need to skip MENU window and</span>
01604 <span class="comment">         * IME related window.</span>
01605 <span class="comment">         */</span>
01606         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd)) {
01607             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOwner = pwnd;
01608             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFoundOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01609 
01610             <span class="comment">/*</span>
01611 <span class="comment">             * Skip MENU window.</span>
01612 <span class="comment">             */</span>
01613             <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a77">ICLS_MENU</a>])
01614                 <span class="keywordflow">continue</span>;
01615 
01616             <span class="keywordflow">while</span> (pwndOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01617                 <span class="comment">/*</span>
01618 <span class="comment">                 * CS_IME class or "IME" class windows can not be the owner of</span>
01619 <span class="comment">                 * IME windows.</span>
01620 <span class="comment">                 */</span>
01621                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwndOwner, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>) ||
01622                         pwndOwner-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>]) {
01623                     fFoundOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01624                     <span class="keywordflow">break</span>;
01625                 }
01626 
01627                 pwndOwner = pwndOwner-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
01628             }
01629 
01630             <span class="keywordflow">if</span> (fFoundOwner)
01631                 <span class="keywordflow">continue</span>;
01632         }
01633 
01634         <span class="comment">/*</span>
01635 <span class="comment">         * We need to skip pwndChild.</span>
01636 <span class="comment">         */</span>
01637         <span class="keywordflow">if</span> (pwnd == pwndChild)
01638             <span class="keywordflow">continue</span>;
01639 
01640         <span class="comment">/*</span>
01641 <span class="comment">         * pwnd and pwndChild are on same thread?</span>
01642 <span class="comment">         */</span>
01643         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) == ptiChild) {
01644             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT = pwnd;
01645             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFoundImeWnd = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01646 
01647             <span class="comment">/*</span>
01648 <span class="comment">             * Check again. If hwndT is children or ownee of</span>
01649 <span class="comment">             * IME related window, skip it.</span>
01650 <span class="comment">             */</span>
01651             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwndT)) {
01652 
01653                 <span class="keywordflow">for</span> (; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwndT) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT) == ptiChild;
01654                         pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
01655                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>) ||
01656                             pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>])
01657                         fFoundImeWnd = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01658                 }
01659             }
01660 
01661             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwndT)) {
01662 
01663                 <span class="keywordflow">for</span> (; pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT) == ptiChild;
01664                         pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>) {
01665                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>) ||
01666                             pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>])
01667                         fFoundImeWnd = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01668                 }
01669             }
01670 
01671             <span class="keywordflow">if</span> (!fFoundImeWnd)
01672                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01673         }
01674     }
01675 
01676     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01677 }
01678 
01679 
01680 <span class="comment">/**************************************************************************\</span>
01681 <span class="comment">* ImeCanDestroyDefIMEforChild</span>
01682 <span class="comment">*</span>
01683 <span class="comment">* History:</span>
01684 <span class="comment">* 02-Apr-1996 wkwok       Ported from FE Win95 (imeclass.c)</span>
01685 <span class="comment">\**************************************************************************/</span>
01686 
<a name="l01687"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a21">01687</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2053">ImeCanDestroyDefIMEforChild</a>(
01688     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDefaultIme,
01689     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDestroy)
01690 {
01691     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01692     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui;
01693 
01694     pimeui = ((<a class="code" href="../../d5/d8/structtagIMEWND.html">PIMEWND</a>)pwndDefaultIme)-&gt;pimeui;
01695 
01696     <span class="comment">/*</span>
01697 <span class="comment">     * If this window is not for Child Thread.....</span>
01698 <span class="comment">     */</span>
01699     <span class="keywordflow">if</span> (pimeui == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || (LONG_PTR)pimeui == (LONG_PTR)-1)
01700         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01701 
01702     <span class="keywordflow">try</span> {
01703         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(pimeui, <a class="code" href="../../d4/d8/structtagIMEUI.html">IMEUI</a>).fChildThreadDef) {
01704             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01705         }
01706     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
01707     }
01708 
01709     <span class="comment">/*</span>
01710 <span class="comment">     * If parent belongs to different thread,</span>
01711 <span class="comment">     * we don't need to check any more...</span>
01712 <span class="comment">     */</span>
01713     <span class="keywordflow">if</span> (pwndDestroy-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01714             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndDestroy) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndDestroy-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>))
01715         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01716 
01717     pwnd = pwndDestroy;
01718 
01719     <span class="keywordflow">while</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
01720         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2052">IsChildSameThread</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>, pwndDestroy))
01721             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01722         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
01723     }
01724 
01725     <span class="comment">/*</span>
01726 <span class="comment">     * We could not find any other window created by GETPTI(pwndDestroy).</span>
01727 <span class="comment">     * Let's destroy the default IME window of this Q.</span>
01728 <span class="comment">     */</span>
01729     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01730 }
01731 
01732 
01733 <span class="comment">/**************************************************************************\</span>
01734 <span class="comment">* ImeCheckTopmost</span>
01735 <span class="comment">*</span>
01736 <span class="comment">* History:</span>
01737 <span class="comment">* 02-Apr-1996 wkwok       Ported from FE Win95 (imeclass.c)</span>
01738 <span class="comment">\**************************************************************************/</span>
01739 
<a name="l01740"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a22">01740</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a2054">ImeCheckTopmost</a>(
01741     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndIme)
01742 {
01743     <span class="keywordflow">if</span> (pwndIme-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>) {
01744         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndInsertBeforeThis;
01745         <span class="comment">/*</span>
01746 <span class="comment">         * The ime window have to be same topmost tyle with the owner window.</span>
01747 <span class="comment">         * If the Q of this window is not foreground Q, we don't need to</span>
01748 <span class="comment">         * forground the IME window.</span>
01749 <span class="comment">         * But the topmost attribute of owner was changed, this IME window</span>
01750 <span class="comment">         * should be re-calced.</span>
01751 <span class="comment">         */</span>
01752         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndIme) == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>) {
01753             pwndInsertBeforeThis = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01754         } <span class="keywordflow">else</span> {
01755             pwndInsertBeforeThis = pwndIme-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
01756         }
01757 
01758         <a class="code" href="../../d4/d1/userk_8h.html#a2057">ImeSetTopmost</a>(pwndIme, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndIme-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>) != 0, pwndInsertBeforeThis);
01759     }
01760 }
01761 
01762 
01763 <span class="comment">/**************************************************************************\</span>
01764 <span class="comment">* ImeSetFutureOwner</span>
01765 <span class="comment">*</span>
01766 <span class="comment">* History:</span>
01767 <span class="comment">* 02-Apr-1996 wkwok       Ported from FE Win95 (imeclass.c)</span>
01768 <span class="comment">\**************************************************************************/</span>
01769 
<a name="l01770"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a23">01770</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a2055">ImeSetFutureOwner</a>(
01771     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndIme,
01772     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOrgOwner)
01773 {
01774     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, pwndOwner;
01775     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiImeWnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndIme);
01776 
01777     <span class="keywordflow">if</span> (pwndOrgOwner == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOrgOwner, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>))
01778         <span class="keywordflow">return</span>;
01779 
01780     pwnd = pwndOrgOwner;
01781 
01782     <span class="comment">/*</span>
01783 <span class="comment">     * Get top of owner created by the same thread.</span>
01784 <span class="comment">     */</span>
01785     <span class="keywordflow">while</span> ((pwndOwner = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01786             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndOwner) == ptiImeWnd)
01787         pwnd = pwndOwner;
01788 
01789     <span class="comment">/*</span>
01790 <span class="comment">     * Bottom window can not be the owner of IME window easily...</span>
01791 <span class="comment">     */</span>
01792     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOrgOwner, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>))
01793         pwnd = pwndOrgOwner;
01794 
01795     <span class="comment">/*</span>
01796 <span class="comment">     * CS_IME class or "IME" class windows can not be the owner of</span>
01797 <span class="comment">     * IME windows.</span>
01798 <span class="comment">     */</span>
01799     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>) ||
01800             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>])
01801         pwnd = pwndOrgOwner;
01802 
01803     <span class="comment">/*</span>
01804 <span class="comment">     * If hwndOrgOwner is a top of owner, we start to search</span>
01805 <span class="comment">     * another top owner window in same queue.</span>
01806 <span class="comment">     */</span>
01807     <span class="keywordflow">if</span> (pwndOrgOwner == pwnd &amp;&amp; pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01808         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
01809 
01810         <span class="keywordflow">for</span> (pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
01811                 pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
01812 
01813             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT))
01814                 <span class="keywordflow">continue</span>;
01815 
01816             <span class="keywordflow">if</span> (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a77">ICLS_MENU</a>])
01817                 <span class="keywordflow">continue</span>;
01818 
01819             <span class="comment">/*</span>
01820 <span class="comment">             * CS_IME class or "IME" class windows can not be the owner of</span>
01821 <span class="comment">             * IME windows.</span>
01822 <span class="comment">             */</span>
01823             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>) ||
01824                     pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>])
01825                 <span class="keywordflow">continue</span>;
01826 
01827             <span class="comment">// We don't like the window that is being destroyed.</span>
01828             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a591">WFINDESTROY</a>))
01829                 <span class="keywordflow">continue</span>;
01830 
01831             <span class="comment">/*</span>
01832 <span class="comment">             * !!!!WARNING!!!!!</span>
01833 <span class="comment">             * Is hwndT a good owner of hIMEwnd??</span>
01834 <span class="comment">             *  1. Of cource, it should no CHILD window!</span>
01835 <span class="comment">             *  2. If it is hwnd,.. I know it and find next!</span>
01836 <span class="comment">             *  3. Does hwndT have owner in the same thread?</span>
01837 <span class="comment">             */</span>
01838             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>) &amp;&amp; pwnd != pwndT &amp;&amp;
01839                     (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01840                      <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>))) {
01841                 UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndIme) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT));
01842                 pwnd = pwndT;
01843                 <span class="keywordflow">break</span>;
01844             }
01845         }
01846     }
01847 
01848     UserAssert(!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>));
01849     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwndIme-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>, pwnd);
01850 
01851     <span class="keywordflow">return</span>;
01852 }
01853 
01854 
01855 <span class="comment">/**************************************************************************\</span>
01856 <span class="comment">* ImeSetTopmostChild</span>
01857 <span class="comment">*</span>
01858 <span class="comment">* History:</span>
01859 <span class="comment">* 02-Apr-1996 wkwok       Ported from FE Win95 (imeclass.c)</span>
01860 <span class="comment">\**************************************************************************/</span>
01861 
<a name="l01862"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a24">01862</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a2056">ImeSetTopmostChild</a>(
01863     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent,
01864     BOOL fMakeTopmost)
01865 {
01866     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
01867 
01868     <span class="keywordflow">while</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01869         <span class="keywordflow">if</span> (fMakeTopmost)
01870             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>);
01871         <span class="keywordflow">else</span>
01872             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>);
01873 
01874         <a class="code" href="../../d4/d1/userk_8h.html#a2056">ImeSetTopmostChild</a>(pwnd, fMakeTopmost);
01875 
01876         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01877     }
01878 
01879     <span class="keywordflow">return</span>;
01880 }
01881 
01882 
01883 <span class="comment">/**************************************************************************\</span>
01884 <span class="comment">*</span>
01885 <span class="comment">*  GetLastTopMostWindowNoIME() -</span>
01886 <span class="comment">*</span>
01887 <span class="comment">*  Get the last topmost window which is not the ownee of pwndRoot (IME window).</span>
01888 <span class="comment">*</span>
01889 <span class="comment">\**************************************************************************/</span>
01890 
<a name="l01891"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a25">01891</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d5/d8/ntimm_8c.html#a25">GetLastTopMostWindowNoIME</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndRoot)
01892 {
01893     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT = <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>();
01894     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndRet = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01895 
01896     <span class="comment">/*</span>
01897 <span class="comment">     * pwndRoot should not be NULL, and should be IME window.</span>
01898 <span class="comment">     */</span>
01899     UserAssert(pwndRoot &amp;&amp; pwndRoot-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>]);
01900 
01901     <span class="keywordflow">if</span> (pwndT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01902 <span class="preprocessor">#if _DBG</span>
01903 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (pwndT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01904             RIPMSG0(RIP_WARNING, <span class="stringliteral">"GetLastTopMostWindowNoIME: there's no desktop window !!"</span>);
01905         }
01906         <span class="keywordflow">else</span> {
01907             RIPMSG0(RIP_WARNING, <span class="stringliteral">"GetLastTopMostWindowNoIME: there is no toplevel window !!"</span>);
01908         }
01909 <span class="preprocessor">#endif</span>
01910 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01911     }
01912 
01913     <span class="comment">/*</span>
01914 <span class="comment">     * Get the first child of the desktop window.</span>
01915 <span class="comment">     */</span>
01916     pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
01917 
01918     <span class="comment">/*</span>
01919 <span class="comment">     * Loop through the toplevel windows while they are topmost.</span>
01920 <span class="comment">     */</span>
01921     <span class="keywordflow">while</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)) {
01922         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOwner = pwndT;
01923         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fOwned = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01924 
01925         <span class="comment">/*</span>
01926 <span class="comment">         * If pwndT is a IME related window, track the owner. If pwndRoot is not</span>
01927 <span class="comment">         * pwndT's owner, remember pwndT as a candidate.</span>
01928 <span class="comment">         */</span>
01929         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwndT,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>) || (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>])) {
01930             <span class="keywordflow">while</span> (pwndOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01931                 <span class="keywordflow">if</span> (pwndRoot == pwndOwner) {
01932                     fOwned = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01933                     <span class="keywordflow">break</span>;
01934                 }
01935                 pwndOwner = pwndOwner-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
01936             }
01937         }
01938         <span class="keywordflow">if</span> (!fOwned)
01939             pwndRet = pwndT;
01940 
01941         <span class="comment">/*</span>
01942 <span class="comment">         * Next toplevel window.</span>
01943 <span class="comment">         */</span>
01944         pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01945         UserAssert(pwndT-&gt;spwndParent == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1137">_GetDesktopWindow</a>());
01946     }
01947 
01948     <span class="keywordflow">return</span> pwndRet;
01949 }
01950 
01951 
01952 <span class="preprocessor">#if DBG</span>
01953 <span class="preprocessor"></span><span class="keywordtype">void</span> ImeCheckSetTopmostLink(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndInsFirst, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndIns)
01954 {
01955     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDebT0 = pwndInsFirst;
01956     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01957 
01958     <span class="keywordflow">if</span> (pwndDebT0) {
01959         <span class="keywordflow">while</span> (pwndDebT0 &amp;&amp; (pwndDebT0 != pwndIns)) {
01960             <span class="keywordflow">if</span> (pwndDebT0 == pwnd)
01961                 fFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01962 
01963             pwndDebT0 = pwndDebT0-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01964         }
01965 
01966         <span class="keywordflow">if</span> (pwndDebT0 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01967             RIPMSG3(RIP_ERROR, <span class="stringliteral">"pwndIns(%#p) is upper that pwndInsFirst(%#p) pwnd is (%#p)"</span>, pwndIns, pwndInsFirst, pwnd);
01968         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fFound) {
01969             RIPMSG3(RIP_ERROR, <span class="stringliteral">"pwnd(%#p) is between pwndInsFirst(%#p) and pwndIns(%#p)"</span>, pwnd, pwndInsFirst, pwndIns);
01970         }
01971     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pwndIns) {
01972         pwndDebT0 = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
01973 
01974         <span class="keywordflow">while</span> (pwndDebT0 &amp;&amp; (pwndDebT0 != pwndIns)) {
01975             <span class="keywordflow">if</span> (pwndDebT0 == pwnd)
01976                 fFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01977 
01978             pwndDebT0 = pwndDebT0-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01979         }
01980 
01981         <span class="keywordflow">if</span> (fFound) {
01982             RIPMSG3(RIP_ERROR, <span class="stringliteral">"pwnd(%#p) is between TOPLEVEL pwndInsFirst(%#p) and pwndIns(%#p)"</span>, pwnd, pwndInsFirst, pwndIns);
01983         }
01984     }
01985 }
01986 <span class="preprocessor">#endif</span>
01987 <span class="preprocessor"></span>
01988 <span class="comment">/**************************************************************************\</span>
01989 <span class="comment">* ImeSetTopmost</span>
01990 <span class="comment">*</span>
01991 <span class="comment">* History:</span>
01992 <span class="comment">* 02-Apr-1996 wkwok       Ported from FE Win95 (imeclass.c)</span>
01993 <span class="comment">\**************************************************************************/</span>
01994 
<a name="l01995"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a26">01995</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a2057">ImeSetTopmost</a>(
01996     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndRootIme,
01997     BOOL fMakeTopmost,
01998     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndInsertBefore)
01999 {
02000     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent = pwndRootIme-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
02001     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndInsert = <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>; <span class="comment">// pwnd which should be prior to pwndRootIme.</span>
02002     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, pwndT;
02003     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndInsertFirst;
02004     BOOLEAN fFound;
02005 
02006     <span class="keywordflow">if</span> (pwndParent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02007         <span class="keywordflow">return</span>;
02008 
02009     pwnd = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
02010 
02011     <span class="keywordflow">if</span> (!fMakeTopmost) {
02012         <span class="comment">/*</span>
02013 <span class="comment">         * Get the last topmost window. This should be after unlink pwndRootIme</span>
02014 <span class="comment">         * because pwndRootIme may be the last topmost window.</span>
02015 <span class="comment">         */</span>
02016         pwndInsert = <a class="code" href="../../d5/d8/ntimm_8c.html#a25">GetLastTopMostWindowNoIME</a>(pwndRootIme);
02017 
02018         <span class="keywordflow">if</span> (pwndInsertBefore) {
02019 
02020             fFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02021             pwndT = pwndInsert;
02022 
02023             <span class="keywordflow">while</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a> != pwndInsertBefore) {
02024                 <span class="keywordflow">if</span> (pwndT == pwndRootIme)
02025                     fFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02026                 pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
02027             }
02028 
02029             <span class="keywordflow">if</span> (pwndT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || fFound)
02030                 <span class="keywordflow">return</span>;
02031 
02032             pwndInsert = pwndT;
02033         }
02034 
02035         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndRootIme-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>)) {
02036             pwndT = pwndInsert;
02037 
02038             <span class="keywordflow">while</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pwndT != pwndRootIme-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>) {
02039                 <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>) &amp;&amp;
02040                         pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> != <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>]) {
02041                     pwndInsert = pwndT;
02042                 }
02043                 pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
02044             }
02045         }
02046     }
02047 
02048     pwndInsertFirst = pwndInsert;
02049 
02050     <span class="comment">/*</span>
02051 <span class="comment">     * Enum the all toplevel windows and if the owner of the window is same as</span>
02052 <span class="comment">     * the owner of pwndRootIme, the window should be changed the position of</span>
02053 <span class="comment">     * window link.</span>
02054 <span class="comment">     */</span>
02055     <span class="keywordflow">while</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02056         <span class="comment">/*</span>
02057 <span class="comment">         * Get the next window before calling ImeSetTopmost.</span>
02058 <span class="comment">         * Because the next window will be changed in LinkWindow.</span>
02059 <span class="comment">         */</span>
02060         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNext = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
02061 
02062         <span class="comment">/*</span>
02063 <span class="comment">         * the owner relation between IME and UI window is in same thread.</span>
02064 <span class="comment">         */</span>
02065         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndRootIme))
02066             <span class="keywordflow">goto</span> ist_next;
02067 
02068         <span class="comment">/*</span>
02069 <span class="comment">         * pwnd have to be CS_IME class or "IME" class.</span>
02070 <span class="comment">         */</span>
02071         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>) &amp;&amp;
02072                 pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> != <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>])
02073             <span class="keywordflow">goto</span> ist_next;
02074 
02075         <span class="comment">/*</span>
02076 <span class="comment">         * If pwnd is pwndInsert, we don't need to do anything...</span>
02077 <span class="comment">         */</span>
02078         <span class="keywordflow">if</span> (pwnd == pwndInsert)
02079             <span class="keywordflow">goto</span> ist_next;
02080 
02081         pwndT = pwnd;
02082         <span class="keywordflow">while</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02083             <span class="keywordflow">if</span> (pwndT == pwndRootIme) {
02084                 <span class="comment">/*</span>
02085 <span class="comment">                 * Found!!</span>
02086 <span class="comment">                 * pwnd is the ownee of pwndRootIme.</span>
02087 <span class="comment">                 */</span>
02088 
02089                 UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndRootIme));
02090                 UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>) ||
02091                             (pwnd-&gt;pcls-&gt;atomClassName == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>]));
02092                 UserAssert(pwnd != pwndInsert);
02093 
02094                 <a class="code" href="../../d4/d1/userk_8h.html#a1458">UnlinkWindow</a>(pwnd, pwndParent);
02095 
02096                 <span class="keywordflow">if</span> (fMakeTopmost) {
02097                     <span class="keywordflow">if</span> (pwndInsert != <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>)
02098                         UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndInsert, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>));
02099                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>);
02100                 }
02101                 <span class="keywordflow">else</span> {
02102                     <span class="keywordflow">if</span> (pwndInsert == <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>) {
02103                         <span class="comment">/*</span>
02104 <span class="comment">                         * In rare cases, the first toplevel window could be the one we'll look next,</span>
02105 <span class="comment">                         * who may still have obscure topmost flag.</span>
02106 <span class="comment">                         */</span>
02107                         UserAssert(pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a> == pwndNext || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>));
02108                     }
02109                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pwndInsert-&gt;spwndNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02110                         <span class="comment">/*</span>
02111 <span class="comment">                         * In rare cases, pwndInsert-&gt;spwndNext could be the one we'll look next,</span>
02112 <span class="comment">                         * who may still have obscure topmost flag.</span>
02113 <span class="comment">                         */</span>
02114                         UserAssert(pwndInsert-&gt;spwndNext == pwndNext || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndInsert-&gt;spwndNext, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>));
02115                     }
02116                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>);
02117                 }
02118 
02119                 <a class="code" href="../../d4/d1/userk_8h.html#a1457">LinkWindow</a>(pwnd, pwndInsert, pwndParent);
02120 <span class="preprocessor">#if 0   // Let's see what happens if we disable this</span>
02121 <span class="preprocessor"></span>                <a class="code" href="../../d4/d1/userk_8h.html#a2056">ImeSetTopmostChild</a>(pwnd, fMakeTopmost);
02122 <span class="preprocessor">#endif</span>
02123 <span class="preprocessor"></span>
02124                 pwndInsert = pwnd;
02125                 <span class="keywordflow">break</span>;  <span class="comment">// goto ist_next;</span>
02126             }
02127             pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
02128         }
02129 ist_next:
02130         pwnd = pwndNext;
02131 
02132         <span class="comment">/*</span>
02133 <span class="comment">         * Skip the windows that were inserted before.</span>
02134 <span class="comment">         */</span>
02135         <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pwnd == pwndInsertFirst)
02136             pwnd = pwndInsert-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
02137 
02138 <span class="preprocessor">#if DBG</span>
02139 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (pwnd)
02140             ImeCheckSetTopmostLink(pwnd, pwndInsertFirst, pwndInsert);
02141 <span class="preprocessor">#endif</span>
02142 <span class="preprocessor"></span>    }
02143 }
02144 
02145 
02146 <span class="comment">/**************************************************************************\</span>
02147 <span class="comment">* ProbeAndCaptureSoftKbdData</span>
02148 <span class="comment">*</span>
02149 <span class="comment">* Captures SoftKbdData that comes from user mode.</span>
02150 <span class="comment">*</span>
02151 <span class="comment">* 23-Apr-1996 wkwok     created</span>
02152 <span class="comment">\**************************************************************************/</span>
02153 
<a name="l02154"></a><a class="code" href="../../d4/d1/userk_8h.html#a2058">02154</a> PSOFTKBDDATA <a class="code" href="../../d4/d1/userk_8h.html#a2058">ProbeAndCaptureSoftKbdData</a>(
02155     PSOFTKBDDATA Source)
02156 {
02157     PSOFTKBDDATA Destination = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02158     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>        cbSize;
02159     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>         uCount;
02160 
02161     <span class="keywordflow">try</span> {
02162         uCount = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>((PULONG)Source);
02163 
02164 <span class="preprocessor">#if defined(_X86_)</span>
02165 <span class="preprocessor"></span>        <a class="code" href="../../d4/d1/userk_8h.html#a24">ProbeForReadBuffer</a>(&amp;Source-&gt;wCode, uCount, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
02166 <span class="preprocessor">#else</span>
02167 <span class="preprocessor"></span>        <a class="code" href="../../d4/d1/userk_8h.html#a24">ProbeForReadBuffer</a>(&amp;Source-&gt;wCode, uCount, <span class="keyword">sizeof</span>(WORD));
02168 <span class="preprocessor">#endif</span>
02169 <span class="preprocessor"></span>
02170         cbSize = FIELD_OFFSET(SOFTKBDDATA, wCode[0])
02171                + uCount * <span class="keyword">sizeof</span>(WORD) * 256;
02172 
02173         Destination = (PSOFTKBDDATA)UserAllocPool(cbSize, TAG_IME);
02174 
02175         <span class="keywordflow">if</span> (Destination != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02176             RtlCopyMemory(Destination, Source, cbSize);
02177         } <span class="keywordflow">else</span> {
02178             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_NO_MEMORY);
02179         }
02180 
02181     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, RIP_WARNING)) {
02182 
02183         <span class="keywordflow">if</span> (Destination != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02184             UserFreePool(Destination);
02185         }
02186 
02187         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02188     }
02189 
02190     <span class="keywordflow">return</span> Destination;
02191 }
02192 
02193 <span class="comment">//</span>
02194 <span class="comment">// ported from Win95:ctxtman.c\SetConvMode()</span>
02195 <span class="comment">//</span>
<a name="l02196"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a28">02196</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>  <a class="code" href="../../d5/d8/ntimm_8c.html#a28">SetConvMode</a>( <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, DWORD dwConversion )
02197 {
02198     <span class="keywordflow">if</span> ( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
02199         <span class="keywordflow">return</span>;
02200 
02201     <span class="keywordflow">switch</span> ( PRIMARYLANGID(HandleToUlong(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>)) ) {
02202     <span class="keywordflow">case</span> LANG_JAPANESE:
02203 
02204         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a839">ClearKeyStateDown</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_ALPHANUMERIC);
02205         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_ALPHANUMERIC);
02206         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a839">ClearKeyStateDown</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_KATAKANA);
02207         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_KATAKANA);
02208         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a839">ClearKeyStateDown</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_HIRAGANA);
02209         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_HIRAGANA);
02210 
02211         <span class="keywordflow">if</span> ( dwConversion &amp; IME_CMODE_NATIVE ) {
02212             <span class="keywordflow">if</span> ( dwConversion &amp; IME_CMODE_KATAKANA ) {
02213                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a838">SetKeyStateDown</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_KATAKANA);
02214                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_KATAKANA);
02215             } <span class="keywordflow">else</span> {
02216                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a838">SetKeyStateDown</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_HIRAGANA);
02217                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_HIRAGANA);
02218             }
02219         } <span class="keywordflow">else</span> {
02220             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a838">SetKeyStateDown</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_ALPHANUMERIC);
02221             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_ALPHANUMERIC);
02222         }
02223 
02224         <span class="keywordflow">if</span> ( dwConversion &amp; IME_CMODE_FULLSHAPE ) {
02225             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a838">SetKeyStateDown</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_DBCSCHAR);
02226             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_DBCSCHAR);
02227             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a839">ClearKeyStateDown</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_SBCSCHAR);
02228             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_SBCSCHAR);
02229         } <span class="keywordflow">else</span> {
02230             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a838">SetKeyStateDown</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_SBCSCHAR);
02231             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_SBCSCHAR);
02232             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a839">ClearKeyStateDown</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_DBCSCHAR);
02233             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_DBCSCHAR);
02234         }
02235 
02236         <span class="keywordflow">if</span> ( dwConversion &amp; IME_CMODE_ROMAN ) {
02237             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a838">SetKeyStateDown</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_ROMAN);
02238             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_ROMAN);
02239             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a839">ClearKeyStateDown</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_NOROMAN);
02240             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_NOROMAN);
02241         } <span class="keywordflow">else</span> {
02242             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a838">SetKeyStateDown</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_NOROMAN);
02243             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_NOROMAN);
02244             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a839">ClearKeyStateDown</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_ROMAN);
02245             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_ROMAN);
02246         }
02247 
02248         <span class="keywordflow">if</span> ( dwConversion &amp; IME_CMODE_CHARCODE ) {
02249             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a838">SetKeyStateDown</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_CODEINPUT);
02250             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_CODEINPUT);
02251             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a839">ClearKeyStateDown</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_NOCODEINPUT);
02252             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_NOCODEINPUT);
02253         } <span class="keywordflow">else</span> {
02254             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a838">SetKeyStateDown</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_NOCODEINPUT);
02255             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_NOCODEINPUT);
02256             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a839">ClearKeyStateDown</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_CODEINPUT);
02257             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_DBE_CODEINPUT);
02258         }
02259         <span class="keywordflow">break</span>;
02260 
02261     <span class="keywordflow">case</span> LANG_KOREAN:
02262         <span class="keywordflow">if</span> ( dwConversion &amp; IME_CMODE_NATIVE) {
02263             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_HANGUL);
02264         } <span class="keywordflow">else</span> {
02265             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_HANGUL);
02266         }
02267 
02268         <span class="keywordflow">if</span> ( dwConversion &amp; IME_CMODE_FULLSHAPE ) {
02269             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_JUNJA);
02270         } <span class="keywordflow">else</span> {
02271             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_JUNJA);
02272         }
02273 
02274         <span class="keywordflow">if</span> ( dwConversion &amp; IME_CMODE_HANJACONVERT ) {
02275             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_HANJA);
02276         } <span class="keywordflow">else</span> {
02277             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_HANJA);
02278         }
02279         <span class="keywordflow">break</span>;
02280 
02281     <span class="keywordflow">default</span>:
02282         <span class="keywordflow">break</span>;
02283     }
02284     <span class="keywordflow">return</span>;
02285 }
02286 
02287 <span class="comment">//</span>
02288 <span class="comment">// called by IMM32 client when:</span>
02289 <span class="comment">//</span>
02290 <span class="comment">//      input focus is switched</span>
02291 <span class="comment">//   or IME open status is changed</span>
02292 <span class="comment">//   or IME conversion status is changed</span>
02293 <span class="comment">//</span>
02294 <span class="comment">//</span>
<a name="l02295"></a><a class="code" href="../../d4/d1/userk_8h.html#a2059">02295</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a2059">xxxNotifyIMEStatus</a>(
02296                        IN <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
02297                        IN DWORD dwOpen,
02298                        IN DWORD dwConversion )
02299 {
02300     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
02301 
02302     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
02303 
02304     <span class="keywordflow">if</span> ( (pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02305         <span class="keywordflow">if</span> ( pti == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> || pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> ) {
02306 
02307             <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a233">gHimcFocus</a> != pwnd-&gt;hImc   ||
02308                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a231">gdwIMEOpenStatus</a> != dwOpen ||
02309                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a232">gdwIMEConversionStatus</a> != dwConversion ) {
02310 
02311                 <span class="comment">//</span>
02312                 <span class="comment">// save the new status</span>
02313                 <span class="comment">//</span>
02314                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a233">gHimcFocus</a> = pwnd-&gt;hImc;
02315                 <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a233">gHimcFocus</a> != (HIMC)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02316 
02317                     RIPMSG2(RIP_VERBOSE, <span class="stringliteral">"xxxNotifyIMEStatus: newOpen=%x newConv=%x"</span>,
02318                             dwOpen, dwConversion);
02319                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a231">gdwIMEOpenStatus</a> = dwOpen;
02320                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a232">gdwIMEConversionStatus</a> = dwConversion;
02321 
02322                     <span class="comment">//</span>
02323                     <span class="comment">// set keyboard states that are related to IME conversion status</span>
02324                     <span class="comment">//</span>
02325                     <a class="code" href="../../d5/d8/ntimm_8c.html#a28">SetConvMode</a>(pti, dwOpen ? dwConversion : 0);
02326                 }
02327 
02328                 <span class="comment">//</span>
02329                 <span class="comment">// notify shell the IME status change</span>
02330                 <span class="comment">//</span>
02331                 <span class="comment">// Implementation note: [takaok 9/5/96]</span>
02332                 <span class="comment">//</span>
02333                 <span class="comment">// Using HSHELL_LANGUAGE is not the best way to inform shell</span>
02334                 <span class="comment">// IME status change because we didn't change the keyboard layout.</span>
02335                 <span class="comment">// ( The spec says HSHELL_LANGUAGE is for keyboard layout change.</span>
02336                 <span class="comment">//  Also passing window handle as WPARAM is not documented )</span>
02337                 <span class="comment">//</span>
02338                 <span class="comment">// This is same as what Win95 does. I won't change this for now</span>
02339                 <span class="comment">// because in the future shell will be developed by a different</span>
02340                 <span class="comment">// group in MS.</span>
02341                 <span class="comment">//</span>
02342                 <span class="comment">// Currently only Korean Windows is interested in getting</span>
02343                 <span class="comment">// the conversion status change.</span>
02344                 <span class="comment">//</span>
02345                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(pti, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a523">WHF_SHELL</a>)) {
02346                     HKL hkl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02347 
02348                     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02349                         hkl = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
02350                     }
02351                     <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_LANGUAGE, (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd), (LPARAM)hkl, WH_SHELL);
02352                 }
02353 
02354                 <span class="comment">//</span>
02355                 <span class="comment">// notify keyboard driver</span>
02356                 <span class="comment">//</span>
02357                 <a class="code" href="../../d4/d2/fekbd_8c.html#a44">NlsKbdSendIMENotification</a>(dwOpen,dwConversion);
02358             }
02359         }
02360     }
02361 }
02362 
02363 <span class="comment">//---------------------------------------------------------------------------</span>
02364 <span class="comment">//</span>
02365 <span class="comment">// xxxCheckImeShowStatus() -</span>
02366 <span class="comment">//</span>
02367 <span class="comment">// Only one Status Window should be shown in the System.</span>
02368 <span class="comment">// This functsion enums all IME window and check the show status of them.</span>
02369 <span class="comment">//</span>
02370 <span class="comment">// If pti is NULL, check all toplevel windows regardless their owners.</span>
02371 <span class="comment">// If pti is not NULL, check only windows belong to the thread.</span>
02372 <span class="comment">//</span>
02373 <span class="comment">//----------------------------------------------------------------------------</span>
02374 
<a name="l02375"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a30">02375</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d8/ntimm_8c.html#a30">xxxCheckImeShowStatus</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndIme, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
02376 {
02377     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl;
02378     <a class="code" href="../../d4/d1/userk_8h.html#a944">PHWND</a> phwnd;
02379     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02380     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02381 
02382     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndIme, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a591">WFINDESTROY</a>)) {
02383         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02384     }
02385 
02386     <span class="comment">// Parent window of IME window should be the desktop window</span>
02387     UserAssert(pwndIme);
02388     UserAssert(pwndIme-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndIme)-&gt;pDeskInfo-&gt;spwnd);
02389 
02390     pbwl = <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(pwndIme-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>, <a class="code" href="../../d4/d1/userk_8h.html#a410">BWL_ENUMLIST</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02391     <span class="keywordflow">if</span> (pbwl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02392         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02393         <span class="keywordflow">for</span> (phwnd = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>; *phwnd != (HWND)1; phwnd++) {
02394             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(*phwnd);
02395 
02396             <span class="comment">// If pwndT is the current active IME window, we should skip it</span>
02397             <span class="comment">// since it's the only one window allowed to show status, and</span>
02398             <span class="comment">// we've already taken care of it.</span>
02399             <span class="keywordflow">if</span> (pwndT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || (<span class="comment">/*pwndIme &amp;&amp; */</span>pwndIme == pwndT)) {   <span class="comment">// Can skip pwndIme != NULL test</span>
02400                 <span class="keywordflow">continue</span>;
02401             }
02402 
02403             <span class="comment">// We are going to touch IME windows only</span>
02404             <span class="keywordflow">if</span> (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>] &amp;&amp;
02405                     !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a591">WFINDESTROY</a>)) {
02406 
02407                 <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui = ((<a class="code" href="../../d5/d8/structtagIMEWND.html">PIMEWND</a>)pwndT)-&gt;pimeui;
02408 
02409                 <span class="keywordflow">if</span> (pimeui == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pimeui == (<a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a>)-1) {
02410                     <span class="keywordflow">continue</span>;
02411                 }
02412 
02413                 <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pti == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT)) {
02414                     BOOLEAN fAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02415                     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndIMC;
02416 
02417                     <span class="comment">// If pwndT is not a window of the current process, we have to138163</span>
02418                     <span class="comment">// attach the process to get access to pimeui.</span>
02419                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT)-&gt;ppi != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>) {
02420                         RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"Attaching process in xxxCheckImeShowStatus"</span>);
02421                         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT)-&gt;ppi-&gt;Process-&gt;Pcb);
02422                         fAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02423                     }
02424 
02425                     <span class="keywordflow">try</span> {
02426                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(pimeui, <a class="code" href="../../d4/d8/structtagIMEUI.html">IMEUI</a>).fShowStatus) {
02427                             <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02428                                 RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"xxxCheckImeShowStatus: the status window is shown !!"</span>);
02429                             }
02430                             <span class="keywordflow">if</span> ((pwndIMC = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02431                                 pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o6">fShowStatus</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02432                             }
02433                         } <span class="keywordflow">else</span> {
02434                             pwndIMC = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02435                         }
02436 
02437                     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
02438                           pwndIMC = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02439                     }
02440                     <span class="keywordflow">if</span> (fAttached) {
02441                         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
02442                     }
02443 
02444                     <span class="keywordflow">if</span> (pwndIMC &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndIMC) &amp;&amp; !(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndIMC)-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>)) {
02445                         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tl;
02446 
02447                         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndIMC, &amp;tl);
02448                         RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"Sending WM_IME_NOTIFY to %#p, IMN_CLOSESTATUSWINDOW"</span>, pwndIMC);
02449                         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndIMC, WM_IME_NOTIFY, IMN_CLOSESTATUSWINDOW, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02450                         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tl);
02451                     }
02452 
02453                 }
02454             }
02455         }
02456         <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>(pbwl);
02457     }
02458     <span class="keywordflow">return</span> fRet;
02459 }
02460 
<a name="l02461"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a31">02461</a> LRESULT <a class="code" href="../../d5/d8/ntimm_8c.html#a31">xxxSendMessageToUI</a>(
02462     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiIme,
02463     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui,
02464     UINT   message,
02465     WPARAM wParam,
02466     LPARAM lParam)
02467 {
02468     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndUI;
02469     LRESULT lRet = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
02470     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>    tl;
02471     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02472 
02473     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02474 
02475     <span class="keywordflow">if</span> (ptiIme != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()) {
02476         fAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02477         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;ptiIme-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;Process-&gt;Pcb);
02478     }
02479 
02480     <span class="keywordflow">try</span> {
02481         pwndUI = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(<a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(pimeui, <a class="code" href="../../d4/d8/structtagIMEUI.html">IMEUI</a>).hwndUI);
02482     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
02483         pwndUI = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02484     }
02485 
02486     <span class="keywordflow">if</span> (pwndUI != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>){
02487         <span class="keywordflow">try</span> {
02488             <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>((PULONG)&amp;pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o5">nCntInIMEProc</a>);
02489             InterlockedIncrement(&amp;pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o5">nCntInIMEProc</a>);   <span class="comment">// Mark to avoid recursion.</span>
02490         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
02491               <span class="keywordflow">goto</span> skip_it;
02492         }
02493         <span class="keywordflow">if</span> (fAttached) {
02494             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
02495         }
02496 
02497         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndUI, &amp;tl);
02498         RIPMSG3(RIP_VERBOSE, <span class="stringliteral">"Sending message UI pwnd=%#p, msg:%x to wParam=%#p"</span>, pwndUI, message, wParam);
02499         lRet = <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndUI, message, wParam, lParam);
02500         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tl);
02501 
02502         <span class="keywordflow">if</span> (fAttached) {
02503             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;ptiIme-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;Process-&gt;Pcb);
02504         }
02505         <span class="keywordflow">try</span> {
02506             InterlockedDecrement(&amp;pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o5">nCntInIMEProc</a>);   <span class="comment">// Mark to avoid recursion.</span>
02507         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
02508         }
02509     }
02510 skip_it:
02511     <span class="keywordflow">if</span> (fAttached) {
02512         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
02513     }
02514 
02515     <span class="keywordflow">return</span> lRet;
02516 }
02517 
<a name="l02518"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a32">02518</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d8/ntimm_8c.html#a32">xxxSendOpenStatusNotify</a>(
02519     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiIme,
02520     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui,
02521     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwndApp,
02522     BOOL   fOpen)
02523 {
02524     WPARAM wParam = fOpen ? IMN_OPENSTATUSWINDOW : IMN_CLOSESTATUSWINDOW;
02525 
02526     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndApp));
02527 
02528     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndApp)-&gt;dwExpWinVer &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a> &amp;&amp; pwndApp-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02529         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tl;
02530         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndApp, &amp;tl);
02531         RIPMSG2(RIP_VERBOSE, <span class="stringliteral">"Sending %s to pwnd=%#p"</span>,
02532                 fOpen ? <span class="stringliteral">"IMN_OPENSTATUSWINDOW"</span> : <span class="stringliteral">"IMN_CLOSESTATUSWINDOW"</span>,
02533                 pwndApp);
02534         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndApp, WM_IME_NOTIFY, wParam, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02535         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tl);
02536     }
02537     <span class="keywordflow">else</span> {
02538         <a class="code" href="../../d5/d8/ntimm_8c.html#a31">xxxSendMessageToUI</a>(ptiIme, pimeui, WM_IME_NOTIFY, wParam, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02539     }
02540 
02541     <span class="keywordflow">return</span>;
02542 }
02543 
<a name="l02544"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a33">02544</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d8/ntimm_8c.html#a33">xxxNotifyImeShowStatus</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndIme)
02545 {
02546     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui;
02547     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fShow;
02548     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
02549     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiIme, ptiCurrent;
02550     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSendOpenStatusNotify = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02551 
02552     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>() || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndIme, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a591">WFINDESTROY</a>)) {
02553         RIPMSG0(RIP_WARNING, <span class="stringliteral">"IME is not enabled or in destroy."</span>);
02554         <span class="keywordflow">return</span>;
02555     }
02556 
02557     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02558     ptiIme = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndIme);
02559 
02560     <span class="keywordflow">if</span> (ptiIme != ptiCurrent) {
02561         RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"Attaching pti=%#p"</span>, ptiIme);
02562         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndIme)-&gt;ppi-&gt;Process-&gt;Pcb);
02563     }
02564 
02565     <span class="keywordflow">try</span> {
02566         pimeui = ((<a class="code" href="../../d5/d8/structtagIMEWND.html">PIMEWND</a>)pwndIme)-&gt;pimeui;
02567         fShow = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a234">gfIMEShowStatus</a> &amp;&amp; <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(pimeui, <a class="code" href="../../d4/d8/structtagIMEUI.html">IMEUI</a>).fCtrlShowStatus;
02568 
02569         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o2">hwndIMC</a>);
02570 
02571         <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || (pwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndIme)-&gt;pq-&gt;spwndFocus) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02572             RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"Setting new show status."</span>);
02573             fSendOpenStatusNotify = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02574             pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o6">fShowStatus</a> = fShow;
02575         }
02576     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
02577           <span class="keywordflow">if</span> (ptiIme != ptiCurrent) {
02578               <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
02579           }
02580           <span class="keywordflow">return</span>;
02581     }
02582     <span class="keywordflow">if</span> (ptiIme != ptiCurrent) {
02583         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
02584     }
02585 
02586     <span class="keywordflow">if</span> (fSendOpenStatusNotify) {
02587         RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"Sending OpenStatus fShow=%d"</span>, fShow);
02588         <a class="code" href="../../d5/d8/ntimm_8c.html#a32">xxxSendOpenStatusNotify</a>(ptiIme, pimeui, pwnd, fShow);
02589     }
02590 
02591     <span class="comment">// Check the show status of all IME windows in the system.</span>
02592     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndIme, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a591">WFINDESTROY</a>)) {
02593         <a class="code" href="../../d5/d8/ntimm_8c.html#a30">xxxCheckImeShowStatus</a>(pwndIme, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02594     }
02595 }
02596 
02597 
02598 <span class="comment">/***************************************************************************\</span>
02599 <span class="comment">* xxxSetIMEShowStatus() -</span>
02600 <span class="comment">*</span>
02601 <span class="comment">* Set IME Status windows' show status. Called from SystemParametersInfo()</span>
02602 <span class="comment">* handler.</span>
02603 <span class="comment">*</span>
02604 <span class="comment">\***************************************************************************/</span>
02605 
<a name="l02606"></a><a class="code" href="../../d4/d1/userk_8h.html#a2060">02606</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2060">xxxSetIMEShowStatus</a>(IN BOOL fShow)
02607 {
02608     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02609 
02610     UserAssert(fShow == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || fShow == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02611 
02612     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a234">gfIMEShowStatus</a> == fShow) {
02613         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02614     }
02615 
02616     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a234">gfIMEShowStatus</a> == <a class="code" href="../../d4/d1/userk_8h.html#a744">IMESHOWSTATUS_NOTINITIALIZED</a>) {
02617         <span class="comment">/*</span>
02618 <span class="comment">         * Called for the first time after logon.</span>
02619 <span class="comment">         * No need to write the value to the registry.</span>
02620 <span class="comment">         */</span>
02621         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a234">gfIMEShowStatus</a> = fShow;
02622     }
02623     <span class="keywordflow">else</span> {
02624         <span class="comment">/*</span>
02625 <span class="comment">         * We need to save the new fShow status to the registry.</span>
02626 <span class="comment">         */</span>
02627         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlName;
02628         PUNICODE_STRING pProfileUserName;
02629         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fOK = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02630 
02631         pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
02632         <span class="keywordflow">if</span> (pProfileUserName) {
02633             UserAssert(pProfileUserName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02634             fOK = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(pProfileUserName, <a class="code" href="../../d4/d1/userk_8h.html#a730">PMAP_INPUTMETHOD</a>, STR_SHOWIMESTATUS, fShow);
02635             <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
02636         }
02637         <span class="keywordflow">if</span> (!fOK) {
02638             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02639         }
02640         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a234">gfIMEShowStatus</a> = fShow;
02641     }
02642 
02643     <span class="comment">/*</span>
02644 <span class="comment">     * If IME is not enabled, further processing is not needed</span>
02645 <span class="comment">     */</span>
02646     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
02647         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02648     }
02649 
02650     <span class="comment">/*</span>
02651 <span class="comment">     * Let the current active IME window know the change.</span>
02652 <span class="comment">     */</span>
02653     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>) {
02654         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiFocus = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>);
02655         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tl;
02656 
02657         UserAssert(ptiFocus);
02658 
02659         <span class="keywordflow">if</span> (ptiFocus-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a> &amp;&amp; !(ptiFocus-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>)) {
02660             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(ptiFocus-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a>, &amp;tl);
02661             <a class="code" href="../../d5/d8/ntimm_8c.html#a33">xxxNotifyImeShowStatus</a>(ptiFocus-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a>);
02662             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tl);
02663         }
02664     }
02665 
02666     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02667 }
02668 
02669 <span class="comment">/***************************************************************************\</span>
02670 <span class="comment">* xxxBroadcastImeShowStatusChange() -</span>
02671 <span class="comment">*</span>
02672 <span class="comment">* Let all IME windows in the desktop, including myself  know about the</span>
02673 <span class="comment">* status change.</span>
02674 <span class="comment">* This routine does not touch the registry, assuming internat.exe updated</span>
02675 <span class="comment">* the registry.</span>
02676 <span class="comment">*</span>
02677 <span class="comment">\***************************************************************************/</span>
02678 
<a name="l02679"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a35">02679</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a2061">xxxBroadcastImeShowStatusChange</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndIme, BOOL fShow)
02680 {
02681     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02682 
02683     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a234">gfIMEShowStatus</a> = !!fShow;
02684     <a class="code" href="../../d5/d8/ntimm_8c.html#a33">xxxNotifyImeShowStatus</a>(pwndIme);
02685 }
02686 
02687 <span class="comment">/***************************************************************************\</span>
02688 <span class="comment">* xxxCheckImeShowStatusInThread() -</span>
02689 <span class="comment">*</span>
02690 <span class="comment">* Let all IME windows in the same thread know about the status change.</span>
02691 <span class="comment">* Called from ImeSetContextHandler().</span>
02692 <span class="comment">*</span>
02693 <span class="comment">\***************************************************************************/</span>
<a name="l02694"></a><a class="code" href="../../d5/d8/ntimm_8c.html#a36">02694</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a2062">xxxCheckImeShowStatusInThread</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndIme)
02695 {
02696     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
02697         UserAssert(pwndIme);
02698 
02699         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndIme, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a591">WFINDESTROY</a>)) {
02700             <a class="code" href="../../d5/d8/ntimm_8c.html#a30">xxxCheckImeShowStatus</a>(pwndIme, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndIme));
02701         }
02702     }
02703 }
02704 
<a name="l02705"></a><a class="code" href="../../d4/d1/userk_8h.html#a1133">02705</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1133">_GetIMEShowStatus</a>(VOID)
02706 {
02707     <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a234">gfIMEShowStatus</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02708 }
02709 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:00 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
