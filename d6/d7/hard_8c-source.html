<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hard.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hard.c</h1><a href="../../d5/d8/hard_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    NtHard.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">Author:</span>
00012 <span class="comment"></span>
00013 <span class="comment">Revision History:</span>
00014 <span class="comment"></span>
00015 <span class="comment">--*/</span>
00016 
00017 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00018 <span class="preprocessor">#pragma hdrstop</span>
00019 <span class="preprocessor"></span>
00020 <span class="preprocessor">#if defined(i386)</span>
00021 <span class="preprocessor"></span>
00022 
00023 <span class="preprocessor">#define REGISTRY_HARDWARE_DESCRIPTION \</span>
00024 <span class="preprocessor">        TEXT("\\Registry\\Machine\\Hardware\\DESCRIPTION\\System")</span>
00025 <span class="preprocessor"></span>
00026 <span class="preprocessor">#define REGISTRY_MACHINE_IDENTIFIER   \</span>
00027 <span class="preprocessor">        TEXT("Identifier")</span>
00028 <span class="preprocessor"></span>
00029 <span class="preprocessor">#define FUJITSU_FMR_NAME    TEXT("FUJITSU FMR-")</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#define NEC_PC98_NAME       TEXT("NEC PC-98")</span>
00031 <span class="preprocessor"></span>
00032 
00033 
00034 <span class="preprocessor">#define KEY_WORK_AREA ((sizeof(KEY_VALUE_FULL_INFORMATION) + \</span>
00035 <span class="preprocessor">                        sizeof(ULONG)) + 256)</span>
00036 <span class="preprocessor"></span>
00037 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00038 NtGetMachineIdentifierValue(
00039     IN OUT PULONG Value
00040     )
00041 
00042 <span class="comment">/*++</span>
00043 <span class="comment"></span>
00044 <span class="comment">Routine Description:</span>
00045 <span class="comment"></span>
00046 <span class="comment">    Given a unicode value name this routine will go into the registry</span>
00047 <span class="comment">    location for the machine identifier information and get the</span>
00048 <span class="comment">    value.</span>
00049 <span class="comment"></span>
00050 <span class="comment">Arguments:</span>
00051 <span class="comment"></span>
00052 <span class="comment">    ValueName - the unicode name for the registry value located in the</span>
00053 <span class="comment">                identifier location of the registry.</span>
00054 <span class="comment">    Value   - a pointer to the ULONG for the result.</span>
00055 <span class="comment"></span>
00056 <span class="comment">Return Value:</span>
00057 <span class="comment"></span>
00058 <span class="comment">    NTSTATUS</span>
00059 <span class="comment"></span>
00060 <span class="comment">    If STATUS_SUCCESSFUL is returned, the location *Value will be</span>
00061 <span class="comment">    updated with the DWORD value from the registry.  If any failing</span>
00062 <span class="comment">    status is returned, this value is untouched.</span>
00063 <span class="comment"></span>
00064 <span class="comment">--*/</span>
00065 
00066 {
00067     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00068     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00069     ULONG RequestLength;
00070     ULONG ResultLength;
00071     UCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d4/d8/fsrtlpc_8c.html#a2">KEY_WORK_AREA</a>];
00072     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00073     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00074     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00075     PKEY_VALUE_FULL_INFORMATION KeyValueInformation;
00076 
00077     <span class="comment">//</span>
00078     <span class="comment">// Set default as PC/AT</span>
00079     <span class="comment">//</span>
00080 
00081     *Value = MACHINEID_MS_PCAT;
00082 
00083     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = REGISTRY_HARDWARE_DESCRIPTION;
00084     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = <span class="keyword">sizeof</span>(REGISTRY_HARDWARE_DESCRIPTION) - <span class="keyword">sizeof</span>(WCHAR);
00085     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength = <span class="keyword">sizeof</span>(REGISTRY_HARDWARE_DESCRIPTION);
00086 
00087     InitializeObjectAttributes(&amp;ObjectAttributes,
00088                                &amp;KeyName,
00089                                OBJ_CASE_INSENSITIVE,
00090                                NULL,
00091                                NULL);
00092 
00093     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;Handle,
00094                        KEY_READ,
00095                        &amp;ObjectAttributes);
00096 
00097     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00098 
00099         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00100     }
00101 
00102     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>.Buffer = REGISTRY_MACHINE_IDENTIFIER;
00103     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>.Length = <span class="keyword">sizeof</span>(REGISTRY_MACHINE_IDENTIFIER) - <span class="keyword">sizeof</span>(WCHAR);
00104     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>.MaximumLength = <span class="keyword">sizeof</span>(REGISTRY_MACHINE_IDENTIFIER);
00105 
00106     RequestLength = <a class="code" href="../../d4/d8/fsrtlpc_8c.html#a2">KEY_WORK_AREA</a>;
00107 
00108     KeyValueInformation = (PKEY_VALUE_FULL_INFORMATION)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00109 
00110     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(Handle,
00111                              &amp;ValueName,
00112                              KeyValueFullInformation,
00113                              KeyValueInformation,
00114                              RequestLength,
00115                              &amp;ResultLength);
00116 
00117     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Status != STATUS_BUFFER_OVERFLOW );
00118 
00119     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Handle);
00120 
00121     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00122 
00123         <span class="keywordflow">if</span> (KeyValueInformation-&gt;DataLength != 0) {
00124 
00125             PWCHAR DataPtr;
00126             UNICODE_STRING DetectedString, TargetString1, TargetString2;
00127 
00128             <span class="comment">//</span>
00129             <span class="comment">// Return contents to the caller.</span>
00130             <span class="comment">//</span>
00131 
00132             DataPtr = (PWCHAR)
00133               ((PUCHAR)KeyValueInformation + KeyValueInformation-&gt;DataOffset);
00134 
00135             <span class="comment">//</span>
00136             <span class="comment">// Initialize strings.</span>
00137             <span class="comment">//</span>
00138 
00139             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;DetectedString, DataPtr );
00140             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;TargetString1, FUJITSU_FMR_NAME );
00141             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;TargetString2, NEC_PC98_NAME );
00142 
00143             <span class="comment">//</span>
00144             <span class="comment">// Check the hardware platform</span>
00145             <span class="comment">//</span>
00146 
00147             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a43">RtlPrefixUnicodeString</a>( &amp;TargetString1 , &amp;DetectedString , TRUE)) {
00148 
00149                 <span class="comment">//</span>
00150                 <span class="comment">// Fujitsu FMR Series.</span>
00151                 <span class="comment">//</span>
00152 
00153                 *Value = MACHINEID_FUJITSU_FMR;
00154 
00155             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a43">RtlPrefixUnicodeString</a>( &amp;TargetString2 , &amp;DetectedString , TRUE)) {
00156 
00157                 <span class="comment">//</span>
00158                 <span class="comment">// NEC PC-9800 Seriss</span>
00159                 <span class="comment">//</span>
00160 
00161                 *Value = MACHINEID_NEC_PC98;
00162 
00163             } <span class="keywordflow">else</span> {
00164 
00165                 <span class="comment">//</span>
00166                 <span class="comment">// Standard PC/AT comapatibles</span>
00167                 <span class="comment">//</span>
00168 
00169                 *Value = MACHINEID_MS_PCAT;
00170 
00171             }
00172 
00173         } <span class="keywordflow">else</span> {
00174 
00175             <span class="comment">//</span>
00176             <span class="comment">// Treat as if no value was found</span>
00177             <span class="comment">//</span>
00178 
00179             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
00180         }
00181 
00182     }
00183 
00184     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00185 }
00186 <span class="preprocessor">#endif // defined(i386)</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:14 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
