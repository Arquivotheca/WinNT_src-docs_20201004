<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: apcsup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>apcsup.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d7/d6/apcsup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d7/apcsup_8c.html#a0">KiDeliverApc</a> (IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, IN PKEXCEPTION_FRAME ExceptionFrame, IN PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d7/apcsup_8c.html#a1">KiInsertQueueApc</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN KPRIORITY Increment)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="apcsup.c::KiDeliverApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiDeliverApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d6/apcsup_8c-source.html#l00030">30</a> of file <a class="el" href="../../d7/d6/apcsup_8c-source.html">apcsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00243">_KAPC_STATE::ApcListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00254">_KAPC::Inserted</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00596">_KTHREAD::KernelApcDisable</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00245">_KAPC_STATE::KernelApcInProgress</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00246">_KAPC_STATE::KernelApcPending</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00241">_KAPC::KernelRoutine</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l02121">KeTestAlertThread()</a>, <a class="el" href="../../d2/d7/ppc_2apcuser_8c-source.html#l00034">KiInitializeUserApc()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00094">KiLockApcQueue</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00101">KiUnlockApcQueue</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00244">_KAPC::NormalContext</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00243">_KAPC::NormalRoutine</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00204">PKKERNEL_ROUTINE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00196">PKNORMAL_ROUTINE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00250">_KAPC::SystemArgument1</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00251">_KAPC::SystemArgument2</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00247">_KAPC_STATE::UserApcPending</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/intsupc_8c-source.html#l00032">KiDispatchSoftwareInterrupt()</a>.
<p>
<pre class="fragment"><div>00038                    :
00039 
00040     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC interrupt code and when one or
00041     more of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC pending flags are set at system <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous
00042     IRQL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero. All special kernel APC's are delivered first, followed
00043     by normal kernel APC's <span class="keywordflow">if</span> one <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not already in progress, and finally
00044     <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user APC queue <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not empty, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user APC pending flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set,
00045     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> user, then a user APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> delivered. On entry
00046     to <span class="keyword">this</span> routine IRQL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>.
00047 
00048     N.B. The exception frame and trap frame addresses are <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> guaranteed
00049          to be valid <span class="keywordflow">if</span>, and <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> user.
00050 
00051 Arguments:
00052 
00053     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous processor mode.
00054 
00055     ExceptionFrame - Supplies a pointer to an exception frame.
00056 
00057     TrapFrame - Supplies a pointer to a trap frame.
00058 
00059 Return Value:
00060 
00061     None.
00062 
00063 --*/
00064 
00065 {
00066 
00067     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc;
00068     <a class="code" href="../../d0/d9/ntosdef_8h.html#a42">PKKERNEL_ROUTINE</a> KernelRoutine;
00069     PLIST_ENTRY NextEntry;
00070     PVOID NormalContext;
00071     <a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> NormalRoutine;
00072     KIRQL OldIrql;
00073     PVOID SystemArgument1;
00074     PVOID SystemArgument2;
00075     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00076 
00077     <span class="comment">//</span>
00078     <span class="comment">// Raise IRQL to dispatcher level and lock the APC queue.</span>
00079     <span class="comment">//</span>
00080 
00081     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00082     <a class="code" href="../../d0/d0/ki_8h.html#a9">KiLockApcQueue</a>(Thread, &amp;OldIrql);
00083 
00084     <span class="comment">//</span>
00085     <span class="comment">// Get address of current thread object, clear kernel APC pending, and</span>
00086     <span class="comment">// check if any kernel mode APC's can be delivered.</span>
00087     <span class="comment">//</span>
00088 
00089     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o3">KernelApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00090     <span class="keywordflow">while</span> (IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[KernelMode]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00091         NextEntry = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>].Flink;
00092         Apc = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>, ApcListEntry);
00093         KernelRoutine = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o5">KernelRoutine</a>;
00094         NormalRoutine = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o7">NormalRoutine</a>;
00095         NormalContext = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o8">NormalContext</a>;
00096         SystemArgument1 = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a>;
00097         SystemArgument2 = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a>;
00098         <span class="keywordflow">if</span> (NormalRoutine == (<a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00099 
00100             <span class="comment">//</span>
00101             <span class="comment">// First entry in the kernel APC queue is a special kernel APC.</span>
00102             <span class="comment">// Remove the entry from the APC queue, set its inserted state</span>
00103             <span class="comment">// to FALSE, release dispatcher database lock, and call the kernel</span>
00104             <span class="comment">// routine. On return raise IRQL to dispatcher level and lock</span>
00105             <span class="comment">// dispatcher database lock.</span>
00106             <span class="comment">//</span>
00107 
00108             RemoveEntryList(NextEntry);
00109             Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o13">Inserted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00110             <a class="code" href="../../d0/d0/ki_8h.html#a10">KiUnlockApcQueue</a>(Thread, OldIrql);
00111             (KernelRoutine)(Apc, &amp;NormalRoutine, &amp;NormalContext,
00112                             &amp;SystemArgument1, &amp;SystemArgument2);
00113 
00114 <span class="preprocessor">#if DBG</span>
00115 <span class="preprocessor"></span>
00116                 <span class="keywordflow">if</span> (KeGetCurrentIrql() != OldIrql) {
00117                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(IRQL_UNEXPECTED_VALUE,
00118                                  KeGetCurrentIrql() &lt;&lt; 16 | OldIrql &lt;&lt; 8,
00119                                  (ULONG_PTR)KernelRoutine,
00120                                  (ULONG_PTR)Apc,
00121                                  (ULONG_PTR)NormalRoutine);
00122                 }
00123 
00124 <span class="preprocessor">#endif</span>
00125 <span class="preprocessor"></span>
00126             <a class="code" href="../../d0/d0/ki_8h.html#a9">KiLockApcQueue</a>(Thread, &amp;OldIrql);
00127 
00128         } <span class="keywordflow">else</span> {
00129 
00130             <span class="comment">//</span>
00131             <span class="comment">// First entry in the kernel APC queue is a normal kernel APC.</span>
00132             <span class="comment">// If there is not a normal kernel APC in progress and kernel</span>
00133             <span class="comment">// APC's are not disabled, then remove the entry from the APC</span>
00134             <span class="comment">// queue, set its inserted state to FALSE, release the APC queue</span>
00135             <span class="comment">// lock, call the specified kernel routine, set kernel APC in</span>
00136             <span class="comment">// progress, lower the IRQL to zero, and call the normal kernel</span>
00137             <span class="comment">// APC routine. On return raise IRQL to dispatcher level, lock</span>
00138             <span class="comment">// the APC queue, and clear kernel APC in progress.</span>
00139             <span class="comment">//</span>
00140 
00141             <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o2">KernelApcInProgress</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00142                (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a> == 0)) {
00143                 RemoveEntryList(NextEntry);
00144                 Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o13">Inserted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00145                 <a class="code" href="../../d0/d0/ki_8h.html#a10">KiUnlockApcQueue</a>(Thread, OldIrql);
00146                 (KernelRoutine)(Apc, &amp;NormalRoutine, &amp;NormalContext,
00147                                 &amp;SystemArgument1, &amp;SystemArgument2);
00148 
00149 <span class="preprocessor">#if DBG</span>
00150 <span class="preprocessor"></span>
00151                 <span class="keywordflow">if</span> (KeGetCurrentIrql() != OldIrql) {
00152                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(IRQL_UNEXPECTED_VALUE,
00153                                  KeGetCurrentIrql() &lt;&lt; 16 | OldIrql &lt;&lt; 8 | 1,
00154                                  (ULONG_PTR)KernelRoutine,
00155                                  (ULONG_PTR)Apc,
00156                                  (ULONG_PTR)NormalRoutine);
00157                 }
00158 
00159 <span class="preprocessor">#endif</span>
00160 <span class="preprocessor"></span>
00161                 <span class="keywordflow">if</span> (NormalRoutine != (<a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00162                     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o2">KernelApcInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00163                     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(0);
00164                     (NormalRoutine)(NormalContext, SystemArgument1,
00165                                     SystemArgument2);
00166                     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
00167                 }
00168 
00169                 <a class="code" href="../../d0/d0/ki_8h.html#a9">KiLockApcQueue</a>(Thread, &amp;OldIrql);
00170                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o2">KernelApcInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00171 
00172             } <span class="keywordflow">else</span> {
00173                 <a class="code" href="../../d0/d0/ki_8h.html#a10">KiUnlockApcQueue</a>(Thread, OldIrql);
00174                 <span class="keywordflow">return</span>;
00175             }
00176         }
00177     }
00178 
00179     <span class="comment">//</span>
00180     <span class="comment">// Kernel APC queue is empty. If the previous mode is user, user APC</span>
00181     <span class="comment">// pending is set, and the user APC queue is not empty, then remove</span>
00182     <span class="comment">// the first entry from the user APC queue, set its inserted state to</span>
00183     <span class="comment">// FALSE, clear user APC pending, release the dispatcher database lock,</span>
00184     <span class="comment">// and call the specified kernel routine. If the normal routine address</span>
00185     <span class="comment">// is not NULL on return from the kernel routine, then initialize the</span>
00186     <span class="comment">// user mode APC context and return. Otherwise, check to determine if</span>
00187     <span class="comment">// another user mode APC can be processed.</span>
00188     <span class="comment">//</span>
00189 
00190     <span class="keywordflow">if</span> ((IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[UserMode]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00191        (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) &amp;&amp; (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o4">UserApcPending</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00192         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o4">UserApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00193         NextEntry = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>].Flink;
00194         Apc = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>, ApcListEntry);
00195         KernelRoutine = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o5">KernelRoutine</a>;
00196         NormalRoutine = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o7">NormalRoutine</a>;
00197         NormalContext = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o8">NormalContext</a>;
00198         SystemArgument1 = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a>;
00199         SystemArgument2 = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a>;
00200         RemoveEntryList(NextEntry);
00201         Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o13">Inserted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00202         <a class="code" href="../../d0/d0/ki_8h.html#a10">KiUnlockApcQueue</a>(Thread, OldIrql);
00203         (KernelRoutine)(Apc, &amp;NormalRoutine, &amp;NormalContext,
00204                         &amp;SystemArgument1, &amp;SystemArgument2);
00205 
00206         <span class="keywordflow">if</span> (NormalRoutine == (<a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00207             <a class="code" href="../../d9/d1/thredobj_8c.html#a27">KeTestAlertThread</a>(UserMode);
00208 
00209         } <span class="keywordflow">else</span> {
00210             <a class="code" href="../../d1/d8/ppc_2apcuser_8c.html#a1">KiInitializeUserApc</a>(ExceptionFrame, TrapFrame, NormalRoutine,
00211                                 NormalContext, SystemArgument1, SystemArgument2);
00212         }
00213 
00214     } <span class="keywordflow">else</span> {
00215         <a class="code" href="../../d0/d0/ki_8h.html#a10">KiUnlockApcQueue</a>(Thread, OldIrql);
00216     }
00217 
00218     <span class="keywordflow">return</span>;
00219 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="apcsup.c::KiInsertQueueApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FASTCALL KiInsertQueueApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KPRIORITY&nbsp;</td>
          <td class="mdname" nowrap> <em>Increment</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d6/apcsup_8c-source.html#l00223">223</a> of file <a class="el" href="../../d7/d6/apcsup_8c-source.html">apcsup.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00657">_KTHREAD::Alertable</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00243">_KAPC_STATE::ApcListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00613">_KTHREAD::ApcQueueLock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00658">_KTHREAD::ApcStateIndex</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00638">_KTHREAD::ApcStatePointer</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d3/rtl_2random_8c-source.html#l00032">Increment</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00596">_KTHREAD::KernelApcDisable</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00245">_KAPC_STATE::KernelApcInProgress</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00246">_KAPC_STATE::KernelApcPending</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00767">KiRequestApcInterrupt</a>, <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00031">KiUnwaitThread()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00626">_KTHREAD::NextProcessor</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00243">_KAPC::NormalRoutine</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00603">PsExitSpecialApc()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a193">Running</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00569">_KTHREAD::State</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00247">_KAPC_STATE::UserApcPending</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a196">Waiting</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00583">_KTHREAD::WaitIrql</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00584">_KTHREAD::WaitMode</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/ke_2i386_2vdm_8c-source.html#l01257">Ke386VdmInsertQueueApc()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00757">KeFreezeAllThreads()</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00217">KeInsertQueueApc()</a>, and <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01912">KeSuspendThread()</a>.
<p>
<pre class="fragment"><div>00230                    :
00231 
00232     This function inserts an APC object into a thread's APC queue. The address
00233     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread object, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC queue, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of APC are all derived
00234     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC object. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already in an APC queue, then
00235     no opertion <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> performed and a function value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned. Else
00236     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> inserted in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified APC queue, its inserted state <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set
00237     to <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, and a function value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned. The APC will actually
00238     be delivered when proper enabling conditions exist.
00239 
00240 Arguments:
00241 
00242     Apc - Supplies a pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> APC.
00243 
00244     <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority increment that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be applied <span class="keywordflow">if</span>
00245         queuing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC causes a thread wait to be satisfied.
00246 
00247 Return Value:
00248 
00249     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already in an APC queue, then a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00250     returned. Else a value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00251 
00252 --*/
00253 
00254 {
00255 
00256     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> ApcMode;
00257     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> ApcEntry;
00258     <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">PKAPC_STATE</a> ApcState;
00259     BOOLEAN Inserted;
00260     PLIST_ENTRY ListEntry;
00261     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">// If the APC object is already in an APC queue, then set inserted to</span>
00265     <span class="comment">// FALSE. Else insert the APC object in the proper queue, set the APC</span>
00266     <span class="comment">// inserted state to TRUE, check to determine if the APC should be delivered</span>
00267     <span class="comment">// immediately, and set inserted to TRUE.</span>
00268     <span class="comment">//</span>
00269     <span class="comment">// For multiprocessor performance, the following code utilizes the fact</span>
00270     <span class="comment">// that kernel APC disable count is incremented before checking whether</span>
00271     <span class="comment">// the kernel APC queue is nonempty.</span>
00272     <span class="comment">//</span>
00273     <span class="comment">// See KeLeaveCriticalRegion().</span>
00274     <span class="comment">//</span>
00275 
00276     Thread = Apc-&gt;Thread;
00277     KiAcquireSpinLock(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o38">ApcQueueLock</a>);
00278     <span class="keywordflow">if</span> (Apc-&gt;Inserted) {
00279         Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00280 
00281     } <span class="keywordflow">else</span> {
00282         ApcState = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o49">ApcStatePointer</a>[Apc-&gt;ApcStateIndex];
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">// Insert the APC after all other special APC entries selected by</span>
00286         <span class="comment">// the processor mode if the normal routine value is null. Else</span>
00287         <span class="comment">// insert the APC object at the tail of the APC queue selected by</span>
00288         <span class="comment">// the processor mode unless the APC mode is user and the address</span>
00289         <span class="comment">// of the special APC routine is exit thread, in which case insert</span>
00290         <span class="comment">// the APC at the front of the list and set user APC pending.</span>
00291         <span class="comment">//</span>
00292 
00293         ApcMode = Apc-&gt;ApcMode;
00294         <span class="keywordflow">if</span> (Apc-&gt;NormalRoutine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00295             <span class="keywordflow">if</span> ((ApcMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; (Apc-&gt;KernelRoutine == <a class="code" href="../../d1/d9/ps_8h.html#a117">PsExitSpecialApc</a>)) {
00296                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o4">UserApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00297                 InsertHeadList(&amp;ApcState-&gt;<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[ApcMode],
00298                                &amp;Apc-&gt;ApcListEntry);
00299 
00300             } <span class="keywordflow">else</span> {
00301                 InsertTailList(&amp;ApcState-&gt;<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[ApcMode],
00302                                &amp;Apc-&gt;ApcListEntry);
00303             }
00304 
00305         } <span class="keywordflow">else</span> {
00306             ListEntry = ApcState-&gt;<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[ApcMode].Flink;
00307             <span class="keywordflow">while</span> (ListEntry != &amp;ApcState-&gt;<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[ApcMode]) {
00308                 ApcEntry = CONTAINING_RECORD(ListEntry, <a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>, ApcListEntry);
00309                 <span class="keywordflow">if</span> (ApcEntry-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o7">NormalRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00310                     <span class="keywordflow">break</span>;
00311                 }
00312 
00313                 ListEntry = ListEntry-&gt;Flink;
00314             }
00315 
00316             ListEntry = ListEntry-&gt;Blink;
00317             InsertHeadList(ListEntry, &amp;Apc-&gt;ApcListEntry);
00318         }
00319 
00320         Apc-&gt;Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00321 
00322         <span class="comment">//</span>
00323         <span class="comment">// If the APC index from the APC object matches the APC Index of</span>
00324         <span class="comment">// the thread, then check to determine if the APC should interrupt</span>
00325         <span class="comment">// thread execution or sequence the thread out of a wait state.</span>
00326         <span class="comment">//</span>
00327 
00328         <span class="keywordflow">if</span> (Apc-&gt;ApcStateIndex == Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a>) {
00329 
00330             <span class="comment">//</span>
00331             <span class="comment">// If the processor mode of the APC is kernel, then check if</span>
00332             <span class="comment">// the APC should either interrupt the thread or sequence the</span>
00333             <span class="comment">// thread out of a Waiting state. Else check if the APC should</span>
00334             <span class="comment">// sequence the thread out of an alertable Waiting state.</span>
00335             <span class="comment">//</span>
00336 
00337             <span class="keywordflow">if</span> (ApcMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00338                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o3">KernelApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00339                 <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> == <a class="code" href="../../d4/d9/ke_8h.html#a406a193">Running</a>) {
00340                     <a class="code" href="../../d0/d0/ki_8h.html#a23">KiRequestApcInterrupt</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o45">NextProcessor</a>);
00341 
00342                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> == <a class="code" href="../../d4/d9/ke_8h.html#a406a196">Waiting</a>) &amp;&amp;
00343                           (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a> == 0) &amp;&amp;
00344                           ((Apc-&gt;NormalRoutine == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00345                           ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a> == 0) &amp;&amp;
00346                           (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o2">KernelApcInProgress</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)))) {
00347                     <a class="code" href="../../d2/d7/waitsup_8c.html#a0">KiUnwaitThread</a>(Thread, STATUS_KERNEL_APC, Increment);
00348                 }
00349 
00350             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> == <a class="code" href="../../d4/d9/ke_8h.html#a406a196">Waiting</a>) &amp;&amp;
00351                       (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o18">WaitMode</a> == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) &amp;&amp;
00352                       (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o57">Alertable</a>)) {
00353                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o4">UserApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00354                 <a class="code" href="../../d2/d7/waitsup_8c.html#a0">KiUnwaitThread</a>(Thread, STATUS_USER_APC, Increment);
00355             }
00356         }
00357 
00358         Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00359     }
00360 
00361     <span class="comment">//</span>
00362     <span class="comment">// Unlock the APC queue lock, and return whether the APC object was</span>
00363     <span class="comment">// inserted in an APC queue.</span>
00364     <span class="comment">//</span>
00365 
00366     KiReleaseSpinLock(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o38">ApcQueueLock</a>);
00367     <span class="keywordflow">return</span> Inserted;
00368 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:52 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
