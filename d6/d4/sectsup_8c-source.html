<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: sectsup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sectsup.c</h1><a href="../../d5/d5/sectsup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   sectsup.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines which implement the</span>
00012 <span class="comment">    section object.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 22-May-1989</span>
00017 <span class="comment">    Landy Wang (landyw) 02-June-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 
00024 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00025 
00026 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiSectionInitialization)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00029 <span class="preprocessor"></span>
<a name="l00030"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a1">00030</a> <a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html">MMEVENT_COUNT_LIST</a> <a class="code" href="../../d5/d1/mminit_8c.html#a7">MmEventCountList</a>;
00031 
00032 ULONG
00033 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00034 <a class="code" href="../../d5/d5/sectsup_8c.html#a11">MiCheckProtoPtePageState</a> (
00035     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PrototypePte,
00036     IN ULONG PfnLockHeld
00037     );
00038 
<a name="l00039"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a2">00039</a> ULONG   <a class="code" href="../../d1/d6/allocpag_8c.html#a11">MmUnusedSegmentForceFree</a>;
00040 
<a name="l00041"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a3">00041</a> SIZE_T <a class="code" href="../../d8/d5/kddata_8c.html#a31">MmSharedCommit</a> = 0;
<a name="l00042"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a4">00042</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d0/d8/creasect_8c.html#a6">MMCONTROL</a>;
00043 
00044 <span class="comment">//</span>
00045 <span class="comment">// Define segment dereference thread wait object types.</span>
00046 <span class="comment">//</span>
00047 
<a name="l00048"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a32">00048</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> <a class="code" href="../../d5/d5/sectsup_8c.html#a32">_SEGMENT_DEREFERENCE_OBJECT</a> {
00049     <a class="code" href="../../d5/d5/sectsup_8c.html#a32a8">SegmentDereference</a>,
00050     <a class="code" href="../../d5/d5/sectsup_8c.html#a32a9">UsedSegmentCleanup</a>,
00051     <a class="code" href="../../d5/d5/sectsup_8c.html#a32a10">SegMaximumObject</a>
00052     } <a class="code" href="../../d1/d9/worker_8c.html#a11">BALANCE_OBJECT</a>;
00053 
<a name="l00054"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a6">00054</a> <span class="keyword">extern</span> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>;
00055 
<a name="l00056"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a7">00056</a> GENERIC_MAPPING <a class="code" href="../../d5/d5/sectsup_8c.html#a7">MiSectionMapping</a> = {
00057     STANDARD_RIGHTS_READ |
00058         SECTION_QUERY | SECTION_MAP_READ,
00059     STANDARD_RIGHTS_WRITE |
00060         SECTION_MAP_WRITE,
00061     STANDARD_RIGHTS_EXECUTE |
00062         SECTION_MAP_EXECUTE,
00063     SECTION_ALL_ACCESS
00064 };
00065 
00066 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00067 <a class="code" href="../../d5/d5/sectsup_8c.html#a12">VadTreeWalk</a> (
00068     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Start
00069     );
00070 
00071 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00072 <a class="code" href="../../d5/d5/sectsup_8c.html#a13">MiRemoveUnusedSegments</a>(
00073     VOID
00074     );
00075 
00076 
00077 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00078 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00079"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a14">00079</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a14">MiInsertBasedSection</a> (
00080     IN PSECTION Section
00081     )
00082 
00083 <span class="comment">/*++</span>
00084 <span class="comment"></span>
00085 <span class="comment">Routine Description:</span>
00086 <span class="comment"></span>
00087 <span class="comment">    This function inserts a virtual address descriptor into the tree and</span>
00088 <span class="comment">    reorders the splay tree as appropriate.</span>
00089 <span class="comment"></span>
00090 <span class="comment">Arguments:</span>
00091 <span class="comment"></span>
00092 <span class="comment">    Section - Supplies a pointer to a based section.</span>
00093 <span class="comment"></span>
00094 <span class="comment">Return Value:</span>
00095 <span class="comment"></span>
00096 <span class="comment">    None.</span>
00097 <span class="comment"></span>
00098 <span class="comment">Environment:</span>
00099 <span class="comment"></span>
00100 <span class="comment">    Must be holding the section based mutex.</span>
00101 <span class="comment"></span>
00102 <span class="comment">--*/</span>
00103 
00104 {
00105     <a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a> *Root;
00106 
00107     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Section-&gt;Address.EndingVpn &gt; Section-&gt;Address.StartingVpn);
00108 
00109     Root = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a675">MmSectionBasedRoot</a>;
00110 
00111     <a class="code" href="../../d4/d8/mi_8h.html#a842">MiInsertNode</a> (&amp;Section-&gt;Address, Root);
00112     <span class="keywordflow">return</span>;
00113 }
00114 
00115 
00116 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00117 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00118"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a15">00118</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a15">MiRemoveBasedSection</a> (
00119     IN PSECTION Section
00120     )
00121 
00122 <span class="comment">/*++</span>
00123 <span class="comment"></span>
00124 <span class="comment">Routine Description:</span>
00125 <span class="comment"></span>
00126 <span class="comment">    This function removes a based section from the tree.</span>
00127 <span class="comment"></span>
00128 <span class="comment">Arguments:</span>
00129 <span class="comment"></span>
00130 <span class="comment">    Section - pointer to the based section object to remove.</span>
00131 <span class="comment"></span>
00132 <span class="comment">Return Value:</span>
00133 <span class="comment"></span>
00134 <span class="comment">    None.</span>
00135 <span class="comment"></span>
00136 <span class="comment">Environment:</span>
00137 <span class="comment"></span>
00138 <span class="comment">    Must be holding the section based mutex.</span>
00139 <span class="comment"></span>
00140 <span class="comment">--*/</span>
00141 
00142 {
00143     <a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a> *Root;
00144 
00145     Root = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a675">MmSectionBasedRoot</a>;
00146 
00147     <a class="code" href="../../d4/d8/mi_8h.html#a843">MiRemoveNode</a> (&amp;Section-&gt;Address, Root);
00148 
00149     <span class="keywordflow">return</span>;
00150 }
00151 
00152 
00153 PVOID
<a name="l00154"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a16">00154</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a16">MiFindEmptySectionBaseDown</a> (
00155     IN ULONG SizeOfRange,
00156     IN PVOID HighestAddressToEndAt
00157     )
00158 
00159 <span class="comment">/*++</span>
00160 <span class="comment"></span>
00161 <span class="comment">Routine Description:</span>
00162 <span class="comment"></span>
00163 <span class="comment">    The function examines the virtual address descriptors to locate</span>
00164 <span class="comment">    an unused range of the specified size and returns the starting</span>
00165 <span class="comment">    address of the range.  This routine looks from the top down.</span>
00166 <span class="comment"></span>
00167 <span class="comment">Arguments:</span>
00168 <span class="comment"></span>
00169 <span class="comment">    SectionBasedRoot - Supplies the root of the available address tree.</span>
00170 <span class="comment"></span>
00171 <span class="comment">    SizeOfRange - Supplies the size in bytes of the range to locate.</span>
00172 <span class="comment"></span>
00173 <span class="comment">    HighestAddressToEndAt - Supplies the virtual address to begin looking</span>
00174 <span class="comment">                            at.</span>
00175 <span class="comment"></span>
00176 <span class="comment">Return Value:</span>
00177 <span class="comment"></span>
00178 <span class="comment">    Returns the starting address of a suitable range.</span>
00179 <span class="comment"></span>
00180 <span class="comment">--*/</span>
00181 
00182 {
00183     <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a847">MiFindEmptyAddressRangeDownTree</a> (SizeOfRange,
00184                                             HighestAddressToEndAt,
00185                                             <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>,
00186                                             <a class="code" href="../../d4/d8/mi_8h.html#a675">MmSectionBasedRoot</a>);
00187 }
00188 
00189 
00190 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00191"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a17">00191</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a17">MiSegmentDelete</a> (
00192     <a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a> Segment
00193     )
00194 
00195 <span class="comment">/*++</span>
00196 <span class="comment"></span>
00197 <span class="comment">Routine Description:</span>
00198 <span class="comment"></span>
00199 <span class="comment">    This routine is called by the object management procedures whenever</span>
00200 <span class="comment">    the last reference to a segment object has been removed.  This routine</span>
00201 <span class="comment">    releases the pool allocated for the prototype PTEs and performs</span>
00202 <span class="comment">    consistency checks on those PTEs.</span>
00203 <span class="comment"></span>
00204 <span class="comment">    For segments which map files, the file object is dereferenced.</span>
00205 <span class="comment"></span>
00206 <span class="comment">    Note, that for a segment which maps a file, no PTEs may be valid</span>
00207 <span class="comment">    or transition, while a segment which is backed by a paging file</span>
00208 <span class="comment">    may have transition pages, but no valid pages (there can be no</span>
00209 <span class="comment">    PTEs which refer to the segment).</span>
00210 <span class="comment"></span>
00211 <span class="comment"></span>
00212 <span class="comment">Arguments:</span>
00213 <span class="comment"></span>
00214 <span class="comment">    Segment - a pointer to the segment structure.</span>
00215 <span class="comment"></span>
00216 <span class="comment">Return Value:</span>
00217 <span class="comment"></span>
00218 <span class="comment">    None.</span>
00219 <span class="comment"></span>
00220 <span class="comment">--*/</span>
00221 
00222 {
00223     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00224     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00225     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00226     KIRQL OldIrql;
00227     KIRQL OldIrql2;
00228     <span class="keyword">volatile</span> <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
00229     <span class="keyword">volatile</span> <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00230     <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">PEVENT_COUNTER</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00231     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00232     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00233     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> NextSubsection;
00234     SIZE_T CommittedPages;
00235 
00236     PointerPte = Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o12">PrototypePte</a>;
00237     LastPte = PointerPte + Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o3">NonExtendedPtes</a>;
00238 
00239 <span class="preprocessor">#if DBG</span>
00240 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a64">MM_DBG_SECTIONS</a>) {
00241         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:deleting segment %lx control %lx\n"</span>,Segment, Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>);
00242     }
00243 <span class="preprocessor">#endif</span>
00244 <span class="preprocessor"></span>
00245     ControlArea = Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
00246 
00247     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted == 1);
00248 
00249     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql2);
00250     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00251 
00252         <span class="comment">//</span>
00253         <span class="comment">// Remove this from the list of unused segments.</span>
00254         <span class="comment">//</span>
00255 
00256         ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, &amp;OldIrql);
00257         RemoveEntryList (&amp;ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>);
00258 
00259         <a class="code" href="../../d4/d8/mi_8h.html#a330">MI_UNUSED_SEGMENTS_REMOVE_CHARGE</a> (ControlArea);
00260 
00261         ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
00262     }
00263     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql2);
00264 
00265     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image ||
00266         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.File ) {
00267 
00268         <span class="comment">//</span>
00269         <span class="comment">// If there have been committed pages in this segment, adjust</span>
00270         <span class="comment">// the total commit count.</span>
00271         <span class="comment">//</span>
00272 
00273 
00274         <span class="comment">//</span>
00275         <span class="comment">// Unload kernel debugger symbols if any were loaded.</span>
00276         <span class="comment">//</span>
00277 
00278         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.DebugSymbolsLoaded != 0) {
00279 
00280             <span class="comment">//</span>
00281             <span class="comment">//  TEMP TEMP TEMP rip out when debugger converted</span>
00282             <span class="comment">//</span>
00283 
00284             ANSI_STRING AnsiName;
00285             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00286 
00287             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;AnsiName,
00288                                                    (PUNICODE_STRING)&amp;Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>,
00289                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00290 
00291             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00292                 DbgUnLoadImageSymbols( &amp;AnsiName,
00293                                        Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o10">BasedAddress</a>,
00294                                        (ULONG_PTR)<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>());
00295                 <a class="code" href="../../d6/d6/nls_8c.html#a35">RtlFreeAnsiString</a>( &amp;AnsiName );
00296             }
00297             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00298             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.DebugSymbolsLoaded = 0;
00299             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00300         }
00301 
00302         <span class="comment">//</span>
00303         <span class="comment">// If the segment was deleted due to a name collision at insertion</span>
00304         <span class="comment">// we don't want to dereference the file pointer.</span>
00305         <span class="comment">//</span>
00306 
00307         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00308 
00309             <span class="comment">//</span>
00310             <span class="comment">// Clear the segment context and dereference the file object</span>
00311             <span class="comment">// for this Segment.</span>
00312             <span class="comment">//</span>
00313 
00314             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00315 
00316             <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (Segment);
00317             <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> = (<span class="keyword">volatile</span> <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>)Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>;
00318             ControlArea = (<span class="keyword">volatile</span> <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
00319 
00320             <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o12">WaitingForDeletion</a>;
00321             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o12">WaitingForDeletion</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00322 
00323             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00324 
00325             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00326                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Event, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00327             }
00328 
00329 <span class="preprocessor">#if DBG</span>
00330 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image == 1) {
00331                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o6">SectionObjectPointer</a>-&gt;<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o2">ImageSectionObject</a> != (PVOID)ControlArea);
00332             } <span class="keywordflow">else</span> {
00333                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o6">SectionObjectPointer</a>-&gt;<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != (PVOID)ControlArea);
00334             }
00335 <span class="preprocessor">#endif //DBG</span>
00336 <span class="preprocessor"></span>    
00337             <a class="code" href="../../d2/d1/mm_8h.html#a92">PERFINFO_SEGMENT_DELETE</a>(ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>);
00338 
00339             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>);
00340         }
00341 
00342         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image == 0) {
00343 
00344             <span class="comment">//</span>
00345             <span class="comment">// This is a mapped data file.  None of the prototype</span>
00346             <span class="comment">// PTEs may be referencing a physical page (valid or transition).</span>
00347             <span class="comment">//</span>
00348 
00349 <span class="preprocessor">#if DBG</span>
00350 <span class="preprocessor"></span>            <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
00351 
00352                 <span class="comment">//</span>
00353                 <span class="comment">// Prototype PTEs for segments backed by paging file</span>
00354                 <span class="comment">// are either in demand zero, page file format, or transition.</span>
00355                 <span class="comment">//</span>
00356 
00357                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00358                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) ||
00359                         (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0));
00360                 PointerPte += 1;
00361             }
00362 <span class="preprocessor">#endif //DBG</span>
00363 <span class="preprocessor"></span>
00364             <span class="comment">//</span>
00365             <span class="comment">// Deallocate the control area and subsections.</span>
00366             <span class="comment">//</span>
00367 
00368             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0);
00369 
00370             Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
00371 
00372             Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00373 
00374             <span class="keywordflow">while</span> (Subsection != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00375                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>);
00376                 NextSubsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00377                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Subsection);
00378                 Subsection = NextSubsection;
00379             }
00380 
00381             <span class="keywordflow">if</span> (Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o8">NumberOfCommittedPages</a> != 0) {
00382                 <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o8">NumberOfCommittedPages</a>);
00383                 <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a303">MM_DBG_COMMIT_RETURN_SEGMENT_DELETE1</a>,
00384                                  Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o8">NumberOfCommittedPages</a>);
00385 
00386                 ExAcquireFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
00387                 <a class="code" href="../../d8/d5/kddata_8c.html#a31">MmSharedCommit</a> -= Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o8">NumberOfCommittedPages</a>;
00388                 ExReleaseFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
00389             }
00390 
00391             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>);
00392             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Segment);
00393 
00394             <span class="comment">//</span>
00395             <span class="comment">// The file mapped Segment object is now deleted.</span>
00396             <span class="comment">//</span>
00397 
00398             <span class="keywordflow">return</span>;
00399         }
00400     }
00401 
00402     <span class="comment">//</span>
00403     <span class="comment">// This is a page file backed or image Segment.  The Segment is being</span>
00404     <span class="comment">// deleted, remove all references to the paging file and physical memory.</span>
00405     <span class="comment">//</span>
00406 
00407     <span class="comment">//</span>
00408     <span class="comment">// The PFN lock is required for deallocating pages from a paging</span>
00409     <span class="comment">// file and for deleting transition PTEs.</span>
00410     <span class="comment">//</span>
00411 
00412     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00413 
00414     <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerPte);
00415 
00416     <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
00417 
00418         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) {
00419 
00420             <span class="comment">//</span>
00421             <span class="comment">// We are on a page boundary, make sure this PTE is resident.</span>
00422             <span class="comment">//</span>
00423 
00424             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (PointerPte) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00425 
00426                 <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerPte);
00427             }
00428         }
00429 
00430         PteContents = *PointerPte;
00431 
00432         <span class="comment">//</span>
00433         <span class="comment">// Prototype PTEs for Segments backed by paging file</span>
00434         <span class="comment">// are either in demand zero, page file format, or transition.</span>
00435         <span class="comment">//</span>
00436 
00437         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00438 
00439         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) {
00440 
00441             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
00442 
00443                 <span class="comment">//</span>
00444                 <span class="comment">// Prototype PTE in transition, put the page on the free list.</span>
00445                 <span class="comment">//</span>
00446 
00447                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
00448 
00449                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00450 
00451                 <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00452 
00453                 <span class="comment">//</span>
00454                 <span class="comment">// Check the reference count for the page, if the reference</span>
00455                 <span class="comment">// count is zero and the page is not on the freelist,</span>
00456                 <span class="comment">// move the page to the free list, if the reference</span>
00457                 <span class="comment">// count is not zero, ignore this page.</span>
00458                 <span class="comment">// When the reference count goes to zero, it will be placed</span>
00459                 <span class="comment">// on the free list.</span>
00460                 <span class="comment">//</span>
00461 
00462                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
00463                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
00464                     <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00465                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
00466                                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents));
00467                 }
00468 
00469             } <span class="keywordflow">else</span> {
00470 
00471                 <span class="comment">//</span>
00472                 <span class="comment">// This is not a prototype PTE, if any paging file</span>
00473                 <span class="comment">// space has been allocated, release it.</span>
00474                 <span class="comment">//</span>
00475 
00476                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a171">IS_PTE_NOT_DEMAND_ZERO</a> (PteContents)) {
00477                     <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (PteContents);
00478                 }
00479             }
00480         }
00481 <span class="preprocessor">#if DBG</span>
00482 <span class="preprocessor"></span>        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
00483 <span class="preprocessor">#endif</span>
00484 <span class="preprocessor"></span>        PointerPte += 1;
00485     }
00486 
00487     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00488 
00489     <span class="comment">//</span>
00490     <span class="comment">// If there have been committed pages in this segment, adjust</span>
00491     <span class="comment">// the total commit count.</span>
00492     <span class="comment">//</span>
00493 
00494     <span class="keywordflow">if</span> (Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o8">NumberOfCommittedPages</a> != 0) {
00495         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o8">NumberOfCommittedPages</a>);
00496         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a304">MM_DBG_COMMIT_RETURN_SEGMENT_DELETE2</a>,
00497                          Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o8">NumberOfCommittedPages</a>);
00498 
00499         ExAcquireFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
00500         <a class="code" href="../../d8/d5/kddata_8c.html#a31">MmSharedCommit</a> -= Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o8">NumberOfCommittedPages</a>;
00501         ExReleaseFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
00502     }
00503 
00504     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>);
00505     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Segment);
00506 
00507     <span class="keywordflow">return</span>;
00508 }
00509 
00510 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00511"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a18">00511</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a18">MiSectionDelete</a> (
00512     PVOID Object
00513     )
00514 
00515 <span class="comment">/*++</span>
00516 <span class="comment"></span>
00517 <span class="comment">Routine Description:</span>
00518 <span class="comment"></span>
00519 <span class="comment"></span>
00520 <span class="comment">    This routine is called by the object management procedures whenever</span>
00521 <span class="comment">    the last reference to a section object has been removed.  This routine</span>
00522 <span class="comment">    dereferences the associated segment object and checks to see if</span>
00523 <span class="comment">    the segment object should be deleted by queueing the segment to the</span>
00524 <span class="comment">    segment deletion thread.</span>
00525 <span class="comment"></span>
00526 <span class="comment">Arguments:</span>
00527 <span class="comment"></span>
00528 <span class="comment">    Object - a pointer to the body of the section object.</span>
00529 <span class="comment"></span>
00530 <span class="comment">Return Value:</span>
00531 <span class="comment"></span>
00532 <span class="comment">    None.</span>
00533 <span class="comment"></span>
00534 <span class="comment">--*/</span>
00535 
00536 {
00537     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> Section;
00538     <span class="keyword">volatile</span> <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00539     KIRQL OldIrql;
00540     ULONG UserRef;
00541 
00542     Section = (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)Object;
00543 
00544     <span class="keywordflow">if</span> (Section-&gt;Segment == (<a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00545 
00546         <span class="comment">//</span>
00547         <span class="comment">// The section was never initialized, no need to remove</span>
00548         <span class="comment">// any structures.</span>
00549         <span class="comment">//</span>
00550         <span class="keywordflow">return</span>;
00551     }
00552 
00553     UserRef = Section-&gt;u.Flags.UserReference;
00554     ControlArea = (<span class="keyword">volatile</span> <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)Section-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
00555 
00556 <span class="preprocessor">#if DBG</span>
00557 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a64">MM_DBG_SECTIONS</a>) {
00558         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:deleting section %lx control %lx\n"</span>,Section, ControlArea);
00559     }
00560 <span class="preprocessor">#endif</span>
00561 <span class="preprocessor"></span>
00562     <span class="keywordflow">if</span> (Section-&gt;Address.StartingVpn != 0) {
00563 
00564         <span class="comment">//</span>
00565         <span class="comment">// This section is based, remove the base address from the</span>
00566         <span class="comment">// tree.</span>
00567         <span class="comment">//</span>
00568 
00569         <span class="comment">//</span>
00570         <span class="comment">// Get the allocation base mutex.</span>
00571         <span class="comment">//</span>
00572 
00573         ExAcquireFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a678">MmSectionBasedMutex</a>);
00574 
00575         <a class="code" href="../../d5/d5/sectsup_8c.html#a15">MiRemoveBasedSection</a> (Section);
00576 
00577         ExReleaseFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a678">MmSectionBasedMutex</a>);
00578 
00579     }
00580 
00581     <span class="comment">//</span>
00582     <span class="comment">// Decrement the number of section references to the segment for this</span>
00583     <span class="comment">// section.  This requires APCs to be blocked and the PFN lock to</span>
00584     <span class="comment">// synchronize upon.</span>
00585     <span class="comment">//</span>
00586 
00587     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00588 
00589     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> -= 1;
00590     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= UserRef;
00591 
00592     <span class="comment">//</span>
00593     <span class="comment">// This routine returns with the PFN lock released.</span>
00594     <span class="comment">//</span>
00595 
00596     <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, OldIrql);
00597 
00598     <span class="keywordflow">return</span>;
00599 }
00600 
00601 
00602 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00603"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a19">00603</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a19">MiDereferenceSegmentThread</a> (
00604     IN PVOID StartContext
00605     )
00606 
00607 <span class="comment">/*++</span>
00608 <span class="comment"></span>
00609 <span class="comment">Routine Description:</span>
00610 <span class="comment"></span>
00611 <span class="comment">    This routine is the thread for dereferencing segments which have</span>
00612 <span class="comment">    no references from any sections or mapped views AND there are</span>
00613 <span class="comment">    no prototype PTEs within the segment which are in the transition</span>
00614 <span class="comment">    state (i.e., no PFN database references to the segment).</span>
00615 <span class="comment"></span>
00616 <span class="comment">    It also does double duty and is used for expansion of paging files.</span>
00617 <span class="comment"></span>
00618 <span class="comment">Arguments:</span>
00619 <span class="comment"></span>
00620 <span class="comment">    StartContext - Not used.</span>
00621 <span class="comment"></span>
00622 <span class="comment">Return Value:</span>
00623 <span class="comment"></span>
00624 <span class="comment">    None.</span>
00625 <span class="comment"></span>
00626 <span class="comment">--*/</span>
00627 
00628 {
00629     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00630     <a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">PMMPAGE_FILE_EXPANSION</a> PageExpand;
00631     PLIST_ENTRY NextEntry;
00632     KIRQL OldIrql;
00633     <span class="keyword">static</span> <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a> WaitBlockArray[<a class="code" href="../../d5/d5/sectsup_8c.html#a32a10">SegMaximumObject</a>];
00634     PVOID WaitObjects[<a class="code" href="../../d5/d5/sectsup_8c.html#a32a10">SegMaximumObject</a>];
00635     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00636 
00637     UNREFERENCED_PARAMETER (StartContext);
00638 
00639     <span class="comment">//</span>
00640     <span class="comment">// Make this a real time thread.</span>
00641     <span class="comment">//</span>
00642 
00643     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Tcb,
00644                                 LOW_REALTIME_PRIORITY + 2);
00645 
00646     WaitObjects[<a class="code" href="../../d5/d5/sectsup_8c.html#a32a8">SegmentDereference</a>] = (PVOID)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o1">Semaphore</a>;
00647     WaitObjects[<a class="code" href="../../d5/d5/sectsup_8c.html#a32a9">UsedSegmentCleanup</a>] = (PVOID)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a699">MmUnusedSegmentCleanup</a>;
00648 
00649     <span class="keywordflow">for</span> (;;) {
00650 
00651         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(<a class="code" href="../../d5/d5/sectsup_8c.html#a32a10">SegMaximumObject</a>,
00652                                           &amp;WaitObjects[0],
00653                                           WaitAny,
00654                                           <a class="code" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>,
00655                                           <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
00656                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00657                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00658                                           &amp;WaitBlockArray[0]);
00659 
00660         <span class="comment">//</span>
00661         <span class="comment">// Switch on the wait status.</span>
00662         <span class="comment">//</span>
00663 
00664         <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00665 
00666         <span class="keywordflow">case</span> <a class="code" href="../../d5/d5/sectsup_8c.html#a32a8">SegmentDereference</a>:
00667 
00668             <span class="comment">//</span>
00669             <span class="comment">// An entry is available to dereference, acquire the spinlock</span>
00670             <span class="comment">// and remove the entry.</span>
00671             <span class="comment">//</span>
00672 
00673             ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, &amp;OldIrql);
00674 
00675             <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>)) {
00676 
00677                 <span class="comment">//</span>
00678                 <span class="comment">// There is nothing in the list, rewait.</span>
00679                 <span class="comment">//</span>
00680 
00681                 ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
00682                 <span class="keywordflow">break</span>;
00683             }
00684 
00685             NextEntry = RemoveHeadList(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>);
00686 
00687             ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
00688 
00689             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00690 
00691             ControlArea = CONTAINING_RECORD( NextEntry,
00692                                              <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">CONTROL_AREA</a>,
00693                                              DereferenceList );
00694 
00695             <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00696 
00697                 <span class="comment">//</span>
00698                 <span class="comment">// This is a control area, delete it.</span>
00699                 <span class="comment">//</span>
00700 
00701 <span class="preprocessor">#if DBG</span>
00702 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a64">MM_DBG_SECTIONS</a>) {
00703                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:dereferencing segment %lx control %lx\n"</span>,
00704                         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>, ControlArea);
00705                 }
00706 <span class="preprocessor">#endif</span>
00707 <span class="preprocessor"></span>
00708                 <span class="comment">//</span>
00709                 <span class="comment">// Indicate this entry is not on any list.</span>
00710                 <span class="comment">//</span>
00711 
00712                 ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00713 
00714                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FilePointerNull == 1);
00715                 <a class="code" href="../../d5/d5/sectsup_8c.html#a17">MiSegmentDelete</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>);
00716 
00717             } <span class="keywordflow">else</span> {
00718 
00719                 <span class="comment">//</span>
00720                 <span class="comment">// This is a request to expand or reduce the paging files.</span>
00721                 <span class="comment">//</span>
00722 
00723                 PageExpand = (<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">PMMPAGE_FILE_EXPANSION</a>)ControlArea;
00724 
00725                 <span class="keywordflow">if</span> (PageExpand-&gt;<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o2">RequestedExpansionSize</a> == 0xFFFFFFFF) {
00726 
00727                     <span class="comment">//</span>
00728                     <span class="comment">// Attempt to reduce the size of the paging files.</span>
00729                     <span class="comment">//</span>
00730 
00731                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PageExpand);
00732 
00733                     <a class="code" href="../../d6/d3/modwrite_8c.html#a48">MiAttemptPageFileReduction</a> ();
00734                 } <span class="keywordflow">else</span> {
00735 
00736                     <span class="comment">//</span>
00737                     <span class="comment">// Attempt to expand the size of the paging files.</span>
00738                     <span class="comment">//</span>
00739 
00740                     <a class="code" href="../../d6/d3/modwrite_8c.html#a46">MiExtendPagingFiles</a> (PageExpand);
00741                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;PageExpand-&gt;<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o4">Event</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00742                     <a class="code" href="../../d5/d5/sectsup_8c.html#a13">MiRemoveUnusedSegments</a>();
00743                 }
00744             }
00745             <span class="keywordflow">break</span>;
00746 
00747         <span class="keywordflow">case</span> <a class="code" href="../../d5/d5/sectsup_8c.html#a32a9">UsedSegmentCleanup</a>:
00748 
00749             <a class="code" href="../../d5/d5/sectsup_8c.html#a13">MiRemoveUnusedSegments</a>();
00750 
00751             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a699">MmUnusedSegmentCleanup</a>);
00752 
00753             <span class="keywordflow">break</span>;
00754 
00755         <span class="keywordflow">default</span>:
00756 
00757             KdPrint((<span class="stringliteral">"MMSegmentderef: Illegal wait status, %lx =\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00758             <span class="keywordflow">break</span>;
00759         } <span class="comment">// end switch</span>
00760 
00761     } <span class="comment">//end for</span>
00762 
00763     <span class="keywordflow">return</span>;
00764 }
00765 
00766 
00767 ULONG
<a name="l00768"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a20">00768</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a20">MiSectionInitialization</a> (
00769     )
00770 
00771 <span class="comment">/*++</span>
00772 <span class="comment"></span>
00773 <span class="comment">Routine Description:</span>
00774 <span class="comment"></span>
00775 <span class="comment">    This function creates the section object type descriptor at system</span>
00776 <span class="comment">    initialization and stores the address of the object type descriptor</span>
00777 <span class="comment">    in global storage.</span>
00778 <span class="comment"></span>
00779 <span class="comment">Arguments:</span>
00780 <span class="comment"></span>
00781 <span class="comment">    None.</span>
00782 <span class="comment"></span>
00783 <span class="comment">Return Value:</span>
00784 <span class="comment"></span>
00785 <span class="comment">    TRUE - Initialization was successful.</span>
00786 <span class="comment"></span>
00787 <span class="comment">    FALSE - Initialization Failed.</span>
00788 <span class="comment"></span>
00789 <span class="comment"></span>
00790 <span class="comment"></span>
00791 <span class="comment">--*/</span>
00792 
00793 {
00794     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
00795     UNICODE_STRING TypeName;
00796     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
00797     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00798     UNICODE_STRING SectionName;
00799     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> Section;
00800     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00801     <a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a> Segment;
00802     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00803     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00804 
00805     <a class="code" href="../../d4/d8/mi_8h.html#a675">MmSectionBasedRoot</a> = (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00806 
00807     <span class="comment">//</span>
00808     <span class="comment">// Initialize the common fields of the Object Type Initializer record</span>
00809     <span class="comment">//</span>
00810 
00811     RtlZeroMemory( &amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>( ObjectTypeInitializer ) );
00812     ObjectTypeInitializer.Length = <span class="keyword">sizeof</span>( ObjectTypeInitializer );
00813     ObjectTypeInitializer.InvalidAttributes = OBJ_OPENLINK;
00814     ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d5/d5/sectsup_8c.html#a7">MiSectionMapping</a>;
00815     ObjectTypeInitializer.PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
00816     ObjectTypeInitializer.DefaultPagedPoolCharge = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d0/struct__SECTION.html">SECTION</a>);
00817 
00818     <span class="comment">//</span>
00819     <span class="comment">// Initialize string descriptor.</span>
00820     <span class="comment">//</span>
00821 
00822     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;TypeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Section"</span>);
00823 
00824     <span class="comment">//</span>
00825     <span class="comment">// Create the section object type descriptor</span>
00826     <span class="comment">//</span>
00827 
00828     ObjectTypeInitializer.ValidAccessMask = SECTION_ALL_ACCESS;
00829     ObjectTypeInitializer.DeleteProcedure = <a class="code" href="../../d4/d8/mi_8h.html#a919">MiSectionDelete</a>;
00830     ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d5/d5/sectsup_8c.html#a7">MiSectionMapping</a>;
00831     ObjectTypeInitializer.UseDefaultObject = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00832     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;TypeName,
00833                                      &amp;ObjectTypeInitializer,
00834                                      (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00835                                      &amp;<a class="code" href="../../d2/d1/mm_8h.html#a133">MmSectionObjectType</a>
00836                                      )) ) {
00837         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00838     }
00839 
00840     <span class="comment">//</span>
00841     <span class="comment">// Initialize listhead, spinlock and semaphore for</span>
00842     <span class="comment">// segment dereferencing thread.</span>
00843     <span class="comment">//</span>
00844 
00845     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>);
00846     InitializeListHead (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>);
00847     <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o1">Semaphore</a>, 0, MAXLONG);
00848 
00849     InitializeListHead (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a698">MmUnusedSegmentList</a>);
00850     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a699">MmUnusedSegmentCleanup</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00851 
00852     <span class="comment">//</span>
00853     <span class="comment">// Create the Segment dereferencing thread.</span>
00854     <span class="comment">//</span>
00855 
00856     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00857                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00858                                 0,
00859                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00860                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00861 
00862     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>(
00863                     &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00864                     THREAD_ALL_ACCESS,
00865                     &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00866                     0,
00867                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00868                     <a class="code" href="../../d4/d8/mi_8h.html#a920">MiDereferenceSegmentThread</a>,
00869                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00870                     )) ) {
00871         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00872     }
00873     ZwClose (<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>);
00874 
00875     <span class="comment">//</span>
00876     <span class="comment">// Create the permanent section which maps physical memory.</span>
00877     <span class="comment">//</span>
00878 
00879     Segment = (<a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00880                                                <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/struct__SEGMENT.html">SEGMENT</a>),
00881                                                'gSmM');
00882     <span class="keywordflow">if</span> (Segment == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00883         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00884     }
00885 
00886     ControlArea = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00887                                          (ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">CONTROL_AREA</a>),
00888                                          <a class="code" href="../../d0/d8/creasect_8c.html#a6">MMCONTROL</a>);
00889     <span class="keywordflow">if</span> (ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00890         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Segment);
00891         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00892     }
00893 
00894     RtlZeroMemory (Segment, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a455">SEGMENT</a>));
00895     RtlZeroMemory (ControlArea, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a460">CONTROL_AREA</a>));
00896 
00897     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a> = Segment;
00898     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> = 1;
00899     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.PhysicalMemory = 1;
00900 
00901     Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a> = ControlArea;
00902     Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o9">SegmentPteTemplate</a> = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
00903 
00904     <span class="comment">//</span>
00905     <span class="comment">// Now that the segment object is created, create a section object</span>
00906     <span class="comment">// which refers to the segment object.</span>
00907     <span class="comment">//</span>
00908 
00909     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;SectionName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Device\\PhysicalMemory"</span>);
00910 
00911     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00912                                 &amp;SectionName,
00913                                 OBJ_PERMANENT,
00914                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00915                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00916                               );
00917 
00918     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00919                              <a class="code" href="../../d2/d1/mm_8h.html#a133">MmSectionObjectType</a>,
00920                              &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00921                              <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00922                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00923                              <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d0/struct__SECTION.html">SECTION</a>),
00924                              <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a479">SECTION</a>),
00925                              0,
00926                              (PVOID *)&amp;Section);
00927     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00928         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ControlArea);
00929         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Segment);
00930         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00931     }
00932 
00933     Section-&gt;Segment = Segment;
00934     Section-&gt;SizeOfSection.QuadPart = ((LONGLONG)1 &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a54">PHYSICAL_ADDRESS_BITS</a>) - 1;
00935     Section-&gt;u.LongFlags = 0;
00936     Section-&gt;InitialPageProtection = PAGE_READWRITE;
00937 
00938     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a> ((PVOID)Section,
00939                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00940                                     SECTION_MAP_READ,
00941                                     0,
00942                                     (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00943                                     &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00944 
00945     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00946         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00947     }
00948 
00949     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> ( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>))) {
00950         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00951     }
00952 
00953     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00954 }
00955 
00956 BOOLEAN
<a name="l00957"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a21">00957</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a21">MmForceSectionClosed</a> (
00958     IN <a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionObjectPointer,
00959     IN BOOLEAN DelayClose
00960     )
00961 
00962 <span class="comment">/*++</span>
00963 <span class="comment"></span>
00964 <span class="comment">Routine Description:</span>
00965 <span class="comment"></span>
00966 <span class="comment">    This function examines the Section object pointers.  If they are NULL,</span>
00967 <span class="comment">    no further action is taken and the value TRUE is returned.</span>
00968 <span class="comment"></span>
00969 <span class="comment">    If the Section object pointer is not NULL, the section reference count</span>
00970 <span class="comment">    and the map view count are checked. If both counts are zero, the</span>
00971 <span class="comment">    segment associated with the file is deleted and the file closed.</span>
00972 <span class="comment">    If one of the counts is non-zero, no action is taken and the</span>
00973 <span class="comment">    value FALSE is returned.</span>
00974 <span class="comment"></span>
00975 <span class="comment">Arguments:</span>
00976 <span class="comment"></span>
00977 <span class="comment">    SectionObjectPointer - Supplies a pointer to a section object.</span>
00978 <span class="comment"></span>
00979 <span class="comment">    DelayClose - Supplies the value TRUE if the close operation should</span>
00980 <span class="comment">                 occur as soon as possible in the event this section</span>
00981 <span class="comment">                 cannot be closed now due to outstanding references.</span>
00982 <span class="comment"></span>
00983 <span class="comment">Return Value:</span>
00984 <span class="comment"></span>
00985 <span class="comment">    TRUE - The segment was deleted and the file closed or no segment was</span>
00986 <span class="comment">           located.</span>
00987 <span class="comment"></span>
00988 <span class="comment">    FALSE - The segment was not deleted and no action was performed OR</span>
00989 <span class="comment">            an I/O error occurred trying to write the pages.</span>
00990 <span class="comment"></span>
00991 <span class="comment">--*/</span>
00992 
00993 {
00994     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00995     KIRQL OldIrql;
00996     BOOLEAN state;
00997 
00998     <span class="comment">//</span>
00999     <span class="comment">// Check the status of the control area, if the control area is in use</span>
01000     <span class="comment">// or the control area is being deleted, this operation cannot continue.</span>
01001     <span class="comment">//</span>
01002 
01003     state = <a class="code" href="../../d5/d5/sectsup_8c.html#a26">MiCheckControlAreaStatus</a> (<a class="code" href="../../d4/d8/mi_8h.html#a1002a768">CheckBothSection</a>,
01004                                       SectionObjectPointer,
01005                                       DelayClose,
01006                                       &amp;ControlArea,
01007                                       &amp;OldIrql);
01008 
01009     <span class="keywordflow">if</span> (ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01010         <span class="keywordflow">return</span> state;
01011     }
01012 
01013     <span class="comment">//</span>
01014     <span class="comment">// PFN LOCK IS NOW HELD!</span>
01015     <span class="comment">//</span>
01016 
01017     <span class="comment">//</span>
01018     <span class="comment">// Repeat until there are no more control areas - multiple control areas</span>
01019     <span class="comment">// for the same image section occur to support user global DLLs - these DLLs</span>
01020     <span class="comment">// require data that is shared within a session but not across sessions.</span>
01021     <span class="comment">// Note this can only happen for Hydra.</span>
01022     <span class="comment">//</span>
01023 
01024     <span class="keywordflow">do</span> {
01025 
01026         <span class="comment">//</span>
01027         <span class="comment">// Set the being deleted flag and up the number of mapped views</span>
01028         <span class="comment">// for the segment.  Upping the number of mapped views prevents</span>
01029         <span class="comment">// the segment from being deleted and passed to the deletion thread</span>
01030         <span class="comment">// while we are forcing a delete.</span>
01031         <span class="comment">//</span>
01032 
01033         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted = 1;
01034         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> == 0);
01035         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> = 1;
01036 
01037         <span class="comment">//</span>
01038         <span class="comment">// This is a page file backed or image Segment.  The Segment is being</span>
01039         <span class="comment">// deleted, remove all references to the paging file and physical memory.</span>
01040         <span class="comment">//</span>
01041 
01042         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01043 
01044         <span class="comment">//</span>
01045         <span class="comment">// Delete the section by flushing all modified pages back to the section</span>
01046         <span class="comment">// if it is a file and freeing up the pages such that the</span>
01047         <span class="comment">// PfnReferenceCount goes to zero.</span>
01048         <span class="comment">//</span>
01049 
01050         <a class="code" href="../../d5/d5/sectsup_8c.html#a22">MiCleanSection</a> (ControlArea, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01051 
01052         <span class="comment">//</span>
01053         <span class="comment">// Get the next Hydra control area.</span>
01054         <span class="comment">//</span>
01055 
01056         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01057             state = <a class="code" href="../../d5/d5/sectsup_8c.html#a26">MiCheckControlAreaStatus</a> (<a class="code" href="../../d4/d8/mi_8h.html#a1002a768">CheckBothSection</a>,
01058                                               SectionObjectPointer,
01059                                               DelayClose,
01060                                               &amp;ControlArea,
01061                                               &amp;OldIrql);
01062         }
01063         <span class="keywordflow">else</span> {
01064             state = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01065             <span class="keywordflow">break</span>;
01066         }
01067 
01068     } <span class="keywordflow">while</span> (ControlArea);
01069 
01070     <span class="keywordflow">return</span> state;
01071 }
01072 
01073 
01074 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01075"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a22">01075</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a22">MiCleanSection</a> (
01076     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea,
01077     IN LOGICAL DirtyDataPagesOk
01078     )
01079 
01080 <span class="comment">/*++</span>
01081 <span class="comment"></span>
01082 <span class="comment">Routine Description:</span>
01083 <span class="comment"></span>
01084 <span class="comment">    This function examines each prototype PTE in the section and</span>
01085 <span class="comment">    takes the appropriate action to "delete" the prototype PTE.</span>
01086 <span class="comment"></span>
01087 <span class="comment">    If the PTE is dirty and is backed by a file (not a paging file),</span>
01088 <span class="comment">    the corresponding page is written to the file.</span>
01089 <span class="comment"></span>
01090 <span class="comment">    At the completion of this service, the section which was</span>
01091 <span class="comment">    operated upon is no longer usable.</span>
01092 <span class="comment"></span>
01093 <span class="comment">    NOTE - ALL I/O ERRORS ARE IGNORED.  IF ANY WRITES FAIL, THE</span>
01094 <span class="comment">           DIRTY PAGES ARE MARKED CLEAN AND THE SECTION IS DELETED.</span>
01095 <span class="comment"></span>
01096 <span class="comment">Arguments:</span>
01097 <span class="comment"></span>
01098 <span class="comment">    ControlArea - Supplies a pointer to the control area for the section.</span>
01099 <span class="comment"></span>
01100 <span class="comment">    DirtyDataPagesOk - Supplies TRUE if dirty data pages are ok.  If FALSE</span>
01101 <span class="comment">                       is specified then no dirty data pages are expected (as</span>
01102 <span class="comment">                       this is a dereference operation) so any encountered</span>
01103 <span class="comment">                       must be due to pool corruption so bugcheck.</span>
01104 <span class="comment"></span>
01105 <span class="comment">                       Note that dirty image pages are always discarded.</span>
01106 <span class="comment">                       This should only happen for images that were either</span>
01107 <span class="comment">                       read in from floppies or images with shared global</span>
01108 <span class="comment">                       subsections.</span>
01109 <span class="comment"></span>
01110 <span class="comment">Return Value:</span>
01111 <span class="comment"></span>
01112 <span class="comment">    None.</span>
01113 <span class="comment"></span>
01114 <span class="comment">--*/</span>
01115 
01116 {
01117     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01118     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
01119     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastWritten;
01120     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
01121     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01122     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
01123     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> WrittenPte;
01124     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> WrittenContents;
01125     KIRQL OldIrql;
01126     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
01127     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
01128     PPFN_NUMBER Page;
01129     PPFN_NUMBER LastPage;
01130     LARGE_INTEGER StartingOffset;
01131     LARGE_INTEGER TempOffset;
01132     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01133     IO_STATUS_BLOCK IoStatus;
01134     ULONG WriteNow;
01135     ULONG ImageSection;
01136     ULONG DelayCount;
01137     ULONG First;
01138     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> IoEvent;
01139     PFN_NUMBER MdlHack[(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)/<span class="keyword">sizeof</span>(PFN_NUMBER)) + <a class="code" href="../../d4/d8/mi_8h.html#a33">MM_MAXIMUM_WRITE_CLUSTER</a>];
01140 
01141     WriteNow = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01142     ImageSection = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01143     DelayCount = 0;
01144 
01145     <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.Image) {
01146         ImageSection = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01147     }
01148     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;FilePointer);
01149 
01150     PointerPte = ControlArea-&gt;Segment-&gt;PrototypePte;
01151     LastPte = PointerPte + ControlArea-&gt;Segment-&gt;NonExtendedPtes;
01152 
01153     Mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)&amp;MdlHack;
01154 
01155     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;IoEvent, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01156 
01157     LastWritten = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01158     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a> == <a class="code" href="../../d4/d8/mi_8h.html#a33">MM_MAXIMUM_WRITE_CLUSTER</a>);
01159     LastPage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01160 
01161     <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.GlobalOnlyPerSession == 0) {
01162         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
01163     }
01164     <span class="keywordflow">else</span> {
01165         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)((<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)ControlArea + 1);
01166     }
01167 
01168     <span class="comment">//</span>
01169     <span class="comment">// The PFN lock is required for deallocating pages from a paging</span>
01170     <span class="comment">// file and for deleting transition PTEs.</span>
01171     <span class="comment">//</span>
01172 
01173     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01174 
01175     <span class="comment">//</span>
01176     <span class="comment">// Stop the modified page writer from writing pages to this</span>
01177     <span class="comment">// file, and if any paging I/O is in progress, wait for it</span>
01178     <span class="comment">// to complete.</span>
01179     <span class="comment">//</span>
01180 
01181     ControlArea-&gt;u.Flags.NoModifiedWriting = 1;
01182 
01183     <span class="keywordflow">while</span> (ControlArea-&gt;ModifiedWriteCount != 0) {
01184 
01185         <span class="comment">//</span>
01186         <span class="comment">// There is modified page writing in progess.  Set the</span>
01187         <span class="comment">// flag in the control area indicating the modified page</span>
01188         <span class="comment">// writer should signal when a write to this control area</span>
01189         <span class="comment">// is complete.  Release the PFN LOCK and wait in an</span>
01190         <span class="comment">// atomic operation.  Once the wait is satisfied, recheck</span>
01191         <span class="comment">// to make sure it was this file's I/O that was written.</span>
01192         <span class="comment">//</span>
01193 
01194         ControlArea-&gt;u.Flags.SetMappedFileIoComplete = 1;
01195         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01196         <a class="code" href="../../d4/d8/mi_8h.html#a132">UNLOCK_PFN_AND_THEN_WAIT</a>(OldIrql);
01197 
01198         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a614">MmMappedFileIoComplete</a>,
01199                               <a class="code" href="../../d4/d9/ke_8h.html#a407a217">WrPageOut</a>,
01200                               <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01201                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01202                               (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01203         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01204         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01205     }
01206 
01207     <span class="keywordflow">for</span> (;;) {
01208 
01209         First = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01210         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
01211 
01212             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) || (First)) {
01213 
01214                 First = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01215 
01216                 <span class="keywordflow">if</span> ((ImageSection) ||
01217                     (<a class="code" href="../../d5/d5/sectsup_8c.html#a11">MiCheckProtoPtePageState</a>(PointerPte, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))) {
01218                     <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerPte);
01219                 } <span class="keywordflow">else</span> {
01220 
01221                     <span class="comment">//</span>
01222                     <span class="comment">// Paged pool page is not resident, hence no transition or</span>
01223                     <span class="comment">// valid prototype PTEs can be present in it.  Skip it.</span>
01224                     <span class="comment">//</span>
01225 
01226                     PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((((ULONG_PTR)PointerPte | <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) + 1);
01227                     <span class="keywordflow">if</span> (LastWritten != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01228                         WriteNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01229                     }
01230                     <span class="keywordflow">goto</span> WriteItOut;
01231                 }
01232             }
01233 
01234             PteContents = *PointerPte;
01235 
01236             <span class="comment">//</span>
01237             <span class="comment">// Prototype PTEs for Segments backed by paging file</span>
01238             <span class="comment">// are either in demand zero, page file format, or transition.</span>
01239             <span class="comment">//</span>
01240 
01241             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01242                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (POOL_CORRUPTION_IN_FILE_AREA,
01243                               0x0,
01244                               (ULONG_PTR)ControlArea,
01245                               (ULONG_PTR)PointerPte,
01246                               (ULONG_PTR)PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01247             }
01248 
01249             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
01250 
01251                 <span class="comment">//</span>
01252                 <span class="comment">// This is a normal prototype PTE in mapped file format.</span>
01253                 <span class="comment">//</span>
01254 
01255                 <span class="keywordflow">if</span> (LastWritten != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01256                     WriteNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01257                 }
01258             }
01259             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
01260 
01261                 <span class="comment">//</span>
01262                 <span class="comment">// Prototype PTE in transition, there are 3 possible cases:</span>
01263                 <span class="comment">//  1. The page is part of an image which is sharable and</span>
01264                 <span class="comment">//     refers to the paging file - dereference page file</span>
01265                 <span class="comment">//     space and free the physical page.</span>
01266                 <span class="comment">//  2. The page refers to the segment but is not modified -</span>
01267                 <span class="comment">//     free the physical page.</span>
01268                 <span class="comment">//  3. The page refers to the segment and is modified -</span>
01269                 <span class="comment">//     write the page to the file and free the physical page.</span>
01270                 <span class="comment">//</span>
01271 
01272                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
01273 
01274                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0) {
01275                     <span class="keywordflow">if</span> (DelayCount &lt; 20) {
01276 
01277                         <span class="comment">//</span>
01278                         <span class="comment">// There must be an I/O in progress on this</span>
01279                         <span class="comment">// page.  Wait for the I/O operation to complete.</span>
01280                         <span class="comment">//</span>
01281 
01282                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01283 
01284                         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (PLARGE_INTEGER)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
01285 
01286                         DelayCount += 1;
01287 
01288                         <span class="comment">//</span>
01289                         <span class="comment">// Redo the loop, if the delay count is greater than</span>
01290                         <span class="comment">// 20, assume that this thread is deadlocked and</span>
01291                         <span class="comment">// don't purge this page.  The file system can deal</span>
01292                         <span class="comment">// with the write operation in progress.</span>
01293                         <span class="comment">//</span>
01294 
01295                         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01296                         <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerPte);
01297                         <span class="keywordflow">continue</span>;
01298                     }
01299 <span class="preprocessor">#if DBG</span>
01300 <span class="preprocessor"></span>                    <span class="comment">//</span>
01301                     <span class="comment">// The I/O still has not completed, just ignore</span>
01302                     <span class="comment">// the fact that the I/O is in progress and</span>
01303                     <span class="comment">// delete the page.</span>
01304                     <span class="comment">//</span>
01305 
01306                     KdPrint((<span class="stringliteral">"MM:CLEAN - page number %lx has i/o outstanding\n"</span>,
01307                           PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber));
01308 <span class="preprocessor">#endif</span>
01309 <span class="preprocessor"></span>                }
01310 
01311                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) {
01312 
01313                     <span class="comment">//</span>
01314                     <span class="comment">// Paging file reference (case 1).</span>
01315                     <span class="comment">//</span>
01316 
01317                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01318 
01319                     <span class="keywordflow">if</span> (!ImageSection) {
01320 
01321                         <span class="comment">//</span>
01322                         <span class="comment">// This is not an image section, it must be a</span>
01323                         <span class="comment">// page file backed section, therefore decrement</span>
01324                         <span class="comment">// the PFN reference count for the control area.</span>
01325                         <span class="comment">//</span>
01326 
01327                         ControlArea-&gt;NumberOfPfnReferences -= 1;
01328                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;NumberOfPfnReferences &gt;= 0);
01329                     }
01330 <span class="preprocessor">#if DBG</span>
01331 <span class="preprocessor"></span>                    <span class="keywordflow">else</span> {
01332                         <span class="comment">//</span>
01333                         <span class="comment">// This should only happen for images with shared</span>
01334                         <span class="comment">// global subsections.</span>
01335                         <span class="comment">//</span>
01336                     }
01337 <span class="preprocessor">#endif</span>
01338 <span class="preprocessor"></span>
01339                     <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01340 
01341                     <span class="comment">//</span>
01342                     <span class="comment">// Check the reference count for the page, if the                               // reference count is zero and the page is not on the</span>
01343                     <span class="comment">// freelist, move the page to the free list, if the</span>
01344                     <span class="comment">// reference count is not zero, ignore this page.  When</span>
01345                     <span class="comment">// the reference count goes to zero, it will be placed</span>
01346                     <span class="comment">// on the free list.</span>
01347                     <span class="comment">//</span>
01348 
01349                     <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) &amp;&amp;
01350                          (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>)) {
01351 
01352                         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
01353                         <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01354                         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
01355                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents));
01356 
01357                     }
01358                     PointerPte-&gt;u.Long = 0;
01359 
01360                     <span class="comment">//</span>
01361                     <span class="comment">// If a cluster of pages to write has been completed,</span>
01362                     <span class="comment">// set the WriteNow flag.</span>
01363                     <span class="comment">//</span>
01364 
01365                     <span class="keywordflow">if</span> (LastWritten != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01366                         WriteNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01367                     }
01368 
01369                 } <span class="keywordflow">else</span> {
01370 
01371                     <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 0) || (ImageSection)) {
01372 
01373                         <span class="comment">//</span>
01374                         <span class="comment">// Non modified or image file page (case 2).</span>
01375                         <span class="comment">//</span>
01376 
01377                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01378                         ControlArea-&gt;NumberOfPfnReferences -= 1;
01379                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;NumberOfPfnReferences &gt;= 0);
01380 
01381                         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01382 
01383                         <span class="comment">//</span>
01384                         <span class="comment">// Check the reference count for the page, if the</span>
01385                         <span class="comment">// reference count is zero and the page is not on</span>
01386                         <span class="comment">// the freelist, move the page to the free list,</span>
01387                         <span class="comment">// if the reference count is not zero, ignore this</span>
01388                         <span class="comment">// page. When the reference count goes to zero, it</span>
01389                         <span class="comment">// will be placed on the free list.</span>
01390                         <span class="comment">//</span>
01391 
01392                         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) &amp;&amp;
01393                              (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>)) {
01394 
01395                             <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
01396                             <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01397                             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
01398                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents));
01399                         }
01400 
01401                         PointerPte-&gt;u.Long = 0;
01402 
01403                         <span class="comment">//</span>
01404                         <span class="comment">// If a cluster of pages to write has been</span>
01405                         <span class="comment">// completed, set the WriteNow flag.</span>
01406                         <span class="comment">//</span>
01407 
01408                         <span class="keywordflow">if</span> (LastWritten != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01409                             WriteNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01410                         }
01411 
01412                     } <span class="keywordflow">else</span> {
01413 
01414                         <span class="comment">//</span>
01415                         <span class="comment">// Modified page backed by the file (case 3).</span>
01416                         <span class="comment">// Check to see if this is the first page of a</span>
01417                         <span class="comment">// cluster.</span>
01418                         <span class="comment">//</span>
01419 
01420                         <span class="keywordflow">if</span> (LastWritten == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01421                             LastPage = (PPFN_NUMBER)(Mdl + 1);
01422                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a>(&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>) ==
01423                                                                 Subsection);
01424 
01425                             <span class="comment">//</span>
01426                             <span class="comment">// Calculate the offset to read into the file.</span>
01427                             <span class="comment">//  offset = base + ((thispte - basepte) &lt;&lt; PAGE_SHIFT)</span>
01428                             <span class="comment">//</span>
01429 
01430                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image == 0);
01431                             StartingOffset.QuadPart = <a class="code" href="../../d4/d8/mi_8h.html#a952">MiStartingOffset</a>(
01432                                                          Subsection,
01433                                                          Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
01434 
01435                             <a class="code" href="../../d4/d8/mi_8h.html#a235">MI_INITIALIZE_ZERO_MDL</a> (Mdl);
01436                             Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
01437 
01438                             Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o5">StartVa</a> =
01439                                    (PVOID)ULongToPtr(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01440                             Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o1">Size</a> = (CSHORT)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>) +
01441                                        (<span class="keyword">sizeof</span>(PFN_NUMBER) * <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>));
01442                         }
01443 
01444                         LastWritten = PointerPte;
01445                         Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01446 
01447                         <span class="comment">//</span>
01448                         <span class="comment">// If the cluster is now full,</span>
01449                         <span class="comment">// set the write now flag.</span>
01450                         <span class="comment">//</span>
01451 
01452                         <span class="keywordflow">if</span> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> == (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> * <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>)) {
01453                             WriteNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01454                         }
01455 
01456                         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
01457                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 0;
01458 
01459                         <span class="comment">//</span>
01460                         <span class="comment">// Up the reference count for the physical page as</span>
01461                         <span class="comment">// there is I/O in progress.</span>
01462                         <span class="comment">//</span>
01463 
01464                         <a class="code" href="../../d4/d8/mi_8h.html#a187">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a>(Pfn1, 22);
01465                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
01466 
01467                         <span class="comment">//</span>
01468                         <span class="comment">// Clear the modified bit for the page and set the</span>
01469                         <span class="comment">// write in progress bit.</span>
01470                         <span class="comment">//</span>
01471 
01472                         *LastPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents);
01473 
01474                         LastPage += 1;
01475                     }
01476                 }
01477             } <span class="keywordflow">else</span> {
01478 
01479                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a171">IS_PTE_NOT_DEMAND_ZERO</a> (PteContents)) {
01480                     <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (PteContents);
01481                 }
01482                 PointerPte-&gt;u.Long = 0;
01483 
01484                 <span class="comment">//</span>
01485                 <span class="comment">// If a cluster of pages to write has been completed,</span>
01486                 <span class="comment">// set the WriteNow flag.</span>
01487                 <span class="comment">//</span>
01488 
01489                 <span class="keywordflow">if</span> (LastWritten != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01490                     WriteNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01491                 }
01492             }
01493 
01494             <span class="comment">//</span>
01495             <span class="comment">// Write the current cluster if it is complete,</span>
01496             <span class="comment">// full, or the loop is now complete.</span>
01497             <span class="comment">//</span>
01498 
01499             PointerPte += 1;
01500 WriteItOut:
01501             DelayCount = 0;
01502 
01503             <span class="keywordflow">if</span> ((WriteNow) ||
01504                 ((PointerPte == LastPte) &amp;&amp; (LastWritten != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
01505 
01506                 <span class="comment">//</span>
01507                 <span class="comment">// Issue the write request.</span>
01508                 <span class="comment">//</span>
01509     
01510                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01511     
01512                 <span class="keywordflow">if</span> (DirtyDataPagesOk == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01513                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (POOL_CORRUPTION_IN_FILE_AREA,
01514                                   0x1,
01515                                   (ULONG_PTR)ControlArea,
01516                                   (ULONG_PTR)Mdl,
01517                                   (ULONG_PTR)0);
01518                 }
01519     
01520                 WriteNow = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01521     
01522                 <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;IoEvent);
01523     
01524                 <span class="comment">//</span>
01525                 <span class="comment">// Make sure the write does not go past the</span>
01526                 <span class="comment">// end of file. (segment size).</span>
01527                 <span class="comment">//</span>
01528     
01529                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image == 0);
01530     
01531                 TempOffset = <a class="code" href="../../d4/d8/mi_8h.html#a953">MiEndingOffset</a>(Subsection);
01532     
01533                 <span class="keywordflow">if</span> (((UINT64)StartingOffset.QuadPart + Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>) &gt;
01534                              (UINT64)TempOffset.QuadPart) {
01535     
01536                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((ULONG)(TempOffset.QuadPart -
01537                                         StartingOffset.QuadPart) &gt;
01538                              (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>));
01539     
01540                     Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> = (ULONG)(TempOffset.QuadPart -
01541                                             StartingOffset.QuadPart);
01542                 }
01543     
01544 <span class="preprocessor">#if DBG</span>
01545 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a71">MM_DBG_FLUSH_SECTION</a>) {
01546                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:flush page write begun %lx\n"</span>,
01547                             Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>);
01548                 }
01549 <span class="preprocessor">#endif //DBG</span>
01550 <span class="preprocessor"></span>    
01551                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a116">IoSynchronousPageWrite</a> (ControlArea-&gt;FilePointer,
01552                                                  Mdl,
01553                                                  &amp;StartingOffset,
01554                                                  &amp;IoEvent,
01555                                                  &amp;IoStatus );
01556     
01557                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01558     
01559                     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;IoEvent,
01560                                            <a class="code" href="../../d4/d9/ke_8h.html#a407a217">WrPageOut</a>,
01561                                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01562                                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01563                                            (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01564                 }
01565     
01566                 <span class="keywordflow">if</span> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
01567                     <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>, Mdl);
01568                 }
01569     
01570                 Page = (PPFN_NUMBER)(Mdl + 1);
01571     
01572                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01573     
01574                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte) == 0) {
01575     
01576                     <span class="comment">//</span>
01577                     <span class="comment">// The next PTE is not in a different page, make</span>
01578                     <span class="comment">// sure this page did not leave memory when the</span>
01579                     <span class="comment">// I/O was in progress.</span>
01580                     <span class="comment">//</span>
01581     
01582                     <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerPte);
01583                 }
01584     
01585                 <span class="comment">//</span>
01586                 <span class="comment">// I/O complete unlock pages.</span>
01587                 <span class="comment">//</span>
01588                 <span class="comment">// NOTE that the error status is ignored.</span>
01589                 <span class="comment">//</span>
01590     
01591                 <span class="keywordflow">while</span> (Page &lt; LastPage) {
01592 
01593                     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
01594     
01595                     <span class="comment">//</span>
01596                     <span class="comment">// Make sure the page is still transition.</span>
01597                     <span class="comment">//</span>
01598     
01599                     WrittenPte = Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
01600     
01601                     <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a> (Pfn2, 23);
01602                     <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (*Page);
01603     
01604                     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a121">MI_IS_PFN_DELETED</a> (Pfn2)) {
01605     
01606                         <span class="comment">//</span>
01607                         <span class="comment">// Make sure the prototype PTE is</span>
01608                         <span class="comment">// still in the working set.</span>
01609                         <span class="comment">//</span>
01610     
01611                         <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (WrittenPte);
01612     
01613                         <span class="keywordflow">if</span> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> != WrittenPte) {
01614     
01615                             <span class="comment">//</span>
01616                             <span class="comment">// The PFN lock was released to make the</span>
01617                             <span class="comment">// page table page valid, and while it</span>
01618                             <span class="comment">// was released, the physical page</span>
01619                             <span class="comment">// was reused.  Go onto the next one.</span>
01620                             <span class="comment">//</span>
01621     
01622                             Page += 1;
01623                             <span class="keywordflow">continue</span>;
01624                         }
01625     
01626                         WrittenContents = *WrittenPte;
01627     
01628                         <span class="keywordflow">if</span> ((WrittenContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
01629                              (WrittenContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
01630     
01631                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn2);
01632                             ControlArea-&gt;NumberOfPfnReferences -= 1;
01633                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;NumberOfPfnReferences &gt;= 0);
01634     
01635                             <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01636     
01637                             <span class="comment">//</span>
01638                             <span class="comment">// Check the reference count for the page,</span>
01639                             <span class="comment">// if the reference count is zero and the</span>
01640                             <span class="comment">// page is not on the freelist, move the page</span>
01641                             <span class="comment">// to the free list, if the reference</span>
01642                             <span class="comment">// count is not zero, ignore this page.</span>
01643                             <span class="comment">// When the reference count goes to zero,</span>
01644                             <span class="comment">// it will be placed on the free list.</span>
01645                             <span class="comment">//</span>
01646     
01647                             <span class="keywordflow">if</span> ((Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) &amp;&amp;
01648                                (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>)) {
01649     
01650                                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn2);
01651                                 <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01652                                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (
01653                                     <a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
01654                                     *Page);
01655                             }
01656                         }
01657                         WrittenPte-&gt;u.Long = 0;
01658                     }
01659                     Page += 1;
01660                 }
01661     
01662                 <span class="comment">//</span>
01663                 <span class="comment">// Indicate that there is no current cluster being built.</span>
01664                 <span class="comment">//</span>
01665     
01666                 LastWritten = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01667             }
01668     
01669         } <span class="comment">// end while</span>
01670     
01671         <span class="comment">//</span>
01672         <span class="comment">// Get the next subsection if any.</span>
01673         <span class="comment">//</span>
01674     
01675         <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> == (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01676             <span class="keywordflow">break</span>;
01677         }
01678 
01679         Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
01680         PointerPte = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>;
01681         LastPte = PointerPte + Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
01682 
01683     } <span class="comment">// end for</span>
01684 
01685     ControlArea-&gt;NumberOfMappedViews = 0;
01686 
01687     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;NumberOfPfnReferences == 0);
01688 
01689     <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.FilePointerNull == 0) {
01690         ControlArea-&gt;u.Flags.FilePointerNull = 1;
01691 
01692         <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.Image) {
01693 
01694             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01695                 <a class="code" href="../../d4/d8/mi_8h.html#a914">MiRemoveImageSectionObject</a> (ControlArea-&gt;FilePointer,
01696                                             ControlArea);
01697             }
01698             <span class="keywordflow">else</span> {
01699                 ControlArea-&gt;FilePointer-&gt;SectionObjectPointer-&gt;ImageSectionObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01700             }
01701         }
01702         <span class="keywordflow">else</span> {
01703 
01704             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(ControlArea-&gt;FilePointer-&gt;SectionObjectPointer-&gt;DataSectionObject)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01705             ControlArea-&gt;FilePointer-&gt;SectionObjectPointer-&gt;DataSectionObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01706 
01707         }
01708     }
01709     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01710 
01711     <span class="comment">//</span>
01712     <span class="comment">// Delete the segment structure.</span>
01713     <span class="comment">//</span>
01714 
01715     <a class="code" href="../../d5/d5/sectsup_8c.html#a17">MiSegmentDelete</a> (ControlArea-&gt;Segment);
01716 
01717     <span class="keywordflow">return</span>;
01718 }
01719 
01720 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01721"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a23">01721</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a23">MmGetFileNameForSection</a> (
01722     IN HANDLE Section,
01723     OUT PSTRING FileName
01724     )
01725 
01726 <span class="comment">/*++</span>
01727 <span class="comment"></span>
01728 <span class="comment">Routine Description:</span>
01729 <span class="comment"></span>
01730 <span class="comment">    This function returns the file name for the corresponding section.</span>
01731 <span class="comment"></span>
01732 <span class="comment">Arguments:</span>
01733 <span class="comment"></span>
01734 <span class="comment">    Section - Supplies the handle of the section to get the name of.</span>
01735 <span class="comment"></span>
01736 <span class="comment">    FileName - Returns the name of the corresponding section.</span>
01737 <span class="comment"></span>
01738 <span class="comment">Return Value:</span>
01739 <span class="comment"></span>
01740 <span class="comment">    TBS</span>
01741 <span class="comment"></span>
01742 <span class="comment">Environment:</span>
01743 <span class="comment"></span>
01744 <span class="comment">    Kernel mode, APC_LEVEL or below, no mutexes held.</span>
01745 <span class="comment"></span>
01746 <span class="comment">--*/</span>
01747 
01748 {
01749 
01750     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> SectionObject;
01751     POBJECT_NAME_INFORMATION FileNameInfo;
01752     ULONG whocares;
01753     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01754     ULONG Dereference;
01755 
01756     Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01757 
01758 <span class="preprocessor">#define xMAX_NAME 1024</span>
01759 <span class="preprocessor"></span>
01760     <span class="keywordflow">if</span> ( (ULONG_PTR)Section &amp; 1 ) {
01761         SectionObject = (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)((ULONG_PTR)Section &amp; ~1);
01762         Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01763     } <span class="keywordflow">else</span> {
01764         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( Section,
01765                                              0,
01766                                              <a class="code" href="../../d2/d1/mm_8h.html#a133">MmSectionObjectType</a>,
01767                                              <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01768                                              (PVOID *)&amp;SectionObject,
01769                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01770 
01771         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01772             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01773         }
01774     }
01775 
01776     <span class="keywordflow">if</span> (SectionObject-&gt;u.Flags.Image == 0) {
01777         <span class="keywordflow">if</span> ( Dereference )
01778             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SectionObject);
01779         <span class="keywordflow">return</span> STATUS_SECTION_NOT_IMAGE;
01780     }
01781 
01782     FileNameInfo = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d5/d5/sectsup_8c.html#a0">xMAX_NAME</a>, '  mM');
01783 
01784     <span class="keywordflow">if</span> ( !FileNameInfo ) {
01785         <span class="keywordflow">if</span> ( Dereference )
01786             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SectionObject);
01787         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01788     }
01789 
01790     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>(
01791                 SectionObject-&gt;Segment-&gt;ControlArea-&gt;FilePointer,
01792                 FileNameInfo,
01793                 <a class="code" href="../../d5/d5/sectsup_8c.html#a0">xMAX_NAME</a>,
01794                 &amp;whocares
01795                 );
01796 
01797     <span class="keywordflow">if</span> ( Dereference )
01798         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SectionObject);
01799 
01800     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01801         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(FileNameInfo);
01802         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01803     }
01804 
01805     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length = 0;
01806     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength = (FileNameInfo-&gt;Name.Length/<span class="keyword">sizeof</span>(WCHAR)) + 1;
01807     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01808                                               <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength,
01809                                               '  mM');
01810     <span class="keywordflow">if</span> ( !<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer ) {
01811         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(FileNameInfo);
01812         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01813     }
01814     <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>((PANSI_STRING)<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,&amp;FileNameInfo-&gt;Name,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01815     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length] = <span class="charliteral">'\0'</span>;
01816     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(FileNameInfo);
01817 
01818     <span class="keywordflow">return</span> STATUS_SUCCESS;
01819 }
01820 
01821 
01822 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01823"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a24">01823</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (
01824     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea,
01825     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess,
01826     IN KIRQL PreviousIrql
01827     )
01828 
01829 <span class="comment">/*++</span>
01830 <span class="comment"></span>
01831 <span class="comment">Routine Description:</span>
01832 <span class="comment"></span>
01833 <span class="comment">    This routine checks the reference counts for the specified</span>
01834 <span class="comment">    control area, and if the counts are all zero, it marks the</span>
01835 <span class="comment">    control area for deletion and queues it to the deletion thread.</span>
01836 <span class="comment"></span>
01837 <span class="comment"></span>
01838 <span class="comment">    *********************** NOTE ********************************</span>
01839 <span class="comment">    This routine returns with the PFN LOCK RELEASED!!!!!</span>
01840 <span class="comment"></span>
01841 <span class="comment">Arguments:</span>
01842 <span class="comment"></span>
01843 <span class="comment">    ControlArea - Supplies a pointer to the control area to check.</span>
01844 <span class="comment"></span>
01845 <span class="comment">    CurrentProcess - Supplies a pointer to the current process if and ONLY</span>
01846 <span class="comment">                     IF the working set lock is held.</span>
01847 <span class="comment"></span>
01848 <span class="comment">    PreviousIrql - Supplies the previous IRQL.</span>
01849 <span class="comment"></span>
01850 <span class="comment">Return Value:</span>
01851 <span class="comment"></span>
01852 <span class="comment">    NONE.</span>
01853 <span class="comment"></span>
01854 <span class="comment">Environment:</span>
01855 <span class="comment"></span>
01856 <span class="comment">    Kernel mode, PFN lock held, PFN lock released upon return!!!</span>
01857 <span class="comment"></span>
01858 <span class="comment">--*/</span>
01859 
01860 {
01861     <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">PEVENT_COUNTER</a> PurgeEvent;
01862     ULONG DeleteOnClose;
01863     ULONG DereferenceSegment;
01864 
01865     PurgeEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01866     DeleteOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01867     DereferenceSegment = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01868 
01869     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
01870     <span class="keywordflow">if</span> ((ControlArea-&gt;NumberOfMappedViews == 0) &amp;&amp;
01871          (ControlArea-&gt;NumberOfSectionReferences == 0)) {
01872 
01873         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;NumberOfUserReferences == 0);
01874 
01875         <span class="keywordflow">if</span> (ControlArea-&gt;FilePointer != (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01876 
01877             <span class="keywordflow">if</span> (ControlArea-&gt;NumberOfPfnReferences == 0) {
01878 
01879                 <span class="comment">//</span>
01880                 <span class="comment">// There are no views and no physical pages referenced</span>
01881                 <span class="comment">// by the Segment, dereference the Segment object.</span>
01882                 <span class="comment">//</span>
01883 
01884                 ControlArea-&gt;u.Flags.BeingDeleted = 1;
01885                 DereferenceSegment = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01886 
01887                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;u.Flags.FilePointerNull == 0);
01888                 ControlArea-&gt;u.Flags.FilePointerNull = 1;
01889 
01890                 <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.Image) {
01891 
01892                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01893                         <a class="code" href="../../d4/d8/mi_8h.html#a914">MiRemoveImageSectionObject</a> (ControlArea-&gt;FilePointer, ControlArea);
01894                     }
01895                     <span class="keywordflow">else</span> {
01896                         ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(ControlArea-&gt;FilePointer-&gt;SectionObjectPointer-&gt;ImageSectionObject)) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01897                     }
01898 
01899                 }
01900                 <span class="keywordflow">else</span> {
01901 
01902                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(ControlArea-&gt;FilePointer-&gt;SectionObjectPointer-&gt;DataSectionObject)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01903                     ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(ControlArea-&gt;FilePointer-&gt;SectionObjectPointer-&gt;DataSectionObject)) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01904 
01905                 }
01906             } <span class="keywordflow">else</span> {
01907 
01908                 <span class="comment">//</span>
01909                 <span class="comment">// Insert this segment into the unused segment list (unless</span>
01910                 <span class="comment">// it is already on the list).</span>
01911                 <span class="comment">//</span>
01912 
01913                 <span class="keywordflow">if</span> (ControlArea-&gt;DereferenceList.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01914                     InsertTailList ( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a698">MmUnusedSegmentList</a>,
01915                                      &amp;ControlArea-&gt;DereferenceList);
01916                     <a class="code" href="../../d4/d8/mi_8h.html#a329">MI_UNUSED_SEGMENTS_INSERT_CHARGE</a> (ControlArea);
01917                 }
01918 
01919                 <span class="comment">//</span>
01920                 <span class="comment">// Indicate if this section should be deleted now that</span>
01921                 <span class="comment">// the reference counts are zero.</span>
01922                 <span class="comment">//</span>
01923 
01924                 DeleteOnClose = ControlArea-&gt;u.Flags.DeleteOnClose;
01925 
01926                 <span class="comment">//</span>
01927                 <span class="comment">// The number of mapped views are zero, the number of</span>
01928                 <span class="comment">// section references are zero, but there are some</span>
01929                 <span class="comment">// pages of the file still resident.  If this is</span>
01930                 <span class="comment">// an image with Global Memory, "purge" the subsections</span>
01931                 <span class="comment">// which contain the global memory and reset them to</span>
01932                 <span class="comment">// point back to the file.</span>
01933                 <span class="comment">//</span>
01934 
01935                 <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.GlobalMemory == 1) {
01936                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;u.Flags.Image == 1);
01937 
01938                     ControlArea-&gt;u.Flags.BeingPurged = 1;
01939                     ControlArea-&gt;NumberOfMappedViews = 1;
01940 
01941                     <a class="code" href="../../d4/d9/umapview_8c.html#a3">MiPurgeImageSection</a> (ControlArea, CurrentProcess);
01942 
01943                     ControlArea-&gt;u.Flags.BeingPurged = 0;
01944                     ControlArea-&gt;NumberOfMappedViews -= 1;
01945                     <span class="keywordflow">if</span> ((ControlArea-&gt;NumberOfMappedViews == 0) &amp;&amp;
01946                         (ControlArea-&gt;NumberOfSectionReferences == 0) &amp;&amp;
01947                         (ControlArea-&gt;NumberOfPfnReferences == 0)) {
01948 
01949                         ControlArea-&gt;u.Flags.BeingDeleted = 1;
01950                         DereferenceSegment = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01951                         ControlArea-&gt;u.Flags.FilePointerNull = 1;
01952 
01953                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01954                             <a class="code" href="../../d4/d8/mi_8h.html#a914">MiRemoveImageSectionObject</a> (ControlArea-&gt;FilePointer, ControlArea);
01955                         }
01956                         <span class="keywordflow">else</span> {
01957                             ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(ControlArea-&gt;FilePointer-&gt;SectionObjectPointer-&gt;ImageSectionObject)) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01958                         }
01959 
01960                     } <span class="keywordflow">else</span> {
01961 
01962                         PurgeEvent = ControlArea-&gt;WaitingForDeletion;
01963                         ControlArea-&gt;WaitingForDeletion = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01964                     }
01965                 }
01966 
01967                 <span class="comment">//</span>
01968                 <span class="comment">// If delete on close is set and the segment was</span>
01969                 <span class="comment">// not deleted, up the count of mapped views so the</span>
01970                 <span class="comment">// control area will not be deleted when the PFN lock</span>
01971                 <span class="comment">// is released.</span>
01972                 <span class="comment">//</span>
01973 
01974                 <span class="keywordflow">if</span> (DeleteOnClose &amp;&amp; !DereferenceSegment) {
01975                     ControlArea-&gt;NumberOfMappedViews = 1;
01976                     ControlArea-&gt;u.Flags.BeingDeleted = 1;
01977                 }
01978             }
01979 
01980         } <span class="keywordflow">else</span> {
01981 
01982             <span class="comment">//</span>
01983             <span class="comment">// This Segment is backed by a paging file, dereference the</span>
01984             <span class="comment">// Segment object when the number of views goes from 1 to 0</span>
01985             <span class="comment">// without regard to the number of PFN references.</span>
01986             <span class="comment">//</span>
01987 
01988             ControlArea-&gt;u.Flags.BeingDeleted = 1;
01989             DereferenceSegment = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01990         }
01991     }
01992     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ControlArea-&gt;WaitingForDeletion != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01993         PurgeEvent = ControlArea-&gt;WaitingForDeletion;
01994         ControlArea-&gt;WaitingForDeletion = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01995     }
01996 
01997     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (PreviousIrql);
01998 
01999     <span class="keywordflow">if</span> (DereferenceSegment || DeleteOnClose) {
02000 
02001         <span class="comment">//</span>
02002         <span class="comment">// Release the working set mutex, if it is held as the object</span>
02003         <span class="comment">// management routines may page fault, etc..</span>
02004         <span class="comment">//</span>
02005 
02006         <span class="keywordflow">if</span> (CurrentProcess) {
02007             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (CurrentProcess);
02008         }
02009 
02010         <span class="keywordflow">if</span> (DereferenceSegment) {
02011 
02012             <span class="comment">//</span>
02013             <span class="comment">// Delete the segment.</span>
02014             <span class="comment">//</span>
02015 
02016             <a class="code" href="../../d5/d5/sectsup_8c.html#a17">MiSegmentDelete</a> (ControlArea-&gt;Segment);
02017 
02018         } <span class="keywordflow">else</span> {
02019 
02020             <span class="comment">//</span>
02021             <span class="comment">// The segment should be forced closed now.</span>
02022             <span class="comment">//</span>
02023 
02024             <a class="code" href="../../d5/d5/sectsup_8c.html#a22">MiCleanSection</a> (ControlArea, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02025         }
02026 
02027         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PurgeEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02028 
02029         <span class="comment">//</span>
02030         <span class="comment">// Reacquire the working set lock, if a process was specified.</span>
02031         <span class="comment">//</span>
02032 
02033         <span class="keywordflow">if</span> (CurrentProcess) {
02034             <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (CurrentProcess);
02035         }
02036 
02037     } <span class="keywordflow">else</span> {
02038 
02039         <span class="comment">//</span>
02040         <span class="comment">// If any threads are waiting for the segment, indicate the</span>
02041         <span class="comment">// the purge operation has completed.</span>
02042         <span class="comment">//</span>
02043 
02044         <span class="keywordflow">if</span> (PurgeEvent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02045             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;PurgeEvent-&gt;<a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html#o1">Event</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02046         }
02047 
02048         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a701">MmUnusedSegmentPagedPoolUsage</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a700">MmMaxUnusedSegmentPagedPoolUsage</a> ||
02049             <a class="code" href="../../d4/d8/mi_8h.html#a705">MmUnusedSegmentNonPagedPoolUsage</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a704">MmMaxUnusedSegmentNonPagedPoolUsage</a>) {
02050             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a699">MmUnusedSegmentCleanup</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02051         }
02052     }
02053 
02054     <span class="keywordflow">return</span>;
02055 }
02056 
02057 
02058 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02059"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a25">02059</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a25">MiCheckForControlAreaDeletion</a> (
02060     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea
02061     )
02062 
02063 <span class="comment">/*++</span>
02064 <span class="comment"></span>
02065 <span class="comment">Routine Description:</span>
02066 <span class="comment"></span>
02067 <span class="comment">    This routine checks the reference counts for the specified</span>
02068 <span class="comment">    control area, and if the counts are all zero, it marks the</span>
02069 <span class="comment">    control area for deletion and queues it to the deletion thread.</span>
02070 <span class="comment"></span>
02071 <span class="comment">Arguments:</span>
02072 <span class="comment"></span>
02073 <span class="comment">    ControlArea - Supplies a pointer to the control area to check.</span>
02074 <span class="comment"></span>
02075 <span class="comment">Return Value:</span>
02076 <span class="comment"></span>
02077 <span class="comment">    None.</span>
02078 <span class="comment"></span>
02079 <span class="comment">Environment:</span>
02080 <span class="comment"></span>
02081 <span class="comment">    Kernel mode, PFN lock held.</span>
02082 <span class="comment"></span>
02083 <span class="comment">--*/</span>
02084 
02085 {
02086     KIRQL OldIrql;
02087 
02088     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
02089     <span class="keywordflow">if</span> ((ControlArea-&gt;NumberOfPfnReferences == 0) &amp;&amp;
02090         (ControlArea-&gt;NumberOfMappedViews == 0) &amp;&amp;
02091         (ControlArea-&gt;NumberOfSectionReferences == 0 )) {
02092 
02093         <span class="comment">//</span>
02094         <span class="comment">// This segment is no longer mapped in any address space</span>
02095         <span class="comment">// nor are there any prototype PTEs within the segment</span>
02096         <span class="comment">// which are valid or in a transition state.  Queue</span>
02097         <span class="comment">// the segment to the segment-dereferencer thread</span>
02098         <span class="comment">// which will dereference the segment object, potentially</span>
02099         <span class="comment">// causing the segment to be deleted.</span>
02100         <span class="comment">//</span>
02101 
02102         ControlArea-&gt;u.Flags.BeingDeleted = 1;
02103         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;u.Flags.FilePointerNull == 0);
02104         ControlArea-&gt;u.Flags.FilePointerNull = 1;
02105 
02106         <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.Image) {
02107 
02108             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02109                 <a class="code" href="../../d4/d8/mi_8h.html#a914">MiRemoveImageSectionObject</a> (ControlArea-&gt;FilePointer,
02110                                             ControlArea);
02111             }
02112             <span class="keywordflow">else</span> {
02113                 ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(ControlArea-&gt;FilePointer-&gt;SectionObjectPointer-&gt;ImageSectionObject)) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02114             }
02115 
02116         }
02117         <span class="keywordflow">else</span> {
02118             ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(ControlArea-&gt;FilePointer-&gt;SectionObjectPointer-&gt;DataSectionObject)) =
02119                                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02120         }
02121 
02122         ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, &amp;OldIrql);
02123 
02124         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;DereferenceList.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02125 
02126         <span class="comment">//</span>
02127         <span class="comment">// Remove the entry from the unused segment list and put it</span>
02128         <span class="comment">// on the dereference list.</span>
02129         <span class="comment">//</span>
02130 
02131         RemoveEntryList (&amp;ControlArea-&gt;DereferenceList);
02132 
02133         <a class="code" href="../../d4/d8/mi_8h.html#a330">MI_UNUSED_SEGMENTS_REMOVE_CHARGE</a> (ControlArea);
02134 
02135         InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>,
02136                         &amp;ControlArea-&gt;DereferenceList);
02137         ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
02138 
02139         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o1">Semaphore</a>,
02140                             0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
02141                             1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
02142                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02143     }
02144     <span class="keywordflow">return</span>;
02145 }
02146 
02147 
02148 BOOLEAN
<a name="l02149"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a26">02149</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a26">MiCheckControlAreaStatus</a> (
02150     IN SECTION_CHECK_TYPE SectionCheckType,
02151     IN <a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionObjectPointers,
02152     IN ULONG DelayClose,
02153     OUT <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> *ControlAreaOut,
02154     OUT PKIRQL PreviousIrql
02155     )
02156 
02157 <span class="comment">/*++</span>
02158 <span class="comment"></span>
02159 <span class="comment">Routine Description:</span>
02160 <span class="comment"></span>
02161 <span class="comment">    This routine checks the status of the control area for the specified</span>
02162 <span class="comment">    SectionObjectPointers.  If the control area is in use, that is, the</span>
02163 <span class="comment">    number of section references and the number of mapped views are not</span>
02164 <span class="comment">    both zero, no action is taken and the function returns FALSE.</span>
02165 <span class="comment"></span>
02166 <span class="comment">    If there is no control area associated with the specified</span>
02167 <span class="comment">    SectionObjectPointers or the control area is in the process of being</span>
02168 <span class="comment">    created or deleted, no action is taken and the value TRUE is returned.</span>
02169 <span class="comment"></span>
02170 <span class="comment">    If, there are no section objects and the control area is not being</span>
02171 <span class="comment">    created or deleted, the address of the control area is returned</span>
02172 <span class="comment">    in the ControlArea argument, the address of a pool block to free</span>
02173 <span class="comment">    is returned in the SegmentEventOut argument and the PFN_LOCK is</span>
02174 <span class="comment">    still held at the return.</span>
02175 <span class="comment"></span>
02176 <span class="comment">Arguments:</span>
02177 <span class="comment"></span>
02178 <span class="comment">    *SegmentEventOut - Returns a pointer to NonPaged Pool which much be</span>
02179 <span class="comment">                       freed by the caller when the PFN_LOCK is released.</span>
02180 <span class="comment">                       This value is NULL if no pool is allocated and the</span>
02181 <span class="comment">                       PFN_LOCK is not held.</span>
02182 <span class="comment"></span>
02183 <span class="comment">    SectionCheckType - Supplies the type of section to check on, one of</span>
02184 <span class="comment">                      CheckImageSection, CheckDataSection, CheckBothSection.</span>
02185 <span class="comment"></span>
02186 <span class="comment">    SectionObjectPointers - Supplies the section object pointers through</span>
02187 <span class="comment">                            which the control area can be located.</span>
02188 <span class="comment"></span>
02189 <span class="comment">    DelayClose - Supplies a boolean which if TRUE and the control area</span>
02190 <span class="comment">                 is being used, the delay on close field should be set</span>
02191 <span class="comment">                 in the control area.</span>
02192 <span class="comment"></span>
02193 <span class="comment">    *ControlAreaOut - Returns the address of the control area.</span>
02194 <span class="comment"></span>
02195 <span class="comment">    PreviousIrql - Returns, in the case the PFN_LOCK is held, the previous</span>
02196 <span class="comment">                   IRQL so the lock can be released properly.</span>
02197 <span class="comment"></span>
02198 <span class="comment">Return Value:</span>
02199 <span class="comment"></span>
02200 <span class="comment">    FALSE if the control area is in use, TRUE if the control area is gone or</span>
02201 <span class="comment">    in the process or being created or deleted.</span>
02202 <span class="comment"></span>
02203 <span class="comment">Environment:</span>
02204 <span class="comment"></span>
02205 <span class="comment">    Kernel mode, PFN lock NOT held.</span>
02206 <span class="comment"></span>
02207 <span class="comment">--*/</span>
02208 
02209 
02210 {
02211     <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">PEVENT_COUNTER</a> IoEvent;
02212     <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">PEVENT_COUNTER</a> SegmentEvent;
02213     ULONG DeallocateSegmentEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02214     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
02215     ULONG SectRef;
02216     KIRQL OldIrql;
02217 
02218     <span class="comment">//</span>
02219     <span class="comment">// Allocate an event to wait on in case the segment is in the</span>
02220     <span class="comment">// process of being deleted.  This event cannot be allocated</span>
02221     <span class="comment">// with the PFN database locked as pool expansion would deadlock.</span>
02222     <span class="comment">//</span>
02223 
02224     *ControlAreaOut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02225 
02226     <span class="comment">//</span>
02227     <span class="comment">// Acquire the PFN lock and examine the section object pointer</span>
02228     <span class="comment">// value within the file object.</span>
02229     <span class="comment">//</span>
02230 
02231     <span class="comment">//</span>
02232     <span class="comment">// File control blocks live in non-paged pool.</span>
02233     <span class="comment">//</span>
02234 
02235     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02236 
02237     SegmentEvent = <a class="code" href="../../d4/d8/mi_8h.html#a931">MiGetEventCounter</a> ();
02238 
02239     <span class="keywordflow">while</span> (SegmentEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02240         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02241         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (PLARGE_INTEGER)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
02242         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02243         SegmentEvent = <a class="code" href="../../d4/d8/mi_8h.html#a931">MiGetEventCounter</a> ();
02244     }
02245 
02246     <span class="keywordflow">if</span> (SectionCheckType != <a class="code" href="../../d4/d8/mi_8h.html#a1002a766">CheckImageSection</a>) {
02247         ControlArea = ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(SectionObjectPointers-&gt;DataSectionObject));
02248     } <span class="keywordflow">else</span> {
02249         ControlArea = ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(SectionObjectPointers-&gt;ImageSectionObject));
02250     }
02251 
02252     <span class="keywordflow">if</span> (ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02253 
02254         <span class="keywordflow">if</span> (SectionCheckType != <a class="code" href="../../d4/d8/mi_8h.html#a1002a768">CheckBothSection</a>) {
02255 
02256             <span class="comment">//</span>
02257             <span class="comment">// This file no longer has an associated segment.</span>
02258             <span class="comment">//</span>
02259 
02260             <a class="code" href="../../d5/d5/sectsup_8c.html#a28">MiFreeEventCounter</a> (SegmentEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02261             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02262             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02263         } <span class="keywordflow">else</span> {
02264             ControlArea = ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(SectionObjectPointers-&gt;ImageSectionObject));
02265             <span class="keywordflow">if</span> (ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02266 
02267                 <span class="comment">//</span>
02268                 <span class="comment">// This file no longer has an associated segment.</span>
02269                 <span class="comment">//</span>
02270 
02271                 <a class="code" href="../../d5/d5/sectsup_8c.html#a28">MiFreeEventCounter</a> (SegmentEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02272                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02273                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02274             }
02275         }
02276     }
02277 
02278     <span class="comment">//</span>
02279     <span class="comment">//  Depending on the type of section, check for the pertinent</span>
02280     <span class="comment">//  reference count being non-zero.</span>
02281     <span class="comment">//</span>
02282 
02283     <span class="keywordflow">if</span> (SectionCheckType != <a class="code" href="../../d4/d8/mi_8h.html#a1002a767">CheckUserDataSection</a>) {
02284         SectRef = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a>;
02285     } <span class="keywordflow">else</span> {
02286         SectRef = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a>;
02287     }
02288 
02289     <span class="keywordflow">if</span> ((SectRef != 0) ||
02290         (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> != 0) ||
02291         (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated)) {
02292 
02293 
02294         <span class="comment">//</span>
02295         <span class="comment">// The segment is currently in use or being created.</span>
02296         <span class="comment">//</span>
02297 
02298         <span class="keywordflow">if</span> (DelayClose) {
02299 
02300             <span class="comment">//</span>
02301             <span class="comment">// The section should be deleted when the reference</span>
02302             <span class="comment">// counts are zero, set the delete on close flag.</span>
02303             <span class="comment">//</span>
02304 
02305             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.DeleteOnClose = 1;
02306         }
02307 
02308         <a class="code" href="../../d5/d5/sectsup_8c.html#a28">MiFreeEventCounter</a> (SegmentEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02309         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02310         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02311     }
02312 
02313     <span class="comment">//</span>
02314     <span class="comment">// The segment has no references, delete it.  If the segment</span>
02315     <span class="comment">// is already being deleted, set the event field in the control</span>
02316     <span class="comment">// area and wait on the event.</span>
02317     <span class="comment">//</span>
02318 
02319     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted) {
02320 
02321         <span class="comment">//</span>
02322         <span class="comment">// The segment object is in the process of being deleted.</span>
02323         <span class="comment">// Check to see if another thread is waiting for the deletion,</span>
02324         <span class="comment">// otherwise create and event object to wait upon.</span>
02325         <span class="comment">//</span>
02326 
02327         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o12">WaitingForDeletion</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02328 
02329             <span class="comment">//</span>
02330             <span class="comment">// Create an event and put its address in the control area.</span>
02331             <span class="comment">//</span>
02332 
02333             DeallocateSegmentEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02334             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o12">WaitingForDeletion</a> = SegmentEvent;
02335             IoEvent = SegmentEvent;
02336         } <span class="keywordflow">else</span> {
02337             IoEvent = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o12">WaitingForDeletion</a>;
02338             IoEvent-&gt;<a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html#o0">RefCount</a> += 1;
02339         }
02340 
02341         <span class="comment">//</span>
02342         <span class="comment">// Release the mutex and wait for the event.</span>
02343         <span class="comment">//</span>
02344 
02345         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02346         <a class="code" href="../../d4/d8/mi_8h.html#a132">UNLOCK_PFN_AND_THEN_WAIT</a>(OldIrql);
02347 
02348         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;IoEvent-&gt;<a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html#o1">Event</a>,
02349                               <a class="code" href="../../d4/d9/ke_8h.html#a407a217">WrPageOut</a>,
02350                               <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02351                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02352                               (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02353 
02354         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02355         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02356 
02357         <a class="code" href="../../d5/d5/sectsup_8c.html#a28">MiFreeEventCounter</a> (IoEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02358         <span class="keywordflow">if</span> (DeallocateSegmentEvent) {
02359             <a class="code" href="../../d5/d5/sectsup_8c.html#a28">MiFreeEventCounter</a> (SegmentEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02360         }
02361         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02362         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02363     }
02364 
02365     <span class="comment">//</span>
02366     <span class="comment">// Return with the PFN database locked.</span>
02367     <span class="comment">//</span>
02368 
02369     <a class="code" href="../../d5/d5/sectsup_8c.html#a28">MiFreeEventCounter</a> (SegmentEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02370     *ControlAreaOut = ControlArea;
02371     *PreviousIrql = OldIrql;
02372     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02373 }
02374 
02375 
02376 <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">PEVENT_COUNTER</a>
<a name="l02377"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a27">02377</a> <a class="code" href="../../d4/d8/mi_8h.html#a931">MiGetEventCounter</a> (
02378     )
02379 
02380 <span class="comment">/*++</span>
02381 <span class="comment"></span>
02382 <span class="comment">Routine Description:</span>
02383 <span class="comment"></span>
02384 <span class="comment">    This function maintains a list of "events" to allow waiting</span>
02385 <span class="comment">    on segment operations (deletion, creation, purging).</span>
02386 <span class="comment"></span>
02387 <span class="comment">Arguments:</span>
02388 <span class="comment"></span>
02389 <span class="comment">    None.</span>
02390 <span class="comment"></span>
02391 <span class="comment">Return Value:</span>
02392 <span class="comment"></span>
02393 <span class="comment">    Event to be used for waiting (stored into the control area) or NULL if</span>
02394 <span class="comment">    no event could be allocated.</span>
02395 <span class="comment"></span>
02396 <span class="comment">Environment:</span>
02397 <span class="comment"></span>
02398 <span class="comment">    Kernel mode, PFN lock held.</span>
02399 <span class="comment"></span>
02400 <span class="comment">--*/</span>
02401 
02402 {
02403     KIRQL OldIrql;
02404     <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">PEVENT_COUNTER</a> Support;
02405     PLIST_ENTRY NextEntry;
02406 
02407     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
02408 
02409     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/mminit_8c.html#a7">MmEventCountList</a>.<a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html#o1">Count</a> == 0) {
02410         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (IsListEmpty(&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a7">MmEventCountList</a>.<a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html#o0">ListHead</a>));
02411         OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
02412         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02413         Support = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02414                                          <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">EVENT_COUNTER</a>),
02415                                          'xEmM');
02416         <span class="keywordflow">if</span> (Support == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02417             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02418             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02419         }
02420         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;Support-&gt;<a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html#o1">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02421         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02422     } <span class="keywordflow">else</span> {
02423         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!IsListEmpty(&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a7">MmEventCountList</a>.<a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html#o0">ListHead</a>));
02424         <a class="code" href="../../d5/d1/mminit_8c.html#a7">MmEventCountList</a>.<a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html#o1">Count</a> -= 1;
02425         NextEntry = RemoveHeadList (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a7">MmEventCountList</a>.<a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html#o0">ListHead</a>);
02426         Support = CONTAINING_RECORD (NextEntry,
02427                                      <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">EVENT_COUNTER</a>,
02428                                      ListEntry );
02429         <span class="comment">//ASSERT (Support-&gt;RefCount == 0);</span>
02430         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;Support-&gt;<a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html#o1">Event</a>);
02431     }
02432     Support-&gt;<a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html#o0">RefCount</a> = 1;
02433     Support-&gt;<a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html#o2">ListEntry</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02434     <span class="keywordflow">return</span> Support;
02435 }
02436 
02437 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02438"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a28">02438</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a28">MiFreeEventCounter</a> (
02439     IN <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">PEVENT_COUNTER</a> Support,
02440     IN ULONG Flush
02441     )
02442 
02443 <span class="comment">/*++</span>
02444 <span class="comment"></span>
02445 <span class="comment">Routine Description:</span>
02446 <span class="comment"></span>
02447 <span class="comment">    This routine frees an event counter back to the free list.</span>
02448 <span class="comment"></span>
02449 <span class="comment">Arguments:</span>
02450 <span class="comment"></span>
02451 <span class="comment">    Support - Supplies a pointer to the event counter.</span>
02452 <span class="comment"></span>
02453 <span class="comment">    Flush - Supplies TRUE if the PFN lock can be released and the event</span>
02454 <span class="comment">            counter pool block actually freed.  The PFN lock will be</span>
02455 <span class="comment">            reacquired before returning.</span>
02456 <span class="comment"></span>
02457 <span class="comment">Return Value:</span>
02458 <span class="comment"></span>
02459 <span class="comment">    None.</span>
02460 <span class="comment"></span>
02461 <span class="comment">Environment:</span>
02462 <span class="comment"></span>
02463 <span class="comment">    Kernel mode, PFN lock held.</span>
02464 <span class="comment"></span>
02465 <span class="comment">--*/</span>
02466 
02467 {
02468 
02469     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
02470 
02471     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Support-&gt;RefCount != 0);
02472     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Support-&gt;ListEntry.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02473     Support-&gt;RefCount -= 1;
02474     <span class="keywordflow">if</span> (Support-&gt;RefCount == 0) {
02475         InsertTailList (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a7">MmEventCountList</a>.<a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html#o0">ListHead</a>,
02476                         &amp;Support-&gt;ListEntry);
02477         <a class="code" href="../../d5/d1/mminit_8c.html#a7">MmEventCountList</a>.<a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html#o1">Count</a> += 1;
02478     }
02479     <span class="keywordflow">if</span> ((Flush) &amp;&amp; (<a class="code" href="../../d5/d1/mminit_8c.html#a7">MmEventCountList</a>.<a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html#o1">Count</a> &gt; 4)) {
02480         <a class="code" href="../../d4/d8/mi_8h.html#a932">MiFlushEventCounter</a>();
02481     }
02482     <span class="keywordflow">return</span>;
02483 }
02484 
02485 
02486 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02487"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a29">02487</a> <a class="code" href="../../d4/d8/mi_8h.html#a932">MiFlushEventCounter</a> (
02488     )
02489 
02490 <span class="comment">/*++</span>
02491 <span class="comment"></span>
02492 <span class="comment">Routine Description:</span>
02493 <span class="comment"></span>
02494 <span class="comment">    This routine examines the list of event counters and attempts</span>
02495 <span class="comment">    to free up to 10 (if there are more than 4).</span>
02496 <span class="comment"></span>
02497 <span class="comment">    It will release and reacquire the PFN lock when it frees the</span>
02498 <span class="comment">    event counters!</span>
02499 <span class="comment"></span>
02500 <span class="comment">Arguments:</span>
02501 <span class="comment"></span>
02502 <span class="comment">    None.</span>
02503 <span class="comment"></span>
02504 <span class="comment">Return Value:</span>
02505 <span class="comment"></span>
02506 <span class="comment">    None.</span>
02507 <span class="comment"></span>
02508 <span class="comment">Environment:</span>
02509 <span class="comment"></span>
02510 <span class="comment">    Kernel mode, PFN lock held.</span>
02511 <span class="comment"></span>
02512 <span class="comment">--*/</span>
02513 
02514 
02515 {
02516     KIRQL OldIrql;
02517     <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">PEVENT_COUNTER</a> Support[10];
02518     ULONG i = 0;
02519     PLIST_ENTRY NextEntry;
02520 
02521     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
02522 
02523     <span class="keywordflow">while</span> ((<a class="code" href="../../d5/d1/mminit_8c.html#a7">MmEventCountList</a>.<a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html#o1">Count</a> &gt; 4) &amp;&amp; (i &lt; 10)) {
02524         NextEntry = RemoveHeadList (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a7">MmEventCountList</a>.<a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html#o0">ListHead</a>);
02525         Support[i] = CONTAINING_RECORD (NextEntry,
02526                                         <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">EVENT_COUNTER</a>,
02527                                         ListEntry );
02528         Support[i]-&gt;<a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html#o2">ListEntry</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02529         i += 1;
02530         <a class="code" href="../../d5/d1/mminit_8c.html#a7">MmEventCountList</a>.<a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html#o1">Count</a> -= 1;
02531     }
02532 
02533     <span class="keywordflow">if</span> (i == 0) {
02534         <span class="keywordflow">return</span>;
02535     }
02536 
02537     OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
02538     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02539 
02540     <span class="keywordflow">do</span> {
02541         i -= 1;
02542         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Support[i]);
02543     } <span class="keywordflow">while</span> (i &gt; 0);
02544 
02545     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02546 
02547     <span class="keywordflow">return</span>;
02548 }
02549 
02550 
02551 BOOLEAN
<a name="l02552"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a30">02552</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a30">MmCanFileBeTruncated</a> (
02553     IN <a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionPointer,
02554     IN PLARGE_INTEGER NewFileSize
02555     )
02556 
02557 <span class="comment">/*++</span>
02558 <span class="comment"></span>
02559 <span class="comment">Routine Description:</span>
02560 <span class="comment"></span>
02561 <span class="comment">    This routine does the following:</span>
02562 <span class="comment"></span>
02563 <span class="comment">        1.  Checks to see if a image section is in use for the file,</span>
02564 <span class="comment">            if so it returns FALSE.</span>
02565 <span class="comment"></span>
02566 <span class="comment">        2.  Checks to see if a user section exists for the file, if</span>
02567 <span class="comment">            it does, it checks to make sure the new file size is greater</span>
02568 <span class="comment">            than the size of the file, if not it returns FALSE.</span>
02569 <span class="comment"></span>
02570 <span class="comment">        3.  If no image section exists, and no user created data section</span>
02571 <span class="comment">            exists or the file's size is greater, then TRUE is returned.</span>
02572 <span class="comment"></span>
02573 <span class="comment">Arguments:</span>
02574 <span class="comment"></span>
02575 <span class="comment">    SectionPointer - Supplies a pointer to the section object pointers</span>
02576 <span class="comment">                     from the file object.</span>
02577 <span class="comment"></span>
02578 <span class="comment">    NewFileSize - Supplies a pointer to the size the file is getting set to.</span>
02579 <span class="comment"></span>
02580 <span class="comment">Return Value:</span>
02581 <span class="comment"></span>
02582 <span class="comment">    TRUE if the file can be truncated, FALSE if it cannot be.</span>
02583 <span class="comment"></span>
02584 <span class="comment">Environment:</span>
02585 <span class="comment"></span>
02586 <span class="comment">    Kernel mode.</span>
02587 <span class="comment"></span>
02588 <span class="comment">--*/</span>
02589 
02590 {
02591     LARGE_INTEGER LocalOffset;
02592     KIRQL OldIrql;
02593 
02594     <span class="comment">//</span>
02595     <span class="comment">//  Capture caller's file size, since we may modify it.</span>
02596     <span class="comment">//</span>
02597 
02598     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NewFileSize)) {
02599 
02600         LocalOffset = *NewFileSize;
02601         NewFileSize = &amp;LocalOffset;
02602     }
02603 
02604     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/sectsup_8c.html#a31">MiCanFileBeTruncatedInternal</a>( SectionPointer, NewFileSize, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;OldIrql )) {
02605 
02606         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02607         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02608     }
02609 
02610     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02611 }
02612 
02613 ULONG
<a name="l02614"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a31">02614</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a31">MiCanFileBeTruncatedInternal</a> (
02615     IN <a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionPointer,
02616     IN PLARGE_INTEGER NewFileSize OPTIONAL,
02617     IN LOGICAL BlockNewViews,
02618     OUT PKIRQL PreviousIrql
02619     )
02620 
02621 <span class="comment">/*++</span>
02622 <span class="comment"></span>
02623 <span class="comment">Routine Description:</span>
02624 <span class="comment"></span>
02625 <span class="comment">    This routine does the following:</span>
02626 <span class="comment"></span>
02627 <span class="comment">        1.  Checks to see if a image section is in use for the file,</span>
02628 <span class="comment">            if so it returns FALSE.</span>
02629 <span class="comment"></span>
02630 <span class="comment">        2.  Checks to see if a user section exists for the file, if</span>
02631 <span class="comment">            it does, it checks to make sure the new file size is greater</span>
02632 <span class="comment">            than the size of the file, if not it returns FALSE.</span>
02633 <span class="comment"></span>
02634 <span class="comment">        3.  If no image section exists, and no user created data section</span>
02635 <span class="comment">            exists or the files size is greater, then TRUE is returned.</span>
02636 <span class="comment"></span>
02637 <span class="comment">Arguments:</span>
02638 <span class="comment"></span>
02639 <span class="comment">    SectionPointer - Supplies a pointer to the section object pointers</span>
02640 <span class="comment">                     from the file object.</span>
02641 <span class="comment"></span>
02642 <span class="comment">    NewFileSize - Supplies a pointer to the size the file is getting set to.</span>
02643 <span class="comment"></span>
02644 <span class="comment">    BlockNewViews - Supplies TRUE if the caller will block new views while</span>
02645 <span class="comment">                    the operation (usually a purge) proceeds.  This allows</span>
02646 <span class="comment">                    this routine to return TRUE even if the user has section</span>
02647 <span class="comment">                    references, provided the user currently has no mapped views.</span>
02648 <span class="comment"></span>
02649 <span class="comment">    PreviousIrql - If returning TRUE, returns Irql to use when unlocking</span>
02650 <span class="comment">                   Pfn database.</span>
02651 <span class="comment"></span>
02652 <span class="comment">Return Value:</span>
02653 <span class="comment"></span>
02654 <span class="comment">    TRUE if the file can be truncated (PFN locked).</span>
02655 <span class="comment">    FALSE if it cannot be truncated (PFN not locked).</span>
02656 <span class="comment"></span>
02657 <span class="comment">Environment:</span>
02658 <span class="comment"></span>
02659 <span class="comment">    Kernel mode.</span>
02660 <span class="comment"></span>
02661 <span class="comment">--*/</span>
02662 
02663 {
02664     KIRQL OldIrql;
02665     LARGE_INTEGER SegmentSize;
02666     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
02667     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
02668 
02669     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d5/flushsec_8c.html#a13">MmFlushImageSection</a> (SectionPointer, <a class="code" href="../../d2/d1/mm_8h.html#a346a180">MmFlushForWrite</a>)) {
02670         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02671     }
02672 
02673     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02674 
02675     ControlArea = (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(SectionPointer-&gt;DataSectionObject);
02676 
02677     <span class="keywordflow">if</span> (ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02678 
02679         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated ||
02680             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted) {
02681             <span class="keywordflow">goto</span> UnlockAndReturn;
02682         }
02683 
02684         <span class="comment">//</span>
02685         <span class="comment">// If there are user references and the size is less than the</span>
02686         <span class="comment">// size of the user view, don't allow the truncation.</span>
02687         <span class="comment">//</span>
02688 
02689         <span class="keywordflow">if</span> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> != 0) &amp;&amp; 
02690             ((BlockNewViews == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) || (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> != 0))) {
02691 
02692             <span class="comment">//</span>
02693             <span class="comment">// You cannot truncate the entire section if there is a user</span>
02694             <span class="comment">// reference.</span>
02695             <span class="comment">//</span>
02696 
02697             <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(NewFileSize)) {
02698                 <span class="keywordflow">goto</span> UnlockAndReturn;
02699             }
02700 
02701             <span class="comment">//</span>
02702             <span class="comment">// Locate last subsection and get total size.</span>
02703             <span class="comment">//</span>
02704 
02705             <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0) {
02706                 Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
02707             }
02708             <span class="keywordflow">else</span> {
02709                 Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)((<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)ControlArea + 1);
02710             }
02711 
02712             <span class="keywordflow">while</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02713                 Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
02714             }
02715 
02716             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image == 0);
02717 
02718             SegmentSize = <a class="code" href="../../d4/d8/mi_8h.html#a953">MiEndingOffset</a>(Subsection);
02719 
02720             <span class="keywordflow">if</span> ((UINT64)NewFileSize-&gt;QuadPart &lt; (UINT64)SegmentSize.QuadPart) {
02721                 <span class="keywordflow">goto</span> UnlockAndReturn;
02722             }
02723 
02724             <span class="comment">//</span>
02725             <span class="comment">// If there are mapped views, we will skip the last page</span>
02726             <span class="comment">// of the section if the size passed in falls in that page.</span>
02727             <span class="comment">// The caller (like Cc) may want to clear this fractional page.</span>
02728             <span class="comment">//</span>
02729 
02730             SegmentSize.QuadPart += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1;
02731             SegmentSize.LowPart &amp;= ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
02732             <span class="keywordflow">if</span> ((UINT64)NewFileSize-&gt;QuadPart &lt; (UINT64)SegmentSize.QuadPart) {
02733                 *NewFileSize = SegmentSize;
02734             }
02735         }
02736     }
02737 
02738     *PreviousIrql = OldIrql;
02739     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02740 
02741 UnlockAndReturn:
02742     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02743     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02744 }
02745 
02746 
02747 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02748"></a><a class="code" href="../../d5/d5/sectsup_8c.html#a13">02748</a> <a class="code" href="../../d5/d5/sectsup_8c.html#a13">MiRemoveUnusedSegments</a> (
02749     VOID
02750     )
02751 
02752 <span class="comment">/*++</span>
02753 <span class="comment"></span>
02754 <span class="comment">Routine Description:</span>
02755 <span class="comment"></span>
02756 <span class="comment">    This routine removes unused segments (no section references,</span>
02757 <span class="comment">    no mapped views only PFN references that are in transition state).</span>
02758 <span class="comment"></span>
02759 <span class="comment">Arguments:</span>
02760 <span class="comment"></span>
02761 <span class="comment">    None.</span>
02762 <span class="comment"></span>
02763 <span class="comment">Return Value:</span>
02764 <span class="comment"></span>
02765 <span class="comment">    None.</span>
02766 <span class="comment"></span>
02767 <span class="comment">Environment:</span>
02768 <span class="comment"></span>
02769 <span class="comment">    Kernel mode.</span>
02770 <span class="comment"></span>
02771 <span class="comment">--*/</span>
02772 
02773 {
02774     KIRQL OldIrql;
02775     PLIST_ENTRY NextEntry;
02776     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
02777     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02778     ULONG ConsecutiveFileLockFailures;
02779     ULONG ConsecutivePagingIOs;
02780     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
02781     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> LastSubsection;
02782     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02783     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02784     IO_STATUS_BLOCK IoStatus;
02785     LOGICAL DirtyPagesOk;
02786 
02787     ConsecutivePagingIOs = 0;
02788     ConsecutiveFileLockFailures = 0;
02789 
02790     <span class="keywordflow">while</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a701">MmUnusedSegmentPagedPoolUsage</a> &gt; (<a class="code" href="../../d4/d8/mi_8h.html#a700">MmMaxUnusedSegmentPagedPoolUsage</a> - <a class="code" href="../../d4/d8/mi_8h.html#a703">MmUnusedSegmentPagedPoolReduction</a>)) ||
02791             (<a class="code" href="../../d4/d8/mi_8h.html#a705">MmUnusedSegmentNonPagedPoolUsage</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a704">MmMaxUnusedSegmentNonPagedPoolUsage</a> - <a class="code" href="../../d4/d8/mi_8h.html#a707">MmUnusedSegmentNonPagedPoolReduction</a>) ||
02792             (<a class="code" href="../../d1/d6/allocpag_8c.html#a11">MmUnusedSegmentForceFree</a> != 0)) {
02793 
02794         <span class="comment">//</span>
02795         <span class="comment">// Eliminate some of the unused segments which are only</span>
02796         <span class="comment">// kept in memory because they contain transition pages.</span>
02797         <span class="comment">//</span>
02798 
02799         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02800 
02801         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02802 
02803         <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a698">MmUnusedSegmentList</a>)) {
02804 
02805             <span class="comment">//</span>
02806             <span class="comment">// There is nothing in the list, rewait.</span>
02807             <span class="comment">//</span>
02808 
02809             <a class="code" href="../../d1/d6/allocpag_8c.html#a11">MmUnusedSegmentForceFree</a> = 0;
02810             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a709">MmUnusedSegmentCount</a> == 0);
02811             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a701">MmUnusedSegmentPagedPoolUsage</a> == 0);
02812             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a705">MmUnusedSegmentNonPagedPoolUsage</a> == 0);
02813             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02814             <span class="keywordflow">break</span>;
02815         }
02816 
02817         NextEntry = RemoveHeadList(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a698">MmUnusedSegmentList</a>);
02818 
02819         ControlArea = CONTAINING_RECORD( NextEntry,
02820                                          <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">CONTROL_AREA</a>,
02821                                          DereferenceList );
02822 <span class="preprocessor">#if DBG</span>
02823 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a64">MM_DBG_SECTIONS</a>) {
02824             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM: cleaning segment %lx control %lx\n"</span>,
02825                 ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>, ControlArea);
02826         }
02827 <span class="preprocessor">#endif</span>
02828 <span class="preprocessor"></span>
02829         <a class="code" href="../../d4/d8/mi_8h.html#a330">MI_UNUSED_SEGMENTS_REMOVE_CHARGE</a> (ControlArea);
02830 
02831         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/allocpag_8c.html#a11">MmUnusedSegmentForceFree</a> != 0) {
02832             <a class="code" href="../../d1/d6/allocpag_8c.html#a11">MmUnusedSegmentForceFree</a> -= 1;
02833         }
02834 
02835         <span class="comment">//</span>
02836         <span class="comment">// Indicate this entry is not on any list.</span>
02837         <span class="comment">//</span>
02838 
02839 <span class="preprocessor">#if DBG</span>
02840 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted == 0) {
02841           <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image) {
02842             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o6">SectionObjectPointer</a>-&gt;<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o2">ImageSectionObject</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02843           } <span class="keywordflow">else</span> {
02844             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o6">SectionObjectPointer</a>-&gt;<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02845           }
02846         }
02847 <span class="preprocessor">#endif //DBG</span>
02848 <span class="preprocessor"></span>
02849         <span class="comment">//</span>
02850         <span class="comment">// Set the flink to NULL indicating this control area</span>
02851         <span class="comment">// is not on any lists.</span>
02852         <span class="comment">//</span>
02853 
02854         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02855 
02856         <span class="keywordflow">if</span> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> == 0) &amp;&amp;
02857             (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> == 0) &amp;&amp;
02858             (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted == 0)) {
02859 
02860             <span class="comment">//</span>
02861             <span class="comment">// If there is paging I/O in progress on this</span>
02862             <span class="comment">// segment, just put this at the tail of the list, as</span>
02863             <span class="comment">// the call to MiCleanSegment would block waiting</span>
02864             <span class="comment">// for the I/O to complete.  As this could tie up</span>
02865             <span class="comment">// the thread, don't do it.   Check if these are the only</span>
02866             <span class="comment">// types of segments on the dereference list so we don't</span>
02867             <span class="comment">// spin forever and wedge the system.</span>
02868             <span class="comment">//</span>
02869 
02870             <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o13">ModifiedWriteCount</a> &gt; 0) {
02871 
02872                 InsertTailList ( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a698">MmUnusedSegmentList</a>,
02873                                  &amp;ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>);
02874 
02875                 <a class="code" href="../../d4/d8/mi_8h.html#a329">MI_UNUSED_SEGMENTS_INSERT_CHARGE</a> (ControlArea);
02876 
02877                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02878 
02879                 ConsecutivePagingIOs += 1;
02880                 <span class="keywordflow">if</span> (ConsecutivePagingIOs &gt; 10) {
02881                     <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
02882                     ConsecutivePagingIOs = 0;
02883                 }
02884                 <span class="keywordflow">continue</span>;
02885             }
02886             ConsecutivePagingIOs = 0;
02887 
02888             <span class="comment">//</span>
02889             <span class="comment">// Up the number of mapped views to prevent other threads</span>
02890             <span class="comment">// from freeing this.  Clear the accessed bit so we'll know</span>
02891             <span class="comment">// if another thread opens the control area while we're flushing</span>
02892             <span class="comment">// and closes it before we finish the flush - the other thread</span>
02893             <span class="comment">// may have modified some pages which can then cause our</span>
02894             <span class="comment">// MiCleanSection call (which expects no modified pages in this</span>
02895             <span class="comment">// case) to deadlock with the filesystem.</span>
02896             <span class="comment">//</span>
02897 
02898             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> = 1;
02899             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Accessed = 0;
02900 
02901             <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image == 0) {
02902 
02903                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02904     
02905                 <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0) {
02906                     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
02907                 }
02908                 <span class="keywordflow">else</span> {
02909                     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)((<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)ControlArea + 1);
02910                 }
02911     
02912                 PointerPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[0];
02913                 LastSubsection = Subsection;
02914                 <span class="keywordflow">while</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02915                     LastSubsection = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
02916                 }
02917                 LastPte = &amp;LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>
02918                                 [LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> - 1];
02919 
02920                 <span class="comment">//</span>
02921                 <span class="comment">// Preacquire the file to prevent deadlocks with other flushers</span>
02922                 <span class="comment">// Also mark ourself as a top level IRP so the filesystem knows</span>
02923                 <span class="comment">// we are holding no other resources and that it can unroll if</span>
02924                 <span class="comment">// it needs to in order to avoid deadlock.  Don't hold this</span>
02925                 <span class="comment">// protection any longer than we need to.</span>
02926                 <span class="comment">//</span>
02927     
02928                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a105">FsRtlAcquireFileForCcFlush</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>);
02929     
02930                 <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d1/d8/fsrtl_8h.html#a11">FSRTL_FSP_TOP_LEVEL_IRP</a>);
02931     
02932                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d8/mi_8h.html#a935">MiFlushSectionInternal</a> (PointerPte,
02933                                                  LastPte,
02934                                                  Subsection,
02935                                                  LastSubsection,
02936                                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02937                                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02938                                                  &amp;IoStatus);
02939     
02940                 <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02941     
02942                 <span class="comment">//</span>
02943                 <span class="comment">//  Now release the file.</span>
02944                 <span class="comment">//</span>
02945     
02946                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a106">FsRtlReleaseFileForCcFlush</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>);
02947 
02948                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02949             }
02950 
02951             <span class="comment">//</span>
02952             <span class="comment">// Before checking for any failure codes, see if any other</span>
02953             <span class="comment">// threads accessed the control area while the flush was ongoing.</span>
02954             <span class="comment">//</span>
02955             <span class="comment">// Note that beyond the case of another thread currently using</span>
02956             <span class="comment">// the control area, the more subtle one is where another</span>
02957             <span class="comment">// thread accessed the control area and modified some pages.</span>
02958             <span class="comment">// The flush needs to redone (so the clean is guaranteed to work)</span>
02959             <span class="comment">// before another clean can be issued.</span>
02960             <span class="comment">//</span>
02961             <span class="comment">// If any of these cases have occurred, grant this control area</span>
02962             <span class="comment">// a reprieve.</span>
02963             <span class="comment">//</span>
02964 
02965             <span class="keywordflow">if</span> (!((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> == 1) &amp;&amp;
02966                 (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Accessed == 0) &amp;&amp;
02967                 (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> == 0) &amp;&amp;
02968                 (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted == 0))) {
02969 
02970                 ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
02971 
02972                 <span class="comment">//</span>
02973                 <span class="comment">// If the other thread(s) are done with this control area,</span>
02974                 <span class="comment">// it MUST be requeued here - otherwise if there are any</span>
02975                 <span class="comment">// pages in the control area, when they are reclaimed,</span>
02976                 <span class="comment">// MiCheckForControlAreaDeletion checks for and expects </span>
02977                 <span class="comment">// the control area to be queued on the unused segment list.</span>
02978                 <span class="comment">//</span>
02979                 <span class="comment">// Note this must be done very carefully because if the other</span>
02980                 <span class="comment">// threads are not done with the control area, it had better</span>
02981                 <span class="comment">// not get put on the unused segment list.</span>
02982                 <span class="comment">//</span>
02983 
02984                 <span class="comment">//</span>
02985                 <span class="comment">// Need to do the equivalent of a MiCheckControlArea here.</span>
02986                 <span class="comment">// or reprocess.  Only iff mappedview &amp; sectref = 0.</span>
02987                 <span class="comment">//</span>
02988 
02989                 <span class="keywordflow">if</span> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> == 0) &amp;&amp;
02990                     (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> == 0) &amp;&amp;
02991                     (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted == 0)) {
02992 
02993                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Accessed == 1);
02994                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02995 
02996                     InsertTailList ( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a698">MmUnusedSegmentList</a>,
02997                                      &amp;ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>);
02998                     <a class="code" href="../../d4/d8/mi_8h.html#a329">MI_UNUSED_SEGMENTS_INSERT_CHARGE</a> (ControlArea);
02999                 }
03000 
03001                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03002                 <span class="keywordflow">continue</span>;
03003             }
03004 
03005             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03006 
03007                 <span class="comment">//</span>
03008                 <span class="comment">// If the filesystem told us it had to unroll to avoid</span>
03009                 <span class="comment">// deadlock OR we hit a mapped writer collision OR</span>
03010                 <span class="comment">// the error occurred on a local file:</span>
03011                 <span class="comment">//</span>
03012                 <span class="comment">// Then requeue this at the end so we can try again later.</span>
03013                 <span class="comment">//</span>
03014                 <span class="comment">// Any other errors for networked files are assumed to be </span>
03015                 <span class="comment">// permanent (ie: the link may have gone down for an indefinite</span>
03016                 <span class="comment">// period), so these sections are cleaned regardless.</span>
03017                 <span class="comment">//</span>
03018 
03019                 <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_FILE_LOCK_CONFLICT) ||
03020                     (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d4/d8/mi_8h.html#a247">STATUS_MAPPED_WRITER_COLLISION</a>) ||
03021                     (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Networked == 0)) {
03022 
03023                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03024 
03025                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
03026 
03027                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_FILE_LOCK_CONFLICT) {
03028                         ConsecutiveFileLockFailures += 1;
03029                     }
03030                     <span class="keywordflow">else</span> {
03031                         ConsecutiveFileLockFailures = 0;
03032                     }
03033 
03034                     InsertTailList ( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a698">MmUnusedSegmentList</a>,
03035                                      &amp;ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>);
03036                     <a class="code" href="../../d4/d8/mi_8h.html#a329">MI_UNUSED_SEGMENTS_INSERT_CHARGE</a> (ControlArea);
03037 
03038                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03039 
03040                     <span class="comment">//</span>
03041                     <span class="comment">// 10 consecutive file locking failures means we need to</span>
03042                     <span class="comment">// yield the processor to allow the filesystem to unjam.</span>
03043                     <span class="comment">// Nothing magic about 10, just a number so it</span>
03044                     <span class="comment">// gives the worker threads a chance to run.</span>
03045                     <span class="comment">//</span>
03046 
03047                     <span class="keywordflow">if</span> (ConsecutiveFileLockFailures &gt;= 10) {
03048                         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
03049                         ConsecutiveFileLockFailures = 0;
03050                     }
03051                     <span class="keywordflow">continue</span>;
03052                 }
03053                 DirtyPagesOk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03054             }
03055             <span class="keywordflow">else</span> {
03056                 ConsecutiveFileLockFailures = 0;
03057                 DirtyPagesOk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03058             }
03059 
03060             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted = 1;
03061 
03062             <span class="comment">//</span>
03063             <span class="comment">// Don't let any pages be written by the modified</span>
03064             <span class="comment">// page writer from this point on.</span>
03065             <span class="comment">//</span>
03066 
03067             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting = 1;
03068             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FilePointerNull == 0);
03069             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03070 
03071             <a class="code" href="../../d5/d5/sectsup_8c.html#a22">MiCleanSection</a> (ControlArea, DirtyPagesOk);
03072 
03073         } <span class="keywordflow">else</span> {
03074 
03075             <span class="comment">//</span>
03076             <span class="comment">// The segment was not eligible for deletion.  Just leave</span>
03077             <span class="comment">// it off the unused segment list and continue the loop.</span>
03078             <span class="comment">//</span>
03079 
03080             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03081             ConsecutivePagingIOs = 0;
03082         }
03083 
03084     } <span class="comment">//end while</span>
03085 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:44 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
