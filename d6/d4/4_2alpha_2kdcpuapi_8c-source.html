<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kdcpuapi.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdcpuapi.c</h1><a href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment">Copyright (c) 1992  Digital Equipment Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    kdcpuapi.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module implements CPU specific remote debug APIs.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Mark Lucovsky (markl) 04-Sep-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Jeff McLeman (mcleman) 11-June-1992</span>
00021 <span class="comment">    Make this an alpha specific module</span>
00022 <span class="comment"></span>
00023 <span class="comment">    Joe Notarangelo  28-Sep-1992</span>
00024 <span class="comment">    Add Alpha-specific control space semantics.</span>
00025 <span class="comment"></span>
00026 <span class="comment">    Miche Baker-Harvey 22-Oct-1992</span>
00027 <span class="comment">    Added Kdp{Read,Write}IoSpace</span>
00028 <span class="comment">--*/</span>
00029 
00030 <span class="preprocessor">#include "<a class="code" href="../../d1/d7/4_2kdp_8h.html">kdp.h</a>"</span>
00031 
<a name="l00032"></a><a class="code" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a0">00032</a> <span class="preprocessor">#define HEADER_FILE</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#include "kxalpha.h"</span>
00034 
00035 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00036"></a><a class="code" href="../../d1/d7/4_2kdp_8h.html#a113">00036</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a113">KdpSetLoadState</a> (
00037     IN PDBGKD_WAIT_STATE_CHANGE64 WaitStateChange,
00038     IN PCONTEXT ContextRecord
00039     )
00040 
00041 <span class="comment">/*++</span>
00042 <span class="comment"></span>
00043 <span class="comment">Routine Description:</span>
00044 <span class="comment"></span>
00045 <span class="comment">    Fill in the Wait_State_Change message record for the load symbol case.</span>
00046 <span class="comment"></span>
00047 <span class="comment">Arguments:</span>
00048 <span class="comment"></span>
00049 <span class="comment">    WaitStateChange - Supplies pointer to record to fill in</span>
00050 <span class="comment"></span>
00051 <span class="comment">    ContextRecord - Supplies a pointer to a context record.</span>
00052 <span class="comment"></span>
00053 <span class="comment">Return Value:</span>
00054 <span class="comment"></span>
00055 <span class="comment">    None.</span>
00056 <span class="comment"></span>
00057 <span class="comment">--*/</span>
00058 
00059 {
00060 
00061     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00062     PVOID <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00063 
00064     <span class="comment">//</span>
00065     <span class="comment">// Copy the immediate instruction stream into the control report structure.</span>
00066     <span class="comment">//</span>
00067 
00068     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> =  <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(&amp;WaitStateChange-&gt;ControlReport.InstructionStream[0],
00069                            (PCHAR)WaitStateChange-&gt;ProgramCounter,
00070                            DBGKD_MAXSTREAM);
00071 
00072     WaitStateChange-&gt;ControlReport.InstructionCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00073 
00074     <span class="comment">//</span>
00075     <span class="comment">// Clear breakpoints in the copied instruction stream. If any breakpoints</span>
00076     <span class="comment">// are clear, then recopy the instruction strasm.</span>
00077     <span class="comment">//</span>
00078 
00079     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = (PVOID)((PUCHAR)(WaitStateChange-&gt;ProgramCounter) + <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - 1);
00080     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a106">KdpDeleteBreakpointRange</a>((PVOID)WaitStateChange-&gt;ProgramCounter, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00081         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(&amp;WaitStateChange-&gt;ControlReport.InstructionStream[0],
00082                       (PVOID)WaitStateChange-&gt;ProgramCounter,
00083                       <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00084     }
00085 
00086     <span class="comment">//</span>
00087     <span class="comment">// Copy the context record into the wait state structure.</span>
00088     <span class="comment">//</span>
00089 
00090     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>((PCHAR)&amp;WaitStateChange-&gt;Context,
00091                   (PCHAR)ContextRecord,
00092                   <span class="keyword">sizeof</span>(*ContextRecord));
00093 
00094     <span class="keywordflow">return</span>;
00095 }
00096 
00097 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00098"></a><a class="code" href="../../d1/d7/4_2kdp_8h.html#a114">00098</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a114">KdpSetStateChange</a> (
00099     IN PDBGKD_WAIT_STATE_CHANGE64 WaitStateChange,
00100     IN PEXCEPTION_RECORD ExceptionRecord,
00101     IN PCONTEXT ContextRecord,
00102     IN BOOLEAN SecondChance
00103     )
00104 
00105 <span class="comment">/*++</span>
00106 <span class="comment"></span>
00107 <span class="comment">Routine Description:</span>
00108 <span class="comment"></span>
00109 <span class="comment">    Fill in the Wait_State_Change message record.</span>
00110 <span class="comment"></span>
00111 <span class="comment">Arguments:</span>
00112 <span class="comment"></span>
00113 <span class="comment">    WaitStateChange - Supplies pointer to record to fill in</span>
00114 <span class="comment"></span>
00115 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span>
00116 <span class="comment"></span>
00117 <span class="comment">    ContextRecord - Supplies a pointer to a context record.</span>
00118 <span class="comment"></span>
00119 <span class="comment">    SecondChance - Supplies a boolean value that determines whether this is</span>
00120 <span class="comment">        the first or second chance for the exception.</span>
00121 <span class="comment"></span>
00122 <span class="comment">Return Value:</span>
00123 <span class="comment"></span>
00124 <span class="comment">    None.</span>
00125 <span class="comment"></span>
00126 <span class="comment">--*/</span>
00127 
00128 {
00129 
00130     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00131     PVOID <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00132 
00133     <span class="comment">//</span>
00134     <span class="comment">// Set up description of event, including exception record</span>
00135     <span class="comment">//</span>
00136 
00137     WaitStateChange-&gt;NewState = DbgKdExceptionStateChange;
00138     WaitStateChange-&gt;ProcessorLevel = <a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a>;
00139     WaitStateChange-&gt;Processor = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a12">KdpGetCurrentPrcb</a>()-&gt;Number;
00140     WaitStateChange-&gt;NumberProcessors = (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
00141     WaitStateChange-&gt;Thread = (ULONG_PTR)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a13">KdpGetCurrentThread</a>();
00142     WaitStateChange-&gt;ProgramCounter = (ULONG_PTR)CONTEXT_TO_PROGRAM_COUNTER(ContextRecord);
00143     <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(EXCEPTION_RECORD) == <span class="keyword">sizeof</span>(WaitStateChange-&gt;u.Exception.ExceptionRecord)) {
00144         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a111">KdpQuickMoveMemory</a>((PCHAR)&amp;WaitStateChange-&gt;u.Exception.ExceptionRecord,
00145                            (PCHAR)ExceptionRecord,
00146                            <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
00147     } <span class="keywordflow">else</span> {
00148         ExceptionRecord32To64((PEXCEPTION_RECORD32)ExceptionRecord,
00149                               &amp;WaitStateChange-&gt;u.Exception.ExceptionRecord
00150                               );
00151     }
00152 
00153     WaitStateChange-&gt;u.Exception.FirstChance = !SecondChance;
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">// Copy the immediate instruction stream into the control report structure.</span>
00157     <span class="comment">//</span>
00158 
00159     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> =  <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(&amp;WaitStateChange-&gt;ControlReport.InstructionStream[0],
00160                            (PVOID)WaitStateChange-&gt;ProgramCounter,
00161                            DBGKD_MAXSTREAM);
00162 
00163     WaitStateChange-&gt;ControlReport.InstructionCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00164 
00165     <span class="comment">//</span>
00166     <span class="comment">// Clear breakpoints in the copied instruction stream. If any breakpoints</span>
00167     <span class="comment">// are clear, then recopy the instruction strasm.</span>
00168     <span class="comment">//</span>
00169 
00170     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = (PVOID)((PUCHAR)(WaitStateChange-&gt;ProgramCounter) + <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - 1);
00171     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a106">KdpDeleteBreakpointRange</a>((PVOID)WaitStateChange-&gt;ProgramCounter, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00172         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(&amp;WaitStateChange-&gt;ControlReport.InstructionStream[0],
00173                       (PVOID)WaitStateChange-&gt;ProgramCounter,
00174                       <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00175     }
00176 
00177     <span class="comment">//</span>
00178     <span class="comment">// Copy the context record into the wait state structure.</span>
00179     <span class="comment">//</span>
00180 
00181     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>((PCHAR)&amp;WaitStateChange-&gt;Context,
00182                   (PCHAR)ContextRecord,
00183                   <span class="keyword">sizeof</span>(*ContextRecord));
00184 
00185     <span class="keywordflow">return</span>;
00186 }
00187 
00188 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00189"></a><a class="code" href="../../d1/d7/4_2kdp_8h.html#a115">00189</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a115">KdpGetStateChange</a> (
00190     IN PDBGKD_MANIPULATE_STATE64 ManipulateState,
00191     IN PCONTEXT ContextRecord
00192     )
00193 
00194 <span class="comment">/*++</span>
00195 <span class="comment"></span>
00196 <span class="comment">Routine Description:</span>
00197 <span class="comment"></span>
00198 <span class="comment">    Extract continuation control data from Manipulate_State message</span>
00199 <span class="comment"></span>
00200 <span class="comment">    N.B. This is a noop for MIPS.</span>
00201 <span class="comment"></span>
00202 <span class="comment">Arguments:</span>
00203 <span class="comment"></span>
00204 <span class="comment">    ManipulateState - supplies pointer to Manipulate_State packet</span>
00205 <span class="comment"></span>
00206 <span class="comment">    ContextRecord - Supplies a pointer to a context record.</span>
00207 <span class="comment"></span>
00208 <span class="comment">Return Value:</span>
00209 <span class="comment"></span>
00210 <span class="comment">    None.</span>
00211 <span class="comment"></span>
00212 <span class="comment">--*/</span>
00213 
00214 {
00215 }
00216 
00217 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00218"></a><a class="code" href="../../d1/d7/4_2kdp_8h.html#a132">00218</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a132">KdpReadControlSpace</a> (
00219     IN PDBGKD_MANIPULATE_STATE64 m,
00220     IN PSTRING AdditionalData,
00221     IN PCONTEXT Context
00222     )
00223 
00224 <span class="comment">/*++</span>
00225 <span class="comment"></span>
00226 <span class="comment">Routine Description:</span>
00227 <span class="comment"></span>
00228 <span class="comment">    This function is called in response of a read control space state</span>
00229 <span class="comment">    manipulation message.  Its function is to read implementation</span>
00230 <span class="comment">    specific system data.</span>
00231 <span class="comment"></span>
00232 <span class="comment">Arguments:</span>
00233 <span class="comment"></span>
00234 <span class="comment">    m - Supplies the state manipulation message.</span>
00235 <span class="comment"></span>
00236 <span class="comment">    AdditionalData - Supplies any additional data for the message.</span>
00237 <span class="comment"></span>
00238 <span class="comment">    Context - Supplies the current context.</span>
00239 <span class="comment"></span>
00240 <span class="comment">Return Value:</span>
00241 <span class="comment"></span>
00242 <span class="comment">    None.</span>
00243 <span class="comment"></span>
00244 <span class="comment">--*/</span>
00245 
00246 {
00247 
00248     PDBGKD_READ_MEMORY64 a = &amp;m-&gt;u.ReadMemory;
00249     ULONG Length;
00250     STRING MessageHeader;
00251     PVOID <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = AdditionalData-&gt;Buffer;
00252 
00253     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00254     MessageHeader.Buffer = (PCHAR)m;
00255 
00256     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
00257 
00258     <span class="keywordflow">if</span> (a-&gt;TransferCount &gt; (PACKET_MAX_SIZE - <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64))) {
00259         Length = PACKET_MAX_SIZE - <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64);
00260     } <span class="keywordflow">else</span> {
00261         Length = a-&gt;TransferCount;
00262     }
00263 
00264     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(PVOID) == <span class="keyword">sizeof</span>(ULONG_PTR));
00265 
00266 <span class="comment">//NOTENOTE</span>
00267 <span class="comment">//  This code will in fact only work on a uni-processor as the</span>
00268 <span class="comment">//  m-&gt;Processor field is ignored for now</span>
00269 
00270     <span class="comment">//</span>
00271     <span class="comment">// Case on address to determine what part of Control</span>
00272     <span class="comment">// space is being read</span>
00273     <span class="comment">//</span>
00274 
00275     <span class="keywordflow">switch</span>( (ULONG_PTR)a-&gt;TargetBaseAddress ){
00276 
00277         <span class="comment">//</span>
00278         <span class="comment">// Return the pcr address for the current processor.</span>
00279         <span class="comment">//</span>
00280 
00281     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_PCR:
00282 
00283         *(PKPCR *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a7">KdpGetPcr</a>();
00284         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>( PKPCR );
00285         a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00286         m-&gt;ReturnStatus = STATUS_SUCCESS;
00287         <span class="keywordflow">break</span>;
00288 
00289         <span class="comment">//</span>
00290         <span class="comment">// Return the prcb address for the current processor.</span>
00291         <span class="comment">//</span>
00292 
00293     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_PRCB:
00294 
00295         *(PKPRCB *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a12">KdpGetCurrentPrcb</a>();
00296         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>( PKPRCB );
00297         a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00298         m-&gt;ReturnStatus = STATUS_SUCCESS;
00299         <span class="keywordflow">break</span>;
00300 
00301         <span class="comment">//</span>
00302         <span class="comment">// Return the pointer to the current thread address for the</span>
00303         <span class="comment">// current processor.</span>
00304         <span class="comment">//</span>
00305 
00306     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_THREAD:
00307 
00308         *(<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a13">KdpGetCurrentThread</a>();
00309         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> );
00310         a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00311         m-&gt;ReturnStatus = STATUS_SUCCESS;
00312         <span class="keywordflow">break</span>;
00313 
00314         <span class="comment">//</span>
00315         <span class="comment">// Return the current Thread Environment Block pointer for the</span>
00316         <span class="comment">// current thread on the current processor.</span>
00317         <span class="comment">//</span>
00318 
00319     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_TEB:
00320 
00321         *(PVOID *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PVOID)NtCurrentTeb();
00322         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>( <span class="keyword">struct </span>_TEB * );
00323         a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00324         m-&gt;ReturnStatus = STATUS_SUCCESS;
00325         <span class="keywordflow">break</span>;
00326 
00327         <span class="comment">//</span>
00328         <span class="comment">// Return the dpc active flag for the current processor.</span>
00329         <span class="comment">//</span>
00330 
00331     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_DPCACTIVE:
00332 
00333         *(BOOLEAN *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = KeIsExecutingDpc();
00334         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>( ULONG );
00335         a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00336         m-&gt;ReturnStatus = STATUS_SUCCESS;
00337         <span class="keywordflow">break</span>;
00338 
00339         <span class="comment">//</span>
00340         <span class="comment">// Return the internal processor register state.</span>
00341         <span class="comment">//</span>
00342         <span class="comment">// N.B. - the kernel debugger buffer is expected to be allocated</span>
00343         <span class="comment">//        in the 32-bit superpage</span>
00344         <span class="comment">//</span>
00345         <span class="comment">// N.B. - the size of the internal state cannot exceed the size of</span>
00346         <span class="comment">//        the buffer allocated to the kernel debugger via</span>
00347         <span class="comment">//        KDP_MESSAGE_BUFFER_SIZE</span>
00348         <span class="comment">//</span>
00349 
00350     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_IPRSTATE:
00351 
00352         <span class="comment">//</span>
00353         <span class="comment">// Guarantee that Buffer is quadword-aligned, and adjust the</span>
00354         <span class="comment">// size of the available buffer accordingly.</span>
00355         <span class="comment">//</span>
00356 
00357         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PVOID)( ((ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + 7) &amp; ~7);
00358 
00359         Length = (ULONG)((ULONG_PTR)&amp;AdditionalData-&gt;Buffer[<a class="code" href="../../d0/d7/kdp_8h.html#a14">KDP_MESSAGE_BUFFER_SIZE</a>] -
00360                  (ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00361 
00362         AdditionalData-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d7/d7/4_2axp64_2kdpcpu_8h.html#a8">KdpReadInternalProcessorState</a>(
00363                                              <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00364                                              Length );
00365 
00366         <span class="comment">//</span>
00367         <span class="comment">// Check the returned size, if greater than the buffer size than</span>
00368         <span class="comment">// we didn't have a sufficient buffer.  If zero then the call</span>
00369         <span class="comment">// failed otherwise.</span>
00370         <span class="comment">//</span>
00371 
00372         <span class="keywordflow">if</span>( (AdditionalData-&gt;Length &gt; <a class="code" href="../../d0/d7/kdp_8h.html#a14">KDP_MESSAGE_BUFFER_SIZE</a>) ||
00373             (AdditionalData-&gt;Length == 0) ){
00374 
00375             AdditionalData-&gt;Length = 0;
00376             m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
00377             a-&gt;ActualBytesRead = 0;
00378 
00379         } <span class="keywordflow">else</span> {
00380 
00381             m-&gt;ReturnStatus = STATUS_SUCCESS;
00382             a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00383 
00384         }
00385 
00386         <span class="keywordflow">break</span>;
00387 
00388         <span class="comment">//</span>
00389         <span class="comment">// Return the internal processor counter values.</span>
00390         <span class="comment">//</span>
00391         <span class="comment">// N.B. - the kernel debugger buffer is expected to be allocated</span>
00392         <span class="comment">//        in the 32-bit superpage</span>
00393         <span class="comment">//</span>
00394         <span class="comment">// N.B. - the size of the counters structure cannot exceed the size of</span>
00395         <span class="comment">//        the buffer allocated to the kernel debugger via</span>
00396         <span class="comment">//        KDP_MESSAGE_BUFFER_SIZE</span>
00397         <span class="comment">//</span>
00398 
00399     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_COUNTERS:
00400 
00401         <span class="comment">//</span>
00402         <span class="comment">// Guarantee that Buffer is quadword-aligned, and adjust the</span>
00403         <span class="comment">// size of the available buffer accordingly.</span>
00404         <span class="comment">//</span>
00405 
00406         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PVOID)( ((ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + 7) &amp; ~7);
00407 
00408         Length = (ULONG)((ULONG_PTR)&amp;AdditionalData-&gt;Buffer[<a class="code" href="../../d0/d7/kdp_8h.html#a14">KDP_MESSAGE_BUFFER_SIZE</a>] -
00409                  (ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00410 
00411         AdditionalData-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d7/d7/4_2axp64_2kdpcpu_8h.html#a9">KdpReadInternalProcessorCounters</a>(
00412                                              <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00413                                              Length );
00414 
00415         <span class="comment">//</span>
00416         <span class="comment">// Check the returned size, if greater than the buffer size than</span>
00417         <span class="comment">// we didn't have a sufficient buffer.  If zero then the call</span>
00418         <span class="comment">// failed otherwise.</span>
00419         <span class="comment">//</span>
00420 
00421         <span class="keywordflow">if</span>( (AdditionalData-&gt;Length &gt; <a class="code" href="../../d0/d7/kdp_8h.html#a14">KDP_MESSAGE_BUFFER_SIZE</a>) ||
00422             (AdditionalData-&gt;Length == 0) ){
00423 
00424             AdditionalData-&gt;Length = 0;
00425             m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
00426             a-&gt;ActualBytesRead = 0;
00427 
00428         } <span class="keywordflow">else</span> {
00429 
00430             m-&gt;ReturnStatus = STATUS_SUCCESS;
00431             a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00432 
00433         }
00434 
00435         <span class="keywordflow">break</span>;
00436 
00437         <span class="comment">//</span>
00438         <span class="comment">// Uninterpreted Special Space</span>
00439         <span class="comment">//</span>
00440 
00441     <span class="keywordflow">default</span>:
00442 
00443         AdditionalData-&gt;Length = 0;
00444         m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
00445         a-&gt;ActualBytesRead = 0;
00446 
00447     }
00448 
00449     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00450         PACKET_TYPE_KD_STATE_MANIPULATE,
00451         &amp;MessageHeader,
00452         AdditionalData
00453         );
00454 }
00455 
00456 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00457"></a><a class="code" href="../../d1/d7/4_2kdp_8h.html#a133">00457</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a133">KdpWriteControlSpace</a> (
00458     IN PDBGKD_MANIPULATE_STATE64 m,
00459     IN PSTRING AdditionalData,
00460     IN PCONTEXT Context
00461     )
00462 
00463 <span class="comment">/*++</span>
00464 <span class="comment"></span>
00465 <span class="comment">Routine Description:</span>
00466 <span class="comment"></span>
00467 <span class="comment">    This function is called in response of a write control space state</span>
00468 <span class="comment">    manipulation message.  Its function is to write implementation</span>
00469 <span class="comment">    specific system data.</span>
00470 <span class="comment"></span>
00471 <span class="comment">Arguments:</span>
00472 <span class="comment"></span>
00473 <span class="comment">    m - Supplies the state manipulation message.</span>
00474 <span class="comment"></span>
00475 <span class="comment">    AdditionalData - Supplies any additional data for the message.</span>
00476 <span class="comment"></span>
00477 <span class="comment">    Context - Supplies the current context.</span>
00478 <span class="comment"></span>
00479 <span class="comment">Return Value:</span>
00480 <span class="comment"></span>
00481 <span class="comment">    None.</span>
00482 <span class="comment"></span>
00483 <span class="comment">--*/</span>
00484 
00485 {
00486     PDBGKD_WRITE_MEMORY64 a = &amp;m-&gt;u.WriteMemory;
00487     ULONG Length;
00488     STRING MessageHeader;
00489 
00490     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00491     MessageHeader.Buffer = (PCHAR)m;
00492 
00493     AdditionalData-&gt;Length = 0;
00494     m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
00495     a-&gt;ActualBytesWritten = 0;
00496 
00497     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00498         PACKET_TYPE_KD_STATE_MANIPULATE,
00499         &amp;MessageHeader,
00500         AdditionalData
00501         );
00502 }
00503 
00504 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00505"></a><a class="code" href="../../d1/d7/4_2kdp_8h.html#a134">00505</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a134">KdpReadIoSpace</a> (
00506     IN PDBGKD_MANIPULATE_STATE64 m,
00507     IN PSTRING AdditionalData,
00508     IN PCONTEXT Context
00509     )
00510 
00511 <span class="comment">/*++</span>
00512 <span class="comment"></span>
00513 <span class="comment">Routine Description:</span>
00514 <span class="comment"></span>
00515 <span class="comment">    This function is called in response of a read io space state</span>
00516 <span class="comment">    manipulation message.  Its function is to read system io</span>
00517 <span class="comment">    locations.</span>
00518 <span class="comment"></span>
00519 <span class="comment">Arguments:</span>
00520 <span class="comment"></span>
00521 <span class="comment">    m - Supplies the state manipulation message.</span>
00522 <span class="comment"></span>
00523 <span class="comment">    AdditionalData - Supplies any additional data for the message.</span>
00524 <span class="comment"></span>
00525 <span class="comment">    Context - Supplies the current context.</span>
00526 <span class="comment"></span>
00527 <span class="comment">Return Value:</span>
00528 <span class="comment"></span>
00529 <span class="comment">    None.</span>
00530 <span class="comment"></span>
00531 <span class="comment">--*/</span>
00532 
00533 {
00534     PDBGKD_READ_WRITE_IO64 a = &amp;m-&gt;u.ReadWriteIo;
00535     STRING MessageHeader;
00536     INTERFACE_TYPE <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
00537     ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00538     PHYSICAL_ADDRESS IoAddress;
00539     PHYSICAL_ADDRESS TranslatedAddress;
00540     ULONG AddressSpace;
00541     ULONG DataSize;
00542 
00543     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00544     MessageHeader.Buffer = (PCHAR)m;
00545 
00546     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
00547 
00548     m-&gt;ReturnStatus = STATUS_SUCCESS;
00549 
00550     <span class="comment">//</span>
00551     <span class="comment">// Capture the input parameters and use the default values for those</span>
00552     <span class="comment">// parameters not specified in the Api.</span>
00553     <span class="comment">//</span>
00554 
00555     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> = Isa;
00556     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = 0;
00557     AddressSpace = 1;
00558     IoAddress.QuadPart = (ULONG_PTR)a-&gt;IoAddress;
00559     DataSize = a-&gt;DataSize;
00560 
00561     <span class="comment">//</span>
00562     <span class="comment">// Zero the return data value.</span>
00563     <span class="comment">//</span>
00564 
00565     a-&gt;DataValue = 0;
00566 
00567     <span class="comment">//</span>
00568     <span class="comment">// Translate the bus address to the physical system address</span>
00569     <span class="comment">// or QVA.</span>
00570     <span class="comment">//</span>
00571 
00572     <span class="keywordflow">if</span>( !<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>( <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>,
00573                                  <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>,
00574                                  IoAddress,
00575                                  &amp;AddressSpace,
00576                                  &amp;TranslatedAddress ) ){
00577         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00578         <span class="keywordflow">goto</span> SendReadIoSpaceResponse;
00579     }
00580 
00581     <span class="comment">//</span>
00582     <span class="comment">// N.B. - for the moment we will only support QVAs ie. when AddressSpace</span>
00583     <span class="comment">//        is one.  It may be in later systems that we will have to</span>
00584     <span class="comment">//        check the address space, map it, perform the virtual read</span>
00585     <span class="comment">//        unmap, and then return the data - only we will have to be</span>
00586     <span class="comment">//        careful about what Irql we are to make sure the memory mgmt</span>
00587     <span class="comment">//        stuff will all work</span>
00588     <span class="comment">//</span>
00589 
00590     <span class="keywordflow">if</span>( !AddressSpace ){
00591         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00592         <span class="keywordflow">goto</span> SendReadIoSpaceResponse;
00593     }
00594 
00595     <span class="comment">//</span>
00596     <span class="comment">// Do the IO space read using the appropriate HAL routines based upon</span>
00597     <span class="comment">// the default address space (io) and the data size requested.</span>
00598     <span class="comment">//</span>
00599 
00600     <span class="keywordflow">switch</span>( DataSize ){
00601 
00602     <span class="keywordflow">case</span> 1:
00603         a-&gt;DataValue = READ_PORT_UCHAR( (PUCHAR)(ULONG_PTR) TranslatedAddress.QuadPart );
00604         <span class="keywordflow">break</span>;
00605 
00606     <span class="keywordflow">case</span> 2:
00607         a-&gt;DataValue = READ_PORT_USHORT( (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(ULONG_PTR) TranslatedAddress.QuadPart );
00608         <span class="keywordflow">break</span>;
00609 
00610     <span class="keywordflow">case</span> 4:
00611         a-&gt;DataValue = READ_PORT_ULONG((PULONG)(ULONG_PTR) TranslatedAddress.QuadPart );
00612         <span class="keywordflow">break</span>;
00613 
00614     <span class="keywordflow">default</span>:
00615         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00616     }
00617 
00618 
00619 SendReadIoSpaceResponse:
00620 
00621     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00622         PACKET_TYPE_KD_STATE_MANIPULATE,
00623         &amp;MessageHeader,
00624         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00625         );
00626 }
00627 
00628 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00629"></a><a class="code" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a7">00629</a> <a class="code" href="../../d7/d7/4_2axp64_2kdpcpu_8h.html#a10">KdpReadIoSpaceExtended</a> (
00630     IN PDBGKD_MANIPULATE_STATE64 m,
00631     IN PSTRING AdditionalData,
00632     IN PCONTEXT Context
00633     )
00634 
00635 <span class="comment">/*++</span>
00636 <span class="comment"></span>
00637 <span class="comment">Routine Description:</span>
00638 <span class="comment"></span>
00639 <span class="comment">    This function is called in response of a read io space extended state</span>
00640 <span class="comment">    manipulation message.  Its function is to read system io</span>
00641 <span class="comment">    locations.</span>
00642 <span class="comment"></span>
00643 <span class="comment">Arguments:</span>
00644 <span class="comment"></span>
00645 <span class="comment">    m - Supplies the state manipulation message.</span>
00646 <span class="comment"></span>
00647 <span class="comment">    AdditionalData - Supplies any additional data for the message.</span>
00648 <span class="comment"></span>
00649 <span class="comment">    Context - Supplies the current context.</span>
00650 <span class="comment"></span>
00651 <span class="comment">Return Value:</span>
00652 <span class="comment"></span>
00653 <span class="comment">    None.</span>
00654 <span class="comment"></span>
00655 <span class="comment">--*/</span>
00656 
00657 {
00658     PDBGKD_READ_WRITE_IO_EXTENDED64 a = &amp;m-&gt;u.ReadWriteIoExtended;
00659     ULONG Length;
00660     STRING MessageHeader;
00661     PUCHAR b;
00662     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> s;
00663     PULONG l;
00664     ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00665     ULONG AddressSpace;
00666     ULONG SavedAddressSpace;
00667     PHYSICAL_ADDRESS IoAddress;
00668     ULONG DataSize;
00669     PHYSICAL_ADDRESS TranslatedAddress;
00670     INTERFACE_TYPE <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
00671 
00672     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00673     MessageHeader.Buffer = (PCHAR)m;
00674 
00675     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
00676 
00677     m-&gt;ReturnStatus = STATUS_SUCCESS;
00678 
00679     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> = a-&gt;InterfaceType;
00680     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = a-&gt;BusNumber;
00681     AddressSpace = SavedAddressSpace = a-&gt;AddressSpace;
00682     IoAddress.QuadPart = (ULONG_PTR)a-&gt;IoAddress;
00683     DataSize = a-&gt;DataSize;
00684 
00685     <span class="comment">//</span>
00686     <span class="comment">// Zero the return data value.</span>
00687     <span class="comment">//</span>
00688 
00689     a-&gt;DataValue = 0;
00690 
00691     <span class="comment">//</span>
00692     <span class="comment">// Translate the bus address to the physical system address</span>
00693     <span class="comment">// or QVA.</span>
00694     <span class="comment">//</span>
00695 
00696     <span class="keywordflow">if</span>( !<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>( <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>,
00697                                  <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>,
00698                                  IoAddress,
00699                                  &amp;AddressSpace,
00700                                  &amp;TranslatedAddress ) ){
00701         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00702         <span class="keywordflow">goto</span> SendReadIoSpaceExtendedResponse;
00703     }
00704 
00705     <span class="comment">//</span>
00706     <span class="comment">// N.B. - for the moment we will only support QVAs ie. when AddressSpace</span>
00707     <span class="comment">//        is one.  It may be in later systems that we will have to</span>
00708     <span class="comment">//        check the address space, map it, perform the virtual read</span>
00709     <span class="comment">//        unmap, and then return the data - only we will have to be</span>
00710     <span class="comment">//        careful about what Irql we are to make sure the memory mgmt</span>
00711     <span class="comment">//        stuff will all work</span>
00712     <span class="comment">//</span>
00713 
00714     <span class="keywordflow">if</span>( !AddressSpace ){
00715         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00716         <span class="keywordflow">goto</span> SendReadIoSpaceExtendedResponse;
00717     }
00718 
00719     <span class="comment">//</span>
00720     <span class="comment">// Do the IO space read using the appropriate HAL routines based upon</span>
00721     <span class="comment">// the original address space and the data size requested.</span>
00722     <span class="comment">//</span>
00723 
00724     <span class="keywordflow">if</span>( !SavedAddressSpace ){
00725 
00726         <span class="comment">//</span>
00727         <span class="comment">// Memory (buffer) space on the bus</span>
00728         <span class="comment">//</span>
00729 
00730         <span class="keywordflow">switch</span>( DataSize ){
00731 
00732         <span class="keywordflow">case</span> 1:
00733             a-&gt;DataValue = READ_REGISTER_UCHAR( (PUCHAR)(ULONG_PTR) TranslatedAddress.QuadPart );
00734             <span class="keywordflow">break</span>;
00735 
00736         <span class="keywordflow">case</span> 2:
00737             a-&gt;DataValue = READ_REGISTER_USHORT((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(ULONG_PTR) TranslatedAddress.QuadPart );
00738             <span class="keywordflow">break</span>;
00739 
00740         <span class="keywordflow">case</span> 4:
00741             a-&gt;DataValue = READ_REGISTER_ULONG((PULONG)(ULONG_PTR) TranslatedAddress.QuadPart );
00742             <span class="keywordflow">break</span>;
00743 
00744         <span class="keywordflow">default</span>:
00745             m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00746         }
00747 
00748     } <span class="keywordflow">else</span> {
00749 
00750         <span class="comment">//</span>
00751         <span class="comment">// I/O space on the bus</span>
00752         <span class="comment">//</span>
00753 
00754         <span class="keywordflow">switch</span>( DataSize ){
00755 
00756         <span class="keywordflow">case</span> 1:
00757             a-&gt;DataValue = READ_PORT_UCHAR( (PUCHAR)(ULONG_PTR) TranslatedAddress.QuadPart );
00758             <span class="keywordflow">break</span>;
00759 
00760         <span class="keywordflow">case</span> 2:
00761             a-&gt;DataValue = READ_PORT_USHORT( (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(ULONG_PTR) TranslatedAddress.QuadPart );
00762             <span class="keywordflow">break</span>;
00763 
00764         <span class="keywordflow">case</span> 4:
00765             a-&gt;DataValue = READ_PORT_ULONG( (PULONG)(ULONG_PTR) TranslatedAddress.QuadPart );
00766             <span class="keywordflow">break</span>;
00767 
00768         <span class="keywordflow">default</span>:
00769             m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00770         }
00771     }
00772 
00773 
00774 
00775 SendReadIoSpaceExtendedResponse:
00776 
00777     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00778         PACKET_TYPE_KD_STATE_MANIPULATE,
00779         &amp;MessageHeader,
00780         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00781         );
00782 }
00783 
00784 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00785"></a><a class="code" href="../../d1/d7/4_2kdp_8h.html#a136">00785</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a136">KdpWriteIoSpace</a> (
00786     IN PDBGKD_MANIPULATE_STATE64 m,
00787     IN PSTRING AdditionalData,
00788     IN PCONTEXT Context
00789     )
00790 
00791 <span class="comment">/*++</span>
00792 <span class="comment"></span>
00793 <span class="comment">Routine Description:</span>
00794 <span class="comment"></span>
00795 <span class="comment">    This function is called in response of a read io space state</span>
00796 <span class="comment">    manipulation message.  Its function is to read system io</span>
00797 <span class="comment">    locations.</span>
00798 <span class="comment"></span>
00799 <span class="comment">Arguments:</span>
00800 <span class="comment"></span>
00801 <span class="comment">    m - Supplies the state manipulation message.</span>
00802 <span class="comment"></span>
00803 <span class="comment">    AdditionalData - Supplies any additional data for the message.</span>
00804 <span class="comment"></span>
00805 <span class="comment">    Context - Supplies the current context.</span>
00806 <span class="comment"></span>
00807 <span class="comment">Return Value:</span>
00808 <span class="comment"></span>
00809 <span class="comment">    None.</span>
00810 <span class="comment"></span>
00811 <span class="comment">--*/</span>
00812 
00813 {
00814     PDBGKD_READ_WRITE_IO64 a = &amp;m-&gt;u.ReadWriteIo;
00815     STRING MessageHeader;
00816     INTERFACE_TYPE <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
00817     ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00818     PHYSICAL_ADDRESS IoAddress;
00819     PHYSICAL_ADDRESS TranslatedAddress;
00820     ULONG AddressSpace;
00821     ULONG DataSize;
00822     ULONG Value;
00823 
00824     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00825     MessageHeader.Buffer = (PCHAR)m;
00826 
00827     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
00828 
00829     m-&gt;ReturnStatus = STATUS_SUCCESS;
00830 
00831     <span class="comment">//</span>
00832     <span class="comment">// Capture the input parameters and use the default values for those</span>
00833     <span class="comment">// parameters not specified in the Api.</span>
00834     <span class="comment">//</span>
00835 
00836     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> = Isa;
00837     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = 0;
00838     AddressSpace = 1;
00839     IoAddress.QuadPart = (ULONG_PTR)a-&gt;IoAddress;
00840     DataSize = a-&gt;DataSize;
00841     Value = a-&gt;DataValue;
00842 
00843     <span class="comment">//</span>
00844     <span class="comment">// Translate the bus address to the physical system address</span>
00845     <span class="comment">// or QVA.</span>
00846     <span class="comment">//</span>
00847 
00848     <span class="keywordflow">if</span>( !<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>( <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>,
00849                                  <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>,
00850                                  IoAddress,
00851                                  &amp;AddressSpace,
00852                                  &amp;TranslatedAddress ) ){
00853         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00854         <span class="keywordflow">goto</span> SendWriteIoSpaceResponse;
00855     }
00856 
00857     <span class="comment">//</span>
00858     <span class="comment">// N.B. - for the moment we will only support QVAs ie. when AddressSpace</span>
00859     <span class="comment">//        is one.  It may be in later systems that we will have to</span>
00860     <span class="comment">//        check the address space, map it, perform the virtual read</span>
00861     <span class="comment">//        unmap, and then return the data - only we will have to be</span>
00862     <span class="comment">//        careful about what Irql we are to make sure the memory mgmt</span>
00863     <span class="comment">//        stuff will all work</span>
00864     <span class="comment">//</span>
00865 
00866     <span class="keywordflow">if</span>( !AddressSpace ){
00867         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00868         <span class="keywordflow">goto</span> SendWriteIoSpaceResponse;
00869     }
00870 
00871     <span class="comment">//</span>
00872     <span class="comment">// Do the IO space read using the appropriate HAL routines based upon</span>
00873     <span class="comment">// the default address space (io) and the data size requested.</span>
00874     <span class="comment">//</span>
00875 
00876     <span class="keywordflow">switch</span>( DataSize ){
00877 
00878     <span class="keywordflow">case</span> 1:
00879         WRITE_PORT_UCHAR( (PUCHAR)TranslatedAddress.QuadPart, (UCHAR)Value );
00880         <span class="keywordflow">break</span>;
00881 
00882     <span class="keywordflow">case</span> 2:
00883         WRITE_PORT_USHORT( (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)TranslatedAddress.QuadPart, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Value );
00884         <span class="keywordflow">break</span>;
00885 
00886     <span class="keywordflow">case</span> 4:
00887         WRITE_PORT_ULONG( (PULONG)TranslatedAddress.QuadPart, Value );
00888         <span class="keywordflow">break</span>;
00889 
00890     <span class="keywordflow">default</span>:
00891         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00892     }
00893 
00894 
00895 SendWriteIoSpaceResponse:
00896 
00897     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00898         PACKET_TYPE_KD_STATE_MANIPULATE,
00899         &amp;MessageHeader,
00900         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00901         );
00902 }
00903 
00904 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00905"></a><a class="code" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a9">00905</a> <a class="code" href="../../d7/d7/4_2axp64_2kdpcpu_8h.html#a11">KdpWriteIoSpaceExtended</a> (
00906     IN PDBGKD_MANIPULATE_STATE64 m,
00907     IN PSTRING AdditionalData,
00908     IN PCONTEXT Context
00909     )
00910 
00911 <span class="comment">/*++</span>
00912 <span class="comment"></span>
00913 <span class="comment">Routine Description:</span>
00914 <span class="comment"></span>
00915 <span class="comment">    This function is called in response of a read io space extended state</span>
00916 <span class="comment">    manipulation message.  Its function is to read system io</span>
00917 <span class="comment">    locations.</span>
00918 <span class="comment"></span>
00919 <span class="comment">Arguments:</span>
00920 <span class="comment"></span>
00921 <span class="comment">    m - Supplies the state manipulation message.</span>
00922 <span class="comment"></span>
00923 <span class="comment">    AdditionalData - Supplies any additional data for the message.</span>
00924 <span class="comment"></span>
00925 <span class="comment">    Context - Supplies the current context.</span>
00926 <span class="comment"></span>
00927 <span class="comment">Return Value:</span>
00928 <span class="comment"></span>
00929 <span class="comment">    None.</span>
00930 <span class="comment"></span>
00931 <span class="comment">--*/</span>
00932 
00933 {
00934     PDBGKD_READ_WRITE_IO_EXTENDED64 a = &amp;m-&gt;u.ReadWriteIoExtended;
00935     ULONG Length;
00936     STRING MessageHeader;
00937     PUCHAR b;
00938     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> s;
00939     PULONG l;
00940     ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00941     ULONG AddressSpace;
00942     ULONG SavedAddressSpace;
00943     PHYSICAL_ADDRESS IoAddress;
00944     ULONG DataSize;
00945     PHYSICAL_ADDRESS TranslatedAddress;
00946     INTERFACE_TYPE <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
00947     ULONG Value;
00948 
00949     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00950     MessageHeader.Buffer = (PCHAR)m;
00951 
00952     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
00953 
00954     m-&gt;ReturnStatus = STATUS_SUCCESS;
00955 
00956     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> = a-&gt;InterfaceType;
00957     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = a-&gt;BusNumber;
00958     AddressSpace = SavedAddressSpace = a-&gt;AddressSpace;
00959     IoAddress.QuadPart = (ULONG_PTR)a-&gt;IoAddress;
00960     DataSize = a-&gt;DataSize;
00961     Value = a-&gt;DataValue;
00962 
00963     <span class="comment">//</span>
00964     <span class="comment">// Translate the bus address to the physical system address</span>
00965     <span class="comment">// or QVA.</span>
00966     <span class="comment">//</span>
00967 
00968     <span class="keywordflow">if</span>( !<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>( <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>,
00969                                  <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>,
00970                                  IoAddress,
00971                                  &amp;AddressSpace,
00972                                  &amp;TranslatedAddress ) ){
00973         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00974         <span class="keywordflow">goto</span> SendWriteIoSpaceExtendedResponse;
00975     }
00976 
00977     <span class="comment">//</span>
00978     <span class="comment">// N.B. - for the moment we will only support QVAs ie. when AddressSpace</span>
00979     <span class="comment">//        is one.  It may be in later systems that we will have to</span>
00980     <span class="comment">//        check the address space, map it, perform the virtual read</span>
00981     <span class="comment">//        unmap, and then return the data - only we will have to be</span>
00982     <span class="comment">//        careful about what Irql we are to make sure the memory mgmt</span>
00983     <span class="comment">//        stuff will all work</span>
00984     <span class="comment">//</span>
00985 
00986     <span class="keywordflow">if</span>( !AddressSpace ){
00987         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00988         <span class="keywordflow">goto</span> SendWriteIoSpaceExtendedResponse;
00989     }
00990 
00991     <span class="comment">//</span>
00992     <span class="comment">// Do the IO space read using the appropriate HAL routines based upon</span>
00993     <span class="comment">// the original address space and the data size requested.</span>
00994     <span class="comment">//</span>
00995 
00996     <span class="keywordflow">if</span>( !SavedAddressSpace ){
00997 
00998         <span class="comment">//</span>
00999         <span class="comment">// Memory (buffer) space on the bus</span>
01000         <span class="comment">//</span>
01001 
01002         <span class="keywordflow">switch</span>( DataSize ){
01003 
01004         <span class="keywordflow">case</span> 1:
01005             WRITE_REGISTER_UCHAR( (PUCHAR)TranslatedAddress.QuadPart, (UCHAR)Value );
01006             <span class="keywordflow">break</span>;
01007 
01008         <span class="keywordflow">case</span> 2:
01009             WRITE_REGISTER_USHORT( (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)TranslatedAddress.QuadPart, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Value );
01010             <span class="keywordflow">break</span>;
01011 
01012         <span class="keywordflow">case</span> 4:
01013             WRITE_REGISTER_ULONG( (PULONG)TranslatedAddress.QuadPart, Value );
01014             <span class="keywordflow">break</span>;
01015 
01016         <span class="keywordflow">default</span>:
01017             m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
01018         }
01019 
01020     } <span class="keywordflow">else</span> {
01021 
01022         <span class="comment">//</span>
01023         <span class="comment">// I/O space on the bus</span>
01024         <span class="comment">//</span>
01025 
01026         <span class="keywordflow">switch</span>( DataSize ){
01027 
01028         <span class="keywordflow">case</span> 1:
01029             WRITE_PORT_UCHAR( (PUCHAR)TranslatedAddress.QuadPart, (UCHAR)Value );
01030             <span class="keywordflow">break</span>;
01031 
01032         <span class="keywordflow">case</span> 2:
01033             WRITE_PORT_USHORT( (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)TranslatedAddress.QuadPart, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Value);
01034             <span class="keywordflow">break</span>;
01035 
01036         <span class="keywordflow">case</span> 4:
01037             WRITE_PORT_ULONG( (PULONG)TranslatedAddress.QuadPart, Value );
01038             <span class="keywordflow">break</span>;
01039 
01040         <span class="keywordflow">default</span>:
01041             m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
01042         }
01043     }
01044 
01045 
01046 
01047 SendWriteIoSpaceExtendedResponse:
01048 
01049     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
01050         PACKET_TYPE_KD_STATE_MANIPULATE,
01051         &amp;MessageHeader,
01052         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01053         );
01054 }
01055 
01056 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01057"></a><a class="code" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a10">01057</a> <a class="code" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a10">KdpGetBusData</a> (
01058     IN PDBGKD_MANIPULATE_STATE64 m,
01059     IN PSTRING AdditionalData,
01060     IN PCONTEXT Context
01061     )
01062 
01063 <span class="comment">/*++</span>
01064 <span class="comment"></span>
01065 <span class="comment">Routine Description:</span>
01066 <span class="comment"></span>
01067 <span class="comment">    This function is called in response to a get bus data state</span>
01068 <span class="comment">    manipulation message.  Its function is to read I/O configuration</span>
01069 <span class="comment">    space.</span>
01070 <span class="comment"></span>
01071 <span class="comment">Arguments:</span>
01072 <span class="comment"></span>
01073 <span class="comment">    m - Supplies the state manipulation message.</span>
01074 <span class="comment"></span>
01075 <span class="comment">    AdditionalData - Supplies any additional data for the message.</span>
01076 <span class="comment"></span>
01077 <span class="comment">    Context - Supplies the current context.</span>
01078 <span class="comment"></span>
01079 <span class="comment">Return Value:</span>
01080 <span class="comment"></span>
01081 <span class="comment">    None.</span>
01082 <span class="comment"></span>
01083 <span class="comment">--*/</span>
01084 
01085 {
01086     PDBGKD_GET_SET_BUS_DATA a = &amp;m-&gt;u.GetSetBusData;
01087     ULONG Length;
01088     STRING MessageHeader;
01089 
01090     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
01091     MessageHeader.Buffer = (PCHAR)m;
01092 
01093     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
01094 
01095     m-&gt;ReturnStatus = STATUS_SUCCESS;
01096 
01097     <span class="comment">//</span>
01098     <span class="comment">// Trim length to fit in a single message</span>
01099     <span class="comment">//</span>
01100 
01101     <span class="keywordflow">if</span> (a-&gt;Length &gt; (PACKET_MAX_SIZE - <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64))) {
01102         Length = PACKET_MAX_SIZE - <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64);
01103     } <span class="keywordflow">else</span> {
01104         Length = a-&gt;Length;
01105     }
01106 
01107     <span class="comment">//</span>
01108     <span class="comment">// Get the bus data.</span>
01109     <span class="comment">//</span>
01110 
01111     Length = <a class="code" href="../../d2/d7/hal_8h.html#a187">HalGetBusDataByOffset</a>(
01112                  a-&gt;BusDataType,
01113                  a-&gt;BusNumber,
01114                  a-&gt;SlotNumber,
01115                  AdditionalData-&gt;Buffer,
01116                  a-&gt;Offset,
01117                  Length
01118              );
01119 
01120     <span class="comment">//</span>
01121     <span class="comment">// Update the data length.</span>
01122     <span class="comment">//</span>
01123 
01124     a-&gt;Length = Length;
01125 
01126     AdditionalData-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
01127 
01128     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
01129         PACKET_TYPE_KD_STATE_MANIPULATE,
01130         &amp;MessageHeader,
01131         AdditionalData
01132         );
01133 }
01134 
01135 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01136"></a><a class="code" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a11">01136</a> <a class="code" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a11">KdpSetBusData</a> (
01137     IN PDBGKD_MANIPULATE_STATE64 m,
01138     IN PSTRING AdditionalData,
01139     IN PCONTEXT Context
01140     )
01141 
01142 <span class="comment">/*++</span>
01143 <span class="comment"></span>
01144 <span class="comment">Routine Description:</span>
01145 <span class="comment"></span>
01146 <span class="comment">    This function is called in response to a set bus data state</span>
01147 <span class="comment">    manipulation message.  Its function is to write I/O configuration</span>
01148 <span class="comment">    space.</span>
01149 <span class="comment"></span>
01150 <span class="comment">Arguments:</span>
01151 <span class="comment"></span>
01152 <span class="comment">    m - Supplies the state manipulation message.</span>
01153 <span class="comment"></span>
01154 <span class="comment">    AdditionalData - Supplies any additional data for the message.</span>
01155 <span class="comment"></span>
01156 <span class="comment">    Context - Supplies the current context.</span>
01157 <span class="comment"></span>
01158 <span class="comment">Return Value:</span>
01159 <span class="comment"></span>
01160 <span class="comment">    None.</span>
01161 <span class="comment"></span>
01162 <span class="comment">--*/</span>
01163 
01164 {
01165     PDBGKD_GET_SET_BUS_DATA a = &amp;m-&gt;u.GetSetBusData;
01166     ULONG Length;
01167     STRING MessageHeader;
01168 
01169     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
01170     MessageHeader.Buffer = (PCHAR)m;
01171 
01172     m-&gt;ReturnStatus = STATUS_SUCCESS;
01173 
01174     <span class="comment">//</span>
01175     <span class="comment">// Get the bus data.</span>
01176     <span class="comment">//</span>
01177 
01178     Length = <a class="code" href="../../d2/d7/hal_8h.html#a183">HalSetBusDataByOffset</a>(
01179                  a-&gt;BusDataType,
01180                  a-&gt;BusNumber,
01181                  a-&gt;SlotNumber,
01182                  AdditionalData-&gt;Buffer,
01183                  a-&gt;Offset,
01184                  a-&gt;Length
01185              );
01186 
01187     <span class="comment">//</span>
01188     <span class="comment">// Update the data length.</span>
01189     <span class="comment">//</span>
01190 
01191     a-&gt;Length = Length;
01192 
01193     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
01194         PACKET_TYPE_KD_STATE_MANIPULATE,
01195         &amp;MessageHeader,
01196         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01197         );
01198 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
