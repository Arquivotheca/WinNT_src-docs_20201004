<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pctohdr.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pctohdr.c File Reference</h1><code>#include &lt;nt.h&gt;</code><br>
<code>#include &lt;ntrtl.h&gt;</code><br>
<code>#include &lt;nturtl.h&gt;</code><br>

<p>
<a href="../../d7/d3/pctohdr_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d4/pctohdr_8c.html#a1">RtlPcToFileHeader</a> (IN PVOID PcValue, OUT PVOID *BaseOfImage)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d4/pctohdr_8c.html#a0">NtDllBase</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="pctohdr.c::RtlPcToFileHeader" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID RtlPcToFileHeader           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>PcValue</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseOfImage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d3/pctohdr_8c-source.html#l00042">42</a> of file <a class="el" href="../../d7/d3/pctohdr_8c-source.html">pctohdr.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00045">NtDllBase</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00061">NtQueryVirtualMemory()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00080">PsLoadedModuleSpinLock</a>, and <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>.
<p>
Referenced by <a class="el" href="../../d8/d8/ia64_2exdsptch_8c-source.html#l00184">RtlLookupFunctionEntry()</a>, and <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l02421">RtlLookupStaticFunctionEntry()</a>.
<p>
<pre class="fragment"><div>00049                    :
00050 
00051     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of an image that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00052     specified PcValue. An image contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PcValue <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PcValue
00053     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ImageBase, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ImageBase plus <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00054     <span class="keyword">virtual</span> image.
00055 
00056 Arguments:
00057 
00058     PcValue - Supplies a PcValue.  All of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modules mapped into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00059         calling processes address space are scanned to compute which
00060         module contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PcValue.
00061 
00062     BaseOfImage - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00063         PcValue.  This value must be added to any relative addresses in
00064         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> headers to locate portions of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image.
00065 
00066 Return Value:
00067 
00068     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - No image was found that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PcValue.
00069 
00070     NON-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image that contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00071         PcValue.
00072 
00073 --*/
00074 
00075 {
00076 
00077 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00078 <span class="preprocessor"></span>
00079     <span class="keyword">extern</span> LIST_ENTRY <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>;
00080     <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a18">PsLoadedModuleSpinLock</a>;
00081 
00082     PVOID Base;
00083     ULONG_PTR Bounds;
00084     PLDR_DATA_TABLE_ENTRY Entry;
00085     PLIST_ENTRY Next;
00086     KIRQL OldIrql;
00087 
00088     <span class="comment">//</span>
00089     <span class="comment">// Acquire the loaded module list spinlock and scan the list for the</span>
00090     <span class="comment">// specified PC value if the list has been initialized.</span>
00091     <span class="comment">//</span>
00092 
00093     ExAcquireSpinLock(&amp;PsLoadedModuleSpinLock, &amp;OldIrql);
00094     Next = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
00095     <span class="keywordflow">if</span> (Next != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00096         <span class="keywordflow">while</span> (Next != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
00097             Entry = CONTAINING_RECORD(Next,
00098                                       LDR_DATA_TABLE_ENTRY,
00099                                       InLoadOrderLinks);
00100 
00101             Next = Next-&gt;Flink;
00102             Base = Entry-&gt;DllBase;
00103             Bounds = (ULONG_PTR)Base + Entry-&gt;SizeOfImage;
00104             <span class="keywordflow">if</span> (((ULONG_PTR)PcValue &gt;= (ULONG_PTR)Base) &amp;&amp; ((ULONG_PTR)PcValue &lt; Bounds)) {
00105                 ExReleaseSpinLock(&amp;PsLoadedModuleSpinLock, OldIrql);
00106                 *BaseOfImage = Base;
00107                 <span class="keywordflow">return</span> Base;
00108             }
00109         }
00110     }
00111 
00112     <span class="comment">//</span>
00113     <span class="comment">// Release the loaded module list spin lock and return NULL.</span>
00114     <span class="comment">//</span>
00115 
00116     ExReleaseSpinLock(&amp;PsLoadedModuleSpinLock, OldIrql);
00117     *BaseOfImage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00118     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00119 
00120 <span class="preprocessor">#else</span>
00121 <span class="preprocessor"></span>
00122     PVOID Base;
00123     ULONG_PTR Bounds;
00124     PLDR_DATA_TABLE_ENTRY Entry;
00125     PLIST_ENTRY ModuleListHead;
00126     PLIST_ENTRY Next;
00127     PIMAGE_NT_HEADERS NtHeaders;
00128     PPEB Peb;
00129     PTEB Teb;
00130     MEMORY_BASIC_INFORMATION MemInfo;
00131     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00132 
00133     <span class="comment">//</span>
00134     <span class="comment">// Acquire the Loader lock for the current process and scan the loaded</span>
00135     <span class="comment">// module list for the specified PC value if all the data structures</span>
00136     <span class="comment">// have been initialized.</span>
00137     <span class="comment">//</span>
00138 
00139     <span class="keywordflow">if</span> ( !RtlTryEnterCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock) ) {
00140 
00141         <span class="comment">//</span>
00142         <span class="comment">// We could not get the loader lock, so call the system to find the image that</span>
00143         <span class="comment">// contains this pc</span>
00144         <span class="comment">//</span>
00145 
00146         st = <a class="code" href="../../d5/d3/queryvm_8c.html#a4">NtQueryVirtualMemory</a>(
00147                 NtCurrentProcess(),
00148                 PcValue,
00149                 MemoryBasicInformation,
00150                 (PVOID)&amp;MemInfo,
00151                 <span class="keyword">sizeof</span>(MemInfo),
00152                 NULL
00153                 );
00154         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00155             MemInfo.AllocationBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;;
00156             }
00157         <span class="keywordflow">else</span> {
00158             <span class="keywordflow">if</span> ( MemInfo.Type == MEM_IMAGE ) {
00159                 <span class="keywordflow">try</span> {
00160                     *BaseOfImage = MemInfo.AllocationBase;
00161                     }
00162                 except (EXCEPTION_EXECUTE_HANDLER) {
00163                     MemInfo.AllocationBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00164                     }
00165                 }
00166             <span class="keywordflow">else</span> {
00167                 MemInfo.AllocationBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;;
00168                 }
00169             }
00170         <span class="keywordflow">return</span> MemInfo.AllocationBase;
00171         }
00172 
00173     <span class="keywordflow">try</span> {
00174         Teb = NtCurrentTeb();
00175         <span class="keywordflow">if</span> (Teb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00176             Peb = Teb-&gt;ProcessEnvironmentBlock;
00177             <span class="keywordflow">if</span> (Peb-&gt;Ldr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00178                 ModuleListHead = &amp;Peb-&gt;Ldr-&gt;InLoadOrderModuleList;
00179                 Next = ModuleListHead-&gt;Flink;
00180                 <span class="keywordflow">if</span> (Next != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00181                     <span class="keywordflow">while</span> (Next != ModuleListHead) {
00182                         Entry = CONTAINING_RECORD(Next,
00183                                                   LDR_DATA_TABLE_ENTRY,
00184                                                   InLoadOrderLinks);
00185 
00186                         Next = Next-&gt;Flink;
00187                         Base = Entry-&gt;DllBase;
00188                         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
00189                         Bounds = (ULONG_PTR)Base + NtHeaders-&gt;OptionalHeader.SizeOfImage;
00190                         <span class="keywordflow">if</span> (((ULONG_PTR)PcValue &gt;= (ULONG_PTR)Base) &amp;&amp; ((ULONG_PTR)PcValue &lt; Bounds)) {
00191                             RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
00192                             *BaseOfImage = Base;
00193                             <span class="keywordflow">return</span> Base;
00194                         }
00195                     }
00196                 }
00197 
00198             } <span class="keywordflow">else</span> {
00199 
00200                 <span class="comment">//</span>
00201                 <span class="comment">//  ( Peb-&gt;Ldr == NULL )</span>
00202                 <span class="comment">//</span>
00203                 <span class="comment">//  If called during process intialization before the Ldr</span>
00204                 <span class="comment">//  module list has been setup, code executing must be in</span>
00205                 <span class="comment">//  NTDLL module.  If NtDllBase is non-NULL and the PcValue</span>
00206                 <span class="comment">//  falls into the NTDLL range, return a valid Base.  This</span>
00207                 <span class="comment">//  allows DbgPrint's during LdrpInitializeProcess to work</span>
00208                 <span class="comment">//  on RISC machines.</span>
00209                 <span class="comment">//</span>
00210 
00211                 <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a5">NtDllBase</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00212                     Base = <a class="code" href="../../d8/d2/ldrinit_8c.html#a5">NtDllBase</a>;
00213                     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( Base );
00214                     Bounds = (ULONG_PTR)Base + NtHeaders-&gt;OptionalHeader.SizeOfImage;
00215                     <span class="keywordflow">if</span> (((ULONG_PTR)PcValue &gt;= (ULONG_PTR)Base) &amp;&amp; ((ULONG_PTR)PcValue &lt; Bounds)) {
00216                         RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
00217                         *BaseOfImage = Base;
00218                         <span class="keywordflow">return</span> Base;
00219                     }
00220                 }
00221             }
00222         }
00223 
00224     } except(EXCEPTION_EXECUTE_HANDLER) {
00225         NOTHING;
00226     }
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">// Release the Loader lock for the current process a return NULL.</span>
00230     <span class="comment">//</span>
00231 
00232     RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
00233     *BaseOfImage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00234     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00235 
00236 <span class="preprocessor">#endif</span>
00237 <span class="preprocessor"></span>
00238 }
}
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="pctohdr.c::NtDllBase" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d6/d4/pctohdr_8c.html#a0">NtDllBase</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d3/pctohdr_8c-source.html#l00037">37</a> of file <a class="el" href="../../d7/d3/pctohdr_8c-source.html">pctohdr.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00106">CsrClientConnectToServer()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d7/d3/pctohdr_8c-source.html#l00042">RtlPcToFileHeader()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
