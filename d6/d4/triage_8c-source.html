<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: triage.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>triage.c</h1><a href="../../d5/d5/triage_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*++</span>
00003 <span class="comment"></span>
00004 <span class="comment">Copyright(c) 1999 Microsoft Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    triage.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    Triage dump support.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Matthew D. Hendel (math) 20-Jan-1999</span>
00017 <span class="comment"></span>
00018 <span class="comment">Comments:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Do not merge this file with some other file. By leaving it in it's own</span>
00021 <span class="comment">    compiland, we avoid having to link with all the other random variables</span>
00022 <span class="comment">    in crashlib.</span>
00023 <span class="comment"></span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00028 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00029 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00030 <span class="preprocessor">#include &lt;windef.h&gt;</span>
00031 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00032 <span class="preprocessor">#include &lt;malloc.h&gt;</span>
00033 <span class="preprocessor">#include &lt;ntiodump.h&gt;</span>
00034 <span class="preprocessor">#include &lt;triage.h&gt;</span>
00035 <span class="preprocessor">#include &lt;ntverp.h&gt;</span>
00036 
00037 
00038 <span class="preprocessor">#ifndef NtBuildNumber</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#  if DBG</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#    define NtBuildNumber   (VER_PRODUCTBUILD | 0xC0000000)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#  else</span>
<a name="l00042"></a><a class="code" href="../../d5/d5/triage_8c.html#a0">00042</a> <span class="preprocessor"></span><span class="preprocessor">#    define NtBuildNumber (VER_PRODUCTBUILD | 0xF0000000)</span>
00043 <span class="preprocessor"></span><span class="preprocessor"># endif</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00045 <span class="preprocessor"></span>
00046 
00047 <span class="comment">//</span>
00048 <span class="comment">// NOTE: Pages sizes copied from ntos\inc. These must be kept in sync with</span>
00049 <span class="comment">// global header files.</span>
00050 <span class="comment">//</span>
00051 
<a name="l00052"></a><a class="code" href="../../d5/d5/triage_8c.html#a1">00052</a> <span class="preprocessor">#define PAGE_SIZE_I386      0x1000</span>
<a name="l00053"></a><a class="code" href="../../d5/d5/triage_8c.html#a2">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define PAGE_SIZE_ALPHA     0x2000</span>
<a name="l00054"></a><a class="code" href="../../d5/d5/triage_8c.html#a3">00054</a> <span class="preprocessor"></span><span class="preprocessor">#define PAGE_SIZE_IA64      0x2000</span>
00055 <span class="preprocessor"></span>
00056 
<a name="l00057"></a><a class="code" href="../../d5/d5/triage_8c.html#a6">00057</a> ULONG <a class="code" href="../../d5/d5/triage_8c.html#a6">TriageImagePageSize</a> = -1;
00058 
00059 BOOLEAN
00060 <a class="code" href="../../d5/d5/triage_8c.html#a7">TriagepVerifyDump</a>(
00061     IN LPVOID TriageDumpBlock
00062     );
00063 
00064 ULONG
00065 <a class="code" href="../../d5/d5/triage_8c.html#a8">TriagepGetPageSize</a>(
00066     ULONG Architecture
00067     );
00068 
00069 PTRIAGE_DUMP_HEADER
00070 <a class="code" href="../../d5/d5/triage_8c.html#a9">TriagepGetTriagePointer</a>(
00071     IN PVOID TriageDumpBlock
00072     );
00073 
00074 
00075 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00076 <span class="preprocessor"></span>
00077 <span class="preprocessor">#pragma alloc_text (INIT, TriagepVerifyDump)</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text (INIT, TriagepGetPageSize)</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text (INIT, TriagepGetTriagePointer)</span>
00080 <span class="preprocessor"></span>
00081 <span class="preprocessor">#pragma alloc_text (INIT, TriageGetVersion)</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text (INIT, TriageGetDriverCount)</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text (INIT, TriageGetContext)</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text (INIT, TriageGetExceptionRecord)</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text (INIT, TriageGetBugcheckData)</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text (INIT, TriageGetDriverEntry)</span>
00087 <span class="preprocessor"></span>
00088 <span class="preprocessor">#endif</span>
00089 <span class="preprocessor"></span>
00090 
00091 <span class="comment">//++</span>
00092 <span class="comment">//</span>
00093 <span class="comment">// PULONG</span>
00094 <span class="comment">// IndexByUlong(</span>
00095 <span class="comment">//     PVOID Pointer,</span>
00096 <span class="comment">//     ULONG Index</span>
00097 <span class="comment">//     )</span>
00098 <span class="comment">//</span>
00099 <span class="comment">// Routine Description:</span>
00100 <span class="comment">//</span>
00101 <span class="comment">//     Return the address Index ULONGs into Pointer. That is,</span>
00102 <span class="comment">//     Index * sizeof (ULONG) bytes into Pointer.</span>
00103 <span class="comment">//</span>
00104 <span class="comment">// Arguments:</span>
00105 <span class="comment">//</span>
00106 <span class="comment">//     Pointer - Start of region.</span>
00107 <span class="comment">//</span>
00108 <span class="comment">//     Index - Number of ULONGs to index into.</span>
00109 <span class="comment">//</span>
00110 <span class="comment">// Return Value:</span>
00111 <span class="comment">//</span>
00112 <span class="comment">//     PULONG representing the pointer described above.</span>
00113 <span class="comment">//</span>
00114 <span class="comment">//--</span>
00115 
<a name="l00116"></a><a class="code" href="../../d5/d5/triage_8c.html#a4">00116</a> <span class="preprocessor">#define IndexByUlong(Pointer,Index) (&amp;(((ULONG*) (Pointer)) [Index]))</span>
00117 <span class="preprocessor"></span>
00118 
00119 <span class="comment">//++</span>
00120 <span class="comment">//</span>
00121 <span class="comment">// PBYTE</span>
00122 <span class="comment">// IndexByByte(</span>
00123 <span class="comment">//     PVOID Pointer,</span>
00124 <span class="comment">//     ULONG Index</span>
00125 <span class="comment">//     )</span>
00126 <span class="comment">//</span>
00127 <span class="comment">// Routine Description:</span>
00128 <span class="comment">//</span>
00129 <span class="comment">//     Return the address Index BYTEs into Pointer. That is,</span>
00130 <span class="comment">//     Index * sizeof (BYTE) bytes into Pointer.</span>
00131 <span class="comment">//</span>
00132 <span class="comment">// Arguments:</span>
00133 <span class="comment">//</span>
00134 <span class="comment">//     Pointer - Start of region.</span>
00135 <span class="comment">//</span>
00136 <span class="comment">//     Index - Number of BYTEs to index into.</span>
00137 <span class="comment">//</span>
00138 <span class="comment">// Return Value:</span>
00139 <span class="comment">//</span>
00140 <span class="comment">//     PBYTE representing the pointer described above.</span>
00141 <span class="comment">//</span>
00142 <span class="comment">//--</span>
00143 
<a name="l00144"></a><a class="code" href="../../d5/d5/triage_8c.html#a5">00144</a> <span class="preprocessor">#define IndexByByte(Pointer, Index) (&amp;(((BYTE*) (Pointer)) [Index]))</span>
00145 <span class="preprocessor"></span>
00146 
00147 ULONG
<a name="l00148"></a><a class="code" href="../../d5/d5/triage_8c.html#a8">00148</a> <a class="code" href="../../d5/d5/triage_8c.html#a8">TriagepGetPageSize</a>(
00149     ULONG Architecture
00150     )
00151 {
00152     <span class="keywordflow">switch</span> (Architecture) {
00153 
00154         <span class="keywordflow">case</span> IMAGE_FILE_MACHINE_I386:
00155             <span class="keywordflow">return</span> <a class="code" href="../../d5/d5/triage_8c.html#a1">PAGE_SIZE_I386</a>;
00156 
00157         <span class="keywordflow">case</span> IMAGE_FILE_MACHINE_ALPHA:
00158             <span class="keywordflow">return</span> <a class="code" href="../../d5/d5/triage_8c.html#a2">PAGE_SIZE_ALPHA</a>;
00159 
00160         <span class="keywordflow">case</span> IMAGE_FILE_MACHINE_IA64:
00161             <span class="keywordflow">return</span> <a class="code" href="../../d5/d5/triage_8c.html#a3">PAGE_SIZE_IA64</a>;
00162 
00163         <span class="keywordflow">default</span>:
00164             <span class="keywordflow">return</span> -1;
00165     }
00166 }
00167 
00168 
00169 
00170 BOOLEAN
<a name="l00171"></a><a class="code" href="../../d5/d5/triage_8c.html#a7">00171</a> <a class="code" href="../../d5/d5/triage_8c.html#a7">TriagepVerifyDump</a>(
00172     IN LPVOID TriageDumpBlock
00173     )
00174 {
00175     BOOLEAN Succ = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00176     PDUMP_HEADER DumpHeader = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00177     PTRIAGE_DUMP_HEADER TriageHeader = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00178 
00179     <span class="keywordflow">if</span> (!TriageDumpBlock) {
00180 
00181         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00182     }
00183     
00184     DumpHeader = (PDUMP_HEADER) TriageDumpBlock;
00185 
00186     <span class="keywordflow">try</span> {
00187     
00188         <span class="keywordflow">if</span> (DumpHeader-&gt;ValidDump != 'PMUD' ||
00189             DumpHeader-&gt;Signature != 'EGAP' ||
00190             <a class="code" href="../../d5/d5/triage_8c.html#a8">TriagepGetPageSize</a> (DumpHeader-&gt;MachineImageType) == -1) {
00191 
00192             Succ = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00193             leave;
00194         }
00195 
00196         <a class="code" href="../../d5/d5/triage_8c.html#a6">TriageImagePageSize</a> = <a class="code" href="../../d5/d5/triage_8c.html#a8">TriagepGetPageSize</a> (DumpHeader-&gt;MachineImageType);
00197         
00198         TriageHeader = (PTRIAGE_DUMP_HEADER)
00199             <a class="code" href="../../d2/d3/dumpctl_8c.html#a14">IndexByByte</a> ( TriageDumpBlock, <a class="code" href="../../d5/d5/triage_8c.html#a6">TriageImagePageSize</a> );
00200 
00201         <span class="keywordflow">if</span> ( *(ULONG*)<a class="code" href="../../d5/d5/triage_8c.html#a4">IndexByUlong</a> (DumpHeader, DH_DUMP_TYPE) != DUMP_TYPE_TRIAGE ||
00202              *(ULONG*)<a class="code" href="../../d2/d3/dumpctl_8c.html#a14">IndexByByte</a> (DumpHeader, TriageHeader-&gt;SizeOfDump - sizeof (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) != TRIAGE_DUMP_VALID ) {
00203 
00204             Succ = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00205             leave;
00206         }
00207 
00208         <span class="comment">// else</span>
00209 
00210         Succ = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00211     }
00212 
00213     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00214 
00215         Succ = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00216     }
00217 
00218     <span class="keywordflow">return</span> Succ;
00219 }
00220 
00221 
00222 PTRIAGE_DUMP_HEADER
<a name="l00223"></a><a class="code" href="../../d5/d5/triage_8c.html#a9">00223</a> <a class="code" href="../../d5/d5/triage_8c.html#a9">TriagepGetTriagePointer</a>(
00224     IN PVOID TriageDumpBlock
00225     )
00226 {
00227     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d5/triage_8c.html#a6">TriageImagePageSize</a> != -1);
00228     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d5/triage_8c.html#a7">TriagepVerifyDump</a> (TriageDumpBlock));
00229 
00230     <span class="keywordflow">return</span> (PTRIAGE_DUMP_HEADER) <a class="code" href="../../d2/d3/dumpctl_8c.html#a14">IndexByByte</a> (TriageDumpBlock, <a class="code" href="../../d5/d5/triage_8c.html#a6">TriageImagePageSize</a>);
00231 }
00232 
00233 
00234 
00235 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00236"></a><a class="code" href="../../d5/d5/triage_8c.html#a10">00236</a> <a class="code" href="../../d5/d5/triage_8c.html#a10">TriageGetVersion</a>(
00237     IN LPVOID TriageDumpBlock,
00238     OUT ULONG * MajorVersion,
00239     OUT ULONG * MinorVersion,
00240     OUT ULONG * ServicePackBuild
00241     )
00242 {
00243     PTRIAGE_DUMP_HEADER TriageDump;
00244     PDUMP_HEADER DumpHeader;
00245     
00246     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/triage_8c.html#a7">TriagepVerifyDump</a> (TriageDumpBlock)) {
00247         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00248     }
00249 
00250     TriageDump = <a class="code" href="../../d5/d5/triage_8c.html#a9">TriagepGetTriagePointer</a> (TriageDumpBlock);
00251 
00252     <span class="keywordflow">if</span> (!TriageDump) {
00253         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00254     }
00255 
00256     DumpHeader = (PDUMP_HEADER) TriageDumpBlock;
00257 
00258     <span class="keywordflow">if</span> (MajorVersion) {
00259         *MajorVersion = DumpHeader-&gt;MajorVersion;
00260     }
00261 
00262     <span class="keywordflow">if</span> (MinorVersion) {
00263         *MinorVersion = DumpHeader-&gt;MinorVersion;
00264     }
00265 
00266     <span class="keywordflow">if</span> (ServicePackBuild) {
00267         *ServicePackBuild = TriageDump-&gt;ServicePackBuild;
00268     }
00269 
00270     <span class="keywordflow">return</span> STATUS_SUCCESS;
00271 }
00272 
00273 
00274 
00275 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00276"></a><a class="code" href="../../d5/d5/triage_8c.html#a11">00276</a> <a class="code" href="../../d5/d5/triage_8c.html#a11">TriageGetDriverCount</a>(
00277     IN LPVOID TriageDumpBlock,
00278     OUT ULONG * DriverCount
00279     )
00280 {
00281     PTRIAGE_DUMP_HEADER TriageDump;
00282     
00283     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/triage_8c.html#a7">TriagepVerifyDump</a> (TriageDumpBlock)) {
00284         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00285     }
00286 
00287     TriageDump = <a class="code" href="../../d5/d5/triage_8c.html#a9">TriagepGetTriagePointer</a> (TriageDumpBlock);
00288 
00289     <span class="keywordflow">if</span> (!TriageDump) {
00290         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00291     }
00292 
00293     *DriverCount = TriageDump-&gt;DriverCount;
00294 
00295     <span class="keywordflow">return</span> STATUS_SUCCESS;
00296 }
00297 
00298     
00299 
00300 <span class="preprocessor">#if 0</span>
00301 <span class="preprocessor"></span>
00302 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00303 TriageGetContext(
00304     IN LPVOID TriageDumpBlock,
00305     OUT LPVOID Context,
00306     IN ULONG SizeInBytes
00307     )
00308 {
00309     PTRIAGE_DUMP_HEADER TriageDump;
00310     
00311     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/triage_8c.html#a7">TriagepVerifyDump</a> (TriageDumpBlock)) {
00312         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00313     }
00314 
00315     TriageDump = <a class="code" href="../../d5/d5/triage_8c.html#a9">TriagepGetTriagePointer</a> (TriageDumpBlock);
00316 
00317     <span class="keywordflow">if</span> (!TriageDump) {
00318         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00319     }
00320 
00321     <span class="comment">//</span>
00322     <span class="comment">// Copy the CONTEXT record.</span>
00323     <span class="comment">//</span>
00324 
00325     <span class="keywordflow">if</span> (SizeInBytes == -1) {
00326         SizeInBytes = <span class="keyword">sizeof</span> (CONTEXT);
00327     }
00328 
00329     RtlCopyMemory (Context,
00330                    IndexByUlong (TriageDumpBlock, TriageDump-&gt;ContextOffset),
00331                    SizeInBytes
00332                    );
00333 
00334     <span class="keywordflow">return</span> STATUS_SUCCESS;
00335 }
00336 
00337 
00338 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00339 TriageGetExceptionRecord(
00340     IN LPVOID TriageDumpBlock,
00341     OUT EXCEPTION_RECORD * ExceptionRecord
00342     )
00343 {
00344     PTRIAGE_DUMP_HEADER TriageDump;
00345     
00346     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/triage_8c.html#a7">TriagepVerifyDump</a> (TriageDumpBlock)) {
00347         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00348     }
00349 
00350     TriageDump = <a class="code" href="../../d5/d5/triage_8c.html#a9">TriagepGetTriagePointer</a> (TriageDumpBlock);
00351 
00352     <span class="keywordflow">if</span> (!TriageDump) {
00353         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00354     }
00355 
00356     RtlCopyMemory (ExceptionRecord,
00357                    IndexByUlong (TriageDumpBlock, TriageDump-&gt;ExceptionOffset),
00358                    sizeof (*ExceptionRecord)
00359                    );
00360 
00361     <span class="keywordflow">return</span> STATUS_SUCCESS;
00362 }
00363 <span class="preprocessor">#endif</span>
00364 <span class="preprocessor"></span>
00365 
00366 LOGICAL
<a name="l00367"></a><a class="code" href="../../d5/d5/triage_8c.html#a12">00367</a> <a class="code" href="../../d5/d5/triage_8c.html#a12">TriageActUpon</a>(
00368     IN PVOID TriageDumpBlock
00369     )
00370 {
00371     PTRIAGE_DUMP_HEADER TriageDump;
00372     
00373     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/triage_8c.html#a7">TriagepVerifyDump</a> (TriageDumpBlock)) {
00374         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00375     }
00376 
00377     TriageDump = <a class="code" href="../../d5/d5/triage_8c.html#a9">TriagepGetTriagePointer</a> (TriageDumpBlock);
00378 
00379     <span class="keywordflow">if</span> (!TriageDump) {
00380         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00381     }
00382     
00383     <span class="keywordflow">if</span> ((TriageDump-&gt;TriageOptions &amp; <a class="code" href="../../d0/d6/iop_8h.html#a11">DCB_TRIAGE_DUMP_ACT_UPON_ENABLED</a>) == 0) {
00384         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00385     }
00386 
00387     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00388 }
00389 
00390 
00391 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00392"></a><a class="code" href="../../d5/d5/triage_8c.html#a13">00392</a> <a class="code" href="../../d5/d5/triage_8c.html#a13">TriageGetBugcheckData</a>(
00393     IN LPVOID TriageDumpBlock,
00394     OUT ULONG * BugCheckCode,
00395     OUT UINT_PTR * BugCheckParam1,
00396     OUT UINT_PTR * BugCheckParam2,
00397     OUT UINT_PTR * BugCheckParam3,
00398     OUT UINT_PTR * BugCheckParam4
00399     )
00400 {
00401     PDUMP_HEADER DumpHeader;
00402     
00403     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/triage_8c.html#a7">TriagepVerifyDump</a> (TriageDumpBlock)) {
00404         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00405     }
00406 
00407     DumpHeader = (PDUMP_HEADER) TriageDumpBlock;
00408     
00409     *BugCheckCode = DumpHeader-&gt;BugCheckCode;
00410     *BugCheckParam1 = DumpHeader-&gt;BugCheckParameter1;
00411     *BugCheckParam2 = DumpHeader-&gt;BugCheckParameter2;
00412     *BugCheckParam3 = DumpHeader-&gt;BugCheckParameter3;
00413     *BugCheckParam4 = DumpHeader-&gt;BugCheckParameter4;
00414 
00415     <span class="keywordflow">return</span> STATUS_SUCCESS;
00416 }
00417 
00418 
00419 
00420 PLDR_DATA_TABLE_ENTRY
<a name="l00421"></a><a class="code" href="../../d5/d5/triage_8c.html#a14">00421</a> <a class="code" href="../../d5/d5/triage_8c.html#a14">TriageGetLoaderEntry</a>(
00422     IN PVOID TriageDumpBlock,
00423     IN ULONG ModuleIndex
00424     )
00425 
00426 <span class="comment">/*++</span>
00427 <span class="comment"></span>
00428 <span class="comment">Routine Description:</span>
00429 <span class="comment"></span>
00430 <span class="comment">    This function retrieves a loaded module list entry.</span>
00431 <span class="comment"></span>
00432 <span class="comment">Arguments:</span>
00433 <span class="comment"></span>
00434 <span class="comment">    TriageDumpBlock - Supplies the triage dump to reference.</span>
00435 <span class="comment"></span>
00436 <span class="comment">    ModuleIndex - Supplies the driver index number to locate.</span>
00437 <span class="comment"></span>
00438 <span class="comment">Return Value:</span>
00439 <span class="comment"></span>
00440 <span class="comment">    A pointer to a loader data table entry if one is available, NULL if not.</span>
00441 <span class="comment"></span>
00442 <span class="comment">Environment:</span>
00443 <span class="comment"></span>
00444 <span class="comment">    Kernel mode, APC_LEVEL or below.  Phase 0 only.</span>
00445 <span class="comment"></span>
00446 <span class="comment">    N.B. This function is for use by memory management ONLY.</span>
00447 <span class="comment"></span>
00448 <span class="comment">--*/</span>
00449 
00450 {
00451     ULONG i;
00452     PDUMP_STRING DriverName;
00453     PDUMP_DRIVER_ENTRY DriverList;
00454     PTRIAGE_DUMP_HEADER TriageDump;
00455     PLDR_DATA_TABLE_ENTRY DataTableEntry;
00456 
00457     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/triage_8c.html#a7">TriagepVerifyDump</a> (TriageDumpBlock)) {
00458         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00459     }
00460 
00461     TriageDump = <a class="code" href="../../d5/d5/triage_8c.html#a9">TriagepGetTriagePointer</a> (TriageDumpBlock);
00462 
00463     <span class="keywordflow">if</span> (ModuleIndex &gt;= TriageDump-&gt;DriverCount) {
00464         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00465     }
00466     
00467     DriverList = (PDUMP_DRIVER_ENTRY)
00468             <a class="code" href="../../d2/d3/dumpctl_8c.html#a14">IndexByByte</a> (TriageDumpBlock, TriageDump-&gt;DriverListOffset);
00469 
00470         
00471     DataTableEntry = &amp;DriverList [ ModuleIndex ].LdrEntry;
00472 
00473     <span class="comment">//</span>
00474     <span class="comment">// Repoint the module driver name into the triage buffer.</span>
00475     <span class="comment">//</span>
00476 
00477     DriverName = (PDUMP_STRING)
00478             <a class="code" href="../../d2/d3/dumpctl_8c.html#a14">IndexByByte</a> (TriageDumpBlock,
00479                          DriverList [ ModuleIndex ].DriverNameOffset);
00480 
00481     DataTableEntry-&gt;BaseDllName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (DriverName-&gt;Length * <span class="keyword">sizeof</span> (WCHAR));
00482     DataTableEntry-&gt;BaseDllName.MaximumLength = DataTableEntry-&gt;BaseDllName.Length;
00483     DataTableEntry-&gt;BaseDllName.Buffer = DriverName-&gt;Buffer;
00484 
00485     <span class="keywordflow">return</span> DataTableEntry;
00486 }
00487 
00488 
00489 PVOID
<a name="l00490"></a><a class="code" href="../../d5/d5/triage_8c.html#a15">00490</a> <a class="code" href="../../d5/d5/triage_8c.html#a15">TriageGetMmInformation</a>(
00491     IN PVOID TriageDumpBlock
00492     )
00493 
00494 <span class="comment">/*++</span>
00495 <span class="comment"></span>
00496 <span class="comment">Routine Description:</span>
00497 <span class="comment"></span>
00498 <span class="comment">    This function retrieves a loaded module list entry.</span>
00499 <span class="comment"></span>
00500 <span class="comment">Arguments:</span>
00501 <span class="comment"></span>
00502 <span class="comment">    TriageDumpBlock - Supplies the triage dump to reference.</span>
00503 <span class="comment"></span>
00504 <span class="comment">Return Value:</span>
00505 <span class="comment"></span>
00506 <span class="comment">    A pointer to an opaque Mm information structure.</span>
00507 <span class="comment"></span>
00508 <span class="comment">Environment:</span>
00509 <span class="comment"></span>
00510 <span class="comment">    Kernel mode, APC_LEVEL or below.  Phase 0 only.</span>
00511 <span class="comment"></span>
00512 <span class="comment">    N.B. This function is for use by memory management ONLY.</span>
00513 <span class="comment"></span>
00514 <span class="comment">--*/</span>
00515 
00516 {
00517     PTRIAGE_DUMP_HEADER TriageDump;
00518     
00519     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/triage_8c.html#a7">TriagepVerifyDump</a> (TriageDumpBlock)) {
00520         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00521     }
00522 
00523     TriageDump = <a class="code" href="../../d5/d5/triage_8c.html#a9">TriagepGetTriagePointer</a> (TriageDumpBlock);
00524 
00525     <span class="keywordflow">if</span> (!TriageDump) {
00526         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00527     }
00528 
00529     <span class="keywordflow">return</span> (PVOID)<a class="code" href="../../d2/d3/dumpctl_8c.html#a14">IndexByByte</a> (TriageDumpBlock, TriageDump-&gt;MmOffset);
00530 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
