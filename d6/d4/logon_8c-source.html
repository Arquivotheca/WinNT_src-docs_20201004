<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: logon.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>logon.c</h1><a href="../../d5/d5/logon_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: logon.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Logon Support Routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 01-14-91 JimA         Created.</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 
00016 <span class="comment">/***************************************************************************\</span>
00017 <span class="comment">* _RegisterLogonProcess</span>
00018 <span class="comment">*</span>
00019 <span class="comment">* Register the logon process and set secure mode flag</span>
00020 <span class="comment">*</span>
00021 <span class="comment">* History:</span>
00022 <span class="comment">* 07-01-91 JimA         Created.</span>
00023 <span class="comment">\***************************************************************************/</span>
00024 
<a name="l00025"></a><a class="code" href="../../d4/d1/userk_8h.html#a1908">00025</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1908">_RegisterLogonProcess</a>(
00026     DWORD dwProcessId,
00027     BOOL fSecure)
00028 {
00029     UNREFERENCED_PARAMETER(fSecure);
00030 
00031     <span class="comment">/*</span>
00032 <span class="comment">     * Allow only one logon process and then only if it has TCB</span>
00033 <span class="comment">     * privilege.</span>
00034 <span class="comment">     */</span>
00035     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a> != 0 || !<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a22">IsPrivileged</a>(&amp;<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a248">psTcb</a>)) {
00036         RIPERR0(ERROR_ACCESS_DENIED,
00037                 RIP_WARNING,
00038                 <span class="stringliteral">"Access denied in _RegisterLogonProcess"</span>);
00039 
00040         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00041     }
00042 
00043     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a> = (HANDLE)LongToHandle( dwProcessId );
00044     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00045 }
00046 
00047 
00048 <span class="comment">/***************************************************************************\</span>
00049 <span class="comment">* _LockWindowStation</span>
00050 <span class="comment">*</span>
00051 <span class="comment">* Locks a windowstation and its desktops and returns the busy status.</span>
00052 <span class="comment">*</span>
00053 <span class="comment">* History:</span>
00054 <span class="comment">* 01-15-91 JimA         Created.</span>
00055 <span class="comment">\***************************************************************************/</span>
00056 
<a name="l00057"></a><a class="code" href="../../d4/d1/userk_8h.html#a1909">00057</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d1/userk_8h.html#a1909">_LockWindowStation</a>(
00058     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta)
00059 {
00060     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk;
00061     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fBusy = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00062 
00063     <span class="comment">/*</span>
00064 <span class="comment">     * Make sure the caller is the logon process</span>
00065 <span class="comment">     */</span>
00066     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a19">GetCurrentProcessId</a>() != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
00067         RIPERR0(ERROR_ACCESS_DENIED,
00068                 RIP_WARNING,
00069                 <span class="stringliteral">"Access denied in _LockWindowStation"</span>);
00070 
00071         <span class="keywordflow">return</span> WSS_ERROR;
00072     }
00073 
00074     <span class="comment">/*</span>
00075 <span class="comment">     * Prevent desktop switches</span>
00076 <span class="comment">     */</span>
00077     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a314">WSF_SWITCHLOCK</a>;
00078 
00079     <span class="comment">/*</span>
00080 <span class="comment">     * Determine whether the station is busy</span>
00081 <span class="comment">     */</span>
00082     pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>;
00083     <span class="keywordflow">while</span> (pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00084         <span class="keywordflow">if</span> (pdesk != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a> &amp;&amp;
00085                 <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pdesk)-&gt;HandleCount != 0) {
00086 
00087             <span class="comment">/*</span>
00088 <span class="comment">             * This desktop is open, thus the station is busy</span>
00089 <span class="comment">             */</span>
00090             fBusy = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00091             <span class="keywordflow">break</span>;
00092         }
00093         pdesk = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>;
00094     }
00095 
00096     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a317">WSF_SHUTDOWN</a>)
00097         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a315">WSF_OPENLOCK</a>;
00098 
00099     <span class="comment">/*</span>
00100 <span class="comment">     * Unlock opens if the station is busy and is not in the middle</span>
00101 <span class="comment">     * of shutting down.</span>
00102 <span class="comment">     */</span>
00103     <span class="keywordflow">if</span> (fBusy)
00104         <span class="keywordflow">return</span> WSS_BUSY;
00105     <span class="keywordflow">else</span>
00106         <span class="keywordflow">return</span> WSS_IDLE;
00107 }
00108 
00109 
00110 <span class="comment">/***************************************************************************\</span>
00111 <span class="comment">* _UnlockWindowStation</span>
00112 <span class="comment">*</span>
00113 <span class="comment">* Unlocks a windowstation locked by LogonLockWindowStation.</span>
00114 <span class="comment">*</span>
00115 <span class="comment">* History:</span>
00116 <span class="comment">* 01-15-91 JimA         Created.</span>
00117 <span class="comment">\***************************************************************************/</span>
00118 
<a name="l00119"></a><a class="code" href="../../d4/d1/userk_8h.html#a1910">00119</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1910">_UnlockWindowStation</a>(
00120     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta)
00121 {
00122 
00123     <span class="comment">/*</span>
00124 <span class="comment">     * Make sure the caller is the logon process</span>
00125 <span class="comment">     */</span>
00126     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a19">GetCurrentProcessId</a>() != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
00127         RIPERR0(ERROR_ACCESS_DENIED,
00128                 RIP_WARNING,
00129                 <span class="stringliteral">"Access denied in _UnlockWindowStation"</span>);
00130 
00131         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00132     }
00133 
00134     <span class="comment">/*</span>
00135 <span class="comment">     * If shutdown is occuring, only remove the switch lock.</span>
00136 <span class="comment">     */</span>
00137     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a317">WSF_SHUTDOWN</a>)
00138         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a314">WSF_SWITCHLOCK</a>;
00139     <span class="keywordflow">else</span>
00140         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp;= ~(<a class="code" href="../../d4/d1/userk_8h.html#a315">WSF_OPENLOCK</a> | <a class="code" href="../../d4/d1/userk_8h.html#a314">WSF_SWITCHLOCK</a>);
00141     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00142 }
00143 
00144 
00145 <span class="comment">/***************************************************************************\</span>
00146 <span class="comment">* _SetLogonNotifyWindow</span>
00147 <span class="comment">*</span>
00148 <span class="comment">* Register the window to notify when logon related events occur.</span>
00149 <span class="comment">*</span>
00150 <span class="comment">* History:</span>
00151 <span class="comment">* 01-13-92 JimA         Created.</span>
00152 <span class="comment">\***************************************************************************/</span>
<a name="l00153"></a><a class="code" href="../../d4/d1/userk_8h.html#a1913">00153</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1913">_SetLogonNotifyWindow</a>(
00154     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00155 {
00156     <span class="comment">/*</span>
00157 <span class="comment">     * Make sure the caller is the logon process</span>
00158 <span class="comment">     */</span>
00159     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a19">GetCurrentProcessId</a>() != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
00160         RIPERR0(ERROR_ACCESS_DENIED,
00161                 RIP_WARNING,
00162                 <span class="stringliteral">"Access denied in _SetLogonNotifyWindow"</span>);
00163 
00164         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00165     }
00166 
00167     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>, pwnd);
00168 
00169     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00170 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
