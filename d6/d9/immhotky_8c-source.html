<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: immhotky.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>immhotky.c</h1><a href="../../d5/d0/immhotky_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: immhotky.c (user32 side IME hotkey handling)</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* IME hot key management routines for imm32 dll</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 03-Jan-1996 hiroyama      Created</span>
00010 <span class="comment">\**************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 
<a name="l00016"></a><a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html">00016</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html">tagFE_KEYBOARDS</a> {
00017     BOOLEAN <a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html#o0">fJPN</a> : 1;
00018     BOOLEAN <a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html#o1">fCHT</a> : 1;
00019     BOOLEAN <a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html#o2">fCHS</a> : 1;
00020     BOOLEAN <a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html#o3">fKOR</a> : 1;
00021 } <a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html">FE_KEYBOARDS</a>;
00022 
00023 <span class="comment">/*</span>
00024 <span class="comment"> * Function pointers to registry routines in advapi32.dll.</span>
00025 <span class="comment"> */</span>
<a name="l00026"></a><a class="code" href="../../d8/d0/structADVAPI__FN.html">00026</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
00027     HMODULE hModule;
00028     LONG (WINAPI* RegCreateKeyW)(HKEY, LPCWSTR, PHKEY);
00029     LONG (WINAPI* RegOpenKeyW)(HKEY, LPCWSTR, PHKEY);
00030     LONG (WINAPI* RegCloseKey)(HKEY);
00031     LONG (WINAPI* RegDeleteKeyW)(HKEY, LPCWSTR);
00032     LONG (WINAPI* RegCreateKeyExW)(HKEY, LPCWSTR, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, LPWSTR, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, REGSAM, <a class="code" href="../../d6/d1/userrtl_8h.html#a30">LPSECURITY_ATTRIBUTES</a>, PHKEY, LPDWORD);
00033     LONG (WINAPI* RegSetValueExW)(HKEY, LPCWSTR, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Reserved, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, CONST <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00034     LONG (WINAPI* RegQueryValueExW)(HKEY, LPCWSTR, LPDWORD, LPDWORD, LPBYTE, LPDWORD);
00035 } <a class="code" href="../../d8/d0/structADVAPI__FN.html">ADVAPI_FN</a>;
00036 
00037 <span class="comment">//</span>
00038 <span class="comment">// internal functions</span>
00039 <span class="comment">//</span>
00040 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a16">CliSaveImeHotKey</a>(DWORD dwID, UINT uModifiers, UINT uVKey, HKL hkl, BOOL fDelete);
00041 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a17">CliImmSetHotKeyWorker</a>(DWORD dwID, UINT uModifiers, UINT uVKey, HKL hkl, DWORD dwAction);
00042 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a30">NumToHexAscii</a>(DWORD, PTSTR);
00043 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a19">CliGetImeHotKeysFromRegistry</a>(<span class="keywordtype">void</span>);
00044 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a20">CliSetSingleHotKey</a>(PKEY_BASIC_INFORMATION pKeyInfo, HANDLE hKey);
00045 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a21">CliSetDefaultImeHotKeys</a>(<a class="code" href="../../d8/d0/immstruc_8h.html#a34">PCIMEHOTKEY</a> ph, INT num, BOOL fCheckExistingHotKey);
00046 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a22">CliGetPreloadKeyboardLayouts</a>(<a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html">FE_KEYBOARDS</a>* pFeKbds);
00047 
00048 <span class="comment">//</span>
00049 <span class="comment">// IMM hotkey related registry keys under HKEY_CURRENT_USER</span>
00050 <span class="comment">//</span>
<a name="l00051"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a2">00051</a> CONST TCHAR *<a class="code" href="../../d5/d0/immhotky_8c.html#a2">szaRegImmHotKeys</a>[] = {
00052     TEXT(<span class="stringliteral">"Control Panel"</span>),
00053     TEXT(<span class="stringliteral">"Input Method"</span>),
00054     TEXT(<span class="stringliteral">"Hot Keys"</span>),
00055     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00056 };
00057 
<a name="l00058"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a3">00058</a> CONST TCHAR <a class="code" href="../../d5/d0/immhotky_8c.html#a3">szRegImeHotKey</a>[] = TEXT(<span class="stringliteral">"Control Panel\\Input Method\\Hot Keys"</span>);
<a name="l00059"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a4">00059</a> CONST TCHAR <a class="code" href="../../d5/d0/immhotky_8c.html#a4">szRegKeyboardPreload</a>[] = TEXT(<span class="stringliteral">"Keyboard Layout\\Preload"</span>);
00060 
<a name="l00061"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a5">00061</a> CONST TCHAR <a class="code" href="../../d5/d0/immhotky_8c.html#a5">szRegVK</a>[] = TEXT(<span class="stringliteral">"Virtual Key"</span>);
<a name="l00062"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a6">00062</a> CONST TCHAR <a class="code" href="../../d5/d0/immhotky_8c.html#a6">szRegMOD</a>[] = TEXT(<span class="stringliteral">"Key Modifiers"</span>);
<a name="l00063"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a7">00063</a> CONST TCHAR <a class="code" href="../../d5/d0/immhotky_8c.html#a7">szRegHKL</a>[] = TEXT(<span class="stringliteral">"Target IME"</span>);
00064 
00065 <span class="comment">//</span>
00066 <span class="comment">// Default IME HotKey Tables</span>
00067 <span class="comment">//</span>
00068 <span class="comment">// CR:takaok - move this to the resource if you have time</span>
00069 <span class="comment">//</span>
<a name="l00070"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a8">00070</a> CONST <a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html">IMEHOTKEY</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a8">DefaultHotKeyTableJ</a>[]= {
00071     {IME_JHOTKEY_CLOSE_OPEN, VK_KANJI, MOD_IGNORE_ALL_MODIFIER, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>}
00072 };
<a name="l00073"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a9">00073</a> CONST <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a9">DefaultHotKeyNumJ</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d0/immhotky_8c.html#a8">DefaultHotKeyTableJ</a>) / <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html">IMEHOTKEY</a>);
00074 
<a name="l00075"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a10">00075</a> CONST <a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html">IMEHOTKEY</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a10">DefaultHotKeyTableT</a>[] = {
00076     { IME_THOTKEY_IME_NONIME_TOGGLE, VK_SPACE, <a class="code" href="../../d8/d0/immstruc_8h.html#a27">MOD_BOTH_SIDES</a>|MOD_CONTROL, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> },
00077     { IME_THOTKEY_SHAPE_TOGGLE, VK_SPACE, <a class="code" href="../../d8/d0/immstruc_8h.html#a27">MOD_BOTH_SIDES</a>|MOD_SHIFT,  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> }
00078 };
<a name="l00079"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a11">00079</a> CONST <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a11">DefaultHotKeyNumT</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d0/immhotky_8c.html#a10">DefaultHotKeyTableT</a>) / <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html">IMEHOTKEY</a>);
00080 
<a name="l00081"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a12">00081</a> CONST <a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html">IMEHOTKEY</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a12">DefaultHotKeyTableC</a>[] = {
00082     { IME_CHOTKEY_IME_NONIME_TOGGLE, VK_SPACE, <a class="code" href="../../d8/d0/immstruc_8h.html#a27">MOD_BOTH_SIDES</a>|MOD_CONTROL, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> },
00083     { IME_CHOTKEY_SHAPE_TOGGLE, VK_SPACE, <a class="code" href="../../d8/d0/immstruc_8h.html#a27">MOD_BOTH_SIDES</a>|MOD_SHIFT,  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> }
00084 };
<a name="l00085"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a13">00085</a> CONST <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a13">DefaultHotKeyNumC</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d0/immhotky_8c.html#a12">DefaultHotKeyTableC</a>) / <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html">IMEHOTKEY</a>);
00086 
00087 <span class="preprocessor">#if 0   // just FYI.</span>
00088 <span class="preprocessor"></span>CONST <a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html">IMEHOTKEY</a> DefaultHotKeyTableK[] = {
00089     { IME_KHOTKEY_ENGLISH,  VK_HANGEUL, MOD_IGNORE_ALL_MODIFIER,  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> },
00090     { IME_KHOTKEY_SHAPE_TOGGLE, VK_JUNJA, MOD_IGNORE_ALL_MODIFIER,  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> },
00091     { IME_KHOTKEY_HANJACONVERT, VK_HANJA, MOD_IGNORE_ALL_MODIFIER, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> }
00092 };
00093 CONST <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> DefaultHotKeyNumK = <span class="keyword">sizeof</span>(DefaultHotKeyTableK) / <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html">IMEHOTKEY</a>);
00094 <span class="preprocessor">#endif</span>
00095 <span class="preprocessor"></span>
00096 <span class="comment">//</span>
00097 <span class="comment">// Set language flags.</span>
00098 <span class="comment">//</span>
<a name="l00099"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a23">00099</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a23">SetFeKeyboardFlags</a>(LANGID langid, <a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html">FE_KEYBOARDS</a>* pFeKbds)
00100 {
00101     <span class="keywordflow">switch</span> (langid) {
00102     <span class="keywordflow">case</span> MAKELANGID(LANG_CHINESE, SUBLANG_CHINESE_TRADITIONAL):
00103     <span class="keywordflow">case</span> MAKELANGID(LANG_CHINESE, SUBLANG_CHINESE_HONGKONG):
00104         pFeKbds-&gt;<a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html#o1">fCHT</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00105         <span class="keywordflow">break</span>;
00106     <span class="keywordflow">case</span> MAKELANGID(LANG_CHINESE, SUBLANG_CHINESE_SIMPLIFIED):
00107     <span class="keywordflow">case</span> MAKELANGID(LANG_CHINESE, SUBLANG_CHINESE_SINGAPORE):
00108         pFeKbds-&gt;<a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html#o2">fCHS</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00109         <span class="keywordflow">break</span>;
00110     <span class="keywordflow">case</span> MAKELANGID(LANG_JAPANESE, SUBLANG_DEFAULT):
00111         pFeKbds-&gt;<a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html#o0">fJPN</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00112         <span class="keywordflow">break</span>;
00113     <span class="keywordflow">case</span> MAKELANGID(LANG_KOREAN, SUBLANG_DEFAULT):
00114         pFeKbds-&gt;<a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html#o3">fKOR</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00115         <span class="keywordflow">break</span>;
00116     }
00117 }
00118 
00119 <span class="comment">/***************************************************************************\</span>
00120 <span class="comment">* ImmInitializeHotkeys()</span>
00121 <span class="comment">*</span>
00122 <span class="comment">* Called from user\client\UpdatePerUserSystemParameters()</span>
00123 <span class="comment">*</span>
00124 <span class="comment">*  Read the User registry and set the IME hotkey.</span>
00125 <span class="comment">*</span>
00126 <span class="comment">* History:</span>
00127 <span class="comment">* 25-Mar-1996 TakaoK       Created</span>
00128 <span class="comment">\***************************************************************************/</span>
<a name="l00129"></a><a class="code" href="../../d6/d0/usercli_8h.html#a788">00129</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d0/usercli_8h.html#a788">CliImmInitializeHotKeys</a>(DWORD dwAction, HKL hkl)
00130 {
00131     <a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html">FE_KEYBOARDS</a> feKbds = { 0, 0, 0, 0, };
00132     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFoundAny;
00133 
00134     UNREFERENCED_PARAMETER(hkl);
00135 
00136     <span class="comment">// First, initialize the hotkey list</span>
00137     <a class="code" href="../../d5/d0/immhotky_8c.html#a17">CliImmSetHotKeyWorker</a>(0, 0, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d8/d0/immstruc_8h.html#a30">ISHK_INITIALIZE</a>);
00138 
00139     <span class="comment">// Check if the user has customized IME hotkeys</span>
00140     <span class="comment">// (they're stored in the registry)</span>
00141     fFoundAny = <a class="code" href="../../d5/d0/immhotky_8c.html#a19">CliGetImeHotKeysFromRegistry</a>();
00142 
00143     <span class="keywordflow">if</span> (dwAction == <a class="code" href="../../d8/d0/immstruc_8h.html#a30">ISHK_INITIALIZE</a>) {
00144         TAGMSG0(DBGTAG_IMM, <span class="stringliteral">"Setting IME HotKeys for Init.\n"</span>);
00145 
00146         <span class="comment">// Get the user's default locale and set its flag</span>
00147         <a class="code" href="../../d5/d0/immhotky_8c.html#a23">SetFeKeyboardFlags</a>(LANGIDFROMLCID(GetUserDefaultLCID()), &amp;feKbds);
00148 
00149         <span class="comment">// Get preloaded keyboards' locales and set their flags</span>
00150         <a class="code" href="../../d5/d0/immhotky_8c.html#a22">CliGetPreloadKeyboardLayouts</a>(&amp;feKbds);
00151 
00152     }
00153     <span class="keywordflow">else</span> {
00154         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
00155         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> nLayouts;
00156         LPHKL lphkl;
00157 
00158         TAGMSG0(DBGTAG_IMM, <span class="stringliteral">"Setting IME HotKeys for Add.\n"</span>);
00159 
00160         nLayouts = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a312">NtUserGetKeyboardLayoutList</a>(0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00161         <span class="keywordflow">if</span> (nLayouts == 0) {
00162             <span class="keywordflow">return</span>;
00163         }
00164         lphkl = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, nLayouts * <span class="keyword">sizeof</span>(HKL));
00165         <span class="keywordflow">if</span> (lphkl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00166             <span class="keywordflow">return</span>;
00167         }
00168         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a312">NtUserGetKeyboardLayoutList</a>(nLayouts, lphkl);
00169         <span class="keywordflow">for</span> (i = 0; i &lt; nLayouts; ++i) {
00170             <span class="comment">//</span>
00171             <span class="comment">// Set language flags. By its definition, LOWORD(hkl) is LANGID</span>
00172             <span class="comment">//</span>
00173             <a class="code" href="../../d5/d0/immhotky_8c.html#a23">SetFeKeyboardFlags</a>(LOWORD(HandleToUlong(lphkl[i])), &amp;feKbds);
00174         }
00175         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lphkl);
00176     }
00177 
00178     <span class="keywordflow">if</span> (feKbds.<a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html#o0">fJPN</a>) {
00179         TAGMSG0(DBGTAG_IMM, <span class="stringliteral">"JPN KL Preloaded.\n"</span>);
00180         <a class="code" href="../../d5/d0/immhotky_8c.html#a21">CliSetDefaultImeHotKeys</a>(<a class="code" href="../../d5/d0/immhotky_8c.html#a8">DefaultHotKeyTableJ</a>, <a class="code" href="../../d5/d0/immhotky_8c.html#a9">DefaultHotKeyNumJ</a>, fFoundAny);
00181     }
00182 
00183     <span class="keywordflow">if</span> (feKbds.<a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html#o3">fKOR</a>) {
00184         TAGMSG0(DBGTAG_IMM, <span class="stringliteral">"KOR KL Preloaded, but KOR hotkeys will not be registered.\n"</span>);
00185     }
00186 
00187     <span class="keywordflow">if</span> (feKbds.<a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html#o1">fCHT</a>) {
00188         TAGMSG0(DBGTAG_IMM, <span class="stringliteral">"CHT KL Preloaded.\n"</span>);
00189         <a class="code" href="../../d5/d0/immhotky_8c.html#a21">CliSetDefaultImeHotKeys</a>(<a class="code" href="../../d5/d0/immhotky_8c.html#a10">DefaultHotKeyTableT</a>, <a class="code" href="../../d5/d0/immhotky_8c.html#a11">DefaultHotKeyNumT</a>, fFoundAny);
00190     }
00191     <span class="keywordflow">if</span> (feKbds.<a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html#o2">fCHS</a>) {
00192         TAGMSG0(DBGTAG_IMM, <span class="stringliteral">"CHS KL Preloaded.\n"</span>);
00193         <a class="code" href="../../d5/d0/immhotky_8c.html#a21">CliSetDefaultImeHotKeys</a>(<a class="code" href="../../d5/d0/immhotky_8c.html#a12">DefaultHotKeyTableC</a>, <a class="code" href="../../d5/d0/immhotky_8c.html#a13">DefaultHotKeyNumC</a>, fFoundAny);
00194     }
00195 }
00196 
<a name="l00197"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a21">00197</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a21">CliSetDefaultImeHotKeys</a>(PCIMEHOTKEY ph, INT num, BOOL fNeedToCheckExistingHotKey)
00198 {
00199     <a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html">IMEHOTKEY</a> hkt;
00200 
00201     <span class="keywordflow">while</span>( num-- &gt; 0 ) {
00202         <span class="comment">//</span>
00203         <span class="comment">// Set IME hotkey only if there is no such</span>
00204         <span class="comment">// hotkey in the registry</span>
00205         <span class="comment">//</span>
00206         <span class="keywordflow">if</span> (!fNeedToCheckExistingHotKey ||
00207                 !<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a393">NtUserGetImeHotKey</a>(ph-&gt;dwHotKeyID, &amp;hkt.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o2">uModifiers</a>, &amp;hkt.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o1">uVKey</a>, &amp;hkt.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o3">hKL</a>)) {
00208 
00209             <a class="code" href="../../d5/d0/immhotky_8c.html#a17">CliImmSetHotKeyWorker</a>(ph-&gt;dwHotKeyID,
00210                                     ph-&gt;uModifiers,
00211                                     ph-&gt;uVKey,
00212                                     ph-&gt;hKL,
00213                                     <a class="code" href="../../d8/d0/immstruc_8h.html#a29">ISHK_ADD</a>);
00214         }
00215         ph++;
00216     }
00217 }
00218 
00219 <span class="comment">/***************************************************************************\</span>
00220 <span class="comment">* CliGetPreloadKeyboardLayouts()</span>
00221 <span class="comment">*</span>
00222 <span class="comment">*  Read the User registry and enumerate values in Keyboard Layouts\Preload</span>
00223 <span class="comment">* to see which FE languages are to be preloaded.</span>
00224 <span class="comment">*</span>
00225 <span class="comment">* History:</span>
00226 <span class="comment">* 03-Dec-1997 Hiroyama     Created</span>
00227 <span class="comment">\***************************************************************************/</span>
00228 
<a name="l00229"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a22">00229</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a22">CliGetPreloadKeyboardLayouts</a>(<a class="code" href="../../d2/d5/structtagFE__KEYBOARDS.html">FE_KEYBOARDS</a>* pFeKbds)
00230 {
00231     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  i;
00232     WCHAR szPreLoadee[4];   <span class="comment">// up to 999 preloads</span>
00233     WCHAR lpszName[KL_NAMELENGTH];
00234     UNICODE_STRING UnicodeString;
00235     HKL hkl;
00236 
00237     <span class="keywordflow">for</span> (i = 1; i &lt; 1000; i++) {
00238         wsprintf(szPreLoadee, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%d"</span>, i);
00239         <span class="keywordflow">if</span> ((GetPrivateProfileStringW(
00240                  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Preload"</span>,
00241                  szPreLoadee,
00242                  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>,                            <span class="comment">// default = NULL</span>
00243                  lpszName,                       <span class="comment">// output buffer</span>
00244                  KL_NAMELENGTH,
00245                  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"keyboardlayout.ini"</span>) == -1 ) || (*lpszName == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>)) {
00246             <span class="keywordflow">break</span>;
00247         }
00248         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, lpszName);
00249         <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;UnicodeString, 16<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, (PULONG)&amp;hkl);
00250 
00251         RIPMSG2(RIP_VERBOSE, <span class="stringliteral">"PreLoaded HKL(%d): %08X\n"</span>, i, hkl);
00252 
00253         <span class="comment">//</span>
00254         <span class="comment">// Set language flags. By its definition, LOWORD(hkl) is LANGID</span>
00255         <span class="comment">//</span>
00256         <a class="code" href="../../d5/d0/immhotky_8c.html#a23">SetFeKeyboardFlags</a>(LOWORD(HandleToUlong(hkl)), pFeKbds);
00257     }
00258 }
00259 
<a name="l00260"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a19">00260</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a19">CliGetImeHotKeysFromRegistry</a>()
00261 {
00262     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fFoundAny = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00263 
00264     HANDLE hCurrentUserKey;
00265     HANDLE hKeyHotKeys;
00266 
00267     OBJECT_ATTRIBUTES   Obja;
00268     UNICODE_STRING      SubKeyName;
00269 
00270     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00271     ULONG uIndex;
00272 
00273     <span class="comment">//</span>
00274     <span class="comment">// Open the current user registry key</span>
00275     <span class="comment">//</span>
00276     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a27">RtlOpenCurrentUser</a>(MAXIMUM_ALLOWED, &amp;hCurrentUserKey);
00277     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00278         <span class="keywordflow">return</span> fFoundAny;
00279     }
00280 
00281     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;SubKeyName, <a class="code" href="../../d5/d0/immhotky_8c.html#a3">szRegImeHotKey</a> );
00282     InitializeObjectAttributes( &amp;Obja,
00283                                 &amp;SubKeyName,
00284                                 OBJ_CASE_INSENSITIVE,
00285                                 hCurrentUserKey,
00286                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00287     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;hKeyHotKeys, KEY_READ, &amp;Obja );
00288     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00289         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( hCurrentUserKey );
00290         <span class="keywordflow">return</span> fFoundAny;
00291     }
00292 
00293     <span class="keywordflow">for</span> (uIndex = 0; <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; uIndex++) {
00294         <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> KeyBuffer[<span class="keyword">sizeof</span>(KEY_BASIC_INFORMATION) + 16 * <span class="keyword">sizeof</span>(WCHAR)];
00295         PKEY_BASIC_INFORMATION pKeyInfo;
00296         ULONG ResultLength;
00297 
00298         pKeyInfo = (PKEY_BASIC_INFORMATION)KeyBuffer;
00299         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a17">NtEnumerateKey</a>(hKeyHotKeys,
00300                                  uIndex,
00301                                  KeyBasicInformation,
00302                                  pKeyInfo,
00303                                  <span class="keyword">sizeof</span>( KeyBuffer ),
00304                                  &amp;ResultLength );
00305 
00306         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00307 
00308             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/immhotky_8c.html#a20">CliSetSingleHotKey</a>(pKeyInfo, hKeyHotKeys)) {
00309 
00310                     fFoundAny = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00311             }
00312 
00313         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
00314             <span class="keywordflow">break</span>;
00315         }
00316     }
00317 
00318     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hKeyHotKeys);
00319     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hCurrentUserKey);
00320 
00321     <span class="keywordflow">return</span> fFoundAny;
00322 }
00323 
<a name="l00324"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a25">00324</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a25">CliReadRegistryValue</a>(HANDLE hKey, PCWSTR pName)
00325 {
00326     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + 16 * <span class="keyword">sizeof</span>(UCHAR)];
00327     PKEY_VALUE_PARTIAL_INFORMATION pKeyValue;
00328     UNICODE_STRING      <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00329     ULONG ResultLength;
00330     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00331 
00332     pKeyValue = (PKEY_VALUE_PARTIAL_INFORMATION)<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>;
00333 
00334     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, pName);
00335     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hKey,
00336                              &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00337                              KeyValuePartialInformation,
00338                              pKeyValue,
00339                              <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>),
00340                              &amp;ResultLength );
00341 
00342     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; pKeyValue-&gt;DataLength &gt; 3) {
00343         <span class="comment">//</span>
00344         <span class="comment">// In Win95 registry, these items are written as BYTE data...</span>
00345         <span class="comment">//</span>
00346         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(MAKEWORD( pKeyValue-&gt;Data[0], pKeyValue-&gt;Data[1])) |
00347                  (((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(MAKEWORD( pKeyValue-&gt;Data[2], pKeyValue-&gt;Data[3]))) &lt;&lt; 16);
00348     }
00349 
00350     <span class="keywordflow">return</span> 0;
00351 }
00352 
<a name="l00353"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a20">00353</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a20">CliSetSingleHotKey</a>(PKEY_BASIC_INFORMATION pKeyInfo, HANDLE hKey)
00354 {
00355     UNICODE_STRING      SubKeyName;
00356     HANDLE    hKeySingleHotKey;
00357     OBJECT_ATTRIBUTES   Obja;
00358 
00359     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwID = 0;
00360     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  uVKey = 0;
00361     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  uModifiers = 0;
00362     HKL   hKL = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00363 
00364     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00365 
00366     SubKeyName.Buffer = (PWSTR)&amp;(pKeyInfo-&gt;Name[0]);
00367     SubKeyName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)pKeyInfo-&gt;NameLength;
00368     SubKeyName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)pKeyInfo-&gt;NameLength;
00369     InitializeObjectAttributes(&amp;Obja,
00370                                &amp;SubKeyName,
00371                                OBJ_CASE_INSENSITIVE,
00372                                hKey,
00373                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00374 
00375     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hKeySingleHotKey, KEY_READ, &amp;Obja);
00376     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00377         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00378     }
00379 
00380     <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;SubKeyName, 16<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, &amp;dwID);
00381     uVKey = <a class="code" href="../../d5/d0/immhotky_8c.html#a25">CliReadRegistryValue</a>(hKeySingleHotKey, <a class="code" href="../../d5/d0/immhotky_8c.html#a5">szRegVK</a>);
00382     uModifiers = <a class="code" href="../../d5/d0/immhotky_8c.html#a25">CliReadRegistryValue</a>(hKeySingleHotKey, <a class="code" href="../../d5/d0/immhotky_8c.html#a6">szRegMOD</a>);
00383     hKL = (HKL)LongToHandle( <a class="code" href="../../d5/d0/immhotky_8c.html#a25">CliReadRegistryValue</a>(hKeySingleHotKey, <a class="code" href="../../d5/d0/immhotky_8c.html#a7">szRegHKL</a>) );
00384 
00385     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hKeySingleHotKey);
00386 
00387     <span class="keywordflow">return</span> <a class="code" href="../../d5/d0/immhotky_8c.html#a17">CliImmSetHotKeyWorker</a>(dwID, uModifiers, uVKey, hKL, <a class="code" href="../../d8/d0/immstruc_8h.html#a29">ISHK_ADD</a>);
00388 }
00389 
00390 <span class="comment">/***************************************************************************\</span>
00391 <span class="comment">* ImmSetHotKey()</span>
00392 <span class="comment">*</span>
00393 <span class="comment">* Private API for IMEs and the control panel.</span>
00394 <span class="comment">*</span>
00395 <span class="comment">* History:</span>
00396 <span class="comment">* 25-Mar-1996 TakaoK       Created</span>
00397 <span class="comment">\***************************************************************************/</span>
<a name="l00398"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a26">00398</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d5/d0/immhotky_8c.html#a26">CliImmSetHotKey</a>(
00399     DWORD dwID,
00400     UINT uModifiers,
00401     UINT uVKey,
00402     HKL hkl)
00403 {
00404     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fResult;
00405     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fTmp;
00406     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDelete = (uVKey == 0 );
00407 
00408     <span class="keywordflow">if</span> (fDelete) {
00409         <span class="comment">//</span>
00410         <span class="comment">// Removing an IME hotkey from the list in the kernel side</span>
00411         <span class="comment">// should not be failed, if we succeed to remove the IME</span>
00412         <span class="comment">// hotkey entry from the registry. Therefore CliSaveImeHotKey</span>
00413         <span class="comment">// is called first.</span>
00414         <span class="comment">//</span>
00415         fResult = <a class="code" href="../../d5/d0/immhotky_8c.html#a16">CliSaveImeHotKey</a>( dwID, uModifiers, uVKey, hkl,  fDelete );
00416         <span class="keywordflow">if</span> (fResult) {
00417             fTmp = <a class="code" href="../../d5/d0/immhotky_8c.html#a17">CliImmSetHotKeyWorker</a>( dwID, uModifiers, uVKey, hkl, <a class="code" href="../../d8/d0/immstruc_8h.html#a28">ISHK_REMOVE</a> );
00418             UserAssert(fTmp);
00419         }
00420     } <span class="keywordflow">else</span> {
00421         <span class="comment">//</span>
00422         <span class="comment">// CliImmSetHotKeyWorker should be called first since</span>
00423         <span class="comment">// adding an IME hotkey into the list in the kernel side</span>
00424         <span class="comment">// will be failed in various reasons.</span>
00425         <span class="comment">//</span>
00426         fResult = <a class="code" href="../../d5/d0/immhotky_8c.html#a17">CliImmSetHotKeyWorker</a>(dwID, uModifiers, uVKey, hkl, <a class="code" href="../../d8/d0/immstruc_8h.html#a29">ISHK_ADD</a>);
00427         <span class="keywordflow">if</span> (fResult) {
00428             fResult = <a class="code" href="../../d5/d0/immhotky_8c.html#a16">CliSaveImeHotKey</a>(dwID, uModifiers, uVKey, hkl, fDelete);
00429             <span class="keywordflow">if</span> (!fResult) {
00430                 <span class="comment">//</span>
00431                 <span class="comment">// We failed to save the hotkey to the registry.</span>
00432                 <span class="comment">// We need to remove the entry from the IME hotkey</span>
00433                 <span class="comment">// list in the kernel side.</span>
00434                 <span class="comment">//</span>
00435                 fTmp = <a class="code" href="../../d5/d0/immhotky_8c.html#a17">CliImmSetHotKeyWorker</a>(dwID, uModifiers, uVKey, hkl, <a class="code" href="../../d8/d0/immstruc_8h.html#a28">ISHK_REMOVE</a>);
00436                 UserAssert(fTmp);
00437             }
00438         }
00439     }
00440     <span class="keywordflow">return</span> fResult;
00441 }
00442 
00443 <span class="comment">/***************************************************************************\</span>
00444 <span class="comment">* Open/CloseRegApi</span>
00445 <span class="comment">*</span>
00446 <span class="comment">*  Open and Close Regstry APIs in ADVAPI32.DLL</span>
00447 <span class="comment">*</span>
00448 <span class="comment">* History:</span>
00449 <span class="comment">* 17-Aug-98 Hiroyama</span>
00450 <span class="comment">\***************************************************************************/</span>
00451 
<a name="l00452"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a0">00452</a> <span class="preprocessor">#define GET(a) \</span>
00453 <span class="preprocessor">    if ((pfn-&gt;a = (void*)GetProcAddress(pfn-&gt;hModule, #a)) == NULL) {   \</span>
00454 <span class="preprocessor">        RIPMSG0(RIP_WARNING, "OpenRegApi: " #a " cannot be imported.");  \</span>
00455 <span class="preprocessor">        FreeLibrary(pfn-&gt;hModule);                                      \</span>
00456 <span class="preprocessor">        return FALSE;                                                   \</span>
00457 <span class="preprocessor">    }</span>
00458 <span class="preprocessor"></span>
<a name="l00459"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a14">00459</a> <a class="code" href="../../d8/d0/structADVAPI__FN.html">ADVAPI_FN</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a14">gAdvApiFn</a>;
00460 
<a name="l00461"></a><a class="code" href="../../d4/d0/immcli_8h.html#a106">00461</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d0/immcli_8h.html#a106">OpenRegApi</a>(<a class="code" href="../../d8/d0/structADVAPI__FN.html">ADVAPI_FN</a>* pfn)
00462 {
00463     pfn-&gt;<a class="code" href="../../d8/d0/structADVAPI__FN.html#o0">hModule</a> = LoadLibraryW(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ADVAPI32.DLL"</span>);
00464 
00465     <span class="keywordflow">if</span> (pfn-&gt;<a class="code" href="../../d8/d0/structADVAPI__FN.html#o0">hModule</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00466         <a class="code" href="../../d5/d0/immhotky_8c.html#a0">GET</a>(RegCreateKeyW);
00467         <a class="code" href="../../d5/d0/immhotky_8c.html#a0">GET</a>(RegOpenKeyW);
00468         <a class="code" href="../../d5/d0/immhotky_8c.html#a0">GET</a>(RegCloseKey);
00469         <a class="code" href="../../d5/d0/immhotky_8c.html#a0">GET</a>(RegDeleteKeyW);
00470         <a class="code" href="../../d5/d0/immhotky_8c.html#a0">GET</a>(RegCreateKeyExW);
00471         <a class="code" href="../../d5/d0/immhotky_8c.html#a0">GET</a>(RegSetValueExW);
00472         <a class="code" href="../../d5/d0/immhotky_8c.html#a0">GET</a>(RegQueryValueExW);
00473 
00474         <span class="comment">//</span>
00475         <span class="comment">// Succeeded.</span>
00476         <span class="comment">//</span>
00477         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00478     }
00479 
00480     <span class="comment">//</span>
00481     <span class="comment">// Failed to open registry APIs.</span>
00482     <span class="comment">//</span>
00483     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00484 }
00485 
<a name="l00486"></a><a class="code" href="../../d4/d0/immcli_8h.html#a107">00486</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d0/immcli_8h.html#a107">CloseRegApi</a>(<a class="code" href="../../d8/d0/structADVAPI__FN.html">ADVAPI_FN</a>* pfn)
00487 {
00488     UserAssert(pfn-&gt;<a class="code" href="../../d8/d0/structADVAPI__FN.html#o0">hModule</a>);
00489     <span class="keywordflow">if</span> (pfn-&gt;<a class="code" href="../../d8/d0/structADVAPI__FN.html#o0">hModule</a>) {
00490         FreeLibrary(pfn-&gt;<a class="code" href="../../d8/d0/structADVAPI__FN.html#o0">hModule</a>);
00491         pfn-&gt;<a class="code" href="../../d8/d0/structADVAPI__FN.html#o0">hModule</a>;
00492     }
00493 }
00494 
00495 <span class="preprocessor">#undef GET</span>
00496 <span class="preprocessor"></span>
00497 <span class="comment">/***************************************************************************\</span>
00498 <span class="comment">* CliSaveImeHotKey()</span>
00499 <span class="comment">*</span>
00500 <span class="comment">*  Put/Remove the specified IME hotkey entry from the registry</span>
00501 <span class="comment">*</span>
00502 <span class="comment">* History:</span>
00503 <span class="comment">* 25-Mar-1996 TakaoK       Created</span>
00504 <span class="comment">\***************************************************************************/</span>
00505 
00506 <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a29">CliSaveImeHotKeyWorker</a>(DWORD, UINT, UINT, HKL, BOOL, <a class="code" href="../../d8/d0/structADVAPI__FN.html">ADVAPI_FN</a>*);
00507 
<a name="l00508"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a16">00508</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a16">CliSaveImeHotKey</a>(DWORD <span class="keywordtype">id</span>, UINT mod, UINT vk, HKL hkl, BOOL fDelete)
00509 {
00510     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00511     <a class="code" href="../../d8/d0/structADVAPI__FN.html">ADVAPI_FN</a> fn;
00512 
00513     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a106">OpenRegApi</a>(&amp;fn)) {
00514         fRet = <a class="code" href="../../d5/d0/immhotky_8c.html#a29">CliSaveImeHotKeyWorker</a>(<span class="keywordtype">id</span>, mod, vk, hkl, fDelete, &amp;fn);
00515         <a class="code" href="../../d4/d0/immcli_8h.html#a107">CloseRegApi</a>(&amp;fn);
00516     }
00517 
00518     <span class="keywordflow">return</span> fRet;
00519 }
00520 
<a name="l00521"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a29">00521</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a29">CliSaveImeHotKeyWorker</a>(DWORD <span class="keywordtype">id</span>, UINT mod, UINT vk, HKL hkl, BOOL fDelete, <a class="code" href="../../d8/d0/structADVAPI__FN.html">ADVAPI_FN</a>* fn)
00522 {
00523     HKEY hKey, hKeyParent;
00524     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
00525     LONG lResult;
00526     TCHAR szHex[16];
00527 
00528     <span class="keywordflow">if</span> (fDelete) {
00529         TCHAR szRegTmp[(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d0/immhotky_8c.html#a3">szRegImeHotKey</a>) / <span class="keyword">sizeof</span>(TCHAR) + 1 + 8 + 1)];
00530 
00531         lstrcpy(szRegTmp, <a class="code" href="../../d5/d0/immhotky_8c.html#a3">szRegImeHotKey</a>);
00532         lstrcat(szRegTmp, TEXT(<span class="stringliteral">"\\"</span>));
00533         <a class="code" href="../../d5/d0/immhotky_8c.html#a30">NumToHexAscii</a>(<span class="keywordtype">id</span>, szHex);
00534         lstrcat(szRegTmp, szHex);
00535 
00536         lResult = fn-&gt;RegDeleteKey(HKEY_CURRENT_USER, szRegTmp);
00537         <span class="keywordflow">if</span> (lResult != ERROR_SUCCESS) {
00538             RIPERR1(lResult, RIP_WARNING,
00539                      <span class="stringliteral">"CliSaveImeHotKeyWorker: deleting %s failed"</span>, szRegTmp);
00540             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00541         }
00542         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00543     }
00544 
00545     hKeyParent = HKEY_CURRENT_USER;
00546     <span class="keywordflow">for</span> (i = 0; <a class="code" href="../../d5/d0/immhotky_8c.html#a2">szaRegImmHotKeys</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; i++) {
00547         lResult = fn-&gt;RegCreateKeyEx(hKeyParent,
00548                                   <a class="code" href="../../d5/d0/immhotky_8c.html#a2">szaRegImmHotKeys</a>[i],
00549                                   0,
00550                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00551                                   REG_OPTION_NON_VOLATILE,
00552                                   KEY_WRITE|KEY_READ,
00553                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00554                                   &amp;hKey,
00555                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00556         fn-&gt;RegCloseKey(hKeyParent);
00557         <span class="keywordflow">if</span> (lResult == ERROR_SUCCESS) {
00558             hKeyParent = hKey;
00559         } <span class="keywordflow">else</span> {
00560             RIPERR1(lResult, RIP_WARNING,
00561                     <span class="stringliteral">"CliSaveImeHotKeyWorker: creating %s failed"</span>, <a class="code" href="../../d5/d0/immhotky_8c.html#a2">szaRegImmHotKeys</a>[i]);
00562 
00563             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00564         }
00565     }
00566 
00567     <a class="code" href="../../d5/d0/immhotky_8c.html#a30">NumToHexAscii</a>(<span class="keywordtype">id</span>, szHex);
00568     lResult = fn-&gt;RegCreateKeyEx(hKeyParent,
00569                              szHex,
00570                              0,
00571                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00572                              REG_OPTION_NON_VOLATILE,
00573                              KEY_WRITE|KEY_READ,
00574                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00575                              &amp;hKey,
00576                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00577     fn-&gt;RegCloseKey(hKeyParent);
00578     <span class="keywordflow">if</span> (lResult != ERROR_SUCCESS) {
00579         RIPERR1(lResult, RIP_WARNING,
00580                 <span class="stringliteral">"CliSaveImeHotKeyWorker: creating %s failed"</span>, szHex );
00581         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00582     }
00583 
00584     lResult = fn-&gt;RegSetValueExW(hKey,
00585                              <a class="code" href="../../d5/d0/immhotky_8c.html#a5">szRegVK</a>,
00586                              0,
00587                              REG_BINARY,
00588                             (LPBYTE)&amp;vk,
00589                             <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
00590     <span class="keywordflow">if</span> (lResult != ERROR_SUCCESS) {
00591         fn-&gt;RegCloseKey(hKey);
00592         <a class="code" href="../../d5/d0/immhotky_8c.html#a16">CliSaveImeHotKey</a>(<span class="keywordtype">id</span>, vk, mod, hkl, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00593         RIPERR1( lResult, RIP_WARNING,
00594                  <span class="stringliteral">"SaveImeHotKey:setting value on %s failed"</span>, <a class="code" href="../../d5/d0/immhotky_8c.html#a5">szRegVK</a> );
00595         <span class="keywordflow">return</span> ( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00596     }
00597     lResult = fn-&gt;RegSetValueExW(hKey,
00598                              <a class="code" href="../../d5/d0/immhotky_8c.html#a6">szRegMOD</a>,
00599                              0,
00600                              REG_BINARY,
00601                             (LPBYTE)&amp;mod,
00602                             <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
00603 
00604     <span class="keywordflow">if</span> (lResult != ERROR_SUCCESS) {
00605         fn-&gt;RegCloseKey(hKey);
00606         <a class="code" href="../../d5/d0/immhotky_8c.html#a16">CliSaveImeHotKey</a>(<span class="keywordtype">id</span>, vk, mod, hkl, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00607         RIPERR1(lResult, RIP_WARNING,
00608                 <span class="stringliteral">"CliSaveImeHotKeyWorker: setting value on %s failed"</span>, <a class="code" href="../../d5/d0/immhotky_8c.html#a6">szRegMOD</a>);
00609         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00610     }
00611 
00612     lResult = fn-&gt;RegSetValueExW(hKey,
00613                              <a class="code" href="../../d5/d0/immhotky_8c.html#a7">szRegHKL</a>,
00614                              0,
00615                              REG_BINARY,
00616                             (LPBYTE)&amp;hkl,
00617                             <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) );
00618 
00619     <span class="keywordflow">if</span> (lResult != ERROR_SUCCESS) {
00620         fn-&gt;RegCloseKey(hKey);
00621         <a class="code" href="../../d5/d0/immhotky_8c.html#a16">CliSaveImeHotKey</a>(<span class="keywordtype">id</span>, vk, mod, hkl, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00622         RIPERR1(lResult, RIP_WARNING,
00623                 <span class="stringliteral">"CliSaveImeHotKeyWorker: setting value on %s failed"</span>, <a class="code" href="../../d5/d0/immhotky_8c.html#a7">szRegHKL</a>);
00624         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00625     }
00626 
00627     fn-&gt;RegCloseKey(hKey);
00628     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00629 }
00630 
<a name="l00631"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a17">00631</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a17">CliImmSetHotKeyWorker</a>(
00632     DWORD dwID,
00633     UINT uModifiers,
00634     UINT uVKey,
00635     HKL hkl,
00636     DWORD dwAction)
00637 {
00638     <span class="comment">//</span>
00639     <span class="comment">// if we're adding an IME hotkey entry, let's check</span>
00640     <span class="comment">// the parameters before calling the kernel side code</span>
00641     <span class="comment">//</span>
00642     <span class="keywordflow">if</span> (dwAction == <a class="code" href="../../d8/d0/immstruc_8h.html#a29">ISHK_ADD</a>) {
00643 
00644         <span class="keywordflow">if</span> (dwID &gt;= IME_HOTKEY_DSWITCH_FIRST &amp;&amp;
00645                 dwID &lt;= IME_HOTKEY_DSWITCH_LAST) {
00646             <span class="comment">//</span>
00647             <span class="comment">// IME direct switching hot key - switch to</span>
00648             <span class="comment">// the keyboard layout specified.</span>
00649             <span class="comment">// We need to specify keyboard layout.</span>
00650             <span class="comment">//</span>
00651             <span class="keywordflow">if</span> (hkl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00652                 RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"hkl should be specified"</span>);
00653                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00654             }
00655 
00656         } <span class="keywordflow">else</span> {
00657             <span class="comment">//</span>
00658             <span class="comment">// normal hot keys - change the mode of current iME</span>
00659             <span class="comment">//</span>
00660             <span class="comment">// Because it should be effective in all IME no matter</span>
00661             <span class="comment">// which IME is active we should not specify a target IME</span>
00662             <span class="comment">//</span>
00663             <span class="keywordflow">if</span> (hkl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00664                 RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"hkl shouldn't be specified"</span>);
00665                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00666             }
00667 
00668             <span class="keywordflow">if</span> (dwID &gt;= IME_KHOTKEY_FIRST &amp;&amp; dwID &lt;= IME_KHOTKEY_LAST) {
00669                 RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Hotkey for Korean IMEs are invalid."</span>);
00670                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00671             }
00672         }
00673 
00674         <span class="keywordflow">if</span> (uModifiers &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a26">MOD_MODIFY_KEYS</a>) {
00675             <span class="comment">//</span>
00676             <span class="comment">// Because normal keyboard has left and right key for</span>
00677             <span class="comment">// these keys, you should specify left or right ( or both )</span>
00678             <span class="comment">//</span>
00679             <span class="keywordflow">if</span> ((uModifiers &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a27">MOD_BOTH_SIDES</a>) == 0) {
00680                 RIPERR3(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"invalid modifiers %x for id %x vKey %x"</span>, uModifiers, dwID, uVKey);
00681                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00682             }
00683         }
00684 
00685 <span class="preprocessor">#if 0   // Skip this check for now</span>
00686 <span class="preprocessor"></span>        <span class="comment">//</span>
00687         <span class="comment">// It doesn't make sense if vkey is same as modifiers</span>
00688         <span class="comment">//</span>
00689         <span class="keywordflow">if</span> ( ((uModifiers &amp; MOD_ALT) &amp;&amp; (uVKey == VK_MENU))        ||
00690              ((uModifiers &amp; MOD_CONTROL) &amp;&amp; (uVKey == VK_CONTROL)) ||
00691              ((uModifiers &amp; MOD_SHIFT) &amp;&amp; (uVKey == VK_SHIFT))     ||
00692              ((uModifiers &amp; MOD_WIN) &amp;&amp; ((uVKey == VK_LWIN)||(uVKey == VK_RWIN)))
00693            ) {
00694 
00695             RIPERR0( ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"vkey and modifiers are same"</span>);
00696             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00697         }
00698 <span class="preprocessor">#endif</span>
00699 <span class="preprocessor"></span>    }
00700     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a394">NtUserSetImeHotKey</a>(dwID, uModifiers, uVKey, hkl, dwAction);
00701 }
00702 
00703 <span class="comment">//</span>
00704 <span class="comment">// NumToHexAscii</span>
00705 <span class="comment">//</span>
00706 <span class="comment">// convert a DWORD into the hex string</span>
00707 <span class="comment">// (e.g. 0x31 -&gt; "00000031")</span>
00708 <span class="comment">//</span>
00709 <span class="comment">// 29-Jan-1996 takaok   ported from Win95.</span>
00710 <span class="comment">//</span>
<a name="l00711"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a15">00711</a> <span class="keyword">static</span> CONST TCHAR <a class="code" href="../../d5/d0/immhotky_8c.html#a15">szHexString</a>[] = TEXT(<span class="stringliteral">"0123456789ABCDEF"</span>);
00712 
00713 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00714"></a><a class="code" href="../../d5/d0/immhotky_8c.html#a30">00714</a> <a class="code" href="../../d5/d0/immhotky_8c.html#a30">NumToHexAscii</a>(
00715     DWORD dwNum,
00716     PWSTR szAscii)
00717 {
00718     <span class="keywordtype">int</span> i;
00719 
00720     <span class="keywordflow">for</span> (i = 7; i &gt;= 0; i--) {
00721         szAscii[i] = <a class="code" href="../../d5/d0/immhotky_8c.html#a15">szHexString</a>[dwNum &amp; 0x0000000f];
00722         dwNum &gt;&gt;= 4;
00723     }
00724     szAscii[8] = TEXT(<span class="charliteral">'\0'</span>);
00725 
00726     <span class="keywordflow">return</span>;
00727 }
00728 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:21 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
