<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obclose.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obclose.c</h1><a href="../../d5/d0/obclose_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    obclose.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Object close system service</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 31-Mar-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d5/d1/obp_8h.html">obp.h</a>"</span>
00022 
00023 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtMakeTemporaryObject)</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObMakeTemporaryObject)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00027 <span class="preprocessor"></span>
00028 <span class="comment">//</span>
00029 <span class="comment">//  Indicates if auditing is enabled so we have to close down the object</span>
00030 <span class="comment">//  audit alarm</span>
00031 <span class="comment">//</span>
00032 
<a name="l00033"></a><a class="code" href="../../d5/d0/obclose_8c.html#a0">00033</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d7/d4/adt_8h.html#a3">SepAdtAuditingEnabled</a>;
00034 
00035 
00036 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00037"></a><a class="code" href="../../d5/d0/obclose_8c.html#a1">00037</a> <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (
00038     IN HANDLE Handle
00039     )
00040 
00041 <span class="comment">/*++</span>
00042 <span class="comment"></span>
00043 <span class="comment">Routine Description:</span>
00044 <span class="comment"></span>
00045 <span class="comment">    This function is used to close access to the specified handle</span>
00046 <span class="comment"></span>
00047 <span class="comment">Arguments:</span>
00048 <span class="comment"></span>
00049 <span class="comment">    Handle - Supplies the handle being closed</span>
00050 <span class="comment"></span>
00051 <span class="comment">Return Value:</span>
00052 <span class="comment"></span>
00053 <span class="comment">    An appropriate status value</span>
00054 <span class="comment"></span>
00055 <span class="comment">--*/</span>
00056 
00057 {
00058     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> ObjectTable;
00059     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ObjectTableEntry;
00060     PVOID Object;
00061     ULONG CapturedGrantedAccess;
00062     ULONG CapturedAttributes;
00063     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00064     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00065     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00066     BOOLEAN AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00067     <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">KAPC_STATE</a> ApcState;
00068 
00069     <span class="comment">//</span>
00070     <span class="comment">//  Protect ourselves from being interrupted while we hold a handle table</span>
00071     <span class="comment">//  entry lock</span>
00072     <span class="comment">//</span>
00073 
00074     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00075 
00076     <span class="keywordflow">try</span> {
00077 
00078 <span class="preprocessor">    #if DBG</span>
00079 <span class="preprocessor"></span>        KIRQL SaveIrql;
00080 <span class="preprocessor">    #endif // DBG</span>
00081 <span class="preprocessor"></span>
00082         <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"NtClose"</span> );
00083 
00084         <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
00085 
00086 <span class="preprocessor">    #if DBG</span>
00087 <span class="preprocessor"></span>
00088         <span class="comment">//</span>
00089         <span class="comment">//  On checked builds, check that if the Kernel handle bit is set, then</span>
00090         <span class="comment">//  we're coming from Kernel mode. We should probably fail the call if</span>
00091         <span class="comment">//  bit set &amp;&amp; !Kmode</span>
00092         <span class="comment">//</span>
00093 
00094         <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != NtCurrentThread()) &amp;&amp; (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != NtCurrentProcess())) {
00095 
00096             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> &lt; 0 ) ? (KeGetPreviousMode() == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00097         }
00098 
00099 <span class="preprocessor">    #endif</span>
00100 <span class="preprocessor"></span>        <span class="comment">//</span>
00101         <span class="comment">//  For the current process we will grab its handle/object table and</span>
00102         <span class="comment">//  translate the handle to its corresponding table entry.  If the</span>
00103         <span class="comment">//  call is successful it also lock down the handle table.  But first</span>
00104         <span class="comment">//  check for a kernel handle and attach and use that table if so.</span>
00105         <span class="comment">//</span>
00106 
00107         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ioverifier_8c.html#a14">IsKernelHandle</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, KeGetPreviousMode() ))  {
00108 
00109             <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d5/d1/obp_8h.html#a27">DecodeKernelHandle</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
00110 
00111             ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a>;
00112 
00113             <span class="comment">//</span>
00114             <span class="comment">//  Go to the system process if we have to</span>
00115             <span class="comment">//</span>
00116             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>) {
00117                <a class="code" href="../../d3/d5/procobj_8c.html#a6">KeStackAttachProcess</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>, &amp;ApcState);
00118                AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00119             }
00120 
00121         } <span class="keywordflow">else</span> {
00122 
00123             ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>();
00124         }
00125 
00126         ObjectTableEntry = <a class="code" href="../../d5/d8/ex_8h.html#a299">ExMapHandleToPointer</a>( ObjectTable,
00127                                                  <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
00128 
00129         <span class="comment">//</span>
00130         <span class="comment">//  Check that the specified handle is legitimate otherwise we can</span>
00131         <span class="comment">//  assume the caller just passed in some bogus handle value</span>
00132         <span class="comment">//</span>
00133 
00134         <span class="keywordflow">if</span> (ObjectTableEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00135 
00136             <span class="comment">//</span>
00137             <span class="comment">//  From the object table entry we can grab a pointer to the object</span>
00138             <span class="comment">//  header, get its type and its body</span>
00139             <span class="comment">//</span>
00140 
00141             ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(((ULONG_PTR)(ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a>)) &amp; ~<a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
00142             ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00143             Object = &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a>;
00144 
00145             <span class="comment">//</span>
00146             <span class="comment">//  If the object type specifies an okay to close procedure then we</span>
00147             <span class="comment">//  need to invoke that callback.  If the callback doesn't want us to</span>
00148             <span class="comment">//  close handle then unlock the object table and return the error</span>
00149             <span class="comment">//  to our caller</span>
00150             <span class="comment">//</span>
00151 
00152             <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o19">OkayToCloseProcedure</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00153 
00154                 <span class="keywordflow">if</span> (!(*ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o19">OkayToCloseProcedure</a>)( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(), Object, <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> )) {
00155 
00156                     <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"NtClose"</span>, ObjectType, Object );
00157 
00158                     <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( ObjectTable, ObjectTableEntry );
00159 
00160                     <span class="comment">//</span>
00161                     <span class="comment">//  If we are attached to the system process then return</span>
00162                     <span class="comment">//  back to our caller</span>
00163                     <span class="comment">//</span>
00164 
00165                     <span class="keywordflow">if</span> (AttachedToProcess) {
00166 
00167                         <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
00168                         AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00169                     }
00170 
00171                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_HANDLE_NOT_CLOSABLE;
00172                     leave;
00173                 }
00174             }
00175 
00176             CapturedAttributes = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a>;
00177 
00178             <span class="comment">//</span>
00179             <span class="comment">//  If the previous mode was user and the handle is protected from</span>
00180             <span class="comment">//  being closed, then we'll either raise or return an error depending</span>
00181             <span class="comment">//  on the global flags and debugger port situation.</span>
00182             <span class="comment">//</span>
00183 
00184             <span class="keywordflow">if</span> ((CapturedAttributes &amp; <a class="code" href="../../d5/d1/obp_8h.html#a15">OBJ_PROTECT_CLOSE</a>) != 0) {
00185 
00186                 <span class="keywordflow">if</span> (KeGetPreviousMode() != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00187 
00188                     <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( ObjectTable, ObjectTableEntry );
00189 
00190                     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_CLOSE_EXCEPTIONS) ||
00191                         (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00192 
00193                         <span class="comment">//</span>
00194                         <span class="comment">//  If we are attached to the system process then return</span>
00195                         <span class="comment">//  back to our caller</span>
00196                         <span class="comment">//</span>
00197 
00198                         <span class="keywordflow">if</span> (AttachedToProcess) {
00199                             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
00200                             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00201                         }
00202 
00203                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a13">KeRaiseUserException</a>(STATUS_HANDLE_NOT_CLOSABLE);
00204                         leave;
00205 
00206                     } <span class="keywordflow">else</span> {
00207 
00208                         <span class="comment">//</span>
00209                         <span class="comment">//  If we are attached to the system process then return</span>
00210                         <span class="comment">//  back to our caller</span>
00211                         <span class="comment">//</span>
00212 
00213                         <span class="keywordflow">if</span> (AttachedToProcess) {
00214                             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
00215                             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00216                         }
00217 
00218                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_HANDLE_NOT_CLOSABLE;
00219                         leave;
00220                     }
00221 
00222                 } <span class="keywordflow">else</span> {
00223 
00224                     <span class="keywordflow">if</span> ((!<a class="code" href="../../d1/d9/ps_8h.html#a27">PsIsThreadTerminating</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())) &amp;&amp;
00225                         (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Peb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00226 
00227                         <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( ObjectTable, ObjectTableEntry );
00228 
00229 <span class="preprocessor">    #if DBG</span>
00230 <span class="preprocessor"></span>                        <span class="comment">//</span>
00231                         <span class="comment">//  bugcheck here on checked builds if kernel mode code is</span>
00232                         <span class="comment">//  closing a protected handle and process is not exiting.</span>
00233                         <span class="comment">//  Ignore if no PEB as this occurs if process is killed</span>
00234                         <span class="comment">//  before really starting.</span>
00235                         <span class="comment">//</span>
00236 
00237                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(INVALID_KERNEL_HANDLE, (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, 0, 0, 0);
00238 <span class="preprocessor">    #else</span>
00239 <span class="preprocessor"></span>                        <span class="comment">//</span>
00240                         <span class="comment">//  If we are attached to the system process then return</span>
00241                         <span class="comment">//  back to our caller</span>
00242                         <span class="comment">//</span>
00243 
00244                         <span class="keywordflow">if</span> (AttachedToProcess) {
00245                             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
00246                             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00247                         }
00248 
00249                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_HANDLE_NOT_CLOSABLE;
00250                         leave;
00251 <span class="preprocessor">    #endif // DBG</span>
00252 <span class="preprocessor"></span>
00253                     }
00254                 }
00255             }
00256 
00257             <span class="comment">//</span>
00258             <span class="comment">//  Get the granted access for the handle</span>
00259             <span class="comment">//</span>
00260 
00261 <span class="preprocessor">    #if i386 &amp;&amp; !FPO</span>
00262 <span class="preprocessor"></span>
00263             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
00264 
00265                 CapturedGrantedAccess = ObpTranslateGrantedAccessIndex( ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> );
00266 
00267             } <span class="keywordflow">else</span> {
00268 
00269                 CapturedGrantedAccess = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
00270             }
00271 
00272 <span class="preprocessor">    #else</span>
00273 <span class="preprocessor"></span>
00274             CapturedGrantedAccess = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
00275 
00276 <span class="preprocessor">    #endif // i386 &amp;&amp; !FPO</span>
00277 <span class="preprocessor"></span>
00278             <span class="comment">//</span>
00279             <span class="comment">//  Now remove the handle from the handle table</span>
00280             <span class="comment">//</span>
00281 
00282             <a class="code" href="../../d5/d8/ex_8h.html#a297">ExDestroyHandle</a>( ObjectTable,
00283                              <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00284                              ObjectTableEntry );
00285 
00286             <span class="comment">//</span>
00287             <span class="comment">//  perform any auditing required</span>
00288             <span class="comment">//</span>
00289 
00290             <span class="comment">//</span>
00291             <span class="comment">//  Extract the value of the GenerateOnClose bit stored</span>
00292             <span class="comment">//  after object open auditing is performed.  This value</span>
00293             <span class="comment">//  was stored by a call to ObSetGenerateOnClosed.</span>
00294             <span class="comment">//</span>
00295 
00296             <span class="keywordflow">if</span> (CapturedAttributes &amp; <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>) {
00297 
00298                 <span class="keywordflow">if</span> ( <a class="code" href="../../d7/d4/adt_8h.html#a3">SepAdtAuditingEnabled</a> ) {
00299 
00300                     <a class="code" href="../../d3/d5/seaudit_8c.html#a29">SeCloseObjectAuditAlarm</a>( Object,
00301                                              (HANDLE)((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> &amp; ~OBJ_HANDLE_TAGBITS),  <span class="comment">// Mask off the tagbits defined for OB objects.</span>
00302                                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00303                 }
00304             }
00305 
00306             <span class="comment">//</span>
00307             <span class="comment">//  Since we took the handle away we need to decrement the objects</span>
00308             <span class="comment">//  handle count, and remove a reference</span>
00309             <span class="comment">//</span>
00310 
00311             <a class="code" href="../../d5/d1/obp_8h.html#a78">ObpDecrementHandleCount</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
00312                                      ObjectHeader,
00313                                      ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>,
00314                                      CapturedGrantedAccess );
00315 
00316             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00317 
00318             <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"NtClose"</span>, ObjectType, Object );
00319 
00320             <span class="comment">//</span>
00321             <span class="comment">//  If we are attached to the system process then return</span>
00322             <span class="comment">//  back to our caller</span>
00323             <span class="comment">//</span>
00324 
00325             <span class="keywordflow">if</span> (AttachedToProcess) {
00326                 <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
00327                 AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00328             }
00329 
00330             <span class="comment">//</span>
00331             <span class="comment">//  And return to our caller</span>
00332             <span class="comment">//</span>
00333 
00334             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00335             leave;
00336 
00337         } <span class="keywordflow">else</span> {
00338 
00339             <span class="comment">//</span>
00340             <span class="comment">//  At this point the input handle did not translate to a valid</span>
00341             <span class="comment">//  object table entry</span>
00342             <span class="comment">//</span>
00343 
00344             <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"NtClose"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a10">ObpTypeObjectType</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
00345 
00346             <span class="comment">//</span>
00347             <span class="comment">//  If we are attached to the system process then return</span>
00348             <span class="comment">//  back to our caller</span>
00349             <span class="comment">//</span>
00350 
00351             <span class="keywordflow">if</span> (AttachedToProcess) {
00352                 <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
00353                 AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00354             }
00355 
00356             <span class="comment">//</span>
00357             <span class="comment">//  Now if the handle is not null and it does not represent the</span>
00358             <span class="comment">//  current thread or process then if we're user mode we either raise</span>
00359             <span class="comment">//  or return an error</span>
00360             <span class="comment">//</span>
00361 
00362             <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00363                 (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != NtCurrentThread()) &amp;&amp;
00364                 (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != NtCurrentProcess())) {
00365 
00366                 <span class="keywordflow">if</span> (KeGetPreviousMode() != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00367 
00368                     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_CLOSE_EXCEPTIONS) ||
00369                         (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00370 
00371                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a13">KeRaiseUserException</a>(STATUS_INVALID_HANDLE);
00372                         leave;
00373 
00374                     } <span class="keywordflow">else</span> {
00375 
00376                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
00377                         leave;
00378                     }
00379 
00380                 } <span class="keywordflow">else</span> {
00381 
00382                     <span class="comment">//</span>
00383                     <span class="comment">//  bugcheck here if kernel debugger is enabled and if kernel mode code is</span>
00384                     <span class="comment">//  closing a bogus handle and process is not exiting.  Ignore</span>
00385                     <span class="comment">//  if no PEB as this occurs if process is killed before</span>
00386                     <span class="comment">//  really starting.</span>
00387                     <span class="comment">//</span>
00388 
00389                     <span class="keywordflow">if</span> (( !<a class="code" href="../../d1/d9/ps_8h.html#a27">PsIsThreadTerminating</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())) &amp;&amp;
00390                         (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Peb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00391 
00392                         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a>) {
00393                             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(INVALID_KERNEL_HANDLE, (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, 1, 0, 0);
00394                         }
00395                     }
00396 
00397                 }
00398             }
00399 
00400             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
00401             leave;
00402         }
00403 
00404     } finally {
00405 
00406         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00407     }
00408 
00409     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00410 }
00411 
00412 
00413 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00414"></a><a class="code" href="../../d5/d0/obclose_8c.html#a2">00414</a> <a class="code" href="../../d5/d0/obclose_8c.html#a2">NtMakeTemporaryObject</a> (
00415     IN HANDLE Handle
00416     )
00417 
00418 <span class="comment">/*++</span>
00419 <span class="comment"></span>
00420 <span class="comment">Routine Description:</span>
00421 <span class="comment"></span>
00422 <span class="comment">    This routine makes the specified object non permanent.</span>
00423 <span class="comment"></span>
00424 <span class="comment">Arguments:</span>
00425 <span class="comment"></span>
00426 <span class="comment">    Handle - Supplies a handle to the object being modified</span>
00427 <span class="comment"></span>
00428 <span class="comment">Return Value:</span>
00429 <span class="comment"></span>
00430 <span class="comment">    An appropriate status value.</span>
00431 <span class="comment"></span>
00432 <span class="comment">--*/</span>
00433 
00434 {
00435     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00436     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00437     PVOID Object;
00438     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInformation;
00439 
00440     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00441 
00442     <span class="comment">//</span>
00443     <span class="comment">//  Get previous processor mode and probe output argument if necessary.</span>
00444     <span class="comment">//</span>
00445 
00446     PreviousMode = KeGetPreviousMode();
00447 
00448     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00449                                         DELETE,
00450                                         (<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00451                                         PreviousMode,
00452                                         &amp;Object,
00453                                         &amp;HandleInformation );
00454     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00455 
00456         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00457     }
00458 
00459     <span class="comment">//</span>
00460     <span class="comment">//  Make the object temporary.  Note that the object should still</span>
00461     <span class="comment">//  have a name and directory entry because its handle count is not</span>
00462     <span class="comment">//  zero</span>
00463     <span class="comment">//</span>
00464 
00465     <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a>( Object );
00466 
00467     <span class="comment">//</span>
00468     <span class="comment">//  Check if we need to generate a delete object audit/alarm</span>
00469     <span class="comment">//</span>
00470 
00471     <span class="keywordflow">if</span> (HandleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o0">HandleAttributes</a> &amp; <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>) {
00472 
00473         <a class="code" href="../../d3/d5/seaudit_8c.html#a30">SeDeleteObjectAuditAlarm</a>( Object,
00474                                   <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
00475     }
00476 
00477     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00478 
00479     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00480 }
00481 
00482 
00483 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00484"></a><a class="code" href="../../d5/d0/obclose_8c.html#a3">00484</a> <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a> (
00485     IN PVOID Object
00486     )
00487 
00488 <span class="comment">/*++</span>
00489 <span class="comment"></span>
00490 <span class="comment">Routine Description:</span>
00491 <span class="comment"></span>
00492 <span class="comment">    This routine removes the name of the object from its parent</span>
00493 <span class="comment">    directory.  The object is only removed if it has a non zero</span>
00494 <span class="comment">    handle count and a name.  Otherwise the object is simply</span>
00495 <span class="comment">    made non permanent</span>
00496 <span class="comment"></span>
00497 <span class="comment">Arguments:</span>
00498 <span class="comment"></span>
00499 <span class="comment">    Object - Supplies the object being modified</span>
00500 <span class="comment"></span>
00501 <span class="comment">Return Value:</span>
00502 <span class="comment"></span>
00503 <span class="comment">    None.</span>
00504 <span class="comment"></span>
00505 <span class="comment">--*/</span>
00506 
00507 {
00508     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00509 
00510     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00511 
00512     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00513     ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp;= ~<a class="code" href="../../d4/d0/ob_8h.html#a5">OB_FLAG_PERMANENT_OBJECT</a>;
00514 
00515     <a class="code" href="../../d7/d1/obref_8c.html#a11">ObpDeleteNameCheck</a>( Object, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00516 
00517     <span class="keywordflow">return</span>;
00518 }
00519 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:04 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
