<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: misc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>misc.c</h1><a href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: misc.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">*</span>
00007 <span class="comment">* History:</span>
00008 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00009 <span class="comment">\**************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/w32_2ntuser_2imm_2precomp_8h.html">precomp.h</a>"</span>
00012 <span class="preprocessor">#pragma hdrstop</span>
00013 <span class="preprocessor"></span>
00014 <span class="preprocessor">#ifdef HIRO_DEBUG</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#define D(x)    x</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00017"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a0">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define D(x)</span>
00018 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00019 <span class="preprocessor"></span>
00020 
00021 <span class="comment">/**************************************************************************\</span>
00022 <span class="comment">* ImmGetDefaultIMEWnd</span>
00023 <span class="comment">*</span>
00024 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00025 <span class="comment">\**************************************************************************/</span>
00026 
<a name="l00027"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a4">00027</a> HWND WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a4">ImmGetDefaultIMEWnd</a>(
00028     HWND hWnd)
00029 {
00030     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00031         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00032     }
00033     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00034         <span class="comment">/*</span>
00035 <span class="comment">         * Query default IME window of current thread.</span>
00036 <span class="comment">         */</span>
00037         <span class="keywordflow">return</span> (HWND)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateDefaultImeWindow);
00038     }
00039 
00040     <span class="keywordflow">return</span> (HWND)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">NtUserQueryWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, WindowDefaultImeWindow);
00041 }
00042 
00043 
00044 <span class="comment">/**************************************************************************\</span>
00045 <span class="comment">* ImmDisableIME</span>
00046 <span class="comment">*</span>
00047 <span class="comment">* 13-Sep-1996 wkwok       Created</span>
00048 <span class="comment">\**************************************************************************/</span>
00049 
<a name="l00050"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a5">00050</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a5">ImmDisableIME</a>(DWORD dwThreadId)
00051 {
00052 <span class="preprocessor">#ifdef LATER    // hiro</span>
00053 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (dwThreadId == -1) {
00054         <span class="comment">// Unload all IMEs</span>
00055         RtlEnterCriticalSection(&amp;<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a8">gcsImeDpi</a>);
00056         <span class="keywordflow">while</span> (<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a7">gpImeDpi</a>) {
00057             <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a> pImeDpi = <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a7">gpImeDpi</a>;
00058             <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a7">gpImeDpi</a> = <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a7">gpImeDpi</a>-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o0">pNext</a>;
00059             <a class="code" href="../../d6/d0/immime_8c.html#a9">UnloadIME</a>(pImeDpi, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00060             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pImeDpi);
00061         }
00062         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a8">gcsImeDpi</a>);
00063     }
00064 <span class="preprocessor">#endif</span>
00065 <span class="preprocessor"></span>    <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a401">NtUserDisableThreadIme</a>(dwThreadId);
00066 }
00067 
00068 <span class="comment">/**************************************************************************\</span>
00069 <span class="comment">* ImmIsUIMessageA</span>
00070 <span class="comment">*</span>
00071 <span class="comment">* Filter messages needed for IME window.</span>
00072 <span class="comment">*</span>
00073 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00074 <span class="comment">\**************************************************************************/</span>
00075 
<a name="l00076"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a6">00076</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a6">ImmIsUIMessageA</a>(
00077     HWND   hIMEWnd,
00078     UINT   message,
00079     WPARAM wParam,
00080     LPARAM lParam)
00081 {
00082     <span class="keywordflow">return</span> <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a8">ImmIsUIMessageWorker</a>(hIMEWnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00083 }
00084 
00085 
00086 <span class="comment">/**************************************************************************\</span>
00087 <span class="comment">* ImmIsUIMessageW</span>
00088 <span class="comment">*</span>
00089 <span class="comment">* Filter messages needed for IME window.</span>
00090 <span class="comment">*</span>
00091 <span class="comment">* 29-Feb-1996 wkwok       Created</span>
00092 <span class="comment">\**************************************************************************/</span>
00093 
<a name="l00094"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a7">00094</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a7">ImmIsUIMessageW</a>(
00095     HWND   hIMEWnd,
00096     UINT   message,
00097     WPARAM wParam,
00098     LPARAM lParam)
00099 {
00100     <span class="keywordflow">return</span> <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a8">ImmIsUIMessageWorker</a>(hIMEWnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00101 }
00102 
00103 
00104 <span class="comment">/**************************************************************************\</span>
00105 <span class="comment">* ImmIsUIMessageWorker</span>
00106 <span class="comment">*</span>
00107 <span class="comment">* Worker function of ImmIsUIMessageA/ImmIsUIMessageW.</span>
00108 <span class="comment">*</span>
00109 <span class="comment">* Return: True if message is processed by IME UI.</span>
00110 <span class="comment">*         False otherwise.</span>
00111 <span class="comment">*</span>
00112 <span class="comment">* 29-Feb-1996 wkwok       Created</span>
00113 <span class="comment">\**************************************************************************/</span>
00114 
<a name="l00115"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a8">00115</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a8">ImmIsUIMessageWorker</a>(
00116     HWND   hIMEWnd,
00117     UINT   message,
00118     WPARAM wParam,
00119     LPARAM lParam,
00120     BOOL   fAnsi)
00121 {
00122     <a class="code" href="../../d2/d0/imemenu_8c.html#a0">D</a>(<a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ImmIsUIMessageWorker(wnd[%08X], msg[%04X], wp[%08X], lp[%08X], Ansi[%d]\n"</span>,
00123       hIMEWnd, message, wParam, lParam, fAnsi));
00124 
00125     <span class="keywordflow">switch</span> (message) {
00126     <span class="keywordflow">case</span> WM_IME_STARTCOMPOSITION:
00127     <span class="keywordflow">case</span> WM_IME_ENDCOMPOSITION:
00128     <span class="keywordflow">case</span> WM_IME_COMPOSITION:
00129     <span class="keywordflow">case</span> WM_IME_SETCONTEXT:
00130     <span class="keywordflow">case</span> WM_IME_COMPOSITIONFULL:
00131     <span class="keywordflow">case</span> WM_IME_SELECT:
00132     <span class="keywordflow">case</span> WM_IME_NOTIFY:
00133     <span class="keywordflow">case</span> WM_IME_SYSTEM:
00134 
00135         <span class="keywordflow">if</span> (!hIMEWnd)
00136             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00137 
00138 <span class="preprocessor">#if DBG</span>
00139 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hIMEWnd)) {
00140             RIPMSG1(RIP_WARNING,
00141                   <span class="stringliteral">"ImmIsUIMessage: Invalid window handle %x"</span>, hIMEWnd);
00142             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00143         }
00144 <span class="preprocessor">#endif</span>
00145 <span class="preprocessor"></span>
00146         <span class="keywordflow">if</span> (fAnsi) {
00147             SendMessageA(hIMEWnd, message, wParam, lParam);
00148         }
00149         <span class="keywordflow">else</span> {
00150             SendMessageW(hIMEWnd, message, wParam, lParam);
00151         }
00152 
00153         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00154 
00155     <span class="keywordflow">default</span>:
00156         <span class="keywordflow">break</span>;
00157     }
00158 
00159     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00160 }
00161 
00162 
00163 <span class="comment">/**************************************************************************\</span>
00164 <span class="comment">* ImmGenerateMessage</span>
00165 <span class="comment">*</span>
00166 <span class="comment">* Sends message(s) that are stored in hMsgBuf of hImc to hWnd of hImc.</span>
00167 <span class="comment">*</span>
00168 <span class="comment">* 29-Feb-1996 wkwok       Created</span>
00169 <span class="comment">\**************************************************************************/</span>
00170 
<a name="l00171"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a9">00171</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a9">ImmGenerateMessage</a>(
00172     HIMC hImc)
00173 {
00174     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>    pClientImc;
00175     PINPUTCONTEXT pInputContext;
00176     PTRANSMSG     pTransMsg;
00177     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>           iNum;
00178     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>           i;
00179     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          fUnicodeImc;
00180 
00181     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc) != GetCurrentThreadId()) {
00182         RIPMSG1(RIP_WARNING,
00183               <span class="stringliteral">"ImmGenerateMessage: Invalid input context access %lx."</span>, hImc);
00184         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00185     }
00186 
00187     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc);
00188     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00189         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00190 
00191     fUnicodeImc = <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>);
00192 
00193     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00194 
00195     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
00196     <span class="keywordflow">if</span> (!pInputContext) {
00197         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGenerateMessage: Lock hImc %lx failed."</span>, hImc);
00198         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00199     }
00200 
00201     iNum = (<span class="keywordtype">int</span>)pInputContext-&gt;dwNumMsgBuf;
00202 
00203     <span class="keywordflow">if</span> (iNum &amp;&amp; (pTransMsg = (PTRANSMSG)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hMsgBuf))) {
00204         PTRANSMSG pTransMsgBuf, pTransMsgTemp;
00205 
00206         pTransMsgBuf = (PTRANSMSG)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, iNum * <span class="keyword">sizeof</span>(TRANSMSG));
00207 
00208         <span class="keywordflow">if</span> (pTransMsgBuf != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00209 
00210             RtlCopyMemory(pTransMsgBuf, pTransMsg, iNum * <span class="keyword">sizeof</span>(TRANSMSG));
00211 
00212             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;dwExpWinVer &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) {
00213                 <span class="comment">/*</span>
00214 <span class="comment">                 * translate messages for those applications that expect</span>
00215 <span class="comment">                 * old style IME messages.</span>
00216 <span class="comment">                 */</span>
00217                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLangId;
00218                 dwLangId = PRIMARYLANGID(LANGIDFROMLCID(GetSystemDefaultLCID()));
00219                 <span class="keywordflow">if</span> ( (dwLangId == LANG_KOREAN &amp;&amp; <a class="code" href="../../d2/d5/transsub_8c.html#a25">TransGetLevel</a>(pInputContext-&gt;hWnd) == 3) ||
00220                      (dwLangId == LANG_JAPANESE) ) {
00221                     iNum = <a class="code" href="../../d4/d3/ntuser_2imm_2input_8c.html#a5">WINNLSTranslateMessage</a>(iNum,
00222                                                   pTransMsgBuf,
00223                                                   hImc,
00224                                                   !fUnicodeImc,
00225                                                   dwLangId );
00226                 }
00227             }
00228 
00229             pTransMsgTemp = pTransMsgBuf;
00230 
00231             <span class="keywordflow">for</span> (i = 0; i &lt; iNum; i++) {
00232                 <span class="keywordflow">if</span> (fUnicodeImc) {
00233                     SendMessageW( pInputContext-&gt;hWnd,
00234                                   pTransMsgTemp-&gt;message,
00235                                   pTransMsgTemp-&gt;wParam,
00236                                   pTransMsgTemp-&gt;lParam );
00237                 } <span class="keywordflow">else</span> {
00238                     SendMessageW( pInputContext-&gt;hWnd,
00239                                   pTransMsgTemp-&gt;message,
00240                                   pTransMsgTemp-&gt;wParam,
00241                                   pTransMsgTemp-&gt;lParam );
00242                 }
00243                 pTransMsgTemp++;
00244             }
00245 
00246             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pTransMsgBuf);
00247         }
00248 
00249         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hMsgBuf);
00250     }
00251 
00252     <span class="comment">/*</span>
00253 <span class="comment">     * We should not reallocate the message buffer</span>
00254 <span class="comment">     */</span>
00255     pInputContext-&gt;dwNumMsgBuf = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00256 
00257     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00258 
00259     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00260 }
00261 
00262 
00263 <span class="comment">/**************************************************************************\</span>
00264 <span class="comment">* ImmGetVirtualKey</span>
00265 <span class="comment">*</span>
00266 <span class="comment">* Gets the actual virtual key which is preprocessed by an IME.</span>
00267 <span class="comment">*</span>
00268 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00269 <span class="comment">\**************************************************************************/</span>
00270 
<a name="l00271"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a10">00271</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a10">ImmGetVirtualKey</a>(
00272     HWND hWnd)
00273 {
00274     HIMC          hImc;
00275     PINPUTCONTEXT pInputContext;
00276     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>          uVirtKey;
00277 
00278     hImc = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a5">ImmGetContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00279 
00280     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
00281     <span class="keywordflow">if</span> (!pInputContext) {
00282         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetVirtualKey: lock IMC %x failure"</span>, hImc);
00283         <span class="keywordflow">return</span> (VK_PROCESSKEY);
00284     }
00285 
00286     <span class="keywordflow">if</span> (pInputContext-&gt;fChgMsg) {
00287         uVirtKey = pInputContext-&gt;uSavedVKey;
00288     } <span class="keywordflow">else</span> {
00289         uVirtKey = VK_PROCESSKEY;
00290     }
00291 
00292     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00293     <span class="keywordflow">return</span> (uVirtKey);
00294 }
00295 
00296 
00297 <span class="comment">/**************************************************************************\</span>
00298 <span class="comment">* ImmLockIMC</span>
00299 <span class="comment">*</span>
00300 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00301 <span class="comment">\**************************************************************************/</span>
00302 
<a name="l00303"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a11">00303</a> PINPUTCONTEXT WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a11">InternalImmLockIMC</a>(
00304     HIMC hImc,
00305     BOOL fCanCallImeSelect)
00306 {
00307     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>    pClientImc;
00308     PINPUTCONTEXT pInputContext;
00309     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         dwImcThreadId;
00310 
00311     <span class="keywordflow">if</span> ((pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00312         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00313 
00314     <a class="code" href="../../d9/d0/immuser_8h.html#a2">EnterImcCrit</a>(pClientImc);
00315 
00316     <span class="keywordflow">if</span> (pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o0">hInputContext</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00317         <span class="comment">/*</span>
00318 <span class="comment">         * If the owner thread of this hImc does not have</span>
00319 <span class="comment">         * default IME window, don't bother to create the</span>
00320 <span class="comment">         * INPUTCONTEXT. It could happen when some other</span>
00321 <span class="comment">         * thread which call ImmGetContext() to retrieve</span>
00322 <span class="comment">         * the associate hImc before the default IME window</span>
00323 <span class="comment">         * is created.</span>
00324 <span class="comment">         */</span>
00325         <span class="keywordflow">if</span> ((HWND)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a389">NtUserQueryInputContext</a>(hImc,
00326                 <a class="code" href="../../d8/d0/immstruc_8h.html#a74a50">InputContextDefaultImeWindow</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00327             <a class="code" href="../../d9/d0/immuser_8h.html#a3">LeaveImcCrit</a>(pClientImc);
00328             <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00329             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00330         }
00331 
00332         <span class="comment">/*</span>
00333 <span class="comment">         * This is a delay creation of INPUTCONTEXT structure. Create</span>
00334 <span class="comment">         * it now for this hImc.</span>
00335 <span class="comment">         */</span>
00336         pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o0">hInputContext</a> = LocalAlloc(<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a0">LHND</a>, <span class="keyword">sizeof</span>(INPUTCONTEXT));
00337 
00338         <span class="keywordflow">if</span> (pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o0">hInputContext</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00339             <a class="code" href="../../d9/d0/immuser_8h.html#a3">LeaveImcCrit</a>(pClientImc);
00340             <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00341             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00342         }
00343 
00344         dwImcThreadId = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a389">NtUserQueryInputContext</a>(hImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a74a49">InputContextThread</a>);
00345 
00346         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a2030">CreateInputContext</a>(hImc, <a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(dwImcThreadId), fCanCallImeSelect)) {
00347             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmLockIMC: CreateInputContext failed"</span>);
00348             LocalFree(pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o0">hInputContext</a>);
00349             pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o0">hInputContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00350             <a class="code" href="../../d9/d0/immuser_8h.html#a3">LeaveImcCrit</a>(pClientImc);
00351             <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00352             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00353         }
00354     }
00355 
00356     <a class="code" href="../../d9/d0/immuser_8h.html#a3">LeaveImcCrit</a>(pClientImc);
00357 
00358     pInputContext = (PINPUTCONTEXT)LocalLock(pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o0">hInputContext</a>);
00359 
00360     <span class="comment">/*</span>
00361 <span class="comment">     * Increment lock count so that the ImmUnlockClientImc() won't</span>
00362 <span class="comment">     * free up the pClientImc-&gt;hInputContext.</span>
00363 <span class="comment">     */</span>
00364     InterlockedIncrement(&amp;pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o1">cLockObj</a>);
00365 
00366     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00367 
00368     <span class="keywordflow">return</span> pInputContext;
00369 }
00370 
<a name="l00371"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">00371</a> PINPUTCONTEXT WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(
00372     HIMC hImc)
00373 {
00374     <span class="keywordflow">return</span> <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a11">InternalImmLockIMC</a>(hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00375 }
00376 
00377 <span class="comment">/**************************************************************************\</span>
00378 <span class="comment">* ImmUnlockIMC</span>
00379 <span class="comment">*</span>
00380 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00381 <span class="comment">\**************************************************************************/</span>
00382 
<a name="l00383"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">00383</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(
00384     HIMC hImc)
00385 {
00386     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a> pClientImc;
00387 
00388     <span class="keywordflow">if</span> ((pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00389         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00390 
00391     <span class="keywordflow">if</span> (pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o0">hInputContext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00392         LocalUnlock(pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o0">hInputContext</a>);
00393 
00394     <span class="comment">/*</span>
00395 <span class="comment">     * Decrement lock count so that the ImmUnlockClientImc() can</span>
00396 <span class="comment">     * free up the pClientImc-&gt;hInputContext if required.</span>
00397 <span class="comment">     */</span>
00398     InterlockedDecrement(&amp;pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o1">cLockObj</a>);
00399 
00400     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00401 
00402     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00403 }
00404 
00405 
00406 <span class="comment">/**************************************************************************\</span>
00407 <span class="comment">* ImmGetIMCLockCount</span>
00408 <span class="comment">*</span>
00409 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00410 <span class="comment">\**************************************************************************/</span>
00411 
<a name="l00412"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a14">00412</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a14">ImmGetIMCLockCount</a>(
00413     HIMC hImc)
00414 {
00415     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a> pClientImc;
00416     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      dwRet = 0;
00417 
00418     <span class="keywordflow">if</span> ((pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00419         <span class="keywordflow">return</span> dwRet;
00420 
00421     <span class="keywordflow">if</span> (pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o0">hInputContext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00422         dwRet = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(LocalFlags(pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o0">hInputContext</a>) &amp; LMEM_LOCKCOUNT);
00423 
00424     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00425 
00426     <span class="keywordflow">return</span> dwRet;
00427 }
00428 
00429 
00430 <span class="comment">/**************************************************************************\</span>
00431 <span class="comment">* ImmCreateIMCC</span>
00432 <span class="comment">*</span>
00433 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00434 <span class="comment">\**************************************************************************/</span>
00435 
<a name="l00436"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">00436</a> HIMCC WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(
00437     DWORD dwSize)
00438 {
00439     <span class="comment">// At least size should be DWORD.</span>
00440     <span class="keywordflow">if</span> (dwSize &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) {
00441         dwSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00442     }
00443 
00444     <span class="keywordflow">return</span> (HIMCC)LocalAlloc(<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a0">LHND</a>, dwSize);
00445 }
00446 
00447 
00448 <span class="comment">/**************************************************************************\</span>
00449 <span class="comment">* ImmDestroyIMCC</span>
00450 <span class="comment">*</span>
00451 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00452 <span class="comment">\**************************************************************************/</span>
00453 
<a name="l00454"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">00454</a> HIMCC WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(
00455     HIMCC hIMCC)
00456 {
00457     <span class="keywordflow">if</span> (hIMCC == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00458         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00459     }
00460 
00461     <span class="keywordflow">return</span> (HIMCC)LocalFree(hIMCC);
00462 }
00463 
00464 
00465 <span class="comment">/**************************************************************************\</span>
00466 <span class="comment">* ImmLockIMCC</span>
00467 <span class="comment">*</span>
00468 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00469 <span class="comment">\**************************************************************************/</span>
00470 
<a name="l00471"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">00471</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(
00472     HIMCC hIMCC)
00473 {
00474     <span class="keywordflow">if</span> (hIMCC == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00475         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00476     }
00477 
00478     <span class="keywordflow">return</span> LocalLock(hIMCC);
00479 }
00480 
00481 
00482 <span class="comment">/**************************************************************************\</span>
00483 <span class="comment">* ImmUnlockIMCC</span>
00484 <span class="comment">*</span>
00485 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00486 <span class="comment">\**************************************************************************/</span>
00487 
<a name="l00488"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">00488</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(
00489     HIMCC hIMCC)
00490 {
00491     <span class="keywordflow">if</span> (hIMCC == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00492         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00493     }
00494 
00495     <span class="keywordflow">return</span> LocalUnlock(hIMCC);
00496 }
00497 
00498 
00499 <span class="comment">/**************************************************************************\</span>
00500 <span class="comment">* ImmGetIMCCLockCount</span>
00501 <span class="comment">*</span>
00502 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00503 <span class="comment">\**************************************************************************/</span>
00504 
<a name="l00505"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a19">00505</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a19">ImmGetIMCCLockCount</a>(
00506     HIMCC hIMCC)
00507 {
00508     <span class="keywordflow">if</span> (hIMCC == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00509         <span class="keywordflow">return</span> 0;
00510     }
00511 
00512     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(LocalFlags(hIMCC) &amp; LMEM_LOCKCOUNT);
00513 }
00514 
00515 
00516 <span class="comment">/**************************************************************************\</span>
00517 <span class="comment">* ImmReSizeIMCC</span>
00518 <span class="comment">*</span>
00519 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00520 <span class="comment">\**************************************************************************/</span>
00521 
<a name="l00522"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a20">00522</a> HIMCC WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a20">ImmReSizeIMCC</a>(
00523     HIMCC hIMCC,
00524     DWORD dwSize)
00525 {
00526     <span class="keywordflow">if</span> (hIMCC == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00527         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00528     }
00529 
00530     <span class="keywordflow">return</span> (HIMCC)LocalReAlloc(hIMCC, dwSize, <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a0">LHND</a>);
00531 }
00532 
00533 
00534 <span class="comment">/**************************************************************************\</span>
00535 <span class="comment">* ImmGetIMCCSize</span>
00536 <span class="comment">*</span>
00537 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00538 <span class="comment">\**************************************************************************/</span>
00539 
<a name="l00540"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a21">00540</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a21">ImmGetIMCCSize</a>(
00541     HIMCC hIMCC)
00542 {
00543     <span class="keywordflow">if</span> (hIMCC == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00544         <span class="keywordflow">return</span> 0;
00545     }
00546 
00547     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)LocalSize(hIMCC);
00548 }
00549 
00550 
00551 <span class="comment">/**************************************************************************\</span>
00552 <span class="comment">* ImmLocalAlloc</span>
00553 <span class="comment">*</span>
00554 <span class="comment">* 18-Jun-1996 wkwok       Created</span>
00555 <span class="comment">\**************************************************************************/</span>
00556 
<a name="l00557"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">00557</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(
00558     DWORD uFlag,
00559     DWORD uBytes)
00560 {
00561     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a3">pImmHeap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00562         <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a3">pImmHeap</a> = RtlProcessHeap();
00563         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a3">pImmHeap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00564             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmLocalAlloc: NULL pImmHeap!"</span>);
00565             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00566         }
00567     }
00568 
00569     <span class="keywordflow">return</span> HeapAlloc(<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a3">pImmHeap</a>, uFlag, uBytes);
00570 }
00571 
00572 
00573 <span class="comment">/***************************************************************************\</span>
00574 <span class="comment">* PtiCurrent</span>
00575 <span class="comment">*</span>
00576 <span class="comment">* Returns the THREADINFO structure for the current thread.</span>
00577 <span class="comment">* LATER: Get DLL_THREAD_ATTACH initialization working right and we won't</span>
00578 <span class="comment">*        need this connect code.</span>
00579 <span class="comment">*</span>
00580 <span class="comment">* History:</span>
00581 <span class="comment">* 10-28-90 DavidPe      Created.</span>
00582 <span class="comment">* 02-21-96 wkwok        Copied from USER32.DLL</span>
00583 <span class="comment">\***************************************************************************/</span>
00584 
<a name="l00585"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a23">00585</a> <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(VOID)
00586 {
00587     <a class="code" href="../../d1/d0/inc_2user_8h.html#a848">ConnectIfNecessary</a>();
00588     <span class="keywordflow">return</span> (<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)NtCurrentTebShared()-&gt;Win32ThreadInfo;
00589 }
00590 
00591 
00592 <span class="comment">/**************************************************************************\</span>
00593 <span class="comment">* TestInputContextProcess</span>
00594 <span class="comment">*</span>
00595 <span class="comment">* 02-21-96 wkwok        Created</span>
00596 <span class="comment">\**************************************************************************/</span>
00597 
<a name="l00598"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a24">00598</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a24">TestInputContextProcess</a>(
00599     <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a> pImc)
00600 {
00601     <span class="comment">/*</span>
00602 <span class="comment">     * If the threads are the same, don't bother going to the kernel</span>
00603 <span class="comment">     * to get the input context's process id.</span>
00604 <span class="comment">     */</span>
00605     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pImc) == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()) {
00606         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00607     }
00608 
00609     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a14">GetInputContextProcess</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pImc)) == <a class="code" href="../../d6/d0/usercli_8h.html#a13">GETPROCESSID</a>());
00610 }
00611 
00612 <span class="comment">/**************************************************************************\</span>
00613 <span class="comment">* TestWindowProcess</span>
00614 <span class="comment">*</span>
00615 <span class="comment">* 11-14-94 JimA         Created.</span>
00616 <span class="comment">* 02-29-96 wkwok        Copied from USER32.DLL</span>
00617 <span class="comment">\**************************************************************************/</span>
00618 
<a name="l00619"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a25">00619</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a16">TestWindowProcess</a>(
00620     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00621 {
00622     <span class="comment">/*</span>
00623 <span class="comment">     * If the threads are the same, don't bother going to the kernel</span>
00624 <span class="comment">     * to get the window's process id.</span>
00625 <span class="comment">     */</span>
00626     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()) {
00627         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00628     }
00629 
00630     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a12">GetWindowProcess</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd)) == <a class="code" href="../../d6/d0/usercli_8h.html#a13">GETPROCESSID</a>());
00631 }
00632 
00633 
00634 <span class="comment">/**************************************************************************\</span>
00635 <span class="comment">* GetKeyboardLayoutCP</span>
00636 <span class="comment">*</span>
00637 <span class="comment">* 12-Mar-1996 wkwok       Created</span>
00638 <span class="comment">\**************************************************************************/</span>
00639 
<a name="l00640"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a2">00640</a> <span class="keyword">static</span> LCID <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a2">CachedLCID</a> = 0;
<a name="l00641"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a3">00641</a> <span class="keyword">static</span> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a3">CachedCP</a> = CP_ACP;
00642 
<a name="l00643"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a26">00643</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a26">GetKeyboardLayoutCP</a>(
00644     HKL hKL)
00645 {
00646 <span class="preprocessor">    #define LOCALE_CPDATA 7</span>
00647 <span class="preprocessor"></span>    WCHAR wszCodePage[<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a1">LOCALE_CPDATA</a>];
00648     LCID  lcid;
00649 
00650     lcid = MAKELCID(LOWORD(HandleToUlong(hKL)), SORT_DEFAULT);
00651 
00652     <span class="keywordflow">if</span> (lcid == <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a2">CachedLCID</a>)
00653         <span class="keywordflow">return</span> <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a3">CachedCP</a>;
00654 
00655     <span class="keywordflow">if</span> (!GetLocaleInfoW(lcid, LOCALE_IDEFAULTANSICODEPAGE,
00656                 wszCodePage, <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a1">LOCALE_CPDATA</a>))
00657         <span class="keywordflow">return</span> CP_ACP;
00658 
00659     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a2">CachedLCID</a> = lcid;
00660     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a3">CachedCP</a> = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wcstol(wszCodePage, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 10);
00661 
00662     <span class="keywordflow">return</span> <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a3">CachedCP</a>;
00663 }
00664 
00665 
00666 <span class="comment">/**************************************************************************\</span>
00667 <span class="comment">* GetKeyboardLayoutCP</span>
00668 <span class="comment">*</span>
00669 <span class="comment">* 12-Mar-1996 wkwok       Created</span>
00670 <span class="comment">\**************************************************************************/</span>
00671 
<a name="l00672"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a27">00672</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a27">GetThreadKeyboardLayoutCP</a>(
00673     DWORD dwThreadId)
00674 {
00675     HKL hKL;
00676 
00677     hKL = <a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(dwThreadId);
00678 
00679     <span class="keywordflow">return</span> <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a26">GetKeyboardLayoutCP</a>(hKL);
00680 }
00681 
00682 
00683 <span class="comment">/**************************************************************************\</span>
00684 <span class="comment">* ImmLockClientImc</span>
00685 <span class="comment">*</span>
00686 <span class="comment">* 13-Mar-1996 wkwok       Created</span>
00687 <span class="comment">\**************************************************************************/</span>
00688 
<a name="l00689"></a><a class="code" href="../../d9/d0/immuser_8h.html#a43">00689</a> <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a> WINAPI <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(
00690     HIMC hImc)
00691 {
00692     <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a>       pImc;
00693     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a> pClientImc;
00694 
00695     <span class="keywordflow">if</span> (hImc == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>)
00696         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00697 
00698     pImc = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>((HANDLE)hImc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a253">TYPE_INPUTCONTEXT</a>);
00699 
00700     <span class="comment">/*</span>
00701 <span class="comment">     * Cannot access input context from other process.</span>
00702 <span class="comment">     */</span>
00703     <span class="keywordflow">if</span> (pImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || !<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a24">TestInputContextProcess</a>(pImc))
00704         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00705 
00706     pClientImc = (<a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>)pImc-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o2">dwClientImcData</a>;
00707 
00708     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00709         <span class="comment">/*</span>
00710 <span class="comment">         * We delay the creation of client side per-thread default Imc.</span>
00711 <span class="comment">         * Now, this is the time to create it.</span>
00712 <span class="comment">         */</span>
00713         pClientImc = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(HEAP_ZERO_MEMORY, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d0/structtagCLIENTIMC.html">CLIENTIMC</a>));
00714         <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00715             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00716 
00717         <a class="code" href="../../d9/d0/immuser_8h.html#a0">InitImcCrit</a>(pClientImc);
00718         pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o3">dwImeCompatFlags</a> = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateImeCompatFlags);
00719 
00720         <span class="comment">/*</span>
00721 <span class="comment">         * Update the kernel side input context.</span>
00722 <span class="comment">         */</span>
00723         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a388">NtUserUpdateInputContext</a>(hImc,
00724                 <a class="code" href="../../d8/d0/immstruc_8h.html#a73a46">UpdateClientInputContext</a>, (ULONG_PTR)pClientImc)) {
00725             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pClientImc);
00726             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00727         }
00728 
00729         <span class="comment">/*</span>
00730 <span class="comment">         * Marks with default input context signature.</span>
00731 <span class="comment">         */</span>
00732         <a class="code" href="../../d4/d0/immcli_8h.html#a19">SetICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a12">IMCF_DEFAULTIMC</a>);
00733     }
00734     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a10">IMCF_INDESTROY</a>)) {
00735         <span class="comment">/*</span>
00736 <span class="comment">         * Cannot access destroyed input context.</span>
00737 <span class="comment">         */</span>
00738         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00739     }
00740 
00741     InterlockedIncrement(&amp;pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o1">cLockObj</a>);
00742 
00743     <span class="keywordflow">return</span> pClientImc;
00744 }
00745 
00746 
<a name="l00747"></a><a class="code" href="../../d9/d0/immuser_8h.html#a44">00747</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> WINAPI <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(
00748     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a> pClientImc)
00749 {
00750     <span class="keywordflow">if</span> (InterlockedDecrement(&amp;pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o1">cLockObj</a>) == 0) {
00751         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a10">IMCF_INDESTROY</a>)) {
00752             <span class="keywordflow">if</span> (pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o0">hInputContext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00753                 LocalFree(pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o0">hInputContext</a>);
00754 
00755             <a class="code" href="../../d9/d0/immuser_8h.html#a1">DeleteImcCrit</a>(pClientImc);
00756             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pClientImc);
00757         }
00758     }
00759 
00760     <span class="keywordflow">return</span>;
00761 }
00762 
00763 <span class="comment">/**************************************************************************\</span>
00764 <span class="comment">* ImmGetImeDpi</span>
00765 <span class="comment">*</span>
00766 <span class="comment">* 08-Jan-1996 wkwok       Created</span>
00767 <span class="comment">\**************************************************************************/</span>
00768 
<a name="l00769"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a30">00769</a> <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a> WINAPI <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a30">ImmGetImeDpi</a>(
00770     HKL hKL)
00771 {
00772     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a> pImeDpi;
00773 
00774     RtlEnterCriticalSection(&amp;<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a8">gcsImeDpi</a>);
00775 
00776     pImeDpi = <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a7">gpImeDpi</a>;
00777 
00778     <span class="keywordflow">while</span> (pImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o2">hKL</a> != hKL)
00779         pImeDpi = pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o0">pNext</a>;
00780 
00781     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a8">gcsImeDpi</a>);
00782 
00783     <span class="keywordflow">return</span> (<a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a>)pImeDpi;
00784 }
00785 
00786 
00787 <span class="comment">/**************************************************************************\</span>
00788 <span class="comment">* ImmLockImeDpi</span>
00789 <span class="comment">*</span>
00790 <span class="comment">* 08-Jan-1996 wkwok       Created</span>
00791 <span class="comment">\**************************************************************************/</span>
00792 
<a name="l00793"></a><a class="code" href="../../d9/d0/immuser_8h.html#a45">00793</a> <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a> WINAPI <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(
00794     HKL hKL)
00795 {
00796     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a> pImeDpi;
00797 
00798     RtlEnterCriticalSection(&amp;<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a8">gcsImeDpi</a>);
00799 
00800     pImeDpi = <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a7">gpImeDpi</a>;
00801 
00802     <span class="keywordflow">while</span> (pImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o2">hKL</a> != hKL)
00803         pImeDpi = pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o0">pNext</a>;
00804 
00805     <span class="keywordflow">if</span> (pImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00806         <span class="keywordflow">if</span> (pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o7">dwFlag</a> &amp; <a class="code" href="../../d9/d0/immuser_8h.html#a4">IMEDPI_UNLOADED</a>)
00807             pImeDpi = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00808         <span class="keywordflow">else</span>
00809             pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o6">cLock</a>++;
00810     }
00811 
00812     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a8">gcsImeDpi</a>);
00813 
00814     <span class="keywordflow">return</span> (<a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a>)pImeDpi;
00815 }
00816 
00817 
00818 <span class="comment">/**************************************************************************\</span>
00819 <span class="comment">* ImmUnlockImeDpi</span>
00820 <span class="comment">*</span>
00821 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00822 <span class="comment">\**************************************************************************/</span>
00823 
<a name="l00824"></a><a class="code" href="../../d9/d0/immuser_8h.html#a46">00824</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> WINAPI <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(
00825     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a> pImeDpi)
00826 {
00827     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a> pImeDpiT;
00828 
00829     <span class="keywordflow">if</span> (pImeDpi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00830         <span class="keywordflow">return</span>;
00831 
00832     RtlEnterCriticalSection(&amp;<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a8">gcsImeDpi</a>);
00833 
00834     <span class="keywordflow">if</span> (--pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o6">cLock</a> == 0) {
00835 
00836         <span class="keywordflow">if</span> ((pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o7">dwFlag</a> &amp; <a class="code" href="../../d9/d0/immuser_8h.html#a4">IMEDPI_UNLOADED</a>) ||
00837             ((pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o7">dwFlag</a> &amp; <a class="code" href="../../d9/d0/immuser_8h.html#a5">IMEDPI_UNLOCKUNLOAD</a>) &amp;&amp;
00838              (pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_END_UNLOAD)))
00839         {
00840             <span class="comment">/*</span>
00841 <span class="comment">             * Unlink it.</span>
00842 <span class="comment">             */</span>
00843             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a7">gpImeDpi</a> == pImeDpi) {
00844                 <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a7">gpImeDpi</a> = pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o0">pNext</a>;
00845             }
00846             <span class="keywordflow">else</span> {
00847                 pImeDpiT = <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a7">gpImeDpi</a>;
00848 
00849                 <span class="keywordflow">while</span> (pImeDpiT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pImeDpiT-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o0">pNext</a> != pImeDpi)
00850                     pImeDpiT = pImeDpiT-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o0">pNext</a>;
00851 
00852                 <span class="keywordflow">if</span> (pImeDpiT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00853                     pImeDpiT-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o0">pNext</a> = pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o0">pNext</a>;
00854             }
00855 
00856             <span class="comment">/*</span>
00857 <span class="comment">             * Unload the IME DLL.</span>
00858 <span class="comment">             */</span>
00859             <a class="code" href="../../d6/d0/immime_8c.html#a9">UnloadIME</a>(pImeDpi, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00860             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pImeDpi);
00861         }
00862     }
00863 
00864     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a8">gcsImeDpi</a>);
00865 
00866     <span class="keywordflow">return</span>;
00867 }
00868 
00869 
00870 <span class="comment">/**************************************************************************\</span>
00871 <span class="comment">* ImmGetImeInfoEx</span>
00872 <span class="comment">*</span>
00873 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00874 <span class="comment">\**************************************************************************/</span>
00875 
<a name="l00876"></a><a class="code" href="../../d9/d0/immuser_8h.html#a47">00876</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(
00877     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a> piiex,
00878     IMEINFOEXCLASS SearchType,
00879     PVOID pvSearchKey)
00880 {
00881     <a class="code" href="../../d4/d0/immcli_8h.html#a2">ImmAssert</a>(piiex != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pvSearchKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00882 
00883     <span class="keywordflow">switch</span> (SearchType) {
00884     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>:
00885         piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a> = *((HKL *)pvSearchKey);
00886         <span class="comment">/*</span>
00887 <span class="comment">         * Quick return for non-IME based keyboard layout</span>
00888 <span class="comment">         */</span>
00889         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a>))
00890             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00891         <span class="keywordflow">break</span>;
00892 
00893     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a75a54">ImeInfoExImeFileName</a>:
00894         wcscpy(piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>, (PWSTR)pvSearchKey);
00895         <span class="keywordflow">break</span>;
00896 
00897     <span class="keywordflow">default</span>:
00898         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00899     }
00900 
00901     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a391">NtUserGetImeInfoEx</a>(piiex, SearchType);
00902 }
00903 
00904 <span class="comment">/**************************************************************************\</span>
00905 <span class="comment">* ImmGetAppCompatFlags</span>
00906 <span class="comment">*</span>
00907 <span class="comment">* private function</span>
00908 <span class="comment">* returns Win95 compatible IME Compatibility flags</span>
00909 <span class="comment">*</span>
00910 <span class="comment">* 02-July-1996 takaok       Created</span>
00911 <span class="comment">\**************************************************************************/</span>
<a name="l00912"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a34">00912</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a34">ImmGetAppCompatFlags</a>( HIMC hImc )
00913 {
00914     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>    pClientImc;
00915     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         dwImeCompat = 0;
00916 
00917     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>( hImc );
00918     <span class="keywordflow">if</span> ( pClientImc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00919         dwImeCompat = pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o3">dwImeCompatFlags</a>;
00920         <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>( pClientImc );
00921     }
00922     <span class="keywordflow">return</span> dwImeCompat;
00923 }
00924 
00925 <span class="comment">/**************************************************************************\</span>
00926 <span class="comment">* ImmPtInRect</span>
00927 <span class="comment">*</span>
00928 <span class="comment">* private function</span>
00929 <span class="comment">*</span>
00930 <span class="comment">* 02-July-1997 hiroyama     Created</span>
00931 <span class="comment">\**************************************************************************/</span>
00932 
<a name="l00933"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a35">00933</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a35">ImmPtInRect</a>(
00934     <span class="keywordtype">int</span> left,
00935     <span class="keywordtype">int</span> top,
00936     <span class="keywordtype">int</span> width,
00937     <span class="keywordtype">int</span> height,
00938     LPPOINT lppt)
00939 {
00940     <span class="keywordflow">return</span> (lppt-&gt;x &gt;= left &amp;&amp; lppt-&gt;x &lt; (left + width) &amp;&amp;
00941             lppt-&gt;y &gt;= top  &amp;&amp; lppt-&gt;y &lt; (top + height));
00942 }
00943 
00944 
00945 <span class="comment">/**************************************************************************\</span>
00946 <span class="comment">* ImmSystemHandler</span>
00947 <span class="comment">*</span>
00948 <span class="comment">* private function</span>
00949 <span class="comment">*</span>
00950 <span class="comment">* IMM bulk helper to handle WM_IME_SYSTEM message</span>
00951 <span class="comment">*</span>
00952 <span class="comment">* 02-July-1997 hiroyama     Created</span>
00953 <span class="comment">\**************************************************************************/</span>
00954 
<a name="l00955"></a><a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a36">00955</a> LRESULT <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a36">ImmSystemHandler</a>(
00956     HIMC hImc,
00957     WPARAM wParam,
00958     LPARAM lParam)
00959 {
00960     LRESULT lRet = 0;
00961 
00962     <span class="keywordflow">switch</span> (wParam) {
00963     <span class="keywordflow">case</span> IMS_SENDNOTIFICATION:
00964         <a class="code" href="../../d4/d0/immcli_8h.html#a86">ImmSendNotification</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)lParam);
00965         <span class="keywordflow">break</span>;
00966     <span class="keywordflow">case</span> IMS_FINALIZE_COMPSTR:
00967         <a class="code" href="../../d6/d0/immime_8c.html#a22">ImmNotifyIME</a>(hImc, NI_COMPOSITIONSTR, CPS_COMPLETE, 0);
00968         <span class="keywordflow">break</span>;
00969     }
00970 
00971     <span class="keywordflow">return</span> lRet;
00972 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:49 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
