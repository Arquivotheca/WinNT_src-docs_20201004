<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kernlini.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kernlini.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>
<code>#include "<a class="el" href="../../d2/d9/ki386_8h-source.html">ki386.h</a>"</code><br>
<code>#include "<a class="el" href="../../d5/d0/fastsys_8inc-source.html">fastsys.inc</a>"</code><br>

<p>
<a href="../../d7/d8/kernlini_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a0">TRAP332_GATE</a>&nbsp;&nbsp;&nbsp;0xEF00</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a1">RET</a>&nbsp;&nbsp;&nbsp;0xc3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a2">CRC_NDX</a>&nbsp;&nbsp;&nbsp;(PUCHAR)0x22</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a3">CRC_DAT</a>&nbsp;&nbsp;&nbsp;(CRC_NDX + 1)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a4">CCR1</a>&nbsp;&nbsp;&nbsp;0xc1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a5">CPUID_REG_COUNT</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a6">MAX_ATTEMPTS</a>&nbsp;&nbsp;&nbsp;10</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a7">IDT_SKIP</a>&nbsp;&nbsp;&nbsp;(7 * sizeof (KIDTENTRY))</td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a61">CPU_VENDORS</a> { <br>
&nbsp;&nbsp;<a class="el" href="../../d6/d9/kernlini_8c.html#a61a28">CPU_NONE</a>, 
<a class="el" href="../../d6/d9/kernlini_8c.html#a61a29">CPU_INTEL</a>, 
<a class="el" href="../../d6/d9/kernlini_8c.html#a61a30">CPU_AMD</a>, 
<a class="el" href="../../d6/d9/kernlini_8c.html#a61a31">CPU_CYRIX</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="../../d6/d9/kernlini_8c.html#a61a32">CPU_UNKNOWN</a>
<br>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a33">KiSetProcessorType</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a34">KiSetCR0Bits</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a35">KiIsNpxPresent</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a36">KiI386PentiumLockErrataFixup</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a37">KiInitializeDblFaultTSS</a> (IN PKTSS Tss, IN ULONG Stack, IN PKGDTENTRY TssDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a38">KiInitializeTSS2</a> (IN PKTSS Tss, IN PKGDTENTRY TssDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a39">KiSwapIDT</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a40">KeSetup80387OrEmulate</a> (IN PVOID *R3EmulatorTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a41">KiGetCacheInformation</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a42">KiGetCpuVendor</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a43">KiGetFeatureBits</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a44">KiMoveRegTree</a> (HANDLE Source, HANDLE Dest)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a45">Ki386EnableFxsr</a> (IN volatile PLONG Number)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a46">Ki386EnableXMMIExceptions</a> (IN volatile PLONG Number)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a47">Ki386EnableGlobalPage</a> (IN volatile PLONG Number)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a48">Ki386UseSynchronousTbFlush</a> (IN volatile PLONG Number)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a49">KiInitMachineDependent</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a50">KiInitializeMTRR</a> (IN BOOLEAN LastProcessor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a51">KiInitializePAT</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a52">KiAmdK6InitializeMTRR</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a53">KiZeroPage</a> (PVOID PageBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a54">KiXMMIZeroPage</a> (PVOID PageBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a55">KiXMMIZeroPageNoSave</a> (PVOID PageBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a56">KiInitializeKernel</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process, IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread, IN PVOID IdleStack, IN PKPRCB Prcb, IN CCHAR Number, <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a57">KiInitializePcr</a> (IN ULONG Processor, IN PKPCR Pcr, IN PKIDTENTRY Idt, IN PKGDTENTRY Gdt, IN PKTSS Tss, IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread, IN PVOID DpcStack)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a58">KiInitializeTSS</a> (IN PKTSS Tss)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a59">KiSwapIDT</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a60">KeOptimizeProcessorControlState</a> (VOID)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a8">CcMasterSpinLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a9">CcVacbSpinLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a10">MmPfnLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a11">MmSystemSpaceLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a12">KiI386PentiumLockErrataPresent</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a13">KiIgnoreUnexpectedTrap07</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a14">Ki387RoundModeTable</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a15">Ki386IopmSaveArea</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a16">KeI386ForceNpxEmulation</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a17">CmDisabledFloatingPointProcessor</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a18">CmpCyrixID</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a19">CmpIntelID</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a20">CmpAmdID</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a21">ScPatchFxb</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a22">ScPatchFxe</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a23">KeI386XMMIPresent</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KE_ZERO_PAGE_ROUTINE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a24">KeZeroPage</a> = KiZeroPage</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KE_ZERO_PAGE_ROUTINE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a25">KeZeroPageFromIdleThread</a> = KiZeroPage</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a26">Ki486CompatibilityLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KIDTENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/kernlini_8c.html#a27">IDT</a> []</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a4" doxytag="kernlini.c::CCR1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CCR1&nbsp;&nbsp;&nbsp;0xc1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="kernlini.c::CPUID_REG_COUNT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CPUID_REG_COUNT&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01509">KiGetCacheInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="kernlini.c::CRC_DAT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CRC_DAT&nbsp;&nbsp;&nbsp;(CRC_NDX + 1)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="kernlini.c::CRC_NDX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CRC_NDX&nbsp;&nbsp;&nbsp;(PUCHAR)0x22          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="kernlini.c::IDT_SKIP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IDT_SKIP&nbsp;&nbsp;&nbsp;(7 * sizeof (KIDTENTRY))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02460">KiI386PentiumLockErrataFixup()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="kernlini.c::MAX_ATTEMPTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_ATTEMPTS&nbsp;&nbsp;&nbsp;10          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01688">1688</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">KiInitMachineDependent()</a>, and <a class="el" href="../../d2/d9/client_2help_8c-source.html#l00447">WinHelpA()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="kernlini.c::RET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RET&nbsp;&nbsp;&nbsp;0xc3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00246">KiInitializeKernel()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="kernlini.c::TRAP332_GATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TRAP332_GATE&nbsp;&nbsp;&nbsp;0xEF00          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00041">41</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02008">KeSetup80387OrEmulate()</a>.    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a61" doxytag="kernlini.c::CPU_VENDORS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d6/d9/kernlini_8c.html#a61">CPU_VENDORS</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a61a28" doxytag="CPU_NONE" ></a>CPU_NONE</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a61a29" doxytag="CPU_INTEL" ></a>CPU_INTEL</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a61a30" doxytag="CPU_AMD" ></a>CPU_AMD</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a61a31" doxytag="CPU_CYRIX" ></a>CPU_CYRIX</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a61a32" doxytag="CPU_UNKNOWN" ></a>CPU_UNKNOWN</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00194">194</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
<pre class="fragment"><div>00194              {
00195     <a class="code" href="../../d6/d9/kernlini_8c.html#a61a28">CPU_NONE</a>,
00196     <a class="code" href="../../d6/d9/kernlini_8c.html#a61a29">CPU_INTEL</a>,
00197     <a class="code" href="../../d6/d9/kernlini_8c.html#a61a30">CPU_AMD</a>,
00198     <a class="code" href="../../d6/d9/kernlini_8c.html#a61a31">CPU_CYRIX</a>,
00199     <a class="code" href="../../d6/d9/kernlini_8c.html#a61a32">CPU_UNKNOWN</a>
00200 } <a class="code" href="../../d6/d9/kernlini_8c.html#a61">CPU_VENDORS</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a60" doxytag="kernlini.c::KeOptimizeProcessorControlState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeOptimizeProcessorControlState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01998">1998</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
References <a class="el" href="../../d0/d1/cyrix_8c-source.html#l00270">Ke386ConfigureCyrixProcessor()</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01986">CmpConfigureProcessors()</a>.
<p>
<pre class="fragment"><div>02001 {
02002     <a class="code" href="../../d9/d1/cyrix_8c.html#a27">Ke386ConfigureCyrixProcessor</a> ();
02003 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="kernlini.c::KeSetup80387OrEmulate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeSetup80387OrEmulate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>R3EmulatorTable</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02008">2008</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
References <a class="el" href="../../d3/d1/i386_2initdat_8c-source.html#l00053">CmDisabledFloatingPointProcessor</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00170">CmRegistryMachineHardwareDescriptionSystemName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00108">CmTypeName</a>, <a class="el" href="../../d0/d1/lboxctl2_8c-source.html#l02757">Compare()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d9/arc_8h.html#a315a189">FloatingPointProcessor</a>, <a class="el" href="../../d4/d9/user32_8def-source.html#l00990">is</a>, <a class="el" href="../../d2/d8/icmui_8def-source.html#l00012">it</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02766">KeActiveProcessors</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02780">KeFeatureBits</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00068">KeGetPcr</a>, <a class="el" href="../../d8/d2/i386init_8c-source.html#l00041">KeI386ForceNpxEmulation</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02694">KeI386NpxPresent</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01153">KeRevertToUserAffinityThread()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01467">KeSetSystemAffinityThread()</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02713">KF_FXSR</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02710">KF_MMX</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02715">KF_XMMI</a>, <a class="el" href="../../d8/d2/i386init_8c-source.html#l00044">Ki387RoundModeTable</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02297">KiMoveRegTree()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d8/d3/conexts_8c-source.html#l00026">move</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d8/d0/genuedef_8c-source.html#l00006">the</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00041">TRAP332_GATE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00745">PspInitializeSystemDll()</a>.
<p>
<pre class="fragment"><div>02014                    :
02015 
02016     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by PS initialization after loading NTDLL.
02017 
02018     If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a 386 system without 387s (all processors must be
02019     symmetrical) then <span class="keyword">this</span> function will set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap 07 vector on all
02020     processors to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address passed in (which should be the
02021     entry point of the 80387 emulator in NTDLL, NPXNPHandler).
02022 
02023 Arguments:
02024 
02025     HandlerAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap07 handler.
02026 
02027 Return Value:
02028 
02029     None.
02030 
02031 --*/
02032 
02033 {
02034     PKINTERRUPT_ROUTINE HandlerAddress;
02035     KAFFINITY           ActiveProcessors, CurrentAffinity;
02036     KIRQL               OldIrql;
02037     ULONG               disposition;
02038     HANDLE              SystemHandle, SourceHandle, DestHandle;
02039     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02040     UNICODE_STRING      unicodeString;
02041     OBJECT_ATTRIBUTES   <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
02042     <span class="keywordtype">double</span>              Dividend, Divisor;
02043     BOOLEAN             PrecisionErrata;
02044 
02045     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a>) {
02046 
02047         <span class="comment">//</span>
02048         <span class="comment">// A coprocessor is present - check to see if the precision errata exists</span>
02049         <span class="comment">//</span>
02050 
02051         PrecisionErrata = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02052 
02053         ActiveProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
02054         <span class="keywordflow">for</span> (CurrentAffinity = 1; ActiveProcessors; CurrentAffinity &lt;&lt;= 1) {
02055 
02056             <span class="keywordflow">if</span> (ActiveProcessors &amp; CurrentAffinity) {
02057                 ActiveProcessors &amp;= ~CurrentAffinity;
02058 
02059                 <span class="comment">//</span>
02060                 <span class="comment">// Run calculation on each processor.</span>
02061                 <span class="comment">//</span>
02062 
02063                 <a class="code" href="../../d9/d1/thredobj_8c.html#a19">KeSetSystemAffinityThread</a>(CurrentAffinity);
02064                 _asm {
02065 
02066                     ;
02067                     ; This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> going to destroy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> coprocesssor,
02068                     ; but we know that there's no state currently in <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
02069                     ;
02070 
02071                     cli
02072                     mov     eax, cr0
02073                     mov     ecx, eax    ; hold original cr0 value
02074                     and     eax, not (CR0_TS+CR0_MP+CR0_EM)
02075                     mov     cr0, eax
02076 
02077                     fninit              ; to known state
02078                 }
02079 
02080                 Dividend = 4195835.0;
02081                 Divisor  = 3145727.0;
02082 
02083                 _asm {
02084                     fld     Dividend
02085                     fdiv    Divisor     ; test known faulty divison
02086                     fmul    Divisor     ; Multiple quotient by divisor
02087                     fcomp   Dividend    ; <a class="code" href="../../d9/d1/lboxctl2_8c.html#a38">Compare</a> product and dividend
02088                     fstsw   ax          ; Move <span class="keywordtype">float</span> conditions to ax
02089                     sahf                ; <a class="code" href="../../d7/d4/conexts_8c.html#a1">move</a> to eflags
02090 
02091                     mov     cr0, ecx    ; restore cr0
02092                     sti
02093 
02094                     jc      <span class="keywordtype">short</span> em10
02095                     jz      <span class="keywordtype">short</span> em20
02096 em10:               mov     PrecisionErrata, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02097 em20:
02098                 }
02099             }
02100         }
02101 
02102 
02103         <span class="comment">//</span>
02104         <span class="comment">// Check to see if the emulator should be used anyway</span>
02105         <span class="comment">//</span>
02106 
02107         <span class="keywordflow">switch</span> (<a class="code" href="../../d7/d3/i386init_8c.html#a4">KeI386ForceNpxEmulation</a>) {
02108             <span class="keywordflow">case</span> 0:
02109                 <span class="comment">//</span>
02110                 <span class="comment">// Use the emulator based on the value in KeI386NpxPresent</span>
02111                 <span class="comment">//</span>
02112 
02113                 <span class="keywordflow">break</span>;
02114 
02115             <span class="keywordflow">case</span> 1:
02116                 <span class="comment">//</span>
02117                 <span class="comment">// Only use the emulator if any processor has the known</span>
02118                 <span class="comment">// Pentium floating point division problem.</span>
02119                 <span class="comment">//</span>
02120 
02121                 <span class="keywordflow">if</span> (PrecisionErrata) {
02122                     <a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02123                 }
02124                 <span class="keywordflow">break</span>;
02125 
02126             <span class="keywordflow">default</span>:
02127 
02128                 <span class="comment">//</span>
02129                 <span class="comment">// Unknown setting - use the emulator</span>
02130                 <span class="comment">//</span>
02131 
02132                 <a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02133                 <span class="keywordflow">break</span>;
02134         }
02135     }
02136 
02137     <span class="comment">//</span>
02138     <span class="comment">// Setup processor features, and install emulator if needed</span>
02139     <span class="comment">//</span>
02140 
02141     SharedUserData-&gt;ProcessorFeatures[PF_FLOATING_POINT_EMULATED] = !<a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a>;
02142     SharedUserData-&gt;ProcessorFeatures[PF_FLOATING_POINT_PRECISION_ERRATA] = PrecisionErrata;
02143 
02144     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a>) {
02145 
02146         <span class="comment">//</span>
02147         <span class="comment">// MMx not available when emulator is used</span>
02148         <span class="comment">//</span>
02149 
02150         <a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp;= ~(<a class="code" href="../../d5/d3/i386_8h.html#a8">KF_MMX</a>|<a class="code" href="../../d5/d3/i386_8h.html#a11">KF_FXSR</a>|<a class="code" href="../../d5/d3/i386_8h.html#a13">KF_XMMI</a>);
02151         SharedUserData-&gt;ProcessorFeatures[PF_MMX_INSTRUCTIONS_AVAILABLE] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02152         SharedUserData-&gt;ProcessorFeatures[PF_XMMI_INSTRUCTIONS_AVAILABLE] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02153         SharedUserData-&gt;ProcessorFeatures[PF_3DNOW_INSTRUCTIONS_AVAILABLE] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02154 
02155         <span class="comment">//</span>
02156         <span class="comment">// Errata not present when using emulator</span>
02157         <span class="comment">//</span>
02158 
02159         SharedUserData-&gt;ProcessorFeatures[PF_FLOATING_POINT_PRECISION_ERRATA] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02160 
02161         <span class="comment">//</span>
02162         <span class="comment">// Use the user mode floating point emulator</span>
02163         <span class="comment">//</span>
02164 
02165         HandlerAddress = (PKINTERRUPT_ROUTINE) ((PULONG) R3EmulatorTable)[0];
02166         <a class="code" href="../../d7/d3/i386init_8c.html#a7">Ki387RoundModeTable</a> = (PVOID) ((PULONG) R3EmulatorTable)[1];
02167 
02168         ActiveProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
02169         <span class="keywordflow">for</span> (CurrentAffinity = 1; ActiveProcessors; CurrentAffinity &lt;&lt;= 1) {
02170 
02171             <span class="keywordflow">if</span> (ActiveProcessors &amp; CurrentAffinity) {
02172                 ActiveProcessors &amp;= ~CurrentAffinity;
02173 
02174                 <span class="comment">//</span>
02175                 <span class="comment">// Run this code on each processor.</span>
02176                 <span class="comment">//</span>
02177 
02178                 <a class="code" href="../../d9/d1/thredobj_8c.html#a19">KeSetSystemAffinityThread</a>(CurrentAffinity);
02179 
02180                 <span class="comment">//</span>
02181                 <span class="comment">// Raise IRQL and lock dispatcher database.</span>
02182                 <span class="comment">//</span>
02183 
02184                 <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
02185 
02186                 <span class="comment">//</span>
02187                 <span class="comment">// Make the trap 07 IDT entry point at the passed-in handler</span>
02188                 <span class="comment">//</span>
02189 
02190                 KiSetHandlerAddressToIDT(I386_80387_NP_VECTOR, HandlerAddress);
02191                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>()-&gt;IDT[I386_80387_NP_VECTOR].Selector = KGDT_R3_CODE;
02192                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>()-&gt;IDT[I386_80387_NP_VECTOR].Access = <a class="code" href="../../d6/d9/kernlini_8c.html#a0">TRAP332_GATE</a>;
02193 
02194 
02195                 <span class="comment">//</span>
02196                 <span class="comment">// Unlock dispatcher database and lower IRQL to its previous value.</span>
02197                 <span class="comment">//</span>
02198 
02199                 <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
02200             }
02201         }
02202 
02203         <span class="comment">//</span>
02204         <span class="comment">// Move any entries from ..\System\FloatingPointProcessor to</span>
02205         <span class="comment">// ..\System\DisabledFloatingPointProcessor.</span>
02206         <span class="comment">//</span>
02207 
02208         <span class="comment">//</span>
02209         <span class="comment">// Open system tree</span>
02210         <span class="comment">//</span>
02211 
02212         InitializeObjectAttributes(
02213             &amp;ObjectAttributes,
02214             &amp;CmRegistryMachineHardwareDescriptionSystemName,
02215             OBJ_CASE_INSENSITIVE,
02216             NULL,
02217             NULL
02218             );
02219 
02220         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey( &amp;SystemHandle,
02221                             KEY_ALL_ACCESS,
02222                             &amp;ObjectAttributes
02223                             );
02224 
02225         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02226 
02227             <span class="comment">//</span>
02228             <span class="comment">// Open FloatingPointProcessor key</span>
02229             <span class="comment">//</span>
02230 
02231             InitializeObjectAttributes(
02232                 &amp;ObjectAttributes,
02233                 &amp;CmTypeName[FloatingPointProcessor],
02234                 OBJ_CASE_INSENSITIVE,
02235                 SystemHandle,
02236                 NULL
02237                 );
02238 
02239             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey ( &amp;SourceHandle,
02240                                  KEY_ALL_ACCESS,
02241                                  &amp;ObjectAttributes
02242                                  );
02243 
02244             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02245 
02246                 <span class="comment">//</span>
02247                 <span class="comment">// Create DisabledFloatingPointProcessor key</span>
02248                 <span class="comment">//</span>
02249 
02250                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (
02251                     &amp;unicodeString,
02252                     CmDisabledFloatingPointProcessor
02253                     );
02254 
02255                 InitializeObjectAttributes(
02256                     &amp;ObjectAttributes,
02257                     &amp;unicodeString,
02258                     OBJ_CASE_INSENSITIVE,
02259                     SystemHandle,
02260                     NULL
02261                     );
02262 
02263                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateKey( &amp;DestHandle,
02264                                       KEY_ALL_ACCESS,
02265                                       &amp;ObjectAttributes,
02266                                       0,
02267                                       NULL,
02268                                       REG_OPTION_VOLATILE,
02269                                       &amp;disposition
02270                                       );
02271 
02272                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02273 
02274                     <span class="comment">//</span>
02275                     <span class="comment">// Move it</span>
02276                     <span class="comment">//</span>
02277 
02278                     <a class="code" href="../../d6/d9/kernlini_8c.html#a44">KiMoveRegTree</a> (SourceHandle, DestHandle);
02279                     ZwClose (DestHandle);
02280                 }
02281                 ZwClose (SourceHandle);
02282             }
02283             ZwClose (SystemHandle);
02284         }
02285     }
02286 
02287     <span class="comment">//</span>
02288     <span class="comment">// Set affinity back to the original value.</span>
02289     <span class="comment">//</span>
02290 
02291     <a class="code" href="../../d9/d1/thredobj_8c.html#a16">KeRevertToUserAffinityThread</a>();
02292 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="kernlini.c::Ki386EnableFxsr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID Ki386EnableFxsr           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN volatile PLONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Number</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">KiInitMachineDependent()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="kernlini.c::Ki386EnableGlobalPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID Ki386EnableGlobalPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN volatile PLONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Number</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">KiInitMachineDependent()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="kernlini.c::Ki386EnableXMMIExceptions" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID Ki386EnableXMMIExceptions           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN volatile PLONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Number</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">KiInitMachineDependent()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="kernlini.c::Ki386UseSynchronousTbFlush" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID Ki386UseSynchronousTbFlush           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN volatile PLONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Number</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="kernlini.c::KiAmdK6InitializeMTRR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiAmdK6InitializeMTRR           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00168">168</a> of file <a class="el" href="../../d1/d4/mtrramd_8c-source.html">mtrramd.c</a>.
<p>
References <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00055">AMDK6_MTRR_MSR</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00048">AMDK6_MTRR_TYPE_DISABLED</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00076">AMDK6_REGION_UNUSED</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00155">AmdK6RegionCount</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00154">AmdK6Regions</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00159">AmdMtrrHwUsageCount</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00064">_AMDK6_MTRR_REGION::BaseAddress</a>, <a class="el" href="../../d8/d8/assign_8c-source.html#l00348">DBGMSG</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00163">KiAmdK6Mtrr</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00230">KiAmdK6MTRRAddRegionFromHW()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00265">KiRangeLock</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00070">MAX_K6_REGIONS</a>, <a class="el" href="../../d5/d3/i386_8h.html#a52">RDMSR()</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00067">_AMDK6_MTRR_REGION::RegionFlags</a>, and <a class="el" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">_AMDK6_MTRR_MSR_IMAGE::u</a>.
<p>
<pre class="fragment"><div>00171 {
00172     ULONG    i;
00173     KIRQL    OldIrql;
00174 
00175     <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a>(<span class="stringliteral">"KiAmdK6InitializeMTRR: Initializing K6 MTRR support\n"</span>);
00176 
00177     <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr0.type = <a class="code" href="../../d0/d5/mtrramd_8c.html#a3">AMDK6_MTRR_TYPE_DISABLED</a>;
00178     <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr1.type = <a class="code" href="../../d0/d5/mtrramd_8c.html#a3">AMDK6_MTRR_TYPE_DISABLED</a>;
00179     <a class="code" href="../../d0/d5/mtrramd_8c.html#a20">AmdK6RegionCount</a> = <a class="code" href="../../d0/d5/mtrramd_8c.html#a8">MAX_K6_REGIONS</a>;
00180     <a class="code" href="../../d0/d5/mtrramd_8c.html#a21">AmdMtrrHwUsageCount</a> = 0;
00181 
00182     <span class="comment">//</span>
00183     <span class="comment">// Set all regions to free.</span>
00184     <span class="comment">//</span>
00185 
00186     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d5/mtrramd_8c.html#a20">AmdK6RegionCount</a>; i++) {
00187         <a class="code" href="../../d0/d5/mtrramd_8c.html#a19">AmdK6Regions</a>[i].<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a> = <a class="code" href="../../d0/d5/mtrramd_8c.html#a9">AMDK6_REGION_UNUSED</a>;
00188         <a class="code" href="../../d0/d5/mtrramd_8c.html#a19">AmdK6Regions</a>[i].<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o3">RegionFlags</a> = 0;
00189     }
00190 
00191     <span class="comment">//</span>
00192     <span class="comment">// Initialize the spin lock.</span>
00193     <span class="comment">//</span>
00194     <span class="comment">// N.B. Normally this is done by KiInitializeMTRR but that</span>
00195     <span class="comment">// routine is not called in the AMD K6 case.</span>
00196     <span class="comment">//</span>
00197 
00198     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;KiRangeLock);
00199 
00200     <span class="comment">//</span>
00201     <span class="comment">// Read the MTRR registers to see if the BIOS has set them up.</span>
00202     <span class="comment">// If so, add entries to the region table and adjust the usage</span>
00203     <span class="comment">// count.  Serialize the region table.</span>
00204     <span class="comment">//</span>
00205 
00206     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a> (&amp;KiRangeLock, &amp;OldIrql);
00207                 
00208     <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.QuadPart = <a class="code" href="../../d5/d3/i386_8h.html#a52">RDMSR</a> (AMDK6_MTRR_MSR);
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">// Check MTRR0 first.</span>
00212     <span class="comment">//</span>
00213 
00214     <a class="code" href="../../d0/d5/mtrramd_8c.html#a30">KiAmdK6MTRRAddRegionFromHW</a>(<a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr0);
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">// Now check MTRR1.</span>
00218     <span class="comment">//</span>
00219 
00220     <a class="code" href="../../d0/d5/mtrramd_8c.html#a30">KiAmdK6MTRRAddRegionFromHW</a>(<a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr1);
00221 
00222     <span class="comment">//</span>
00223     <span class="comment">// Release the locks.</span>
00224     <span class="comment">//</span>
00225 
00226     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a> (&amp;KiRangeLock, OldIrql);
00227 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="kernlini.c::KiGetCacheInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiGetCacheInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01509">1509</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a61a30">CPU_AMD</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a61a29">CPU_INTEL</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a61a28">CPU_NONE</a>, <a class="el" href="../../d5/d3/i386_8h.html#a50">CPUID()</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a5">CPUID_REG_COUNT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00068">KeGetPcr</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01110">KiGetCpuVendor()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00246">KiInitializeKernel()</a>.
<p>
<pre class="fragment"><div>01512 {
01513 <span class="preprocessor">#define CPUID_REG_COUNT 4</span>
01514 <span class="preprocessor"></span>    ULONG CpuidData[<a class="code" href="../../d6/d9/kernlini_8c.html#a5">CPUID_REG_COUNT</a>];
01515 
01516     ULONG CpuVendor;
01517     PKPCR Pcr;
01518 
01519     <span class="comment">//</span>
01520     <span class="comment">// Set default.</span>
01521     <span class="comment">//</span>
01522 
01523     Pcr = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>();
01524 
01525     Pcr-&gt;SecondLevelCacheSize = 0;
01526 
01527     <span class="comment">//</span>
01528     <span class="comment">// Determine the processor manufacturer</span>
01529     <span class="comment">//</span>
01530 
01531     CpuVendor = <a class="code" href="../../d6/d9/kernlini_8c.html#a42">KiGetCpuVendor</a>();
01532 
01533     <span class="keywordflow">if</span> (CpuVendor == <a class="code" href="../../d6/d9/kernlini_8c.html#a61a28">CPU_NONE</a>) {
01534         <span class="keywordflow">return</span>;
01535     }
01536 
01537     <span class="comment">//</span>
01538     <span class="comment">// Obtain Cache size information for those processors on which</span>
01539     <span class="comment">// we know how.</span>
01540     <span class="comment">//</span>
01541 
01542     <span class="keywordflow">switch</span> (CpuVendor) {
01543     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/kernlini_8c.html#a61a29">CPU_INTEL</a>:
01544 
01545         <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a>(0, CpuidData, CpuidData+1, CpuidData+2, CpuidData+3);
01546 
01547         <span class="comment">//</span>
01548         <span class="comment">// Check this processor supports CPUID function 2 which is the</span>
01549         <span class="comment">// one that returns cache size info.</span>
01550         <span class="comment">//</span>
01551 
01552         <span class="keywordflow">if</span> (CpuidData[0] &gt;= 2) {
01553 
01554             <span class="comment">//</span>
01555             <span class="comment">// The above returns a series of bytes.    (In EAX, EBX, ECX</span>
01556             <span class="comment">// and EDX).   The least significant byte (of EAX) gives the</span>
01557             <span class="comment">// number of times CPUID(2 ...) should be issued to return</span>
01558             <span class="comment">// the complete set of data.   The bytes are self describing</span>
01559             <span class="comment">// data.</span>
01560             <span class="comment">//</span>
01561             <span class="comment">// In particular, the bytes describing the L2 cache size</span>
01562             <span class="comment">// will be in the following set (and meaning)</span>
01563             <span class="comment">//</span>
01564             <span class="comment">// 0x40       0  bytes</span>
01565             <span class="comment">// 0x41     128K bytes</span>
01566             <span class="comment">// 0x42     256K bytes</span>
01567             <span class="comment">// 0x43     512K bytes</span>
01568             <span class="comment">// 0x44    1024K bytes</span>
01569             <span class="comment">// 0x45    2048K bytes</span>
01570             <span class="comment">// 0x46    4096K bytes</span>
01571             <span class="comment">//</span>
01572             <span class="comment">// I am extrapolating the above as anything in the range</span>
01573             <span class="comment">// 0x41 thru 0x4f can be computed as</span>
01574             <span class="comment">//</span>
01575             <span class="comment">//   128KB &lt;&lt; (descriptor - 0x41)</span>
01576             <span class="comment">//</span>
01577             <span class="comment">// The Intel folks say keep it to a reasonable upper bound,</span>
01578             <span class="comment">// eg 49.</span>
01579             <span class="comment">//</span>
01580             <span class="comment">// N.B. the range 0x80 .. 0x86 indicates the same cache</span>
01581             <span class="comment">// sizes but 8 way associative.</span>
01582             <span class="comment">//</span>
01583             <span class="comment">// Also, the most significant bit of each register indicates</span>
01584             <span class="comment">// whether not the register contains valid information.</span>
01585             <span class="comment">// 0 == Valid, 1 == InValid.</span>
01586             <span class="comment">//</span>
01587 
01588             ULONG CpuidIterations;
01589             ULONG i;
01590             ULONG CpuidReg;
01591 
01592             BOOLEAN FirstPass = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01593 
01594             <span class="keywordflow">do</span> {
01595                 <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a>(2, CpuidData, CpuidData+1, CpuidData+2, CpuidData+3);
01596 
01597                 <span class="keywordflow">if</span> (FirstPass) {
01598 
01599                     <span class="comment">//</span>
01600                     <span class="comment">// Get the iteration count from the first byte</span>
01601                     <span class="comment">// of the returned data then replace that byte</span>
01602                     <span class="comment">// with 0 (a null descriptor).</span>
01603                     <span class="comment">//</span>
01604 
01605                     CpuidIterations = CpuidData[0] &amp; 0xff;
01606                     CpuidData[0] &amp;= 0xffffff00;
01607 
01608                     FirstPass = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01609                 }
01610 
01611                 <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d6/d9/kernlini_8c.html#a5">CPUID_REG_COUNT</a>; i++) {
01612 
01613                     CpuidReg = CpuidData[i];
01614 
01615                     <span class="keywordflow">if</span> (CpuidReg &amp; 0x80000000) {
01616 
01617                         <span class="comment">//</span>
01618                         <span class="comment">// Register doesn't contain valid data,</span>
01619                         <span class="comment">// skip it.</span>
01620                         <span class="comment">//</span>
01621 
01622                         <span class="keywordflow">continue</span>;
01623                     }
01624 
01625                     <span class="keywordflow">while</span> (CpuidReg) {
01626 
01627                         <span class="comment">//</span>
01628                         <span class="comment">// Get LS Byte from this DWORD and remove the</span>
01629                         <span class="comment">// byte.</span>
01630                         <span class="comment">//</span>
01631 
01632                         UCHAR Descriptor = (UCHAR)(CpuidReg &amp; 0xff);
01633                         CpuidReg &gt;&gt;= 8;
01634 
01635                         <span class="keywordflow">if</span> (Descriptor == 0) {
01636 
01637                             <span class="comment">//</span>
01638                             <span class="comment">// NULL descriptor</span>
01639                             <span class="comment">//</span>
01640 
01641                             <span class="keywordflow">continue</span>;
01642                         }
01643 
01644                         <span class="keywordflow">if</span> (((Descriptor &gt; 0x40) &amp;&amp; (Descriptor &lt;= 0x49)) ||
01645                             ((Descriptor &gt; 0x80) &amp;&amp; (Descriptor &lt;= 0x89))) {
01646 
01647                             <span class="comment">//</span>
01648                             <span class="comment">// L2 descriptor.</span>
01649                             <span class="comment">//</span>
01650 
01651                             Descriptor &amp;= 0x0f;
01652 
01653                             <span class="comment">//</span>
01654                             <span class="comment">// Assert the descriptor is in the range we</span>
01655                             <span class="comment">// officially know about.   If this hits on</span>
01656                             <span class="comment">// a checked build, check with Intel about</span>
01657                             <span class="comment">// the interpretation.</span>
01658                             <span class="comment">//</span>
01659 
01660                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor &lt;= 0x6);
01661 
01662                             Pcr-&gt;SecondLevelCacheSize = 0x10000 &lt;&lt; Descriptor;
01663                         }
01664 
01665                         <span class="comment">//</span>
01666                         <span class="comment">// else if (do other descriptors)</span>
01667                         <span class="comment">//</span>
01668 
01669                     } <span class="comment">// while more bytes in this register</span>
01670 
01671                 } <span class="comment">// for each register</span>
01672 
01673                 <span class="comment">//</span>
01674                 <span class="comment">// Note: Always run thru all iterations indicated by</span>
01675                 <span class="comment">// the first to ensure a subsequent call won't start</span>
01676                 <span class="comment">// part way thru.</span>
01677                 <span class="comment">//</span>
01678 
01679             } <span class="keywordflow">while</span> (--CpuidIterations);
01680         }
01681         <span class="keywordflow">break</span>;
01682     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/kernlini_8c.html#a61a30">CPU_AMD</a>:
01683         <span class="keywordflow">break</span>;
01684     }
01685 <span class="preprocessor">#undef CPUID_REG_COUNT</span>
01686 <span class="preprocessor"></span>}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="kernlini.c::KiGetCpuVendor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG KiGetCpuVendor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01110">1110</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00061">CmpAmdID</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00059">CmpCyrixID</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00060">CmpIntelID</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a61a30">CPU_AMD</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a61a31">CPU_CYRIX</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a61a29">CPU_INTEL</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a61a28">CPU_NONE</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a61a32">CPU_UNKNOWN</a>, <a class="el" href="../../d5/d3/i386_8h.html#a50">CPUID()</a>, and <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01509">KiGetCacheInformation()</a>.
<p>
<pre class="fragment"><div>01116                    :
01117 
01118     (Try to) Determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> manufacturer of <span class="keyword">this</span> processor based on
01119     data returned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a> instruction (<span class="keywordflow">if</span> present).
01120 
01121 Arguments:
01122 
01123     None.
01124 
01125 Return Value:
01126 
01127     One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> members of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration <a class="code" href="../../d6/d9/kernlini_8c.html#a61">CPU_VENDORS</a> (defined above).
01128 
01129 --*/
01130 {
01131     PKPRCB Prcb;
01132     ULONG  Junk;
01133     ULONG  <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[4];
01134 
01135     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
01136     Prcb-&gt;VendorString[0] = 0;
01137 
01138     <span class="keywordflow">if</span> (!Prcb-&gt;CpuID) {
01139         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/kernlini_8c.html#a61a28">CPU_NONE</a>;
01140     }
01141 
01142     <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a>(0, &amp;Junk, Buffer+0, Buffer+2, Buffer+1);
01143     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[3] = 0;
01144 
01145     <span class="comment">//</span>
01146     <span class="comment">// Copy vendor string to Prcb for debugging (ensure it's NULL</span>
01147     <span class="comment">// terminated).</span>
01148     <span class="comment">//</span>
01149 
01150     RtlCopyMemory(
01151         Prcb-&gt;VendorString,
01152         Buffer,
01153         <span class="keyword">sizeof</span>(Prcb-&gt;VendorString) - 1
01154         );
01155 
01156     Prcb-&gt;VendorString[<span class="keyword">sizeof</span>(Prcb-&gt;VendorString) - 1] = <span class="charliteral">'\0'</span>;
01157 
01158     <span class="keywordflow">if</span> (strcmp((PVOID)Buffer, CmpIntelID) == 0) {
01159         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/kernlini_8c.html#a61a29">CPU_INTEL</a>;
01160     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp((PVOID)Buffer, CmpAmdID) == 0) {
01161         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/kernlini_8c.html#a61a30">CPU_AMD</a>;
01162     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp((PVOID)Buffer, CmpCyrixID) == 0) {
01163         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/kernlini_8c.html#a61a31">CPU_CYRIX</a>;
01164     }
01165     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/kernlini_8c.html#a61a32">CPU_UNKNOWN</a>;
01166 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="kernlini.c::KiGetFeatureBits" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG KiGetFeatureBits           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d1/alpha_2initkr_8c-source.html#l00065">KiInitializeKernel()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="kernlini.c::KiI386PentiumLockErrataFixup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiI386PentiumLockErrataFixup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02460">2460</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a7">IDT_SKIP</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00068">KeGetPcr</a>, <a class="el" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a107">KiRestoreInterrupts()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03942">MmAllocateIndependentPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04027">MmSetPageProtection()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">KiInitMachineDependent()</a>.
<p>
<pre class="fragment"><div>02466                    :
02467 
02468     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called once on every processor when
02469     <a class="code" href="../../d6/d9/kernlini_8c.html#a12">KiI386PentiumLockErrataPresent</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
02470 
02471     This routine replaces <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> local <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a> with an <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a> that has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first 7 <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>
02472     entries on their own page and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first page to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to
02473     be marked as read-<a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.  This causes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor to trap-0e fault when
02474     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> errata occurs.  Special code in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap-0e handler detects <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02475     problem and performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proper fixup.
02476 
02477 Arguments:
02478 
02479     FixupPage   - Returns a <span class="keyword">virtual</span> address of a page to be marked read-<a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
02480 
02481 Return Value:
02482 
02483     None.
02484 
02485 --*/
02486 
02487 {
02488     KDESCRIPTOR IdtDescriptor;
02489     ULONG       OrginalBase;
02490     PUCHAR      NewBase, BasePage;
02491     BOOLEAN     Enable;
02492     BOOLEAN     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02493 
02494 
02495 <span class="preprocessor">#define IDT_SKIP   (7 * sizeof (KIDTENTRY))</span>
02496 <span class="preprocessor"></span>
02497     <span class="comment">//</span>
02498     <span class="comment">// Allocate memory for a new copy of the processors IDT</span>
02499     <span class="comment">//</span>
02500 
02501     BasePage = <a class="code" href="../../d5/d6/iosup_8c.html#a61">MmAllocateIndependentPages</a> (2*PAGE_SIZE);
02502 
02503     <span class="comment">//</span>
02504     <span class="comment">// The IDT base is such that the first 7 entries are on the</span>
02505     <span class="comment">// first (read-only) page, and the remaining entries are on the</span>
02506     <span class="comment">// second (read-write) page</span>
02507     <span class="comment">//</span>
02508 
02509     NewBase = BasePage + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d6/d9/kernlini_8c.html#a7">IDT_SKIP</a>;
02510 
02511     <span class="comment">//</span>
02512     <span class="comment">// Disable interrupts on this processor while updating the IDT base</span>
02513     <span class="comment">//</span>
02514 
02515     Enable = <a class="code" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts</a>();
02516 
02517     <span class="comment">//</span>
02518     <span class="comment">// Copy Old IDT to new IDT</span>
02519     <span class="comment">//</span>
02520 
02521     _asm {
02522         sidt IdtDescriptor.Limit
02523     }
02524 
02525     RtlMoveMemory ((PVOID) NewBase,
02526                    (PVOID) IdtDescriptor.Base,
02527                    IdtDescriptor.Limit + 1
02528                   );
02529 
02530     IdtDescriptor.Base = (ULONG) NewBase;
02531 
02532     <span class="comment">//</span>
02533     <span class="comment">// Set the new IDT</span>
02534     <span class="comment">//</span>
02535 
02536     _asm {
02537         lidt IdtDescriptor.Limit
02538     }
02539 
02540     <span class="comment">//</span>
02541     <span class="comment">// Update the PCR</span>
02542     <span class="comment">//</span>
02543 
02544     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>()-&gt;IDT = (PKIDTENTRY) NewBase;
02545 
02546     <span class="comment">//</span>
02547     <span class="comment">// Restore interrupts</span>
02548     <span class="comment">//</span>
02549 
02550     <a class="code" href="../../d0/d0/ki_8h.html#a107">KiRestoreInterrupts</a>(Enable);
02551 
02552     <span class="comment">//</span>
02553     <span class="comment">// Mark the first page which contains IDT entries 0-6 as read-only</span>
02554     <span class="comment">//</span>
02555 
02556     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d6/iosup_8c.html#a62">MmSetPageProtection</a> (BasePage, PAGE_SIZE, PAGE_READONLY);
02557     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Status);
02558 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="kernlini.c::KiInitializeDblFaultTSS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiInitializeDblFaultTSS           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTSS&nbsp;</td>
          <td class="mdname" nowrap> <em>Tss</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Stack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKGDTENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>TssDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="kernlini.c::KiInitializeKernel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiInitializeKernel           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>IdleStack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKPRCB&nbsp;</td>
          <td class="mdname" nowrap> <em>Prcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Number</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderBlock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00246">246</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00029">CcMasterSpinLock</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00075">CcVacbSpinLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d0/d0/ki_8h.html#a86">ExpInitializeExecutive()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00091">HIGH_LEVEL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02780">KeFeatureBits</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00068">KeGetPcr</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02693">KeI386CpuStep</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02692">KeI386CpuType</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02695">KeI386FxsrPresent</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02694">KeI386NpxPresent</a>, <a class="el" href="../../d0/d8/i386_2exceptn_8c-source.html#l00046">KeI386XMMIPresent</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00063">KeInitializeProcess()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00043">KeInitializeThread()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02774">KeMaximumIncrement</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02777">KeProcessorArchitecture</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02778">KeProcessorLevel</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02779">KeProcessorRevision</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01838">KeSetPriorityThread()</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02716">KF_3DNOW</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02709">KF_CMPXCHG8B</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02713">KF_FXSR</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02706">KF_GLOBAL_PAGE</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02710">KF_MMX</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02708">KF_MTRR</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02712">KF_PAT</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02703">KF_RDTSC</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02715">KF_XMMI</a>, <a class="el" href="../../d4/d0/biosc_8c-source.html#l00051">Ki386IopmSaveArea</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00237">Ki486CompatibilityLock</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00127">KiAdjustDpcThreshold</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02723">KiBootFeatureBits</a>, <a class="el" href="../../d3/d9/kiinit_8c-source.html#l00237">KiComputeReciprocal()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l01113">KiContextSwapLock</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00332">KiDispatcherLock</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00062">KiFreezeExecutionLock</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01509">KiGetCacheInformation()</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a43">KiGetFeatureBits()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00044">KiIdleSummary</a>, <a class="el" href="../../d3/d9/kiinit_8c-source.html#l00096">KiInitSystem()</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a35">KiIsNpxPresent()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00125">KiMaximumDpcQueueDepth</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00126">KiMinimumDpcRate</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00149">KiQueuedSpinLockContext</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a34">KiSetCR0Bits()</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a33">KiSetProcessorType()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00505">KiTimeIncrementReciprocal</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00512">KiTimeIncrementShiftCount</a>, <a class="el" href="../../d0/d0/ki_8h.html#a85">KiTryToAcquireQueuedSpinLock()</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a75a63">LockQueueContextSwapLock</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a75a62">LockQueueDispatcherLock</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a75a67">LockQueueMasterLock</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a75a64">LockQueuePfnLock</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a75a65">LockQueueSystemSpaceLock</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a75a66">LockQueueVacbLock</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02450">MmCreateKernelStack()</a>, <a class="el" href="../../d8/d1/alpha_2initkr_8c-source.html#l00039">MmPfnLock</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00072">MmSystemSpaceLock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00367">PKSTART_ROUTINE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00379">PKSYSTEM_ROUTINE</a>, <a class="el" href="../../d1/d2/po_8h.html#a57">PoInitializePrcb()</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01848">_LOADER_PARAMETER_BLOCK::Prcb</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a1">RET</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a193">Running</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00065">SetMember</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00257                    :
00258 
00259     This function gains <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has been bootstrapped and
00260     before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has been initialized. Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to initialize
00261     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel data structures, initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> idle thread and process objects,
00262     initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block, call <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> executive initialization
00263     routine, and then <span class="keywordflow">return</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system startup routine. This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00264     also called to initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor specific structures when a <span class="keyword">new</span>
00265     processor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> brought on line.
00266 
00267 Arguments:
00268 
00269     Process - Supplies a pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> process <span class="keywordflow">for</span>
00270         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified processor.
00271 
00272     Thread - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> thread <span class="keywordflow">for</span>
00273         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified processor.
00274 
00275     IdleStack - Supplies a pointer <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real kernel stack <span class="keywordflow">for</span>
00276         idle thread on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified processor.
00277 
00278     Prcb - Supplies a pointer to a processor <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00279         processor.
00280 
00281     Number - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00282         initialized.
00283 
00284     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader parameter block.
00285 
00286 Return Value:
00287 
00288     None.
00289 
00290 --*/
00291 
00292 {
00293     LONG  <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00294     ULONG DirectoryTableBase[2];
00295     KIRQL OldIrql;
00296     PKPCR Pcr;
00297     BOOLEAN NpxFlag;
00298     BOOLEAN FxsrPresent;
00299     BOOLEAN XMMIPresent;
00300     ULONG FeatureBits;
00301 
00302     <a class="code" href="../../d6/d9/kernlini_8c.html#a33">KiSetProcessorType</a>();
00303     <a class="code" href="../../d6/d9/kernlini_8c.html#a34">KiSetCR0Bits</a>();
00304     NpxFlag = <a class="code" href="../../d6/d9/kernlini_8c.html#a35">KiIsNpxPresent</a>();
00305 
00306     Pcr = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>();
00307 
00308     <span class="comment">//</span>
00309     <span class="comment">// Initialize DPC listhead and lock.</span>
00310     <span class="comment">//</span>
00311 
00312     InitializeListHead(&amp;Prcb-&gt;DpcListHead);
00313     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;Prcb-&gt;DpcLock);
00314     Prcb-&gt;DpcRoutineActive = 0;
00315     Prcb-&gt;DpcQueueDepth = 0;
00316     Prcb-&gt;MaximumDpcQueueDepth = <a class="code" href="../../d8/d0/cmdat3_8c.html#a64">KiMaximumDpcQueueDepth</a>;
00317     Prcb-&gt;MinimumDpcRate = <a class="code" href="../../d8/d0/cmdat3_8c.html#a65">KiMinimumDpcRate</a>;
00318     Prcb-&gt;AdjustDpcThreshold = <a class="code" href="../../d8/d0/cmdat3_8c.html#a66">KiAdjustDpcThreshold</a>;
00319     <a class="code" href="../../d1/d2/po_8h.html#a57">PoInitializePrcb</a> (Prcb);
00320 
00321     <span class="comment">//</span>
00322     <span class="comment">// Check for unsupported processor revision</span>
00323     <span class="comment">//</span>
00324 
00325     <span class="keywordflow">if</span> (Prcb-&gt;CpuType == 3) {
00326         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(UNSUPPORTED_PROCESSOR,0x386,0,0,0);
00327     }
00328 
00329     <span class="comment">//</span>
00330     <span class="comment">// Get the processor FeatureBits for this processor.</span>
00331     <span class="comment">//</span>
00332 
00333     FeatureBits = <a class="code" href="../../d6/d9/kernlini_8c.html#a43">KiGetFeatureBits</a>();
00334     Prcb-&gt;FeatureBits = FeatureBits;
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">// Get processor Cache Size information.</span>
00338     <span class="comment">//</span>
00339 
00340     <a class="code" href="../../d6/d9/kernlini_8c.html#a41">KiGetCacheInformation</a>();
00341 
00342     <span class="comment">//</span>
00343     <span class="comment">// initialize the per processor lock queue entry for implemented locks.</span>
00344     <span class="comment">//</span>
00345 
00346 <span class="preprocessor">#if !defined(NT_UP)</span>
00347 <span class="preprocessor"></span>
00348     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a62">LockQueueDispatcherLock</a>].Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00349     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a62">LockQueueDispatcherLock</a>].Lock = &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a38">KiDispatcherLock</a>;
00350     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a63">LockQueueContextSwapLock</a>].Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00351     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a63">LockQueueContextSwapLock</a>].Lock = &amp;<a class="code" href="../../d0/d0/ki_8h.html#a40">KiContextSwapLock</a>;
00352     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a64">LockQueuePfnLock</a>].Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00353     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a64">LockQueuePfnLock</a>].Lock = &amp;<a class="code" href="../../d7/d2/alpha_2initkr_8c.html#a2">MmPfnLock</a>;
00354     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a65">LockQueueSystemSpaceLock</a>].Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00355     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a65">LockQueueSystemSpaceLock</a>].Lock = &amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a15">MmSystemSpaceLock</a>;
00356     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a67">LockQueueMasterLock</a>].Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00357     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a67">LockQueueMasterLock</a>].Lock = &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a0">CcMasterSpinLock</a>;
00358     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a66">LockQueueVacbLock</a>].Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00359     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a66">LockQueueVacbLock</a>].Lock = &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a18">CcVacbSpinLock</a>;
00360 
00361 <span class="preprocessor">#endif</span>
00362 <span class="preprocessor"></span>
00363     <span class="comment">//</span>
00364     <span class="comment">// If the initial processor is being initialized, then initialize the</span>
00365     <span class="comment">// per system data structures.</span>
00366     <span class="comment">//</span>
00367 
00368     <span class="keywordflow">if</span> (Number == 0) {
00369 
00370         <span class="comment">//</span>
00371         <span class="comment">// Initial setting for global Cpu &amp; Stepping levels</span>
00372         <span class="comment">//</span>
00373 
00374         <a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a> = NpxFlag;
00375         <a class="code" href="../../d5/d3/i386_8h.html#a21">KeI386CpuType</a> = Prcb-&gt;CpuType;
00376         <a class="code" href="../../d5/d3/i386_8h.html#a22">KeI386CpuStep</a> = Prcb-&gt;CpuStep;
00377 
00378         <a class="code" href="../../d4/d9/ke_8h.html#a134">KeProcessorArchitecture</a> = PROCESSOR_ARCHITECTURE_INTEL;
00379         <a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Prcb-&gt;CpuType;
00380         <span class="keywordflow">if</span> (Prcb-&gt;CpuID == 0) {
00381             <a class="code" href="../../d4/d9/ke_8h.html#a136">KeProcessorRevision</a> = 0xFF00 |
00382                                   (((Prcb-&gt;CpuStep &gt;&gt; 4) + 0xa0 ) &amp; 0x0F0) |
00383                                   (Prcb-&gt;CpuStep &amp; 0xf);
00384         } <span class="keywordflow">else</span> {
00385             <a class="code" href="../../d4/d9/ke_8h.html#a136">KeProcessorRevision</a> = Prcb-&gt;CpuStep;
00386         }
00387 
00388         <a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> = FeatureBits;
00389 
00390         <a class="code" href="../../d5/d3/i386_8h.html#a24">KeI386FxsrPresent</a> = ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a11">KF_FXSR</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>:<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00391 
00392         <a class="code" href="../../d9/d8/i386_2exceptn_8c.html#a9">KeI386XMMIPresent</a> = ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a13">KF_XMMI</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>:<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00393 
00394         <span class="comment">//</span>
00395         <span class="comment">// If cmpxchg8b was available at boot, verify its still available</span>
00396         <span class="comment">//</span>
00397 
00398         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d3/i386_8h.html#a25">KiBootFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>) &amp;&amp; !(<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>)) {
00399             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, KF_CMPXCHG8B, 0, 0, 0);
00400         }
00401 
00402         <span class="comment">//</span>
00403         <span class="comment">// Lower IRQL to APC level.</span>
00404         <span class="comment">//</span>
00405 
00406         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(APC_LEVEL);
00407 
00408 
00409         <span class="comment">//</span>
00410         <span class="comment">// Initialize kernel internal spinlocks</span>
00411         <span class="comment">//</span>
00412 
00413         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;KiContextSwapLock);
00414         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;KiDispatcherLock);
00415         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;KiFreezeExecutionLock);
00416 
00417         <span class="comment">//</span>
00418         <span class="comment">// Initialize 486 compatibility lock</span>
00419         <span class="comment">//</span>
00420 
00421         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;Ki486CompatibilityLock);
00422 
00423 <span class="preprocessor">#if !defined(NT_UP)</span>
00424 <span class="preprocessor"></span>
00425         <span class="comment">//</span>
00426         <span class="comment">// During Text Mode setup, it is possible the system is</span>
00427         <span class="comment">// running with an MP kernel and a UP HAL.  On X86 systems,</span>
00428         <span class="comment">// spinlocks are implemented in both the kernel and the HAL</span>
00429         <span class="comment">// with the verisons that alter IRQL in the HAL.   If the</span>
00430         <span class="comment">// HAL is UP, it will not actually acquire/release locks</span>
00431         <span class="comment">// while the MP kernel will which will cause the system to</span>
00432         <span class="comment">// hang (or crash).   As this can only occur during text</span>
00433         <span class="comment">// mode setup, we will detect the situation and disable </span>
00434         <span class="comment">// the kernel only versions of queued spinlocks if the HAL</span>
00435         <span class="comment">// is UP (and the kernel MP).</span>
00436         <span class="comment">//</span>
00437         <span class="comment">// We need to patch 3 routines, two of them are void and</span>
00438         <span class="comment">// the other returns a boolean (must be true (and ZF must be</span>
00439         <span class="comment">// clear) in a UP case).</span>
00440         <span class="comment">//</span>
00441         <span class="comment">// Determine if the HAL us UP by acquiring the dispatcher</span>
00442         <span class="comment">// lock and examining it to see if the HAL actually did</span>
00443         <span class="comment">// anything to it.</span>
00444         <span class="comment">//</span>
00445 
00446         OldIrql = KfAcquireSpinLock(&amp;KiDispatcherLock);
00447         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/kernldat_8c.html#a38">KiDispatcherLock</a> == 0) {
00448 
00449             <span class="comment">//</span>
00450             <span class="comment">// KfAcquireSpinLock is in the HAL and it did not</span>
00451             <span class="comment">// change the value of the lock.  This is a UP HAL.</span>
00452             <span class="comment">//</span>
00453 
00454             <span class="keyword">extern</span> UCHAR KiTryToAcquireQueuedSpinLockUP;
00455             PUCHAR PatchTarget, PatchSource;
00456             UCHAR Byte;
00457 
00458 <span class="preprocessor">            #define RET 0xc3</span>
00459 <span class="preprocessor"></span>
00460             *(PUCHAR)(KiAcquireQueuedSpinLock) = <a class="code" href="../../d6/d9/kernlini_8c.html#a1">RET</a>;
00461             *(PUCHAR)(KiReleaseQueuedSpinLock) = <a class="code" href="../../d6/d9/kernlini_8c.html#a1">RET</a>;
00462 
00463             <span class="comment">//</span>
00464             <span class="comment">// Copy the UP version of KiTryToAcquireQueuedSpinLock</span>
00465             <span class="comment">// over the top of the MP versin.</span>
00466             <span class="comment">//</span>
00467 
00468             PatchSource = &amp;(KiTryToAcquireQueuedSpinLockUP);
00469             PatchTarget = (PUCHAR)(<a class="code" href="../../d0/d0/ki_8h.html#a85">KiTryToAcquireQueuedSpinLock</a>);
00470 
00471             <span class="keywordflow">do</span> {
00472                 Byte = *PatchSource++;
00473                 *PatchTarget++ = Byte;
00474             } <span class="keywordflow">while</span> (Byte != <a class="code" href="../../d6/d9/kernlini_8c.html#a1">RET</a>);
00475 
00476 <span class="preprocessor">            #undef RET</span>
00477 <span class="preprocessor"></span>        }
00478         <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;KiDispatcherLock, OldIrql);
00479 
00480 <span class="preprocessor">#endif</span>
00481 <span class="preprocessor"></span>
00482         <span class="comment">//</span>
00483         <span class="comment">// Performance architecture independent initialization.</span>
00484         <span class="comment">//</span>
00485 
00486         <a class="code" href="../../d2/d0/kiinit_8c.html#a1">KiInitSystem</a>();
00487 
00488         <span class="comment">//</span>
00489         <span class="comment">// Initialize idle thread process object and then set:</span>
00490         <span class="comment">//</span>
00491         <span class="comment">//      1. all the quantum values to the maximum possible.</span>
00492         <span class="comment">//      2. the process in the balance set.</span>
00493         <span class="comment">//      3. the active processor mask to the specified process.</span>
00494         <span class="comment">//</span>
00495 
00496         DirectoryTableBase[0] = 0;
00497         DirectoryTableBase[1] = 0;
00498         <a class="code" href="../../d3/d5/procobj_8c.html#a3">KeInitializeProcess</a>(Process,
00499                             (KPRIORITY)0,
00500                             (KAFFINITY)(0xffffffff),
00501                             &amp;DirectoryTableBase[0],
00502                             FALSE);
00503 
00504         Process-&gt;ThreadQuantum = MAXCHAR;
00505 
00506     } <span class="keywordflow">else</span> {
00507 
00508         <span class="comment">//</span>
00509         <span class="comment">// Adjust global cpu setting to represent lowest of all processors</span>
00510         <span class="comment">//</span>
00511 
00512         FxsrPresent = ((FeatureBits &amp; <a class="code" href="../../d5/d3/i386_8h.html#a11">KF_FXSR</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>:<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00513         <span class="keywordflow">if</span> (FxsrPresent != <a class="code" href="../../d5/d3/i386_8h.html#a24">KeI386FxsrPresent</a>) {
00514             <span class="comment">//</span>
00515             <span class="comment">// FXSR support must be available on all processors or on none</span>
00516             <span class="comment">//</span>
00517             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, KF_FXSR, 0, 0, 0);
00518         }
00519 
00520         XMMIPresent = ((FeatureBits &amp; <a class="code" href="../../d5/d3/i386_8h.html#a13">KF_XMMI</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>:<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00521         <span class="keywordflow">if</span> (XMMIPresent != <a class="code" href="../../d9/d8/i386_2exceptn_8c.html#a9">KeI386XMMIPresent</a>) {
00522             <span class="comment">//</span>
00523             <span class="comment">// XMMI support must be available on all processors or on none</span>
00524             <span class="comment">//</span>
00525             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, KF_XMMI, 0, 0, 0);
00526         }
00527 
00528         <span class="keywordflow">if</span> (NpxFlag != <a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a>) {
00529             <span class="comment">//</span>
00530             <span class="comment">// NPX support must be available on all processors or on none</span>
00531             <span class="comment">//</span>
00532 
00533             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, 0x387, 0, 0, 0);
00534         }
00535 
00536         <span class="keywordflow">if</span> ((ULONG)(Prcb-&gt;CpuType) != <a class="code" href="../../d5/d3/i386_8h.html#a21">KeI386CpuType</a>) {
00537 
00538             <span class="keywordflow">if</span> ((ULONG)(Prcb-&gt;CpuType) &lt; <a class="code" href="../../d5/d3/i386_8h.html#a21">KeI386CpuType</a>) {
00539 
00540                 <span class="comment">//</span>
00541                 <span class="comment">// What is the lowest CPU type</span>
00542                 <span class="comment">//</span>
00543 
00544                 <a class="code" href="../../d5/d3/i386_8h.html#a21">KeI386CpuType</a> = (ULONG)Prcb-&gt;CpuType;
00545                 <a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Prcb-&gt;CpuType;
00546             }
00547         }
00548 
00549         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d3/i386_8h.html#a25">KiBootFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>)  &amp;&amp;  !(FeatureBits &amp; <a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>)) {
00550             <span class="comment">//</span>
00551             <span class="comment">// cmpxchg8b must be available on all processors, if installed at boot</span>
00552             <span class="comment">//</span>
00553 
00554             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, KF_CMPXCHG8B, 0, 0, 0);
00555         }
00556 
00557         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a4">KF_GLOBAL_PAGE</a>)  &amp;&amp;  !(FeatureBits &amp; <a class="code" href="../../d5/d3/i386_8h.html#a4">KF_GLOBAL_PAGE</a>)) {
00558             <span class="comment">//</span>
00559             <span class="comment">// Global page support must be available on all processors, if on boot processor</span>
00560             <span class="comment">//</span>
00561 
00562             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, KF_GLOBAL_PAGE, 0, 0, 0);
00563         }
00564 
00565         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>)  &amp;&amp;  !(FeatureBits &amp; <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>)) {
00566             <span class="comment">//</span>
00567             <span class="comment">// PAT must be available on all processors, if on boot processor</span>
00568             <span class="comment">//</span>
00569 
00570             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, KF_PAT, 0, 0, 0);
00571         }
00572 
00573         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a6">KF_MTRR</a>)  &amp;&amp;  !(FeatureBits &amp; <a class="code" href="../../d5/d3/i386_8h.html#a6">KF_MTRR</a>)) {
00574             <span class="comment">//</span>
00575             <span class="comment">// MTRR must be available on all processors, if on boot processor</span>
00576             <span class="comment">//</span>
00577 
00578             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, KF_MTRR, 0, 0, 0);
00579         }
00580 
00581         <span class="comment">//</span>
00582         <span class="comment">// Use lowest stepping value</span>
00583         <span class="comment">//</span>
00584 
00585         <span class="keywordflow">if</span> (Prcb-&gt;CpuStep &lt; <a class="code" href="../../d5/d3/i386_8h.html#a22">KeI386CpuStep</a>) {
00586             <a class="code" href="../../d5/d3/i386_8h.html#a22">KeI386CpuStep</a> = Prcb-&gt;CpuStep;
00587             <span class="keywordflow">if</span> (Prcb-&gt;CpuID == 0) {
00588                 <a class="code" href="../../d4/d9/ke_8h.html#a136">KeProcessorRevision</a> = 0xFF00 |
00589                                       ((Prcb-&gt;CpuStep &gt;&gt; 8) + <span class="charliteral">'A'</span>) |
00590                                       (Prcb-&gt;CpuStep &amp; 0xf);
00591             } <span class="keywordflow">else</span> {
00592                 <a class="code" href="../../d4/d9/ke_8h.html#a136">KeProcessorRevision</a> = Prcb-&gt;CpuStep;
00593             }
00594         }
00595 
00596         <span class="comment">//</span>
00597         <span class="comment">// Use subset of all NT feature bits available on each processor</span>
00598         <span class="comment">//</span>
00599 
00600         <a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp;= FeatureBits;
00601 
00602         <span class="comment">//</span>
00603         <span class="comment">// Lower IRQL to DISPATCH level.</span>
00604         <span class="comment">//</span>
00605 
00606         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(DISPATCH_LEVEL);
00607 
00608     }
00609 
00610     <span class="comment">//</span>
00611     <span class="comment">// Update processor features</span>
00612     <span class="comment">//</span>
00613 
00614     SharedUserData-&gt;ProcessorFeatures[PF_MMX_INSTRUCTIONS_AVAILABLE] =
00615         (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a8">KF_MMX</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00616 
00617     SharedUserData-&gt;ProcessorFeatures[PF_COMPARE_EXCHANGE_DOUBLE] =
00618         (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00619 
00620     SharedUserData-&gt;ProcessorFeatures[PF_XMMI_INSTRUCTIONS_AVAILABLE] =
00621         ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a11">KF_FXSR</a>) &amp;&amp; (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a13">KF_XMMI</a>)) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00622 
00623     SharedUserData-&gt;ProcessorFeatures[PF_3DNOW_INSTRUCTIONS_AVAILABLE] =
00624         (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a14">KF_3DNOW</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00625 
00626     SharedUserData-&gt;ProcessorFeatures[PF_RDTSC_INSTRUCTION_AVAILABLE] =
00627         (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a1">KF_RDTSC</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00628     <span class="comment">//</span>
00629     <span class="comment">// Initialize idle thread object and then set:</span>
00630     <span class="comment">//</span>
00631     <span class="comment">//      1. the initial kernel stack to the specified idle stack.</span>
00632     <span class="comment">//      2. the next processor number to the specified processor.</span>
00633     <span class="comment">//      3. the thread priority to the highest possible value.</span>
00634     <span class="comment">//      4. the state of the thread to running.</span>
00635     <span class="comment">//      5. the thread affinity to the specified processor.</span>
00636     <span class="comment">//      6. the specified processor member in the process active processors</span>
00637     <span class="comment">//          set.</span>
00638     <span class="comment">//</span>
00639 
00640     <a class="code" href="../../d9/d1/thredobj_8c.html#a1">KeInitializeThread</a>(Thread, (PVOID)((ULONG)IdleStack),
00641                        (PKSYSTEM_ROUTINE)NULL, (PKSTART_ROUTINE)NULL,
00642                        (PVOID)NULL, (PCONTEXT)NULL, (PVOID)NULL, Process);
00643     Thread-&gt;NextProcessor = Number;
00644     Thread-&gt;Priority = HIGH_PRIORITY;
00645     Thread-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a406a193">Running</a>;
00646     Thread-&gt;Affinity = (KAFFINITY)(1&lt;&lt;Number);
00647     Thread-&gt;WaitIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>;
00648     <a class="code" href="../../d0/d0/ki_8h.html#a7">SetMember</a>(Number, Process-&gt;ActiveProcessors);
00649 
00650     <span class="comment">//</span>
00651     <span class="comment">// Initialize the processor block. (Note that some fields have been</span>
00652     <span class="comment">// initialized at KiInitializePcr().</span>
00653     <span class="comment">//</span>
00654 
00655     Prcb-&gt;CurrentThread = Thread;
00656     Prcb-&gt;NextThread = (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00657     Prcb-&gt;IdleThread = Thread;
00658     Pcr-&gt;NtTib.StackBase = Thread-&gt;InitialStack;
00659 
00660     <span class="comment">//</span>
00661     <span class="comment">// call the executive initialization routine.</span>
00662     <span class="comment">//</span>
00663 
00664     <span class="keywordflow">try</span> {
00665         <a class="code" href="../../d0/d0/ki_8h.html#a86">ExpInitializeExecutive</a>(Number, LoaderBlock);
00666 
00667     } except (EXCEPTION_EXECUTE_HANDLER) {
00668         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a> (PHASE0_EXCEPTION);
00669     }
00670 
00671     <span class="comment">//</span>
00672     <span class="comment">// If the initial processor is being initialized, then compute the</span>
00673     <span class="comment">// timer table reciprocal value and reset the PRCB values for the</span>
00674     <span class="comment">// controllable DPC behavior in order to reflect any registry</span>
00675     <span class="comment">// overrides.</span>
00676     <span class="comment">//</span>
00677 
00678     <span class="keywordflow">if</span> (Number == 0) {
00679         <a class="code" href="../../d5/d9/kernldat_8c.html#a59">KiTimeIncrementReciprocal</a> = <a class="code" href="../../d2/d0/kiinit_8c.html#a2">KiComputeReciprocal</a>((LONG)KeMaximumIncrement,
00680                                                         &amp;KiTimeIncrementShiftCount);
00681 
00682         Prcb-&gt;MaximumDpcQueueDepth = <a class="code" href="../../d8/d0/cmdat3_8c.html#a64">KiMaximumDpcQueueDepth</a>;
00683         Prcb-&gt;MinimumDpcRate = <a class="code" href="../../d8/d0/cmdat3_8c.html#a65">KiMinimumDpcRate</a>;
00684         Prcb-&gt;AdjustDpcThreshold = <a class="code" href="../../d8/d0/cmdat3_8c.html#a66">KiAdjustDpcThreshold</a>;
00685     }
00686 
00687     <span class="keywordflow">if</span> (Number == 0) {
00688 
00689         <span class="comment">//</span>
00690         <span class="comment">// Processor 0's DPC stack was temporarily allocated on</span>
00691         <span class="comment">// the Double Fault Stack, switch to a proper kernel </span>
00692         <span class="comment">// stack now.</span>
00693         <span class="comment">//</span>
00694 
00695         PVOID DpcStack;
00696 
00697         DpcStack = <a class="code" href="../../d4/d5/procsup_8c.html#a33">MmCreateKernelStack</a>(FALSE);
00698 
00699         <span class="keywordflow">if</span> (DpcStack == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00700             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(NO_PAGES_AVAILABLE, 1, 0, 0, 0);
00701         }
00702         Prcb-&gt;DpcStack = DpcStack;
00703 
00704         <span class="comment">//</span>
00705         <span class="comment">// Allocate 8k IOPM bit map saved area to allow BiosCall swap</span>
00706         <span class="comment">// bit maps.</span>
00707         <span class="comment">//</span>
00708 
00709         <a class="code" href="../../d3/d1/biosc_8c.html#a7">Ki386IopmSaveArea</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool,
00710                                                   PAGE_SIZE * 2,
00711                                                   '  eK');
00712         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/biosc_8c.html#a7">Ki386IopmSaveArea</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00713             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(NO_PAGES_AVAILABLE, 2, PAGE_SIZE * 2, 0, 0);
00714         }
00715     }
00716 
00717     <span class="comment">//</span>
00718     <span class="comment">// Set the priority of the specified idle thread to zero, set appropriate</span>
00719     <span class="comment">// member in KiIdleSummary and return to the system start up routine.</span>
00720     <span class="comment">//</span>
00721 
00722     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(DISPATCH_LEVEL, &amp;OldIrql);
00723     <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a>(Thread, (KPRIORITY)0);
00724 
00725     <span class="comment">//</span>
00726     <span class="comment">// if a thread has not been selected to run on the current processors,</span>
00727     <span class="comment">// check to see if there are any ready threads; otherwise add this</span>
00728     <span class="comment">// processors to the IdleSummary</span>
00729     <span class="comment">//</span>
00730 
00731     KiAcquireQueuedSpinLock(<a class="code" href="../../d0/d0/ki_8h.html#a13">KiQueuedSpinLockContext</a>(LockQueueDispatcherLock));
00732     <span class="keywordflow">if</span> (Prcb-&gt;NextThread == (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00733         <a class="code" href="../../d0/d0/ki_8h.html#a7">SetMember</a>(Number, KiIdleSummary);
00734     }
00735     KiReleaseQueuedSpinLock(<a class="code" href="../../d0/d0/ki_8h.html#a13">KiQueuedSpinLockContext</a>(LockQueueDispatcherLock));
00736 
00737     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(HIGH_LEVEL, &amp;OldIrql);
00738 
00739     <span class="comment">//</span>
00740     <span class="comment">// This processor has initialized</span>
00741     <span class="comment">//</span>
00742 
00743     LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o4">Prcb</a> = (ULONG)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00744 
00745     <span class="keywordflow">return</span>;
00746 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="kernlini.c::KiInitializeMTRR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiInitializeMTRR           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LastProcessor</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00275">275</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
References <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00077">_RANGE_INFO::Capabilities</a>, <a class="el" href="../../d8/d8/assign_8c-source.html#l00348">DBGMSG</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00076">_RANGE_INFO::Default</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00078">_RANGE_INFO::DefaultCachedType</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00055">GROW_RANGE_TABLE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02780">KeFeatureBits</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00068">KeGetPcr</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02708">KF_MTRR</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00992">KiAddRange()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01624">KiMaskToLength()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00272">KiRangeInfo</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00265">KiRangeLock</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00120">MASK_OVERFLOW_MASK</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00087">_RANGE_INFO::MaxRange</a>, <a class="el" href="../../d9/d4/mtrr_8h.html#a17">MTRR_CAPABILITIES</a>, <a class="el" href="../../d9/d4/mtrr_8h.html#a19">MTRR_DEFAULT</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00097">MTRR_MASK_BASE</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00112">MTRR_MASK_MASK</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00030">MTRR_MSR_CAPABILITIES</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00031">MTRR_MSR_DEFAULT</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00032">MTRR_MSR_VARIABLE_BASE</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00033">MTRR_MSR_VARIABLE_MASK</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00047">MTRR_TYPE_MAX</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00042">MTRR_TYPE_UC</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00046">MTRR_TYPE_WB</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00044">MTRR_TYPE_WT</a>, <a class="el" href="../../d9/d4/mtrr_8h.html#a21">MTRR_VARIABLE_BASE</a>, <a class="el" href="../../d9/d4/mtrr_8h.html#a23">MTRR_VARIABLE_MASK</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00085">_RANGE_INFO::MtrrWorkaround</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00086">_RANGE_INFO::NoRange</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d4/mtrr_8c.html#a6">ONE_RANGE</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00088">_RANGE_INFO::Ranges</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00084">_RANGE_INFO::RangesValid</a>, <a class="el" href="../../d5/d3/i386_8h.html#a52">RDMSR()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d9/d0/struct__MTRR__VARIABLE__MASK.html#o7">_MTRR_VARIABLE_MASK::u</a>, <a class="el" href="../../d6/d0/struct__MTRR__VARIABLE__BASE.html#o7">_MTRR_VARIABLE_BASE::u</a>, <a class="el" href="../../d2/d0/struct__MTRR__DEFAULT.html#o8">_MTRR_DEFAULT::u</a>, and <a class="el" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">_MTRR_CAPABILITIES::u</a>.
<p>
<pre class="fragment"><div>00280                    :
00281 
00282     Called to incrementally initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical range
00283     database feature.   First processor's MTRR set <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> read into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00284     physical range database.
00285 
00286 Arguments:
00287 
00288     LastProcessor - If set <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last processor to execute <span class="keyword">this</span> routine
00289     such that when <span class="keyword">this</span> processor finishes, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initialization <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete.
00290 
00291 Return Value:
00292 
00293     None - <span class="keywordflow">if</span> there was a problem <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function
00294     <a class="code" href="../../d8/d4/mtrr_8c.html#a32">KeSetPhysicalCacheTypeRange</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> disabled.
00295 
00296 --*/
00297 {
00298     BOOLEAN             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00299     ULONG               <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00300     <a class="code" href="../../d2/d0/struct__MTRR__DEFAULT.html">MTRR_DEFAULT</a>        Default;
00301     <a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html">MTRR_CAPABILITIES</a>   Capabilities;
00302     <a class="code" href="../../d0/d2/struct__NEW__RANGE.html">NEW_RANGE</a>           NewRange;
00303     <a class="code" href="../../d6/d0/struct__MTRR__VARIABLE__BASE.html">MTRR_VARIABLE_BASE</a>  MtrrBase;
00304     <a class="code" href="../../d9/d0/struct__MTRR__VARIABLE__MASK.html">MTRR_VARIABLE_MASK</a>  MtrrMask;
00305     ULONGLONG           Base, Mask, Length;
00306     BOOLEAN             RemoveThisType[<a class="code" href="../../d9/d4/mtrr_8h.html#a11">MTRR_TYPE_MAX</a>];
00307     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            NtStatus;
00308     PKPRCB              Prcb;
00309 
00310     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00311     RtlZeroMemory (&amp;NewRange, <span class="keyword">sizeof</span> (NewRange));
00312     NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o0">Status</a> = STATUS_UNSUCCESSFUL;
00313 
00314     <span class="comment">//</span>
00315     <span class="comment">// If this is the first processor, initialize some fields</span>
00316     <span class="comment">//</span>
00317 
00318     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>()-&gt;Number == 0) {
00319         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;KiRangeLock);
00320 
00321         <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o1">Capabilities</a>.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.QuadPart = <a class="code" href="../../d5/d3/i386_8h.html#a52">RDMSR</a>(MTRR_MSR_CAPABILITIES);
00322         <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o0">Default</a>.<a class="code" href="../../d2/d0/struct__MTRR__DEFAULT.html#o8">u</a>.QuadPart = <a class="code" href="../../d5/d3/i386_8h.html#a52">RDMSR</a>(MTRR_MSR_DEFAULT);
00323         <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o2">DefaultCachedType</a> = <a class="code" href="../../d9/d4/mtrr_8h.html#a11">MTRR_TYPE_MAX</a>;
00324 
00325         <span class="comment">//</span>
00326         <span class="comment">// If h/w mtrr support is not enabled, disable OS support</span>
00327         <span class="comment">//</span>
00328 
00329         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o0">Default</a>.<a class="code" href="../../d2/d0/struct__MTRR__DEFAULT.html#o8">u</a>.hw.MtrrEnabled ||
00330             <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o1">Capabilities</a>.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.hw.VarCnt == 0 ||
00331             <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o0">Default</a>.<a class="code" href="../../d2/d0/struct__MTRR__DEFAULT.html#o8">u</a>.hw.Type != <a class="code" href="../../d9/d4/mtrr_8h.html#a6">MTRR_TYPE_UC</a>) {
00332 
00333             <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a>(<span class="stringliteral">"MTRR feature disabled.\n"</span>);
00334             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00335 
00336         } <span class="keywordflow">else</span> {
00337 
00338             <span class="comment">//</span>
00339             <span class="comment">// If USWC type is supported by hardware, but the MTRR</span>
00340             <span class="comment">// feature is not set in KeFeatureBits, it is because</span>
00341             <span class="comment">// the HAL indicated USWC should not be used on this</span>
00342             <span class="comment">// machine.  (Possibly due to shared memory clusters).</span>
00343             <span class="comment">//</span>
00344 
00345             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o1">Capabilities</a>.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.hw.UswcSupported &amp;&amp;
00346                 ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a6">KF_MTRR</a>) == 0)) {
00347 
00348                 <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a>(<span class="stringliteral">"KiInitializeMTRR: MTRR use globally disabled on this machine.\n"</span>);
00349                 <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o1">Capabilities</a>.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.hw.UswcSupported = 0;
00350             }
00351 
00352             <span class="comment">//</span>
00353             <span class="comment">// Allocate initial range type database</span>
00354             <span class="comment">//</span>
00355 
00356             <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a> = 0;
00357             <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o6">MaxRange</a> = (UCHAR) <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o1">Capabilities</a>.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.hw.VarCnt + <a class="code" href="../../d8/d4/mtrr_8c.html#a3">GROW_RANGE_TABLE</a>;
00358             <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00359                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/struct__ONE__RANGE.html">ONE_RANGE</a>) * <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o6">MaxRange</a>,
00360                                     '  eK');
00361             RtlZeroMemory (<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/struct__ONE__RANGE.html">ONE_RANGE</a>) * <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o6">MaxRange</a>);
00362         }
00363     }
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">// Workaround for cpu signatures 611, 612, 616 and 617</span>
00367     <span class="comment">// - if the request for setting a variable MTRR specifies</span>
00368     <span class="comment">// an address which is not 4M aligned or length is not</span>
00369     <span class="comment">// a multiple of 4M then possible problem for INVLPG inst.</span>
00370     <span class="comment">// Detect if workaround is required</span>
00371     <span class="comment">//</span>
00372 
00373     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00374     <span class="keywordflow">if</span> (Prcb-&gt;CpuType == 6  &amp;&amp;
00375         (Prcb-&gt;CpuStep == 0x0101 || Prcb-&gt;CpuStep == 0x0102 ||
00376          Prcb-&gt;CpuStep == 0x0106 || Prcb-&gt;CpuStep == 0x0107 )) {
00377 
00378         <span class="keywordflow">if</span> (strcmp(Prcb-&gt;VendorString, <span class="stringliteral">"GenuineIntel"</span>) == 0) {
00379 
00380             <span class="comment">//</span>
00381             <span class="comment">// Only do this if it's an Intel part, other </span>
00382             <span class="comment">// manufacturers may have the same stepping </span>
00383             <span class="comment">// numbers but no bug.</span>
00384             <span class="comment">//</span>
00385 
00386             <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o4">MtrrWorkaround</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00387         }
00388     }
00389 
00390     <span class="comment">//</span>
00391     <span class="comment">// If MTRR support disabled on first processor or if</span>
00392     <span class="comment">// buffer not allocated then fall through</span>
00393     <span class="comment">//</span>
00394 
00395     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>){
00396         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00397     } <span class="keywordflow">else</span> {
00398 
00399         <span class="comment">//</span>
00400         <span class="comment">// Verify MTRR support is symmetric</span>
00401         <span class="comment">//</span>
00402 
00403         Capabilities.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.QuadPart = <a class="code" href="../../d5/d3/i386_8h.html#a52">RDMSR</a>(MTRR_MSR_CAPABILITIES);
00404 
00405         <span class="keywordflow">if</span> ((Capabilities.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.hw.UswcSupported) &amp;&amp;
00406             ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a6">KF_MTRR</a>) == 0)) {
00407             <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"KiInitializeMTRR: setting UswcSupported FALSE\n"</span>);
00408             Capabilities.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.hw.UswcSupported = 0;
00409         }
00410 
00411         Default.<a class="code" href="../../d2/d0/struct__MTRR__DEFAULT.html#o8">u</a>.QuadPart = <a class="code" href="../../d5/d3/i386_8h.html#a52">RDMSR</a>(MTRR_MSR_DEFAULT);
00412 
00413         <span class="keywordflow">if</span> (Default.<a class="code" href="../../d2/d0/struct__MTRR__DEFAULT.html#o8">u</a>.QuadPart != <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o0">Default</a>.<a class="code" href="../../d2/d0/struct__MTRR__DEFAULT.html#o8">u</a>.QuadPart ||
00414             Capabilities.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.QuadPart != <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o1">Capabilities</a>.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.QuadPart) {
00415             <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"KiInitializeMTRR: asymmetric mtrr support\n"</span>);
00416             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00417         }
00418     }
00419 
00420     NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o0">Status</a> = STATUS_SUCCESS;
00421 
00422     <span class="comment">//</span>
00423     <span class="comment">// MTRR registers should be identically set on each processor.</span>
00424     <span class="comment">// Ranges should be added to the range database only for one</span>
00425     <span class="comment">// processor.</span>
00426     <span class="comment">//</span>
00427 
00428     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &amp;&amp; (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>()-&gt;Number == 0)) {
00429 <span class="preprocessor">#if IDBG</span>
00430 <span class="preprocessor"></span>        KiDumpMTRR (<span class="stringliteral">"Processor MTRR:"</span>, NULL);
00431 <span class="preprocessor">#endif</span>
00432 <span class="preprocessor"></span>
00433         <span class="comment">//</span>
00434         <span class="comment">// Read current MTRR settings for various cached range types</span>
00435         <span class="comment">// and add them to the range database</span>
00436         <span class="comment">//</span>
00437 
00438         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Capabilities.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.hw.VarCnt; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
00439 
00440             MtrrBase.<a class="code" href="../../d6/d0/struct__MTRR__VARIABLE__BASE.html#o7">u</a>.QuadPart = <a class="code" href="../../d5/d3/i386_8h.html#a52">RDMSR</a>(MTRR_MSR_VARIABLE_BASE+Index*2);
00441             MtrrMask.<a class="code" href="../../d9/d0/struct__MTRR__VARIABLE__MASK.html#o7">u</a>.QuadPart = <a class="code" href="../../d5/d3/i386_8h.html#a52">RDMSR</a>(MTRR_MSR_VARIABLE_MASK+Index*2);
00442 
00443             Mask = MtrrMask.<a class="code" href="../../d9/d0/struct__MTRR__VARIABLE__MASK.html#o7">u</a>.QuadPart &amp; <a class="code" href="../../d9/d4/mtrr_8h.html#a13">MTRR_MASK_MASK</a>;
00444             Base = MtrrBase.<a class="code" href="../../d6/d0/struct__MTRR__VARIABLE__BASE.html#o7">u</a>.QuadPart &amp; <a class="code" href="../../d9/d4/mtrr_8h.html#a12">MTRR_MASK_BASE</a>;
00445 
00446             <span class="comment">//</span>
00447             <span class="comment">// Note - the variable MTRR Mask does NOT contain the length</span>
00448             <span class="comment">// spanned by the variable MTRR. Thus just checking the Valid</span>
00449             <span class="comment">// Bit should be sufficient for identifying a valid MTRR.</span>
00450             <span class="comment">//</span>
00451 
00452             <span class="keywordflow">if</span> (MtrrMask.<a class="code" href="../../d9/d0/struct__MTRR__VARIABLE__MASK.html#o7">u</a>.hw.Valid) {
00453 
00454                 Length = <a class="code" href="../../d8/d4/mtrr_8c.html#a27">KiMaskToLength</a>(Mask);
00455 
00456                 <span class="comment">//</span>
00457                 <span class="comment">// Check for non-contiguous MTRR mask.</span>
00458                 <span class="comment">//</span>
00459 
00460                 <span class="keywordflow">if</span> ((Mask + Length) &amp; <a class="code" href="../../d9/d4/mtrr_8h.html#a14">MASK_OVERFLOW_MASK</a>) {
00461                     <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"KiInitializeMTRR: Found non-contiguous MTRR mask!\n"</span>);
00462                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00463                 }
00464 
00465                 <span class="comment">//</span>
00466                 <span class="comment">// Add this MTRR to the range database</span>
00467                 <span class="comment">//</span>
00468 
00469                 Base &amp;= Mask;
00470                 <a class="code" href="../../d8/d4/mtrr_8c.html#a18">KiAddRange</a> (
00471                     &amp;NewRange,
00472                     Base,
00473                     Base + Length - 1,
00474                     (UCHAR) MtrrBase.<a class="code" href="../../d6/d0/struct__MTRR__VARIABLE__BASE.html#o7">u</a>.hw.Type
00475                     );
00476 
00477                 <span class="comment">//</span>
00478                 <span class="comment">// Check for default cache type</span>
00479                 <span class="comment">//</span>
00480 
00481                 <span class="keywordflow">if</span> (MtrrBase.<a class="code" href="../../d6/d0/struct__MTRR__VARIABLE__BASE.html#o7">u</a>.hw.Type == <a class="code" href="../../d9/d4/mtrr_8h.html#a10">MTRR_TYPE_WB</a>) {
00482                     <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o2">DefaultCachedType</a> = <a class="code" href="../../d9/d4/mtrr_8h.html#a10">MTRR_TYPE_WB</a>;
00483                 }
00484 
00485                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o2">DefaultCachedType</a> == <a class="code" href="../../d9/d4/mtrr_8h.html#a11">MTRR_TYPE_MAX</a>  &amp;&amp;
00486                     MtrrBase.<a class="code" href="../../d6/d0/struct__MTRR__VARIABLE__BASE.html#o7">u</a>.hw.Type == <a class="code" href="../../d9/d4/mtrr_8h.html#a8">MTRR_TYPE_WT</a>) {
00487                     <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o2">DefaultCachedType</a> = <a class="code" href="../../d9/d4/mtrr_8h.html#a8">MTRR_TYPE_WT</a>;
00488                 }
00489             }
00490         }
00491 
00492         <span class="comment">//</span>
00493         <span class="comment">// If a default type for "cached" was not found, assume write-back</span>
00494         <span class="comment">//</span>
00495 
00496         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o2">DefaultCachedType</a> == <a class="code" href="../../d9/d4/mtrr_8h.html#a11">MTRR_TYPE_MAX</a>) {
00497             <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"KiInitializeMTRR: assume write-back\n"</span>);
00498             <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o2">DefaultCachedType</a> = <a class="code" href="../../d9/d4/mtrr_8h.html#a10">MTRR_TYPE_WB</a>;
00499         }
00500     }
00501 
00502     <span class="comment">//</span>
00503     <span class="comment">// Done</span>
00504     <span class="comment">//</span>
00505 
00506     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o0">Status</a>)) {
00507         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00508     }
00509 
00510     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00511         <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"KiInitializeMTRR: OS support for MTRRs disabled\n"</span>);
00512         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00513             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>);
00514             <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00515         }
00516     } <span class="keywordflow">else</span> {
00517 
00518         <span class="comment">// if last processor indicate initialization complete</span>
00519         <span class="keywordflow">if</span> (LastProcessor) {
00520             <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o3">RangesValid</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00521         }
00522     }
00523 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="kernlini.c::KiInitializePAT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiInitializePAT           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/pat_8c-source.html#l00119">119</a> of file <a class="el" href="../../d0/d3/pat_8c-source.html">pat.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d3/pat_8c-source.html#l00038">_NEW_PAT::Attributes</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00091">HIGH_LEVEL</a>, <a class="el" href="../../d2/d9/union__PAT.html#o1">_PAT::hw</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02766">KeActiveProcessors</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02780">KeFeatureBits</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02712">KF_PAT</a>, <a class="el" href="../../d3/d0/xipi_8c-source.html#l00182">KiIpiStallOnPacketTargets()</a>, <a class="el" href="../../d0/d3/pat_8c-source.html#l00289">KiLoadPAT()</a>, <a class="el" href="../../d0/d3/pat_8c-source.html#l00249">KiLoadPATTarget()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00128">KiLockContextSwap</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00131">KiUnlockContextSwap</a>, <a class="el" href="../../d2/d1/mm_8h.html#a189">MmEnablePAT()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d3/pat_8h-source.html#l00038">PAT_TYPE_STRONG_UC</a>, <a class="el" href="../../d1/d3/pat_8h-source.html#l00039">PAT_TYPE_USWC</a>, <a class="el" href="../../d1/d3/pat_8h-source.html#l00042">PAT_TYPE_WB</a>, <a class="el" href="../../d1/d3/pat_8h-source.html#l00043">PAT_TYPE_WEAK_UC</a>, <a class="el" href="../../d0/d3/pat_8c-source.html#l00042">_NEW_PAT::Processor</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d0/d3/pat_8c-source.html#l00043">_NEW_PAT::TargetCount</a>, and <a class="el" href="../../d0/d3/pat_8c-source.html#l00044">_NEW_PAT::TargetPhase</a>.
<p>
<pre class="fragment"><div>00124                    :
00125 
00126     Initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Page Attribute Table (<a class="code" href="../../d2/d9/union__PAT.html">PAT</a>) on all processors. <a class="code" href="../../d2/d9/union__PAT.html">PAT</a>
00127     is setup to provide WB, WC, STRONG_UC and WEAK_UC as the memory
00128     types such that mm macros for enabling/disabling/querying caching
00129     (MI_DISABLE_CACHING, MI_ENABLE_CACHING and MI_IS_CACHING_ENABLED)
00130     are unaffected.
00131 
00132     PAT_Entry   <a class="code" href="../../d2/d9/union__PAT.html">PAT</a> Index   PCD PWT     Memory Type
00133     0            0           0   0       WB
00134     1            0           0   1       WC *
00135     2            0           1   0       WEAK_UC
00136     3            0           1   1       STRONG_UC
00137     4            1           0   0       WB
00138     5            1           0   1       WC *
00139     6            1           1   0       WEAK_UC
00140     7            1           1   1       STRONG_UC
00141 
00142     N.B. The caller must have the PAGELK code locked and ensure that the
00143     <a class="code" href="../../d2/d9/union__PAT.html">PAT</a> feature is supported.
00144 
00145   Arguments:
00146 
00147     None.
00148 
00149 Return Value:
00150 
00151     None.
00152 
00153 --*/
00154 {
00155     <a class="code" href="../../d2/d9/union__PAT.html">PAT</a>         PatAttributes;
00156     ULONG       <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00157     KIRQL       OldIrql, NewIrql;
00158     PKPRCB      Prcb;
00159     <a class="code" href="../../d9/d1/struct__NEW__PAT.html">NEW_PAT</a>     NewPAT;
00160     KAFFINITY   TargetProcessors;
00161 
00162     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((KeFeatureBits &amp; KF_PAT) != 0);
00163 
00164     <span class="comment">//</span>
00165     <span class="comment">// Initialize the PAT</span>
00166     <span class="comment">//</span>
00167 
00168     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[0] = <a class="code" href="../../d0/d4/pat_8h.html#a5">PAT_TYPE_WB</a>;
00169     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[1] = <a class="code" href="../../d0/d4/pat_8h.html#a2">PAT_TYPE_USWC</a>;
00170     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[2] = <a class="code" href="../../d0/d4/pat_8h.html#a6">PAT_TYPE_WEAK_UC</a>;
00171     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[3] = <a class="code" href="../../d0/d4/pat_8h.html#a1">PAT_TYPE_STRONG_UC</a>;
00172     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[4] = <a class="code" href="../../d0/d4/pat_8h.html#a5">PAT_TYPE_WB</a>;
00173     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[5] = <a class="code" href="../../d0/d4/pat_8h.html#a2">PAT_TYPE_USWC</a>;
00174     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[6] = <a class="code" href="../../d0/d4/pat_8h.html#a6">PAT_TYPE_WEAK_UC</a>;
00175     PatAttributes.<a class="code" href="../../d2/d9/union__PAT.html#o1">hw</a>.Pat[7] = <a class="code" href="../../d0/d4/pat_8h.html#a1">PAT_TYPE_STRONG_UC</a>;
00176 
00177     <span class="comment">//</span>
00178     <span class="comment">// Synchronize with other IPI functions which may stall</span>
00179     <span class="comment">//</span>
00180 
00181     <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql);
00182 
00183     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00184 
00185     NewPAT.<a class="code" href="../../d9/d1/struct__NEW__PAT.html#o0">Attributes</a> = PatAttributes;
00186     NewPAT.<a class="code" href="../../d9/d1/struct__NEW__PAT.html#o2">TargetCount</a> = 0;
00187     NewPAT.<a class="code" href="../../d9/d1/struct__NEW__PAT.html#o3">TargetPhase</a> = &amp;Prcb-&gt;ReverseStall;
00188     NewPAT.<a class="code" href="../../d9/d1/struct__NEW__PAT.html#o1">Processor</a> = Prcb-&gt;Number;
00189 
00190 
00191 <span class="preprocessor">#if !defined(NT_UP)</span>
00192 <span class="preprocessor"></span>
00193     <span class="comment">//</span>
00194     <span class="comment">// Collect all the (other) processors</span>
00195     <span class="comment">//</span>
00196 
00197     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; ~Prcb-&gt;SetMember;
00198     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00199 
00200         KiIpiSendSynchronousPacket (
00201             Prcb,
00202             TargetProcessors,
00203             KiLoadPATTarget,
00204             (PVOID) (&amp;NewPAT),
00205             NULL,
00206             NULL
00207             );
00208 
00209         <span class="comment">//</span>
00210         <span class="comment">// Wait for all processors to be collected</span>
00211         <span class="comment">//</span>
00212 
00213         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00214 
00215         <span class="comment">//</span>
00216         <span class="comment">// All processors are now waiting.  Raise to high level to</span>
00217         <span class="comment">// ensure this processor doesn't enter the debugger due to</span>
00218         <span class="comment">// some interrupt service routine.</span>
00219         <span class="comment">//</span>
00220 
00221         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (HIGH_LEVEL, &amp;NewIrql);
00222 
00223         <span class="comment">//</span>
00224         <span class="comment">// There's no reason for any debug events now, so signal</span>
00225         <span class="comment">// the other processors that they can all begin the PAT update</span>
00226         <span class="comment">//</span>
00227 
00228         Prcb-&gt;ReverseStall += 1;
00229     }
00230 
00231 <span class="preprocessor">#endif</span>
00232 <span class="preprocessor"></span>
00233     <span class="comment">//</span>
00234     <span class="comment">// Update PAT</span>
00235     <span class="comment">//</span>
00236 
00237     <a class="code" href="../../d9/d3/pat_8c.html#a5">KiLoadPAT</a>(&amp;NewPAT);
00238 
00239     <span class="comment">//</span>
00240     <span class="comment">// Release ContextSwap lock and lower to initial irql</span>
00241     <span class="comment">//</span>
00242 
00243     <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql);
00244     <a class="code" href="../../d2/d1/mm_8h.html#a189">MmEnablePAT</a>();
00245     <span class="keywordflow">return</span>;
00246 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="kernlini.c::KiInitializePcr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiInitializePcr           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Processor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKPCR&nbsp;</td>
          <td class="mdname" nowrap> <em>Pcr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKIDTENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>Idt</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKGDTENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>Gdt</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKTSS&nbsp;</td>
          <td class="mdname" nowrap> <em>Tss</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DpcStack</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00749">749</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l02782">KiProcessorBlock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00195">PCR_MAJOR_VERSION</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00194">PCR_MINOR_VERSION</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00177">PRCB_MAJOR_VERSION</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00176">PRCB_MINOR_VERSION</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/i386_2allproc_8c-source.html#l00075">KeStartAllProcessors()</a>.
<p>
<pre class="fragment"><div>00761                    :
00762 
00763     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PCR <span class="keywordflow">for</span> a processor.  It
00764     simply stuffs values into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PCR.  (The PCR <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not inited statically
00765     because <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number varies with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of processors.)
00766 
00767     Note that each processor has its own <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>, GDT, and TSS as well as PCR!
00768 
00769 Arguments:
00770 
00771     Processor - Processor whose PCR to initialize.
00772 
00773     Pcr - Linear address of PCR.
00774 
00775     Idt - Linear address of i386 <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>.
00776 
00777     Gdt - Linear address of i386 GDT.
00778 
00779     Tss - Linear address (NOT SELECTOR!) of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> i386 TSS.
00780 
00781     Thread - Dummy thread object to use very early on.
00782 
00783 Return Value:
00784 
00785     None.
00786 
00787 --*/
00788 {
00789     <span class="comment">// set version values</span>
00790 
00791     Pcr-&gt;MajorVersion = <a class="code" href="../../d6/d7/halmips_8h.html#a114">PCR_MAJOR_VERSION</a>;
00792     Pcr-&gt;MinorVersion = <a class="code" href="../../d6/d7/halmips_8h.html#a113">PCR_MINOR_VERSION</a>;
00793 
00794     Pcr-&gt;PrcbData.MajorVersion = <a class="code" href="../../d6/d7/halmips_8h.html#a102">PRCB_MAJOR_VERSION</a>;
00795     Pcr-&gt;PrcbData.MinorVersion = <a class="code" href="../../d6/d7/halmips_8h.html#a101">PRCB_MINOR_VERSION</a>;
00796 
00797     Pcr-&gt;PrcbData.BuildType = 0;
00798 
00799 <span class="preprocessor">#if DBG</span>
00800 <span class="preprocessor"></span>    Pcr-&gt;PrcbData.BuildType |= PRCB_BUILD_DEBUG;
00801 <span class="preprocessor">#endif</span>
00802 <span class="preprocessor"></span>
00803 <span class="preprocessor">#ifdef NT_UP</span>
00804 <span class="preprocessor"></span>    Pcr-&gt;PrcbData.BuildType |= PRCB_BUILD_UNIPROCESSOR;
00805 <span class="preprocessor">#endif</span>
00806 <span class="preprocessor"></span>
00807 <span class="preprocessor">#if defined (_X86PAE_)</span>
00808 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Processor == 0) {
00809         <span class="comment">//</span>
00810         <span class="comment">//  PAE feature must be initialized prior to the first HAL call.</span>
00811         <span class="comment">//</span>
00812     
00813         SharedUserData-&gt;ProcessorFeatures[PF_PAE_ENABLED] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00814     }
00815 <span class="preprocessor">#endif</span>
00816 <span class="preprocessor"></span>
00817     <span class="comment">//  Basic addressing fields</span>
00818 
00819     Pcr-&gt;SelfPcr = Pcr;
00820     Pcr-&gt;Prcb = &amp;(Pcr-&gt;PrcbData);
00821 
00822     <span class="comment">//  Thread control fields</span>
00823 
00824     Pcr-&gt;NtTib.ExceptionList = EXCEPTION_CHAIN_END;
00825     Pcr-&gt;NtTib.StackBase = 0;
00826     Pcr-&gt;NtTib.StackLimit = 0;
00827     Pcr-&gt;NtTib.Self = 0;
00828 
00829     Pcr-&gt;PrcbData.CurrentThread = Thread;
00830 
00831     <span class="comment">//</span>
00832     <span class="comment">// Init Prcb.Number and ProcessorBlock such that Ipi will work</span>
00833     <span class="comment">// as early as possible.</span>
00834     <span class="comment">//</span>
00835 
00836     Pcr-&gt;PrcbData.Number = (UCHAR)Processor;
00837     Pcr-&gt;PrcbData.SetMember = 1 &lt;&lt; Processor;
00838     <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[Processor] = Pcr-&gt;Prcb;
00839 
00840     Pcr-&gt;Irql = 0;
00841 
00842     <span class="comment">//  Machine structure addresses</span>
00843 
00844     Pcr-&gt;GDT = Gdt;
00845     Pcr-&gt;IDT = Idt;
00846     Pcr-&gt;TSS = Tss;
00847     Pcr-&gt;PrcbData.DpcStack = DpcStack;
00848 
00849     <span class="keywordflow">return</span>;
00850 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="kernlini.c::KiInitializeTSS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiInitializeTSS           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTSS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Tss</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00944">944</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
<pre class="fragment"><div>00950                    :
00951 
00952     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TSS <span class="keywordflow">for</span> a processor.
00953     It will set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">static</span> fields of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TSS.  (ie Those fields that
00954     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> part reads, and <span class="keywordflow">for</span> which NT uses constant values.)
00955 
00956     The dynamic <a class="code" href="../../d9/d7/halvprnt_8c.html#a3">fields</a> (Esp0 and CR3) are set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context swap
00957     code.
00958 
00959 Arguments:
00960 
00961     Tss - Linear address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Task State Segment.
00962 
00963 Return Value:
00964 
00965     None.
00966 
00967 --*/
00968 {
00969 
00970     <span class="comment">//  Set IO Map base address to indicate no IO map present.</span>
00971 
00972     <span class="comment">// N.B. -1 does not seem to be a valid value for the map base.  If this</span>
00973     <span class="comment">//      value is used, byte immediate in's and out's will actually go</span>
00974     <span class="comment">//      the hardware when executed in V86 mode.</span>
00975 
00976     Tss-&gt;IoMapBase = KiComputeIopmOffset(IO_ACCESS_MAP_NONE);
00977 
00978     <span class="comment">//  Set flags to 0, which in particular disables traps on task switches.</span>
00979 
00980     Tss-&gt;Flags = 0;
00981 
00982 
00983     <span class="comment">//  Set LDT and Ss0 to constants used by NT.</span>
00984 
00985     Tss-&gt;LDT = 0;
00986     Tss-&gt;Ss0 = KGDT_R0_DATA;
00987 
00988     <span class="keywordflow">return</span>;
00989 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="kernlini.c::KiInitializeTSS2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiInitializeTSS2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTSS&nbsp;</td>
          <td class="mdname" nowrap> <em>Tss</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKGDTENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>TssDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00992">992</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
<pre class="fragment"><div>00999                    :
01000 
01001     Do part of TSS init we <span class="keywordflow">do</span> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> once.
01002 
01003 Arguments:
01004 
01005     Tss - Linear address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Task State Segment.
01006 
01007     TssDescriptor - Linear address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TSS.
01008 
01009 Return Value:
01010 
01011     None.
01012 
01013 --*/
01014 {
01015     PUCHAR  p;
01016     ULONG   i;
01017     ULONG   j;
01018 
01019     <span class="comment">//</span>
01020     <span class="comment">// Set limit for TSS</span>
01021     <span class="comment">//</span>
01022 
01023     <span class="keywordflow">if</span> (TssDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01024         TssDescriptor-&gt;LimitLow = <span class="keyword">sizeof</span>(KTSS) - 1;
01025         TssDescriptor-&gt;HighWord.Bits.LimitHi = 0;
01026     }
01027 
01028     <span class="comment">//</span>
01029     <span class="comment">// Initialize IOPMs</span>
01030     <span class="comment">//</span>
01031 
01032     <span class="keywordflow">for</span> (i = 0; i &lt; IOPM_COUNT; i++) {
01033         p = (PUCHAR)(Tss-&gt;IoMaps[i].IoMap);
01034 
01035         <span class="keywordflow">for</span> (j = 0; j &lt; PIOPM_SIZE; j++) {
01036             p[j] = (UCHAR)-1;
01037         }
01038     }
01039 
01040     <span class="comment">//</span>
01041     <span class="comment">// Initialize Software Interrupt Direction Maps</span>
01042     <span class="comment">//</span>
01043 
01044     <span class="keywordflow">for</span> (i = 0; i &lt; IOPM_COUNT; i++) {
01045         p = (PUCHAR)(Tss-&gt;IoMaps[i].DirectionMap);
01046         <span class="keywordflow">for</span> (j = 0; j &lt; INT_DIRECTION_MAP_SIZE; j++) {
01047             p[j] = 0;
01048         }
01049         <span class="comment">// dpmi requires special case for int 2, 1b, 1c, 23, 24</span>
01050         p[0] = 4;
01051         p[3] = 0x18;
01052         p[4] = 0x18;
01053     }
01054 
01055     <span class="comment">//</span>
01056     <span class="comment">// Initialize the map for IO_ACCESS_MAP_NONE</span>
01057     <span class="comment">//</span>
01058     p = (PUCHAR)(Tss-&gt;IntDirectionMap);
01059     <span class="keywordflow">for</span> (j = 0; j &lt; INT_DIRECTION_MAP_SIZE; j++) {
01060         p[j] = 0;
01061     }
01062 
01063     <span class="comment">// dpmi requires special case for int 2, 1b, 1c, 23, 24</span>
01064     p[0] = 4;
01065     p[3] = 0x18;
01066     p[4] = 0x18;
01067 
01068     <span class="keywordflow">return</span>;
01069 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="kernlini.c::KiInitMachineDependent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiInitMachineDependent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">1691</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d3/i386_8h.html#a50">CPUID()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a237a150">HalFrameBufferCachingInformation</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l01542">HalQuerySystemInformation</a>, <a class="el" href="../../d1/d0/ki386_8h.html#a10">IDENTITY_MAP</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02766">KeActiveProcessors</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02780">KeFeatureBits</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01153">KeRevertToUserAffinityThread()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01467">KeSetSystemAffinityThread()</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00228">KeZeroPage</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00229">KeZeroPageFromIdleThread</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02717">KF_AMDK6MTRR</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02713">KF_FXSR</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02706">KF_GLOBAL_PAGE</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02707">KF_LARGE_PAGE</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02708">KF_MTRR</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02712">KF_PAT</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02703">KF_RDTSC</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02711">KF_WORKING_PTE</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02715">KF_XMMI</a>, <a class="el" href="../../d3/d0/largepag_8c-source.html#l00646">Ki386ClearIdentityMap()</a>, <a class="el" href="../../d3/d0/largepag_8c-source.html#l00054">Ki386CreateIdentityMap()</a>, <a class="el" href="../../d1/d0/ki386_8h.html#a16">Ki386EnableCurrentLargePage()</a>, <a class="el" href="../../d2/d9/ki386_8h-source.html#l00036">Ki386EnableCurrentLargePageEnd</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a45">Ki386EnableFxsr()</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a47">Ki386EnableGlobalPage()</a>, <a class="el" href="../../d1/d0/ki386_8h.html#a14">Ki386EnableTargetLargePage()</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a46">Ki386EnableXMMIExceptions()</a>, <a class="el" href="../../d9/d4/i386_2flushtb_8c-source.html#l00747">Ki386UseSynchronousTbFlush()</a>, <a class="el" href="../../d0/d5/mtrramd_8c.html#a24">KiAmdK6InitializeMTRR()</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02460">KiI386PentiumLockErrataFixup()</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00173">KiI386PentiumLockErrataPresent</a>, <a class="el" href="../../d8/d4/mtrr_8c.html#a16">KiInitializeMTRR()</a>, <a class="el" href="../../d9/d3/pat_8c.html#a4">KiInitializePAT()</a>, <a class="el" href="../../d3/d0/xipi_8c-source.html#l00040">KiIpiGenericCall()</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a54">KiXMMIZeroPage()</a>, <a class="el" href="../../d6/d9/kernlini_8c.html#a55">KiXMMIZeroPageNoSave()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01688">MAX_ATTEMPTS</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00293">PKIPI_BROADCAST_WORKER</a>, <a class="el" href="../../d5/d3/i386_8h.html#a51">RDTSC()</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00190">ScPatchFxb</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00191">ScPatchFxe</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>01694 {
01695     KAFFINITY       ActiveProcessors, CurrentAffinity;
01696     ULONG           NumberProcessors;
01697     <a class="code" href="../../d5/d0/struct__IDENTITY__MAP.html">IDENTITY_MAP</a>    IdentityMap;
01698     ULONG           <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01699     ULONG           Average;
01700     ULONG           Junk;
01701     <span class="keyword">struct </span>{
01702         LARGE_INTEGER   PerfStart;
01703         LARGE_INTEGER   PerfEnd;
01704         LONGLONG        PerfDelta;
01705         LARGE_INTEGER   PerfFreq;
01706         LONGLONG        TSCStart;
01707         LONGLONG        TSCEnd;
01708         LONGLONG        TSCDelta;
01709         ULONG           MHz;
01710     } Samples[<a class="code" href="../../d6/d9/kernlini_8c.html#a6">MAX_ATTEMPTS</a>], *pSamp;
01711     PUCHAR          PatchLocation;
01712 
01713     <span class="comment">//</span>
01714     <span class="comment">// If PDE large page is supported, enable it.</span>
01715     <span class="comment">//</span>
01716     <span class="comment">// We enable large pages before global pages to make TLB invalidation</span>
01717     <span class="comment">// easier while turning on large pages.</span>
01718     <span class="comment">//</span>
01719 
01720     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a5">KF_LARGE_PAGE</a>) {
01721         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/largepag_8c.html#a6">Ki386CreateIdentityMap</a>(&amp;IdentityMap,
01722                                    &amp;Ki386EnableCurrentLargePage,
01723                                    &amp;Ki386EnableCurrentLargePageEnd )) {
01724 
01725             <a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a> (
01726                 (PKIPI_BROADCAST_WORKER) Ki386EnableTargetLargePage,
01727                 (ULONG)(&amp;IdentityMap)
01728             );
01729         }
01730 
01731         <span class="comment">//</span>
01732         <span class="comment">// Always call Ki386ClearIdentityMap() to free any memory allocated</span>
01733         <span class="comment">//</span>
01734 
01735         <a class="code" href="../../d2/d1/largepag_8c.html#a7">Ki386ClearIdentityMap</a>(&amp;IdentityMap);
01736     }
01737 
01738     <span class="comment">//</span>
01739     <span class="comment">// If PDE/PTE global page is supported, enable it</span>
01740     <span class="comment">//</span>
01741 
01742     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a4">KF_GLOBAL_PAGE</a>) {
01743         NumberProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
01744         <a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a> (
01745             (PKIPI_BROADCAST_WORKER) Ki386EnableGlobalPage,
01746             (ULONG)(&amp;NumberProcessors)
01747         );
01748     }
01749 
01750 <span class="preprocessor">#if !defined(NT_UP)</span>
01751 <span class="preprocessor"></span>
01752     <span class="comment">//</span>
01753     <span class="comment">// If some processor doesn't have proper MP PTE implementation,</span>
01754     <span class="comment">// then use a synchronous TB shoot down handler</span>
01755     <span class="comment">//</span>
01756 
01757     <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a9">KF_WORKING_PTE</a>)) {
01758         NumberProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
01759         <a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a> (
01760             (PKIPI_BROADCAST_WORKER) Ki386UseSynchronousTbFlush,
01761             (ULONG)(&amp;NumberProcessors)
01762         );
01763     }
01764 
01765 <span class="preprocessor">#endif</span>
01766 <span class="preprocessor"></span>
01767     <span class="comment">//</span>
01768     <span class="comment">// If PAT or MTRR supported but the HAL indicates it shouldn't</span>
01769     <span class="comment">// be used (eg on a Shared Memory Cluster), drop the feature.</span>
01770     <span class="comment">//</span>
01771 
01772     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; (<a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a> | <a class="code" href="../../d5/d3/i386_8h.html#a6">KF_MTRR</a>)) {
01773 
01774         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01775         BOOLEAN  UseFrameBufferCaching;
01776         ULONG    <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01777 
01778         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/hal_8h.html#a20">HalQuerySystemInformation</a>(
01779                      HalFrameBufferCachingInformation,
01780                      <span class="keyword">sizeof</span>(UseFrameBufferCaching),
01781                      &amp;UseFrameBufferCaching,
01782                      &amp;Size
01783                      );
01784 
01785         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp;
01786             (UseFrameBufferCaching == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
01787 
01788             <span class="comment">//</span>
01789             <span class="comment">// Hal says don't use.</span>
01790             <span class="comment">//</span>
01791 
01792             <a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp;= ~(<a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a> | <a class="code" href="../../d5/d3/i386_8h.html#a6">KF_MTRR</a>);
01793         }
01794     }
01795 
01796 
01797     <span class="comment">//</span>
01798     <span class="comment">// If PAT is supported then initialize it.</span>
01799     <span class="comment">//</span>
01800 
01801     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>) {
01802         <a class="code" href="../../d9/d3/pat_8c.html#a4">KiInitializePAT</a>();
01803     }
01804 
01805     <span class="comment">//</span>
01806     <span class="comment">// Compute each processors approximate mhz</span>
01807     <span class="comment">//</span>
01808 
01809     <span class="comment">//</span>
01810     <span class="comment">// If FXSR feature is supported, set OSFXSR (bit 9) in CR4</span>
01811     <span class="comment">//</span>
01812 
01813     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a11">KF_FXSR</a>) {
01814         NumberProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
01815 
01816         <a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a> (
01817             (PKIPI_BROADCAST_WORKER) Ki386EnableFxsr,
01818             (ULONG)(&amp;NumberProcessors)
01819         );
01820 
01821 
01822         <span class="comment">//</span>
01823         <span class="comment">// If XMMI feature is supported,</span>
01824         <span class="comment">//    a. Hook int 19 handler</span>
01825         <span class="comment">//    b. Set OSXMMEXCPT (bit 10) in CR4</span>
01826         <span class="comment">//    c. Enable use of fast XMMI based zero page routines.</span>
01827         <span class="comment">//</span>
01828 
01829         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a13">KF_XMMI</a>) {
01830             <a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a> (
01831                 (PKIPI_BROADCAST_WORKER) Ki386EnableXMMIExceptions,
01832                 (ULONG)(&amp;NumberProcessors)
01833             );
01834 
01835             <a class="code" href="../../d6/d9/kernlini_8c.html#a24">KeZeroPage</a> = <a class="code" href="../../d6/d9/kernlini_8c.html#a54">KiXMMIZeroPage</a>;
01836             <a class="code" href="../../d6/d9/kernlini_8c.html#a25">KeZeroPageFromIdleThread</a> = <a class="code" href="../../d6/d9/kernlini_8c.html#a55">KiXMMIZeroPageNoSave</a>;
01837         }
01838 
01839 
01840     } <span class="keywordflow">else</span> {
01841 <span class="preprocessor">#ifndef NT_UP</span>
01842 <span class="preprocessor"></span>        <span class="comment">//</span>
01843         <span class="comment">// Patch the fxsave instruction in SwapContext to use</span>
01844         <span class="comment">// "fnsave {dd, 31}, fwait {9b}"</span>
01845         <span class="comment">//</span>
01846         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ((ULONG)&amp;ScPatchFxe-(ULONG)&amp;ScPatchFxb) &gt;= 3);
01847 
01848         PatchLocation = (PUCHAR)&amp;<a class="code" href="../../d6/d9/kernlini_8c.html#a21">ScPatchFxb</a>;
01849 
01850         *PatchLocation++ = 0xdd;
01851         *PatchLocation++ = 0x31;
01852         *PatchLocation++ = 0x9b;
01853 
01854         <span class="keywordflow">while</span> (PatchLocation &lt; (PUCHAR)&amp;<a class="code" href="../../d6/d9/kernlini_8c.html#a22">ScPatchFxe</a>) {
01855             <span class="comment">//</span>
01856             <span class="comment">// Put nop's in the remaining bytes</span>
01857             <span class="comment">//</span>
01858             *PatchLocation++ = 0x90;
01859         }
01860 <span class="preprocessor">#endif</span>
01861 <span class="preprocessor"></span>    }
01862 
01863     ActiveProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
01864     <span class="keywordflow">for</span> (CurrentAffinity=1; ActiveProcessors; CurrentAffinity &lt;&lt;= 1) {
01865 
01866         <span class="keywordflow">if</span> (ActiveProcessors &amp; CurrentAffinity) {
01867 
01868             <span class="comment">//</span>
01869             <span class="comment">// Switch to that processor, and remove it from the</span>
01870             <span class="comment">// remaining set of processors</span>
01871             <span class="comment">//</span>
01872 
01873             ActiveProcessors &amp;= ~CurrentAffinity;
01874             <a class="code" href="../../d9/d1/thredobj_8c.html#a19">KeSetSystemAffinityThread</a>(CurrentAffinity);
01875 
01876             <span class="comment">//</span>
01877             <span class="comment">// Determine the MHz for the processor</span>
01878             <span class="comment">//</span>
01879 
01880             <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;MHz = 0;
01881 
01882             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a1">KF_RDTSC</a>) {
01883 
01884                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
01885                 pSamp = Samples;
01886 
01887                 <span class="keywordflow">for</span> (; ;) {
01888 
01889                     <span class="comment">//</span>
01890                     <span class="comment">// Collect a new sample</span>
01891                     <span class="comment">// Delay the thread a "long" amount and time it with</span>
01892                     <span class="comment">// a time source and RDTSC.</span>
01893                     <span class="comment">//</span>
01894 
01895                     <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a> (0, &amp;Junk, &amp;Junk, &amp;Junk, &amp;Junk);
01896                     pSamp-&gt;PerfStart = <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a> (NULL);
01897                     pSamp-&gt;TSCStart = <a class="code" href="../../d5/d3/i386_8h.html#a51">RDTSC</a>();
01898                     pSamp-&gt;PerfFreq.QuadPart = -50000;
01899 
01900                     <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;pSamp-&gt;PerfFreq);
01901 
01902                     <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a> (0, &amp;Junk, &amp;Junk, &amp;Junk, &amp;Junk);
01903                     pSamp-&gt;PerfEnd = <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a> (&amp;pSamp-&gt;PerfFreq);
01904                     pSamp-&gt;TSCEnd = <a class="code" href="../../d5/d3/i386_8h.html#a51">RDTSC</a>();
01905 
01906                     <span class="comment">//</span>
01907                     <span class="comment">// Calculate processors MHz</span>
01908                     <span class="comment">//</span>
01909 
01910                     pSamp-&gt;PerfDelta = pSamp-&gt;PerfEnd.QuadPart - pSamp-&gt;PerfStart.QuadPart;
01911                     pSamp-&gt;TSCDelta = pSamp-&gt;TSCEnd - pSamp-&gt;TSCStart;
01912 
01913                     pSamp-&gt;MHz = (ULONG) ((pSamp-&gt;TSCDelta * pSamp-&gt;PerfFreq.QuadPart + 500000<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) /
01914                                           (pSamp-&gt;PerfDelta * 1000000<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
01915 
01916 
01917                     <span class="comment">//</span>
01918                     <span class="comment">// If last 2 samples matched within a MHz, done</span>
01919                     <span class="comment">//</span>
01920 
01921                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) {
01922                         <span class="keywordflow">if</span> (pSamp-&gt;MHz == pSamp[-1].MHz ||
01923                             pSamp-&gt;MHz == pSamp[-1].MHz + 1 ||
01924                             pSamp-&gt;MHz == pSamp[-1].MHz - 1) {
01925                                 <span class="keywordflow">break</span>;
01926                         }
01927                     }
01928 
01929                     <span class="comment">//</span>
01930                     <span class="comment">// Advance to next sample</span>
01931                     <span class="comment">//</span>
01932 
01933                     pSamp += 1;
01934                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01935 
01936                     <span class="comment">//</span>
01937                     <span class="comment">// If too many samples, then something is wrong</span>
01938                     <span class="comment">//</span>
01939 
01940                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= <a class="code" href="../../d6/d9/kernlini_8c.html#a6">MAX_ATTEMPTS</a>) {
01941 
01942 <span class="preprocessor">#if DBG</span>
01943 <span class="preprocessor"></span>                        <span class="comment">//</span>
01944                         <span class="comment">// Temp breakpoint to see where this is failing</span>
01945                         <span class="comment">// and why</span>
01946                         <span class="comment">//</span>
01947 
01948                         DbgBreakPoint();
01949 <span class="preprocessor">#endif</span>
01950 <span class="preprocessor"></span>
01951                         Average = 0;
01952                         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d6/d9/kernlini_8c.html#a6">MAX_ATTEMPTS</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
01953                             Average += Samples[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].MHz;
01954                         }
01955                         pSamp[-1].MHz = Average / <a class="code" href="../../d6/d9/kernlini_8c.html#a6">MAX_ATTEMPTS</a>;
01956                         <span class="keywordflow">break</span>;
01957                     }
01958 
01959                 }
01960 
01961                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;MHz = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) pSamp[-1].MHz;
01962             }
01963 
01964             <span class="comment">//</span>
01965             <span class="comment">// If MTRRs are supported and PAT not supported, initialize MTRRs</span>
01966             <span class="comment">// per processor</span>
01967             <span class="comment">//</span>
01968 
01969             <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>) &amp;&amp; (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a6">KF_MTRR</a>)) {
01970                 <a class="code" href="../../d8/d4/mtrr_8c.html#a16">KiInitializeMTRR</a> ( (BOOLEAN) (ActiveProcessors ? FALSE : TRUE));
01971             }
01972 
01973             <span class="comment">//</span>
01974             <span class="comment">// If the processor is a AMD K6 with MTRR support then</span>
01975             <span class="comment">// perform processor specific initialization.</span>
01976             <span class="comment">//</span>
01977 
01978             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a15">KF_AMDK6MTRR</a>) {
01979                 <a class="code" href="../../d0/d5/mtrramd_8c.html#a24">KiAmdK6InitializeMTRR</a>();
01980             }
01981 
01982             <span class="comment">//</span>
01983             <span class="comment">// Apply Pentium workaround if needed</span>
01984             <span class="comment">//</span>
01985 
01986             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/kernlini_8c.html#a12">KiI386PentiumLockErrataPresent</a>) {
01987                 <a class="code" href="../../d6/d9/kernlini_8c.html#a36">KiI386PentiumLockErrataFixup</a> ();
01988             }
01989         }
01990     }
01991 
01992     <a class="code" href="../../d9/d1/thredobj_8c.html#a16">KeRevertToUserAffinityThread</a>();
01993     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01994 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="kernlini.c::KiIsNpxPresent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiIsNpxPresent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00246">KiInitializeKernel()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="kernlini.c::KiMoveRegTree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS KiMoveRegTree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Source</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Dest</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02297">2297</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
References <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02008">KeSetup80387OrEmulate()</a>.
<p>
<pre class="fragment"><div>02301 {
02302     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02303     PKEY_BASIC_INFORMATION      KeyInformation;
02304     PKEY_VALUE_FULL_INFORMATION KeyValue;
02305     OBJECT_ATTRIBUTES           <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
02306     HANDLE                      SourceChild;
02307     HANDLE                      DestChild;
02308     ULONG                       ResultLength;
02309     UCHAR                       buffer[1024];           <span class="comment">// hmm....</span>
02310     UNICODE_STRING              <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
02311     UNICODE_STRING              <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
02312 
02313 
02314     KeyValue = (PKEY_VALUE_FULL_INFORMATION)buffer;
02315 
02316     <span class="comment">//</span>
02317     <span class="comment">// Move values from source node to dest node</span>
02318     <span class="comment">//</span>
02319 
02320     <span class="keywordflow">for</span> (; ;) {
02321         <span class="comment">//</span>
02322         <span class="comment">// Get first value</span>
02323         <span class="comment">//</span>
02324 
02325         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateValueKey(Source,
02326                                      0,
02327                                      KeyValueFullInformation,
02328                                      buffer,
02329                                      <span class="keyword">sizeof</span> (buffer),
02330                                      &amp;ResultLength);
02331 
02332         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02333             <span class="keywordflow">break</span>;
02334         }
02335 
02336 
02337         <span class="comment">//</span>
02338         <span class="comment">// Write value to dest node</span>
02339         <span class="comment">//</span>
02340 
02341         <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>.Buffer = KeyValue-&gt;Name;
02342         <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) KeyValue-&gt;NameLength;
02343         ZwSetValueKey( Dest,
02344                        &amp;ValueName,
02345                        KeyValue-&gt;TitleIndex,
02346                        KeyValue-&gt;Type,
02347                        buffer+KeyValue-&gt;DataOffset,
02348                        KeyValue-&gt;DataLength
02349                       );
02350 
02351         <span class="comment">//</span>
02352         <span class="comment">// Delete value and get first value again</span>
02353         <span class="comment">//</span>
02354 
02355         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeleteValueKey (Source, &amp;ValueName);
02356         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02357             <span class="keywordflow">break</span>;
02358         }
02359     }
02360 
02361 
02362     <span class="comment">//</span>
02363     <span class="comment">// Enumerate node's children and apply ourselves to each one</span>
02364     <span class="comment">//</span>
02365 
02366     KeyInformation = (PKEY_BASIC_INFORMATION)buffer;
02367     <span class="keywordflow">for</span> (; ;) {
02368 
02369         <span class="comment">//</span>
02370         <span class="comment">// Open node's first key</span>
02371         <span class="comment">//</span>
02372 
02373         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateKey(
02374                     Source,
02375                     0,
02376                     KeyBasicInformation,
02377                     KeyInformation,
02378                     <span class="keyword">sizeof</span> (buffer),
02379                     &amp;ResultLength
02380                     );
02381 
02382         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02383             <span class="keywordflow">break</span>;
02384         }
02385 
02386         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = KeyInformation-&gt;Name;
02387         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) KeyInformation-&gt;NameLength;
02388 
02389         InitializeObjectAttributes(
02390             &amp;ObjectAttributes,
02391             &amp;KeyName,
02392             OBJ_CASE_INSENSITIVE,
02393             Source,
02394             NULL
02395             );
02396 
02397         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey(
02398                     &amp;SourceChild,
02399                     KEY_ALL_ACCESS,
02400                     &amp;ObjectAttributes
02401                     );
02402 
02403         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02404             <span class="keywordflow">break</span>;
02405         }
02406 
02407         <span class="comment">//</span>
02408         <span class="comment">// Create key in dest tree</span>
02409         <span class="comment">//</span>
02410 
02411         InitializeObjectAttributes(
02412             &amp;ObjectAttributes,
02413             &amp;KeyName,
02414             OBJ_CASE_INSENSITIVE,
02415             Dest,
02416             NULL
02417             );
02418 
02419         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateKey(
02420                     &amp;DestChild,
02421                     KEY_ALL_ACCESS,
02422                     &amp;ObjectAttributes,
02423                     0,
02424                     NULL,
02425                     REG_OPTION_VOLATILE,
02426                     NULL
02427                     );
02428 
02429         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02430             <span class="keywordflow">break</span>;
02431         }
02432 
02433         <span class="comment">//</span>
02434         <span class="comment">// Move subtree</span>
02435         <span class="comment">//</span>
02436 
02437         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/kernlini_8c.html#a44">KiMoveRegTree</a>(SourceChild, DestChild);
02438 
02439         ZwClose(DestChild);
02440         ZwClose(SourceChild);
02441 
02442         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02443             <span class="keywordflow">break</span>;
02444         }
02445 
02446         <span class="comment">//</span>
02447         <span class="comment">// Loop and get first key.  (old first key was delete by the</span>
02448         <span class="comment">// call to KiMoveRegTree).</span>
02449         <span class="comment">//</span>
02450     }
02451 
02452     <span class="comment">//</span>
02453     <span class="comment">// Remove source node</span>
02454     <span class="comment">//</span>
02455 
02456     <span class="keywordflow">return</span> <a class="code" href="../../d7/d7/ntapi_8c.html#a15">NtDeleteKey</a> (Source);
02457 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="kernlini.c::KiSetCR0Bits" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiSetCR0Bits           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00246">KiInitializeKernel()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="kernlini.c::KiSetProcessorType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiSetProcessorType           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00246">KiInitializeKernel()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="kernlini.c::KiSwapIDT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiSwapIDT           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01072">1072</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
References <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00243">IDT</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>01077                    :
01078 
01079     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to edit <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>.  It swaps words of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address
01080     and access fields around into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> part actually needs.
01081     This allows <span class="keywordflow">for</span> easy <span class="keyword">static</span> init of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>.
01082 
01083     Note that <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> edits <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>.
01084 
01085 Arguments:
01086 
01087     None.
01088 
01089 Return Value:
01090 
01091     None.
01092 
01093 --*/
01094 {
01095     LONG    <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01096     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Temp;
01097 
01098     <span class="comment">//</span>
01099     <span class="comment">// Rearrange the entries of IDT to match i386 interrupt gate structure</span>
01100     <span class="comment">//</span>
01101 
01102     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt;= MAXIMUM_IDTVECTOR; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
01103         Temp = <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Selector;
01104         <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Selector = <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].ExtendedOffset;
01105         <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].ExtendedOffset = Temp;
01106     }
01107 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="kernlini.c::KiSwapIDT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiSwapIDT           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="kernlini.c::KiXMMIZeroPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL KiXMMIZeroPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PageBase</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">KiInitMachineDependent()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="kernlini.c::KiXMMIZeroPageNoSave" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL KiXMMIZeroPageNoSave           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PageBase</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">KiInitMachineDependent()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="kernlini.c::KiZeroPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL KiZeroPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PageBase</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a8" doxytag="kernlini.c::CcMasterSpinLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d6/d9/kernlini_8c.html#a8">CcMasterSpinLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00047">47</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="kernlini.c::CcVacbSpinLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d6/d9/kernlini_8c.html#a9">CcVacbSpinLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00048">48</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="kernlini.c::CmDisabledFloatingPointProcessor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> WCHAR <a class="el" href="../../d6/d9/kernlini_8c.html#a17">CmDisabledFloatingPointProcessor</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00184">184</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="kernlini.c::CmpAmdID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UCHAR <a class="el" href="../../d6/d9/kernlini_8c.html#a20">CmpAmdID</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00187">187</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="kernlini.c::CmpCyrixID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UCHAR <a class="el" href="../../d6/d9/kernlini_8c.html#a18">CmpCyrixID</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00185">185</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="kernlini.c::CmpIntelID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UCHAR <a class="el" href="../../d6/d9/kernlini_8c.html#a19">CmpIntelID</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00186">186</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="kernlini.c::IDT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KIDTENTRY <a class="el" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00243">243</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01072">KiSwapIDT()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="kernlini.c::KeI386ForceNpxEmulation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d9/kernlini_8c.html#a16">KeI386ForceNpxEmulation</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00183">183</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02008">KeSetup80387OrEmulate()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="kernlini.c::KeI386XMMIPresent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d1/i386_2thredini_8c.html#a4">KeI386XMMIPresent</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00208">208</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="kernlini.c::KeZeroPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KE_ZERO_PAGE_ROUTINE <a class="el" href="../../d6/d9/kernlini_8c.html#a24">KeZeroPage</a> = KiZeroPage          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00228">228</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">KiInitMachineDependent()</a>, and <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01184">MiZeroPhysicalPage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="kernlini.c::KeZeroPageFromIdleThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KE_ZERO_PAGE_ROUTINE <a class="el" href="../../d6/d9/kernlini_8c.html#a25">KeZeroPageFromIdleThread</a> = KiZeroPage          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00229">229</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">KiInitMachineDependent()</a>, and <a class="el" href="../../d8/d0/zeropage_8c-source.html#l00029">MmZeroPageThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="kernlini.c::Ki386IopmSaveArea" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d6/d9/kernlini_8c.html#a15">Ki386IopmSaveArea</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00182">182</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/biosc_8c-source.html#l00060">Ke386CallBios()</a>, and <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00246">KiInitializeKernel()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="kernlini.c::Ki387RoundModeTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d6/d9/kernlini_8c.html#a14">Ki387RoundModeTable</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00181">181</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02008">KeSetup80387OrEmulate()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="kernlini.c::Ki486CompatibilityLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d9/kernlini_8c.html#a26">Ki486CompatibilityLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00237">237</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00246">KiInitializeKernel()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="kernlini.c::KiI386PentiumLockErrataPresent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d6/d9/kernlini_8c.html#a12">KiI386PentiumLockErrataPresent</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00173">173</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">KiInitMachineDependent()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="kernlini.c::KiIgnoreUnexpectedTrap07" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d6/d9/kernlini_8c.html#a13">KiIgnoreUnexpectedTrap07</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00174">174</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="kernlini.c::MmPfnLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d4/d8/mi_8h.html#a687">MmPfnLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00049">49</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="kernlini.c::MmSystemSpaceLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d4/d8/mi_8h.html#a689">MmSystemSpaceLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00050">50</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="kernlini.c::ScPatchFxb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d6/d9/kernlini_8c.html#a21">ScPatchFxb</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00190">190</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">KiInitMachineDependent()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="kernlini.c::ScPatchFxe" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d6/d9/kernlini_8c.html#a22">ScPatchFxe</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00191">191</a> of file <a class="el" href="../../d7/d8/kernlini_8c-source.html">kernlini.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">KiInitMachineDependent()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:28 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
