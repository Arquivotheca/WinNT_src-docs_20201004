<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: text.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>text.c</h1><a href="../../d5/d0/kernel_2text_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: text.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains the MessageBox API and related functions.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 10-01-90 EricK        Created.</span>
00010 <span class="comment">* 11-20-90 DarrinM      Merged in User text APIs.</span>
00011 <span class="comment">* 02-07-91 DarrinM      Removed TextOut, ExtTextOut, and GetTextExtentPoint stubs.</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
00017 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d0/kernel_2text_8c.html#a0">_TextOutW</a>(
00018     HDC     hdc,
00019     <span class="keywordtype">int</span>     x,
00020     <span class="keywordtype">int</span>     y,
00021     LPCWSTR lp,
00022     UINT    cc);
00023 
00024 <span class="comment">/***************************************************************************\</span>
00025 <span class="comment">* xxxPSMTextOut</span>
00026 <span class="comment">*</span>
00027 <span class="comment">* Outputs the text and puts and _ below the character with an &amp;</span>
00028 <span class="comment">* before it. Note that this routine isn't used for menus since menus</span>
00029 <span class="comment">* have their own special one so that it is specialized and faster...</span>
00030 <span class="comment">*</span>
00031 <span class="comment">* NOTE: A very similar routine (UserLpkPSMTextOut) exists on the client</span>
00032 <span class="comment">*       side in drawtext.c.  Any non-kernel specific changes to this</span>
00033 <span class="comment">*       routine most likely need to be made in UserLpkPSMTextOut as well.</span>
00034 <span class="comment">*</span>
00035 <span class="comment">* History:</span>
00036 <span class="comment">* 11-13-90 JimA         Ported to NT.</span>
00037 <span class="comment">* 30-Nov-1992 mikeke    Client side version</span>
00038 <span class="comment">* 8-Apr-1998 MCostea    Added dwFlags</span>
00039 <span class="comment">\***************************************************************************/</span>
00040 
<a name="l00041"></a><a class="code" href="../../d4/d1/userk_8h.html#a1407">00041</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1407">xxxPSMTextOut</a>(
00042     HDC hdc,
00043     <span class="keywordtype">int</span> xLeft,
00044     <span class="keywordtype">int</span> yTop,
00045     LPWSTR lpsz,
00046     <span class="keywordtype">int</span> cch,
00047     DWORD dwFlags)
00048 {
00049     <span class="keywordtype">int</span> cx;
00050     LONG textsize, result;
00051     <span class="comment">/*</span>
00052 <span class="comment">     * In the kernel we have a limited amount of stack. So it should be a stack</span>
00053 <span class="comment">     * variable in user mode and static in kernel mode where it is thread safe</span>
00054 <span class="comment">     * since we are in the crit section.</span>
00055 <span class="comment">     */</span>
00056     <span class="keyword">static</span> WCHAR achWorkBuffer[255];
00057     WCHAR *pchOut = achWorkBuffer;
00058     TEXTMETRICW textMetric;
00059     SIZE size;
00060     RECT rc;
00061     COLORREF color;
00062     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00063 
00064     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a393">CALL_LPK</a>(ptiCurrent)) {
00065         <span class="comment">/*</span>
00066 <span class="comment">         * A user mode LPK is installed for layout and shaping.</span>
00067 <span class="comment">         * Perform callback and return.</span>
00068 <span class="comment">         */</span>
00069         UNICODE_STRING ustrStr;
00070 
00071         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ustrStr, lpsz);
00072         <a class="code" href="../../d4/d1/userk_8h.html#a1409">xxxClientPSMTextOut</a>(hdc, xLeft, yTop, &amp;ustrStr, cch, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00073         <span class="keywordflow">return</span>;
00074     }
00075 
00076     <span class="keywordflow">if</span> (cch &gt; <span class="keyword">sizeof</span>(achWorkBuffer)/<span class="keyword">sizeof</span>(WCHAR)) {
00077         pchOut = (WCHAR*)UserAllocPool((cch+1) * <span class="keyword">sizeof</span>(WCHAR), TAG_RTL);
00078         <span class="keywordflow">if</span> (pchOut == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00079             <span class="keywordflow">return</span>;
00080     }
00081 
00082     result = <a class="code" href="../../d5/d2/rtl_2drawtext_8c.html#a39">GetPrefixCount</a>(lpsz, cch, pchOut, cch);
00083 
00084     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; DT_PREFIXONLY)) {
00085         <a class="code" href="../../d5/d0/kernel_2text_8c.html#a0">_TextOutW</a>(hdc, xLeft, yTop, pchOut, cch - HIWORD(result));
00086     }
00087 
00088     <span class="comment">/*</span>
00089 <span class="comment">     * Any true prefix characters to underline?</span>
00090 <span class="comment">     */</span>
00091     <span class="keywordflow">if</span> (LOWORD(result) == 0xFFFF || <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; DT_HIDEPREFIX) {
00092         <span class="keywordflow">if</span> (pchOut != achWorkBuffer)
00093             UserFreePool(pchOut);
00094         <span class="keywordflow">return</span>;
00095     }
00096 
00097     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1933">_GetTextMetricsW</a>(hdc, &amp;textMetric)) {
00098         textMetric.tmOverhang = 0;
00099         textMetric.tmAscent = 0;
00100     }
00101 
00102     <span class="comment">/*</span>
00103 <span class="comment">     * For proportional fonts, find starting point of underline.</span>
00104 <span class="comment">     */</span>
00105     <span class="keywordflow">if</span> (LOWORD(result) != 0) {
00106 
00107         <span class="comment">/*</span>
00108 <span class="comment">         * How far in does underline start (if not at 0th byte.).</span>
00109 <span class="comment">         */</span>
00110         GreGetTextExtentW(hdc, (LPWSTR)pchOut, LOWORD(result), &amp;size, GGTE_WIN3_EXTENT);
00111         xLeft += size.cx;
00112 
00113         <span class="comment">/*</span>
00114 <span class="comment">         * Adjust starting point of underline if not at first char and there is</span>
00115 <span class="comment">         * an overhang.  (Italics or bold fonts.)</span>
00116 <span class="comment">         */</span>
00117         xLeft = xLeft - textMetric.tmOverhang;
00118     }
00119 
00120     <span class="comment">/*</span>
00121 <span class="comment">     * Adjust for proportional font when setting the length of the underline and</span>
00122 <span class="comment">     * height of text.</span>
00123 <span class="comment">     */</span>
00124     GreGetTextExtentW(hdc, (LPWSTR)(pchOut + LOWORD(result)), 1, &amp;size, GGTE_WIN3_EXTENT);
00125     textsize = size.cx;
00126 
00127     <span class="comment">/*</span>
00128 <span class="comment">     * Find the width of the underline character.  Just subtract out the overhang</span>
00129 <span class="comment">     * divided by two so that we look better with italic fonts.  This is not</span>
00130 <span class="comment">     * going to effect embolded fonts since their overhang is 1.</span>
00131 <span class="comment">     */</span>
00132     cx = LOWORD(textsize) - textMetric.tmOverhang / 2;
00133 
00134     <span class="comment">/*</span>
00135 <span class="comment">     * Get height of text so that underline is at bottom.</span>
00136 <span class="comment">     */</span>
00137     yTop += textMetric.tmAscent + 1;
00138 
00139     <span class="comment">/*</span>
00140 <span class="comment">     * Draw the underline using the foreground color.</span>
00141 <span class="comment">     */</span>
00142     <a class="code" href="../../d3/d6/rect_8c.html#a1">SetRect</a>(&amp;rc, xLeft, yTop, xLeft+cx, yTop+1);
00143     color = GreSetBkColor(hdc, GreGetTextColor(hdc));
00144     GreExtTextOutW(hdc, xLeft, yTop, ETO_OPAQUE, &amp;rc, TEXT(<span class="stringliteral">""</span>), 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00145     GreSetBkColor(hdc, color);
00146 
00147     <span class="keywordflow">if</span> (pchOut != achWorkBuffer) {
00148         UserFreePool(pchOut);
00149     }
00150 }
00151 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
