<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: restrfil.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>restrfil.c File Reference</h1><code>#include &lt;nt.h&gt;</code><br>
<code>#include &lt;ntdef.h&gt;</code><br>
<code>#include &lt;ntrtl.h&gt;</code><br>
<code>#include &lt;nturtl.h&gt;</code><br>
<code>#include &lt;windef.h&gt;</code><br>
<code>#include &lt;winbase.h&gt;</code><br>

<p>
<a href="../../d7/d8/restrfil_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a0">GetSiteSidFromToken</a>&nbsp;&nbsp;&nbsp;xxxGetSiteSidFromToken</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a1">GetMangledSiteSid</a>&nbsp;&nbsp;&nbsp;xxxGetMangledSiteSid</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a2">IsTokenRestricted</a>&nbsp;&nbsp;&nbsp;xxxIsTokenRestricted</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(object)</td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom>{ <a class="el" href="../../d6/d9/restrfil_8c.html#a41a10">eUnRestricted</a> =  0, 
<a class="el" href="../../d6/d9/restrfil_8c.html#a41a11">eRestricted</a>, 
<a class="el" href="../../d6/d9/restrfil_8c.html#a41a12">eUnknownRestricted</a>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a13">Base32Encode</a> (<a class="el" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> pvData, UINT cbData, LPWSTR pchData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HRESULT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a14">GetMangledSiteSid</a> (PSID pSid, ULONG cchMangledSite, LPWSTR *ppwszMangledSite)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PSID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a15">GetSiteSidFromToken</a> (IN HANDLE TokenHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a16">IsTokenRestricted</a> (IN HANDLE TokenHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a17">IsInterestingPath</a> (OBJECT_ATTRIBUTES *NormalFile, OBJECT_ATTRIBUTES *RestrictedFile)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a18">CopyRestrictedFile</a> (OBJECT_ATTRIBUTES *SourceAttributes, OBJECT_ATTRIBUTES *DestinationAttributes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a19">CreateDirectories</a> (OBJECT_ATTRIBUTES *Attributes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a20">FileExists</a> (OBJECT_ATTRIBUTES *Attributes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a21">CopyStream</a> (HANDLE SourceFile, HANDLE DestinationFile, FILE_STREAM_INFORMATION *StreamInfo, <a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *<a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a22">InitializeRestrictedStuff</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a23">NtUnRestrictedCreateFile</a> (OUT PHANDLE FileHandle, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, OUT PIO_STATUS_BLOCK IoStatusBlock, IN PLARGE_INTEGER AllocationSize OPTIONAL, IN ULONG <a class="el" href="../../d2/d2/rtload_8c.html#a5">FileAttributes</a>, IN ULONG ShareAccess, IN ULONG CreateDisposition, IN ULONG CreateOptions, IN PVOID EaBuffer OPTIONAL, IN ULONG EaLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a24">NtUnRestrictedOpenFile</a> (OUT PHANDLE FileHandle, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, OUT PIO_STATUS_BLOCK IoStatusBlock, IN ULONG ShareAccess, IN ULONG OpenOptions)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a25">NtUnRestrictedDeleteFile</a> (IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a26">NtUnRestrictedQueryAttributesFile</a> (IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, OUT PFILE_BASIC_INFORMATION FileInformation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a27">NtUnRestrictedSetInformationFile</a> (IN HANDLE FileHandle, OUT PIO_STATUS_BLOCK IoStatusBlock, IN PVOID FileInformation, IN ULONG Length, IN FILE_INFORMATION_CLASS FileInformationClass)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a28">CheckRestricted</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>__inline BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a29">IsRestricted</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a30">NtCreateFile</a> (OUT PHANDLE FileHandle, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, OUT PIO_STATUS_BLOCK IoStatusBlock, IN PLARGE_INTEGER AllocationSize OPTIONAL, IN ULONG <a class="el" href="../../d2/d2/rtload_8c.html#a5">FileAttributes</a>, IN ULONG ShareAccess, IN ULONG CreateDisposition, IN ULONG CreateOptions, IN PVOID EaBuffer OPTIONAL, IN ULONG EaLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a> (OUT PHANDLE FileHandle, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, OUT PIO_STATUS_BLOCK IoStatusBlock, IN PLARGE_INTEGER AllocationSize OPTIONAL, IN ULONG <a class="el" href="../../d2/d2/rtload_8c.html#a5">FileAttributes</a>, IN ULONG ShareAccess, IN ULONG CreateDisposition, IN ULONG CreateOptions, IN PVOID EaBuffer OPTIONAL, IN ULONG EaLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a32">NtOpenFile</a> (OUT PHANDLE FileHandle, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, OUT PIO_STATUS_BLOCK IoStatusBlock, IN ULONG ShareAccess, IN ULONG OpenOptions)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a> (OUT PHANDLE FileHandle, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, OUT PIO_STATUS_BLOCK IoStatusBlock, IN ULONG ShareAccess, IN ULONG OpenOptions)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a34">NtDeleteFile</a> (IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a35">ZwDeleteFile</a> (IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a36">NtQueryAttributesFile</a> (IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, OUT PFILE_BASIC_INFORMATION FileInformation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a37">ZwQueryAttributesFile</a> (IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, OUT PFILE_BASIC_INFORMATION FileInformation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a38">NtSetInformationFile</a> (IN HANDLE FileHandle, OUT PIO_STATUS_BLOCK IoStatusBlock, IN PVOID FileInformation, IN ULONG Length, IN FILE_INFORMATION_CLASS FileInformationClass)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a39">ZwSetInformationFile</a> (IN HANDLE FileHandle, OUT PIO_STATUS_BLOCK IoStatusBlock, IN PVOID FileInformation, IN ULONG Length, IN FILE_INFORMATION_CLASS FileInformationClass)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a40">IsInterestingPath</a> (IN POBJECT_ATTRIBUTES NormalFile, IN OUT POBJECT_ATTRIBUTES RestrictedFile)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum  { ... } &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a6">SystemPath1</a> = {0, 0, 0}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a7">SystemPath2</a> = {0, 0, 0}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a8">SystemPath3</a> = {0, 0, 0}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d9/restrfil_8c.html#a9">SiteDirectory</a> = {0, 0, 0}</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a3" doxytag="restrfil.c::CALL_CREATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CALL_CREATE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">object&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d6/d9/restrfil_8c.html#a23">NtUnRestrictedCreateFile</a>(       \
                    FileHandle,             \
                    DesiredAccess,          \
                    object,                 \
                    IoStatusBlock,          \
                    AllocationSize,         \
                    FileAttributes,         \
                    ShareAccess,            \
                    CreateDisposition,      \
                    CreateOptions,          \
                    EaBuffer,               \
                    EaLength)
</div></pre>
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00253">NtCreateFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="restrfil.c::CALL_OPEN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CALL_OPEN          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">object&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d6/d9/restrfil_8c.html#a24">NtUnRestrictedOpenFile</a>(       \
                    FileHandle,             \
                    DesiredAccess,          \
                    object,                 \
                    IoStatusBlock,          \
                    ShareAccess,            \
                    OpenOptions)
</div></pre>
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00449">NtOpenFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="restrfil.c::GetMangledSiteSid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GetMangledSiteSid&nbsp;&nbsp;&nbsp;xxxGetMangledSiteSid          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00038">38</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">InitializeRestrictedStuff()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="restrfil.c::GetSiteSidFromToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GetSiteSidFromToken&nbsp;&nbsp;&nbsp;xxxGetSiteSidFromToken          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00037">37</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">InitializeRestrictedStuff()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="restrfil.c::IsTokenRestricted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsTokenRestricted&nbsp;&nbsp;&nbsp;xxxIsTokenRestricted          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00039">39</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00129">CheckRestricted()</a>.    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a41" doxytag="restrfil.c::@21" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> anonymous enum          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a41a10" doxytag="eUnRestricted" ></a>eUnRestricted</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a41a11" doxytag="eRestricted" ></a>eRestricted</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a41a12" doxytag="eUnknownRestricted" ></a>eUnknownRestricted</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00113">113</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
<pre class="fragment"><div>00114 {
00115     <a class="code" href="../../d6/d9/restrfil_8c.html#a41a10">eUnRestricted</a> = 0,
00116     <a class="code" href="../../d6/d9/restrfil_8c.html#a41a11">eRestricted</a>,
00117     <a class="code" href="../../d6/d9/restrfil_8c.html#a41a12">eUnknownRestricted</a>
00118 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a13" doxytag="restrfil.c::Base32Encode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void Base32Encode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pvData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>cbData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>pchData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01953">1953</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, and <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01915">GetMangledSiteSid()</a>.
<p>
<pre class="fragment"><div>01954 {
01955     <span class="keyword">static</span> <span class="keyword">const</span> WCHAR alphabet[32] =
01956         { <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'a'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'b'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'c'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'d'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'e'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'f'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'g'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'h'</span>,
01957           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'i'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'j'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'k'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'l'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'m'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'n'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'o'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'p'</span>,
01958           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'q'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'r'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'s'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'t'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'u'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'v'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'w'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'x'</span>,
01959           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'y'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'z'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'1'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'2'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'3'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'4'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'5'</span> };
01960 
01961     <span class="keywordtype">int</span>   shift = 0;    <span class="comment">// The # of unprocessed bits in accum</span>
01962     ULONG accum = 0;    <span class="comment">// The unprocessed bits</span>
01963     ULONG value;
01964     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *pData = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *) pvData;
01965 
01966     <span class="comment">// For each byte...</span>
01967 
01968     <span class="keywordflow">while</span> (cbData)
01969     {
01970         <span class="comment">// Move the byte into the low bits of the accumulator</span>
01971 
01972         accum = (accum &lt;&lt; 8) | *pData++;
01973         shift += 8;
01974         --cbData;
01975 
01976         <span class="comment">// Lop off the high 5 or 10 bits and write them out</span>
01977 
01978         <span class="keywordflow">while</span> ( shift &gt;= 5 )
01979         {
01980             shift -= 5;
01981             value = (accum &gt;&gt; shift) &amp; 0x1Fl;
01982 
01983             *pchData++ = alphabet[value];
01984         }
01985     }
01986 
01987     <span class="comment">// If there are any remaining bits, push out one more char padded with 0's</span>
01988 
01989     <span class="keywordflow">if</span> (shift)
01990     {
01991         value = (accum &lt;&lt; (5 - shift)) &amp; 0x1Fl;
01992 
01993         *pchData++ = alphabet[value];
01994     }
01995 
01996     *pchData = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01997 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="restrfil.c::CheckRestricted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void CheckRestricted           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00129">129</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a41a11">eRestricted</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a41a10">eUnRestricted</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">InitializeRestrictedStuff()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00039">IsTokenRestricted</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00178">NtOpenProcessToken()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00223">IsRestricted()</a>.
<p>
<pre class="fragment"><div>00132                    :
00133 
00134     Determine <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a restricted process and thus should have filesystem
00135     redirection active.
00136 
00137 Arguments:
00138 
00139     None
00140 
00141 Return Value:
00142 
00143     <span class="keywordtype">void</span>
00144 
00145 --*/
00146 {
00147     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00148     HANDLE              hToken;
00149     UNICODE_STRING      SandboxKeyName;
00150     HANDLE              SandboxKey;
00151     OBJECT_ATTRIBUTES   Attributes;
00152     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>                <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[256];
00153     ULONG               Length;
00154 
00155     KEY_VALUE_PARTIAL_INFORMATION *ValueInfo = (KEY_VALUE_PARTIAL_INFORMATION *) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00156 
00157     <span class="comment">//</span>
00158     <span class="comment">// Assume unrestricted unless we have reason to believe otherwise</span>
00159     <span class="comment">//</span>
00160 
00161     <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a41a10">eUnRestricted</a>;
00162 
00163     <span class="comment">//</span>
00164     <span class="comment">// HACKHACK: Temporarily allow redirection to be forced off by setting</span>
00165     <span class="comment">//           HKLM\Software\Sandbox!FileSystemRedir = (REG_DWORD) 0</span>
00166     <span class="comment">//</span>
00167 
00168     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SandboxKeyName, L<span class="stringliteral">"\\Registry\\Machine\\Software\\Sandbox"</span>);
00169 
00170     InitializeObjectAttributes(
00171             &amp;Attributes,
00172             &amp;SandboxKeyName,
00173             OBJ_CASE_INSENSITIVE,
00174             NULL,
00175             NULL);
00176 
00177     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;SandboxKey, KEY_READ, &amp;Attributes);
00178 
00179     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; STATUS_OBJECT_NAME_NOT_FOUND != <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)
00180         <span class="keywordflow">return</span>;
00181 
00182     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00183     {
00184         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SandboxKeyName, L<span class="stringliteral">"FileSystemRedir"</span>);
00185 
00186         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00187                         SandboxKey,
00188                         &amp;SandboxKeyName,
00189                         KeyValuePartialInformation,
00190                         ValueInfo,
00191                         <span class="keyword">sizeof</span>(Buffer),
00192                         &amp;Length);
00193 
00194         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SandboxKey);
00195 
00196         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; STATUS_OBJECT_NAME_NOT_FOUND != <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)
00197             <span class="keywordflow">return</span>;
00198 
00199         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; 0 == * (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *) (&amp;ValueInfo-&gt;Data))
00200             <span class="keywordflow">return</span>;
00201     }
00202 
00203     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(NtCurrentProcess(), TOKEN_READ, &amp;hToken);
00204 
00205     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00206     {
00207         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a2">IsTokenRestricted</a>(hToken))
00208         {
00209             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a22">InitializeRestrictedStuff</a>();
00210 
00211             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00212                 <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a41a11">eRestricted</a>;
00213         }
00214 
00215         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hToken);
00216     }
00217 }
 
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="restrfil.c::CopyRestrictedFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CopyRestrictedFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OBJECT_ATTRIBUTES *&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OBJECT_ATTRIBUTES *&nbsp;</td>
          <td class="mdname" nowrap> <em>DestinationAttributes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01596">1596</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01451">CopyStream()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01311">CreateDirectories()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a23">NtUnRestrictedCreateFile()</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a25">NtUnRestrictedDeleteFile()</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a24">NtUnRestrictedOpenFile()</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a26">NtUnRestrictedQueryAttributesFile()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00253">NtCreateFile()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00449">NtOpenFile()</a>.
<p>
<pre class="fragment"><div>01601                    :
01602 
01603     <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  Substreams in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> are copied and a best effort <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>
01604     to preserve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> attributes - although <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> copy does not fail <span class="keywordflow">if</span>
01605     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes can'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> be preserved.  Acl's and extended attributes such
01606     as object <span class="keywordtype">id</span>'s are not copied.
01607 
01608     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent directories of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination don'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> exist they
01609     are created.
01610 
01611 Arguments:
01612 
01613     SourceAttributes        - The source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
01614     DestinationAttributues  - The destination <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
01615 
01616 Return Value:
01617 
01618     STATUS_SUCCESS <span class="keywordflow">if</span> all goes well
01619 
01620     The copy fails <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination already exists or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> read-<a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
01621 
01622 --*/
01623 {
01624     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01625     HANDLE          SourceFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01626     HANDLE          DestinationFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01627     IO_STATUS_BLOCK SourceIoStatus;
01628     IO_STATUS_BLOCK DestinationIoStatus;
01629     ULONG           StreamInfoSize = 4096;
01630     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>           *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01631     ULONG           <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = 8192;
01632 
01633     FILE_BASIC_INFORMATION      BasicInfo;
01634     FILE_STANDARD_INFORMATION   StandardInfo;
01635     FILE_STREAM_INFORMATION    *StreamInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01636     FILE_STREAM_INFORMATION    *Stream;
01637 
01638     <span class="comment">//</span>
01639     <span class="comment">// Check the attributes on the source.  If it's set to </span>
01640     <span class="comment">// read-only don't try to copy it</span>
01641     <span class="comment">//</span>
01642 
01643     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a26">NtUnRestrictedQueryAttributesFile</a>(SourceAttributes, &amp;BasicInfo);
01644 
01645     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01646         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01647     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (BasicInfo.FileAttributes &amp; FILE_ATTRIBUTE_READONLY)
01648         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
01649 
01650 
01651     <span class="comment">//</span>
01652     <span class="comment">// Try to open the source file</span>
01653     <span class="comment">//</span>
01654 
01655     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a24">NtUnRestrictedOpenFile</a>(
01656                     &amp;SourceFile,
01657                     GENERIC_READ | SYNCHRONIZE,
01658                     SourceAttributes,
01659                     &amp;SourceIoStatus,
01660                     FILE_SHARE_READ,
01661                     FILE_SEQUENTIAL_ONLY | FILE_SYNCHRONOUS_IO_NONALERT);
01662 
01663     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01664         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01665 
01666     <span class="comment">//</span>
01667     <span class="comment">// Get the size of the source.  If this fails don't worry about it.</span>
01668     <span class="comment">//</span>
01669 
01670     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d2/qsinfo_8c.html#a3">NtQueryInformationFile</a>(
01671                     SourceFile,
01672                     &amp;SourceIoStatus,
01673                     &amp;StandardInfo,
01674                     <span class="keyword">sizeof</span>(StandardInfo),
01675                     FileStandardInformation);
01676 
01677     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01678         StandardInfo.AllocationSize.QuadPart = 0;
01679 
01680     <span class="comment">// </span>
01681     <span class="comment">// Get the file stream information.  There's no way to tell how big a </span>
01682     <span class="comment">// buffer we'll need to just keep doubling it.</span>
01683     <span class="comment">//</span>
01684 
01685     <span class="keywordflow">do</span>
01686     {
01687         StreamInfo = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0, StreamInfoSize);    
01688 
01689         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == StreamInfo)
01690         {
01691             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01692             <span class="keywordflow">goto</span> ErrorOut;
01693         }
01694 
01695         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d2/qsinfo_8c.html#a3">NtQueryInformationFile</a>(
01696                         SourceFile,
01697                         &amp;SourceIoStatus,
01698                         StreamInfo,
01699                         StreamInfoSize,
01700                         FileStreamInformation);
01701 
01702         StreamInfoSize *= 2;
01703     }
01704     <span class="keywordflow">while</span> (STATUS_BUFFER_OVERFLOW == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> 
01705                || STATUS_BUFFER_TOO_SMALL == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01706 
01707     <span class="comment">//</span>
01708     <span class="comment">// Allocate a buffer to do the copying</span>
01709     <span class="comment">//</span>
01710 
01711     <span class="keywordflow">do</span>
01712     {
01713         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0, BufferSize);
01714 
01715         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)
01716             <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> /= 2;
01717     }
01718     <span class="keywordflow">while</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> &amp;&amp; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &gt; 15);
01719 
01720     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)
01721         <span class="keywordflow">goto</span> ErrorOut;
01722             
01723     <span class="comment">//</span>
01724     <span class="comment">// Try to create the destination file</span>
01725     <span class="comment">//</span>
01726 
01727     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a23">NtUnRestrictedCreateFile</a>(
01728                     &amp;DestinationFile,
01729                     GENERIC_WRITE | SYNCHRONIZE,
01730                     DestinationAttributes,
01731                     &amp;DestinationIoStatus,
01732                     &amp;StandardInfo.AllocationSize,
01733                     BasicInfo.FileAttributes,
01734                     0,
01735                     FILE_CREATE,
01736                     FILE_SEQUENTIAL_ONLY | FILE_SYNCHRONOUS_IO_NONALERT,
01737                     NULL,
01738                     0);
01739 
01740     <span class="comment">//</span>
01741     <span class="comment">// If creating the file failed because the path doesn't exist,</span>
01742     <span class="comment">// create the path and try again</span>
01743     <span class="comment">//</span>
01744 
01745     <span class="keywordflow">if</span> (STATUS_OBJECT_PATH_NOT_FOUND == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)
01746     {
01747         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a19">CreateDirectories</a>(DestinationAttributes);
01748 
01749         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01750         {
01751             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a23">NtUnRestrictedCreateFile</a>(
01752                             &amp;DestinationFile,
01753                             GENERIC_WRITE | SYNCHRONIZE,
01754                             DestinationAttributes,
01755                             &amp;DestinationIoStatus,
01756                             &amp;StandardInfo.AllocationSize,
01757                             BasicInfo.FileAttributes,
01758                             0,
01759                             FILE_CREATE,
01760                             FILE_SEQUENTIAL_ONLY |FILE_SYNCHRONOUS_IO_NONALERT,
01761                             NULL,
01762                             0);
01763         }
01764     }
01765 
01766     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01767         <span class="keywordflow">goto</span> ErrorOut;
01768 
01769     <span class="comment">//</span>
01770     <span class="comment">// Set the file times.  It's ok to fail</span>
01771     <span class="comment">//</span>
01772 
01773     <a class="code" href="../../d9/d2/qsinfo_8c.html#a4">NtSetInformationFile</a>(
01774             DestinationFile,
01775             &amp;DestinationIoStatus,
01776             &amp;BasicInfo,
01777             <span class="keyword">sizeof</span>(BasicInfo),
01778             FileBasicInformation);
01779 
01780     <span class="comment">//</span>
01781     <span class="comment">// Copy each stream in the file</span>
01782     <span class="comment">//</span>
01783 
01784     Stream = StreamInfo;
01785 
01786     <span class="keywordflow">do</span>
01787     {
01788         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a21">CopyStream</a>(
01789                         SourceFile, 
01790                         DestinationFile, 
01791                         Stream, 
01792                         Buffer, 
01793                         BufferSize);
01794 
01795         <span class="keywordflow">if</span> (0 == Stream-&gt;NextEntryOffset)
01796             <span class="keywordflow">break</span>;
01797 
01798         Stream = (FILE_STREAM_INFORMATION *) 
01799                         (((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *) Stream) + Stream-&gt;NextEntryOffset);
01800     }
01801     <span class="keywordflow">while</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01802 
01803 ErrorOut:
01804 
01805     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)
01806         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, Buffer);
01807     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != StreamInfo)
01808         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, StreamInfo);
01809     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != SourceFile)
01810         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SourceFile);
01811 
01812     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != DestinationFile)
01813     {
01814         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(DestinationFile);
01815 
01816         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01817         {
01818             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> DeleteStatus;
01819             DeleteStatus = <a class="code" href="../../d6/d9/restrfil_8c.html#a25">NtUnRestrictedDeleteFile</a>(DestinationAttributes);
01820             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(DeleteStatus));
01821         }
01822     }
01823 
01824     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01825 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="restrfil.c::CopyStream" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CopyStream           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>DestinationFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FILE_STREAM_INFORMATION *&nbsp;</td>
          <td class="mdname" nowrap> <em>StreamInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01451">1451</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a23">NtUnRestrictedCreateFile()</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a24">NtUnRestrictedOpenFile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01596">CopyRestrictedFile()</a>.
<p>
<pre class="fragment"><div>01459                    :
01460 
01461     <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> a stream from one <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to another
01462 
01463 Arguments:
01464 
01465     SourceFile      - The source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
01466     DestinationFile - The destination <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
01467     StreamInfo      - Information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream to copy
01468     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>          - The buffer to use <span class="keywordflow">for</span> copying
01469     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>      - The size of <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>
01470 
01471 Return Value:
01472 
01473     STATUS_SUCCESS <span class="keywordflow">if</span> all goes well
01474 
01475 --*/
01476 {
01477     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01478     UNICODE_STRING      StreamName;
01479     OBJECT_ATTRIBUTES   SourceAttributes;
01480     OBJECT_ATTRIBUTES   DestinationAttributes;
01481     HANDLE              SourceStream;
01482     HANDLE              DestinationStream;
01483     IO_STATUS_BLOCK     SourceIoStatus;
01484     IO_STATUS_BLOCK     DestinationIoStatus;
01485 
01486     StreamName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) StreamInfo-&gt;StreamNameLength;
01487     StreamName.Length        = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) StreamInfo-&gt;StreamNameLength;
01488     StreamName.Buffer        = StreamInfo-&gt;StreamName;
01489 
01490     <span class="comment">//</span>
01491     <span class="comment">// Data stream names are of the form ":&lt;name&gt;:$DATA" so if the second</span>
01492     <span class="comment">// char in the name is a colon then this is the default stream and we</span>
01493     <span class="comment">// don't need to open/create it</span>
01494     <span class="comment">//</span>
01495 
01496     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">':'</span> == StreamInfo-&gt;StreamName[1])
01497     {
01498         SourceStream = SourceFile;
01499         DestinationStream = DestinationFile;
01500     }
01501     <span class="keywordflow">else</span>
01502     {
01503         InitializeObjectAttributes(
01504                 &amp;SourceAttributes,
01505                 &amp;StreamName,
01506                 OBJ_CASE_INSENSITIVE,
01507                 SourceFile,
01508                 NULL);            
01509         InitializeObjectAttributes(
01510                 &amp;DestinationAttributes,
01511                 &amp;StreamName,
01512                 OBJ_CASE_INSENSITIVE,
01513                 DestinationFile,
01514                 NULL);
01515 
01516         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a24">NtUnRestrictedOpenFile</a>(
01517                         &amp;SourceStream,
01518                         GENERIC_READ | SYNCHRONIZE,
01519                         &amp;SourceAttributes,
01520                         &amp;SourceIoStatus,
01521                         FILE_SHARE_READ,
01522                         FILE_SEQUENTIAL_ONLY | FILE_SYNCHRONOUS_IO_NONALERT);
01523 
01524         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01525             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01526 
01527         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a23">NtUnRestrictedCreateFile</a>(
01528                         &amp;DestinationStream,
01529                         GENERIC_WRITE | SYNCHRONIZE,
01530                         &amp;DestinationAttributes,
01531                         &amp;DestinationIoStatus,
01532                         &amp;StreamInfo-&gt;StreamAllocationSize,
01533                         FILE_ATTRIBUTE_NORMAL,
01534                         0,
01535                         FILE_CREATE,
01536                         FILE_SEQUENTIAL_ONLY | FILE_SYNCHRONOUS_IO_NONALERT,
01537                         NULL,
01538                         0);
01539 
01540         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01541         {
01542             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SourceStream);
01543             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01544         }
01545     }
01546 
01547     <span class="comment">//</span>
01548     <span class="comment">// Copy the stream</span>
01549     <span class="comment">//</span>
01550 
01551     <span class="keywordflow">do</span>
01552     {
01553         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/io_2read_8c.html#a1">NtReadFile</a>(
01554                         SourceStream,
01555                         NULL,
01556                         NULL,
01557                         NULL,
01558                         &amp;SourceIoStatus,
01559                         Buffer,
01560                         BufferSize,
01561                         0,
01562                         NULL);
01563 
01564         <span class="keywordflow">if</span> (STATUS_END_OF_FILE == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)
01565         {
01566             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01567             <span class="keywordflow">break</span>;
01568         }
01569         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01570         {
01571             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d0/io_2write_8c.html#a0">NtWriteFile</a>(
01572                             DestinationStream,
01573                             NULL,
01574                             NULL,
01575                             NULL,
01576                             &amp;DestinationIoStatus,
01577                             Buffer,
01578                             SourceIoStatus.Information,
01579                             0,
01580                             NULL);
01581         }
01582     }
01583     <span class="keywordflow">while</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; SourceIoStatus.Information == <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
01584 
01585     <span class="keywordflow">if</span> (SourceStream != SourceFile)
01586     {
01587         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SourceStream);
01588         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(DestinationStream);
01589     }
01590 
01591     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01592 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="restrfil.c::CreateDirectories" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CreateDirectories           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OBJECT_ATTRIBUTES *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Attributes</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01311">1311</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a23">NtUnRestrictedCreateFile()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00124">SiteDirectory</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01596">CopyRestrictedFile()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00253">NtCreateFile()</a>.
<p>
<pre class="fragment"><div>01314                    :
01315 
01316     Given <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> pointed to by Attributes, make sure all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directories
01317     above <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last element in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> exist.
01318 
01319 Parameters:
01320 
01321     Attributes - The <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>
01322 
01323 Return Value:
01324 
01325     STATUS_SUCCESS <span class="keywordflow">if</span> all goes well
01326 
01327 --*/
01328 {
01329     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01330     UNICODE_STRING      SubDirectory;
01331     OBJECT_ATTRIBUTES   DirectoryAttributes;
01332     HANDLE              NewDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01333     WCHAR              *NextDirectory;
01334     WCHAR              *EndOfString;
01335     IO_STATUS_BLOCK     IoStatus;
01336 
01337     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NULL == Attributes-&gt;RootDirectory);
01338 
01339     InitializeObjectAttributes(
01340             &amp;DirectoryAttributes,
01341             &amp;SubDirectory,
01342             OBJ_CASE_INSENSITIVE,
01343             NULL,
01344             NULL);
01345 
01346     <span class="comment">// </span>
01347     <span class="comment">// Keep track of the end of the path and trim off any trailing '\'s</span>
01348     <span class="comment">//</span>
01349 
01350     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Attributes-&gt;ObjectName-&gt;Length &gt;= 2);
01351 
01352     EndOfString         = Attributes-&gt;ObjectName-&gt;Buffer 
01353                             + Attributes-&gt;ObjectName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
01354 
01355     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span> == EndOfString[-1])
01356         --EndOfString;
01357 
01358     <span class="comment">// </span>
01359     <span class="comment">// Keep of a private version of the path so we can muck with it</span>
01360     <span class="comment">//</span>
01361 
01362     SubDirectory.Buffer = Attributes-&gt;ObjectName-&gt;Buffer;
01363     NextDirectory       = SubDirectory.Buffer;
01364     NextDirectory      += <a class="code" href="../../d6/d9/restrfil_8c.html#a9">SiteDirectory</a>.Length / <span class="keyword">sizeof</span>(WCHAR);
01365 
01366     <span class="comment">//</span>
01367     <span class="comment">// For each element in the path, try to create a directory using the full</span>
01368     <span class="comment">// path up to that element.</span>
01369     <span class="comment">//</span>
01370     <span class="comment">// Notes: CreateFile for "\??" returns STATUS_OBJECT_TYPE_MISMATCH</span>
01371     <span class="comment">//        CreateFile for "\??\D:" returns STATUS_INVALID_PARAMETER</span>
01372     <span class="comment">//</span>
01373 
01374     <span class="keywordflow">do</span>
01375     {
01376         <span class="comment">// Find the end of the next element</span>
01377 
01378         <span class="keywordflow">do</span>
01379         {
01380             ++NextDirectory;
01381         }
01382         <span class="keywordflow">while</span> (NextDirectory &lt; EndOfString &amp;&amp; <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span> != *NextDirectory);
01383 
01384         <span class="keywordflow">if</span> ( !(NextDirectory &lt; EndOfString) )
01385             <span class="keywordflow">break</span>;
01386 
01387         <span class="comment">// Adjust SubDirectory to include it</span>
01388 
01389         SubDirectory.Length        = (NextDirectory - SubDirectory.Buffer);
01390         SubDirectory.Length       *= <span class="keyword">sizeof</span>(WCHAR);
01391         SubDirectory.MaximumLength = SubDirectory.Length;
01392 
01393         <span class="comment">// Create it</span>
01394 
01395         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a23">NtUnRestrictedCreateFile</a>(
01396                         &amp;NewDirectory,
01397                         GENERIC_READ | SYNCHRONIZE,
01398                         &amp;DirectoryAttributes,
01399                         &amp;IoStatus,
01400                         NULL,
01401                         FILE_ATTRIBUTE_NORMAL,
01402                         FILE_SHARE_READ | FILE_SHARE_WRITE,
01403                         FILE_OPEN_IF,
01404                         FILE_DIRECTORY_FILE | FILE_SYNCHRONOUS_IO_NONALERT,
01405                         NULL,
01406                         0);
01407 
01408         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01409             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(NewDirectory);
01410 
01411         NewDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01412     }
01413     <span class="keywordflow">while</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) 
01414                     || STATUS_OBJECT_TYPE_MISMATCH == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
01415                     || STATUS_INVALID_PARAMETER    == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)
01416            &amp;&amp; NextDirectory &lt; EndOfString);
01417 
01418     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01419 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="restrfil.c::FileExists" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL FileExists           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OBJECT_ATTRIBUTES *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Attributes</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01423">1423</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00629">NtQueryAttributesFile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00253">NtCreateFile()</a>.
<p>
<pre class="fragment"><div>01427                    :
01428 
01429     Determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>/directory exists
01430 
01431 Arguments:
01432 
01433     Attributes      - The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>/directory to check
01434 
01435 Return Value:
01436 
01437     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> exists 
01438 
01439 --*/
01440 {
01441     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01442     FILE_BASIC_INFORMATION  FileInfo;
01443 
01444     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/io_2misc_8c.html#a4">NtQueryAttributesFile</a>(Attributes, &amp;FileInfo);
01445 
01446     <span class="keywordflow">return</span> (STATUS_SUCCESS == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01447 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="restrfil.c::GetMangledSiteSid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HRESULT GetMangledSiteSid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>pSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>cchMangledSite</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPWSTR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ppwszMangledSite</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01915">1915</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01953">Base32Encode()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01316">RtlSubAuthorityCountSid()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l01286">RtlSubAuthoritySid()</a>.
<p>
<pre class="fragment"><div>01916 {
01917     <span class="keywordflow">if</span> (cchMangledSite &lt; MAX_MANGLED_SITE)
01918     {
01919 <span class="comment">/*        *ppwszMangledSite = (WCHAR *) LocalAlloc(</span>
01920 <span class="comment">                                            0,</span>
01921 <span class="comment">                                            MAX_MANGLED_SITE * sizeof(WCHAR));*/</span>
01922 <span class="comment">//        if (NULL == *ppwszMangledSite)</span>
01923             <span class="keywordflow">return</span> E_OUTOFMEMORY;
01924     }
01925 
01926     <span class="comment">// The value of MAX_MANGLED_SITE assumes 4 dwords</span>
01927     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(4 == *<a class="code" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a>(pSid));
01928 
01929     <a class="code" href="../../d6/d9/restrfil_8c.html#a13">Base32Encode</a>(
01930             <a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(pSid, 0),
01931             *<a class="code" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a>(pSid) * <span class="keyword">sizeof</span>(DWORD),
01932             *ppwszMangledSite);
01933 
01934     <span class="comment">// The output string should always be MAX_MANGLED_SITE - 1 chars long</span>
01935     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(MAX_MANGLED_SITE - 1 == wcslen(*ppwszMangledSite));
01936 
01937     <span class="keywordflow">return</span> S_OK;
01938 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="restrfil.c::GetSiteSidFromToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PSID GetSiteSidFromToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TokenHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01844">1844</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>.
<p>
<pre class="fragment"><div>01847 {
01848     PTOKEN_GROUPS RestrictedSids = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01849     ULONG ReturnLength;
01850     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01851     PSID psSiteSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01852 
01853 
01854     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01855         TokenHandle,
01856         TokenRestrictedSids,
01857         NULL,
01858         0,
01859         &amp;ReturnLength
01860         );
01861     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_TOO_SMALL)
01862     {
01863         <span class="comment">//BaseSetLastNTError(Status);</span>
01864         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01865     }
01866 
01867     RestrictedSids = (PTOKEN_GROUPS) <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0, ReturnLength);
01868     <span class="keywordflow">if</span> (RestrictedSids == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01869     {
01870 <span class="comment">//        SetLastError(ERROR_OUTOFMEMORY);</span>
01871         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01872     }
01873 
01874     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01875         TokenHandle,
01876         TokenRestrictedSids,
01877         RestrictedSids,
01878         ReturnLength,
01879         &amp;ReturnLength
01880         );
01881     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01882     {
01883         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
01884         SID_IDENTIFIER_AUTHORITY InternetSiteAuthority = SECURITY_INTERNETSITE_AUTHORITY;
01885 
01886         <span class="keywordflow">for</span> (i = 0; i &lt; RestrictedSids-&gt;GroupCount; i++) {
01887 
01888             <span class="keywordflow">if</span> (RtlCompareMemory((PVOID) &amp;((SID *) RestrictedSids-&gt;Groups[i].Sid)-&gt;IdentifierAuthority,
01889                 (PVOID) &amp;InternetSiteAuthority,
01890                 <span class="keyword">sizeof</span>(SID_IDENTIFIER_AUTHORITY)) == <span class="keyword">sizeof</span>(SID_IDENTIFIER_AUTHORITY))
01891             {
01892                 psSiteSid = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0, <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>((RestrictedSids-&gt;Groups[i]).Sid));
01893                 <span class="keywordflow">if</span> (psSiteSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01894 <span class="comment">//                    SetLastError(ERROR_OUTOFMEMORY);</span>
01895                 }
01896                 <span class="keywordflow">else</span> {
01897                     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>((RestrictedSids-&gt;Groups[i]).Sid), psSiteSid, (RestrictedSids-&gt;Groups[i]).Sid);
01898                 }
01899 
01900                 <span class="keywordflow">break</span>;
01901             }
01902 
01903         }
01904     }
01905     <span class="keywordflow">else</span>
01906     {
01907         <span class="comment">//BaseSetLastNTError(Status);</span>
01908     }
01909 
01910     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, RestrictedSids);
01911     <span class="keywordflow">return</span> psSiteSid;
01912 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="restrfil.c::InitializeRestrictedStuff" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS InitializeRestrictedStuff           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">879</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00038">GetMangledSiteSid</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00037">GetSiteSidFromToken</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00178">NtOpenProcessToken()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a24">NtUnRestrictedOpenFile()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01935">RtlCreateUnicodeString()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01325">RtlExpandEnvironmentStrings_U()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01453">RtlFormatCurrentUserKeyPath()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01218">RtlFreeSid()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00124">SiteDirectory</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00121">SystemPath1</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00122">SystemPath2</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00123">SystemPath3</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00129">CheckRestricted()</a>.
<p>
<pre class="fragment"><div>00882                    :
00883 
00884     Determine <span class="keywordflow">if</span> <span class="keyword">this</span> process needs to have <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> mapping turned on and <span class="keywordflow">if</span> so
00885     figure <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paths to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system drive and shadow area
00886 
00887 Arguments:
00888 
00889     None
00890 
00891 Return Value:
00892 
00893     STATUS_SUCCESS <span class="keywordflow">if</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> mapping support was initialized.
00894 
00895 --*/
00896 {
00897     OBJECT_ATTRIBUTES   Attributes;
00898     UNICODE_STRING      Path;
00899     UNICODE_STRING      ProfileDirectory;
00900     HKEY                ProfileKey;
00901     HKEY                UserProfileKey;
00902     WCHAR               <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION)+128/<span class="keyword">sizeof</span>(WCHAR)];
00903     ULONG               <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = <span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION)+128;
00904     IO_STATUS_BLOCK     IoStatus;
00905     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00906     HANDLE              SystemRoot;
00907     UNICODE_STRING     *TempString;
00908 
00909     HANDLE              hToken;
00910     PSID                SiteSid;
00911     WCHAR               MangledSiteBuffer[MAX_MANGLED_SITE];
00912     LPWSTR              MangledSite = MangledSiteBuffer;
00913 
00914     <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>         <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00915 
00916     KEY_VALUE_PARTIAL_INFORMATION  *KeyInfo;
00917 
00918     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>)
00919         <span class="keywordflow">return</span> STATUS_SUCCESS;
00920 
00921     <span class="comment">//</span>
00922     <span class="comment">// Figure out the path to \Device&lt;systemvolume&gt;.  We need to open a</span>
00923     <span class="comment">// handle to SystemRoot and then query the name of that handle.</span>
00924     <span class="comment">//</span>
00925 
00926     Path.MaximumLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00927     Path.Length        = 0;
00928     Path.Buffer        = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00929     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, L<span class="stringliteral">"\\??\\"</span>);
00930     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, USER_SHARED_DATA-&gt;NtSystemRoot);
00931 
00932     InitializeObjectAttributes(
00933             &amp;Attributes,
00934             &amp;Path,
00935             OBJ_CASE_INSENSITIVE,
00936             NULL,
00937             NULL);
00938 
00939     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a24">NtUnRestrictedOpenFile</a>(
00940                         &amp;SystemRoot, 
00941                         GENERIC_READ | SYNCHRONIZE, 
00942                         &amp;Attributes, 
00943                         &amp;IoStatus,
00944                         FILE_SHARE_READ | FILE_SHARE_WRITE,
00945                         FILE_DIRECTORY_FILE | FILE_SYNCHRONOUS_IO_NONALERT);
00946 
00947     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00948         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00949 
00950     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a5">NtQueryObject</a>(
00951                     SystemRoot, 
00952                     ObjectNameInformation,
00953                     Buffer,
00954                     <span class="keyword">sizeof</span>(Buffer),
00955                     NULL);
00956 
00957     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SystemRoot);
00958 
00959     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00960         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00961 
00962     <span class="comment">// The path is the name of the SystemRoot handle minus the length of </span>
00963     <span class="comment">// NtSystemRoot minus the drive letter</span>
00964     
00965     TempString = &amp; ((OBJECT_NAME_INFORMATION *) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;Name;
00966     TempString-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR) * 
00967                                     (wcslen(USER_SHARED_DATA-&gt;NtSystemRoot) 
00968                                                 - <span class="keyword">sizeof</span>(<span class="stringliteral">"d"</span>));
00969 
00970     TempString-&gt;Buffer[TempString-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00971          
00972     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(
00973                         &amp;SystemPath1, 
00974                         TempString-&gt;Buffer);
00975 
00976     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00977         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00978 
00979 <span class="comment">//DbgPrint("SystemPath1 = %wZ\n", &amp;SystemPath1);</span>
00980 
00981     <span class="comment">// Figure out the path to \??&lt;systemdrive&gt;</span>
00982 
00983     Path.Length        = 0;
00984     Path.Buffer        = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00985     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, L<span class="stringliteral">"\\??\\"</span>);
00986     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, USER_SHARED_DATA-&gt;NtSystemRoot);
00987     Path.Buffer[<span class="keyword">sizeof</span>(<span class="stringliteral">"\\??\\d"</span>)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00988 
00989     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;SystemPath2, Path.Buffer);
00990 
00991     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00992         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00993 
00994 <span class="comment">//DbgPrint("SystemPath2 = %wZ\n", &amp;SystemPath2);</span>
00995 
00996     <span class="comment">// Figure out the path to \DosDevices&lt;systemdrive&gt;</span>
00997 
00998     Path.Length        = 0;
00999     Path.Buffer        = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01000     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, L<span class="stringliteral">"\\DosDevices\\"</span>);
01001     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, USER_SHARED_DATA-&gt;NtSystemRoot);
01002     Path.Buffer[<span class="keyword">sizeof</span>(<span class="stringliteral">"\\DosDevices\\d"</span>)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01003 
01004     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;SystemPath3, Path.Buffer);
01005 
01006     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01007         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01008 
01009 <span class="comment">//DbgPrint("SystemPath3 = %wZ\n", &amp;SystemPath3);</span>
01010 
01011     <span class="comment">//</span>
01012     <span class="comment">// Figure out where the site directory is</span>
01013     <span class="comment">//</span>
01014     <span class="comment">// This code is temporary.  Eventually the shadow directory will be stored</span>
01015     <span class="comment">// in the job object</span>
01016     <span class="comment">//</span>
01017 
01018     <span class="comment">// First open the list of profile locations</span>
01019 
01020     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Path, L<span class="stringliteral">"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\ProfileList"</span>);
01021 
01022     InitializeObjectAttributes(
01023             &amp;Attributes,
01024             &amp;Path,
01025             OBJ_CASE_INSENSITIVE,
01026             NULL,
01027             NULL);
01028 
01029     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;ProfileKey, KEY_READ, &amp;Attributes);
01030 
01031     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01032         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01033 
01034     <span class="comment">// Next get a stringized version of the user's SID</span>
01035 
01036     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a26">RtlFormatCurrentUserKeyPath</a>(&amp;Path);
01037 
01038     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01039     {
01040         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ProfileKey);
01041         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01042     }
01043 
01044     Path.Buffer += <span class="keyword">sizeof</span>(<span class="stringliteral">"\\Registry\\User"</span>);
01045     Path.Length -= <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\User"</span>);
01046 
01047     <span class="comment">// And open the profile for the current user</span>
01048 
01049     Attributes.RootDirectory = ProfileKey;
01050 
01051     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;UserProfileKey, KEY_READ, &amp;Attributes);
01052 
01053     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ProfileKey);
01054     Path.Buffer -= <span class="keyword">sizeof</span>(<span class="stringliteral">"\\Registry\\User"</span>);
01055     Path.Length += <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\User"</span>);
01056     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;Path);
01057 
01058     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01059         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01060 
01061     <span class="comment">// Allocate a buffer and get the info</span>
01062 
01063     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Path, L<span class="stringliteral">"ProfileImagePath"</span>);
01064 
01065     <span class="keywordflow">do</span>
01066     {
01067         ULONG ResultLength;
01068 
01069         KeyInfo = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0, BufferSize);
01070 
01071         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == KeyInfo)
01072         {
01073             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(UserProfileKey);
01074             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01075             <span class="keywordflow">break</span>;
01076         }
01077 
01078         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
01079                         UserProfileKey,
01080                         &amp;Path,
01081                         KeyValuePartialInformation,
01082                         KeyInfo,
01083                         BufferSize,
01084                         &amp;ResultLength);
01085 
01086         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01087         {
01088             <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> *= 2;
01089             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, KeyInfo);
01090         }
01091     }
01092     <span class="keywordflow">while</span> (   STATUS_BUFFER_OVERFLOW == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> 
01093            || STATUS_BUFFER_TOO_SMALL == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01094 
01095     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(UserProfileKey);
01096 
01097     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01098         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01099 
01100     <span class="comment">// Create the path to the site directory</span>
01101 
01102     Path.Length         = 0;
01103     Path.MaximumLength  = <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
01104     Path.Buffer         = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01105 
01106     ProfileDirectory.Length        = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) KeyInfo-&gt;DataLength;
01107     ProfileDirectory.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) KeyInfo-&gt;DataLength;
01108     ProfileDirectory.Buffer        = (WCHAR *) KeyInfo-&gt;Data;
01109 
01110     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a24">RtlExpandEnvironmentStrings_U</a>(NULL, &amp;ProfileDirectory, &amp;Path, NULL);
01111 
01112     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01113         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01114 
01115     <span class="comment">// RtlExpandEnvironmentStrings_U includes the null terminator in the length</span>
01116 
01117     Path.Length        -= <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>);
01118 
01119     <span class="comment">// Remove the drive letter from the path</span>
01120 
01121     Path.Length        -= 2 * <span class="keyword">sizeof</span>(WCHAR);
01122     MoveMemory(Path.Buffer, Path.Buffer + 2, Path.Length);
01123 
01124     <span class="comment">// </span>
01125     <span class="comment">// Figure out the site directory name</span>
01126     <span class="comment">//</span>
01127 
01128     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(NtCurrentProcess(), TOKEN_READ, &amp;hToken);
01129 
01130     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01131         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01132 
01133     SiteSid = <a class="code" href="../../d6/d9/restrfil_8c.html#a0">GetSiteSidFromToken</a>(hToken);
01134 
01135     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hToken);
01136 
01137     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == SiteSid)
01138         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01139 
01140     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a1">GetMangledSiteSid</a>(SiteSid, MAX_MANGLED_SITE, &amp;MangledSite);
01141 
01142     <a class="code" href="../../d8/d6/sertl_8c.html#a41">RtlFreeSid</a>(SiteSid);
01143 
01144     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01145         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01146 
01147     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, L<span class="stringliteral">"\\"</span>);
01148     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, MangledSite);
01149 
01150     Path.Buffer[Path.Length / <span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01151 
01152     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;SiteDirectory, Path.Buffer);
01153 
01154 <span class="comment">//DbgPrint("Site Directory = %wZ\n", &amp;SiteDirectory);</span>
01155 
01156     <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a> = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status);
01157 
01158     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01159 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="restrfil.c::IsInterestingPath" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL IsInterestingPath           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>RestrictedFile</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01163">1163</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01763">RtlCopyUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01690">RtlPrefixUnicodeString()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00124">SiteDirectory</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00121">SystemPath1</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00122">SystemPath2</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00123">SystemPath3</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00253">NtCreateFile()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00602">NtDeleteFile()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00449">NtOpenFile()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00663">NtQueryAttributesFile()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00740">NtSetInformationFile()</a>.
<p>
<pre class="fragment"><div>01168                    :
01169 
01170     Determine <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> pointed to by NormalFile can be mapped and <span class="keywordflow">if</span> so
01171     point RestrictedFile at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapped version
01172 
01173 Arguments:
01174 
01175     NormalFile - The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to be tested
01176     RestrictedFile - The resultant restricted <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
01177 
01178 Return Value:
01179 
01180     STATUS_SUCCESS <span class="keywordflow">if</span> RestrictedFile was setup
01181 
01182 --*/
01183 {
01184     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>                    <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[1024];
01185     OBJECT_NAME_INFORMATION *NameInfo = (OBJECT_NAME_INFORMATION *) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01186     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01187     BOOLEAN                 CaseInSensitive;
01188     UNICODE_STRING         *SystemPath = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01189     UNICODE_STRING         *RestrictedName;
01190     
01191     <span class="comment">//</span>
01192     <span class="comment">// Expand out the root directory of a relative path, if applicable</span>
01193     <span class="comment">//</span>
01194 
01195     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != NormalFile-&gt;RootDirectory)
01196     {
01197         WCHAR  LastChar;
01198 
01199         <span class="comment">// Get the name corresponding to the root handle</span>
01200 
01201         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a5">NtQueryObject</a>(
01202                         NormalFile-&gt;RootDirectory,
01203                         ObjectNameInformation,
01204                         NameInfo,
01205                         <span class="keyword">sizeof</span>(Buffer),
01206                         NULL);
01207 
01208         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01209             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01210 
01211         <span class="comment">// Make sure there's a backslash on the end</span>
01212 
01213         LastChar = NameInfo-&gt;Name.Buffer[
01214                                 (NameInfo-&gt;Name.Length-1)*<span class="keyword">sizeof</span>(WCHAR)];
01215 
01216         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span> != LastChar)
01217         {
01218             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;NameInfo-&gt;Name, L<span class="stringliteral">"\\"</span>);
01219 
01220             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01221                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01222         }
01223     }
01224     <span class="keywordflow">else</span>
01225     {
01226         NameInfo-&gt;Name.Length = 0;
01227         NameInfo-&gt;Name.Buffer = (WCHAR *) (((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *) NameInfo) 
01228                                                         + <span class="keyword">sizeof</span>(*NameInfo));
01229     }
01230 
01231     <span class="comment">//</span>
01232     <span class="comment">// Concatenate the file/directory to it's root to get a full path</span>
01233     <span class="comment">//</span>
01234 
01235     NameInfo-&gt;Name.MaximumLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) 
01236                                         - <span class="keyword">sizeof</span>(*NameInfo) 
01237                                         - NameInfo-&gt;Name.Length;
01238 
01239     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(
01240                             &amp;NameInfo-&gt;Name, 
01241                             NormalFile-&gt;ObjectName);
01242 
01243     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01244         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01245     
01246     <span class="comment">//</span>
01247     <span class="comment">// Check to see if the path should be mapped</span>
01248     <span class="comment">//</span>
01249 
01250     CaseInSensitive = (BOOLEAN) 
01251                         ((OBJ_CASE_INSENSITIVE &amp; NormalFile-&gt;Attributes) != 0);
01252 
01253     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a43">RtlPrefixUnicodeString</a>(&amp;SystemPath1, &amp;NameInfo-&gt;Name, CaseInSensitive))
01254         SystemPath = &amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a6">SystemPath1</a>;
01255     <span class="keywordflow">else</span>
01256     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a43">RtlPrefixUnicodeString</a>(&amp;SystemPath2, &amp;NameInfo-&gt;Name, CaseInSensitive))
01257         SystemPath = &amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a7">SystemPath2</a>;
01258     <span class="keywordflow">else</span>
01259     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a43">RtlPrefixUnicodeString</a>(&amp;SystemPath3, &amp;NameInfo-&gt;Name, CaseInSensitive))
01260         SystemPath = &amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a8">SystemPath3</a>;
01261 
01262     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == SystemPath)
01263         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01264 
01265     <span class="comment">//</span>
01266     <span class="comment">// This path is on the system drive, reject it if it's pointing at the</span>
01267     <span class="comment">// mapped area already</span>
01268     <span class="comment">//</span>
01269 
01270     NameInfo-&gt;Name.Length -= SystemPath-&gt;Length;
01271     NameInfo-&gt;Name.Buffer += SystemPath-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
01272 
01273     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a43">RtlPrefixUnicodeString</a>(&amp;SiteDirectory,&amp;NameInfo-&gt;Name,CaseInSensitive))
01274         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01275 
01276     NameInfo-&gt;Name.Length += SystemPath-&gt;Length;
01277     NameInfo-&gt;Name.Buffer -= SystemPath-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
01278 
01279     <span class="comment">//</span>
01280     <span class="comment">// This path should be mapped</span>
01281     <span class="comment">//</span>
01282 
01283     RestrictedName = RestrictedFile-&gt;ObjectName;
01284     RestrictedName-&gt;MaximumLength = <a class="code" href="../../d6/d9/restrfil_8c.html#a6">SystemPath1</a>.Length
01285                                     + <a class="code" href="../../d6/d9/restrfil_8c.html#a9">SiteDirectory</a>.Length
01286                                     + NameInfo-&gt;Name.Length;
01287     RestrictedName-&gt;Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
01288                                     RtlProcessHeap(), 
01289                                     0, 
01290                                     RestrictedName-&gt;MaximumLength);
01291 
01292     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == RestrictedName-&gt;Buffer)
01293         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01294 
01295     NameInfo-&gt;Name.Buffer[NameInfo-&gt;Name.Length] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01296 
01297     RestrictedFile-&gt;RootDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01298     RestrictedName-&gt;Length = 0;
01299 
01300     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(RestrictedName, &amp;SystemPath1);
01301     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(RestrictedName, &amp;SiteDirectory);
01302     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(
01303                 RestrictedName, 
01304                 NameInfo-&gt;Name.Buffer + SystemPath-&gt;Length / <span class="keyword">sizeof</span>(WCHAR));
01305 
01306     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01307 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="restrfil.c::IsInterestingPath" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL IsInterestingPath           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OBJECT_ATTRIBUTES *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OBJECT_ATTRIBUTES *&nbsp;</td>
          <td class="mdname" nowrap> <em>RestrictedFile</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="restrfil.c::IsRestricted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> __inline BOOL IsRestricted           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00223">223</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00129">CheckRestricted()</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a41a11">eRestricted</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a41a12">eUnknownRestricted</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a41a10">eUnRestricted</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00253">NtCreateFile()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00602">NtDeleteFile()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00449">NtOpenFile()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00663">NtQueryAttributesFile()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00740">NtSetInformationFile()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>, and <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00068">xxxProcessNotifyWinEvent()</a>.
<p>
<pre class="fragment"><div>00226                    :
00227 
00228     Determine <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a restricted process and thus should have filesystem
00229     redirection active.
00230 
00231 Arguments:
00232 
00233     None
00234 
00235 Return Value:
00236 
00237     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a restricted process, otherwise <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00238 
00239 --*/
00240 {
00241     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a41a10">eUnRestricted</a> == <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>)
00242         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00243     
00244     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a41a12">eUnknownRestricted</a> == <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>)
00245         <a class="code" href="../../d6/d9/restrfil_8c.html#a28">CheckRestricted</a>();
00246 
00247     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a41a11">eRestricted</a> == <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>);
00248 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="restrfil.c::IsTokenRestricted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL IsTokenRestricted           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TokenHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l02001">2001</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>02004 {
02005     PTOKEN_GROUPS RestrictedSids = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02006     ULONG ReturnLength;
02007     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02008     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02009 
02010 
02011     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02012                 TokenHandle,
02013                 TokenRestrictedSids,
02014                 NULL,
02015                 0,
02016                 &amp;ReturnLength
02017                 );
02018     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_TOO_SMALL)
02019     {
02020 <span class="comment">//        BaseSetLastNTError(Status);</span>
02021         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02022     }
02023 
02024     RestrictedSids = (PTOKEN_GROUPS) <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0, ReturnLength);
02025     <span class="keywordflow">if</span> (RestrictedSids == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02026     {
02027 <span class="comment">//        SetLastError(ERROR_OUTOFMEMORY);</span>
02028         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02029     }
02030 
02031     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02032                 TokenHandle,
02033                 TokenRestrictedSids,
02034                 RestrictedSids,
02035                 ReturnLength,
02036                 &amp;ReturnLength
02037                 );
02038     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
02039     {
02040         <span class="keywordflow">if</span> (RestrictedSids-&gt;GroupCount != 0)
02041         {
02042             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02043         }
02044     }
02045     <span class="keywordflow">else</span>
02046     {
02047 <span class="comment">//        BaseSetLastNTError(Status);</span>
02048     }
02049     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, RestrictedSids);
02050     <span class="keywordflow">return</span>(Result);
02051 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="restrfil.c::NtCreateFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtCreateFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER AllocationSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ShareAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateDisposition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateOptions</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID EaBuffer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>EaLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00253">253</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01596">CopyRestrictedFile()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01311">CreateDirectories()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01423">FileExists()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01163">IsInterestingPath()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00223">IsRestricted()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00268                    :
00269 
00270     Entry point <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restricted version of <a class="code" href="../../d6/d9/restrfil_8c.html#a30">NtCreateFile</a>
00271 
00272 Arguments:
00273 
00274     FileHandle - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00275 
00276     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> types of access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller would like to
00277         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00278 
00279     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes to be used <span class="keywordflow">for</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object (name,
00280         SECURITY_DESCRIPTOR, etc.)
00281 
00282     IoStatusBlock - Specifies the address of the caller's I/O status block.
00283 
00284     AllocationSize - Initial size that should be allocated to the <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  This
00285         parameter only has an affect <span class="keywordflow">if</span> the file is created.  Further, <span class="keywordflow">if</span>
00286         not specified, then it is taken to mean zero.
00287 
00288     FileAttributes - Specifies the attributes that should be set on the file,
00289         <span class="keywordflow">if</span> it is created.
00290 
00291     ShareAccess - Supplies the types of share access that the caller would like
00292         to the <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00293 
00294     CreateDisposition - Supplies the method <span class="keywordflow">for</span> handling the create/open.
00295 
00296     CreateOptions - Caller options <span class="keywordflow">for</span> how to perform the create/open.
00297 
00298     EaBuffer - Optionally specifies a set of EAs to be applied to the file <span class="keywordflow">if</span>
00299         it is created.
00300 
00301     EaLength - Supplies the length of the EaBuffer.
00302 
00303 Return Value:
00304 
00305     The function value is the <span class="keyword">final</span> status of the create/open operation.
00306 
00307 --*/
00308 {
00309 #define <a class="code" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(object)                 \
00310             <a class="code" href="../../d6/d9/restrfil_8c.html#a23">NtUnRestrictedCreateFile</a>(       \
00311                     FileHandle,             \
00312                     DesiredAccess,          \
00313                     object,                 \
00314                     IoStatusBlock,          \
00315                     AllocationSize,         \
00316                     FileAttributes,         \
00317                     ShareAccess,            \
00318                     CreateDisposition,      \
00319                     CreateOptions,          \
00320                     EaBuffer,               \
00321                     EaLength)                       
00322     <span class="comment">/*\</span>
00323 <span class="comment">        ((st =                                       \</span>
00324 <span class="comment">       ) ? st                                        \</span>
00325 <span class="comment">    :  ((Restricted == eRestricted) ? DbgPrint("%s %wZ\n", (object==NormalFile)?"UnMapped":"  Mapped",object-&gt;ObjectName) : 0), st)</span>
00326 <span class="comment">*/</span>
00327                     
00328     NTSTATUS            Status;
00329     OBJECT_ATTRIBUTES  *OriginalAttributes;
00330     OBJECT_ATTRIBUTES  *NormalFile;
00331     OBJECT_ATTRIBUTES   RestrictedFileAttributes;
00332     OBJECT_ATTRIBUTES  *RestrictedFile = &amp;RestrictedFileAttributes;
00333     UNICODE_STRING      RestrictedObjectName;
00334 
00335     FILE_BASIC_INFORMATION  BasicInfo;
00336 
00337 <span class="comment">//NTSTATUS st;</span>
00338 
00339     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d9/restrfil_8c.html#a29">IsRestricted</a>())
00340         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(ObjectAttributes);
00341 
00342     <span class="comment">//</span>
00343     <span class="comment">// Check to see if this file is mappable.  If not don't try</span>
00344     <span class="comment">//</span>
00345 
00346     NormalFile = ObjectAttributes;
00347 
00348     CopyMemory(RestrictedFile, NormalFile, <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES));
00349     RestrictedFile-&gt;ObjectName = &amp;RestrictedObjectName;
00350 
00351     if (!<a class="code" href="../../d6/d9/restrfil_8c.html#a40">IsInterestingPath</a>(NormalFile, RestrictedFile))
00352         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(NormalFile);
00353 
00354     <span class="comment">//</span>
00355     <span class="comment">// The file/directory is mappable</span>
00356     <span class="comment">//</span>
00357 
00358     <span class="comment">//</span>
00359     <span class="comment">// If this is a directory, try to access the normal one first, then the </span>
00360     <span class="comment">// shadowed one</span>
00361     <span class="comment">//</span>
00362     <span class="keywordflow">if</span> (CreateOptions &amp; FILE_DIRECTORY_FILE)
00363     {
00364         Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(NormalFile);
00365 
00366         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00367         {
00368             Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(RestrictedFile);
00369         }
00370     }
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">// If this is a file which which already has a shadowed version, try the</span>
00374     <span class="comment">// operation only on that version</span>
00375     <span class="comment">//</span>
00376     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a20">FileExists</a>(RestrictedFile))
00377     {
00378         Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(RestrictedFile);
00379     }
00380 
00381     <span class="comment">//</span>
00382     <span class="comment">// This is a file operation and no shadowed version of the file exists,</span>
00383     <span class="comment">// try the operation in the unshadowed area</span>
00384     <span class="comment">//</span>
00385     <span class="keywordflow">else</span>
00386     {
00387         Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(NormalFile);
00388 
00389         <span class="keywordflow">if</span> (STATUS_ACCESS_DENIED == Status)
00390         {
00391             Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a19">CreateDirectories</a>(RestrictedFile);
00392             
00393             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00394             {
00395                 Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a18">CopyRestrictedFile</a>(NormalFile, RestrictedFile);
00396 
00397                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) 
00398                     || STATUS_OBJECT_NAME_NOT_FOUND == Status)
00399                 {
00400                     Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(RestrictedFile);
00401                 }
00402             }
00403         }
00404     }
00405 
00406 
00407 <span class="comment">/*</span>
00408 <span class="comment">if (!NT_SUCCESS(Status))</span>
00409 <span class="comment">  DbgPrint("  Failed %wZ\n", NormalFile-&gt;ObjectName);</span>
00410 <span class="comment">*/</span>
00411     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, RestrictedObjectName.Buffer);
00412 
00413     <span class="keywordflow">return</span> Status;
00414     
00415 #undef CALL_CREATE
00416 }
<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="restrfil.c::NtDeleteFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtDeleteFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ObjectAttributes</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00602">602</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01163">IsInterestingPath()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00223">IsRestricted()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a25">NtUnRestrictedDeleteFile()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00605                    :
00606 
00607     Attempt to <span class="keyword">delete</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> shadowed version of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  If that fails
00608     attempt to <span class="keyword">delete</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real version of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00609 
00610 Arguments:
00611 
00612     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes to be used <span class="keywordflow">for</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object (name,
00613         SECURITY_DESCRIPTOR, etc.)
00614 
00615 Return Value:
00616 
00617     The status returned is the <span class="keyword">final</span> completion status of the operation.
00618 
00619 --*/
00620 {
00621     NTSTATUS            Status;
00622     OBJECT_ATTRIBUTES  *NormalFile;
00623     OBJECT_ATTRIBUTES   RestrictedFileAttributes;
00624     OBJECT_ATTRIBUTES  *RestrictedFile = &amp;RestrictedFileAttributes;
00625     UNICODE_STRING      RestrictedObjectName;
00626 
00627     if (!<a class="code" href="../../d6/d9/restrfil_8c.html#a29">IsRestricted</a>())
00628         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a25">NtUnRestrictedDeleteFile</a>(ObjectAttributes);
00629 
00630     <span class="comment">//</span>
00631     <span class="comment">// Check to see if this file is mappable.  Map it if it is</span>
00632     <span class="comment">//</span>
00633 
00634     NormalFile = ObjectAttributes;
00635 
00636     CopyMemory(RestrictedFile, NormalFile, <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES));
00637     RestrictedFile-&gt;ObjectName = &amp;RestrictedObjectName;
00638 
00639     if (<a class="code" href="../../d6/d9/restrfil_8c.html#a40">IsInterestingPath</a>(NormalFile, RestrictedFile))
00640     {
00641         Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a25">NtUnRestrictedDeleteFile</a>(RestrictedFile);
00642         
00643         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, RestrictedObjectName.Buffer);
00644             
00645         if (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) || STATUS_ACCESS_DENIED == Status)
00646             <span class="keywordflow">return</span> Status;
00647     }
00648 
00649     <span class="comment">//</span>
00650     <span class="comment">// The file is not mappable or deleting the mapped version failed.</span>
00651     <span class="comment">//</span>
00652 
00653     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a25">NtUnRestrictedDeleteFile</a>(NormalFile);
00654 }
NTSTATUS <a class="code" href="../../d6/d9/restrfil_8c.html#a35">ZwDeleteFile</a>(IN POBJECT_ATTRIBUTES ObjectAttributes)
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="restrfil.c::NtOpenFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtOpenFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ShareAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenOptions</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00449">449</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01596">CopyRestrictedFile()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01163">IsInterestingPath()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00223">IsRestricted()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00459                    :
00460 
00461     Entry point <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restricted version of <a class="code" href="../../d6/d9/restrfil_8c.html#a32">NtOpenFile</a>
00462 
00463 Arguments:
00464 
00465     FileHandle - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00466 
00467     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> types of access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller would like to
00468         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00469 
00470     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes to be used <span class="keywordflow">for</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object (name,
00471         SECURITY_DESCRIPTOR, etc.)
00472 
00473     IoStatusBlock - Specifies the address of the caller's I/O status block.
00474 
00475     ShareAccess - Supplies the types of share access that the caller would like
00476         to the <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00477 
00478     OpenOptions - Caller options <span class="keywordflow">for</span> how to perform the open.
00479 
00480 Return Value:
00481 
00482     The function value is the <span class="keyword">final</span> completion status of the open/create
00483     operation.
00484 
00485 --*/
00486 {
00487 #define <a class="code" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(object)                 \
00488             <a class="code" href="../../d6/d9/restrfil_8c.html#a24">NtUnRestrictedOpenFile</a>(       \
00489                     FileHandle,             \
00490                     DesiredAccess,          \
00491                     object,                 \
00492                     IoStatusBlock,          \
00493                     ShareAccess,            \
00494                     OpenOptions)                   
00495     <span class="comment">/*\</span>
00496 <span class="comment">        ((st =                                       \</span>
00497 <span class="comment">       ) ? st                                        \</span>
00498 <span class="comment">    :  ((Restricted == eRestricted) ? DbgPrint("%s %wZ\n", (object==NormalFile)?"UnMapped":"  Mapped",object-&gt;ObjectName) : 0), st)</span>
00499 <span class="comment">*/</span>
00500                     
00501     NTSTATUS            Status;
00502     OBJECT_ATTRIBUTES  *OriginalAttributes;
00503     OBJECT_ATTRIBUTES  *NormalFile;
00504     OBJECT_ATTRIBUTES   RestrictedFileAttributes;
00505     OBJECT_ATTRIBUTES  *RestrictedFile = &amp;RestrictedFileAttributes;
00506     UNICODE_STRING      RestrictedObjectName;
00507 
00508     FILE_BASIC_INFORMATION  BasicInfo;
00509 
00510 <span class="comment">//NTSTATUS st;</span>
00511 
00512     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d9/restrfil_8c.html#a29">IsRestricted</a>())
00513         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(ObjectAttributes);
00514 
00515     <span class="comment">//</span>
00516     <span class="comment">// Check to see if this file is mappable.  If not don't try</span>
00517     <span class="comment">//</span>
00518 
00519     NormalFile = ObjectAttributes;
00520 
00521     CopyMemory(RestrictedFile, NormalFile, <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES));
00522     RestrictedFile-&gt;ObjectName = &amp;RestrictedObjectName;
00523 
00524     if (!<a class="code" href="../../d6/d9/restrfil_8c.html#a40">IsInterestingPath</a>(NormalFile, RestrictedFile))
00525         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(NormalFile);
00526 
00527     <span class="comment">//</span>
00528     <span class="comment">// The file/directory is mappable</span>
00529     <span class="comment">//</span>
00530 
00531     <span class="keywordflow">if</span> (OpenOptions &amp; FILE_DIRECTORY_FILE)
00532     {
00533         <span class="comment">//</span>
00534         <span class="comment">// This is a directory, attempt to access the given one, if that fails</span>
00535         <span class="comment">// try to access the shadowed version</span>
00536         <span class="comment">//</span>
00537 
00538         Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(NormalFile);
00539 
00540         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00541         {
00542             Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(RestrictedFile);
00543         }
00544     }
00545     <span class="keywordflow">else</span>
00546     {
00547         <span class="comment">//</span>
00548         <span class="comment">// This is a file (not a directory).  Attempt to open the shadowed</span>
00549         <span class="comment">// version.  If that fails, attempt to open the real version.  If that</span>
00550         <span class="comment">// fails with access denied, then try to copy the file to the shadow</span>
00551         <span class="comment">// area and try to open it there again.</span>
00552         <span class="comment">//</span>
00553 
00554         Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(RestrictedFile);
00555 
00556         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00557         {           
00558             Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(NormalFile);
00559 
00560             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00561             {
00562                 Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a18">CopyRestrictedFile</a>(NormalFile, RestrictedFile);
00563 
00564                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00565                 {
00566                     Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(RestrictedFile);
00567                 }
00568             }
00569         }
00570     }
00571 <span class="comment">/*</span>
00572 <span class="comment">if (!NT_SUCCESS(Status))</span>
00573 <span class="comment">  DbgPrint("  Failed %wZ\n", NormalFile-&gt;ObjectName);</span>
00574 <span class="comment">*/</span>
00575     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, RestrictedObjectName.Buffer);
00576 
00577     <span class="keywordflow">return</span> Status;
00578     
00579 #undef CALL_OPEN
00580 }
<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="restrfil.c::NtQueryAttributesFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryAttributesFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PFILE_BASIC_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00663">663</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01163">IsInterestingPath()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00223">IsRestricted()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a26">NtUnRestrictedQueryAttributesFile()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00669                    :
00670 
00671     Attempt to query <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> shadowed version of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  If that fails
00672     attempt to query <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real version of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00673 
00674 Arguments:
00675 
00676     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes to be used <span class="keywordflow">for</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object (name,
00677         SECURITY_DESCRIPTOR, etc.)
00678 
00679     FileInformation - Supplies an output buffer to receive the returned file
00680         attributes information.
00681 
00682 Return Value:
00683 
00684     The status returned is the <span class="keyword">final</span> completion status of the operation.
00685 
00686 --*/
00687 {
00688     NTSTATUS            Status;
00689     OBJECT_ATTRIBUTES  *NormalFile;
00690     OBJECT_ATTRIBUTES   RestrictedFileAttributes;
00691     OBJECT_ATTRIBUTES  *RestrictedFile = &amp;RestrictedFileAttributes;
00692     UNICODE_STRING      RestrictedObjectName;
00693 
00694     if (!<a class="code" href="../../d6/d9/restrfil_8c.html#a29">IsRestricted</a>())
00695         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a26">NtUnRestrictedQueryAttributesFile</a>(
00696                         ObjectAttributes, 
00697                         FileInformation);
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">// Check to see if this file is mappable.  Map it if it is</span>
00701     <span class="comment">//</span>
00702 
00703     NormalFile = ObjectAttributes;
00704 
00705     CopyMemory(RestrictedFile, NormalFile, <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES));
00706     RestrictedFile-&gt;ObjectName = &amp;RestrictedObjectName;
00707 
00708     if (<a class="code" href="../../d6/d9/restrfil_8c.html#a40">IsInterestingPath</a>(NormalFile, RestrictedFile))
00709     {
00710         Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a26">NtUnRestrictedQueryAttributesFile</a>(
00711                         RestrictedFile, 
00712                         FileInformation);
00713 
00714         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, RestrictedObjectName.Buffer);
00715             
00716         if (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) || STATUS_ACCESS_DENIED == Status)
00717             <span class="keywordflow">return</span> Status;
00718     }
00719 
00720     <span class="comment">//</span>
00721     <span class="comment">// The file is not mappable or accessing the mapped version failed.</span>
00722     <span class="comment">//</span>
00723 
00724     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a26">NtUnRestrictedQueryAttributesFile</a>(
00725                     NormalFile, 
00726                     FileInformation);
00727 }
NTSTATUS
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="restrfil.c::NtSetInformationFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetInformationFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN FILE_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformationClass</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00740">740</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01163">IsInterestingPath()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00223">IsRestricted()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d9/restrfil_8c.html#a27">NtUnRestrictedSetInformationFile()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01582">SepClientOpenPipe()</a>.
<p>
<pre class="fragment"><div>00749                    :
00750 
00751     Hook <a class="code" href="../../d6/d9/restrfil_8c.html#a38">NtSetInformationFile</a> to <span class="keywordflow">catch</span> renames/moves of files by restricted 
00752     processes.
00753 
00754 Arguments:
00755 
00756     FileHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> whose information should be
00757         changed.
00758 
00759     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
00760 
00761     FileInformation - Supplies a buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information which should
00762         be changed on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00763 
00764     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileInformation buffer.
00765 
00766     FileInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information which should be
00767         changed about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00768 
00769 Return Value:
00770 
00771     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00772 
00773 --*/
00774 {
00775     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00776     OBJECT_ATTRIBUTES   NormalFileAttributes;
00777     OBJECT_ATTRIBUTES  *NormalFile = &amp;NormalFileAttributes;
00778     UNICODE_STRING      NormalFileName;
00779     OBJECT_ATTRIBUTES   RestrictedFileAttributes;
00780     OBJECT_ATTRIBUTES  *RestrictedFile = &amp;RestrictedFileAttributes;
00781     UNICODE_STRING      RestrictedObjectName;
00782 
00783     FILE_RENAME_INFORMATION *RenameInfo;
00784 
00785     <span class="comment">//</span>
00786     <span class="comment">// Try the original operation first</span>
00787     <span class="comment">//</span>
00788 
00789     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a27">NtUnRestrictedSetInformationFile</a>(
00790                         FileHandle, 
00791                         IoStatusBlock, 
00792                         FileInformation, 
00793                         Length, 
00794                         FileInformationClass);
00795 
00796     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) 
00797         || !<a class="code" href="../../d6/d9/restrfil_8c.html#a29">IsRestricted</a>() 
00798         || FileRenameInformation != FileInformationClass)
00799     {
00800         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00801     }
00802 
00803     <span class="comment">//</span>
00804     <span class="comment">// Check to see if this file is mappable.  Map it if it is</span>
00805     <span class="comment">//</span>
00806 
00807     RenameInfo = (FILE_RENAME_INFORMATION *) FileInformation;
00808 
00809     NormalFileName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) RenameInfo-&gt;FileNameLength;
00810     NormalFileName.Length        = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) RenameInfo-&gt;FileNameLength;
00811     NormalFileName.Buffer        = RenameInfo-&gt;FileName;
00812 
00813     InitializeObjectAttributes(
00814             NormalFile,
00815             &amp;NormalFileName,
00816             OBJ_CASE_INSENSITIVE,
00817             RenameInfo-&gt;RootDirectory,
00818             NULL);
00819 
00820     CopyMemory(RestrictedFile, NormalFile, <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES));
00821     RestrictedFile-&gt;ObjectName = &amp;RestrictedObjectName;
00822 
00823     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a40">IsInterestingPath</a>(NormalFile, RestrictedFile))
00824     {
00825         FILE_RENAME_INFORMATION *NewRenameInfo;
00826         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                 Status2;
00827 
00828         NewRenameInfo = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
00829                             RtlProcessHeap(), 
00830                             0, 
00831                             <span class="keyword">sizeof</span>(*RenameInfo) + RestrictedObjectName.Length);
00832 
00833         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != RenameInfo)
00834         {
00835             NewRenameInfo-&gt;ReplaceIfExists = RenameInfo-&gt;ReplaceIfExists;
00836             NewRenameInfo-&gt;RootDirectory   = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00837             NewRenameInfo-&gt;FileNameLength  = RestrictedObjectName.Length;
00838             CopyMemory(
00839                     NewRenameInfo-&gt;FileName, 
00840                     RestrictedObjectName.Buffer, 
00841                     RestrictedObjectName.Length);
00842 
00843             Status2 = <a class="code" href="../../d6/d9/restrfil_8c.html#a27">NtUnRestrictedSetInformationFile</a>(
00844                                 FileHandle, 
00845                                 IoStatusBlock, 
00846                                 NewRenameInfo, 
00847                                 <span class="keyword">sizeof</span>(*RenameInfo) + RestrictedObjectName.Length, 
00848                                 FileInformationClass);
00849 
00850             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status2) ? Status2 : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00851 
00852             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, NewRenameInfo);
00853         }
00854 
00855         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, RestrictedObjectName.Buffer);
00856     }
00857 
00858     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00859 }
<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="restrfil.c::NtUnRestrictedCreateFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtUnRestrictedCreateFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER AllocationSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ShareAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateDisposition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateOptions</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID EaBuffer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>EaLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01596">CopyRestrictedFile()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01451">CopyStream()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01311">CreateDirectories()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="restrfil.c::NtUnRestrictedDeleteFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtUnRestrictedDeleteFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ObjectAttributes</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01596">CopyRestrictedFile()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00602">NtDeleteFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="restrfil.c::NtUnRestrictedOpenFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtUnRestrictedOpenFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ShareAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenOptions</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01596">CopyRestrictedFile()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01451">CopyStream()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">InitializeRestrictedStuff()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="restrfil.c::NtUnRestrictedQueryAttributesFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtUnRestrictedQueryAttributesFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PFILE_BASIC_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01596">CopyRestrictedFile()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00663">NtQueryAttributesFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="restrfil.c::NtUnRestrictedSetInformationFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtUnRestrictedSetInformationFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN FILE_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformationClass</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00740">NtSetInformationFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="restrfil.c::ZwCreateFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ZwCreateFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER AllocationSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ShareAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateDisposition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateOptions</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID EaBuffer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>EaLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00418">418</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d3/d1/rtload_8c-source.html#l00050">FileAttributes</a>, <a class="el" href="../../d2/d7/io_2create_8c-source.html#l00037">NtCreateFile()</a>, and <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00721">CmpOpenFileWithExtremePrejudice()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00046">CmpOpenHiveFiles()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00282">FsRecCreateAndRegisterDO()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00183">FsRtlpOpenDev()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l01200">IoepGetErrCaseDB()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09284">IopBootLogToFile()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00807">OpenDevice()</a>, and <a class="el" href="../../d1/d0/base_8c-source.html#l00102">UserBeep()</a>.
<p>
<pre class="fragment"><div>00431 {
00432     <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
00433                     FileHandle,
00434                     DesiredAccess,
00435                     ObjectAttributes,
00436                     IoStatusBlock,
00437                     AllocationSize,
00438                     FileAttributes,
00439                     ShareAccess,
00440                     CreateDisposition,
00441                     CreateOptions,
00442                     EaBuffer,
00443                     EaLength);
00444 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="restrfil.c::ZwDeleteFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ZwDeleteFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ObjectAttributes</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00655">655</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00298">NtDeleteFile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>.
<p>
<pre class="fragment"><div>00656 {
00657     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/io_2misc_8c.html#a2">NtDeleteFile</a>(ObjectAttributes);
00658 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="restrfil.c::ZwOpenFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ZwOpenFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ShareAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenOptions</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00582">582</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d5/d1/open_8c-source.html#l00034">NtOpenFile()</a>, and <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00721">CmpOpenFileWithExtremePrejudice()</a>, <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00211">DbgkCreateThread()</a>, <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00136">DbgkpSectionHandleToFileHandle()</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00326">GetNextReparseVolumePath()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01067">IoAttachDevice()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06998">IoGetDeviceObjectPointer()</a>, <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00168">IopApplySystemPartitionProt()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03479">IopMarkBootPartition()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00225">OpenDeviceReparseIndex()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00525">PsLocateSystemDll()</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00149">QueryDeviceNameForPath()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00493">RtlpOpenImageFile()</a>, and <a class="el" href="../../d8/d1/drivesup_8c-source.html#l01243">xHalIoAssignDriveLetters()</a>.
<p>
<pre class="fragment"><div>00590 {
00591     <span class="keywordflow">return</span> <a class="code" href="../../d4/d2/open_8c.html#a0">NtOpenFile</a>(
00592                 FileHandle,
00593                 DesiredAccess,
00594                 ObjectAttributes,
00595                 IoStatusBlock,
00596                 ShareAccess,
00597                 OpenOptions);
00598 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="restrfil.c::ZwQueryAttributesFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ZwQueryAttributesFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PFILE_BASIC_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00729">729</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00629">NtQueryAttributesFile()</a>, and <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00721">CmpOpenFileWithExtremePrejudice()</a>.
<p>
<pre class="fragment"><div>00733 {
00734     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/io_2misc_8c.html#a4">NtQueryAttributesFile</a>(ObjectAttributes, FileInformation);
00735 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="restrfil.c::ZwSetInformationFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ZwSetInformationFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN FILE_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformationClass</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00861">861</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
References <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00227">CmpDoFileSetSize()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00721">CmpOpenFileWithExtremePrejudice()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, and <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>.
<p>
<pre class="fragment"><div>00868 {
00869     <span class="keywordflow">return</span> <a class="code" href="../../d9/d2/qsinfo_8c.html#a4">NtSetInformationFile</a>(
00870                     FileHandle, 
00871                     IoStatusBlock, 
00872                     FileInformation, 
00873                     Length, 
00874                     FileInformationClass);
00875 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a5" doxytag="restrfil.c::Restricted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum { ... } 
 <a class="el" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00129">CheckRestricted()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00223">IsRestricted()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00992">SepMaximumAccessCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l01304">SepNormalAccessCheck()</a>, and <a class="el" href="../../d1/d3/accessck_8c-source.html#l00856">SepSidInTokenEx()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="restrfil.c::SiteDirectory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d6/d9/restrfil_8c.html#a9">SiteDirectory</a> = {0, 0, 0}          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00124">124</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01311">CreateDirectories()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">InitializeRestrictedStuff()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01163">IsInterestingPath()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="restrfil.c::SystemPath1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d6/d9/restrfil_8c.html#a6">SystemPath1</a> = {0, 0, 0}          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00121">121</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">InitializeRestrictedStuff()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01163">IsInterestingPath()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="restrfil.c::SystemPath2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d6/d9/restrfil_8c.html#a7">SystemPath2</a> = {0, 0, 0}          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00122">122</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">InitializeRestrictedStuff()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01163">IsInterestingPath()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="restrfil.c::SystemPath3" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d6/d9/restrfil_8c.html#a8">SystemPath3</a> = {0, 0, 0}          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00123">123</a> of file <a class="el" href="../../d7/d8/restrfil_8c-source.html">restrfil.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">InitializeRestrictedStuff()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01163">IsInterestingPath()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
