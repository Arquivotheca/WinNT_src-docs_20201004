<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: wsmanage.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>wsmanage.c</h1><a href="../../d5/d0/wsmanage_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   wsmanage.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains routines which manage the set of active working</span>
00012 <span class="comment">    set lists.</span>
00013 <span class="comment"></span>
00014 <span class="comment">    Working set management is accomplished by a parallel group of actions</span>
00015 <span class="comment"></span>
00016 <span class="comment">        1. Writing modified pages</span>
00017 <span class="comment"></span>
00018 <span class="comment">        2. Trimming working sets in one of two ways:</span>
00019 <span class="comment"></span>
00020 <span class="comment">            a. Using claims</span>
00021 <span class="comment"></span>
00022 <span class="comment">                1. Aging pages by turning off access bits and incrementing age</span>
00023 <span class="comment">                   counts for pages which haven't been accessed.</span>
00024 <span class="comment">                2. Estimating the number of unused pages in a working set and</span>
00025 <span class="comment">                   keeping a global count of that estimate.</span>
00026 <span class="comment">                3. When getting tight on memory, replacing rather than adding</span>
00027 <span class="comment">                   pages in a working set when a fault occurs in a working set</span>
00028 <span class="comment">                   that has a significant proportion of unused pages.</span>
00029 <span class="comment">                4. When memory is tight, reducing (trimming) working sets which</span>
00030 <span class="comment">                   are above their maximum towards their minimum.  This is done</span>
00031 <span class="comment">                   especially if there are a large number of available pages</span>
00032 <span class="comment">                   in it.</span>
00033 <span class="comment">        </span>
00034 <span class="comment">            b. Using page fault information</span>
00035 <span class="comment"></span>
00036 <span class="comment">                1. Reducing (trimming) working sets which are above their</span>
00037 <span class="comment">                   maximum towards their minimum.</span>
00038 <span class="comment"></span>
00039 <span class="comment">    The metrics are set such that writing modified pages is typically</span>
00040 <span class="comment">    accomplished before trimming working sets, however, under certain cases</span>
00041 <span class="comment">    where modified pages are being generated at a very high rate, working</span>
00042 <span class="comment">    set trimming will be initiated to free up more pages to modify.</span>
00043 <span class="comment"></span>
00044 <span class="comment">    When the first thread in a process is created, the memory management</span>
00045 <span class="comment">    system is notified that working set expansion is allowed.  This</span>
00046 <span class="comment">    is noted by changing the FLINK field of the WorkingSetExpansionLink</span>
00047 <span class="comment">    entry in the process control block from MM_NO_WS_EXPANSION to</span>
00048 <span class="comment">    MM_ALLOW_WS_EXPANSION.  As threads fault, the working set is eligible</span>
00049 <span class="comment">    for expansion if ample pages exist (MmAvailablePages is high enough).</span>
00050 <span class="comment"></span>
00051 <span class="comment">    Once a process has had its working set raised above the minimum</span>
00052 <span class="comment">    specified, the process is put on the Working Set Expanded list and</span>
00053 <span class="comment">    is now eligible for trimming.  Note that at this time the FLINK field</span>
00054 <span class="comment">    in the WorkingSetExpansionLink has an address value.</span>
00055 <span class="comment"></span>
00056 <span class="comment">    When working set trimming is initiated, a process is removed from the</span>
00057 <span class="comment">    list (the expansion lock guards this list) and the FLINK field is set</span>
00058 <span class="comment">    to MM_NO_WS_EXPANSION, also, the BLINK field is set to</span>
00059 <span class="comment">    MM_WS_EXPANSION_IN_PROGRESS.  The BLINK field value indicates to</span>
00060 <span class="comment">    the MmCleanUserAddressSpace function that working set trimming is</span>
00061 <span class="comment">    in progress for this process and it should wait until it completes.</span>
00062 <span class="comment">    This is accomplished by creating an event, putting the address of the</span>
00063 <span class="comment">    event in the BLINK field and then releasing the expansion lock and</span>
00064 <span class="comment">    waiting on the event atomically.  When working set trimming is</span>
00065 <span class="comment">    complete, the BLINK field is no longer MM_EXPANSION_IN_PROGRESS</span>
00066 <span class="comment">    indicating that the event should be set.</span>
00067 <span class="comment"></span>
00068 <span class="comment">Author:</span>
00069 <span class="comment"></span>
00070 <span class="comment">    Lou Perazzoli (loup) 10-Apr-1990</span>
00071 <span class="comment">    Landy Wang (landyw) 02-Jun-1997</span>
00072 <span class="comment"></span>
00073 <span class="comment">Revision History:</span>
00074 <span class="comment"></span>
00075 <span class="comment">--*/</span>
00076 
00077 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00078 
00079 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00080 <a class="code" href="../../d5/d0/wsmanage_8c.html#a32">MiEmptyAllWorkingSetsWorker</a> (
00081     VOID
00082     );
00083 
00084 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, MiEmptyAllWorkingSetsWorker)</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, MiEmptyAllWorkingSets)</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, MiAdjustWorkingSetManagerParameters)</span>
00088 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00089 <span class="preprocessor"></span>
00090 <span class="comment">//</span>
00091 <span class="comment">// Minimum number of page faults to take to avoid being trimmed on</span>
00092 <span class="comment">// an "ideal pass".</span>
00093 <span class="comment">//</span>
00094 
<a name="l00095"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a4">00095</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a4">MiIdealPassFaultCountDisable</a>;
00096 
<a name="l00097"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a5">00097</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a5">PsMinimumWorkingSet</a>;
00098 
<a name="l00099"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a6">00099</a> <span class="keyword">extern</span> <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a4">ExpDefaultErrorPortProcess</a>;
00100 
<a name="l00101"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a0">00101</a> <span class="preprocessor">#define MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM (6)</span>
00102 <span class="preprocessor"></span>
00103 <span class="comment">//</span>
00104 <span class="comment">// Hydra working set emptying support.</span>
00105 <span class="comment">//</span>
00106 
<a name="l00107"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a7">00107</a> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>  <a class="code" href="../../d5/d0/wsmanage_8c.html#a7">MiWaitForEmptyEvent</a>;
<a name="l00108"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a8">00108</a> BOOLEAN <a class="code" href="../../d5/d0/wsmanage_8c.html#a8">MiWaitingForWorkingSetEmpty</a>;
00109 
00110 <span class="comment">//</span>
00111 <span class="comment">// Number of times to wake up and do nothing before trimming processes</span>
00112 <span class="comment">// with no faulting activity.</span>
00113 <span class="comment">//</span>
00114 
<a name="l00115"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a1">00115</a> <span class="preprocessor">#define MM_REDUCE_FAULT_COUNT (10000)</span>
00116 <span class="preprocessor"></span>
<a name="l00117"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a2">00117</a> <span class="preprocessor">#define MM_IGNORE_FAULT_COUNT (100)</span>
00118 <span class="preprocessor"></span>
00119 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00120 <span class="preprocessor"></span>BOOLEAN MiReplacing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00121 <span class="preprocessor">#endif</span>
00122 <span class="preprocessor"></span>
<a name="l00123"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a9">00123</a> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a> = 1000;
00124 
<a name="l00125"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a10">00125</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a10">MmAmpleFreePages</a> = 200;
00126 
<a name="l00127"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a11">00127</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a11">MmWorkingSetReductionMin</a> = 12;
<a name="l00128"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a12">00128</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a12">MmWorkingSetReductionMinCacheWs</a> = 12;
00129 
<a name="l00130"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a13">00130</a> ULONG <a class="code" href="../../d4/d5/procsup_8c.html#a6">MmWorkingSetReductionMax</a> = 60;
<a name="l00131"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a14">00131</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a14">MmWorkingSetReductionMaxCacheWs</a> = 60;
00132 
<a name="l00133"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a15">00133</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a15">MmWorkingSetReductionHuge</a> = (512*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00134 
<a name="l00135"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a16">00135</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a16">MmWorkingSetVolReductionMin</a> = 12;
00136 
<a name="l00137"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a17">00137</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a17">MmWorkingSetVolReductionMax</a> = 60;
<a name="l00138"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a18">00138</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a18">MmWorkingSetVolReductionMaxCacheWs</a> = 60;
00139 
<a name="l00140"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a19">00140</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a19">MmWorkingSetVolReductionHuge</a> = (2*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00141 
<a name="l00142"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a20">00142</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a20">MmWorkingSetSwapReduction</a> = 75;
00143 
<a name="l00144"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a21">00144</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a21">MmWorkingSetSwapReductionHuge</a> = (4*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00145 
<a name="l00146"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a22">00146</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a22">MmNumberOfForegroundProcesses</a>;
00147 
00148 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00149 <span class="preprocessor"></span>
00150 ULONG MiAgingShift = 4;
00151 ULONG MiEstimationShift = 5;
00152 ULONG MmTotalClaim = 0;
00153 ULONG MmTotalEstimatedAvailable = 0;
00154 
00155 LARGE_INTEGER MiLastAdjustmentOfClaimParams;
00156 LARGE_INTEGER MmClaimParameterAdjustUpTime = {60 * 1000 * 1000 * 10, 0};    <span class="comment">// Sixty seconds</span>
00157 LARGE_INTEGER MmClaimParameterAdjustDownTime = {20 * 1000 * 1000 * 10, 0};    <span class="comment">// 20 seconds</span>
00158 
00159 ULONG MmPlentyFreePages = 400;
00160 
00161 <span class="preprocessor">#else</span>
00162 <span class="preprocessor"></span>
<a name="l00163"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a23">00163</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a>;
<a name="l00164"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a24">00164</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a24">MmLastFaultCount</a>;
00165 
00166 <span class="preprocessor">#endif</span>
00167 <span class="preprocessor"></span>
00168 <span class="preprocessor">#if DBG</span>
00169 <span class="preprocessor"></span><a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> MmWorkingSetThread;
00170 <span class="preprocessor">#endif</span>
00171 <span class="preprocessor"></span>
<a name="l00172"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a25">00172</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d5/d0/wsmanage_8c.html#a25">MmPagableKernelStart</a>;
<a name="l00173"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a26">00173</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d5/d0/wsmanage_8c.html#a26">MmPagableKernelEnd</a>;
00174 
<a name="l00175"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a27">00175</a> <a class="code" href="../../d2/d1/mm_8h.html#a105">PERFINFO_WSMANAGE_GLOBAL_DECL</a>;
00176 
<a name="l00177"></a><a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">00177</a> <span class="keyword">typedef</span> <span class="keyword">union </span><a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">_MMWS_TRIM_CRITERIA</a> {
00178 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00179 <span class="preprocessor"></span>    <span class="keyword">struct </span>{
00180         ULONG <a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o0">NumPasses</a>;
00181         PFN_NUMBER <a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o1">DesiredFreeGoal</a>;
00182         PFN_NUMBER NewTotalClaim;
00183         PFN_NUMBER NewTotalEstimatedAvailable;
00184         ULONG TrimAge;
00185         BOOLEAN DoAging;
00186         ULONG <a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o5">NumberOfForegroundProcesses</a>;
00187     } ClaimBased;
00188 <span class="preprocessor">#else</span>
00189 <span class="preprocessor"></span>    <span class="keyword">struct </span>{
<a name="l00190"></a><a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o0">00190</a>         ULONG <a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o0">NumPasses</a>;
<a name="l00191"></a><a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o1">00191</a>         PFN_NUMBER <a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o1">DesiredFreeGoal</a>;
<a name="l00192"></a><a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o2">00192</a>         PFN_NUMBER <a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o2">DesiredReductionGoal</a>;
<a name="l00193"></a><a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o3">00193</a>         ULONG <a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o3">FaultCount</a>;
<a name="l00194"></a><a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o4">00194</a>         PFN_NUMBER <a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o4">TotalReduction</a>;
<a name="l00195"></a><a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o5">00195</a>         ULONG <a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o5">NumberOfForegroundProcesses</a>;
00196     } FaultBased;
00197 <span class="preprocessor">#endif</span>
00198 <span class="preprocessor"></span>} <a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">MMWS_TRIM_CRITERIA</a>, *<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a>;
00199 
00200 LOGICAL
00201 <a class="code" href="../../d5/d0/wsmanage_8c.html#a42">MiCheckAndSetSystemTrimCriteria</a>(
00202     IN OUT PMMWS_TRIM_CRITERIA Criteria
00203     );
00204 
00205 BOOLEAN
00206 <a class="code" href="../../d5/d0/wsmanage_8c.html#a43">MiCheckSystemTrimEndCriteria</a>(
00207     IN OUT PMMWS_TRIM_CRITERIA Criteria,
00208     IN KIRQL OldIrql
00209     );
00210 
00211 BOOLEAN
00212 <a class="code" href="../../d5/d0/wsmanage_8c.html#a44">MiCheckProcessTrimCriteria</a>(
00213     IN PMMWS_TRIM_CRITERIA Criteria,
00214     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport,
00215     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00216     IN PLARGE_INTEGER CurrentTime
00217     );
00218 
00219 <span class="preprocessor">#ifndef _MI_USE_CLAIMS_</span>
00220 <span class="preprocessor"></span>LOGICAL
00221 <a class="code" href="../../d5/d0/wsmanage_8c.html#a45">MiCheckSystemCacheWsTrimCriteria</a>(
00222     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport
00223     );
00224 <span class="preprocessor">#endif</span>
00225 <span class="preprocessor"></span>
00226 ULONG
00227 <a class="code" href="../../d5/d0/wsmanage_8c.html#a46">MiDetermineWsTrimAmount</a>(
00228     IN PMMWS_TRIM_CRITERIA Criteria,
00229     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport,
00230     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00231     );
00232 
00233 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00234 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00235 MiAgePagesAndEstimateClaims(
00236     VOID
00237     );
00238 
00239 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00240 MiAdjustClaimParameters(
00241     IN BOOLEAN EnoughPages
00242     );
00243 
00244 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00245 MiAgeAndEstimateAvailableInWorkingSet(
00246     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport,
00247     IN BOOLEAN DoAging,
00248     IN OUT PULONG TotalClaim,
00249     IN OUT PULONG TotalEstimatedAvailable
00250     );
00251 <span class="preprocessor">#endif</span>
00252 <span class="preprocessor"></span>
00253 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00254 <a class="code" href="../../d5/d0/wsmanage_8c.html#a38">MiRearrangeWorkingSetExpansionList</a>(
00255     VOID
00256     );
00257 
00258 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00259"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a39">00259</a> <a class="code" href="../../d5/d0/wsmanage_8c.html#a39">MiAdjustWorkingSetManagerParameters</a>(
00260     BOOLEAN WorkStation
00261     )
00262 <span class="comment">/*++</span>
00263 <span class="comment"></span>
00264 <span class="comment">Routine Description:</span>
00265 <span class="comment"></span>
00266 <span class="comment">    This function is called from MmInitSystem to adjust the working set manager</span>
00267 <span class="comment">    trim algorithms based on system type and size.</span>
00268 <span class="comment"></span>
00269 <span class="comment">Arguments:</span>
00270 <span class="comment"></span>
00271 <span class="comment">    WorkStation - TRUE if this is a workstation, FALSE if not.</span>
00272 <span class="comment"></span>
00273 <span class="comment">Return Value:</span>
00274 <span class="comment"></span>
00275 <span class="comment">    None.</span>
00276 <span class="comment"></span>
00277 <span class="comment">Environment:</span>
00278 <span class="comment"></span>
00279 <span class="comment">    Kernel mode</span>
00280 <span class="comment"></span>
00281 <span class="comment">--*/</span>
00282 {
00283 
00284 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00285 <span class="preprocessor"></span>
00286     <span class="keywordflow">if</span> (WorkStation &amp;&amp; <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt;= 63*1024*1024/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
00287         MiAgingShift = 4;
00288         MiEstimationShift = 5;
00289     }
00290     <span class="keywordflow">else</span> {
00291         MiAgingShift = 5;
00292         MiEstimationShift = 6;
00293     }
00294 
00295     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt;= 63*1024*1024/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
00296         MmPlentyFreePages *= 2;
00297     }
00298 <span class="preprocessor">#else</span>
00299 <span class="preprocessor"></span>
00300     <span class="keywordflow">if</span> (WorkStation &amp;&amp; (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt;= (31*1024*1024/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>))) {
00301 
00302         <span class="comment">//</span>
00303         <span class="comment">// To get fault protection, you have to take 45 faults instead of</span>
00304         <span class="comment">// the old 15 fault protection threshold.</span>
00305         <span class="comment">//</span>
00306 
00307         <a class="code" href="../../d5/d0/wsmanage_8c.html#a4">MiIdealPassFaultCountDisable</a> = 45;
00308 
00309         <span class="comment">//</span>
00310         <span class="comment">// Take more away when you are over your working set in both</span>
00311         <span class="comment">// forced and voluntary mode, but leave cache WS trim amounts</span>
00312         <span class="comment">// alone.</span>
00313         <span class="comment">//</span>
00314 
00315         <a class="code" href="../../d5/d0/wsmanage_8c.html#a17">MmWorkingSetVolReductionMax</a> = 100;
00316         <a class="code" href="../../d4/d5/procsup_8c.html#a6">MmWorkingSetReductionMax</a> = 100;
00317 
00318         <span class="comment">//</span>
00319         <span class="comment">// In forced mode, even if you are within your working set, take</span>
00320         <span class="comment">// memory away more aggressively.</span>
00321         <span class="comment">//</span>
00322 
00323         <a class="code" href="../../d5/d0/wsmanage_8c.html#a11">MmWorkingSetReductionMin</a> = 40;
00324     }
00325     <span class="keywordflow">else</span> {
00326         <a class="code" href="../../d5/d0/wsmanage_8c.html#a4">MiIdealPassFaultCountDisable</a> = 15;
00327     }
00328 <span class="preprocessor">#endif</span>
00329 <span class="preprocessor"></span>
00330     <a class="code" href="../../d5/d0/wsmanage_8c.html#a8">MiWaitingForWorkingSetEmpty</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00331     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d5/d0/wsmanage_8c.html#a7">MiWaitForEmptyEvent</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00332 }
00333 
00334 
00335 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00336"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a40">00336</a> <a class="code" href="../../d5/d0/wsmanage_8c.html#a40">MiObtainFreePages</a> (
00337     VOID
00338     )
00339 
00340 <span class="comment">/*++</span>
00341 <span class="comment"></span>
00342 <span class="comment">Routine Description:</span>
00343 <span class="comment"></span>
00344 <span class="comment">    This function examines the size of the modified list and the</span>
00345 <span class="comment">    total number of pages in use because of working set increments</span>
00346 <span class="comment">    and obtains pages by writing modified pages and/or reducing</span>
00347 <span class="comment">    working sets.</span>
00348 <span class="comment"></span>
00349 <span class="comment">Arguments:</span>
00350 <span class="comment"></span>
00351 <span class="comment">    None.</span>
00352 <span class="comment"></span>
00353 <span class="comment">Return Value:</span>
00354 <span class="comment"></span>
00355 <span class="comment">    None.</span>
00356 <span class="comment"></span>
00357 <span class="comment">Environment:</span>
00358 <span class="comment"></span>
00359 <span class="comment">    Kernel mode, APCs disabled, working set and PFN mutexes held.</span>
00360 <span class="comment"></span>
00361 <span class="comment">--*/</span>
00362 
00363 {
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">// Check to see if there are enough modified pages to institute a</span>
00367     <span class="comment">// write.</span>
00368     <span class="comment">//</span>
00369 
00370     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>) ||
00371         (<a class="code" href="../../d4/d8/mi_8h.html#a608">MmModNoWriteInsert</a>)) {
00372 
00373         <span class="comment">//</span>
00374         <span class="comment">// Start the modified page writer.</span>
00375         <span class="comment">//</span>
00376 
00377         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a719">MmModifiedPageWriterEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00378     }
00379 
00380     <span class="comment">//</span>
00381     <span class="comment">// See if there are enough working sets above the minimum</span>
00382     <span class="comment">// threshold to make working set trimming worthwhile.</span>
00383     <span class="comment">//</span>
00384 
00385     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a592">MmPagesAboveWsThreshold</a>) ||
00386         (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 5)) {
00387 
00388         <span class="comment">//</span>
00389         <span class="comment">// Start the working set manager to reduce working sets.</span>
00390         <span class="comment">//</span>
00391 
00392         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d2/d1/mm_8h.html#a139">MmWorkingSetManagerEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00393     }
00394 }
00395 
00396 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00397"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a41">00397</a> <a class="code" href="../../d5/d0/wsmanage_8c.html#a41">MmWorkingSetManager</a> (
00398     VOID
00399     )
00400 
00401 <span class="comment">/*++</span>
00402 <span class="comment"></span>
00403 <span class="comment">Routine Description:</span>
00404 <span class="comment"></span>
00405 <span class="comment">    Implements the NT working set manager thread.  When the number</span>
00406 <span class="comment">    of free pages becomes critical and ample pages can be obtained by</span>
00407 <span class="comment">    reducing working sets, the working set manager's event is set, and</span>
00408 <span class="comment">    this thread becomes active.</span>
00409 <span class="comment"></span>
00410 <span class="comment">Arguments:</span>
00411 <span class="comment"></span>
00412 <span class="comment">    None.</span>
00413 <span class="comment"></span>
00414 <span class="comment">Return Value:</span>
00415 <span class="comment"></span>
00416 <span class="comment">    None.</span>
00417 <span class="comment"></span>
00418 <span class="comment">Environment:</span>
00419 <span class="comment"></span>
00420 <span class="comment">    Kernel mode.</span>
00421 <span class="comment"></span>
00422 <span class="comment">--*/</span>
00423 
00424 {
00425 
00426     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00427     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToTrim;
00428     PLIST_ENTRY ListEntry;
00429     LOGICAL Attached;
00430     ULONG Trim;
00431     KIRQL OldIrql;
00432     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport;
00433     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
00434     LARGE_INTEGER CurrentTime;
00435     ULONG count;
00436     LOGICAL DoTrimming;
00437     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace;
00438     LOGICAL InformSessionOfRelease;
00439 <span class="preprocessor">#if DBG</span>
00440 <span class="preprocessor"></span>    ULONG LastTrimFaultCount;
00441 <span class="preprocessor">#endif // DBG</span>
00442 <span class="preprocessor"></span>    <a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">MMWS_TRIM_CRITERIA</a> TrimCriteria;
00443     <a class="code" href="../../d2/d1/mm_8h.html#a99">PERFINFO_WSMANAGE_DECL</a>();
00444 
00445 <span class="preprocessor">#if DBG</span>
00446 <span class="preprocessor"></span>    MmWorkingSetThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
00447 <span class="preprocessor">#endif</span>
00448 <span class="preprocessor"></span>
00449     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || <a class="code" href="../../d2/d1/mm_8h.html#a302">MmIsAddressValid</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00450 
00451     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00452 
00453     Trim = 0;
00454 
00455     <span class="comment">//</span>
00456     <span class="comment">// Set the trim criteria: If there are plenty of pages, the existing</span>
00457     <span class="comment">// sets are aged and FALSE is returned to signify no trim is necessary.</span>
00458     <span class="comment">// Otherwise, the working set expansion list is ordered so the best</span>
00459     <span class="comment">// candidates for trimming are placed at the front and TRUE is returned.</span>
00460     <span class="comment">//</span>
00461 
00462     DoTrimming = <a class="code" href="../../d5/d0/wsmanage_8c.html#a42">MiCheckAndSetSystemTrimCriteria</a>(&amp;TrimCriteria);
00463 
00464     <span class="keywordflow">if</span> (DoTrimming) {
00465  
00466         Attached = 0;
00467 
00468         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;CurrentTime);
00469 
00470         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || <a class="code" href="../../d2/d1/mm_8h.html#a302">MmIsAddressValid</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00471 
00472         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00473         <span class="keywordflow">while</span> (!IsListEmpty (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>)) {
00474 
00475             <span class="comment">//</span>
00476             <span class="comment">// Remove the entry at the head and trim it.</span>
00477             <span class="comment">//</span>
00478 
00479             ListEntry = RemoveHeadList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>);
00480 
00481             <span class="keywordflow">if</span> (ListEntry == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>) {
00482                 VmSupport = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
00483                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
00484                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.TrimHard == 0);
00485                 SessionSpace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00486             }
00487             <span class="keywordflow">else</span> {
00488                 VmSupport = CONTAINING_RECORD(ListEntry,
00489                                               <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">MMSUPPORT</a>,
00490                                               WorkingSetExpansionLinks);
00491 
00492                 <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
00493                     ProcessToTrim = CONTAINING_RECORD(VmSupport,
00494                                                       <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,
00495                                                       Vm);
00496 
00497                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport == &amp;ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>);
00498                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> == 0);
00499                     SessionSpace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00500                 }
00501                 <span class="keywordflow">else</span> {
00502                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00503                     SessionSpace = CONTAINING_RECORD(VmSupport,
00504                                                      <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">MM_SESSION_SPACE</a>,
00505                                                      Vm);
00506                 }
00507             }
00508 
00509             <span class="comment">//</span>
00510             <span class="comment">// Note that other routines that set this bit must remove the</span>
00511             <span class="comment">// entry from the expansion list first.</span>
00512             <span class="comment">//</span>
00513 
00514             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 0);
00515 
00516             <span class="comment">//</span>
00517             <span class="comment">// Check to see if we've been here before.</span>
00518             <span class="comment">//</span>
00519 
00520             <span class="keywordflow">if</span> ((*(PLARGE_INTEGER)&amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a>).QuadPart ==
00521                        (*(PLARGE_INTEGER)&amp;CurrentTime).QuadPart) {
00522 
00523                 InsertHeadList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00524                             &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00525 
00526                 <span class="comment">//</span>
00527                 <span class="comment">// If we aren't finished we may sleep in this call.</span>
00528                 <span class="comment">//</span>
00529 
00530                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a43">MiCheckSystemTrimEndCriteria</a>(&amp;TrimCriteria, OldIrql)) {
00531 
00532                     <span class="comment">//</span>
00533                     <span class="comment">// No more pages are needed so we're done.</span>
00534                     <span class="comment">//</span>
00535 
00536                     <span class="keywordflow">break</span>;
00537                 }
00538 
00539                 <span class="comment">//</span>
00540                 <span class="comment">// Start a new round of trimming.</span>
00541                 <span class="comment">//</span>
00542 
00543                 <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;CurrentTime);
00544 
00545                 <span class="keywordflow">continue</span>;
00546             }
00547 
00548             <a class="code" href="../../d2/d1/mm_8h.html#a117">PERFINFO_WSMANAGE_TRIMWS</a>(ProcessToTrim, SessionSpace, VmSupport);
00549 
00550             <span class="keywordflow">if</span> (SessionSpace) {
00551 
00552                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a44">MiCheckProcessTrimCriteria</a>(&amp;TrimCriteria,
00553                                                 VmSupport,
00554                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00555                                                 &amp;CurrentTime) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00556 
00557                     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00558                                     &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00559                     <span class="keywordflow">continue</span>;
00560                 }
00561 
00562                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a> = CurrentTime;
00563                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 1;
00564 
00565                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
00566                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink =
00567                                                     <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>;
00568                 <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00569 
00570                 ProcessToTrim = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00571 
00572                 <span class="comment">//</span>
00573                 <span class="comment">// Attach directly to the session space to be trimmed.</span>
00574                 <span class="comment">//</span>
00575 
00576                 <a class="code" href="../../d3/d7/session_8c.html#a16">MiAttachSession</a> (SessionSpace);
00577 
00578                 <span class="comment">//</span>
00579                 <span class="comment">// Try for the session working set lock.</span>
00580                 <span class="comment">//</span>
00581 
00582                 WorkingSetList = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>;
00583 
00584                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
00585 
00586                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a> (&amp;SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o32">WsLock</a>)) {
00587                     <span class="comment">//</span>
00588                     <span class="comment">// This session space's working set lock was not</span>
00589                     <span class="comment">// granted, don't trim it.</span>
00590                     <span class="comment">//</span>
00591 
00592                     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
00593 
00594                     <a class="code" href="../../d3/d7/session_8c.html#a17">MiDetachSession</a> ();
00595 
00596                     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00597 
00598                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 1);
00599 
00600                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
00601 
00602                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d4/d8/mi_8h.html#a31">MM_FORCE_TRIM</a>;
00603 
00604                     <span class="keywordflow">goto</span> WorkingSetLockFailed;
00605                 }
00606 
00607                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
00608 
00609                 <a class="code" href="../../d4/d8/mi_8h.html#a404">MM_SET_SESSION_RESOURCE_OWNER</a>();
00610                 <a class="code" href="../../d2/d1/mm_8h.html#a108">PERFINFO_WSMANAGE_PROCESS_RESET</a>(VmSupport);
00611             }
00612             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
00613 
00614                 <span class="comment">//</span>
00615                 <span class="comment">// Check to see if this is a forced trim or</span>
00616                 <span class="comment">// if we are trimming because check counter is</span>
00617                 <span class="comment">// at the maximum.</span>
00618                 <span class="comment">//</span>
00619 
00620                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a44">MiCheckProcessTrimCriteria</a>(&amp;TrimCriteria,
00621                                                 VmSupport,
00622                                                 ProcessToTrim,
00623                                                 &amp;CurrentTime) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00624 
00625                     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00626                                     &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00627                     <span class="keywordflow">continue</span>;
00628                 }
00629 
00630                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a> = CurrentTime;
00631                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 1;
00632 
00633                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
00634                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink =
00635                                                     <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>;
00636                 <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00637                 WorkingSetList = <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>;
00638                 InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00639 
00640                 <span class="comment">//</span>
00641                 <span class="comment">// Attach to the process in preparation for trimming.</span>
00642                 <span class="comment">//</span>
00643 
00644                 <span class="keywordflow">if</span> (ProcessToTrim != CurrentProcess) {
00645 
00646                     Attached = <a class="code" href="../../d3/d5/procobj_8c.html#a5">KeForceAttachProcess</a> (&amp;ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
00647 
00648                     <span class="keywordflow">if</span> (Attached == 0) {
00649                         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00650                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
00651                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d4/d8/mi_8h.html#a31">MM_FORCE_TRIM</a>;
00652                         <span class="keywordflow">goto</span> WorkingSetLockFailed;
00653                     }
00654                     <span class="keywordflow">if</span> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00655                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o25">ProcessOutswapped</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00656                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession == 1 &amp;&amp; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionLeader == 0) {
00657                             InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00658                         }
00659                     }
00660                 }
00661 
00662                 <span class="comment">//</span>
00663                 <span class="comment">// Attempt to acquire the working set lock. If the</span>
00664                 <span class="comment">// lock cannot be acquired, skip over this process.</span>
00665                 <span class="comment">//</span>
00666 
00667                 count = 0;
00668                 <span class="keywordflow">do</span> {
00669                     <span class="keywordflow">if</span> (ExTryToAcquireFastMutex(&amp;ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o22">WorkingSetLock</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00670                         <span class="keywordflow">break</span>;
00671                     }
00672                     <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
00673                     count += 1;
00674                     <span class="keywordflow">if</span> (count == 5) {
00675 
00676                         <span class="comment">//</span>
00677                         <span class="comment">// Could not get the lock, skip this process.</span>
00678                         <span class="comment">//</span>
00679 
00680                         <span class="keywordflow">if</span> (InformSessionOfRelease == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00681                             <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00682                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00683                             ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00684                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &gt;= 1);
00685                             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> -= 1;
00686                             <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00687                             InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00688                         }
00689 
00690                         <span class="keywordflow">if</span> (Attached) {
00691                             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
00692                             Attached = 0;
00693                         }
00694 
00695                         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00696                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
00697                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d4/d8/mi_8h.html#a31">MM_FORCE_TRIM</a>;
00698                         <span class="keywordflow">goto</span> WorkingSetLockFailed;
00699                     }
00700                 } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00701 
00702                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 1);
00703 
00704 <span class="preprocessor">#if DBG</span>
00705 <span class="preprocessor"></span>                LastTrimFaultCount = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a>;
00706 <span class="preprocessor">#endif // DBG</span>
00707 <span class="preprocessor"></span>                VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
00708 
00709                 <a class="code" href="../../d2/d1/mm_8h.html#a108">PERFINFO_WSMANAGE_PROCESS_RESET</a>(VmSupport);
00710             }
00711             <span class="keywordflow">else</span> {
00712 
00713                 <span class="comment">//</span>
00714                 <span class="comment">// System cache,</span>
00715                 <span class="comment">//</span>
00716 
00717 <span class="preprocessor">#if DBG</span>
00718 <span class="preprocessor"></span>                LastTrimFaultCount = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a>;
00719 <span class="preprocessor">#endif // DBG</span>
00720 <span class="preprocessor"></span>
00721                 <a class="code" href="../../d2/d1/mm_8h.html#a108">PERFINFO_WSMANAGE_PROCESS_RESET</a>(VmSupport);
00722 
00723                 <span class="comment">//</span>
00724                 <span class="comment">// Always try to trim the system cache when using claims.</span>
00725                 <span class="comment">// Fault-based trimming might skip it from time to time.</span>
00726                 <span class="comment">//</span>
00727 
00728 <span class="preprocessor">#ifndef _MI_USE_CLAIMS_</span>
00729 <span class="preprocessor"></span>
00730                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d0/wsmanage_8c.html#a45">MiCheckSystemCacheWsTrimCriteria</a>(VmSupport)) {
00731 
00732                     <span class="comment">//</span>
00733                     <span class="comment">// Don't trim the system cache.</span>
00734                     <span class="comment">//</span>
00735 
00736                     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00737                                         &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00738                     <span class="keywordflow">continue</span>;
00739                 }
00740 <span class="preprocessor">#endif</span>
00741 <span class="preprocessor"></span>
00742                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a> = CurrentTime;
00743 
00744                 <span class="comment">//</span>
00745                 <span class="comment">// Indicate that this working set is being trimmed.</span>
00746                 <span class="comment">//</span>
00747 
00748                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 1;
00749 
00750                 <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00751 
00752                 ProcessToTrim = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00753                 WorkingSetList = <a class="code" href="../../d4/d8/mi_8h.html#a657">MmSystemCacheWorkingSetList</a>;
00754 
00755                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
00756                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a688">MmSystemWsLock</a>)) {
00757 
00758                     <span class="comment">//</span>
00759                     <span class="comment">// System working set lock was not granted, don't trim</span>
00760                     <span class="comment">// the system cache.</span>
00761                     <span class="comment">//</span>
00762 
00763                     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
00764                     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00765                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
00766                     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00767                                     &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00768                     <span class="keywordflow">continue</span>;
00769                 }
00770 
00771                 <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00772 
00773                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
00774 
00775                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
00776                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink =
00777                                                     <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>;
00778             }
00779 
00780             <span class="comment">//</span>
00781             <span class="comment">// Determine how many pages we want to trim from this working set.</span>
00782             <span class="comment">//</span>
00783 
00784             Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a46">MiDetermineWsTrimAmount</a>(&amp;TrimCriteria,
00785                                            VmSupport,
00786                                            ProcessToTrim
00787                                            );
00788 
00789 <span class="preprocessor">#if DBG</span>
00790 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a60">MM_DBG_WS_EXPANSION</a>) {
00791                 <span class="keywordflow">if</span> (Trim) {
00792                   <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
00793                       <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"           Trimming        Process %16s %5d Faults, WS %6d, Trimming %5d ==&gt; %5d\n"</span>,
00794                         ProcessToTrim ? ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o65">ImageFileName</a> : (PUCHAR)<span class="stringliteral">"System Cache"</span>,
00795                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a> - LastTrimFaultCount,
00796                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>,
00797                         Trim,
00798                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>-Trim
00799                         );
00800                   }
00801                   <span class="keywordflow">else</span> {
00802                       <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"           Trimming        Session 0x%x (id %d) %5d Faults, WS %6d, Trimming %5d ==&gt; %5d\n"</span>,
00803                         SessionSpace,
00804                         SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
00805                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a> - LastTrimFaultCount,
00806                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>,
00807                         Trim,
00808                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>-Trim
00809                         );
00810                   }
00811                 }
00812             }
00813 <span class="preprocessor">#endif //DBG</span>
00814 <span class="preprocessor"></span>
00815 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00816 <span class="preprocessor"></span>
00817             <span class="comment">//</span>
00818             <span class="comment">// If there's something to trim...</span>
00819             <span class="comment">//</span>
00820 
00821             <span class="keywordflow">if</span> (Trim != 0 &amp;&amp;
00822                 (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; TrimCriteria.ClaimBased.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o1">DesiredFreeGoal</a>)) {
00823 
00824                 <span class="comment">//</span>
00825                 <span class="comment">// We haven't reached our goal, so trim now.</span>
00826                 <span class="comment">//</span>
00827 
00828                 <a class="code" href="../../d2/d1/mm_8h.html#a113">PERFINFO_WSMANAGE_TOTRIM</a>(Trim);
00829 
00830                 Trim = <a class="code" href="../../d4/d0/wslist_8c.html#a34">MiTrimWorkingSet</a> (Trim,
00831                                          VmSupport,
00832                                          TrimCriteria.ClaimBased.TrimAge
00833                                          );
00834 
00835                 <a class="code" href="../../d2/d1/mm_8h.html#a98">PERFINFO_WSMANAGE_ACTUALTRIM</a>(Trim);
00836             }
00837 
00838             <span class="comment">//</span>
00839             <span class="comment">// Estimating the current claim is always done here by taking a</span>
00840             <span class="comment">// sample of the working set.  Aging is only done if the trim</span>
00841             <span class="comment">// pass warrants it (ie: the first pass only).</span>
00842             <span class="comment">//</span>
00843 
00844             MiAgeAndEstimateAvailableInWorkingSet(
00845                                 VmSupport,
00846                                 TrimCriteria.ClaimBased.DoAging,
00847                                 &amp;TrimCriteria.ClaimBased.NewTotalClaim,
00848                                 &amp;TrimCriteria.ClaimBased.NewTotalEstimatedAvailable
00849                                 );
00850 <span class="preprocessor">#else</span>
00851 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Trim != 0) {
00852 
00853                 <a class="code" href="../../d2/d1/mm_8h.html#a113">PERFINFO_WSMANAGE_TOTRIM</a>(Trim);
00854 
00855                 Trim = <a class="code" href="../../d4/d0/wslist_8c.html#a34">MiTrimWorkingSet</a> (
00856                             Trim,
00857                             VmSupport,
00858                             (BOOLEAN)(<a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a0">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>)
00859                             );
00860 
00861                 <a class="code" href="../../d2/d1/mm_8h.html#a98">PERFINFO_WSMANAGE_ACTUALTRIM</a>(Trim);
00862             }
00863 <span class="preprocessor">#endif</span>
00864 <span class="preprocessor"></span>
00865             <span class="comment">//</span>
00866             <span class="comment">// Set the quota to the current size.</span>
00867             <span class="comment">//</span>
00868 
00869             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>;
00870             <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> &lt; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>) {
00871                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
00872             }
00873 
00874             <span class="keywordflow">if</span> (SessionSpace) {
00875 
00876                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 1);
00877 
00878                 <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00879 
00880                 <a class="code" href="../../d3/d7/session_8c.html#a17">MiDetachSession</a> ();
00881             }
00882             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
00883 
00884                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
00885                 <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (ProcessToTrim);
00886 
00887                 <span class="keywordflow">if</span> (InformSessionOfRelease == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00888                     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00889                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00890                     ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00891                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &gt;= 1);
00892                     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> -= 1;
00893                     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00894                     InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00895                 }
00896 
00897                 <span class="keywordflow">if</span> (Attached) {
00898                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
00899                     Attached = 0;
00900                 }
00901 
00902             }
00903             <span class="keywordflow">else</span> {
00904                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
00905                 <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql);
00906             }
00907 
00908             <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00909 
00910             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 1);
00911             VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
00912 
00913 WorkingSetLockFailed:
00914 
00915             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink == <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>);
00916 
00917             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink ==
00918                                                  <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>) {
00919 
00920                 <span class="comment">//</span>
00921                 <span class="comment">// If the working set size is still above the minimum,</span>
00922                 <span class="comment">// add this back at the tail of the list.</span>
00923                 <span class="comment">//</span>
00924 
00925                 InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00926                                 &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00927             }
00928             <span class="keywordflow">else</span> {
00929 
00930                 <span class="comment">//</span>
00931                 <span class="comment">// The value in the blink is the address of an event</span>
00932                 <span class="comment">// to set.</span>
00933                 <span class="comment">//</span>
00934 
00935                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>);
00936 
00937                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> ((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink,
00938                             0,
00939                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00940             }
00941 
00942 <span class="preprocessor">#ifndef _MI_USE_CLAIMS_</span>
00943 <span class="preprocessor"></span>            TrimCriteria.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.TotalReduction += Trim;
00944 
00945             <span class="comment">//</span>
00946             <span class="comment">// Zero this in case the next attach fails.</span>
00947             <span class="comment">//</span>
00948 
00949             Trim = 0;
00950 
00951             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a0">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>) {
00952                 <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; TrimCriteria.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredFreeGoal) ||
00953                     (TrimCriteria.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.TotalReduction &gt; TrimCriteria.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredReductionGoal)) {
00954 
00955 
00956                     <span class="comment">//</span>
00957                     <span class="comment">// Ample pages now exist.</span>
00958                     <span class="comment">//</span>
00959 
00960                     <a class="code" href="../../d2/d1/mm_8h.html#a104">PERFINFO_WSMANAGE_FINALACTION</a>(WS_ACTION_AMPLE_PAGES_EXIST);
00961                     <span class="keywordflow">break</span>;
00962                 }
00963             }
00964 <span class="preprocessor">#endif</span>
00965 <span class="preprocessor"></span>
00966         }
00967 
00968 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00969 <span class="preprocessor"></span>        MmTotalClaim = TrimCriteria.ClaimBased.NewTotalClaim;
00970         MmTotalEstimatedAvailable = TrimCriteria.ClaimBased.NewTotalEstimatedAvailable;
00971         <a class="code" href="../../d2/d1/mm_8h.html#a115">PERFINFO_WSMANAGE_TRIMEND_CLAIMS</a>(&amp;TrimCriteria);
00972 <span class="preprocessor">#else</span>
00973 <span class="preprocessor"></span>        <a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> = 0;
00974         <a class="code" href="../../d2/d1/mm_8h.html#a116">PERFINFO_WSMANAGE_TRIMEND_FAULTS</a>(&amp;TrimCriteria);
00975 <span class="preprocessor">#endif</span>
00976 <span class="preprocessor"></span>
00977         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00978     }
00979 
00980     <span class="comment">//</span>
00981     <span class="comment">// Signal the modified page writer as we have moved pages</span>
00982     <span class="comment">// to the modified list and memory was critical.</span>
00983     <span class="comment">//</span>
00984 
00985     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>) ||
00986         (<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a>)) {
00987         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a719">MmModifiedPageWriterEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00988     }
00989 
00990     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentProcess == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ());
00991 
00992     <span class="keywordflow">return</span>;
00993 }
00994 
00995 LOGICAL
<a name="l00996"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a42">00996</a> <a class="code" href="../../d5/d0/wsmanage_8c.html#a42">MiCheckAndSetSystemTrimCriteria</a>(
00997     PMMWS_TRIM_CRITERIA Criteria
00998     )
00999 
01000 <span class="comment">/*++</span>
01001 <span class="comment"></span>
01002 <span class="comment">Routine Description:</span>
01003 <span class="comment"></span>
01004 <span class="comment">    Decide whether to trim at this time.  If using claims, then this</span>
01005 <span class="comment">    routine may initiate aging and claim adjustments as well.</span>
01006 <span class="comment"></span>
01007 <span class="comment">Arguments:</span>
01008 <span class="comment"></span>
01009 <span class="comment">    Criteria - Supplies a pointer to the trim criteria information.  Various</span>
01010 <span class="comment">               fields in this structure are set as needed by this routine.</span>
01011 <span class="comment"></span>
01012 <span class="comment">Return Value:</span>
01013 <span class="comment"></span>
01014 <span class="comment">    TRUE if the caller should initiate trimming, FALSE if not.</span>
01015 <span class="comment"></span>
01016 <span class="comment">Environment:</span>
01017 <span class="comment"></span>
01018 <span class="comment">    Kernel mode.  No locks held.  APC level or below.</span>
01019 <span class="comment"></span>
01020 <span class="comment">--*/</span>
01021 
01022 {
01023     PFN_NUMBER Available;
01024     ULONG PageFaultCount;
01025     KIRQL OldIrql;
01026     BOOLEAN InitiateTrim;
01027 
01028     <a class="code" href="../../d2/d1/mm_8h.html#a99">PERFINFO_WSMANAGE_DECL</a>();
01029 
01030     <span class="comment">//</span>
01031     <span class="comment">// See if an empty-all-working-sets request has been queued to us.</span>
01032     <span class="comment">// This only happens on Hydra.</span>
01033     <span class="comment">//</span>
01034 
01035     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a8">MiWaitingForWorkingSetEmpty</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01036 
01037         <a class="code" href="../../d5/d0/wsmanage_8c.html#a32">MiEmptyAllWorkingSetsWorker</a> ();
01038 
01039         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01040 
01041         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d5/d0/wsmanage_8c.html#a7">MiWaitForEmptyEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01042         <a class="code" href="../../d5/d0/wsmanage_8c.html#a8">MiWaitingForWorkingSetEmpty</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01043 
01044         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01045 
01046 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
01047 <span class="preprocessor"></span>        MiReplacing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01048 <span class="preprocessor">#endif</span>
01049 <span class="preprocessor"></span>
01050         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01051     }
01052 
01053     <span class="comment">//</span>
01054     <span class="comment">// Check the number of pages available to see if any trimming</span>
01055     <span class="comment">// is really required.</span>
01056     <span class="comment">//</span>
01057 
01058     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01059     Available = <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a>;
01060     PageFaultCount = <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o0">PageFaultCount</a>;
01061     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01062 
01063 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
01064 <span class="preprocessor"></span>    <a class="code" href="../../d2/d1/mm_8h.html#a111">PERFINFO_WSMANAGE_STARTLOG_CLAIMS</a>();
01065     <span class="keywordflow">if</span> (Available &gt; MmPlentyFreePages &amp;&amp; MiReplacing == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01066 
01067         <span class="comment">//</span>
01068         <span class="comment">// Don't trim but do age unused pages and estimate</span>
01069         <span class="comment">// the amount available in working sets.</span>
01070         <span class="comment">//</span>
01071 
01072         MiAgePagesAndEstimateClaims ();
01073         MiAdjustClaimParameters (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01074         <a class="code" href="../../d2/d1/mm_8h.html#a114">PERFINFO_WSMANAGE_TRIMACTION</a> (WS_ACTION_RESET_COUNTER);
01075     }
01076     <span class="keywordflow">else</span> {
01077 
01078         <span class="comment">//</span>
01079         <span class="comment">// Inform our caller to start trimming since we're below</span>
01080         <span class="comment">// plenty pages - order the list so the bigger working sets are</span>
01081         <span class="comment">// in front so our caller trims those first.</span>
01082         <span class="comment">//</span>
01083 
01084         Criteria-&gt;ClaimBased.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o0">NumPasses</a> = 0;
01085         Criteria-&gt;ClaimBased.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o1">DesiredFreeGoal</a> = MmPlentyFreePages +
01086                                                     (MmPlentyFreePages / 2);
01087         Criteria-&gt;ClaimBased.NewTotalClaim = 0;
01088         Criteria-&gt;ClaimBased.NewTotalEstimatedAvailable = 0;
01089         Criteria-&gt;ClaimBased.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o5">NumberOfForegroundProcesses</a> = 0;
01090 
01091         <span class="comment">//</span>
01092         <span class="comment">// Start trimming the bigger working sets first.</span>
01093         <span class="comment">//</span>
01094 
01095         <a class="code" href="../../d5/d0/wsmanage_8c.html#a38">MiRearrangeWorkingSetExpansionList</a> ();
01096 
01097 <span class="preprocessor">#if DBG</span>
01098 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a60">MM_DBG_WS_EXPANSION</a>) {
01099             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\nMM-wsmanage: Desired = %ld, Avail %ld\n"</span>,
01100                     Criteria-&gt;ClaimBased.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o1">DesiredFreeGoal</a>, <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a>);
01101         }
01102 <span class="preprocessor">#endif //DBG</span>
01103 <span class="preprocessor"></span>
01104         <a class="code" href="../../d2/d1/mm_8h.html#a123">PERFINFO_WSMANAGE_WILLTRIM_CLAIMS</a>(Criteria);
01105 
01106         MiReplacing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01107 
01108         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01109     }
01110     <a class="code" href="../../d2/d1/mm_8h.html#a101">PERFINFO_WSMANAGE_DUMPENTRIES_CLAIMS</a>();
01111 
01112     <span class="comment">//</span>
01113     <span class="comment">// If we've been replacing within a given working set, it's worth doing</span>
01114     <span class="comment">// a trim.  No need to lock synchronize the MiReplacing clearing as it</span>
01115     <span class="comment">// gets set every time a page replacement happens anyway.</span>
01116     <span class="comment">//</span>
01117 
01118     InitiateTrim = MiReplacing;
01119 
01120     MiReplacing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01121 
01122     <span class="keywordflow">return</span> InitiateTrim;
01123 
01124 <span class="preprocessor">#else</span>
01125 <span class="preprocessor"></span>
01126     <a class="code" href="../../d2/d1/mm_8h.html#a112">PERFINFO_WSMANAGE_STARTLOG_FAULTS</a>();
01127 
01128     <span class="keywordflow">if</span> ((Available &gt; (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt;&gt; 2)) ||
01129         ((Available &gt; <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a>) &amp;&amp;
01130         ((PageFaultCount - <a class="code" href="../../d5/d0/wsmanage_8c.html#a24">MmLastFaultCount</a>) &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a1">MM_REDUCE_FAULT_COUNT</a>))) {
01131 
01132         <span class="comment">//</span>
01133         <span class="comment">// Don't trim and zero the check counter.</span>
01134         <span class="comment">//</span>
01135 
01136         <a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> = 0;
01137         <a class="code" href="../../d2/d1/mm_8h.html#a114">PERFINFO_WSMANAGE_TRIMACTION</a>(WS_ACTION_RESET_COUNTER);
01138 
01139     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Available &gt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a10">MmAmpleFreePages</a>) &amp;&amp;
01140         ((PageFaultCount - <a class="code" href="../../d5/d0/wsmanage_8c.html#a24">MmLastFaultCount</a>) &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a2">MM_IGNORE_FAULT_COUNT</a>)) {
01141 
01142         <span class="comment">//</span>
01143         <span class="comment">// Don't do anything.</span>
01144         <span class="comment">//</span>
01145 
01146         NOTHING;
01147         <a class="code" href="../../d2/d1/mm_8h.html#a114">PERFINFO_WSMANAGE_TRIMACTION</a>(WS_ACTION_NOTHING);
01148 
01149     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Available &gt; <a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a>) &amp;&amp;
01150                (<a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a0">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>)) {
01151 
01152         <span class="comment">//</span>
01153         <span class="comment">// Don't trim, but increment the check counter.</span>
01154         <span class="comment">//</span>
01155 
01156         <a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> += 1;
01157         <a class="code" href="../../d2/d1/mm_8h.html#a114">PERFINFO_WSMANAGE_TRIMACTION</a>(WS_ACTION_INCREMENT_COUNTER);
01158 
01159     }
01160     <span class="keywordflow">else</span> {
01161 
01162         <span class="comment">//</span>
01163         <span class="comment">// Initialize state variables.</span>
01164         <span class="comment">//</span>
01165 
01166         Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.NumPasses = 0;
01167         Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.TotalReduction = 0;
01168         Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.NumberOfForegroundProcesses = 0;
01169 
01170         <span class="comment">//</span>
01171         <span class="comment">// Set the total reduction goals.</span>
01172         <span class="comment">//</span>
01173 
01174         Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredReductionGoal = <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> &gt;&gt; 2;
01175         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> &gt; (<a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a> &lt;&lt; 1)) {
01176             Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredFreeGoal = <a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a>;
01177         }
01178         <span class="keywordflow">else</span> {
01179             Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredFreeGoal = <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a> + 10;
01180         }
01181 
01182         <span class="comment">//</span>
01183         <span class="comment">// Calculate the number of faults to be taken to not be trimmed.</span>
01184         <span class="comment">//</span>
01185 
01186         <span class="keywordflow">if</span> (Available &gt; <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a>) {
01187             Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.FaultCount = 1;
01188         }
01189         <span class="keywordflow">else</span> {
01190             Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.FaultCount = <a class="code" href="../../d5/d0/wsmanage_8c.html#a4">MiIdealPassFaultCountDisable</a>;
01191         }
01192 
01193 <span class="preprocessor">#if DBG</span>
01194 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a60">MM_DBG_WS_EXPANSION</a>) {
01195             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\nMM-wsmanage: checkcounter = %ld, Desired = %ld, Free = %ld Avail %ld\n"</span>,
01196                 <a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a>, Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredReductionGoal,
01197                 Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredFreeGoal, <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a>);
01198         }
01199 <span class="preprocessor">#endif //DBG</span>
01200 <span class="preprocessor"></span>
01201         <a class="code" href="../../d2/d1/mm_8h.html#a124">PERFINFO_WSMANAGE_WILLTRIM_FAULTS</a>(Criteria);
01202 
01203         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01204             <a class="code" href="../../d5/d0/wsmanage_8c.html#a38">MiRearrangeWorkingSetExpansionList</a> ();
01205         }
01206 
01207         <a class="code" href="../../d5/d0/wsmanage_8c.html#a24">MmLastFaultCount</a> = PageFaultCount;
01208 
01209         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01210     }
01211     <a class="code" href="../../d2/d1/mm_8h.html#a102">PERFINFO_WSMANAGE_DUMPENTRIES_FAULTS</a>();
01212 
01213     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01214 <span class="preprocessor">#endif</span>
01215 <span class="preprocessor"></span>}
01216 
01217 BOOLEAN
<a name="l01218"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a43">01218</a> <a class="code" href="../../d5/d0/wsmanage_8c.html#a43">MiCheckSystemTrimEndCriteria</a>(
01219     IN PMMWS_TRIM_CRITERIA Criteria,
01220     IN KIRQL OldIrql
01221     )
01222 
01223 <span class="comment">/*++</span>
01224 <span class="comment"></span>
01225 <span class="comment">Routine Description:</span>
01226 <span class="comment"></span>
01227 <span class="comment">     Check the ending criteria.  If we're not done, delay for a little</span>
01228 <span class="comment">     bit to let the modified write catch up.</span>
01229 <span class="comment"></span>
01230 <span class="comment">Arguments:</span>
01231 <span class="comment"></span>
01232 <span class="comment">    Criteria - Supplies the trim criteria information.</span>
01233 <span class="comment"></span>
01234 <span class="comment">    OldIrql - Supplies the old IRQL to lower to if the expansion lock needs</span>
01235 <span class="comment">              to be released.</span>
01236 <span class="comment"></span>
01237 <span class="comment">Return Value:</span>
01238 <span class="comment"></span>
01239 <span class="comment">    TRUE if trimming can be stopped, FALSE otherwise.</span>
01240 <span class="comment"></span>
01241 <span class="comment">Environment:</span>
01242 <span class="comment"></span>
01243 <span class="comment">    Kernel mode.  Expansion lock held.  APC level or below.</span>
01244 <span class="comment"></span>
01245 <span class="comment">--*/</span>
01246 
01247 {
01248     BOOLEAN FinishedTrimming;
01249     <a class="code" href="../../d2/d1/mm_8h.html#a99">PERFINFO_WSMANAGE_DECL</a>();
01250 
01251     FinishedTrimming = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01252 
01253 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
01254 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; Criteria-&gt;ClaimBased.DesiredFreeGoal) ||
01255         (Criteria-&gt;ClaimBased.NumPasses &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a199">MI_MAX_TRIM_PASSES</a>)) {
01256 
01257         <span class="comment">//</span>
01258         <span class="comment">// We have enough pages or we trimmed as many as we're going to get.</span>
01259         <span class="comment">//</span>
01260 
01261         FinishedTrimming = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01262     }
01263     <span class="keywordflow">else</span> {
01264 
01265         <span class="comment">//</span>
01266         <span class="comment">// Update the global claim and estimate before we wait.</span>
01267         <span class="comment">//</span>
01268 
01269         MmTotalClaim = Criteria-&gt;ClaimBased.NewTotalClaim;
01270         MmTotalEstimatedAvailable = Criteria-&gt;ClaimBased.NewTotalEstimatedAvailable;
01271     }
01272 <span class="preprocessor">#else</span>
01273 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>) {
01274 
01275         <span class="comment">//</span>
01276         <span class="comment">// Every process has been examined and ample pages</span>
01277         <span class="comment">// now exist.</span>
01278         <span class="comment">//</span>
01279 
01280         <a class="code" href="../../d5/d0/wsmanage_8c.html#a22">MmNumberOfForegroundProcesses</a> = Criteria-&gt;FaultBased.NumberOfForegroundProcesses;
01281 
01282         FinishedTrimming = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01283     }
01284 <span class="preprocessor">#endif</span>
01285 <span class="preprocessor"></span>
01286     <span class="keywordflow">if</span> (FinishedTrimming == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01287 
01288         <span class="comment">//</span>
01289         <span class="comment">// If we don't have enough pages wait 10 milliseconds</span>
01290         <span class="comment">// for the modified page writer to catch up.  The wait is also</span>
01291         <span class="comment">// important because a thread may have the system cache locked but</span>
01292         <span class="comment">// has been preempted by the balance set manager due to its higher</span>
01293         <span class="comment">// priority.  We must give this thread a shot at running so it can</span>
01294         <span class="comment">// release the system cache lock (all the trimmable pages may reside in</span>
01295         <span class="comment">// the system cache).</span>
01296         <span class="comment">//</span>
01297 
01298         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01299 
01300         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01301                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01302                                 &amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
01303 
01304 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
01305 <span class="preprocessor"></span>        <a class="code" href="../../d2/d1/mm_8h.html#a120">PERFINFO_WSMANAGE_WAITFORWRITER_CLAIMS</a>();
01306 <span class="preprocessor">#else</span>
01307 <span class="preprocessor"></span>        <a class="code" href="../../d2/d1/mm_8h.html#a121">PERFINFO_WSMANAGE_WAITFORWRITER_FAULTS</a>();
01308 <span class="preprocessor">#endif</span>
01309 <span class="preprocessor"></span>
01310         <span class="comment">//</span>
01311         <span class="comment">// Check again to see if we've met the criteria to stop trimming.</span>
01312         <span class="comment">//</span>
01313 
01314 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
01315 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; Criteria-&gt;ClaimBased.DesiredFreeGoal) {
01316 
01317             <span class="comment">//</span>
01318             <span class="comment">// Now we have enough pages so break out.</span>
01319             <span class="comment">//</span>
01320 
01321             FinishedTrimming = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01322         }
01323         <span class="keywordflow">else</span> {
01324 
01325             <span class="comment">//</span>
01326             <span class="comment">// We don't have enough pages so let's do another pass.</span>
01327             <span class="comment">// Go get the next working set list which is probably the</span>
01328             <span class="comment">// one we put back before we gave up the processor.</span>
01329             <span class="comment">//</span>
01330     
01331             <span class="keywordflow">if</span> (Criteria-&gt;ClaimBased.NumPasses == 0) {
01332                 MiAdjustClaimParameters(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01333             }
01334 
01335             Criteria-&gt;ClaimBased.NumPasses += 1;
01336             Criteria-&gt;ClaimBased.NewTotalClaim = 0;
01337             Criteria-&gt;ClaimBased.NewTotalEstimatedAvailable = 0;
01338     
01339             <a class="code" href="../../d2/d1/mm_8h.html#a114">PERFINFO_WSMANAGE_TRIMACTION</a>(WS_ACTION_FORCE_TRIMMING_PROCESS);
01340         }
01341 <span class="preprocessor">#else</span>
01342 <span class="preprocessor"></span>
01343         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>) {
01344 
01345             <span class="comment">//</span>
01346             <span class="comment">// Now we have enough pages so break out.</span>
01347             <span class="comment">//</span>
01348 
01349             FinishedTrimming = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01350         }
01351         <span class="keywordflow">else</span> {
01352 
01353             <span class="comment">//</span>
01354             <span class="comment">// Change this to a forced trim, so we get pages</span>
01355             <span class="comment">// available, and reset the current time.</span>
01356             <span class="comment">//</span>
01357 
01358             <a class="code" href="../../d2/d1/mm_8h.html#a114">PERFINFO_WSMANAGE_TRIMACTION</a>(WS_ACTION_FORCE_TRIMMING_PROCESS);
01359 
01360             <a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> = 0;
01361             Criteria-&gt;FaultBased.NumPasses += 1;
01362         }
01363 <span class="preprocessor">#endif</span>
01364 <span class="preprocessor"></span>
01365         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01366     }
01367 
01368     <span class="keywordflow">return</span> FinishedTrimming;
01369 }
01370 
01371 BOOLEAN
<a name="l01372"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a44">01372</a> <a class="code" href="../../d5/d0/wsmanage_8c.html#a44">MiCheckProcessTrimCriteria</a>(
01373     PMMWS_TRIM_CRITERIA Criteria,
01374     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport,
01375     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
01376     PLARGE_INTEGER CurrentTime
01377     )
01378 
01379 <span class="comment">/*++</span>
01380 <span class="comment"></span>
01381 <span class="comment">Routine Description:</span>
01382 <span class="comment"></span>
01383 <span class="comment">    Determine whether the specified working set should be trimmed.</span>
01384 <span class="comment"></span>
01385 <span class="comment">Arguments:</span>
01386 <span class="comment"></span>
01387 <span class="comment">    Criteria - Supplies the trim criteria information.</span>
01388 <span class="comment"></span>
01389 <span class="comment">    VmSupport - Supplies the working set information for the candidate process.</span>
01390 <span class="comment"></span>
01391 <span class="comment">    Process - Supplies the process to trim.  NULL if this is for a session.</span>
01392 <span class="comment"></span>
01393 <span class="comment">    CurrentTime - Supplies the time at the start of this trim round.</span>
01394 <span class="comment"></span>
01395 <span class="comment">Return Value:</span>
01396 <span class="comment"></span>
01397 <span class="comment">    TRUE if trimming should be done on this process, FALSE otherwise.</span>
01398 <span class="comment"></span>
01399 <span class="comment">Environment:</span>
01400 <span class="comment"></span>
01401 <span class="comment">    Kernel mode.  Expansion lock held.  APC level or below.</span>
01402 <span class="comment"></span>
01403 <span class="comment">--*/</span>
01404 
01405 {
01406     BOOLEAN Trim;
01407     BOOLEAN Reset;
01408     BOOLEAN Responsive;
01409 
01410 <span class="preprocessor">#if DBG</span>
01411 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Process) {
01412         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
01413     }
01414     <span class="keywordflow">else</span> {
01415         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 1);
01416     }
01417 <span class="preprocessor">#endif</span>
01418 <span class="preprocessor"></span>
01419     <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.TrimHard == 1 &amp;&amp; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>) {
01420         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01421     }
01422 
01423 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
01424 <span class="preprocessor"></span>
01425     <span class="comment">//</span>
01426     <span class="comment">// Always trim if there's anything left.  Note that the</span>
01427     <span class="comment">// foreground process is given priority by putting it last in the</span>
01428     <span class="comment">// working set list and stopping trimming when we have enough pages.</span>
01429     <span class="comment">//</span>
01430 
01431     <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &lt;= 3) {
01432         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01433     }
01434 
01435     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01436 <span class="preprocessor">#else</span>
01437 <span class="preprocessor"></span>
01438     Trim = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01439     Reset = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01440 
01441     <span class="keywordflow">if</span> (Process &amp;&amp; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o12">MemoryPriority</a> == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a> &amp;&amp; Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.NumPasses == 0) {
01442 
01443         Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.NumberOfForegroundProcesses += 1;
01444     }
01445 
01446     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> &gt;= <a class="code" href="../../d5/d0/wsmanage_8c.html#a0">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>) {
01447 
01448         <span class="comment">//</span>
01449         <span class="comment">// This is a voluntary trim so don't trim if </span>
01450         <span class="comment">//  - the page fault count is too high</span>
01451         <span class="comment">//  - or the size is too small</span>
01452         <span class="comment">//  - or not enough time has elapsed since it was last trimmed</span>
01453         <span class="comment">//</span>
01454 
01455         <span class="keywordflow">if</span> (((VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a> - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a>) &gt;
01456                                                Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.FaultCount)
01457                                 ||
01458               (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &lt;= 5)
01459 
01460                                 ||
01461               ((CurrentTime-&gt;QuadPart - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a>.QuadPart) &lt;
01462                         <a class="code" href="../../d4/d8/mi_8h.html#a417">MmWorkingSetProtectionTime</a>.QuadPart)) {
01463 
01464 <span class="preprocessor">#if DBG</span>
01465 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a60">MM_DBG_WS_EXPANSION</a>) {
01466                 <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; 5) {
01467 
01468                     <span class="keywordflow">if</span> (Process) {
01469                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"     ***** Skipping Process %16s %5d Faults, WS %6d\n"</span>,
01470                         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o65">ImageFileName</a>,
01471                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a> - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a>,
01472                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>
01473                         );
01474                     }
01475                     <span class="keywordflow">else</span> {
01476                         <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace;
01477 
01478                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01479                         SessionSpace = CONTAINING_RECORD(VmSupport,
01480                                                          <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">MM_SESSION_SPACE</a>,
01481                                                          Vm);
01482 
01483                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"     ***** Skipping Session %d %5d Faults, WS %6d\n"</span>,
01484                         SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
01485                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a> - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a>,
01486                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>
01487                         );
01488                     }
01489                 }
01490             }
01491 <span class="preprocessor">#endif //DBG</span>
01492 <span class="preprocessor"></span>
01493             Reset = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01494             Trim = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01495         }
01496     } <span class="keywordflow">else</span> {
01497 
01498         <span class="comment">//</span>
01499         <span class="comment">// This is a forced trim.  If this process is above its</span>
01500         <span class="comment">// minimum it's a candidate.</span>
01501         <span class="comment">//</span>
01502 
01503         <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &lt;= VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>) {
01504 
01505             <span class="comment">//</span>
01506             <span class="comment">// If this process is below its minimum, don't trim it</span>
01507             <span class="comment">// unless stacks are swapped out or it's paging a bit.</span>
01508             <span class="comment">//</span>
01509 
01510             <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> + 5) &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a>) &amp;&amp;
01511                  (((VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a> !=
01512                                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>) ||
01513                   (Process &amp;&amp; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)))) {
01514 
01515                 <span class="comment">//</span>
01516                 <span class="comment">// If we've almost reached our goal and either this process</span>
01517                 <span class="comment">// has taken page faults since the last trim or it's</span>
01518                 <span class="comment">// not swap enabled, then don't trim it but do reset it.</span>
01519                 <span class="comment">//</span>
01520 
01521                 Reset = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01522                 Trim = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01523             } 
01524             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &lt; 5) ||
01525                     ((CurrentTime-&gt;QuadPart - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a>.QuadPart) &lt;
01526                           <a class="code" href="../../d4/d8/mi_8h.html#a417">MmWorkingSetProtectionTime</a>.QuadPart)) {
01527 
01528                 <span class="comment">//</span>
01529                 <span class="comment">// If the working set is very small or it was trimmed</span>
01530                 <span class="comment">// recently don't trim it again.</span>
01531                 <span class="comment">//</span>
01532     
01533                 Reset = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01534                 Trim = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01535             }
01536         }
01537     }
01538 
01539     <span class="keywordflow">if</span> (Trim == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01540     
01541         <span class="comment">//</span>
01542         <span class="comment">// Fix to supply foreground responsiveness by not trimming</span>
01543         <span class="comment">// foreground priority applications as aggressively.</span>
01544         <span class="comment">//</span>
01545     
01546         Responsive = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01547     
01548         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d0/wsmanage_8c.html#a22">MmNumberOfForegroundProcesses</a> &lt;= 3) &amp;&amp;
01549             (Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.NumberOfForegroundProcesses &lt;= 3) &amp;&amp;
01550             (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o12">MemoryPriority</a>)) {
01551     
01552             <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; (<a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a> &gt;&gt; 2)) ||
01553                (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o12">MemoryPriority</a> &gt;= <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>)) {
01554 
01555                 <span class="comment">//</span>
01556                 <span class="comment">// Indicate that memory responsiveness to the foreground</span>
01557                 <span class="comment">// process is important (not so for large console trees).</span>
01558                 <span class="comment">//</span>
01559     
01560                 Responsive = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01561             }
01562         }
01563     
01564         <span class="keywordflow">if</span> (Responsive == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.NumPasses == 0) {
01565     
01566             <span class="comment">//</span>
01567             <span class="comment">// Note that NumPasses yields a measurement of how</span>
01568             <span class="comment">// desperate we are for memory, if NumPasses is nonzero,</span>
01569             <span class="comment">// we are in trouble.</span>
01570             <span class="comment">//</span>
01571     
01572             Trim = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01573         }
01574     }
01575 
01576     <span class="keywordflow">if</span> (Trim == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01577         <span class="keywordflow">if</span> (Reset == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01578             VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a> = *CurrentTime;
01579             VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
01580         }
01581 
01582         <a class="code" href="../../d2/d1/mm_8h.html#a108">PERFINFO_WSMANAGE_PROCESS_RESET</a>(VmSupport);
01583     }
01584 
01585     <span class="keywordflow">return</span> Trim;
01586 <span class="preprocessor">#endif</span>
01587 <span class="preprocessor"></span>}
01588 <span class="preprocessor">#ifndef _MI_USE_CLAIMS_</span>
01589 <span class="preprocessor"></span>
01590 LOGICAL
<a name="l01591"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a45">01591</a> <a class="code" href="../../d5/d0/wsmanage_8c.html#a45">MiCheckSystemCacheWsTrimCriteria</a>(
01592     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport
01593     )
01594 
01595 <span class="comment">/*++</span>
01596 <span class="comment"></span>
01597 <span class="comment">Routine Description:</span>
01598 <span class="comment"></span>
01599 <span class="comment">     Determine whether the system cache should be trimmed</span>
01600 <span class="comment"></span>
01601 <span class="comment">Arguments:</span>
01602 <span class="comment"></span>
01603 <span class="comment">    VmSupport - Supplies the working set information for the system cache.</span>
01604 <span class="comment"></span>
01605 <span class="comment">Return Value:</span>
01606 <span class="comment"></span>
01607 <span class="comment">    TRUE if trimming should be done on this process, FALSE otherwise.</span>
01608 <span class="comment"></span>
01609 <span class="comment">Environment:</span>
01610 <span class="comment"></span>
01611 <span class="comment">    Kernel mode.  Expansion lock held.  APC level or below.</span>
01612 <span class="comment"></span>
01613 <span class="comment">--*/</span>
01614 
01615 {
01616     LOGICAL Trim;
01617 
01618     <span class="comment">//</span>
01619     <span class="comment">// Don't trim the system cache if this is a voluntary trim and</span>
01620     <span class="comment">// the working set is within 100 pages of the minimum or</span>
01621     <span class="comment">// if the cache is at its minimum.</span>
01622     <span class="comment">//</span>
01623 
01624     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> &gt;= <a class="code" href="../../d5/d0/wsmanage_8c.html#a0">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>) &amp;&amp;
01625         (((LONG)VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> -
01626             (LONG)VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>) &lt; 100)) {
01627 
01628         <span class="comment">//</span>
01629         <span class="comment">// Don't trim it if it's near its minimum and it's not a forced trim.</span>
01630         <span class="comment">//</span>
01631 
01632         Trim = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01633     }
01634     <span class="keywordflow">else</span> {
01635         Trim = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01636     }
01637 
01638     <span class="keywordflow">return</span> Trim;
01639 }
01640 <span class="preprocessor">#endif</span>
01641 <span class="preprocessor"></span>
01642 
01643 ULONG
<a name="l01644"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a46">01644</a> <a class="code" href="../../d5/d0/wsmanage_8c.html#a46">MiDetermineWsTrimAmount</a>(
01645     PMMWS_TRIM_CRITERIA Criteria,
01646     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport,
01647     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01648     )
01649 
01650 <span class="comment">/*++</span>
01651 <span class="comment"></span>
01652 <span class="comment">Routine Description:</span>
01653 <span class="comment"></span>
01654 <span class="comment">     Determine whether this process should be trimmed.</span>
01655 <span class="comment"></span>
01656 <span class="comment">Arguments:</span>
01657 <span class="comment"></span>
01658 <span class="comment">    Criteria - Supplies the trim criteria information.</span>
01659 <span class="comment"></span>
01660 <span class="comment">    VmSupport - Supplies the working set information for the candidate process.</span>
01661 <span class="comment"></span>
01662 <span class="comment">    Process - Supplies the candidate process to be trimmed.</span>
01663 <span class="comment"></span>
01664 <span class="comment">Return Value:</span>
01665 <span class="comment"></span>
01666 <span class="comment">    TRUE if trimming should be done on this process, FALSE if not.</span>
01667 <span class="comment"></span>
01668 <span class="comment">Environment:</span>
01669 <span class="comment"></span>
01670 <span class="comment">    Kernel mode.  Expansion lock held.  APC level or below.</span>
01671 <span class="comment"></span>
01672 <span class="comment">--*/</span>
01673 
01674 {
01675     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
01676     ULONG MaxTrim;
01677     ULONG Trim;
01678     BOOLEAN OutswapEnabled;
01679 
01680     <span class="keywordflow">if</span> (Process) {
01681         OutswapEnabled = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a>;
01682     }
01683     <span class="keywordflow">else</span> {
01684         <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.TrimHard == 1) {
01685             OutswapEnabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01686         }
01687         <span class="keywordflow">else</span> {
01688             OutswapEnabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01689         }
01690     }
01691 
01692     WorkingSetList = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>;
01693 
01694     <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
01695         <span class="keywordflow">return</span> 0;
01696     }
01697 
01698 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
01699 <span class="preprocessor"></span>    MaxTrim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>;
01700 
01701     <span class="keywordflow">if</span> (OutswapEnabled == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01702         
01703         <span class="comment">//</span>
01704         <span class="comment">// Don't trim the cache or non-swapped sessions or processes</span>
01705         <span class="comment">// below their minimum.</span>
01706         <span class="comment">//</span>
01707 
01708         MaxTrim -= VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
01709     }
01710 
01711     <span class="keywordflow">switch</span> (Criteria-&gt;ClaimBased.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o0">NumPasses</a>) {
01712     <span class="keywordflow">case</span> 0:
01713         Trim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a> &gt;&gt; 
01714                     ((VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o12">MemoryPriority</a> == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>)
01715                         ? <a class="code" href="../../d4/d8/mi_8h.html#a206">MI_FOREGROUND_CLAIM_AVAILABLE_SHIFT</a>
01716                         : <a class="code" href="../../d4/d8/mi_8h.html#a207">MI_BACKGROUND_CLAIM_AVAILABLE_SHIFT</a>);
01717         Criteria-&gt;ClaimBased.TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a200">MI_PASS0_TRIM_AGE</a>;
01718         Criteria-&gt;ClaimBased.DoAging = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01719         <span class="keywordflow">break</span>;
01720     <span class="keywordflow">case</span> 1:
01721         Trim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a> &gt;&gt; 
01722                     ((VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o12">MemoryPriority</a> == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>)
01723                         ? <a class="code" href="../../d4/d8/mi_8h.html#a206">MI_FOREGROUND_CLAIM_AVAILABLE_SHIFT</a>
01724                         : <a class="code" href="../../d4/d8/mi_8h.html#a207">MI_BACKGROUND_CLAIM_AVAILABLE_SHIFT</a>);
01725         Criteria-&gt;ClaimBased.TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a201">MI_PASS1_TRIM_AGE</a>;
01726         Criteria-&gt;ClaimBased.DoAging = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01727         <span class="keywordflow">break</span>;
01728     <span class="keywordflow">case</span> 2:
01729         Trim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a>;
01730         Criteria-&gt;ClaimBased.TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a202">MI_PASS2_TRIM_AGE</a>;
01731         Criteria-&gt;ClaimBased.DoAging = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01732         <span class="keywordflow">break</span>;
01733     <span class="keywordflow">case</span> 3:
01734         Trim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o19">EstimatedAvailable</a>;
01735         Criteria-&gt;ClaimBased.TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a203">MI_PASS3_TRIM_AGE</a>;
01736         Criteria-&gt;ClaimBased.DoAging = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01737         <span class="keywordflow">break</span>;
01738     <span class="keywordflow">default</span>:
01739         Trim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o19">EstimatedAvailable</a>;
01740         Criteria-&gt;ClaimBased.TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a203">MI_PASS3_TRIM_AGE</a>;
01741         Criteria-&gt;ClaimBased.DoAging = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01742 
01743         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 100) {
01744             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>) {
01745                 Trim = (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>) &gt;&gt; 2;
01746             }
01747             Criteria-&gt;ClaimBased.TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a204">MI_PASS4_TRIM_AGE</a>;
01748             Criteria-&gt;ClaimBased.DoAging = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01749         }
01750 
01751         <span class="keywordflow">break</span>;
01752     }
01753 
01754     <span class="keywordflow">if</span> (Trim &gt; MaxTrim) {
01755         Trim = MaxTrim;
01756     }
01757 
01758 <span class="preprocessor">#else</span>
01759 <span class="preprocessor"></span>
01760     UNREFERENCED_PARAMETER (Criteria);
01761 
01762     <span class="comment">//</span>
01763     <span class="comment">// Calculate Trim size.</span>
01764     <span class="comment">//</span>
01765 
01766     <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &lt;= VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> &amp;&amp;
01767         OutswapEnabled == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01768 
01769         <span class="comment">//</span>
01770         <span class="comment">// Set the quota to the minimum and reduce the working</span>
01771         <span class="comment">// set size.</span>
01772         <span class="comment">//</span>
01773 
01774         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
01775         Trim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> - WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
01776         <span class="keywordflow">if</span> (Trim &gt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a20">MmWorkingSetSwapReduction</a>) {
01777             Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a20">MmWorkingSetSwapReduction</a>;
01778         }
01779 
01780         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)Trim &gt;= 0);
01781 
01782     } <span class="keywordflow">else</span> {
01783 
01784         MaxTrim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> -
01785                                      VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
01786 
01787         <span class="keywordflow">if</span> (OutswapEnabled == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01788 
01789             <span class="comment">//</span>
01790             <span class="comment">// All thread stacks have been swapped out this process or</span>
01791             <span class="comment">// all the processes and threads have been swapped out of this</span>
01792             <span class="comment">// session.</span>
01793             <span class="comment">//</span>
01794 
01795             ULONG i;
01796 
01797             Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a20">MmWorkingSetSwapReduction</a>;
01798             i = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a>;
01799             <span class="keywordflow">if</span> ((LONG)i &gt; 0) {
01800                 Trim = i;
01801                 <span class="keywordflow">if</span> (Trim &gt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a21">MmWorkingSetSwapReductionHuge</a>) {
01802                     Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a21">MmWorkingSetSwapReductionHuge</a>;
01803                 }
01804             }
01805 
01806         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> &gt;= <a class="code" href="../../d5/d0/wsmanage_8c.html#a0">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>) {
01807 
01808             <span class="comment">//</span>
01809             <span class="comment">// Haven't faulted much, reduce a bit.</span>
01810             <span class="comment">//</span>
01811 
01812             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt;
01813                   (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> +
01814                             (6 * <a class="code" href="../../d5/d0/wsmanage_8c.html#a19">MmWorkingSetVolReductionHuge</a>))) {
01815                 Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a19">MmWorkingSetVolReductionHuge</a>;
01816 
01817             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) &amp;&amp;
01818                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt;
01819                         ( VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> + (2 * <a class="code" href="../../d5/d0/wsmanage_8c.html#a15">MmWorkingSetReductionHuge</a>))) {
01820                 Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a15">MmWorkingSetReductionHuge</a>;
01821             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a>) {
01822                 <span class="keywordflow">if</span> (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
01823                     Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a17">MmWorkingSetVolReductionMax</a>;
01824                 } <span class="keywordflow">else</span> {
01825                     Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a18">MmWorkingSetVolReductionMaxCacheWs</a>;
01826                 }
01827             } <span class="keywordflow">else</span> {
01828                 Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a16">MmWorkingSetVolReductionMin</a>;
01829             }
01830 
01831         } <span class="keywordflow">else</span> {
01832 
01833             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt;
01834                   (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> +
01835                             (2 * <a class="code" href="../../d5/d0/wsmanage_8c.html#a15">MmWorkingSetReductionHuge</a>))) {
01836                 Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a15">MmWorkingSetReductionHuge</a>;
01837 
01838             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a>) {
01839                 <span class="keywordflow">if</span> (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
01840                     Trim = <a class="code" href="../../d4/d5/procsup_8c.html#a6">MmWorkingSetReductionMax</a>;
01841                 } <span class="keywordflow">else</span> {
01842                     Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a14">MmWorkingSetReductionMaxCacheWs</a>;
01843                 }
01844             } <span class="keywordflow">else</span> {
01845                 <span class="keywordflow">if</span> (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
01846                     Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a11">MmWorkingSetReductionMin</a>;
01847                 } <span class="keywordflow">else</span> {
01848                     Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a12">MmWorkingSetReductionMinCacheWs</a>;
01849                 }
01850             }
01851         }
01852 
01853         <span class="keywordflow">if</span> (MaxTrim &lt; Trim) {
01854             Trim = MaxTrim;
01855         }
01856     }
01857 <span class="preprocessor">#endif</span>
01858 <span class="preprocessor"></span>
01859     <span class="keywordflow">return</span> Trim;
01860 }
01861 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
01862 <span class="preprocessor"></span>
01863 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01864 MiAgePagesAndEstimateClaims(
01865     VOID
01866     )
01867 
01868 <span class="comment">/*++</span>
01869 <span class="comment"></span>
01870 <span class="comment">Routine Description:</span>
01871 <span class="comment"></span>
01872 <span class="comment">    Walk through the processes on the working set expansion list</span>
01873 <span class="comment">    aging pages and estimating the number of pages that they</span>
01874 <span class="comment">    aren't using, the claim.</span>
01875 <span class="comment">    </span>
01876 <span class="comment">Arguments:</span>
01877 <span class="comment"></span>
01878 <span class="comment">    None.</span>
01879 <span class="comment"></span>
01880 <span class="comment">Return Value:</span>
01881 <span class="comment"></span>
01882 <span class="comment">    None.</span>
01883 <span class="comment"></span>
01884 <span class="comment">Environment:</span>
01885 <span class="comment"></span>
01886 <span class="comment">    Kernel mode, APCs disabled.  PFN lock NOT held.</span>
01887 <span class="comment"></span>
01888 <span class="comment">--*/</span>
01889 
01890 {
01891     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01892     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport;
01893     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> FirstSeen;
01894     BOOLEAN SystemCacheSeen;
01895     LOGICAL Attached;
01896     BOOLEAN Locked;
01897     KIRQL OldIrql;
01898     PLIST_ENTRY ListEntry;
01899     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01900     ULONG NewTotalClaim;
01901     ULONG NewTotalEstimatedAvailable;
01902     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
01903     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace;
01904     LOGICAL InformSessionOfRelease;
01905     ULONG LoopCount;
01906 
01907     FirstSeen = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01908     SystemCacheSeen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01909     Attached = 0;
01910     Locked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01911     NewTotalClaim = 0;
01912     NewTotalEstimatedAvailable = 0;
01913     status = STATUS_SUCCESS;
01914     LoopCount = 0;
01915 
01916     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
01917 
01918     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == FALSE || MmIsAddressValid (MmSessionSpace) == FALSE);
01919 
01920     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01921 
01922     <span class="keywordflow">while</span> (!IsListEmpty (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>)) {
01923 
01924         <span class="comment">//</span>
01925         <span class="comment">// Remove the entry at the head, try to lock it, if we can lock it</span>
01926         <span class="comment">// then age some pages and estimate the number of available pages.</span>
01927         <span class="comment">//</span>
01928 
01929         ListEntry = RemoveHeadList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>);
01930 
01931         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == FALSE || MmIsAddressValid (MmSessionSpace) == FALSE);
01932 
01933         <span class="keywordflow">if</span> (ListEntry == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>) {
01934             VmSupport = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
01935             Process = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01936             <span class="keywordflow">if</span> (SystemCacheSeen != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01937             
01938                 <span class="comment">//</span>
01939                 <span class="comment">// Seen this one already.</span>
01940                 <span class="comment">//</span>
01941             
01942                 FirstSeen = VmSupport;
01943             }
01944             SystemCacheSeen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01945         }
01946         <span class="keywordflow">else</span> {
01947             VmSupport = CONTAINING_RECORD(ListEntry,
01948                                           <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">MMSUPPORT</a>,
01949                                           WorkingSetExpansionLinks);
01950 
01951             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
01952 
01953                 Process = CONTAINING_RECORD(ListEntry,
01954                                                   <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,
01955                                                   Vm.WorkingSetExpansionLinks);
01956                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> == 0);
01957                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a> == MmWorkingSetList);
01958             }
01959             <span class="keywordflow">else</span> {
01960                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
01961                 SessionSpace = CONTAINING_RECORD(VmSupport,
01962                                                  <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">MM_SESSION_SPACE</a>,
01963                                                  Vm);
01964 
01965                 Process = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01966             }
01967         }
01968 
01969         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 0);
01970 
01971         <span class="keywordflow">if</span> (VmSupport == FirstSeen) {
01972             InsertHeadList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
01973                        &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
01974             <span class="keywordflow">break</span>;
01975         }
01976 
01977         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 1;
01978 
01979         <span class="keywordflow">if</span> (FirstSeen == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01980             FirstSeen = VmSupport;
01981         }
01982 
01983         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
01984         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink =
01985                                            <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>;
01986         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01987 
01988         Locked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01989         <span class="keywordflow">if</span> (VmSupport == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
01990             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;OldIrql);
01991             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a> (&amp;MmSystemWsLock)) {
01992                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
01993                 <span class="keywordflow">goto</span> FailureBranch;
01994             }
01995             <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01996             Locked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01997         }
01998         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
01999             InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02000             <span class="keywordflow">if</span> (CurrentProcess != Process) {
02001                 Attached = <a class="code" href="../../d3/d5/procobj_8c.html#a5">KeForceAttachProcess</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
02002                 <span class="keywordflow">if</span> (Attached == 0) {
02003                     <span class="keywordflow">goto</span> FailureBranch;
02004                 }
02005                 <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02006                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o25">ProcessOutswapped</a> == FALSE);
02007                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession == 1 &amp;&amp; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionLeader == 0) {
02008                         InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02009                     }
02010                 }
02011             }
02012             <span class="keywordflow">if</span> (ExTryToAcquireFastMutex(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o22">WorkingSetLock</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02013 
02014                 <span class="keywordflow">if</span> (InformSessionOfRelease == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02015                     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02016                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> == TRUE);
02017                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02018                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &gt;= 1);
02019                     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> -= 1;
02020                     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02021                     InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02022                 }
02023 
02024                 <span class="keywordflow">if</span> (Attached) {
02025                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
02026                     Attached = 0;
02027                 }
02028                 <span class="keywordflow">goto</span> FailureBranch;
02029             }
02030 
02031             Locked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02032         }
02033         <span class="keywordflow">else</span> {
02034 
02035             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
02036 
02037             <span class="comment">//</span>
02038             <span class="comment">// Attach directly to the session space to be trimmed.</span>
02039             <span class="comment">//</span>
02040 
02041             <a class="code" href="../../d3/d7/session_8c.html#a16">MiAttachSession</a> (SessionSpace);
02042 
02043             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;OldIrql);
02044             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a> (&amp;SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o32">WsLock</a>)) {
02045     
02046                 <span class="comment">//</span>
02047                 <span class="comment">// This session space's working set lock was not</span>
02048                 <span class="comment">// granted, don't trim it.</span>
02049                 <span class="comment">//</span>
02050     
02051                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
02052     
02053                 <a class="code" href="../../d3/d7/session_8c.html#a17">MiDetachSession</a> ();
02054 
02055                 <span class="keywordflow">goto</span> FailureBranch;
02056             }
02057     
02058             Locked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02059 
02060             <a class="code" href="../../d4/d8/mi_8h.html#a404">MM_SET_SESSION_RESOURCE_OWNER</a>();
02061         }
02062 
02063 FailureBranch:
02064 
02065         <span class="keywordflow">if</span> (Locked) {
02066             MiAgeAndEstimateAvailableInWorkingSet (VmSupport,
02067                                                    TRUE,
02068                                                    &amp;NewTotalClaim,
02069                                                    &amp;NewTotalEstimatedAvailable
02070                                                    );
02071     
02072             <span class="keywordflow">if</span> (VmSupport == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
02073                <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
02074                <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql);
02075             }
02076             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
02077 
02078                 <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
02079 
02080                 <span class="keywordflow">if</span> (InformSessionOfRelease == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02081                     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02082                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> == TRUE);
02083                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02084                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &gt;= 1);
02085                     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> -= 1;
02086                     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02087                     InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02088                 }
02089 
02090                 <span class="keywordflow">if</span> (Attached) {
02091                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
02092                     Attached = 0;
02093                 }
02094             }
02095             <span class="keywordflow">else</span> {
02096                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
02097                 <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
02098 
02099                 <a class="code" href="../../d3/d7/session_8c.html#a17">MiDetachSession</a> ();
02100             }
02101         }
02102 
02103         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02104 
02105         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 1);
02106         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
02107 
02108         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink == MM_NO_WS_EXPANSION);
02109         <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink ==
02110                                              <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>) {
02111 
02112             <span class="comment">//</span>
02113             <span class="comment">// If the working set size is still above the minimum,</span>
02114             <span class="comment">// add this back at the tail of the list.</span>
02115             <span class="comment">//</span>
02116 
02117             InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
02118                             &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
02119         }
02120         <span class="keywordflow">else</span> {
02121 
02122             <span class="comment">//</span>
02123             <span class="comment">// The value in the blink is the address of an event</span>
02124             <span class="comment">// to set.</span>
02125             <span class="comment">//</span>
02126 
02127             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport != &amp;MmSystemCacheWs);
02128 
02129             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> ((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink,
02130                         0,
02131                         FALSE);
02132         }
02133 
02134         <span class="comment">//</span>
02135         <span class="comment">// The initial working set that was chosen for FirstSeen may have</span>
02136         <span class="comment">// been trimmed down under its minimum and been removed from the</span>
02137         <span class="comment">// ExpansionHead links.  It is possible that the system cache is not</span>
02138         <span class="comment">// on the links either.  This check detects this extremely rare</span>
02139         <span class="comment">// situation so that the system does not spin forever.</span>
02140         <span class="comment">//</span>
02141 
02142         LoopCount += 1;
02143         <span class="keywordflow">if</span> (LoopCount &gt; 200) {
02144             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink == <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>) {
02145                 <span class="keywordflow">break</span>;
02146             }
02147         }
02148     }
02149 
02150     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a>(OldIrql);
02151 
02152     MmTotalClaim = NewTotalClaim;
02153     MmTotalEstimatedAvailable = NewTotalEstimatedAvailable;
02154 
02155 }
02156 
02157 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02158 MiAgeAndEstimateAvailableInWorkingSet(
02159     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport,
02160     IN BOOLEAN DoAging,
02161     IN OUT PULONG TotalClaim,
02162     IN OUT PULONG TotalEstimatedAvailable
02163     )
02164 
02165 <span class="comment">/*++</span>
02166 <span class="comment"></span>
02167 <span class="comment">Routine Description:</span>
02168 <span class="comment"></span>
02169 <span class="comment">    Age pages (clear the access bit or if the page hasn't been</span>
02170 <span class="comment">    accessed, increment the age) for a portion of the working</span>
02171 <span class="comment">    set.  Also, walk through a sample of the working set</span>
02172 <span class="comment">    building a set of counts of how old the pages are.</span>
02173 <span class="comment">    </span>
02174 <span class="comment">    The counts are used to create a claim of the amount</span>
02175 <span class="comment">    the system can steal from this process if memory</span>
02176 <span class="comment">    becomes tight.</span>
02177 <span class="comment"></span>
02178 <span class="comment">Arguments:</span>
02179 <span class="comment"></span>
02180 <span class="comment">    VmSupport - Supplies the VM support structure to age and estimate.</span>
02181 <span class="comment"></span>
02182 <span class="comment">    DoAging - TRUE if pages are to be aged.  Regardless, the pages will be</span>
02183 <span class="comment">              added to the availablity estimation.</span>
02184 <span class="comment"></span>
02185 <span class="comment">    TotalClaim - Supplies a pointer to system wide claim to update.</span>
02186 <span class="comment"></span>
02187 <span class="comment">    TotalEstimatedAvailable - Supplies a pointer to system wide estimate</span>
02188 <span class="comment">                              to update.</span>
02189 <span class="comment"></span>
02190 <span class="comment">Return Value:</span>
02191 <span class="comment"></span>
02192 <span class="comment">    None</span>
02193 <span class="comment"></span>
02194 <span class="comment">Environment:</span>
02195 <span class="comment"></span>
02196 <span class="comment">    Kernel mode, APCs disabled, working set lock.  PFN lock NOT held.</span>
02197 <span class="comment"></span>
02198 <span class="comment">--*/</span>
02199 
02200 {
02201     ULONG LastEntry;
02202     ULONG StartEntry;
02203     ULONG FirstDynamic;
02204     ULONG CurrentEntry;
02205     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
02206     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
02207     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02208     ULONG NumberToExamine;
02209     ULONG Claim;
02210     ULONG Estimate;
02211     ULONG SampledAgeCounts[<a class="code" href="../../d4/d8/mi_8h.html#a193">MI_USE_AGE_COUNT</a>] = {0};
02212     <a class="code" href="../../d2/d9/struct__MI__NEXT__ESTIMATION__SLOT__CONST.html">MI_NEXT_ESTIMATION_SLOT_CONST</a> NextConst;
02213 
02214     WorkingSetList = VmSupport-&gt;VmWorkingSetList;
02215     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
02216 
02217 <span class="preprocessor">#if DBG</span>
02218 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (VmSupport == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
02219         <a class="code" href="../../d4/d8/mi_8h.html#a147">MM_SYSTEM_WS_LOCK_ASSERT</a>();
02220     }
02221 <span class="preprocessor">#endif //DBG</span>
02222 <span class="preprocessor"></span>
02223     LastEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
02224     FirstDynamic = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
02225 
02226     <span class="keywordflow">if</span> (DoAging == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02227 
02228         <span class="comment">//</span>
02229         <span class="comment">// Clear the used bits or increment the age of a</span>
02230         <span class="comment">// portion of the working set.</span>
02231         <span class="comment">//</span>
02232         <span class="comment">// In Usage Estimation/WorkingSet Aging, walk the entire</span>
02233         <span class="comment">// working set every 2^MI_AGE_AGING_SHIFT seconds.</span>
02234         <span class="comment">//</span>
02235 
02236         <span class="keywordflow">if</span> (VmSupport-&gt;WorkingSetSize &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
02237             NumberToExamine = (VmSupport-&gt;WorkingSetSize - WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) &gt;&gt; MiAgingShift;
02238         }
02239         <span class="keywordflow">else</span> {
02240             NumberToExamine = 0;
02241         }
02242 
02243         <span class="keywordflow">if</span> (NumberToExamine != 0) {
02244 
02245             CurrentEntry = VmSupport-&gt;NextAgingSlot;
02246 
02247             <span class="keywordflow">if</span> (CurrentEntry &gt; LastEntry || CurrentEntry &lt; FirstDynamic) {
02248                 CurrentEntry = FirstDynamic;
02249             }
02250     
02251             <span class="keywordflow">if</span> (Wsle[CurrentEntry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 0) {
02252                 <a class="code" href="../../d4/d8/mi_8h.html#a210">MI_NEXT_VALID_AGING_SLOT</a>(CurrentEntry, FirstDynamic, LastEntry, Wsle);
02253             }
02254     
02255             <span class="keywordflow">while</span> (NumberToExamine != 0) {
02256         
02257                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Wsle[CurrentEntry].u1.VirtualAddress);
02258         
02259                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a138">MI_GET_ACCESSED_IN_PTE</a>(PointerPte) == 1) {
02260                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a137">MI_SET_ACCESSED_IN_PTE</a>(PointerPte, 0);
02261                     <a class="code" href="../../d4/d8/mi_8h.html#a212">MI_RESET_WSLE_AGE</a>(PointerPte, &amp;Wsle[CurrentEntry]);
02262                 }
02263                 <span class="keywordflow">else</span> {
02264                     <a class="code" href="../../d4/d8/mi_8h.html#a214">MI_INC_WSLE_AGE</a>(PointerPte, &amp;Wsle[CurrentEntry]);
02265                 }
02266         
02267                 NumberToExamine -= 1;
02268                 <a class="code" href="../../d4/d8/mi_8h.html#a210">MI_NEXT_VALID_AGING_SLOT</a>(CurrentEntry, FirstDynamic, LastEntry, Wsle);
02269             }
02270     
02271             VmSupport-&gt;NextAgingSlot = CurrentEntry + 1; <span class="comment">// Start here next time</span>
02272         }
02273     }
02274 
02275     <span class="comment">//</span>
02276     <span class="comment">// Estimate the number of unused pages in the working set.</span>
02277     <span class="comment">//</span>
02278     <span class="comment">// The working set may have shrunk or the non-paged portion may have</span>
02279     <span class="comment">// grown since the last time.  Put the next counter at the FirstDynamic</span>
02280     <span class="comment">// if so.</span>
02281     <span class="comment">//</span>
02282 
02283     CurrentEntry = VmSupport-&gt;NextEstimationSlot;
02284 
02285     <span class="keywordflow">if</span> (CurrentEntry &gt; LastEntry || CurrentEntry &lt; FirstDynamic) {
02286         CurrentEntry = FirstDynamic;
02287     }
02288 
02289     <span class="comment">//</span>
02290     <span class="comment">// In Usage Estimation/WorkingSet Aging, walk the entire</span>
02291     <span class="comment">// working set every 2^MiEstimationShift seconds.</span>
02292     <span class="comment">//</span>
02293 
02294     <span class="keywordflow">if</span> (VmSupport-&gt;WorkingSetSize &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
02295         NumberToExamine = (VmSupport-&gt;WorkingSetSize - WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) &gt;&gt; MiEstimationShift;
02296     }
02297     <span class="keywordflow">else</span> {
02298         NumberToExamine = 0;
02299     }
02300 
02301     <span class="keywordflow">if</span> (NumberToExamine != 0) {
02302 
02303         <a class="code" href="../../d4/d8/mi_8h.html#a208">MI_CALC_NEXT_ESTIMATION_SLOT_CONST</a>(NextConst, WorkingSetList);
02304 
02305         StartEntry = FirstDynamic;
02306 
02307         <span class="keywordflow">if</span> (Wsle[CurrentEntry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 0) {
02308 
02309             <a class="code" href="../../d4/d8/mi_8h.html#a209">MI_NEXT_VALID_ESTIMATION_SLOT</a> (CurrentEntry,
02310                                            StartEntry,
02311                                            FirstDynamic,
02312                                            LastEntry,
02313                                            NextConst,
02314                                            Wsle);
02315         }
02316     
02317         <span class="keywordflow">while</span> (NumberToExamine != 0) {
02318 
02319             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Wsle[CurrentEntry].u1.VirtualAddress);
02320     
02321             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a138">MI_GET_ACCESSED_IN_PTE</a>(PointerPte) == 0) {
02322                 <a class="code" href="../../d4/d8/mi_8h.html#a215">MI_UPDATE_USE_ESTIMATE</a>(PointerPte,
02323                                         &amp;Wsle[CurrentEntry],
02324                                         SampledAgeCounts
02325                                         );
02326             }
02327     
02328             NumberToExamine -= 1;
02329 
02330             <a class="code" href="../../d4/d8/mi_8h.html#a209">MI_NEXT_VALID_ESTIMATION_SLOT</a> (CurrentEntry,
02331                                            StartEntry,
02332                                            FirstDynamic,
02333                                            LastEntry,
02334                                            NextConst,
02335                                            Wsle);
02336         }
02337     }
02338     
02339     <span class="comment">//</span>
02340     <span class="comment">// Start estimation here next time.</span>
02341     <span class="comment">//</span>
02342 
02343     VmSupport-&gt;NextEstimationSlot = CurrentEntry + 1;
02344 
02345     Estimate = <a class="code" href="../../d4/d8/mi_8h.html#a211">MI_CALCULATE_USAGE_ESTIMATE</a>(SampledAgeCounts);
02346 
02347     Claim = VmSupport-&gt;Claim + MI_CLAIM_INCR;
02348 
02349     <span class="keywordflow">if</span> (Claim &gt; Estimate) {
02350         Claim = Estimate;
02351     }
02352 
02353     VmSupport-&gt;Claim = Claim;
02354     VmSupport-&gt;EstimatedAvailable = Estimate;
02355 
02356     <a class="code" href="../../d2/d1/mm_8h.html#a103">PERFINFO_WSMANAGE_DUMPWS</a>(VmSupport, SampledAgeCounts);
02357 
02358     VmSupport-&gt;GrowthSinceLastEstimate = 0;
02359     *TotalClaim += Claim &gt;&gt; ((VmSupport-&gt;MemoryPriority == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>)
02360                                 ? <a class="code" href="../../d4/d8/mi_8h.html#a206">MI_FOREGROUND_CLAIM_AVAILABLE_SHIFT</a>
02361                                 : <a class="code" href="../../d4/d8/mi_8h.html#a207">MI_BACKGROUND_CLAIM_AVAILABLE_SHIFT</a>);
02362 
02363     *TotalEstimatedAvailable += Estimate;
02364     <span class="keywordflow">return</span>;
02365 }
02366 
02367 ULONG MiClaimAdjustmentThreshold[7] = { 0, 0, 0, 1000, 2000, 4000, 8000};
02368 
02369 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02370 MiAdjustClaimParameters(
02371     BOOLEAN EnoughPages
02372     )
02373 
02374 <span class="comment">/*++</span>
02375 <span class="comment"></span>
02376 <span class="comment">Routine Description:</span>
02377 <span class="comment"></span>
02378 <span class="comment">    Adjust the rate at which we walk through working sets.  If we have</span>
02379 <span class="comment">    enough pages (we aren't trimming pages that aren't considered young),</span>
02380 <span class="comment">    then we check to see whether we should decrease the aging rate and</span>
02381 <span class="comment">    vice versa.</span>
02382 <span class="comment"></span>
02383 <span class="comment">    The limits for the aging rate are 1/8 and 1/128 of the working sets.</span>
02384 <span class="comment">    This means that the finest age granularities are 8 to 128 seconds in</span>
02385 <span class="comment">    these cases.  With the current 2 bit counter, at the low end we would</span>
02386 <span class="comment">    start trimming pages &gt; 16 seconds old and at the high end &gt; 4 minutes.</span>
02387 <span class="comment"></span>
02388 <span class="comment">Arguments:</span>
02389 <span class="comment"></span>
02390 <span class="comment">    EnoughPages - Supplies whether to increase the rate or decrease it.</span>
02391 <span class="comment"></span>
02392 <span class="comment">Return Value:</span>
02393 <span class="comment"></span>
02394 <span class="comment">    None.</span>
02395 <span class="comment"></span>
02396 <span class="comment">Environment:</span>
02397 <span class="comment"></span>
02398 <span class="comment">    Kernel mode.</span>
02399 <span class="comment"></span>
02400 <span class="comment">--*/</span>
02401 
02402 {
02403     LARGE_INTEGER CurrentTime;
02404 
02405     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;CurrentTime);
02406 
02407     <span class="keywordflow">if</span> (EnoughPages == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02408 
02409         <span class="comment">//</span>
02410         <span class="comment">// Don't adjust the rate too frequently, don't go over the limit, and</span>
02411         <span class="comment">// make sure there are enough claimed and/or available.</span>
02412         <span class="comment">//</span>
02413 
02414         <span class="keywordflow">if</span> (((CurrentTime.QuadPart - MiLastAdjustmentOfClaimParams.QuadPart) &gt;
02415                 MmClaimParameterAdjustUpTime.QuadPart) &amp;&amp;
02416             (MiAgingShift &lt; 7) &amp;&amp; 
02417             ((MmTotalClaim + <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a>) &gt; MiClaimAdjustmentThreshold[MiAgingShift])) {
02418 
02419             <span class="comment">//</span>
02420             <span class="comment">// Set the time only when we change the rate.</span>
02421             <span class="comment">//</span>
02422 
02423             MiLastAdjustmentOfClaimParams.QuadPart = CurrentTime.QuadPart;
02424 
02425             MiAgingShift += 1;
02426             MiEstimationShift += 1;
02427         }
02428     }
02429     <span class="keywordflow">else</span> {
02430 
02431         <span class="comment">//</span>
02432         <span class="comment">// Don't adjust the rate down too frequently.</span>
02433         <span class="comment">//</span>
02434 
02435         <span class="keywordflow">if</span> ((CurrentTime.QuadPart - MiLastAdjustmentOfClaimParams.QuadPart) &gt;
02436                 MmClaimParameterAdjustDownTime.QuadPart) {
02437             
02438             <span class="comment">//</span>
02439             <span class="comment">// Always set the time so we don't adjust up too soon after</span>
02440             <span class="comment">// a 2nd pass trim.</span>
02441             <span class="comment">//</span>
02442     
02443             MiLastAdjustmentOfClaimParams.QuadPart = CurrentTime.QuadPart;
02444 
02445             <span class="comment">//</span>
02446             <span class="comment">// Don't go under the limit.</span>
02447             <span class="comment">//</span>
02448 
02449             <span class="keywordflow">if</span> (MiAgingShift &gt; 3) {
02450                 MiAgingShift -= 1;
02451                 MiEstimationShift -= 1;
02452             }
02453         }
02454     }
02455 }
02456 <span class="preprocessor">#endif</span>
02457 <span class="preprocessor"></span>
<a name="l02458"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a3">02458</a> <span class="preprocessor">#define MM_WS_REORG_BUCKETS_MAX 7</span>
02459 <span class="preprocessor"></span>
02460 <span class="preprocessor">#if DBG</span>
02461 <span class="preprocessor"></span>ULONG MiSessionIdleBuckets[<a class="code" href="../../d5/d0/wsmanage_8c.html#a3">MM_WS_REORG_BUCKETS_MAX</a>];
02462 <span class="preprocessor">#endif</span>
02463 <span class="preprocessor"></span>
02464 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02465"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a38">02465</a> <a class="code" href="../../d5/d0/wsmanage_8c.html#a38">MiRearrangeWorkingSetExpansionList</a>(
02466     VOID
02467     )
02468 
02469 <span class="comment">/*++</span>
02470 <span class="comment"></span>
02471 <span class="comment">Routine Description:</span>
02472 <span class="comment"></span>
02473 <span class="comment">    This function arranges the working set list into different</span>
02474 <span class="comment">    groups based upon the claim.  This is done so the working set</span>
02475 <span class="comment">    trimming will take place on fat processes first.</span>
02476 <span class="comment"></span>
02477 <span class="comment">    The working sets are sorted into buckets and then linked back up.</span>
02478 <span class="comment"></span>
02479 <span class="comment">    Swapped out sessions and processes are put at the front.</span>
02480 <span class="comment"></span>
02481 <span class="comment">Arguments:</span>
02482 <span class="comment"></span>
02483 <span class="comment">    None.</span>
02484 <span class="comment"></span>
02485 <span class="comment">Return Value:</span>
02486 <span class="comment"></span>
02487 <span class="comment">    None.</span>
02488 <span class="comment"></span>
02489 <span class="comment">Environment:</span>
02490 <span class="comment"></span>
02491 <span class="comment">    Kernel mode, no locks held.</span>
02492 <span class="comment"></span>
02493 <span class="comment">--*/</span>
02494 
02495 {
02496     KIRQL OldIrql;
02497     PLIST_ENTRY ListEntry;
02498     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport;
02499     <span class="keywordtype">int</span> <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02500     <span class="keywordtype">int</span> PreviousNonEmpty;
02501     <span class="keywordtype">int</span> NonEmpty;
02502     LIST_ENTRY ListHead[<a class="code" href="../../d5/d0/wsmanage_8c.html#a3">MM_WS_REORG_BUCKETS_MAX</a>];
02503     LARGE_INTEGER CurrentTime;
02504     LARGE_INTEGER SessionIdleTime;
02505     ULONG IdleTime;
02506     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
02507 
02508     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;CurrentTime);
02509 
02510     <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>)) {
02511         <span class="keywordflow">return</span>;
02512     }
02513 
02514     <span class="keywordflow">for</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0 ; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a3">MM_WS_REORG_BUCKETS_MAX</a>; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>++) {
02515         InitializeListHead(&amp;ListHead[<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>]);
02516     }
02517 
02518     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02519 
02520     <span class="keywordflow">while</span> (!IsListEmpty (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>)) {
02521         ListEntry = RemoveHeadList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>);
02522 
02523         VmSupport = CONTAINING_RECORD(ListEntry,
02524                                           <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">MMSUPPORT</a>,
02525                                           WorkingSetExpansionLinks);
02526 
02527         <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.TrimHard == 1) {
02528 
02529             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02530             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 1);
02531 
02532             SessionGlobal = CONTAINING_RECORD (VmSupport,
02533                                                <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">MM_SESSION_SPACE</a>,
02534                                                Vm);
02535 
02536             SessionIdleTime.QuadPart = CurrentTime.QuadPart - SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o15">LastProcessSwappedOutTime</a>.QuadPart;
02537 
02538 <span class="preprocessor">#if DBG</span>
02539 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
02540                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Mm: Session %d heavily trim/aged - all its processes (%d) swapped out %d seconds ago\n"</span>,
02541                     SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
02542                     SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>,
02543                     (ULONG)(SessionIdleTime.QuadPart / 10000000));
02544             }
02545 <span class="preprocessor">#endif</span>
02546 <span class="preprocessor"></span>
02547             <span class="keywordflow">if</span> (SessionIdleTime.QuadPart &lt; 0) {
02548 
02549                 <span class="comment">//</span>
02550                 <span class="comment">// The administrator has moved the system time backwards.</span>
02551                 <span class="comment">// Give this session a fresh start.</span>
02552                 <span class="comment">//</span>
02553 
02554                 SessionIdleTime.QuadPart = 0;
02555                 <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o15">LastProcessSwappedOutTime</a>);
02556             }
02557 
02558             IdleTime = (ULONG) (SessionIdleTime.QuadPart / 10000000);
02559         }
02560         <span class="keywordflow">else</span> {
02561             IdleTime = 0;
02562         }
02563 
02564         <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o12">MemoryPriority</a> == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>) {
02565 
02566             <span class="comment">//</span>
02567             <span class="comment">// Put the foreground processes at the end of the list,</span>
02568             <span class="comment">// to give them priority.</span>
02569             <span class="comment">//</span>
02570 
02571             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 6;
02572         }
02573 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
02574 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
02575 
02576             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a> &gt; 400) {
02577                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
02578             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime &gt; 30) {
02579                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
02580 <span class="preprocessor">#if DBG</span>
02581 <span class="preprocessor"></span>                MiSessionIdleBuckets[<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>] += 1;
02582 <span class="preprocessor">#endif</span>
02583 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a> &gt; 200) {
02584                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 1;
02585             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime &gt; 20) {
02586                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 1;
02587 <span class="preprocessor">#if DBG</span>
02588 <span class="preprocessor"></span>                MiSessionIdleBuckets[<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>] += 1;
02589 <span class="preprocessor">#endif</span>
02590 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a> &gt; 100) {
02591                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 2;
02592             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime &gt; 10) {
02593                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 2;
02594 <span class="preprocessor">#if DBG</span>
02595 <span class="preprocessor"></span>                MiSessionIdleBuckets[<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>] += 1;
02596 <span class="preprocessor">#endif</span>
02597 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a> &gt; 50) {
02598                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 3;
02599             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime) {
02600                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 3;
02601 <span class="preprocessor">#if DBG</span>
02602 <span class="preprocessor"></span>                MiSessionIdleBuckets[<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>] += 1;
02603 <span class="preprocessor">#endif</span>
02604 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a> &gt; 25) {
02605                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 4;
02606             } <span class="keywordflow">else</span> {
02607                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 5;
02608 <span class="preprocessor">#if DBG</span>
02609 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 1) {
02610                     MiSessionIdleBuckets[<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>] += 1;
02611                 }
02612 <span class="preprocessor">#endif</span>
02613 <span class="preprocessor"></span>            }
02614         }
02615 <span class="preprocessor">#else</span>
02616 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
02617 
02618             <span class="comment">//</span>
02619             <span class="comment">// Just put swapped out entries at the front and keep all other</span>
02620             <span class="comment">// entries in the same order, just in front of the foreground</span>
02621             <span class="comment">// processes.</span>
02622             <span class="comment">//</span>
02623 
02624             <span class="keywordflow">if</span> (IdleTime &gt; 40) {
02625                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
02626             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime &gt; 30) {
02627                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 1;
02628             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime &gt; 20) {
02629                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 2;
02630             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime &gt; 10) {
02631                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 3;
02632             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime) {
02633                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 4;
02634             } <span class="keywordflow">else</span> {
02635                 InsertTailList (&amp;ListHead[5],
02636                                 &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
02637                 <span class="keywordflow">continue</span>;
02638             }
02639 <span class="preprocessor">#if DBG</span>
02640 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02641             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 1);
02642             MiSessionIdleBuckets[<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>] += 1;
02643 <span class="preprocessor">#endif</span>
02644 <span class="preprocessor"></span>        }
02645 <span class="preprocessor">#endif</span>
02646 <span class="preprocessor"></span>
02647 <span class="preprocessor">#if DBG</span>
02648 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a60">MM_DBG_WS_EXPANSION</a>) {
02649             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM-rearrange: TrimHard = %d, WS Size = 0x%x, Claim 0x%x, Bucket %d\n"</span>,
02650                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.TrimHard,
02651                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>,
02652                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a>,
02653                     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
02654         }
02655 <span class="preprocessor">#endif //DBG</span>
02656 <span class="preprocessor"></span>
02657         <span class="comment">//</span>
02658         <span class="comment">// Note: this reverses the bucket order each time we</span>
02659         <span class="comment">// reorganize the lists.  This may be good or bad -</span>
02660         <span class="comment">// if you change it you may want to think about it.</span>
02661         <span class="comment">//</span>
02662 
02663         InsertHeadList (&amp;ListHead[<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>],
02664                         &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
02665     }
02666 
02667     <span class="comment">//</span>
02668     <span class="comment">// Find the first non-empty list.</span>
02669     <span class="comment">//</span>
02670 
02671     <span class="keywordflow">for</span> (NonEmpty = 0 ; NonEmpty &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a3">MM_WS_REORG_BUCKETS_MAX</a> ; NonEmpty += 1) {
02672         <span class="keywordflow">if</span> (!IsListEmpty (&amp;ListHead[NonEmpty])) {
02673             <span class="keywordflow">break</span>;
02674         }
02675     }
02676 
02677     <span class="comment">//</span>
02678     <span class="comment">// Put the head of first non-empty list at the beginning</span>
02679     <span class="comment">// of the MmWorkingSetExpansion list.</span>
02680     <span class="comment">//</span>
02681 
02682     <a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>.Flink = ListHead[NonEmpty].Flink;
02683     ListHead[NonEmpty].Flink-&gt;Blink = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>;
02684 
02685     PreviousNonEmpty = NonEmpty;
02686 
02687     <span class="comment">//</span>
02688     <span class="comment">// Link the rest of the lists together.</span>
02689     <span class="comment">//</span>
02690 
02691     <span class="keywordflow">for</span> (NonEmpty += 1; NonEmpty &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a3">MM_WS_REORG_BUCKETS_MAX</a>; NonEmpty += 1) {
02692 
02693         <span class="keywordflow">if</span> (!IsListEmpty (&amp;ListHead[NonEmpty])) {
02694             
02695             ListHead[PreviousNonEmpty].Blink-&gt;Flink = ListHead[NonEmpty].Flink;
02696             ListHead[NonEmpty].Flink-&gt;Blink = ListHead[PreviousNonEmpty].Blink;
02697             PreviousNonEmpty = NonEmpty;
02698         }
02699     }
02700 
02701     <span class="comment">//</span>
02702     <span class="comment">// Link the tail of last non-empty to the MmWorkingSetExpansion list.</span>
02703     <span class="comment">//</span>
02704    
02705     <a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>.Blink = ListHead[PreviousNonEmpty].Blink;
02706     ListHead[PreviousNonEmpty].Blink-&gt;Flink = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>;
02707 
02708     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02709 
02710     <span class="keywordflow">return</span>;
02711 }
02712 
02713 
02714 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02715"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a47">02715</a> <a class="code" href="../../d5/d0/wsmanage_8c.html#a47">MiEmptyAllWorkingSets</a> (
02716     VOID
02717     )
02718 
02719 <span class="comment">/*++</span>
02720 <span class="comment"></span>
02721 <span class="comment">Routine Description:</span>
02722 <span class="comment"></span>
02723 <span class="comment">    This routine attempts to empty all the working sets on the</span>
02724 <span class="comment">    expansion list.</span>
02725 <span class="comment"></span>
02726 <span class="comment">Arguments:</span>
02727 <span class="comment"></span>
02728 <span class="comment">    None.</span>
02729 <span class="comment"></span>
02730 <span class="comment">Return Value:</span>
02731 <span class="comment"></span>
02732 <span class="comment">    None.</span>
02733 <span class="comment"></span>
02734 <span class="comment">Environment:</span>
02735 <span class="comment"></span>
02736 <span class="comment">    Kernel mode.  No locks held.  APC level or below.</span>
02737 <span class="comment"></span>
02738 <span class="comment">--*/</span>
02739 
02740 {
02741     KIRQL OldIrql;
02742 
02743     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02744 
02745     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
02746 
02747     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02748         <a class="code" href="../../d5/d0/wsmanage_8c.html#a32">MiEmptyAllWorkingSetsWorker</a> ();
02749     }
02750     <span class="keywordflow">else</span> {
02751         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> () != MmWorkingSetThread);
02752 
02753         <span class="comment">//</span>
02754         <span class="comment">// For Hydra, we cannot attach directly to the session space to be</span>
02755         <span class="comment">// trimmed because it would result in session space references by</span>
02756         <span class="comment">// other threads in this process to the attached session instead</span>
02757         <span class="comment">// of the (currently) correct one.  In fact, we cannot even queue</span>
02758         <span class="comment">// this to a worker thread because the working set manager</span>
02759         <span class="comment">// (who shares the same page directory) may be attaching or</span>
02760         <span class="comment">// detaching from a session (any session).  So this must be queued</span>
02761         <span class="comment">// to the working set manager.</span>
02762         <span class="comment">//</span>
02763     
02764         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02765 
02766         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a8">MiWaitingForWorkingSetEmpty</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02767             <a class="code" href="../../d5/d0/wsmanage_8c.html#a8">MiWaitingForWorkingSetEmpty</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02768             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;<a class="code" href="../../d5/d0/wsmanage_8c.html#a7">MiWaitForEmptyEvent</a>);
02769         }
02770 
02771         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02772 
02773         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d2/d1/mm_8h.html#a139">MmWorkingSetManagerEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02774 
02775         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;<a class="code" href="../../d5/d0/wsmanage_8c.html#a7">MiWaitForEmptyEvent</a>,
02776                                <a class="code" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>,
02777                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02778                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02779                                (PLARGE_INTEGER)0);
02780     }
02781 
02782     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
02783 
02784     <span class="keywordflow">return</span>;
02785 }
02786 
02787 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02788"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a32">02788</a> <a class="code" href="../../d5/d0/wsmanage_8c.html#a32">MiEmptyAllWorkingSetsWorker</a> (
02789     VOID
02790     )
02791 
02792 <span class="comment">/*++</span>
02793 <span class="comment"></span>
02794 <span class="comment">Routine Description:</span>
02795 <span class="comment"></span>
02796 <span class="comment">    This routine attempts to empty all the working sets on the expansion list.</span>
02797 <span class="comment"></span>
02798 <span class="comment">Arguments:</span>
02799 <span class="comment"></span>
02800 <span class="comment">    None.</span>
02801 <span class="comment"></span>
02802 <span class="comment">Return Value:</span>
02803 <span class="comment"></span>
02804 <span class="comment">    None.</span>
02805 <span class="comment"></span>
02806 <span class="comment">Environment:</span>
02807 <span class="comment"></span>
02808 <span class="comment">    Kernel mode.  No locks held.  APC level or below.</span>
02809 <span class="comment"></span>
02810 <span class="comment">--*/</span>
02811 
02812 {
02813     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport;
02814     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> FirstSeen;
02815     ULONG SystemCacheSeen;
02816     KIRQL OldIrql;
02817     PLIST_ENTRY ListEntry;
02818     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToTrim;
02819     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace;
02820     ULONG LoopCount;
02821 
02822     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02823 
02824     FirstSeen = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02825     SystemCacheSeen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02826     LoopCount = 0;
02827 
02828     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02829 
02830     <span class="keywordflow">while</span> (!IsListEmpty (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>)) {
02831 
02832         <span class="comment">//</span>
02833         <span class="comment">// Remove the entry at the head and trim it.</span>
02834         <span class="comment">//</span>
02835 
02836         ListEntry = RemoveHeadList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>);
02837 
02838         <span class="keywordflow">if</span> (ListEntry == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>) {
02839             VmSupport = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
02840             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
02841             ProcessToTrim = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02842             <span class="keywordflow">if</span> (SystemCacheSeen != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02843 
02844                 <span class="comment">//</span>
02845                 <span class="comment">// Seen this one already.</span>
02846                 <span class="comment">//</span>
02847 
02848                 FirstSeen = VmSupport;
02849             }
02850             SystemCacheSeen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02851         }
02852         <span class="keywordflow">else</span> {
02853             VmSupport = CONTAINING_RECORD(ListEntry,
02854                                           <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">MMSUPPORT</a>,
02855                                           WorkingSetExpansionLinks);
02856 
02857             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
02858                 ProcessToTrim = CONTAINING_RECORD(VmSupport,
02859                                                   <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,
02860                                                   Vm);
02861 
02862                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a> == <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>);
02863                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport == &amp;ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>);
02864                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> == 0);
02865                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
02866             }
02867             <span class="keywordflow">else</span> {
02868                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02869                 SessionSpace = CONTAINING_RECORD(VmSupport,
02870                                                  <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">MM_SESSION_SPACE</a>,
02871                                                  Vm);
02872 
02873                 ProcessToTrim = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02874             }
02875         }
02876 
02877         <span class="keywordflow">if</span> (VmSupport == FirstSeen) {
02878             InsertHeadList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
02879                         &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
02880             <span class="keywordflow">break</span>;
02881         }
02882 
02883         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 0);
02884         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 1;
02885 
02886         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
02887         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink =
02888                                             <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>;
02889         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02890 
02891         <span class="keywordflow">if</span> (FirstSeen == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02892             FirstSeen = VmSupport;
02893         }
02894 
02895         <span class="comment">//</span>
02896         <span class="comment">// Empty the working set.</span>
02897         <span class="comment">//</span>
02898 
02899         <span class="keywordflow">if</span> (ProcessToTrim == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02900             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
02901                 <a class="code" href="../../d4/d0/wslist_8c.html#a35">MiEmptyWorkingSet</a> (VmSupport, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02902             }
02903             <span class="keywordflow">else</span> {
02904                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02905                 <a class="code" href="../../d3/d7/session_8c.html#a16">MiAttachSession</a> (SessionSpace);
02906                 <a class="code" href="../../d4/d0/wslist_8c.html#a35">MiEmptyWorkingSet</a> (VmSupport, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02907                 <a class="code" href="../../d3/d7/session_8c.html#a17">MiDetachSession</a> ();
02908             }
02909         }
02910         <span class="keywordflow">else</span> {
02911 
02912             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; 4) {
02913                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
02914                 <a class="code" href="../../d4/d0/wslist_8c.html#a35">MiEmptyWorkingSet</a> (VmSupport, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02915                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
02916             }
02917         }
02918 
02919         <span class="comment">//</span>
02920         <span class="comment">// Add back to the list.</span>
02921         <span class="comment">//</span>
02922 
02923         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02924         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink == <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>);
02925         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 1);
02926         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
02927 
02928         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink == <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>);
02929         <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink ==
02930                                              <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>) {
02931 
02932             <span class="comment">//</span>
02933             <span class="comment">// If the working set size is still above the minimum,</span>
02934             <span class="comment">// add this back at the tail of the list.</span>
02935             <span class="comment">//</span>
02936 
02937             InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
02938                             &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
02939         }
02940         <span class="keywordflow">else</span> {
02941 
02942             <span class="comment">//</span>
02943             <span class="comment">// The value in the blink is the address of an event</span>
02944             <span class="comment">// to set.</span>
02945             <span class="comment">//</span>
02946 
02947             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>);
02948 
02949             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> ((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink,
02950                         0,
02951                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02952         }
02953 
02954         <span class="comment">//</span>
02955         <span class="comment">// The initial working set that was chosen for FirstSeen may have</span>
02956         <span class="comment">// been trimmed down under its minimum and been removed from the</span>
02957         <span class="comment">// ExpansionHead links.  It is possible that the system cache is not</span>
02958         <span class="comment">// on the links either.  This check detects this extremely rare</span>
02959         <span class="comment">// situation so that the system does not spin forever.</span>
02960         <span class="comment">//</span>
02961 
02962         LoopCount += 1;
02963         <span class="keywordflow">if</span> (LoopCount &gt; 200) {
02964             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink == <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>) {
02965                 <span class="keywordflow">break</span>;
02966             }
02967         }
02968     }
02969 
02970     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02971 
02972     <span class="keywordflow">return</span>;
02973 }
02974 
02975 <span class="comment">//</span>
02976 <span class="comment">// This is deliberately initialized to 1 and only cleared when we have</span>
02977 <span class="comment">// initialized enough of the system working set to support a trim.</span>
02978 <span class="comment">//</span>
02979 
<a name="l02980"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a30">02980</a> LONG <a class="code" href="../../d5/d1/mminit_8c.html#a33">MiTrimInProgressCount</a> = 1;
02981 
<a name="l02982"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a31">02982</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a31">MiTrimAllPageFaultCount</a>;
02983 
02984 
02985 LOGICAL
<a name="l02986"></a><a class="code" href="../../d5/d0/wsmanage_8c.html#a48">02986</a> <a class="code" href="../../d5/d0/wsmanage_8c.html#a48">MmTrimAllSystemPagableMemory</a> (
02987     IN LOGICAL PurgeTransition
02988     )
02989 
02990 <span class="comment">/*++</span>
02991 <span class="comment"></span>
02992 <span class="comment">Routine Description:</span>
02993 <span class="comment"></span>
02994 <span class="comment">    This routine unmaps all pagable system memory.  This does not unmap user</span>
02995 <span class="comment">    memory or locked down kernel memory.  Thus, the memory being unmapped</span>
02996 <span class="comment">    resides in paged pool, pagable kernel/driver code &amp; data, special pool</span>
02997 <span class="comment">    and the system cache.</span>
02998 <span class="comment"></span>
02999 <span class="comment">    Note that pages with a reference count greater than 1 are skipped (ie:</span>
03000 <span class="comment">    they remain valid, as they are assumed to be locked down).  This prevents</span>
03001 <span class="comment">    us from unmapping all of the system cache entries, etc.</span>
03002 <span class="comment"></span>
03003 <span class="comment">    Non-locked down kernel stacks must be outpaged by modifying the balance</span>
03004 <span class="comment">    set manager to operate in conjunction with a support routine.  This is not</span>
03005 <span class="comment">    done here.</span>
03006 <span class="comment"></span>
03007 <span class="comment">Arguments:</span>
03008 <span class="comment"></span>
03009 <span class="comment">    PurgeTransition - Supplies whether to purge all the clean pages from the</span>
03010 <span class="comment">                      transition list.</span>
03011 <span class="comment"></span>
03012 <span class="comment">Return Value:</span>
03013 <span class="comment"></span>
03014 <span class="comment">    TRUE if accomplished, FALSE if not.</span>
03015 <span class="comment"></span>
03016 <span class="comment">Environment:</span>
03017 <span class="comment"></span>
03018 <span class="comment">    Kernel mode.  APC_LEVEL or below.</span>
03019 <span class="comment"></span>
03020 <span class="comment">--*/</span>
03021 
03022 {
03023     KIRQL OldIrql;
03024     KIRQL OldIrql2;
03025     PLIST_ENTRY Next;
03026     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport;
03027     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> PagesInUse;
03028     PFN_NUMBER PageFrameIndex;
03029     LOGICAL LockAvailable;
03030     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03031     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread;
03032     ULONG flags;
03033 
03034     <span class="comment">//</span>
03035     <span class="comment">// It's ok to check this without acquiring the system WS lock.</span>
03036     <span class="comment">//</span>
03037 
03038     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a31">MiTrimAllPageFaultCount</a> == <a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>) {
03039         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03040     }
03041 
03042     <span class="comment">//</span>
03043     <span class="comment">// Working set mutexes will be acquired which require APC_LEVEL or below.</span>
03044     <span class="comment">//</span>
03045 
03046     <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
03047         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03048     }
03049 
03050     <span class="comment">//</span>
03051     <span class="comment">// Just return if it's too early during system initialization or if</span>
03052     <span class="comment">// another thread/processor is racing here to do the work for us.</span>
03053     <span class="comment">//</span>
03054 
03055     <span class="keywordflow">if</span> (InterlockedIncrement (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a33">MiTrimInProgressCount</a>) &gt; 1) {
03056         InterlockedDecrement (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a33">MiTrimInProgressCount</a>);
03057         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03058     }
03059 
03060 <span class="preprocessor">#if defined(_X86_)</span>
03061 <span class="preprocessor"></span>
03062     _asm {
03063         pushfd
03064         pop     flags
03065     }
03066 
03067     <span class="keywordflow">if</span> ((flags &amp; EFLAGS_INTERRUPT_MASK) == 0) {
03068         InterlockedDecrement (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a33">MiTrimInProgressCount</a>);
03069         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03070     }
03071 
03072 <span class="preprocessor">#endif</span>
03073 <span class="preprocessor"></span>
03074     LockAvailable = <a class="code" href="../../d4/d9/ke_8h.html#a360">KeTryToAcquireSpinLock</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a691">MmExpansionLock</a>, &amp;OldIrql);
03075 
03076     <span class="keywordflow">if</span> (LockAvailable == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03077         InterlockedDecrement (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a33">MiTrimInProgressCount</a>);
03078         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03079     }
03080 
03081     <a class="code" href="../../d4/d8/mi_8h.html#a137">MM_SET_EXPANSION_OWNER</a> ();
03082 
03083     CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
03084 
03085     <span class="comment">//</span>
03086     <span class="comment">// If the system cache resource is owned by this thread then don't bother</span>
03087     <span class="comment">// trying to trim now.  Note that checking the MmSystemLockOwner is not</span>
03088     <span class="comment">// sufficient as this flag is cleared just before actually releasing it.</span>
03089     <span class="comment">//</span>
03090 
03091     <span class="keywordflow">if</span> ((CurrentThread == <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a>) ||
03092         (<a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a>(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a688">MmSystemWsLock</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03093         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
03094         InterlockedDecrement (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a33">MiTrimInProgressCount</a>);
03095         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03096     }
03097 
03098     Next = <a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>.Flink;
03099 
03100     <span class="keywordflow">while</span> (Next != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>) {
03101         <span class="keywordflow">if</span> (Next == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>) {
03102             <span class="keywordflow">break</span>;
03103         }
03104         Next = Next-&gt;Flink;
03105     }
03106 
03107     <span class="keywordflow">if</span> (Next != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>) {
03108         <a class="code" href="../../d5/d8/ex_8h.html#a273">ExReleaseResourceLite</a>(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a688">MmSystemWsLock</a>);
03109         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
03110         InterlockedDecrement (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a33">MiTrimInProgressCount</a>);
03111         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03112     }
03113 
03114     RemoveEntryList (Next);
03115 
03116     VmSupport = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
03117     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
03118     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink = <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>;
03119     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 0);
03120     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 1;
03121 
03122     <a class="code" href="../../d5/d0/wsmanage_8c.html#a31">MiTrimAllPageFaultCount</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
03123 
03124     PagesInUse = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>;
03125 
03126     <span class="comment">//</span>
03127     <span class="comment">// There are 2 issues here that are carefully dealt with :</span>
03128     <span class="comment">//</span>
03129     <span class="comment">// 1.  APCs must be disabled while any resources are held to prevent</span>
03130     <span class="comment">//     suspend APCs from deadlocking the system.</span>
03131     <span class="comment">// 2.  Once the system cache has been marked MM_WS_EXPANSION_IN_PROGRESS,</span>
03132     <span class="comment">//     either the thread must not be preempted or the system cache working</span>
03133     <span class="comment">//     set lock must be held throughout.  Otherwise a high priority thread</span>
03134     <span class="comment">//     can fault on a system code and data address and the two pages will</span>
03135     <span class="comment">//     thrash forever (at high priority) because no system working set</span>
03136     <span class="comment">//     expansion is allowed while MM_WS_EXPANSION_IN_PROGRESS is set.</span>
03137     <span class="comment">//     The decision was to hold the system working set lock throughout.</span>
03138     <span class="comment">//</span>
03139 
03140     <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
03141 
03142     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
03143 
03144     <a class="code" href="../../d4/d0/wslist_8c.html#a35">MiEmptyWorkingSet</a> (VmSupport, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03145 
03146     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql2);
03147     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (OldIrql2 == <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
03148 
03149     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink == <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>);
03150 
03151     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 1);
03152     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
03153 
03154     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink ==
03155                                         <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>);
03156 
03157     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
03158                     &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
03159 
03160     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
03161 
03162     <span class="comment">//</span>
03163     <span class="comment">// Since MiEmptyWorkingSet will attempt to recursively acquire and release</span>
03164     <span class="comment">// the MmSystemWsLock, the MmSystemLockOwner field may get cleared.</span>
03165     <span class="comment">// This means here the resource must be explicitly released instead of</span>
03166     <span class="comment">// using UNLOCK_SYSTEM_WS.</span>
03167     <span class="comment">//</span>
03168 
03169     <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03170     <a class="code" href="../../d5/d8/ex_8h.html#a273">ExReleaseResourceLite</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a688">MmSystemWsLock</a>);
03171     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
03172     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
03173 
03174     <span class="keywordflow">if</span> (PurgeTransition == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03175 
03176         <span class="comment">//</span>
03177         <span class="comment">// Run the transition list and free all the entries so transition</span>
03178         <span class="comment">// faults are not satisfied for any of the non modified pages that were</span>
03179         <span class="comment">// freed.</span>
03180         <span class="comment">//</span>
03181     
03182         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03183     
03184         <span class="keywordflow">while</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0) {
03185     
03186             PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a> (&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>);
03187     
03188             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03189     
03190             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
03191             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
03192     
03193             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
03194             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a> = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
03195             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 0;
03196             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
03197         
03198             <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
03199         }
03200     
03201         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03202     }
03203     
03204     InterlockedDecrement (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a33">MiTrimInProgressCount</a>);
03205 
03206     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03207 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
