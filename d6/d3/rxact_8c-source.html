<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rxact.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rxact.c</h1><a href="../../d5/d4/rxact_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    rxact.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This Module implements a simple transaction mechanism for registry</span>
00012 <span class="comment">    database operations which helps eliminate the possibility of partial</span>
00013 <span class="comment">    updates being made.  The cases covered are specifically partial updates</span>
00014 <span class="comment">    caused by system crashes or program aborts during multiple-write updates.</span>
00015 <span class="comment"></span>
00016 <span class="comment"></span>
00017 <span class="comment">    WARNING:  This package does not yet deal with full-disk problems</span>
00018 <span class="comment">              automatically.  If a full disk is encountered during</span>
00019 <span class="comment">              transaction commit, then manual interaction may be required</span>
00020 <span class="comment">              to free enough space to complete the commit.  There is</span>
00021 <span class="comment">              no means provided for backing out the commit.</span>
00022 <span class="comment"></span>
00023 <span class="comment">Author:</span>
00024 <span class="comment"></span>
00025 <span class="comment">    Jim Kelly       (JimK)     15-May-1991</span>
00026 <span class="comment">    Robert Reichel  (RobertRe) 15-July-1992</span>
00027 <span class="comment"></span>
00028 <span class="comment">Environment:</span>
00029 <span class="comment"></span>
00030 <span class="comment">    Pure Runtime Library Routine</span>
00031 <span class="comment"></span>
00032 <span class="comment">Revision History:</span>
00033 <span class="comment"></span>
00034 <span class="comment"></span>
00035 <span class="comment"></span>
00036 <span class="comment">--*/</span>
00037 
00038 
00039 <span class="comment">/*</span>
00041 <span class="comment"></span>
00042 <span class="comment">High Level Description:</span>
00043 <span class="comment"></span>
00044 <span class="comment">    The simple transaction mechanism expects the following to be true:</span>
00045 <span class="comment"></span>
00046 <span class="comment">       (1) A single server is responsible for operations on an entire</span>
00047 <span class="comment">           sub-tree of the registry database.  For example, the security</span>
00048 <span class="comment">           account manager server (SAM) is responsible for everything</span>
00049 <span class="comment">           below \REGISTRY\LOCAL_MACHINE\SECURITY\SAM.</span>
00050 <span class="comment"></span>
00051 <span class="comment">       (2) Transactions on the sub-tree are serialized by the server</span>
00052 <span class="comment">           responsible for the sub-tree.  That is, the server will not</span>
00053 <span class="comment">           start a second user request until all previous user requests</span>
00054 <span class="comment">           have been completed.</span>
00055 <span class="comment"></span>
00056 <span class="comment">    The simple transaction mechanism helps eliminate the problem of partial</span>
00057 <span class="comment">    updates caused by system crash or program abort during multiple-write</span>
00058 <span class="comment">    updates to the registry database.  This is achieved by:</span>
00059 <span class="comment"></span>
00060 <span class="comment">       (1) Keeping all actions in-memory until instructed to commit.  The</span>
00061 <span class="comment">           presence of in-memory data structures implicitly indicates</span>
00062 <span class="comment">           that a transaction is in progress.</span>
00063 <span class="comment"></span>
00064 <span class="comment">           The initial state is no transaction in progress.</span>
00065 <span class="comment"></span>
00066 <span class="comment">       (2) Providing a service which allows a server to initiate a transaction.</span>
00067 <span class="comment">           This allocates in-memory data structures, thereby changing the</span>
00068 <span class="comment">           state to transaction in progress.</span>
00069 <span class="comment"></span>
00070 <span class="comment">       (3) Keeping a log of all keys in the sub-tree that are to be</span>
00071 <span class="comment">           updated in a single transaction.  Each record in this log</span>
00072 <span class="comment">           contains the following information:</span>
00073 <span class="comment"></span>
00074 <span class="comment">                   (a) The name of the sub-key effected</span>
00075 <span class="comment"></span>
00076 <span class="comment">                   (b) The operation to be performed on the sub-key</span>
00077 <span class="comment">                       either DELETE or SET_VALUE.  Note that these</span>
00078 <span class="comment">                       operations are idempotent and may be applied</span>
00079 <span class="comment">                       again in the event that the server aborts during</span>
00080 <span class="comment">                       an initial commit.</span>
00081 <span class="comment"></span>
00082 <span class="comment">                   (c) The new value of the sub-key (if applicable)</span>
00083 <span class="comment"></span>
00084 <span class="comment">                   (d) (optionally) The attribute name of the subkey</span>
00085 <span class="comment">                       to be operated on.</span>
00086 <span class="comment"></span>
00087 <span class="comment">                    (note that SET_VALUE is used to create new sub-keys</span>
00088 <span class="comment">                     as well as updated existing ones).</span>
00089 <span class="comment"></span>
00090 <span class="comment">            The entire list of sub-keys to be modified must be entered</span>
00091 <span class="comment">            into this log before ANY of the sub-keys is actually modified.</span>
00092 <span class="comment"></span>
00093 <span class="comment">       (4)  Providing a commit service that applies all changes indicated</span>
00094 <span class="comment">            in the change log.  This is done by first writing the contents</span>
00095 <span class="comment">            of the in-memory structures to a single key value ("Log") in</span>
00096 <span class="comment">            the registry and flushing the data to disk.  The presence of</span>
00097 <span class="comment">            the "Log" value and data imply that a commit is in progress.</span>
00098 <span class="comment"></span>
00099 <span class="comment">            All necessary changes are applied, the "Log" value and its</span>
00100 <span class="comment">            data are deleted, and in-memory data structres are freed,</span>
00101 <span class="comment">            thereby changing the state to no-transaction.</span>
00102 <span class="comment"></span>
00103 <span class="comment"></span>
00104 <span class="comment">    The package also includes a service which must be called upon server</span>
00105 <span class="comment">    startup.  This service checks to make sure the state of the sub-tree</span>
00106 <span class="comment">    is NO_TRANSACTION.  If it is not, then one of the actions below is</span>
00107 <span class="comment">    performed based upon the current state of the sub-tree:</span>
00108 <span class="comment"></span>
00109 <span class="comment">        COMMITTING - This means the server was previously aborted while</span>
00110 <span class="comment">            a transaction was being committed (applied to the registry).</span>
00111 <span class="comment">            In this case, the commit is performed again from the beginning</span>
00112 <span class="comment">            of the change log.  After the commit is completed, the state</span>
00113 <span class="comment">            of the sub-tree is set to NO_TRANSACTION.</span>
00114 <span class="comment"></span>
00116 <span class="comment">*/</span>
00117 
00118 
00119 
00120 <span class="comment">/*</span>
00122 <span class="comment"></span>
00123 <span class="comment">Detailed Description:</span>
00124 <span class="comment"></span>
00125 <span class="comment">    Registry State</span>
00126 <span class="comment">    --------------</span>
00127 <span class="comment"></span>
00128 <span class="comment">    The registry state of a subtree is kept in a sub-key of that tree</span>
00129 <span class="comment">    named:</span>
00130 <span class="comment"></span>
00131 <span class="comment">            "RXACT"</span>
00132 <span class="comment"></span>
00133 <span class="comment">    The value field of that registry key includes a revision field.</span>
00134 <span class="comment"></span>
00135 <span class="comment"></span>
00136 <span class="comment">    RXact Context</span>
00137 <span class="comment">    -------------</span>
00138 <span class="comment"></span>
00139 <span class="comment">    A call to RtlInitializeRXact will return a pointer to an</span>
00140 <span class="comment">    RTL_RXACT_CONTEXT structure.  This structure contains:</span>
00141 <span class="comment"></span>
00142 <span class="comment">    (1) the passed RootRegistryKey (eg, key to "Sam"),</span>
00143 <span class="comment"></span>
00144 <span class="comment">    (2) a handle to the top of the RXact subtree (eg, key to</span>
00145 <span class="comment">        "Sam\RXACT"),</span>
00146 <span class="comment"></span>
00147 <span class="comment">    (3) a flag indicating if handles stored in the log are</span>
00148 <span class="comment">        valid,</span>
00149 <span class="comment"></span>
00150 <span class="comment">    (4) a pointer to the current RXactLog.</span>
00151 <span class="comment"></span>
00152 <span class="comment">    The subsystem calling RtlInitializeRXact must keep this returned</span>
00153 <span class="comment">    pointer and pass it back to RXact in all subsequent calls.</span>
00154 <span class="comment"></span>
00155 <span class="comment"></span>
00156 <span class="comment">    Operation Log</span>
00157 <span class="comment">    -------------</span>
00158 <span class="comment"></span>
00159 <span class="comment">    The operation log of a registry sub-tree transaction is kept as sequence</span>
00160 <span class="comment">    of "operation log entries".</span>
00161 <span class="comment"></span>
00162 <span class="comment">    An in-memory log is a block of heap memory allocted by RtlStartRXact.</span>
00163 <span class="comment">    It has a header which contains:</span>
00164 <span class="comment"></span>
00165 <span class="comment">    (1) The count of operations in the log.</span>
00166 <span class="comment"></span>
00167 <span class="comment">    (2) The maximum size of the log.</span>
00168 <span class="comment"></span>
00169 <span class="comment">    (3) The amount of the log currently in use.</span>
00170 <span class="comment"></span>
00171 <span class="comment">    The log data itself follows the header directly.</span>
00172 <span class="comment"></span>
00173 <span class="comment"></span>
00174 <span class="comment">    Operation Log Entries</span>
00175 <span class="comment">    ---------------------</span>
00176 <span class="comment"></span>
00177 <span class="comment">    An operation log entry is described by the following structure:</span>
00178 <span class="comment"></span>
00179 <span class="comment">    typedef struct _RXACT_LOG_ENTRY {</span>
00180 <span class="comment">        ULONG LogEntrySize;</span>
00181 <span class="comment">        RTL_RXACT_OPERATION Operation;</span>
00182 <span class="comment">        UNICODE_STRING SubKeyName;       // Self-relativized (Buffer is really offset)</span>
00183 <span class="comment">        UNICODE_STRING AttributeName;    // Self-relativized (Buffer is really offset)</span>
00184 <span class="comment">        HANDLE KeyHandle;                // optional, not valid if read from disk.</span>
00185 <span class="comment">        ULONG NewKeyValueType;</span>
00186 <span class="comment">        ULONG NewKeyValueLength;</span>
00187 <span class="comment">        PVOID NewKeyValue;               // Contains offset to data from start of log</span>
00188 <span class="comment">    } RXACT_LOG_ENTRY, *PRXACT_LOG_ENTRY;</span>
00189 <span class="comment"></span>
00190 <span class="comment">    The log entry contains all of the information passed in during a call</span>
00191 <span class="comment">    to RtlAddActionToRXact or RtlAddAttributeActionToRXact.</span>
00192 <span class="comment"></span>
00193 <span class="comment">    The UNICODE_STRING structures contain an offset to the string data</span>
00194 <span class="comment">    rather than a pointer.  These offsets are relative to the start of</span>
00195 <span class="comment">    the log data, and are adjusted in place as each log entry is commited.</span>
00196 <span class="comment"></span>
00197 <span class="comment">    The KeyHandle is valid if it is not equal to INVALID_HANDLE_VALUE and</span>
00198 <span class="comment">    if the HandlesValid flag in the RXactContext structure is TRUE.  This</span>
00199 <span class="comment">    is so that we do not attempt to use the handles if the log has been</span>
00200 <span class="comment">    read from disk after a reboot.</span>
00201 <span class="comment"></span>
00202 <span class="comment"></span>
00204 <span class="comment">*/</span>
00205 
00206 
00207 <span class="preprocessor">#include "<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>"</span>
00208 
00209 <span class="comment">//</span>
00210 <span class="comment">// Cannot include &lt;windows.h&gt; from kernel code</span>
00211 <span class="comment">//</span>
<a name="l00212"></a><a class="code" href="../../d5/d4/rxact_8c.html#a0">00212</a> <span class="preprocessor">#define INVALID_HANDLE_VALUE (HANDLE)-1</span>
00213 <span class="preprocessor"></span>
00214 
00215 
00216 
00217 
00219 <span class="comment">//                                                                           //</span>
00220 <span class="comment">//    Local Macros &amp; Definitions                                             //</span>
00221 <span class="comment">//                                                                           //</span>
00223 <span class="comment"></span>
00224 <span class="comment">//</span>
00225 <span class="comment">// Revision level of a registry transaction .</span>
00226 <span class="comment">//</span>
00227 
<a name="l00228"></a><a class="code" href="../../d5/d4/rxact_8c.html#a1">00228</a> <span class="preprocessor">#define RTLP_RXACT_REVISION1          (1l)</span>
<a name="l00229"></a><a class="code" href="../../d5/d4/rxact_8c.html#a2">00229</a> <span class="preprocessor"></span><span class="preprocessor">#define RTLP_RXACT_CURRENT_REVISION   RTLP_RXACT_REVISION1</span>
00230 <span class="preprocessor"></span>
00231 
<a name="l00232"></a><a class="code" href="../../d5/d4/rxact_8c.html#a3">00232</a> <span class="preprocessor">#define RTLP_RXACT_KEY_NAME           L"RXACT"</span>
00233 <span class="preprocessor"></span>
<a name="l00234"></a><a class="code" href="../../d5/d4/rxact_8c.html#a4">00234</a> <span class="preprocessor">#define RTLP_RXACT_LOG_NAME           L"Log"</span>
00235 <span class="preprocessor"></span>
<a name="l00236"></a><a class="code" href="../../d5/d4/rxact_8c.html#a5">00236</a> <span class="preprocessor">#define RTLP_INITIAL_LOG_SIZE         0x4000</span>
00237 <span class="preprocessor"></span>
00238 <span class="comment">//</span>
00239 <span class="comment">//  Given a value return its longword aligned equivalent value</span>
00240 <span class="comment">//</span>
00241 
<a name="l00242"></a><a class="code" href="../../d5/d4/rxact_8c.html#a6">00242</a> <span class="preprocessor">#define DwordAlign(Value) (                       \</span>
00243 <span class="preprocessor">    (ULONG)((((ULONG)(Value)) + 3) &amp; 0xfffffffc)  \</span>
00244 <span class="preprocessor">    )</span>
00245 <span class="preprocessor"></span>
00246 <span class="comment">//</span>
00247 <span class="comment">// The value field of the RXACT registry key is one of the following data</span>
00248 <span class="comment">// structures.</span>
00249 <span class="comment">//</span>
00250 
00251 <span class="comment">//</span>
00252 <span class="comment">// The state of a registry sub-tree is one of the following:</span>
00253 <span class="comment">//</span>
00254 <span class="comment">//         RtlpRXactStateNoTransaction - There is not a transaction in progress.</span>
00255 <span class="comment">//</span>
00256 <span class="comment">//         RtlpRXactStateCommitting    - The actions of a transaction are being</span>
00257 <span class="comment">//                                       applied to the registry database.</span>
00258 <span class="comment">//</span>
00259 
<a name="l00260"></a><a class="code" href="../../d5/d4/rxact_8c.html#a25">00260</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> <a class="code" href="../../d5/d4/rxact_8c.html#a25">_RTLP_RXACT_STATE</a> {
00261     <a class="code" href="../../d5/d4/rxact_8c.html#a25a13">RtlpRXactStateNoTransaction</a> = 2,
00262     <a class="code" href="../../d5/d4/rxact_8c.html#a25a14">RtlpRXactStateCommitting</a>
00263 } <a class="code" href="../../d5/d4/rxact_8c.html#a7">RTLP_RXACT_STATE</a>, *<a class="code" href="../../d5/d4/rxact_8c.html#a8">PRTLP_RXACT_STATE</a>;
00264 
00265 
<a name="l00266"></a><a class="code" href="../../d1/d7/struct__RTLP__RXACT.html">00266</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d7/struct__RTLP__RXACT.html">_RTLP_RXACT</a> {
<a name="l00267"></a><a class="code" href="../../d1/d7/struct__RTLP__RXACT.html#o0">00267</a>     ULONG <a class="code" href="../../d1/d7/struct__RTLP__RXACT.html#o0">Revision</a>;
<a name="l00268"></a><a class="code" href="../../d1/d7/struct__RTLP__RXACT.html#o1">00268</a>     <a class="code" href="../../d5/d4/rxact_8c.html#a7">RTLP_RXACT_STATE</a> <a class="code" href="../../d1/d7/struct__RTLP__RXACT.html#o1">State</a>;   <span class="comment">// no longer used</span>
<a name="l00269"></a><a class="code" href="../../d1/d7/struct__RTLP__RXACT.html#o2">00269</a>     ULONG <a class="code" href="../../d1/d7/struct__RTLP__RXACT.html#o2">OperationCount</a>;     <span class="comment">// no longer used</span>
00270 } <a class="code" href="../../d1/d7/struct__RTLP__RXACT.html">RTLP_RXACT</a>, *<a class="code" href="../../d1/d7/struct__RTLP__RXACT.html">PRTLP_RXACT</a>;
00271 
00272 
<a name="l00273"></a><a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html">00273</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html">_RXACT_LOG_ENTRY</a> {
<a name="l00274"></a><a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o0">00274</a>     ULONG <a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o0">LogEntrySize</a>;
<a name="l00275"></a><a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o1">00275</a>     RTL_RXACT_OPERATION <a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o1">Operation</a>;
<a name="l00276"></a><a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o2">00276</a>     UNICODE_STRING <a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o2">SubKeyName</a>;       <span class="comment">// Self-relativized (Buffer is really offset)</span>
<a name="l00277"></a><a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o3">00277</a>     UNICODE_STRING <a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o3">AttributeName</a>;    <span class="comment">// Self-relativized (Buffer is really offset)</span>
<a name="l00278"></a><a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o4">00278</a>     HANDLE <a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o4">KeyHandle</a>;                <span class="comment">// optional, not valid if read from disk.</span>
<a name="l00279"></a><a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o5">00279</a>     ULONG <a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o5">NewKeyValueType</a>;
<a name="l00280"></a><a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o6">00280</a>     ULONG <a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o6">NewKeyValueLength</a>;
<a name="l00281"></a><a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o7">00281</a>     PVOID <a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o7">NewKeyValue</a>;               <span class="comment">// Contains offset to data from start of log</span>
00282 } <a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html">RXACT_LOG_ENTRY</a>, *<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html">PRXACT_LOG_ENTRY</a>;
00283 
00284 
00285 
00286 
00288 <span class="comment">//                                                                            //</span>
00289 <span class="comment">//                      Prototypes for local procedures                       //</span>
00290 <span class="comment">//                                                                            //</span>
00292 <span class="comment"></span>
00293 
00294 
00295 
00296 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00297 <a class="code" href="../../d5/d4/rxact_8c.html#a15">RXactpCommit</a>(
00298     IN PRTL_RXACT_CONTEXT RXactContext
00299     );
00300 
00301 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00302 <a class="code" href="../../d5/d4/rxact_8c.html#a16">RXactpOpenTargetKey</a>(
00303     IN HANDLE RootRegistryKey,
00304     IN RTL_RXACT_OPERATION Operation,
00305     IN PUNICODE_STRING SubKeyName,
00306     OUT PHANDLE TargetKey
00307     );
00308 
00309 
00310 
00311 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00312 <a class="code" href="../../d5/d4/rxact_8c.html#a17">RXactInitializeContext</a>(
00313     IN PRTL_RXACT_CONTEXT RXactContext,
00314     IN HANDLE RootRegistryKey,
00315     IN HANDLE RXactKey
00316     );
00317 
00318 
00319 <span class="preprocessor">#if defined(ALLOC_PRAGMA) &amp;&amp; defined(NTOS_KERNEL_RUNTIME)</span>
00320 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RXactpCommit)</span>
00321 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RXactpOpenTargetKey)</span>
00322 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RXactInitializeContext)</span>
00323 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlInitializeRXact)</span>
00324 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlStartRXact)</span>
00325 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlAbortRXact)</span>
00326 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlAddAttributeActionToRXact)</span>
00327 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlAddActionToRXact)</span>
00328 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlApplyRXact)</span>
00329 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlApplyRXactNoFlush)</span>
00330 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00331 <span class="preprocessor"></span>
00332 
00334 <span class="comment">//                                                                           //</span>
00335 <span class="comment">//    Exported Procedures   (defined in ntrtl.h)                             //</span>
00336 <span class="comment">//                                                                           //</span>
00338 <span class="comment"></span>
00339 
00340 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00341"></a><a class="code" href="../../d5/d4/rxact_8c.html#a18">00341</a> <a class="code" href="../../d5/d4/rxact_8c.html#a18">RtlInitializeRXact</a>(
00342     IN HANDLE RootRegistryKey,
00343     IN BOOLEAN CommitIfNecessary,
00344     OUT PRTL_RXACT_CONTEXT *RXactContext
00345     )
00346 
00347 <span class="comment">/*++</span>
00348 <span class="comment"></span>
00349 <span class="comment">Routine Description:</span>
00350 <span class="comment"></span>
00351 <span class="comment">    This routine should be called by a server exactly once when it starts.</span>
00352 <span class="comment">    This routine will check to see that the registry transaction information</span>
00353 <span class="comment">    exists for the specified registry sub-tree, and will create it if it</span>
00354 <span class="comment">    doesn't exist.</span>
00355 <span class="comment"></span>
00356 <span class="comment">Arguments:</span>
00357 <span class="comment"></span>
00358 <span class="comment">    RootRegistryKey - A handle to the registry key within whose sub-tree</span>
00359 <span class="comment">        a transaction is to be initialized.</span>
00360 <span class="comment"></span>
00361 <span class="comment">    CommitIfNecessary - A BOOLEAN value indicating whether or not any</span>
00362 <span class="comment">        previously aborted commit discovered should be commited at this</span>
00363 <span class="comment">        time.  A value of TRUE indicates the commit should be applied</span>
00364 <span class="comment">        if encountered.  A value of FALSE indicates a previously</span>
00365 <span class="comment">        aborted COMMIT should not be committed at this time.</span>
00366 <span class="comment"></span>
00367 <span class="comment">    RXactContext - Returns a pointer to an RTL_RXACT_CONTEXT structure</span>
00368 <span class="comment">        allocated out of the local heap.  The caller must keep this</span>
00369 <span class="comment">        pointer and pass it back in for all future RXact transactions</span>
00370 <span class="comment">        for the passed RootRegistryKey.</span>
00371 <span class="comment"></span>
00372 <span class="comment"></span>
00373 <span class="comment">Return Value:</span>
00374 <span class="comment"></span>
00375 <span class="comment">    STATUS_SUCCESS - Indicates the transaction state already exists for the</span>
00376 <span class="comment">        registry sub-tree and is already in the NO_TRANSACTION state.</span>
00377 <span class="comment"></span>
00378 <span class="comment">    STATUS_UNKNOWN_REVISION - Indicates that a transaction state already</span>
00379 <span class="comment">        exists for the specified sub-tree, but is a revision level that is</span>
00380 <span class="comment">        unknown by this service.</span>
00381 <span class="comment"></span>
00382 <span class="comment">    STATUS_RXACT_STATE_CREATED - This informational level status indicates</span>
00383 <span class="comment">        that a specified registry sub-tree transaction state did not yet</span>
00384 <span class="comment">        exist and had to be created.</span>
00385 <span class="comment"></span>
00386 <span class="comment">    STATUS_RXACT_COMMIT_NECESSARY - This warning level status indicates that the</span>
00387 <span class="comment">        transaction state already exists for the registry sub-tree, but that</span>
00388 <span class="comment">        a transaction commit was previously aborted.  The commit has NOT been</span>
00389 <span class="comment">        completed.  Another call to this service with a CommitIfNecessary value</span>
00390 <span class="comment">        of TRUE may be used to commit the transaction.</span>
00391 <span class="comment"></span>
00392 <span class="comment"></span>
00393 <span class="comment">    STATUS_RXACT_INVALID_STATE - Indicates that the transaction state</span>
00394 <span class="comment">        of the registry sub-tree is incompatible with the requested operation.</span>
00395 <span class="comment">        For example, a request to start a new transaction while one is already</span>
00396 <span class="comment">        in progress, or a request to apply a transaction when one is not</span>
00397 <span class="comment">        currently in progress.</span>
00398 <span class="comment"></span>
00399 <span class="comment">--*/</span>
00400 
00401 {
00402 
00403     HANDLE RXactKey;
00404     LARGE_INTEGER LastWriteTime;
00405     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, TmpStatus;
00406     OBJECT_ATTRIBUTES RXactAttributes;
00407     PKEY_VALUE_FULL_INFORMATION FullInformation;
00408     <a class="code" href="../../d1/d7/struct__RTLP__RXACT.html">RTLP_RXACT</a> RXactKeyValue;
00409     UCHAR BasicInformation[128];      <span class="comment">// Should be more than long enough</span>
00410     ULONG Disposition;
00411     ULONG KeyValueLength;
00412     ULONG KeyValueType;
00413     ULONG ResultLength;
00414     UNICODE_STRING RXactKeyName;
00415     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00416     UNICODE_STRING NullName;
00417 
00418     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00419 
00420     <span class="comment">//</span>
00421     <span class="comment">// Initialize some stuff</span>
00422     <span class="comment">//</span>
00423 
00424     KeyValueLength = (ULONG)<span class="keyword">sizeof</span>( <a class="code" href="../../d1/d7/struct__RTLP__RXACT.html">RTLP_RXACT</a> );
00425     KeyValueType   = 0;         <span class="comment">// Not used by RXact</span>
00426 
00427     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;NullName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00428 
00429     <span class="comment">//</span>
00430     <span class="comment">// Create or open the RXACT key.</span>
00431     <span class="comment">//</span>
00432 
00433     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;RXactKeyName, <a class="code" href="../../d5/d4/rxact_8c.html#a3">RTLP_RXACT_KEY_NAME</a>);
00434 
00435     InitializeObjectAttributes(
00436         &amp;RXactAttributes,
00437         &amp;RXactKeyName,
00438         OBJ_CASE_INSENSITIVE | OBJ_OPENIF,
00439         RootRegistryKey,
00440         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00441 
00442 <span class="comment">//    Status = RtlpNtCreateKey(</span>
00443 <span class="comment">//                 &amp;RXactKey,</span>
00444 <span class="comment">//                 (KEY_READ | KEY_WRITE | DELETE),</span>
00445 <span class="comment">//                 &amp;RXactAttributes,</span>
00446 <span class="comment">//                 0,</span>
00447 <span class="comment">//                 NULL,</span>
00448 <span class="comment">//                 &amp;Disposition</span>
00449 <span class="comment">//                 );</span>
00450 
00451     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>( &amp;RXactKey,
00452                           (KEY_READ | KEY_WRITE | DELETE),
00453                           &amp;RXactAttributes,
00454                           0,                          <span class="comment">//TitleIndex</span>
00455                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                       <span class="comment">//Class OPTIONAL,</span>
00456                           REG_OPTION_NON_VOLATILE,    <span class="comment">//CreateOptions,</span>
00457                           &amp;Disposition
00458                           );
00459 
00460     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00461         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00462     }
00463 
00464     <span class="comment">//</span>
00465     <span class="comment">// Allocate the RXactContext block</span>
00466     <span class="comment">//</span>
00467 
00468     *RXactContext = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, <span class="keyword">sizeof</span>( RTL_RXACT_CONTEXT ));
00469 
00470     <span class="keywordflow">if</span> ( *RXactContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00471 
00472         <span class="comment">//</span>
00473         <span class="comment">// Something prevented value assignment...</span>
00474         <span class="comment">// Get rid of the RXact key and return the error</span>
00475         <span class="comment">//</span>
00476 
00477         TmpStatus = <a class="code" href="../../d7/d7/ntapi_8c.html#a15">NtDeleteKey</a>( RXactKey );
00478         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus)); <span class="comment">//Safe to ignore, notify security group</span>
00479         TmpStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( RXactKey );
00480         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus)); <span class="comment">//Safe to ignore, notify security group</span>
00481 
00482         <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
00483     }
00484 
00485     <span class="comment">//</span>
00486     <span class="comment">// Initialize the newly created RXactContext structure.</span>
00487     <span class="comment">//</span>
00488 
00489     <a class="code" href="../../d5/d4/rxact_8c.html#a17">RXactInitializeContext</a>( *RXactContext, RootRegistryKey, RXactKey );
00490 
00491     <span class="comment">//</span>
00492     <span class="comment">// If we created (as opposed to opened an existing) rxact key,</span>
00493     <span class="comment">// then we need to initialize it.</span>
00494     <span class="comment">//</span>
00495 
00496     <span class="keywordflow">if</span> ( Disposition == REG_CREATED_NEW_KEY ) {
00497 
00498         RXactKeyValue.<a class="code" href="../../d1/d7/struct__RTLP__RXACT.html#o0">Revision</a>       = <a class="code" href="../../d5/d4/rxact_8c.html#a1">RTLP_RXACT_REVISION1</a>;
00499 
00500         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>( RXactKey,
00501                                 &amp;NullName,       <span class="comment">// ValueName</span>
00502                                 0,               <span class="comment">// TitleIndex</span>
00503                                 KeyValueType,
00504                                 &amp;RXactKeyValue,
00505                                 KeyValueLength
00506                                 );
00507 
00508         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00509 
00510             <span class="comment">//</span>
00511             <span class="comment">// Something prevented value assignment...</span>
00512             <span class="comment">// Get rid of the RXact key and return the error</span>
00513             <span class="comment">//</span>
00514 
00515             TmpStatus = <a class="code" href="../../d7/d7/ntapi_8c.html#a15">NtDeleteKey</a>( RXactKey );
00516             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus)); <span class="comment">//Safe to ignore, notify security group</span>
00517             TmpStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( RXactKey );
00518             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus)); <span class="comment">//Safe to ignore, notify security group</span>
00519 
00520             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, *RXactContext );
00521 
00522             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00523         }
00524 
00525         <span class="keywordflow">return</span>( STATUS_RXACT_STATE_CREATED );
00526     }
00527 
00528 
00529 
00530     <span class="comment">//</span>
00531     <span class="comment">// We have opened an existing RXACT key.</span>
00532     <span class="comment">// See if it is a revision level we know about.</span>
00533     <span class="comment">//</span>
00534 
00535     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/rtl_2registry_8c.html#a3">RtlpNtQueryValueKey</a>(
00536                  RXactKey,              <span class="comment">// KeyHandle</span>
00537                  &amp;KeyValueType,         <span class="comment">// KeyValueType</span>
00538                  &amp;RXactKeyValue,        <span class="comment">// KeyValue</span>
00539                  &amp;KeyValueLength,       <span class="comment">// KeyValueLength</span>
00540                  &amp;LastWriteTime         <span class="comment">// LastWriteTime</span>
00541                  );
00542 
00543 
00544     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00545 
00546         <span class="comment">//</span>
00547         <span class="comment">// Something prevented value query...</span>
00548         <span class="comment">//</span>
00549 
00550         TmpStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( RXactKey );
00551         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus)); <span class="comment">//Safe to ignore, notify security group</span>
00552         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, *RXactContext );
00553         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00554     }
00555 
00556 
00557     <span class="keywordflow">if</span> ( KeyValueLength != (ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__RTLP__RXACT.html">RTLP_RXACT</a>) ) {
00558         TmpStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( RXactKey );
00559         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus)); <span class="comment">//Safe to ignore, notify security group</span>
00560         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, *RXactContext );
00561         <span class="keywordflow">return</span>( STATUS_UNKNOWN_REVISION );
00562     }
00563 
00564     <span class="keywordflow">if</span> (RXactKeyValue.<a class="code" href="../../d1/d7/struct__RTLP__RXACT.html#o0">Revision</a> != <a class="code" href="../../d5/d4/rxact_8c.html#a1">RTLP_RXACT_REVISION1</a>) {
00565         TmpStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( RXactKey );
00566         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus)); <span class="comment">//Safe to ignore, notify security group</span>
00567         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, *RXactContext );
00568         <span class="keywordflow">return</span>( STATUS_UNKNOWN_REVISION );
00569     }
00570 
00571 
00572 
00573     <span class="comment">//</span>
00574     <span class="comment">// Right revision...</span>
00575     <span class="comment">// See if there is a transaction or commit in progress.  If not,</span>
00576     <span class="comment">// return success</span>
00577     <span class="comment">//</span>
00578 
00579     <span class="comment">//</span>
00580     <span class="comment">// If a log file exists, then we are committing.</span>
00581     <span class="comment">//</span>
00582 
00583     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, <a class="code" href="../../d5/d4/rxact_8c.html#a4">RTLP_RXACT_LOG_NAME</a> );
00584 
00585     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00586                  RXactKey,
00587                  &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00588                  KeyValueBasicInformation,
00589                  &amp;BasicInformation,
00590                  128,
00591                  &amp;ResultLength
00592                  );
00593 
00594     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00595 
00596         <span class="comment">//</span>
00597         <span class="comment">// We found a value called 'Log'.  This means that a commit</span>
00598         <span class="comment">// was in progress.</span>
00599         <span class="comment">//</span>
00600 
00601         <span class="keywordflow">if</span> ( CommitIfNecessary ) {
00602 
00603             <span class="comment">//</span>
00604             <span class="comment">// Query the full value of the log, then call a low level routine</span>
00605             <span class="comment">// to actually perform the commit.</span>
00606             <span class="comment">//</span>
00607 
00608             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00609                          RXactKey,
00610                          &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00611                          KeyValueFullInformation,
00612                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00613                          0,
00614                          &amp;ResultLength
00615                          );
00616 
00617             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_TOO_SMALL ) {
00618                 <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00619             }
00620 
00621             FullInformation = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, ResultLength );
00622 
00623             <span class="keywordflow">if</span> ( FullInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00624                 <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
00625             }
00626 
00627 
00628             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00629                          RXactKey,
00630                          &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00631                          KeyValueFullInformation,
00632                          FullInformation,
00633                          ResultLength,
00634                          &amp;ResultLength
00635                          );
00636 
00637             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00638 
00639                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, FullInformation );
00640                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, *RXactContext );
00641                 <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00642             }
00643 
00644             <span class="comment">//</span>
00645             <span class="comment">// The log information is buried in the returned FullInformation</span>
00646             <span class="comment">// buffer.  Dig it out and make the RXactLog in the RXactContext</span>
00647             <span class="comment">// structure point to it.  Then commit.</span>
00648             <span class="comment">//</span>
00649 
00650             (*RXactContext)-&gt;RXactLog = (PRTL_RXACT_LOG)((PCHAR)FullInformation + FullInformation-&gt;DataOffset);
00651 
00652             <span class="comment">//</span>
00653             <span class="comment">// Don't use any handles we may find in the log file</span>
00654             <span class="comment">//</span>
00655 
00656             (*RXactContext)-&gt;HandlesValid = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00657 
00658             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/rxact_8c.html#a15">RXactpCommit</a>( *RXactContext );
00659 
00660             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00661 
00662                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, FullInformation );
00663                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, *RXactContext );
00664                 <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00665             }
00666 
00667 
00668             <span class="comment">//</span>
00669             <span class="comment">// The commit was successful.  Clean up.</span>
00670             <span class="comment">// Delete the log file value and data</span>
00671             <span class="comment">//</span>
00672 
00673             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>( RXactKey, &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> );
00674 
00675             <span class="comment">//</span>
00676             <span class="comment">// This should never fail</span>
00677             <span class="comment">//</span>
00678 
00679             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
00680 
00681             <span class="comment">//</span>
00682             <span class="comment">// Get rid of the in memory data structures.  Abort</span>
00683             <span class="comment">// will free the RXactLog, so put what we want</span>
00684             <span class="comment">// freed in there and it will go away.</span>
00685             <span class="comment">//</span>
00686 
00687             (*RXactContext)-&gt;RXactLog = (PRTL_RXACT_LOG)FullInformation;
00688 
00689             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/rxact_8c.html#a20">RtlAbortRXact</a>( *RXactContext );
00690 
00691             <span class="comment">//</span>
00692             <span class="comment">// This should never fail</span>
00693             <span class="comment">//</span>
00694 
00695             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
00696             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00697         } <span class="keywordflow">else</span> {
00698 
00699             <span class="keywordflow">return</span>( STATUS_RXACT_COMMIT_NECESSARY );
00700         }
00701 
00702     } <span class="keywordflow">else</span> {
00703 
00704         <span class="comment">//</span>
00705         <span class="comment">// No log, so nothing to do here.</span>
00706         <span class="comment">//</span>
00707 
00708         <span class="keywordflow">return</span>( STATUS_SUCCESS );
00709     }
00710 
00711 }
00712 
00713 
00714 
00715 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00716"></a><a class="code" href="../../d5/d4/rxact_8c.html#a17">00716</a> <a class="code" href="../../d5/d4/rxact_8c.html#a17">RXactInitializeContext</a>(
00717     IN PRTL_RXACT_CONTEXT RXactContext,
00718     IN HANDLE RootRegistryKey,
00719     IN HANDLE RXactKey
00720     )
00721 
00722 <span class="comment">/*++</span>
00723 <span class="comment"></span>
00724 <span class="comment">Routine Description:</span>
00725 <span class="comment"></span>
00726 <span class="comment">    Initializes an in-memory RXactContext structure.</span>
00727 <span class="comment"></span>
00728 <span class="comment">Arguments:</span>
00729 <span class="comment"></span>
00730 <span class="comment">    RXactContext - Supplies a pointer to an RXact Context created</span>
00731 <span class="comment">        by RtlInitializeRXact.</span>
00732 <span class="comment"></span>
00733 <span class="comment">    RootRegistryKey - Supplies the RootRegistryKey for this component.</span>
00734 <span class="comment"></span>
00735 <span class="comment">    RXactKey - Supplies the {RootRegistryKey}\RXactKey for this component</span>
00736 <span class="comment"></span>
00737 <span class="comment"></span>
00738 <span class="comment">Return Value:</span>
00739 <span class="comment"></span>
00740 <span class="comment">    None.</span>
00741 <span class="comment"></span>
00742 <span class="comment">--*/</span>
00743 
00744 {
00745     <span class="comment">//</span>
00746     <span class="comment">// Initialize the RXactContext for this client</span>
00747     <span class="comment">//</span>
00748 
00749     RXactContext-&gt;RootRegistryKey      = RootRegistryKey;
00750     RXactContext-&gt;HandlesValid         = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00751     RXactContext-&gt;RXactLog             = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00752     RXactContext-&gt;RXactKey             = RXactKey;
00753 
00754     <span class="keywordflow">return</span>;
00755 }
00756 
00757 
00758 
00759 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00760"></a><a class="code" href="../../d5/d4/rxact_8c.html#a19">00760</a> <a class="code" href="../../d5/d4/rxact_8c.html#a19">RtlStartRXact</a>(
00761     IN PRTL_RXACT_CONTEXT RXactContext
00762     )
00763 
00764 <span class="comment">/*++</span>
00765 <span class="comment"></span>
00766 <span class="comment">Routine Description:</span>
00767 <span class="comment"></span>
00768 <span class="comment">    This routine is used to start a new transaction in a registry sub-tree.</span>
00769 <span class="comment">    Transactions must be serialized by the server so that only one transaction</span>
00770 <span class="comment">    is in progress at a time.</span>
00771 <span class="comment"></span>
00772 <span class="comment">Arguments:</span>
00773 <span class="comment"></span>
00774 <span class="comment">    RXactContext - Supplies a pointer to an RTL_RXACT_CONTEXT structure</span>
00775 <span class="comment">        that is not currently in use.</span>
00776 <span class="comment"></span>
00777 <span class="comment">Return Value:</span>
00778 <span class="comment"></span>
00779 <span class="comment">    STATUS_SUCCESS - Indicates the transaction was started.</span>
00780 <span class="comment"></span>
00781 <span class="comment">    STATUS_RXACT_INVALID_STATE - Indicates that the transaction state</span>
00782 <span class="comment">        of the registry sub-tree is incompatible with the requested operation.</span>
00783 <span class="comment">        For example, a request to start a new transaction while one is already</span>
00784 <span class="comment">        in progress, or a request to apply a transaction when one is not</span>
00785 <span class="comment">        currently in progress.  This may also indicate that there is no</span>
00786 <span class="comment">        transaction state at all for the specified registry sub-tree.</span>
00787 <span class="comment"></span>
00788 <span class="comment">--*/</span>
00789 {
00790     PRTL_RXACT_LOG RXactLogHeader;
00791 
00792     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00793 
00794     <span class="comment">//</span>
00795     <span class="comment">// Allocate in-memory log file and initialize.  This implicitly</span>
00796     <span class="comment">// sets the state to 'transaction in progress'.</span>
00797     <span class="comment">//</span>
00798 
00799     <span class="keywordflow">if</span> ( RXactContext-&gt;RXactLog != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00800 
00801         <span class="comment">//</span>
00802         <span class="comment">// There is already a transaction in progress for this</span>
00803         <span class="comment">// context.  Return an error.</span>
00804         <span class="comment">//</span>
00805 
00806         <span class="keywordflow">return</span>( STATUS_RXACT_INVALID_STATE );
00807     }
00808 
00809     RXactLogHeader = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, <a class="code" href="../../d5/d4/rxact_8c.html#a5">RTLP_INITIAL_LOG_SIZE</a> );
00810 
00811     <span class="keywordflow">if</span> ( RXactLogHeader == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00812         <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
00813     }
00814 
00815     <span class="comment">//</span>
00816     <span class="comment">// Fill in the log header information at the top of the</span>
00817     <span class="comment">// newly allocated buffer.</span>
00818     <span class="comment">//</span>
00819 
00820 
00821     RXactLogHeader-&gt;OperationCount = 0;
00822     RXactLogHeader-&gt;LogSize        = <a class="code" href="../../d5/d4/rxact_8c.html#a5">RTLP_INITIAL_LOG_SIZE</a>;
00823     RXactLogHeader-&gt;LogSizeInUse   = <span class="keyword">sizeof</span>( RTL_RXACT_LOG );
00824 
00825     RXactContext-&gt;RXactLog = RXactLogHeader;
00826 
00827     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00828 
00829 }
00830 
00831 
00832 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00833"></a><a class="code" href="../../d5/d4/rxact_8c.html#a20">00833</a> <a class="code" href="../../d5/d4/rxact_8c.html#a20">RtlAbortRXact</a>(
00834     IN PRTL_RXACT_CONTEXT RXactContext
00835     )
00836 
00837 <span class="comment">/*++</span>
00838 <span class="comment"></span>
00839 <span class="comment">Routine Description:</span>
00840 <span class="comment"></span>
00841 <span class="comment">    This routine is used to abort a transaction in a registry sub-tree.</span>
00842 <span class="comment"></span>
00843 <span class="comment">Arguments:</span>
00844 <span class="comment"></span>
00845 <span class="comment">    RootRegistryKey - A handle to the registry key within whose sub-tree</span>
00846 <span class="comment">        the transaction is to be aborted.</span>
00847 <span class="comment"></span>
00848 <span class="comment">Return Value:</span>
00849 <span class="comment"></span>
00850 <span class="comment">    STATUS_SUCCESS - Indicates the transaction was aborted.</span>
00851 <span class="comment"></span>
00852 <span class="comment"></span>
00853 <span class="comment">    STATUS_UNKNOWN_REVISION - Indicates that a transaction state</span>
00854 <span class="comment">        exists for the specified sub-tree, but has a revision level that is</span>
00855 <span class="comment">        unknown by this service.</span>
00856 <span class="comment"></span>
00857 <span class="comment"></span>
00858 <span class="comment">    STATUS_RXACT_INVALID_STATE - Indicates that the transaction state</span>
00859 <span class="comment">        of the registry sub-tree is incompatible with the requested operation.</span>
00860 <span class="comment">        For example, a request to start a new transaction while one is already</span>
00861 <span class="comment">        in progress, or a request to apply a transaction when one is not</span>
00862 <span class="comment">        currently in progress.  This may also indicate that there is no</span>
00863 <span class="comment">        transaction state at all for the specified registry sub-tree.</span>
00864 <span class="comment"></span>
00865 <span class="comment">--*/</span>
00866 
00867 {
00868     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00869 
00870     <span class="keywordflow">if</span> ( RXactContext-&gt;RXactLog == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00871 
00872         <span class="comment">//</span>
00873         <span class="comment">// There is no transaction in progress for this</span>
00874         <span class="comment">// context.  Return an error.</span>
00875         <span class="comment">//</span>
00876 
00877         <span class="keywordflow">return</span>( STATUS_RXACT_INVALID_STATE );
00878     }
00879 
00880     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, RXactContext-&gt;RXactLog );
00881 
00882     <span class="comment">//</span>
00883     <span class="comment">// Reinitialize the RXactContext structure with the same initial data.</span>
00884     <span class="comment">//</span>
00885 
00886     <a class="code" href="../../d5/d4/rxact_8c.html#a17">RXactInitializeContext</a>(
00887         RXactContext,
00888         RXactContext-&gt;RootRegistryKey,
00889         RXactContext-&gt;RXactKey
00890         );
00891 
00892 
00893     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00894 
00895 }
00896 
00897 
00898 
00899 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00900"></a><a class="code" href="../../d5/d4/rxact_8c.html#a21">00900</a> <a class="code" href="../../d5/d4/rxact_8c.html#a21">RtlAddAttributeActionToRXact</a>(
00901     IN PRTL_RXACT_CONTEXT RXactContext,
00902     IN RTL_RXACT_OPERATION Operation,
00903     IN PUNICODE_STRING SubKeyName,
00904     IN HANDLE KeyHandle OPTIONAL,
00905     IN PUNICODE_STRING AttributeName,
00906     IN ULONG NewValueType,
00907     IN PVOID NewValue,
00908     IN ULONG NewValueLength
00909     )
00910 
00911 <span class="comment">/*++</span>
00912 <span class="comment"></span>
00913 <span class="comment">Routine Description:</span>
00914 <span class="comment"></span>
00915 <span class="comment">    This routine is used to add a new action to the transaction operation log.</span>
00916 <span class="comment">    Upon commit, these operations are applied in the order they are added</span>
00917 <span class="comment">    to the log.</span>
00918 <span class="comment"></span>
00919 <span class="comment">    This routine differs from RtlAddActionToRXact in that it takes an Attribute</span>
00920 <span class="comment">    Name parameter, rather than using the default ("NULL") Attribute of the</span>
00921 <span class="comment">    specified key.</span>
00922 <span class="comment"></span>
00923 <span class="comment"></span>
00924 <span class="comment">Arguments:</span>
00925 <span class="comment"></span>
00926 <span class="comment">    RXactContext - Supplies a pointer to the RXactContext structure for this</span>
00927 <span class="comment">        subsystem's root registry key.</span>
00928 <span class="comment"></span>
00929 <span class="comment">    Operation - Indicates the type of operation to perform (e.g., delete</span>
00930 <span class="comment">        a sub-key or set the value of a sub-key).  Sub-keys may be created</span>
00931 <span class="comment">        by setting a value of a previously non-existent sub-key.  This will</span>
00932 <span class="comment">        cause all sub-keys between the root and the specified sub-key to</span>
00933 <span class="comment">        be created.</span>
00934 <span class="comment"></span>
00935 <span class="comment">    SubKeyName - Specifies the name of the target registry key.  This name</span>
00936 <span class="comment">        is relative to the Root of the Registry transaction sub-tree</span>
00937 <span class="comment">        and must NOT start with a delimiter character ("\").</span>
00938 <span class="comment"></span>
00939 <span class="comment">    KeyHandle - Optionally supplies a handle to the target key.  If</span>
00940 <span class="comment">        not specified, the name passed for SubKeyName will determine</span>
00941 <span class="comment">        the target key.</span>
00942 <span class="comment"></span>
00943 <span class="comment">    AttributeName - Supplies the name of the key attribute to be</span>
00944 <span class="comment">        modified.</span>
00945 <span class="comment"></span>
00946 <span class="comment">    NewKeyValueType - (Optional) Contains the KeyValueType to assign</span>
00947 <span class="comment">        to the target registry key.  This parameter is ignored if the</span>
00948 <span class="comment">        Operation is not RtlRXactOperationSetValue.</span>
00949 <span class="comment"></span>
00950 <span class="comment">    NewKeyValue -  (Optional) Points to a buffer containing the value</span>
00951 <span class="comment">        to assign to the specified target registry key.  This parameter</span>
00952 <span class="comment">        is ignored if the Operation is not RtlRXactOperationSetValue.</span>
00953 <span class="comment"></span>
00954 <span class="comment">    NewKeyValueLength - Indicates the length (number of bytes) of the</span>
00955 <span class="comment">        NewKeyValue buffer.  This parameter is ignored if the Operation</span>
00956 <span class="comment">        is not RtlRXactOperationSetValue.</span>
00957 <span class="comment"></span>
00958 <span class="comment"></span>
00959 <span class="comment">Return Value:</span>
00960 <span class="comment"></span>
00961 <span class="comment">    STATUS_SUCCESS - Indicates the request completed successfully..</span>
00962 <span class="comment"></span>
00963 <span class="comment">    STATUS_INVALID_PARAMETER - Indicates that an unknown Operation</span>
00964 <span class="comment">        was requested.</span>
00965 <span class="comment"></span>
00966 <span class="comment">    STATUS_NO_MEMORY - Insufficient memeory was available to complete</span>
00967 <span class="comment">        this operation.</span>
00968 <span class="comment"></span>
00969 <span class="comment">    STATUS_UNKNOWN_REVISION - Indicates that a transaction state</span>
00970 <span class="comment">        exists for the specified sub-tree, but has a revision level that is</span>
00971 <span class="comment">        unknown by this service.</span>
00972 <span class="comment"></span>
00973 <span class="comment"></span>
00974 <span class="comment">--*/</span>
00975 
00976 {
00977 
00978     PRTL_RXACT_LOG   NewLog;
00979     <a class="code" href="../../d5/d4/rxact_8c.html#a12">PRXACT_LOG_ENTRY</a> Base;
00980 
00981     ULONG <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00982     ULONG LogEntrySize;
00983     ULONG NewLogSize;
00984 
00985     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00986 
00987     <span class="comment">//</span>
00988     <span class="comment">// Make sure we were passed a legitimate operation.</span>
00989     <span class="comment">//</span>
00990 
00991     <span class="keywordflow">if</span> (  (Operation != RtlRXactOperationDelete)  &amp;&amp;
00992           (Operation != RtlRXactOperationSetValue)   ) {
00993         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00994     }
00995 
00996     <span class="comment">//</span>
00997     <span class="comment">// Compute the total size of the new data</span>
00998     <span class="comment">//</span>
00999 
01000     LogEntrySize = <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html">RXACT_LOG_ENTRY</a> )               +
01001                    <a class="code" href="../../d5/d4/rxact_8c.html#a6">DwordAlign</a>( SubKeyName-&gt;Length )        +
01002                    <a class="code" href="../../d5/d4/rxact_8c.html#a6">DwordAlign</a>( AttributeName-&gt;Length )     +
01003                    <a class="code" href="../../d5/d4/rxact_8c.html#a6">DwordAlign</a>( NewValueLength );
01004 
01005     LogEntrySize = <a class="code" href="../../d0/d9/ntosdef_8h.html#a4">ALIGN_UP</a>( LogEntrySize, PVOID );
01006 
01007     <span class="comment">//</span>
01008     <span class="comment">// Make sure there is enough space in the current</span>
01009     <span class="comment">// log file for this data.  If not, we must create</span>
01010     <span class="comment">// a larger log, copy all the old data, and then</span>
01011     <span class="comment">// append this to the end.</span>
01012     <span class="comment">//</span>
01013 
01014     <span class="keywordflow">if</span> ( RXactContext-&gt;RXactLog-&gt;LogSizeInUse + LogEntrySize &gt;
01015                                    RXactContext-&gt;RXactLog-&gt;LogSize ) {
01016 
01017         <span class="comment">//</span>
01018         <span class="comment">// We must allocate a bigger log file.</span>
01019         <span class="comment">//</span>
01020 
01021         NewLogSize = RXactContext-&gt;RXactLog-&gt;LogSize;
01022 
01023         <span class="keywordflow">do</span> {
01024 
01025             NewLogSize = NewLogSize * 2;
01026 
01027         } <span class="keywordflow">while</span> ( NewLogSize &lt;
01028             ( RXactContext-&gt;RXactLog-&gt;LogSizeInUse + LogEntrySize ) );
01029 
01030         NewLog = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, NewLogSize );
01031 
01032         <span class="keywordflow">if</span> ( NewLog == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01033             <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
01034         }
01035 
01036         <span class="comment">//</span>
01037         <span class="comment">// Copy over previous information</span>
01038         <span class="comment">//</span>
01039 
01040         RtlMoveMemory( NewLog, RXactContext-&gt;RXactLog, RXactContext-&gt;RXactLog-&gt;LogSizeInUse );
01041 
01042         <span class="comment">//</span>
01043         <span class="comment">// Free the old log file</span>
01044         <span class="comment">//</span>
01045 
01046         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, RXactContext-&gt;RXactLog );
01047 
01048         <span class="comment">//</span>
01049         <span class="comment">// Install the new log file and adjust its size in its header</span>
01050         <span class="comment">//</span>
01051 
01052         RXactContext-&gt;RXactLog = NewLog;
01053         RXactContext-&gt;RXactLog-&gt;LogSize = NewLogSize;
01054     }
01055 
01056     <span class="comment">//</span>
01057     <span class="comment">// The log file is big enough, append data to</span>
01058     <span class="comment">// the end.</span>
01059     <span class="comment">//</span>
01060 
01061     Base = (<a class="code" href="../../d5/d4/rxact_8c.html#a12">PRXACT_LOG_ENTRY</a>)((PCHAR)(RXactContext-&gt;RXactLog) +
01062                              (RXactContext-&gt;RXactLog-&gt;LogSizeInUse));
01063 
01064 
01065     <span class="comment">//</span>
01066     <span class="comment">// Append each parameter to the end of the log.  Unicode string data</span>
01067     <span class="comment">// will be appended to the end of the entry.  The Buffer field in the</span>
01068     <span class="comment">// Unicode string structure will contain the offset to the Buffer,</span>
01069     <span class="comment">// relative to the beginning of the log file.</span>
01070     <span class="comment">//</span>
01071 
01072     Base-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o0">LogEntrySize</a>      = LogEntrySize;
01073     Base-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o1">Operation</a>         = Operation;
01074     Base-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o2">SubKeyName</a>        = *SubKeyName;
01075     Base-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o3">AttributeName</a>     = *AttributeName;
01076     Base-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o5">NewKeyValueType</a>   = NewValueType;
01077     Base-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o6">NewKeyValueLength</a> = NewValueLength;
01078     Base-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o4">KeyHandle</a>         = KeyHandle;
01079 
01080     <span class="comment">//</span>
01081     <span class="comment">// Fill in the variable length data: SubKeyName, AttributeName,</span>
01082     <span class="comment">// and NewKeyValue</span>
01083     <span class="comment">//</span>
01084 
01085     <span class="comment">//</span>
01086     <span class="comment">// End is an offset relative to the beginning of the entire log</span>
01087     <span class="comment">// structure.  It is initialized to 'point' to the offset immediately</span>
01088     <span class="comment">// following the structure we just filled in above.</span>
01089     <span class="comment">//</span>
01090 
01091     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = (ULONG)((RXactContext-&gt;RXactLog-&gt;LogSizeInUse) +
01092                  <span class="keyword">sizeof</span>( *Base ));
01093 
01094 
01095     <span class="comment">//</span>
01096     <span class="comment">// Append SubKeyName information to the log file</span>
01097     <span class="comment">//</span>
01098 
01099     RtlMoveMemory (
01100         (PCHAR)(RXactContext-&gt;RXactLog) + <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>,
01101         SubKeyName-&gt;Buffer,
01102         SubKeyName-&gt;Length
01103         );
01104 
01105     Base-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o2">SubKeyName</a>.Buffer = (PWSTR)ULongToPtr(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>);
01106     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> += <a class="code" href="../../d5/d4/rxact_8c.html#a6">DwordAlign</a>( SubKeyName-&gt;Length );
01107 
01108 
01109 
01110     <span class="comment">//</span>
01111     <span class="comment">// Append AttributeName information to the log file</span>
01112     <span class="comment">//</span>
01113 
01114 
01115     RtlMoveMemory(
01116         (PCHAR)(RXactContext-&gt;RXactLog) + <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>,
01117         AttributeName-&gt;Buffer,
01118         AttributeName-&gt;Length
01119         );
01120 
01121     Base-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o3">AttributeName</a>.Buffer = (PWSTR)ULongToPtr(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>);
01122     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> += <a class="code" href="../../d5/d4/rxact_8c.html#a6">DwordAlign</a>( AttributeName-&gt;Length );
01123 
01124 
01125 
01126     <span class="comment">//</span>
01127     <span class="comment">// Append NewKeyValue information (if present) to the log file</span>
01128     <span class="comment">//</span>
01129 
01130     <span class="keywordflow">if</span> ( Operation == RtlRXactOperationSetValue ) {
01131 
01132         RtlMoveMemory(
01133             (PCHAR)(RXactContext-&gt;RXactLog) + <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>,
01134             NewValue,
01135             NewValueLength
01136             );
01137 
01138         Base-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o7">NewKeyValue</a> = (PVOID)ULongToPtr(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>);
01139         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> += <a class="code" href="../../d5/d4/rxact_8c.html#a6">DwordAlign</a>( NewValueLength );
01140     }
01141 
01142     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = <a class="code" href="../../d0/d9/ntosdef_8h.html#a4">ALIGN_UP</a>( <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>, PVOID );
01143 
01144     RXactContext-&gt;RXactLog-&gt;LogSizeInUse = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
01145     RXactContext-&gt;RXactLog-&gt;OperationCount++;
01146 
01147     <span class="comment">//</span>
01148     <span class="comment">// We're done</span>
01149     <span class="comment">//</span>
01150 
01151     <span class="keywordflow">return</span>(STATUS_SUCCESS);
01152 }
01153 
01154 
01155 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01156"></a><a class="code" href="../../d5/d4/rxact_8c.html#a22">01156</a> <a class="code" href="../../d5/d4/rxact_8c.html#a22">RtlAddActionToRXact</a>(
01157     IN PRTL_RXACT_CONTEXT RXactContext,
01158     IN RTL_RXACT_OPERATION Operation,
01159     IN PUNICODE_STRING SubKeyName,
01160     IN ULONG NewKeyValueType,
01161     IN PVOID NewKeyValue OPTIONAL,
01162     IN ULONG NewKeyValueLength
01163     )
01164 
01165 <span class="comment">/*++</span>
01166 <span class="comment"></span>
01167 <span class="comment">Routine Description:</span>
01168 <span class="comment"></span>
01169 <span class="comment">    This routine is used to add a new action to the transaction operation log.</span>
01170 <span class="comment">    Upon commit, these operations are applied in the order they are added</span>
01171 <span class="comment">    to the log.</span>
01172 <span class="comment"></span>
01173 <span class="comment">Arguments:</span>
01174 <span class="comment"></span>
01175 <span class="comment">    RXactContext - Supplies a pointer to the RXactContext structure for this</span>
01176 <span class="comment">        subsystem's root registry key.</span>
01177 <span class="comment"></span>
01178 <span class="comment">    Operation - Indicates the type of operation to perform (e.g., delete</span>
01179 <span class="comment">        a sub-key or set the value of a sub-key).  Sub-keys may be created</span>
01180 <span class="comment">        by setting a value of a previously non-existent sub-key.  This will</span>
01181 <span class="comment">        cause all sub-keys between the root and the specified sub-key to</span>
01182 <span class="comment">        be created.</span>
01183 <span class="comment"></span>
01184 <span class="comment">    SubKeyName - Specifies the name of the target registry key.  This name</span>
01185 <span class="comment">        is relative to the Root of the Registry transaction sub-tree</span>
01186 <span class="comment">        and must NOT start with a delimiter character ("\").</span>
01187 <span class="comment"></span>
01188 <span class="comment">    NewKeyValueType - (Optional) Contains the KeyValueType to assign</span>
01189 <span class="comment">        to the target registry key.  This parameter is ignored if the</span>
01190 <span class="comment">        Operation is not RtlRXactOperationSetValue.</span>
01191 <span class="comment"></span>
01192 <span class="comment">    NewKeyValue -  (Optional) Points to a buffer containing the value</span>
01193 <span class="comment">        to assign to the specified target registry key.  This parameter</span>
01194 <span class="comment">        is ignored if the Operation is not RtlRXactOperationSetValue.</span>
01195 <span class="comment"></span>
01196 <span class="comment">    NewKeyValueLength - Indicates the length (number of bytes) of the</span>
01197 <span class="comment">        NewKeyValue buffer.  This parameter is ignored if the Operation</span>
01198 <span class="comment">        is not RtlRXactOperationSetValue.</span>
01199 <span class="comment"></span>
01200 <span class="comment">Return Value:</span>
01201 <span class="comment"></span>
01202 <span class="comment">    STATUS_SUCCESS - Indicates the request completed successfully..</span>
01203 <span class="comment"></span>
01204 <span class="comment"></span>
01205 <span class="comment">    STATUS_UNKNOWN_REVISION - Indicates that a transaction state</span>
01206 <span class="comment">        exists for the specified sub-tree, but has a revision level that is</span>
01207 <span class="comment">        unknown by this service.</span>
01208 <span class="comment"></span>
01209 <span class="comment">    Others - Other status values that may be returned from registry key</span>
01210 <span class="comment">        services (such as STATUS_ACCESS_DENIED).</span>
01211 <span class="comment"></span>
01212 <span class="comment">--*/</span>
01213 {
01214     UNICODE_STRING AttributeName;
01215     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01216 
01217     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01218 
01219     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;AttributeName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01220 
01221     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/rxact_8c.html#a21">RtlAddAttributeActionToRXact</a>(
01222                  RXactContext,
01223                  Operation,
01224                  SubKeyName,
01225                  <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>,
01226                  &amp;AttributeName,
01227                  NewKeyValueType,
01228                  NewKeyValue,
01229                  NewKeyValueLength
01230                  );
01231 
01232     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01233 
01234 
01235 }
01236 
01237 
01238 
01239 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01240"></a><a class="code" href="../../d5/d4/rxact_8c.html#a23">01240</a> <a class="code" href="../../d5/d4/rxact_8c.html#a23">RtlApplyRXact</a>(
01241     IN PRTL_RXACT_CONTEXT RXactContext
01242     )
01243 
01244 <span class="comment">/*++</span>
01245 <span class="comment"></span>
01246 <span class="comment">Routine Description:</span>
01247 <span class="comment"></span>
01248 <span class="comment">    This routine is used to apply the changes of a registry sub-tree</span>
01249 <span class="comment">    Transaction to that registry sub-tree.  This routine is meant to be</span>
01250 <span class="comment">    called for the common case, where the hive is automatically</span>
01251 <span class="comment">    lazy-flushed.  That means that this routine must write the change log</span>
01252 <span class="comment">    to disk, then flush the hive (to ensure that pieces of changes aren't</span>
01253 <span class="comment">    lazy-written to disk before this routine finishes an atomic operation),</span>
01254 <span class="comment">    the apply the changes, then delete the change log.</span>
01255 <span class="comment"></span>
01256 <span class="comment">    The actual changes will be lazy-written to disk, but the registry</span>
01257 <span class="comment">    guarantees that none or all will make it.  If the machine goes down</span>
01258 <span class="comment">    while this routine is executing, the flushed change log guarantees</span>
01259 <span class="comment">    that the hive can be put into a consistent state.</span>
01260 <span class="comment"></span>
01261 <span class="comment">Arguments:</span>
01262 <span class="comment"></span>
01263 <span class="comment">    RXactContext - Supplies a pointer to the RXactContext structure for this</span>
01264 <span class="comment">        subsystem's root registry key.</span>
01265 <span class="comment"></span>
01266 <span class="comment">Return Value:</span>
01267 <span class="comment"></span>
01268 <span class="comment">    STATUS_SUCCESS - Indicates the transaction was completed.</span>
01269 <span class="comment"></span>
01270 <span class="comment">    STATUS_UNKNOWN_REVISION - Indicates that a transaction state</span>
01271 <span class="comment">        exists for the specified sub-tree, but has a revision level that is</span>
01272 <span class="comment">        unknown by this service.</span>
01273 <span class="comment"></span>
01274 <span class="comment"></span>
01275 <span class="comment">    STATUS_RXACT_INVALID_STATE - Indicates that the transaction state</span>
01276 <span class="comment">        of the registry sub-tree is incompatible with the requested operation.</span>
01277 <span class="comment">        For example, a request to start a new transaction while one is already</span>
01278 <span class="comment">        in progress, or a request to apply a transaction when one is not</span>
01279 <span class="comment">        currently in progress.  This may also indicate that there is no</span>
01280 <span class="comment">        transaction state at all for the specified registry sub-tree.</span>
01281 <span class="comment"></span>
01282 <span class="comment"></span>
01283 <span class="comment">--*/</span>
01284 {
01285     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01286     UNICODE_STRING LogName;
01287     HANDLE RXactKey;
01288 
01289     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01290 
01291     <span class="comment">//</span>
01292     <span class="comment">// Commit the contents of the current log to disk</span>
01293     <span class="comment">//</span>
01294 
01295     RXactKey = RXactContext-&gt;RXactKey;
01296 
01297     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;LogName, <a class="code" href="../../d5/d4/rxact_8c.html#a4">RTLP_RXACT_LOG_NAME</a> );
01298 
01299     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>( RXactKey,
01300                             &amp;LogName,        <span class="comment">// ValueName</span>
01301                             0,               <span class="comment">// TitleIndex</span>
01302                             REG_BINARY,
01303                             RXactContext-&gt;RXactLog,
01304                             RXactContext-&gt;RXactLog-&gt;LogSizeInUse
01305                             );
01306 
01307     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01308         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01309     }
01310 
01311     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a19">NtFlushKey</a>( RXactKey );
01312 
01313     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01314 
01315         <span class="comment">//</span>
01316         <span class="comment">// If this fails, maintain the in-memory data,</span>
01317         <span class="comment">// but get rid of what we just tried to write</span>
01318         <span class="comment">// to disk.</span>
01319         <span class="comment">//</span>
01320         <span class="comment">// Ignore the error, since we're in a funky</span>
01321         <span class="comment">// state right now.</span>
01322         <span class="comment">//</span>
01323 
01324         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>( RXactKey, &amp;LogName );
01325 
01326         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01327     }
01328 
01329     <span class="comment">//</span>
01330     <span class="comment">// The log is safe, now execute what is in it</span>
01331     <span class="comment">//</span>
01332 
01333     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/rxact_8c.html#a15">RXactpCommit</a>( RXactContext );
01334 
01335     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01336 
01337         <span class="comment">//</span>
01338         <span class="comment">// As above, try to get rid of what's on</span>
01339         <span class="comment">// disk, leave the in-memory stuff alone,</span>
01340         <span class="comment">// so that the caller may try again.</span>
01341         <span class="comment">//</span>
01342 
01343         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>( RXactKey, &amp;LogName );
01344 
01345         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01346     }
01347 
01348     <span class="comment">//</span>
01349     <span class="comment">// Delete the log file value and data</span>
01350     <span class="comment">//</span>
01351 
01352     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>( RXactKey, &amp;LogName );
01353 
01354     <span class="comment">//</span>
01355     <span class="comment">// This should never fail</span>
01356     <span class="comment">//</span>
01357 
01358     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
01359 
01360     <span class="comment">//</span>
01361     <span class="comment">// Get rid of the in memory data structures.  Abort</span>
01362     <span class="comment">// does exactly what we want to do.</span>
01363     <span class="comment">//</span>
01364 
01365     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/rxact_8c.html#a20">RtlAbortRXact</a>( RXactContext );
01366 
01367     <span class="comment">//</span>
01368     <span class="comment">// This should never fail</span>
01369     <span class="comment">//</span>
01370 
01371     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
01372 
01373     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01374 
01375 }
01376 
01377 
01378 
01379 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01380"></a><a class="code" href="../../d5/d4/rxact_8c.html#a24">01380</a> <a class="code" href="../../d5/d4/rxact_8c.html#a24">RtlApplyRXactNoFlush</a>(
01381     IN PRTL_RXACT_CONTEXT RXactContext
01382     )
01383 
01384 <span class="comment">/*++</span>
01385 <span class="comment"></span>
01386 <span class="comment">Routine Description:</span>
01387 <span class="comment"></span>
01388 <span class="comment">    This routine is used to apply the changes of a registry sub-tree</span>
01389 <span class="comment">    Transaction to that registry sub-tree.  This routine should only be</span>
01390 <span class="comment">    called for special hives that do not have automatic lazy-flushing.</span>
01391 <span class="comment">    The caller must decide when to flush the hive in order to guarantee</span>
01392 <span class="comment">    a consistent hive.</span>
01393 <span class="comment"></span>
01394 <span class="comment">Arguments:</span>
01395 <span class="comment"></span>
01396 <span class="comment">    RXactContext - Supplies a pointer to the RXactContext structure for this</span>
01397 <span class="comment">        subsystem's root registry key.</span>
01398 <span class="comment"></span>
01399 <span class="comment">Return Value:</span>
01400 <span class="comment"></span>
01401 <span class="comment">    STATUS_SUCCESS - Indicates the transaction was completed.</span>
01402 <span class="comment"></span>
01403 <span class="comment">    STATUS_UNKNOWN_REVISION - Indicates that a transaction state</span>
01404 <span class="comment">        exists for the specified sub-tree, but has a revision level that is</span>
01405 <span class="comment">        unknown by this service.</span>
01406 <span class="comment"></span>
01407 <span class="comment"></span>
01408 <span class="comment">    STATUS_RXACT_INVALID_STATE - Indicates that the transaction state</span>
01409 <span class="comment">        of the registry sub-tree is incompatible with the requested operation.</span>
01410 <span class="comment">        For example, a request to start a new transaction while one is already</span>
01411 <span class="comment">        in progress, or a request to apply a transaction when one is not</span>
01412 <span class="comment">        currently in progress.  This may also indicate that there is no</span>
01413 <span class="comment">        transaction state at all for the specified registry sub-tree.</span>
01414 <span class="comment"></span>
01415 <span class="comment"></span>
01416 <span class="comment">--*/</span>
01417 {
01418     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01419 
01420     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01421 
01422     <span class="comment">//</span>
01423     <span class="comment">// Execute the contents of the RXACT log.</span>
01424     <span class="comment">//</span>
01425 
01426     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/rxact_8c.html#a15">RXactpCommit</a>( RXactContext );
01427 
01428     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
01429 
01430         <span class="comment">//</span>
01431         <span class="comment">// Get rid of the in memory data structures.  Abort</span>
01432         <span class="comment">// does exactly what we want to do.</span>
01433         <span class="comment">//</span>
01434 
01435         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/rxact_8c.html#a20">RtlAbortRXact</a>( RXactContext );
01436 
01437         <span class="comment">//</span>
01438         <span class="comment">// This should never fail</span>
01439         <span class="comment">//</span>
01440 
01441         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
01442     }
01443 
01444     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01445 
01446 }
01447 
01448 
01449 
01451 <span class="comment">//                                                                           //</span>
01452 <span class="comment">//    Internal Procedures   (defined in within this file)                    //</span>
01453 <span class="comment">//                                                                           //</span>
01455 <span class="comment"></span>
01456 
01457 
01458 
01459 
01460 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01461"></a><a class="code" href="../../d5/d4/rxact_8c.html#a15">01461</a> <a class="code" href="../../d5/d4/rxact_8c.html#a15">RXactpCommit</a>(
01462     IN PRTL_RXACT_CONTEXT RXactContext
01463     )
01464 
01465 <span class="comment">/*++</span>
01466 <span class="comment"></span>
01467 <span class="comment">Routine Description:</span>
01468 <span class="comment"></span>
01469 <span class="comment">    This routine commits the operations in the operation log.</span>
01470 <span class="comment"></span>
01471 <span class="comment">    When all changes have been applied, the transaction state</span>
01472 <span class="comment">    is changed to NO_TRANSACTION.</span>
01473 <span class="comment"></span>
01474 <span class="comment">Arguments:</span>
01475 <span class="comment"></span>
01476 <span class="comment">    RXactContext - Supplies a pointer to the RXactContext structure for this</span>
01477 <span class="comment">        subsystem's root registry key.</span>
01478 <span class="comment"></span>
01479 <span class="comment">Return Value:</span>
01480 <span class="comment"></span>
01481 <span class="comment">    STATUS_SUCCESS - Indicates the transaction was completed.</span>
01482 <span class="comment"></span>
01483 <span class="comment"></span>
01484 <span class="comment"></span>
01485 <span class="comment">--*/</span>
01486 {
01487     BOOLEAN HandlesValid;
01488 
01489     HANDLE TargetKey;
01490     HANDLE RXactKey;
01491     HANDLE RootRegistryKey;
01492 
01493     PRTL_RXACT_LOG      RXactLog;
01494     <a class="code" href="../../d5/d4/rxact_8c.html#a12">PRXACT_LOG_ENTRY</a>    RXactLogEntry;
01495     RTL_RXACT_OPERATION Operation;
01496 
01497     ULONG OperationCount;
01498     ULONG i;
01499 
01500     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01501     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> TmpStatus = STATUS_SUCCESS;
01502     BOOLEAN CloseTargetKey;
01503 
01504     <span class="comment">//</span>
01505     <span class="comment">// Extract information from the RXactContext to simplify</span>
01506     <span class="comment">// the code that follows</span>
01507     <span class="comment">//</span>
01508 
01509     RootRegistryKey = RXactContext-&gt;RootRegistryKey;
01510     RXactKey        = RXactContext-&gt;RXactKey;
01511     RXactLog        = RXactContext-&gt;RXactLog;
01512 
01513     OperationCount  = RXactLog-&gt;OperationCount;
01514 
01515     HandlesValid    = RXactContext-&gt;HandlesValid;
01516 
01517 
01518     <span class="comment">//</span>
01519     <span class="comment">// Keep a pointer to the beginning of the current log entry.</span>
01520     <span class="comment">//</span>
01521 
01522     RXactLogEntry = (<a class="code" href="../../d5/d4/rxact_8c.html#a12">PRXACT_LOG_ENTRY</a>)((PCHAR)RXactLog + <span class="keyword">sizeof</span>( RTL_RXACT_LOG ));
01523 
01524 
01525     <span class="comment">//</span>
01526     <span class="comment">// Go through and perform each operation log.  Notice that some operation</span>
01527     <span class="comment">// logs may already have been deleted by a previous commit attempt.</span>
01528     <span class="comment">// So, don't get alarmed if we don't successfully open some operation</span>
01529     <span class="comment">// log entry keys.</span>
01530     <span class="comment">//</span>
01531 
01532     <span class="keywordflow">for</span> ( i=0 ; i&lt;OperationCount ; i++ ) {
01533 
01534         <span class="comment">//</span>
01535         <span class="comment">// Turn the self-relative offsets in the structure</span>
01536         <span class="comment">// back into real pointers.</span>
01537         <span class="comment">//</span>
01538 
01539         RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o2">SubKeyName</a>.Buffer = (PWSTR) ((PCHAR)RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o2">SubKeyName</a>.Buffer +
01540                                                     (ULONG_PTR)RXactLog);
01541 
01542         RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o3">AttributeName</a>.Buffer = (PWSTR) ((PCHAR)RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o3">AttributeName</a>.Buffer +
01543                                                        (ULONG_PTR)RXactLog);
01544 
01545         RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o7">NewKeyValue</a> = (PVOID)((PCHAR)RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o7">NewKeyValue</a> + (ULONG_PTR)RXactLog);
01546 
01547         Operation = RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o1">Operation</a>;
01548 
01549         <span class="comment">//</span>
01550         <span class="comment">// Perform this operation</span>
01551         <span class="comment">//</span>
01552 
01553         <span class="keywordflow">switch</span> (Operation) {
01554             <span class="keywordflow">case</span> RtlRXactOperationDelete:
01555 
01556                 <span class="comment">//</span>
01557                 <span class="comment">// Open the target key and delete it.</span>
01558                 <span class="comment">// The name is relative to the RootRegistryKey.</span>
01559                 <span class="comment">//</span>
01560 
01561                 <span class="keywordflow">if</span> ( ((RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o4">KeyHandle</a> == <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>) || !HandlesValid) ) {
01562 
01563                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/rxact_8c.html#a16">RXactpOpenTargetKey</a>(
01564                                  RootRegistryKey,
01565                                  RtlRXactOperationDelete,
01566                                  &amp;RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o2">SubKeyName</a>,
01567                                  &amp;TargetKey
01568                                  );
01569 
01570                     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01571 
01572                         <span class="comment">//</span>
01573                         <span class="comment">// We must allow the object not to be found,</span>
01574                         <span class="comment">// because we may be replaying this log after</span>
01575                         <span class="comment">// it had been partially executed.</span>
01576                         <span class="comment">//</span>
01577 
01578                         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_OBJECT_NAME_NOT_FOUND ) {
01579 
01580                             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01581 
01582                         } <span class="keywordflow">else</span> {
01583 
01584                             <span class="keywordflow">break</span>;
01585                         }
01586                     }
01587 
01588                     CloseTargetKey = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01589 
01590                 } <span class="keywordflow">else</span> {
01591 
01592                     TargetKey = RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o4">KeyHandle</a>;
01593                     CloseTargetKey = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01594                 }
01595 
01596 
01597                 <span class="comment">//</span>
01598                 <span class="comment">// If this fails, then it is an error</span>
01599                 <span class="comment">// because the key should exist at</span>
01600                 <span class="comment">// this point.</span>
01601                 <span class="comment">//</span>
01602 
01603                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a15">NtDeleteKey</a>( TargetKey );
01604 
01605 
01606                 <span class="comment">//</span>
01607                 <span class="comment">// Only close the target key if we opened it</span>
01608                 <span class="comment">//</span>
01609 
01610                 <span class="keywordflow">if</span> ( CloseTargetKey ) {
01611 
01612                     TmpStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TargetKey );
01613 
01614                     <span class="comment">//</span>
01615                     <span class="comment">// If we opened this handle, then we should</span>
01616                     <span class="comment">// be able to close it, whether it has been</span>
01617                     <span class="comment">// deleted or not.</span>
01618                     <span class="comment">//</span>
01619 
01620                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus));        <span class="comment">// safe to ignore, but curious...</span>
01621                 }
01622 
01623 
01624                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01625                     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01626                 }
01627 
01628                 <span class="keywordflow">break</span>;
01629 
01630             <span class="keywordflow">case</span> RtlRXactOperationSetValue:
01631 
01632                 <span class="comment">//</span>
01633                 <span class="comment">// Open the target key.</span>
01634                 <span class="comment">// The name is relative to the RootRegistryKey.</span>
01635                 <span class="comment">//</span>
01636 
01637                 <span class="keywordflow">if</span> ( ((RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o4">KeyHandle</a> == <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>) || !HandlesValid) ) {
01638 
01639                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/rxact_8c.html#a16">RXactpOpenTargetKey</a>(
01640                                  RootRegistryKey,
01641                                  RtlRXactOperationSetValue,
01642                                  &amp;RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o2">SubKeyName</a>,
01643                                  &amp;TargetKey
01644                                  );
01645 
01646                     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01647                         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01648                     }
01649 
01650                     CloseTargetKey = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01651 
01652                 } <span class="keywordflow">else</span> {
01653 
01654                     TargetKey = RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o4">KeyHandle</a>;
01655                     CloseTargetKey = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01656                 }
01657 
01658                 <span class="comment">//</span>
01659                 <span class="comment">// Assign to the target key's new value</span>
01660                 <span class="comment">//</span>
01661 
01662                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>( TargetKey,
01663                                         &amp;RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o3">AttributeName</a>,
01664                                         0,               <span class="comment">// TitleIndex</span>
01665                                         RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o5">NewKeyValueType</a>,
01666                                         RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o7">NewKeyValue</a>,
01667                                         RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o6">NewKeyValueLength</a>
01668                                         );
01669 
01670                 <span class="comment">//</span>
01671                 <span class="comment">// Only close the target key if we opened it</span>
01672                 <span class="comment">//</span>
01673 
01674                 <span class="keywordflow">if</span> ( CloseTargetKey ) {
01675 
01676                     TmpStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TargetKey );
01677                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus));        <span class="comment">// safe to ignore, but curious...</span>
01678 
01679                 }
01680 
01681                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01682                     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01683                 }
01684 
01685                 <span class="keywordflow">break</span>;
01686 
01687 
01688 
01689             <span class="keywordflow">default</span>:
01690 
01691                 <span class="comment">//</span>
01692                 <span class="comment">// Unknown operation type.  This should never happen.</span>
01693                 <span class="comment">//</span>
01694 
01695                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01696 
01697                 <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
01698 
01699         }
01700 
01701         RXactLogEntry = (<a class="code" href="../../d5/d4/rxact_8c.html#a12">PRXACT_LOG_ENTRY</a>)((PCHAR)RXactLogEntry + RXactLogEntry-&gt;<a class="code" href="../../d7/d7/struct__RXACT__LOG__ENTRY.html#o0">LogEntrySize</a>);
01702 
01703     }
01704 
01705     <span class="comment">//</span>
01706     <span class="comment">// Commit complete</span>
01707     <span class="comment">//</span>
01708 
01709     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01710 
01711 }
01712 
01713 
01714 
01715 
01716 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01717"></a><a class="code" href="../../d5/d4/rxact_8c.html#a16">01717</a> <a class="code" href="../../d5/d4/rxact_8c.html#a16">RXactpOpenTargetKey</a>(
01718     IN HANDLE RootRegistryKey,
01719     IN RTL_RXACT_OPERATION Operation,
01720     IN PUNICODE_STRING SubKeyName,
01721     OUT PHANDLE TargetKey
01722     )
01723 
01724 <span class="comment">/*++</span>
01725 <span class="comment"></span>
01726 <span class="comment">Routine Description:</span>
01727 <span class="comment"></span>
01728 <span class="comment">    This routine opens the target registry key of an operation.</span>
01729 <span class="comment"></span>
01730 <span class="comment">Arguments:</span>
01731 <span class="comment"></span>
01732 <span class="comment">    RootRegistryKey - A handle to the registry key within whose sub-tree</span>
01733 <span class="comment">        a transaction is to be initialized.</span>
01734 <span class="comment"></span>
01735 <span class="comment">    Operation - Indicates what operation is to be performed on the target.</span>
01736 <span class="comment">        This will effect how the target is opened.</span>
01737 <span class="comment"></span>
01738 <span class="comment">    OperationNameKey - A handle to the operation log sub-key</span>
01739 <span class="comment">        containing the name of the target registry key.</span>
01740 <span class="comment"></span>
01741 <span class="comment">    TargetKey - Receives a handle to the target registry key.</span>
01742 <span class="comment"></span>
01743 <span class="comment">Return Value:</span>
01744 <span class="comment"></span>
01745 <span class="comment">    STATUS_SUCCESS - Indicates the operation log entry was opened.</span>
01746 <span class="comment"></span>
01747 <span class="comment">    STATUS_NO_MEMORY - Ran out of heap.</span>
01748 <span class="comment"></span>
01749 <span class="comment"></span>
01750 <span class="comment">--*/</span>
01751 {
01752 
01753     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01754     OBJECT_ATTRIBUTES TargetKeyAttributes;
01755     ACCESS_MASK DesiredAccess;
01756     ULONG Disposition;
01757 
01758 
01759     <span class="keywordflow">if</span> (Operation == RtlRXactOperationDelete) {
01760 
01761         DesiredAccess = DELETE;
01762 
01763         InitializeObjectAttributes(
01764             &amp;TargetKeyAttributes,
01765             SubKeyName,
01766             OBJ_CASE_INSENSITIVE,
01767             RootRegistryKey,
01768             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01769 
01770 <span class="comment">//        Status = RtlpNtOpenKey(</span>
01771 <span class="comment">//                     TargetKey,</span>
01772 <span class="comment">//                     DesiredAccess,</span>
01773 <span class="comment">//                     &amp;TargetKeyAttributes,</span>
01774 <span class="comment">//                     0);</span>
01775 
01776         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( TargetKey,
01777                             DesiredAccess,
01778                             &amp;TargetKeyAttributes
01779                             );
01780 
01781 
01782     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Operation == RtlRXactOperationSetValue) {
01783 
01784         DesiredAccess = KEY_WRITE;
01785 
01786         InitializeObjectAttributes(
01787             &amp;TargetKeyAttributes,
01788             SubKeyName,
01789             OBJ_CASE_INSENSITIVE | OBJ_OPENIF,
01790             RootRegistryKey,
01791             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01792 
01793         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
01794                      TargetKey,
01795                      DesiredAccess,
01796                      &amp;TargetKeyAttributes,
01797                      0,
01798                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01799                      REG_OPTION_NON_VOLATILE,
01800                      &amp;Disposition
01801                      );
01802 
01803     } <span class="keywordflow">else</span> {
01804         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01805     }
01806 
01807 
01808 
01809     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01810 
01811 }
01812 
01813 
01814 
01815 <span class="comment">//NTSTATUS</span>
01816 <span class="comment">//RXactpAssignTargetValue(</span>
01817 <span class="comment">//    IN PVOID NewKeyValue,</span>
01818 <span class="comment">//    IN ULONG NewKeyValueLength,</span>
01819 <span class="comment">//    IN ULONG NewKeyValueType,</span>
01820 <span class="comment">//    IN HANDLE TargetKey,</span>
01821 <span class="comment">//    IN PUNICODE_STRING AttributeName</span>
01822 <span class="comment">//    );</span>
01823 
01824 
01825 <span class="comment">//NTSTATUS</span>
01826 <span class="comment">//RXactpAssignTargetValue(</span>
01827 <span class="comment">//    IN PVOID NewKeyValue,</span>
01828 <span class="comment">//    IN ULONG NewKeyValueLength,</span>
01829 <span class="comment">//    IN ULONG NewKeyValueType,</span>
01830 <span class="comment">//    IN HANDLE TargetKey,</span>
01831 <span class="comment">//    IN PUNICODE_STRING AttributeName</span>
01832 <span class="comment">//    )</span>
01833 <span class="comment">//</span>
01835 <span class="comment"></span><span class="comment">//</span>
01836 <span class="comment">//Routine Description:</span>
01837 <span class="comment">//</span>
01838 <span class="comment">//    This routine copies the value of an operation log entry to its</span>
01839 <span class="comment">//    corresponding target key.  The target key must already be open.</span>
01840 <span class="comment">//</span>
01841 <span class="comment">//Arguments:</span>
01842 <span class="comment">//</span>
01843 <span class="comment">//    NewKeyValue - The new value for the key being modified.</span>
01844 <span class="comment">//</span>
01845 <span class="comment">//    NewKeyValueLength - The size in bytes of the new value information.</span>
01846 <span class="comment">//</span>
01847 <span class="comment">//    NewKeyValueType - The type of the data for the new key.</span>
01848 <span class="comment">//</span>
01849 <span class="comment">//    TargetKey - A handle to the target registry key.</span>
01850 <span class="comment">//</span>
01851 <span class="comment">//    AttributeName - Supplies the name of the key attribute being edited.</span>
01852 <span class="comment">//</span>
01853 <span class="comment">//Return Value:</span>
01854 <span class="comment">//</span>
01855 <span class="comment">//    STATUS_SUCCESS - Indicates the value was successfully applied to</span>
01856 <span class="comment">//        the target registry key.</span>
01857 <span class="comment">//</span>
01858 <span class="comment">//    STATUS_NO_MEMORY - ran out of heap.</span>
01859 <span class="comment">//</span>
01860 <span class="comment">//</span>
01861 <span class="comment">//--*/</span>
01862 <span class="comment">//{</span>
01863 <span class="comment">//    NTSTATUS Status;</span>
01864 <span class="comment">//</span>
01865 <span class="comment">//    //</span>
01866 <span class="comment">//    // Now apply the value to the target key</span>
01867 <span class="comment">//    //</span>
01868 <span class="comment">//    // Even if there is no key value, we need to do the assign so that</span>
01869 <span class="comment">//    // the key value type is assigned.</span>
01870 <span class="comment">//    //</span>
01871 <span class="comment">//</span>
01872 <span class="comment">//    Status = NtSetValueKey( TargetKey,</span>
01873 <span class="comment">//                            AttributeName,</span>
01874 <span class="comment">//                            0,               // TitleIndex</span>
01875 <span class="comment">//                            NewKeyValueType,</span>
01876 <span class="comment">//                            NewKeyValue,</span>
01877 <span class="comment">//                            NewKeyValueLength</span>
01878 <span class="comment">//                            );</span>
01879 <span class="comment">//</span>
01880 <span class="comment">//</span>
01881 <span class="comment">//    return( Status );</span>
01882 <span class="comment">//}</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:43 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
