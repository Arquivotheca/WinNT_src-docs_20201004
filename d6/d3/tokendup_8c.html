<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: tokendup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>tokendup.c File Reference</h1><code>#include "<a class="el" href="../../d7/d5/sep_8h-source.html">sep.h</a>"</code><br>
<code>#include "<a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>"</code><br>

<p>
<a href="../../d7/d2/tokendup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/tokendup_8c.html#a0">MAX</a>(_x_, _y_)&nbsp;&nbsp;&nbsp;((_x_) &gt; (_y_) ? (_x_) : (_y_))</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/tokendup_8c.html#a1">NtDuplicateToken</a> (IN HANDLE ExistingTokenHandle, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, IN BOOLEAN EffectiveOnly, IN TOKEN_TYPE TokenType, OUT PHANDLE NewTokenHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/tokendup_8c.html#a2">SepDuplicateToken</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> ExistingToken, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, IN BOOLEAN EffectiveOnly, IN TOKEN_TYPE TokenType, IN SECURITY_IMPERSONATION_LEVEL ImpersonationLevel OPTIONAL, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode, OUT <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> *DuplicateToken)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/tokendup_8c.html#a3">SepMakeTokenEffectiveOnly</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/tokendup_8c.html#a4">SepSidInSidAndAttributes</a> (IN PSID_AND_ATTRIBUTES SidAndAttributes, IN ULONG SidCount, IN PSID PrincipalSelfSid, IN PSID Sid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/tokendup_8c.html#a5">SepRemoveDisabledGroupsAndPrivileges</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN ULONG Flags, IN ULONG GroupCount, IN PSID_AND_ATTRIBUTES GroupsToDisable, IN ULONG PrivilegeCount, IN PLUID_AND_ATTRIBUTES PrivilegesToDelete)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/tokendup_8c.html#a6">SeCopyClientToken</a> (IN PACCESS_TOKEN <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>, IN SECURITY_IMPERSONATION_LEVEL ImpersonationLevel, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode, OUT PACCESS_TOKEN *DuplicateToken)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/tokendup_8c.html#a7">NtFilterToken</a> (IN HANDLE ExistingTokenHandle, IN ULONG Flags, IN PTOKEN_GROUPS SidsToDisable OPTIONAL, IN PTOKEN_PRIVILEGES PrivilegesToDelete OPTIONAL, IN PTOKEN_GROUPS RestrictedSids OPTIONAL, OUT PHANDLE NewTokenHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/tokendup_8c.html#a8">SeFilterToken</a> (IN PACCESS_TOKEN ExistingToken, IN ULONG Flags, IN PTOKEN_GROUPS SidsToDisable OPTIONAL, IN PTOKEN_PRIVILEGES PrivilegesToDelete OPTIONAL, IN PTOKEN_GROUPS RestrictedSids OPTIONAL, OUT PACCESS_TOKEN *NewToken)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/tokendup_8c.html#a9">SeFastFilterToken</a> (IN PACCESS_TOKEN ExistingToken, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode, IN ULONG Flags, IN ULONG GroupCount, IN PSID_AND_ATTRIBUTES GroupsToDisable OPTIONAL, IN ULONG PrivilegeCount, IN PLUID_AND_ATTRIBUTES PrivilegesToDelete OPTIONAL, IN ULONG SidCount, IN PSID_AND_ATTRIBUTES RestrictedSids OPTIONAL, IN ULONG SidLength, OUT PACCESS_TOKEN *FilteredToken)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/tokendup_8c.html#a10">SepFilterToken</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> ExistingToken, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode, IN ULONG Flags, IN ULONG GroupCount, IN PSID_AND_ATTRIBUTES GroupsToDisable OPTIONAL, IN ULONG PrivilegeCount, IN PLUID_AND_ATTRIBUTES PrivilegesToDelete OPTIONAL, IN ULONG SidCount, IN PSID_AND_ATTRIBUTES RestrictedSids OPTIONAL, IN ULONG SidLength, OUT <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> *FilteredToken)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="tokendup.c::MAX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_x_,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>_y_&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((_x_) &gt; (_y_) ? (_x_) : (_y_))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">SepFilterToken()</a>, and <a class="el" href="../../d2/d4/caption_8c-source.html#l00986">xxxDrawCaptionBar()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="tokendup.c::NtDuplicateToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtDuplicateToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ExistingTokenHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>EffectiveOnly</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN TOKEN_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>NewTokenHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00046">46</a> of file <a class="el" href="../../d7/d2/tokendup_8c-source.html">tokendup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00057">_OBJECT_HANDLE_INFORMATION::GrantedAccess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00953">SeCaptureSecurityQos()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00037">SecurityQos</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00910">SeFreeCapturedSecurityQos()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00362">SepDuplicateToken()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/ttokend_8c-source.html#l00322">main()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03446">RtlImpersonateSelf()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07402">TestTokenDuplicate()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07982">TestTokenImpersonation()</a>.
<p>
<pre class="fragment"><div>00058                    :
00059 
00060     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> a <span class="keyword">new</span> token that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a duplicate of an existing token.
00061 
00062 Arguments:
00063 
00064     ExistingTokenHandle - Is a handle to a token already open <span class="keywordflow">for</span>
00065         TOKEN_DUPLICATE access.
00066 
00067     DesiredAccess - Is an access mask indicating which access types
00068         are desired to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created token.  If specified as zero,
00069         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granted access mask of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> existing token handle
00070         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access mask <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token.
00071 
00072     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> standard object attributes data
00073         structure.  Refer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT Object Management
00074         Specification <span class="keywordflow">for</span> a description of <span class="keyword">this</span> data structure.
00075 
00076         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> TokenImpersonation, then <span class="keyword">this</span>
00077         parameter may be used to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation level
00078         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token.  If no value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> provided, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source
00079         token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an impersonation token, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation level
00080         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source will become that of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target as well.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00081         source token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a primary token, then an impersonation level
00082         must be explicitly provided.
00083 
00084         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token being duplicated <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an impersonation token, and
00085         an impersonation level <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> explicitly provided <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target,
00086         then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value provided must not be greater than that of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00087         source token. For example, an Identification level token can
00088         not be duplicated to produce a Delegation level token.
00089 
00090     EffectiveOnly - Is a <span class="keywordtype">boolean</span> flag indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire
00091         source token should be duplicated into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target token or
00092         just <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> effective (currently enabled) part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00093         This provides a means <span class="keywordflow">for</span> a caller of a <span class="keyword">protected</span> subsystem
00094         to limit which privileges and optional groups are <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>
00095         available to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">protected</span> subsystem.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00096         indicates <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> currently enabled parts of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source
00097         token are to be duplicated.  Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire source
00098         token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> duplicated.
00099 
00100     TokenType - Indicates which <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of object <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
00101         be created as (primary or impersonation).  If you are duplicating
00102         an Impersonation token to produce a Primary token, then
00103         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Impersonation token must have an impersonation level of
00104         either DELEGATE or IMPERSONATE.
00105 
00106 
00107     NewTokenHandle - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created token.
00108 
00109 Return Value:
00110 
00111     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was successful.
00112 
00113     STATUS_INVALID_PARAMETER - Indicates one or more of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameter values
00114         was invalid.  This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00115         an impersonation token.
00116 
00117     STATUS_BAD_IMPERSONATION_LEVEL - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation level
00118         requested <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duplicate token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not compatible with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00119         level of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source token.  The duplicate token may not be assigned
00120         a level greater than that of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source token.
00121 
00122 --*/
00123 {
00124 
00125     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00126     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> NewToken;
00127     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00128     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00129 
00130     SECURITY_ADVANCED_QUALITY_OF_SERVICE <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>;
00131     BOOLEAN SecurityQosPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00132     HANDLE LocalHandle;
00133 
00134     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInformation;
00135     ACCESS_MASK EffectiveDesiredAccess;
00136 
00137     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00138 
00139     PreviousMode = KeGetPreviousMode();
00140 
00141     <span class="comment">//</span>
00142     <span class="comment">//  Probe parameters</span>
00143     <span class="comment">//</span>
00144 
00145     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00146 
00147         <span class="keywordflow">try</span> {
00148 
00149             <span class="comment">//</span>
00150             <span class="comment">// Make sure the TokenType is valid</span>
00151             <span class="comment">//</span>
00152 
00153             <span class="keywordflow">if</span> ( (TokenType &lt; TokenPrimary) || (TokenType &gt; TokenImpersonation) ) {
00154                 <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
00155             }
00156 
00157             <span class="comment">//</span>
00158             <span class="comment">//  Make sure we can write the handle</span>
00159             <span class="comment">//</span>
00160 
00161             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(NewTokenHandle);
00162 
00163 
00164         } except(EXCEPTION_EXECUTE_HANDLER) {
00165             <span class="keywordflow">return</span> GetExceptionCode();
00166         }  <span class="comment">// end_try</span>
00167 
00168     } <span class="comment">//end_if</span>
00169 
00170 
00171 
00172     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a7">SeCaptureSecurityQos</a>(
00173                  ObjectAttributes,
00174                  PreviousMode,
00175                  &amp;SecurityQosPresent,
00176                  &amp;SecurityQos
00177                  );
00178 
00179     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00180         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00181     }
00182 
00183 
00184     <span class="comment">//</span>
00185     <span class="comment">//  Check the handle's access to the existing token and get</span>
00186     <span class="comment">//  a pointer to that token.  Pick up the default desired</span>
00187     <span class="comment">//  access mask from the handle while we're at it.</span>
00188     <span class="comment">//</span>
00189 
00190     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00191                  ExistingTokenHandle,    <span class="comment">// Handle</span>
00192                  TOKEN_DUPLICATE,        <span class="comment">// DesiredAccess</span>
00193                  SepTokenObjectType,     <span class="comment">// ObjectType</span>
00194                  PreviousMode,           <span class="comment">// AccessMode</span>
00195                  (PVOID *)&amp;Token,        <span class="comment">// Object</span>
00196                  &amp;HandleInformation      <span class="comment">// GrantedAccess</span>
00197                  );
00198 
00199     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00200 
00201         <span class="keywordflow">if</span> (SecurityQosPresent) {
00202             <a class="code" href="../../d2/d5/se_2capture_8c.html#a6">SeFreeCapturedSecurityQos</a>( &amp;SecurityQos );
00203         }
00204         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00205     }
00206 
00207 
00208 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
00209 <span class="preprocessor"></span>
00210 <span class="comment">//</span>
00211 <span class="comment">// Debug</span>
00212     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
00213     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
00214     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
00215     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Token being duplicated: \n"</span>);
00216     SepDumpToken( Token );
00217     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00218 <span class="comment">// Debug</span>
00219 <span class="comment">//</span>
00221 <span class="comment"></span><span class="preprocessor">#endif //TOKEN_DEBUG</span>
00222 <span class="preprocessor"></span>
00223 
00224     <span class="comment">//</span>
00225     <span class="comment">// Check to see if an alternate desired access mask was provided.</span>
00226     <span class="comment">//</span>
00227 
00228     <span class="keywordflow">if</span> (ARGUMENT_PRESENT((PVOID)(ULONG_PTR)DesiredAccess)) {
00229 
00230         EffectiveDesiredAccess = DesiredAccess;
00231 
00232     } <span class="keywordflow">else</span> {
00233 
00234         EffectiveDesiredAccess = HandleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>;
00235     }
00236 
00237 
00238     <span class="comment">//</span>
00239     <span class="comment">//  If no impersonation level was specified, pick one up from</span>
00240     <span class="comment">//  the source token.</span>
00241     <span class="comment">//</span>
00242 
00243     <span class="keywordflow">if</span> ( !SecurityQosPresent ) {
00244 
00245         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>.ImpersonationLevel = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel;
00246 
00247     }
00248 
00249 
00250 
00251     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType == TokenImpersonation) {
00252 
00253         <span class="comment">//</span>
00254         <span class="comment">// Make sure a legitimate transformation is being requested:</span>
00255         <span class="comment">//</span>
00256         <span class="comment">//    (1) The impersonation level of a target duplicate must not</span>
00257         <span class="comment">//        exceed that of the source token.</span>
00258         <span class="comment">//</span>
00259         <span class="comment">//</span>
00260 
00261         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SecurityDelegation     &gt; SecurityImpersonation );
00262         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SecurityImpersonation  &gt; SecurityIdentification );
00263         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SecurityIdentification &gt; SecurityAnonymous );
00264 
00265         <span class="keywordflow">if</span> ( (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>.ImpersonationLevel &gt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel) ) {
00266 
00267             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
00268             <span class="keywordflow">if</span> (SecurityQosPresent) {
00269                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a6">SeFreeCapturedSecurityQos</a>( &amp;SecurityQos );
00270             }
00271             <span class="keywordflow">return</span> STATUS_BAD_IMPERSONATION_LEVEL;
00272         }
00273 
00274     }
00275 
00276     <span class="comment">//</span>
00277     <span class="comment">// If we are producing a Primary token from an impersonation</span>
00278     <span class="comment">// token, then specify an impersonation level of at least</span>
00279     <span class="comment">// Impersonate.</span>
00280     <span class="comment">//</span>
00281 
00282     <span class="keywordflow">if</span> ( (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType == TokenImpersonation) &amp;&amp;
00283          (TokenType == TokenPrimary)              &amp;&amp;
00284          (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel &lt;  SecurityImpersonation)
00285        ) {
00286         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
00287         <span class="keywordflow">if</span> (SecurityQosPresent) {
00288             <a class="code" href="../../d2/d5/se_2capture_8c.html#a6">SeFreeCapturedSecurityQos</a>( &amp;SecurityQos );
00289         }
00290         <span class="keywordflow">return</span> STATUS_BAD_IMPERSONATION_LEVEL;
00291     }
00292 
00293     <span class="comment">//</span>
00294     <span class="comment">//  Duplicate the existing token</span>
00295     <span class="comment">//</span>
00296 
00297     NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00298     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a27">SepDuplicateToken</a>(
00299                  Token,
00300                  ObjectAttributes,
00301                  EffectiveOnly,
00302                  TokenType,
00303                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>.ImpersonationLevel,
00304                  PreviousMode,
00305                  &amp;NewToken
00306                  );
00307 
00308 
00309     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00310 
00311         <span class="comment">//</span>
00312         <span class="comment">//  Insert the new token</span>
00313         <span class="comment">//</span>
00314 
00315         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( NewToken,
00316                                  NULL,
00317                                  EffectiveDesiredAccess,
00318                                  0,
00319                                  (PVOID *)NULL,
00320                                  &amp;LocalHandle
00321                                  );
00322 
00323         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00324 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
00325 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"SE: ObInsertObject failed (%x) for token at %x\n"</span>, Status, NewToken );
00326 <span class="preprocessor">#endif</span>
00327 <span class="preprocessor"></span>        }
00328 
00329     } <span class="keywordflow">else</span>
00330     <span class="keywordflow">if</span> (NewToken != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00331 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
00332 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"SE: SepDuplicateToken failed (%x) but allocated token at %x\n"</span>, Status, NewToken );
00333 <span class="preprocessor">#endif</span>
00334 <span class="preprocessor"></span>    }
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">//  We no longer need our reference to the source token</span>
00338     <span class="comment">//</span>
00339 
00340     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
00341 
00342     <span class="keywordflow">if</span> (SecurityQosPresent) {
00343         <a class="code" href="../../d2/d5/se_2capture_8c.html#a6">SeFreeCapturedSecurityQos</a>( &amp;SecurityQos );
00344     }
00345 
00346     <span class="comment">// BUGWARNING Probably need to audit here</span>
00347 
00348     <span class="comment">//</span>
00349     <span class="comment">//  Return the new handle</span>
00350     <span class="comment">//</span>
00351 
00352     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00353         <span class="keywordflow">try</span> { *NewTokenHandle = LocalHandle; }
00354             except(EXCEPTION_EXECUTE_HANDLER) { <span class="keywordflow">return</span> GetExceptionCode(); }
00355     }
00356 
00357    <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00358 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="tokendup.c::NtFilterToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtFilterToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ExistingTokenHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_GROUPS SidsToDisable&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_PRIVILEGES PrivilegesToDelete&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_GROUPS RestrictedSids&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>NewTokenHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01306">1306</a> of file <a class="el" href="../../d7/d2/tokendup_8c-source.html">tokendup.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00057">_OBJECT_HANDLE_INFORMATION::GrantedAccess</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01608">SeCaptureLuidAndAttributesArray()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01850">SeCaptureSidAndAttributesArray()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">SepFilterToken()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01797">SeReleaseLuidAndAttributesArray()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l02297">SeReleaseSidAndAttributesArray()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/cttoken_8c-source.html#l01085">TestTokenFilter()</a>.
<p>
<pre class="fragment"><div>01317                    :
01318 
01319     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> a <span class="keyword">new</span> token that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a subset of an existing token.
01320 
01321 Arguments:
01322 
01323     ExistingTokenHandle - Is a handle to a token already open <span class="keywordflow">for</span>
01324         TOKEN_DUPLICATE access.
01325 
01326     Flags - Flags indicating additional filtering. The flags may be:
01327 
01328                 DISABLE_ALL_GROUPS  - disable all groups in token
01329                 DELETE_ALL_PRIVILEGES - Disable all privileges
01330 
01331 
01332     SidsToDisable - Contains a list of sids and attributes. All sids with
01333         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> USE_FOR_DENY_ONLY attribute that also exist in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token will
01334         cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token to have that sid set with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> USE_FOR_DENY_ONLY
01335         attribte.
01336 
01337     PrivilegesToDelete - Privileges in <span class="keyword">this</span> list that are present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01338         existing token will not exist in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> token. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> similar
01339         to duplicating a token effective <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> with these privileges set to
01340         disabled.
01341 
01342     RestrictedSids - Contains a list of SIDs and attributes that will be
01343         stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RestrictedSids field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token. These SIDs
01344         are used after a normal access check to futher restrict access.
01345         The attributes of these groups are always SE_GROUP_MANDATORY |
01346         SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT. If there already
01347         exist RestrictedSids in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original token, these sids will be
01348         appended.
01349 
01350     NewTokenHandle - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created token.
01351 
01352 Return Value:
01353 
01354     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was successful.
01355 
01356     STATUS_INVALID_PARAMETER - Indicates one or more of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameter values
01357         was invalid.  This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
01358         an impersonation token.
01359 
01360 
01361 --*/
01362 {
01363 
01364     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
01365     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> NewToken;
01366     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01367     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01368 
01369     ULONG CapturedSidCount = 0;
01370     PSID_AND_ATTRIBUTES CapturedSids = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01371     ULONG CapturedSidsLength = 0;
01372 
01373     ULONG CapturedGroupCount = 0;
01374     PSID_AND_ATTRIBUTES CapturedGroups = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01375     ULONG CapturedGroupsLength = 0;
01376 
01377     ULONG CapturedPrivilegeCount = 0;
01378     PLUID_AND_ATTRIBUTES CapturedPrivileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01379     ULONG CapturedPrivilegesLength = 0;
01380     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01381 
01382     HANDLE LocalHandle;
01383 
01384     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInformation;
01385     ACCESS_MASK EffectiveDesiredAccess;
01386 
01387     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01388 
01389     PreviousMode = KeGetPreviousMode();
01390 
01391     <span class="comment">//</span>
01392     <span class="comment">//  Probe parameters</span>
01393     <span class="comment">//</span>
01394 
01395 
01396     <span class="keywordflow">try</span> {
01397 
01398 
01399         <span class="comment">//</span>
01400         <span class="comment">//  Make sure we can write the handle</span>
01401         <span class="comment">//</span>
01402 
01403         <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(NewTokenHandle);
01404 
01405         <span class="comment">//</span>
01406         <span class="comment">//  Capture Sids to remove</span>
01407         <span class="comment">//</span>
01408 
01409         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SidsToDisable)) {
01410             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( SidsToDisable, <span class="keyword">sizeof</span>(TOKEN_GROUPS), <span class="keyword">sizeof</span>(ULONG) );
01411 
01412             CapturedGroupCount = SidsToDisable-&gt;GroupCount;
01413             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a14">SeCaptureSidAndAttributesArray</a>(
01414                         SidsToDisable-&gt;Groups,
01415                         CapturedGroupCount,
01416                         PreviousMode,
01417                         NULL, 0,
01418                         PagedPool,
01419                         TRUE,
01420                         &amp;CapturedGroups,
01421                         &amp;CapturedGroupsLength
01422                         );
01423 
01424         }
01425 
01426         <span class="comment">//</span>
01427         <span class="comment">//  Capture PrivilegesToDelete</span>
01428         <span class="comment">//</span>
01429 
01430         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; ARGUMENT_PRESENT(PrivilegesToDelete)) {
01431             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( PrivilegesToDelete, <span class="keyword">sizeof</span>(TOKEN_PRIVILEGES), <span class="keyword">sizeof</span>(ULONG) );
01432 
01433             CapturedPrivilegeCount = PrivilegesToDelete-&gt;PrivilegeCount;
01434             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a12">SeCaptureLuidAndAttributesArray</a>(
01435                          PrivilegesToDelete-&gt;Privileges,
01436                          CapturedPrivilegeCount,
01437                          PreviousMode,
01438                          NULL, 0,
01439                          PagedPool,
01440                          TRUE,
01441                          &amp;CapturedPrivileges,
01442                          &amp;CapturedPrivilegesLength
01443                          );
01444 
01445         }
01446 
01447         <span class="comment">//</span>
01448         <span class="comment">//  Capture Restricted Sids</span>
01449         <span class="comment">//</span>
01450 
01451         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; ARGUMENT_PRESENT(RestrictedSids)) {
01452             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( RestrictedSids, <span class="keyword">sizeof</span>(TOKEN_GROUPS), <span class="keyword">sizeof</span>(ULONG) );
01453 
01454             CapturedSidCount = RestrictedSids-&gt;GroupCount;
01455             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a14">SeCaptureSidAndAttributesArray</a>(
01456                         RestrictedSids-&gt;Groups,
01457                         CapturedSidCount,
01458                         PreviousMode,
01459                         NULL, 0,
01460                         PagedPool,
01461                         TRUE,
01462                         &amp;CapturedSids,
01463                         &amp;CapturedSidsLength
01464                         );
01465 
01466         }
01467 
01468 
01469 
01470     } except(EXCEPTION_EXECUTE_HANDLER) {
01471 
01472         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01473     }  <span class="comment">// end_try</span>
01474 
01475     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01476         <span class="keywordflow">goto</span> Cleanup;
01477     }
01478 
01479     <span class="comment">//</span>
01480     <span class="comment">// Check that the attribtes are all zero for the restricted sids</span>
01481     <span class="comment">//</span>
01482 
01483     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; CapturedSidCount ; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ )
01484     {
01485         <span class="keywordflow">if</span> (CapturedSids[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Attributes != 0) {
01486             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01487             <span class="keywordflow">goto</span> Cleanup;
01488         }
01489     }
01490     <span class="comment">//</span>
01491     <span class="comment">//  Check the handle's access to the existing token and get</span>
01492     <span class="comment">//  a pointer to that token.  Pick up the default desired</span>
01493     <span class="comment">//  access mask from the handle while we're at it.</span>
01494     <span class="comment">//</span>
01495 
01496     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01497                  ExistingTokenHandle,    <span class="comment">// Handle</span>
01498                  TOKEN_DUPLICATE,        <span class="comment">// DesiredAccess</span>
01499                  SepTokenObjectType,     <span class="comment">// ObjectType</span>
01500                  PreviousMode,           <span class="comment">// AccessMode</span>
01501                  (PVOID *)&amp;Token,        <span class="comment">// Object</span>
01502                  &amp;HandleInformation      <span class="comment">// GrantedAccess</span>
01503                  );
01504 
01505     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01506 
01507         <span class="keywordflow">goto</span> Cleanup;
01508     }
01509 
01510 
01511 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01512 <span class="preprocessor"></span>
01513 <span class="comment">//</span>
01514 <span class="comment">// Debug</span>
01515     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
01516     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01517     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01518     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Token being filtered: \n"</span>);
01519     SepDumpToken( Token );
01520     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01521 <span class="comment">// Debug</span>
01522 <span class="comment">//</span>
01524 <span class="comment"></span><span class="preprocessor">#endif //TOKEN_DEBUG</span>
01525 <span class="preprocessor"></span>
01526 
01527     <span class="comment">//</span>
01528     <span class="comment">// Check to see if an alternate desired access mask was provided.</span>
01529     <span class="comment">//</span>
01530 
01531 
01532     EffectiveDesiredAccess = HandleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>;
01533 
01534 
01535 
01536     <span class="comment">//</span>
01537     <span class="comment">//  Filter the existing token</span>
01538     <span class="comment">//</span>
01539 
01540     NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01541     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a28">SepFilterToken</a>(
01542                  Token,
01543                  PreviousMode,
01544                  Flags,
01545                  CapturedGroupCount,
01546                  CapturedGroups,
01547                  CapturedPrivilegeCount,
01548                  CapturedPrivileges,
01549                  CapturedSidCount,
01550                  CapturedSids,
01551                  CapturedSidsLength,
01552                  &amp;NewToken
01553                  );
01554 
01555 
01556     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01557 
01558         <span class="comment">//</span>
01559         <span class="comment">//  Insert the new token</span>
01560         <span class="comment">//</span>
01561 
01562         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( NewToken,
01563                                  NULL,
01564                                  EffectiveDesiredAccess,
01565                                  0,
01566                                  (PVOID *)NULL,
01567                                  &amp;LocalHandle
01568                                  );
01569 
01570         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01571 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01572 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"SE: ObInsertObject failed (%x) for token at %x\n"</span>, Status, NewToken );
01573 <span class="preprocessor">#endif</span>
01574 <span class="preprocessor"></span>        }
01575 
01576     } <span class="keywordflow">else</span>
01577     <span class="keywordflow">if</span> (NewToken != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01578 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01579 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"SE: SepFilterToken failed (%x) but allocated token at %x\n"</span>, Status, NewToken );
01580 <span class="preprocessor">#endif</span>
01581 <span class="preprocessor"></span>    }
01582 
01583     <span class="comment">//</span>
01584     <span class="comment">//  We no longer need our reference to the source token</span>
01585     <span class="comment">//</span>
01586 
01587     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
01588 
01589 
01590     <span class="comment">// BUGWARNING Probably need to audit here</span>
01591 
01592     <span class="comment">//</span>
01593     <span class="comment">//  Return the new handle</span>
01594     <span class="comment">//</span>
01595 
01596     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01597         <span class="keywordflow">try</span> { *NewTokenHandle = LocalHandle; }
01598             except(EXCEPTION_EXECUTE_HANDLER) {
01599             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01600             }
01601     }
01602 
01603 Cleanup:
01604 
01605     <span class="keywordflow">if</span> (CapturedGroups != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01606         <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>(
01607             CapturedGroups,
01608             PreviousMode,
01609             TRUE
01610             );
01611     }
01612 
01613     <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01614         <a class="code" href="../../d2/d5/se_2capture_8c.html#a13">SeReleaseLuidAndAttributesArray</a>(
01615             CapturedPrivileges,
01616             PreviousMode,
01617             TRUE
01618             );
01619     }
01620 
01621     <span class="keywordflow">if</span> (CapturedSids != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01622         <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>(
01623             CapturedSids,
01624             PreviousMode,
01625             TRUE
01626             );
01627     }
01628 
01629    <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01630 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="tokendup.c::SeCopyClientToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeCopyClientToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECURITY_IMPERSONATION_LEVEL&nbsp;</td>
          <td class="mdname" nowrap> <em>ImpersonationLevel</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_TOKEN *&nbsp;</td>
          <td class="mdname" nowrap> <em>DuplicateToken</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01227">1227</a> of file <a class="el" href="../../d7/d2/tokendup_8c-source.html">tokendup.c</a>.
<p>
References <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00362">SepDuplicateToken()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/seclient_8c-source.html#l00062">SepCreateClientSecurity()</a>.
<p>
<pre class="fragment"><div>01237                    :
01238 
01239     This routine copies a client's token as part of establishing a client
01240     context <span class="keywordflow">for</span> impersonation.
01241 
01242     The result will be an impersonation token.
01243 
01244     No handles to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token are established.
01245 
01246     The token will be an exact duplicate of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source token.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01247     caller's responsibility to ensure an effective <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token
01248     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> produced when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> opened, <span class="keywordflow">if</span> necessary.
01249 
01250 
01251 Arguments:
01252 
01253     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to be duplicated.  This may be either
01254         a primary or impersonation token.
01255 
01256     ImpersonationLevel - The impersonation level to be assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
01257         token.
01258 
01259     RequestorMode - Mode to be assigned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token.
01260 
01261     DuplicateToken - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duplicate token.
01262         The token has not yet been inserted into any object table.
01263         No exceptions are expected when tring to set <span class="keyword">this</span> OUT value.
01264 
01265 Return Value:
01266 
01267     STATUS_SUCCESS - The service successfully completed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
01268         operation.
01269 
01270 
01271 --*/
01272 {
01273     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01274     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01275     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> NewToken;
01276 
01277     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01278 
01279     InitializeObjectAttributes(
01280         &amp;ObjectAttributes,
01281         NULL,
01282         0,
01283         NULL,
01284         NULL
01285         );
01286 
01287     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a27">SepDuplicateToken</a>(
01288                  (PTOKEN)ClientToken,              <span class="comment">// ExistingToken</span>
01289                  &amp;ObjectAttributes,                <span class="comment">// ObjectAttributes</span>
01290                  FALSE,                            <span class="comment">// EffectiveOnly</span>
01291                  TokenImpersonation,               <span class="comment">// TokenType  (target)</span>
01292                  ImpersonationLevel,               <span class="comment">// ImpersonationLevel</span>
01293                  RequestorMode,                    <span class="comment">// RequestorMode</span>
01294                  &amp;NewToken                         <span class="comment">// DuplicateToken</span>
01295                  );
01296 
01297     (*DuplicateToken) = (PACCESS_TOKEN)NewToken;
01298 
01299     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01300 
01301 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="tokendup.c::SeFastFilterToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeFastFilterToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>ExistingToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID_AND_ATTRIBUTES GroupsToDisable&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID_AND_ATTRIBUTES PrivilegesToDelete&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SidCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID_AND_ATTRIBUTES RestrictedSids&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SidLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_TOKEN *&nbsp;</td>
          <td class="mdname" nowrap> <em>FilteredToken</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01859">1859</a> of file <a class="el" href="../../d7/d2/tokendup_8c-source.html">tokendup.c</a>.
<p>
References <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, and <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">SepFilterToken()</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01483">PsAssignImpersonationToken()</a>, and <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00650">PsImpersonateClient()</a>.
<p>
<pre class="fragment"><div>01874                    :
01875 
01876     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a fast wrapper <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ps code to filter a token
01877     <span class="keyword">inline</span> of an impersonate.
01878 
01879     This routine acquires a read lock on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token being filtered.
01880 
01881 Arguments:
01882 
01883     ExistingToken - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to be duplicated.
01884 
01885     GroupCount - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of groups to disable
01886 
01887     GroupsToDisable - Contains a list of sids and attributes. All sids with
01888         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> USE_FOR_DENY_ONLY attribute that also exist in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token will
01889         cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token to have that sid set with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> USE_FOR_DENY_ONLY
01890         attribute.
01891 
01892     PrivilegeCount - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of privileges to <span class="keyword">delete</span>
01893 
01894     PrivilegesToDelete - Privileges in <span class="keyword">this</span> list that are present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01895         existing token will not exist in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> token. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> similar
01896         to duplicating a token effective <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> with these privileges set to
01897         disabled.
01898 
01899     SidCount - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of restricted sids to add.
01900 
01901     RestrictedSids - Contains a list of SIDs and attributes that will be
01902         stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RestrictedSids field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token. These SIDs
01903         are used after a normal access check to futher restrict access.
01904         The attributes of these groups are always SE_GROUP_MANDATORY |
01905         SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT. If there already
01906         exist RestrictedSids in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original token, these sids will be
01907         appended.
01908 
01909     SidLength - Length of added restricted sids.
01910 
01911     FilteredToken - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duplicate token.
01912         The token has not yet been inserted into any object table.
01913         No exceptions are expected when tring to set <span class="keyword">this</span> OUT value.
01914 
01915 Return Value:
01916 
01917     STATUS_SUCCESS - The service successfully completed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
01918         operation.
01919 
01920 
01921 --*/
01922 {
01923     <span class="keywordflow">return</span> <a class="code" href="../../d8/d3/tokenp_8h.html#a28">SepFilterToken</a>( (PTOKEN) ExistingToken,
01924                            RequestorMode,
01925                            Flags,
01926                            GroupCount,
01927                            GroupsToDisable,
01928                            PrivilegeCount,
01929                            PrivilegesToDelete,
01930                            SidCount,
01931                            RestrictedSids,
01932                            SidLength,
01933                            (PTOKEN *) FilteredToken );
01934 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="tokendup.c::SeFilterToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeFilterToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>ExistingToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_GROUPS SidsToDisable&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_PRIVILEGES PrivilegesToDelete&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_GROUPS RestrictedSids&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_TOKEN *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewToken</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01634">1634</a> of file <a class="el" href="../../d7/d2/tokendup_8c-source.html">tokendup.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">SepFilterToken()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>01645                    :
01646 
01647     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> a <span class="keyword">new</span> token that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a subset of an existing token.
01648 
01649 Arguments:
01650 
01651     ExistingToken - Is a  token already open <span class="keywordflow">for</span>
01652         TOKEN_DUPLICATE access.
01653 
01654     Flags - Flags indicating additional filtering. The flags may be:
01655 
01656                 DISABLE_ALL_GROUPS  - disable all groups in token
01657                 DELETE_ALL_PRIVILEGES - Disable all privileges
01658 
01659 
01660     SidsToDisable - Contains a list of sids and attributes. All sids with
01661         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> USE_FOR_DENY_ONLY attribute that also exist in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token will
01662         cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token to have that sid set with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> USE_FOR_DENY_ONLY
01663         attribte.
01664 
01665     PrivilegesToDelete - Privileges in <span class="keyword">this</span> list that are present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01666         existing token will not exist in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> token. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> similar
01667         to duplicating a token effective <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> with these privileges set to
01668         disabled.
01669 
01670     RestrictedSids - Contains a list of SIDs and attributes that will be
01671         stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RestrictedSids field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token. These SIDs
01672         are used after a normal access check to futher restrict access.
01673         The attributes of these groups are always SE_GROUP_MANDATORY |
01674         SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT. If there already
01675         exist RestrictedSids in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original token, these sids will be
01676         appended.
01677 
01678     NewToken - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created token.
01679 
01680 Return Value:
01681 
01682     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was successful.
01683 
01684     STATUS_INVALID_PARAMETER - Indicates one or more of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameter values
01685         was invalid.  This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
01686         an impersonation token.
01687 
01688 
01689 --*/
01690 {
01691 
01692     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
01693     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> FilteredToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01694     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01695     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01696     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01697 
01698     ULONG CapturedSidCount = 0;
01699     PSID_AND_ATTRIBUTES CapturedSids = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01700     ULONG CapturedSidsLength = 0;
01701 
01702     ULONG CapturedGroupCount = 0;
01703     PSID_AND_ATTRIBUTES CapturedGroups = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01704     ULONG CapturedGroupsLength = 0;
01705 
01706     ULONG CapturedPrivilegeCount = 0;
01707     PLUID_AND_ATTRIBUTES CapturedPrivileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01708     ULONG CapturedPrivilegesLength = 0;
01709 
01710     HANDLE LocalHandle;
01711 
01712     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInformation;
01713     ACCESS_MASK EffectiveDesiredAccess;
01714 
01715     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01716 
01717     PreviousMode = KeGetPreviousMode();
01718 
01719     <span class="comment">//</span>
01720     <span class="comment">//  Probe parameters</span>
01721     <span class="comment">//</span>
01722 
01723     *NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01724 
01725 
01726     <span class="comment">//</span>
01727     <span class="comment">//  Capture Sids to remove</span>
01728     <span class="comment">//</span>
01729 
01730     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SidsToDisable)) {
01731 
01732         CapturedGroupCount = SidsToDisable-&gt;GroupCount;
01733         CapturedGroups = SidsToDisable-&gt;Groups;
01734 
01735     }
01736 
01737     <span class="comment">//</span>
01738     <span class="comment">//  Capture PrivilegesToDelete</span>
01739     <span class="comment">//</span>
01740 
01741     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PrivilegesToDelete)) {
01742 
01743         CapturedPrivilegeCount = PrivilegesToDelete-&gt;PrivilegeCount;
01744         CapturedPrivileges = PrivilegesToDelete-&gt;Privileges;
01745 
01746     }
01747 
01748     <span class="comment">//</span>
01749     <span class="comment">//  Capture Restricted Sids</span>
01750     <span class="comment">//</span>
01751 
01752     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RestrictedSids)) {
01753 
01754         CapturedSidCount = RestrictedSids-&gt;GroupCount;
01755         CapturedSids = RestrictedSids-&gt;Groups;
01756 
01757         <span class="comment">//</span>
01758         <span class="comment">// Check that the attribtes are all zero for the restricted sids</span>
01759         <span class="comment">//</span>
01760 
01761         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; CapturedSidCount ; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
01762             <span class="keywordflow">if</span> (CapturedSids[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Attributes != 0) {
01763                 <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
01764             }
01765         }
01766 
01767     }
01768 
01769 
01770 
01771     <span class="comment">//</span>
01772     <span class="comment">//  Check the handle's access to the existing token and get</span>
01773     <span class="comment">//  a pointer to that token.  Pick up the default desired</span>
01774     <span class="comment">//  access mask from the handle while we're at it.</span>
01775     <span class="comment">//</span>
01776 
01777     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>) ExistingToken;
01778 
01779 
01780 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01781 <span class="preprocessor"></span>
01782 <span class="comment">//</span>
01783 <span class="comment">// Debug</span>
01784     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
01785     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01786     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01787     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Token being filtered: \n"</span>);
01788     SepDumpToken( Token );
01789     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01790 <span class="comment">// Debug</span>
01791 <span class="comment">//</span>
01793 <span class="comment"></span><span class="preprocessor">#endif //TOKEN_DEBUG</span>
01794 <span class="preprocessor"></span>
01795 
01796     <span class="comment">//</span>
01797     <span class="comment">//  Filter the existing token</span>
01798     <span class="comment">//</span>
01799 
01800     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a28">SepFilterToken</a>(
01801                  Token,
01802                  KernelMode,
01803                  Flags,
01804                  CapturedGroupCount,
01805                  CapturedGroups,
01806                  CapturedPrivilegeCount,
01807                  CapturedPrivileges,
01808                  CapturedSidCount,
01809                  CapturedSids,
01810                  CapturedSidsLength,
01811                  &amp;FilteredToken
01812                  );
01813 
01814 
01815     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01816 
01817         <span class="comment">//</span>
01818         <span class="comment">//  Insert the new token</span>
01819         <span class="comment">//</span>
01820 
01821         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( FilteredToken,
01822                                  NULL,
01823                                  0,
01824                                  0,
01825                                  (PVOID *)NULL,
01826                                  &amp;LocalHandle
01827                                  );
01828 
01829         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01830 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01831 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"SE: ObInsertObject failed (%x) for token at %x\n"</span>, Status, NewToken );
01832 <span class="preprocessor">#endif</span>
01833 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
01834             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01835                         LocalHandle,
01836                         TOKEN_IMPERSONATE,
01837                         SepTokenObjectType,
01838                         KernelMode,
01839                         (PVOID * ) NewToken,
01840                         NULL                    <span class="comment">// granted acess</span>
01841                         );
01842 
01843             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(LocalHandle);
01844 
01845         }
01846 
01847     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NewToken != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01848 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01849 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"SE: SepFilterToken failed (%x) but allocated token at %x\n"</span>, Status, NewToken );
01850 <span class="preprocessor">#endif</span>
01851 <span class="preprocessor"></span>    }
01852 
01853 
01854 
01855    <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01856 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="tokendup.c::SepDuplicateToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepDuplicateToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ExistingToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>EffectiveOnly</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN TOKEN_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECURITY_IMPERSONATION_LEVEL ImpersonationLevel&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>DuplicateToken</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00362">362</a> of file <a class="el" href="../../d7/d2/tokendup_8c-source.html">tokendup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03024">ExAllocateLocallyUniqueId</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00681">SepCopyProxyData()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00384">SepDeReferenceLogonSession()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00737">SepFreeProxyData()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00806">SepMakeTokenEffectiveOnly()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00278">SepReferenceLogonSession()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00046">NtDuplicateToken()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01227">SeCopyClientToken()</a>, and <a class="el" href="../../d5/d2/token_8c-source.html#l01327">SeSubProcessToken()</a>.
<p>
<pre class="fragment"><div>00376                    :
00377 
00378     This routine does <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bulk of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work to actually duplicate
00379     a token.  This routine assumes all access validation and argument
00380     probing (except the ObjectAttributes) has been performed.
00381 
00382     THE CALLER IS RESPONSIBLE FOR CHECKING SUBJECT RIGHTS TO <a class="code" href="../../d2/d5/editreg_8c.html#a10">CREATE</a> THE
00383     TYPE OF <a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> BEING CREATED.
00384 
00385     This routine acquires a read lock on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token being duplicated.
00386 
00387 Arguments:
00388 
00389     ExistingToken - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to be duplicated.
00390 
00391     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> standard object attributes data
00392         structure.  Refer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT Object Management
00393         Specification <span class="keywordflow">for</span> a description of <span class="keyword">this</span> data structure.
00394 
00395         The security Quality Of Service of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object attributes are ignored.
00396         This information must be specified <span class="keyword">using</span> parameters to <span class="keyword">this</span>
00397         routine.
00398 
00399     EffectiveOnly - Is a <span class="keywordtype">boolean</span> flag indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire
00400         source token should be duplicated into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target token or
00401         just <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> effective (currently enabled) part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00402         This provides a means <span class="keywordflow">for</span> a caller of a <span class="keyword">protected</span> subsystem
00403         to limit which privileges and optional groups are <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>
00404         available to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">protected</span> subsystem.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00405         indicates <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> currently enabled parts of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source
00406         token are to be duplicated.  Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire source
00407         token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> duplicated.
00408 
00409     TokenType - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of token to make <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duplicate token.
00410 
00411     ImpersonationLevel - This value specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation level
00412         to assign to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duplicate token.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TokenType of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00413         duplicate <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not TokenImpersonation then <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00414         ignored.  Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> must be provided.
00415 
00416     RequestorMode - Mode of client requesting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token be duplicated.
00417 
00418     DuplicateToken - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duplicate token.
00419         The token has not yet been inserted into any object table.
00420         No exceptions are expected when tring to set <span class="keyword">this</span> OUT value.
00421 
00422 Return Value:
00423 
00424     STATUS_SUCCESS - The service successfully completed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
00425         operation.
00426 
00427 
00428 --*/
00429 {
00430     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00431 
00432     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> NewToken;
00433     PULONG DynamicPart;
00434     ULONG PagedPoolSize;
00435     ULONG NonPagedPoolSize;
00436     ULONG TokenBodyLength;
00437     ULONG FieldOffset;
00438 
00439     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00440 
00441     PSECURITY_TOKEN_PROXY_DATA NewProxyData;
00442     PSECURITY_TOKEN_AUDIT_DATA NewAuditData;
00443 
00444 
00445     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00446 
00447     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(SECURITY_IMPERSONATION_LEVEL) &lt;= <span class="keyword">sizeof</span>(ULONG) );
00448 
00449 
00450     <span class="keywordflow">if</span> ( TokenType == TokenImpersonation ) {
00451 
00452         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SecurityDelegation     &gt; SecurityImpersonation );
00453         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SecurityImpersonation  &gt; SecurityIdentification );
00454         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SecurityIdentification &gt; SecurityAnonymous );
00455 
00456         <span class="keywordflow">if</span> ( (ImpersonationLevel &gt; SecurityDelegation)  ||
00457              (ImpersonationLevel &lt; SecurityAnonymous) ) {
00458 
00459             <span class="keywordflow">return</span> STATUS_BAD_IMPERSONATION_LEVEL;
00460         }
00461     }
00462 
00463 
00464     <span class="comment">//</span>
00465     <span class="comment">// Increment the reference count for this logon session</span>
00466     <span class="comment">// This can not fail, since there is already a token in this logon</span>
00467     <span class="comment">// session.</span>
00468     <span class="comment">//</span>
00469 
00470     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/sep_8h.html#a40">SepReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
00471     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00472 
00473 
00474 
00475     <span class="comment">//</span>
00476     <span class="comment">// Note that the size of the dynamic portion of a token can not change</span>
00477     <span class="comment">// once established.</span>
00478     <span class="comment">//</span>
00479 
00480     <span class="comment">//</span>
00481     <span class="comment">//  Allocate the dynamic portion</span>
00482     <span class="comment">//</span>
00483 
00484     DynamicPart = (PULONG)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00485                               PagedPool,
00486                               ExistingToken-&gt;DynamicCharged,
00487                               'dTeS'
00488                               );
00489 
00490     <span class="keywordflow">if</span> (DynamicPart == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00491         <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
00492         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00493     }
00494 
00495     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ExistingToken-&gt;ProxyData)) {
00496 
00497         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/sep_8h.html#a73">SepCopyProxyData</a>(
00498                     &amp;NewProxyData,
00499                     ExistingToken-&gt;ProxyData
00500                     );
00501 
00502         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00503 
00504             <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
00505             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DynamicPart );
00506             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00507         }
00508 
00509     } <span class="keywordflow">else</span> {
00510 
00511         NewProxyData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00512     }
00513 
00514     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ExistingToken-&gt;AuditData )) {
00515 
00516         NewAuditData = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, <span class="keyword">sizeof</span>( SECURITY_TOKEN_AUDIT_DATA ));
00517 
00518         <span class="keywordflow">if</span> (NewAuditData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00519 
00520             <a class="code" href="../../d6/d6/sep_8h.html#a74">SepFreeProxyData</a>( NewProxyData );
00521             <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
00522             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DynamicPart );
00523 
00524             <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00525 
00526         } <span class="keywordflow">else</span> {
00527 
00528             *NewAuditData = *(ExistingToken-&gt;AuditData);
00529         }
00530 
00531     } <span class="keywordflow">else</span> {
00532 
00533         NewAuditData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00534 
00535     }
00536 
00537     <span class="comment">//</span>
00538     <span class="comment">//  Create a new object</span>
00539     <span class="comment">//</span>
00540 
00541     TokenBodyLength = (ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a>) +
00542                       ExistingToken-&gt;VariableLength;
00543 
00544     NonPagedPoolSize = TokenBodyLength;
00545     PagedPoolSize    = ExistingToken-&gt;DynamicCharged;
00546 
00547     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(
00548                  RequestorMode,      <span class="comment">// ProbeMode</span>
00549                  SepTokenObjectType, <span class="comment">// ObjectType</span>
00550                  ObjectAttributes,   <span class="comment">// ObjectAttributes</span>
00551                  RequestorMode,      <span class="comment">// OwnershipMode</span>
00552                  NULL,               <span class="comment">// ParseContext</span>
00553                  TokenBodyLength,    <span class="comment">// ObjectBodySize</span>
00554                  PagedPoolSize,      <span class="comment">// PagedPoolCharge</span>
00555                  NonPagedPoolSize,   <span class="comment">// NonPagedPoolCharge</span>
00556                  (PVOID *)&amp;NewToken  <span class="comment">// Return pointer to object</span>
00557                  );
00558 
00559     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00560         <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
00561         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DynamicPart );
00562         <a class="code" href="../../d6/d6/sep_8h.html#a74">SepFreeProxyData</a>( NewProxyData );
00563 
00564         <span class="keywordflow">if</span> (NewAuditData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00565             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewAuditData );
00566         }
00567 
00568         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00569     }
00570 
00571 
00572     <span class="comment">//</span>
00573     <span class="comment">//  acquire exclusive access to the source token</span>
00574     <span class="comment">//</span>
00575 
00576     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( ExistingToken );
00577 
00578 
00579     <span class="comment">//</span>
00580     <span class="comment">// Main Body initialization</span>
00581     <span class="comment">//</span>
00582 
00583     <span class="comment">//</span>
00584     <span class="comment">// The following fields are unchanged from the source token.</span>
00585     <span class="comment">// Although some may change if EffectiveOnly has been specified.</span>
00586     <span class="comment">//</span>
00587 
00588     NewToken-&gt;AuthenticationId = ExistingToken-&gt;AuthenticationId;
00589     NewToken-&gt;ModifiedId = ExistingToken-&gt;ModifiedId;
00590     NewToken-&gt;ExpirationTime = ExistingToken-&gt;ExpirationTime;
00591     NewToken-&gt;TokenSource = ExistingToken-&gt;TokenSource;
00592     NewToken-&gt;DynamicCharged = ExistingToken-&gt;DynamicCharged;
00593     NewToken-&gt;DynamicAvailable = ExistingToken-&gt;DynamicAvailable;
00594     NewToken-&gt;DefaultOwnerIndex = ExistingToken-&gt;DefaultOwnerIndex;
00595     NewToken-&gt;UserAndGroupCount = ExistingToken-&gt;UserAndGroupCount;
00596     NewToken-&gt;RestrictedSidCount = ExistingToken-&gt;RestrictedSidCount;
00597     NewToken-&gt;PrivilegeCount = ExistingToken-&gt;PrivilegeCount;
00598     NewToken-&gt;VariableLength = ExistingToken-&gt;VariableLength;
00599     NewToken-&gt;TokenFlags = ExistingToken-&gt;TokenFlags;
00600     NewToken-&gt;ProxyData = NewProxyData;
00601     NewToken-&gt;AuditData = NewAuditData;
00602     NewToken-&gt;SessionId = ExistingToken-&gt;SessionId;
00603 
00604 
00605     <span class="comment">//</span>
00606     <span class="comment">// The following fields differ in the new token.</span>
00607     <span class="comment">//</span>
00608 
00609     <a class="code" href="../../d5/d8/ex_8h.html#a79">ExAllocateLocallyUniqueId</a>( &amp;(NewToken-&gt;TokenId) );
00610     NewToken-&gt;ParentTokenId = ExistingToken-&gt;ParentTokenId;
00611     NewToken-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00612     NewToken-&gt;TokenType = TokenType;
00613     NewToken-&gt;ImpersonationLevel = ImpersonationLevel;
00614 
00615 
00616     <span class="comment">//</span>
00617     <span class="comment">//  Copy and initialize the variable part.</span>
00618     <span class="comment">//  The variable part is assumed to be position independent.</span>
00619     <span class="comment">//</span>
00620 
00621     RtlCopyMemory( (PVOID)&amp;(NewToken-&gt;VariablePart),
00622                   (PVOID)&amp;(ExistingToken-&gt;VariablePart),
00623                   ExistingToken-&gt;VariableLength
00624                   );
00625 
00626     <span class="comment">//</span>
00627     <span class="comment">//  Set the address of the UserAndGroups array.</span>
00628     <span class="comment">//</span>
00629 
00630     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ARGUMENT_PRESENT(ExistingToken-&gt;UserAndGroups ) );
00631     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ULONG_PTR)(ExistingToken-&gt;UserAndGroups) &gt;=
00632             (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)) );
00633 
00634     FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;UserAndGroups) -
00635                           (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)));
00636 
00637     NewToken-&gt;UserAndGroups =
00638         (PSID_AND_ATTRIBUTES)(FieldOffset + (ULONG_PTR)(&amp;(NewToken-&gt;VariablePart)));
00639 
00640     <span class="comment">//</span>
00641     <span class="comment">//  Now go through and change the address of each SID pointer</span>
00642     <span class="comment">//  for the user and groups</span>
00643     <span class="comment">//</span>
00644 
00645     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00646 
00647     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ExistingToken-&gt;UserAndGroupCount) {
00648 
00649         FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;UserAndGroups[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Sid) -
00650                               (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)));
00651 
00652         NewToken-&gt;UserAndGroups[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Sid =
00653             (PSID)( FieldOffset + (ULONG_PTR)(&amp;(NewToken-&gt;VariablePart)) );
00654 
00655         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00656 
00657     }
00658 
00659     <span class="comment">//</span>
00660     <span class="comment">//  Set the address of the RestrictedSids array.</span>
00661     <span class="comment">//</span>
00662 
00663     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ExistingToken-&gt;RestrictedSids ) ) {
00664         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ULONG_PTR)(ExistingToken-&gt;RestrictedSids) &gt;=
00665                 (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)) );
00666 
00667         FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;RestrictedSids) -
00668                               (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)));
00669 
00670         NewToken-&gt;RestrictedSids =
00671             (PSID_AND_ATTRIBUTES)(FieldOffset + (ULONG_PTR)(&amp;(NewToken-&gt;VariablePart)) );
00672 
00673         <span class="comment">//</span>
00674         <span class="comment">//  Now go through and change the address of each SID pointer</span>
00675         <span class="comment">//  for the user and groups</span>
00676         <span class="comment">//</span>
00677 
00678         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00679 
00680         <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ExistingToken-&gt;RestrictedSidCount) {
00681 
00682             FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;RestrictedSids[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Sid) -
00683                                   (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)));
00684 
00685             NewToken-&gt;RestrictedSids[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Sid =
00686                 (PSID)( FieldOffset + (ULONG_PTR)(&amp;(NewToken-&gt;VariablePart)) );
00687 
00688             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00689 
00690         }
00691     } <span class="keywordflow">else</span> {
00692         NewToken-&gt;RestrictedSids = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00693     }
00694 
00695 
00696     <span class="comment">//</span>
00697     <span class="comment">// If present, set the address of the privileges</span>
00698     <span class="comment">//</span>
00699 
00700     <span class="keywordflow">if</span> (ExistingToken-&gt;PrivilegeCount &gt; 0) {
00701         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ARGUMENT_PRESENT(ExistingToken-&gt;Privileges ) );
00702         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ULONG_PTR)(ExistingToken-&gt;Privileges) &gt;=
00703                 (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)) );
00704 
00705         FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;Privileges) -
00706                               (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)));
00707         NewToken-&gt;Privileges = (PLUID_AND_ATTRIBUTES)(
00708                                    FieldOffset +
00709                                    (ULONG_PTR)(&amp;(NewToken-&gt;VariablePart))
00710                                    );
00711     } <span class="keywordflow">else</span> {
00712 
00713         NewToken-&gt;Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00714 
00715     }
00716 
00717     <span class="comment">//</span>
00718     <span class="comment">//  Copy and initialize the dynamic part.</span>
00719     <span class="comment">//  The dynamic part is assumed to be position independent.</span>
00720     <span class="comment">//</span>
00721 
00722     RtlCopyMemory( (PVOID)DynamicPart,
00723                   (PVOID)(ExistingToken-&gt;DynamicPart),
00724                   ExistingToken-&gt;DynamicCharged
00725                   );
00726 
00727     NewToken-&gt;DynamicPart = DynamicPart;
00728 
00729     <span class="comment">//</span>
00730     <span class="comment">// If present, set the address of the default Dacl</span>
00731     <span class="comment">//</span>
00732 
00733     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ExistingToken-&gt;DefaultDacl)) {
00734 
00735         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ULONG_PTR)(ExistingToken-&gt;DefaultDacl) &gt;=
00736                 (ULONG_PTR)(ExistingToken-&gt;DynamicPart) );
00737 
00738         FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;DefaultDacl) -
00739                               (ULONG_PTR)(ExistingToken-&gt;DynamicPart));
00740 
00741         NewToken-&gt;DefaultDacl = (PACL)(FieldOffset + (ULONG_PTR)DynamicPart);
00742 
00743     } <span class="keywordflow">else</span> {
00744 
00745         NewToken-&gt;DefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00746     }
00747 
00748 
00749     <span class="comment">//</span>
00750     <span class="comment">// Set the address of the primary group</span>
00751     <span class="comment">//</span>
00752 
00753     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ARGUMENT_PRESENT(ExistingToken-&gt;PrimaryGroup));
00754 
00755     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ULONG_PTR)(ExistingToken-&gt;PrimaryGroup) &gt;=
00756             (ULONG_PTR)(ExistingToken-&gt;DynamicPart) );
00757 
00758     FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;PrimaryGroup) -
00759                           (ULONG_PTR)(ExistingToken-&gt;DynamicPart));
00760 
00761     NewToken-&gt;PrimaryGroup = (PACL)(FieldOffset + (ULONG_PTR)(DynamicPart));
00762 
00763 
00764     <span class="comment">//</span>
00765     <span class="comment">// For the time being, take the easy way to generating an "EffectiveOnly"</span>
00766     <span class="comment">// duplicate.  That is, use the same space required of the original, just</span>
00767     <span class="comment">// eliminate any IDs or privileges not active.</span>
00768     <span class="comment">//</span>
00769     <span class="comment">// Ultimately, if duplication becomes a common operation, then it will be</span>
00770     <span class="comment">// worthwhile to recalculate the actual space needed and copy only the</span>
00771     <span class="comment">// effective IDs/privileges into the new token.</span>
00772     <span class="comment">//</span>
00773 
00774     <span class="keywordflow">if</span> (EffectiveOnly) {
00775         <a class="code" href="../../d8/d3/tokenp_8h.html#a34">SepMakeTokenEffectiveOnly</a>( NewToken );
00776     }
00777 
00778 
00779 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
00780 <span class="preprocessor"></span>
00781 <span class="comment">//</span>
00782 <span class="comment">// Debug</span>
00783     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
00784     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
00785     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
00786     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Duplicate token:\n"</span>);
00787     SepDumpToken( NewToken );
00788 <span class="comment">// Debug</span>
00789 <span class="comment">//</span>
00791 <span class="comment"></span><span class="preprocessor">#endif //TOKEN_DEBUG</span>
00792 <span class="preprocessor"></span>
00793     <span class="comment">//</span>
00794     <span class="comment">// Release the source token.</span>
00795     <span class="comment">//</span>
00796 
00797     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( ExistingToken );
00798 
00799 
00800     (*DuplicateToken) = NewToken;
00801     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00802 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="tokendup.c::SepFilterToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepFilterToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ExistingToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID_AND_ATTRIBUTES GroupsToDisable&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID_AND_ATTRIBUTES PrivilegesToDelete&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SidCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID_AND_ATTRIBUTES RestrictedSids&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SidLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>FilteredToken</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">1939</a> of file <a class="el" href="../../d7/d2/tokendup_8c-source.html">tokendup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03024">ExAllocateLocallyUniqueId</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d6/d3/tokendup_8c.html#a0">MAX</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01896">RtlCopyLuidAndAttributesArray()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01436">RtlCopySidAndAttributesArray()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00681">SepCopyProxyData()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00384">SepDeReferenceLogonSession()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00737">SepFreeProxyData()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00278">SepReferenceLogonSession()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01041">SepRemoveDisabledGroupsAndPrivileges()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00933">SepSidInSidAndAttributes()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00076">TOKEN_IS_RESTRICTED</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01306">NtFilterToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01859">SeFastFilterToken()</a>, and <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01634">SeFilterToken()</a>.
<p>
<pre class="fragment"><div>01955                    :
01956 
01957     This routine does <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bulk of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work to actually filter
01958     a token.  This routine assumes all access validation and argument
01959     probing has been performed.
01960 
01961     THE CALLER IS RESPONSIBLE FOR CHECKING SUBJECT RIGHTS TO <a class="code" href="../../d2/d5/editreg_8c.html#a10">CREATE</a> THE
01962     TYPE OF <a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> BEING CREATED.
01963 
01964     This routine acquires a read lock on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token being filtered.
01965 
01966 Arguments:
01967 
01968     ExistingToken - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to be duplicated.
01969 
01970     RequestorMode - Mode of client requesting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token be duplicated.
01971 
01972     GroupCount - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of groups to disable
01973 
01974     GroupsToDisable - Contains a list of sids and attributes. All sids with
01975         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> USE_FOR_DENY_ONLY attribute that also exist in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token will
01976         cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token to have that sid set with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> USE_FOR_DENY_ONLY
01977         attribute.
01978 
01979     PrivilegeCount - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of privileges to <span class="keyword">delete</span>
01980 
01981     PrivilegesToDelete - Privileges in <span class="keyword">this</span> list that are present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01982         existing token will not exist in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> token. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> similar
01983         to duplicating a token effective <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> with these privileges set to
01984         disabled.
01985 
01986     SidCount - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of restricted sids to add.
01987 
01988     RestrictedSids - Contains a list of SIDs and attributes that will be
01989         stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RestrictedSids field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token. These SIDs
01990         are used after a normal access check to futher restrict access.
01991         The attributes of these groups are always SE_GROUP_MANDATORY |
01992         SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT. If there already
01993         exist RestrictedSids in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original token, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> intersection of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01994         two sets will be in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> tokense sids will be.
01995 
01996     SidLength - Length of added restricted sids.
01997 
01998     FilteredToken - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duplicate token.
01999         The token has not yet been inserted into any object table.
02000         No exceptions are expected when tring to set <span class="keyword">this</span> OUT value.
02001 
02002 Return Value:
02003 
02004     STATUS_SUCCESS - The service successfully completed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
02005         operation.
02006 
02007 
02008 --*/
02009 {
02010     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02011 
02012     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> NewToken;
02013     PULONG DynamicPart;
02014     ULONG PagedPoolSize;
02015     ULONG NonPagedPoolSize;
02016     ULONG TokenBodyLength;
02017     ULONG FieldOffset;
02018     ULONG_PTR NextFree;
02019     PSID NextSidFree;
02020     ULONG VariableLength;
02021 
02022     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02023 
02024     PSECURITY_TOKEN_PROXY_DATA NewProxyData;
02025     PSECURITY_TOKEN_AUDIT_DATA NewAuditData;
02026     OBJECT_ATTRIBUTES ObjA ;
02027 
02028 
02029     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02030 
02031     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(SECURITY_IMPERSONATION_LEVEL) &lt;= <span class="keyword">sizeof</span>(ULONG) );
02032 
02033 
02034     <span class="comment">//</span>
02035     <span class="comment">// Increment the reference count for this logon session</span>
02036     <span class="comment">// This can not fail, since there is already a token in this logon</span>
02037     <span class="comment">// session.</span>
02038     <span class="comment">//</span>
02039 
02040     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/sep_8h.html#a40">SepReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
02041     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
02042 
02043 
02044 
02045     <span class="comment">//</span>
02046     <span class="comment">// Note that the size of the dynamic portion of a token can not change</span>
02047     <span class="comment">// once established.</span>
02048     <span class="comment">//</span>
02049 
02050     <span class="comment">//</span>
02051     <span class="comment">//  Allocate the dynamic portion</span>
02052     <span class="comment">//</span>
02053 
02054     DynamicPart = (PULONG)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
02055                               PagedPool,
02056                               ExistingToken-&gt;DynamicCharged,
02057                               'dTeS'
02058                               );
02059 
02060     <span class="keywordflow">if</span> (DynamicPart == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02061         <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
02062         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
02063     }
02064 
02065     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ExistingToken-&gt;ProxyData)) {
02066 
02067         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/sep_8h.html#a73">SepCopyProxyData</a>(
02068                     &amp;NewProxyData,
02069                     ExistingToken-&gt;ProxyData
02070                     );
02071 
02072         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02073 
02074             <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
02075             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DynamicPart );
02076             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02077         }
02078 
02079     } <span class="keywordflow">else</span> {
02080 
02081         NewProxyData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02082     }
02083 
02084     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ExistingToken-&gt;AuditData )) {
02085 
02086         NewAuditData = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, <span class="keyword">sizeof</span>( SECURITY_TOKEN_AUDIT_DATA ));
02087 
02088         <span class="keywordflow">if</span> (NewAuditData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02089 
02090             <a class="code" href="../../d6/d6/sep_8h.html#a74">SepFreeProxyData</a>( NewProxyData );
02091             <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
02092             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DynamicPart );
02093 
02094             <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
02095 
02096         } <span class="keywordflow">else</span> {
02097 
02098             *NewAuditData = *(ExistingToken-&gt;AuditData);
02099         }
02100 
02101     } <span class="keywordflow">else</span> {
02102 
02103         NewAuditData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02104 
02105     }
02106 
02107     <span class="comment">//</span>
02108     <span class="comment">//  Create a new object</span>
02109     <span class="comment">//</span>
02110 
02111     VariableLength = ExistingToken-&gt;VariableLength + SidLength;
02112 
02113     TokenBodyLength = (ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a>) +
02114                       VariableLength;
02115 
02116     NonPagedPoolSize = TokenBodyLength;
02117     PagedPoolSize    = ExistingToken-&gt;DynamicCharged;
02118 
02119     InitializeObjectAttributes( &amp;ObjA, NULL, 0, NULL, NULL );
02120 
02121     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(
02122                  RequestorMode,      <span class="comment">// ProbeMode</span>
02123                  SepTokenObjectType, <span class="comment">// ObjectType</span>
02124                  NULL,               <span class="comment">// ObjectAttributes</span>
02125                  RequestorMode,      <span class="comment">// OwnershipMode</span>
02126                  NULL,               <span class="comment">// ParseContext</span>
02127                  TokenBodyLength,    <span class="comment">// ObjectBodySize</span>
02128                  PagedPoolSize,      <span class="comment">// PagedPoolCharge</span>
02129                  NonPagedPoolSize,   <span class="comment">// NonPagedPoolCharge</span>
02130                  (PVOID *)&amp;NewToken  <span class="comment">// Return pointer to object</span>
02131                  );
02132 
02133     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02134         <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
02135         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DynamicPart );
02136         <a class="code" href="../../d6/d6/sep_8h.html#a74">SepFreeProxyData</a>( NewProxyData );
02137 
02138         <span class="keywordflow">if</span> (NewAuditData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02139             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewAuditData );
02140         }
02141 
02142         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02143     }
02144 
02145 
02146     <span class="comment">//</span>
02147     <span class="comment">//  acquire exclusive access to the source token</span>
02148     <span class="comment">//</span>
02149 
02150     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( ExistingToken );
02151 
02152 
02153     <span class="comment">//</span>
02154     <span class="comment">// Main Body initialization</span>
02155     <span class="comment">//</span>
02156 
02157     <span class="comment">//</span>
02158     <span class="comment">// The following fields are unchanged from the source token.</span>
02159     <span class="comment">// Although some may change if EffectiveOnly has been specified.</span>
02160     <span class="comment">//</span>
02161 
02162     NewToken-&gt;AuthenticationId = ExistingToken-&gt;AuthenticationId;
02163     NewToken-&gt;ExpirationTime = ExistingToken-&gt;ExpirationTime;
02164     NewToken-&gt;TokenSource = ExistingToken-&gt;TokenSource;
02165     NewToken-&gt;DynamicCharged = ExistingToken-&gt;DynamicCharged;
02166     NewToken-&gt;DynamicAvailable = ExistingToken-&gt;DynamicAvailable;
02167     NewToken-&gt;DefaultOwnerIndex = ExistingToken-&gt;DefaultOwnerIndex;
02168     NewToken-&gt;UserAndGroupCount = ExistingToken-&gt;UserAndGroupCount;
02169     NewToken-&gt;SessionId = ExistingToken-&gt;SessionId;
02170     NewToken-&gt;RestrictedSidCount = 0;
02171     NewToken-&gt;PrivilegeCount = ExistingToken-&gt;PrivilegeCount;
02172     NewToken-&gt;VariableLength = VariableLength;
02173     NewToken-&gt;TokenFlags = ExistingToken-&gt;TokenFlags;
02174     NewToken-&gt;ProxyData = NewProxyData;
02175     NewToken-&gt;AuditData = NewAuditData;
02176 
02177 
02178     <span class="comment">//</span>
02179     <span class="comment">// The following fields differ in the new token.</span>
02180     <span class="comment">//</span>
02181 
02182     <span class="comment">//</span>
02183     <span class="comment">// Allocate a new modified Id to distinguish this token from the orignial</span>
02184     <span class="comment">// token.</span>
02185     <span class="comment">//</span>
02186 
02187     <a class="code" href="../../d5/d8/ex_8h.html#a79">ExAllocateLocallyUniqueId</a>( &amp;(NewToken-&gt;ModifiedId) );
02188     <a class="code" href="../../d5/d8/ex_8h.html#a79">ExAllocateLocallyUniqueId</a>( &amp;(NewToken-&gt;TokenId) );
02189     NewToken-&gt;ParentTokenId = ExistingToken-&gt;TokenId;
02190     NewToken-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02191     NewToken-&gt;TokenType = ExistingToken-&gt;TokenType;
02192     NewToken-&gt;ImpersonationLevel = ExistingToken-&gt;ImpersonationLevel;
02193 
02194 
02195 
02196     <span class="comment">//</span>
02197     <span class="comment">// Compute the beginning portion of the variable part, which contains the</span>
02198     <span class="comment">// sid &amp; attributes arrays and the privilege set.</span>
02199     <span class="comment">//</span>
02200 
02201     <span class="comment">//</span>
02202     <span class="comment">// First copy the privileges. We will later remove the ones that are</span>
02203     <span class="comment">// to be deleted.</span>
02204     <span class="comment">//</span>
02205 
02206     NextFree = (ULONG_PTR)(&amp;NewToken-&gt;VariablePart);
02207     NewToken-&gt;Privileges = (PLUID_AND_ATTRIBUTES)NextFree;
02208     <a class="code" href="../../d8/d6/sertl_8c.html#a52">RtlCopyLuidAndAttributesArray</a>( ExistingToken-&gt;PrivilegeCount,
02209                                    ExistingToken-&gt;Privileges,
02210                                    (PLUID_AND_ATTRIBUTES)NextFree
02211                                    );
02212 
02213     NextFree += (ExistingToken-&gt;PrivilegeCount * (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES));
02214     VariableLength -= ( (ExistingToken-&gt;PrivilegeCount * (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)) );
02215 
02216     <span class="comment">//</span>
02217     <span class="comment">// Figure out the count of SIDs. This is the count of users&amp;groups +</span>
02218     <span class="comment">// the number of existing restricuted SIDs plus the number of new</span>
02219     <span class="comment">// restricted Sids</span>
02220     <span class="comment">//</span>
02221 
02222 <span class="preprocessor">#define MAX(_x_,_y_) ((_x_) &gt; (_y_) ? (_x_) : (_y_))</span>
02223 <span class="preprocessor"></span>
02224     NextSidFree = (PSID) (NextFree + (ExistingToken-&gt;UserAndGroupCount +
02225                                       <a class="code" href="../../d6/d3/tokendup_8c.html#a0">MAX</a>(ExistingToken-&gt;RestrictedSidCount,SidCount)) * <span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES));
02226 
02227     NewToken-&gt;UserAndGroups = (PSID_AND_ATTRIBUTES) NextFree;
02228 
02229     <span class="comment">//</span>
02230     <span class="comment">// Copy in the existing users &amp; groups. We will later flag the ones</span>
02231     <span class="comment">// to be disabled.</span>
02232     <span class="comment">//</span>
02233 
02234     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
02235                  ExistingToken-&gt;UserAndGroupCount,
02236                  ExistingToken-&gt;UserAndGroups,
02237                  VariableLength,
02238                  (PSID_AND_ATTRIBUTES)NextFree,
02239                  NextSidFree,
02240                  &amp;NextSidFree,
02241                  &amp;VariableLength
02242                  );
02243 
02244 
02245     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
02246     NextFree += (ExistingToken-&gt;UserAndGroupCount * (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES));
02247 
02248     <span class="comment">//</span>
02249     <span class="comment">// Now add all the existing restricted sids. We need to take the</span>
02250     <span class="comment">// intersection of the two sets.</span>
02251     <span class="comment">//</span>
02252 
02253     NewToken-&gt;RestrictedSids = (PSID_AND_ATTRIBUTES) NextFree;
02254 
02255 
02256     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; SidCount ; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
02257         <span class="keywordflow">if</span> ( ( ExistingToken-&gt;RestrictedSidCount == 0 ) ||
02258             <a class="code" href="../../d8/d3/tokenp_8h.html#a29">SepSidInSidAndAttributes</a>(
02259                 ExistingToken-&gt;RestrictedSids,
02260                 ExistingToken-&gt;RestrictedSidCount,
02261                 NULL,                           <span class="comment">// no self sid</span>
02262                 RestrictedSids[Index].Sid
02263                 )) {
02264 
02265             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
02266                         1,
02267                         &amp;RestrictedSids[Index],
02268                         VariableLength,
02269                         (PSID_AND_ATTRIBUTES)NextFree,
02270                         NextSidFree,
02271                         &amp;NextSidFree,
02272                         &amp;VariableLength
02273                         );
02274             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
02275             NextFree += <span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES);
02276             NewToken-&gt;RestrictedSids[NewToken-&gt;RestrictedSidCount].Attributes =
02277                 SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT | SE_GROUP_MANDATORY;
02278             NewToken-&gt;RestrictedSidCount++;
02279 
02280         }
02281     }
02282 
02283     <span class="comment">//</span>
02284     <span class="comment">// Make sure the new token has some restrictions.</span>
02285     <span class="comment">// If it doesn't, then we've ended up with a token</span>
02286     <span class="comment">// that gives us more access than the original,</span>
02287     <span class="comment">// which we don't want.</span>
02288     <span class="comment">//</span>
02289 
02290     <span class="keywordflow">if</span> ((ExistingToken-&gt;RestrictedSidCount != 0) &amp;&amp;
02291         (NewToken-&gt;RestrictedSidCount == 0)) {
02292 
02293         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( ExistingToken );
02294 
02295         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02296 
02297         <span class="comment">//</span>
02298         <span class="comment">// Cleanup.  ObDereferenceObject will cause the logon</span>
02299         <span class="comment">// session to be dereferenced, and will free the proxy data</span>
02300         <span class="comment">// as well as the audit data.</span>
02301         <span class="comment">//</span>
02302         <span class="comment">// See SepTokenDeleteMethod(), which is called by</span>
02303         <span class="comment">// the object manager when the token object is</span>
02304         <span class="comment">// being freed.</span>
02305         <span class="comment">//</span>
02306 
02307         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DynamicPart );
02308 
02309         <span class="comment">//</span>
02310         <span class="comment">// Do this so we don't crash trying to free whatever</span>
02311         <span class="comment">// junk is pointed to by DynamicPart.</span>
02312         <span class="comment">//</span>
02313 
02314         NewToken-&gt;DynamicPart = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02315 
02316         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
02317 
02318         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02319     }
02320 
02321     <span class="comment">//</span>
02322     <span class="comment">// If there are any restricted sids in the token, turn on the restricted</span>
02323     <span class="comment">// flag</span>
02324     <span class="comment">//</span>
02325 
02326     <span class="keywordflow">if</span> (NewToken-&gt;RestrictedSidCount &gt; 0) {
02327         NewToken-&gt;TokenFlags |= <a class="code" href="../../d0/d5/se_8h.html#a5">TOKEN_IS_RESTRICTED</a>;
02328     }
02329 
02330     <span class="comment">//</span>
02331     <span class="comment">//  Copy and initialize the dynamic part.</span>
02332     <span class="comment">//  The dynamic part is assumed to be position independent.</span>
02333     <span class="comment">//</span>
02334 
02335     RtlCopyMemory( (PVOID)DynamicPart,
02336                   (PVOID)(ExistingToken-&gt;DynamicPart),
02337                   ExistingToken-&gt;DynamicCharged
02338                   );
02339 
02340     NewToken-&gt;DynamicPart = DynamicPart;
02341 
02342     <span class="comment">//</span>
02343     <span class="comment">// If present, set the address of the default Dacl</span>
02344     <span class="comment">//</span>
02345 
02346     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ExistingToken-&gt;DefaultDacl)) {
02347 
02348         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ULONG_PTR)(ExistingToken-&gt;DefaultDacl) &gt;=
02349                 (ULONG_PTR)(ExistingToken-&gt;DynamicPart) );
02350 
02351         FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;DefaultDacl) -
02352                               (ULONG_PTR)(ExistingToken-&gt;DynamicPart));
02353 
02354         NewToken-&gt;DefaultDacl = (PACL)(FieldOffset + (ULONG_PTR)DynamicPart);
02355 
02356     } <span class="keywordflow">else</span> {
02357 
02358         NewToken-&gt;DefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02359     }
02360 
02361 
02362     <span class="comment">//</span>
02363     <span class="comment">// Set the address of the primary group</span>
02364     <span class="comment">//</span>
02365 
02366     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ARGUMENT_PRESENT(ExistingToken-&gt;PrimaryGroup));
02367 
02368     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ULONG_PTR)(ExistingToken-&gt;PrimaryGroup) &gt;=
02369             (ULONG_PTR)(ExistingToken-&gt;DynamicPart) );
02370 
02371     FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;PrimaryGroup) -
02372                           (ULONG_PTR)(ExistingToken-&gt;DynamicPart));
02373 
02374     NewToken-&gt;PrimaryGroup = (PACL)(FieldOffset + (ULONG_PTR)(DynamicPart));
02375 
02376 
02377     <span class="comment">//</span>
02378     <span class="comment">// For the time being, take the easy way to generating an "EffectiveOnly"</span>
02379     <span class="comment">// duplicate.  That is, use the same space required of the original, just</span>
02380     <span class="comment">// eliminate any IDs or privileges not active.</span>
02381     <span class="comment">//</span>
02382     <span class="comment">// Ultimately, if duplication becomes a common operation, then it will be</span>
02383     <span class="comment">// worthwhile to recalculate the actual space needed and copy only the</span>
02384     <span class="comment">// effective IDs/privileges into the new token.</span>
02385     <span class="comment">//</span>
02386 
02387     <a class="code" href="../../d8/d3/tokenp_8h.html#a30">SepRemoveDisabledGroupsAndPrivileges</a>(
02388         NewToken,
02389         Flags,
02390         GroupCount,
02391         GroupsToDisable,
02392         PrivilegeCount,
02393         PrivilegesToDelete
02394         );
02395 
02396 
02397 
02398 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02399 <span class="preprocessor"></span>
02400 <span class="comment">//</span>
02401 <span class="comment">// Debug</span>
02402     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
02403     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
02404     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
02405     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Filter token:\n"</span>);
02406     SepDumpToken( NewToken );
02407 <span class="comment">// Debug</span>
02408 <span class="comment">//</span>
02410 <span class="comment"></span><span class="preprocessor">#endif //TOKEN_DEBUG</span>
02411 <span class="preprocessor"></span>
02412     <span class="comment">//</span>
02413     <span class="comment">// Release the source token.</span>
02414     <span class="comment">//</span>
02415 
02416     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( ExistingToken );
02417 
02418 
02419     (*FilteredToken) = NewToken;
02420     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02421 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="tokendup.c::SepMakeTokenEffectiveOnly" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepMakeTokenEffectiveOnly           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Token</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00806">806</a> of file <a class="el" href="../../d7/d2/tokendup_8c-source.html">tokendup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01630">SeAliasAdminsSid</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00489">SepTokenGroupAttributes</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00470">SepTokenPrivilegeAttributes</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00075">TOKEN_HAS_ADMIN_GROUP</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00362">SepDuplicateToken()</a>.
<p>
<pre class="fragment"><div>00814                    :
00815 
00816     This routine eliminates all but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> effective groups and privileges from
00817     a token.  It does <span class="keyword">this</span> by moving elements of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID and privileges arrays
00818     to overwrite lapsed IDs/privileges, and then reducing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> array element
00819     counts.  This results in wasted memory within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token object.
00820 
00821     One side effect of <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that a token that initially had a
00822     <span class="keywordflow">default</span> owner <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> corresponding to a lapsed group will be changed so
00823     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> owner <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.
00824 
00825     THIS ROUTINE MUST BE CALLED ONLY AS PART OF <a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> CREATION (FOR TOKENS
00826     WHICH HAVE NOT YET BEEN INSERTED INTO AN OBJECT TABLE.)  THIS ROUTINE
00827     MODIFIES READ ONLY <a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> FIELDS.
00828 
00829     Note that since we are operating on a token that is not yet visible
00830     to the user, we <span class="keywordflow">do</span> not bother acquiring a read lock on the token
00831     being modified.
00832 
00833 Arguments:
00834 
00835     Token - Points to the token to be made effective <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
00836 
00837 Return Value:
00838 
00839     None.
00840 
00841 --*/
00842 {
00843 
00844     ULONG Index;
00845     ULONG ElementCount;
00846 
00847     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00848 
00849     <span class="comment">//</span>
00850     <span class="comment">// Walk the privilege array, discarding any lapsed privileges</span>
00851     <span class="comment">//</span>
00852 
00853     ElementCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount;
00854     Index = 0;
00855 
00856     while (Index &lt; ElementCount) {
00857 
00858         <span class="comment">//</span>
00859         <span class="comment">// If this privilege is not enabled, replace it with the one at</span>
00860         <span class="comment">// the end of the array and reduce the size of the array by one.</span>
00861         <span class="comment">// Otherwise, move on to the next entry in the array.</span>
00862         <span class="comment">//</span>
00863 
00864         <span class="keywordflow">if</span> ( !(<a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(Token,Index) &amp; SE_PRIVILEGE_ENABLED)
00865             ) {
00866 
00867             (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges)[Index] =
00868                 (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges)[ElementCount - 1];
00869             ElementCount -= 1;
00870 
00871         } <span class="keywordflow">else</span> {
00872 
00873             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00874 
00875         }
00876 
00877     } <span class="comment">// endwhile</span>
00878 
00879     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount = ElementCount;
00880 
00881     <span class="comment">//</span>
00882     <span class="comment">// Walk the UserAndGroups array (except for the first entry, which is</span>
00883     <span class="comment">// the user - and can't be disabled) discarding any lapsed groups.</span>
00884     <span class="comment">//</span>
00885 
00886     ElementCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount;
00887     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ElementCount &gt;= 1 );        <span class="comment">// Must be at least a user ID</span>
00888     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1;   <span class="comment">// Start at the first group, not the user ID.</span>
00889 
00890     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ElementCount) {
00891 
00892         <span class="comment">//</span>
00893         <span class="comment">// If this group is not enabled, replace it with the one at</span>
00894         <span class="comment">// the end of the array and reduce the size of the array by one.</span>
00895         <span class="comment">//</span>
00896 
00897         <span class="keywordflow">if</span> ( !(<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token, Index) &amp; SE_GROUP_ENABLED) &amp;&amp;
00898              !(<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token, Index) &amp; SE_GROUP_USE_FOR_DENY_ONLY) ) {
00899 
00900             <span class="comment">//</span>
00901             <span class="comment">// Reset the TOKEN_HAS_ADMIN_GROUP flag</span>
00902             <span class="comment">//</span>
00903 
00904             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(
00905                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[Index].Sid,
00906                     SeAliasAdminsSid
00907                     )) {
00908                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags &amp;= ~<a class="code" href="../../d0/d5/se_8h.html#a4">TOKEN_HAS_ADMIN_GROUP</a>;
00909             }
00910 
00911 
00912             (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] =
00913                 (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups)[ElementCount - 1];
00914             ElementCount -= 1;
00915 
00916 
00917 
00918         } <span class="keywordflow">else</span> {
00919 
00920             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00921 
00922         }
00923 
00924     } <span class="comment">// endwhile</span>
00925 
00926     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount = ElementCount;
00927 
00928     <span class="keywordflow">return</span>;
00929 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="tokendup.c::SepRemoveDisabledGroupsAndPrivileges" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepRemoveDisabledGroupsAndPrivileges           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID_AND_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupsToDisable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID_AND_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegesToDelete</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01041">1041</a> of file <a class="el" href="../../d7/d2/tokendup_8c-source.html">tokendup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01630">SeAliasAdminsSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01691">SeChangeNotifyPrivilege</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00933">SepSidInSidAndAttributes()</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00075">TOKEN_HAS_ADMIN_GROUP</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00072">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">SepFilterToken()</a>.
<p>
<pre class="fragment"><div>01052                    :
01053 
01054     This routine eliminates all groups and privileges that are marked
01055     to be deleted/disabled. It does <span class="keyword">this</span> by looping through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> groups in
01056     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token and checking each one agains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> groups to disable. Similary
01057     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilegs are compared.  It does <span class="keyword">this</span> by moving elements of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID and privileges arrays
01058     to overwrite lapsed IDs/privileges, and then reducing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> array element
01059     counts.  This results in wasted memory within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token object.
01060 
01061 
01062     THIS ROUTINE MUST BE CALLED ONLY AS PART OF <a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> CREATION (FOR TOKENS
01063     WHICH HAVE NOT YET BEEN INSERTED INTO AN OBJECT TABLE.)  THIS ROUTINE
01064     MODIFIES READ ONLY <a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> FIELDS.
01065 
01066     Note that since we are operating on a token that is not yet visible
01067     to the user, we <span class="keywordflow">do</span> not bother acquiring a read lock on the token
01068     being modified.
01069 
01070 Arguments:
01071 
01072     Token - Points to the token to be made effective <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
01073 
01074     Flags - Flags indicating additional filtering. The flags may be:
01075 
01076                 DISABLE_ALL_GROUPS  - disable all groups in token
01077                 DELETE_ALL_PRIVILEGES - Disable all privileges
01078 
01079     GroupCount - Count of groups to be removed
01080 
01081     GroupsToDisable - Groups to disable and mark with SE_GROUP_USE_FOR_DENY_ONLY
01082 
01083     PrivilegeCount - Count of privileges to remove
01084 
01085     PrivilegesToDelete - List of privileges to remove
01086 
01087 Return Value:
01088 
01089     None.
01090 
01091 --*/
01092 {
01093 
01094     ULONG Index;
01095     ULONG Index2;
01096     ULONG ElementCount;
01097     BOOLEAN Found;
01098 
01099     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01100 
01101     <span class="comment">//</span>
01102     <span class="comment">// Walk the privilege array, discarding any lapsed privileges</span>
01103     <span class="comment">//</span>
01104 
01105     ElementCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount;
01106     Index = 0;
01107 
01108     while (Index &lt; ElementCount) {
01109 
01110         <span class="comment">//</span>
01111         <span class="comment">// If the caller asked us to disable all privileges except change</span>
01112         <span class="comment">// notify, do so now.</span>
01113         <span class="comment">//</span>
01114 
01115         <span class="keywordflow">if</span> (((Flags &amp; DISABLE_MAX_PRIVILEGE) != 0) &amp;&amp;
01116               !<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(
01117                 &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges[Index].Luid,
01118                 &amp;SeChangeNotifyPrivilege
01119                 )) {
01120 
01121             (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges)[Index] =
01122                 (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges)[ElementCount - 1];
01123             ElementCount -= 1;
01124 
01125         } <span class="keywordflow">else</span> {
01126 
01127             <span class="comment">//</span>
01128             <span class="comment">// If this privilege is in the list of those to be removed, replace it</span>
01129             <span class="comment">// with the one at the end of the array and reduce the size of the</span>
01130             <span class="comment">// array by one.  Otherwise, move on to the next entry in the array.</span>
01131             <span class="comment">//</span>
01132 
01133             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01134             <span class="keywordflow">for</span> (Index2 = 0; Index2 &lt; PrivilegeCount ; Index2++ ) {
01135                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(
01136                         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges[Index].Luid,
01137                         &amp;PrivilegesToDelete[Index2].Luid
01138                         )) {
01139                     (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] =
01140                         (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges)[ElementCount - 1];
01141                     ElementCount -= 1;
01142 
01143                     <span class="comment">//</span>
01144                     <span class="comment">// If this was SeChangeNotifyPrivilege, we need to turn off</span>
01145                     <span class="comment">// the TOKEN_HAS_TRAVERSE_PRIVILEGE in the token</span>
01146                     <span class="comment">//</span>
01147 
01148                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(
01149                             &amp;PrivilegesToDelete[Index2].Luid,
01150                             &amp;SeChangeNotifyPrivilege
01151                             )) {
01152                         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags &amp;= ~<a class="code" href="../../d0/d5/se_8h.html#a1">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>;
01153                     }
01154 
01155 
01156                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01157                     <span class="keywordflow">break</span>;
01158 
01159                 }
01160             }
01161 
01162             <span class="keywordflow">if</span> (!Found) {
01163                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01164             }
01165         }
01166     } <span class="comment">// endwhile</span>
01167 
01168     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount = ElementCount;
01169 
01170     <span class="comment">//</span>
01171     <span class="comment">// Walk the UserAndGroups array marking any disabled groups.</span>
01172     <span class="comment">//</span>
01173 
01174     ElementCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount;
01175     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ElementCount &gt;= 1 );        <span class="comment">// Must be at least a user ID</span>
01176     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;   <span class="comment">// Start at the first group, not the user ID.</span>
01177 
01178     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ElementCount) {
01179 
01180         <span class="comment">//</span>
01181         <span class="comment">// If this group is not enabled, replace it with the one at</span>
01182         <span class="comment">// the end of the array and reduce the size of the array by one.</span>
01183         <span class="comment">//</span>
01184 
01185         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a29">SepSidInSidAndAttributes</a>(
01186                 GroupsToDisable,
01187                 GroupCount,
01188                 NULL,           <span class="comment">// no principal self sid</span>
01189                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[Index].Sid
01190                 )){
01191 
01192             (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Attributes &amp;= ~(SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT);
01193             (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Attributes |= SE_GROUP_USE_FOR_DENY_ONLY;
01194 
01195             <span class="comment">//</span>
01196             <span class="comment">// If this was the owner, reset the owner to be the user</span>
01197             <span class="comment">//</span>
01198 
01199             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex) {
01200                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex = 0;
01201             }
01202 
01203             <span class="comment">//</span>
01204             <span class="comment">// If this is the admins sid, turn off the admin group flag</span>
01205             <span class="comment">//</span>
01206 
01207             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(
01208                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[Index].Sid,
01209                     SeAliasAdminsSid
01210                     )) {
01211 
01212                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags &amp;= ~<a class="code" href="../../d0/d5/se_8h.html#a4">TOKEN_HAS_ADMIN_GROUP</a>;
01213             }
01214         }
01215 
01216         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01217 
01218 
01219     } <span class="comment">// endwhile</span>
01220 
01221 
01222     <span class="keywordflow">return</span>;
01223 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="tokendup.c::SepSidInSidAndAttributes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepSidInSidAndAttributes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSID_AND_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>SidAndAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SidCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrincipalSelfSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00933">933</a> of file <a class="el" href="../../d7/d2/tokendup_8c-source.html">tokendup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01615">SePrincipalSelfSid</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">SepFilterToken()</a>, and <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01041">SepRemoveDisabledGroupsAndPrivileges()</a>.
<p>
<pre class="fragment"><div>00942                    :
00943 
00944     Checks to see <span class="keywordflow">if</span> a given SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given token.
00945 
00946     N.B. The code to compute <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of a SID and test <span class="keywordflow">for</span> equality
00947          <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> duplicated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security runtime since <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> such a
00948          frequently used routine.
00949 
00950 Arguments:
00951 
00952     SidAndAttributes - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sid and attributes to be examined
00953 
00954     PrincipalSelfSid - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being access checked <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an object which
00955         represents a principal (e.g., a user object), <span class="keyword">this</span> parameter should
00956         be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  Any ACE containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> constant
00957         PRINCIPAL_SELF_SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> replaced by <span class="keyword">this</span> SID.
00958 
00959         The parameter should be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object does not represent a principal.
00960 
00961 
00962     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of interest
00963 
00964 Return Value:
00965 
00966     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00967     otherwise.
00968 
00969 --*/
00970 
00971 {
00972 
00973     ULONG i;
00974     PISID MatchSid;
00975     ULONG SidLength;
00976     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00977     PSID_AND_ATTRIBUTES TokenSid;
00978     ULONG UserAndGroupCount;
00979 
00980     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00981 
00982 
00983     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( SidAndAttributes ) ) {
00984         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00985     }
00986 
00987     <span class="comment">//</span>
00988     <span class="comment">// If Sid is the constant PrincipalSelfSid,</span>
00989     <span class="comment">//  replace it with the passed in PrincipalSelfSid.</span>
00990     <span class="comment">//</span>
00991 
00992     <span class="keywordflow">if</span> ( PrincipalSelfSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00993          <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SePrincipalSelfSid, Sid ) ) {
00994         Sid = PrincipalSelfSid;
00995     }
00996 
00997     <span class="comment">//</span>
00998     <span class="comment">// Get the length of the source SID since this only needs to be computed</span>
00999     <span class="comment">// once.</span>
01000     <span class="comment">//</span>
01001 
01002     SidLength = 8 + (4 * ((PISID)Sid)-&gt;SubAuthorityCount);
01003 
01004     <span class="comment">//</span>
01005     <span class="comment">// Get address of user/group array and number of user/groups.</span>
01006     <span class="comment">//</span>
01007 
01008     TokenSid = SidAndAttributes;
01009     UserAndGroupCount = SidCount;
01010 
01011     <span class="comment">//</span>
01012     <span class="comment">// Scan through the user/groups and attempt to find a match with the</span>
01013     <span class="comment">// specified SID.</span>
01014     <span class="comment">//</span>
01015 
01016     <span class="keywordflow">for</span> (i = 0 ; i &lt; UserAndGroupCount ; i += 1) {
01017         MatchSid = (PISID)TokenSid-&gt;Sid;
01018 
01019         <span class="comment">//</span>
01020         <span class="comment">// If the SID revision and length matches, then compare the SIDs</span>
01021         <span class="comment">// for equality.</span>
01022         <span class="comment">//</span>
01023 
01024         <span class="keywordflow">if</span> ((((PISID)Sid)-&gt;Revision == MatchSid-&gt;Revision) &amp;&amp;
01025             (SidLength == (8 + (4 * (ULONG)MatchSid-&gt;SubAuthorityCount)))) {
01026             <span class="keywordflow">if</span> (RtlEqualMemory(Sid, MatchSid, SidLength)) {
01027 
01028                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01029 
01030             }
01031         }
01032 
01033         TokenSid += 1;
01034     }
01035 
01036     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01037 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:47 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
