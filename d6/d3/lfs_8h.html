<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lfs.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lfs.h File Reference</h1>
<p>
<a href="../../d7/d2/lfs_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html">_MULTI_SECTOR_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">_LFS_WRITE_DATA</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">_LFS_WRITE_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">_LOG_FILE_INFORMATION</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a0">SEQUENCE_NUMBER_STRIDE</a>&nbsp;&nbsp;&nbsp;(512)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a1">LFS_DEFAULT_LOG_PAGE_SIZE</a>&nbsp;&nbsp;&nbsp;(0x1000)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a2">UPDATE_SEQUENCE_NUMBER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a3">PUPDATE_SEQUENCE_NUMBER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html">_MULTI_SECTOR_HEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a4">MULTI_SECTOR_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html">_MULTI_SECTOR_HEADER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a5">PMULTI_SECTOR_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d3/lfs_8h.html#a2">UPDATE_SEQUENCE_NUMBER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a6">UPDATE_SEQUENCE_ARRAY</a> [1]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d3/lfs_8h.html#a6">UPDATE_SEQUENCE_ARRAY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a7">PUPDATE_SEQUENCE_ARRAY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">_LFS_WRITE_DATA</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a8">LFS_WRITE_DATA</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">_LFS_WRITE_DATA</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a9">PLFS_WRITE_DATA</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef LARGE_INTEGER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef LARGE_INTEGER *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a62">_LFS_RECORD_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a13">LFS_RECORD_TYPE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a62">_LFS_RECORD_TYPE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a14">PLFS_RECORD_TYPE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a63">_LFS_CONTEXT_MODE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a15">LFS_CONTEXT_MODE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a63">_LFS_CONTEXT_MODE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a16">PLFS_CONTEXT_MODE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef ULONG *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a18">PTRANSACTION_ID</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a64">_TRANSACTION_STATE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a19">TRANSACTION_STATE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a64">_TRANSACTION_STATE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a20">PTRANSACTION_STATE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a65">_LFS_INFO</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a21">LFS_INFO</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a65">_LFS_INFO</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a22">PLFS_INFO</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef PVOID *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a24">PLFS_LOG_HANDLE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a25">LFS_LOG_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef PVOID *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a26">PLFS_LOG_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">_LFS_WRITE_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a27">LFS_WRITE_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">_LFS_WRITE_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a28">PLFS_WRITE_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">_LOG_FILE_INFORMATION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a29">LOG_FILE_INFORMATION</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">_LOG_FILE_INFORMATION</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a30">PLOG_FILE_INFORMATION</a></td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a62">_LFS_RECORD_TYPE</a> { <a class="el" href="../../d6/d3/lfs_8h.html#a62a31">LfsClientRecord</a> =  1, 
<a class="el" href="../../d6/d3/lfs_8h.html#a62a32">LfsClientRestart</a>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a63">_LFS_CONTEXT_MODE</a> { <a class="el" href="../../d6/d3/lfs_8h.html#a63a33">LfsContextUndoNext</a> =  1, 
<a class="el" href="../../d6/d3/lfs_8h.html#a63a34">LfsContextPrevious</a>, 
<a class="el" href="../../d6/d3/lfs_8h.html#a63a35">LfsContextForward</a>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a64">_TRANSACTION_STATE</a> { <a class="el" href="../../d6/d3/lfs_8h.html#a64a36">TransactionUninitialized</a> =  0, 
<a class="el" href="../../d6/d3/lfs_8h.html#a64a37">TransactionActive</a>, 
<a class="el" href="../../d6/d3/lfs_8h.html#a64a38">TransactionPrepared</a>, 
<a class="el" href="../../d6/d3/lfs_8h.html#a64a39">TransactionCommitted</a>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a65">_LFS_INFO</a> { <a class="el" href="../../d6/d3/lfs_8h.html#a65a40">LfsUseUsa</a> =  1, 
<a class="el" href="../../d6/d3/lfs_8h.html#a65a41">LfsPackLog</a>, 
<a class="el" href="../../d6/d3/lfs_8h.html#a65a42">LfsFixedPageSize</a>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a43">LfsInitializeLogFileService</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a44">LfsInitializeLogFile</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> LogFile, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> MaximumClients, IN ULONG LogPageSize OPTIONAL, IN LONGLONG FileSize, OUT <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">PLFS_WRITE_DATA</a> WriteData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a45">LfsOpenLogFile</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> LogFile, IN UNICODE_STRING ClientName, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> MaximumClients, IN ULONG LogPageSize OPTIONAL, IN LONGLONG FileSize, IN OUT <a class="el" href="../../d6/d3/lfs_8h.html#a22">PLFS_INFO</a> LfsInfo, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a24">PLFS_LOG_HANDLE</a> LogHandle, OUT <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">PLFS_WRITE_DATA</a> WriteData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a46">LfsCloseLogFile</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a47">LfsDeleteLogHandle</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a48">LfsReadLogFileInformation</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN <a class="el" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">PLOG_FILE_INFORMATION</a> <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN OUT PULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a49">LfsVerifyLogFile</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN PVOID LogFileHeader, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a50">LfsReadRestartArea</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN OUT PULONG BufferLength, IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> Lsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a51">LfsWriteRestartArea</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN ULONG BufferLength, IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> Lsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a52">LfsSetBaseLsn</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> BaseLsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a53">LfsResetUndoTotal</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN ULONG NumberRecords, IN LONG ResetTotal)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a54">LfsWrite</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN ULONG NumberOfWriteEntries, IN <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a> WriteEntries, IN <a class="el" href="../../d6/d3/lfs_8h.html#a13">LFS_RECORD_TYPE</a> RecordType, IN <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *TransactionId OPTIONAL, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> UndoNextLsn, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> PreviousLsn, IN LONG UndoRequirement, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> Lsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a55">LfsForceWrite</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN ULONG NumberOfWriteEntries, IN <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a> WriteEntries, IN <a class="el" href="../../d6/d3/lfs_8h.html#a13">LFS_RECORD_TYPE</a> RecordType, IN <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *TransactionId OPTIONAL, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> UndoNextLsn, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> PreviousLsn, IN LONG UndoRequirement, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> Lsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a56">LfsFlushToLsn</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> Lsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a57">LfsCheckWriteRange</a> (IN <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">PLFS_WRITE_DATA</a> WriteData, IN OUT PLONGLONG FlushOffset, IN OUT PULONG FlushLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a58">LfsReadLogRecord</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> FirstLsn, IN <a class="el" href="../../d6/d3/lfs_8h.html#a15">LFS_CONTEXT_MODE</a> ContextMode, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a26">PLFS_LOG_CONTEXT</a> Context, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a14">PLFS_RECORD_TYPE</a> RecordType, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *TransactionId, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> UndoNextLsn, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> PreviousLsn, OUT PULONG BufferLength, OUT PVOID *<a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a59">LfsReadNextLogRecord</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN OUT <a class="el" href="../../d6/d3/lfs_8h.html#a25">LFS_LOG_CONTEXT</a> Context, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a14">PLFS_RECORD_TYPE</a> RecordType, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *TransactionId, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> UndoNextLsn, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> PreviousLsn, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> Lsn, OUT PULONG BufferLength, OUT PVOID *<a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a60">LfsTerminateLogQuery</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN <a class="el" href="../../d6/d3/lfs_8h.html#a25">LFS_LOG_CONTEXT</a> Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a61">LfsQueryLastLsn</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/lfs_8h.html#a12">LfsZeroLsn</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="lfs.h::LFS_DEFAULT_LOG_PAGE_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LFS_DEFAULT_LOG_PAGE_SIZE&nbsp;&nbsp;&nbsp;(0x1000)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00153">153</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02246">LfsNormalizeBasicLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="lfs.h::SEQUENCE_NUMBER_STRIDE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SEQUENCE_NUMBER_STRIDE&nbsp;&nbsp;&nbsp;(512)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00073">73</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01711">LfsIsRestartPageHeaderValid()</a>, and <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01402">LfsReadRestart()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a15" doxytag="lfs.h::LFS_CONTEXT_MODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a63">_LFS_CONTEXT_MODE</a>  <a class="el" href="../../d6/d3/lfs_8h.html#a15">LFS_CONTEXT_MODE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="lfs.h::LFS_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a65">_LFS_INFO</a>  <a class="el" href="../../d6/d3/lfs_8h.html#a21">LFS_INFO</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="lfs.h::LFS_LOG_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef PVOID <a class="el" href="../../d6/d3/lfs_8h.html#a25">LFS_LOG_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00199">199</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="lfs.h::LFS_LOG_HANDLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef PVOID <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00197">197</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="lfs.h::LFS_RECORD_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a62">_LFS_RECORD_TYPE</a>  <a class="el" href="../../d6/d3/lfs_8h.html#a13">LFS_RECORD_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="lfs.h::LFS_WRITE_DATA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">_LFS_WRITE_DATA</a>  <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">LFS_WRITE_DATA</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="lfs.h::LFS_WRITE_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">_LFS_WRITE_ENTRY</a>  <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">LFS_WRITE_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="lfs.h::LOG_FILE_INFORMATION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">_LOG_FILE_INFORMATION</a>  <a class="el" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">LOG_FILE_INFORMATION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="lfs.h::LSN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef LARGE_INTEGER <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00140">140</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04188">LfsCheckSubsequentLogPage()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l01004">LfsFindClientNextLsn()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03193">LfsFindLastLsn()</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00037">LfsFlushLbcb()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">LfsFlushLfcb()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01885">LfsIsRestartAreaValid()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00701">LfsQueryLastLsn()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l01116">LfsSearchForwardByClient()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02514">LfsUpdateLfcbFromNoRestart()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>, and <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">LfsWriteLogRecordIntoLogPage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="lfs.h::MULTI_SECTOR_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html">_MULTI_SECTOR_HEADER</a>  <a class="el" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html">MULTI_SECTOR_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="lfs.h::PLFS_CONTEXT_MODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a63">_LFS_CONTEXT_MODE</a> * <a class="el" href="../../d6/d3/lfs_8h.html#a16">PLFS_CONTEXT_MODE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="lfs.h::PLFS_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a65">_LFS_INFO</a> * <a class="el" href="../../d6/d3/lfs_8h.html#a22">PLFS_INFO</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="lfs.h::PLFS_LOG_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef PVOID * <a class="el" href="../../d6/d3/lfs_8h.html#a26">PLFS_LOG_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00199">199</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="lfs.h::PLFS_LOG_HANDLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef PVOID * <a class="el" href="../../d6/d3/lfs_8h.html#a24">PLFS_LOG_HANDLE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00197">197</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="lfs.h::PLFS_RECORD_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a62">_LFS_RECORD_TYPE</a> * <a class="el" href="../../d6/d3/lfs_8h.html#a14">PLFS_RECORD_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="lfs.h::PLFS_WRITE_DATA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">_LFS_WRITE_DATA</a> * <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">PLFS_WRITE_DATA</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="lfs.h::PLFS_WRITE_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">_LFS_WRITE_ENTRY</a> * <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00039">LfsWrite()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="lfs.h::PLOG_FILE_INFORMATION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">_LOG_FILE_INFORMATION</a> * <a class="el" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">PLOG_FILE_INFORMATION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="lfs.h::PLSN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef LARGE_INTEGER * <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00140">140</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00037">LfsFlushLbcb()</a>, and <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01402">LfsReadRestart()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="lfs.h::PMULTI_SECTOR_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html">_MULTI_SECTOR_HEADER</a> * <a class="el" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html">PMULTI_SECTOR_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="lfs.h::PTRANSACTION_ID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef ULONG * <a class="el" href="../../d6/d3/lfs_8h.html#a18">PTRANSACTION_ID</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00178">178</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="lfs.h::PTRANSACTION_STATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a64">_TRANSACTION_STATE</a> * <a class="el" href="../../d6/d3/lfs_8h.html#a20">PTRANSACTION_STATE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="lfs.h::PUPDATE_SEQUENCE_ARRAY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d6/d3/lfs_8h.html#a6">UPDATE_SEQUENCE_ARRAY</a>* <a class="el" href="../../d6/d3/lfs_8h.html#a7">PUPDATE_SEQUENCE_ARRAY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00117">117</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="lfs.h::PUPDATE_SEQUENCE_NUMBER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> * <a class="el" href="../../d6/d3/lfs_8h.html#a3">PUPDATE_SEQUENCE_NUMBER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00075">75</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="lfs.h::TRANSACTION_ID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef ULONG <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00178">178</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="lfs.h::TRANSACTION_STATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d6/d3/lfs_8h.html#a64">_TRANSACTION_STATE</a>  <a class="el" href="../../d6/d3/lfs_8h.html#a19">TRANSACTION_STATE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="lfs.h::UPDATE_SEQUENCE_ARRAY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d6/d3/lfs_8h.html#a2">UPDATE_SEQUENCE_NUMBER</a> <a class="el" href="../../d6/d3/lfs_8h.html#a6">UPDATE_SEQUENCE_ARRAY</a>[1]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00115">115</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="lfs.h::UPDATE_SEQUENCE_NUMBER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> <a class="el" href="../../d6/d3/lfs_8h.html#a2">UPDATE_SEQUENCE_NUMBER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00075">75</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01711">LfsIsRestartPageHeaderValid()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02514">LfsUpdateLfcbFromNoRestart()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>.    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a63" doxytag="lfs.h::_LFS_CONTEXT_MODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d6/d3/lfs_8h.html#a63">_LFS_CONTEXT_MODE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a63a33" doxytag="LfsContextUndoNext" ></a>LfsContextUndoNext</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a63a34" doxytag="LfsContextPrevious" ></a>LfsContextPrevious</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a63a35" doxytag="LfsContextForward" ></a>LfsContextForward</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00170">170</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.
<p>
<pre class="fragment"><div>00170                                {
00171 
00172     <a class="code" href="../../d6/d3/lfs_8h.html#a63a33">LfsContextUndoNext</a> = 1,
00173     <a class="code" href="../../d6/d3/lfs_8h.html#a63a34">LfsContextPrevious</a>,
00174     <a class="code" href="../../d6/d3/lfs_8h.html#a63a35">LfsContextForward</a>
00175 
00176 } <a class="code" href="../../d6/d3/lfs_8h.html#a15">LFS_CONTEXT_MODE</a>, *<a class="code" href="../../d6/d3/lfs_8h.html#a16">PLFS_CONTEXT_MODE</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="lfs.h::_LFS_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d6/d3/lfs_8h.html#a65">_LFS_INFO</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a65a40" doxytag="LfsUseUsa" ></a>LfsUseUsa</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a65a41" doxytag="LfsPackLog" ></a>LfsPackLog</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a65a42" doxytag="LfsFixedPageSize" ></a>LfsFixedPageSize</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00189">189</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.
<p>
<pre class="fragment"><div>00189                        {
00190 
00191     <a class="code" href="../../d6/d3/lfs_8h.html#a65a40">LfsUseUsa</a> = 1,
00192     <a class="code" href="../../d6/d3/lfs_8h.html#a65a41">LfsPackLog</a>,
00193     <a class="code" href="../../d6/d3/lfs_8h.html#a65a42">LfsFixedPageSize</a>
00194 
00195 } <a class="code" href="../../d6/d3/lfs_8h.html#a21">LFS_INFO</a>, *<a class="code" href="../../d6/d3/lfs_8h.html#a22">PLFS_INFO</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="lfs.h::_LFS_RECORD_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d6/d3/lfs_8h.html#a62">_LFS_RECORD_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a62a31" doxytag="LfsClientRecord" ></a>LfsClientRecord</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a62a32" doxytag="LfsClientRestart" ></a>LfsClientRestart</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00159">159</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.
<p>
<pre class="fragment"><div>00159                               {
00160 
00161     <a class="code" href="../../d6/d3/lfs_8h.html#a62a31">LfsClientRecord</a> = 1,
00162     <a class="code" href="../../d6/d3/lfs_8h.html#a62a32">LfsClientRestart</a>
00163 
00164 } <a class="code" href="../../d6/d3/lfs_8h.html#a13">LFS_RECORD_TYPE</a>, *<a class="code" href="../../d6/d3/lfs_8h.html#a14">PLFS_RECORD_TYPE</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="lfs.h::_TRANSACTION_STATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d6/d3/lfs_8h.html#a64">_TRANSACTION_STATE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a64a36" doxytag="TransactionUninitialized" ></a>TransactionUninitialized</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a64a37" doxytag="TransactionActive" ></a>TransactionActive</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a64a38" doxytag="TransactionPrepared" ></a>TransactionPrepared</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a64a39" doxytag="TransactionCommitted" ></a>TransactionCommitted</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00180">180</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.
<p>
<pre class="fragment"><div>00180                                 {
00181 
00182     <a class="code" href="../../d6/d3/lfs_8h.html#a64a36">TransactionUninitialized</a> = 0,
00183     <a class="code" href="../../d6/d3/lfs_8h.html#a64a37">TransactionActive</a>,
00184     <a class="code" href="../../d6/d3/lfs_8h.html#a64a38">TransactionPrepared</a>,
00185     <a class="code" href="../../d6/d3/lfs_8h.html#a64a39">TransactionCommitted</a>
00186 
00187 } <a class="code" href="../../d6/d3/lfs_8h.html#a19">TRANSACTION_STATE</a>, *<a class="code" href="../../d6/d3/lfs_8h.html#a20">PTRANSACTION_STATE</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a57" doxytag="lfs.h::LfsCheckWriteRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsCheckWriteRange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">PLFS_WRITE_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FlushOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FlushLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00477">477</a> of file <a class="el" href="../../d2/d9/lfs_2write_8c-source.html">lfs/write.c</a>.
<p>
References <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00203">_LBCB::FileOffset</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00341">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00228">_LBCB::PageHeader</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00591">_LFCB::PageToDirty</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00341">_LFCB::SystemPageSize</a>.
<p>
<pre class="fragment"><div>00485                    :
00486 
00487     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called Ntfs to Lfs when a flush occurs.  This will give Lfs a chance
00488     to trim <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> amount of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flush.  Lfs can then use a 4K log record page size
00489     <span class="keywordflow">for</span> all systems (Intel and Alpha).
00490 
00491     This routine will trim <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO request to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00492     Lfcb <span class="keywordflow">for</span> <span class="keyword">this</span> volume.  We will also redirty <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second half of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <span class="keywordflow">if</span>
00493     we have begun writing log records into <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00494 
00495 Arguments:
00496 
00497     WriteData - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's data structure which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> maintained
00498         by Lfs to describe <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current writes.
00499 
00500     FlushOffset - On input <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flush passed to Ntfs from MM.
00501         On output <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual range to flush.
00502 
00503     FlushLength - On input <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flush from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given FlushOffset.
00504         On output <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flush from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> possibly modified FlushOffset.
00505 
00506 Return Value:
00507 
00508     None
00509 
00510 --*/
00511 
00512 {
00513     PLIST_ENTRY Links;
00514     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00515     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> NextLfcb;
00516     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00517 
00518     <span class="comment">//</span>
00519     <span class="comment">//  Find the correct Lfcb for this request.</span>
00520     <span class="comment">//</span>
00521 
00522     Lfcb = WriteData-&gt;Lfcb;
00523 
00524     <span class="comment">//</span>
00525     <span class="comment">//  Trim the write if not a system page size.</span>
00526     <span class="comment">//</span>
00527 
00528     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> != Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o6">SystemPageSize</a>) {
00529 
00530         <span class="comment">//</span>
00531         <span class="comment">//  Check if we are trimming before the write.</span>
00532         <span class="comment">//</span>
00533 
00534         <span class="keywordflow">if</span> (*FlushOffset &lt; WriteData-&gt;FileOffset) {
00535 
00536             *FlushLength -= (ULONG) (WriteData-&gt;FileOffset - *FlushOffset);
00537             *FlushOffset = WriteData-&gt;FileOffset;
00538         }
00539 
00540         <span class="comment">//</span>
00541         <span class="comment">//  Check that we aren't flushing too much.</span>
00542         <span class="comment">//</span>
00543 
00544         <span class="keywordflow">if</span> (*FlushOffset + *FlushLength &gt; WriteData-&gt;FileOffset + WriteData-&gt;Length) {
00545 
00546             *FlushLength = (ULONG) (WriteData-&gt;FileOffset + WriteData-&gt;Length - *FlushOffset);
00547         }
00548 
00549         <span class="comment">//</span>
00550         <span class="comment">//  Finally check if we have to redirty a page.</span>
00551         <span class="comment">//</span>
00552 
00553         <span class="keywordflow">if</span> ((Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o63">PageToDirty</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00554             (*FlushLength + *FlushOffset == Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o63">PageToDirty</a>-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a>)) {
00555 
00556             *((PULONG) (Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o63">PageToDirty</a>-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>)) = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a14">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>;
00557         }
00558     }
00559 
00560     <span class="keywordflow">return</span>;
00561 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="lfs.h::LfsCloseLogFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsCloseLogFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LogHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">706</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00196">_LBCB::ActiveLinks</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01142">CcUnpinDataForThread()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00436">_LFCB::ClientArray</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00163">_LCH::ClientArrayByteOffset</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00443">_LFS_RESTART_AREA::ClientFreeList</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00149">_LCH::ClientId</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00057">_LFS_CLIENT_ID::ClientIndex</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00444">_LFS_RESTART_AREA::ClientInUseList</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00373">_LFS_CLIENT_RECORD::ClientRestartLsn</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00099">_LFCB_SYNC::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00548">_LFCB::Flags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00285">LBCB_NOT_EMPTY</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00284">LBCB_ON_ACTIVE_QUEUE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00415">_LFCB::LbcbActive</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00273">_LBCB::LbcbFlags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00414">_LFCB::LbcbWorkque</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00136">_LCH::LchLinks</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00606">LFCB_FINAL_SHUTDOWN</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00315">_LFCB::LfcbLinks</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00355">LFS_NO_CLIENT</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00509">LfsAcquireLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00484">LfsAcquireLfsData</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04463">LfsAddClientToList()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00402">LfsDeallocateLbcb()</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00188">LfsDeallocateLfcb()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00426">_LFCB::LfsIoState</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00445">LfsLbcbIsRestart</a>, <a class="el" href="../../d1/d4/lfsstruc_8h.html#a40a38">LfsNoIoInProgress</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00487">LfsReleaseLfsData</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04383">LfsRemoveClientFromList()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00147">LfsZeroLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00235">_LBCB::LogPageBcb</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00279">_LBCB::ResourceThread</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00435">_LFCB::RestartArea</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00444">_LFCB::RestartAreaSize</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00389">_LFS_CLIENT_RECORD::SeqNumber</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00570">_LFCB::Sync</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00576">_LFCB::Waiters</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00195">_LBCB::WorkqueLinks</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>.
<p>
<pre class="fragment"><div>00712                    :
00713 
00714     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a client detaches itself from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log
00715     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  On <span class="keywordflow">return</span>, all prior references to <span class="keyword">this</span> client in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log
00716     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> are inaccessible.
00717 
00718 Arguments:
00719 
00720     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00721                 client.
00722 
00723 Return Value:
00724 
00725     None
00726 
00727 --*/
00728 
00729 {
00730     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00731 
00732     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00733 
00734     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00735 
00736     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ClientIndex;
00737     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
00738 
00739     BOOLEAN FlushRestart;
00740     BOOLEAN ExitLoop;
00741 
00742     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00743 
00744     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsCloseLogFile:  Entered\n"</span>, 0 );
00745     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"LogHandle  -&gt;  %08lx\n"</span>, LogHandle );
00746 
00747     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00748 
00749     <span class="comment">//</span>
00750     <span class="comment">//  Enclose this in a loop.  We will loop as long as there are waiters or there is an IO</span>
00751     <span class="comment">//  in progress.</span>
00752     <span class="comment">//</span>
00753 
00754     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00755 
00756         <span class="comment">//</span>
00757         <span class="comment">//  Always assume we exit the loop.</span>
00758         <span class="comment">//</span>
00759 
00760         ExitLoop = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00761 
00762         <span class="comment">//</span>
00763         <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00764         <span class="comment">//</span>
00765 
00766         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00767 
00768         <span class="comment">//</span>
00769         <span class="comment">//  Protect this entry point with a try-except.</span>
00770         <span class="comment">//</span>
00771 
00772         <span class="keywordflow">try</span> {
00773 
00774             <span class="comment">//</span>
00775             <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00776             <span class="comment">//</span>
00777 
00778             <span class="comment">//</span>
00779             <span class="comment">//  Acquire the global data block and the log file control block.</span>
00780             <span class="comment">//</span>
00781 
00782             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a21">LfsAcquireLfsData</a>();
00783 
00784             <span class="keywordflow">try</span> {
00785 
00786                 <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> ThisLbcb;
00787 
00788                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00789 
00790                 Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00791 
00792                 <span class="comment">//</span>
00793                 <span class="comment">//  If the Log file has been closed then return immediately.</span>
00794                 <span class="comment">//</span>
00795 
00796                 <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00797 
00798                     <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00799                 }
00800 
00801                 <span class="comment">//</span>
00802                 <span class="comment">//  Check that there are no waiters or IO in progress before proceeding.</span>
00803                 <span class="comment">//</span>
00804 
00805                 <span class="keywordflow">if</span> ((Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o60">Waiters</a> != 0) ||
00806                     (Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o29">LfsIoState</a> != <a class="code" href="../../d1/d4/lfsstruc_8h.html#a40a38">LfsNoIoInProgress</a>)) {
00807 
00808                     ExitLoop = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00809                     Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o60">Waiters</a> += 1;
00810                     <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00811                 }
00812 
00813                 <span class="comment">//</span>
00814                 <span class="comment">//  Check that the client Id is valid.</span>
00815                 <span class="comment">//</span>
00816 
00817                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00818 
00819                 ClientRecord = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00820                                         Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o6">ClientArrayByteOffset</a>,
00821                                         <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00822 
00823 <span class="preprocessor">#if 1</span>
00824 <span class="preprocessor"></span>                <span class="comment">//</span>
00825                 <span class="comment">//  Increment the client sequence number in the restart area.</span>
00826                 <span class="comment">//  This will prevent anyone else from accessing this client block.</span>
00827                 <span class="comment">//</span>
00828 
00829                 ClientIndex = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o4">ClientId</a>.<a class="code" href="../../d3/d0/struct__LFS__CLIENT__ID.html#o1">ClientIndex</a>;
00830 
00831                 ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o4">SeqNumber</a>++;
00832 <span class="preprocessor">#endif</span>
00833 <span class="preprocessor"></span>
00834                 <span class="comment">//</span>
00835                 <span class="comment">//  Remember if this client wrote a restart area.</span>
00836                 <span class="comment">//</span>
00837 
00838                 FlushRestart = (BOOLEAN) ( <a class="code" href="../../d6/d3/lfs_8h.html#a12">LfsZeroLsn</a>.QuadPart != ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a>.QuadPart );
00839 
00840 <span class="preprocessor">#if 1</span>
00841 <span class="preprocessor"></span>                <span class="comment">//</span>
00842                 <span class="comment">//  Remove the client from the log file in use list.</span>
00843                 <span class="comment">//</span>
00844 
00845                 <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a21">LfsRemoveClientFromList</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00846                                          ClientRecord,
00847                                          &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a> );
00848 
00849                 <span class="comment">//</span>
00850                 <span class="comment">//  Add the client block to the log file free list</span>
00851                 <span class="comment">//</span>
00852 
00853                 <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a12">LfsAddClientToList</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00854                                     ClientIndex,
00855                                     &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o2">ClientFreeList</a> );
00856 
00857                 <span class="comment">//</span>
00858                 <span class="comment">//  If this is the last client then move the last active Lbcb off</span>
00859                 <span class="comment">//  the active queue.</span>
00860                 <span class="comment">//</span>
00861 
00862                 <span class="keywordflow">if</span> (Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a> == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
00863 <span class="preprocessor">#endif</span>
00864 <span class="preprocessor"></span>                    <span class="comment">//</span>
00865                     <span class="comment">//  Set the flag to indicate we are at the final close.</span>
00866                     <span class="comment">//</span>
00867 
00868                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o54">Flags</a>, LFCB_FINAL_SHUTDOWN );
00869 
00870                     <span class="comment">//</span>
00871                     <span class="comment">//  Walk through the active queue and remove any Lbcb's with</span>
00872                     <span class="comment">//  data from that queue.  That will allow them to get out to disk.</span>
00873                     <span class="comment">//</span>
00874 
00875                     <span class="keywordflow">while</span> (!IsListEmpty( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o26">LbcbActive</a> )) {
00876 
00877                         ThisLbcb = CONTAINING_RECORD( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o26">LbcbActive</a>.Flink,
00878                                                       <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00879                                                       ActiveLinks );
00880 
00881                         RemoveEntryList( &amp;ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o3">ActiveLinks</a> );
00882                         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_ON_ACTIVE_QUEUE );
00883 
00884                         <span class="comment">//</span>
00885                         <span class="comment">//  If this page has some new entries, allow it to</span>
00886                         <span class="comment">//  be flushed to disk.  Otherwise deallocate it.</span>
00887                         <span class="comment">//</span>
00888 
00889                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_NOT_EMPTY )) {
00890 
00891                             RemoveEntryList( &amp;ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o2">WorkqueLinks</a> );
00892 
00893                             <span class="keywordflow">if</span> (ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o9">LogPageBcb</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00894 
00895                                 <a class="code" href="../../d4/d2/cache_8h.html#a94">CcUnpinDataForThread</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o9">LogPageBcb</a>,
00896                                                       ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o14">ResourceThread</a> );
00897                             }
00898 
00899                             <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a>( Lfcb, ThisLbcb );
00900                         }
00901                     }
00902 
00903                     <span class="comment">//</span>
00904                     <span class="comment">//  It's possible that we have the two restart areas in the workque.</span>
00905                     <span class="comment">//  They can be removed and the memory deallocated if we have no</span>
00906                     <span class="comment">//  more clients.</span>
00907                     <span class="comment">//</span>
00908                     <span class="comment">//  We skip this action if the there is Io in progress or the user</span>
00909                     <span class="comment">//  had a restart area.</span>
00910                     <span class="comment">//</span>
00911 
00912                     <span class="keywordflow">if</span> ((Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o29">LfsIoState</a> == <a class="code" href="../../d1/d4/lfsstruc_8h.html#a40a38">LfsNoIoInProgress</a>) &amp;&amp; !FlushRestart) {
00913 
00914                         PLIST_ENTRY Links;
00915 
00916                         <span class="comment">//</span>
00917                         <span class="comment">//  Now walk through the workque list looking for a non-restart</span>
00918                         <span class="comment">//  entry.</span>
00919                         <span class="comment">//</span>
00920 
00921                         Links = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o25">LbcbWorkque</a>.Flink;
00922 
00923                         <span class="keywordflow">while</span> (Links != &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o25">LbcbWorkque</a>) {
00924 
00925                             ThisLbcb = CONTAINING_RECORD( Links,
00926                                                           <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00927                                                           WorkqueLinks );
00928 
00929                             <span class="comment">//</span>
00930                             <span class="comment">//  If this is not a restart area, we exit and remember that</span>
00931                             <span class="comment">//  we need to flush the restart areas.</span>
00932                             <span class="comment">//</span>
00933 
00934                             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d4/lfsprocs_8h.html#a20">LfsLbcbIsRestart</a>( ThisLbcb )) {
00935 
00936                                 FlushRestart = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00937                                 <span class="keywordflow">break</span>;
00938                             }
00939 
00940                             Links = Links-&gt;Flink;
00941                         }
00942 
00943                         <span class="comment">//</span>
00944                         <span class="comment">//  If we are still not to flush the restart areas remove</span>
00945                         <span class="comment">//  all of the restart areas from the queue.</span>
00946                         <span class="comment">//</span>
00947 
00948                         <span class="keywordflow">if</span> (!FlushRestart) {
00949 
00950                             <span class="keywordflow">while</span> (!IsListEmpty( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o25">LbcbWorkque</a>)) {
00951 
00952                                 ThisLbcb = CONTAINING_RECORD( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o25">LbcbWorkque</a>.Blink,
00953                                                               <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00954                                                               WorkqueLinks );
00955 
00956                                 RemoveEntryList( &amp;ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o2">WorkqueLinks</a> );
00957                                 <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a>( Lfcb, ThisLbcb );
00958                             }
00959                         }
00960 
00961                     } <span class="keywordflow">else</span> {
00962 
00963                         FlushRestart = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00964                     }
00965 
00966 <span class="preprocessor">#if 1</span>
00967 <span class="preprocessor"></span>                <span class="comment">//</span>
00968                 <span class="comment">//  We will have to flush the restart area in this case.</span>
00969                 <span class="comment">//</span>
00970 
00971                 } <span class="keywordflow">else</span> {
00972 
00973                     FlushRestart = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00974                 }
00975 <span class="preprocessor">#endif</span>
00976 <span class="preprocessor"></span>
00977                 <span class="comment">//</span>
00978                 <span class="comment">//  Flush the new restart area if we need to.</span>
00979                 <span class="comment">//</span>
00980 
00981                 <span class="keywordflow">if</span> (FlushRestart) {
00982 
00983                     <a class="code" href="../../d7/d0/rstrtsup_8c.html#a1">LfsWriteLfsRestart</a>( Lfcb, Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o34">RestartAreaSize</a>, FALSE );
00984                     <a class="code" href="../../d7/d0/rstrtsup_8c.html#a1">LfsWriteLfsRestart</a>( Lfcb, Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o34">RestartAreaSize</a>, TRUE );
00985                 }
00986 
00987                 <span class="comment">//</span>
00988                 <span class="comment">//  Clear the Lfcb pointer in the client handle.</span>
00989                 <span class="comment">//</span>
00990 
00991                 Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00992                 RemoveEntryList( &amp;Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o2">LchLinks</a> );
00993 
00994                 <span class="comment">//</span>
00995                 <span class="comment">//  If there are no active clients, we can remove this log file</span>
00996                 <span class="comment">//  control block from the active queue.</span>
00997                 <span class="comment">//</span>
00998 
00999 <span class="preprocessor">#if 1</span>
01000 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a> == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
01001 <span class="preprocessor">#endif</span>
01002 <span class="preprocessor"></span>
01003                     RemoveEntryList( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o2">LfcbLinks</a> );
01004                     <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a2">LfsDeallocateLfcb</a>( Lfcb, FALSE );
01005 <span class="preprocessor">#if 1</span>
01006 <span class="preprocessor"></span>                }
01007 <span class="preprocessor">#endif</span>
01008 <span class="preprocessor"></span>
01009             try_exit:  NOTHING;
01010             } finally {
01011 
01012                 <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsCloseLogFile );
01013 
01014                 <span class="comment">//</span>
01015                 <span class="comment">//   Release the log file control block if held.</span>
01016                 <span class="comment">//</span>
01017 
01018                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
01019 
01020                 <span class="comment">//</span>
01021                 <span class="comment">//  Release the global data block if held.</span>
01022                 <span class="comment">//</span>
01023 
01024                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a22">LfsReleaseLfsData</a>();
01025 
01026                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsCloseLogFile:  Exit\n"</span>, 0 );
01027             }
01028 
01029         } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
01030 
01031             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01032         }
01033 
01034         <span class="comment">//</span>
01035         <span class="comment">//  Test if we want to exit the loop now.</span>
01036         <span class="comment">//</span>
01037 
01038         <span class="keywordflow">if</span> (ExitLoop) { <span class="keywordflow">break</span>; }
01039 
01040         <span class="comment">//</span>
01041         <span class="comment">//  Wait for the io to complete.</span>
01042         <span class="comment">//</span>
01043 
01044         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o1">Event</a>,
01045                                Executive,
01046                                KernelMode,
01047                                FALSE,
01048                                NULL );
01049 
01050         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
01051         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o60">Waiters</a> -= 1;
01052         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
01053     }
01054 
01055     <span class="comment">//</span>
01056     <span class="comment">//  We always let this operation succeed.</span>
01057     <span class="comment">//</span>
01058 
01059     <span class="keywordflow">return</span>;
01060 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="lfs.h::LfsDeleteLogHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsDeleteLogHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LogHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01063">1063</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02478">ExDeleteResource</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00033">LFS_NTC_LCH</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00435">LfsDeallocateLch</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00129">_LCH::NodeTypeCode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00091">_LFCB_SYNC::Resource</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00170">_LCH::Sync</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00106">_LFCB_SYNC::UserCount</a>.
<p>
<pre class="fragment"><div>01069                    :
01070 
01071     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a client <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> tearing down <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last of
01072     his volume structures.  There will be no more references to <span class="keyword">this</span>
01073     handle.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last handle <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> then we will
01074     deallocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d9/d0/cmdata_8h.html#a104a98">Sync</a> structure as well.
01075 
01076 Arguments:
01077 
01078     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
01079                 client.
01080 
01081 Return Value:
01082 
01083     None
01084 
01085 --*/
01086 
01087 {
01088     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
01089 
01090     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01091 
01092     <span class="comment">//</span>
01093     <span class="comment">//  If the log handle is null then return immediately.</span>
01094     <span class="comment">//</span>
01095 
01096     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
01097 
01098     <span class="keywordflow">if</span> ((Lch == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01099         (Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o0">NodeTypeCode</a> != <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a2">LFS_NTC_LCH</a>)) {
01100 
01101         <span class="keywordflow">return</span>;
01102     }
01103 
01104     <span class="comment">//</span>
01105     <span class="comment">//  Ignore all errors from now on.</span>
01106     <span class="comment">//</span>
01107 
01108     <span class="keywordflow">try</span> {
01109 
01110         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
01111 
01112         Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o7">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o2">UserCount</a> -= 1;
01113 
01114         <span class="comment">//</span>
01115         <span class="comment">//  If we are the last user then deallocate the sync structure.</span>
01116         <span class="comment">//</span>
01117 
01118         <span class="keywordflow">if</span> (Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o7">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o2">UserCount</a> == 0) {
01119 
01120             <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>( &amp;Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o7">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o0">Resource</a> );
01121 
01122             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o7">Sync</a> );
01123 
01124         } <span class="keywordflow">else</span> {
01125 
01126             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
01127         }
01128 
01129         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a17">LfsDeallocateLch</a>( Lch );
01130 
01131     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
01132 
01133         NOTHING;
01134     }
01135 
01136     <span class="keywordflow">return</span>;
01137 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="lfs.h::LfsFlushToLsn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsFlushToLsn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00360">360</a> of file <a class="el" href="../../d2/d9/lfs_2write_8c-source.html">lfs/write.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00360">LfsFlushToLsn()</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00134">LfsFlushToLsnPriv()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00360">LfsFlushToLsn()</a>.
<p>
<pre class="fragment"><div>00367                    :
00368 
00369     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a client to insure that all log records
00370     to a certain point have been flushed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done by
00371     checking <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired Lsn has even been written at all.  If so we
00372     check <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> has been flushed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  If not, we simply write
00373     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current restart area to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk.
00374 
00375 Arguments:
00376 
00377     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00378                 client.
00379 
00380     Lsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn that must be on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk on <span class="keywordflow">return</span> from <span class="keyword">this</span>
00381           routine.
00382 
00383 Return Value:
00384 
00385     None
00386 
00387 --*/
00388 
00389 {
00390     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00391 
00392     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00393 
00394     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00395 
00396     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00397 
00398     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsFlushToLsn:  Entered\n"</span>, 0 );
00399     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle        -&gt; %08lx\n"</span>, LogHandle );
00400     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)         -&gt; %08lx\n"</span>, Lsn.LowPart );
00401     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (High)        -&gt; %08lx\n"</span>, Lsn.HighPart );
00402 
00403     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00404 
00405     <span class="comment">//</span>
00406     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00407     <span class="comment">//</span>
00408 
00409     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00410 
00411     <span class="comment">//</span>
00412     <span class="comment">//  Use a try-except to catch errors.</span>
00413     <span class="comment">//</span>
00414 
00415     <span class="keywordflow">try</span> {
00416 
00417         <span class="comment">//</span>
00418         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00419         <span class="comment">//</span>
00420 
00421         <span class="keywordflow">try</span> {
00422 
00423             <span class="comment">//</span>
00424             <span class="comment">//  Acquire the log file control block for this log file.</span>
00425             <span class="comment">//</span>
00426 
00427             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00428             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00429 
00430             <span class="comment">//</span>
00431             <span class="comment">//  If the log file has been closed we will assume the Lsn has been flushed.</span>
00432             <span class="comment">//</span>
00433 
00434             <span class="keywordflow">if</span> (Lfcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00435 
00436                 <span class="comment">//</span>
00437                 <span class="comment">//  Check that the client Id is valid.</span>
00438                 <span class="comment">//</span>
00439 
00440                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00441 
00442                 <span class="comment">//</span>
00443                 <span class="comment">//  Call our common routine to perform the work.</span>
00444                 <span class="comment">//</span>
00445 
00446                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a54">LfsFlushToLsnPriv</a>( Lfcb, Lsn );
00447             }
00448 
00449         } finally {
00450 
00451             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsFlushToLsn );
00452 
00453             <span class="comment">//</span>
00454             <span class="comment">//  Release the log file control block if held.</span>
00455             <span class="comment">//</span>
00456 
00457             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00458 
00459             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsFlushToLsn:  Exit\n"</span>, 0 );
00460         }
00461 
00462     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00463 
00464         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00465     }
00466 
00467     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00468 
00469         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00470     }
00471 
00472     <span class="keywordflow">return</span>;
00473 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="lfs.h::LfsForceWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LfsForceWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfWriteEntries</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteEntries</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a13">LFS_RECORD_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RecordType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *TransactionId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>UndoNextLsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousLsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UndoRequirement</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00197">LfsForceWrite()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="lfs.h::LfsInitializeLogFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsInitializeLogFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MaximumClients</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG LogPageSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">PLFS_WRITE_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">150</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d9/d4/logsup_8c-source.html#l00032">CcSetAdditionalCacheAttributes()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00436">_LFCB::ClientArray</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00437">_LFCB::ClientArrayOffset</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00328">_LFCB::FileObject</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00360">_LFCB::FirstLogPage</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00452">_LFCB::InitialRestartArea</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00636">_LFS_DATA::LfcbLinks</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00315">_LFCB::LfcbLinks</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00153">LFS_DEFAULT_LOG_PAGE_SIZE</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00509">LfsAcquireLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00484">LfsAcquireLfsData</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00041">LfsAllocateLfcb()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00438">LfsAllocateRestartArea</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00033">LfsData</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00188">LfsDeallocateLfcb()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00442">LfsDeallocateRestartArea</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03065">LfsInitializeLogFilePriv()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00039">LfsLi0</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02246">LfsNormalizeBasicLogFile()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00487">LfsReleaseLfsData</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00130">_LFS_WRITE_DATA::LfsStructureSize</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02514">LfsUpdateLfcbFromNoRestart()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02390">LfsUpdateLfcbFromPgHeader()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02964">LfsUpdateRestartAreaFromLfcb()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00435">_LFCB::RestartArea</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00386">_LFCB::RestartDataSize</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00589">_LFCB::UserWriteData</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>.
<p>
<pre class="fragment"><div>00160                    :
00161 
00162     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to initialize a log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to prepare <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">for</span> use
00163     by log clients.  Any previous data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> will be overwritten.
00164 
00165     Lfs will partition <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> into 2 Lfs restart areas and as many log
00166     pages as will fit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  The restart area size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined
00167     by computing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> amount of space needed <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum number
00168 
00169 Arguments:
00170 
00171     LogFile - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to be used as a log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00172 
00173     MaximumClients - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum number of clients that will be
00174                      active in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> at any one time.
00175 
00176     LogPageSize - If specified (not 0), <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> recommended size of
00177                   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log page.  Lfs will use <span class="keyword">this</span> as a guide in
00178                   determining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log page size.
00179 
00180     FileSize - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> available size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00181 
00182     WriteData - Pointer to WRITE_DATA in caller's data structure.
00183 
00184 Return Value:
00185 
00186     None
00187 
00188 --*/
00189 
00190 {
00191     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00192     LARGE_INTEGER CurrentTime;
00193 
00194     <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> RestartArea = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00195 
00196     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00197 
00198     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00199 
00200     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsInitializeLogFile:  Entered\n"</span>, 0 );
00201     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log File          -&gt; %08lx\n"</span>, LogFile );
00202     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Maximum Clients   -&gt; %04x\n"</span>, MaximumClients );
00203     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Page Size     -&gt; %08lx\n"</span>, LogPageSize );
00204     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"File Size (Low)   -&gt; %08lx\n"</span>, FileSize.LowPart );
00205     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"File Size (High)  -&gt; %08lx\n"</span>, FileSize.HighPart );
00206 
00207     Lfcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00208 
00209     <span class="comment">//</span>
00210     <span class="comment">//  Protect this entry point with a try-except.</span>
00211     <span class="comment">//</span>
00212 
00213     <span class="keywordflow">try</span> {
00214 
00215         <span class="comment">//</span>
00216         <span class="comment">//  We grab the global data exclusively.</span>
00217         <span class="comment">//</span>
00218 
00219         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a21">LfsAcquireLfsData</a>();
00220 
00221         <span class="comment">//</span>
00222         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00223         <span class="comment">//</span>
00224 
00225         <span class="keywordflow">try</span> {
00226 
00227             <span class="comment">//</span>
00228             <span class="comment">//  We allocate an Lfcb and point it to the log file.</span>
00229             <span class="comment">//</span>
00230 
00231             Lfcb = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a65">LfsAllocateLfcb</a>();
00232 
00233             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
00234 
00235             Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o4">FileObject</a> = LogFile;
00236 
00237             <span class="comment">//</span>
00238             <span class="comment">//  Call the Cache Manager to disable read ahead and write behind;</span>
00239             <span class="comment">//  we flush the log file explicitly.</span>
00240             <span class="comment">//</span>
00241 
00242             <a class="code" href="../../d4/d2/cache_8h.html#a95">CcSetAdditionalCacheAttributes</a>( LogFile, TRUE, TRUE );
00243 
00244             <span class="comment">//</span>
00245             <span class="comment">//  Normalize the values passed in with this call.</span>
00246             <span class="comment">//</span>
00247 
00248             <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a2">LfsNormalizeBasicLogFile</a>( &amp;FileSize,
00249                                       &amp;LogPageSize,
00250                                       &amp;MaximumClients,
00251                                       (BOOLEAN) ((PAGE_SIZE &gt;= LFS_DEFAULT_LOG_PAGE_SIZE) &amp;&amp;
00252                                                  (PAGE_SIZE &lt;= LFS_DEFAULT_LOG_PAGE_SIZE * 2)));
00253 
00254             <span class="comment">//</span>
00255             <span class="comment">//  We can go directly to version 1.1 since we can immediately pack</span>
00256             <span class="comment">//  the log file and use the default system log page size.</span>
00257             <span class="comment">//</span>
00258 
00259             <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a3">LfsUpdateLfcbFromPgHeader</a>( Lfcb,
00260                                        LogPageSize,
00261                                        LogPageSize,
00262                                        1,
00263                                        1,
00264                                        TRUE );
00265 
00266             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>( &amp;CurrentTime );
00267 
00268             <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a4">LfsUpdateLfcbFromNoRestart</a>( Lfcb,
00269                                         FileSize,
00270                                         LfsLi0,
00271                                         MaximumClients,
00272                                         CurrentTime.LowPart,
00273                                         FALSE,
00274                                         FALSE );
00275 
00276             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a18">LfsAllocateRestartArea</a>( &amp;RestartArea, Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o18">RestartDataSize</a> );
00277 
00278             <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a6">LfsUpdateRestartAreaFromLfcb</a>( Lfcb, RestartArea );
00279 
00280             Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a> = RestartArea;
00281             Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a> = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RestartArea, Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o32">ClientArrayOffset</a>, <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00282             RestartArea = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00283 
00284             Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o36">InitialRestartArea</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00285 
00286             <span class="comment">//</span>
00287             <span class="comment">//  Now update the caller's WRITE_DATA structure.</span>
00288             <span class="comment">//</span>
00289 
00290             Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o62">UserWriteData</a> = WriteData;
00291             WriteData-&gt;<a class="code" href="../../d5/d1/struct__LFS__WRITE__DATA.html#o2">LfsStructureSize</a> = LogPageSize;
00292             WriteData-&gt;Lfcb = Lfcb;
00293 
00294             <span class="comment">//</span>
00295             <span class="comment">//  Force two restart areas to disk and reinitialize the file.</span>
00296             <span class="comment">//</span>
00297 
00298             <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a7">LfsInitializeLogFilePriv</a>( Lfcb,
00299                                       TRUE,
00300                                       Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o18">RestartDataSize</a>,
00301                                       Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o13">FirstLogPage</a>,
00302                                       TRUE );
00303 
00304             <span class="comment">//</span>
00305             <span class="comment">//  Put the Lfcb into the global queue.</span>
00306             <span class="comment">//</span>
00307 
00308             InsertHeadList( &amp;<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o2">LfcbLinks</a>, &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o2">LfcbLinks</a> );
00309 
00310         } finally {
00311 
00312             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsInitializeLogFile );
00313 
00314             <span class="comment">//</span>
00315             <span class="comment">//  If the Lfcb has been acquired, we release it now.</span>
00316             <span class="comment">//</span>
00317 
00318             <span class="keywordflow">if</span> (Lfcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00319 
00320                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
00321 
00322                 <span class="comment">//</span>
00323                 <span class="comment">//  If an error occurred and we allocated an Lfcb.  We deallocate</span>
00324                 <span class="comment">//  it now.</span>
00325                 <span class="comment">//</span>
00326 
00327                 <span class="keywordflow">if</span> (AbnormalTermination()) {
00328 
00329                     <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a2">LfsDeallocateLfcb</a>( Lfcb, TRUE );
00330                 }
00331             }
00332 
00333             <span class="comment">//</span>
00334             <span class="comment">//  Deallocate the restart area.</span>
00335             <span class="comment">//</span>
00336 
00337             <span class="keywordflow">if</span> (RestartArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00338 
00339                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a19">LfsDeallocateRestartArea</a>( RestartArea );
00340             }
00341 
00342             <span class="comment">//</span>
00343             <span class="comment">//  We release the global data.</span>
00344             <span class="comment">//</span>
00345 
00346             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a22">LfsReleaseLfsData</a>();
00347 
00348             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsInitializeLogFile:  Exit\n"</span>, 0 );
00349         }
00350 
00351     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00352 
00353         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00354     }
00355 
00356     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00357 
00358         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00359     }
00360 
00361     <span class="keywordflow">return</span>;
00362 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="lfs.h::LfsInitializeLogFileService" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LfsInitializeLogFileService           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/sysinit_8c-source.html#l00040">40</a> of file <a class="el" href="../../d8/d7/sysinit_8c-source.html">sysinit.c</a>.
<p>
References <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00657">_LFS_DATA::Buffer1</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00658">_LFS_DATA::Buffer2</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00662">_LFS_DATA::BufferLock</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00663">_LFS_DATA::BufferNotification</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00642">_LFS_DATA::Flags</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00636">_LFS_DATA::LfcbLinks</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00673">LFS_BUFFER_SIZE</a>, <a class="el" href="../../d1/d4/lfsstruc_8h.html#a36">LFS_DATA</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00667">LFS_DATA_INIT_FAILED</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00668">LFS_DATA_INITIALIZED</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00036">LFS_NTC_DATA</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00046">LfsAllocatePoolNoRaise</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00033">LfsData</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00648">_LFS_DATA::LfsDataLock</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00048">LfsFreePool</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00035">LfsUsaSeqNumber</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00629">_LFS_DATA::NodeByteSize</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00628">_LFS_DATA::NodeTypeCode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00045                    :
00046 
00047     This routine must be called during system initialization before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00048     first call to logging service, to allow <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Log <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> Service to initialize
00049     its global data structures.  This routine has no dependencies on other
00050     system components being initialized.
00051 
00052     This routine will initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> global structures used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logging
00053     service and start <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfs worker thread.
00054 
00055 Arguments:
00056 
00057     None
00058 
00059 Return Value:
00060 
00061     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> initialization was successful
00062 
00063 --*/
00064 
00065 {
00066     LARGE_INTEGER CurrentTime;
00067 
00068     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00069 
00070     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsInitializeLogFileService:  Enter\n"</span>, 0 );
00071 
00072     <span class="comment">//</span>
00073     <span class="comment">//  If the structure has already been initialized then we can return</span>
00074     <span class="comment">//  immediately.</span>
00075     <span class="comment">//</span>
00076 
00077     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o0">NodeTypeCode</a> == <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a5">LFS_NTC_DATA</a>
00078         &amp;&amp; <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o1">NodeByteSize</a> == <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d0/struct__LFS__DATA.html">LFS_DATA</a> )
00079         &amp;&amp; <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o3">Flags</a>, LFS_DATA_INITIALIZED )) {
00080 
00081         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsInitializeLogFileService:  Exit  -&gt;  %01x\n"</span>, TRUE );
00082 
00083         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00084     }
00085 
00086     <span class="comment">//</span>
00087     <span class="comment">//  Zero out the structure initially.</span>
00088     <span class="comment">//</span>
00089 
00090     RtlZeroMemory( &amp;LfsData, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d0/struct__LFS__DATA.html">LFS_DATA</a> ));
00091 
00092     <span class="comment">//</span>
00093     <span class="comment">//  Assume the operation will fail.</span>
00094     <span class="comment">//</span>
00095 
00096     <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o3">Flags</a> = <a class="code" href="../../d1/d4/lfsstruc_8h.html#a19">LFS_DATA_INIT_FAILED</a>;
00097 
00098     <span class="comment">//</span>
00099     <span class="comment">//  Initialize the global structure for Lfs.</span>
00100     <span class="comment">//</span>
00101 
00102     <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o0">NodeTypeCode</a> = <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a5">LFS_NTC_DATA</a>;
00103     <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o1">NodeByteSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d0/struct__LFS__DATA.html">LFS_DATA</a> );
00104 
00105     InitializeListHead( &amp;<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o2">LfcbLinks</a> );
00106 
00107     <span class="comment">//</span>
00108     <span class="comment">//  Initialize the synchronization objects.</span>
00109     <span class="comment">//</span>
00110 
00111     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( &amp;<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o4">LfsDataLock</a> );
00112 
00113     <span class="comment">//</span>
00114     <span class="comment">//  Initialize the buffer allocation.  System will be robust enough to tolerate</span>
00115     <span class="comment">//  allocation failures.</span>
00116     <span class="comment">//</span>
00117 
00118     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( &amp;<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o9">BufferLock</a> );
00119     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o10">BufferNotification</a>, NotificationEvent, TRUE );
00120     <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o5">Buffer1</a> = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a2">LfsAllocatePoolNoRaise</a>( PagedPool, LFS_BUFFER_SIZE );
00121 
00122     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o5">Buffer1</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00123 
00124         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00125     }
00126 
00127     <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o6">Buffer2</a> = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a2">LfsAllocatePoolNoRaise</a>( PagedPool, LFS_BUFFER_SIZE );
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">//  Make sure we got both.</span>
00131     <span class="comment">//</span>
00132 
00133     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o6">Buffer2</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00134 
00135         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a4">LfsFreePool</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o5">Buffer1</a> );
00136         <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o5">Buffer1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00137         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00138     }
00139 
00140     <span class="comment">//</span>
00141     <span class="comment">//  Initialization has been successful.</span>
00142     <span class="comment">//</span>
00143 
00144     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o3">Flags</a>, LFS_DATA_INIT_FAILED );
00145     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o3">Flags</a>, LFS_DATA_INITIALIZED );
00146 
00147     <span class="comment">//</span>
00148     <span class="comment">//  Get a random number as a seed for the Usa sequence numbers.  Use the lower</span>
00149     <span class="comment">//  bits of the current time.</span>
00150     <span class="comment">//</span>
00151 
00152     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>( &amp;CurrentTime );
00153     <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a1">LfsUsaSeqNumber</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) CurrentTime.LowPart;
00154 
00155     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsInitializeLogFileService:  Exit  -&gt;  %01x\n"</span>, TRUE );
00156 
00157     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00158 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="lfs.h::LfsOpenLogFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG LfsOpenLogFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MaximumClients</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG LogPageSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d6/d3/lfs_8h.html#a22">PLFS_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LfsInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a24">PLFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">PLFS_WRITE_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">366</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d9/d4/logsup_8c-source.html#l00032">CcSetAdditionalCacheAttributes()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00436">_LFCB::ClientArray</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00163">_LCH::ClientArrayByteOffset</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00443">_LFS_RESTART_AREA::ClientFreeList</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00149">_LCH::ClientId</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00057">_LFS_CLIENT_ID::ClientIndex</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00444">_LFS_RESTART_AREA::ClientInUseList</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00411">_LFS_CLIENT_RECORD::ClientName</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00409">_LFS_CLIENT_RECORD::ClientNameLength</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00373">_LFS_CLIENT_RECORD::ClientRestartLsn</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00328">_LFCB::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00548">_LFCB::Flags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00321">_LFCB::LchLinks</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00136">_LCH::LchLinks</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00605">LFCB_LOG_FILE_CORRUPT</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00636">_LFS_DATA::LfcbLinks</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00315">_LFCB::LfcbLinks</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00356">LFS_CLIENT_NAME_MAX</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00197">LFS_LOG_HANDLE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00355">LFS_NO_CLIENT</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00484">LfsAcquireLfsData</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04463">LfsAddClientToList()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00428">LfsAllocateLch</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00033">LfsData</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00435">LfsDeallocateLch</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00188">LfsDeallocateLfcb()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00487">LfsReleaseLfsData</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04383">LfsRemoveClientFromList()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00147">LfsZeroLsn</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00382">_LFS_CLIENT_RECORD::NextClient</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00365">_LFS_CLIENT_RECORD::OldestLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00467">_LFCB::OldestLsn</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00238">PtrOffset</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00394">_LFCB::RecordHeaderLength</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00435">_LFCB::RestartArea</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00056">_LFS_CLIENT_ID::SeqNumber</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00389">_LFS_CLIENT_RECORD::SeqNumber</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00170">_LCH::Sync</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00570">_LFCB::Sync</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00106">_LFCB_SYNC::UserCount</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>.
<p>
<pre class="fragment"><div>00379                    :
00380 
00381     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a client wishes to <span class="keyword">register</span> with logging
00382     service.  This can be a reregistration (i.e. restart after a crash)
00383     or an initial registration.  There can be no other active clients
00384     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same name.  The Log <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> then used <span class="keywordflow">for</span> any
00385     subsequent access by <span class="keyword">this</span> client.
00386 
00387     If an Lfs restart has not been done on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will be done
00388     at <span class="keyword">this</span> time.
00389 
00390 Arguments:
00391 
00392     LogFile - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> previously initialized <span class="keywordflow">for</span> use
00393               as a log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00394 
00395     ClientName - This unicode string <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to uniquely identify clients
00396                  of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logging service.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordflow">case</span>-sensitive comparison <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00397                  used to check <span class="keyword">this</span> name against active clients of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00398                  log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00399 
00400     MaximumClients - The maximum number of clients <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> has
00401                      never been initialized.
00402 
00403     LogPageSize - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> recommeded size <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log page.
00404 
00405     FileSize - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00406 
00407     LfsInfo - On entry, indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> state <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user may
00408         know about.  On <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>, indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> state that Lfs
00409         knows about.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a conduit <span class="keywordflow">for</span> Lfs to communicate with its
00410         clients.
00411 
00412     LogHandle - The address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> identifier <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logging service
00413                 will use to identify <span class="keyword">this</span> client in all other Lfs calls.
00414 
00415     WriteData - Pointer to WRITE_DATA in caller's data structure.
00416 
00417 Return Value:
00418 
00419     ULONG - Amount to add to reservation value <span class="keywordflow">for</span> header <span class="keywordflow">for</span> log record.
00420 
00421 --*/
00422 
00423 {
00424     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00425 
00426     PLIST_ENTRY Link;
00427     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> ThisLfcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00428     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> NewLfcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00429 
00430     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ThisClient;
00431     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
00432 
00433     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00434 
00435     ULONG ReservedHeader;
00436 
00437     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00438 
00439     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsOpenLogFile:  Entered\n"</span>, 0 );
00440     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log File          -&gt; %08lx\n"</span>, LogFile );
00441     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Client Name       -&gt; %08lx\n"</span>, &amp;ClientName );
00442     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Maximum Clients   -&gt; %04x\n"</span>, MaximumClients );
00443     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Page Size     -&gt; %08lx\n"</span>, LogPageSize );
00444     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"File Size (Low)   -&gt; %08lx\n"</span>, FileSize.LowPart );
00445     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"File Size (High)  -&gt; %08lx\n"</span>, FileSize.HighPart );
00446 
00447     <span class="comment">//</span>
00448     <span class="comment">//  Check that the client name length is a legal length.</span>
00449     <span class="comment">//</span>
00450 
00451     <span class="keywordflow">if</span> (ClientName.Length &gt; <a class="code" href="../../d9/d3/lfsdisk_8h.html#a22">LFS_CLIENT_NAME_MAX</a>) {
00452 
00453         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Illegal name length for client\n"</span>, 0 );
00454         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsOpenLogFile:  Exit\n"</span>, 0 );
00455         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INVALID_PARAMETER );
00456     }
00457 
00458     <span class="comment">//</span>
00459     <span class="comment">//  Protect this call with a try-except.</span>
00460     <span class="comment">//</span>
00461 
00462     <span class="keywordflow">try</span> {
00463 
00464         <span class="comment">//</span>
00465         <span class="comment">//  Aqcuire the global data.</span>
00466         <span class="comment">//</span>
00467 
00468         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a21">LfsAcquireLfsData</a>();
00469 
00470         <span class="comment">//</span>
00471         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00472         <span class="comment">//</span>
00473 
00474         <span class="keywordflow">try</span> {
00475 
00476             <span class="comment">//</span>
00477             <span class="comment">//  Walk through the list searching for this file object.</span>
00478             <span class="comment">//</span>
00479 
00480             Link = <a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o2">LfcbLinks</a>.Flink;
00481 
00482             <span class="keywordflow">while</span> (Link != &amp;<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o2">LfcbLinks</a>) {
00483 
00484                 ThisLfcb = CONTAINING_RECORD( Link, <a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a>, LfcbLinks );
00485 
00486                 <span class="keywordflow">if</span> (ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o4">FileObject</a> == LogFile) {
00487 
00488                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Found matching log file\n"</span>, 0 );
00489                     <span class="keywordflow">break</span>;
00490                 }
00491 
00492                 Link = Link-&gt;Flink;
00493             }
00494 
00495             <span class="comment">//</span>
00496             <span class="comment">//  If the log file doesn't exist, create an Lfcb and perform an</span>
00497             <span class="comment">//  Lfs restart.</span>
00498             <span class="comment">//</span>
00499 
00500             <span class="keywordflow">if</span> (Link == &amp;<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o2">LfcbLinks</a>) {
00501 
00502                 <span class="comment">//</span>
00503                 <span class="comment">//  Call the Cache Manager to disable read ahead and write behind;</span>
00504                 <span class="comment">//  we flush the log file explicitly.</span>
00505                 <span class="comment">//</span>
00506 
00507                 <a class="code" href="../../d4/d2/cache_8h.html#a95">CcSetAdditionalCacheAttributes</a>( LogFile, TRUE, TRUE );
00508 
00509                 <span class="comment">//</span>
00510                 <span class="comment">//  Perform Lfs restart on this file object.</span>
00511                 <span class="comment">//</span>
00512 
00513                 ThisLfcb = NewLfcb = <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a1">LfsRestartLogFile</a>( LogFile,
00514                                                         MaximumClients,
00515                                                         0,
00516                                                         FileSize,
00517                                                         LfsInfo,
00518                                                         WriteData );
00519 
00520                 <span class="comment">//</span>
00521                 <span class="comment">//  Insert this Lfcb into the global list.</span>
00522                 <span class="comment">//</span>
00523 
00524                 InsertHeadList( &amp;<a class="code" href="../../d7/d3/lfsdata_8c.html#a1">LfsData</a>.<a class="code" href="../../d5/d0/struct__LFS__DATA.html#o2">LfcbLinks</a>, &amp;ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o2">LfcbLinks</a> );
00525             }
00526 
00527             <span class="comment">//</span>
00528             <span class="comment">//  At this point we have the log file control block for the file</span>
00529             <span class="comment">//  object given us.  We first check whether the log file is fatally</span>
00530             <span class="comment">//  corrupt.</span>
00531             <span class="comment">//</span>
00532 
00533             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o54">Flags</a>, LFCB_LOG_FILE_CORRUPT )) {
00534 
00535                 <span class="comment">//</span>
00536                 <span class="comment">//  We leave the in-memory data alone and raise an error if</span>
00537                 <span class="comment">//  anyone attempts to access this file.</span>
00538                 <span class="comment">//</span>
00539 
00540                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"The Lfcb is corrupt\n"</span>, 0 );
00541                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00542             }
00543 
00544             <span class="comment">//</span>
00545             <span class="comment">//  Search through and look for a client match.</span>
00546             <span class="comment">//</span>
00547 
00548             ThisClient = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a>;
00549 
00550             <span class="keywordflow">while</span> (ThisClient != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
00551 
00552                 ClientRecord = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a> + ThisClient;
00553 
00554                 <span class="keywordflow">if</span> (ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o7">ClientNameLength</a> == (ULONG) ClientName.Length
00555                     &amp;&amp; RtlCompareMemory( ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o8">ClientName</a>,
00556                                          ClientName.Buffer,
00557                                          ClientName.Length ) == (ULONG) ClientName.Length) {
00558 
00559                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Matching client name found\n"</span>, 0 );
00560                     <span class="keywordflow">break</span>;
00561                 }
00562 
00563                 ThisClient = ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o3">NextClient</a>;
00564             }
00565 
00566             <span class="comment">//</span>
00567             <span class="comment">//  Allocate an Lch structure and link it into the Lfcb.</span>
00568             <span class="comment">//</span>
00569 
00570             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a16">LfsAllocateLch</a>( &amp;Lch );
00571             InsertTailList( &amp;ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o3">LchLinks</a>, &amp;Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o2">LchLinks</a> );
00572 
00573             <span class="comment">//</span>
00574             <span class="comment">//  Initialize the client handle with the data from the Lfcb.</span>
00575             <span class="comment">//</span>
00576 
00577             Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a> = ThisLfcb;
00578             Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o7">Sync</a> = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>;
00579             Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o7">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o2">UserCount</a> += 1;
00580 
00581             <span class="comment">//</span>
00582             <span class="comment">//  If a match isn't found, take a client block off the free list</span>
00583             <span class="comment">//  if available.</span>
00584             <span class="comment">//</span>
00585 
00586             <span class="keywordflow">if</span> (ThisClient == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
00587 
00588                 <span class="comment">//</span>
00589                 <span class="comment">//  Raise an error status if out of client blocks.</span>
00590                 <span class="comment">//</span>
00591 
00592                 ThisClient = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o2">ClientFreeList</a>;
00593 
00594                 <span class="keywordflow">if</span> (ThisClient == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
00595 
00596                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"No free client records available\n"</span>, 0 );
00597                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00598                 }
00599 
00600                 <span class="comment">//</span>
00601                 <span class="comment">//  Initialize the client block.</span>
00602                 <span class="comment">//</span>
00603 
00604                 ClientRecord = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a> + ThisClient;
00605 
00606                 <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a21">LfsRemoveClientFromList</a>( ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00607                                          ClientRecord,
00608                                          &amp;ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o2">ClientFreeList</a> );
00609 
00610                 ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a> = <a class="code" href="../../d6/d3/lfs_8h.html#a12">LfsZeroLsn</a>;
00611                 ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o0">OldestLsn</a> = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o39">OldestLsn</a>;
00612                 ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o7">ClientNameLength</a> = ClientName.Length;
00613                 RtlCopyMemory( ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o8">ClientName</a>,
00614                                ClientName.Buffer,
00615                                ClientName.Length );
00616 
00617                 <span class="comment">//</span>
00618                 <span class="comment">//  Add it to the in use list.</span>
00619                 <span class="comment">//</span>
00620 
00621                 <a class="code" href="../../d0/d7/lfs_2registry_8c.html#a12">LfsAddClientToList</a>( ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00622                                     ThisClient,
00623                                     &amp;ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a> );
00624             }
00625 
00626             <span class="comment">//</span>
00627             <span class="comment">//  Update the client handle with the client block information.</span>
00628             <span class="comment">//</span>
00629 
00630             Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o4">ClientId</a>.<a class="code" href="../../d3/d0/struct__LFS__CLIENT__ID.html#o0">SeqNumber</a> = ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o4">SeqNumber</a>;
00631             Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o4">ClientId</a>.<a class="code" href="../../d3/d0/struct__LFS__CLIENT__ID.html#o1">ClientIndex</a> = ThisClient;
00632 
00633             Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o6">ClientArrayByteOffset</a> = <a class="code" href="../../d2/d7/notify_8c.html#a8">PtrOffset</a>( ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00634                                                     ClientRecord );
00635 
00636             *LogHandle = (<a class="code" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>) Lch;
00637 
00638         } finally {
00639 
00640             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsOpenLogFile );
00641 
00642             <span class="comment">//</span>
00643             <span class="comment">//  If the Lfcb has been acquired, we release it now.</span>
00644             <span class="comment">//</span>
00645 
00646             <span class="keywordflow">if</span> (ThisLfcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00647 
00648                 <span class="comment">//</span>
00649                 <span class="comment">//  Pass information back to our caller for the number</span>
00650                 <span class="comment">//  of bytes to add to the reserved amount for a</span>
00651                 <span class="comment">//  log header.</span>
00652                 <span class="comment">//</span>
00653 
00654                 ReservedHeader = ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o20">RecordHeaderLength</a>;
00655                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o54">Flags</a>, LFCB_PACK_LOG )) {
00656 
00657                     ReservedHeader *= 2;
00658                 }
00659 
00660                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( ThisLfcb );
00661             }
00662 
00663             <span class="comment">//</span>
00664             <span class="comment">//  If there is an error then deallocate the Lch and any new Lfcb.</span>
00665             <span class="comment">//</span>
00666 
00667             <span class="keywordflow">if</span> (AbnormalTermination()) {
00668 
00669                 <span class="keywordflow">if</span> (Lch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00670 
00671                     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a17">LfsDeallocateLch</a>( Lch );
00672                     ThisLfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o2">UserCount</a> -= 1;
00673                 }
00674 
00675                 <span class="keywordflow">if</span> (NewLfcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00676 
00677                     <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a2">LfsDeallocateLfcb</a>( NewLfcb, TRUE );
00678                 }
00679             }
00680 
00681             <span class="comment">//</span>
00682             <span class="comment">//  Always free the global.</span>
00683             <span class="comment">//</span>
00684 
00685             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a22">LfsReleaseLfsData</a>();
00686 
00687             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle    -&gt; %08ln\n"</span>, *LogHandle );
00688             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsOpenLogFile:  Exit\n"</span>, 0 );
00689         }
00690 
00691     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00692 
00693         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00694     }
00695 
00696     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00697 
00698         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00699     }
00700 
00701     <span class="keywordflow">return</span> ReservedHeader;
00702 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="lfs.h::LfsQueryLastLsn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> LfsQueryLastLsn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LogHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d2/querylog_8c-source.html#l00701">701</a> of file <a class="el" href="../../d4/d2/querylog_8c-source.html">querylog.c</a>.
<p>
References <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00428">_LFS_RESTART_AREA::CurrentLsn</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00548">_LFCB::Flags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00601">LFCB_NO_LAST_LSN</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00701">LfsQueryLastLsn()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00147">LfsZeroLsn</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00140">LSN</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00435">_LFCB::RestartArea</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l00701">LfsQueryLastLsn()</a>.
<p>
<pre class="fragment"><div>00707                    :
00708 
00709     This routine will <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> most recent Lsn <span class="keywordflow">for</span> <span class="keyword">this</span> log record.
00710 
00711 Arguments:
00712 
00713     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00714                 client.
00715 
00716 Return Value:
00717 
00718     <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last Lsn assigned in <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00719 
00720 --*/
00721 
00722 {
00723     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00724 
00725     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00726 
00727     <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> LastLsn;
00728 
00729     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00730 
00731     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsQueryLastLsn:  Entered\n"</span>, 0 );
00732     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle    -&gt; %08lx\n"</span>, LogHandle );
00733 
00734     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00735 
00736     <span class="comment">//</span>
00737     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00738     <span class="comment">//</span>
00739 
00740     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00741 
00742     <span class="comment">//</span>
00743     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00744     <span class="comment">//</span>
00745 
00746     <span class="keywordflow">try</span> {
00747 
00748         <span class="comment">//</span>
00749         <span class="comment">//  Acquire the log file control block for this log file.</span>
00750         <span class="comment">//</span>
00751 
00752         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00753         Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00754 
00755         <span class="comment">//</span>
00756         <span class="comment">//  If the Log file has been closed then refuse access.</span>
00757         <span class="comment">//</span>
00758 
00759         <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00760 
00761             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00762         }
00763 
00764         <span class="comment">//</span>
00765         <span class="comment">//  Check that the client Id is valid.</span>
00766         <span class="comment">//</span>
00767 
00768         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00769 
00770         <span class="comment">//</span>
00771         <span class="comment">//  Copy the last Lsn out of the Lfcb.  If the last Lsn is</span>
00772         <span class="comment">//  does not correspond to a log record, we will return the</span>
00773         <span class="comment">//  zero Lsn.</span>
00774         <span class="comment">//</span>
00775 
00776         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o54">Flags</a>, LFCB_NO_LAST_LSN )) {
00777 
00778             LastLsn = <a class="code" href="../../d6/d3/lfs_8h.html#a12">LfsZeroLsn</a>;
00779 
00780         } <span class="keywordflow">else</span> {
00781 
00782             LastLsn = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o0">CurrentLsn</a>;
00783         }
00784 
00785     } finally {
00786 
00787         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsQueryLastLsn );
00788 
00789         <span class="comment">//</span>
00790         <span class="comment">//  Release the Lfcb if acquired.</span>
00791         <span class="comment">//</span>
00792 
00793         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00794 
00795         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Last Lsn (Low)    -&gt; %08lx\n"</span>, LastLsn.LowPart );
00796         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Last Lsn (High)   -&gt; %08lx\n"</span>, LastLsn.HighPart );
00797         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsQueryLastLsn:  Exit\n"</span>, 0 );
00798     }
00799 
00800     <span class="keywordflow">return</span> LastLsn;
00801 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="lfs.h::LfsReadLogFileInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsReadLogFileInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">PLOG_FILE_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01141">1141</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00258">_LOG_FILE_INFORMATION::ClientUndoCommitment</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00157">_LCH::ClientUndoCommitment</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00243">_LOG_FILE_INFORMATION::CurrentAvailable</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00428">_LFS_RESTART_AREA::CurrentLsn</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00266">_LOG_FILE_INFORMATION::LastFlushedLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00483">_LFCB::LastFlushedLsn</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00267">_LOG_FILE_INFORMATION::LastLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00036">LfsCurrentAvailSpace()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01141">LfsReadLogFileInformation()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00265">_LOG_FILE_INFORMATION::OldestLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00467">_LFCB::OldestLsn</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00435">_LFCB::RestartArea</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00235">_LOG_FILE_INFORMATION::TotalAvailable</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00511">_LFCB::TotalAvailable</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00252">_LOG_FILE_INFORMATION::TotalUndoCommitment</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00513">_LFCB::TotalUndoCommitment</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01141">LfsReadLogFileInformation()</a>.
<p>
<pre class="fragment"><div>01149                    :
01150 
01151     This routine returns information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log
01152     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, primarily to aid <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client perform its checkpoint processing.
01153 
01154 Arguments:
01155 
01156     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
01157                 client.
01158 
01159     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Pointer to buffer to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> information.
01160 
01161     Length - On input <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's buffer.  On output,
01162              <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> amount of data stored by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfs in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
01163 
01164 Return Value:
01165 
01166     None
01167 
01168 --*/
01169 
01170 {
01171     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
01172     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
01173 
01174     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01175 
01176     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsReadLogFileInformation:  Entered\n"</span>, 0 );
01177     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle    -&gt; %08lx\n"</span>, LogHandle );
01178     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer        -&gt; %08lx\n"</span>, Buffer );
01179     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Length        -&gt; %08lx\n"</span>, *Length );
01180 
01181     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
01182 
01183     <span class="comment">//</span>
01184     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
01185     <span class="comment">//</span>
01186 
01187     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
01188 
01189     <span class="comment">//</span>
01190     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01191     <span class="comment">//</span>
01192 
01193     <span class="keywordflow">try</span> {
01194 
01195         <span class="comment">//</span>
01196         <span class="comment">//  Acquire the log file control block for this log file.</span>
01197         <span class="comment">//</span>
01198 
01199         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
01200         Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
01201 
01202         <span class="comment">//</span>
01203         <span class="comment">//  If the Log file has been closed then return immediately.</span>
01204         <span class="comment">//</span>
01205 
01206         <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01207 
01208             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( *Length = 0 );
01209         }
01210 
01211         <span class="comment">//</span>
01212         <span class="comment">//  Check that the client Id is valid.</span>
01213         <span class="comment">//</span>
01214 
01215         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
01216 
01217         <span class="comment">//</span>
01218         <span class="comment">//  The buffer better be large enough.</span>
01219         <span class="comment">//</span>
01220 
01221         <span class="keywordflow">if</span> (*Length &gt;= <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">LOG_FILE_INFORMATION</a> )) {
01222 
01223             <a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">PLOG_FILE_INFORMATION</a> Information;
01224             LONGLONG CurrentAvail;
01225             ULONG UnusedBytes;
01226 
01227             <a class="code" href="../../d7/d5/lfs_2verfysup_8c.html#a0">LfsCurrentAvailSpace</a>( Lfcb,
01228                                   &amp;CurrentAvail,
01229                                   &amp;UnusedBytes );
01230 
01231             <span class="comment">//</span>
01232             <span class="comment">//  Cast a pointer to the buffer and fill in the</span>
01233             <span class="comment">//  data.</span>
01234             <span class="comment">//</span>
01235 
01236             Information = (<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">PLOG_FILE_INFORMATION</a>) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01237 
01238             Information-&gt;<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html#o0">TotalAvailable</a> = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o42">TotalAvailable</a>;
01239             Information-&gt;<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html#o1">CurrentAvailable</a> =  CurrentAvail;
01240             Information-&gt;<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html#o2">TotalUndoCommitment</a> = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o44">TotalUndoCommitment</a>;
01241             Information-&gt;<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html#o3">ClientUndoCommitment</a> = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o5">ClientUndoCommitment</a>;
01242 
01243             Information-&gt;<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html#o4">OldestLsn</a> = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o39">OldestLsn</a>;
01244             Information-&gt;<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html#o5">LastFlushedLsn</a> = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o41">LastFlushedLsn</a>;
01245             Information-&gt;<a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html#o6">LastLsn</a> = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o0">CurrentLsn</a>;
01246 
01247             *Length = <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d3/struct__LOG__FILE__INFORMATION.html">LOG_FILE_INFORMATION</a> );
01248 
01249         } <span class="keywordflow">else</span> {
01250 
01251             *Length = 0;
01252         }
01253 
01254     try_exit:  NOTHING;
01255     } finally {
01256 
01257         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsReadLogFileInformation );
01258 
01259         <span class="comment">//</span>
01260         <span class="comment">//  Release the log file control block if held.</span>
01261         <span class="comment">//</span>
01262 
01263         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
01264 
01265         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsReadLogFileInformation:  Exit\n"</span>, 0 );
01266     }
01267 
01268     <span class="keywordflow">return</span>;
01269 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="lfs.h::LfsReadLogRecord" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsReadLogRecord           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FirstLsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a15">LFS_CONTEXT_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a26">PLFS_LOG_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a14">PLFS_RECORD_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RecordType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>TransactionId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>UndoNextLsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousLsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">72</a> of file <a class="el" href="../../d4/d2/querylog_8c-source.html">querylog.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00436">_LFCB::ClientArray</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00163">_LCH::ClientArrayByteOffset</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00149">_LCH::ClientId</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00463">LfsAllocateLcb()</a>, <a class="el" href="../../d6/d3/lfs_8h.html#a63a35">LfsContextForward</a>, <a class="el" href="../../d6/d3/lfs_8h.html#a63a34">LfsContextPrevious</a>, <a class="el" href="../../d6/d3/lfs_8h.html#a63a33">LfsContextUndoNext</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00518">LfsDeallocateLcb()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00809">LfsFindLogRecord()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00423">LfsInitializeLcb</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">LfsReadLogRecord()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00602">LfsVerifyClientLsnInRange</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">LfsReadLogRecord()</a>.
<p>
<pre class="fragment"><div>00087                    :
00088 
00089     This routine initiates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation.  It returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record
00090     in question and a context structure used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfs to <span class="keywordflow">return</span> related
00091     log records.  The caller specifies what mode of query to use.  He may
00092     walk backwards through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> by Undo records or all records <span class="keywordflow">for</span>
00093     <span class="keyword">this</span> client linked through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous Lsn fields.  He may also look
00094     forwards through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> all records <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> issuing client.
00095 
00096 Arguments:
00097 
00098     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00099                 client.
00100 
00101     FirstLsn - Starting record <span class="keywordflow">for</span> <span class="keyword">this</span> query operation.
00102 
00103     ContextMode - Method of query.
00104 
00105     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfs created
00106               context structure.
00107 
00108     RecordType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> record <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <span class="keyword">this</span>
00109                  log record.
00110 
00111     TransactionId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transaction Id of
00112                     <span class="keyword">this</span> log record.
00113 
00114     UndoNextLsn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Undo Next Lsn <span class="keywordflow">for</span> <span class="keyword">this</span>
00115                   log record.
00116 
00117     PreviousLsn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Previous Lsn <span class="keywordflow">for</span> <span class="keyword">this</span>
00118                   log record.
00119 
00120     BufferLength - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log data.
00121 
00122     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log data.
00123 
00124 Return Value:
00125 
00126     None
00127 
00128 --*/
00129 
00130 {
00131     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00132 
00133     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
00134 
00135     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00136 
00137     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00138 
00139     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00140 
00141     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00142 
00143     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsReadLogRecord:  Entered\n"</span>, 0 );
00144     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle        -&gt; %08lx\n"</span>, LogHandle );
00145     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"First Lsn (Low)   -&gt; %08lx\n"</span>, FirstLsn.LowPart );
00146     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"First Lsn (High)  -&gt; %08lx\n"</span>, FirstLsn.HighPart );
00147     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Context Mode      -&gt; %08lx\n"</span>, ContextMode );
00148 
00149     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00150 
00151     <span class="comment">//</span>
00152     <span class="comment">//  Check that the context mode is valid.</span>
00153     <span class="comment">//</span>
00154 
00155     <span class="keywordflow">switch</span> (ContextMode) {
00156 
00157     <span class="keywordflow">case</span> <a class="code" href="../../d6/d3/lfs_8h.html#a63a33">LfsContextUndoNext</a> :
00158     <span class="keywordflow">case</span> <a class="code" href="../../d6/d3/lfs_8h.html#a63a34">LfsContextPrevious</a> :
00159     <span class="keywordflow">case</span> <a class="code" href="../../d6/d3/lfs_8h.html#a63a35">LfsContextForward</a> :
00160 
00161         <span class="keywordflow">break</span>;
00162 
00163     <span class="keywordflow">default</span>:
00164 
00165         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Invalid context mode -&gt; %08x\n"</span>, ContextMode );
00166         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INVALID_PARAMETER );
00167     }
00168 
00169     <span class="comment">//</span>
00170     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00171     <span class="comment">//</span>
00172 
00173     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00174 
00175     <span class="comment">//</span>
00176     <span class="comment">//  Use a try-except to catch errors.</span>
00177     <span class="comment">//</span>
00178 
00179     <span class="keywordflow">try</span> {
00180 
00181         <span class="comment">//</span>
00182         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00183         <span class="comment">//</span>
00184 
00185         <span class="keywordflow">try</span> {
00186 
00187             <span class="comment">//</span>
00188             <span class="comment">//  Acquire the log file control block for this log file.</span>
00189             <span class="comment">//</span>
00190 
00191             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00192             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00193 
00194             <span class="comment">//</span>
00195             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00196             <span class="comment">//</span>
00197 
00198             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00199 
00200                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00201             }
00202 
00203             <span class="comment">//</span>
00204             <span class="comment">//  Check that the client Id is valid.</span>
00205             <span class="comment">//</span>
00206 
00207             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00208 
00209             <span class="comment">//</span>
00210             <span class="comment">//  Check that the given Lsn is in the legal range for this client.</span>
00211             <span class="comment">//</span>
00212 
00213             ClientRecord = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00214                                     Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o6">ClientArrayByteOffset</a>,
00215                                     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00216 
00217             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d4/lfsprocs_8h.html#a34">LfsVerifyClientLsnInRange</a>( Lfcb, ClientRecord, FirstLsn )) {
00218 
00219                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00220             }
00221 
00222             <span class="comment">//</span>
00223             <span class="comment">//  We can give up the Lfcb as we know the Lsn is within the file.</span>
00224             <span class="comment">//</span>
00225 
00226             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00227 
00228             <span class="comment">//</span>
00229             <span class="comment">//  Allocate and initialize a context structure.</span>
00230             <span class="comment">//</span>
00231 
00232             <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a5">LfsAllocateLcb</a>( Lfcb, &amp;Lcb );
00233 
00234             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a15">LfsInitializeLcb</a>( Lcb,
00235                               Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o4">ClientId</a>,
00236                               ContextMode );
00237 
00238             <span class="comment">//</span>
00239             <span class="comment">//  Find the log record indicated by the given Lsn.</span>
00240             <span class="comment">//</span>
00241 
00242             <a class="code" href="../../d3/d3/querylog_8c.html#a2">LfsFindLogRecord</a>( Lfcb,
00243                               Lcb,
00244                               FirstLsn,
00245                               RecordType,
00246                               TransactionId,
00247                               UndoNextLsn,
00248                               PreviousLsn,
00249                               BufferLength,
00250                               Buffer );
00251 
00252             <span class="comment">//</span>
00253             <span class="comment">//  Update the client's arguments.</span>
00254             <span class="comment">//</span>
00255 
00256             *Context = Lcb;
00257             Lcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00258 
00259         } finally {
00260 
00261             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsReadLogRecord );
00262 
00263             <span class="comment">//</span>
00264             <span class="comment">//  Release the log file control block if held.</span>
00265             <span class="comment">//</span>
00266 
00267             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00268 
00269             <span class="comment">//</span>
00270             <span class="comment">//  Deallocate the context block if an error occurred.</span>
00271             <span class="comment">//</span>
00272 
00273             <span class="keywordflow">if</span> (Lcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00274 
00275                 <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a6">LfsDeallocateLcb</a>( Lfcb, Lcb );
00276             }
00277 
00278             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Context       -&gt; %08lx\n"</span>, *Context );
00279             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer Length -&gt; %08lx\n"</span>, *BufferLength );
00280             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer        -&gt; %08lx\n"</span>, *Buffer );
00281             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsReadLogRecord:  Exit\n"</span>, 0 );
00282         }
00283 
00284     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00285 
00286         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00287     }
00288 
00289     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00290 
00291         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00292     }
00293 
00294     <span class="keywordflow">return</span>;
00295 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="lfs.h::LfsReadNextLogRecord" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LfsReadNextLogRecord           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d6/d3/lfs_8h.html#a25">LFS_LOG_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a14">PLFS_RECORD_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RecordType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>TransactionId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>UndoNextLsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousLsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d2/querylog_8c-source.html#l00299">299</a> of file <a class="el" href="../../d4/d2/querylog_8c-source.html">querylog.c</a>.
<p>
References <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00076">_LCB::AuxilaryBuffer</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00075">_LCB::CurrentLogRecord</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l01004">LfsFindClientNextLsn()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00809">LfsFindLogRecord()</a>, <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00297">LfsFreeSpanningBuffer()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00299">LfsReadNextLogRecord()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00611">LfsValidateLcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00048">_LCB::RecordHeader</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00049">_LCB::RecordHeaderBcb</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l00299">LfsReadNextLogRecord()</a>.
<p>
<pre class="fragment"><div>00313                    :
00314 
00315     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to <span class="keywordflow">continue</span> a query operation.  The Lfs uses
00316     <span class="keyword">private</span> information stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context structure to determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00317     next log record to <span class="keywordflow">return</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
00318 
00319 Arguments:
00320 
00321     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00322                 client.
00323 
00324     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfs created
00325               context structure.
00326 
00327     Lsn - Lsn <span class="keywordflow">for</span> <span class="keyword">this</span> log record.
00328 
00329     RecordType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> record <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <span class="keyword">this</span>
00330                  log record.
00331 
00332     TransactionId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transaction Id of
00333                     <span class="keyword">this</span> log record.
00334 
00335     UndoNextLsn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Undo Next Lsn <span class="keywordflow">for</span> <span class="keyword">this</span>
00336                   log record.
00337 
00338     PreviousLsn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Previous Lsn <span class="keywordflow">for</span> <span class="keyword">this</span>
00339                   log record.
00340 
00341     BufferLength - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log data.
00342 
00343     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log data.
00344 
00345 Return Value:
00346 
00347     None
00348 
00349 --*/
00350 
00351 {
00352     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00353 
00354     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00355 
00356     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00357 
00358     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb;
00359 
00360     BOOLEAN FoundNextLsn;
00361 
00362     BOOLEAN UnwindRememberLcbFields;
00363     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> UnwindRecordHeaderBcb;
00364     <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> UnwindRecordHeader;
00365     PVOID UnwindCurrentLogRecord;
00366     BOOLEAN UnwindAuxilaryBuffer;
00367 
00368     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00369 
00370     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsReadNextLogRecord:  Entered\n"</span>, 0 );
00371     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle    -&gt; %08lx\n"</span>, LogHandle );
00372     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Context       -&gt; %08lx\n"</span>, Context );
00373 
00374     FoundNextLsn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00375 
00376     UnwindRememberLcbFields = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00377 
00378     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00379     Lcb = (<a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>) Context;
00380 
00381     <span class="comment">//</span>
00382     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00383     <span class="comment">//</span>
00384 
00385     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">//  Use a try-except to catch errors.</span>
00389     <span class="comment">//</span>
00390 
00391     <span class="keywordflow">try</span> {
00392 
00393         <span class="comment">//</span>
00394         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00395         <span class="comment">//</span>
00396 
00397         <span class="keywordflow">try</span> {
00398 
00399             <span class="comment">//</span>
00400             <span class="comment">//  Acquire the log file control block for this log file.</span>
00401             <span class="comment">//</span>
00402 
00403             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00404             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00405 
00406             <span class="comment">//</span>
00407             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00408             <span class="comment">//</span>
00409 
00410             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00411 
00412                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00413             }
00414 
00415             <span class="comment">//</span>
00416             <span class="comment">//  Check that the client Id is valid.</span>
00417             <span class="comment">//</span>
00418 
00419             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00420 
00421             <span class="comment">//</span>
00422             <span class="comment">//  Check that the context structure is valid.</span>
00423             <span class="comment">//</span>
00424 
00425             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a36">LfsValidateLcb</a>( Lcb, Lch );
00426 
00427             <span class="comment">//</span>
00428             <span class="comment">//  Remember any context fields to be overwritten.</span>
00429             <span class="comment">//</span>
00430 
00431             UnwindRememberLcbFields = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00432 
00433             UnwindRecordHeaderBcb = Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o3">RecordHeaderBcb</a>;
00434             Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o3">RecordHeaderBcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00435 
00436             UnwindRecordHeader = Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o2">RecordHeader</a>;
00437             UnwindCurrentLogRecord = Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o6">CurrentLogRecord</a>;
00438 
00439             UnwindAuxilaryBuffer = Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o7">AuxilaryBuffer</a>;
00440             Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o7">AuxilaryBuffer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00441 
00442             <span class="comment">//</span>
00443             <span class="comment">//  Find the next Lsn number based on the current Lsn number in</span>
00444             <span class="comment">//  the context block.</span>
00445             <span class="comment">//</span>
00446 
00447             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/querylog_8c.html#a3">LfsFindClientNextLsn</a>( Lfcb, Lcb, Lsn )) {
00448 
00449                 <span class="comment">//</span>
00450                 <span class="comment">//  We can give up the Lfcb as we know the Lsn is within the file.</span>
00451                 <span class="comment">//</span>
00452 
00453                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
00454 
00455                 <span class="comment">//</span>
00456                 <span class="comment">//  Cleanup the context block so we can do the next search.</span>
00457                 <span class="comment">//</span>
00458 
00459                 Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o6">CurrentLogRecord</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00460                 Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o7">AuxilaryBuffer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00461 
00462                 <span class="comment">//</span>
00463                 <span class="comment">//  Perform the work of getting the log record.</span>
00464                 <span class="comment">//</span>
00465 
00466                 <a class="code" href="../../d3/d3/querylog_8c.html#a2">LfsFindLogRecord</a>( Lfcb,
00467                                   Lcb,
00468                                   *Lsn,
00469                                   RecordType,
00470                                   TransactionId,
00471                                   UndoNextLsn,
00472                                   PreviousLsn,
00473                                   BufferLength,
00474                                   Buffer );
00475 
00476                 FoundNextLsn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00477             }
00478 
00479         } finally {
00480 
00481             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsReadNextLogRecord );
00482 
00483             <span class="comment">//</span>
00484             <span class="comment">//  If we exited due to an error, we have to restore the context</span>
00485             <span class="comment">//  block.</span>
00486             <span class="comment">//</span>
00487 
00488             <span class="keywordflow">if</span> (UnwindRememberLcbFields) {
00489 
00490                 <span class="keywordflow">if</span> (AbnormalTermination()) {
00491 
00492                     <span class="comment">//</span>
00493                     <span class="comment">//  If the record header in the context block is not</span>
00494                     <span class="comment">//  the same as we started with.  Then we unpin that</span>
00495                     <span class="comment">//  data.</span>
00496                     <span class="comment">//</span>
00497 
00498                     <span class="keywordflow">if</span> (Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o3">RecordHeaderBcb</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00499 
00500                         <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o3">RecordHeaderBcb</a> );
00501 
00502                     }
00503 
00504                     <span class="keywordflow">if</span> (Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o6">CurrentLogRecord</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00505                         &amp;&amp; Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o7">AuxilaryBuffer</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00506 
00507                         <a class="code" href="../../d6/d5/logpgsup_8c.html#a4">LfsFreeSpanningBuffer</a>( Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o6">CurrentLogRecord</a> );
00508                     }
00509 
00510                     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o3">RecordHeaderBcb</a> = UnwindRecordHeaderBcb;
00511                     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o2">RecordHeader</a> = UnwindRecordHeader;
00512                     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o6">CurrentLogRecord</a> = UnwindCurrentLogRecord;
00513                     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o7">AuxilaryBuffer</a> = UnwindAuxilaryBuffer;
00514 
00515                 <span class="comment">//</span>
00516                 <span class="comment">//  Otherwise, if we have successfully found the next Lsn,</span>
00517                 <span class="comment">//  we free up any resources being held from the previous search.</span>
00518                 <span class="comment">//</span>
00519 
00520                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FoundNextLsn ) {
00521 
00522                     <span class="keywordflow">if</span> (UnwindRecordHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00523 
00524                         <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( UnwindRecordHeaderBcb );
00525                     }
00526 
00527                     <span class="keywordflow">if</span> (UnwindCurrentLogRecord != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00528                         &amp;&amp; UnwindAuxilaryBuffer == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00529 
00530                         <a class="code" href="../../d6/d5/logpgsup_8c.html#a4">LfsFreeSpanningBuffer</a>( UnwindCurrentLogRecord );
00531                     }
00532 
00533                 <span class="comment">//</span>
00534                 <span class="comment">//  Restore the Bcb and auxilary buffer field for the final</span>
00535                 <span class="comment">//  cleanup.</span>
00536                 <span class="comment">//</span>
00537 
00538                 } <span class="keywordflow">else</span> {
00539 
00540                     <span class="keywordflow">if</span> (UnwindRecordHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00541 
00542                         <span class="keywordflow">if</span> (Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o3">RecordHeaderBcb</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00543 
00544                             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( UnwindRecordHeaderBcb );
00545 
00546                         } <span class="keywordflow">else</span> {
00547 
00548                             Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o3">RecordHeaderBcb</a> = UnwindRecordHeaderBcb;
00549                         }
00550                     }
00551 
00552                     <span class="keywordflow">if</span> (UnwindAuxilaryBuffer) {
00553 
00554                         <span class="keywordflow">if</span> (Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o6">CurrentLogRecord</a> == UnwindCurrentLogRecord) {
00555 
00556                             Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o7">AuxilaryBuffer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00557 
00558                         } <span class="keywordflow">else</span> {
00559 
00560                             <a class="code" href="../../d6/d5/logpgsup_8c.html#a4">LfsFreeSpanningBuffer</a>( UnwindCurrentLogRecord );
00561                         }
00562                     }
00563                 }
00564             }
00565 
00566             <span class="comment">//</span>
00567             <span class="comment">//  Release the log file control block if held.</span>
00568             <span class="comment">//</span>
00569 
00570             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00571 
00572             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)     -&gt; %08lx\n"</span>, Lsn-&gt;LowPart );
00573             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (High)    -&gt; %08lx\n"</span>, Lsn-&gt;HighPart );
00574             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer Length -&gt; %08lx\n"</span>, *BufferLength );
00575             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer        -&gt; %08lx\n"</span>, *Buffer );
00576             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsReadNextLogRecord:  Exit\n"</span>, 0 );
00577         }
00578 
00579     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00580 
00581         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00582     }
00583 
00584     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00585 
00586         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00587     }
00588 
00589     <span class="keywordflow">return</span> FoundNextLsn;
00590 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="lfs.h::LfsReadRestartArea" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LfsReadRestartArea           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">46</a> of file <a class="el" href="../../d6/d8/restart_8c-source.html">restart.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00436">_LFCB::ClientArray</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00163">_LCH::ClientArrayByteOffset</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00092">_LFS_RECORD_HEADER::ClientDataLength</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00373">_LFS_CLIENT_RECORD::ClientRestartLsn</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00339">LfsCopyReadLogRecord()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00248">LfsPinOrMapLogRecordHeader()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00147">LfsZeroLsn</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00073">_LFS_RECORD_HEADER::ThisLsn</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>.
<p>
<pre class="fragment"><div>00055                    :
00056 
00057     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client when he wishes to read his restart
00058     area in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00059 
00060 Arguments:
00061 
00062     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00063                 client.
00064 
00065     BufferLength - On entry <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user buffer.  On <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>
00066                    <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
00067 
00068     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client restart data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
00069              copied.
00070 
00071     Lsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn <span class="keywordflow">for</span> client restart area.
00072 
00073 Return Value:
00074 
00075     None
00076 
00077 --*/
00078 
00079 {
00080     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00081 
00082     BOOLEAN UsaError;
00083 
00084     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00085 
00086     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
00087 
00088     <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> RecordHeader;
00089     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> RecordHeaderBcb;
00090 
00091     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00092     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> RetStatus = STATUS_SUCCESS;
00093 
00094 
00095     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00096 
00097     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsReadRestartArea:  Entered\n"</span>, 0 );
00098     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle    -&gt; %08lx\n"</span>, LogHandle );
00099     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer Length -&gt; %08lx\n"</span>, *BufferLength );
00100     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer        -&gt; %08lx\n"</span>, Buffer );
00101 
00102     RecordHeaderBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00103 
00104     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00105 
00106     <span class="comment">//</span>
00107     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00108     <span class="comment">//</span>
00109 
00110     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00111 
00112     <span class="comment">//</span>
00113     <span class="comment">//  Use a try-except to catch errors.</span>
00114     <span class="comment">//</span>
00115 
00116     <span class="keywordflow">try</span> {
00117 
00118         <span class="comment">//</span>
00119         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00120         <span class="comment">//</span>
00121 
00122         <span class="keywordflow">try</span> {
00123 
00124             <span class="comment">//</span>
00125             <span class="comment">//  Acquire the log file control block for this log file.</span>
00126             <span class="comment">//</span>
00127 
00128             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00129             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00130 
00131             <span class="comment">//</span>
00132             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00133             <span class="comment">//</span>
00134 
00135             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00136 
00137                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00138             }
00139 
00140             <span class="comment">//</span>
00141             <span class="comment">//  Check that the client Id is valid.</span>
00142             <span class="comment">//</span>
00143 
00144             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00145 
00146             ClientRecord = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00147                                     Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o6">ClientArrayByteOffset</a>,
00148                                     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00149 
00150             <span class="comment">//</span>
00151             <span class="comment">//  If the client doesn't have a restart area, go ahead and exit</span>
00152             <span class="comment">//  now.</span>
00153             <span class="comment">//</span>
00154 
00155             <span class="keywordflow">if</span> ( ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a>.QuadPart == 0 ) {                                                      <span class="comment">//**** xxEqlZero( ClientRecord-&gt;ClientRestartLsn )</span>
00156 
00157                 <span class="comment">//</span>
00158                 <span class="comment">//  We show there is no restart area by returning a length</span>
00159                 <span class="comment">//  of zero.  We also set the Lsn value to zero so that</span>
00160                 <span class="comment">//  we can catch it if the user tries to use the Lsn.</span>
00161                 <span class="comment">//</span>
00162 
00163                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"No client restart area exists\n"</span>, 0 );
00164 
00165                 *BufferLength = 0;
00166                 *Lsn = <a class="code" href="../../d6/d3/lfs_8h.html#a12">LfsZeroLsn</a>;
00167 
00168                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00169             }
00170 
00171             <span class="comment">//</span>
00172             <span class="comment">//  Release the Lfcb as we won't be modifying any fields in it.</span>
00173             <span class="comment">//</span>
00174 
00175             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
00176 
00177             <span class="comment">//</span>
00178             <span class="comment">//  Pin the log record for this Lsn.</span>
00179             <span class="comment">//</span>
00180 
00181             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a49">LfsPinOrMapLogRecordHeader</a>( Lfcb,
00182                                         ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a>,
00183                                         FALSE,
00184                                         FALSE,
00185                                         &amp;UsaError,
00186                                         &amp;RecordHeader,
00187                                         &amp;RecordHeaderBcb );
00188 
00189             <span class="comment">//</span>
00190             <span class="comment">//  If the Lsn values don't match, then the disk is corrupt.</span>
00191             <span class="comment">//</span>
00192 
00193             <span class="keywordflow">if</span> ( ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a>.QuadPart != RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o0">ThisLsn</a>.QuadPart ) {                         <span class="comment">//**** xxNeq( ClientRecord-&gt;ClientRestartLsn, RecordHeader-&gt;ThisLsn )</span>
00194 
00195                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00196             }
00197 
00198 
00199             <span class="comment">//</span>
00200             <span class="comment">//  Check that the user's buffer is big enough to hold the restart</span>
00201             <span class="comment">//  data.  We raise an error status for this error.</span>
00202             <span class="comment">//</span>
00203 
00204             <span class="keywordflow">if</span> (RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o3">ClientDataLength</a> &gt; *BufferLength) {
00205 
00206                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Client buffer is too small\n"</span>, 0 );
00207                 *BufferLength = RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o3">ClientDataLength</a>;
00208                 *Lsn = <a class="code" href="../../d6/d3/lfs_8h.html#a12">LfsZeroLsn</a>;
00209                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( RetStatus = STATUS_BUFFER_TOO_SMALL );
00210             }
00211 
00212 
00213             <span class="comment">//</span>
00214             <span class="comment">//  Use the cache manager to copy the data into the user's buffer.</span>
00215             <span class="comment">//</span>
00216 
00217             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a50">LfsCopyReadLogRecord</a>( Lfcb,
00218                                   RecordHeader,
00219                                   Buffer );
00220 
00221             <span class="comment">//</span>
00222             <span class="comment">//  Pass the length and the Lsn of the restart area back to the</span>
00223             <span class="comment">//  caller.</span>
00224             <span class="comment">//</span>
00225 
00226             *BufferLength = RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o3">ClientDataLength</a>;
00227             *Lsn = RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o0">ThisLsn</a>;
00228 
00229         try_exit: NOTHING;
00230         } finally {
00231 
00232             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsReadRestartArea );
00233 
00234             <span class="comment">//</span>
00235             <span class="comment">//  Release the log file control block if held.</span>
00236             <span class="comment">//</span>
00237 
00238             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00239 
00240             <span class="comment">//</span>
00241             <span class="comment">//  Unpin the log record header for the client restart if pinned.</span>
00242             <span class="comment">//</span>
00243 
00244             <span class="keywordflow">if</span> (RecordHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00245 
00246                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( RecordHeaderBcb );
00247             }
00248 
00249             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)     -&gt; %08lx\n"</span>, Lsn-&gt;LowPart );
00250             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (High)    -&gt; %08lx\n"</span>, Lsn-&gt;HighPart );
00251             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer Length -&gt; %08lx\n"</span>, *BufferLength );
00252             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsReadRestartArea:  Exit\n"</span>, 0 );
00253         }
00254 
00255     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00256 
00257         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00258     }
00259 
00260     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00261 
00262         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00263     }
00264 
00265     <span class="keywordflow">return</span> RetStatus;
00266 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="lfs.h::LfsResetUndoTotal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsResetUndoTotal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberRecords</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResetTotal</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01361">1361</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00157">_LCH::ClientUndoCommitment</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00548">_LFCB::Flags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01361">LfsResetUndoTotal()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00394">_LFCB::RecordHeaderLength</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00513">_LFCB::TotalUndoCommitment</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01361">LfsResetUndoTotal()</a>.
<p>
<pre class="fragment"><div>01369                    :
01370 
01371     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to adjust <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo commitment <span class="keywordflow">for</span> <span class="keyword">this</span> client.
01372     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reset total <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> positive, then we absolutely set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01373     reserve value <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client <span class="keyword">using</span> <span class="keyword">this</span> as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> basis.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value
01374     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> negative, we will adjust <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current value <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client.
01375 
01376     To adjust <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> values in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb, we first <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Undo commitment
01377     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle and then adjust by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> values passed in.
01378 
01379     To adjust <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client handle, we simply set <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span>
01380     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reset value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> positive, adjust <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> negative.
01381 
01382     For a packed log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> we just reserve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space requested.  We
01383     have already taken into account <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loss of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tail of each page.
01384     For an unpacked log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> we <span class="keywordtype">double</span> each value.
01385 
01386 Arguments:
01387 
01388     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
01389                 client.
01390 
01391     NumberRecords - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of records we should assume <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01392                     reset total covers.  We allow an Lfs header <span class="keywordflow">for</span>
01393                     each one.
01394 
01395     ResetTotal - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> amount to adjust (or set) <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo
01396                  commitment.
01397 
01398 Return Value:
01399 
01400     None
01401 
01402 --*/
01403 
01404 {
01405     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
01406 
01407     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
01408 
01409     LONGLONG AdjustedUndoTotal;
01410     LONG LfsHeaderBytes;
01411 
01412     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01413 
01414     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsResetUndoTotal:  Entered\n"</span>, 0 );
01415     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle        -&gt; %08lx\n"</span>, LogHandle );
01416     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Number Records    -&gt; %08lx\n"</span>, NumberRecords );
01417     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"ResetTotal        -&gt; %08lx\n"</span>, ResetTotal );
01418 
01419     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
01420 
01421     <span class="comment">//</span>
01422     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
01423     <span class="comment">//</span>
01424 
01425     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
01426 
01427     <span class="comment">//</span>
01428     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01429     <span class="comment">//</span>
01430 
01431     <span class="keywordflow">try</span> {
01432 
01433         <span class="comment">//</span>
01434         <span class="comment">//  Acquire the log file control block for this log file.</span>
01435         <span class="comment">//</span>
01436 
01437         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
01438         Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
01439 
01440         <span class="comment">//</span>
01441         <span class="comment">//  If the Log file has been closed then refuse access.</span>
01442         <span class="comment">//</span>
01443 
01444         <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01445 
01446             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
01447         }
01448 
01449         <span class="comment">//</span>
01450         <span class="comment">//  Check that the client Id is valid.</span>
01451         <span class="comment">//</span>
01452 
01453         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
01454 
01455         <span class="comment">//</span>
01456         <span class="comment">//  Compute the adjusted reset total.  Start by computing the</span>
01457         <span class="comment">//  bytes needed for the Lfs log headers.  Add (or subtract) this</span>
01458         <span class="comment">//  from the reset total and multiply by 2 (only if not packing the</span>
01459         <span class="comment">//  log).</span>
01460         <span class="comment">//</span>
01461 
01462         LfsHeaderBytes = NumberRecords * Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o20">RecordHeaderLength</a>;
01463         LfsHeaderBytes *= 2;
01464 
01465         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o54">Flags</a>, LFCB_PACK_LOG )) {
01466 
01467             ResetTotal *= 2;
01468         }
01469 
01470         <span class="comment">//</span>
01471         <span class="comment">//  If the reset total is positive, add the header bytes.</span>
01472         <span class="comment">//</span>
01473 
01474         <span class="keywordflow">if</span> (ResetTotal &gt; 0) {
01475 
01476             <span class="comment">//</span>
01477             <span class="comment">//  Subtract the client's current value from the TotalUndo</span>
01478             <span class="comment">//  commit if he is setting his value exactly.</span>
01479             <span class="comment">//</span>
01480 
01481             Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o44">TotalUndoCommitment</a> = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o44">TotalUndoCommitment</a> - Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o5">ClientUndoCommitment</a>;
01482 
01483             <span class="comment">//</span>
01484             <span class="comment">//  We can clear the values in the user's handle at this</span>
01485             <span class="comment">//  time.</span>
01486             <span class="comment">//</span>
01487 
01488             Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o5">ClientUndoCommitment</a> = 0;
01489 
01490 
01491             ResetTotal += LfsHeaderBytes;
01492 
01493         <span class="comment">//</span>
01494         <span class="comment">//  Otherwise subtract the value for the header bytes.</span>
01495         <span class="comment">//</span>
01496 
01497         } <span class="keywordflow">else</span> {
01498 
01499             ResetTotal -= LfsHeaderBytes;
01500         }
01501 
01502         <span class="comment">//</span>
01503         <span class="comment">//  Now we adjust the Lfcb and Lch values by the adjustment amount.</span>
01504         <span class="comment">//</span>
01505 
01506         AdjustedUndoTotal = ResetTotal;
01507 
01508         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o44">TotalUndoCommitment</a> = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o44">TotalUndoCommitment</a> + AdjustedUndoTotal;
01509 
01510         Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o5">ClientUndoCommitment</a> = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o5">ClientUndoCommitment</a> + AdjustedUndoTotal;
01511 
01512     } finally {
01513 
01514         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsResetUndoTotal );
01515 
01516         <span class="comment">//</span>
01517         <span class="comment">//  Release the log file control block if held.</span>
01518         <span class="comment">//</span>
01519 
01520         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
01521 
01522         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsResetUndoTotal:  Exit\n"</span>, 0 );
01523     }
01524 
01525     <span class="keywordflow">return</span>;
01526 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="lfs.h::LfsSetBaseLsn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsSetBaseLsn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseLsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">447</a> of file <a class="el" href="../../d6/d8/restart_8c-source.html">restart.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00436">_LFCB::ClientArray</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00163">_LCH::ClientArrayByteOffset</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">LfsSetBaseLsn()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00582">LfsSetBaseLsnPriv()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00444">_LFCB::RestartAreaSize</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">LfsSetBaseLsn()</a>.
<p>
<pre class="fragment"><div>00454                    :
00455 
00456     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client to notify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log service of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00457     oldest Lsn he expects to need during restart.  The Lfs <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed to
00458     reuse any part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> circular log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which logically precedes
00459     <span class="keyword">this</span> Lsn.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> client may <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> specify a Lsn which follows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous
00460     Lsn specified by <span class="keyword">this</span> client.
00461 
00462 Arguments:
00463 
00464     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00465                 client.
00466 
00467     BaseLsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oldest Lsn <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client may require during a
00468               restart.
00469 
00470 Return Value:
00471 
00472     None
00473 
00474 --*/
00475 
00476 {
00477     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00478 
00479     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00480 
00481     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00482 
00483     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
00484 
00485     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00486 
00487     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsSetBaseLsn:  Entered\n"</span>, 0 );
00488     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle        -&gt; %08lx\n"</span>, LogHandle );
00489     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Base Lsn (Low)    -&gt; %08lx\n"</span>, BaseLsn.LowPart );
00490     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Base Lsn (High)   -&gt; %08lx\n"</span>, BaseLsn.HighPart );
00491 
00492     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00493 
00494     <span class="comment">//</span>
00495     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00496     <span class="comment">//</span>
00497 
00498     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00499 
00500     <span class="comment">//</span>
00501     <span class="comment">//  Use a try-except to catch errors.</span>
00502     <span class="comment">//</span>
00503 
00504     <span class="keywordflow">try</span> {
00505 
00506         <span class="comment">//</span>
00507         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00508         <span class="comment">//</span>
00509 
00510         <span class="keywordflow">try</span> {
00511 
00512             <span class="comment">//</span>
00513             <span class="comment">//  Acquire the log file control block for this log file.</span>
00514             <span class="comment">//</span>
00515 
00516             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00517             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00518 
00519             <span class="comment">//</span>
00520             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00521             <span class="comment">//</span>
00522 
00523             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00524 
00525                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00526             }
00527 
00528             <span class="comment">//</span>
00529             <span class="comment">//  Check that the client Id is valid.</span>
00530             <span class="comment">//</span>
00531 
00532             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00533 
00534             ClientRecord = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00535                                     Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o6">ClientArrayByteOffset</a>,
00536                                     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00537 
00538             <span class="comment">//</span>
00539             <span class="comment">//  We simply call the worker routine to advance the base lsn.</span>
00540             <span class="comment">//  If we moved forward in the file, we will put our restart area in the</span>
00541             <span class="comment">//  queue.</span>
00542             <span class="comment">//</span>
00543 
00544             <a class="code" href="../../d5/d9/restart_8c.html#a1">LfsSetBaseLsnPriv</a>( Lfcb,
00545                                ClientRecord,
00546                                BaseLsn );
00547 
00548             <a class="code" href="../../d7/d0/rstrtsup_8c.html#a1">LfsWriteLfsRestart</a>( Lfcb, Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o34">RestartAreaSize</a>, FALSE );
00549 
00550         } finally {
00551 
00552             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsSetBaseLsn );
00553 
00554             <span class="comment">//</span>
00555             <span class="comment">//  Release the log file control block if held.</span>
00556             <span class="comment">//</span>
00557 
00558             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00559 
00560             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsSetBaseLsn:  Exit\n"</span>, 0 );
00561         }
00562 
00563     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00564 
00565         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00566     }
00567 
00568     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00569 
00570         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00571     }
00572 
00573     <span class="keywordflow">return</span>;
00574 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="lfs.h::LfsTerminateLogQuery" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsTerminateLogQuery           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a25">LFS_LOG_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d2/querylog_8c-source.html#l00594">594</a> of file <a class="el" href="../../d4/d2/querylog_8c-source.html">querylog.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00518">LfsDeallocateLcb()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00594">LfsTerminateLogQuery()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00611">LfsValidateLcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l00594">LfsTerminateLogQuery()</a>.
<p>
<pre class="fragment"><div>00601                    :
00602 
00603     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a client has completed his query operation
00604     and wishes to deallocate any resources acquired by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfs to
00605     perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> query.
00606 
00607 Arguments:
00608 
00609     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00610                 client.
00611 
00612     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfs created
00613               context structure.
00614 
00615 Return Value:
00616 
00617     None
00618 
00619 --*/
00620 
00621 {
00622     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00623     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb;
00624 
00625     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00626 
00627     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00628 
00629     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsTerminateLogQuery:  Entered\n"</span>, 0 );
00630     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle    -&gt; %08lx\n"</span>, LogHandle );
00631     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Context       -&gt; %08lx\n"</span>, Context );
00632 
00633     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00634     Lcb = (<a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>) Context;
00635 
00636     <span class="comment">//</span>
00637     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00638     <span class="comment">//</span>
00639 
00640     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00641 
00642     <span class="comment">//</span>
00643     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00644     <span class="comment">//</span>
00645 
00646     <span class="keywordflow">try</span> {
00647 
00648         <span class="comment">//</span>
00649         <span class="comment">//  Acquire the log file control block for this log file.</span>
00650         <span class="comment">//</span>
00651 
00652         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00653         Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00654 
00655         <span class="comment">//</span>
00656         <span class="comment">//  If the Log file has been closed then refuse access.</span>
00657         <span class="comment">//</span>
00658 
00659         <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00660 
00661             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00662         }
00663 
00664         <span class="comment">//</span>
00665         <span class="comment">//  Check that the client Id is valid.</span>
00666         <span class="comment">//</span>
00667 
00668         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00669 
00670         <span class="comment">//</span>
00671         <span class="comment">//  Check that the context structure is valid.</span>
00672         <span class="comment">//</span>
00673 
00674         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a36">LfsValidateLcb</a>( Lcb, Lch );
00675 
00676         <span class="comment">//</span>
00677         <span class="comment">//  Deallocate the context block.</span>
00678         <span class="comment">//</span>
00679 
00680         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a6">LfsDeallocateLcb</a>( Lfcb, Lcb );
00681 
00682     try_exit:  NOTHING;
00683     } finally {
00684 
00685         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsTerminateLogQuery );
00686 
00687         <span class="comment">//</span>
00688         <span class="comment">//  Release the Lfcb if acquired.</span>
00689         <span class="comment">//</span>
00690 
00691         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00692 
00693         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsTerminateLogQuery:  Exit\n"</span>, 0 );
00694     }
00695 
00696     <span class="keywordflow">return</span>;
00697 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="lfs.h::LfsVerifyLogFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LfsVerifyLogFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>LogFileHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01273">1273</a> of file <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html">lfs/registry.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00583">_LFCB::CurrentOpenLogCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00033">LFS_NTC_LCH</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00035">LFS_NTC_LFCB</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00339">LFS_SIGNATURE_RESTART_PAGE_ULONG</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00129">_LCH::NodeTypeCode</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00307">_LFCB::NodeTypeCode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00305">_LFS_RESTART_PAGE_HEADER::RestartOffset</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00341">_LFCB::SystemPageSize</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01281                    :
01282 
01283     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a client to verify that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume has not been removed
01284     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system and then reattached.  We will verify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> open count on
01285     disk matches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's handle.
01286 
01287 Arguments:
01288 
01289     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
01290                 client.
01291 
01292     LogFileHeader - Pointer to start of log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01293 
01294     Length - Number bytes returned with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> read.
01295 
01296 Return Value:
01297 
01298     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> has not been altered externally, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> we
01299         fail <span class="keywordflow">for</span> any <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a>.
01300 
01301 --*/
01302 
01303 {
01304     BOOLEAN ValidLogFile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01305     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
01306     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
01307 
01308     <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> RestartPage = LogFileHeader;
01309 
01310     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01311 
01312     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
01313 
01314     <span class="comment">//</span>
01315     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
01316     <span class="comment">//</span>
01317 
01318     <span class="keywordflow">if</span> ((Lch == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01319         (Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o0">NodeTypeCode</a> != <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a2">LFS_NTC_LCH</a>) ||
01320         ((Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01321          (Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o0">NodeTypeCode</a> != <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a4">LFS_NTC_LFCB</a>))) {
01322 
01323         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01324     }
01325 
01326     <span class="comment">//</span>
01327     <span class="comment">//  Acquire the log file control block for this log file.</span>
01328     <span class="comment">//</span>
01329 
01330     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
01331     Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
01332 
01333     <span class="comment">//</span>
01334     <span class="comment">//  If the Log file has been closed then return immediately.</span>
01335     <span class="comment">//</span>
01336 
01337     <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01338 
01339         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
01340         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01341     }
01342 
01343     <span class="comment">//</span>
01344     <span class="comment">//  Check that we have at least one page and that the page is valid.</span>
01345     <span class="comment">//</span>
01346 
01347     <span class="keywordflow">if</span> ((Length &gt;= (ULONG) Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o6">SystemPageSize</a>) &amp;&amp;
01348         (*((PULONG) RestartPage) == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a12">LFS_SIGNATURE_RESTART_PAGE_ULONG</a>) &amp;&amp;
01349         ((RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o4">RestartOffset</a> + <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">LFS_RESTART_AREA</a> )) &lt; (ULONG) Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o6">SystemPageSize</a>) &amp;&amp;
01350         ((<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RestartPage, RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o4">RestartOffset</a>, <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> ))-&gt;RestartOpenLogCount == Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o61">CurrentOpenLogCount</a>)) {
01351 
01352         ValidLogFile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01353     }
01354 
01355     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
01356     <span class="keywordflow">return</span> ValidLogFile;
01357 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="lfs.h::LfsWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LfsWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfWriteEntries</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteEntries</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a13">LFS_RECORD_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RecordType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *TransactionId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>UndoNextLsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousLsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UndoRequirement</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00039">39</a> of file <a class="el" href="../../d2/d9/lfs_2write_8c-source.html">lfs/write.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00039">LfsWrite()</a>, <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">LfsWriteLogRecordIntoLogPage()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d3/lfs_8h.html#a28">PLFS_WRITE_ENTRY</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00039">LfsWrite()</a>.
<p>
<pre class="fragment"><div>00053                    :
00054 
00055     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a client to write a log record to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00056     The log record <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> lazy written and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not guaranteed to be on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk
00057     until a subsequent LfsForceWrie or <a class="code" href="../../d6/d3/lfs_8h.html#a51">LfsWriteRestartArea</a> or until
00058     an LfsFlushtoLsn <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> issued withan Lsn greater-than or equal to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn
00059     returned from <span class="keyword">this</span> service.
00060 
00061 Arguments:
00062 
00063     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00064                 client.
00065 
00066     NumberOfWriteEntries - Number of components of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record.
00067 
00068     WriteEntries - Pointer to an array of write entries.
00069 
00070     RecordType - Lfs defined <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <span class="keywordflow">for</span> <span class="keyword">this</span> log record.
00071 
00072     TransactionId - Id value used to group log records by complete transaction.
00073 
00074     UndoNextLsn - Lsn of a previous log record which needs to be undone in
00075                   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event of a client restart.
00076 
00077     PreviousLsn - Lsn of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> immediately previous log record <span class="keywordflow">for</span> <span class="keyword">this</span> client.
00078 
00079     Lsn - Lsn to be associated with <span class="keyword">this</span> log record.
00080 
00081 Return Value:
00082 
00083     BOOLEAN - Advisory, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates that less than 1/4 of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00084         available.
00085 
00086 --*/
00087 
00088 {
00089     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00090 
00091     BOOLEAN LogFileFull = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00092     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00093 
00094     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00095 
00096     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00097 
00098     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsWrite:  Entered\n"</span>, 0 );
00099     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle                -&gt; %08lx\n"</span>, LogHandle );
00100     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"NumberOfWriteEntries      -&gt; %08lx\n"</span>, NumberOfWriteEntries );
00101     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"WriteEntries              -&gt; %08lx\n"</span>, WriteEntries );
00102     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Record Type               -&gt; %08lx\n"</span>, RecordType );
00103     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Transaction Id            -&gt; %08lx\n"</span>, TransactionId );
00104     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"UndoNextLsn (Low)         -&gt; %08lx\n"</span>, UndoNextLsn.LowPart );
00105     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"UndoNextLsn (High)        -&gt; %08lx\n"</span>, UndoNextLsn.HighPart );
00106     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"PreviousLsn (Low)         -&gt; %08lx\n"</span>, PreviousLsn.LowPart );
00107     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"PreviousLsn (High)        -&gt; %08lx\n"</span>, PreviousLsn.HighPart );
00108 
00109     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00110 
00111     <span class="comment">//</span>
00112     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00113     <span class="comment">//</span>
00114 
00115     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00116 
00117     <span class="comment">//</span>
00118     <span class="comment">//  Use a try-except to catch errors.</span>
00119     <span class="comment">//</span>
00120 
00121     <span class="keywordflow">try</span> {
00122 
00123         <span class="comment">//</span>
00124         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00125         <span class="comment">//</span>
00126 
00127         <span class="keywordflow">try</span> {
00128 
00129             <span class="comment">//</span>
00130             <span class="comment">//  Acquire the log file control block for this log file.</span>
00131             <span class="comment">//</span>
00132 
00133             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00134             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00135 
00136             <span class="comment">//</span>
00137             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00138             <span class="comment">//</span>
00139 
00140             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00141 
00142                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00143             }
00144 
00145             <span class="comment">//</span>
00146             <span class="comment">//  Check that the client Id is valid.</span>
00147             <span class="comment">//</span>
00148 
00149             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00150 
00151             <span class="comment">//</span>
00152             <span class="comment">//  Write the log record.</span>
00153             <span class="comment">//</span>
00154 
00155             LogFileFull = <a class="code" href="../../d7/d5/logrcsup_8c.html#a3">LfsWriteLogRecordIntoLogPage</a>( Lfcb,
00156                                                         Lch,
00157                                                         NumberOfWriteEntries,
00158                                                         WriteEntries,
00159                                                         RecordType,
00160                                                         TransactionId,
00161                                                         UndoNextLsn,
00162                                                         PreviousLsn,
00163                                                         UndoRequirement,
00164                                                         FALSE,
00165                                                         Lsn );
00166 
00167         } finally {
00168 
00169             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsWrite );
00170 
00171             <span class="comment">//</span>
00172             <span class="comment">//  Release the log file control block if held.</span>
00173             <span class="comment">//</span>
00174 
00175             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00176 
00177             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)   -&gt; %08lx\n"</span>, Lsn-&gt;LowPart );
00178             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (High)  -&gt; %08lx\n"</span>, Lsn-&gt;HighPart );
00179             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsWrite:  Exit\n"</span>, 0 );
00180         }
00181 
00182     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00183 
00184         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00185     }
00186 
00187     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00188 
00189         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00190     }
00191 
00192     <span class="keywordflow">return</span> LogFileFull;
00193 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="lfs.h::LfsWriteRestartArea" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsWriteRestartArea           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">270</a> of file <a class="el" href="../../d6/d8/restart_8c-source.html">restart.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00210">_LFS_WRITE_ENTRY::Buffer</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00211">_LFS_WRITE_ENTRY::ByteLength</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00436">_LFCB::ClientArray</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00163">_LCH::ClientArrayByteOffset</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00373">_LFS_CLIENT_RECORD::ClientRestartLsn</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d6/d3/lfs_8h.html#a62a32">LfsClientRestart</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00582">LfsSetBaseLsnPriv()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>, <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">LfsWriteLogRecordIntoLogPage()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00147">LfsZeroLsn</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00444">_LFCB::RestartAreaSize</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>.
<p>
<pre class="fragment"><div>00279                    :
00280 
00281     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client to write a restart area to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00282     disk.  This routine will not <span class="keywordflow">return</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client
00283     restart area and all prior Lsn's have been flushed and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfs
00284     restart area on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk has been updated.
00285 
00286     On <span class="keywordflow">return</span>, all log records up to and including 'Lsn' have been flushed
00287     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk.
00288 
00289 Arguments:
00290 
00291     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00292                 client.
00293 
00294     BufferLength - On entry <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user buffer.
00295 
00296     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client restart data resides.
00297 
00298     Lsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn <span class="keywordflow">for</span> <span class="keyword">this</span> write operation.  On input, <span class="keyword">this</span> will be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00299           <span class="keyword">new</span> Base Lsn <span class="keywordflow">for</span> <span class="keyword">this</span> client.
00300 
00301           ****  This was used to prevent adding an interface change to
00302                 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Beta release.
00303 
00304 Return Value:
00305 
00306     None
00307 
00308 --*/
00309 
00310 {
00311     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00312 
00313     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00314 
00315     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00316 
00317     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
00318 
00319     <a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">LFS_WRITE_ENTRY</a> WriteEntry;
00320 
00321     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00322 
00323     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsWriteRestartArea:  Entered\n"</span>, 0 );
00324     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle    -&gt; %08lx\n"</span>, LogHandle );
00325     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer Length -&gt; %08lx\n"</span>, BufferLength );
00326     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer        -&gt; %08lx\n"</span>, Buffer );
00327 
00328     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00329 
00330     <span class="comment">//</span>
00331     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00332     <span class="comment">//</span>
00333 
00334     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">//  Use a try-except to catch errors.</span>
00338     <span class="comment">//</span>
00339 
00340     <span class="keywordflow">try</span> {
00341 
00342         <span class="comment">//</span>
00343         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00344         <span class="comment">//</span>
00345 
00346         <span class="keywordflow">try</span> {
00347 
00348             <span class="comment">//</span>
00349             <span class="comment">//  Acquire the log file control block for this log file.</span>
00350             <span class="comment">//</span>
00351 
00352             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00353             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00354 
00355             <span class="comment">//</span>
00356             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00357             <span class="comment">//</span>
00358 
00359             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00360 
00361                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00362             }
00363 
00364             <span class="comment">//</span>
00365             <span class="comment">//  Check that the client Id is valid.</span>
00366             <span class="comment">//</span>
00367 
00368             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00369 
00370             ClientRecord = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00371                                     Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o6">ClientArrayByteOffset</a>,
00372                                     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00373 
00374             <span class="comment">//</span>
00375             <span class="comment">//  Go ahead and update the Base Lsn in the client area if the value</span>
00376             <span class="comment">//  given is not zero.</span>
00377             <span class="comment">//</span>
00378 
00379             <span class="keywordflow">if</span> ( Lsn-&gt;QuadPart != 0 ) {                                                                                <span class="comment">//**** xxNeqZero( *Lsn )</span>
00380 
00381                 <a class="code" href="../../d5/d9/restart_8c.html#a1">LfsSetBaseLsnPriv</a>( Lfcb,
00382                                    ClientRecord,
00383                                    *Lsn );
00384             }
00385 
00386             <span class="comment">//</span>
00387             <span class="comment">//  Write this restart area as a log record into a log page.</span>
00388             <span class="comment">//</span>
00389 
00390             WriteEntry.<a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html#o0">Buffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00391             WriteEntry.<a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html#o1">ByteLength</a> = BufferLength;
00392 
00393             <a class="code" href="../../d7/d5/logrcsup_8c.html#a3">LfsWriteLogRecordIntoLogPage</a>( Lfcb,
00394                                           Lch,
00395                                           1,
00396                                           &amp;WriteEntry,
00397                                           LfsClientRestart,
00398                                           NULL,
00399                                           LfsZeroLsn,
00400                                           LfsZeroLsn,
00401                                           0,
00402                                           TRUE,
00403                                           Lsn );
00404 
00405             <span class="comment">//</span>
00406             <span class="comment">//  Update the restart area for the client.</span>
00407             <span class="comment">//</span>
00408 
00409             ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a> = *Lsn;
00410 
00411             <span class="comment">//</span>
00412             <span class="comment">//  Write the restart area to the disk.</span>
00413             <span class="comment">//</span>
00414 
00415             <a class="code" href="../../d7/d0/rstrtsup_8c.html#a1">LfsWriteLfsRestart</a>( Lfcb, Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o34">RestartAreaSize</a>, TRUE );
00416 
00417         } finally {
00418 
00419             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsWriteRestartArea );
00420 
00421             <span class="comment">//</span>
00422             <span class="comment">//  Release the log file control block if still held.</span>
00423             <span class="comment">//</span>
00424 
00425             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00426 
00427             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)     -&gt; %08lx\n"</span>, Lsn-&gt;LowPart );
00428             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log (High)    -&gt; %08lx\n"</span>, Lsn-&gt;HighPart );
00429             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsWriteRestartArea:  Exit\n"</span>, 0 );
00430         }
00431 
00432     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00433 
00434         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00435     }
00436 
00437     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00438 
00439         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00440     }
00441 
00442     <span class="keywordflow">return</span>;
00443 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a12" doxytag="lfs.h::LfsZeroLsn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> <a class="el" href="../../d7/d3/lfsdata_8c.html#a4">LfsZeroLsn</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/lfs_8h-source.html#l00147">147</a> of file <a class="el" href="../../d7/d2/lfs_8h-source.html">lfs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00701">LfsQueryLastLsn()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>, and <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:32 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
