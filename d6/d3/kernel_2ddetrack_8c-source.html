<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ddetrack.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ddetrack.c</h1><a href="../../d5/d4/kernel_2ddetrack_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header *******************************</span>
00002 <span class="comment">* Module Name: ddetrack.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module handles tracking of DDE conversations for use in emulating</span>
00007 <span class="comment">* DDE shared memory.</span>
00008 <span class="comment">*</span>
00009 <span class="comment">* History:</span>
00010 <span class="comment">* 9-3-91      sanfords  Created</span>
00011 <span class="comment">* 21-Jan-1992 IanJa     ANSI/Unicode netralized (null op)</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
<a name="l00017"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a6">00017</a> <a class="code" href="../../d6/d4/structtagPUBOBJ.html">PPUBOBJ</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a6">gpPublicObjectList</a>;
00018 
<a name="l00019"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">00019</a> <span class="preprocessor">#define TRACE_DDE(str)          TAGMSG0(DBGTAG_DDE, str)</span>
<a name="l00020"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a1">00020</a> <span class="preprocessor"></span><span class="preprocessor">#define TRACE_DDE1(s, a)        TAGMSG1(DBGTAG_DDE, (s), (a))</span>
<a name="l00021"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a2">00021</a> <span class="preprocessor"></span><span class="preprocessor">#define TRACE_DDE2(s, a, b)     TAGMSG2(DBGTAG_DDE, (s), (a), (b))</span>
<a name="l00022"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a3">00022</a> <span class="preprocessor"></span><span class="preprocessor">#define TRACE_DDE3(s, a, b, c)  TAGMSG3(DBGTAG_DDE, (s), (a), (b), (c))</span>
00023 <span class="preprocessor"></span>
00024 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a20">NewConversation</a>(<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> *ppdcNewClient, <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> *ppdcNewServer,
00025         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndClient, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndServer);
00026 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a21">FindDdeConv</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndProp, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndPartner);
00027 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a22">AddConvProp</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndUs, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndThem, DWORD flags, <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pdcNew,
00028         <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pdcPartner);
<a name="l00029"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a7">00029</a> <a class="code" href="../../d4/d1/userk_8h.html#a931">FNDDERESPONSE</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a7">xxxUnexpectedServerPost</a>;
<a name="l00030"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a8">00030</a> <a class="code" href="../../d4/d1/userk_8h.html#a931">FNDDERESPONSE</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a8">xxxUnexpectedClientPost</a>;
<a name="l00031"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a9">00031</a> <a class="code" href="../../d4/d1/userk_8h.html#a931">FNDDERESPONSE</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a9">xxxAdvise</a>;
<a name="l00032"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a10">00032</a> <a class="code" href="../../d4/d1/userk_8h.html#a931">FNDDERESPONSE</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a10">xxxAdviseAck</a>;
<a name="l00033"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a11">00033</a> <a class="code" href="../../d4/d1/userk_8h.html#a931">FNDDERESPONSE</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a11">xxxAdviseData</a>;
<a name="l00034"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a12">00034</a> <a class="code" href="../../d4/d1/userk_8h.html#a931">FNDDERESPONSE</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a12">xxxAdviseDataAck</a>;
00035 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a23">Unadvise</a>(<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv);
<a name="l00036"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a13">00036</a> <a class="code" href="../../d4/d1/userk_8h.html#a931">FNDDERESPONSE</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a13">xxxUnadviseAck</a>;
00037 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a>(<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv);
<a name="l00038"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a14">00038</a> <a class="code" href="../../d4/d1/userk_8h.html#a931">FNDDERESPONSE</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a14">xxxRequestAck</a>;
<a name="l00039"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a15">00039</a> <a class="code" href="../../d4/d1/userk_8h.html#a931">FNDDERESPONSE</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a15">xxxPoke</a>;
<a name="l00040"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a16">00040</a> <a class="code" href="../../d4/d1/userk_8h.html#a931">FNDDERESPONSE</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a16">xxxPokeAck</a>;
<a name="l00041"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a17">00041</a> <a class="code" href="../../d4/d1/userk_8h.html#a931">FNDDERESPONSE</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a17">xxxExecute</a>;
<a name="l00042"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a18">00042</a> <a class="code" href="../../d4/d1/userk_8h.html#a931">FNDDERESPONSE</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a18">xxxExecuteAck</a>;
00043 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a25">SpontaneousTerminate</a>(PDWORD pmessage, <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv);
<a name="l00044"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a19">00044</a> <a class="code" href="../../d4/d1/userk_8h.html#a931">FNDDERESPONSE</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a19">DupConvTerminate</a>;
00045 
00046 HANDLE <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a26">AnticipatePost</a>(<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv, FNDDERESPONSE fnResponse,
00047         HANDLE hClient, HANDLE hServer, <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo, DWORD flags);
00048 <a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a27">Createpxs</a>(FNDDERESPONSE fnResponse, HANDLE hClient, HANDLE hServer,
00049         <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo, DWORD flags);
00050 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a28">AbnormalDDEPost</a>(<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv, DWORD message);
00051 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a29">xxxCopyDdeIn</a>(HANDLE hSrc, PDWORD pflags, PHANDLE phDirect, <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> *ppi);
00052 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a64">xxxCopyAckIn</a>(PDWORD pmessage, LPARAM *plParam, <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv, <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> *ppIntDdeInfo);
00053 HANDLE <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a31">xxxCopyDDEOut</a>(<a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo, PHANDLE phDirect);
00054 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a32">FreeListAdd</a>(<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv, HANDLE hClient, DWORD flags);
00055 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a33">xxxFreeListFree</a>(<a class="code" href="../../d4/d5/structtagFREELIST.html">PFREELIST</a> pfl);
00056 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a34">PopState</a>(<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv);
00057 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a35">UnlinkConv</a>(<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv);
00058 
00059 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a36">FreeDDEHandle</a>(<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv, HANDLE hClient, DWORD flags);
00060 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a37">ClientFreeDDEHandle</a>(HANDLE hClient, DWORD flags);
00061 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a38">ClientGetDDEFlags</a>(HANDLE hClient, DWORD flags);
00062 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a39">xxxClientCopyDDEIn1</a>(HANDLE hClient, DWORD flags, <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> *ppi);
00063 HANDLE <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a40">xxxClientCopyDDEOut1</a>(<a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo);
00064 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a41">xxxClientCopyDDEOut2</a>(<a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo);
00065 
00066 <a class="code" href="../../d6/d4/structtagPUBOBJ.html">PPUBOBJ</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a42">IsObjectPublic</a>(HANDLE hObj);
00067 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a43">AddPublicObject</a>(UINT format, HANDLE hObj, W32PID pid);
00068 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a44">RemovePublicObject</a>(UINT format, HANDLE hObj);
00069 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a45">GiveObject</a>(UINT format, HANDLE hObj, W32PID pid);
00070 <span class="preprocessor">#if DBG</span>
00071 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a4">ValidatePublicObjectList</a>(VOID);
00072 <span class="preprocessor">#define MSG_SENT    0</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#define MSG_POST    1</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#define MSG_RECV    2</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#define MSG_PEEK    3</span>
00076 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a5">TraceDdeMsg</a>(UINT msg, HWND hwndFrom, HWND hwndTo, UINT code);
00077 <span class="preprocessor">#else</span>
<a name="l00078"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a4">00078</a> <span class="preprocessor"></span><span class="preprocessor">#define ValidatePublicObjectList()</span>
<a name="l00079"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a5">00079</a> <span class="preprocessor"></span><span class="preprocessor">#define TraceDdeMsg(m, h1, h2, c)</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#endif // DBG</span>
00081 <span class="preprocessor"></span>
00082 <span class="comment">/*</span>
00083 <span class="comment"> *  The Big Picture:</span>
00084 <span class="comment"> *</span>
00085 <span class="comment"> *  When a WM_DDE_ACK message is SENT, it implies the begining of a DDE</span>
00086 <span class="comment"> *    Conversation.  The tracking layer creates DDECONV structure for each</span>
00087 <span class="comment"> *    window in volved in the conversation and cross links the structures.</span>
00088 <span class="comment"> *    Thus a unique window pair identifies a conversation.  Each window has</span>
00089 <span class="comment"> *    its DDECONV structure attached to it via a private property.</span>
00090 <span class="comment"> *</span>
00091 <span class="comment"> *  As DDE messages are posted, the tracking layer copies data into the</span>
00092 <span class="comment"> *    CSR server side of USER into a INTDDEINFO structure.  This structure</span>
00093 <span class="comment"> *    contains flags which direct how the data is to be freed when the</span>
00094 <span class="comment"> *    time comes.  This info is placed within an XSTATE structure along</span>
00095 <span class="comment"> *    with context infomation.  A pointer to the XSTATE structure is</span>
00096 <span class="comment"> *    placed in the lParam of the message and the MSB of message is set</span>
00097 <span class="comment"> *    for special processing when the message is recieved on the other side.</span>
00098 <span class="comment"> *</span>
00099 <span class="comment"> *  If the message posted requires a responding message to follow the DDE</span>
00100 <span class="comment"> *    protocol, a XSTATE structure is created and attached to DDECONV</span>
00101 <span class="comment"> *    structure associated with the window that is expected to post the message.</span>
00102 <span class="comment"> *    The XSTATE structure directs the tracking layer so that it knows the</span>
00103 <span class="comment"> *    context of the message when it is posted and also includes any</span>
00104 <span class="comment"> *    information needed for proper freeing of extra DDE data.</span>
00105 <span class="comment"> *</span>
00106 <span class="comment"> *  When the message is extracted from the queue either by a hook, peek,</span>
00107 <span class="comment"> *    or by GetMessage, the id is checked to see if it lies in the special</span>
00108 <span class="comment"> *    range.  If so, the XSTATE structure pointed to by the lParam is</span>
00109 <span class="comment"> *    operated on.  This causes the data to be copied from the CSR server</span>
00110 <span class="comment"> *    side of USER to the target process context.  Once this is done, the</span>
00111 <span class="comment"> *    XSTATE structure may or may not be freed depending on flags and</span>
00112 <span class="comment"> *    the message is restored to a proper DDE message form ready to be</span>
00113 <span class="comment"> *    used by the target process.  Since the message id is changed back,</span>
00114 <span class="comment"> *    subsequent peeks or hooks to the message will not result in duplicated</span>
00115 <span class="comment"> *    processing of the message.</span>
00116 <span class="comment"> *</span>
00117 <span class="comment"> *  During the course of come transactions it becomes evident that an object</span>
00118 <span class="comment"> *    on the opposite side process needs to be freed.  This is done</span>
00119 <span class="comment"> *    asynchronously by inserting the object that needs freeing along with</span>
00120 <span class="comment"> *    associated flags into a freeing list which is tied to the DDECONV</span>
00121 <span class="comment"> *    structure associated with the window on the opposite side.  Whenever</span>
00122 <span class="comment"> *    a DDE messages is posted, this freeing list is checked and processed.</span>
00123 <span class="comment"> *</span>
00124 <span class="comment"> *  When a WM_DDE_TERMINATE message is finally recieved, flags are set</span>
00125 <span class="comment"> *    in the DDECONV structure indicating that the conversation is terminating.</span>
00126 <span class="comment"> *    This alters the way the mapping layer handles DDE messages posted.</span>
00127 <span class="comment"> *    When the responding side posts a WM_DDE_TERMINATE, the DDECONV structures</span>
00128 <span class="comment"> *    and all associated information is freed and unlinked from the windows</span>
00129 <span class="comment"> *    concerned.</span>
00130 <span class="comment"> *</span>
00131 <span class="comment"> *  Should a DDE window get destroyed before proper termination, the</span>
00132 <span class="comment"> *    xxxDDETrackWindowDying function is called to make sure proper termination</span>
00133 <span class="comment"> *    is done prior to the window being destroyed.</span>
00134 <span class="comment"> */</span>
00135 
00136 
00137 <span class="comment">/************************************************************************</span>
00138 <span class="comment">* xxxDDETrackSendHook</span>
00139 <span class="comment">*</span>
00140 <span class="comment">* Called when a DDE message is passed to SendMessage().</span>
00141 <span class="comment">*</span>
00142 <span class="comment">* Returns fSendOk.</span>
00143 <span class="comment">*</span>
00144 <span class="comment">* History:</span>
00145 <span class="comment">* 9-3-91    sanfords    Created</span>
00146 <span class="comment">\***********************************************************************/</span>
<a name="l00147"></a><a class="code" href="../../d4/d1/userk_8h.html#a1873">00147</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1873">xxxDDETrackSendHook</a>(
00148 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndTo,
00149 DWORD message,
00150 WPARAM wParam,
00151 LPARAM lParam)
00152 {
00153     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndServer;
00154     <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pdcNewClient, pdcNewServer;
00155 
00156     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/ddemlsvr_8h.html#a2">MonitorFlags</a> &amp; MF_SENDMSGS) {
00157         DDEML_MSG_HOOK_DATA dmhd;
00158 
00159         dmhd.cbData = 0;    <span class="comment">// Initiate and Ack sent messages have no data.</span>
00160         dmhd.uiLo = LOWORD(lParam);     <span class="comment">// they arn't packed either.</span>
00161         dmhd.uiHi = HIWORD(lParam);
00162         <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a11">xxxMessageEvent</a>(pwndTo, message, wParam, lParam, MF_SENDMSGS, &amp;dmhd);
00163     }
00164 
00165     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;ppi == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a458">GETPWNDPPI</a>(pwndTo)) {
00166         <span class="comment">/*</span>
00167 <span class="comment">         * Skip monitoring of all intra-process conversations.</span>
00168 <span class="comment">         */</span>
00169         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00170     }
00171 
00172     <span class="keywordflow">if</span> (message != WM_DDE_ACK) {
00173         <span class="keywordflow">if</span> (message == WM_DDE_INITIATE) {
00174             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;     <span class="comment">// this is cool</span>
00175         }
00176         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00177     }
00178 
00179     pwndServer = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>((HWND)wParam);
00180     <span class="keywordflow">if</span> (pwndServer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00181         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00182     }
00183 
00184     pdcNewServer = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a21">FindDdeConv</a>(pwndServer, pwndTo);
00185     <span class="keywordflow">if</span> (pdcNewServer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00186         RIPMSG2(RIP_WARNING,
00187                 <span class="stringliteral">"DDE protocol violation - non-unique window pair (%#p:%#p)"</span>,
00188                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndTo), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndServer));
00189         <span class="comment">/*</span>
00190 <span class="comment">         * Duplicate Conversation case:</span>
00191 <span class="comment">         *  Don't allow the ACK to pass, post a terminate to the server</span>
00192 <span class="comment">         *  to shut down the duplicate on his end.</span>
00193 <span class="comment">         */</span>
00194         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a26">AnticipatePost</a>(pdcNewServer, <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a19">DupConvTerminate</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00195         <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwndServer, WM_DDE_TERMINATE, (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndTo), 0);
00196         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00197     }
00198 
00199     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a20">NewConversation</a>(&amp;pdcNewClient, &amp;pdcNewServer, pwndTo, pwndServer)) {
00200         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00201     }
00202 
00203     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a2">TRACE_DDE2</a>(<span class="stringliteral">"%#p-&gt;%#p DDE Conversation started"</span>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndTo), wParam);
00204     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00205 }
00206 
00207 
00208 <span class="comment">/************************************************************************</span>
00209 <span class="comment">* AddConvProp</span>
00210 <span class="comment">*</span>
00211 <span class="comment">* Helper for xxxDDETrackSendHook - associates a new DDECONV struct with</span>
00212 <span class="comment">* a window and initializes it.</span>
00213 <span class="comment">*</span>
00214 <span class="comment">* History:</span>
00215 <span class="comment">* 9-3-91    sanfords    Created</span>
00216 <span class="comment">\***********************************************************************/</span>
<a name="l00217"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a22">00217</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a22">AddConvProp</a>(
00218 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndUs,
00219 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndThem,
00220 DWORD flags,
00221 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pdcNew,
00222 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pdcPartner)
00223 {
00224     <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv;
00225     <a class="code" href="../../d7/d2/structtagDDEIMP.html">PDDEIMP</a> pddei;
00226 
00227     pDdeConv = (<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a>)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwndUs, <a class="code" href="../../d4/d1/userk_8h.html#a476">PROP_DDETRACK</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
00228     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pdcNew-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o1">snext</a>), pDdeConv);
00229     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pdcNew-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a>), pwndUs);
00230     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pdcNew-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>), pwndThem);
00231 
00232     <span class="comment">/*</span>
00233 <span class="comment">     * Assert to catch stress bug.</span>
00234 <span class="comment">     */</span>
00235     UserAssert(pdcPartner != (<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a>)(-1));
00236 
00237     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pdcNew-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>), pdcPartner);
00238     pdcNew-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o6">spxsIn</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00239     pdcNew-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00240     pdcNew-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> = flags;
00241     pddei = (<a class="code" href="../../d7/d2/structtagDDEIMP.html">PDDEIMP</a>)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>((flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a602">CXF_IS_SERVER</a>) ?
00242             pwndThem : pwndUs, <a class="code" href="../../d4/d1/userk_8h.html#a478">PROP_DDEIMP</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
00243     <span class="keywordflow">if</span> (pddei != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {    <span class="comment">// This can be NULL if a bad WOW app has been</span>
00244         pddei-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o3">cRefConv</a>++;  <span class="comment">// allowed through for compatability.</span>
00245     }
00246     pdcNew-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o9">pddei</a> = pddei;
00247 
00248     <a class="code" href="../../d4/d1/userk_8h.html#a112">HMLockObject</a>(pdcNew);         <span class="comment">// lock for property</span>
00249     <a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a0">InternalSetProp</a>(pwndUs, <a class="code" href="../../d4/d1/userk_8h.html#a476">PROP_DDETRACK</a>, pdcNew, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
00250     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00251 }
00252 
00253 
00254 <span class="comment">/************************************************************************</span>
00255 <span class="comment">* UnlinkConv</span>
00256 <span class="comment">*</span>
00257 <span class="comment">* Unlinks a DDECONV structure from the property list it is associated with.</span>
00258 <span class="comment">*</span>
00259 <span class="comment">* returns pDdeConv-&gt;snext</span>
00260 <span class="comment">*</span>
00261 <span class="comment">* History:</span>
00262 <span class="comment">* 9-3-91    sanfords    Created</span>
00263 <span class="comment">\***********************************************************************/</span>
<a name="l00264"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a35">00264</a> <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a35">UnlinkConv</a>(
00265 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
00266 {
00267     <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pdcPrev, pdcT, pDdeConvNext;
00268 
00269     <span class="comment">/*</span>
00270 <span class="comment">     * Already unlinked</span>
00271 <span class="comment">     */</span>
00272     <span class="keywordflow">if</span> (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00273         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00274     }
00275     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a1">TRACE_DDE1</a>(<span class="stringliteral">"UnlinkConv(%#p)"</span>, pDdeConv);
00276 
00277     pdcT = (<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a>)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a>,
00278             <a class="code" href="../../d4/d1/userk_8h.html#a476">PROP_DDETRACK</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
00279     <span class="keywordflow">if</span> (pdcT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00280         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);             <span class="comment">// already unlinked</span>
00281     }
00282 
00283     pdcPrev = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00284     <span class="keywordflow">while</span> (pdcT != pDdeConv) {
00285         pdcPrev = pdcT;
00286         pdcT = pdcT-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o1">snext</a>;
00287         <span class="keywordflow">if</span> (pdcT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00288             <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);        <span class="comment">// already unlinked</span>
00289         }
00290     }
00291 
00292     <span class="keywordflow">if</span> (pdcPrev == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00293         <span class="keywordflow">if</span> (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o1">snext</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00294             <span class="comment">// last one out removes the property</span>
00295             <a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a1">InternalRemoveProp</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a>, <a class="code" href="../../d4/d1/userk_8h.html#a476">PROP_DDETRACK</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
00296         } <span class="keywordflow">else</span> {
00297             <span class="comment">// head conv unlinked - update prop</span>
00298             <a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a0">InternalSetProp</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a>, <a class="code" href="../../d4/d1/userk_8h.html#a476">PROP_DDETRACK</a>, pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o1">snext</a>,
00299                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
00300         }
00301     } <span class="keywordflow">else</span> {
00302         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pdcPrev-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o1">snext</a>), pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o1">snext</a>);
00303     }
00304     pDdeConvNext = <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o1">snext</a>));
00305     <a class="code" href="../../d4/d1/userk_8h.html#a110">HMUnlockObject</a>(pDdeConv);      <span class="comment">// unlock for property detachment</span>
00306     <span class="keywordflow">return</span>(pDdeConvNext);
00307 }
00308 
00309 
00310 <span class="comment">/************************************************************************</span>
00311 <span class="comment">* xxxDDETrackPostHook</span>
00312 <span class="comment">*</span>
00313 <span class="comment">* Hook function for handling posted DDE messages.</span>
00314 <span class="comment">*</span>
00315 <span class="comment">* returns post action code - DO_POST, FAKE_POST, FAIL_POST.</span>
00316 <span class="comment">*</span>
00317 <span class="comment">* History:</span>
00318 <span class="comment">* 9-3-91    sanfords    Created</span>
00319 <span class="comment">\***********************************************************************/</span>
<a name="l00320"></a><a class="code" href="../../d4/d1/userk_8h.html#a1874">00320</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a1874">xxxDDETrackPostHook</a>(
00321 PUINT pmessage,
00322 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndTo,
00323 WPARAM wParam,
00324 LPARAM *plParam,
00325 BOOL fSent)
00326 {
00327     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFrom;
00328     <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00329     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRet;
00330     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpDdeConv;
00331     <a class="code" href="../../d4/d5/structtagFREELIST.html">PFREELIST</a> pfl, *ppfl;
00332     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> MFlag;
00333 
00334     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndTo);
00335 
00336     MFlag = fSent ? MF_SENDMSGS : MF_POSTMSGS;
00337     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/ddemlsvr_8h.html#a2">MonitorFlags</a> &amp; MFlag) {
00338         DDEML_MSG_HOOK_DATA dmhd;
00339 
00340         <span class="keywordflow">switch</span> (*pmessage ) {
00341         <span class="keywordflow">case</span> WM_DDE_DATA:
00342         <span class="keywordflow">case</span> WM_DDE_POKE:
00343         <span class="keywordflow">case</span> WM_DDE_ADVISE:
00344         <span class="keywordflow">case</span> WM_DDE_EXECUTE:
00345         <span class="keywordflow">case</span> WM_DDE_ACK:
00346             <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a14">ClientGetDDEHookData</a>(*pmessage, *plParam, &amp;dmhd);
00347             <span class="keywordflow">break</span>;
00348 
00349         <span class="keywordflow">default</span>:
00350             <span class="comment">// WM_DDE_REQUEST</span>
00351             <span class="comment">// WM_DDE_TERMINATE</span>
00352             <span class="comment">// WM_DDE_UNADVISE</span>
00353             dmhd.cbData = 0;
00354             dmhd.uiLo = LOWORD(*plParam);
00355             dmhd.uiHi = HIWORD(*plParam);
00356         }
00357         <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a11">xxxMessageEvent</a>(pwndTo, *pmessage, wParam, *plParam, MFlag,
00358                 &amp;dmhd);
00359     }
00360 
00361     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;ppi == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a458">GETPWNDPPI</a>(pwndTo)) {
00362         <span class="comment">/*</span>
00363 <span class="comment">         * skip all intra-process conversation tracking.</span>
00364 <span class="comment">         */</span>
00365         dwRet = <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>;
00366         <span class="keywordflow">goto</span> Exit;
00367     }
00368 
00369     <span class="keywordflow">if</span> (*pmessage == WM_DDE_INITIATE) {
00370         RIPMSG2(RIP_WARNING,
00371                 <span class="stringliteral">"DDE Post failed (%#p:%#p) - WM_DDE_INITIATE posted"</span>,
00372                 wParam, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndTo));
00373         dwRet = <a class="code" href="../../d6/d4/ddetrack_8h.html#a17">FAIL_POST</a>;
00374         <span class="keywordflow">goto</span> Exit;
00375     }
00376 
00377     pwndFrom = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>((HWND)wParam);
00378     <span class="keywordflow">if</span> (pwndFrom == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00379         <span class="comment">/*</span>
00380 <span class="comment">         * This is a post AFTER a window has been destroyed.  This is not</span>
00381 <span class="comment">         * expected except in the case where xxxDdeTrackWindowDying()</span>
00382 <span class="comment">         * is posting a cleanup terminate.</span>
00383 <span class="comment">         */</span>
00384         dwRet = *pmessage == WM_DDE_TERMINATE ? <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a> : <a class="code" href="../../d6/d4/ddetrack_8h.html#a18">FAKE_POST</a>;
00385         <span class="keywordflow">goto</span> Exit;
00386     }
00387 
00388     <span class="comment">/*</span>
00389 <span class="comment">     * locate conversation info.</span>
00390 <span class="comment">     */</span>
00391     pDdeConv = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a21">FindDdeConv</a>(pwndFrom, pwndTo);
00392     <span class="keywordflow">if</span> (pDdeConv == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00393         <span class="keywordflow">if</span> (*pmessage != WM_DDE_TERMINATE &amp;&amp;
00394                 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndFrom)-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) &amp;&amp;
00395                 (pwndTo-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk == pwndFrom-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk)) {
00396             <span class="comment">/*</span>
00397 <span class="comment">             * If a WOW app bypasses initiates and posts directly to</span>
00398 <span class="comment">             * a window on the same desktop, let it sneak by here.</span>
00399 <span class="comment">             *</span>
00400 <span class="comment">             * This allows some evil apps such as OpenEngine and CA-Cricket</span>
00401 <span class="comment">             * to get away with murder.</span>
00402 <span class="comment">             *</span>
00403 <span class="comment">             * TERMINATES out of the blue however may be due to an app</span>
00404 <span class="comment">             * posting its WM_DDE_TERMINATE after it has destroyed its</span>
00405 <span class="comment">             * window.  Since window destruction would have generated the</span>
00406 <span class="comment">             * TERMINATE already, don't let it through here.</span>
00407 <span class="comment">             */</span>
00408             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a20">NewConversation</a>(&amp;pDdeConv, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pwndFrom, pwndTo);
00409         }
00410         <span class="keywordflow">if</span> (pDdeConv == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00411             RIPMSG2(RIP_VERBOSE, <span class="stringliteral">"Can't find DDE conversation for (%#p:%#p)."</span>,
00412                     wParam, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndTo));
00413             dwRet = *pmessage == WM_DDE_TERMINATE ? <a class="code" href="../../d6/d4/ddetrack_8h.html#a18">FAKE_POST</a> : <a class="code" href="../../d6/d4/ddetrack_8h.html#a17">FAIL_POST</a>;
00414             <span class="keywordflow">goto</span> Exit;
00415         }
00416     }
00417 
00418     <span class="keywordflow">if</span> (fSent &amp;&amp; pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00419         <span class="comment">/*</span>
00420 <span class="comment">         * Sent DDE messages will not work if any posted DDE messages are</span>
00421 <span class="comment">         * in the queue because this will violate the message ordering rule.</span>
00422 <span class="comment">         */</span>
00423         RIPMSG0(RIP_VERBOSE,
00424                 <span class="stringliteral">"Sent DDE message failed - queue contains a previous post."</span>);
00425         dwRet = <a class="code" href="../../d6/d4/ddetrack_8h.html#a17">FAIL_POST</a>;
00426         <span class="keywordflow">goto</span> Exit;
00427     }
00428 
00429     <span class="comment">/*</span>
00430 <span class="comment">     * The tracking layer never did allow multiple threads to handle</span>
00431 <span class="comment">     * the same DDE conversation but win95 shipped and some apps</span>
00432 <span class="comment">     * got out there that did just this.  We will let it slide for</span>
00433 <span class="comment">     * 4.0 apps only so that when they rev their app, they will see</span>
00434 <span class="comment">     * that they were wrong.</span>
00435 <span class="comment">     */</span>
00436     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv) &amp;&amp;
00437             <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;dwExpWinVer != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) {
00438         RIPERR0(ERROR_WINDOW_OF_OTHER_THREAD,
00439                 RIP_ERROR,
00440                 <span class="stringliteral">"Posting DDE message from wrong thread!"</span>);
00441 
00442         dwRet = <a class="code" href="../../d6/d4/ddetrack_8h.html#a17">FAIL_POST</a>;
00443         <span class="keywordflow">goto</span> Exit;
00444     }
00445 
00446     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pDdeConv, &amp;tlpDdeConv);
00447 
00448     <span class="comment">/*</span>
00449 <span class="comment">     * If the handle we're using is in the free list, remove it</span>
00450 <span class="comment">     */</span>
00451     ppfl = &amp;pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o7">pfl</a>;
00452     <span class="keywordflow">while</span> (*ppfl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00453         <span class="keywordflow">if</span> ((*ppfl)-&gt;h == (HANDLE)*plParam) {
00454             <span class="comment">/* Let's stop to check this out */</span>
00455             UserAssert((*ppfl)-&gt;h == (HANDLE)*plParam);
00456             *ppfl = (*ppfl)-&gt;<a class="code" href="../../d4/d5/structtagFREELIST.html#o0">next</a>;
00457         } <span class="keywordflow">else</span> {
00458             ppfl = &amp;(*ppfl)-&gt;<a class="code" href="../../d4/d5/structtagFREELIST.html#o0">next</a>;
00459         }
00460     }
00461     pfl = pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o7">pfl</a>;
00462     pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o7">pfl</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00463     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a33">xxxFreeListFree</a>(pfl);
00464 
00465     <span class="keywordflow">if</span> (*pmessage != WM_DDE_TERMINATE &amp;&amp;
00466             (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a603">CXF_TERMINATE_POSTED</a> | <a class="code" href="../../d4/d1/userk_8h.html#a604">CXF_PARTNER_WINDOW_DIED</a>))) {
00467         dwRet = <a class="code" href="../../d6/d4/ddetrack_8h.html#a18">FAKE_POST</a>;
00468         <span class="keywordflow">goto</span> UnlockExit;
00469     }
00470 
00471     <span class="keywordflow">if</span> (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00472         <span class="keywordflow">if</span> (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a602">CXF_IS_SERVER</a>) {
00473             dwRet = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a51">xxxUnexpectedServerPost</a>((PDWORD)pmessage, plParam, pDdeConv);
00474         } <span class="keywordflow">else</span> {
00475             dwRet = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a52">xxxUnexpectedClientPost</a>((PDWORD)pmessage, plParam, pDdeConv);
00476         }
00477     } <span class="keywordflow">else</span> {
00478         dwRet = (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o2">fnResponse</a>)(pmessage, plParam, pDdeConv);
00479     }
00480 
00481 UnlockExit:
00482 
00483     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpDdeConv);
00484 
00485 Exit:
00486 
00487     <span class="keywordflow">if</span> (dwRet == <a class="code" href="../../d6/d4/ddetrack_8h.html#a18">FAKE_POST</a> &amp;&amp; !((<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>())-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>)) {
00488         <span class="comment">/*</span>
00489 <span class="comment">         * We faked the post so do a client side cleanup here so that we</span>
00490 <span class="comment">         * don't make it appear there is a leak in the client app.</span>
00491 <span class="comment">         */</span>
00492         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags = <a class="code" href="../../d6/d4/ddetrack_8h.html#a15">XS_DUMPMSG</a>;
00493         <span class="comment">/*</span>
00494 <span class="comment">         * The XS_DUMPMSG tells FreeDDEHandle to also free the atoms</span>
00495 <span class="comment">         * associated with the data - since a faked post would make the app</span>
00496 <span class="comment">         * think that the receiver was going to cleanup the atoms.</span>
00497 <span class="comment">         * It also tells FreeDDEHandle to pay attention to the</span>
00498 <span class="comment">         * fRelease bit when freeing the data - this way, loaned data</span>
00499 <span class="comment">         * won't be destroyed.</span>
00500 <span class="comment">         */</span>
00501 
00502         <span class="keywordflow">switch</span> (*pmessage &amp; 0xFFFF) {
00503         <span class="keywordflow">case</span> WM_DDE_UNADVISE:
00504         <span class="keywordflow">case</span> WM_DDE_REQUEST:
00505             <span class="keywordflow">goto</span> DumpMsg;
00506 
00507         <span class="keywordflow">case</span> WM_DDE_ACK:
00508             flags |= <a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a>;
00509             <span class="keywordflow">goto</span> DumpMsg;
00510 
00511         <span class="keywordflow">case</span> WM_DDE_ADVISE:
00512             flags |= <a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a> | <a class="code" href="../../d6/d4/ddetrack_8h.html#a8">XS_HIHANDLE</a>;
00513             <span class="keywordflow">goto</span> DumpMsg;
00514 
00515         <span class="keywordflow">case</span> WM_DDE_DATA:
00516         <span class="keywordflow">case</span> WM_DDE_POKE:
00517             flags |= <a class="code" href="../../d6/d4/ddetrack_8h.html#a1">XS_DATA</a> | <a class="code" href="../../d6/d4/ddetrack_8h.html#a7">XS_LOHANDLE</a> | <a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a>;
00518             <span class="keywordflow">goto</span> DumpMsg;
00519 
00520         <span class="keywordflow">case</span> WM_DDE_EXECUTE:
00521             flags |= <a class="code" href="../../d6/d4/ddetrack_8h.html#a11">XS_EXECUTE</a>;
00522             <span class="comment">// fall through</span>
00523 DumpMsg:
00524             <span class="keywordflow">if</span> (pDdeConv != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00525                 <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxDdeTrackPostHook: dumping message..."</span>);
00526                 <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a36">FreeDDEHandle</a>(pDdeConv, (HANDLE)*plParam, flags);
00527                 dwRet = <a class="code" href="../../d6/d4/ddetrack_8h.html#a20">FAILNOFREE_POST</a>;
00528             }
00529         }
00530     }
00531 <span class="preprocessor">#if DBG</span>
00532 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (fSent) {
00533         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a5">TraceDdeMsg</a>(*pmessage, (HWND)wParam, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndTo), MSG_SENT);
00534     } <span class="keywordflow">else</span> {
00535         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a5">TraceDdeMsg</a>(*pmessage, (HWND)wParam, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndTo), MSG_POST);
00536     }
00537     <span class="keywordflow">if</span> (dwRet == <a class="code" href="../../d6/d4/ddetrack_8h.html#a18">FAKE_POST</a>) {
00538         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"...FAKED!"</span>);
00539     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwRet == <a class="code" href="../../d6/d4/ddetrack_8h.html#a17">FAIL_POST</a>) {
00540         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"...FAILED!"</span>);
00541     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwRet == <a class="code" href="../../d6/d4/ddetrack_8h.html#a20">FAILNOFREE_POST</a>) {
00542         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"...FAILED, DATA FREED!"</span>);
00543     }
00544 <span class="preprocessor">#endif // DBG</span>
00545 <span class="preprocessor"></span>    <span class="keywordflow">return</span>(dwRet);
00546 }
00547 
<a name="l00548"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a48">00548</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a48">xxxCleanupDdeConv</a>(
00549 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndProp)
00550 {
00551     <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv;
00552 
00553 Restart:
00554 
00555     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00556 
00557     pDdeConv = (<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a>)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwndProp, <a class="code" href="../../d4/d1/userk_8h.html#a476">PROP_DDETRACK</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
00558     
00559     <span class="keywordflow">while</span> (pDdeConv != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00560         <span class="keywordflow">if</span> ((pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a602">CXF_IS_SERVER</a> | <a class="code" href="../../d4/d1/userk_8h.html#a603">CXF_TERMINATE_POSTED</a> | <a class="code" href="../../d4/d1/userk_8h.html#a604">CXF_PARTNER_WINDOW_DIED</a>))
00561                 == (<a class="code" href="../../d4/d1/userk_8h.html#a602">CXF_IS_SERVER</a> | <a class="code" href="../../d4/d1/userk_8h.html#a603">CXF_TERMINATE_POSTED</a> | <a class="code" href="../../d4/d1/userk_8h.html#a604">CXF_PARTNER_WINDOW_DIED</a>) &amp;&amp;
00562             
00563             (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a603">CXF_TERMINATE_POSTED</a>)) {
00564             
00565             <span class="comment">/*</span>
00566 <span class="comment">             * clean up client side objects on this side</span>
00567 <span class="comment">             */</span>
00568             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fUnlockDdeConv;
00569             <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpDdeConv;
00570 
00571             RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"xxxCleanupDdeConv %p"</span>, pDdeConv);
00572 
00573             fUnlockDdeConv = (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o7">pfl</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00574             <span class="keywordflow">if</span> (fUnlockDdeConv) {
00575                 <a class="code" href="../../d4/d5/structtagFREELIST.html">PFREELIST</a> pfl;
00576 
00577                 <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pDdeConv, &amp;tlpDdeConv);
00578 
00579                 pfl = pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o7">pfl</a>;
00580                 pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o7">pfl</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00581                 <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a33">xxxFreeListFree</a>(pfl);
00582             }
00583 
00584             <a class="code" href="../../d4/d1/userk_8h.html#a1878">FreeDdeConv</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>);
00585             <a class="code" href="../../d4/d1/userk_8h.html#a1878">FreeDdeConv</a>(pDdeConv);
00586 
00587             <span class="keywordflow">if</span> (fUnlockDdeConv) {
00588                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpDdeConv);
00589             }
00590             
00591             <span class="comment">/*</span>
00592 <span class="comment">             * Take it back from the top. The list might have changed</span>
00593 <span class="comment">             * if we left the critical section</span>
00594 <span class="comment">             */</span>
00595             <span class="keywordflow">goto</span> Restart;
00596         }
00597         
00598         pDdeConv = pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o1">snext</a>;
00599     }
00600 }
00601 
00602 
00603 <span class="comment">/************************************************************************</span>
00604 <span class="comment">* xxxDDETrackGetMessageHook</span>
00605 <span class="comment">*</span>
00606 <span class="comment">* This routine is used to complete an inter-process copy from the</span>
00607 <span class="comment">* CSRServer context to the target context.  pmsg-&gt;lParam is a</span>
00608 <span class="comment">* pxs that is used to obtain the pIntDdeInfo needed to</span>
00609 <span class="comment">* complete the copy.  The pxs is either filled with the target side</span>
00610 <span class="comment">* direct handle or is freed depending on the message and its context.</span>
00611 <span class="comment">*</span>
00612 <span class="comment">* The XS_FREEPXS bit of the flags field of the pxs tells this function</span>
00613 <span class="comment">* to free the pxs when done.</span>
00614 <span class="comment">*</span>
00615 <span class="comment">* History:</span>
00616 <span class="comment">* 9-3-91    sanfords    Created</span>
00617 <span class="comment">\***********************************************************************/</span>
<a name="l00618"></a><a class="code" href="../../d4/d1/userk_8h.html#a1876">00618</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1876">xxxDDETrackGetMessageHook</a>(
00619 PMSG pmsg)
00620 {
00621     <a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a> pxs;
00622     HANDLE hDirect;
00623     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags;
00624     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fUnlockDdeConv;
00625     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpDdeConv, tlpxs;
00626 
00627     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a5">TraceDdeMsg</a>(pmsg-&gt;message, (HWND)pmsg-&gt;wParam, pmsg-&gt;hwnd, MSG_RECV);
00628 
00629     <span class="keywordflow">if</span> (pmsg-&gt;message == WM_DDE_TERMINATE) {
00630         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFrom, pwndTo;
00631         <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv;
00632 
00633         pwndTo = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(pmsg-&gt;hwnd);
00634         
00635         <span class="comment">/*</span>
00636 <span class="comment">         * We should get the pwnd even if the partner is destroyed in order</span>
00637 <span class="comment">         * to clean up the DDE objects now.  Exiting now would work, but would</span>
00638 <span class="comment">         * leave the conversation objects locked and present until the To window</span>
00639 <span class="comment">         * gets destroyed, which seems excessive.</span>
00640 <span class="comment">         */</span>
00641         pwndFrom = <a class="code" href="../../d4/d1/userk_8h.html#a99">RevalidateCatHwnd</a>((HWND)pmsg-&gt;wParam);
00642         
00643         <span class="keywordflow">if</span> (pwndTo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00644             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"TERMINATE ignored, invalid window(s)."</span>);
00645             <span class="keywordflow">return</span>;
00646         
00647         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pwndFrom == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00648             
00649 CleanupAndExit:            
00650             <span class="comment">/*</span>
00651 <span class="comment">             * Do this only for appcompat</span>
00652 <span class="comment">             */</span>
00653             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a35">GetAppCompatFlags2</a>(VERMAX) &amp; GACF2_DDE) {
00654                 <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a48">xxxCleanupDdeConv</a>(pwndTo);
00655             } <span class="keywordflow">else</span> {
00656                 <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"TERMINATE ignored, invalid window(s)."</span>);
00657             }
00658             <span class="keywordflow">return</span>;
00659         }
00660         
00661         <span class="comment">/*</span>
00662 <span class="comment">         * locate conversation info.</span>
00663 <span class="comment">         */</span>
00664         pDdeConv = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a21">FindDdeConv</a>(pwndTo, pwndFrom);
00665         <span class="keywordflow">if</span> (pDdeConv == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00666             <span class="comment">/*</span>
00667 <span class="comment">             * Must be a harmless extra terminate.</span>
00668 <span class="comment">             */</span>
00669             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"TERMINATE ignored, conversation not found."</span>);
00670             <span class="keywordflow">return</span>;
00671         }
00672 
00673         <span class="keywordflow">if</span> (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a603">CXF_TERMINATE_POSTED</a> &amp;&amp;
00674                 pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a603">CXF_TERMINATE_POSTED</a>) {
00675 
00676             <span class="comment">/*</span>
00677 <span class="comment">             * clean up client side objects on this side</span>
00678 <span class="comment">             */</span>
00679             fUnlockDdeConv = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00680             <span class="keywordflow">if</span> (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o7">pfl</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00681                 <a class="code" href="../../d4/d5/structtagFREELIST.html">PFREELIST</a> pfl;
00682 
00683                 fUnlockDdeConv = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00684                 <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pDdeConv, &amp;tlpDdeConv);
00685                 pfl = pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o7">pfl</a>;
00686                 pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o7">pfl</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00687                 <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a33">xxxFreeListFree</a>(pfl);
00688             }
00689 
00690             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a2">TRACE_DDE2</a>(<span class="stringliteral">"DDE conversation (%#p:%#p) closed"</span>,
00691                     (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a602">CXF_IS_SERVER</a>) ? pmsg-&gt;wParam : (ULONG_PTR)pmsg-&gt;hwnd,
00692                     (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a602">CXF_IS_SERVER</a>) ? (ULONG_PTR)pmsg-&gt;hwnd : pmsg-&gt;wParam);
00693 
00694             <a class="code" href="../../d4/d1/userk_8h.html#a1878">FreeDdeConv</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>);
00695             <a class="code" href="../../d4/d1/userk_8h.html#a1878">FreeDdeConv</a>(pDdeConv);
00696 
00697             <span class="keywordflow">if</span> (fUnlockDdeConv) {
00698                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpDdeConv);
00699             }
00700         }
00701 
00702         <span class="keywordflow">goto</span> CleanupAndExit;
00703     }
00704 
00705     pxs = (<a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a>)<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>((HANDLE)pmsg-&gt;lParam, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a247">TYPE_DDEXACT</a>);
00706     <span class="keywordflow">if</span> (pxs == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00707         <span class="comment">/*</span>
00708 <span class="comment">         * The posting window has died and the pxs was freed so this</span>
00709 <span class="comment">         * message shouldn't be bothered with...map to WM_NULL.</span>
00710 <span class="comment">         */</span>
00711         pmsg-&gt;lParam = 0;
00712         pmsg-&gt;message = WM_NULL;
00713         <span class="keywordflow">return</span>;
00714     }
00715     flags = pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a>;
00716 
00717     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pxs, &amp;tlpxs);
00718     pmsg-&gt;lParam = (LPARAM)<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a31">xxxCopyDDEOut</a>(pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o5">pIntDdeInfo</a>, &amp;hDirect);
00719     <span class="keywordflow">if</span> (pmsg-&gt;lParam == (LPARAM)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00720         <span class="comment">/*</span>
00721 <span class="comment">         * Turn this message into a terminate - we failed to copy the</span>
00722 <span class="comment">         * message data out which implies we are too low on memory</span>
00723 <span class="comment">         * to continue the conversation.  Shut it down now before</span>
00724 <span class="comment">         * other problems pop up that this failure will cause.</span>
00725 <span class="comment">         */</span>
00726         pmsg-&gt;message = WM_DDE_TERMINATE;
00727         RIPMSG0(RIP_WARNING, <span class="stringliteral">"DDETrack: couldn't copy data out, terminate faked."</span>);
00728     }
00729     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpxs) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00730         <span class="keywordflow">return</span>;
00731     }
00732 
00733     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d6/d4/ddetrack_8h.html#a9">XS_FREEPXS</a>) {
00734         <a class="code" href="../../d4/d1/userk_8h.html#a1875">FreeDdeXact</a>(pxs);
00735         <span class="keywordflow">return</span>;
00736     }
00737 
00738     <span class="comment">/*</span>
00739 <span class="comment">     * The only reason XS_FREEPXS isn't set is because we don't know which</span>
00740 <span class="comment">     * side frees the data till an ACK comes back, thus one of the client</span>
00741 <span class="comment">     * handles in pxs is already set via xxxDDETrackPostHook().  The one thats</span>
00742 <span class="comment">     * not yet set gets set here.</span>
00743 <span class="comment">     */</span>
00744 
00745     <span class="keywordflow">if</span> (pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o3">hClient</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00746         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a1">TRACE_DDE1</a>(<span class="stringliteral">"Saving %#p into hClient"</span>, hDirect);
00747         pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o3">hClient</a> = hDirect;
00748     } <span class="keywordflow">else</span> {
00749         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a1">TRACE_DDE1</a>(<span class="stringliteral">"Saving %#p into hServer."</span>, hDirect);
00750         pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o4">hServer</a> = hDirect;
00751     }
00752     <span class="keywordflow">return</span>;
00753 }
00754 
00755 
00756 
00757 <span class="comment">/************************************************************************</span>
00758 <span class="comment">* xxxDDETrackWindowDying</span>
00759 <span class="comment">*</span>
00760 <span class="comment">* Called when a window with PROP_DDETRACK is destroyed.</span>
00761 <span class="comment">*</span>
00762 <span class="comment">* This posts a terminate to the partner window and sets up for proper</span>
00763 <span class="comment">* terminate post fake from other end.</span>
00764 <span class="comment">*</span>
00765 <span class="comment">* History:</span>
00766 <span class="comment">* 9-3-91    sanfords    Created</span>
00767 <span class="comment">\***********************************************************************/</span>
<a name="l00768"></a><a class="code" href="../../d4/d1/userk_8h.html#a1877">00768</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1877">xxxDDETrackWindowDying</a>(
00769 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00770 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
00771 {
00772     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpDdeConv, tlpDdeConvNext;
00773 
00774     UNREFERENCED_PARAMETER(pwnd);
00775 
00776     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00777     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pDdeConv);
00778 
00779     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a2">TRACE_DDE2</a>(<span class="stringliteral">"xxxDDETrackWindowDying(%#p, %#p)"</span>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwnd), pDdeConv);
00780 
00781     <span class="keywordflow">while</span> (pDdeConv != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00782 
00783         <a class="code" href="../../d4/d5/structtagFREELIST.html">PFREELIST</a> pfl;
00784 
00785         <span class="comment">/*</span>
00786 <span class="comment">         * If there are any active conversations for this window</span>
00787 <span class="comment">         * start termination if not already started.</span>
00788 <span class="comment">         */</span>
00789         <span class="keywordflow">if</span> (!(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a603">CXF_TERMINATE_POSTED</a>)) {
00790             <span class="comment">/*</span>
00791 <span class="comment">             * Win9x doesn't do any tracking. This breaks some apps that</span>
00792 <span class="comment">             *  destroy the window first and then post the terminate. The</span>
00793 <span class="comment">             *  other side gets two terminates.</span>
00794 <span class="comment">             */</span>
00795             <span class="keywordflow">if</span> (!(GACF2_NODDETRKDYING &amp; <a class="code" href="../../d6/d3/queue_8c.html#a35">GetAppCompatFlags2</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>))
00796                 || (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00797                 || !(GACF2_NODDETRKDYING
00798                         &amp; <a class="code" href="../../d4/d1/userk_8h.html#a1823">GetAppCompatFlags2ForPti</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>))) {
00799 
00800                 <span class="comment">/*</span>
00801 <span class="comment">                 * CXF_TERMINATE_POSTED would have been set if the window had died.</span>
00802 <span class="comment">                 */</span>
00803                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>, WM_DDE_TERMINATE,
00804                         (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a>), 0);
00805                 <span class="comment">// pDdeConv-&gt;flags |= CXF_TERMINATE_POSTED;  set by PostHookProc</span>
00806             } <span class="keywordflow">else</span> {
00807                 RIPMSG2(RIP_WARNING, <span class="stringliteral">"xxxDDETrackWindowDying(GACF2_NODDETRKDYING) not posting terminate from %#p to %#p\r\n"</span>,
00808                         pwnd, pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>);
00809             }
00810         }
00811 
00812         <span class="comment">/*</span>
00813 <span class="comment">         * now fake that the other side already posted a terminate since</span>
00814 <span class="comment">         * we will be gone.</span>
00815 <span class="comment">         */</span>
00816         pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> |=
00817                 <a class="code" href="../../d4/d1/userk_8h.html#a603">CXF_TERMINATE_POSTED</a> | <a class="code" href="../../d4/d1/userk_8h.html#a604">CXF_PARTNER_WINDOW_DIED</a>;
00818 
00819         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o1">snext</a>, &amp;tlpDdeConvNext);
00820         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pDdeConv, &amp;tlpDdeConv);
00821 
00822         pfl = pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o7">pfl</a>;
00823         pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o7">pfl</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00824 
00825         <span class="keywordflow">if</span> (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a604">CXF_PARTNER_WINDOW_DIED</a>) {
00826 
00827             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpDdeConv);
00828             <span class="comment">/*</span>
00829 <span class="comment">             * he's already gone, free up conversation tracking data</span>
00830 <span class="comment">             */</span>
00831             <a class="code" href="../../d4/d1/userk_8h.html#a1878">FreeDdeConv</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>);
00832             <a class="code" href="../../d4/d1/userk_8h.html#a1878">FreeDdeConv</a>(pDdeConv);
00833         } <span class="keywordflow">else</span> {
00834             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a35">UnlinkConv</a>(pDdeConv);
00835             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpDdeConv);
00836         }
00837         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a33">xxxFreeListFree</a>(pfl);
00838 
00839         pDdeConv = <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpDdeConvNext);
00840     }
00841 }
00842 
00843 
00844 
00845 <span class="comment">/************************************************************************</span>
00846 <span class="comment">* xxxUnexpectedServerPost</span>
00847 <span class="comment">*</span>
00848 <span class="comment">* Handles Server DDE messages not anticipated. (ie spontaneous or abnormal)</span>
00849 <span class="comment">*</span>
00850 <span class="comment">* History:</span>
00851 <span class="comment">* 9-3-91    sanfords    Created</span>
00852 <span class="comment">\***********************************************************************/</span>
<a name="l00853"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a51">00853</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a51">xxxUnexpectedServerPost</a>(
00854 PDWORD pmessage,
00855 LPARAM *plParam,
00856 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
00857 {
00858     <span class="keywordflow">switch</span> (*pmessage) {
00859     <span class="keywordflow">case</span> WM_DDE_TERMINATE:
00860         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a25">SpontaneousTerminate</a>(pmessage, pDdeConv));
00861 
00862     <span class="keywordflow">case</span> WM_DDE_DATA:
00863         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a55">xxxAdviseData</a>(pmessage, plParam, pDdeConv));
00864 
00865     <span class="keywordflow">case</span> WM_DDE_ACK:
00866 
00867         <span class="comment">/*</span>
00868 <span class="comment">         * Could be an extra NACK due to timeout problems, just fake it.</span>
00869 <span class="comment">         */</span>
00870         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxUnexpectedServerPost: dumping ACK data..."</span>);
00871         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a36">FreeDDEHandle</a>(pDdeConv, (HANDLE)*plParam, <a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a>);
00872         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d4/ddetrack_8h.html#a20">FAILNOFREE_POST</a>);
00873 
00874     <span class="keywordflow">case</span> WM_DDE_ADVISE:
00875     <span class="keywordflow">case</span> WM_DDE_UNADVISE:
00876     <span class="keywordflow">case</span> WM_DDE_REQUEST:
00877     <span class="keywordflow">case</span> WM_DDE_POKE:
00878     <span class="keywordflow">case</span> WM_DDE_EXECUTE:
00879         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a28">AbnormalDDEPost</a>(pDdeConv, *pmessage));
00880     }
00881     <span class="keywordflow">return</span> 0;
00882 }
00883 
00884 
00885 
00886 <span class="comment">/************************************************************************</span>
00887 <span class="comment">* xxxUnexpectedClientPost</span>
00888 <span class="comment">*</span>
00889 <span class="comment">*</span>
00890 <span class="comment">* Handles Client DDE messages not anticipated. (ie spontaneous or abnormal)</span>
00891 <span class="comment">*</span>
00892 <span class="comment">* History:</span>
00893 <span class="comment">* 9-3-91    sanfords    Created</span>
00894 <span class="comment">\***********************************************************************/</span>
<a name="l00895"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a52">00895</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a52">xxxUnexpectedClientPost</a>(
00896 PDWORD pmessage,
00897 LPARAM *plParam,
00898 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
00899 {
00900     <span class="keywordflow">switch</span> (*pmessage) {
00901     <span class="keywordflow">case</span> WM_DDE_TERMINATE:
00902         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a25">SpontaneousTerminate</a>(pmessage, pDdeConv));
00903 
00904     <span class="keywordflow">case</span> WM_DDE_ACK:
00905 
00906         <span class="comment">/*</span>
00907 <span class="comment">         * Could be an extra NACK due to timeout problems, just fake it.</span>
00908 <span class="comment">         */</span>
00909         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxUnexpectedClientPost: dumping ACK data..."</span>);
00910         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a36">FreeDDEHandle</a>(pDdeConv, (HANDLE)*plParam, <a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a>);
00911         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d4/ddetrack_8h.html#a20">FAILNOFREE_POST</a>);
00912 
00913     <span class="keywordflow">case</span> WM_DDE_DATA:
00914         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a28">AbnormalDDEPost</a>(pDdeConv, *pmessage));
00915 
00916     <span class="keywordflow">case</span> WM_DDE_ADVISE:
00917         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a53">xxxAdvise</a>(pmessage, plParam, pDdeConv));
00918 
00919     <span class="keywordflow">case</span> WM_DDE_UNADVISE:
00920         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a23">Unadvise</a>(pDdeConv));
00921 
00922     <span class="keywordflow">case</span> WM_DDE_REQUEST:
00923         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a>(pDdeConv));
00924 
00925     <span class="keywordflow">case</span> WM_DDE_POKE:
00926         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a59">xxxPoke</a>(pmessage, plParam, pDdeConv));
00927 
00928     <span class="keywordflow">case</span> WM_DDE_EXECUTE:
00929         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a61">xxxExecute</a>(pmessage, plParam, pDdeConv));
00930     }
00931     <span class="keywordflow">return</span> 0;
00932 }
00933 
00934 
00935 
00936 <span class="comment">/************************************************************************</span>
00937 <span class="comment">*                   ADVISE TRANSACTION PROCESSING                       *</span>
00938 <span class="comment">\***********************************************************************/</span>
00939 
00940 
00941 
<a name="l00942"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a53">00942</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a53">xxxAdvise</a>(            <span class="comment">// Spontaneous Client transaction = WM_DDE_ADVISE</span>
00943 PDWORD pmessage,
00944 LPARAM *plParam,
00945 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
00946 {
00947     <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo;
00948     HANDLE hDirect;
00949     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags, dwRet;
00950 
00951     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pDdeConv);
00952 
00953     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxAdvise"</span>);
00954     flags = <a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a> | <a class="code" href="../../d6/d4/ddetrack_8h.html#a7">XS_LOHANDLE</a>;
00955     dwRet = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a29">xxxCopyDdeIn</a>((HANDLE)*plParam, &amp;flags, &amp;hDirect, &amp;pIntDdeInfo);
00956     <span class="keywordflow">if</span> (dwRet == <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>) {
00957         UserAssert(pIntDdeInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00958         *pmessage |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a545">MSGFLAG_DDE_MID_THUNK</a>;
00959         *plParam = (LPARAM)<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a26">AnticipatePost</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>, <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a10">xxxAdviseAck</a>,
00960              hDirect, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pIntDdeInfo, flags);
00961         <span class="keywordflow">if</span> (*plParam == 0) {
00962             dwRet = <a class="code" href="../../d6/d4/ddetrack_8h.html#a20">FAILNOFREE_POST</a>;
00963         }
00964     }
00965     <span class="keywordflow">return</span> dwRet;
00966 }
00967 
00968 <span class="comment">/*</span>
00969 <span class="comment"> * If its inter-process:</span>
00970 <span class="comment"> *</span>
00971 <span class="comment"> * xxxDDETrackGetMessageHook() fills in hServer from pIntDdeInfo when WM_DDE_ADVISE</span>
00972 <span class="comment"> * is received. pIntDdeInfo is then freed. The hServer handle is saved into the</span>
00973 <span class="comment"> * pxs structure pointed to by lParam is a direct data structure since</span>
00974 <span class="comment"> * packed DDE messages are always assumed to have the packing handle freed.</span>
00975 <span class="comment"> */</span>
00976 
00977 
<a name="l00978"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a54">00978</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a54">xxxAdviseAck</a>(         <span class="comment">// Server response to advise - WM_DDE_ACK expected</span>
00979 PDWORD pmessage,
00980 LPARAM *plParam,
00981 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
00982 {
00983     <a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a> pxsFree;
00984     <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo;
00985     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRet;
00986 
00987     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pDdeConv);
00988 
00989     <span class="keywordflow">if</span> (*pmessage != WM_DDE_ACK) {
00990         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a51">xxxUnexpectedServerPost</a>(pmessage, plParam, pDdeConv));
00991     }
00992 
00993     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxAdviseAck"</span>);
00994 
00995     dwRet = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a64">xxxCopyAckIn</a>(pmessage, plParam, pDdeConv, &amp;pIntDdeInfo);
00996     <span class="keywordflow">if</span> (dwRet != <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>) {
00997         <span class="keywordflow">return</span> dwRet;
00998     }
00999     UserAssert(pIntDdeInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01000 
01001     pxsFree = pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>;
01002     <span class="keywordflow">if</span> (pIntDdeInfo-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o0">DdePack</a>.<a class="code" href="../../d9/d2/structtagDDEPACK.html#o0">uiLo</a> &amp; DDE_FACK) {
01003 
01004         <span class="comment">/*</span>
01005 <span class="comment">         * positive ack implies server accepted the hOptions data - free from</span>
01006 <span class="comment">         * client at postmessage time.</span>
01007 <span class="comment">         */</span>
01008         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxAdviseAck: +ACK delayed freeing data from client"</span>);
01009         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a32">FreeListAdd</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>, pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o3">hClient</a>, pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp; ~<a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a>);
01010     } <span class="keywordflow">else</span> {
01011         <span class="comment">// Shouldn't this be freed directly?</span>
01012         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxAdviseAck: -ACK delayed freeing data from server"</span>);
01013         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a32">FreeListAdd</a>(pDdeConv, pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o4">hServer</a>, pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp; ~<a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a>);
01014     }
01015 
01016     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a34">PopState</a>(pDdeConv);
01017     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>);
01018 }
01019 
01020 
01021 
01022 <span class="comment">/************************************************************************</span>
01023 <span class="comment">*                  ADVISE DATA TRANSACTION PROCESSING                   *</span>
01024 <span class="comment">\***********************************************************************/</span>
01025 
01026 
01027 
<a name="l01028"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a55">01028</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a55">xxxAdviseData</a>(        <span class="comment">// spontaneous from server - WM_DDE_DATA</span>
01029 PDWORD pmessage,
01030 LPARAM *plParam,
01031 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
01032 {
01033     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags, dwRet;
01034     <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo;
01035     HANDLE hDirect;
01036     <a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a> pxs;
01037 
01038     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pDdeConv);
01039 
01040     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxAdviseData"</span>);
01041 
01042     flags = <a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a> | <a class="code" href="../../d6/d4/ddetrack_8h.html#a7">XS_LOHANDLE</a> | <a class="code" href="../../d6/d4/ddetrack_8h.html#a1">XS_DATA</a>;
01043 
01044     dwRet = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a29">xxxCopyDdeIn</a>((HANDLE)*plParam, &amp;flags, &amp;hDirect, &amp;pIntDdeInfo);
01045     <span class="keywordflow">if</span> (dwRet == <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>) {
01046         UserAssert(pIntDdeInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01047         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a1">TRACE_DDE1</a>(<span class="stringliteral">"xxxAdviseData: wStatus = %x"</span>,
01048                 ((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pIntDdeInfo + 1))-&gt;wStatus);
01049         <span class="keywordflow">if</span> (!(((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pIntDdeInfo + 1))-&gt;wStatus &amp; (DDE_FACK | DDE_FRELEASE))) {
01050             RIPMSG0(RIP_ERROR, <span class="stringliteral">"DDE protocol violation - no RELEASE or ACK bit set - setting RELEASE."</span>);
01051             ((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pIntDdeInfo + 1))-&gt;wStatus |= DDE_FRELEASE;
01052         }
01053         <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pIntDdeInfo + 1))-&gt;wStatus &amp; DDE_FRELEASE) {
01054             <span class="comment">/*</span>
01055 <span class="comment">             * giving it away</span>
01056 <span class="comment">             */</span>
01057             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a42">IsObjectPublic</a>(pIntDdeInfo-&gt;hIndirect) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01058                 RIPMSG0(RIP_ERROR, <span class="stringliteral">"DDE Protocol violation - giving away a public GDI object."</span>);
01059                 UserFreePool(pIntDdeInfo);
01060                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d4/ddetrack_8h.html#a20">FAILNOFREE_POST</a>);
01061             }
01062             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a45">GiveObject</a>(((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pIntDdeInfo + 1))-&gt;wFmt,
01063                     pIntDdeInfo-&gt;hIndirect,
01064                     (W32PID)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>)-&gt;ppi-&gt;W32Pid))) {
01065                 flags |= <a class="code" href="../../d6/d4/ddetrack_8h.html#a14">XS_GIVEBACKONNACK</a>;
01066             }
01067             flags |= <a class="code" href="../../d6/d4/ddetrack_8h.html#a10">XS_FRELEASE</a>;
01068         } <span class="keywordflow">else</span> {
01069             <span class="comment">/*</span>
01070 <span class="comment">             * on loan</span>
01071 <span class="comment">             */</span>
01072             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a43">AddPublicObject</a>(((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pIntDdeInfo + 1))-&gt;wFmt,
01073                         pIntDdeInfo-&gt;hIndirect,
01074                         (W32PID)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a>)-&gt;ppi-&gt;W32Pid))) {
01075                 flags |= <a class="code" href="../../d6/d4/ddetrack_8h.html#a13">XS_PUBLICOBJ</a>;
01076             }
01077         }
01078 
01079         *pmessage |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a545">MSGFLAG_DDE_MID_THUNK</a>;
01080         <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pIntDdeInfo + 1))-&gt;wStatus &amp; DDE_FACK) {
01081             *plParam = (LPARAM)<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a26">AnticipatePost</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>,
01082                 <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a12">xxxAdviseDataAck</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hDirect, pIntDdeInfo, flags);
01083         } <span class="keywordflow">else</span> {
01084             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxAdviseData: dumping non Ackable data..."</span>);
01085             UserAssert(hDirect != (HANDLE)*plParam);
01086             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a36">FreeDDEHandle</a>(pDdeConv, hDirect, flags &amp; ~<a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a>);
01087             pxs = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a27">Createpxs</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pIntDdeInfo, flags | <a class="code" href="../../d6/d4/ddetrack_8h.html#a9">XS_FREEPXS</a>);
01088             <span class="keywordflow">if</span> (pxs != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01089                 pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o0">head</a>.<a class="code" href="../../d1/d1/struct__THROBJHEAD.html#o1">pti</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>);
01090             }
01091             *plParam = (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pxs);
01092         }
01093         <span class="keywordflow">if</span> (*plParam == 0) {
01094             dwRet = <a class="code" href="../../d6/d4/ddetrack_8h.html#a20">FAILNOFREE_POST</a>;
01095         }
01096     }
01097     <span class="keywordflow">return</span> dwRet;
01098 }
01099 
01100 
01101 <span class="comment">/*</span>
01102 <span class="comment"> * If its inter-process:</span>
01103 <span class="comment"> *</span>
01104 <span class="comment"> * xxxDDETrackGetMessageHook() completes the copy from pIntDdeInfo when WM_DDE_DATA</span>
01105 <span class="comment"> * is received. pIntDdeInfo is then freed. The hServer handle saved into the</span>
01106 <span class="comment"> * pxs structure pointed to by lParam is a directdata structure since</span>
01107 <span class="comment"> * packed DDE messages are always assumed to have the packing handle freed</span>
01108 <span class="comment"> * by the receiving app.</span>
01109 <span class="comment"> * For the !fAckReq case, the pxs is freed due to the XS_FREEPXS flag.</span>
01110 <span class="comment"> */</span>
01111 
01112 
<a name="l01113"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a56">01113</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a56">xxxAdviseDataAck</a>(     <span class="comment">// Client response to advise data - WM_DDE_ACK expected</span>
01114 PDWORD pmessage,
01115 LPARAM *plParam,
01116 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
01117 {
01118     <a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a> pxsFree;
01119     <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo;
01120     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRet;
01121 
01122     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pDdeConv);
01123 
01124     <span class="comment">/*</span>
01125 <span class="comment">     * This is also used for request data ack processing.</span>
01126 <span class="comment">     */</span>
01127     <span class="keywordflow">if</span> (*pmessage != WM_DDE_ACK) {
01128         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a52">xxxUnexpectedClientPost</a>(pmessage, plParam, pDdeConv));
01129     }
01130 
01131     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxAdviseDataAck"</span>);
01132 
01133     dwRet = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a64">xxxCopyAckIn</a>(pmessage, plParam, pDdeConv, &amp;pIntDdeInfo);
01134     <span class="keywordflow">if</span> (dwRet != <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>) {
01135         <span class="keywordflow">return</span> dwRet;
01136     }
01137     UserAssert(pIntDdeInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01138 
01139     pxsFree = pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>;
01140     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a3">TRACE_DDE3</a>(<span class="stringliteral">"xxxAdviseDataAck:pxs.hClient(%#p), hServer(%#p), wStatus(%x)"</span>,
01141             pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o3">hClient</a>, pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o4">hServer</a>, pIntDdeInfo-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o0">DdePack</a>.<a class="code" href="../../d9/d2/structtagDDEPACK.html#o0">uiLo</a>);
01142     <span class="keywordflow">if</span> (pIntDdeInfo-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o0">DdePack</a>.<a class="code" href="../../d9/d2/structtagDDEPACK.html#o0">uiLo</a> &amp; DDE_FACK) {
01143 
01144         <span class="comment">/*</span>
01145 <span class="comment">         * positive ack implies client accepted the data - free from</span>
01146 <span class="comment">         * server at postmessage time iff FRELEASE was set in data msg.</span>
01147 <span class="comment">         */</span>
01148         <span class="keywordflow">if</span> (pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp; <a class="code" href="../../d6/d4/ddetrack_8h.html#a10">XS_FRELEASE</a>) {
01149             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxAdviseDataAck: +ACK delayed server data free"</span>);
01150             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a32">FreeListAdd</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>, pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o4">hServer</a>,
01151                     pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp; ~<a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a>);
01152         } <span class="keywordflow">else</span> {
01153             <span class="comment">/*</span>
01154 <span class="comment">             * Ack w/out fRelease bit means client is done with data.</span>
01155 <span class="comment">             */</span>
01156             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a1">TRACE_DDE1</a>(<span class="stringliteral">"xxxAdviseDataAck: Freeing %#p. (+ACK)"</span>,
01157                     pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o3">hClient</a>);
01158             UserAssert(pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o3">hClient</a> != (HANDLE)*plParam);
01159             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a36">FreeDDEHandle</a>(pDdeConv, pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o3">hClient</a>, pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp; ~<a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a>);
01160         }
01161 
01162     } <span class="keywordflow">else</span> {
01163         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a1">TRACE_DDE1</a>(<span class="stringliteral">"xxxAdviseDataAck: Freeing %#p. (-ACK)"</span>,
01164                 pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o3">hClient</a>);
01165         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a36">FreeDDEHandle</a>(pDdeConv, pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o3">hClient</a>, pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp; ~<a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a>);
01166         UserAssert(pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o3">hClient</a> != (HANDLE)*plParam);
01167     }
01168     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a34">PopState</a>(pDdeConv);
01169     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>);
01170 }
01171 
01172 
01173 
01174 <span class="comment">/************************************************************************</span>
01175 <span class="comment">*                   UNADVISE TRANSACTION PROCESSING                     *</span>
01176 <span class="comment">\***********************************************************************/</span>
01177 
01178 
01179 
<a name="l01180"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a23">01180</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a23">Unadvise</a>(          <span class="comment">// Spontaneous client transaction = WM_DDE_UNADVISE</span>
01181 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
01182 {
01183     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"Unadvise"</span>);
01184     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a26">AnticipatePost</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>, <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a13">xxxUnadviseAck</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0)) {
01185         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>);
01186     } <span class="keywordflow">else</span> {
01187         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d4/ddetrack_8h.html#a17">FAIL_POST</a>);
01188     }
01189 }
01190 
01191 
01192 
<a name="l01193"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a57">01193</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a57">xxxUnadviseAck</a>(      <span class="comment">// Server response to unadvise - WM_DDE_ACK expected</span>
01194 PDWORD pmessage,
01195 LPARAM *plParam,
01196 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
01197 {
01198     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRet;
01199     <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo;
01200     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pDdeConv);
01201 
01202     <span class="keywordflow">if</span> (*pmessage != WM_DDE_ACK) {
01203         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a51">xxxUnexpectedServerPost</a>(pmessage, plParam, pDdeConv));
01204     }
01205     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxUnadviseAck"</span>);
01206     dwRet = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a64">xxxCopyAckIn</a>(pmessage, plParam, pDdeConv, &amp;pIntDdeInfo);
01207     <span class="keywordflow">if</span> (dwRet != <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>) {
01208         <span class="keywordflow">return</span> dwRet;
01209     }
01210     UserAssert(pIntDdeInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01211     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a34">PopState</a>(pDdeConv);
01212     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>);
01213 }
01214 
01215 
01216 
01217 <span class="comment">/************************************************************************</span>
01218 <span class="comment">*                   REQUEST TRANSACTION PROCESSING                      *</span>
01219 <span class="comment">\***********************************************************************/</span>
01220 
<a name="l01221"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">01221</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a>(       <span class="comment">// Spontaneous Client transaction - WM_DDE_REQUEST</span>
01222 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
01223 {
01224     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"Request"</span>);
01225     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a26">AnticipatePost</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>, <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a14">xxxRequestAck</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0)) {
01226         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>);
01227     } <span class="keywordflow">else</span> {
01228         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d4/ddetrack_8h.html#a17">FAIL_POST</a>);
01229     }
01230 }
01231 
01232 
01233 
<a name="l01234"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a58">01234</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a58">xxxRequestAck</a>(    <span class="comment">// Server response - WM_DDE_ACK or WM_DDE_DATA expected</span>
01235 PDWORD pmessage,
01236 LPARAM *plParam,
01237 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
01238 {
01239     <a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a> pxsFree;
01240     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags;
01241     <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo;
01242     HANDLE hDirect;
01243     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwStatus, dwRet;
01244 
01245     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pDdeConv);
01246 
01247     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxRequestAck or xxxAdviseData"</span>);
01248     <span class="keywordflow">switch</span> (*pmessage) {
01249     <span class="keywordflow">case</span> WM_DDE_DATA:
01250 
01251         <span class="comment">/*</span>
01252 <span class="comment">         * This is very close to advise data handling - the only catch</span>
01253 <span class="comment">         * is that if the fRequest bit is clear this IS advise data.</span>
01254 <span class="comment">         */</span>
01255         flags = <a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a> | <a class="code" href="../../d6/d4/ddetrack_8h.html#a7">XS_LOHANDLE</a> | <a class="code" href="../../d6/d4/ddetrack_8h.html#a1">XS_DATA</a>;
01256 
01257         dwStatus = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a38">ClientGetDDEFlags</a>((HANDLE)*plParam, flags);
01258 
01259         <span class="keywordflow">if</span> (!(dwStatus &amp; DDE_FREQUESTED)) {
01260 
01261             <span class="comment">/*</span>
01262 <span class="comment">             * Its NOT a request Ack - it must be advise data</span>
01263 <span class="comment">             */</span>
01264             <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a55">xxxAdviseData</a>(pmessage, plParam, pDdeConv));
01265         }
01266 
01267         pxsFree = pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>;
01268         dwRet = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a29">xxxCopyDdeIn</a>((HANDLE)*plParam, &amp;flags, &amp;hDirect, &amp;pIntDdeInfo);
01269         <span class="keywordflow">if</span> (dwRet == <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>) {
01270             UserAssert(pIntDdeInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01271             <span class="keywordflow">if</span> (!(((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pIntDdeInfo + 1))-&gt;wStatus &amp; (DDE_FACK | DDE_FRELEASE))) {
01272                 RIPMSG0(RIP_ERROR, <span class="stringliteral">"DDE protocol violation - no RELEASE or ACK bit set - setting RELEASE."</span>);
01273                 ((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pIntDdeInfo + 1))-&gt;wStatus |= DDE_FRELEASE;
01274             }
01275             <span class="keywordflow">if</span> (dwStatus &amp; DDE_FRELEASE) {
01276                 <span class="comment">/*</span>
01277 <span class="comment">                 * giving it away</span>
01278 <span class="comment">                 */</span>
01279                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a42">IsObjectPublic</a>(pIntDdeInfo-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o5">hIndirect</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01280                     RIPMSG0(RIP_ERROR, <span class="stringliteral">"DDE Protocol violation - giving away a public GDI object."</span>);
01281                     UserFreePool(pIntDdeInfo);
01282                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d4/ddetrack_8h.html#a20">FAILNOFREE_POST</a>;
01283                 }
01284                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a45">GiveObject</a>(((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pIntDdeInfo + 1))-&gt;wFmt,
01285                         pIntDdeInfo-&gt;hIndirect,
01286                         (W32PID)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>)-&gt;ppi-&gt;W32Pid)) {
01287                     flags |= <a class="code" href="../../d6/d4/ddetrack_8h.html#a14">XS_GIVEBACKONNACK</a>;
01288                 }
01289                 flags |= <a class="code" href="../../d6/d4/ddetrack_8h.html#a10">XS_FRELEASE</a>;
01290             } <span class="keywordflow">else</span> {
01291                 <span class="comment">/*</span>
01292 <span class="comment">                 * on loan</span>
01293 <span class="comment">                 */</span>
01294                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a43">AddPublicObject</a>(((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pIntDdeInfo + 1))-&gt;wFmt,
01295                             pIntDdeInfo-&gt;hIndirect,
01296                             (W32PID)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a>)-&gt;ppi-&gt;W32Pid)) {
01297                     flags |= <a class="code" href="../../d6/d4/ddetrack_8h.html#a13">XS_PUBLICOBJ</a>;
01298                 }
01299             }
01300             *pmessage |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a545">MSGFLAG_DDE_MID_THUNK</a>;
01301             <span class="keywordflow">if</span> (dwStatus &amp; DDE_FACK) {
01302                 *plParam = (LPARAM)<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a26">AnticipatePost</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>,
01303                     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a12">xxxAdviseDataAck</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hDirect, pIntDdeInfo, flags);
01304             } <span class="keywordflow">else</span> {
01305                 <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxRequestAck: Delayed freeing non-ackable request data"</span>);
01306                 <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a32">FreeListAdd</a>(pDdeConv, hDirect, flags &amp; ~<a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a>);
01307                 pxsFree = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a27">Createpxs</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pIntDdeInfo, flags | <a class="code" href="../../d6/d4/ddetrack_8h.html#a9">XS_FREEPXS</a>);
01308                 <span class="keywordflow">if</span> (pxsFree != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01309                     pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o0">head</a>.<a class="code" href="../../d1/d1/struct__THROBJHEAD.html#o1">pti</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>);
01310                 }
01311                 *plParam = (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pxsFree);
01312             }
01313 
01314             <span class="keywordflow">if</span> (*plParam != 0) {
01315                 <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a34">PopState</a>(pDdeConv);
01316             } <span class="keywordflow">else</span> {
01317                 dwRet = <a class="code" href="../../d6/d4/ddetrack_8h.html#a20">FAILNOFREE_POST</a>;
01318             }
01319         }
01320         <span class="keywordflow">return</span> dwRet;
01321 
01322     <span class="keywordflow">case</span> WM_DDE_ACK:        <span class="comment">// server NACKs request</span>
01323         dwRet = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a64">xxxCopyAckIn</a>(pmessage, plParam, pDdeConv, &amp;pIntDdeInfo);
01324         <span class="keywordflow">if</span> (dwRet != <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>) {
01325             <span class="keywordflow">return</span> dwRet;
01326         }
01327         UserAssert(pIntDdeInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01328         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a34">PopState</a>(pDdeConv);
01329         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>);
01330 
01331     <span class="keywordflow">default</span>:
01332         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a51">xxxUnexpectedServerPost</a>(pmessage, plParam, pDdeConv));
01333     }
01334 }
01335 
01336 
01337 
01338 <span class="comment">/************************************************************************</span>
01339 <span class="comment">*                     POKE TRANSACTION PROCESSING                       *</span>
01340 <span class="comment">\***********************************************************************/</span>
01341 
01342 
01343 
<a name="l01344"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a59">01344</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a59">xxxPoke</a>(          <span class="comment">// spontaneous client transaction - WM_DDE_POKE</span>
01345 PDWORD pmessage,
01346 LPARAM *plParam,
01347 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
01348 {
01349     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags, dwRet;
01350     <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo;
01351     HANDLE hDirect;
01352 
01353     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pDdeConv);
01354 
01355     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxPoke"</span>);
01356     flags = <a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a> | <a class="code" href="../../d6/d4/ddetrack_8h.html#a7">XS_LOHANDLE</a> | <a class="code" href="../../d6/d4/ddetrack_8h.html#a1">XS_DATA</a>;
01357     dwRet = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a29">xxxCopyDdeIn</a>((HANDLE)*plParam, &amp;flags, &amp;hDirect, &amp;pIntDdeInfo);
01358     <span class="keywordflow">if</span> (dwRet == <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>) {
01359         UserAssert(pIntDdeInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01360         <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pIntDdeInfo + 1))-&gt;wStatus &amp; DDE_FRELEASE) {
01361             <span class="comment">/*</span>
01362 <span class="comment">             * giving it away</span>
01363 <span class="comment">             */</span>
01364             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a42">IsObjectPublic</a>(pIntDdeInfo-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o5">hIndirect</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01365                 RIPMSG0(RIP_ERROR, <span class="stringliteral">"DDE Protocol violation - giving away a public GDI object."</span>);
01366                 UserFreePool(pIntDdeInfo);
01367                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d4/ddetrack_8h.html#a20">FAILNOFREE_POST</a>;
01368             }
01369             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a45">GiveObject</a>(((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pIntDdeInfo + 1))-&gt;wFmt,
01370                     pIntDdeInfo-&gt;hIndirect,
01371                     (W32PID)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>)-&gt;ppi-&gt;W32Pid)) {
01372                 flags |= <a class="code" href="../../d6/d4/ddetrack_8h.html#a14">XS_GIVEBACKONNACK</a>;
01373             }
01374             flags |= <a class="code" href="../../d6/d4/ddetrack_8h.html#a10">XS_FRELEASE</a>;
01375         } <span class="keywordflow">else</span> {
01376             <span class="comment">/*</span>
01377 <span class="comment">             * on loan</span>
01378 <span class="comment">             */</span>
01379             <span class="comment">/*</span>
01380 <span class="comment">             * fAck bit is ignored and assumed on.</span>
01381 <span class="comment">             */</span>
01382             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a43">AddPublicObject</a>(((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pIntDdeInfo + 1))-&gt;wFmt,
01383                         pIntDdeInfo-&gt;hIndirect,
01384                         (W32PID)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a>)-&gt;ppi-&gt;W32Pid)) {
01385                 flags |= <a class="code" href="../../d6/d4/ddetrack_8h.html#a13">XS_PUBLICOBJ</a>;
01386             }
01387         }
01388         *pmessage |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a545">MSGFLAG_DDE_MID_THUNK</a>;
01389         *plParam = (LPARAM)<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a26">AnticipatePost</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>, <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a16">xxxPokeAck</a>,
01390              hDirect, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pIntDdeInfo, flags);
01391         <span class="keywordflow">if</span> (*plParam == 0) {
01392             dwRet = <a class="code" href="../../d6/d4/ddetrack_8h.html#a20">FAILNOFREE_POST</a>;
01393         }
01394     }
01395     <span class="keywordflow">return</span> dwRet;
01396 }
01397 
01398 
01399 <span class="comment">/*</span>
01400 <span class="comment"> * If its inter-process:</span>
01401 <span class="comment"> *</span>
01402 <span class="comment"> * xxxDDETrackGetMessageHook() fills in hServer from pIntDdeInfo when WM_DDE_ADVISE</span>
01403 <span class="comment"> * is received.  pIntDdeInfo is then freed.  The hServer handle saved into the</span>
01404 <span class="comment"> * pxs structure pointer to by lParam is a directdata structure since</span>
01405 <span class="comment"> * packed DDE messages are always assumed to have the packing handle freed</span>
01406 <span class="comment"> * by the receiving app.</span>
01407 <span class="comment"> * For the !fAckReq case, the pxs is also freed due to the XS_FREEPXS flag.</span>
01408 <span class="comment"> */</span>
01409 
01410 
<a name="l01411"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a60">01411</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a60">xxxPokeAck</a>(       <span class="comment">// Server response to poke data - WM_DDE_ACK expected</span>
01412 PDWORD pmessage,
01413 LPARAM *plParam,
01414 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
01415 {
01416     <a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a> pxsFree;
01417     <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo;
01418     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRet;
01419 
01420     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pDdeConv);
01421 
01422     <span class="keywordflow">if</span> (*pmessage != WM_DDE_ACK) {
01423         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a51">xxxUnexpectedServerPost</a>(pmessage, plParam, pDdeConv));
01424     }
01425 
01426     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxPokeAck"</span>);
01427 
01428     dwRet = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a64">xxxCopyAckIn</a>(pmessage, plParam, pDdeConv, &amp;pIntDdeInfo);
01429     <span class="keywordflow">if</span> (dwRet != <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>) {
01430         <span class="keywordflow">return</span> dwRet;
01431     }
01432     UserAssert(pIntDdeInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01433 
01434     pxsFree = pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>;
01435     <span class="keywordflow">if</span> (pIntDdeInfo-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o0">DdePack</a>.<a class="code" href="../../d9/d2/structtagDDEPACK.html#o0">uiLo</a> &amp; DDE_FACK) {
01436         <span class="comment">// positive ack implies server accepted the data - free from</span>
01437         <span class="comment">// client at postmessage time iff fRelease was set in poke message.</span>
01438         <span class="keywordflow">if</span> (pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp; <a class="code" href="../../d6/d4/ddetrack_8h.html#a10">XS_FRELEASE</a>) {
01439             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxPokeAck: delayed freeing client data"</span>);
01440             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a32">FreeListAdd</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>, pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o3">hClient</a>,
01441                     pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp; ~<a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a>);
01442         }
01443     } <span class="keywordflow">else</span> {
01444         <span class="comment">// Nack means that sender is responsible for freeing it.</span>
01445         <span class="comment">// We must free it in the receiver's context for him.</span>
01446         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxPokeAck: freeing Nacked data"</span>);
01447         UserAssert(pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o4">hServer</a> != (HANDLE)*plParam);
01448         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a36">FreeDDEHandle</a>(pDdeConv, pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o4">hServer</a>, pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp; ~<a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a>);
01449     }
01450     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a34">PopState</a>(pDdeConv);
01451     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>);
01452 }
01453 
01454 
01455 
01456 <span class="comment">/************************************************************************</span>
01457 <span class="comment">*                   EXECUTE TRANSACTION PROCESSING                      *</span>
01458 <span class="comment">\***********************************************************************/</span>
01459 
<a name="l01460"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a61">01460</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a61">xxxExecute</a>(       <span class="comment">// spontaneous client transaction - WM_DDE_EXECUTE</span>
01461 PDWORD pmessage,
01462 LPARAM *plParam,
01463 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
01464 {
01465     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags, dwRet;
01466     <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo;
01467     HANDLE hDirect;
01468 
01469     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pDdeConv);
01470 
01471     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxExecute"</span>);
01472 
01473     flags = <a class="code" href="../../d6/d4/ddetrack_8h.html#a11">XS_EXECUTE</a>;
01474     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>) &amp;&amp;
01475             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>)) {
01476         flags |= <a class="code" href="../../d6/d4/ddetrack_8h.html#a16">XS_UNICODE</a>;
01477     }
01478     dwRet = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a29">xxxCopyDdeIn</a>((HANDLE)*plParam, &amp;flags, &amp;hDirect, &amp;pIntDdeInfo);
01479     <span class="keywordflow">if</span> (dwRet == <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>) {
01480         UserAssert(pIntDdeInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01481         *pmessage |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a545">MSGFLAG_DDE_MID_THUNK</a>;
01482         *plParam = (LPARAM)<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a26">AnticipatePost</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>, <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a18">xxxExecuteAck</a>,
01483                 hDirect, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pIntDdeInfo, flags);
01484         <span class="comment">/*</span>
01485 <span class="comment">         * Check for != 0 to make sure the AnticipatePost() succeeded.</span>
01486 <span class="comment">         */</span>
01487         <span class="keywordflow">if</span> (*plParam != 0) {
01488 
01489             <span class="comment">/*</span>
01490 <span class="comment">             * In the execute case it is likely that the postee will want to activate</span>
01491 <span class="comment">             * itself and come on top (OLE 1.0 is an example). In this case, allow</span>
01492 <span class="comment">             * both the postee and the poster to foreground activate for the next</span>
01493 <span class="comment">             * activate (poster because it will want to activate itself again</span>
01494 <span class="comment">             * probably, once the postee is done.)</span>
01495 <span class="comment">             */</span>
01496             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a>)-&gt;TIF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>;
01497             TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxExecute set TIF %#p"</span>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a>));
01498             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>)-&gt;TIF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>;
01499             TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxExecute set TIF %#p"</span>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>));
01500         } <span class="keywordflow">else</span> {
01501             dwRet = <a class="code" href="../../d6/d4/ddetrack_8h.html#a20">FAILNOFREE_POST</a>;
01502         }
01503 
01504     }
01505     <span class="keywordflow">return</span> dwRet;
01506 }
01507 
01508 
01509 <span class="comment">/*</span>
01510 <span class="comment"> * xxxDDETrackGetMessageHook() fills in hServer from pIntDdeInfo when WM_DDE_EXECUTE</span>
01511 <span class="comment"> * is received.  pIntDdeInfo is then freed.</span>
01512 <span class="comment"> */</span>
01513 
01514 
<a name="l01515"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a62">01515</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a62">xxxExecuteAck</a>(       <span class="comment">// Server response to execute data - WM_DDE_ACK expected</span>
01516 PDWORD pmessage,
01517 LPARAM *plParam,
01518 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
01519 {
01520     <a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a> pxsFree;
01521     <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pi;
01522     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags = <a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a> | <a class="code" href="../../d6/d4/ddetrack_8h.html#a12">XS_FREESRC</a> | <a class="code" href="../../d6/d4/ddetrack_8h.html#a11">XS_EXECUTE</a>;
01523     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRet;
01524 
01525     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pDdeConv);
01526 
01527     <span class="keywordflow">if</span> (*pmessage != WM_DDE_ACK) {
01528         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a51">xxxUnexpectedServerPost</a>(pmessage, plParam, pDdeConv));
01529     }
01530 
01531     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"xxxExecuteAck"</span>);
01532     dwRet = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a29">xxxCopyDdeIn</a>((HANDLE)*plParam, &amp;flags, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;pi);
01533     <span class="keywordflow">if</span> (dwRet == <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>) {
01534         UserAssert(pi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01535         <span class="comment">/*</span>
01536 <span class="comment">         * the server must respond to the execute with an ack containing the</span>
01537 <span class="comment">         * same handle it was given.</span>
01538 <span class="comment">         */</span>
01539         pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o0">DdePack</a>.<a class="code" href="../../d9/d2/structtagDDEPACK.html#o1">uiHi</a> = (ULONG_PTR)pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o3">hClient</a>;
01540         pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o2">hDirect</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01541         pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o4">cbDirect</a> = 0;
01542         *pmessage |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a545">MSGFLAG_DDE_MID_THUNK</a>;
01543         pxsFree = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a27">Createpxs</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pi, <a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a> | <a class="code" href="../../d6/d4/ddetrack_8h.html#a9">XS_FREEPXS</a>);
01544         <span class="keywordflow">if</span> (pxsFree != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01545             pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o0">head</a>.<a class="code" href="../../d1/d1/struct__THROBJHEAD.html#o1">pti</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>);
01546         }
01547         *plParam = (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pxsFree);
01548         <span class="keywordflow">if</span> (*plParam != 0) {
01549             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a34">PopState</a>(pDdeConv);
01550         } <span class="keywordflow">else</span> {
01551             dwRet = <a class="code" href="../../d6/d4/ddetrack_8h.html#a20">FAILNOFREE_POST</a>;
01552         }
01553     }
01554     <span class="keywordflow">return</span> dwRet;
01555 }
01556 
01557 
01558 
01559 <span class="comment">/************************************************************************</span>
01560 <span class="comment">*                  TERMINATE TRANSACTION PROCESSING                     *</span>
01561 <span class="comment">\***********************************************************************/</span>
01562 
01563 
01564 
<a name="l01565"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a25">01565</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a25">SpontaneousTerminate</a>(
01566 PDWORD pmessage,
01567 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
01568 {
01569     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"SpontaneousTerminate"</span>);
01570     <span class="keywordflow">if</span> (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a603">CXF_TERMINATE_POSTED</a>) {
01571         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d4/ddetrack_8h.html#a18">FAKE_POST</a>);
01572     } <span class="keywordflow">else</span> {
01573         pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a603">CXF_TERMINATE_POSTED</a>;
01574         *pmessage |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a545">MSGFLAG_DDE_MID_THUNK</a>;
01575         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>);
01576     }
01577 }
01578 
01579 <span class="comment">/*</span>
01580 <span class="comment"> * The xxxDDETrackGetMessageHook() function restores the *pmessage value.</span>
01581 <span class="comment"> * Unless a spontaneous terminate from the other app has already</span>
01582 <span class="comment"> * arrived, it will note that CXF_TERMINATE_POSTED is NOT set on</span>
01583 <span class="comment"> * both sides so no action is taken.</span>
01584 <span class="comment"> */</span>
01585 
01586 
01587 <span class="comment">/************************************************************************</span>
01588 <span class="comment">*               DUPLICATE CONVERSATION TERMINATION                      *</span>
01589 <span class="comment">\***********************************************************************/</span>
01590 
01591 <span class="comment">/*</span>
01592 <span class="comment"> * This routine is called when a DDE server window sent a WM_DDE_ACK</span>
01593 <span class="comment"> * message to a client window which is already engaged in a conversation</span>
01594 <span class="comment"> * with that server window.  We swallow the ACK and post a terminate to</span>
01595 <span class="comment"> * the server window to shut this conversation down.  When the server</span>
01596 <span class="comment"> * posts the terminate, this function is called to basically fake</span>
01597 <span class="comment"> * a sucessful post.  Thus the client is never bothered while the</span>
01598 <span class="comment"> * errant server thinks the conversation was connected and then</span>
01599 <span class="comment"> * imediately terminated.</span>
01600 <span class="comment"> */</span>
<a name="l01601"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a63">01601</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a63">DupConvTerminate</a>(       <span class="comment">// WM_DDE_TERMINATE expected</span>
01602 PDWORD pmessage,
01603 LPARAM *plParam,
01604 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
01605 {
01606     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pDdeConv);
01607 
01608     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a0">TRACE_DDE</a>(<span class="stringliteral">"DupConvTerminate"</span>);
01609 
01610     <span class="keywordflow">if</span> (*pmessage != WM_DDE_TERMINATE) {
01611         <span class="keywordflow">return</span>(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a51">xxxUnexpectedServerPost</a>(pmessage, plParam, pDdeConv));
01612     }
01613 
01614     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a34">PopState</a>(pDdeConv);
01615     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d4/ddetrack_8h.html#a18">FAKE_POST</a>);
01616 }
01617 
01618 
01619 
01620 <span class="comment">/************************************************************************</span>
01621 <span class="comment">*               HELPER ROUTINES FOR TRANSACTION TRACKING                *</span>
01622 <span class="comment">\***********************************************************************/</span>
01623 
01624 
01625 
01626 <span class="comment">/************************************************************************</span>
01627 <span class="comment">* AnticipatePost</span>
01628 <span class="comment">*</span>
01629 <span class="comment">* Allocates, fills and links XSTATE structures.</span>
01630 <span class="comment">*</span>
01631 <span class="comment">* History:</span>
01632 <span class="comment">* 9-3-91    sanfords    Created</span>
01633 <span class="comment">\***********************************************************************/</span>
<a name="l01634"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a26">01634</a> HANDLE <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a26">AnticipatePost</a>(
01635 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv,
01636 FNDDERESPONSE fnResponse,
01637 HANDLE hClient,
01638 HANDLE hServer,
01639 <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo,
01640 DWORD flags)
01641 {
01642     <a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a> pxs;
01643 
01644     pxs = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a27">Createpxs</a>(fnResponse, hClient, hServer, pIntDdeInfo, flags);
01645     <span class="keywordflow">if</span> (pxs != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01646         pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o0">head</a>.<a class="code" href="../../d1/d1/struct__THROBJHEAD.html#o1">pti</a> = pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o0">head</a>.<a class="code" href="../../d1/d1/struct__THROBJHEAD.html#o1">pti</a>;
01647         <span class="keywordflow">if</span> (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01648             UserAssert(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o6">spxsIn</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01649             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>), pxs);
01650             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o6">spxsIn</a>), pxs);
01651         } <span class="keywordflow">else</span> {
01652             UserAssert(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o6">spxsIn</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01653             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o6">spxsIn</a>-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o1">snext</a>), pxs);
01654             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o6">spxsIn</a>), pxs);
01655         }
01656 <span class="preprocessor">#if 0</span>
01657 <span class="preprocessor"></span>        {
01658             <span class="keywordtype">int</span> i;
01659             <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">HANDLEENTRY</a> *phe;
01660 
01661             <span class="keywordflow">for</span> (i = 0, phe = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>;
01662                 i &lt;= (<span class="keywordtype">int</span>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>;
01663                     i++) {
01664                 <span class="keywordflow">if</span> (phe[i].bType == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a247">TYPE_DDEXACT</a>) {
01665                     UserAssert(((<a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a>)(phe[i].phead))-&gt;snext != pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>);
01666                 }
01667                 <span class="keywordflow">if</span> (phe[i].bType == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a246">TYPE_DDECONV</a> &amp;&amp;
01668                         (<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a>)phe[i].phead != pDdeConv) {
01669                     UserAssert(((<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a>)(phe[i].phead))-&gt;spxsOut != pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>);
01670                     UserAssert(((<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a>)(phe[i].phead))-&gt;spxsIn != pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>);
01671                 }
01672             }
01673         }
01674 <span class="preprocessor">#endif</span>
01675 <span class="preprocessor"></span>    }
01676     <span class="keywordflow">return</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pxs));
01677 }
01678 
01679 
01680 
01681 <span class="comment">/************************************************************************</span>
01682 <span class="comment">* Createpxs</span>
01683 <span class="comment">*</span>
01684 <span class="comment">* Allocates and fills XSTATE structures.</span>
01685 <span class="comment">*</span>
01686 <span class="comment">* History:</span>
01687 <span class="comment">* 9-3-91    sanfords    Created</span>
01688 <span class="comment">\***********************************************************************/</span>
<a name="l01689"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a27">01689</a> <a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a27">Createpxs</a>(
01690 FNDDERESPONSE fnResponse,
01691 HANDLE hClient,
01692 HANDLE hServer,
01693 <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo,
01694 DWORD flags)
01695 {
01696     <a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a> pxs;
01697 
01698     pxs = <a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a247">TYPE_DDEXACT</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/structtagXSTATE.html">XSTATE</a>));
01699     <span class="keywordflow">if</span> (pxs == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01700 <span class="preprocessor">#if DBG</span>
01701 <span class="preprocessor"></span>        RIPMSG0(RIP_WARNING, <span class="stringliteral">"Unable to alloc DDEXACT"</span>);
01702 <span class="preprocessor">#endif</span>
01703 <span class="preprocessor"></span>        <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01704     }
01705     pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o1">snext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01706     pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o2">fnResponse</a> = fnResponse;
01707     pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o3">hClient</a> = hClient;
01708     pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o4">hServer</a> = hServer;
01709     pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o5">pIntDdeInfo</a> = pIntDdeInfo;
01710     pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> = flags;
01711     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a4">ValidatePublicObjectList</a>();
01712     UserAssert(pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o0">head</a>.cLockObj == 0);
01713     <span class="keywordflow">return</span>(pxs);
01714 }
01715 
01716 
01717 
01718 
01719 <span class="comment">/************************************************************************</span>
01720 <span class="comment">* AbnormalDDEPost</span>
01721 <span class="comment">*</span>
01722 <span class="comment">* This is the catch-all routine for wierd cases</span>
01723 <span class="comment">*</span>
01724 <span class="comment">* returns post action code - DO_POST, FAKE_POST, FAIL_POST.</span>
01725 <span class="comment">*</span>
01726 <span class="comment">* History:</span>
01727 <span class="comment">* 9-3-91    sanfords    Created</span>
01728 <span class="comment">\***********************************************************************/</span>
<a name="l01729"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a28">01729</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a28">AbnormalDDEPost</a>(
01730 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv,
01731 DWORD message)
01732 {
01733 
01734 <span class="preprocessor">#if DBG</span>
01735 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (message != WM_DDE_TERMINATE) {
01736         RIPMSG2(RIP_WARNING,
01737                 <span class="stringliteral">"DDE Post failed (%#p:%#p) - protocol violation."</span>,
01738                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a>), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>));
01739     }
01740 <span class="preprocessor">#endif // DBG</span>
01741 <span class="preprocessor"></span>
01742     <span class="comment">// shutdown this conversation by posting a terminate on</span>
01743     <span class="comment">// behalf of this guy, then fail all future posts but</span>
01744     <span class="comment">// fake a successful terminate.</span>
01745 
01746     <span class="keywordflow">if</span> (!(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a603">CXF_TERMINATE_POSTED</a>)) {
01747         <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>, WM_DDE_TERMINATE,
01748                 (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a>), 0);
01749         <span class="comment">// pDdeConv-&gt;flags |= CXF_TERMINATE_POSTED; Set by post hook proc</span>
01750     }
01751     <span class="keywordflow">return</span>(message == WM_DDE_TERMINATE ? <a class="code" href="../../d6/d4/ddetrack_8h.html#a18">FAKE_POST</a> : <a class="code" href="../../d6/d4/ddetrack_8h.html#a17">FAIL_POST</a>);
01752 }
01753 
01754 
01755 
01756 <span class="comment">/************************************************************************</span>
01757 <span class="comment">* NewConversation</span>
01758 <span class="comment">*</span>
01759 <span class="comment">* Worker function used to create a saimese pair of DDECONV structures.</span>
01760 <span class="comment">*</span>
01761 <span class="comment">* Returns fCreateOk</span>
01762 <span class="comment">*</span>
01763 <span class="comment">* History:</span>
01764 <span class="comment">* 11-5-92    sanfords    Created</span>
01765 <span class="comment">\***********************************************************************/</span>
<a name="l01766"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a20">01766</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a20">NewConversation</a>(
01767 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> *ppdcNewClient,
01768 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> *ppdcNewServer,
01769 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndClient,
01770 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndServer)
01771 {
01772     <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pdcNewClient;
01773     <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pdcNewServer;
01774 
01775     pdcNewClient = <a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndClient), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01776             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a246">TYPE_DDECONV</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/structtagDDECONV.html">DDECONV</a>));
01777     <span class="keywordflow">if</span> (pdcNewClient == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01778         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01779     }
01780 
01781     pdcNewServer = <a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndServer), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01782             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a246">TYPE_DDECONV</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/userk_8h.html#a929">DDECONV</a>));
01783     <span class="keywordflow">if</span> (pdcNewServer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01784         <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pdcNewClient);     <span class="comment">// we know it's not locked.</span>
01785         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01786     }
01787 
01788     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a22">AddConvProp</a>(pwndClient, pwndServer, 0, pdcNewClient, pdcNewServer);
01789     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a22">AddConvProp</a>(pwndServer, pwndClient, <a class="code" href="../../d4/d1/userk_8h.html#a602">CXF_IS_SERVER</a>, pdcNewServer,
01790             pdcNewClient);
01791 
01792     <span class="keywordflow">if</span> (ppdcNewClient != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01793         *ppdcNewClient = pdcNewClient;
01794     }
01795     <span class="keywordflow">if</span> (ppdcNewServer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01796         *ppdcNewServer = pdcNewServer;
01797     }
01798     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01799 }
01800 
01801 
01802 <span class="comment">/************************************************************************</span>
01803 <span class="comment">* FindDdeConv</span>
01804 <span class="comment">*</span>
01805 <span class="comment">* Locates the pDdeConv associated with pwndProp, and pwndPartner.</span>
01806 <span class="comment">* Only searches pwndProp's property list.</span>
01807 <span class="comment">*</span>
01808 <span class="comment">* History:</span>
01809 <span class="comment">* 3-31-91   sanfords    Created</span>
01810 <span class="comment">\***********************************************************************/</span>
<a name="l01811"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a21">01811</a> <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a21">FindDdeConv</a>(
01812 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndProp,
01813 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndPartner)
01814 {
01815     <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv;
01816 
01817     pDdeConv = (<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a>)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwndProp, <a class="code" href="../../d4/d1/userk_8h.html#a476">PROP_DDETRACK</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
01818     <span class="keywordflow">while</span> (pDdeConv != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a> != pwndPartner) {
01819         pDdeConv = pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o1">snext</a>;
01820     }
01821 
01822     <span class="keywordflow">return</span>(pDdeConv);
01823 }
01824 
01825 
01826 
01827 <span class="comment">/************************************************************************</span>
01828 <span class="comment">* xxxCopyAckIn</span>
01829 <span class="comment">*</span>
01830 <span class="comment">* A common occurance helper function</span>
01831 <span class="comment">*</span>
01832 <span class="comment">* History:</span>
01833 <span class="comment">* 9-3-91    sanfords    Created</span>
01834 <span class="comment">\***********************************************************************/</span>
<a name="l01835"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a64">01835</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a64">xxxCopyAckIn</a>(
01836 LPDWORD pmessage,
01837 LPARAM *plParam,
01838 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv,
01839 <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> * ppIntDdeInfo)
01840 {
01841     <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pIntDdeInfo;
01842     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags, dwRet;
01843     <a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a> pxs;
01844 
01845     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pDdeConv);
01846 
01847     flags = <a class="code" href="../../d6/d4/ddetrack_8h.html#a0">XS_PACKED</a> | <a class="code" href="../../d6/d4/ddetrack_8h.html#a12">XS_FREESRC</a>;
01848     dwRet = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a29">xxxCopyDdeIn</a>((HANDLE)*plParam, &amp;flags, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ppIntDdeInfo);
01849     <span class="keywordflow">if</span> (dwRet == <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>) {
01850         UserAssert(*ppIntDdeInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01851         pIntDdeInfo = *ppIntDdeInfo;
01852         <span class="keywordflow">if</span> (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp; <a class="code" href="../../d6/d4/ddetrack_8h.html#a14">XS_GIVEBACKONNACK</a> &amp;&amp;
01853                 !(((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pIntDdeInfo + 1))-&gt;wStatus &amp; DDE_FACK)) {
01854             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a45">GiveObject</a>(((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o5">pIntDdeInfo</a> + 1))-&gt;wFmt,
01855                     pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o5">pIntDdeInfo</a>-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o5">hIndirect</a>,
01856                     (W32PID)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>)-&gt;ppi-&gt;W32Pid);
01857         }
01858         <span class="keywordflow">if</span> (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp; <a class="code" href="../../d6/d4/ddetrack_8h.html#a13">XS_PUBLICOBJ</a>) {
01859             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a44">RemovePublicObject</a>(((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o5">pIntDdeInfo</a> + 1))-&gt;wFmt,
01860                     pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o5">pIntDdeInfo</a>-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o5">hIndirect</a>);
01861             pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp;= ~<a class="code" href="../../d6/d4/ddetrack_8h.html#a13">XS_PUBLICOBJ</a>;
01862         }
01863         pxs = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a27">Createpxs</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pIntDdeInfo, flags | <a class="code" href="../../d6/d4/ddetrack_8h.html#a9">XS_FREEPXS</a>);
01864         <span class="keywordflow">if</span> (pxs != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01865             pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o0">head</a>.<a class="code" href="../../d1/d1/struct__THROBJHEAD.html#o1">pti</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>);
01866         }
01867         *plParam = (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pxs);
01868         <span class="keywordflow">if</span> (*plParam == 0) {
01869             <span class="keywordflow">return</span> <a class="code" href="../../d6/d4/ddetrack_8h.html#a20">FAILNOFREE_POST</a>;
01870         }
01871         *pmessage |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a545">MSGFLAG_DDE_MID_THUNK</a>;
01872     }
01873     <span class="keywordflow">return</span> dwRet;
01874 }
01875 
01876 
01877 
01878 <span class="comment">/************************************************************************</span>
01879 <span class="comment">* FreeListAdd</span>
01880 <span class="comment">*</span>
01881 <span class="comment">* Adds a CSR Client handle to the free list associated with pDdeConv.</span>
01882 <span class="comment">* This allows us to make sure stuff is freed that isn't in a context</span>
01883 <span class="comment">* we have access at the time we know it must be freed.</span>
01884 <span class="comment">*</span>
01885 <span class="comment">* returns fSuccess</span>
01886 <span class="comment">*</span>
01887 <span class="comment">* History:</span>
01888 <span class="comment">* 9-3-91    sanfords    Created</span>
01889 <span class="comment">\***********************************************************************/</span>
<a name="l01890"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a32">01890</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a32">FreeListAdd</a>(
01891 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv,
01892 HANDLE hClient,
01893 DWORD flags)
01894 {
01895     <a class="code" href="../../d4/d5/structtagFREELIST.html">PFREELIST</a> pfl;
01896 
01897     pfl = (<a class="code" href="../../d4/d5/structtagFREELIST.html">PFREELIST</a>)UserAllocPool(<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/structtagFREELIST.html">FREELIST</a>), TAG_DDE1);
01898     <span class="keywordflow">if</span> (!pfl) {
01899         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01900     }
01901     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a2">TRACE_DDE2</a>(<span class="stringliteral">"FreeListAdd: %x for thread %x."</span>, hClient,
01902             pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o0">head</a>.<a class="code" href="../../d1/d1/struct__THROBJHEAD.html#o1">pti</a>-&gt;pEThread-&gt;Cid.UniqueThread);
01903     pfl-&gt;<a class="code" href="../../d4/d5/structtagFREELIST.html#o1">h</a> = hClient;
01904     pfl-&gt;<a class="code" href="../../d4/d5/structtagFREELIST.html#o2">flags</a> = flags;
01905     pfl-&gt;<a class="code" href="../../d4/d5/structtagFREELIST.html#o0">next</a> = pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o7">pfl</a>;
01906     pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o7">pfl</a> = pfl;
01907     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01908 }
01909 
01910 
01911 <span class="comment">/************************************************************************</span>
01912 <span class="comment">* FreeDDEHandle</span>
01913 <span class="comment">*</span>
01914 <span class="comment">* Frees contents DDE client side handle - delayed free if a WOW process.</span>
01915 <span class="comment">*</span>
01916 <span class="comment">* History:</span>
01917 <span class="comment">* 7-28-94    sanfords    Created</span>
01918 <span class="comment">\***********************************************************************/</span>
<a name="l01919"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a36">01919</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a36">FreeDDEHandle</a>(
01920 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv,
01921 HANDLE hClient,
01922 DWORD flags)
01923 {
01924     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
01925         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a1">TRACE_DDE1</a>(<span class="stringliteral">"FreeDDEHandle: (WOW hack) delayed Freeing %#p."</span>, hClient);
01926         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a32">FreeListAdd</a>(pDdeConv, hClient, flags);
01927     } <span class="keywordflow">else</span> {
01928         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a1">TRACE_DDE1</a>(<span class="stringliteral">"FreeDDEHandle: Freeing %#p."</span>, hClient);
01929         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a37">ClientFreeDDEHandle</a>(hClient, flags);
01930     }
01931 }
01932 
01933 
01934 
01935 <span class="comment">/************************************************************************</span>
01936 <span class="comment">* xxxFreeListFree</span>
01937 <span class="comment">*</span>
01938 <span class="comment">* Frees contents of the free list associated with pDdeConv.</span>
01939 <span class="comment">*</span>
01940 <span class="comment">* History:</span>
01941 <span class="comment">* 9-3-91    sanfords    Created</span>
01942 <span class="comment">\***********************************************************************/</span>
<a name="l01943"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a65">01943</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a65">FreeListFree</a>(
01944     <a class="code" href="../../d4/d5/structtagFREELIST.html">PFREELIST</a> pfl)
01945 {
01946     <a class="code" href="../../d4/d5/structtagFREELIST.html">PFREELIST</a> pflPrev;
01947 
01948     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01949 
01950     UserAssert(pfl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01951 
01952     <span class="keywordflow">while</span> (pfl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01953         pflPrev = pfl;
01954         pfl = pfl-&gt;<a class="code" href="../../d4/d5/structtagFREELIST.html#o0">next</a>;
01955         UserFreePool(pflPrev);
01956     }
01957 }
01958 
01959 
<a name="l01960"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a33">01960</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a33">xxxFreeListFree</a>(
01961 <a class="code" href="../../d4/d5/structtagFREELIST.html">PFREELIST</a> pfl)
01962 {
01963     <a class="code" href="../../d4/d5/structtagFREELIST.html">PFREELIST</a> pflPrev;
01964     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>      fInCleanup;
01965     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>        tlPool;
01966 
01967     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01968 
01969     <span class="keywordflow">if</span> (pfl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01970         <span class="keywordflow">return</span>;
01971     }
01972 
01973     fInCleanup = (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>())-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>;
01974 
01975     <span class="keywordflow">while</span> (pfl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01976 
01977         <a class="code" href="../../d4/d1/userk_8h.html#a140">ThreadLockPoolCleanup</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), pfl, &amp;tlPool, <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a65">FreeListFree</a>);
01978 
01979         <span class="keywordflow">if</span> (!fInCleanup) {
01980             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a1">TRACE_DDE1</a>(<span class="stringliteral">"Freeing %#p from free list.\n"</span>, pfl-&gt;<a class="code" href="../../d4/d5/structtagFREELIST.html#o1">h</a>);
01981             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a37">ClientFreeDDEHandle</a>(pfl-&gt;<a class="code" href="../../d4/d5/structtagFREELIST.html#o1">h</a>, pfl-&gt;<a class="code" href="../../d4/d5/structtagFREELIST.html#o2">flags</a>);
01982         }
01983 
01984         <a class="code" href="../../d4/d1/userk_8h.html#a141">ThreadUnlockPoolCleanup</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), &amp;tlPool);
01985 
01986         pflPrev = pfl;
01987         pfl = pfl-&gt;<a class="code" href="../../d4/d5/structtagFREELIST.html#o0">next</a>;
01988         UserFreePool(pflPrev);
01989     }
01990 }
01991 
01992 
01993 <span class="comment">/************************************************************************</span>
01994 <span class="comment">* PopState</span>
01995 <span class="comment">*</span>
01996 <span class="comment">* Frees spxsOut from pDdeConv and handles empty queue case.</span>
01997 <span class="comment">*</span>
01998 <span class="comment">* History:</span>
01999 <span class="comment">* 9-3-91    sanfords    Created</span>
02000 <span class="comment">\***********************************************************************/</span>
<a name="l02001"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a34">02001</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a34">PopState</a>(
02002 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
02003 {
02004     <a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a> pxsNext, pxsFree;
02005     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpxs;
02006 
02007     UserAssert(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02008 <span class="preprocessor">#if 0</span>
02009 <span class="preprocessor"></span>    {
02010         <span class="keywordtype">int</span> i;
02011         <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">HANDLEENTRY</a> *phe;
02012 
02013         <span class="keywordflow">for</span> (i = 0, phe = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>;
02014             i &lt;= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>;
02015                 i++) {
02016             <span class="keywordflow">if</span> (phe[i].bType == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a247">TYPE_DDEXACT</a>) {
02017                 UserAssert(((<a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a>)(phe[i].phead))-&gt;snext != pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>);
02018             }
02019         }
02020     }
02021 <span class="preprocessor">#endif</span>
02022 <span class="preprocessor"></span>    UserAssert(!(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp; <a class="code" href="../../d6/d4/ddetrack_8h.html#a9">XS_FREEPXS</a>));
02023     UserAssert(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o6">spxsIn</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02024     UserAssert(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o6">spxsIn</a>-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o1">snext</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02025 
02026     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>, &amp;tlpxs);              <span class="comment">// hold it fast</span>
02027     pxsNext = pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o1">snext</a>;
02028     pxsFree = <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o5">spxsOut</a>), pxsNext);      <span class="comment">// lock next into head</span>
02029     <span class="keywordflow">if</span> (pxsNext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02030         UserAssert(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o6">spxsIn</a> == pxsFree);
02031         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o6">spxsIn</a>));                <span class="comment">// queue is empty.</span>
02032     } <span class="keywordflow">else</span> {
02033         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;(pxsFree-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o1">snext</a>));                  <span class="comment">// clear next ptr</span>
02034     }
02035     pxsFree = <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpxs);                     <span class="comment">// undo our lock</span>
02036     <span class="keywordflow">if</span> (pxsFree != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02037         <a class="code" href="../../d4/d1/userk_8h.html#a1875">FreeDdeXact</a>(pxsFree);                           <span class="comment">// cleanup.</span>
02038     }
02039 }
02040 
02041 
<a name="l02042"></a><a class="code" href="../../d4/d1/userk_8h.html#a1878">02042</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1878">FreeDdeConv</a>(
02043 <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv)
02044 {
02045 
02046     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a1">TRACE_DDE1</a>(<span class="stringliteral">"FreeDdeConv(%#p)"</span>, pDdeConv);
02047 
02048     <span class="keywordflow">if</span> (!(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a603">CXF_TERMINATE_POSTED</a>) &amp;&amp;
02049             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>)) {
02050         <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>, WM_DDE_TERMINATE,
02051                 (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a>), 0);
02052         <span class="comment">// pDdeConv-&gt;flags |= CXF_TERMINATE_POSTED; set by PostHookProc</span>
02053     }
02054 
02055     <span class="keywordflow">if</span> (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
02056             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pDdeConv)-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>) {
02057         <span class="comment">/*</span>
02058 <span class="comment">         * Fake that the other side already posted a terminate.</span>
02059 <span class="comment">         * This prevents vestigal dde structures from hanging</span>
02060 <span class="comment">         * around after thread cleanup if the conversation structure</span>
02061 <span class="comment">         * is destroyed before the associated window.</span>
02062 <span class="comment">         */</span>
02063         pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o8">flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a603">CXF_TERMINATE_POSTED</a>;
02064     }
02065 
02066     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a35">UnlinkConv</a>(pDdeConv);
02067 
02068     <span class="keywordflow">if</span> (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o9">pddei</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02069         pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o9">pddei</a>-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o3">cRefConv</a>--;
02070         <span class="keywordflow">if</span> (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o9">pddei</a>-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o3">cRefConv</a> == 0 &amp;&amp; pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o9">pddei</a>-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o2">cRefInit</a> == 0) {
02071             <a class="code" href="../../d0/d5/se_8h.html#a12">SeDeleteClientSecurity</a>(&amp;pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o9">pddei</a>-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o1">ClientContext</a>);
02072             UserFreePool(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o9">pddei</a>);
02073         }
02074         pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o9">pddei</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02075     }
02076 
02077     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o2">spartnerConv</a>));
02078     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o4">spwndPartner</a>));
02079     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;(pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o3">spwnd</a>));
02080 
02081     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>((<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)pDdeConv))
02082         <span class="keywordflow">return</span>;
02083 
02084     <span class="keywordflow">while</span> (pDdeConv-&gt;spxsOut) {
02085         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a34">PopState</a>(pDdeConv);
02086     }
02087 
02088     <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pDdeConv);
02089 }
02090 
02091 
02092 
02093 <span class="comment">/***************************************************************************\</span>
02094 <span class="comment">* xxxCopyDdeIn</span>
02095 <span class="comment">*</span>
02096 <span class="comment">* Description:</span>
02097 <span class="comment">*   Copies DDE data from the CSR client to the CSR server side.</span>
02098 <span class="comment">*   Crosses the CSR barrier as many times as is needed to get all the data</span>
02099 <span class="comment">*   through the CSR window.</span>
02100 <span class="comment">*</span>
02101 <span class="comment">* History:</span>
02102 <span class="comment">* 11-1-91   sanfords    Created.</span>
02103 <span class="comment">\***************************************************************************/</span>
<a name="l02104"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a29">02104</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a29">xxxCopyDdeIn</a>(
02105 HANDLE hSrc,
02106 PDWORD pflags,
02107 PHANDLE phDirect,
02108 <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> *ppi)
02109 {
02110     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRet;
02111     <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pi;
02112 
02113     dwRet = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a39">xxxClientCopyDDEIn1</a>(hSrc, *pflags, ppi);
02114     pi = *ppi;
02115     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a2">TRACE_DDE2</a>(*pflags &amp; <a class="code" href="../../d6/d4/ddetrack_8h.html#a12">XS_FREESRC</a> ?
02116             <span class="stringliteral">"Copying in and freeing %#p(%#p)"</span> :
02117             <span class="stringliteral">"Copying in %#p(%#p)"</span>,
02118             hSrc, pi ? pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o2">hDirect</a> : 0);
02119 
02120     <span class="keywordflow">if</span> (dwRet == <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>) {
02121         UserAssert(*ppi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02122         *pflags = pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o1">flags</a>;
02123         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a3">TRACE_DDE3</a>(<span class="stringliteral">"xxxCopyDdeIn: uiLo=%x, uiHi=%x, hDirect=%#p"</span>,
02124                 pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o0">DdePack</a>.<a class="code" href="../../d9/d2/structtagDDEPACK.html#o0">uiLo</a>, pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o0">DdePack</a>.<a class="code" href="../../d9/d2/structtagDDEPACK.html#o1">uiHi</a>, pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o2">hDirect</a>);
02125         <span class="keywordflow">if</span> (phDirect != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02126             *phDirect = pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o2">hDirect</a>;
02127         }
02128     }
02129 <span class="preprocessor">#if DBG</span>
02130 <span class="preprocessor"></span>      <span class="keywordflow">else</span> {
02131         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Unable to alloc DDE INTDDEINFO"</span>);
02132     }
02133 <span class="preprocessor">#endif</span>
02134 <span class="preprocessor"></span>
02135     <span class="keywordflow">return</span>(dwRet);
02136 }
02137 
02138 
02139 
02140 <span class="comment">/***********************************************************************\</span>
02141 <span class="comment">* xxxCopyDDEOut</span>
02142 <span class="comment">*</span>
02143 <span class="comment">* Returns: the apropriate client side handle for lParam or NULL on</span>
02144 <span class="comment">* failure. (Since only TERMINATES should have 0 here)</span>
02145 <span class="comment">*</span>
02146 <span class="comment">* 11/7/1995 Created SanfordS</span>
02147 <span class="comment">\***********************************************************************/</span>
02148 
<a name="l02149"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a31">02149</a> HANDLE <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a31">xxxCopyDDEOut</a>(
02150 <a class="code" href="../../d7/d8/structtagINTDDEINFO.html">PINTDDEINFO</a> pi,
02151 PHANDLE phDirect)   <span class="comment">// receives the target client side GMEM handle.</span>
02152 {
02153     HANDLE hDst;
02154 
02155     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a3">TRACE_DDE3</a>(<span class="stringliteral">"xxxCopyDDEOut: cbDirect=%x, cbIndirect=%x, flags=%x"</span>,
02156             pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o4">cbDirect</a>, pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o7">cbIndirect</a>, pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o1">flags</a>);
02157     hDst = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a40">xxxClientCopyDDEOut1</a>(pi);
02158     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a3">TRACE_DDE3</a>(<span class="stringliteral">"xxxCopyDDEOut: uiLo=%x, uiHi=%x, hResult=%#p"</span>,
02159             pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o0">DdePack</a>.<a class="code" href="../../d9/d2/structtagDDEPACK.html#o0">uiLo</a>, pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o0">DdePack</a>.<a class="code" href="../../d9/d2/structtagDDEPACK.html#o1">uiHi</a>, hDst);
02160     <span class="keywordflow">if</span> (hDst != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02161         <span class="keywordflow">if</span> (phDirect != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02162             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a1">TRACE_DDE1</a>(<span class="stringliteral">"xxxCopyDDEOut: *phDirect=%#p"</span>, pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o2">hDirect</a>);
02163             *phDirect = pi-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o2">hDirect</a>;
02164         }
02165     }
02166     <span class="keywordflow">return</span>(hDst);
02167 }
02168 
02169 
02170 
02171 <span class="comment">/*</span>
02172 <span class="comment"> * This API is used to set the QOS associated with a potential DDE client window.</span>
02173 <span class="comment"> * It should be called prior to sending a WM_DDE_INITIATE message and the qos set</span>
02174 <span class="comment"> * will hold until the WM_DDE_INITIATE send or broadcast returns.</span>
02175 <span class="comment"> */</span>
<a name="l02176"></a><a class="code" href="../../d4/d1/userk_8h.html#a1127">02176</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1127">_DdeSetQualityOfService</a>(
02177 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndClient,
02178 CONST PSECURITY_QUALITY_OF_SERVICE pqosNew,
02179 PSECURITY_QUALITY_OF_SERVICE pqosOld)
02180 {
02181     PSECURITY_QUALITY_OF_SERVICE pqosUser;
02182     PSECURITY_QUALITY_OF_SERVICE pqosAlloc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02183     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet;
02184 
02185     <span class="comment">/*</span>
02186 <span class="comment">     * ASSUME: calling process is owner of pwndClient - ensured in thunk.</span>
02187 <span class="comment">     */</span>
02188     pqosUser = (PSECURITY_QUALITY_OF_SERVICE)<a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a1">InternalRemoveProp</a>(pwndClient,
02189             <a class="code" href="../../d4/d1/userk_8h.html#a477">PROP_QOS</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
02190     <span class="keywordflow">if</span> (pqosUser == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02191         <span class="keywordflow">if</span> (RtlEqualMemory(pqosNew, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a311">gqosDefault</a>, <span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE))) {
02192             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);           <span class="comment">// no PROP_QOS property implies default QOS</span>
02193         }
02194         pqosAlloc = (PSECURITY_QUALITY_OF_SERVICE)UserAllocPoolZInit(
02195                 <span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE), TAG_DDE2);
02196         <span class="keywordflow">if</span> (pqosAlloc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02197             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);          <span class="comment">// memory allocation failure - can't change from default</span>
02198         }
02199         pqosUser = pqosAlloc;
02200     }
02201     *pqosOld = *pqosUser;
02202     *pqosUser = *pqosNew;
02203 
02204     fRet = <a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a0">InternalSetProp</a>(pwndClient, <a class="code" href="../../d4/d1/userk_8h.html#a477">PROP_QOS</a>, pqosUser, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
02205     <span class="keywordflow">if</span> ((fRet == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (pqosAlloc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02206         UserFreePool(pqosAlloc);
02207     }
02208 
02209     <span class="keywordflow">return</span> fRet;
02210 }
02211 
02212 
02213 <span class="comment">/*</span>
02214 <span class="comment"> * This is a private API for NetDDE's use.  It extracts the QOS associated with an</span>
02215 <span class="comment"> * active DDE conversation.  Intra-process conversations always are set to the default</span>
02216 <span class="comment"> * QOS.</span>
02217 <span class="comment"> */</span>
<a name="l02218"></a><a class="code" href="../../d4/d1/userk_8h.html#a1128">02218</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1128">_DdeGetQualityOfService</a>(
02219 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndClient,
02220 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndServer,
02221 PSECURITY_QUALITY_OF_SERVICE pqos)
02222 {
02223     <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv;
02224     PSECURITY_QUALITY_OF_SERVICE pqosClient;
02225 
02226     <span class="keywordflow">if</span> (pwndServer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02227         <span class="comment">/*</span>
02228 <span class="comment">         * Special case to support DDEML-RAW conversations that need to get</span>
02229 <span class="comment">         * the QOS prior to initiation completion.</span>
02230 <span class="comment">         */</span>
02231         pqosClient = <a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwndClient, <a class="code" href="../../d4/d1/userk_8h.html#a477">PROP_QOS</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
02232         <span class="keywordflow">if</span> (pqosClient == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02233             *pqos = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a311">gqosDefault</a>;
02234         } <span class="keywordflow">else</span> {
02235             *pqos = *pqosClient;
02236         }
02237         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02238     }
02239     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a458">GETPWNDPPI</a>(pwndClient) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a458">GETPWNDPPI</a>(pwndServer)) {
02240         *pqos = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a311">gqosDefault</a>;
02241         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02242     }
02243     pDdeConv = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a21">FindDdeConv</a>(pwndClient, pwndServer);
02244     <span class="keywordflow">if</span> (pDdeConv == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02245         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02246     }
02247     <span class="keywordflow">if</span> (pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o9">pddei</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02248         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02249     }
02250     *pqos = pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o9">pddei</a>-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o0">qos</a>;
02251     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02252 }
02253 
02254 
02255 
<a name="l02256"></a><a class="code" href="../../d4/d1/userk_8h.html#a1879">02256</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1879">_ImpersonateDdeClientWindow</a>(
02257     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndClient,
02258     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndServer)
02259 {
02260     <a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a> pDdeConv;
02261     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02262 
02263     <span class="comment">/*</span>
02264 <span class="comment">     * Locate token used in the conversation</span>
02265 <span class="comment">     */</span>
02266     pDdeConv = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a21">FindDdeConv</a>(pwndClient, pwndServer);
02267     <span class="keywordflow">if</span> (pDdeConv == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o9">pddei</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02268         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02269 
02270     <span class="comment">/*</span>
02271 <span class="comment">     * Stick the token into the dde server thread</span>
02272 <span class="comment">     */</span>
02273     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d5/seclient_8c.html#a3">SeImpersonateClientEx</a>(&amp;pDdeConv-&gt;<a class="code" href="../../d6/d2/structtagDDECONV.html#o9">pddei</a>-&gt;<a class="code" href="../../d7/d2/structtagDDEIMP.html#o1">ClientContext</a>,
02274             <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>());
02275     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02276         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">""</span>);
02277         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02278     }
02279     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02280 }
02281 
02282 
02283 
02284 
<a name="l02285"></a><a class="code" href="../../d4/d1/userk_8h.html#a1875">02285</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1875">FreeDdeXact</a>(
02286 <a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a> pxs)
02287 {
02288     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>(pxs))
02289         <span class="keywordflow">return</span>;
02290 
02291 <span class="preprocessor">#if 0</span>
02292 <span class="preprocessor"></span>    {
02293         <span class="keywordtype">int</span> i;
02294         <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">HANDLEENTRY</a> *phe;
02295 
02296         <span class="keywordflow">for</span> (i = 0, phe = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>;
02297             i &lt;= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>;
02298                 i++) {
02299             <span class="keywordflow">if</span> (phe[i].bType == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a247">TYPE_DDEXACT</a>) {
02300                 UserAssert(((<a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a>)(phe[i].phead))-&gt;snext != pxs);
02301             }
02302             <span class="keywordflow">if</span> (phe[i].bType == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a246">TYPE_DDECONV</a>) {
02303                 UserAssert(((<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a>)(phe[i].phead))-&gt;spxsOut != pxs);
02304                 UserAssert(((<a class="code" href="../../d6/d2/structtagDDECONV.html">PDDECONV</a>)(phe[i].phead))-&gt;spxsIn != pxs);
02305             }
02306         }
02307     }
02308     UserAssert(pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o0">head</a>.cLockObj == 0);
02309     UserAssert(pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o1">snext</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02310 <span class="preprocessor">#endif</span>
02311 <span class="preprocessor"></span>
02312     <span class="keywordflow">if</span> (pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o5">pIntDdeInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02313         <span class="comment">/*</span>
02314 <span class="comment">         * free any server-side GDI objects</span>
02315 <span class="comment">         */</span>
02316         <span class="keywordflow">if</span> (pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o5">pIntDdeInfo</a>-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o1">flags</a> &amp; (<a class="code" href="../../d6/d4/ddetrack_8h.html#a2">XS_METAFILEPICT</a> | <a class="code" href="../../d6/d4/ddetrack_8h.html#a5">XS_ENHMETAFILE</a>)) {
02317             GreDeleteServerMetaFile(pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o5">pIntDdeInfo</a>-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o5">hIndirect</a>);
02318         }
02319         <span class="keywordflow">if</span> (pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp; <a class="code" href="../../d6/d4/ddetrack_8h.html#a13">XS_PUBLICOBJ</a>) {
02320             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a44">RemovePublicObject</a>(((<a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a>)(pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o5">pIntDdeInfo</a> + 1))-&gt;wFmt,
02321                     pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o5">pIntDdeInfo</a>-&gt;<a class="code" href="../../d7/d8/structtagINTDDEINFO.html#o5">hIndirect</a>);
02322             pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp;= ~<a class="code" href="../../d6/d4/ddetrack_8h.html#a13">XS_PUBLICOBJ</a>;
02323         }
02324         UserFreePool(pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o5">pIntDdeInfo</a>);
02325     }
02326 
02327     <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pxs);
02328     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a4">ValidatePublicObjectList</a>();
02329 }
02330 
02331 
02332 
<a name="l02333"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a42">02333</a> <a class="code" href="../../d6/d4/structtagPUBOBJ.html">PPUBOBJ</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a42">IsObjectPublic</a>(
02334 HANDLE hObj)
02335 {
02336     <a class="code" href="../../d6/d4/structtagPUBOBJ.html">PPUBOBJ</a> ppo;
02337 
02338     <span class="keywordflow">for</span> (ppo = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a6">gpPublicObjectList</a>; ppo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ppo = ppo-&gt;<a class="code" href="../../d6/d4/structtagPUBOBJ.html#o0">next</a>) {
02339         <span class="keywordflow">if</span> (ppo-&gt;<a class="code" href="../../d6/d4/structtagPUBOBJ.html#o1">hObj</a> == hObj) {
02340             <span class="keywordflow">break</span>;
02341         }
02342     }
02343     <span class="keywordflow">return</span>(ppo);
02344 }
02345 
02346 
02347 
<a name="l02348"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a43">02348</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a43">AddPublicObject</a>(
02349 UINT format,
02350 HANDLE hObj,
02351 W32PID pid)
02352 {
02353     <a class="code" href="../../d6/d4/structtagPUBOBJ.html">PPUBOBJ</a> ppo;
02354 
02355     <span class="keywordflow">switch</span> (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>) {
02356     <span class="keywordflow">case</span> CF_BITMAP:
02357     <span class="keywordflow">case</span> CF_DSPBITMAP:
02358     <span class="keywordflow">case</span> CF_PALETTE:
02359         <span class="keywordflow">break</span>;
02360 
02361     <span class="keywordflow">default</span>:
02362         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02363     }
02364 
02365     ppo = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a42">IsObjectPublic</a>(hObj);
02366     <span class="keywordflow">if</span> (ppo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02367         ppo = UserAllocPool(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/structtagPUBOBJ.html">PUBOBJ</a>), TAG_DDE4);
02368         <span class="keywordflow">if</span> (ppo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02369             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02370         }
02371         ppo-&gt;<a class="code" href="../../d6/d4/structtagPUBOBJ.html#o2">count</a> = 1;
02372         ppo-&gt;<a class="code" href="../../d6/d4/structtagPUBOBJ.html#o1">hObj</a> = hObj;
02373         ppo-&gt;<a class="code" href="../../d6/d4/structtagPUBOBJ.html#o3">pid</a> = pid;
02374         ppo-&gt;<a class="code" href="../../d6/d4/structtagPUBOBJ.html#o0">next</a> = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a6">gpPublicObjectList</a>;
02375         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a6">gpPublicObjectList</a> = ppo;
02376         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a45">GiveObject</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>, hObj, OBJECT_OWNER_PUBLIC);
02377     } <span class="keywordflow">else</span> {
02378         ppo-&gt;<a class="code" href="../../d6/d4/structtagPUBOBJ.html#o2">count</a>++;
02379     }
02380     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02381 }
02382 
02383 
02384 
<a name="l02385"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a44">02385</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a44">RemovePublicObject</a>(
02386 UINT format,
02387 HANDLE hObj)
02388 {
02389     <a class="code" href="../../d6/d4/structtagPUBOBJ.html">PPUBOBJ</a> ppo, ppoPrev;
02390 
02391     <span class="keywordflow">switch</span> (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>) {
02392     <span class="keywordflow">case</span> CF_BITMAP:
02393     <span class="keywordflow">case</span> CF_DSPBITMAP:
02394     <span class="keywordflow">case</span> CF_PALETTE:
02395         <span class="keywordflow">break</span>;
02396 
02397     <span class="keywordflow">default</span>:
02398         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02399     }
02400 
02401     <span class="keywordflow">for</span> (ppoPrev = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ppo = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a6">gpPublicObjectList</a>;
02402             ppo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02403                 ppoPrev = ppo, ppo = ppo-&gt;<a class="code" href="../../d6/d4/structtagPUBOBJ.html#o0">next</a>) {
02404         <span class="keywordflow">if</span> (ppo-&gt;hObj == hObj) {
02405             <span class="keywordflow">break</span>;
02406         }
02407     }
02408     <span class="keywordflow">if</span> (ppo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02409         UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02410         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02411     }
02412     ppo-&gt;count--;
02413     <span class="keywordflow">if</span> (ppo-&gt;count == 0) {
02414         <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a45">GiveObject</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>, hObj, ppo-&gt;pid);
02415         <span class="keywordflow">if</span> (ppoPrev != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02416             ppoPrev-&gt;<a class="code" href="../../d6/d4/structtagPUBOBJ.html#o0">next</a> = ppo-&gt;<a class="code" href="../../d6/d4/structtagPUBOBJ.html#o0">next</a>;
02417         } <span class="keywordflow">else</span> {
02418             <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a6">gpPublicObjectList</a> = ppo-&gt;<a class="code" href="../../d6/d4/structtagPUBOBJ.html#o0">next</a>;
02419         }
02420         UserFreePool(ppo);
02421     }
02422     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02423 }
02424 
02425 
02426 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l02427"></a><a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a45">02427</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a45">GiveObject</a>(
02428     UINT format,
02429     HANDLE hObj,
02430     W32PID pid)
02431 {
02432     <span class="keywordflow">switch</span> (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>) {
02433     <span class="keywordflow">case</span> CF_BITMAP:
02434     <span class="keywordflow">case</span> CF_DSPBITMAP:
02435         GreSetBitmapOwner(hObj, pid);
02436         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02437 
02438     <span class="keywordflow">case</span> CF_PALETTE:
02439         GreSetPaletteOwner(hObj, pid);
02440         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02441 
02442     <span class="keywordflow">default</span>:
02443         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02444     }
02445 }
02446 
02447 <span class="preprocessor">#if DBG</span>
02448 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a4">ValidatePublicObjectList</a>()
02449 {
02450     <a class="code" href="../../d6/d4/structtagPUBOBJ.html">PPUBOBJ</a> ppo;
02451     <span class="keywordtype">int</span> i, count;
02452     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">HANDLEENTRY</a> *phe;
02453 
02454     <span class="keywordflow">for</span> (count = 0, ppo = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a6">gpPublicObjectList</a>;
02455             ppo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02456                 ppo = ppo-&gt;next) {
02457         count += ppo-&gt;count;
02458     }
02459     <span class="keywordflow">for</span> (i = 0, phe = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>;
02460         i &lt;= (<span class="keywordtype">int</span>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>;
02461             i++) {
02462         <span class="keywordflow">if</span> (phe[i].bType == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a247">TYPE_DDEXACT</a>) {
02463             <span class="keywordflow">if</span> (((<a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a>)(phe[i].phead))-&gt;flags &amp; <a class="code" href="../../d6/d4/ddetrack_8h.html#a13">XS_PUBLICOBJ</a>) {
02464                 UserAssert(((<a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a>)(phe[i].phead))-&gt;pIntDdeInfo != NULL);
02465                 UserAssert(<a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a42">IsObjectPublic</a>(((<a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a>)
02466                         (phe[i].phead))-&gt;pIntDdeInfo-&gt;hIndirect) != NULL);
02467                 count--;
02468             }
02469         }
02470     }
02471     UserAssert(count == 0);
02472 }
02473 
02474 
02475 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a5">TraceDdeMsg</a>(
02476 UINT msg,
02477 HWND hwndFrom,
02478 HWND hwndTo,
02479 UINT code)
02480 {
02481     LPSTR szMsg, szType;
02482 
02483     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> &amp; 0xFFFF;
02484 
02485     <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
02486     <span class="keywordflow">case</span> WM_DDE_INITIATE:
02487         szMsg = <span class="stringliteral">"INITIATE"</span>;
02488         <span class="keywordflow">break</span>;
02489 
02490     <span class="keywordflow">case</span> WM_DDE_TERMINATE:
02491         szMsg = <span class="stringliteral">"TERMINATE"</span>;
02492         <span class="keywordflow">break</span>;
02493 
02494     <span class="keywordflow">case</span> WM_DDE_ADVISE:
02495         szMsg = <span class="stringliteral">"ADVISE"</span>;
02496         <span class="keywordflow">break</span>;
02497 
02498     <span class="keywordflow">case</span> WM_DDE_UNADVISE:
02499         szMsg = <span class="stringliteral">"UNADVISE"</span>;
02500         <span class="keywordflow">break</span>;
02501 
02502     <span class="keywordflow">case</span> WM_DDE_ACK:
02503         szMsg = <span class="stringliteral">"ACK"</span>;
02504         <span class="keywordflow">break</span>;
02505 
02506     <span class="keywordflow">case</span> WM_DDE_DATA:
02507         szMsg = <span class="stringliteral">"DATA"</span>;
02508         <span class="keywordflow">break</span>;
02509 
02510     <span class="keywordflow">case</span> WM_DDE_REQUEST:
02511         szMsg = <span class="stringliteral">"REQUEST"</span>;
02512         <span class="keywordflow">break</span>;
02513 
02514     <span class="keywordflow">case</span> WM_DDE_POKE:
02515         szMsg = <span class="stringliteral">"POKE"</span>;
02516         <span class="keywordflow">break</span>;
02517 
02518     <span class="keywordflow">case</span> WM_DDE_EXECUTE:
02519         szMsg = <span class="stringliteral">"EXECUTE"</span>;
02520         <span class="keywordflow">break</span>;
02521 
02522     <span class="keywordflow">default</span>:
02523         szMsg = <span class="stringliteral">"BOGUS"</span>;
02524         UserAssert(msg &gt;= WM_DDE_FIRST &amp;&amp; msg &lt;= WM_DDE_LAST);
02525         <span class="keywordflow">break</span>;
02526     }
02527 
02528     <span class="keywordflow">switch</span> (code) {
02529     <span class="keywordflow">case</span> MSG_SENT:
02530         szType = <span class="stringliteral">"[sent]"</span>;
02531         <span class="keywordflow">break</span>;
02532 
02533     <span class="keywordflow">case</span> MSG_POST:
02534         szType = <span class="stringliteral">"[posted]"</span>;
02535         <span class="keywordflow">break</span>;
02536 
02537     <span class="keywordflow">case</span> MSG_RECV:
02538         szType = <span class="stringliteral">"[received]"</span>;
02539         <span class="keywordflow">break</span>;
02540 
02541     <span class="keywordflow">case</span> MSG_PEEK:
02542         szType = <span class="stringliteral">"[peeked]"</span>;
02543         <span class="keywordflow">break</span>;
02544 
02545     <span class="keywordflow">default</span>:
02546         szType = <span class="stringliteral">"[bogus]"</span>;
02547         UserAssert(FALSE);
02548         <span class="keywordflow">break</span>;
02549     }
02550 
02551     RIPMSG4(RIP_VERBOSE,
02552             <span class="stringliteral">"%#p-&gt;%#p WM_DDE_%s %s"</span>,
02553             hwndFrom, hwndTo, szMsg, szType);
02554 }
02555 <span class="preprocessor">#endif //DBG</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
