<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: edecrare.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>edecrare.c</h1><a href="../../d5/d4/edecrare_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************************************************************\</span>
00002 <span class="comment">* edECRare.c - EC Edit controls Routines Called rarely are to be</span>
00003 <span class="comment">* put in a seperate segment _EDECRare. This file contains</span>
00004 <span class="comment">* these routines.</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* Support Routines common to Single-line and Multi-Line edit controls</span>
00009 <span class="comment">* called Rarely.</span>
00010 <span class="comment">*</span>
00011 <span class="comment">* Created: 02-08-89 sankar</span>
00012 <span class="comment">\****************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
00017 
<a name="l00018"></a><a class="code" href="../../d5/d4/edecrare_8c.html#a5">00018</a> <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__LOOKASIDE.html">LOOKASIDE</a> <a class="code" href="../../d5/d4/edecrare_8c.html#a5">EditLookaside</a>;
00019 
<a name="l00020"></a><a class="code" href="../../d5/d4/edecrare_8c.html#a0">00020</a> <span class="preprocessor">#define WS_EX_EDGEMASK (WS_EX_WINDOWEDGE | WS_EX_CLIENTEDGE)</span>
00021 <span class="preprocessor"></span>
00022 <span class="comment">/*</span>
00023 <span class="comment"> * Those two macros assume PED can be referred as "ped."</span>
00024 <span class="comment"> */</span>
<a name="l00025"></a><a class="code" href="../../d5/d4/edecrare_8c.html#a1">00025</a> <span class="preprocessor">#define GetCharABCWidthsAorW    ((ped)-&gt;fAnsi ? GetCharABCWidthsA : GetCharABCWidthsW)</span>
<a name="l00026"></a><a class="code" href="../../d5/d4/edecrare_8c.html#a2">00026</a> <span class="preprocessor"></span><span class="preprocessor">#define GetCharWidthAorW        ((ped)-&gt;fAnsi ? GetCharWidthA : GetCharWidthW)</span>
00027 <span class="preprocessor"></span>
<a name="l00028"></a><a class="code" href="../../d5/d4/edecrare_8c.html#a3">00028</a> <span class="preprocessor">#define umin(a, b)  ((unsigned)(a) &lt; (unsigned)(b) ? (unsigned)(a) : (unsigned)(b))</span>
00029 <span class="preprocessor"></span>
<a name="l00030"></a><a class="code" href="../../d5/d4/edecrare_8c.html#a6">00030</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a> (*<a class="code" href="../../d5/d4/edecrare_8c.html#a6">PFNABCWIDTHS</a>)(HDC, <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, LPABC);
<a name="l00031"></a><a class="code" href="../../d5/d4/edecrare_8c.html#a7">00031</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a> (*<a class="code" href="../../d5/d4/edecrare_8c.html#a7">PFNCHARWIDTH</a>)(HDC, <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, LPINT);
00032 
00033 <span class="comment">/***************************************************************************\</span>
00034 <span class="comment">*</span>
00035 <span class="comment">*  GetMaxOverlapChars - Gives maximum number of overlapping characters due to</span>
00036 <span class="comment">*                       negative A or C widths.</span>
00037 <span class="comment">*</span>
00038 <span class="comment">\***************************************************************************/</span>
<a name="l00039"></a><a class="code" href="../../d5/d4/edecrare_8c.html#a9">00039</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d4/edecrare_8c.html#a9">GetMaxOverlapChars</a>( <span class="keywordtype">void</span> )
00040 {
00041     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) MAKELONG( <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;wMaxLeftOverlapChars, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;wMaxRightOverlapChars ) ;
00042 }
00043 
00044 <span class="comment">/***************************************************************************\</span>
00045 <span class="comment">*</span>
00046 <span class="comment">*  ECSetMargin()</span>
00047 <span class="comment">*</span>
00048 <span class="comment">\***************************************************************************/</span>
<a name="l00049"></a><a class="code" href="../../d6/d0/usercli_8h.html#a455">00049</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a455">ECSetMargin</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, UINT  wFlags, <span class="keywordtype">long</span> lMarginValues, BOOL fRedraw)
00050 {
00051     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fUseFontInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00052     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wValue, wOldLeftMargin, wOldRightMargin;
00053 
00054 
00055     <span class="keywordflow">if</span> (wFlags &amp; EC_LEFTMARGIN)  <span class="comment">/* Set the left margin */</span> {
00056 
00057         <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>) (wValue = (<span class="keywordtype">int</span>)(<span class="keywordtype">short</span>)LOWORD(lMarginValues)) &lt; 0) {
00058             fUseFontInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00059             wValue = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a> / 2), (<span class="keywordtype">int</span>)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o76">wMaxNegA</a>);
00060         }
00061 
00062         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left += wValue - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>;
00063         wOldLeftMargin = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>;
00064         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a> = wValue;
00065     }
00066 
00067     <span class="keywordflow">if</span> (wFlags &amp; EC_RIGHTMARGIN)  <span class="comment">/* Set the Right margin */</span> {
00068 
00069         <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>) (wValue = (<span class="keywordtype">int</span>)(<span class="keywordtype">short</span>)HIWORD(lMarginValues)) &lt; 0) {
00070             fUseFontInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00071             wValue = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a> / 2), (<span class="keywordtype">int</span>)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o78">wMaxNegC</a>);
00072         }
00073 
00074         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right -= wValue - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a>;
00075         wOldRightMargin = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a>;
00076         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a> = wValue;
00077     }
00078 
00079     <span class="keywordflow">if</span> (fUseFontInfo) {
00080         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left &lt; 2 * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a>) {
00081             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ECSetMargin: rcFmt is too narrow for EC_USEFONTINFO"</span>);
00082 
00083             <span class="keywordflow">if</span> (wFlags &amp; EC_LEFTMARGIN)  <span class="comment">/* Reset the left margin */</span> {
00084                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left += wOldLeftMargin - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>;
00085                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a> = wOldLeftMargin;
00086             }
00087 
00088             <span class="keywordflow">if</span> (wFlags &amp; EC_RIGHTMARGIN)  <span class="comment">/* Reset the Right margin */</span> {
00089                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right -= wOldRightMargin - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a>;
00090                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a> = wOldRightMargin;
00091             }
00092 
00093             <span class="keywordflow">return</span>;
00094         }
00095     }
00096 
00097 <span class="comment">//    NtUserInvalidateRect(ped-&gt;hwnd, NULL, TRUE);</span>
00098     <span class="keywordflow">if</span> (fRedraw) {
00099         <a class="code" href="../../d6/d0/usercli_8h.html#a436">ECInvalidateClient</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00100     }
00101 }
00102 
00103 <span class="comment">// --------------------------------------------------------------------------</span>
00104 <span class="comment">//</span>
00105 <span class="comment">//  ECCalcMarginfForDBCSFont()</span>
00106 <span class="comment">//</span>
00107 <span class="comment">// Jun.24.1996 HideyukN - Ported from Windows95 FarEast version (edecrare.c)</span>
00108 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00109"></a><a class="code" href="../../d5/d4/edecrare_8c.html#a11">00109</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d4/edecrare_8c.html#a11">ECCalcMarginForDBCSFont</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, BOOL fRedraw)
00110 {
00111     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o41">fTrueType</a>)
00112         <span class="keywordflow">return</span>;
00113 
00114     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a>) {
00115         <span class="comment">// wMaxNegA came from ABC CharWidth.</span>
00116         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o76">wMaxNegA</a> != 0) {
00117             <a class="code" href="../../d6/d0/usercli_8h.html#a455">ECSetMargin</a>(ped, EC_LEFTMARGIN | EC_RIGHTMARGIN,
00118                     MAKELONG(EC_USEFONTINFO, EC_USEFONTINFO),fRedraw);
00119         }
00120     } <span class="keywordflow">else</span> {
00121         <span class="keywordtype">int</span>    iMaxNegA = 0, iMaxNegC = 0;
00122         <span class="keywordtype">int</span>    i;
00123         PVOID  lpBuffer;
00124         LPABC  lpABCBuff;
00125         ABC    ABCInfo;
00126         HFONT  hOldFont;
00127         HDC    hdc = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a250">NtUserGetDC</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
00128 
00129         <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o66">hFont</a> || !(hOldFont = SelectFont(hdc, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o66">hFont</a>))) {
00130             <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, hdc);
00131             <span class="keywordflow">return</span>;
00132         }
00133 
00134         <span class="keywordflow">if</span> (lpBuffer = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0,<span class="keyword">sizeof</span>(ABC) * 256)) {
00135             lpABCBuff = lpBuffer;
00136             <a class="code" href="../../d5/d4/edecrare_8c.html#a1">GetCharABCWidthsAorW</a>(hdc, 0, 255, lpABCBuff);
00137         } <span class="keywordflow">else</span> {
00138             lpABCBuff = &amp;ABCInfo;
00139             <a class="code" href="../../d5/d4/edecrare_8c.html#a1">GetCharABCWidthsAorW</a>(hdc, 0, 0, lpABCBuff);
00140         }
00141 
00142         i = 0;
00143         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00144             iMaxNegA = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(iMaxNegA, lpABCBuff-&gt;abcA);
00145             iMaxNegC = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(iMaxNegC, lpABCBuff-&gt;abcC);
00146             <span class="keywordflow">if</span> (++i == 256)
00147                 <span class="keywordflow">break</span>;
00148             <span class="keywordflow">if</span> (lpBuffer) {
00149                 lpABCBuff++;
00150             } <span class="keywordflow">else</span> {
00151                 <a class="code" href="../../d5/d4/edecrare_8c.html#a1">GetCharABCWidthsAorW</a>(hdc, i, i, lpABCBuff);
00152             }
00153         }
00154 
00155         SelectFont(hdc, hOldFont);
00156 
00157         <span class="keywordflow">if</span> (lpBuffer) <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpBuffer);
00158 
00159         <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, hdc);
00160 
00161         <span class="keywordflow">if</span> ((iMaxNegA != 0) || (iMaxNegC != 0))
00162            <a class="code" href="../../d6/d0/usercli_8h.html#a455">ECSetMargin</a>(ped, EC_LEFTMARGIN | EC_RIGHTMARGIN,
00163                     MAKELONG((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(-iMaxNegC), (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(-iMaxNegA)),fRedraw);
00164     }
00165 
00166     <span class="keywordflow">return</span>;
00167 }
00168 
00169 <span class="comment">// --------------------------------------------------------------------------</span>
00170 <span class="comment">//</span>
00171 <span class="comment">//  GetCharDimensionsEx(HDC hDC, HFONT hfont, LPTEXTMETRIC lptm, LPINT lpcy)</span>
00172 <span class="comment">//</span>
00173 <span class="comment">// Jun.24.1996 HideyukN - Ported from Windows95 FarEast version (wmclient.c)</span>
00174 <span class="comment">// --------------------------------------------------------------------------</span>
00175 
<a name="l00176"></a><a class="code" href="../../d5/d4/edecrare_8c.html#a8">00176</a> WCHAR <a class="code" href="../../d5/d4/edecrare_8c.html#a8">AveCharWidthData</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>;
00177 <span class="comment">//</span>
00178 <span class="comment">// if an app set a font for vertical writing, even though we don't</span>
00179 <span class="comment">// handle it with EC, the escapement of tm can be NON 0. Then cxWidth from</span>
00180 <span class="comment">// GetCharDimenstions() could be 0 in GetCharDimensions().</span>
00181 <span class="comment">// This will break our caller who don't expect 0 at return. So I created</span>
00182 <span class="comment">// this entry  for the case the caller set vertical font.</span>
00183 <span class="comment">//</span>
00184 <span class="comment">//</span>
<a name="l00185"></a><a class="code" href="../../d5/d4/edecrare_8c.html#a12">00185</a> <span class="keywordtype">int</span> <a class="code" href="../../d5/d4/edecrare_8c.html#a12">UserGetCharDimensionsEx</a>(HDC hDC, HFONT hfont, LPTEXTMETRIC lptm, LPINT lpcy)
00186 {
00187     <span class="keywordtype">int</span>         cxWidth;
00188     TEXTMETRIC  tm;
00189     LOGFONTW    <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a18">lf</a>;
00190     WCHAR       wchFaceName[LF_FACESIZE];
00191 
00192     <span class="comment">//</span>
00193     <span class="comment">// Is this font vertical font ??</span>
00194     <span class="comment">//</span>
00195     GetTextFaceW(hDC, LF_FACESIZE, wchFaceName);
00196     <span class="keywordflow">if</span> (wchFaceName[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'@'</span>) {
00197         <span class="comment">//</span>
00198         <span class="comment">// if not call GDI...</span>
00199         <span class="comment">//</span>
00200         <span class="keywordflow">return</span>(GdiGetCharDimensions(hDC, lptm, lpcy));
00201     }
00202 
00203     <span class="keywordflow">if</span> (!lptm)
00204         lptm = &amp;tm;
00205 
00206     GetTextMetrics(hDC, lptm);
00207 
00208     <span class="comment">// TMPF_FIXED_PITCH</span>
00209     <span class="comment">//</span>
00210     <span class="comment">//   If this bit is set the font is a variable pitch font.</span>
00211     <span class="comment">//   If this bit is clear the font is a fixed pitch font.</span>
00212     <span class="comment">// Note very carefully that those meanings are the opposite of what the constant name implies.</span>
00213     <span class="comment">//</span>
00214     <span class="keywordflow">if</span> (!(lptm-&gt;tmPitchAndFamily &amp; TMPF_FIXED_PITCH)) { <span class="comment">// If !variable_width font</span>
00215         <span class="comment">// This is fixed pitch font....</span>
00216         cxWidth = lptm-&gt;tmAveCharWidth;
00217     } <span class="keywordflow">else</span> {
00218         <span class="comment">// This is variable pitch font...</span>
00219         <span class="keywordflow">if</span> (hfont &amp;&amp; GetObjectW(hfont, <span class="keyword">sizeof</span>(LOGFONTW), &amp;<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a18">lf</a>) &amp;&amp; (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a18">lf</a>.lfEscapement != 0)) {
00220             cxWidth = lptm-&gt;tmAveCharWidth;
00221         } <span class="keywordflow">else</span> {
00222             SIZE size;
00223             GetTextExtentPointW(hDC, <a class="code" href="../../d5/d4/edecrare_8c.html#a8">AveCharWidthData</a>, 52, &amp;size);
00224             cxWidth = ((size.cx / 26) + 1) / 2;
00225         }
00226     }
00227 
00228     <span class="keywordflow">if</span> (lpcy)
00229         *lpcy = lptm-&gt;tmHeight;
00230 
00231     <span class="keywordflow">return</span>(cxWidth);
00232 }
00233 
00234 <span class="comment">/***************************************************************************\</span>
00235 <span class="comment">* ECGetText AorW</span>
00236 <span class="comment">*</span>
00237 <span class="comment">* Copies at most maxCchToCopy chars to the buffer lpBuffer. Returns</span>
00238 <span class="comment">* how many chars were actually copied. Null terminates the string based</span>
00239 <span class="comment">* on the fNullTerminate flag:</span>
00240 <span class="comment">* fNullTerminate --&gt; at most (maxCchToCopy - 1) characters will be copied</span>
00241 <span class="comment">* !fNullTerminate --&gt; at most (maxCchToCopy) characters will be copied</span>
00242 <span class="comment">*</span>
00243 <span class="comment">* History:</span>
00244 <span class="comment">\***************************************************************************/</span>
00245 
<a name="l00246"></a><a class="code" href="../../d6/d0/usercli_8h.html#a453">00246</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d6/d0/usercli_8h.html#a453">ECGetText</a>(
00247     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00248     ICH maxCchToCopy,
00249     LPSTR lpBuffer,
00250     BOOL fNullTerminate)
00251 {
00252     PSTR pText;
00253 
00254     <span class="keywordflow">if</span> (maxCchToCopy) {
00255 
00256         <span class="comment">/*</span>
00257 <span class="comment">         * Zero terminator takes the extra byte</span>
00258 <span class="comment">         */</span>
00259         <span class="keywordflow">if</span> (fNullTerminate)
00260             maxCchToCopy--;
00261         maxCchToCopy = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(maxCchToCopy, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>);
00262 
00263         <span class="comment">/*</span>
00264 <span class="comment">         * Zero terminate the string</span>
00265 <span class="comment">         */</span>
00266         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>)
00267             *(LPSTR)(lpBuffer + maxCchToCopy) = 0;
00268         <span class="keywordflow">else</span>
00269             *(((LPWSTR)lpBuffer) + maxCchToCopy) = 0;
00270 
00271         pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
00272         RtlCopyMemory(lpBuffer, pText, maxCchToCopy*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>);
00273         <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
00274     }
00275 
00276     <span class="keywordflow">return</span> maxCchToCopy;
00277 }
00278 
00279 <span class="comment">/***************************************************************************\</span>
00280 <span class="comment">* ECNcCreate AorW</span>
00281 <span class="comment">*</span>
00282 <span class="comment">* History:</span>
00283 <span class="comment">\***************************************************************************/</span>
00284 
<a name="l00285"></a><a class="code" href="../../d6/d0/usercli_8h.html#a435">00285</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a435">ECNcCreate</a>(
00286     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00287     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00288     LPCREATESTRUCT lpCreateStruct)
00289 {
00290     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00291     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAnsi;
00292 
00293     fAnsi = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a581">WFANSICREATOR</a>);
00294 
00295     <span class="comment">/*</span>
00296 <span class="comment">     * Initialize the ped</span>
00297 <span class="comment">     */</span>
00298     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o89">fEncoded</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00299     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o90">iLockLevel</a> = 0;
00300 
00301     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00302     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o73">pTabStops</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00303     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00304     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> = fAnsi ? 1 : 0; <span class="comment">// Force TRUE to be 1 because its a 1 bit field</span>
00305     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a> = (WORD)(fAnsi ? <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>) : <span class="keyword">sizeof</span>(WCHAR));
00306     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o87">hInstance</a> = pwnd-&gt;hModule;
00307     <span class="comment">// IME</span>
00308     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o92">hImcPrev</a> = <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00309 
00310     {
00311         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwVer = <a class="code" href="../../d6/d0/usercli_8h.html#a134">GETEXPWINVER</a>(lpCreateStruct-&gt;hInstance);
00312 
00313         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o43">fWin31Compat</a> = (dwVer &gt;= 0x030a);
00314         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o44">f40Compat</a> = (dwVer &gt;= 0x0400);
00315     }
00316 
00317     <span class="comment">//</span>
00318     <span class="comment">// NOTE:</span>
00319     <span class="comment">// The order of the following two checks is important.  People can</span>
00320     <span class="comment">// create edit fields with a 3D and a normal border, and we don't</span>
00321     <span class="comment">// want to disallow that.  But we need to detect the "no 3D border"</span>
00322     <span class="comment">// border case too.</span>
00323     <span class="comment">//</span>
00324     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a622">WEFEDGEMASK</a>))
00325     {
00326         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o28">fBorder</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00327     }
00328     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a644">WFBORDER</a>))
00329     {
00330         <a class="code" href="../../d4/d1/userk_8h.html#a1629">ClearWindowState</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a644">WFBORDER</a>);
00331         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o45">fFlatBorder</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00332         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o28">fBorder</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00333     }
00334 
00335     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a701">EFMULTILINE</a>))
00336         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00337 
00338     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>))
00339         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o25">fDisabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00340 
00341     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a710">EFREADONLY</a>)) {
00342         <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o43">fWin31Compat</a>) {
00343             <span class="comment">/*</span>
00344 <span class="comment">             * BACKWARD COMPATIBILITY HACK</span>
00345 <span class="comment">             *</span>
00346 <span class="comment">             * "MileStone" unknowingly sets the ES_READONLY style. So, we strip this</span>
00347 <span class="comment">             * style here for all Win3.0 apps (this style is new for Win3.1).</span>
00348 <span class="comment">             * Fix for Bug #12982 -- SANKAR -- 01/24/92 --</span>
00349 <span class="comment">             */</span>
00350              <a class="code" href="../../d4/d1/userk_8h.html#a1629">ClearWindowState</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a710">EFREADONLY</a>);
00351         } <span class="keywordflow">else</span>
00352             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o39">fReadOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00353     }
00354 
00355 
00356     <span class="comment">/*</span>
00357 <span class="comment">     * Allocate storage for the text for the edit controls. Storage for single</span>
00358 <span class="comment">     * line edit controls will always get allocated in the local data segment.</span>
00359 <span class="comment">     * Multiline will allocate in the local ds but the app may free this and</span>
00360 <span class="comment">     * allocate storage elsewhere...</span>
00361 <span class="comment">     */</span>
00362     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a> = <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a2">LOCALALLOC</a>(<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a0">LHND</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a71">CCHALLOCEXTRA</a>*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o87">hInstance</a>);
00363     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a>) {
00364         <a class="code" href="../../d6/d0/usercli_8h.html#a408">FreeLookasideEntry</a>(&amp;<a class="code" href="../../d5/d4/edecrare_8c.html#a5">EditLookaside</a>, ped);
00365         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a284">NtUserSetWindowFNID</a>(hwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a226">FNID_CLEANEDUP_BIT</a>); <span class="comment">/* No ped for this window */</span>
00366         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; <span class="comment">/* If no_memory error */</span>
00367     }
00368 
00369     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o1">cchAlloc</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a71">CCHALLOCEXTRA</a>;
00370     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a> = 1;
00371 
00372     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a> = hwnd;
00373     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o17">hwndParent</a> = lpCreateStruct-&gt;hwndParent;
00374 
00375     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o59">wImeStatus</a> = 0;
00376 
00377     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, WM_NCCREATE, 0,
00378             (LPARAM)lpCreateStruct, fAnsi);
00379 }
00380 
00381 <span class="comment">/***************************************************************************\</span>
00382 <span class="comment">* ECCreate AorW</span>
00383 <span class="comment">*</span>
00384 <span class="comment">* History:</span>
00385 <span class="comment">\***************************************************************************/</span>
00386 
<a name="l00387"></a><a class="code" href="../../d6/d0/usercli_8h.html#a437">00387</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a437">ECCreate</a>(
00388     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00389     LONG windowStyle)
00390 {
00391     HDC hdc;
00392 
00393     <span class="comment">/*</span>
00394 <span class="comment">     * Get values from the window instance data structure and put them in the</span>
00395 <span class="comment">     * ped so that we can access them easier.</span>
00396 <span class="comment">     */</span>
00397     <span class="keywordflow">if</span> (windowStyle &amp; ES_AUTOHSCROLL)
00398         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o30">fAutoHScroll</a> = 1;
00399     <span class="keywordflow">if</span> (windowStyle &amp; ES_NOHIDESEL)
00400         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o31">fNoHideSel</a> = 1;
00401 
00402     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> = (LOWORD(windowStyle) &amp; LOWORD(ES_FMTMASK));
00403     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a624">WEFRIGHT</a>) &amp;&amp; !ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a>)
00404         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> = ES_RIGHT;
00405 
00406     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o2">cchTextMax</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a75">MAXTEXT</a>; <span class="comment">/* Max # chars we will initially allow */</span>
00407 
00408     <span class="comment">/*</span>
00409 <span class="comment">     * Set up undo initial conditions... (ie. nothing to undo)</span>
00410 <span class="comment">     */</span>
00411     ped-&gt;ichDeleted = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)-1;
00412     ped-&gt;ichInsStart = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)-1;
00413     ped-&gt;ichInsEnd = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)-1;
00414 
00415     <span class="comment">// initial charset value - need to do this BEFORE MLCreate is called</span>
00416     <span class="comment">// so that we know not to fool with scrollbars if nessacary</span>
00417     hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00418     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o75">charSet</a> = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)GetTextCharset(hdc);
00419     <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00420 
00421     <span class="comment">// FE_IME</span>
00422     <span class="comment">// EC_INSERT_COMPOSITION_CHARACTER: ECCreate() - call ECInitInsert()</span>
00423     <a class="code" href="../../d6/d0/usercli_8h.html#a473">ECInitInsert</a>(ped, <a class="code" href="../../d6/d0/usercli_8h.html#a151">THREAD_HKL</a>());
00424 
00425     <span class="keywordflow">if</span>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a35">fpLpkEditControl</a>) {
00426         <span class="keywordflow">return</span> ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o0">EditCreate</a>(ped, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>));
00427     } <span class="keywordflow">else</span>
00428         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00429 }
00430 
00431 <span class="comment">/***************************************************************************\</span>
00432 <span class="comment">* ECNcDestroyHandler AorW</span>
00433 <span class="comment">*</span>
00434 <span class="comment">* Destroys the edit control ped by freeing up all memory used by it.</span>
00435 <span class="comment">*</span>
00436 <span class="comment">* History:</span>
00437 <span class="comment">\***************************************************************************/</span>
00438 
<a name="l00439"></a><a class="code" href="../../d6/d0/usercli_8h.html#a440">00439</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a440">ECNcDestroyHandler</a>(
00440     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00441     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
00442 {
00443     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent;
00444 
00445     <span class="comment">/*</span>
00446 <span class="comment">     * ped could be NULL if WM_NCCREATE failed to create it...</span>
00447 <span class="comment">     */</span>
00448     <span class="keywordflow">if</span> (ped) {
00449 
00450         <span class="comment">/*</span>
00451 <span class="comment">         * Free the text buffer (always present?)</span>
00452 <span class="comment">         */</span>
00453         <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a7">LOCALFREE</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o87">hInstance</a>);
00454 
00455         <span class="comment">/*</span>
00456 <span class="comment">         * Free up undo buffer and line start array (if present)</span>
00457 <span class="comment">         */</span>
00458         <span class="keywordflow">if</span> (ped-&gt;hDeletedText != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00459             <a class="code" href="../../d6/d0/usercli_8h.html#a2">UserGlobalFree</a>(ped-&gt;hDeletedText);
00460 
00461         <span class="comment">/*</span>
00462 <span class="comment">         * Free tab stop buffer (if present)</span>
00463 <span class="comment">         */</span>
00464         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o73">pTabStops</a>)
00465             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o73">pTabStops</a>);
00466 
00467         <span class="comment">/*</span>
00468 <span class="comment">         * Free line start array (if present)</span>
00469 <span class="comment">         */</span>
00470         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>) {
00471             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>);
00472         }
00473 
00474         <span class="comment">/*</span>
00475 <span class="comment">         * Free the character width buffer (if present)</span>
00476 <span class="comment">         */</span>
00477         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>)
00478             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>);
00479 
00480         <span class="comment">/*</span>
00481 <span class="comment">         * Free the cursor bitmap</span>
00482 <span class="comment">         */</span>
00483         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o85">hCaretBitmap</a>) {
00484             DeleteObject(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o85">hCaretBitmap</a>);
00485         }
00486 
00487         <span class="comment">/*</span>
00488 <span class="comment">         * Last but not least, free the ped</span>
00489 <span class="comment">         */</span>
00490         <a class="code" href="../../d6/d0/usercli_8h.html#a408">FreeLookasideEntry</a>(&amp;<a class="code" href="../../d5/d4/edecrare_8c.html#a5">EditLookaside</a>, ped);
00491     }
00492 
00493     <span class="comment">/*</span>
00494 <span class="comment">     * Set the window's fnid status so that we can ignore rogue messages</span>
00495 <span class="comment">     */</span>
00496     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a284">NtUserSetWindowFNID</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a226">FNID_CLEANEDUP_BIT</a>);
00497 
00498     <span class="comment">/*</span>
00499 <span class="comment">     * If we're part of a combo box, let it know we're gone</span>
00500 <span class="comment">     */</span>
00501     pwndParent = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndParent);
00502     <span class="keywordflow">if</span> (pwndParent &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwndParent) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a201">FNID_COMBOBOX</a>) {
00503         <a class="code" href="../../d6/d0/usercli_8h.html#a614">ComboBoxWndProcWorker</a>(pwndParent, WM_PARENTNOTIFY,
00504                 MAKELONG(WM_DESTROY, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>)), (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00505     }
00506 }
00507 
00508 <span class="comment">/***************************************************************************\</span>
00509 <span class="comment">* ECSetPasswordChar AorW</span>
00510 <span class="comment">*</span>
00511 <span class="comment">* Sets the password char to display.</span>
00512 <span class="comment">*</span>
00513 <span class="comment">* History:</span>
00514 <span class="comment">\***************************************************************************/</span>
00515 
<a name="l00516"></a><a class="code" href="../../d6/d0/usercli_8h.html#a442">00516</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a442">ECSetPasswordChar</a>(
00517     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00518     UINT pwchar)
00519 {
00520     HDC hdc;
00521     SIZE size;
00522 
00523     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o12">charPasswordChar</a> = pwchar;
00524 
00525     <span class="keywordflow">if</span> (pwchar) {
00526         hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00527         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>)
00528             GetTextExtentPointA(hdc, (LPSTR)&amp;pwchar, 1, &amp;size);
00529         <span class="keywordflow">else</span>
00530             GetTextExtentPointW(hdc, (LPWSTR)&amp;pwchar, 1, &amp;size);
00531 
00532         GetTextExtentPointW(hdc, (LPWSTR)&amp;pwchar, 1, &amp;size);
00533         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o13">cPasswordCharWidth</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(size.cx, 1);
00534         <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00535     }
00536     <span class="keywordflow">if</span> (pwchar)
00537         <a class="code" href="../../d4/d1/userk_8h.html#a1628">SetWindowState</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a704">EFPASSWORD</a>);
00538     <span class="keywordflow">else</span>
00539         <a class="code" href="../../d4/d1/userk_8h.html#a1629">ClearWindowState</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a704">EFPASSWORD</a>);
00540 
00541     <a class="code" href="../../d6/d0/usercli_8h.html#a469">ECEnableDisableIME</a>(ped);
00542 }
00543 
00544 <span class="comment">/***************************************************************************\</span>
00545 <span class="comment">*  GetNegABCwidthInfo()</span>
00546 <span class="comment">*    This function fills up the ped-&gt;charWidthBuffer buffer with the</span>
00547 <span class="comment">*      negative A,B and C widths for all the characters below 0x7f in the</span>
00548 <span class="comment">*      currently selected font.</span>
00549 <span class="comment">*  Returns:</span>
00550 <span class="comment">* TRUE, if the function succeeded.</span>
00551 <span class="comment">* FALSE, if GDI calls to get the char widths have failed.</span>
00552 <span class="comment">*</span>
00553 <span class="comment">* Note: not used if LPK installed</span>
00554 <span class="comment">\***************************************************************************/</span>
<a name="l00555"></a><a class="code" href="../../d5/d4/edecrare_8c.html#a18">00555</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   <a class="code" href="../../d5/d4/edecrare_8c.html#a18">GetNegABCwidthInfo</a>(
00556     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00557     HDC hdc)
00558 {
00559     LPABC lpABCbuff;
00560     <span class="keywordtype">int</span>   i;
00561     <span class="keywordtype">int</span>   CharWidthBuff[<a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a>]; <span class="comment">// Local char width buffer.</span>
00562     <span class="keywordtype">int</span>   iOverhang;
00563 
00564     <span class="keywordflow">if</span> (!GetCharABCWidthsA(hdc, 0, <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a>-1, (LPABC)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>)) {
00565         RIPMSG0(RIP_WARNING, <span class="stringliteral">"GetNegABCwidthInfo: GetCharABCWidthsA Failed"</span>);
00566         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00567     }
00568 
00569    <span class="comment">// The (A+B+C) returned for some fonts (eg: Lucida Caligraphy) does not</span>
00570    <span class="comment">// equal the actual advanced width returned by GetCharWidths() minus overhang.</span>
00571    <span class="comment">// This is due to font bugs. So, we adjust the 'B' width so that this</span>
00572    <span class="comment">// discrepancy is removed.</span>
00573    <span class="comment">// Fix for Bug #2932 --sankar-- 02/17/93</span>
00574    iOverhang = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o69">charOverhang</a>;
00575    GetCharWidthA(hdc, 0, <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a>-1, (LPINT)CharWidthBuff);
00576    lpABCbuff = (LPABC)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>;
00577    <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a>; i++) {
00578         lpABCbuff-&gt;abcB = CharWidthBuff[i] - iOverhang
00579                 - lpABCbuff-&gt;abcA
00580                 - lpABCbuff-&gt;abcC;
00581         lpABCbuff++;
00582    }
00583 
00584    <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00585 }
00586 
00587 <span class="comment">/***************************************************************************\</span>
00588 <span class="comment">*</span>
00589 <span class="comment">*  ECSize() -</span>
00590 <span class="comment">*</span>
00591 <span class="comment">*  Handle sizing for an edit control's client rectangle.</span>
00592 <span class="comment">*  Use lprc as the bounding rectangle if specified; otherwise use the current</span>
00593 <span class="comment">*  client rectangle.</span>
00594 <span class="comment">*</span>
00595 <span class="comment">\***************************************************************************/</span>
00596 
<a name="l00597"></a><a class="code" href="../../d6/d0/usercli_8h.html#a482">00597</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a482">ECSize</a>(
00598     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00599     LPRECT lprc,
00600     BOOL fRedraw)
00601 {
00602     RECT    rc;
00603 
00604     <span class="comment">/*</span>
00605 <span class="comment">     *  BiDi VB32 Creates an Edit Control and immediately sends a WM_SIZE</span>
00606 <span class="comment">     *  message which causes EXSize to be called before ECSetFont, which</span>
00607 <span class="comment">     *  in turn causes a divide by zero exception below. This check for</span>
00608 <span class="comment">     *  ped-&gt;lineHeight will pick it up safely. [samera] 3/5/97</span>
00609 <span class="comment">     */</span>
00610     <span class="keywordflow">if</span>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a> == 0)
00611         <span class="keywordflow">return</span>;
00612 
00613     <span class="comment">// assume that we won't be able to display the caret</span>
00614     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o40">fCaretHidden</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00615 
00616 
00617     <span class="keywordflow">if</span> ( lprc )
00618         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, lprc);
00619     <span class="keywordflow">else</span>
00620         <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, &amp;rc);
00621 
00622     <span class="keywordflow">if</span> (!(rc.right - rc.left) || !(rc.bottom - rc.top)) {
00623         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left)
00624             <span class="keywordflow">return</span>;
00625 
00626         rc.left     = 0;
00627         rc.top      = 0;
00628         rc.right    = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a> * 10;
00629         rc.bottom   = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>;
00630     }
00631 
00632     <span class="keywordflow">if</span> (!lprc) {
00633         <span class="comment">// subtract the margins from the given rectangle --</span>
00634         <span class="comment">// make sure that this rectangle is big enough to have these margins.</span>
00635         <span class="keywordflow">if</span> ((rc.right - rc.left) &gt; (<span class="keywordtype">int</span>)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a> + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a>)) {
00636             rc.left  += ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>;
00637             rc.right -= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a>;
00638         }
00639     }
00640 
00641     <span class="comment">//</span>
00642     <span class="comment">// Leave space so text doesn't touch borders.</span>
00643     <span class="comment">// For 3.1 compatibility, don't subtract out vertical borders unless</span>
00644     <span class="comment">// there is room.</span>
00645     <span class="comment">//</span>
00646     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o28">fBorder</a>) {
00647         <span class="keywordtype">int</span> cxBorder = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER);
00648         <span class="keywordtype">int</span> cyBorder = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER);
00649 
00650         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o45">fFlatBorder</a>)
00651         {
00652             cxBorder *= 2;
00653             cyBorder *= 2;
00654         }
00655 
00656         <span class="keywordflow">if</span> (rc.bottom &lt; rc.top + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a> + 2*cyBorder)
00657             cyBorder = 0;
00658 
00659         <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(&amp;rc, -cxBorder, -cyBorder);
00660     }
00661 
00662     <span class="comment">// Is the resulting rectangle too small?  Don't change it then.</span>
00663     <span class="keywordflow">if</span> ((!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a>) &amp;&amp; ((rc.right - rc.left &lt; (<span class="keywordtype">int</span>) ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a>) ||
00664         ((rc.bottom - rc.top) / ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a> == 0)))
00665         <span class="keywordflow">return</span>;
00666 
00667     <span class="comment">// now, we know we're safe to display the caret</span>
00668     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o40">fCaretHidden</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00669 
00670     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>, &amp;rc);
00671 
00672     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a>)
00673         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.bottom = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(rc.bottom, rc.top + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>);
00674     <span class="keywordflow">else</span>
00675         <a class="code" href="../../d6/d0/usercli_8h.html#a512">MLSize</a>(ped, fRedraw);
00676 
00677     <span class="keywordflow">if</span> (fRedraw) {
00678         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00679         <span class="comment">// UpdateWindow31(ped-&gt;hwnd);    Evaluates to NOP in Chicago - Johnl</span>
00680     }
00681 
00682     <span class="comment">// FE_IME</span>
00683     <span class="comment">// ECSize()  - call ECImmSetCompositionWindow()</span>
00684     <span class="comment">//</span>
00685     <span class="comment">// normally this isn't needed because WM_SIZE will cause</span>
00686     <span class="comment">// WM_PAINT and the paint handler will take care of IME</span>
00687     <span class="comment">// composition window. However when the edit window is</span>
00688     <span class="comment">// restored from maximized window and client area is out</span>
00689     <span class="comment">// of screen, the window will not be redrawn.</span>
00690     <span class="comment">//</span>
00691     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a> &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a312">fpImmIsIME</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a151">THREAD_HKL</a>())) {
00692         POINT pt;
00693 
00694         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a274">NtUserGetCaretPos</a>(&amp;pt);
00695         <a class="code" href="../../d6/d0/usercli_8h.html#a471">ECImmSetCompositionWindow</a>(ped, pt.x, pt.y);
00696     }
00697 }
00698 
00699 <span class="comment">/***************************************************************************\</span>
00700 <span class="comment">*</span>
00701 <span class="comment">*  ECSetFont AorW () -</span>
00702 <span class="comment">*</span>
00703 <span class="comment">*  Sets the font used in the edit control.  Warning:  Memory compaction may</span>
00704 <span class="comment">*  occur if the font wasn't previously loaded.  If the font handle passed</span>
00705 <span class="comment">*  in is NULL, assume the system font.</span>
00706 <span class="comment">*</span>
00707 <span class="comment">\***************************************************************************/</span>
<a name="l00708"></a><a class="code" href="../../d6/d0/usercli_8h.html#a454">00708</a> <span class="keywordtype">void</span>   <a class="code" href="../../d6/d0/usercli_8h.html#a454">ECSetFont</a>(
00709     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00710     HFONT hfont,
00711     BOOL fRedraw)
00712 {
00713     <span class="keywordtype">short</span>  i;
00714     TEXTMETRIC      TextMetrics;
00715     HDC             hdc;
00716     HFONT           hOldFont=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00717     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>            wBuffSize;
00718     LPINT           lpCharWidthBuff;
00719     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>           dwMaxOverlapChars;
00720     CHWIDTHINFO     cwi;
00721     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>            uExtracharPos;
00722 
00723     hdc = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a250">NtUserGetDC</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
00724 
00725     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o66">hFont</a> = hfont) {
00726         <span class="comment">//</span>
00727         <span class="comment">// Since the default font is the system font, no need to select it in</span>
00728         <span class="comment">// if that's what the user wants.</span>
00729         <span class="comment">//</span>
00730         <span class="keywordflow">if</span> (!(hOldFont = SelectObject(hdc, hfont))) {
00731             hfont = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o66">hFont</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00732         }
00733 
00734         <span class="comment">//</span>
00735         <span class="comment">// Get the metrics and ave char width for the currently selected font</span>
00736         <span class="comment">//</span>
00737 
00738         <span class="comment">//</span>
00739         <span class="comment">// Call Vertical font-aware AveWidth compute function...</span>
00740         <span class="comment">//</span>
00741         <span class="comment">// FE_SB</span>
00742         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a> = <a class="code" href="../../d5/d4/edecrare_8c.html#a12">UserGetCharDimensionsEx</a>(hdc, hfont, &amp;TextMetrics, &amp;ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>);
00743 
00744         <span class="comment">/*</span>
00745 <span class="comment">         * This might fail when people uses network fonts (or bad fonts).</span>
00746 <span class="comment">         */</span>
00747         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a> == 0) {
00748             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ECSetFont: GdiGetCharDimensions failed"</span>);
00749             <span class="keywordflow">if</span> (hOldFont != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00750                 SelectObject(hdc, hOldFont);
00751             }
00752 
00753             <span class="comment">/*</span>
00754 <span class="comment">             * We've messed up the ped so let's reset the font.</span>
00755 <span class="comment">             *  Note that we won't recurse more than once because we'll</span>
00756 <span class="comment">             *  pass hfont == NULL.</span>
00757 <span class="comment">             * Too bad WM_SETFONT doesn't return a value.</span>
00758 <span class="comment">             */</span>
00759             <a class="code" href="../../d6/d0/usercli_8h.html#a454">ECSetFont</a>(ped, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, fRedraw);
00760             <span class="keywordflow">return</span>;
00761         }
00762     } <span class="keywordflow">else</span> {
00763         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxSysFontChar;
00764         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cySysFontChar;
00765         TextMetrics = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;tmSysFont;
00766     }
00767 
00768     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o69">charOverhang</a> = TextMetrics.tmOverhang;
00769 
00770     <span class="comment">//assume that they don't have any negative widths at all.</span>
00771     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o76">wMaxNegA</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o78">wMaxNegC</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o77">wMaxNegAcharPos</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o79">wMaxNegCcharPos</a> = 0;
00772 
00773 
00774     <span class="comment">// Check if Proportional Width Font</span>
00775     <span class="comment">//</span>
00776     <span class="comment">// NOTE: as SDK doc says about TEXTMETRIC:</span>
00777     <span class="comment">// TMPF_FIXED_PITCH</span>
00778     <span class="comment">// If this bit is set the font is a variable pitch font. If this bit is clear</span>
00779     <span class="comment">// the font is a fixed pitch font. Note very carefully that those meanings are</span>
00780     <span class="comment">// the opposite of what the constant name implies.</span>
00781     <span class="comment">//</span>
00782     <span class="comment">// Thus we have to reverse the value using logical not (fNonPropFont has 1 bit width)</span>
00783     <span class="comment">//</span>
00784     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o26">fNonPropFont</a> = !(TextMetrics.tmPitchAndFamily &amp; FIXED_PITCH);
00785 
00786     <span class="comment">// Check for a TrueType font</span>
00787     <span class="comment">// Older app OZWIN chokes if we allocate a bigger buffer for TrueType fonts</span>
00788     <span class="comment">// So, for apps older than 4.0, no special treatment for TrueType fonts.</span>
00789     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o44">f40Compat</a> &amp;&amp; (TextMetrics.tmPitchAndFamily &amp; TMPF_TRUETYPE)) {
00790         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o41">fTrueType</a> = GetCharWidthInfo(hdc, &amp;cwi);
00791 <span class="preprocessor">#if DBG</span>
00792 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o41">fTrueType</a>) {
00793             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ECSetFont: GetCharWidthInfo Failed"</span>);
00794         }
00795 <span class="preprocessor">#endif</span>
00796 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00797         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o41">fTrueType</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00798     }
00799 
00800     <span class="comment">// FE_SB</span>
00801     <span class="comment">//</span>
00802     <span class="comment">// In DBCS Windows, Edit Control must handle Double Byte Character</span>
00803     <span class="comment">// if tmCharSet field of textmetrics is double byte character set</span>
00804     <span class="comment">// such as SHIFTJIS_CHARSET(128:Japan), HANGEUL_CHARSET(129:Korea).</span>
00805     <span class="comment">//</span>
00806     <span class="comment">// We call ECGetDBCSVector even when fAnsi is false so that we could</span>
00807     <span class="comment">// treat ped-&gt;fAnsi and ped-&gt;fDBCS indivisually. I changed ECGetDBCSVector</span>
00808     <span class="comment">// function so that it returns 0 or 1, because I would like to set ped-&gt;fDBCS</span>
00809     <span class="comment">// bit field here.</span>
00810     <span class="comment">//</span>
00811     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a463">ECGetDBCSVector</a>(ped,hdc,TextMetrics.tmCharSet);
00812     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o75">charSet</a> = TextMetrics.tmCharSet;
00813 
00814     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a>) {
00815         <span class="comment">//</span>
00816         <span class="comment">// Free the character width buffer if ped-&gt;fDBCS.</span>
00817         <span class="comment">//</span>
00818         <span class="comment">// I expect single GetTextExtentPoint call is faster than multiple</span>
00819         <span class="comment">// GetTextExtentPoint call (because the graphic engine has a cache buffer).</span>
00820         <span class="comment">// See editec.c/ECTabTheTextOut().</span>
00821         <span class="comment">//</span>
00822         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>) {
00823             LocalFree(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>);
00824             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00825         }
00826 
00827         <span class="comment">//</span>
00828         <span class="comment">// if FullWidthChar : HalfWidthChar == 2 : 1....</span>
00829         <span class="comment">//</span>
00830         <span class="comment">// TextMetrics.tmMaxCharWidth = FullWidthChar width</span>
00831         <span class="comment">// ped-&gt;aveCharWidth          = HalfWidthChar width</span>
00832         <span class="comment">//</span>
00833         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o26">fNonPropFont</a> &amp;&amp;
00834             ((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a> * 2) == TextMetrics.tmMaxCharWidth)) {
00835             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o27">fNonPropDBCS</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00836         } <span class="keywordflow">else</span> {
00837             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o27">fNonPropDBCS</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00838         }
00839 
00840     } <span class="keywordflow">else</span> {
00841 
00842         <span class="comment">//</span>
00843         <span class="comment">// Since the font has changed, let us obtain and save the character width</span>
00844         <span class="comment">// info for this font.</span>
00845         <span class="comment">//</span>
00846         <span class="comment">// First left us find out if the maximum chars that can overlap due to</span>
00847         <span class="comment">// negative widths. Since we can't access USER globals, we make a call here.</span>
00848         <span class="comment">//</span>
00849         <span class="keywordflow">if</span> (!(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a> || ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>)) {  <span class="comment">// Is this a multiline edit control with no LPK present?</span>
00850             <span class="comment">//</span>
00851             <span class="comment">// For multiline edit controls, we maintain a buffer that contains</span>
00852             <span class="comment">// the character width information.</span>
00853             <span class="comment">//</span>
00854             wBuffSize = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o41">fTrueType</a>) ? (<a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a> * <span class="keyword">sizeof</span>(ABC)) :
00855                                            (<a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00856 
00857             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>) { <span class="comment">/* If buffer already present */</span>
00858                 lpCharWidthBuff = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>;
00859                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a137">UserLocalReAlloc</a>(lpCharWidthBuff, wBuffSize, HEAP_ZERO_MEMORY);
00860                 <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00861                     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>((HANDLE)lpCharWidthBuff);
00862                 }
00863             } <span class="keywordflow">else</span> {
00864                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, wBuffSize);
00865             }
00866 
00867             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00868                 <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o41">fTrueType</a>) {
00869                     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o41">fTrueType</a> = <a class="code" href="../../d5/d4/edecrare_8c.html#a18">GetNegABCwidthInfo</a>(ped, hdc);
00870                 }
00871 
00872                 <span class="comment">/*</span>
00873 <span class="comment">                 * It is possible that the above attempts could have failed and reset</span>
00874 <span class="comment">                 * the value of fTrueType. So, let us check that value again.</span>
00875 <span class="comment">                 */</span>
00876                 <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o41">fTrueType</a>) {
00877                     <span class="keywordflow">if</span> (!GetCharWidthA(hdc, 0, <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a>-1, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>)) {
00878                         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>((HANDLE)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>);
00879                         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00880                     } <span class="keywordflow">else</span> {
00881                         <span class="comment">/*</span>
00882 <span class="comment">                         * We need to subtract out the overhang associated with</span>
00883 <span class="comment">                         * each character since GetCharWidth includes it...</span>
00884 <span class="comment">                         */</span>
00885                         <span class="keywordflow">for</span> (i=0;i &lt; <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a>;i++)
00886                             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>[i] -= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o69">charOverhang</a>;
00887                     }
00888                 }
00889             } <span class="comment">/* if (ped-&gt;charWidthBuffer != NULL) */</span>
00890         } <span class="comment">/* if (!ped-&gt;fSingle) */</span>
00891     } <span class="comment">/* if (ped-&gt;fDBCS) */</span>
00892 
00893     {
00894         <span class="comment">/*</span>
00895 <span class="comment">         * Calculate MaxNeg A C metrics</span>
00896 <span class="comment">         */</span>
00897         dwMaxOverlapChars = <a class="code" href="../../d5/d4/edecrare_8c.html#a9">GetMaxOverlapChars</a>();
00898         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o41">fTrueType</a>) {
00899             <span class="keywordflow">if</span> (cwi.lMaxNegA &lt; 0)
00900                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o76">wMaxNegA</a> = -cwi.lMaxNegA;
00901             <span class="keywordflow">else</span>
00902                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o76">wMaxNegA</a> = 0;
00903             <span class="keywordflow">if</span> (cwi.lMaxNegC &lt; 0)
00904                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o78">wMaxNegC</a> = -cwi.lMaxNegC;
00905             <span class="keywordflow">else</span>
00906                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o78">wMaxNegC</a> = 0;
00907             <span class="keywordflow">if</span> (cwi.lMinWidthD != 0) {
00908                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o77">wMaxNegAcharPos</a> = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o76">wMaxNegA</a> + cwi.lMinWidthD - 1) / cwi.lMinWidthD;
00909                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o79">wMaxNegCcharPos</a> = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o78">wMaxNegC</a> + cwi.lMinWidthD - 1) / cwi.lMinWidthD;
00910                 <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o76">wMaxNegA</a> + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o78">wMaxNegC</a> &gt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)cwi.lMinWidthD) {
00911                     uExtracharPos = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o76">wMaxNegA</a> + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o78">wMaxNegC</a> - 1) / cwi.lMinWidthD;
00912                     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o77">wMaxNegAcharPos</a> += uExtracharPos;
00913                     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o79">wMaxNegCcharPos</a> += uExtracharPos;
00914                 }
00915             } <span class="keywordflow">else</span> {
00916                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o77">wMaxNegAcharPos</a> = LOWORD(dwMaxOverlapChars);     <span class="comment">// Left</span>
00917                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o79">wMaxNegCcharPos</a> = HIWORD(dwMaxOverlapChars);     <span class="comment">// Right</span>
00918             }
00919 
00920         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o69">charOverhang</a> != 0) {
00921             <span class="comment">/*</span>
00922 <span class="comment">             * Some bitmaps fonts (i.e., italic) have under/overhangs;</span>
00923 <span class="comment">             *  this is pretty much like having negative A and C widths.</span>
00924 <span class="comment">             */</span>
00925             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o76">wMaxNegA</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o78">wMaxNegC</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o69">charOverhang</a>;
00926             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o77">wMaxNegAcharPos</a> = LOWORD(dwMaxOverlapChars);     <span class="comment">// Left</span>
00927             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o79">wMaxNegCcharPos</a> = HIWORD(dwMaxOverlapChars);     <span class="comment">// Right</span>
00928         }
00929     } <span class="comment">/* if (ped-&gt;fDBCS) */</span>
00930 
00931     <span class="keywordflow">if</span> (!hfont) {
00932         <span class="comment">//</span>
00933         <span class="comment">// We are getting the stats for the system font so update the system</span>
00934         <span class="comment">// font fields in the ed structure since we use these when calculating</span>
00935         <span class="comment">// some spacing.</span>
00936         <span class="comment">//</span>
00937         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o70">cxSysCharWidth</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a>;
00938         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o71">cySysCharHeight</a>= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>;
00939     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hOldFont)
00940         SelectObject(hdc, hOldFont);
00941 
00942     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a>) {
00943         <span class="comment">//</span>
00944         <span class="comment">// Update the caret.</span>
00945         <span class="comment">//</span>
00946         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a204">NtUserHideCaret</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
00947         <a class="code" href="../../d6/d0/usercli_8h.html#a215">NtUserDestroyCaret</a>();
00948 
00949         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
00950             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o12">EditCreateCaret</a> (ped, hdc, <a class="code" href="../../d6/d0/usercli_8h.html#a149">ECGetCaretWidth</a>(), ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>, 0);
00951         }
00952         <span class="keywordflow">else</span> {
00953             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a247">NtUserCreateCaret</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, (HBITMAP)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a149">ECGetCaretWidth</a>(), ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>);
00954         }
00955         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a234">NtUserShowCaret</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
00956     }
00957 
00958     <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, hdc);
00959 
00960     <span class="comment">//</span>
00961     <span class="comment">// Update password character.</span>
00962     <span class="comment">//</span>
00963     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o12">charPasswordChar</a>)
00964         <a class="code" href="../../d6/d0/usercli_8h.html#a442">ECSetPasswordChar</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o12">charPasswordChar</a>);
00965 
00966     <span class="comment">//</span>
00967     <span class="comment">// If it is a TrueType font and it's a new app, set both the margins at the</span>
00968     <span class="comment">// max negative width values for all types of the edit controls.</span>
00969     <span class="comment">// (NOTE: Can't use ped-&gt;f40Compat here because edit-controls inside dialog</span>
00970     <span class="comment">// boxes without DS_LOCALEDIT style are always marked as 4.0 compat.</span>
00971     <span class="comment">// This is the fix for NETBENCH 3.0)</span>
00972     <span class="comment">//</span>
00973 
00974     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o41">fTrueType</a> &amp;&amp; (<a class="code" href="../../d6/d0/usercli_8h.html#a150">GETAPPVER</a>() &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>))
00975         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a>) {
00976             <span class="comment">// For DBCS TrueType Font, we calc margin from ABC width.</span>
00977             <a class="code" href="../../d5/d4/edecrare_8c.html#a11">ECCalcMarginForDBCSFont</a>(ped, fRedraw);
00978         } <span class="keywordflow">else</span> {
00979             <a class="code" href="../../d6/d0/usercli_8h.html#a455">ECSetMargin</a>(ped, EC_LEFTMARGIN | EC_RIGHTMARGIN,
00980                         MAKELONG(EC_USEFONTINFO, EC_USEFONTINFO), fRedraw);
00981         }
00982 
00983     <span class="comment">//</span>
00984     <span class="comment">// We need to calc maxPixelWidth when font changes.</span>
00985     <span class="comment">// If the word-wrap is ON, then this is done in MLSize() called later.</span>
00986     <span class="comment">//</span>
00987     <span class="keywordflow">if</span>((!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a>) &amp;&amp; (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o34">fWrap</a>))
00988         <a class="code" href="../../d6/d0/usercli_8h.html#a490">MLBuildchLines</a>(ped, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00989 
00990     <span class="comment">//</span>
00991     <span class="comment">// Recalc the layout.</span>
00992     <span class="comment">//</span>
00993     <a class="code" href="../../d6/d0/usercli_8h.html#a482">ECSize</a>(ped, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, fRedraw);
00994 
00995     <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a> &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a312">fpImmIsIME</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a151">THREAD_HKL</a>()) ) {
00996         <a class="code" href="../../d6/d0/usercli_8h.html#a470">ECImmSetCompositionFont</a>( ped );
00997     }
00998 }
00999 
01000 
01001 
01002 <span class="comment">/***************************************************************************\</span>
01003 <span class="comment">*</span>
01004 <span class="comment">*  ECIsCharNumeric AorW () -</span>
01005 <span class="comment">*</span>
01006 <span class="comment">*  Tests whether the character entered is a numeral.</span>
01007 <span class="comment">*  For multiline and singleline edit controls with the ES_NUMBER style.</span>
01008 <span class="comment">*</span>
01009 <span class="comment">\***************************************************************************/</span>
<a name="l01010"></a><a class="code" href="../../d6/d0/usercli_8h.html#a459">01010</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a459">ECIsCharNumeric</a>(
01011     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
01012     DWORD keyPress)
01013 {
01014     WORD wCharType;
01015 
01016     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
01017         <span class="keywordtype">char</span> ch = (<span class="keywordtype">char</span>)keyPress;
01018         LCID lcid = (LCID)((ULONG_PTR)<a class="code" href="../../d6/d0/usercli_8h.html#a151">THREAD_HKL</a>() &amp; 0xFFFF);
01019         GetStringTypeA(lcid, CT_CTYPE1, &amp;ch, 1, &amp;wCharType);
01020     } <span class="keywordflow">else</span> {
01021         WCHAR wch = (WCHAR)keyPress;
01022         GetStringTypeW(CT_CTYPE1, &amp;wch, 1, &amp;wCharType);
01023     }
01024     <span class="keywordflow">return</span> (wCharType &amp; C1_DIGIT ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01025 }
01026 
01027 <span class="comment">/***************************************************************************\</span>
01028 <span class="comment">*</span>
01029 <span class="comment">*  ECEnableDisableIME( PED ped )</span>
01030 <span class="comment">*</span>
01031 <span class="comment">*</span>
01032 <span class="comment">*  xx/xx/9x by somebody     Created for Win95</span>
01033 <span class="comment">*  xx/xx/95 by kazum        Ported to NT-J 3.51</span>
01034 <span class="comment">*  04/15/96 by takaok       Ported to NT 4.0</span>
01035 <span class="comment">*</span>
01036 <span class="comment">\***************************************************************************/</span>
<a name="l01037"></a><a class="code" href="../../d6/d0/usercli_8h.html#a469">01037</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d0/usercli_8h.html#a469">ECEnableDisableIME</a>( <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped )
01038 {
01039     <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o39">fReadOnly</a> || ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o12">charPasswordChar</a> ) {
01040     <span class="comment">//</span>
01041     <span class="comment">// IME should be disabled</span>
01042     <span class="comment">//</span>
01043         HIMC hImc;
01044         hImc = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a> );
01045 
01046         <span class="keywordflow">if</span> ( hImc != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> ) {
01047             <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, hImc );
01048             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o92">hImcPrev</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a304">fpImmAssociateContext</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> );
01049         }
01050 
01051     } <span class="keywordflow">else</span> {
01052     <span class="comment">//</span>
01053     <span class="comment">// IME should be enabled</span>
01054     <span class="comment">//</span>
01055         <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o92">hImcPrev</a> != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> ) {
01056             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o92">hImcPrev</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a304">fpImmAssociateContext</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o92">hImcPrev</a> );
01057 
01058             <span class="comment">//</span>
01059             <span class="comment">// Font and the caret position might be changed while</span>
01060             <span class="comment">// IME was being disabled. Set those now if the window</span>
01061             <span class="comment">// has the focus.</span>
01062             <span class="comment">//</span>
01063             <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a> ) {
01064                 POINT pt;
01065 
01066                 <a class="code" href="../../d6/d0/usercli_8h.html#a470">ECImmSetCompositionFont</a>( ped );
01067 
01068                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a274">NtUserGetCaretPos</a>( &amp;pt );
01069                 <a class="code" href="../../d6/d0/usercli_8h.html#a471">ECImmSetCompositionWindow</a>( ped, pt.x, pt.y  );
01070             }
01071         }
01072     }
01073     <a class="code" href="../../d6/d0/usercli_8h.html#a473">ECInitInsert</a>(ped, <a class="code" href="../../d6/d0/usercli_8h.html#a151">THREAD_HKL</a>());
01074 }
01075 
01076 
01077 <span class="comment">/***************************************************************************\</span>
01078 <span class="comment">*</span>
01079 <span class="comment">*  ECImmSetCompositionWindow( PED ped, LONG x, LONG y )</span>
01080 <span class="comment">*</span>
01081 <span class="comment">*  xx/xx/9x by somebody     Created for Win95</span>
01082 <span class="comment">*  xx/xx/95 by kazum        Ported to NT-J 3.51</span>
01083 <span class="comment">*  04/15/96 by takaok       Ported to NT 4.0</span>
01084 <span class="comment">\***************************************************************************/</span>
<a name="l01085"></a><a class="code" href="../../d6/d0/usercli_8h.html#a471">01085</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d0/usercli_8h.html#a471">ECImmSetCompositionWindow</a>( <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, LONG x, LONG y )
01086 {
01087     COMPOSITIONFORM cf;
01088     COMPOSITIONFORM cft;
01089     RECT rcScreenWindow;
01090     HIMC hImc;
01091 
01092     hImc = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a> );
01093     <span class="keywordflow">if</span> ( hImc != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> ) {
01094 
01095         <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a> ) {
01096             <a class="code" href="../../d3/d9/client_2wow_8c.html#a26">GetWindowRect</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, &amp;rcScreenWindow);
01097             <span class="comment">// assuming RECT.left is the first and and RECT.top is the second field</span>
01098             <a class="code" href="../../d3/d8/winmgrc_8c.html#a15">MapWindowPoints</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, HWND_DESKTOP, (LPPOINT)&amp;rcScreenWindow, 2);
01099             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o57">fInReconversion</a>) {
01100                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwPoint = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> ? SendMessageA : SendMessageW)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, EM_POSFROMCHAR, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>, 0);
01101 
01102                 x = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a7">GET_X_LPARAM</a>(dwPoint);
01103                 y = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a8">GET_Y_LPARAM</a>(dwPoint);
01104 
01105                 RIPMSG2(RIP_WARNING, <span class="stringliteral">"ECImmSetCompositionWindow: fInReconversion (%d,%d)"</span>, x, y);
01106             }
01107             <span class="comment">//</span>
01108             <span class="comment">// The window currently has the focus.</span>
01109             <span class="comment">//</span>
01110             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a>) {
01111                 <span class="comment">//</span>
01112                 <span class="comment">// Single line edit control.</span>
01113                 <span class="comment">//</span>
01114                 cf.dwStyle = CFS_POINT;
01115                 cf.ptCurrentPos.x = x;
01116                 cf.ptCurrentPos.y = y;
01117                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(&amp;cf.rcArea);
01118 
01119             } <span class="keywordflow">else</span> {
01120                 <span class="comment">//</span>
01121                 <span class="comment">// Multi line edit control.</span>
01122                 <span class="comment">//</span>
01123                 cf.dwStyle = CFS_RECT;
01124                 cf.ptCurrentPos.x = x;
01125                 cf.ptCurrentPos.y = y;
01126                 cf.rcArea = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>;
01127             }
01128             <a class="code" href="../../d6/d0/usercli_8h.html#a310">fpImmGetCompositionWindow</a>( hImc, &amp;cft );
01129             <span class="keywordflow">if</span> ( (!RtlEqualMemory(&amp;cf,&amp;cft,<span class="keyword">sizeof</span>(COMPOSITIONFORM))) ||
01130                  (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o93">ptScreenBounding</a>.x != rcScreenWindow.left)    ||
01131                  (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o93">ptScreenBounding</a>.y  != rcScreenWindow.top) ) {
01132 
01133                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o93">ptScreenBounding</a>.x = rcScreenWindow.left;
01134                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o93">ptScreenBounding</a>.y = rcScreenWindow.top;
01135                 <a class="code" href="../../d6/d0/usercli_8h.html#a321">fpImmSetCompositionWindow</a>( hImc, &amp;cf );
01136             }
01137         }
01138         <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, hImc );
01139     }
01140 }
01141 
01142 <span class="comment">/***************************************************************************\</span>
01143 <span class="comment">*</span>
01144 <span class="comment">*  ECImmSetCompositionFont( PED ped )</span>
01145 <span class="comment">*</span>
01146 <span class="comment">*  xx/xx/9x by somebody     Created for Win95</span>
01147 <span class="comment">*  xx/xx/95 by kazum        Ported to NT-J 3.51</span>
01148 <span class="comment">*  04/15/96 by takaok       Ported to NT 4.0</span>
01149 <span class="comment">\***************************************************************************/</span>
<a name="l01150"></a><a class="code" href="../../d6/d0/usercli_8h.html#a470">01150</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>  <a class="code" href="../../d6/d0/usercli_8h.html#a470">ECImmSetCompositionFont</a>( <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped )
01151 {
01152     HIMC hImc;
01153     LOGFONTW <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a18">lf</a>;
01154 
01155     <span class="keywordflow">if</span> ( (hImc = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a> )) != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> ) {
01156 
01157         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o66">hFont</a>) {
01158             GetObjectW( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o66">hFont</a>,
01159                         <span class="keyword">sizeof</span>(LOGFONTW),
01160                         (LPLOGFONTW)&amp;<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a18">lf</a>);
01161         } <span class="keywordflow">else</span> {
01162             GetObjectW( GetStockObject(SYSTEM_FONT),
01163                         <span class="keyword">sizeof</span>(LOGFONTW),
01164                         (LPLOGFONTW)&amp;<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a18">lf</a>);
01165         }
01166         <a class="code" href="../../d6/d0/usercli_8h.html#a318">fpImmSetCompositionFontW</a>( hImc, &amp;<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a18">lf</a> );
01167         <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, hImc );
01168     }
01169 }
01170 
01171 
01172 <span class="comment">/***************************************************************************\</span>
01173 <span class="comment">*</span>
01174 <span class="comment">*  ECInitInsert( PED ped, HKL hkl )</span>
01175 <span class="comment">*</span>
01176 <span class="comment">*  this function is called when:</span>
01177 <span class="comment">*  1) a edit control window is initialized</span>
01178 <span class="comment">*  2) active keyboard layout of current thread is changed</span>
01179 <span class="comment">*  3) read only attribute of this edit control is changed</span>
01180 <span class="comment">*</span>
01181 <span class="comment">*  04/15/96 by takaok       Created</span>
01182 <span class="comment">\***************************************************************************/</span>
<a name="l01183"></a><a class="code" href="../../d6/d0/usercli_8h.html#a473">01183</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d0/usercli_8h.html#a473">ECInitInsert</a>( <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, HKL hkl )
01184 {
01185     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o56">fKorea</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01186     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o52">fInsertCompChr</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01187     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o54">fNoMoveCaret</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01188     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o55">fResultProcess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01189 
01190     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/usercli_8h.html#a312">fpImmIsIME</a>(hkl) ) {
01191         <span class="keywordflow">if</span> (  PRIMARYLANGID(LOWORD(HandleToUlong(hkl))) == LANG_KOREAN ) {
01192 
01193             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o56">fKorea</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01194         }
01195         <span class="comment">//</span>
01196         <span class="comment">// LATER:this flag should be set based on the IME caps</span>
01197         <span class="comment">// retrieved from IME. (Such IME caps should be defined)</span>
01198         <span class="comment">// For now, we can safely assume that only Korean IMEs</span>
01199         <span class="comment">// set CS_INSERTCHAR.</span>
01200         <span class="comment">//</span>
01201         <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o56">fKorea</a> ) {
01202             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o52">fInsertCompChr</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01203         }
01204     }
01205 
01206     <span class="comment">//</span>
01207     <span class="comment">// if we had a composition character, the shape of caret</span>
01208     <span class="comment">// is changed. We need to reset the caret shape.</span>
01209     <span class="comment">//</span>
01210     <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a> ) {
01211         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01212         <a class="code" href="../../d6/d0/usercli_8h.html#a472">ECSetCaretHandler</a>( ped );
01213     }
01214 }
01215 
01216 <span class="comment">/***************************************************************************\</span>
01217 <span class="comment">*</span>
01218 <span class="comment">*  ECSetCaretHandler( PED ped )</span>
01219 <span class="comment">*</span>
01220 <span class="comment">* History:</span>
01221 <span class="comment">*       07/16/96 by takaok      ported from NT 3.51</span>
01222 <span class="comment">*</span>
01223 <span class="comment">\***************************************************************************/</span>
01224 
<a name="l01225"></a><a class="code" href="../../d6/d0/usercli_8h.html#a472">01225</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a472">ECSetCaretHandler</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
01226 {
01227     HDC     hdc;
01228     SIZE    size;
01229     PSTR    pText;
01230 
01231 <span class="comment">//    if (!ped-&gt;fInsertCompChr || ped-&gt;fReadOnly)</span>
01232 <span class="comment">//        return;</span>
01233 
01234     <span class="comment">// In any case destroy caret beforehand otherwise SetCaretPos()</span>
01235     <span class="comment">// will get crazy.. win95d-B#992,B#2370</span>
01236     <span class="comment">//</span>
01237     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a>) {
01238 
01239         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a204">NtUserHideCaret</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
01240         <a class="code" href="../../d3/d8/client_8c.html#a95">DestroyCaret</a>();
01241         <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a> ) {
01242 
01243             hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01244             pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
01245 
01246             <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>)
01247                  GetTextExtentPointA(hdc, pText + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, 2, &amp;size);
01248             <span class="keywordflow">else</span>
01249                  GetTextExtentPointW(hdc, (LPWSTR)pText + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, 1, &amp;size);
01250 
01251             <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
01252             <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01253 
01254             <a class="code" href="../../d6/d0/usercli_8h.html#a233">CreateCaret</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, (HBITMAP)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, size.cx, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>);
01255         }
01256         <span class="keywordflow">else</span> {
01257             <a class="code" href="../../d6/d0/usercli_8h.html#a233">CreateCaret</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>,
01258                         (HBITMAP)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01259                         (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o70">cxSysCharWidth</a> &gt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a> ? 1 : 2),
01260                         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>);
01261         }
01262 
01263         hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01264         <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a> )
01265             <a class="code" href="../../d6/d0/usercli_8h.html#a524">SLSetCaretPosition</a>( ped, hdc );
01266         <span class="keywordflow">else</span>
01267             <a class="code" href="../../d6/d0/usercli_8h.html#a493">MLSetCaretPosition</a>( ped, hdc );
01268         <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01269         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a234">NtUserShowCaret</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
01270     }
01271 }
01272 
01273 
01274 <span class="comment">/***************************************************************************\</span>
01275 <span class="comment">*</span>
01276 <span class="comment">* LONG ECImeCompoistion( PED ped, WPARAM wParam, LPARAM lParam )</span>
01277 <span class="comment">*</span>
01278 <span class="comment">* WM_IME_COMPOSITION handler for Korean IME</span>
01279 <span class="comment">*</span>
01280 <span class="comment">* History:</span>
01281 <span class="comment">\***************************************************************************/</span>
01282 
01283 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a521">MLReplaceSel</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a>, LPSTR);
01284 
<a name="l01285"></a><a class="code" href="../../d5/d4/edecrare_8c.html#a4">01285</a> <span class="preprocessor">#define GET_COMPOSITION_STRING  (ped-&gt;fAnsi ? fpImmGetCompositionStringA : fpImmGetCompositionStringW)</span>
01286 <span class="preprocessor"></span>
<a name="l01287"></a><a class="code" href="../../d5/d4/edecrare_8c.html#a28">01287</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> PASCAL <a class="code" href="../../d5/d4/edecrare_8c.html#a28">ECResultStrHandler</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
01288 {
01289     HIMC himc;
01290     LPSTR lpStr;
01291     LONG dwLen;
01292 
01293     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o52">fInsertCompChr</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;    <span class="comment">// clear the state</span>
01294     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o54">fNoMoveCaret</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01295 
01296     <span class="keywordflow">if</span> ((himc = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>)) == 0) {
01297         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01298     }
01299 
01300     dwLen = <a class="code" href="../../d5/d4/edecrare_8c.html#a4">GET_COMPOSITION_STRING</a>(himc, GCS_RESULTSTR, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
01301 
01302     <span class="keywordflow">if</span> (dwLen == 0) {
01303         <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, himc);
01304         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01305     }
01306 
01307     dwLen *= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
01308     dwLen += ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
01309 
01310     lpStr = (LPSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a3">UserGlobalAlloc</a>(GPTR, dwLen);
01311     <span class="keywordflow">if</span> (lpStr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01312         <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, himc);
01313         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01314     }
01315 
01316     <a class="code" href="../../d5/d4/edecrare_8c.html#a4">GET_COMPOSITION_STRING</a>(himc, GCS_RESULTSTR, lpStr, dwLen);
01317 
01318     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a>) {
01319         <a class="code" href="../../d6/d0/usercli_8h.html#a522">SLReplaceSel</a>(ped, lpStr);
01320     } <span class="keywordflow">else</span> {
01321         <a class="code" href="../../d6/d0/usercli_8h.html#a521">MLReplaceSel</a>(ped, lpStr);
01322     }
01323 
01324     <a class="code" href="../../d6/d0/usercli_8h.html#a2">UserGlobalFree</a>((HGLOBAL)lpStr);
01325 
01326     <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, himc);
01327 
01328     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01329     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o54">fNoMoveCaret</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01330     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o55">fResultProcess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01331 
01332     <a class="code" href="../../d6/d0/usercli_8h.html#a472">ECSetCaretHandler</a>(ped);
01333 
01334     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01335 }
01336 
<a name="l01337"></a><a class="code" href="../../d6/d0/usercli_8h.html#a474">01337</a> LRESULT <a class="code" href="../../d6/d0/usercli_8h.html#a474">ECImeComposition</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, WPARAM wParam, LPARAM lParam)
01338 {
01339     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> ich;
01340     LRESULT lReturn = 1;
01341     HDC hdc;
01342     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSLTextUpdated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01343     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> iResult;
01344     HIMC hImc;
01345     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> TextBuf[4];
01346 
01347     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o52">fInsertCompChr</a>) {
01348         <span class="keywordflow">if</span> (lParam &amp; GCS_RESULTSTR) {
01349             <a class="code" href="../../d6/d0/usercli_8h.html#a477">ECInOutReconversionMode</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01350 
01351             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o59">wImeStatus</a> &amp; EIMES_GETCOMPSTRATONCE) {
01352 ResultAtOnce:
01353                 <a class="code" href="../../d5/d4/edecrare_8c.html#a28">ECResultStrHandler</a>(ped);
01354                 lParam &amp;= ~GCS_RESULTSTR;
01355             }
01356         }
01357         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, WM_IME_COMPOSITION, wParam, lParam, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>);
01358     }
01359 
01360     <span class="comment">// In case of Ansi edit control, the length of minimum composition string</span>
01361     <span class="comment">// is 2. Check here maximum byte of edit control.</span>
01362     <span class="keywordflow">if</span>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o2">cchTextMax</a> == 1 ) {
01363         HIMC hImc;
01364 
01365         hImc = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a> );
01366         <a class="code" href="../../d6/d0/usercli_8h.html#a322">fpImmNotifyIME</a>(hImc, NI_COMPOSITIONSTR, CPS_CANCEL, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01367         <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, hImc );
01368         <a class="code" href="../../d6/d0/usercli_8h.html#a219">NtUserMessageBeep</a>(MB_ICONEXCLAMATION);
01369         <span class="keywordflow">return</span> lReturn;
01370     }
01371 
01372     <span class="comment">// Don't move this after CS_NOMOVECARET check.</span>
01373     <span class="comment">// In case if skip the message, fNoMoveCaret should not be set.</span>
01374     <span class="keywordflow">if</span> ((lParam &amp; CS_INSERTCHAR) &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o55">fResultProcess</a>) {
01375 
01376         <span class="comment">// Now we're in result processing. GCS_RESULTSTR ends up</span>
01377         <span class="comment">// to WM_IME_CHAR and WM_CHAR. Since WM_CHAR is posted,</span>
01378         <span class="comment">// the message(s) will come later than this CS_INSERTCHAR</span>
01379         <span class="comment">// message. This composition character should be handled</span>
01380         <span class="comment">// after the WM_CHAR message(s).</span>
01381         <span class="comment">//</span>
01382         <span class="keywordflow">if</span>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>)
01383             PostMessageA(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, WM_IME_COMPOSITION, wParam, lParam);
01384         <span class="keywordflow">else</span>
01385             PostMessageW(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, WM_IME_COMPOSITION, wParam, lParam);
01386         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o55">fResultProcess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01387         <span class="keywordflow">return</span> lReturn;
01388     }
01389 
01390 <span class="comment">//</span>
01391 <span class="comment">// If fReplaceCompChr is TRUE, we change the shape of caret. A block</span>
01392 <span class="comment">// caret is displayed on the composition character. From the user's</span>
01393 <span class="comment">// point of view, there is no difference if the caret is before the</span>
01394 <span class="comment">// composition character or after the composition character. When</span>
01395 <span class="comment">// the composition character is finalized, the insertion point should</span>
01396 <span class="comment">// be moved to after the character, any way. Therefore checking</span>
01397 <span class="comment">// CS_NOMOVECARET bit doesn't make sense in our current implementation.</span>
01398 <span class="comment">// [takaok]</span>
01399 <span class="comment">//</span>
01400 <span class="preprocessor">#if 0</span>
01401 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (lParam &amp; CS_NOMOVECARET)
01402         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o54">fNoMoveCaret</a>=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;   <span class="comment">// stick to current caret pos.</span>
01403     <span class="keywordflow">else</span>
01404         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o54">fNoMoveCaret</a>=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01405 <span class="preprocessor">#endif</span>
01406 <span class="preprocessor"></span>
01407     <span class="keywordflow">if</span> (lParam &amp; GCS_RESULTSTR) {
01408 
01409         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o59">wImeStatus</a> &amp; EIMES_GETCOMPSTRATONCE) {
01410             <span class="keywordflow">goto</span> ResultAtOnce;
01411         }
01412 
01413         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o55">fResultProcess</a>=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01414         <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a> ) {
01415             <span class="comment">//</span>
01416             <span class="comment">// we have a DBCS character to be replaced.</span>
01417             <span class="comment">// let's delete it before inserting the new one.</span>
01418             <span class="comment">//</span>
01419             ich = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) ? 2 : 1;
01420             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01421             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> + ich, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>);
01422             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
01423             <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/usercli_8h.html#a447">ECDeleteText</a>( ped ) &gt; 0 ) {
01424                 <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a> ) {
01425                     <span class="comment">//</span>
01426                     <span class="comment">// Update the display</span>
01427                     <span class="comment">//</span>
01428                     <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_UPDATE);
01429                     hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01430                     <a class="code" href="../../d6/d0/usercli_8h.html#a527">SLDrawText</a>(ped, hdc, 0);
01431                     <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped,hdc,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01432                     <span class="comment">//</span>
01433                     <span class="comment">// Tell parent our text contents changed.</span>
01434                     <span class="comment">//</span>
01435                     <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_CHANGE);
01436                 }
01437             }
01438             <a class="code" href="../../d6/d0/usercli_8h.html#a472">ECSetCaretHandler</a>( ped );
01439         }
01440 
01441     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(lParam &amp; CS_INSERTCHAR) {
01442 
01443         <span class="comment">//</span>
01444         <span class="comment">// If we are in the middle of a mousedown command, don't do anything.</span>
01445         <span class="comment">//</span>
01446         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o22">fMouseDown</a>) {
01447             <span class="keywordflow">return</span> lReturn;
01448         }
01449 
01450         <span class="comment">//</span>
01451         <span class="comment">// We can safely assume that interimm character is always DBCS.</span>
01452         <span class="comment">//</span>
01453         ich = ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> ) ? 2 : 1;
01454 
01455         <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a> ) {
01456             <span class="comment">//</span>
01457             <span class="comment">// we have a character to be replaced.</span>
01458             <span class="comment">// let's delete it before inserting the new one.</span>
01459             <span class="comment">// when we have a composition characters, the</span>
01460             <span class="comment">// caret is placed before the composition character.</span>
01461             <span class="comment">//</span>
01462             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>+ich, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>);
01463             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
01464         }
01465 
01466         <span class="comment">//</span>
01467         <span class="comment">// let's delete current selected text or composition character</span>
01468         <span class="comment">//</span>
01469         <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a> ) {
01470             <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/usercli_8h.html#a447">ECDeleteText</a>( ped ) &gt; 0 ) {
01471                 fSLTextUpdated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01472             }
01473         } <span class="keywordflow">else</span> {
01474             <a class="code" href="../../d6/d0/usercli_8h.html#a484">MLDeleteText</a>( ped );
01475         }
01476 
01477         <span class="comment">//</span>
01478         <span class="comment">// When the composition charcter is canceled, IME may give us NULL wParam,</span>
01479         <span class="comment">// with CS_INSERTCHAR flag on. We shouldn't insert a NULL character.</span>
01480         <span class="comment">//</span>
01481         <span class="keywordflow">if</span> ( wParam != 0 ) {
01482 
01483             <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> ) {
01484                 TextBuf[0] = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(LOWORD(wParam)); <span class="comment">// leading byte</span>
01485                 TextBuf[1] = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(LOWORD(wParam)); <span class="comment">// trailing byte</span>
01486                 TextBuf[2] = <span class="charliteral">'\0'</span>;
01487             } <span class="keywordflow">else</span> {
01488                 TextBuf[0] = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(LOWORD(wParam));
01489                 TextBuf[1] = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(LOWORD(wParam));
01490                 TextBuf[2] = <span class="charliteral">'\0'</span>;
01491                 TextBuf[3] = <span class="charliteral">'\0'</span>;
01492             }
01493 
01494             <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a> ) {
01495 
01496                 iResult = <a class="code" href="../../d6/d0/usercli_8h.html#a532">SLInsertText</a>( ped, (LPSTR)TextBuf, ich );
01497                 <span class="keywordflow">if</span> (iResult == 0) {
01498                     <span class="comment">/*</span>
01499 <span class="comment">                     * Couldn't insert the text, for e.g. the text exceeded the limit.</span>
01500 <span class="comment">                     */</span>
01501                     <a class="code" href="../../d6/d0/usercli_8h.html#a219">NtUserMessageBeep</a>(0);
01502                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iResult &gt; 0) {
01503                     <span class="comment">/*</span>
01504 <span class="comment">                     * Remember we need to update the text.</span>
01505 <span class="comment">                     */</span>
01506                     fSLTextUpdated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01507                 }
01508 
01509             } <span class="keywordflow">else</span> {
01510 
01511                 iResult = <a class="code" href="../../d6/d0/usercli_8h.html#a483">MLInsertText</a>( ped, (LPSTR)TextBuf, ich, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01512             }
01513 
01514             <span class="keywordflow">if</span> ( iResult &gt; 0 ) {
01515                 <span class="comment">//</span>
01516                 <span class="comment">// ped-&gt;fReplaceCompChr will be reset:</span>
01517                 <span class="comment">//</span>
01518                 <span class="comment">// 1) when the character is finalized.</span>
01519                 <span class="comment">//    we will receive GCS_RESULTSTR</span>
01520                 <span class="comment">//</span>
01521                 <span class="comment">// 2) when the character is canceled.</span>
01522                 <span class="comment">//</span>
01523                 <span class="comment">//    we will receive WM_IME_COMPOSITION|CS_INSERTCHAR</span>
01524                 <span class="comment">//    with wParam == 0 (in case of user types backspace</span>
01525                 <span class="comment">//    at the first element of composition character).</span>
01526                 <span class="comment">//</span>
01527                 <span class="comment">//      or</span>
01528                 <span class="comment">//</span>
01529                 <span class="comment">//    we will receive WM_IME_ENDCOMPOSITION message</span>
01530                 <span class="comment">//</span>
01531                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01532 
01533                 <span class="comment">//</span>
01534                 <span class="comment">// Caret should be placed BEFORE the composition</span>
01535                 <span class="comment">// character.</span>
01536                 <span class="comment">//</span>
01537                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>( 0, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> - ich);
01538                 <a class="code" href="../../d6/d0/usercli_8h.html#a472">ECSetCaretHandler</a>( ped );
01539             } <span class="keywordflow">else</span> {
01540 
01541                 <span class="comment">//</span>
01542                 <span class="comment">// We failed to insert a character. We might run out</span>
01543                 <span class="comment">// of memory, or reached to the text size limit. let's</span>
01544                 <span class="comment">// cancel the composition character.</span>
01545                 <span class="comment">//</span>
01546                 hImc = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
01547                 <a class="code" href="../../d6/d0/usercli_8h.html#a322">fpImmNotifyIME</a>(hImc, NI_COMPOSITIONSTR, CPS_CANCEL, 0);
01548                 <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, hImc);
01549 
01550                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01551                 <a class="code" href="../../d6/d0/usercli_8h.html#a472">ECSetCaretHandler</a>( ped );
01552             }
01553         } <span class="keywordflow">else</span> {
01554             <span class="comment">//</span>
01555             <span class="comment">// the composition character is canceled.</span>
01556             <span class="comment">//</span>
01557             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01558             <a class="code" href="../../d6/d0/usercli_8h.html#a472">ECSetCaretHandler</a>( ped );
01559         }
01560 
01561         <span class="comment">//</span>
01562         <span class="comment">// We won't notify parent the text change</span>
01563         <span class="comment">// because the composition character has</span>
01564         <span class="comment">// not been finalized.</span>
01565         <span class="comment">//</span>
01566         <span class="keywordflow">if</span> ( fSLTextUpdated ) {
01567 
01568             <span class="comment">//</span>
01569             <span class="comment">// Update the display</span>
01570             <span class="comment">//</span>
01571             <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_UPDATE);
01572 
01573             hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01574 
01575             <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a> ) {
01576                 <span class="comment">//</span>
01577                 <span class="comment">// move back the caret to the original position</span>
01578                 <span class="comment">// temporarily so that our new block cursor can</span>
01579                 <span class="comment">// be located within the visible area of window.</span>
01580                 <span class="comment">//</span>
01581                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> + ich);
01582                 <a class="code" href="../../d6/d0/usercli_8h.html#a530">SLScrollText</a>(ped, hdc);
01583                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>( 0, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> - ich);
01584             } <span class="keywordflow">else</span> {
01585                 <a class="code" href="../../d6/d0/usercli_8h.html#a530">SLScrollText</a>(ped, hdc);
01586             }
01587             <a class="code" href="../../d6/d0/usercli_8h.html#a527">SLDrawText</a>(ped, hdc, 0);
01588 
01589             <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped,hdc,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01590 
01591             <span class="comment">//</span>
01592             <span class="comment">// Tell parent our text contents changed.</span>
01593             <span class="comment">//</span>
01594             <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_CHANGE);
01595         }
01596         <span class="keywordflow">return</span> lReturn;
01597     }
01598 
01599     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, WM_IME_COMPOSITION, wParam, lParam, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>);
01600 }
01601 
01602 
01603 <span class="preprocessor">#ifdef LATER    // fyi: window 98 equiv.</span>
01604 <span class="preprocessor"></span>LRESULT <a class="code" href="../../d6/d0/usercli_8h.html#a474">ECImeComposition</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, WPARAM wParam, LPARAM lParam)
01605 {
01606     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> ich;
01607     LRESULT lReturn = 1;
01608     HDC hdc;
01609     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSLTextUpdated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01610     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> iResult;
01611     HIMC hImc;
01612     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> TextBuf[4];
01613 
01614     <span class="comment">// In case of Ansi edit control, the length of minimum composition string</span>
01615     <span class="comment">// is 2. Check here maximum byte of edit control.</span>
01616     <span class="keywordflow">if</span>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o2">cchTextMax</a> == 1 ) {
01617         HIMC hImc;
01618 
01619         hImc = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a> );
01620         <a class="code" href="../../d6/d0/usercli_8h.html#a322">fpImmNotifyIME</a>(hImc, NI_COMPOSITIONSTR, CPS_CANCEL, 0L);
01621         <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, hImc );
01622         <a class="code" href="../../d3/d8/client_8c.html#a110">MessageBeep</a>(MB_ICONEXCLAMATION);
01623         <span class="keywordflow">return</span> lReturn;
01624     }
01625 
01626     <span class="comment">// Don't move this after CS_NOMOVECARET check.</span>
01627     <span class="comment">// In case if skip the message, fNoMoveCaret should not be set.</span>
01628     <span class="keywordflow">if</span> ((lParam &amp; CS_INSERTCHAR) &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o55">fResultProcess</a>) {
01629 
01630         <span class="comment">// Now we're in result processing. GCS_RESULTSTR ends up</span>
01631         <span class="comment">// to WM_IME_CHAR and WM_CHAR. Since WM_CHAR is posted,</span>
01632         <span class="comment">// the message(s) will come later than this CS_INSERTCHAR</span>
01633         <span class="comment">// message. This composition character should be handled</span>
01634         <span class="comment">// after the WM_CHAR message(s).</span>
01635         <span class="comment">//</span>
01636         (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> ? PostMessageA : PostMessageW)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, WM_IME_COMPOSITION, wParam, lParam);
01637         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o55">fResultProcess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01638         <span class="keywordflow">return</span> lReturn;
01639     }
01640 
01641     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o54">fNoMoveCaret</a> = (lParam &amp; CS_NOMOVECARET) != 0;
01642 
01643     <span class="keywordflow">if</span> (lParam &amp; GCS_RESULTSTR) {
01644         <a class="code" href="../../d6/d0/usercli_8h.html#a477">ECInOutReconversionMode</a>(ped, FALSE);
01645 
01646         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o59">wImeStatus</a> &amp; EIMS_GETCOMPSTRATONCE) {
01647             ECGetCompStrAtOnce(ped);
01648 
01649             <span class="keywordflow">goto</span> PassToDefaultWindowProc;
01650         }
01651 
01652         <span class="comment">// Getting into result processing</span>
01653         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o55">fResultProcess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01654     }
01655     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lParam &amp; CS_INSERTCHAR) {
01656         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o52">fInsertCompChr</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; <span class="comment">// Process this composition character.</span>
01657 
01658         (ped-&gt;fSingleLine ? <a class="code" href="../../d3/d5/editsl_8c.html#a17">SLChar</a> : <a class="code" href="../../d1/d5/editml_8c.html#a24">MLChar</a>)(ped, wParam, 0);
01659 
01660         <span class="keywordflow">if</span> (ped-&gt;fInsretCompChr) {
01661             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;    <span class="comment">// The next character will replace this.</span>
01662             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o52">fInsertCompChr</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;    <span class="comment">// Clear the state for the next character.</span>
01663         }
01664 
01665         <a class="code" href="../../d6/d0/usercli_8h.html#a472">ECSetCaretHandler</a>(ped);
01666         <span class="keywordflow">return</span> 0;
01667     }
01668 
01669 PassToDefaultWindowProc:
01670     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, WM_IME_COMPOSITION, wParam, lParam, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>);
01671 }
01672 <span class="preprocessor">#endif</span>
01673 <span class="preprocessor"></span>
01674 
01675 <span class="comment">/***************************************************************************\</span>
01676 <span class="comment">*</span>
01677 <span class="comment">* BOOL HanjaKeyHandler( PED ped )</span>
01678 <span class="comment">*</span>
01679 <span class="comment">* VK_HANJA handler - Korean only</span>
01680 <span class="comment">*</span>
01681 <span class="comment">* History: July 15,1996 takaok  ported from NT 3.51</span>
01682 <span class="comment">\***************************************************************************/</span>
<a name="l01683"></a><a class="code" href="../../d6/d0/usercli_8h.html#a476">01683</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a476">HanjaKeyHandler</a>( <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped )
01684 {
01685     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> changeSelection = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01686 
01687     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o56">fKorea</a> &amp;&amp; !ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o39">fReadOnly</a>) {
01688         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> oldCaret = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
01689 
01690         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a>)
01691                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01692 
01693         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>)
01694             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;
01695 
01696         <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> || ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>) {
01697             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = oldCaret;
01698             <a class="code" href="../../d6/d0/usercli_8h.html#a219">NtUserMessageBeep</a>(MB_ICONEXCLAMATION);
01699             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01700         }
01701 
01702         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
01703             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a305">fpImmEscapeA</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a151">THREAD_HKL</a>(), <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>),
01704                 IME_ESC_HANJA_MODE, (<a class="code" href="../../d8/d4/editec_8c.html#a12">ECLock</a>(ped) + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>))) {
01705                 changeSelection = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01706             }
01707             <span class="keywordflow">else</span>
01708                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = oldCaret;
01709             <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
01710         }
01711         <span class="keywordflow">else</span> {
01712             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a306">fpImmEscapeW</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a151">THREAD_HKL</a>(), <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>),
01713                 IME_ESC_HANJA_MODE, (<a class="code" href="../../d8/d4/editec_8c.html#a12">ECLock</a>(ped) + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>))) {
01714                 changeSelection = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01715             }
01716             <span class="keywordflow">else</span>
01717                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = oldCaret;
01718             <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
01719         }
01720     }
01721     <span class="keywordflow">return</span> changeSelection;
01722 }
01723 
01724 
01726 <span class="comment">// EcImeRequestHandler()</span>
01727 <span class="comment">//</span>
01728 <span class="comment">// Handles WM_IME_REQUEST message originated by IME</span>
01729 <span class="comment">//</span>
01730 <span class="comment">// Histroy:</span>
01731 <span class="comment">// 27-Mar-97 Hiroyama Created</span>
01733 <span class="comment"></span>
01734 
<a name="l01735"></a><a class="code" href="../../d6/d0/usercli_8h.html#a475">01735</a> LRESULT <a class="code" href="../../d6/d0/usercli_8h.html#a475">EcImeRequestHandler</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, WPARAM dwSubMsg, LPARAM lParam)
01736 {
01737     LRESULT lreturn = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01738 
01739     <span class="keywordflow">switch</span> (dwSubMsg) {
01740     <span class="keywordflow">case</span> IMR_CONFIRMRECONVERTSTRING:
01741         <span class="comment">// Edit control does not allow IME to change it.</span>
01742         <span class="keywordflow">break</span>;
01743 
01744     <span class="keywordflow">case</span> IMR_RECONVERTSTRING:
01745         <span class="comment">//</span>
01746         <span class="comment">// CHECK VERSION of the structure</span>
01747         <span class="comment">//</span>
01748         <span class="keywordflow">if</span> (lParam &amp;&amp; ((LPRECONVERTSTRING)lParam)-&gt;dwVersion != 0) {
01749             RIPMSG1(RIP_WARNING, <span class="stringliteral">"EcImeRequestHandler: RECONVERTSTRING dwVersion is not expected."</span>,
01750                 ((LPRECONVERTSTRING)lParam)-&gt;dwVersion);
01751             <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01752         }
01753 
01754         <span class="keywordflow">if</span> (ped &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a> &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a312">fpImmIsIME</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a151">THREAD_HKL</a>())) {
01755             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cchLen = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;    <span class="comment">// holds character count.</span>
01756             <span class="keywordflow">if</span> (cchLen == 0) {
01757                 <span class="comment">// if we have no selection,</span>
01758                 <span class="comment">// just return 0.</span>
01759                 <span class="keywordflow">break</span>;
01760             }
01761 
01762             UserAssert(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a> == <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>) || ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a> == <span class="keyword">sizeof</span>(WCHAR));
01763 
01764             <span class="comment">// This Edit Control has selection.</span>
01765             <span class="keywordflow">if</span> (lParam == 0) {
01766                 <span class="comment">//</span>
01767                 <span class="comment">// IME just want to get required size for buffer.</span>
01768                 <span class="comment">// cchLen + 1 is needed to reserve room for trailing L'\0'.</span>
01769                 <span class="comment">//       ~~~~</span>
01770                 lreturn = <span class="keyword">sizeof</span>(RECONVERTSTRING) + (cchLen + 1) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
01771             } <span class="keywordflow">else</span> {
01772                 LPRECONVERTSTRING lpRCS = (LPRECONVERTSTRING)lParam;
01773                 <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> lpSrc;
01774                 <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> <a class="code" href="../../d6/d3/kcodecnv_8c.html#a4">lpDest</a> = (LPBYTE)lpRCS + <span class="keyword">sizeof</span>(RECONVERTSTRING);
01775 
01776                 <span class="comment">// check buffer size</span>
01777                 <span class="comment">// if the given buffer is smaller than actual needed size,</span>
01778                 <span class="comment">// shrink our size to fit the buffer</span>
01779                 <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpRCS-&gt;dwSize &lt;= <span class="keyword">sizeof</span>(RECONVERTSTRING) + cchLen * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>) {
01780                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"EcImeRequest: ERR09"</span>);
01781                     cchLen = (lpRCS-&gt;dwSize - <span class="keyword">sizeof</span>(RECONVERTSTRING)) / ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a> - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
01782                 }
01783 
01784                 lpRCS-&gt;dwStrOffset = <span class="keyword">sizeof</span>(RECONVERTSTRING); <span class="comment">// buffer begins just after RECONVERTSTRING</span>
01785                 lpRCS-&gt;dwCompStrOffset =
01786                 lpRCS-&gt;dwTargetStrOffset = 0;
01787                 lpRCS-&gt;dwStrLen =
01788                 lpRCS-&gt;dwCompStrLen =
01789                 lpRCS-&gt;dwTargetStrLen = cchLen; <span class="comment">// StrLen means TCHAR count</span>
01790 
01791                 lpSrc = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
01792                 <span class="keywordflow">if</span> (lpSrc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01793                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"EcImeRequestHandler: LOCALLOCK(ped) failed."</span>);
01794                 } <span class="keywordflow">else</span> {
01795                     RtlCopyMemory(<a class="code" href="../../d6/d3/kcodecnv_8c.html#a4">lpDest</a>,
01796                                   (LPBYTE)lpSrc + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>,
01797                                   cchLen * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>);
01798                     <span class="comment">// Null-Terminate the string</span>
01799                     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
01800                         LPBYTE psz = (LPBYTE)<a class="code" href="../../d6/d3/kcodecnv_8c.html#a4">lpDest</a>;
01801                         psz[cchLen] = <span class="charliteral">'\0'</span>;
01802                     } <span class="keywordflow">else</span> {
01803                         LPWSTR pwsz = (LPWSTR)<a class="code" href="../../d6/d3/kcodecnv_8c.html#a4">lpDest</a>;
01804                         pwsz[cchLen] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01805                     }
01806                     <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
01807                     <span class="comment">// final buffer size</span>
01808                     lreturn = <span class="keyword">sizeof</span>(RECONVERTSTRING) + (cchLen + 1) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
01809 
01810                     <a class="code" href="../../d6/d0/usercli_8h.html#a477">ECInOutReconversionMode</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01811                     <a class="code" href="../../d6/d0/usercli_8h.html#a471">ECImmSetCompositionWindow</a>(ped, 0, 0);
01812                 }
01813             }
01814 
01815         }
01816         <span class="keywordflow">break</span>;
01817     }
01818 
01819     <span class="keywordflow">return</span> lreturn;
01820 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
