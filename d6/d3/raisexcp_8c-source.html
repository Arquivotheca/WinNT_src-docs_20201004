<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: raisexcp.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>raisexcp.c</h1><a href="../../d5/d4/raisexcp_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    raisexcp.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the internal kernel code to continue execution</span>
00012 <span class="comment">    and raise a exception.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    David N. Cutler (davec) 8-Aug-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">18-Oct-1997                     Neillc</span>
00025 <span class="comment"></span>
00026 <span class="comment">Fix for bug #98981. KiRaiseException referenced the users exception record before probeing.</span>
00027 <span class="comment">It also had a range check that was incorrect for the number of exception parameters because</span>
00028 <span class="comment">it used a signed temp to make a later calculation of the size work. The exception record</span>
00029 <span class="comment">was also subject to changes to the number of parameters after validation. This might cause</span>
00030 <span class="comment">lower levels to fail.</span>
00031 <span class="comment"></span>
00032 <span class="comment">--*/</span>
00033 
00034 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00035 
00036 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00037"></a><a class="code" href="../../d5/d4/raisexcp_8c.html#a0">00037</a> <a class="code" href="../../d5/d4/raisexcp_8c.html#a0">KiContinuePreviousModeUser</a>(
00038     IN PCONTEXT ContextRecord,
00039     IN PKEXCEPTION_FRAME ExceptionFrame,
00040     IN PKTRAP_FRAME TrapFrame,
00041     IN KPROCESSOR_MODE PreviousMode
00042     )
00043 
00044 <span class="comment">/*++</span>
00045 <span class="comment"></span>
00046 <span class="comment">Routine Description:</span>
00047 <span class="comment"></span>
00048 <span class="comment">    This function is called from KiContinue if PreviousMode is</span>
00049 <span class="comment">    not KernelMode.   In this case a kernel mode copy of the </span>
00050 <span class="comment">    ContextRecord is made before calling KeContextToKframes.</span>
00051 <span class="comment">    This is done in a seperate routine to save stack space for</span>
00052 <span class="comment">    the common case which is PreviousMode == Kernel.</span>
00053 <span class="comment"></span>
00054 <span class="comment">    N.B. This routine is called from within a try/except block</span>
00055 <span class="comment">    that will be used to handle errors like invalid context.</span>
00056 <span class="comment"></span>
00057 <span class="comment">Arguments:</span>
00058 <span class="comment"></span>
00059 <span class="comment"></span>
00060 <span class="comment">    ContextRecord - Supplies a pointer to a context record.</span>
00061 <span class="comment"></span>
00062 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span>
00063 <span class="comment"></span>
00064 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00065 <span class="comment"></span>
00066 <span class="comment">    PreviousMode - Not KernelMode.</span>
00067 <span class="comment"></span>
00068 <span class="comment">Return Value:</span>
00069 <span class="comment"></span>
00070 <span class="comment">    None.</span>
00071 <span class="comment"></span>
00072 <span class="comment">--*/</span>
00073 
00074 {
00075     CONTEXT ContextRecord2;
00076 
00077     <span class="comment">//</span>
00078     <span class="comment">// Copy the context record to kernel mode space.</span>
00079     <span class="comment">//</span>
00080 
00081     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ContextRecord, <span class="keyword">sizeof</span>(CONTEXT), CONTEXT_ALIGN);
00082     RtlMoveMemory(&amp;ContextRecord2, ContextRecord, <span class="keyword">sizeof</span>(CONTEXT));
00083     ContextRecord = &amp;ContextRecord2;
00084 
00085     <span class="comment">//</span>
00086     <span class="comment">// Move information from the context record to the exception</span>
00087     <span class="comment">// and trap frames.</span>
00088     <span class="comment">//</span>
00089 
00090     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame,
00091                        ExceptionFrame,
00092                        &amp;ContextRecord2,
00093                        ContextRecord2.ContextFlags,
00094                        PreviousMode);
00095 }
00096 
00097 
00098 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00099"></a><a class="code" href="../../d5/d4/raisexcp_8c.html#a1">00099</a> <a class="code" href="../../d5/d4/raisexcp_8c.html#a1">KiContinue</a> (
00100     IN PCONTEXT ContextRecord,
00101     IN PKEXCEPTION_FRAME ExceptionFrame,
00102     IN PKTRAP_FRAME TrapFrame
00103     )
00104 
00105 <span class="comment">/*++</span>
00106 <span class="comment"></span>
00107 <span class="comment">Routine Description:</span>
00108 <span class="comment"></span>
00109 <span class="comment">    This function is called to copy the specified context frame to the</span>
00110 <span class="comment">    specified exception and trap frames for the continue system service.</span>
00111 <span class="comment"></span>
00112 <span class="comment">Arguments:</span>
00113 <span class="comment"></span>
00114 <span class="comment">    ContextRecord - Supplies a pointer to a context record.</span>
00115 <span class="comment"></span>
00116 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span>
00117 <span class="comment"></span>
00118 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00119 <span class="comment"></span>
00120 <span class="comment">Return Value:</span>
00121 <span class="comment"></span>
00122 <span class="comment">    STATUS_ACCESS_VIOLATION is returned if the context record is not readable</span>
00123 <span class="comment">        from user mode.</span>
00124 <span class="comment"></span>
00125 <span class="comment">    STATUS_DATATYPE_MISALIGNMENT is returned if the context record is not</span>
00126 <span class="comment">        properly aligned.</span>
00127 <span class="comment"></span>
00128 <span class="comment">    STATUS_SUCCESS is returned if the context frame is copied successfully</span>
00129 <span class="comment">        to the specified exception and trap frames.</span>
00130 <span class="comment"></span>
00131 <span class="comment">--*/</span>
00132 
00133 {
00134     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00135     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00136     KIRQL OldIrql;
00137     BOOLEAN IrqlChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00138 
00139     <span class="comment">//</span>
00140     <span class="comment">// Synchronize with other context operations.</span>
00141     <span class="comment">//</span>
00142 
00143     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00144     <span class="keywordflow">if</span> (KeGetCurrentIrql() &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
00145 
00146         <span class="comment">//</span>
00147         <span class="comment">// To support try-except and ExRaiseStatus in device driver code we</span>
00148         <span class="comment">// need to check if we are already at raised level.</span>
00149         <span class="comment">//</span>
00150 
00151         IrqlChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00152         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
00153     }
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">// Establish an exception handler and probe and capture the specified</span>
00157     <span class="comment">// context record if the previous mode is user. If the probe or copy</span>
00158     <span class="comment">// fails, then return the exception code as the function value. Else</span>
00159     <span class="comment">// copy the context record to the specified exception and trap frames,</span>
00160     <span class="comment">// and return success as the function value.</span>
00161     <span class="comment">//</span>
00162 
00163     <span class="keywordflow">try</span> {
00164 
00165         <span class="comment">//</span>
00166         <span class="comment">// Get the previous processor mode. If the previous processor mode is</span>
00167         <span class="comment">// user, then probe and copy the specified context record.</span>
00168         <span class="comment">//</span>
00169 
00170         PreviousMode = KeGetPreviousMode();
00171         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00172             <a class="code" href="../../d5/d4/raisexcp_8c.html#a0">KiContinuePreviousModeUser</a>(ContextRecord,
00173                                        ExceptionFrame,
00174                                        TrapFrame,
00175                                        PreviousMode);
00176         } <span class="keywordflow">else</span> {
00177 
00178             <span class="comment">//</span>
00179             <span class="comment">// Move information from the context record to the exception</span>
00180             <span class="comment">// and trap frames.</span>
00181             <span class="comment">//</span>
00182 
00183             <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame,
00184                                ExceptionFrame,
00185                                ContextRecord,
00186                                ContextRecord-&gt;ContextFlags,
00187                                PreviousMode);
00188         }
00189 
00190     <span class="comment">//</span>
00191     <span class="comment">// If an exception occurs during the probe or copy of the context</span>
00192     <span class="comment">// record, then always handle the exception and return the exception</span>
00193     <span class="comment">// code as the status value.</span>
00194     <span class="comment">//</span>
00195 
00196     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00197         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00198     }
00199 
00200     <span class="keywordflow">if</span> (IrqlChanged) {
00201         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
00202     }
00203 
00204     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00205 }
00206 
00207 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00208"></a><a class="code" href="../../d5/d4/raisexcp_8c.html#a2">00208</a> <a class="code" href="../../d5/d4/raisexcp_8c.html#a2">KiRaiseException</a> (
00209     IN PEXCEPTION_RECORD ExceptionRecord,
00210     IN PCONTEXT ContextRecord,
00211     IN PKEXCEPTION_FRAME ExceptionFrame,
00212     IN PKTRAP_FRAME TrapFrame,
00213     IN BOOLEAN FirstChance
00214     )
00215 
00216 <span class="comment">/*++</span>
00217 <span class="comment"></span>
00218 <span class="comment">Routine Description:</span>
00219 <span class="comment"></span>
00220 <span class="comment">    This function is called to raise an exception. The exception can be</span>
00221 <span class="comment">    raised as a first or second chance exception.</span>
00222 <span class="comment"></span>
00223 <span class="comment">Arguments:</span>
00224 <span class="comment"></span>
00225 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span>
00226 <span class="comment"></span>
00227 <span class="comment">    ContextRecord - Supplies a pointer to a context record.</span>
00228 <span class="comment"></span>
00229 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span>
00230 <span class="comment"></span>
00231 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00232 <span class="comment"></span>
00233 <span class="comment">    FirstChance - Supplies a boolean value that specifies whether this is</span>
00234 <span class="comment">        the first (TRUE) or second (FALSE) chance for the exception.</span>
00235 <span class="comment"></span>
00236 <span class="comment">Return Value:</span>
00237 <span class="comment"></span>
00238 <span class="comment">    STATUS_ACCESS_VIOLATION is returned if either the exception or the context</span>
00239 <span class="comment">        record is not readable from user mode.</span>
00240 <span class="comment"></span>
00241 <span class="comment">    STATUS_DATATYPE_MISALIGNMENT is returned if the exception record or the</span>
00242 <span class="comment">        context record are not properly aligned.</span>
00243 <span class="comment"></span>
00244 <span class="comment">    STATUS_INVALID_PARAMETER is returned if the number of exception parameters</span>
00245 <span class="comment">        is greater than the maximum allowable number of exception parameters.</span>
00246 <span class="comment"></span>
00247 <span class="comment">    STATUS_SUCCESS is returned if the exception is dispatched and handled.</span>
00248 <span class="comment"></span>
00249 <span class="comment">--*/</span>
00250 
00251 {
00252 
00253     CONTEXT ContextRecord2;
00254     EXCEPTION_RECORD ExceptionRecord2;
00255     ULONG Length;
00256     ULONG Params;
00257     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00258 
00259     <span class="comment">//</span>
00260     <span class="comment">// Establish an exception handler and probe the specified exception and</span>
00261     <span class="comment">// context records for read accessibility. If the probe fails, then</span>
00262     <span class="comment">// return the exception code as the service status. Else call the exception</span>
00263     <span class="comment">// dispatcher to dispatch the exception.</span>
00264     <span class="comment">//</span>
00265 
00266     <span class="keywordflow">try</span> {
00267 
00268         <span class="comment">//</span>
00269         <span class="comment">// Get the previous processor mode. If the previous processor mode</span>
00270         <span class="comment">// is user, then probe and copy the specified exception and context</span>
00271         <span class="comment">// records.</span>
00272         <span class="comment">//</span>
00273 
00274         PreviousMode = KeGetPreviousMode();
00275         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00276             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ContextRecord, <span class="keyword">sizeof</span>(CONTEXT), CONTEXT_ALIGN);
00277             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ExceptionRecord,
00278                          FIELD_OFFSET (EXCEPTION_RECORD, NumberParameters) +
00279                          <span class="keyword">sizeof</span> (ExceptionRecord-&gt;NumberParameters), <span class="keyword">sizeof</span>(ULONG));
00280             Params = ExceptionRecord-&gt;NumberParameters;
00281             <span class="keywordflow">if</span> (Params &gt; EXCEPTION_MAXIMUM_PARAMETERS) {
00282                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00283             }
00284 
00285             <span class="comment">//</span>
00286             <span class="comment">// The exception record structure is defined unlike others with trailing</span>
00287             <span class="comment">// information as being its maximum size rather than just a single trailing</span>
00288             <span class="comment">// element.</span>
00289             <span class="comment">//</span>
00290             Length = (<span class="keyword">sizeof</span>(EXCEPTION_RECORD) -
00291                      ((EXCEPTION_MAXIMUM_PARAMETERS - Params) *
00292                      <span class="keyword">sizeof</span>(ExceptionRecord-&gt;ExceptionInformation[0])));
00293 
00294             <span class="comment">//</span>
00295             <span class="comment">// The structure is currently less that 64k so we don't really need this probe.</span>
00296             <span class="comment">//</span>
00297             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ExceptionRecord, Length, <span class="keyword">sizeof</span>(ULONG));
00298 
00299             <span class="comment">//</span>
00300             <span class="comment">// Copy the exception and context record to local storage so an</span>
00301             <span class="comment">// access violation cannot occur during exception dispatching.</span>
00302             <span class="comment">//</span>
00303 
00304             RtlMoveMemory(&amp;ContextRecord2, ContextRecord, <span class="keyword">sizeof</span>(CONTEXT));
00305             RtlMoveMemory(&amp;ExceptionRecord2, ExceptionRecord, Length);
00306             ContextRecord = &amp;ContextRecord2;
00307             ExceptionRecord = &amp;ExceptionRecord2;
00308             <span class="comment">//</span>
00309             <span class="comment">// The number of parameters might have changed after we validated but before we</span>
00310             <span class="comment">// copied the structure. Fix this up as lower levels might not like this.</span>
00311             <span class="comment">//</span>
00312             ExceptionRecord-&gt;NumberParameters = Params;            
00313         }
00314 
00315     <span class="comment">//</span>
00316     <span class="comment">// If an exception occurs during the probe of the exception or context</span>
00317     <span class="comment">// record, then always handle the exception and return the exception code</span>
00318     <span class="comment">// as the status value.</span>
00319     <span class="comment">//</span>
00320 
00321     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00322         <span class="keywordflow">return</span> GetExceptionCode();
00323     }
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">// Move information from the context record to the exception and</span>
00327     <span class="comment">// trap frames.</span>
00328     <span class="comment">//</span>
00329 
00330     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame,
00331                        ExceptionFrame,
00332                        ContextRecord,
00333                        ContextRecord-&gt;ContextFlags,
00334                        PreviousMode);
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">// Make sure the reserved bit is clear in the exception code and</span>
00338     <span class="comment">// perform exception dispatching.</span>
00339     <span class="comment">//</span>
00340     <span class="comment">// N.B. The reserved bit is used to differentiate internally gerarated</span>
00341     <span class="comment">//      codes from codes generated by application programs.</span>
00342     <span class="comment">//</span>
00343 
00344     ExceptionRecord-&gt;ExceptionCode &amp;= 0xefffffff;
00345     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a11">KiDispatchException</a>(ExceptionRecord,
00346                         ExceptionFrame,
00347                         TrapFrame,
00348                         PreviousMode,
00349                         FirstChance);
00350 
00351     <span class="keywordflow">return</span> STATUS_SUCCESS;
00352 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
