<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: vadtree.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>vadtree.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d7/d2/vadtree_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/vadtree_8c.html#a1">MiRemoveVad</a> (IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> (IN SIZE_T SizeOfRange, IN ULONG_PTR Alignment, IN ULONG QuickCheck)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="vadtree.c::MiFindEmptyAddressRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiFindEmptyAddressRange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>SizeOfRange</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Alignment</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>QuickCheck</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00431">431</a> of file <a class="el" href="../../d7/d2/vadtree_8c-source.html">vadtree.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00334">MI_ROUND_TO_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00763">MI_VPN_TO_VA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00765">MI_VPN_TO_VA_ENDING</a>, <a class="el" href="../../d7/d3/addrsup_8c-source.html#l01127">MiFindEmptyAddressRangeInTree()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00503">MiGetNextVad</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00257">_EPROCESS::VadFreeHint</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00227">_EPROCESS::VadRoot</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l02785">MiMapLockedPagesInUserSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02256">MiMapViewOfDataSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l01567">MiMapViewOfImageSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l01028">MiMapViewOfPhysicalSection()</a>, and <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00439                    :
00440 
00441     The function examines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address descriptors to locate
00442     an unused range of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified size and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting
00443     address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
00444 
00445 Arguments:
00446 
00447     SizeOfRange - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range to locate.
00448 
00449     Alignment - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> alignment <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address.  Must be
00450                  a power of 2 and greater than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page_size.
00451 
00452     QuickCheck - Supplies a zero <span class="keywordflow">if</span> a quick check <span class="keywordflow">for</span> free memory
00453                  after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> VadFreeHint exists, non-zero <span class="keywordflow">if</span> checking
00454                  should start at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest address.
00455 
00456 Return Value:
00457 
00458     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting address of a suitable range.
00459 
00460 --*/
00461 
00462 {
00463     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NextVad;
00464     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FreeHint;
00465     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00466     PVOID StartingVa;
00467     PVOID EndingVa;
00468 
00469     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00470     FreeHint = CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a>;
00471 
00472     <span class="keywordflow">if</span> ((QuickCheck == 0) &amp;&amp; (FreeHint != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00473 
00474         EndingVa = <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (FreeHint-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>);
00475         NextVad = <a class="code" href="../../d4/d8/mi_8h.html#a96">MiGetNextVad</a> (FreeHint);
00476         <span class="keywordflow">if</span> (NextVad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00477 
00478             <span class="keywordflow">if</span> (SizeOfRange &lt;
00479                 (((ULONG_PTR)MM_HIGHEST_USER_ADDRESS + 1) -
00480                          <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a>((ULONG_PTR)EndingVa, Alignment))) {
00481                 <span class="keywordflow">return</span> (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)<a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a>((ULONG_PTR)EndingVa,
00482                                                          Alignment);
00483             }
00484         } <span class="keywordflow">else</span> {
00485             StartingVa = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (NextVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>);
00486 
00487             <span class="keywordflow">if</span> (SizeOfRange &lt;
00488                 ((ULONG_PTR)StartingVa -
00489                          <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a>((ULONG_PTR)EndingVa, Alignment))) {
00490 
00491                 <span class="comment">//</span>
00492                 <span class="comment">// Check to ensure that the ending address aligned upwards</span>
00493                 <span class="comment">// is not greater than the starting address.</span>
00494                 <span class="comment">//</span>
00495 
00496                 <span class="keywordflow">if</span> ((ULONG_PTR)StartingVa &gt;
00497                          <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a>((ULONG_PTR)EndingVa,Alignment)) {
00498                     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)<a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a>((ULONG_PTR)EndingVa,
00499                                                            Alignment);
00500                 }
00501             }
00502         }
00503     }
00504 
00505     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d8/mi_8h.html#a846">MiFindEmptyAddressRangeInTree</a> (
00506                    SizeOfRange,
00507                    Alignment,
00508                    (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)(CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a>),
00509                    (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a> *)&amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a>);
00510 
00511 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="vadtree.c::MiInsertVad" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiInsertVad           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Vad</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00030">30</a> of file <a class="el" href="../../d7/d2/vadtree_8c-source.html">vadtree.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00186">_EPROCESS::CommitCharge</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00304">_EPROCESS::CommitChargeLimit</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00305">_EPROCESS::CommitChargePeak</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01626">_MMWSL::CommittedPageTables</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00285">_EPROCESS::Job</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00286">_EPROCESS::JobStatus</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01157">MI_CHECK_BIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01186">MI_SET_BIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00763">MI_VPN_TO_VA</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00058">MiChargePageFileQuota()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01746">MiGetPpePdeOffset</a>, <a class="el" href="../../d7/d3/addrsup_8c-source.html#l00464">MiInsertNode()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00133">MiReturnPageFileQuota()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04271">MM_DBG_COMMIT_INSERT_VAD</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02338">MM_MAX_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d4/d8/mi_8h.html#a489">MMVAD</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01604">_MMWSL::NumberOfCommittedPageTables</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00453">PDE_PER_PAGE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00318">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02823">PsChangeJobMemoryUsage()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02901">PsReportProcessMemoryLimitViolation()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00257">_EPROCESS::VadFreeHint</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00228">_EPROCESS::VadHint</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00227">_EPROCESS::VadRoot</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04202">MiCreatePebOrTeb()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02785">MiMapLockedPagesInUserSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02256">MiMapViewOfDataSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l01567">MiMapViewOfImageSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l01028">MiMapViewOfPhysicalSection()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00911">MmInitializeProcessAddressSpace()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, and <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00036                    :
00037 
00038     This function inserts a <span class="keyword">virtual</span> address descriptor into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree and
00039     reorders <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> splay tree as appropriate.
00040 
00041 Arguments:
00042 
00043     Vad - Supplies a pointer to a <span class="keyword">virtual</span> address descriptor
00044 
00045 
00046 Return Value:
00047 
00048     None - An exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised <span class="keywordflow">if</span> quota <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> exceeded.
00049 
00050 --*/
00051 
00052 {
00053     <a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a> *Root;
00054     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00055     SIZE_T RealCharge;
00056     SIZE_T PageCharge;
00057     SIZE_T PagedQuotaCharged;
00058     ULONG FirstPage;
00059     ULONG LastPage;
00060     SIZE_T PagedPoolCharge;
00061     LOGICAL ChargedPageFileQuota;
00062     LOGICAL ChargedJobCommit;
00063 
00064     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;EndingVpn &gt;= Vad-&gt;StartingVpn);
00065 
00066     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00067 
00068     <span class="comment">//</span>
00069     <span class="comment">// Commit charge of MAX_COMMIT means don't charge quota.</span>
00070     <span class="comment">//</span>
00071 
00072     <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.CommitCharge != <a class="code" href="../../d4/d8/mi_8h.html#a227">MM_MAX_COMMIT</a>) {
00073 
00074         PageCharge = 0;
00075         PagedQuotaCharged = 0;
00076         ChargedPageFileQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00077         ChargedJobCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00078 
00079         <span class="comment">//</span>
00080         <span class="comment">// Charge quota for the nonpaged pool for the VAD.  This is</span>
00081         <span class="comment">// done here rather than by using ExAllocatePoolWithQuota</span>
00082         <span class="comment">// so the process object is not referenced by the quota charge.</span>
00083         <span class="comment">//</span>
00084 
00085         <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a> (CurrentProcess, NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>));
00086 
00087         <span class="keywordflow">try</span> {
00088 
00089             <span class="comment">//</span>
00090             <span class="comment">// Charge quota for the prototype PTEs if this is a mapped view.</span>
00091             <span class="comment">//</span>
00092 
00093             <span class="keywordflow">if</span> ((Vad-&gt;u.VadFlags.PrivateMemory == 0) &amp;&amp;
00094                 (Vad-&gt;ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00095                 PagedPoolCharge =
00096                   (Vad-&gt;EndingVpn - Vad-&gt;StartingVpn) &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>;
00097                 <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a> (CurrentProcess, PagedPool, PagedPoolCharge);
00098                 PagedQuotaCharged = PagedPoolCharge;
00099             }
00100 
00101 <span class="preprocessor">#if !defined (_WIN64)</span>
00102 <span class="preprocessor"></span>            <span class="comment">//</span>
00103             <span class="comment">// Add in the charge for page table pages.</span>
00104             <span class="comment">//</span>
00105 
00106             FirstPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a> (MI_VPN_TO_VA (Vad-&gt;StartingVpn));
00107             LastPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a> (MI_VPN_TO_VA (Vad-&gt;EndingVpn));
00108 
00109             <span class="keywordflow">while</span> (FirstPage &lt;= LastPage) {
00110 
00111                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d8/mi_8h.html#a167">MI_CHECK_BIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o17">CommittedPageTables</a>,
00112                                    FirstPage)) {
00113                     PageCharge += 1;
00114                 }
00115                 FirstPage += 1;
00116             }
00117 <span class="preprocessor">#endif</span>
00118 <span class="preprocessor"></span>
00119             RealCharge = Vad-&gt;u.VadFlags.CommitCharge + PageCharge;
00120 
00121             <span class="keywordflow">if</span> (RealCharge != 0) {
00122 
00123                 <a class="code" href="../../d6/d1/mmquota_8c.html#a15">MiChargePageFileQuota</a> (RealCharge, CurrentProcess);
00124                 ChargedPageFileQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00125 
00126 <span class="preprocessor">#if 0 //commented out so page file quota is meaningful.</span>
00127 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.PrivateMemory == 0) {
00128 
00129                     <span class="keywordflow">if</span> ((Vad-&gt;ControlArea-&gt;FilePointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00130                         (Vad-&gt;u.VadFlags.PhysicalMapping == 0)) {
00131 
00132                         <span class="comment">//</span>
00133                         <span class="comment">// Don't charge commitment for the page file space</span>
00134                         <span class="comment">// occupied by a page file section.  This will be</span>
00135                         <span class="comment">// charged as the shared memory is committed.</span>
00136                         <span class="comment">//</span>
00137 
00138                         RealCharge -= 1 + (Vad-&gt;EndingVpn -
00139                                                      Vad-&gt;StartingVpn);
00140                     }
00141                 }
00142 <span class="preprocessor">#endif //0</span>
00143 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o85">CommitChargeLimit</a>) {
00144                     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> + RealCharge &gt; CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o85">CommitChargeLimit</a>) {
00145                         <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>) {
00146                             <a class="code" href="../../d1/d1/psjob_8c.html#a21">PsReportProcessMemoryLimitViolation</a> ();
00147                         }
00148                         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
00149                     }
00150                 }
00151                 <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
00152                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(RealCharge) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00153                         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
00154                     }
00155                     ChargedJobCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00156                 }
00157 
00158                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (RealCharge, CurrentProcess) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00159                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
00160                 }
00161 
00162                 CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> += RealCharge;
00163                 <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> &gt; CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o86">CommitChargePeak</a>) {
00164                     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o86">CommitChargePeak</a> = CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a>;
00165                 }
00166             }
00167         } except (EXCEPTION_EXECUTE_HANDLER) {
00168 
00169             <span class="comment">//</span>
00170             <span class="comment">// Return any quotas charged thus far.</span>
00171             <span class="comment">//</span>
00172 
00173             <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess, NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>));
00174 
00175             <span class="keywordflow">if</span> (PagedQuotaCharged != 0) {
00176                 <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess, PagedPool, PagedPoolCharge);
00177             }
00178 
00179             <span class="keywordflow">if</span> (ChargedPageFileQuota == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00180 
00181                 <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (RealCharge,
00182                                        CurrentProcess);
00183             }
00184 
00185             <span class="keywordflow">if</span> (ChargedJobCommit == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00186 
00187                 <span class="comment">//</span>
00188                 <span class="comment">// Temporarily up the process commit charge as the</span>
00189                 <span class="comment">// job code will be referencing it as though everything</span>
00190                 <span class="comment">// has succeeded.</span>
00191                 <span class="comment">//</span>
00192 
00193                 CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> += RealCharge;
00194                 <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(-(SSIZE_T)RealCharge);
00195                 CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> -= RealCharge;
00196             }
00197 
00198             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (GetExceptionCode());
00199         }
00200 
00201         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_INSERT_VAD, RealCharge);
00202 
00203 <span class="preprocessor">#if !defined (_WIN64)</span>
00204 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PageCharge != 0) {
00205 
00206             <span class="comment">//</span>
00207             <span class="comment">// Since the commitment was successful, charge the page</span>
00208             <span class="comment">// table pages.</span>
00209             <span class="comment">//</span>
00210 
00211             FirstPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a> (MI_VPN_TO_VA (Vad-&gt;StartingVpn));
00212 
00213             <span class="keywordflow">while</span> (FirstPage &lt;= LastPage) {
00214 
00215                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d8/mi_8h.html#a167">MI_CHECK_BIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o17">CommittedPageTables</a>,
00216                                    FirstPage)) {
00217                     <a class="code" href="../../d4/d8/mi_8h.html#a168">MI_SET_BIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o17">CommittedPageTables</a>,
00218                                 FirstPage);
00219                     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o6">NumberOfCommittedPageTables</a> += 1;
00220 <span class="preprocessor">#if defined (_X86PAE_)</span>
00221 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o6">NumberOfCommittedPageTables</a> &lt;
00222                                                  PD_PER_SYSTEM * PDE_PER_PAGE);
00223 <span class="preprocessor">#else</span>
00224 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o6">NumberOfCommittedPageTables</a> &lt;
00225                                                                  PDE_PER_PAGE);
00226 <span class="preprocessor">#endif</span>
00227 <span class="preprocessor"></span>                }
00228                 FirstPage += 1;
00229             }
00230         }
00231 <span class="preprocessor">#endif</span>
00232 <span class="preprocessor"></span>    }
00233 
00234     Root = (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a> *)&amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a>;
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">// Set the hint field in the process to this Vad.</span>
00238     <span class="comment">//</span>
00239 
00240     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> = Vad;
00241 
00242     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00243         <span class="keywordflow">if</span> (((ULONG)((<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a>)-&gt;EndingVpn +
00244                 <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (X64K)) &gt;=
00245                 Vad-&gt;StartingVpn) {
00246             CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a> = Vad;
00247         }
00248     }
00249 
00250     <a class="code" href="../../d4/d8/mi_8h.html#a842">MiInsertNode</a> ( (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)Vad, Root);
00251     <span class="keywordflow">return</span>;
00252 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="vadtree.c::MiLocateAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FASTCALL MiLocateAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">380</a> of file <a class="el" href="../../d7/d2/vadtree_8c-source.html">vadtree.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d7/d3/addrsup_8c-source.html#l01001">MiLocateAddressInTree()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00228">_EPROCESS::VadHint</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00227">_EPROCESS::VadRoot</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/pagfault_8c-source.html#l02880">MiCheckVirtualAddress()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03253">MiUnmapLockedPagesInUserSpace()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04843">MmDeleteTeb()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05161">MmMapUserAddressesToPage()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l04177">MmSecureVirtualMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07311">MmSetBankedSection()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00090">MmUnmapViewOfSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l04614">MmUnsecureVirtualMemory()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02965">NtAreMappedFilesTheSame()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00033">NtLockVirtualMemory()</a>, and <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00605">NtUnlockVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00386                    :
00387 
00388     The function locates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address descriptor which describes
00389     a given address.
00390 
00391 Arguments:
00392 
00393     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to locate a descriptor
00394                      <span class="keywordflow">for</span>.
00395 
00396 Return Value:
00397 
00398     Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address descriptor which contains
00399     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied <span class="keyword">virtual</span> address or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> none was located.
00400 
00401 --*/
00402 
00403 {
00404     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FoundVad;
00405     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00406     ULONG_PTR Vpn;
00407 
00408     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00409 
00410     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00411         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00412     }
00413 
00414     Vpn = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (VirtualAddress);
00415     <span class="keywordflow">if</span> ((Vpn &gt;= ((<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a>)-&gt;StartingVpn) &amp;&amp;
00416         (Vpn &lt;= ((<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a>)-&gt;EndingVpn)) {
00417 
00418         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a>;
00419     }
00420 
00421     FoundVad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d8/mi_8h.html#a844">MiLocateAddressInTree</a> ( Vpn,
00422                    (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a> *)&amp;(CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a>));
00423 
00424     <span class="keywordflow">if</span> (FoundVad != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00425         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> = (PVOID)FoundVad;
00426     }
00427     <span class="keywordflow">return</span> FoundVad;
00428 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="vadtree.c::MiRemoveVad" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiRemoveVad           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Vad</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00256">256</a> of file <a class="el" href="../../d7/d2/vadtree_8c-source.html">vadtree.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00186">_EPROCESS::CommitCharge</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00286">_EPROCESS::JobStatus</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02380">_MMSECURE_ENTRY::List</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00480">MiGetPreviousVad</a>, <a class="el" href="../../d7/d3/addrsup_8c-source.html#l00568">MiRemoveNode()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00133">MiReturnPageFileQuota()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04299">MM_DBG_COMMIT_RETURN_VAD</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02338">MM_MAX_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00318">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02823">PsChangeJobMemoryUsage()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00257">_EPROCESS::VadFreeHint</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00228">_EPROCESS::VadHint</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00227">_EPROCESS::VadRoot</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l03253">MiUnmapLockedPagesInUserSpace()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04843">MmDeleteTeb()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00090">MmUnmapViewOfSection()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, and <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00262                    :
00263 
00264     This function removes a <span class="keyword">virtual</span> address descriptor from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree and
00265     reorders <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> splay tree as appropriate.  If any quota or commitment
00266     was charged by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> VAD (as indicated by the CommitCharge field) <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00267     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> released.
00268 
00269 Arguments:
00270 
00271     Vad - Supplies a pointer to a <span class="keyword">virtual</span> address descriptor.
00272 
00273 Return Value:
00274 
00275     None.
00276 
00277 --*/
00278 
00279 {
00280     <a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a> *Root;
00281     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00282     SIZE_T RealCharge;
00283     PLIST_ENTRY Next;
00284     <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a> Entry;
00285 
00286     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00287 
00288 
00289     <span class="comment">//</span>
00290     <span class="comment">// Commit charge of MAX_COMMIT means don't charge quota.</span>
00291     <span class="comment">//</span>
00292 
00293     <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.CommitCharge != <a class="code" href="../../d4/d8/mi_8h.html#a227">MM_MAX_COMMIT</a>) {
00294 
00295         <span class="comment">//</span>
00296         <span class="comment">// Return the quota charge to the process.</span>
00297         <span class="comment">//</span>
00298 
00299         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess, NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>));
00300 
00301         <span class="keywordflow">if</span> ((Vad-&gt;u.VadFlags.PrivateMemory == 0) &amp;&amp;
00302             (Vad-&gt;ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00303             <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess,
00304                                PagedPool,
00305                                (Vad-&gt;EndingVpn - Vad-&gt;StartingVpn) &lt;&lt; PTE_SHIFT);
00306         }
00307 
00308         RealCharge = Vad-&gt;u.VadFlags.CommitCharge;
00309 
00310         <span class="keywordflow">if</span> (RealCharge != 0) {
00311 
00312             <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (RealCharge, CurrentProcess);
00313 
00314             <span class="keywordflow">if</span> ((Vad-&gt;u.VadFlags.PrivateMemory == 0) &amp;&amp;
00315                 (Vad-&gt;ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00316 
00317 <span class="preprocessor">#if 0 //commented out so page file quota is meaningful.</span>
00318 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Vad-&gt;ControlArea-&gt;FilePointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00319 
00320                     <span class="comment">//</span>
00321                     <span class="comment">// Don't release commitment for the page file space</span>
00322                     <span class="comment">// occupied by a page file section.  This will be charged</span>
00323                     <span class="comment">// as the shared memory is committed.</span>
00324                     <span class="comment">//</span>
00325 
00326                     RealCharge -= <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> ((ULONG)Vad-&gt;EndingVa -
00327                                                    (ULONG)Vad-&gt;StartingVa);
00328                 }
00329 <span class="preprocessor">#endif</span>
00330 <span class="preprocessor"></span>            }
00331 
00332             <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (RealCharge);
00333             <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_VAD, RealCharge);
00334             <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
00335                 <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(-(SSIZE_T)RealCharge);
00336             }
00337             CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> -= RealCharge;
00338         }
00339     }
00340 
00341     <span class="keywordflow">if</span> (Vad == CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a>) {
00342         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a> = <a class="code" href="../../d4/d8/mi_8h.html#a95">MiGetPreviousVad</a> (Vad);
00343     }
00344 
00345     Root = (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a> *)&amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a>;
00346 
00347     <a class="code" href="../../d4/d8/mi_8h.html#a843">MiRemoveNode</a> ( (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)Vad, Root);
00348 
00349     <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.NoChange) {
00350         <span class="keywordflow">if</span> (Vad-&gt;u2.VadFlags2.MultipleSecured) {
00351 
00352            <span class="comment">//</span>
00353            <span class="comment">// Free the oustanding pool allocations.</span>
00354            <span class="comment">//</span>
00355 
00356             Next = Vad-&gt;u3.List.Flink;
00357             <span class="keywordflow">do</span> {
00358                 Entry = CONTAINING_RECORD( Next,
00359                                            <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>,
00360                                            List);
00361 
00362                 Next = Entry-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>.Flink;
00363                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Entry);
00364             } <span class="keywordflow">while</span> (Next != &amp;Vad-&gt;u3.List);
00365         }
00366     }
00367 
00368     <span class="comment">//</span>
00369     <span class="comment">// If the VadHint was the removed Vad, change the Hint.</span>
00370 
00371     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> == Vad) {
00372         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> = CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a>;
00373     }
00374 
00375     <span class="keywordflow">return</span>;
00376 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:06 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
